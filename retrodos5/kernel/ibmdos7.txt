     1                                  ;*****************************************************************************
     2                                  ; IBMDOS7.S (PCDOS 7.1 Kernel) - RETRO DOS v5.0 by ERDOGAN TAN - 01/01/2024
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 25/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 22/04/2019 (Retro DOS 4.0), 03/11/2022 (Retro DOS 4.2)
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.15
     9                                  ; ----------------------------------------------------------------------------
    10                                  ;	   ((nasm ibmdos7.s -l ibmdos7.txt -o IBMDOS.COM -Z error.txt))
    11                                  ;					   -o IBMDOS7.BIN
    12                                  ;*****************************************************************************
    13                                  ; main file: 'retrodos5.s'
    14                                  ; incbin 'IBMDOS7.BIN'
    15                                  ;=============================================================================
    16                                  ; Modified from 'msdos6.s' (modified MSDOS 6.21 kernel src as Retro DOS v4.2)
    17                                  ; 29/09/2023 /// Retro DOS v4.2 (2023) -> Modified MSDOS 6.22 IO.SYS+MSDOS.SYS
    18                                  ;=============================================================================
    19                                  
    20                                  ; 30/12/2022 - Retro DOS v4.2 Kernel ('msdos6.s')
    21                                  ; Modified from 'msdos5.s' (29/12/2022, Retro DOS v4.1 Kernel) file
    22                                  ; as below:
    23                                  ;	1) MS-DOS version has been changed to 6.22 (It was 5.0) 
    24                                  ;	2) Retro DOS version has been changed to 4.2 (It was 4.1)
    25                                  ; (The content has not been changed except kernel version because the kernel
    26                                  ;  code is already compatible with MSDOS 6.x and it is optimized before.)
    27                                  ;	(But IO.SYS part of the kernel is not same with Retro DOS v4.1 code.)
    28                                  
    29                                  ; ----------------------------------------------------------------------------
    30                                  
    31                                  ; 03/11/2022 - Erdogan Tan (Istanbul)
    32                                  
    33                                  ; Note:	This code is a part of Retro DOS 4.0 kernel source code
    34                                  ;	(as included binary, 'MSDOS5.BIN') 
    35                                  ;	Equivalent of MSDOS 5.0 MSDOS.SYS kernel file 
    36                                  ;	
    37                                  ;	((MSDOS 6.0 kernel source code has been modified by using disassembled
    38                                  ;	MSDOS 5.0 MSDOS.SYS)) -- Disassembler: HEX-RAYS IDA Pro --
    39                                  ;	((Disassembly -Reverse engineering- reference: MSDOS 6.0 kernel src))
    40                                        
    41                                  ;------ Retro DOS v2 (v3) boot sector loads RETRODOS.SYS (MSDOS.SYS)
    42                                  ;	at 1000h:0000h and loader (initialization) part of RETRODOS kernel
    43                                  ;	moves IO.SYS (DOSBIOSCODE & DOSBIOSDATA, 'IOSYS5.BIN') to 70h:0000h.
    44                                  ;	Then SYSINIT code to the next segment (4D6h for current version)..
    45                                  ;	SYSINIT code relocates itself and DOSBIOSCODE and MSDOS.SYS
    46                                  ;	(MSDOS5.BIN) according to request/setting in 'config.sys' file.
    47                                  
    48                                  ; ----------------------------------------------------------------------------
    49                                  
    50                                  ; 01/01/2024 - Retro DOS v5.0 Kernel ('ibmdos7.s')
    51                                  ; Modified from 'msdos6.s' (29/09/2023, Retro DOS v4.2 kernel: MSDOS.SYS) file
    52                                  ; as below:
    53                                  ;
    54                                  ;    1) Retro DOS v5.0 IBMDOS.COM is based on disassembled source code
    55                                  ;	of PCDOS 7.1 IBMDOS.COM (2003) and it is derived using Retro DOS v4.2
    56                                  ;	MSDOS.SYS source code. Retro DOS v5.0 (IBMDOS.COM) kernel source code
    57                                  ;	is modified (and optimized) and so, it is not same with the original
    58                                  ;	PCDOS 7.1 IBMDOS.COM.
    59                                  ;
    60                                  ;    2) Retro DOS v4.2 MSDOS.SYS is based on disassembled source code
    61                                  ;	of MSDOS 6.21 MSDOS.SYS, derived using MSDOS 6.0 source code.
    62                                  ;	(And then it has been verified and updated by comparing it with
    63                                  ;	the disassembled source code of MSDOS 6.22 kernel file MSDOS.SYS.)
    64                                  ;
    65                                  ;    3) Labels, names, comments, explanations and structure definitions
    66                                  ;	about procedures and code details are almost entirely taken from
    67                                  ;	the original MSDOS 6.0 source code, except for the details that
    68                                  ;	Erdogan Tan personally experienced. Some of them are incompatible
    69                                  ;	with PCDOS 7.1 code. But they have not been deleted to preserve
    70                                  ;	the originality of the descriptions.)
    71                                  ;
    72                                  ; ('msdos6.s' has been converted to 'ibmdos7.s' and 'retrodos42.s' has been
    73                                  ; converted to 'retrodos5.s'. 'ibmdos7.s' is IBMDOS.COM source code file
    74                                  ; while 'retrodos5.s' is source code of Retro DOS v5 kernel file 'PCDOS.SYS'.
    75                                  ; 'retrodos5.s' includes 'ibmdos7.bin' or IBMDOS.COM as binary file.)
    76                                  		
    77                                  ; ----------------------------------------------------------------------------
    78                                  
    79                                  ;=============================================================================
    80                                  ; Most of comments in this file are from the original MSDOS 6.0 source code
    81                                  ;-----------------------------------------------------------------------------
    82                                  
    83                                  ; MSDOS 6.0 Kernel source files:
    84                                  ;	MSDATA.ASM, 
    85                                  ; 		(MSHEAD.ASM, MSCONST.ASM,CONST2.ASM, MS_DATA.ASM,
    86                                  ;		DOSTAB.ASM, LMSTUB.ASM, WPATCH.INC, MPATCH.ASM)
    87                                  ;	MSTABLE.ASM, MSCODE.ASM, MSDOSME.ASM (DOSMES.INC), TIME.ASM,
    88                                  ;	GETSET.ASM, PARSE.ASM, MISC.ASM, MISC2.ASM, CRIT.ASM, CPMIO.ASM,
    89                                  ;	CPMIO2.ASM, FCBIO.ASM, FCBIO2.ASM, SEARCH.ASM, PATH.ASM, IOCTL.ASM,
    90                                  ;	DELETE.ASM, RENAME.ASM, FINFO.ASM, DUP.ASM, CREATE.ASM, OPEN.ASM,
    91                                  ;	DINFO.ASM, ISEARCH.ASM, BUF.ASM, ABORT.ASM,CLOSE.ASM, DIRCALL.ASM,
    92                                  ;	DISK.ASM, DISK2.ASM, DISK3.ASM, DIR.ASM, DIR2.ASM, DEV.ASM,
    93                                  ;	MKNODE.ASM, ROM.ASM, FCB.ASM, MSCTRLC.ASM, FAT.ASM, MSPROC.ASM
    94                                  ;	ALLOC.ASM, SRVCALL.ASM, UTIL.ASM, MACRO.ASM, MACRO2.ASM, HANDLE.ASM
    95                                  ;	FILE.ASM, LOCK.ASM, ROMFIND.ASM, SHARE.ASM, MSINIT.ASM, ORIGIN.ASM
    96                                  ;
    97                                  ; MSDOS 2.0 Kernel source files:
    98                                  ; 	MSDOS.ASM (STDSW.ASM + MSHEAD.ASM + MSDATA.ASM)
    99                                  ;	MSCODE.ASM
   100                                  ;	DOSMES.ASM ... STDIO.ASM, TIME.ASM, XENIX.ASM, XENIX2.ASM
   101                                  
   102                                  ;============================================================================
   103                                  ; DOSLINK
   104                                  ;============================================================================
   105                                  ;msdos mscode dosmes misc getset dircall alloc dev dir +
   106                                  ;disk fat rom stdbuf stdcall stdctrlc stdfcb stdproc +
   107                                  ;stdio time xenix xenix2
   108                                  
   109                                  ;============================================================================
   110                                  ; This MSDOS source code is verified & modified by using IDA Pro Disassembler
   111                                  ; output in TASM syntax (July 2018 -> NASM syntax) [ IBMDOS.COM, 17/03/1987 ]
   112                                  ;============================================================================
   113                                  ;
   114                                  ; ###########################################################################
   115                                  ; #	This file is generated by The Interactive Disassembler (IDA)	    #
   116                                  ; #	Copyright (c) 2010 by Hex-Rays SA, <support@hex-rays.com>	    #
   117                                  ; #			 Licensed to: Freeware version			    #
   118                                  ; ###########################################################################
   119                                  ;
   120                                  ; Input	MD5   :	75959BC417C19135B982F7959EE9C92A
   121                                  
   122                                  ; ---------------------------------------------------------------------------
   123                                  ; File Name   :	C:\Documents and Settings\Erdoðan Tan\Desktop\MSDOS621.BIN
   124                                  ; Format      :	Binary file
   125                                  ;============================================================================
   126                                  ; MSDOS621.BIN = MSDOS.SYS, 13/02/1994, 38138 bytes (MSDOS 6.21 kernel) 2019
   127                                  ;----------------------------------------------------------------------------
   128                                  ; MSDOS5.BIN = MSDOS.SYS, 11/11/1991, 37394 bytes (MSDOS 5.0 kernel) 2022
   129                                  
   130                                  ;============================================================================
   131                                  ; MSDOS.ASM
   132                                  ;============================================================================
   133                                  
   134                                  ;TITLE   Standard MSDOS
   135                                  ;NAME    MSDOS_2
   136                                  
   137                                  ; Number of disk I/O buffers
   138                                  
   139                                  ;	INCLUDE STDSW.ASM
   140                                  ;       INCLUDE MSHEAD.ASM
   141                                  ;       INCLUDE MSDATA.ASM
   142                                  
   143                                  ;	END
   144                                  
   145                                  ;============================================================================
   146                                  ; STDSW.ASM
   147                                  ;============================================================================
   148                                  
   149                                  TRUE    EQU     0FFFFH
   150                                  FALSE   EQU     ~TRUE ; NOT TRUE
   151                                  
   152                                  ; Use the switches below to produce the standard Microsoft version or the IBM
   153                                  ; version of the operating system
   154                                  ;MSVER   EQU	false
   155                                  ;IBM     EQU	true
   156                                  ;WANG    EQU	FALSE
   157                                  ;ALTVECT EQU	FALSE
   158                                  
   159                                  ; Set this switch to cause DOS to move itself to the end of memory
   160                                  ;HIGHMEM EQU     FALSE
   161                                  
   162                                  ;	IF      IBM
   163                                  ESCCH    EQU	 0			;character to begin escape seq.
   164                                  CANCEL   EQU	 27			;Cancel with escape
   165                                  TOGLINS  EQU	TRUE			;One key toggles insert mode
   166                                  TOGLPRN  EQU	TRUE			;One key toggles printer echo
   167                                  ZEROEXT  EQU	TRUE
   168                                  ;       ELSE
   169                                  ;       IF      WANG			;Are we assembling for WANG?
   170                                  ;ESCCH	 EQU	1FH			;Yes. Use 1FH for escape character
   171                                  ;       ELSE
   172                                  ;ESCCH	 EQU	1BH
   173                                  ;       ENDIF
   174                                  ;CANCEL  EQU	"X"-"@"			;Cancel with Ctrl-X
   175                                  ;TOGLINS EQU	WANG			;Separate keys for insert mode on
   176                                  					;and off if not WANG
   177                                  ;TOGLPRN EQU	FALSE			;Separate keys for printer echo on
   178                                  					;and off
   179                                  ;ZEROEXT EQU	TRUE
   180                                  ;        ENDIF
   181                                  
   182                                  ;============================================================================
   183                                  ; MSHEAD.ASM
   184                                  ;============================================================================
   185                                  
   186                                  ;--------------------------------------------------------------
   187                                  ; TITLE   MSHEAD.ASM -- MS-DOS DEFINITIONS
   188                                  ;--------------------------------------------------------------
   189                                  
   190                                  ; MS-DOS High-performance operating system for the 8086  version 1.28
   191                                  ;        by Microsoft MSDOS development group:
   192                                  ;           Tim Paterson (Ret.)
   193                                  ;           Aaron Reynolds
   194                                  ;           Nancy Panners (Parenting)
   195                                  ;           Mark Zbikowski
   196                                  ;           Chris Peters (BIOS) (ret.)
   197                                  
   198                                  ; ****************** Revision History *************************
   199                                  ;          >> EVERY change must noted below!! <<
   200                                  ;
   201                                  ; 0.34 12/29/80 General release, updating all past customers
   202                                  ; 0.42 02/25/81 32-byte directory entries added
   203                                  ; 0.56 03/23/81 Variable record and sector sizes
   204                                  ; 0.60 03/27/81 Ctrl-C exit changes, including register save on user stack
   205                                  ; 0.74 04/15/81 Recognize I/O devices with file names
   206                                  ; 0.75 04/17/81 Improve and correct buffer handling
   207                                  ; 0.76 04/23/81 Correct directory size when not 2^N entries
   208                                  ; 0.80 04/27/81 Add console input without echo, Functions 7 & 8
   209                                  ; 1.00 04/28/81 Renumber for general release
   210                                  ; 1.01 05/12/81 Fix bug in `STORE'
   211                                  ; 1.10 07/21/81 Fatal error trapping, NUL device, hidden files, date & time,
   212                                  ;               RENAME fix, general cleanup
   213                                  ; 1.11 09/03/81 Don't set CURRENT BLOCK to 0 on open; fix SET FILE SIZE
   214                                  ; 1.12 10/09/81 Zero high half of CURRENT BLOCK after all (CP/M programs don't)
   215                                  ; 1.13 10/29/81 Fix classic "no write-through" error in buffer handling
   216                                  ; 1.20 12/31/81 Add time to FCB; separate FAT from DPT; Kill SMALLDIR; Add
   217                                  ;               FLUSH and MAPDEV calls; allow disk mapping in DSKCHG; Lots
   218                                  ;               of smaller improvements
   219                                  ; 1.21 01/06/82 HIGHMEM switch to run DOS in high memory
   220                                  ; 1.22 01/12/82 Add VERIFY system call to enable/disable verify after write
   221                                  ; 1.23 02/11/82 Add defaulting to parser; use variable escape character Don't
   222                                  ;               zero extent field in IBM version (back to 1.01!)
   223                                  ; 1.24 03/01/82 Restore fcn. 27 to 1.0 level; add fcn. 28
   224                                  ; 1.25 03/03/82 Put marker (00) at end of directory to speed searches
   225                                  ; 1.26 03/03/82 Directory buffers searched as a circular queue, current buffer
   226                                  ;               is searched first when possible to minimize I/O
   227                                  ;      03/03/82 STORE routine optimized to tack on partial sector tail as
   228                                  ;               full sector write when file is growing
   229                                  ;      03/09/82 Multiple I/O buffers
   230                                  ;      03/29/82 Two bugs:  Delete all case resets search to start at beginning
   231                                  ;               of directory (infinite loop possible otherwise), DSKRESET
   232                                  ;               must invalidate all buffers (disk and directory).
   233                                  ; 1.27 03/31/82 Installable device drivers
   234                                  ;                 Function call 47 - Get pointer to device table list
   235                                  ;                 Function call 48 - Assign CON AUX LIST
   236                                  ;      04/01/82 Spooler interrupt (INT 28) added.
   237                                  ; 1.28 04/15/82 DOS retructured to use ASSUMEs and PROC labels around system
   238                                  ;               call entries.  Most CS relative references changed to SS
   239                                  ;               relative with an eye toward putting a portion of the DOS in
   240                                  ;               ROM.  DOS source also broken into header, data and code pieces
   241                                  ;      04/15/82 GETDMA and GETVECT calls added as 24 and 32.  These calls
   242                                  ;               return the current values.
   243                                  ;      04/15/82 INDOS flag implemented for interrupt processing along with
   244                                  ;               call to return flag location (call 29)
   245                                  ;      04/15/82 Volume ID attribute added
   246                                  ;      04/17/82 Changed ABORT return to user to a long ret from a long jump to
   247                                  ;               avoid a CS relative reference.
   248                                  ;      04/17/82 Put call to STATCHK in dispatcher to catch ^C more often
   249                                  ;      04/20/82 Added INT int_upooler into loop ^S wait
   250                                  ;      04/22/82 Dynamic disk I/O buffer allocation and call to manage them
   251                                  ;               call 49.
   252                                  ;      04/23/82 Added GETDSKPTDL as call 50, similar to GETFATPT(DL), returns
   253                                  ;               address of DPB
   254                                  ;      04/29/82 Mod to WRTDEV to look for ^C or ^S at console input when
   255                                  ;               writting to console device via file I/O.  Added a console
   256                                  ;               output attribute to devices.
   257                                  ;      04/30/82 Call to en/dis able ^C check in dispatcher Call 51
   258                                  ;      04/30/82 Code to allow assignment of func 1-12 to disk files as well
   259                                  ;               as devices....  pipes, redirection now possible
   260                                  ;      04/30/82 Expanded GETLIST call to 2.0 standard
   261                                  ;      05/04/82 Change to INT int_fatal_abort callout int HARDERR.  DOS SS
   262                                  ;               (data segment) stashed in ES, INT int_fatal_abort routines must
   263                                  ;               preserve ES.  This mod so HARDERR can be ROMed.
   264                                  ; 1.29 06/01/82 Installable block and character devices as per 2.0 spec
   265                                  ;      06/04/82 Fixed Bug in CLOSE regarding call to CHKFATWRT.  It got left
   266                                  ;               out back about 1.27 or so (oops).  ARR
   267                                  ; 1.30 06/07/82 Directory sector buffering added to main DOS buffer queue
   268                                  ; 1.40 06/15/82 Tree structured directories.  XENIX Path Parser MKDIR CHDIR
   269                                  ;               RMDIR Xenix calls
   270                                  ; 1.41 06/13/82 Made GETBUFFR call PLACEBUF
   271                                  ; 1.50 06/17/82 FATs cached in buffer pool, get FAT pointer calls disappear
   272                                  ;               Frees up lots of memory.
   273                                  ; 1.51 06/24/82 BREAKDOWN modified to do EXACT one sector read/write through
   274                                  ;               system buffers
   275                                  ; 1.52 06/30/82 OPEN, CLOSE, READ, WRITE, DUP, DUP2, LSEEK implemented
   276                                  ; 1.53 07/01/82 OPEN CLOSE mod for Xenix calls, saves and gets remote dir
   277                                  ; 1.54 07/11/82 Function calls 1-12 make use of new 2.0 PDB. Init code
   278                                  ;               changed to set file handle environment.
   279                                  ; 2.00 08/01/82 Number for IBM release
   280                                  ;      01/19/83 No environ bug in EXEC
   281                                  ;      01/19/83 MS-DOS OEM INT 21 extensions (SET_OEM_HANDLER)
   282                                  ;      01/19/83 Performance bug fix in cooked write to NUL
   283                                  ;      01/27/83 Growcnt fixed for 32-bits
   284                                  ;      01/27/83 Find-first problem after create
   285                                  ; 2.01 02/17/83 International DOS
   286                                  ; 2.11 08/12/83 Dos split into several more modules for assembly on
   287                                  ;               an IBM PC
   288                                  ; 08/07/2018 - Retro DOS v3.0 by Erdogan Tan
   289                                  ; (MSHEAD.ASM, MSDOS 6.0, 1991) - mshead.asm 1.1 85/04/10 -
   290                                  ; 2.10 03/09/83 Start of NETWORK support
   291                                  ;		New Buffer structure
   292                                  ;		New Sytem file table structure
   293                                  ;		FCB moved to internal representation
   294                                  ;		DOS re-organized
   295                                  ; 2.11 04/21/83 Continuation of 2.10, preliminary Network
   296                                  ;		device interface.
   297                                  ; 2.11 08/12/83 Dos split into several more modules for assembly on
   298                                  ;               an IBM PC
   299                                  ; 2.50 09/12/83 More network stuff
   300                                  ;
   301                                  ; *************************************************************
   302                                  
   303                                  ; ----------------------------------------------------------------------------
   304                                  ; EQUATES
   305                                  
   306                                  ; Interrupt Entry Points:
   307                                  
   308                                  ; INTBASE:      ABORT
   309                                  ; INTBASE+4:    COMMAND
   310                                  ; INTBASE+8:    BASE EXIT ADDRESS
   311                                  ; INTBASE+C:    CONTROL-C ABORT
   312                                  ; INTBASE+10H:  FATAL ERROR ABORT
   313                                  ; INTBASE+14H:  BIOS DISK READ
   314                                  ; INTBASE+18H:  BIOS DISK WRITE
   315                                  ; INTBASE+1CH:  END BUT STAY RESIDENT (NOT SET BY DOS)
   316                                  ; INTBASE+20H:  SPOOLER INTERRUPT
   317                                  ; INTBASE+40H:  Long jump to CALL entry point
   318                                  
   319                                  ENTRYPOINTSEG   EQU     0Ch
   320                                  MAXDIF          EQU     0FFFh
   321                                  SAVEXIT         EQU     10
   322                                  ; 06/05/2019
   323                                  WRAPOFFSET	EQU	0FEF0h  ; (MISC.ASM, MSDOS 6.0, 1991)
   324                                  
   325                                         ; INCLUDE DOSSYM.ASM
   326                                         ; INCLUDE DEVSYM.ASM
   327                                  
   328                                  ; SUBTTL ^C, terminate/abort/exit and Hard error actions
   329                                  ; PAGE
   330                                  ; There are three kinds of context resets that can occur during normal DOS
   331                                  ; functioning:  ^C trap, terminate/abort/exit, and Hard-disk error.  These must
   332                                  ; be handles in a clean fashion that allows nested executions along with the
   333                                  ; ability to trap one's own errors.
   334                                  ;
   335                                  ; ^C trap - A process may elect to catch his own ^Cs.  This is achieved by
   336                                  ;           using the $GET_INTERRUPT_VECTOR and $SET_INTERRUPT_VECTOR as
   337                                  ;           follows:
   338                                  ;
   339                                  ;           $GET_INTERRUPT_VECTOR for INT int_ctrl_c
   340                                  ;           Save it in static memory.
   341                                  ;           $SET_INTERRUPT_VECTOR for INT int_ctrl_c
   342                                  ;
   343                                  ;           The interrupt service routine must preserve all registers and
   344                                  ;           return carry set iff the operation is to be aborted (via abort
   345                                  ;           system call), otherwise, carry is reset and the operation is
   346                                  ;           restarted.  ANY DEVIATION FROM THIS WILL LEAD TO UNRELIABLE
   347                                  ;           RESULTS.
   348                                  ;
   349                                  ;           To restore original ^C processing (done on terminate/abort/exit),
   350                                  ;           restore INT int_ctrl_c from the saved vector.
   351                                  ;
   352                                  ; Hard-disk error -- The interrupt service routine for INT int_fatal_abort must
   353                                  ;           also preserve registers and return one of three values in AL: 0 and
   354                                  ;           1 imply retry and ignore (???)  and 2 indicates an abort.  The user
   355                                  ;           himself is not to issue the abort, rather, the dos will do it for
   356                                  ;           him by simulating a normal abort/exit system call.  ANY DEVIATION
   357                                  ;           FROM THIS WILL LEAD TO UNRELIABLE RESULTS.
   358                                  ;
   359                                  ; terminate/abort/exit -- The user may not, under any circumstances trap an
   360                                  ;           abort call.  This is reserved for knowledgeable system programs.
   361                                  ;           ANY DEVIATION FROM THIS WILL LEAD TO UNRELIABLE RESULTS.
   362                                  
   363                                  ;SUBTTL SEGMENT DECLARATIONS
   364                                  
   365                                  ; The following are all of the segments used.  They are declared in the order
   366                                  ; that they should be placed in the executable
   367                                  
   368                                  ;
   369                                  ; segment ordering for MSDOS
   370                                  ;
   371                                  
   372                                  ;START           SEGMENT BYTE PUBLIC 'START'
   373                                  ;START           ENDS
   374                                  
   375                                  ;CONSTANTS       SEGMENT BYTE PUBLIC 'CONST'
   376                                  ;CONSTANTS       ENDS
   377                                  
   378                                  ;DATA            SEGMENT WORD PUBLIC 'DATA'
   379                                  ;DATA            ENDS
   380                                  
   381                                  ;CODE            SEGMENT BYTE PUBLIC 'CODE'
   382                                  ;CODE            ENDS
   383                                  
   384                                  ;LAST            SEGMENT BYTE PUBLIC 'LAST'
   385                                  ;LAST            ENDS
   386                                  
   387                                  ;DOSGROUP    GROUP   CODE,CONSTANTS,DATA,LAST
   388                                  
   389                                  ; The following segment is defined such that the data/const classes appear
   390                                  ; before the code class for ROMification
   391                                  
   392                                  ;START		SEGMENT BYTE PUBLIC 'START'
   393                                  ;           	ASSUME  CS:DOSGROUP,DS:NOTHING,ES:NOTHING,SS:NOTHING
   394                                  ;		JMP     DOSINIT
   395                                  ;START		ENDS
   396                                  
   397                                  ;============================================================================
   398                                  ; BPB.INC, MSDOS 6.0, 1991
   399                                  ;============================================================================
   400                                  ; 09/07/2018 - Retro DOS v3.0
   401                                  
   402                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   403                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   404                                  ;									   ;
   405                                  
   406                                  ;**	BIOS PARAMETER BLOCK DEFINITION
   407                                  ;
   408                                  ;	The BPB contains information about the disk structure. It dates
   409                                  ;	back to the earliest FAT systems and so FAT information is
   410                                  ;	intermingled with physical driver information.
   411                                  ;
   412                                  ;	A boot sector contains a BPB for its device; for other disks
   413                                  ;	the driver creates a BPB. DOS keeps copies of some of this
   414                                  ;	information in the DPB.
   415                                  ;
   416                                  ;	The BDS structure contains a BPB within it. 
   417                                  
   418                                  ; 01/01/2024
   419                                  %if 0
   420                                  
   421                                  struc A_BPB
   422                                  .BPB_BYTESPERSECTOR:	resw	1
   423                                  .BPB_SECTORSPERCLUSTER:	resb	1
   424                                  .BPB_RESERVEDSECTORS:	resw	1
   425                                  .BPB_NUMBEROFFATS:	resb	1
   426                                  .BPB_ROOTENTRIES: 	resw	1
   427                                  .BPB_TOTALSECTORS:	resw	1
   428                                  .BPB_MEDIADESCRIPTOR:	resb	1
   429                                  .BPB_SECTORSPERFAT:	resw	1
   430                                  .BPB_SECTORSPERTRACK:	resw	1
   431                                  .BPB_HEADS:		resw	1
   432                                  .BPB_HIDDENSECTORS:	resw	1
   433                                  			resw	1
   434                                  .BPB_BIGTOTALSECTORS:	resw	1
   435                                  			resw	1
   436                                  			resb	6	; NOTE:  many times these
   437                                  ;					; 	 6 bytes are omitted
   438                                  ;					;	 when BPB manipulations
   439                                  ;					;	 are performed!
   440                                  .size:
   441                                  endstruc
   442                                  
   443                                  %else
   444                                  
   445                                  ; 01/01/2024 - Retro DOS v5.0	
   446                                  
   447                                  struc A_BPB
   448 00000000 ????                    .BYTESPERSECTOR:    resw 1
   449 00000002 ??                      .SECTORSPERCLUSTER: resb 1
   450 00000003 ????                    .RESERVEDSECTORS:   resw 1
   451 00000005 ??                      .NUMBEROFFATS:	    resb 1
   452 00000006 ????                    .ROOTENTRIES:	    resw 1
   453 00000008 ????                    .TOTALSECTORS:	    resw 1
   454 0000000A ??                      .MEDIADESCRIPTOR:   resb 1
   455 0000000B ????                    .SECTORSPERFAT:	    resw 1
   456 0000000D ????                    .SECTORSPERTRACK:   resw 1
   457 0000000F ????                    .HEADS:		    resw 1
   458 00000011 ????????                .HIDDENSECTORS:	    resd 1
   459 00000015 ????????                .BIGTOTALSECTORS:   resd 1
   460                                  ;............ FAT32 ......  + 28
   461 00000019 ????????                .FATSIZE32:	    resd 1
   462 0000001D ????                    .EXTFLAGS:	    resw 1
   463 0000001F ????                    .FSVER:		    resw 1
   464 00000021 ????????                .ROOTDIRCLUSTER:    resd 1
   465 00000025 ????                    .FSINFOSECTOR:	    resw 1  ; (offset from FAT32 bs)
   466 00000027 ????                    .BACKUPBOOTSECTOR:  resw 1  ; (offset from FAT32 bs)
   467 00000029 <res Ch>                .RESERVEDBYTES:	    resb 12 ; (zero bytes)
   468                                  .size:
   469                                  endstruc
   470                                  
   471                                  %endif
   472                                  
   473                                  ;                                                                          ;
   474                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
   475                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   476                                  
   477                                  ;============================================================================
   478                                  ; BUFFER.INC, MSDOS 6.0, 1991
   479                                  ;============================================================================
   480                                  ; 04/05/2019 - Retro DOS v4.0
   481                                  ; 03/01/2024 - Retro DOS v5.0
   482                                  
   483                                  ; <Disk I/O Buffer Header>
   484                                  
   485                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   486                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   487                                  ;									   ;
   488                                  
   489                                  ; Field definition for I/O buffer information
   490                                  
   491                                  	; 03/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
   492                                  
   493                                  struc BUFFINFO
   494 00000000 ????                    .buf_next:	resw 1		; Pointer to next buffer in list
   495 00000002 ????                    .buf_prev:	resw 1		; Pointer to prev buffer in list
   496 00000004 ??                      .buf_ID:	resb 1		; Drive of buffer (bit 7 = 0)
   497                                  				; SFT table index (bit 7 = 1)
   498                                  				; = FFH if buffer free
   499 00000005 ??                      .buf_flags:	resb 1		; Bit 7 = 1 if Remote file buffer
   500                                  				;	= 0 if Local device buffer
   501                                  				; Bit 6 = 1 if buffer dirty
   502                                  				; Bit 5 = Reserved
   503                                  				; Bit 4 = Search bit (bit 7 = 1)
   504                                  				; Bit 3 = 1 if buffer is DATA
   505                                  				; Bit 2 = 1 if buffer is DIR
   506                                  				; Bit 1 = 1 if buffer is FAT
   507                                  				; Bit 0 = Reserved
   508 00000006 ????????                .buf_sector:	resd 1		; Sector number of buffer (flags bit 7 = 0)
   509                                  ; The next two items are often refed as a word (flags bit 7 = 0)
   510 0000000A ??                      .buf_wrtcnt:	resb 1		; For FAT sectors, # times sector written out
   511 0000000B ????                    .buf_wrtcntinc:	resw 1		; "   "     "   , # sectors between each write
   512 0000000D ????                    		resw 1 ; * ; 03/01/2024 ; PCDOS 7.1
   513                                  			   ; hw of sectors per FAT
   514 0000000F ????????                .buf_DPB:	resd 1		; Pointer to drive parameters
   515 00000013 ????                    .buf_fill:	resw 1		; How full buffer is (flags bit 7 = 1)
   516 00000015 ??                      .buf_reserved:	resb 1		; make DWORD boundary for 386
   517 00000016 ????                    		resw 1 ; * ; 03/01/2024 ; PCDOS 7.1
   518                                  			   ; reserved word for dword boundary
   519                                  .size:	; 20 bytes ; MSDOS 5.0 to 6.22
   520                                  	; 24 bytes ; PCDOS 7.1 ; 03/01/2024
   521                                  endstruc
   522                                  
   523                                  %define buf_offset	BUFFINFO.buf_sector ; 22/07/2019
   524                                  				;For buf_flags bit 7 = 1, this is the byte
   525                                  				;offset of the start of the buffer in
   526                                  				;the file pointed to by buf_ID. Thus
   527                                  				;the buffer starts at location
   528                                  				;buf_offset in the file and contains
   529                                  				;buf_fill bytes.
   530                                  
   531                                  BUFINSIZ        EQU     BUFFINFO.size
   532                                  
   533                                  buf_Free	EQU	0FFh	; buf_id of free buffer
   534                                  
   535                                  ;Flag byte masks
   536                                  buf_isnet	EQU	10000000B
   537                                  buf_dirty	EQU	01000000B
   538                                  ;***
   539                                  buf_visit	EQU	00100000B
   540                                  ;***
   541                                  buf_snbuf	EQU	00010000B
   542                                  
   543                                  buf_isDATA	EQU	00001000B
   544                                  buf_isDIR	EQU	00000100B
   545                                  buf_isFAT	EQU	00000010B
   546                                  buf_type_0	EQU	11110001B	; AND sets type to "none"
   547                                  
   548                                  buf_NetID	EQU	BUFINSIZ
   549                                  
   550                                  ;                                                                          ;
   551                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
   552                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   553                                  
   554                                  ;============================================================================
   555                                  ; DOSSSYM.INC, MSDOS 6.0, 1991
   556                                  ;============================================================================
   557                                  ; 04/05/2019 - Retro DOS v4.0
   558                                  
   559                                  ; <Control character definitions>
   560                                  
   561                                  c_DEL	    EQU     7Fh 	;    ASCII rubout or delete previous char
   562                                  c_BS	    EQU     08h 	; ^H ASCII backspace
   563                                  c_CR	    EQU     0Dh 	; ^M ASCII carriage return
   564                                  c_LF	    EQU     0Ah 	; ^J ASCII linefeed
   565                                  c_ETB	    EQU     17h 	; ^W ASCII end of transmission
   566                                  c_NAK	    EQU     15h 	; ^U ASCII negative acknowledge
   567                                  c_ETX	    EQU     03h 	; ^C ASCII end of text
   568                                  c_HT	    EQU     09h 	; ^I ASCII tab
   569                                  
   570                                  ; <User stack inside of system call>
   571                                  ; Location of user registers relative user stack pointer
   572                                  
   573                                  struc	user_env   ; user_environ
   574 00000000 ????                    .user_AX: resw 1
   575 00000002 ????                    .user_BX: resw 1
   576 00000004 ????                    .user_CX: resw 1
   577 00000006 ????                    .user_DX: resw 1
   578 00000008 ????                    .user_SI: resw 1
   579 0000000A ????                    .user_DI: resw 1
   580 0000000C ????                    .user_BP: resw 1
   581 0000000E ????                    .user_DS: resw 1
   582 00000010 ????                    .user_ES: resw 1
   583 00000012 ????                    .user_IP: resw 1
   584 00000014 ????                    .user_CS: resw 1
   585 00000016 ????                    .user_F:  resw 1
   586                                  .size:
   587                                  endstruc
   588                                  
   589                                  ; ---- <Disk map> ----
   590                                  
   591                                  ;	MSDOS partitions the disk into 4 sections:
   592                                  ;
   593                                  ;  phys sector 0:   +-------------------+
   594                                  ;	|	    | boot/reserved	|
   595                                  ;	|	    +-------------------+
   596                                  ;	|	    |  File allocation	|
   597                                  ;	v	    |	   table(s)	|
   598                                  ;		    |  (multiple copies |
   599                                  ;		    |	  are kept)	|
   600                                  ;		    +-------------------+
   601                                  ;		    |	  Directory	|
   602                                  ;		    +-------------------+
   603                                  ;		    |	  File space	|
   604                                  ;		    +-------------------+
   605                                  ;		    |	Unaddressable	|
   606                                  ;		    |  (to end of disk) |
   607                                  ;		    +-------------------+
   608                                  ;
   609                                  ; All partition boundaries are sector boundaries. The size of the FAT is
   610                                  ; adjusted to maximize the file space addressable.
   611                                  
   612                                  ; <File allocation Table information>
   613                                  
   614                                  ; The File Allocation Table uses a 12-bit entry for each allocation unit on
   615                                  ; the disk. These entries are packed, two for every three bytes. The contents
   616                                  ; of entry number N is found by 1) multiplying N by 1.5; 2) adding the result
   617                                  ; to the base address of the Allocation Table; 3) fetching the 16-bit word
   618                                  ; at this address; 4) If N was odd (so that N*1.5 was not an integer), shift
   619                                  ; the word right four bits; 5) mask to 12 bits (AND with 0FFF hex). Entry
   620                                  ; number zero is used as an end-of-file trap in the OS and is passed to the
   621                                  ; BIOS to help determine disk format. Entry 1 is reserved for future use.
   622                                  ; The first available allocation unit is assigned entry number two, and even
   623                                  ; though it is the first, is called cluster 2. Entries greater than 0FF8H
   624                                  ; (12-bit fats) or 0FFF8H (16-bit fats) are end of file marks; entries of zero
   625                                  ; are unallocated. Otherwise, the contents of a FAT entry is the number of
   626                                  ; the next cluster in the file.
   627                                  ;
   628                                  ; Clusters with bad sectors are tagged with FF7H. Any non-zero number would
   629                                  ; do because these clusters show as allocated, but are not part of any
   630                                  ; allocation chain and thus will never be allocated to a file. A particular
   631                                  ; number is selected so that disk checking programs know what to do (ie. a
   632                                  ; cluster with entry FF7H which is not in a chain is not an error).
   633                                  
   634                                  ;**	Character Type Flags
   635                                  ;
   636                                  ;	These flags are used in a lookup table indexed by the character code.
   637                                  ;	They're used to quickly classify characters when parsing paths.
   638                                  ;	I think that these are only used to parse FCBs - jgl
   639                                  
   640                                  FCHK	equ 1	; I think this means "normal name char, no chks needed" -jgl
   641                                  FDELIM	equ 2	; is a delimiter
   642                                  FSPCHK	equ 4	; set if character is not a space or equivalent
   643                                  FFCB	equ 8	; is valid in an FCB
   644                                  
   645                                  ;** Bit definitions for DOS_FLAG
   646                                  ;
   647                                  ; Bit 0 - this is set when a $open call is made from $exec. This is used in
   648                                  ;	  $open to indicate to the redirector that this open is being made
   649                                  ;	  by an exec call.
   650                                  ;
   651                                  ; Bit 2
   652                                  ;
   653                                  ; M003, M027:
   654                                  ;
   655                                  ; The start up code of MS PASCAL 3.2 programs depend on the 1M address wrap 
   656                                  ; if they load below 64K. This is a likely possiblity in DOS 5.x with DOS in
   657                                  ; the HMA. By default DOS will turn A20 OFF before Xferring control to the
   658                                  ; user program in the case of an Exec call. The next call to DOS will turn
   659                                  ; A20 line ON. It has been observed that MS PASCAL 3.2 start up does an int
   660                                  ; 21 ah=25h call before executing the faulty code. This will turn A20 On. 
   661                                  ; In order to support this we will set Bit 2 of this flag in the DOS exec
   662                                  ; call (msproc.asm) if DOS is running in the HMA. In $set_interrupt_vector in
   663                                  ; getset.asm A20OFF_COUNT is set to 1 if bit 2 of DOS_FLAG was previously set 
   664                                  ; by a call to exec and if A20OFF_COUNT is 0. In msdisp.asm, if A20OFF_COUNT 
   665                                  ; is non zero then A20 will be turned OFF before returning to the user. 
   666                                  ; Bit 2 will be unconditionally cleared here.
   667                                  ;
   668                                  ; M009, M027:
   669                                  ;
   670                                  ; Mace utilities MKEYRATE.COM version 1.0 copyright 1987 is an execpacked 
   671                                  ; program converted to a com file. Therefore if DOS is loaded high and if 
   672                                  ; this program is loaded below 64K it will blurt out "packed file is corrupt".
   673                                  ; This program does an int 21 ah=49h before executing the buggy execpacked
   674                                  ; code. This int21 call turns a20 on and hence the problem. In $dealloc
   675                                  ; alloc.asm A20OFF_COUNT is set to 1 if bit 2 of DOS_FLAG was previously set 
   676                                  ; by a call to exec and if A20OFF_COUNT is 0. In msdisp.asm, if A20OFF_COUNT 
   677                                  ; is non zero then A20 will be turned OFF before returning to the user. 
   678                                  ; Bit 2 will be unconditionally cleared here.
   679                                  
   680                                  EXECOPEN	EQU	00000001b	; bit 0 of DOS_FLAG
   681                                  SUPPRESS_WINA20	EQU	00000010b	; M025
   682                                  EXECA20OFF	EQU	00000100b	; bit 2 of DOS_FLAG
   683                                  
   684                                  ;============================================================================
   685                                  ; VECTOR.INC, MSDOS 6.0, 1991
   686                                  ;============================================================================
   687                                  ; 04/05/2019 - Retro DOS v4.0
   688                                  
   689                                  ; 09/07/2018 - Retro DOS v3.0 (VECTOR.INC, MSDOS 3.3, 1987)
   690                                  
   691                                  ; <interrupt definitions>
   692                                  
   693                                  INTTAB          EQU     20H
   694                                  INTBASE         EQU     4 * INTTAB
   695                                  ENTRYPOINT      EQU     INTBASE+40H
   696                                  
   697                                  ;	IF      ALTVECT
   698                                  ;ALTTAB  EQU     0F0H
   699                                  ;ALTBASE EQU     4 * ALTTAB
   700                                  ;	ENDIF
   701                                  
   702                                  ;
   703                                  ; interrupt assignments
   704                                  ;
   705                                  ;	IF	NOT ALTVECT
   706                                  int_abort	    EQU     INTTAB	; abort process
   707                                  int_command	    EQU     int_abort+1 ; call MSDOS
   708                                  int_terminate	    EQU     int_abort+2 ; int to terminate address
   709                                  int_ctrl_c	    EQU     int_abort+3 ; ^c trapper
   710                                  int_fatal_abort     EQU     int_abort+4 ; hard disk error
   711                                  int_disk_read	    EQU     int_abort+5 ; logical sector disk read
   712                                  int_disk_write	    EQU     int_abort+6 ; logical sector disk write
   713                                  int_keep_process    EQU     int_abort+7 ; terminate program and stay
   714                                  					; resident
   715                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   716                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   717                                  ;									   ;
   718                                  int_spooler	    EQU     int_abort+8 ; spooler call
   719                                  int_fastcon	    EQU     int_abort+9 ; fast CON interrupt
   720                                  int_IBM 	    EQU     int_abort+10; critical section maintenance
   721                                  ;									   ;
   722                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   723                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   724                                  ;	ELSE
   725                                  ;int_abort	    EQU     INTTAB	; abort process
   726                                  ;int_command	    EQU     int_abort+1 ; call MSDOS
   727                                  ;int_terminate	    EQU     ALTTAB	; int to terminate address
   728                                  ;int_ctrl_c	    EQU     int_terminate+1 ; ^c trapper
   729                                  ;int_fatal_abort    EQU     int_terminate+2 ; hard disk error
   730                                  ;int_disk_read	    EQU     int_abort+5 ; logical sector disk read
   731                                  ;int_disk_write	    EQU     int_abort+6 ; logical sector disk write
   732                                  ;int_keep_process   EQU     int_abort+7 ; terminate program and stay resident
   733                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   734                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   735                                  ;									   ;
   736                                  ;int_spooler	    EQU     int_terminate+3 ; spooler call
   737                                  ;int_fastcon	    EQU     int_abort+9 ; fast CON interrupt
   738                                  ;									   ;
   739                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   740                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   741                                  ;	ENDIF
   742                                  
   743                                  addr_int_abort		EQU    4 * int_abort
   744                                  addr_int_command	EQU    4 * int_command
   745                                  addr_int_terminate	EQU    4 * int_terminate
   746                                  addr_int_ctrl_c 	EQU    4 * int_ctrl_c
   747                                  addr_int_fatal_abort	EQU    4 * int_fatal_abort
   748                                  addr_int_disk_read	EQU    4 * int_disk_read
   749                                  addr_int_disk_write	EQU    4 * int_disk_write
   750                                  addr_int_keep_process	EQU    4 * int_keep_process
   751                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   752                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   753                                  ;									   ;
   754                                  addr_int_spooler	EQU    4 * int_spooler
   755                                  addr_int_fastcon	EQU    4 * int_fastcon
   756                                  addr_int_ibm		EQU    4 * int_IBM
   757                                  ;									   ;
   758                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   759                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   760                                  
   761                                  ;============================================================================
   762                                  ; DIRENT.INC, MSDOS 6.0, 1991
   763                                  ;============================================================================
   764                                  ; 04/05/2019 - Retro DOS v4.0
   765                                  
   766                                  ; BREAK <Directory entry>
   767                                  
   768                                  ;
   769                                  ;       +---------------------------+
   770                                  ;       |  (12 BYTE) filename/ext   |       0       0
   771                                  ;       +---------------------------+
   772                                  ;       |     (BYTE) attributes     |       11      B
   773                                  ;       +---------------------------+
   774                                  ;       |    (10 BYTE) reserved     |       12      C
   775                                  ;       +---------------------------+
   776                                  ;       | (WORD) time of last write |       22      16
   777                                  ;       +---------------------------+
   778                                  ;       | (WORD) date of last write |       24      18
   779                                  ;       +---------------------------+
   780                                  ;       |   (WORD) First cluster    |       26      1A
   781                                  ;       +---------------------------+
   782                                  ;       |     (DWORD) file size     |       28      1C
   783                                  ;       +---------------------------+
   784                                  ;
   785                                  ;   First byte of filename  = E5 -> free directory entry
   786                                  ;                           = 00 -> end of allocated directory
   787                                  ;   Time:   Bits 0-4=seconds/2, bits 5-10=minute, 11-15=hour
   788                                  ;   Date:   Bits 0-4=day, bits 5-8=month, bits 9-15=year-1980
   789                                  
   790                                  ; 01/01/2024
   791                                  %if 0
   792                                  
   793                                  struc dir_entry
   794                                  .dir_name:	resb 11			; file name
   795                                  .dir_attr:	resb 1			; attribute bits
   796                                  .dir_codepg:	resw 1			; code page DOS 4.00
   797                                  .dir_extcluster: resw 1			; extended attribute starting cluster
   798                                  .dir_attr2:	resb 1			; reserved
   799                                  .dir_pad:	resb 5			; reserved for expansion
   800                                  .dir_time:	resw 1			; time of last write
   801                                  .dir_date:	resw 1			; date of last write
   802                                  .dir_first:	resw 1			; first allocation unit of file
   803                                  .dir_size_l:	resw 1			; low 16 bits of file size
   804                                  .dir_size_h:	resw 1			; high 16 bits of file size
   805                                  .size:
   806                                  endstruc
   807                                  
   808                                  %else
   809                                  
   810                                  ; 01/01/2024 - Retro DOS v5.0 (*)
   811                                  
   812                                  struc dir_entry
   813 00000000 <res Bh>                .dir_name:	resb 11			; file name (short file name)
   814 0000000B ??                      .dir_attr:	resb 1			; file attributes (*)
   815 0000000C ??                      .dir_nt_res:	resb 1			; reserved for use by Windows NT. 0
   816                                  .dir_pad:	;resb 7			; (creation time, last access date
   817                                  					;  for use by Windows) 
   818                                  .dir_crttime_tenth:
   819 0000000D ??                      		resb 1
   820 0000000E ????                    .dir_crttime:	resw 1
   821 00000010 ????                    .dir_crtdate:	resw 1
   822                                  .dir_lstaccdate:
   823 00000012 ????                    		resw 1
   824 00000014 ????                    .dir_fclus_hi:	resw 1	; FAT32	fs	; high word of first cluster number
   825 00000016 ????                    .dir_time:	resw 1			; time of last write
   826 00000018 ????                    .dir_date:	resw 1			; date of last write
   827                                  .dir_fclus:				
   828 0000001A ????                    .dir_first:	resw 1			; first cluster (alloc. unit) of file
   829                                  .dir_file_size:
   830 0000001C ????                    .dir_size_l:	resw 1			; low 16 bits of file size
   831 0000001E ????                    .dir_size_h:	resw 1			; high 16 bits of file size
   832                                  .size:
   833                                  endstruc
   834                                  
   835                                  %endif
   836                                  
   837                                  attr_read_only      EQU      1h
   838                                  attr_hidden         EQU      2h
   839                                  attr_system         EQU      4h
   840                                  attr_volume_id      EQU      8h
   841                                  attr_directory      EQU     10h
   842                                  attr_archive        EQU     20h
   843                                  attr_device	    EQU     40h	; This is a VERY special bit.
   844                                  				;   NO directory entry on a disk EVER
   845                                  				;   has this bit set. It is set non-zero
   846                                  				;   when a device is found by GETPATH
   847                                  
   848                                  attr_all            EQU     attr_hidden+attr_system+attr_directory
   849                                                                          ; OR of hard attributes for FINDENTRY
   850                                  
   851                                  attr_ignore         EQU     attr_read_only+attr_archive
   852                                                                          ; ignore this(ese) attribute(s)
   853                                                                          ; during search first/next
   854                                  
   855                                  attr_changeable     EQU     attr_read_only+attr_hidden+attr_system+attr_archive
   856                                                                          ; changeable via CHMOD
   857                                  
   858                                  DIRFREE		equ	0E5h	; stored in dir_name[0] to indicate free slot
   859                                  
   860                                  ; ----------------------------------------------------------------------------
   861                                  ; 01/01/2024 - Retro DOS v5.0
   862                                  ; ref: FAT32 File System Specification v1.03 (Microsoft, December 6, 2000) (*)
   863                                  
   864                                  attr_long_name	equ attr_read_only|attr_hidden|attr_system|attr_volume_id
   865                                  attr_longname_mask equ attr_long_name|attr_directory|attr_archive
   866                                  
   867                                  ;============================================================================
   868                                  ; DPB.INC, MSDOS 6.0, 1991
   869                                  ;============================================================================
   870                                  ; 24/04/2019 - Retro DOS v4.0
   871                                  
   872                                  ; 19/07/2018 - Retro DOS v3.0 (DPB.INC, MSDOS 3.3, 1987)
   873                                  ; 07/07/2018 - Retro DOS v3.0 (DPB.INC, MSDOS 6.0, 1991)
   874                                  
   875                                  ; ---------------------------------------------------------------------------
   876                                  ;**	DPB - Drive Parameter Block
   877                                  ;
   878                                  ;	BUGBUG - this isn't authorative - it's my probably incomplete and
   879                                  ;	possibly inaccurate deductions from code study... - jgl
   880                                  ;
   881                                  ;	The DPB is DOS's main structure for describing block devices.
   882                                  ;	It contains info about the "Drive" intermingled with info about
   883                                  ;	the FAT file system which is presumably on the drive. I don't know
   884                                  ;	how those fields are used if it's not the FAT file system - BUGBUG
   885                                  ;
   886                                  ;	The DPBs are statically allocated and chained off of DPBHead.
   887                                  ;	Users scan this chain looking for a match on DPB_DRIVE.
   888                                  ;	The DPBs are built at init time from info in the SYSDEV structure.
   889                                  ; ---------------------------------------------------------------------------
   890                                  
   891                                  ; 01/01/2024
   892                                  %if 0
   893                                  
   894                                  struc	DPB
   895                                  .DRIVE:		resb 1		; Logical drive # assoc with DPB (A=0,B=1,...)
   896                                  .UNIT:		resb 1		; Driver unit number of DPB
   897                                  .SECTOR_SIZE:	resw 1		; Size of physical sector in bytes
   898                                  .CLUSTER_MASK:	resb 1		; Sectors/cluster - 1
   899                                  .CLUSTER_SHIFT:	resb 1		; Log2 of sectors/cluster
   900                                  .FIRST_FAT:	resw 1		; Starting record of FATs
   901                                  .FAT_COUNT:	resb 1		; Number of FATs for this drive
   902                                  .ROOT_ENTRIES:	resw 1		; Number of directory entries
   903                                  .FIRST_SECTOR:	resw 1		; First sector of first cluster
   904                                  .MAX_CLUSTER:	resw 1		; Number of clusters on drive + 1
   905                                  ; MSDOS 3.3
   906                                  ;.FAT_SIZE:	resb 1		; Number of records occupied by FAT
   907                                  ; MSDOS 6.0
   908                                  .FAT_SIZE:	resw 1		; Number of records occupied by FAT
   909                                  .DIR_SECTOR:	resw 1		; Starting record of directory
   910                                  .DRIVER_ADDR:	resd 1		; Pointer to driver
   911                                  .MEDIA:		resb 1		; Media byte
   912                                  .FIRST_ACCESS:	resb 1		; This is initialized to -1 to force a media
   913                                  				; check the first time this DPB is used
   914                                  .NEXT_DPB:	resd 1		; Pointer to next Drive parameter block
   915                                  .NEXT_FREE:	resw 1		; Cluster # of last allocated cluster
   916                                  .FREE_CNT:	resw 1		; Count of free clusters, -1 if unknown
   917                                  .size:
   918                                  endstruc
   919                                  
   920                                  %else
   921                                  
   922                                  ; 01/01/2024 - Retro DOS v5.0 (PCDOS 7.1)
   923                                  
   924                                  struc	DPB
   925 00000000 ??                      .DRIVE:		resb 1	; 0	; Logical drive # assoc with DPB (A=0,B=1,...)
   926 00000001 ??                      .UNIT:		resb 1	; 1	; Driver unit number of DPB
   927 00000002 ????                    .SECTOR_SIZE:	resw 1	; 2	; Size of physical sector in bytes
   928 00000004 ??                      .CLUSTER_MASK:	resb 1	; 4	; Sectors/cluster - 1
   929 00000005 ??                      .CLUSTER_SHIFT:	resb 1	; 5	; Log2 of sectors/cluster
   930 00000006 ????                    .FIRST_FAT:	resw 1	; 6	; Starting record of FATs
   931 00000008 ??                      .FAT_COUNT:	resb 1	; 8	; Number of FATs for this drive
   932 00000009 ????                    .ROOT_ENTRIES:	resw 1	; 9	; Number of directory entries
   933 0000000B ????                    .FIRST_SECTOR:	resw 1	; 11	; First sector of first cluster
   934 0000000D ????                    .MAX_CLUSTER:	resw 1	; 13	; Number of clusters on drive + 1
   935 0000000F ????                    .FAT_SIZE:	resw 1	; 15	; Number of records occupied by FAT
   936 00000011 ????                    .DIR_SECTOR:	resw 1	; 17	; Starting record of directory
   937 00000013 ????????                .DRIVER_ADDR:	resd 1  ; 19	; Pointer to driver
   938 00000017 ??                      .MEDIA:		resb 1	; 23	; Media byte
   939 00000018 ??                      .FIRST_ACCESS:	resb 1	; 24	; This is initialized to -1 to force a media
   940                                  				; check the first time this DPB is used
   941 00000019 ????????                .NEXT_DPB:	resd 1	; 25	; Pointer to next Drive parameter block
   942 0000001D ????                    .NEXT_FREE:	resw 1	; 29	; Cluster # of last allocated cluster
   943 0000001F ????                    .FREE_CNT:	resw 1	; 31	; Count of free clusters, -1 if unknown
   944                                  ; FAT32 fs ; 01/01/2024
   945                                  ; ref: https://en.wikibooks.org/wiki/
   946                                  ;      First_steps_towards_system_programming_under_MS-DOS_7/Appendix
   947                                  ;   -- A.03-1. Structure of Drive Parameters Blocks (DPB) ---
   948 00000021 ????                    .FREE_CNT_HW:	resw 1	; 33	; High word of free cluster count
   949 00000023 ????                    .EXT_FLAGS:	resw 1	; 35	; FAT32 extended flags (active FAT number)
   950 00000025 ????                    .FSINFO_SECTOR:	resw 1	; 37	; (FAT32 fs) FSINFO structure sector address
   951 00000027 ????                    .BKBOOT_SECTOR:	resw 1	; 39	; (FAT32 fs) Backup Boot Sector address
   952 00000029 ????????                .FCLUS_FSECTOR: resd 1	; 41	; The first cluster's first sector address
   953 0000002D ????????                .LAST_CLUSTER:	resd 1	; 45	; The last cluster number
   954 00000031 ????????                .FAT32_SIZE:	resd 1	; 49	; Number of FAT sectors (for FAT32 fs)	 
   955 00000035 ????????                .ROOT_CLUSTER:	resd 1	; 53	; Root directory's cluster number (FAT32 fs)
   956                                  ; 01/01/2024 - Retro DOS v5.0
   957 00000039 ????????                .FAT32_NXTFREE:	resd 1  ; 57	; The next free cluster (for FAT32 fs)
   958                                  .size:		; 61 bytes ; 01/01/2024 (PCDOS 7.1)
   959                                  endstruc
   960                                  
   961                                  
   962                                  %endif
   963                                  
   964                                  DPBSIZ  EQU     DPB.size	; Size of the structure in bytes
   965                                  
   966                                  DSKSIZ  EQU	DPB.MAX_CLUSTER	; Size of disk (temp used during init only)
   967                                  
   968                                  ;                                                                          ;
   969                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
   970                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   971                                  
   972                                  ;============================================================================
   973                                  ; SF.INC, MSDOS 6.0, 1991
   974                                  ;============================================================================
   975                                  ; 25/04/2019 - Retro DOS v4.0
   976                                  ; 07/07/2018 - Retro DOS v3.0
   977                                  
   978                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   979                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
   980                                  ;                                                                          ;
   981                                  
   982                                  ; ---------------------------------------------------------------------------
   983                                  ;**	SF.INC - System File Table
   984                                  ;
   985                                  ;   AN000   version 4.00   Jan. 1988
   986                                  ;   AN003   PTM 3680 --  make NAME offset the same as before (<=3.30)
   987                                  ;   AN009   PTM 3839	 reorder SFT for MS WINDOWS
   988                                  ; ---------------------------------------------------------------------------
   989                                  ;**	System File Table SuperStructure
   990                                  ;
   991                                  ;	The system file table entries are allocated in contiguous groups.
   992                                  ;	There may be more than one such groups; the SF "superstructure"
   993                                  ;	tracks the groups.
   994                                  ; ---------------------------------------------------------------------------
   995                                  
   996                                  struc	SFT
   997 00000000 ????????                .SFLink:	resd 1
   998 00000004 ????                    .SFCount:	resw 1		; number of entries
   999 00000006 ????                    .SFTable:	resw 1		; beginning of array of the following
  1000                                  .size:
  1001                                  endstruc
  1002                                  
  1003                                  ; ---------------------------------------------------------------------------
  1004                                  ;**	System file table entry
  1005                                  ;
  1006                                  ;	These are the structures which are at SFTABLE in the SF structure.
  1007                                  ; ---------------------------------------------------------------------------
  1008                                  
  1009                                  ; 01/01/2024 - Retro DOS v5.0
  1010                                  ; 25/04/2019 - Retro DOS v4.0
  1011                                  
  1012                                  struc SF_ENTRY
  1013 00000000 ????                    .sf_ref_count:	resw 1	; 0	; number of processes sharing entry
  1014                                  				;   if FCB then ref count
  1015 00000002 ????                    .sf_mode:	resw 1	; 2	; mode of access or high bit on if FCB
  1016 00000004 ??                      .sf_attr:	resb 1	; 4	; attribute of file
  1017 00000005 ????                    .sf_flags:	resw 1	; 5	;Bits 8-15
  1018                                  				; Bit 15 = 1 if remote file
  1019                                  				;	 = 0 if local file or device
  1020                                  				; Bit 14 = 1 if date/time is not to be
  1021                                  				;   set from clock at CLOSE. Set by
  1022                                  				;   FILETIMES and FCB_CLOSE. Reset by
  1023                                  				;   other reseters of the dirty bit
  1024                                  				;   (WRITE)
  1025                                  				; Bit 13 = Pipe bit (reserved)
  1026                                  				;
  1027                                  				; Bits 0-7 (old FCB_devid bits)
  1028                                  				; If remote file or local file, bit
  1029                                  				; 6=0 if dirty Device ID number, bits
  1030                                  				; 0-5 if local file.
  1031                                  				; bit 7=0 for local file, bit 7
  1032                                  				;      =1 for local I/O device
  1033                                  				; If local I/O device, bit 6=0 if EOF (input)
  1034                                  				;		Bit 5=1 if Raw mode
  1035                                  				;		Bit 0=1 if console input device
  1036                                  				;		Bit 1=1 if console output device
  1037                                  				;		Bit 2=1 if null device
  1038                                  				;		Bit 3=1 if clock device
  1039 00000007 ????????                .sf_devptr:	resd	1 ; 7	; Points to DPB if local file, points
  1040                                  				; to device header if local device,
  1041                                  				; points to net device header if
  1042                                  				; remote
  1043 0000000B ????                    .sf_firclus:	resw	1 ; 11	; First cluster of file (bit 15 = 0)
  1044 0000000D ????                    .sf_time:	resw	1 ; 13	; Time associated with file
  1045 0000000F ????                    .sf_date:	resw	1 ; 15	; Date associated with file
  1046 00000011 ????????                .sf_size:	resd 	1 ; 17	; Size associated with file
  1047 00000015 ????????                .sf_position:	resd	1 ; 21	; Read/Write pointer or LRU count for FCBs
  1048                                  
  1049                                  ; Starting here, the next 7 bytes may be used by the file system to store
  1050                                  ; an ID
  1051                                  
  1052                                  ; 09/07/2018 - Retro DOS v3.0
  1053                                  
  1054                                  ; MSDOS 3.3 SF.INC, 1987
  1055                                  ;.sf_cluspos:	resw	1	; Position of last cluster accessed
  1056                                  ;.sf_lstclus	resw	1	; Last cluster accessed
  1057                                  ;.sf_dirsec:	resw	1	; Sector number of directory sector
  1058                                  ;				; for this file
  1059                                  ;.sf_dirpos:	resb	1	; Offset of this entry in the above
  1060                                  
  1061                                  ; MSDOS 6.0, SF.INC, 1991
  1062 00000019 ????                    .sf_cluspos:	resw	1 ; 25	; Position of last cluster accessed
  1063 0000001B ????????                .sf_dirsec:	resd	1 ; 27	; Sector number of directory sector
  1064                                  				; for this file
  1065 0000001F ??                      .sf_dirpos:	resb	1 ; 31	; Offset of this entry in the above
  1066                                  
  1067                                  ; End of 7 bytes of file-system specific info.
  1068                                  
  1069 00000020 <res Bh>                .sf_name:	resb	11 ; 32	; 11 character name that is in the
  1070                                  				; directory entry. This is used by
  1071                                  				; close to detect file deleted and
  1072                                  				; disk changed errors.
  1073                                  .sf_fclus32:	; 22/03/2024
  1074                                  ; SHARING INFO
  1075 0000002B ????????                .sf_chain:	resd	1 ; 43	; link to next SF
  1076 0000002F ????                    .sf_UID:	resw	1 ; 47
  1077 00000031 ????                    .sf_PID:	resw	1 ; 49	; owner process identifier (PSP segment) 
  1078 00000033 ????                    .sf_MFT:	resw	1 ; 51
  1079                                  
  1080                                  ; MSDOS 6.0, SF.INC, 1991
  1081 00000035 ????                    .sf_lstclus:	resw	1 ; 53	;AN009; Last cluster accessed
  1082 00000037 ????????                .sf_IFS_HDR:	resd	1 ; 55	; pointer to IFS drive or 0:0 for files
  1083                                  
  1084                                  .size:
  1085                                  endstruc
  1086                                  
  1087                                  ; 20/07/2018
  1088                                  ; MSDOS 3.3, SF.INC, 1987
  1089                                  %define sf_netid   SF_ENTRY.sf_cluspos    ; byte
  1090                                  %define sf_OpenAge SF_ENTRY.sf_position+2 ; word
  1091                                  %define sf_LRU	   SF_ENTRY.sf_position	  ; word
  1092                                  ; MSDOS 6.0, SF.INC, 1991
  1093                                  %define sf_fsda	     SF_ENTRY.sf_cluspos  ; byte ;DOS 4.00
  1094                                  %define sf_serial_ID SF_ENTRY.sf_firclus  ; word ;DOS 4.00
  1095                                  
  1096                                  ; 19/07/2018
  1097                                  ; MSDOS 3.3, SF.INC, 1987
  1098                                  
  1099                                  sf_default_number  EQU	5
  1100                                  
  1101                                  ; Note that we need to mark an SFT as being busy for OPEN/CREATE. This is
  1102                                  ; because an INT 24 may prevent us from 'freeing' it. We mark this as such
  1103                                  ; by placing a -1 in the ref_count field.
  1104                                  
  1105                                  sf_busy EQU -1
  1106                                  
  1107                                  ; mode mask for FCB detection
  1108                                  sf_isFCB		EQU	1000000000000000B
  1109                                  
  1110                                  ; Flag word masks
  1111                                  sf_isnet		EQU	1000000000000000B
  1112                                  sf_close_nodate 	EQU	0100000000000000B
  1113                                  sf_pipe 		EQU	0010000000000000B
  1114                                  sf_no_inherit		EQU	0001000000000000B
  1115                                  sf_net_spool		EQU	0000100000000000B
  1116                                  
  1117                                  ; 25/04/2019
  1118                                  sf_entry_size equ SF_ENTRY.size ; 59 (MSDOS 6.0)
  1119                                  
  1120                                  ; ---------------------------------------------------------------------------
  1121                                  ; Local file/device flag masks
  1122                                  ; ---------------------------------------------------------------------------
  1123                                  
  1124                                  devid_file_clean        EQU     40h     ; true if file and not written
  1125                                  devid_file_mask_drive   EQU     3Fh     ; mask for drive number
  1126                                  
  1127                                  devid_device            EQU     80h     ; true if a device
  1128                                  devid_device_EOF        EQU     40h     ; true if end of file reached
  1129                                  devid_device_raw        EQU     20h     ; true if in raw mode
  1130                                  devid_device_special    EQU     10h     ; true if special device
  1131                                  devid_device_clock      EQU     08h     ; true if clock device
  1132                                  devid_device_null       EQU     04h     ; true if null device
  1133                                  devid_device_con_out    EQU     02h     ; true if console output
  1134                                  devid_device_con_in     EQU     01h     ; true if console input
  1135                                  
  1136                                  ; ---------------------------------------------------------------------------
  1137                                  ; structure of devid field as returned by IOCTL is:
  1138                                  ;
  1139                                  ;       BIT     7   6   5   4   3   2   1   0
  1140                                  ;             |---|---|---|---|---|---|---|---|
  1141                                  ;             | I | E | R | S | I | I | I | I |
  1142                                  ;             | S | O | A | P | S | S | S | S |
  1143                                  ;             | D | F | W | E | C | N | C | C |
  1144                                  ;             | E |   |   | C | L | U | O | I |
  1145                                  ;             | V |   |   | L | K | L | T | N |
  1146                                  ;             |---|---|---|---|---|---|---|---|
  1147                                  ;       ISDEV = 1 if this channel is a device
  1148                                  ;             = 0 if this channel is a disk file
  1149                                  ;
  1150                                  ;       If ISDEV = 1
  1151                                  ;
  1152                                  ;             EOF = 0 if End Of File on input
  1153                                  ;             RAW = 1 if this device is in Raw mode
  1154                                  ;                 = 0 if this device is cooked
  1155                                  ;             ISCLK = 1 if this device is the clock device
  1156                                  ;             ISNUL = 1 if this device is the null device
  1157                                  ;             ISCOT = 1 if this device is the console output
  1158                                  ;             ISCIN = 1 if this device is the console input
  1159                                  ;
  1160                                  ;       If ISDEV = 0
  1161                                  ;             EOF = 0 if channel has been written
  1162                                  ;             Bits 0-5 are the block device number for
  1163                                  ;                 the channel (0 = A, 1 = B, ...)
  1164                                  ; ---------------------------------------------------------------------------
  1165                                  
  1166                                  devid_ISDEV     EQU     80h
  1167                                  devid_EOF       EQU     40h
  1168                                  devid_RAW       EQU     20h
  1169                                  devid_SPECIAL   EQU     10H
  1170                                  devid_ISCLK     EQU     08h
  1171                                  devid_ISNUL     EQU     04h
  1172                                  devid_ISCOT     EQU     02h
  1173                                  devid_ISCIN     EQU     01h
  1174                                  
  1175                                  devid_block_dev EQU     1Fh             ; mask for block device number
  1176                                  
  1177                                  ;============================================================================
  1178                                  ; PDB.INC, MSDOS 6.0, 1991
  1179                                  ;============================================================================
  1180                                  ; 04/05/2019 - Retro DOS v4.0
  1181                                  ; 08/07/2018 - Retro DOS v3.0
  1182                                  
  1183                                  ; ---------------------------------------------------------------------------
  1184                                  ; BREAK <Process data block>
  1185                                  ; ---------------------------------------------------------------------------
  1186                                  ;**	Process data block (otherwise known as program header)
  1187                                  ;
  1188                                  
  1189                                  ;	These offset are documented in the MSDOS Encyclopedia, so nothing
  1190                                  ;	can be rearranged here, ever. Reserved areas are probably safe
  1191                                  ;	for use.
  1192                                  ; ---------------------------------------------------------------------------
  1193                                  
  1194                                  FILPERPROC	EQU     20
  1195                                  
  1196                                  struc PDB	; Process_data_block
  1197 00000000 ????                    .EXIT_CALL:	resw 1   	; INT int_abort system terminate
  1198 00000002 ????                    .BLOCK_LEN:	resw 1		; size of execution block
  1199 00000004 ??                                      resb 1
  1200 00000005 ??????????              .CPM_CALL:	resb 5		; ancient call to system
  1201 0000000A ????????                .EXIT:		resd 1		; pointer to exit routine
  1202 0000000E ????????                .CTRL_C:	resd 1		; pointer to ^C routine
  1203 00000012 ????????                .FATAL_ABORT:	resd 1		; pointer to fatal error
  1204 00000016 ????                    .PARENT_PID:	resw 1		; PID of parent (terminate PID)
  1205 00000018 <res 14h>               .JFN_TABLE:     resb FILPERPROC ; indices into system table
  1206 0000002C ????                    .ENVIRON:	resw 1		; segment address of environment
  1207 0000002E ????????                .USER_STACK:	resd 1		; stack of self during system calls
  1208 00000032 ????                    .JFN_Length:	resw 1		; number of handles allowed
  1209 00000034 ????????                .JFN_Pointer:	resd 1		; pointer to JFN table
  1210 00000038 ????????                .Next_PDB:	resd 1		; pointer to nested PDB's
  1211 0000003C ??                      .InterCon:	resb 1	; MSDOS 6.0 ; *** jh-3/28/90 *** 
  1212 0000003D ??                      .Append:	resb 1	; MSDOS 6.0 ; *** Not sure if still used ***
  1213 0000003E ????                    .Novell_Used:	resb 2	; MSDOS 6.0 ; Novell shell (redir) uses these
  1214 00000040 ????                    .Version:	resw 1	; MSDOS 6.0 ; DOS version reported to this app
  1215 00000042 <res Eh>                .PAD1:		resb 14 ; 0Eh
  1216 00000050 ??????????              .CALL_SYSTEM:	resb 5		; portable method of system call
  1217 00000055 ??????????????          .PAD2:		resb 7		; reserved so FCB 1 can be used as
  1218                                  				;  an extended FCB
  1219                                  ;endstruc 	; MSDOS 3.3
  1220                                  	  	; MSDOS 6.0
  1221 0000005C <res 10h>               .FCB1:		resb 16 ; 10h	; default FCB 1
  1222 0000006C <res 10h>               .FCB2:		resb 16 ; 10h	; default FCB 2
  1223 0000007C ????????                .PAD3:		resb 4		; not sure if this is used by PDB_FCB2
  1224 00000080 <res 80h>               .TAIL:		resb 128	; command tail and default DTA
  1225                                  endstruc
  1226                                  
  1227                                  ;============================================================================
  1228                                  ; EXE.INC, MSDOS 6.0, 1991
  1229                                  ;============================================================================
  1230                                  ; 04/05/2019 - Retro DOS v4.0
  1231                                  
  1232                                  ;**	EXE.INC - Definitions for the EXEC command and EXE files
  1233                                  ; ---------------------------------------------------------------------------
  1234                                  ; The following get used as arguments to the EXEC system call.  They indicate
  1235                                  ; whether or not the program is executed or whether or not a program header
  1236                                  ; gets created.
  1237                                  
  1238                                  exec_func_no_execute EQU 1	; no execute bit
  1239                                  exec_func_overlay    EQU 2	; overlay bit
  1240                                  
  1241                                  struc EXEC0
  1242 00000000 ????                    .ENVIRON:	resw 1		; seg addr of environment
  1243 00000002 ????????                .COM_LINE:	resd 1		; pointer to asciz command line
  1244 00000006 ????????                .5C_FCB:	resd 1		; default fcb at 5C
  1245 0000000A ????????                .6C_FCB:	resd 1		; default fcb at 6C
  1246                                  .size:
  1247                                  endstruc
  1248                                  
  1249                                  struc EXEC1
  1250 00000000 ????                    .ENVIRON:	resw 1		; seg addr of environment
  1251 00000002 ????????                .COM_LINE:	resd 1		; pointer to asciz command line
  1252 00000006 ????????                .5C_FCB:	resd 1		; default fcb at 5C
  1253 0000000A ????????                .6C_FCB:	resd 1		; default fcb at 6C
  1254 0000000E ????                    .SP:		resw 1		; stack pointer of program
  1255 00000010 ????                    .SS:		resw 1		; stack seg register of program
  1256 00000012 ????                    .IP:		resw 1		; entry point IP
  1257 00000014 ????                    .CS:		resw 1		; entry point CS
  1258                                  .size:
  1259                                  endstruc
  1260                                  
  1261                                  struc EXEC3
  1262 00000000 ????                    .load_addr:	resw 1		; seg address of load point
  1263 00000002 ????                    .reloc_fac:	resw 1		; relocation factor
  1264                                  endstruc
  1265                                  
  1266                                  ;**	Exit codes (in upper byte) for terminating programs
  1267                                  
  1268                                  EXIT_TERMINATE		EQU	0
  1269                                  EXIT_ABORT		EQU	0
  1270                                  EXIT_CTRL_C		EQU	1
  1271                                  EXIT_HARD_ERROR 	EQU	2
  1272                                  EXIT_KEEP_PROCESS	EQU	3
  1273                                  
  1274                                  ;**	EXE File Header Description
  1275                                  
  1276                                  struc EXE
  1277 00000000 ????                    .signature:   resw 1		; must contain 4D5A (yay zibo!)
  1278 00000002 ????                    .len_mod_512: resw 1		; low 9 bits of length
  1279 00000004 ????                    .pages:       resw 1		; number of 512b pages in file
  1280 00000006 ????                    .rle_count:   resw 1		; count of reloc entries
  1281 00000008 ????                    .par_dir:     resw 1		; number of paragraphs before image
  1282 0000000A ????                    .min_BSS:     resw 1		; minimum number of para of BSS
  1283 0000000C ????                    .max_BSS:     resw 1		; max number of para of BSS
  1284 0000000E ????                    .SS:          resw 1		; stack of image
  1285 00000010 ????                    .SP:          resw 1		; SP of image
  1286 00000012 ????                    .chksum:      resw 1		; checksum of file (ignored)
  1287 00000014 ????                    .IP:          resw 1		; IP of entry
  1288 00000016 ????                    .CS:          resw 1		; CS of entry
  1289 00000018 ????                    .rle_table:   resw 1		; byte offset of reloc table
  1290 0000001A ????                    .iov:         resw 1		; overlay number (0 for root)
  1291 0000001C ????????                .sym_tab:     resd 1		; offset of symbol table in file
  1292                                  .size:
  1293                                  endstruc
  1294                                  
  1295                                  exe_valid_signature     EQU 5A4Dh
  1296                                  exe_valid_old_signature EQU 4D5Ah
  1297                                  
  1298                                  ;**	EXE file symbol info definitions
  1299                                  
  1300                                  struc symbol_entry
  1301 00000000 ????????                .value:	resd 1
  1302 00000004 ????                    .type:	resw 1
  1303 00000006 ??                      .len:	resb 1
  1304 00000007 <res FFh>               .name:	resb 255
  1305                                  endstruc
  1306                                  
  1307                                  ;**	Data structure passed for ExecReady call
  1308                                  
  1309                                  struc ERStruc
  1310 00000000 ????                     .ER_Reserved:	resw	1	; reserved, should be zero
  1311 00000002 ????                     .ER_Flags:	resw	1
  1312 00000004 ????????                 .ER_ProgName:	resd	1	; ptr to ASCIIZ str of prog name
  1313 00000008 ????                     .ER_PSP:	resw	1	; PSP of the program
  1314 0000000A ????????                 .ER_StartAddr:	resd	1	; Start CS:IP of the program
  1315 0000000E ????????                 .ER_ProgSize:	resd	1	; Program size including PSP
  1316                                   .size:
  1317                                  endstruc
  1318                                  
  1319                                  ;** bit fields in ER_Flags
  1320                                  
  1321                                  ER_EXE		equ	0001h
  1322                                  ER_OVERLAY	equ	0002h
  1323                                  
  1324                                  
  1325                                  ;============================================================================
  1326                                  ; ARENA.INC, MSDOS 6.0, 1991
  1327                                  ;============================================================================
  1328                                  ; 24/04/2019 - Retro DOS v4.0
  1329                                  ; 04/08/2018 - Retro DOS v3.0
  1330                                  
  1331                                  ;BREAK <Memory arena structure>
  1332                                  
  1333                                  ;**	Arena Header
  1334                                  
  1335                                  struc ARENA
  1336 00000000 ??                      .SIGNATURE:	resb 1		; 4D for valid item, 5A for last item
  1337 00000001 ????                    .OWNER:		resw 1		; owner of arena item
  1338 00000003 ????                    .SIZE:		resw 1		; size in paragraphs of item
  1339 00000005 ??????                  .RESERVED:	resb 3		; reserved
  1340 00000008 ????????????????        .NAME:		resb 8		; owner file name
  1341                                  .headersize:			
  1342                                  endstruc
  1343                                  
  1344                                  ; 20/05/2019 - Retro DOS v4.0
  1345                                  ARENAHEADERSIZE equ ARENA.headersize 
  1346                                  
  1347                                  ; CAUTION: The routines in ALLOC.ASM rely on the fact that arena_signature
  1348                                  ; and arena_owner_system are all equal to zero and are contained in DI.
  1349                                  ; Change them and change ALLOC.ASM.
  1350                                  
  1351                                  arena_owner_system  EQU 0               ; free block indication
  1352                                  
  1353                                  arena_signature_normal	EQU 4Dh		; valid signature, not end of arena
  1354                                  arena_signature_end     EQU 5Ah         ; valid signature, last block in arena
  1355                                  
  1356                                  FIRST_FIT	EQU	00000000B
  1357                                  BEST_FIT	EQU	00000001B
  1358                                  LAST_FIT	EQU	00000010B
  1359                                  
  1360                                  ; MSDOS 6.0
  1361                                  LOW_FIRST	EQU	00000000B	; M001
  1362                                  HIGH_FIRST	EQU	10000000B	; M001
  1363                                  HIGH_ONLY	EQU	01000000B	; M001
  1364                                  
  1365                                  LINKSTATE	EQU	00000001B	; M002
  1366                                  
  1367                                  HF_MASK		EQU	~HIGH_FIRST	; M001
  1368                                  HO_MASK		EQU	~HIGH_ONLY	; M001
  1369                                  
  1370                                  STRAT_MASK	EQU	HF_MASK & HO_MASK	; M001;
  1371                                  						; M026: used to mask of bits
  1372                                  						; M026: 6 & 7 of AllocMethod
  1373                                  
  1374                                  ;============================================================================
  1375                                  ; MI.INC, MSDOS 6.0, 1991
  1376                                  ;============================================================================
  1377                                  ; 07/07/2018 - Retro DOS v3.0
  1378                                  
  1379                                  ;BREAK <Machine instruction, flag definitions and character types>
  1380                                  
  1381                                  mi_INT		EQU	0CDh
  1382                                  mi_long_jmp	EQU	0EAh
  1383                                  mi_Long_CALL	EQU	09Ah
  1384                                  mi_Long_RET	EQU	0CBh
  1385                                  mi_Near_RET	EQU	0C3h
  1386                                  
  1387                                  ;			xxxxoditszxaxpxc
  1388                                  f_Overflow	EQU	0000100000000000B
  1389                                  f_Direction	EQU	0000010000000000B
  1390                                  f_Interrupt	EQU	0000001000000000B
  1391                                  f_Trace 	EQU	0000000100000000B
  1392                                  f_Sign		EQU	0000000010000000B
  1393                                  f_Zero		EQU	0000000001000000B
  1394                                  f_Aux		EQU	0000000000010000B
  1395                                  f_Parity	EQU	0000000000000100B
  1396                                  f_Carry 	EQU	0000000000000001B
  1397                                  
  1398                                  ;============================================================================
  1399                                  ; FILEMODE.INC, MSDOS 6.0, 1991
  1400                                  ;============================================================================
  1401                                  ; 13/07/2018 - Retro DOS v3.0
  1402                                  ; 29/04/2019 - Retro DOS v4.0
  1403                                  
  1404                                  ;**	Standard I/O file handles
  1405                                  
  1406                                  stdin       EQU     0
  1407                                  stdout      EQU     1
  1408                                  stderr      EQU     2
  1409                                  stdaux      EQU     3
  1410                                  stdprn      EQU     4
  1411                                  
  1412                                  ;**	File Modes
  1413                                  ; <Xenix subfunction assignments>  ; MSDOS 3.3 FILEMODE.INC
  1414                                  
  1415                                  open_for_read   EQU 0
  1416                                  open_for_write  EQU 1
  1417                                  open_for_both   EQU 2
  1418                                  
  1419                                  ; MSDOS 6.0
  1420                                  OPEN_FOR_BOTH	equ 2
  1421                                  EXEC_OPEN	equ 3	; access code of 3 indicates that open was 
  1422                                  				; made from exec
  1423                                  
  1424                                  access_mask	EQU 0Fh ; 09/08/2018
  1425                                  
  1426                                  SHARING_MASK	    equ 0F0h
  1427                                  SHARING_COMPAT	    equ 000h
  1428                                  SHARING_DENY_BOTH   equ 010h
  1429                                  SHARING_DENY_WRITE  equ 020h
  1430                                  SHARING_DENY_READ   equ 030h
  1431                                  SHARING_DENY_NONE   equ 040h
  1432                                  SHARING_NET_FCB     equ 070h
  1433                                  SHARING_NO_INHERIT  equ 080h
  1434                                  
  1435                                  ; 29/04/2019
  1436                                  
  1437                                  ;**	Extended Open Definitions
  1438                                  
  1439                                  RESERVED_BITS_MASK equ 0FE00h	; reserved bits for extended open flags
  1440                                  EXISTS_MASK	   equ 0Fh 	; "file exists" action field
  1441                                  NOT_EXISTS_MASK    equ 0F0h
  1442                                  
  1443                                  ;*	SF_MODE values
  1444                                  
  1445                                  AUTO_COMMIT_WRITE	equ 4000h
  1446                                  INT_24_ERROR		equ 2000h
  1447                                  
  1448                                  ;*	Flags in EXTOPEN_ON
  1449                                  
  1450                                  EXT_OPEN_ON		equ 01h
  1451                                  EXT_FILE_NOT_EXISTS	equ 04h
  1452                                  EXT_OPEN_I24_OFF	equ 02h
  1453                                  
  1454                                  ;*	Flags in EXTOPEN_FLAG
  1455                                  
  1456                                  ACTION_OPENED		equ 01h
  1457                                  ACTION_CREATED_OPENED	equ 02h
  1458                                  ACTION_REPLACED_OPENED	equ 03h
  1459                                  EXT_EXISTS_OPEN 	equ 01h
  1460                                  EXT_EXISTS_FAIL 	equ 00h
  1461                                  EXT_NEXISTS_CREATE	equ 10h
  1462                                  
  1463                                  ;**	Extended Open Structure
  1464                                  
  1465                                  struc EXT_OPEN_PARM
  1466 00000000 ????????                .SET_LIST:	resd 1
  1467 00000004 ????                    .NUM_OF_PARM:	resw 1
  1468                                  endstruc
  1469                                  
  1470                                  ;============================================================================
  1471                                  ; SYSCALL.INC, MSDOS 6.0, 1991
  1472                                  ;============================================================================
  1473                                  ; 29/04/2019 - Retro DOS v4.0
  1474                                  ; 09/07/2018 - Retro DOS v3.0 (SYSCALL.INC, MSDOS 3.3, 1987)
  1475                                  
  1476                                  ; <system call definitions>
  1477                                  
  1478                                  ABORT                           EQU 0   ;  0      0
  1479                                  STD_CON_INPUT                   EQU 1   ;  1      1
  1480                                  STD_CON_OUTPUT                  EQU 2   ;  2      2
  1481                                  STD_AUX_INPUT                   EQU 3   ;  3      3
  1482                                  STD_AUX_OUTPUT                  EQU 4   ;  4      4
  1483                                  STD_PRINTER_OUTPUT              EQU 5   ;  5      5
  1484                                  RAW_CON_IO                      EQU 6   ;  6      6
  1485                                  RAW_CON_INPUT                   EQU 7   ;  7      7
  1486                                  STD_CON_INPUT_NO_ECHO           EQU 8   ;  8      8
  1487                                  STD_CON_STRING_OUTPUT           EQU 9   ;  9      9
  1488                                  STD_CON_STRING_INPUT            EQU 10  ; 10      A
  1489                                  STD_CON_INPUT_STATUS            EQU 11  ; 11      B
  1490                                  STD_CON_INPUT_FLUSH             EQU 12  ; 12      C
  1491                                  DISK_RESET                      EQU 13  ; 13      D
  1492                                  SET_DEFAULT_DRIVE               EQU 14  ; 14      E
  1493                                  FCB_OPEN                        EQU 15  ; 15      F
  1494                                  FCB_CLOSE                       EQU 16  ; 16     10
  1495                                  DIR_SEARCH_FIRST                EQU 17  ; 17     11
  1496                                  DIR_SEARCH_NEXT                 EQU 18  ; 18     12
  1497                                  FCB_DELETE                      EQU 19  ; 19     13
  1498                                  FCB_SEQ_READ                    EQU 20  ; 20     14
  1499                                  FCB_SEQ_WRITE                   EQU 21  ; 21     15
  1500                                  FCB_CREATE                      EQU 22  ; 22     16
  1501                                  FCB_RENAME                      EQU 23  ; 23     17
  1502                                  GET_DEFAULT_DRIVE               EQU 25  ; 25     19
  1503                                  SET_DMA                         EQU 26  ; 26     1A
  1504                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1505                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1506                                  ;                                                                          ;
  1507                                  GET_DEFAULT_DPB                 EQU 31  ; 31     1F
  1508                                  ;                                                                          ;
  1509                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1510                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1511                                  FCB_RANDOM_READ                 EQU 33  ; 33     21
  1512                                  FCB_RANDOM_WRITE                EQU 34  ; 34     22
  1513                                  GET_FCB_FILE_LENGTH             EQU 35  ; 35     23
  1514                                  GET_FCB_POSITION                EQU 36  ; 36     24
  1515                                  SET_INTERRUPT_VECTOR            EQU 37  ; 37     25
  1516                                  CREATE_PROCESS_DATA_BLOCK       EQU 38  ; 38     26
  1517                                  FCB_RANDOM_READ_BLOCK           EQU 39  ; 39     27
  1518                                  FCB_RANDOM_WRITE_BLOCK          EQU 40  ; 40     28
  1519                                  PARSE_FILE_DESCRIPTOR           EQU 41  ; 41     29
  1520                                  GET_DATE                        EQU 42  ; 42     2A
  1521                                  SET_DATE                        EQU 43  ; 43     2B
  1522                                  GET_TIME                        EQU 44  ; 44     2C
  1523                                  SET_TIME                        EQU 45  ; 45     2D
  1524                                  SET_VERIFY_ON_WRITE             EQU 46  ; 46     2E
  1525                                  ; Extended functionality group
  1526                                  GET_DMA                         EQU 47  ; 47     2F
  1527                                  GET_VERSION                     EQU 48  ; 48     30
  1528                                  KEEP_PROCESS                    EQU 49  ; 49     31
  1529                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1530                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1531                                  ;                                                                          ;
  1532                                  GET_DPB                         EQU 50  ; 50     32
  1533                                  ;                                                                          ;
  1534                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1535                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1536                                  SET_CTRL_C_TRAPPING             EQU 51  ; 51     33
  1537                                  GET_INDOS_FLAG                  EQU 52  ; 52     34
  1538                                  GET_INTERRUPT_VECTOR            EQU 53  ; 53     35
  1539                                  GET_DRIVE_FREESPACE             EQU 54  ; 54     36
  1540                                  CHAR_OPER                       EQU 55  ; 55     37
  1541                                  INTERNATIONAL                   EQU 56  ; 56     38
  1542                                  ; XENIX CALLS
  1543                                  ;   Directory Group
  1544                                  MKDIR                           EQU 57  ; 57     39
  1545                                  RMDIR                           EQU 58  ; 58     3A
  1546                                  CHDIR                           EQU 59  ; 59     3B
  1547                                  ;   File Group
  1548                                  CREAT                           EQU 60  ; 60     3C
  1549                                  OPEN                            EQU 61  ; 61     3D
  1550                                  CLOSE                           EQU 62  ; 62     3E
  1551                                  READ                            EQU 63  ; 63     3F
  1552                                  WRITE                           EQU 64  ; 64     40
  1553                                  UNLINK                          EQU 65  ; 65     41
  1554                                  LSEEK                           EQU 66  ; 66     42
  1555                                  CHMOD                           EQU 67  ; 67     43
  1556                                  IOCTL                           EQU 68  ; 68     44
  1557                                  XDUP                            EQU 69  ; 69     45
  1558                                  XDUP2                           EQU 70  ; 70     46
  1559                                  CURRENT_DIR                     EQU 71  ; 71     47
  1560                                  ;    Memory Group
  1561                                  ALLOC                           EQU 72  ; 72     48
  1562                                  DEALLOC                         EQU 73  ; 73     49
  1563                                  SETBLOCK                        EQU 74  ; 74     4A
  1564                                  ;    Process Group
  1565                                  EXEC                            EQU 75  ; 75     4B
  1566                                  EXIT                            EQU 76  ; 76     4C
  1567                                  _WAIT				EQU 77  ; 77     4D
  1568                                  FIND_FIRST                      EQU 78  ; 78     4E
  1569                                  ;   Special Group
  1570                                  FIND_NEXT                       EQU 79  ; 79     4F
  1571                                  ; SPECIAL SYSTEM GROUP
  1572                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1573                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1574                                  ;                                                                          ;
  1575                                  SET_CURRENT_PDB                 EQU 80  ; 80     50
  1576                                  GET_CURRENT_PDB                 EQU 81  ; 81     51
  1577                                  GET_IN_VARS                     EQU 82  ; 82     52
  1578                                  SETDPB                          EQU 83  ; 83     53
  1579                                  ;                                                                          ;
  1580                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1581                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1582                                  GET_VERIFY_ON_WRITE             EQU 84  ; 84     54
  1583                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1584                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1585                                  ;                                                                          ;
  1586                                  DUP_PDB                         EQU 85  ; 85     55
  1587                                  ;                                                                          ;
  1588                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1589                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1590                                  RENAME                          EQU 86  ; 86     56
  1591                                  FILE_TIMES                      EQU 87  ; 87     57
  1592                                  ALLOCOPER			EQU 88	; 88	 58
  1593                                  ; Network extention system calls
  1594                                  GETEXTENDEDERROR		EQU 89	; 89	 59
  1595                                  CREATETEMPFILE			EQU 90	; 90	 5A
  1596                                  CREATENEWFILE			EQU 91	; 91	 5B
  1597                                  LOCKOPER			EQU 92	; 92	 5C Lock and Unlock
  1598                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1599                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  1600                                  ;									   ;
  1601                                  SERVERCALL			EQU 93	; 93	 5D CommitAll, ServerDOSCall,
  1602                                  					;	    CloseByName, CloseUser,
  1603                                  					;	    CloseUserProcess,
  1604                                  					;	    GetOpenFileList
  1605                                  ;									   ;
  1606                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  1607                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1608                                  USEROPER			EQU 94	; 94	 5E Get and Set
  1609                                  ASSINGOPER			EQU 95	; 95	 5F On, Off, Get, Set, Cancel
  1610                                  XNAMETRANS			EQU 96	; 96	 60
  1611                                  PATHPARSE			EQU 97	; 97	 61
  1612                                  GETCURRENTPSP			EQU 98	; 98	 62
  1613                                  HONGEUL 			EQU 99	; 99	 63
  1614                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1615                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  1616                                  ;									   ;
  1617                                  SET_PRINTER_FLAG		EQU 100 ; 100	 64
  1618                                  ;									   ;
  1619                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  1620                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1621                                  GETEXTCNTRY			EQU 101 ; 101	 65 
  1622                                  GETSETCDPG			EQU 102 ; 102	 66
  1623                                  EXTHANDLE			EQU 103 ; 103	 67
  1624                                  COMMIT				EQU 104 ; 104	 68
  1625                                  
  1626                                  ; 29/04/2019 - Retro DOS v4.0
  1627                                  ; (MSDOS 6.0, SYSCALL.INC, 1987)
  1628                                  
  1629                                  GetSetMediaID			EQU 105 ; 105	 69
  1630                                  IFS_IOCTL			EQU 107 ; 107	 6B
  1631                                  ExtOpen 			EQU 108 ; 108	 6C
  1632                                  
  1633                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1634                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1635                                  ;                                                                          ;
  1636                                  ;ifdef ROMEXEC
  1637                                  ;ROM_FIND_FIRST			EQU 109 ; 109    6D
  1638                                  ;ROM_FIND_NEXT			EQU 110 ; 110    6E
  1639                                  ;ROM_EXCLUDE			EQU 111 ; 111	 6F		; M035
  1640                                  ;endif
  1641                                  ;                                                                          ;
  1642                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1643                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1644                                  
  1645                                  SET_OEM_HANDLER			EQU 248 ; 248    F8
  1646                                  ;OEM_C1				EQU 249 ; 249    F9
  1647                                  ;OEM_C2				EQU 250 ; 250    FA
  1648                                  ;OEM_C3				EQU 251 ; 251    FB
  1649                                  ;OEM_C4				EQU 252 ; 252    FC
  1650                                  ;OEM_C5				EQU 253 ; 253    FD
  1651                                  ;OEM_C6				EQU 254 ; 254    FE
  1652                                  ;OEM_C7				EQU 255 ; 255    FF
  1653                                  
  1654                                  ; 01/01/2024 - Retro DOS v5.0 - PCDOS 7.1 IBMDOS.COM
  1655                                  ; (PCDOS 7.1 extension to MSDOS 6.22 system calls)
  1656                                   
  1657                                  ExtCountryInfo 			equ 112	; 70h
  1658                                  LONGNAME			equ 113	; 71h
  1659                                  LFNFINDCLOSE			equ 114 ; 72h
  1660                                  FAT32EXT			equ 115	; 73h
  1661                                  
  1662                                  ;============================================================================
  1663                                  ; VERSIONA.INC (MSDOS 6.0, 1991)
  1664                                  ;============================================================================
  1665                                  ; 24/04/2019 - Retro DOS 4.0
  1666                                  
  1667                                  ;MAJOR_VERSION	EQU     6
  1668                                  ;;MINOR_VERSION	EQU	00
  1669                                  ;MINOR_VERSION	EQU     21  ; MSDOS 6.21
  1670                                  
  1671                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  1672                                  ;MAJOR_VERSION	EQU     5
  1673                                  ;MINOR_VERSION	EQU     0
  1674                                  
  1675                                  ; 30/12/2022 - Retro DOS v4.2
  1676                                  ;MAJOR_VERSION	EQU     6
  1677                                  ;MINOR_VERSION	EQU     22
  1678                                  
  1679                                  ; 01/01/2024 - Retro DOS v5.0
  1680                                  MAJOR_VERSION	EQU     7
  1681                                  MINOR_VERSION	EQU     10  ; PCDOS 7.1	(7.10)
  1682                                  
  1683                                  ;============================================================================
  1684                                  ; INTNAT.INC, MSDOS 3.3, 1987
  1685                                  ;============================================================================
  1686                                  ; 09/07/2018 - Retro DOS 3.0
  1687                                  
  1688                                  ; Current structure of the data returned by the international call
  1689                                  
  1690                                  struc	INTERNAT_BLOCK		; (-*-) Same with MSDOS 2.11 & MSDOS 6.0
  1691                                  .Date_tim_format:
  1692 00000000 ????                    		RESW 1		; 0-USA, 1-EUR, 2-JAP
  1693                                  .Currency_sym:
  1694 00000002 ??????????              		RESB 5		; Currency Symbol 5 bytes
  1695                                  .Thous_sep:
  1696 00000007 ????                    		RESB 2		; Thousands separator 2 bytes
  1697                                  .Decimal_sep:
  1698 00000009 ????                    		RESB 2		; Decimal separator 2 bytes
  1699                                  .Date_sep:
  1700 0000000B ????                    		RESB 2		; Date separator 2 bytes
  1701                                  .Time_sep:
  1702 0000000D ????                    		RESB 2		; Time separator 2 bytes
  1703                                  .Bit_field:	
  1704 0000000F ??                      		RESB 1		; Bit values
  1705                                                                     ;   Bit 0 = 0 if currency symbol first
  1706                                                                     ;         = 1 if currency symbol last
  1707                                                                     ;   Bit 1 = 0 if No space after currency symbol
  1708                                                                     ;         = 1 if space after currency symbol
  1709                                  .Currency_cents:
  1710 00000010 ??                      		RESB 	1	; Number of places after currency dec point
  1711                                  .Time_24:
  1712 00000011 ??                      		RESB 	1	; 1 if 24 hour time, 0 if 12 hour time
  1713                                  .Map_call:
  1714 00000012 ????                    		RESW	1	; Address of case mapping call (DWORD)
  1715 00000014 ????                                    RESW	1       ; THIS IS TWO WORDS SO IT CAN BE INITIALIZED
  1716                                  				;  in pieces.
  1717                                  .Data_sep:
  1718 00000016 ????                    		RESB	2	; Data list separator character
  1719                                  .size:		
  1720                                  endstruc
  1721                                  
  1722                                  ; Max size of the block returned by the INTERNATIONAL call
  1723                                  
  1724                                  internat_block_max	EQU	32
  1725                                  
  1726                                  ;============================================================================
  1727                                  ; SYSVAR.INC (MSDOS 6.0, 1991)
  1728                                  ;============================================================================
  1729                                  ; 08/07/2018 - Retro DOS v3.0
  1730                                  
  1731                                  ; 01/01/2024 - Retro DOS v5.0
  1732                                  
  1733                                  ;SysInitVars STRUC
  1734                                  struc SYSI
  1735 00000000 ????????                .DPB:	    resd 1	; 0	; DPB chain
  1736 00000004 ????????                .SFT:	    resd 1	; 4	; SFT chain
  1737 00000008 ????????                .CLOCK:	    resd 1	; 8	; CLOCK device
  1738 0000000C ????????                .CON:	    resd 1	; 12	; CON device
  1739 00000010 ????                    .MAXSEC:    resw 1	; 16	; maximum sector size
  1740 00000012 ????????                .BUF:	    resd 1	; 18	; points to Hashinitvar
  1741 00000016 ????????                .CDS:	    resd 1	; 22	; CDS list
  1742 0000001A ????????                .FCB:	    resd 1	; 26	; FCB chain
  1743 0000001E ????                    .Keep:	    resw 1	; 30	; keep count
  1744 00000020 ??                      .NUMIO:	    resb 1	; 32	; Number of block devices
  1745 00000021 ??                      .NCDS:	    resb 1	; 33	; number of CDS's
  1746 00000022 ????????                .DEV:	    resd 1	; 34	; device list
  1747                                  ; 09/07/2018
  1748                                  ; Above parameters are described in MSDOS 3.3 SYSVAR.INC (85/04/10)
  1749                                  ; Following parameters are used with MSDOS 6.0 (Retro DOS v4.0)
  1750 00000026 ????                    .ATTR:	    resw 1	; 38	; null device attribute word
  1751 00000028 ????                    .STRAT:	    resw 1	; 40	; null device strategy entry point
  1752 0000002A ????                    .INTER:	    resw 1	; 42	; null device interrupt entry point
  1753 0000002C ????????????????        .NAME:	    resb 8	; 44	; null device name
  1754 00000034 ??                      .SPLICE:    resb 1	; 52	; TRUE -> splicees being done
  1755 00000035 ????                    .IBMDOS_SIZE: resw 1	; 53 	; DOS size in paragraphs
  1756 00000037 ????????                .IFS_DOSCALL@: resd 1	; 55	; IFS DOS service routine entry
  1757 0000003B ????????                .IFS:	    resd 1	; 59	; IFS header chain
  1758 0000003F ????????                .BUFFERS:   resw 2	; 63	; BUFFERS= values (m,n)
  1759 00000043 ??                      .BOOT_DRIVE: resb 1	; 67	; boot drive A=1 B=2,..
  1760 00000044 ??                      .DWMOVE:    resb 1	; 68	; 1 if 386 machine
  1761 00000045 ????                    .EXT_MEM:   resw 1	; 69	; Extended memory size in KB.
  1762                                  endstruc
  1763                                  ;SysInitVars ENDS
  1764                                  
  1765                                  ;This is added for more information exchange between DOS, BIOS.
  1766                                  ;DOS will give the pointer to SysInitTable in ES:DI. - J.K. 5/29/86
  1767                                  
  1768                                  ;SysInitVars_Ext struc
  1769                                  struc SYSI_EXT
  1770 00000000 ????????                .SysInitVars:	resd 1		; Points to the above structure.
  1771 00000004 ????????                .Country_Tab:	resd 1		; DOS_Country_cdpg_info
  1772                                  endstruc
  1773                                  ;SysInitVars_Ext ends
  1774                                  
  1775                                  ;============================================================================
  1776                                  ; IOCTL.INC - MSDOS 6.0 - 1991
  1777                                  ;============================================================================
  1778                                  ; 09/07/2018 - Retro DOS v3.0
  1779                                  
  1780                                  ;*** J.K.
  1781                                  ;General Guide -
  1782                                  ;Category Code:
  1783                                  ; 0... .... DOS Defined
  1784                                  ; 1... .... User defined
  1785                                  ; .xxx xxxx Code
  1786                                  
  1787                                  ;Function Code:
  1788                                  ; 0... .... Return error if unsupported
  1789                                  ; 1... .... Ignore if unsupported
  1790                                  ; .0.. .... Intercepted by DOS
  1791                                  ; .1.. .... Passed to driver
  1792                                  ; ..0. .... Sends data/commands to device
  1793                                  ; ..1. .... Quries data/info from device
  1794                                  ; ...x .... Subfunction
  1795                                  ;
  1796                                  ; Note that "Sends/queries" data bit is intended only to regularize the
  1797                                  ; function set.  It plays no critical role; some functions may contain both
  1798                                  ; command and query elements. The convention is that such commands are
  1799                                  ; defined as "sends data".
  1800                                  
  1801                                  ;*****************************;*
  1802                                  ; BLOCK DRIVERS 	      ;*
  1803                                  ;*****************************;*
  1804                                  
  1805                                  ; IOCTL SUB-FUNCTIONS
  1806                                  ; (MSDOS 3.3 + MSDOS 6.0)
  1807                                  IOCTL_GET_DEVICE_INFO	EQU	0
  1808                                  IOCTL_SET_DEVICE_INFO	EQU	1
  1809                                  IOCTL_READ_HANDLE	EQU	2
  1810                                  IOCTL_WRITE_HANDLE	EQU	3
  1811                                  IOCTL_READ_DRIVE	EQU	4
  1812                                  IOCTL_WRITE_DRIVE	EQU	5
  1813                                  IOCTL_GET_INPUT_STATUS	EQU	6
  1814                                  IOCTL_GET_OUTPUT_STATUS EQU	7
  1815                                  IOCTL_CHANGEABLE?	EQU	8
  1816                                  IOCTL_DeviceLocOrRem?	EQU	9
  1817                                  IOCTL_HandleLocOrRem?	EQU	0Ah   ;10
  1818                                  IOCTL_SHARING_RETRY	EQU	0Bh   ;11
  1819                                  GENERIC_IOCTL_HANDLE	EQU	0Ch   ;12
  1820                                  GENERIC_IOCTL		EQU	0Dh   ;13
  1821                                  ; (MSDOS 6.0 + MSDOS 3.3)
  1822                                  IOCTL_GET_DRIVE_MAP 	EQU	0Eh   ;14
  1823                                  IOCTL_SET_DRIVE_MAP	EQU	0Fh   ;15
  1824                                  ; (MSDOS 6.0)
  1825                                  IOCTL_QUERY_HANDLE	EQU	10h   ;16
  1826                                  IOCTL_QUERY_BLOCK	EQU	11h   ;17
  1827                                  
  1828                                  ; GENERIC IOCTL CATEGORY CODES
  1829                                  IOC_OTHER		EQU	0	; Other device control J.K. 4/29/86
  1830                                  IOC_SE			EQU	1	; SERIAL DEVICE CONTROL
  1831                                  IOC_TC			EQU	2	; TERMINAL CONTROL
  1832                                  IOC_SC			EQU	3	; SCREEN CONTROL
  1833                                  IOC_KC			EQU	4	; KEYBOARD CONTROL
  1834                                  IOC_PC			EQU	5	; PRINTER CONTROL
  1835                                  IOC_DC			EQU	8	; DISK CONTROL (SAME AS RAWIO)
  1836                                  
  1837                                  ; GENERIC IOCTL SUB-FUNCTIONS
  1838                                  RAWIO			EQU	8
  1839                                  
  1840                                  ; RAWIO SUB-FUNCTIONS
  1841                                  ; (MSDOS 3.3 + MSDOS 6.0)
  1842                                  GET_DEVICE_PARAMETERS	EQU	60H
  1843                                  SET_DEVICE_PARAMETERS	EQU	40H
  1844                                  READ_TRACK		EQU	61H
  1845                                  WRITE_TRACK		EQU	41H
  1846                                  VERIFY_TRACK		EQU	62H
  1847                                  FORMAT_TRACK		EQU	42H
  1848                                  ; (MSDOS 6.0)
  1849                                  GET_MEDIA_ID		EQU	66h	;AN000;AN003;changed from 63h
  1850                                  SET_MEDIA_ID		EQU	46h	;AN000;AN003;changed from 43h
  1851                                  GET_ACCESS_FLAG 	EQU	67h	;AN002;AN003;Unpublished function.Changed from 64h
  1852                                  SET_ACCESS_FLAG 	EQU	47h	;AN002;AN003;Unpublished function.Changed from 44h
  1853                                  SENSE_MEDIA_TYPE	EQU	68H	;Added for 5.00
  1854                                  
  1855                                  ; SPECIAL FUNCTION FOR GET DEVICE PARAMETERS
  1856                                  BUILD_DEVICE_BPB	EQU	000000001B
  1857                                  
  1858                                  ; SPECIAL FUNCTIONS FOR SET DEVICE PARAMETERS
  1859                                  INSTALL_FAKE_BPB	EQU	000000001B
  1860                                  ONLY_SET_TRACKLAYOUT	EQU	000000010B
  1861                                  TRACKLAYOUT_IS_GOOD	EQU	000000100B
  1862                                  
  1863                                  ; SPECIAL FUNCTION FOR FORMAT TRACK
  1864                                  ; (MSDOS 3.3 + MSDOS 6.0)
  1865                                  STATUS_FOR_FORMAT	EQU	000000001B
  1866                                  ; (MSDOS 6.0)
  1867                                  DO_FAST_FORMAT		EQU	000000010B ;AN001;
  1868                                  
  1869                                  ; CODES RETURNED FROM FORMAT STATUS CALL
  1870                                  FORMAT_NO_ROM_SUPPORT	EQU	000000001B
  1871                                  FORMAT_COMB_NOT_SUPPORTED EQU	000000010B
  1872                                  
  1873                                  ; DEVICETYPE VALUES
  1874                                  ; (MSDOS 3.3 + MSDOS 6.0)
  1875                                  MAX_SECTORS_IN_TRACK	EQU	63	; MAXIMUM SECTORS ON A DISK.(Was 40 in DOS 3.2)
  1876                                  DEV_5INCH		EQU	0
  1877                                  DEV_5INCH96TPI		EQU	1
  1878                                  DEV_3INCH720KB		EQU	2
  1879                                  DEV_8INCHSS		EQU	3
  1880                                  DEV_8INCHDS		EQU	4
  1881                                  DEV_HARDDISK		EQU	5
  1882                                  DEV_OTHER		EQU	7
  1883                                  ; (MSDOS 6.0)
  1884                                  ;DEV_3INCH1440KB	EQU	7
  1885                                  DEV_3INCH2880KB		EQU	9
  1886                                  ; Retro DOS v2.0 - 26/03/2018
  1887                                  ;;DEV_TAPE		EQU	6
  1888                                  ;;DEV_ERIMO		EQU	8
  1889                                  ;DEV_3INCH2880KB	EQU	9
  1890                                  DEV_3INCH1440KB		EQU	10
  1891                                  
  1892                                  ; (MSDOS 3.3)
  1893                                  ;MAX_DEV_TYPE		EQU	7
  1894                                  
  1895                                  ; (MSDOS 6.0)
  1896                                  MAX_DEV_TYPE		EQU	10	; MAXIMUM DEVICE TYPE THAT WE
  1897                                  					; CURRENTLY SUPPORT.
  1898                                  struc A_SECTORTABLE
  1899 00000000 ????                    .ST_SECTORNUMBER:	resw	1
  1900 00000002 ????                    .ST_SECTORSIZE:		resw	1
  1901                                  .size:
  1902                                  endstruc
  1903                                  
  1904                                  ;============================================================================
  1905                                  ; DEVSYM.INC
  1906                                  ;============================================================================
  1907                                  ; 07/07/2018 - Retro DOS v3.0
  1908                                  ; 30/04/2019 - Retro DOS v4.0 (DEVSYM.INC, MSDOS 6.0, 1991)
  1909                                  ; 21/02/2024 - Retro DOS v5.0
  1910                                  
  1911                                  ;**	DevSym.inc - Device Symbols
  1912                                  
  1913                                  ; The device table list has the form:
  1914                                  struc	SYSDEV
  1915 00000000 ????????                .NEXT:		resd 1		;Pointer to next device header
  1916 00000004 ????                    .ATT:		resw 1		;Attributes of the device
  1917 00000006 ????                    .STRAT:		resw 1		;Strategy entry point
  1918 00000008 ????                    .INT:		resw 1		;Interrupt entry point
  1919 0000000A ????????????????        .NAME:		resb 8		;Name of device (only first byte used for block)
  1920                                  .size:
  1921                                  endstruc
  1922                                  
  1923                                  ;
  1924                                  ; ATTRIBUTE BIT MASKS
  1925                                  ;
  1926                                  ; CHARACTER DEVICES:
  1927                                  ;
  1928                                  ; BIT 15 -> MUST BE 1
  1929                                  ;     14 -> 1 IF THE DEVICE UNDERSTANDS IOCTL CONTROL STRINGS
  1930                                  ;     13 -> 1 IF THE DEVICE SUPPORTS OUTPUT-UNTIL-BUSY
  1931                                  ;     12 -> UNUSED
  1932                                  ;     11 -> 1 IF THE DEVICE UNDERSTANDS OPEN/CLOSE
  1933                                  ;     10 -> MUST BE 0
  1934                                  ;      9 -> MUST BE 0
  1935                                  ;      8 -> UNUSED
  1936                                  ;      7 -> UNUSED
  1937                                  ;      6 -> UNUSED
  1938                                  ;      5 -> UNUSED
  1939                                  ;      4 -> 1 IF DEVICE IS RECIPIENT OF INT 29H
  1940                                  ;      3 -> 1 IF DEVICE IS CLOCK DEVICE
  1941                                  ;      2 -> 1 IF DEVICE IS NULL DEVICE
  1942                                  ;      1 -> 1 IF DEVICE IS CONSOLE OUTPUT
  1943                                  ;      0 -> 1 IF DEVICE IS CONSOLE INPUT
  1944                                  ;
  1945                                  ; BLOCK DEVICES:
  1946                                  ;
  1947                                  ; BIT 15 -> MUST BE 0
  1948                                  ;     14 -> 1 IF THE DEVICE UNDERSTANDS IOCTL CONTROL STRINGS
  1949                                  ;     13 -> 1 IF THE DEVICE DETERMINES MEDIA BY EXAMINING THE FAT ID BYTE.
  1950                                  ;	    THIS REQUIRES THE FIRST SECTOR OF THE FAT TO *ALWAYS* RESIDE IN
  1951                                  ;	    THE SAME PLACE.
  1952                                  ;     12 -> UNUSED
  1953                                  ;     11 -> 1 IF THE DEVICE UNDERSTANDS OPEN/CLOSE/REMOVABLE MEDIA
  1954                                  ;     10 -> MUST BE 0
  1955                                  ;      9 -> MUST BE 0
  1956                                  ;      8 -> UNUSED
  1957                                  ;      7 -> UNUSED
  1958                                  ;      6 -> IF DEVICE HAS SUPPORT FOR GETMAP/SETMAP OF LOGICAL DRIVES.
  1959                                  ;	    IF THE DEVICE UNDERSTANDS GENERIC IOCTL FUNCTION CALLS.
  1960                                  ;      5 -> UNUSED
  1961                                  ;      4 -> UNUSED
  1962                                  ;      3 -> UNUSED
  1963                                  ;      2 -> UNUSED
  1964                                  ;      1 -> UNUSED
  1965                                  ;      0 -> UNUSED
  1966                                  ;
  1967                                  
  1968                                  ;Attribute bit masks
  1969                                  DEVTYP	EQU     8000H           ;Bit 15 - 1 if Char, 0 if block
  1970                                  DEVIOCTL EQU    4000H           ;Bit 14 - CONTROL mode bit
  1971                                  ISFATBYDEV EQU  2000H           ;Bit 13 - Device uses FAT ID bytes, comp media.
  1972                                  
  1973                                  ; 09/07/2018 - Retro DOS (DEVSYM.INC, MSDOS 3.3, 1987) 
  1974                                  
  1975                                  OUTTILBUSY EQU	2000H		; OUTPUT UNTIL BUSY IS ENABLED
  1976                                  ISNET	   EQU	1000H		; BIT 12 - 1 IF A NET DEVICE, 0 IF
  1977                                  				;  NOT.  CURRENTLY BLOCK ONLY.
  1978                                  DEVOPCL    EQU	0800H		; BIT 11 - 1 IF THIS DEVICE HAS
  1979                                  				;  OPEN,CLOSE AND REMOVABLE MEDIA
  1980                                  				;  ENTRY POINTS, 0 IF NOT
  1981                                  
  1982                                  EXTENTBIT  EQU	0400H		; BIT 10 - CURRENTLY 0 ON ALL DEVS
  1983                                  				;  THIS BIT IS RESERVED FOR FUTURE USE
  1984                                  				;  TO EXTEND THE DEVICE HEADER BEYOND
  1985                                  				;  ITS CURRENT FORM.
  1986                                  
  1987                                  ; NOTE BIT 9 IS CURRENTLY USED ON IBM SYSTEMS TO INDICATE "DRIVE IS SHARED".
  1988                                  ;    SEE IOCTL FUNCTION 9. THIS USE IS NOT DOCUMENTED, IT IS USED BY SOME
  1989                                  ;    OF THE UTILITIES WHICH ARE SUPPOSED TO FAIL ON SHARED DRIVES ON SERVER
  1990                                  ;    MACHINES (FORMAT,CHKDSK,RECOVER,..).
  1991                                  
  1992                                  IOQUERY	EQU	0080H		;Bit 7 - Supports generic IOCtl query
  1993                                  
  1994                                  DEV320	EQU	0040H		;BIT 6 - FOR BLOCK DEVICES, THIS
  1995                                  				;DEVICE SUPPORTS SET/GET MAP OF
  1996                                  				;LOGICAL DRIVES, AND SUPPORTS
  1997                                  				;GENERIC IOCTL CALLS.
  1998                                  				;FOR CHARACTER DEVICES, THIS
  1999                                  				;DEVICE SUPPORTS GENERIC IOCTL.
  2000                                  				;THIS IS A DOS 3.2 DEVICE DRIVER.
  2001                                  
  2002                                  ISSPEC	EQU     0010H		;Bit 4 - This device is special ; 15/03/2018
  2003                                  ;ISIBM	EQU     0010H		;Bit 4 - This device is special
  2004                                  ISCLOCK EQU     0008H           ;Bit 3 - This device is the clock device.
  2005                                  ISNULL  EQU     0004H           ;Bit 2 - This device is the null device.
  2006                                  ISCOUT  EQU     0002H           ;Bit 1 - This device is the console output.
  2007                                  ISCIN   EQU     0001H           ;Bit 0 - This device is the console input.
  2008                                  
  2009                                  EXTDRVR	EQU	0002h		;BIT 1 - BLOCK DEVICE EXTENDED DRIVER
  2010                                  				; (MSDOS 6.0, DEVSYM.INC, 1991) ; 30/04/2019
  2011                                  
  2012                                  ;Static Reguest Header
  2013                                  struc	SRHEAD
  2014 00000000 ??                      .REQLEN:	resb 1		;Length in bytes of request block
  2015 00000001 ??                      .REQUNIT:	resb 1		;Device unit number
  2016 00000002 ??                      .REQFUNC:	resb 1		;Type of request
  2017 00000003 ????                    .REQSTAT:	resw 1		;Status Word
  2018 00000005 ????????????????                	resb 8		;Reserved for queue links
  2019                                  .size:
  2020                                  endstruc
  2021                                  
  2022                                  ;Status word masks
  2023                                  STERR   EQU     8000H           ;Bit 15 - Error
  2024                                  STBUI   EQU     0200H           ;Bit 9 - Buisy
  2025                                  STDON   EQU     0100H           ;Bit 8 - Done
  2026                                  STECODE EQU     00FFH           ;Error code
  2027                                  WRECODE EQU     0
  2028                                  
  2029                                  ;Function codes
  2030                                  DINITHL EQU     26              ;Size of init header
  2031                                  DMEDHL  EQU     15              ;Size of media check header
  2032                                  DBPBHL  EQU     22              ;Size of Get BPB header
  2033                                  DRDWRHL EQU     22              ;Size of RD/WR header
  2034                                  DRDNDHL EQU     14              ;Size of non destructive read header
  2035                                  DSTATHL EQU     13              ;Size of status header
  2036                                  ; 21/02/2024
  2037                                  ;DFLSHL EQU     15              ;Size of flush header
  2038                                  DFLSHL	equ	13	; PCDOS 7.1 IBMDOS.COM  ; 21/02/2024
  2039                                  
  2040                                  DEVINIT EQU     0               ;Initialization
  2041                                  DEVMDCH EQU     1               ;Media check
  2042                                  DEVBPB  EQU     2               ;Get BPB
  2043                                  DEVRDIOCTL EQU  3               ;IOCTL read
  2044                                  DEVRD   EQU     4               ;Read
  2045                                  DEVRDND EQU     5               ;Non destructive read no wait (character devs)
  2046                                  DEVIST  EQU     6               ;Input status
  2047                                  DEVIFL  EQU     7               ;Input flush
  2048                                  DEVWRT  EQU     8               ;Write
  2049                                  DEVWRTV EQU     9               ;Write with verify
  2050                                  DEVOST  EQU     10              ;Output status
  2051                                  DEVOFL  EQU     11              ;Output flush
  2052                                  DEVWRIOCTL EQU  12              ;IOCTL write
  2053                                  
  2054                                  ; 09/07/2018 - Retro DOS v3.0 (DEVSYM.INC, MSDOS 3.3, 1987) 
  2055                                  DEVOPN	EQU	13		;DEVICE OPEN
  2056                                  DEVCLS	EQU	14		;DEVICE CLOSE
  2057                                  DOPCLHL EQU	13		;SIZE OF OPEN/CLOSE HEADER
  2058                                  DEVRMD	EQU	15		;REMOVABLE MEDIA
  2059                                  ; 07/08/2018 - Retro DOS v3.0
  2060                                  REMHL	EQU	13		;SIZE OF REMOVABLE MEDIA HEADER
  2061                                  GENIOCTL EQU	19
  2062                                  
  2063                                  ; THE NEXT THREE ARE USED IN DOS 4.0
  2064                                  ;		     20
  2065                                  ;		     21
  2066                                  ;		     22
  2067                                  
  2068                                  DEVGETOWN      EQU   23		;GET DEVICE OWNER
  2069                                  DEVSETOWN      EQU   24		;SET DEVICE OWNER
  2070                                  ; 18/05/2019 - Retro DOS v4.0
  2071                                  IOCTL_QUERY    EQU   25		;Query generic ioctl support
  2072                                  
  2073                                  OWNHL	       EQU   13		;SIZE OF DEVICE OWNER HEADER
  2074                                  
  2075                                  DEVOUT	       EQU   16		; OUTPUT UNTIL BUSY.
  2076                                  DEVOUTL        EQU   DEVWRT	; LENGTH OF OUTPUT UNTIL BUSY
  2077                                  
  2078                                  ; ADDED FOR DOS 5.00
  2079                                  
  2080                                  ; GENERIC IOCTL REQUEST STRUCTURE
  2081                                  ;	SEE THE DOS 4.0 DEVICE DRIVER SPEC FOR FURTHER ELABORATION.
  2082                                  
  2083                                  struc IOCTL_REQ
  2084 00000000 <res Dh>                .SRHEAD:	resb SRHEAD.size
  2085                                  				; GENERIC IOCTL ADDITION.
  2086 0000000D ??                      .MAJORFUNCTION: resb 1		;FUNCTION CODE
  2087 0000000E ??                      .MINORFUNCTION: resb 1		;FUNCTION CATEGORY
  2088 0000000F ????                    .REG_SI:	resw 1
  2089 00000011 ????                    .REG_DI:	resw 1
  2090 00000013 ????????                .GENERICIOCTL_PACKET: resd 1	; POINTER TO DATA BUFFER
  2091                                  .size: ; 07/08/2018
  2092                                  endstruc
  2093                                  
  2094                                  ; DEFINITIONS FOR IOCTL_REQ.MINORFUNCTION
  2095                                  GEN_IOCTL_WRT_TRK EQU	40H
  2096                                  GEN_IOCTL_RD_TRK  EQU	60H
  2097                                  GEN_IOCTL_FN_TST  EQU	20H	; USED TO DIFF. BET READS AND WRTS
  2098                                  
  2099                                  ;; 32-bit absolute read/write input list structure
  2100                                  
  2101                                  struc ABS_32RW
  2102 00000000 ????????                .SECTOR_RBA:	resd 1		; relative block address
  2103 00000004 ????                    .ABS_RW_COUNT:	resw 1		; number of sectors to be transferred
  2104 00000006 ????????                .BUFFER_ADDR:	resd 1		; data addrress
  2105                                  .size:
  2106                                  endstruc
  2107                                  
  2108                                  ;; media ID info
  2109                                  
  2110                                  struc MEDIA_ID_INFO
  2111 00000000 ????                    .MEDIA_level:	resw	1	; info level
  2112 00000002 ????????                .MEDIA_Serial:	resd	1	; serial #
  2113 00000006 <res Bh>                .MEDIA_Label:	resb	11	; volume label
  2114 00000011 ????????????????        .MEDIA_System:	resb	8	; system type
  2115                                  .size:
  2116                                  endstruc
  2117                                  
  2118                                  ; equates for DOS34_FLAG
  2119                                  ; (BUGBUG: why are bits 0,1,3 and 4 not defined.)
  2120                                  
  2121                                  FROM_DISK_RESET       EQU   000000000100b   ;from disk reset
  2122                                  Force_I24_Fail	      EQU   000000100000b   ;form IFS CALL BACK
  2123                                  Disable_EOF_I24       EQU   000001000000b   ;disable EOF int24 for input status
  2124                                  DBCS_VOLID	      EQU   000010000000b   ;indicate from volume id
  2125                                  DBCS_VOLID2	      EQU   000100000000b   ;indicate 8th char is DBCS
  2126                                  CTRL_BREAK_FLAG       EQU   001000000000b   ;indicate control break is input
  2127                                  SEARCH_FASTOPEN       EQU   010000000000b   ;set fastopen flag for search
  2128                                  EXEC_AWARE_REDIR      EQU   100000000000b   ;M018: this bit is set by a redir 
  2129                                  					    ;M018: that knows how to handle 
  2130                                  					    ;M018: open for exec
  2131                                  
  2132                                  NO_FROM_DISK_RESET    EQU   ~FROM_DISK_RESET	;not from disk reset
  2133                                  NO_Force_I24_Fail     EQU   ~Force_I24_Fail	;not form IFS CALL BACK
  2134                                  NO_Disable_EOF_I24    EQU   ~Disable_EOF_I24
  2135                                  
  2136                                  ;============================================================================
  2137                                  ; ERROR.INC (MSDOS 6.0, 1991)
  2138                                  ;============================================================================
  2139                                  ; 16/07/2018 - Retro DOS v3.0 
  2140                                  
  2141                                  ;**	ERROR.INC - DOS Error Codes
  2142                                  ;
  2143                                  ;    The newer (DOS 2.0 and above) "XENIX-style" calls
  2144                                  ;    return error codes through AX. If an error occurred then
  2145                                  ;    the carry bit will be set and the error code is in AX. If no error
  2146                                  ;    occurred then the carry bit is reset and AX contains returned info.
  2147                                  ;
  2148                                  ;    Since the set of error codes is being extended as we extend the operating
  2149                                  ;    system, we have provided a means for applications to ask the system for a
  2150                                  ;    recommended course of action when they receive an error.
  2151                                  ;
  2152                                  ;    The GetExtendedError system call returns a universal error, an error
  2153                                  ;    location and a recommended course of action. The universal error code is
  2154                                  ;    a symptom of the error REGARDLESS of the context in which GetExtendedError
  2155                                  ;    is issued.
  2156                                  
  2157                                  ;	2.0 error codes
  2158                                  
  2159                                  error_invalid_function		EQU	1
  2160                                  error_file_not_found		EQU	2
  2161                                  error_path_not_found		EQU	3
  2162                                  error_too_many_open_files	EQU	4
  2163                                  error_access_denied		EQU	5
  2164                                  error_invalid_handle		EQU	6
  2165                                  error_arena_trashed		EQU	7
  2166                                  error_not_enough_memory 	EQU	8
  2167                                  error_invalid_block		EQU	9
  2168                                  error_bad_environment		EQU	10
  2169                                  error_bad_format		EQU	11
  2170                                  error_invalid_access		EQU	12
  2171                                  error_invalid_data		EQU	13
  2172                                  ;**** reserved			EQU	14	; *****
  2173                                  error_invalid_drive		EQU	15
  2174                                  error_current_directory 	EQU	16
  2175                                  error_not_same_device		EQU	17
  2176                                  error_no_more_files		EQU	18
  2177                                  
  2178                                  ;	These are the universal int 24 mappings for the old INT 24 set of errors
  2179                                  
  2180                                  error_write_protect		EQU	19
  2181                                  error_bad_unit			EQU	20
  2182                                  error_not_ready 		EQU	21
  2183                                  error_bad_command		EQU	22
  2184                                  error_CRC			EQU	23
  2185                                  error_bad_length		EQU	24
  2186                                  error_seek			EQU	25
  2187                                  error_not_DOS_disk		EQU	26
  2188                                  error_sector_not_found		EQU	27
  2189                                  error_out_of_paper		EQU	28
  2190                                  error_write_fault		EQU	29
  2191                                  error_read_fault		EQU	30
  2192                                  error_gen_failure		EQU	31
  2193                                  
  2194                                  ;	the new 3.0 error codes reported through INT 24
  2195                                  
  2196                                  error_sharing_violation 	EQU	32
  2197                                  error_lock_violation		EQU	33
  2198                                  error_wrong_disk		EQU	34
  2199                                  error_FCB_unavailable		EQU	35
  2200                                  error_sharing_buffer_exceeded	EQU	36
  2201                                  error_Code_Page_Mismatched	EQU	37    ; DOS 4.00  ;AN000;
  2202                                  error_handle_EOF		EQU	38    ; DOS 4.00  ;AN000;
  2203                                  error_handle_Disk_Full		EQU	39    ; DOS 4.00  ;AN000;
  2204                                  
  2205                                  ;	New OEM network-related errors are 50-79
  2206                                  
  2207                                  error_not_supported		EQU	50
  2208                                  
  2209                                  error_net_access_denied		EQU	65	;M028
  2210                                  
  2211                                  ;	End of INT 24 reportable errors
  2212                                  
  2213                                  error_file_exists		EQU	80
  2214                                  error_DUP_FCB			EQU	81	; *****
  2215                                  error_cannot_make		EQU	82
  2216                                  error_FAIL_I24			EQU	83
  2217                                  
  2218                                  ;	New 3.0 network related error codes
  2219                                  
  2220                                  error_out_of_structures 	EQU	84
  2221                                  error_already_assigned		EQU	85
  2222                                  error_invalid_password		EQU	86
  2223                                  error_invalid_parameter 	EQU	87
  2224                                  error_NET_write_fault		EQU	88
  2225                                  error_sys_comp_not_loaded	EQU	90    ; DOS 4.00  ;AN000;
  2226                                  
  2227                                  ;	BREAK <Interrupt 24 error codes>
  2228                                  
  2229                                  ;**	Int24 Error Codes
  2230                                  
  2231                                  error_I24_write_protect 	EQU	0
  2232                                  error_I24_bad_unit		EQU	1
  2233                                  error_I24_not_ready		EQU	2
  2234                                  error_I24_bad_command		EQU	3
  2235                                  error_I24_CRC			EQU	4
  2236                                  error_I24_bad_length		EQU	5
  2237                                  error_I24_Seek			EQU	6
  2238                                  error_I24_not_DOS_disk		EQU	7
  2239                                  error_I24_sector_not_found	EQU	8
  2240                                  error_I24_out_of_paper		EQU	9
  2241                                  error_I24_write_fault		EQU	0Ah
  2242                                  error_I24_read_fault		EQU	0Bh
  2243                                  error_I24_gen_failure		EQU	0Ch
  2244                                  ; NOTE: Code 0DH is used by MT-DOS.
  2245                                  error_I24_wrong_disk		EQU	0Fh
  2246                                  
  2247                                  ;	THE FOLLOWING ARE MASKS FOR THE AH REGISTER ON Int 24
  2248                                  ;
  2249                                  ;	NOTE: ABORT is ALWAYS allowed
  2250                                  
  2251                                  Allowed_FAIL			EQU	00001000B
  2252                                  Allowed_RETRY			EQU	00010000B
  2253                                  Allowed_IGNORE			EQU	00100000B
  2254                                  
  2255                                  I24_operation			EQU	00000001B  ;Z if READ,NZ if Write
  2256                                  I24_area			EQU	00000110B  ; 00 if DOS
  2257                                  						   ; 01 if FAT
  2258                                  						   ; 10 if root DIR
  2259                                  						   ; 11 if DATA
  2260                                  I24_class			EQU	10000000B  ;Z if DISK, NZ if FAT or char
  2261                                  
  2262                                  ;	BREAK <GetExtendedError CLASSes ACTIONs LOCUSs>
  2263                                  
  2264                                  ;**	The GetExtendedError call takes an error code and returns CLASS,
  2265                                  ;	ACTION and LOCUS codes to help programs determine the proper action
  2266                                  ;	to take for error codes that they don't explicitly understand.
  2267                                  
  2268                                  ;	Values for error CLASS
  2269                                  
  2270                                  errCLASS_OutRes 	EQU	1	; Out of Resource
  2271                                  errCLASS_TempSit	EQU	2	; Temporary Situation
  2272                                  errCLASS_Auth		EQU	3	; Permission problem
  2273                                  errCLASS_Intrn		EQU	4	; Internal System Error
  2274                                  errCLASS_HrdFail	EQU	5	; Hardware Failure
  2275                                  errCLASS_SysFail	EQU	6	; System Failure
  2276                                  errCLASS_Apperr 	EQU	7	; Application Error
  2277                                  errCLASS_NotFnd 	EQU	8	; Not Found
  2278                                  errCLASS_BadFmt 	EQU	9	; Bad Format
  2279                                  errCLASS_Locked 	EQU	10	; Locked
  2280                                  errCLASS_Media		EQU	11	; Media Failure
  2281                                  errCLASS_Already	EQU	12	; Collision with Existing Item
  2282                                  errCLASS_Unk		EQU	13	; Unknown/other
  2283                                  
  2284                                  ;	Values for error ACTION
  2285                                  
  2286                                  errACT_Retry		EQU	1	; Retry
  2287                                  errACT_DlyRet		EQU	2	; Delay Retry, retry after pause
  2288                                  errACT_User		EQU	3	; Ask user to regive info
  2289                                  errACT_Abort		EQU	4	; abort with clean up
  2290                                  errACT_Panic		EQU	5	; abort immediately
  2291                                  errACT_Ignore		EQU	6	; ignore
  2292                                  errACT_IntRet		EQU	7	; Retry after User Intervention
  2293                                  
  2294                                  ;	Values for error LOCUS
  2295                                  
  2296                                  errLOC_Unk		EQU	1	; No appropriate value
  2297                                  errLOC_Disk		EQU	2	; Random Access Mass Storage
  2298                                  errLOC_Net		EQU	3	; Network
  2299                                  errLOC_SerDev		EQU	4	; Serial Device
  2300                                  errLOC_Mem		EQU	5	; Memory
  2301                                  
  2302                                  ;============================================================================
  2303                                  ; INT2A.INC (MSDOS 6.0, 1991)
  2304                                  ;============================================================================
  2305                                  ; 04/05/2019 - Retro DOS v4.0
  2306                                  
  2307                                  ;**	Int 2A functions
  2308                                  ; ---------------------------------------------------------------------------
  2309                                  ;	Int 2A is an interface to the network code; it's also overloaded
  2310                                  ;		as a critical section handler since critical sections
  2311                                  ;		were originally created to support the net.
  2312                                  ; ---------------------------------------------------------------------------
  2313                                  
  2314                                  ; ---------------------------------------------------------------------------
  2315                                  ;**	This table was created by examining the source and may not be
  2316                                  ;	complete or completely accurate - JGL
  2317                                  ;
  2318                                  ;	M010	MD	8/31/90 - Added definition for AH = 5
  2319                                  
  2320                                  ;	(ah) = 0	installation check
  2321                                  ;			   (returns ah !=0 if installed)
  2322                                  ;	(ah) = 1	cooked net bios call
  2323                                  ;	(ah) = 3	query drive shared
  2324                                  ;			   (ds:si) = "n:" asciz string
  2325                                  ;	(ah) = 4	net bios
  2326                                  ;	       (al) = 0	   cooked net bios call
  2327                                  ;	       (al) = 1	   raw net bios call
  2328                                  ;	       (al) = 2	   ???
  2329                                  ;
  2330                                  ;	(ah) = 5	Get Net Adaptor Resources. CX returns the number of
  2331                                  ;			NCBs available/outstanding. DX returns the number of
  2332                                  ;			sessions. Supposedly, this is documented in an old
  2333                                  ;			IBM PC-LAN reference. Lotus Notes uses it. DOS LAN
  2334                                  ;			Manager 2.0 Enhanced responds to it. But it should
  2335                                  ;			not be used, as it is a hack, only to get Lotus
  2336                                  ;			Notes running.
  2337                                  ;
  2338                                  ;	(ah) = 80h	enter critical section
  2339                                  ;	(ah) = 81h	leave critical section
  2340                                  ;	(ah) = 82h	free all critical sections (Leave-all)
  2341                                  ;	(ah) = 84h	entering idle loop (don't understand how this works)
  2342                                  ; ---------------------------------------------------------------------------
  2343                                  
  2344                                  ;**	Critical section definitions
  2345                                  ; ---------------------------------------------------------------------------
  2346                                  ;	Although DOS is not designed to be reentrant there are some hacks
  2347                                  ;	which various programs use to make it so, in a limited fashion.
  2348                                  ;	Both WIN386 and some servers block copy a section of the DOS data
  2349                                  ;	area so that DOS can be reentered on behalf of another thread/program.
  2350                                  ;	DOS's global data structures, such as the memory arena, are not
  2351                                  ;	in this area, so critical section indicators are used to protect
  2352                                  ;	those areas.  DOS flags a critical section by issuing an INT_IBM
  2353                                  ;	(int 2Ah) at each critical section entry and exit.  Some clients
  2354                                  ;	(such as WIN386) just don't "context switch" the DOS when one
  2355                                  ;	of these is in effect, others, such as the IBM server, go ahead
  2356                                  ;	and reenter the DOS and if they get an int 2A to reenter the same
  2357                                  ;	critical section they then switch away from that second thread and
  2358                                  ;	let the first one finish and exit the section.
  2359                                  ; ---------------------------------------------------------------------------
  2360                                  
  2361                                  ; These below are subject to leave-all sections
  2362                                  critDisk    EQU     1			; Disk I/O critical section
  2363                                  critShare   EQU     1			; Sharer I/O critical section
  2364                                  critMem     EQU     1			; memory maintenance critical section
  2365                                  critSFT     EQU     1			; sft table allocation
  2366                                  critDevice  EQU     2			; Device I/O critical section
  2367                                  critNet     EQU     5			; network critical section
  2368                                  critIFS     EQU     6			; ifsfunc critical section
  2369                                  ; These below are not subject to leave-all sections
  2370                                  critASSIGN  EQU     8			; Assign has munged a system call
  2371                                  
  2372                                  ;============================================================================
  2373                                  ; MULT.INC (MSDOS 6.0, 1991)
  2374                                  ;============================================================================
  2375                                  ; 04/05/2019 - Retro DOS v4.0
  2376                                  
  2377                                  ;Break <Multiplex channels>
  2378                                  
  2379                                  ; ---------------------------------------------------------------------------
  2380                                  ; The current set of defined multiplex channels is (* means documented):
  2381                                  ;
  2382                                  ;   Channel(h)  Issuer          Receiver    Function
  2383                                  ;      00       server          PSPRINT     print job control
  2384                                  ;     *01       print/apps      PRINT       Queueing of files
  2385                                  ;      02       BIOS            REDIR       signal open/close of printers
  2386                                  ;
  2387                                  ;      05       command         REDIR       obtain text of net int 24 message
  2388                                  ;     *06       server/assign   ASSIGN      Install check
  2389                                  ;
  2390                                  ;      08       external driver IBMBIO      interface to internal routines
  2391                                  ;
  2392                                  ;      10       sharer/server   Sharer      install check
  2393                                  ;      11       DOS/server      Redir       install check/redirection funcs
  2394                                  ;      12       sharer/redir    DOS         dos functions and structure maint
  2395                                  ;      13       MSNET           MSNET       movement of NCBs
  2396                                  ;      13       external driver IBMBIO      Reset_Int_13, allows installation
  2397                                  ;                                           of alternative INT_13 drivers after
  2398                                  ;                                           boot_up
  2399                                  ;      14 (IBM) DOS             NLSFUNC     down load NLS country info,DOS 3.3
  2400                                  ;      14 (MS)  APPS            POPUP       MSDOS 4 popup screen functions
  2401                                  ;      15       APPS            MSCDEX      CD-ROM extensions interface
  2402                                  ;      16       WIN386          WIN386      Windows communications
  2403                                  ;      17       Clipboard       WINDOWS     Clipboard interface
  2404                                  ;     *18       Applications    MS-Manger   Toggle interface to manager
  2405                                  ;      19       Shell
  2406                                  ;      1A       Ansi.sys
  2407                                  ;      1B       Fastopen,Vdisk   IBMBIO     EMS INT 67H stub handler
  2408                                  ;
  2409                                  ;      40h      OS/2
  2410                                  ;      41h      Lanman
  2411                                  ;      42h      Lanman
  2412                                  ;      43h      Himem
  2413                                  ;                               AL = 20h    reserved for Mach 20 Himem support
  2414                                  ;                               AL = 30h    reserved for Himem external A20 code
  2415                                  ;      44h      Dosextender
  2416                                  ;      45H      Windows profiler
  2417                                  ;      46h      Windows/286 DOS extender
  2418                                  ;      47h      Basic Compiler Vn. 7.0
  2419                                  ;      48h      Doskey
  2420                                  ;      49h      DOS 5.x install 
  2421                                  ;      4Ah      Multi Purpose
  2422                                  ;                multMULTSWPDSK         0 - Swap Disk in drive A (BIOS)
  2423                                  ;                multMULTGETHMAPTR      1 - Get available HMA & ptr
  2424                                  ;                multMULTALLOCHMA       2 - Allocate HMA (bx == no of bytes)
  2425                                  ;                multMULTTASKSHELL      5 - Shell/switcher API
  2426                                  ;                multMULTRPLTOM         6 - Top Of Memory for RPL support
  2427                                  ;
  2428                                  ;                multSmartdrv           10h
  2429                                  ;                multMagicdrv           11h
  2430                                  ;      4Bh      Task Switcher API
  2431                                  ;
  2432                                  ;      4Ch      APPS            APM         Advanced power management
  2433                                  ;      4Dh      Kana Kanji Converter, MSKK
  2434                                  ;
  2435                                  ;      51h      ODI real mode support driver (for Chicago)
  2436                                  ;
  2437                                  ;      53h      POWER.EXE - used for broadcasting APM events    ; M036
  2438                                  ;      54h      POWER.EXE - used for POWER API                  ; M036
  2439                                  ;
  2440                                  ;      55h      COMMAND.COM
  2441                                  ;                multCOMFIRST           0 - API to determine whether 1st
  2442                                  ;                                           instance of command.com
  2443                                  ;                multCOMFIRSTROM        1 - API to determine whether 1st
  2444                                  ;                                           instance of ROM COMMAND
  2445                                  ;      56h      Sewell Development
  2446                                  ;               INTERLNK
  2447                                  ;
  2448                                  ;      57h      Iomega Corp.
  2449                                  ;
  2450                                  ;      ABh      Unspecified IBM use
  2451                                  ;      ACh      Graphics
  2452                                  ;      ADh      NLS (toronto)
  2453                                  ;      AEh
  2454                                  ;      AFh      Mode
  2455                                  ;      B0h      GRAFTABL        GRAFTABL
  2456                                  ;
  2457                                  ;      D7h      Banyan VINES
  2458                                  ; ---------------------------------------------------------------------------
  2459                                  
  2460                                  ;MUX 00-3F reserverd for IBM
  2461                                  ;MUX 80-BF reserverd for IBM
  2462                                  
  2463                                  ;MUX 40-7F reserved for Microsoft
  2464                                  
  2465                                  ;MUX C0-FF users
  2466                                  
  2467                                  MultSHARE   EQU     10h 		; sharer
  2468                                      ;	1   MFT_enter
  2469                                      ;	2   MFTClose
  2470                                      ;	3   MFTclU
  2471                                      ;	4   MFTCloseP
  2472                                      ;	5   MFTCloN
  2473                                      ;	6   set_block
  2474                                      ;	7   clr_block
  2475                                      ;	8   chk_block
  2476                                      ;	9   MFT_get
  2477                                      ;	10  ShSave
  2478                                      ;	11  ShChk
  2479                                      ;	12  ShCol
  2480                                      ;	13  ShCloseFile
  2481                                  
  2482                                  MultNET     EQU     11h 		; Network support
  2483                                  MultIFS     EQU     11h                 ; Network support
  2484                                      ;   1   IFS_RMDIR
  2485                                      ;   2   IFS_SEQ_RMDIR
  2486                                      ;   3   IFS_MKDIR
  2487                                      ;   4   IFS_SEQ_MKDIR
  2488                                      ;   5   IFS_CHDIR
  2489                                      ;   6   IFS_CLOSE
  2490                                      ;   7   IFS_COMMIT
  2491                                      ;   8   IFS_READ
  2492                                      ;   9   IFS_WRITE
  2493                                      ;   10  IFS_LOCK
  2494                                      ;   11  IFS_UNLOCK
  2495                                      ;   12  IFS_DISK_INFO
  2496                                      ;   13  IFS_SET_FILE_ATTRIBUTE
  2497                                      ;   14  IFS_SEQ_SET_FILE_ATTRIBUTE
  2498                                      ;   15  IFS_GET_FILE_INFO
  2499                                      ;   16  IFS_SEQ_GET_FILE_INFO
  2500                                      ;   17  IFS_RENAME
  2501                                      ;   18  IFS_SEQ_RENAME
  2502                                      ;   19  IFS_DELETE
  2503                                      ;   20  IFS_SEQ_DELETE
  2504                                      ;   21  IFS_OPEN
  2505                                      ;   22  IFS_SEQ_OPEN
  2506                                      ;   23  IFS_CREATE
  2507                                      ;   24  IFS_SEQ_CREATE
  2508                                      ;   25  IFS_SEQ_SEARCH_FIRST
  2509                                      ;   26  IFS_SEQ_SEARCH_NEXT
  2510                                      ;   27  IFS_SEARCH_FIRST
  2511                                      ;   28  IFS_SEARCH_NEXT
  2512                                      ;   29  IFS_ABORT
  2513                                      ;   30  IFS_ASSOPER
  2514                                      ;   31  Printer_SET_STRING
  2515                                      ;   32  IFSFlushBuf
  2516                                      ;   33  IFSBufWrite
  2517                                      ;   34  IFSResetEnvironment
  2518                                      ;   35  IFSSpoolCheck
  2519                                      ;   36  IFSSpoolClose
  2520                                      ;   37  IFSDeviceOper
  2521                                      ;   38  IFSSpoolEchoCheck
  2522                                      ;   39      - - -   Unused   - - -
  2523                                      ;   40      - - -   Unused   - - -
  2524                                      ;   41      - - -   Unused   - - -
  2525                                      ;   42  SERVER_DOSCALL_CLOSEFILES_FOR_UID
  2526                                      ;   43  DEVICE_IOCTL
  2527                                      ;   44  IFS_UPDATE_CB
  2528                                      ;   45  IFS_FILE_XATTRIBUTES
  2529                                      ;   46  IFS_XOPEN
  2530                                      ;   47  IFS_DEPENDENT_IOCTL
  2531                                  
  2532                                  MultDOS     EQU     12h 		; DOS call back
  2533                                      ;	1   DOS_CLOSE
  2534                                      ;	2   RECSET
  2535                                      ;	3   Get DOSGROUP
  2536                                      ;	4   PATHCHRCMP
  2537                                      ;	5   OUT
  2538                                      ;	6   NET_I24_ENTRY
  2539                                      ;	7   PLACEBUF
  2540                                      ;	8   FREE_SFT
  2541                                      ;	9   BUFWRITE
  2542                                      ;	10  SHARE_VIOLATION
  2543                                      ;	11  SHARE_ERROR
  2544                                      ;	12  SET_SFT_MODE
  2545                                      ;	13  DATE16
  2546                                      ;	14  SETVISIT
  2547                                      ;	15  SCANPLACE
  2548                                      ;	16  SKIPVISIT
  2549                                      ;	17  StrCpy
  2550                                      ;	18  StrLen
  2551                                      ;	19  UCase
  2552                                      ;	20  POINTCOMP
  2553                                      ;	21  CHECKFLUSH
  2554                                      ;	22  SFFromSFN
  2555                                      ;	23  GetCDSFromDrv
  2556                                      ;	24  Get_User_Stack
  2557                                      ;	25  GetThisDrv
  2558                                      ;	26  DriveFromText
  2559                                      ;	27  SETYEAR
  2560                                      ;	28  DSUM
  2561                                      ;	29  DSLIDE
  2562                                      ;	30  StrCmp
  2563                                      ;	31  initcds
  2564                                      ;	32  pjfnfromhandle
  2565                                      ;	33  $NameTrans
  2566                                      ;	34  CAL_LK
  2567                                      ;	35  DEVNAME
  2568                                      ;	36  Idle
  2569                                      ;   37  DStrLen
  2570                                      ;   38  NLS_OPEN      DOS 3.3
  2571                                      ;   39  $CLOSE        DOS 3.3
  2572                                      ;   40  NLS_LSEEK     DOS 3.3
  2573                                      ;   41  $READ         DOS 3.3
  2574                                      ;   42  FastInit      DOS 4.0
  2575                                      ;   43  NLS_IOCTL     DOS 3.3
  2576                                      ;   44  GetDevList    DOS 3.3
  2577                                      ;   45  NLS_GETEXT    DOS 3.3
  2578                                      ;   46  MSG_RETRIEVAL DOS 4.0
  2579                                      ;   47  FAKE_VERSION  DOS 4.0
  2580                                  
  2581                                  NLSFUNC     EQU     14h 		; NLSFUNC CALL , DOS 3.3
  2582                                      ;	0   NLSInstall
  2583                                      ;	1   ChgCodePage
  2584                                      ;	2   GetExtInfo
  2585                                      ;	3   SetCodePage
  2586                                      ;	4   GetCntry
  2587                                  
  2588                                  multANSI    EQU     1Ah                 ; ANSI multiplex number
  2589                                      ;   0   INSTALL_CHECK               ; install check for ANSI
  2590                                      ;   1   IOCTL_2F                    ; 2F interface to IOCTL
  2591                                      ;   2   DA_INFO_2F                  ; J.K. Information passing to ANSI.
  2592                                  
  2593                                  multMULT        EQU     4Ah
  2594                                  multMAGIC       EQU     256*multMULT + 11h
  2595                                  multMULTRPLTOM  EQU     06h
  2596                                  
  2597                                      ;   0   swap disk function for single floppy drive m/cs
  2598                                      ;       BIOS broadcasts with cx==0, and apps who handle
  2599                                      ;       swap disk messaging set cx == -1. BIOS sets dl == requested
  2600                                      ;       drive
  2601                                      ;
  2602                                      ;   1   Get available HMA & pointer to it. Returns in BX & ES:DI
  2603                                      ;   2   Allocate HMA. BX == number of bytes in HMA to be allocated
  2604                                      ;       returns pointer in ES:DI
  2605                                      ;
  2606                                      ;   3-4 currently used by nobody
  2607                                      ;   5   Switcher API
  2608                                      ;   6   Top of Memory for RPL.
  2609                                      ;           BIOS issues INT 2f AX=4a06 & DX = Top of Mem and any RPL
  2610                                      ;           code present in TOM should respond with a new TOM in DX
  2611                                      ;           to protect itself from MSLOAD & SYSINIT tromping over it.
  2612                                      ;           SYSINIT builds an arena with owner type 8 & name 'RPL' to
  2613                                      ;           protect the RPL code from COMMAND.COM transient protion.
  2614                                      ;           It is the responsibility of RPL program to release the mem.
  2615                                      ;   7   Reserved for PROTMAN support.
  2616                                      ;  10   smartdrv 4.0
  2617                                      ;  11   dblspace api
  2618                                      ;  12   MRCI     api
  2619                                      ;  13   dblspace/mrci stealth packet api
  2620                                  
  2621                                  MultAPM     EQU     4ch             ; Obselete ???
  2622                                      ;       00h     APM_VER_CHK
  2623                                      ;       01h     APM_SUS_SYS_REQ
  2624                                      ;       FFh     APM_SUS_RES_BATT_NOTIFY
  2625                                  
  2626                                  MultPWR_BRDCST  EQU     53h     ; Used by POWER.EXE to broadcast      ; M036
  2627                                  				;  APM events                         ; M036
  2628                                  MultPWR_API     EQU     54h     ; Used for accessing POWER.EXE's API  ; M036
  2629                                  
  2630                                  ;FASTOPEN is not chained through INT 2F   ; DOS 3.3 F.C.
  2631                                  ;	  it calls Multdos 42 to set up an entry routine address
  2632                                      ;	0   Install status  (reserved)
  2633                                      ;	1   Lookup
  2634                                      ;	2   Insert
  2635                                      ;	3   Delete
  2636                                      ;	4   Purge	    (reserved)
  2637                                  
  2638                                  ;============================================================================
  2639                                  ; FIND.INC (MSDOS 6.0, 1991)
  2640                                  ;============================================================================
  2641                                  ; 17/05/2019 - Retro DOS v4.0
  2642                                  ; 09/07/2018 - Retro DOS v3.0 (MSDOS 3.3, 1987)
  2643                                  
  2644                                  ;Break	<find first/next buffer>
  2645                                  
  2646                                  struc find_buf
  2647 00000000 ??                      .drive:	    resb 1		; drive of search
  2648 00000001 <res Bh>                .name:	    resb 11		; formatted name
  2649 0000000C ??                      .sattr:	    resb 1		; attribute of search
  2650 0000000D ????                    .LastEnt:   resw 1		; LastEnt
  2651 0000000F ????                    .DirStart:  resw 1		; DirStart
  2652 00000011 ????????                .NETID:	    resb 4 ; MSDOS 6.0 	; Reserved for NET
  2653 00000015 ??                      .attr:	    resb 1		; attribute found
  2654 00000016 ????                    .time:	    resw 1		; time
  2655 00000018 ????                    .date:	    resw 1		; date
  2656 0000001A ????                    .size_l:    resw 1		; low(size)
  2657 0000001C ????                    .size_h:    resw 1		; high(size)
  2658 0000001E <res Dh>                .pname:	    resb 13		; packed name
  2659                                  .size:
  2660                                  endstruc
  2661                                  
  2662                                  ;============================================================================
  2663                                  ; DOSCNTRY.INC (MSDOS 6.0, 1991)
  2664                                  ;============================================================================
  2665                                  ; 29/04/2019 - Retro DOS v4.0
  2666                                  ; 09/07/2018 - Retro DOS v3.0 (MSDOS 3.3, 1987)
  2667                                  
  2668                                  ;Equates for COUNTRY INFORMATION.
  2669                                  SetCountryInfo	EQU	1	;country info
  2670                                  SetUcase	EQU	2	;uppercase table
  2671                                  SetLcase	EQU	3	;lowercase table (Reserved)
  2672                                  SetUcaseFile	EQU	4	;uppercase file spec table
  2673                                  SetFileList	EQU	5	;valid file character list
  2674                                  SetCollate	EQU	6	;collating sequence
  2675                                  SetDBCS 	EQU	7	;double byte character set
  2676                                  SetALL		EQU	-1	;all the entries
  2677                                  
  2678                                  ;DOS country and code page information table structure.
  2679                                  ;Internally, IBMDOS gives a pointer to this table.
  2680                                  ;IBMBIO, MODE and NLSFUNC modules communicate with IBMDOS through
  2681                                  ;this structure.
  2682                                  
  2683                                  struc  DOS_CCDPG	; DOS_country_cdpg_info
  2684 00000000 ????????????????        .ccInfo_reserved: 	resb 8	;reserved for internal use
  2685 00000008 <res 40h>               .ccPath_CountrySys:	resb 64 ;path and filename for country info
  2686 00000048 ????                    .ccSysCodePage:		resw 1	;system code page id
  2687 0000004A ????                    .ccNumber_of_entries:	resw 1  ; (default value = 6)
  2688 0000004C ??                      .ccSetUcase:		resb 1  ; (default value = SetUcase)
  2689 0000004D ????????                .ccUcase_ptr:		resd 1	;pointer to Ucase table
  2690                                  
  2691 00000051 ??                      .ccSetUcaseFile:	resb 1	; (default value = SetUcaseFile)
  2692 00000052 ????????                .ccFileUcase_ptr: 	resd 1	;pointer to File Ucase table
  2693                                  
  2694 00000056 ??                      .ccSetFileList:		resb 1 	; (default value = SetFileList)
  2695 00000057 ????????                .ccFileChar_ptr:	resd 1	;pointer to File char list table
  2696                                  
  2697 0000005B ??                      .ccSetCollate:		resb 1	; (default value = SetCollate)
  2698 0000005C ????????                .ccCollate_ptr:		resd 1	;pointer to collate table
  2699                                  
  2700                                  ; MSDOS 6.0
  2701 00000060 ??                      .ccSetDBCS:		resb 1	; (default value = SetDBCS)
  2702 00000061 ????????                .ccDBCS_ptr:		resd 1	; pointer to DBCS table
  2703                                  
  2704 00000065 ??                      .ccSetCountryInfo:	resb 1  ; (default value = SetCountryInfo)
  2705 00000066 ????                    .ccCountryInfoLen:	resw 1	;length of country info
  2706 00000068 ????                    .ccDosCountry:		resw 1	;system country code id
  2707 0000006A ????                    .ccDosCodePage:		resw 1	;system code page id
  2708 0000006C ????                    .ccDFormat:		resw 1	;date format
  2709 0000006E ??????????              .ccCurSymbol:		resb 5	;5 byte of (currency symbol+0)
  2710 00000073 ????                    .cc1000Sep:		resb 2	;2 byte of (1000 sep. + 0)
  2711 00000075 ????                    .ccDecSep:		resb 2	;2 byte of (Decimal sep. + 0)
  2712 00000077 ????                    .ccDateSep:		resb 2	;2 byte of (date sep. + 0)
  2713 00000079 ????                    .ccTimeSep:		resb 2	;2 byte of (time sep. + 0)
  2714 0000007B ??                      .ccCFormat:		resb 1	;currency format flags
  2715 0000007C ??                      .ccCSigDigits:		resb 1	;# of digits in currency
  2716 0000007D ??                      .ccTFormat:		resb 1	;time format
  2717 0000007E ????????                .ccMono_ptr:		resd 1	;monocase routine entry point
  2718 00000082 ????                    .ccListSep:		resb 2	;data list separator
  2719 00000084 <res Ah>                .ccReserved_area: 	resw 5	;reserved
  2720                                  .size:
  2721                                  endstruc
  2722                                  
  2723                                  ;Ucase table
  2724                                  struc CC_UCASE_TAB
  2725 00000000 ????                    .ccUcase_leng:		resw 1	; (default value = 128)
  2726 00000002 <res 80h>               .ccUcase_data:		resb 128
  2727                                  endstruc
  2728                                  
  2729                                  ;File Ucase table
  2730                                  struc CC_FILE_UCASE_TAB
  2731 00000000 ????                    .ccFileucase_leng:	resw 1	; (default value = 128)
  2732 00000002 <res 80h>               .ccFileucase_data:	resb 128
  2733                                  endstruc
  2734                                  
  2735                                  ;File char list
  2736                                  struc CC_FILE_CHAR_TAB
  2737 00000000 ????                    .ccFilechar_leng:	resw 1
  2738 00000002 <res 2Eh>               .ccFilechar_data:	resb 46
  2739                                  endstruc
  2740                                  
  2741                                  ;collate table
  2742                                  struc CC_COLLATE_TAB
  2743 00000000 ????                    .ccCollate_leng:	resw 1	; (default value = 128)
  2744 00000002 <res 100h>              .ccCollate_data:	resb 256
  2745                                  endstruc
  2746                                  
  2747                                  OLD_COUNTRY_SIZE  equ	(DOS_CCDPG.size - DOS_CCDPG.ccDFormat - 10)
  2748                                  NEW_COUNTRY_SIZE  equ	(DOS_CCDPG.size - DOS_CCDPG.ccDosCountry) ; 38
  2749                                  
  2750                                  ; 06/08/2018
  2751                                  ; DOSCNTRY.INC (MSDOS 6.0, 1991)
  2752                                  
  2753                                  ;CAPITALIZATION equates
  2754                                  CAP_ONE_CHAR	equ	20H
  2755                                  CAP_STRING	equ	21H
  2756                                  CAP_ASCIIZ	equ	22H
  2757                                  CHECK_YES_NO	equ	23H
  2758                                  UPPER_TABLE	equ	80H
  2759                                  
  2760                                  ;NLS_YES	equ	59H  ; 'Y'
  2761                                  ;NLS_yes2	equ	79H  ; 'y' 	
  2762                                  ;NLS_NO		equ	4EH  ; 'N'	
  2763                                  ;NLS_no2	equ	6EH  ; 'n'	
  2764                                  
  2765                                  ;============================================================================
  2766                                  ; CURDIR.INC (MSDOS 6.0, 1991)
  2767                                  ;============================================================================
  2768                                  ; 25/04/2019 - Retro DOS v4.0
  2769                                  ; 09/07/2018 - Retro DOS v3.0 (CURDIR.INC, MSDOS 3.3, 1987)
  2770                                  
  2771                                  ;BREAK <Current directory list structure>
  2772                                  
  2773                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  2774                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  2775                                  ;									   ;
  2776                                  ; CDS items are used bu the internal routines to store cluster numbers and ;
  2777                                  ; network identifiers for each logical name.  The ID field is used dually, ;
  2778                                  ; both as net ID and for a cluster number for local devices.  In the case  ;
  2779                                  ; of local devices, the cluster number will be -1 if there is a potential  ;
  2780                                  ; of the disk being changed or if the path must be recracked.		   ;
  2781                                  ;
  2782                                  ;	Some pathnames have special preambles, such as
  2783                                  ;
  2784                                  ;		\\machine\sharename\...
  2785                                  ;	For these pathnames we can't allow ".." processing to back us
  2786                                  ;	up into the special front part of the name.  The CURDIR_END field
  2787                                  ;	holds the address of the seperator character which marks
  2788                                  ;	the split between the special preamble and the regular
  2789                                  ;	path list; ".." processing isn't allowed to back us up past
  2790                                  ;	(i.e., before) CURDIR_END
  2791                                  ;	For the root, it points at the leading /.  For net
  2792                                  ;	assignments it points at the end (nul) of the initial assignment:
  2793                                  ;	A:/	\\foo\bar	    \\foo\bar\blech\bozo
  2794                                  ;	  ^		 ^		     ^
  2795                                  
  2796                                  DIRSTRLEN	EQU	64+3		; Max length in bytes of directory strings
  2797                                  
  2798                                  TEMPLEN 	EQU	DIRSTRLEN*2
  2799                                  
  2800                                  struc curdir	; curdir_list
  2801 00000000 <res 43h>               .text:		resb DIRSTRLEN		; text of assignment and curdir
  2802 00000043 ????                    .flags:		resw 1			; various flags
  2803 00000045 ????????                .devptr:	resd 1			; local pointer to DPB or net device
  2804 00000049 ????????                .ID:		resw 2			; cluster of current dir (net ID)
  2805 0000004D ????                    .user_word:	resw 1
  2806 0000004F ????                    .end:		resw 1			; index to ".." backup limit - see above
  2807                                  ; MSDOS 6.0
  2808 00000051 ??                      .type:		resb 1			; IFS drive (2=ifs, 4=netuse)
  2809 00000052 ????????                .ifs_hdr:	resd 1			; Ptr to File System Header
  2810 00000056 ????                    .fsda:		resb 2			; File System Dependent Data Area
  2811                                  .size:
  2812                                  endstruc
  2813                                  
  2814                                  curdirLen	EQU curdir.size	; 88	; Needed for screwed up
  2815                                  
  2816                                  %define curdir_netID curdir_ID  ; dword
  2817                                  
  2818                                  ;**	Flag values for CURDIR_FLAGS
  2819                                  
  2820                                  curdir_isnet	EQU	1000000000000000B
  2821                                  CURDIR_isifs	EQU	1000000000000000B ; MSDOS 6.0	
  2822                                  curdir_inuse	EQU	0100000000000000B
  2823                                  curdir_splice	EQU	0010000000000000B
  2824                                  curdir_local	EQU	0001000000000000B
  2825                                  
  2826                                  ;									   ;
  2827                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  2828                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  2829                                  
  2830                                  ;============================================================================
  2831                                  ; CPMFCB.INC (MSDOS 3.3, 1987)
  2832                                  ;============================================================================
  2833                                  ; 09/07/2018 - Retro DOS v3.0
  2834                                  
  2835                                  ;BREAK <File Control Block definition>
  2836                                  
  2837                                  ;
  2838                                  ; Field definition for FCBs
  2839                                  ; The FCB has the following structure:
  2840                                  ;
  2841                                  ;	+---------------------------+
  2842                                  ;	|   Drive indicator(byte)   |
  2843                                  ;	+---------------------------+
  2844                                  ;	|    Filename (8 chars)     |
  2845                                  ;	+---------------------------+
  2846                                  ;	|    Extension (3 chars)    |
  2847                                  ;	+---------------------------+
  2848                                  ;	|   Current Extent(word)    |
  2849                                  ;	+---------------------------+
  2850                                  ;	|    Record size (word)     |
  2851                                  ;	+---------------------------+
  2852                                  ;	|    File Size (2 words)    |
  2853                                  ;	+---------------------------+
  2854                                  ;	|	Date of write	    |
  2855                                  ;	+---------------------------+
  2856                                  ;	|	Time of write	    |
  2857                                  ;	+---------------------------+
  2858                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  2859                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  2860                                  ;									   ;
  2861                                  ;	+---------------------------+
  2862                                  ;	|   8 bytes reserved	    |
  2863                                  ;	+---------------------------+
  2864                                  ;									   ;
  2865                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  2866                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  2867                                  ;	|    next record number     |
  2868                                  ;	+---------------------------+
  2869                                  ;	|   random record number    |
  2870                                  ;	+---------------------------+
  2871                                  ;
  2872                                  
  2873                                  struc	SYS_FCB
  2874 00000000 ??                      .drive:	resb 1
  2875 00000001 ????????????????        .name:	resb 8
  2876 00000009 ??????                  .ext:	resb 3
  2877 0000000C ????                    .EXTENT: resw 1
  2878 0000000E ????                    .RECSIZ: resw 1			; Size of record (user settable)
  2879 00000010 ????                    .FILSIZ: resw 1			; Size of file in bytes; used with the
  2880                                  				; following word
  2881 00000012 ????                    .DRVBP:	resw 1			; BP for SEARCH FIRST and SEARCH NEXT
  2882 00000014 ????                    .FDATE:	resw 1			; Date of last writing
  2883 00000016 ????                    .FTIME:	resw 1			; Time of last writing
  2884                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  2885                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  2886                                  ;									   ;
  2887 00000018 ????????????????        .reserved: resb 8		; RESERVED
  2888                                  ;									   ;
  2889                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  2890                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  2891 00000020 ??                      .NR:	resb 1			; Next record
  2892 00000021 ????????                .RR:	resb 4			; Random record
  2893                                  .size:
  2894                                  endstruc
  2895                                  
  2896                                  FILDIRENT EQU SYS_FCB.FILSIZ	; Used only by SEARCH FIRST and SEARCH
  2897                                  				; NEXT
  2898                                  ; 20/07/2018
  2899                                  %define fcb_sfn	SYS_FCB.reserved ; byte
  2900                                  
  2901                                  ; Note that fcb_net_handle, fcb_nsl_drive, fcb_nsld_drive and fcb_l_drive
  2902                                  ; all must point to the same byte.  Otherwise, the FCBRegen will fail.
  2903                                  ; NOTE about this byte (fcb_nsl_drive)
  2904                                  ;   The high two bits of this byte are used as follows to indicate the FCB type
  2905                                  ;	00 means a local file or device with sharing loaded
  2906                                  ;	10 means a remote (network) file
  2907                                  ;	01 means a local file with no sharing loaded
  2908                                  ;	11 means a local device with no sharing loaded
  2909                                  
  2910                                  ; 20/07/2018
  2911                                  
  2912                                  ;
  2913                                  ; Network FCB
  2914                                  ;
  2915                                  
  2916                                  %define fcb_net_drive	SYS_FCB.reserved+1  ; byte
  2917                                  %define fcb_net_handle	SYS_FCB.reserved+2  ; word
  2918                                  %define fcb_netID	SYS_FCB.reserved+4  ; dword		
  2919                                  
  2920                                  ;
  2921                                  ; No sharing local file FCB
  2922                                  ;
  2923                                  
  2924                                  %define fcb_nsl_drive	SYS_FCB.reserved+1  ; byte
  2925                                  %define fcb_nsl_bits	SYS_FCB.reserved+2  ; byte	
  2926                                  %define fcb_nsl_firclus SYS_FCB.reserved+3  ; word	
  2927                                  %define fcb_nsl_dirsec	SYS_FCB.reserved+5  ; word
  2928                                  %define fcb_nsl_dirpos  SYS_FCB.reserved+7  ; byte
  2929                                  
  2930                                  ;
  2931                                  ; No sharing local device FCB
  2932                                  ;
  2933                                  
  2934                                  %define fcb_nsld_drive	SYS_FCB.reserved+1  ; byte	
  2935                                  %define fcb_nsld_drvptr SYS_FCB.reserved+2  ; dword
  2936                                  
  2937                                  ;
  2938                                  ; Sharing local FCB
  2939                                  ;
  2940                                  
  2941                                  %define fcb_l_drive	SYS_FCB.reserved+1  ; byte
  2942                                  %define fcb_l_firclus	SYS_FCB.reserved+2  ; word
  2943                                  %define fcb_l_mfs	SYS_FCB.reserved+4  ; word
  2944                                  %define fcb_l_attr	SYS_FCB.reserved+6  ; byte
  2945                                  
  2946                                  ;
  2947                                  ; Bogusness:  the four cases are:
  2948                                  ;
  2949                                  ;   local file	    00
  2950                                  ;   local device    40
  2951                                  ;   local sharing   C0
  2952                                  ;   network	    80
  2953                                  ;
  2954                                  ; Since sharing and network collide, we cannot use a test instruction for
  2955                                  ; deciding whether a network or a share check in involved
  2956                                  ;
  2957                                  FCBDEVICE   EQU 040h
  2958                                  FCBNETWORK  EQU 080h
  2959                                  FCBSHARE    EQU 0C0h
  2960                                  
  2961                                  ; FCBSPECIAL must be able to mask off both net and share
  2962                                  FCBSPECIAL  EQU 080h
  2963                                  FCBMASK     EQU 0C0h
  2964                                  
  2965                                  ;============================================================================
  2966                                  ; FASTOPEN.INC, MSDOS 6.0, 1991
  2967                                  ;============================================================================
  2968                                  ; 11/07/2018 - Retro DOS v3.0
  2969                                  ; 25/04/2019 - Retro DOS v4.0
  2970                                  ; 21/02/2024 - Retro DOS v5.0
  2971                                  
  2972                                  struc FEI	; FASTOPEN_EXTENDED_INFO
  2973 00000000 ??                      .dirpos:	resb 1
  2974 00000001 ????????                .dirsec:	resd 1 ; MSDOS 6.0
  2975                                  ;.dirsec:	resw 1 ; MSDOS 3.3
  2976 00000005 ????                    .clusnum:	resw 1
  2977 00000007 ????                    		resw 1 ; PCDOS 7.1 ; 21/02/2024
  2978 00000009 ????                    .lastent:	resw 1	; for search first ; MSDOS 6.0
  2979 0000000B ????                    .dirstart:	resw 1	; for search first ; MSDOS 6.0
  2980                                  .size:
  2981                                  endstruc
  2982                                  
  2983                                  ; 23/07/2018
  2984                                  ;FASTOPEN NAME CACHING Subfunctions
  2985                                  FONC_Look_up	equ	1
  2986                                  FONC_insert	equ	2
  2987                                  FONC_delete	equ	3
  2988                                  FONC_update	equ	4
  2989                                  FONC_purge	equ	5	;reserved for the future use.
  2990                                  FONC_Rename	equ	6	;AN001
  2991                                  
  2992                                  ; 27/07/2018
  2993                                  ;FastOpen Data Structure
  2994                                  struc fastopen_entry	;Fastopen Entry pointer in DOS
  2995 00000000 ????                    .entry_size:	resw 1	; = 4	; size of the following
  2996 00000002 ????????                .name_caching:	resd 1
  2997                                  ; MSDOS 6.0
  2998                                  ;.fatchain_caching: resd 1	;reserved for future use
  2999                                  .size:
  3000                                  endstruc
  3001                                  
  3002                                  ; 27/07/2018
  3003                                  ;Equates used in DOS.
  3004                                  FastOpen_Set	       equ     00000001b
  3005                                  FastOpen_Reset	       equ     11111110b
  3006                                  Lookup_Success	       equ     00000010b
  3007                                  Lookup_Reset	       equ     11111101b
  3008                                  Special_Fill_Set       equ     00000100b
  3009                                  Special_Fill_Reset     equ     11111011b
  3010                                  No_Lookup	       equ     00001000b
  3011                                  Set_For_Search	       equ     00010000b	;DCR 167
  3012                                  
  3013                                  ; 09/08/2018 
  3014                                  ; (FASTXXXX.INC, MSDOS 6.0, 1991)
  3015                                  ; Fastxxx equates
  3016                                  FastOpen_ID	   equ	   1
  3017                                  FastSeek_ID	   equ	   2
  3018                                  Fast_yes	   equ	   10000000B ; 80h ; fastxxx flag
  3019                                  
  3020                                  ;Structure definitions
  3021                                  ;
  3022                                  struc Fasttable_Entry	 ; Fastxxx  Entry pointer in DOS
  3023 00000000 ????                    .Fast_Entry_Num: resw 1	 ; number of entries
  3024 00000002 ????????                .FastOpen_Seek:	 resd 1	 ; fastopen & fastseek entry address
  3025                                  endstruc
  3026                                  
  3027                                  ;============================================================================
  3028                                  ; LOCK.INC, MSDOS 6.0, 1991
  3029                                  ;============================================================================
  3030                                  ; 14/07/2018 - Retro DOS v3.0
  3031                                  
  3032                                  ;**	LOCK.INC - Definitions for Record Locking
  3033                                  
  3034                                  ;**	LOCK functions
  3035                                  
  3036                                  LOCK_ALL	    equ    0
  3037                                  UNLOCK_ALL	    equ    1
  3038                                  LOCK_MUL_RANGE	    equ    2
  3039                                  UNLOCK_MUL_RANGE    equ    3
  3040                                  LOCK_READ	    equ    4
  3041                                  WRITE_UNLOCK	    equ    5
  3042                                  LOCK_ADD	    equ    6
  3043                                  
  3044                                  ;**	Structure for Lock buffer
  3045                                  
  3046                                  struc LockBuf
  3047 00000000 ????????                .Lock_position:	resd 1		; file position for LOCK
  3048 00000004 ????????                .Lock_length:	resd 1		; number of bytes to LOCK
  3049                                  endstruc
  3050                                  
  3051                                  ;============================================================================
  3052                                  ; DPL.ASM, MSDOS 6.0, 1991
  3053                                  ;============================================================================
  3054                                  ; 04/08/2018 - Retro DOS v3.0
  3055                                  
  3056                                  ; (SRVCALL.ASM)
  3057                                  
  3058                                  struc DPL
  3059 00000000 ????                    .AX:	resw	1	; AX register
  3060 00000002 ????                    .BX:	resw	1	; BX register
  3061 00000004 ????                    .CX:	resw	1	; CX register
  3062 00000006 ????                    .DX:	resw	1	; DX register
  3063 00000008 ????                    .SI:	resw	1	; SI register
  3064 0000000A ????                    .DI:	resw	1	; DI register
  3065 0000000C ????                    .DS:	resw	1	; DS register
  3066 0000000E ????                    .ES:	resw	1	; ES register
  3067 00000010 ????                    .rsrvd: resw	1	; Reserved
  3068 00000012 ????                    .UID:	resw	1	; User (Machine) ID (0 = local macine)
  3069 00000014 ????                    .PID:	resw	1	; Process ID (0 = local user PID)
  3070                                  .size:
  3071                                  endstruc
  3072                                   
  3073                                  ;----------------------------------------------------------------------------
  3074                                  ; DOSDATA
  3075                                  ;----------------------------------------------------------------------------
  3076                                  ;============================================================================
  3077                                  ; 24/04/2019 - Retro DOS v4.0
  3078                                  
  3079                                  DosDataSg equ 3 ; DOS Data Segment address (dw in 'retrodos4.s')
  3080                                  		; ((just after resident IO.SYS code&data))
  3081                                  
  3082                                  ;============================================================================
  3083                                  ; WIN386.INC, MSDOS 6.0, 1991
  3084                                  ;============================================================================
  3085                                  ; 24/04/2019 - Retro DOS 4.0
  3086                                  
  3087                                  ;
  3088                                  ;  Symbols and structures relating to WIN386 support.
  3089                                  ;
  3090                                  ;  Used by files in both the DOS and the BIOS.
  3091                                  ;
  3092                                  ;  Created: 7-13-89 by MRW
  3093                                  ;
  3094                                  
  3095                                  ; WIN386 broadcast int 2fh multiplex number and subfunction numbers
  3096                                  
  3097                                  MultWin386		equ     16h	; Int 2f multiplex number
  3098                                  
  3099                                  Win386_Init		equ	05h	; Win386 initialization
  3100                                  Win386_Exit		equ	06h	; Win386 exit
  3101                                  Win386_Devcall		equ	07h	; Win386 device call out
  3102                                  Win386_InitDone		equ	08h	; Win386 initialization is complete
  3103                                  
  3104                                  ; When Win386_Devcall is broadcast, BX is the Device ID. DOS must 
  3105                                  ; answer call outs from the DOSMGR
  3106                                  
  3107                                  Win386_DOSMGR		equ	15H
  3108                                  
  3109                                  ; The following structures are used to communicate instance data to 
  3110                                  ; Win386 from the DOS and the BIOS. See Win386 API documentation
  3111                                  ; (chapter 3, "Call Out Interfaces") for further description.
  3112                                  
  3113                                  struc Win386_SIS	; Startup Info Structure
  3114 00000000 ????                     .Version:		resb	2	; db 3, 0
  3115 00000002 ????????                 .Next_Dev_Ptr:		resd	1	; pointer to next SIS in list
  3116 00000006 ????????                 .Virt_Dev_File_Ptr:	resd	1
  3117 0000000A ????????                 .Reference_Data:	resd	1
  3118 0000000E ????????                 .Instance_Data_Ptr:	resd	1	; pointer to instance data array
  3119                                  endstruc
  3120                                  
  3121                                  size_of_Win386_SIS equ 18 ; 24/04/2019 - Retro DOS v4.0
  3122                                  
  3123                                  struc Win386_IIS	; Instance Item Structure
  3124 00000000 ????????                .Ptr:			resd	1	; pointer to an instance item
  3125 00000004 ????                    .Size:			resw	1	; size of an instance item
  3126                                  endstruc
  3127                                  
  3128                                  size_of_Win386_IIS equ 6 ; 24/04/2019 - Retro DOS v4.0
  3129                                  
  3130                                  ;Win386 DOSMGR function return values to indicate operation done
  3131                                  
  3132                                  WIN_OP_DONE		equ	0B97Ch	; 
  3133                                  DOSMGR_OP_DONE		equ	0A2ABh	;
  3134                                  
  3135                                  ;M021
  3136                                  ; WInoldap callout multiplex number
  3137                                  
  3138                                  WINOLDAP		equ	46h	;
  3139                                  
  3140                                  ;============================================================================
  3141                                  ;----------------------------------------------------------------------------
  3142                                  ; DOSCODE
  3143                                  ;----------------------------------------------------------------------------
  3144                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3145                                  
  3146                                  ;============================================================================
  3147                                  ; MSHEAD.ASM (MSDOS 6.0, 1991)
  3148                                  ;============================================================================
  3149                                  ; 16/07/2018 - Retro DOS 3.0
  3150                                  ;----------------------------------------------------------------------------
  3151                                  ; 24/04/2019 - Retro DOS 4.0
  3152                                  
  3153                                  ; MSDOS 6.0
  3154                                  ;----------------------------------------------------------------------------
  3155                                  ; FILE : ORIGIN.INC
  3156                                  ;----------------------------------------------------------------------------
  3157                                  ; This is included in origin.asm and mshead.asm. Contains the equate that
  3158                                  ; is used for ORGing the DOS code.
  3159                                  ;
  3160                                  ; Brief Description of the necessacity of this ORG:
  3161                                  ; -------------------------------------------------
  3162                                  ;
  3163                                  ; A special problem exits when running out of the HMA. The HMA starts at 
  3164                                  ; address FFFF:10. There is no place in the HMA with an offset of zero.
  3165                                  ; This means programs running out off the HMA must use non-zero offset base
  3166                                  ; addresses. It also means that if we're running multiple programs from the
  3167                                  ; HMA, the base offset of each segment must atleast be as big as all of the
  3168                                  ; HMA segments that precede it.
  3169                                  ; 
  3170                                  ; One solution to this problem to ORG each module at 64K minus its size.
  3171                                  ; For instance a code segment 1234h bytes in length would org'd at edcbh.
  3172                                  ; This gives max. flexibility regarding it's location in the HMA. By 
  3173                                  ; selecting segment values between f124h and ffffh it could be located 
  3174                                  ; anywhere in the HMA. The problem with this is that programs with such 
  3175                                  ; high ORGs would not be able to run in low RAM.
  3176                                  ;
  3177                                  ; A compromise solution is to set the ORG address somewhere between 0010h
  3178                                  ; and ffffh - their size. In the particular case of the BIOS and the DOS 
  3179                                  ; the following solution has been implemented:
  3180                                  ;
  3181                                  ; The Bios Code segment will have a very small offset and run at the very
  3182                                  ; front of the HMA, after the VDISK header. THE Dos Code segment will have 
  3183                                  ; a base offset of (700+<min. size off RAM based BIOS>+<min. size of the DOS
  3184                                  ; DATA segment when DOS is running low>). This will reflect the lowest 
  3185                                  ; possible physical address at which DOS code will run, while still providing
  3186                                  ; max. possible flexibility in HMA positioning. This offset MUST NOT be 
  3187                                  ; smaller then that 20+size of Bios Code segment when running high. This is 
  3188                                  ; mostly true.
  3189                                  ;
  3190                                  ; Also this ORG'd value must be communicated to the BIOS. This is done by
  3191                                  ; putting this value after the first jmp instruction in the DOS code in
  3192                                  ; mshead.asm. 
  3193                                  ;
  3194                                  ; In order for the stripz utility to know how many zeroes to be stripped 
  3195                                  ; out, this value is placed at the beginning of the binary in origin.asm.
  3196                                  ;
  3197                                  ; Revision History:
  3198                                  ;
  3199                                  ; Currently this is being done manually. Therefore any change in the DOS DATA
  3200                                  ; Size or the BIOS size should be reflected here. --- Feb 90
  3201                                  ;
  3202                                  ; BDSIZE.INC contains the equates for BIODATASIZE, BIOCODESIZ and DOSDATASIZ.
  3203                                  ; A utility called getsize will obtain the corresponding values from msdos
  3204                                  ; and msbio.map and update the values in BDSIZ.INC if they are different. 
  3205                                  ; DOS should now be built using the batch file makedos.bat which invokes this
  3206                                  ; utility. The FORMAT of BDSIZE.INC should not be changed as getsize is 
  3207                                  ; dependant on that.				  --- Apr 3 '90
  3208                                  ;
  3209                                  ; For ROMDOS, however, there is no need to org the doscode to any location
  3210                                  ; other than zero.  Therefore the stripz utility will not need to be used,
  3211                                  ; so the offset will not need to be included at the beginning of the code
  3212                                  ; segment.  Also, the BIOS can just assume that the resident code begins
  3213                                  ; at offset zero within the segment.
  3214                                  ; 
  3215                                  ;
  3216                                  ;--------------------------------------------------------------------------
  3217                                  
  3218                                  BIODATASTART	EQU	00700h
  3219                                  ;include	bdsize.inc	; this sets the values:
  3220                                  				;	BIODATASIZ
  3221                                  				;	BIOCODESIZ
  3222                                  				;	DOSDATASIZ
  3223                                  
  3224                                  ; 05/12/2022
  3225                                  ;BIODATASIZ EQU 00910H	; 0900h for MSDOS 6.21 IO.SYS
  3226                                  			; 0900h for MSDOS 5.0 IO.SYS
  3227                                  ;BIOCODESIZ EQU 01A70H	; 1A70h for MSDOS 6.21 IO.SYS
  3228                                  			; 1A60h for MSDOS 5.0 IO.SYS
  3229                                  ;DOSDATASIZ EQU 01370H	; 1370h for MSDOS 6.21 IO.SYS
  3230                                  			; 1370h for MSDOS 5.0 IO.SYS
  3231                                  ;ifndef ROMDOS
  3232                                  ;
  3233                                  ;BYTSTART	EQU    	BIODATASTART+BIODATASIZ+BIOCODESIZ+DOSDATASIZ
  3234                                  ;PARASTART	EQU	(BYTSTART + 0FH) AND (NOT 0FH)	
  3235                                  ;
  3236                                  ;else
  3237                                  ;
  3238                                  ;BYTSTART	EQU	0
  3239                                  ;PARASTART	EQU	0
  3240                                  ;
  3241                                  ;endif ; ROMDOS
  3242                                  
  3243                                  ; 24/04/2019 - Retro DOS v4.0 - Modification
  3244                                  ; -----------------------------------------------------------------
  3245                                  ;MSDAT001E equ 136Ah ; 4970 ; for MSDOS 6.21	
  3246                                  ;MSDAT001E equ 1370h ; 4976 ; for Retro DOS v4.0 modif. 25/05/2019	
  3247                                  ;DOSDATASIZE equ MSDAT001E
  3248                                  ; 05/12/2022
  3249                                  ;DOSDATASIZE equ $ ; 29/04/2019 ; -only- for RETRO DOS v4.0 :
  3250                                  ;_PARASTART_ equ DOSDATASIZE ; segment value will point to start of
  3251                                  			    ; of DOSDATA (in low memory) while
  3252                                  			    ; dos/kernel code starts just after 
  3253                                  			    ; this data block ((org = DOSDATASIZE))
  3254                                  			    ; (in low memory or in HMA)	
  3255                                  ; -----------------------------------------------------------------
  3256                                  
  3257                                  ; 04/11/2022	
  3258                                  ; -----------------------------------------------------------------	
  3259                                  ; NOTE:
  3260                                  ; Microsoft dos programmers were calling 'IO.SYS' as dos 'BIOS'
  3261                                  ; (Also, they were calling 'ROMBIOS' as 'ROM' only!)
  3262                                  ; -----------------------------------------------------------------
  3263                                  
  3264                                  ; ----------------------------------------------------------------------------
  3265                                  ; 06/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3266                                  ; ----------------------------------------------------------------------------
  3267                                  ; ----------------------------------------------------------------------------
  3268                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  3269                                  ; ----------------------------------------------------------------------------
  3270                                  
  3271                                  ;-----------------------------------------------------------------------------
  3272                                  ; Start of (PCDOS 7.1) IBMDOS.COM
  3273                                  ;-----------------------------------------------------------------------------
  3274                                  
  3275                                  ;segment .code vstart=3DD0h ; 06/12/2022
  3276                                  ; 29/09/2023
  3277                                  ;segment .code vstart=3DE0h ; 19/09/2023 - Retro DOS v4.2 (Modified MSDOS 6.22)
  3278                                  ; ----------------------------------------------------------------------------
  3279                                  ; 01/01/2024
  3280                                  segment .code vstart=3F10h ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1)
  3281                                  								
  3282                                  ; ============================================================================
  3283                                  
  3284                                  ;[ORG 3DE0h]
  3285                                  
  3286                                  ;[ORG _PARASTART_]     ; [org 136Ah]
  3287                                  
  3288                                  ;[ORG 1370h] ; 25/05/2019 - Retro DOS v4.0
  3289                                  
  3290                                  ; 01/01/2024 - Retro DOS v5.0 
  3291                                  ;[ORG 3F10h] 
  3292                                  
  3293                                  	; 05/12/2022 - RetroDOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3294                                  	;PARASTART equ 3DD0h ; BIOSDATASTART+BIOSDATASIZE
  3295                                  			     ; +BIOSCODESIZE+DOSDATASIZE (rounded up)
  3296                                  	
  3297                                  	; 29/09/2023 
  3298                                  	; 19/09/2023 - Retro DOS v4.2 (Modified MSDOS 6.22 MSDOS.SYS)
  3299                                  	;PARASTART equ 3DE0h	; (MSDOS 6.22 MSDOS.SYS)
  3300                                  
  3301                                  	; 01/01/2024 - Retro DOS v4.2 (Modified PCDOS 7.1 IBMDOS.COM)
  3302                                  	PARASTART equ 3F10h	; (PCDOS 7.1 IBMDOS.COM)
  3303                                  
  3304                                  	[ORG PARASTART]	
  3305                                  
  3306                                  _$STARTCODE:
  3307                                  
  3308                                  ;PARASTART:
  3309 00000000 E94F8B                          JMP     DOSINIT
  3310                                  
  3311                                  	;dw	PARASTART	; PARASTART = 3DE0h for MSDOS 6.0, 6.22
  3312                                  	; 04/11/2022		; PARASTART = 3DD0h for MSDOS 5.0
  3313 00000003 [0000]                  	dw	_$STARTCODE	; PARASTART = 3F10h for PCDOS 7.1 ; 01/01/2024
  3314                                  
  3315                                  BioDataSeg:
  3316 00000005 7000                    	dw	0070h		; Bios data segment fixed at 70h
  3317                                  
  3318                                  ; DosDSeg is a data word in the DOSCODE segment that is loaded with
  3319                                  ; the segment address of DOSDATA. This is purely an optimization, that
  3320                                  ; allows getting the DOS data segment without going through the 
  3321                                  ; BIOS data segment. It is used by the "getdseg" macro.
  3322                                  
  3323                                  DosDSeg:
  3324 00000007 0000                    	dw	0
  3325                                  	
  3326                                  ;============================================================================
  3327                                  ; MSTABLE.ASM (MSDOS 6.0, 1991)
  3328                                  ;============================================================================
  3329                                  ; 16/07/2018 - Retro DOS 3.0
  3330                                  ; 29/04/2019 - Retro DOS 4.0
  3331                                  
  3332                                  	; (MSDOS version)
  3333                                  	; DOSCODE:3DE9h (MSDOS 6.21, MSDOS.SYS)
  3334                                  	;db	6
  3335                                  	;db	20
  3336                                  	; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS) 
  3337                                  	; DOSCODE:3DD9h (MSDOS 5.0, MSDOS.SYS)
  3338                                  	;db	5
  3339                                  	;db	0	
  3340                                  
  3341                                  	; Offset 0C78h in IBMDOS.COM (MSDOS 3.3, 1987)
  3342                                  MSVERS:				; MS-DOS version in hex for $GET_VERSION
  3343 00000009 07                      MSMAJOR: DB	MAJOR_VERSION	; DOS_MAJOR_VERSION
  3344 0000000A 0A                      MSMINOR: DB	MINOR_VERSION	; DOS_MINOR_VERSION  
  3345                                  
  3346                                  ;;hkn YRTAB & MONTAB moved to DOSDATA in ms_data.asm
  3347                                  ;	I_am	YRTAB,8,<200,166,200,165,200,165,200,165>   ; [SYSTEM]
  3348                                  ;	I_am	MONTAB,12,<31,28,31,30,31,30,31,31,30,31,30,31> ; [SYSTEM]
  3349                                  
  3350                                  ; DOSTAB.ASM (MSDOS 6.0, 1991)
  3351                                  ; YRTAB & MONTAB moved from TABLE segment in ms_table.asm
  3352                                  ;
  3353                                  ;	I_am    YRTAB,8,<200,166,200,165,200,165,200,165>   
  3354                                  ;	I_am    MONTAB,12,<31,28,31,30,31,30,31,31,30,31,30,31> 
  3355                                  
  3356                                  ; This is the error code mapping table for INT 21 errors. This table defines
  3357                                  ; those error codes which are "allowed" for each system call. If the error
  3358                                  ; code ABOUT to be returned is not "allowed" for the call, the correct action
  3359                                  ; is to return the "real" error via Extended error, and one of the allowed
  3360                                  ; errors on the actual call.
  3361                                  ;
  3362                                  ; The table is organized as follows:
  3363                                  ;
  3364                                  ;    Each entry in the table is of variable size, but the first
  3365                                  ;       two bytes are always:
  3366                                  ;
  3367                                  ;       Call#,Cnt of bytes following this byte
  3368                                  ;
  3369                                  ; EXAMPLE:
  3370                                  ;       Call 61 (OPEN)
  3371                                  ;
  3372                                  ;       DB      61,5,12,3,2,4,5
  3373                                  ;
  3374                                  ;       61 is the AH INT 21 call value for OPEN.
  3375                                  ;        5 indicates that there are 5 bytes after this byte (12,3,2,4,5).
  3376                                  ;       Next five bytes are those error codes which are "allowed" on OPEN.
  3377                                  ;       The order of these values is not important EXCEPT FOR THE LAST ONE (in
  3378                                  ;       this case 5).  The last value will be the one returned on the call if
  3379                                  ;       the "real" error is not one of the allowed ones.
  3380                                  ;
  3381                                  ; There are a number of calls (for instance all of the FCB calls) for which
  3382                                  ;   there is NO entry.  This means that NO error codes are returned on this
  3383                                  ;   call, so set up an Extended error and leave the current error code alone.
  3384                                  ;
  3385                                  ; The table is terminated by a call value of 0FFh
  3386                                  
  3387                                  ;PUBLIC I21_MAP_E_TAB
  3388                                  	; 10/08/2018
  3389                                  
  3390                                  ; 29/04/2019
  3391                                  ; DOSCODE:3DE9h (MSDOS 6.21, MSDOS.SYS)
  3392                                  ; 04/11/2022
  3393                                  ; DOSCODE:3DDBh	(MSDOS 5.0 MSDOS.SYS)
  3394                                  ; 01/01/2024
  3395                                  ; DOSCODE:3F1Bh	(PCDOS 7.1 IBMDOS.COM)
  3396                                  
  3397                                  I21_MAP_E_TAB:	; LABEL	BYTE
  3398 0000000B 38020102                    DB  INTERNATIONAL,2,error_invalid_function,error_file_not_found
  3399 0000000F 3903030205                  DB  MKDIR,3,error_path_not_found,error_file_not_found,error_access_denied
  3400 00000014 3A041003                    DB  RMDIR,4,error_current_directory,error_path_not_found
  3401 00000018 0205                        DB          error_file_not_found,error_access_denied
  3402 0000001A 3B020203                    DB  CHDIR,2,error_file_not_found,error_path_not_found
  3403 0000001E 3C040302                    DB  CREAT,4,error_path_not_found,error_file_not_found
  3404 00000022 04                          DB          error_too_many_open_files
  3405 00000023 05                          DB          error_access_denied
  3406                                      ; MSDOS 6.0
  3407 00000024 3D0603020C                  DB	OPEN,6,error_path_not_found,error_file_not_found,error_invalid_access
  3408 00000029 04                          DB          error_too_many_open_files
  3409 0000002A 1A05                        DB          error_not_DOS_disk,error_access_denied
  3410                                      ; MSDOS 3.3
  3411                                      ;DB	OPEN,5,error_path_not_found,error_file_not_found,error_invalid_access
  3412                                      ;DB		error_too_many_open_files,error_access_denied
  3413 0000002C 3E0106                      DB  CLOSE,1,error_invalid_handle
  3414 0000002F 3F020605                    DB  READ,2,error_invalid_handle,error_access_denied
  3415 00000033 40020605                    DB  WRITE,2,error_invalid_handle,error_access_denied
  3416 00000037 4103030205                  DB  UNLINK,3,error_path_not_found,error_file_not_found,error_access_denied
  3417 0000003C 42020601                    DB  LSEEK,2,error_invalid_handle,error_invalid_function
  3418 00000040 4304030201                  DB  CHMOD,4,error_path_not_found,error_file_not_found,error_invalid_function
  3419 00000045 05                          DB          error_access_denied
  3420 00000046 44050F0D01                  DB  IOCTL,5,error_invalid_drive,error_invalid_data,error_invalid_function
  3421 0000004B 0605                        DB          error_invalid_handle,error_access_denied
  3422 0000004D 45020604                    DB  XDUP,2,error_invalid_handle,error_too_many_open_files
  3423 00000051 46020604                    DB  XDUP2,2,error_invalid_handle,error_too_many_open_files
  3424                                      ; MSDOS 6.0	
  3425 00000055 47021A0F                    DB  CURRENT_DIR,2,error_not_DOS_disk,error_invalid_drive
  3426                                      ; MSDOS 3.3	
  3427                                      ;DB  CURRENT_DIR,1,error_invalid_drive
  3428 00000059 48020708                    DB  ALLOC,2,error_arena_trashed,error_not_enough_memory
  3429 0000005D 49020709                    DB  DEALLOC,2,error_arena_trashed,error_invalid_block
  3430 00000061 4A03070908                  DB  SETBLOCK,3,error_arena_trashed,error_invalid_block,error_not_enough_memory
  3431 00000066 4B08030102                  DB  EXEC,8,error_path_not_found,error_invalid_function,error_file_not_found
  3432 0000006B 040B0A                      DB          error_too_many_open_files,error_bad_format,error_bad_environment
  3433 0000006E 0805                        DB          error_not_enough_memory,error_access_denied
  3434 00000070 4E03030212                  DB  FIND_FIRST,3,error_path_not_found,error_file_not_found,error_no_more_files
  3435 00000075 4F0112                      DB  FIND_NEXT,1,error_no_more_files
  3436                                      ; MSDOS 6.0
  3437 00000078 5605110302                  DB  RENAME,5,error_not_same_device,error_path_not_found,error_file_not_found
  3438 0000007D 1005                        DB		error_current_directory,error_access_denied
  3439                                      ; MSDOS 3.3
  3440                                      ;DB  RENAME,4,error_not_same_device,error_path_not_found,error_file_not_found
  3441                                      ;DB		error_access_denied
  3442                                      ; MSDOS 6.0	
  3443 0000007F 57040608                    DB  FILE_TIMES,4,error_invalid_handle,error_not_enough_memory
  3444 00000083 0D01                        DB		error_invalid_data,error_invalid_function
  3445                                      ; MSDOS 3.3	
  3446                                      ;DB  FILE_TIMES,2,error_invalid_handle,error_invalid_function
  3447 00000085 580101                      DB  ALLOCOPER,1,error_invalid_function
  3448 00000088 5A040302                    DB  CREATETEMPFILE,4,error_path_not_found,error_file_not_found
  3449 0000008C 0405                        DB          error_too_many_open_files,error_access_denied
  3450 0000008E 5B055003                    DB  CREATENEWFILE,5,error_file_exists,error_path_not_found
  3451 00000092 020405                      DB          error_file_not_found,error_too_many_open_files,error_access_denied
  3452 00000095 5C040601                    DB  LOCKOPER,4,error_invalid_handle,error_invalid_function
  3453 00000099 2421                        DB          error_sharing_buffer_exceeded,error_lock_violation
  3454 0000009B 65020102                    DB  GETEXTCNTRY,2,error_invalid_function,error_file_not_found	;DOS 3.3
  3455 0000009F 66020102                    DB  GETSETCDPG,2,error_invalid_function,error_file_not_found        ;DOS 3.3
  3456 000000A3 680106                      DB  COMMIT,1,error_invalid_handle                                   ;DOS 3.3
  3457 000000A6 67030408                    DB  EXTHANDLE,3,error_too_many_open_files,error_not_enough_memory
  3458 000000AA 01                          DB              error_invalid_function
  3459                                      ; MSDOS 6.0		
  3460 000000AB 6C0A                        DB	ExtOpen,10
  3461 000000AD 03020C                      DB	  error_path_not_found,error_file_not_found,error_invalid_access
  3462 000000B0 045008                      DB		error_too_many_open_files,error_file_exists,error_not_enough_memory
  3463 000000B3 1A0D                        DB		error_not_DOS_disk,error_invalid_data
  3464 000000B5 0105                        DB		error_invalid_function,error_access_denied
  3465 000000B7 69040F0D                    DB	GetSetMediaID,4,error_invalid_drive,error_invalid_data
  3466 000000BB 0105                        DB		error_invalid_function,error_access_denied
  3467                                      ; 01/01/2024
  3468                                      ; PCDOS 7.1				
  3469 000000BD 700101                      db	ExtCountryInfo,1,error_invalid_function 
  3470 000000C0 FF                          DB  0FFh
  3471                                  
  3472                                  ;19/09/2023
  3473                                  ;22/12/2022
  3474                                  ;04/11/2022	
  3475                                  ;29/04/2019 - Retro DOS v4.0
  3476                                  ;============================================================================
  3477                                  ; 	Retro DOS v4.0
  3478                                  ;============================================================================
  3479 000000C1 00                      	db 	0
  3480                                  RETRODOSMSG:
  3481 000000C2 0D0A                    	db	13,10
  3482                                  	;;;;;db	"Retro DOS v4.0 by Erdogan Tan [2019]"
  3483                                  	;;;;db	"Retro DOS v4.0 by Erdogan Tan [2022]"
  3484                                  	;;;db	"Retro DOS v4.1 by Erdogan Tan [2022]" ; 28/12/2022
  3485                                  	;;db	"Retro DOS v4.2 by Erdogan Tan [2022]" ; 30/12/2022
  3486                                  	;db	"Retro DOS v4.2 by Erdogan Tan [2023]"
  3487 000000C4 526574726F20444F53-     	db	"Retro DOS v5.0 by Erdogan Tan [2024]" ; 01/01/2024	 
  3487 000000CD 2076352E3020627920-
  3487 000000D6 4572646F67616E2054-
  3487 000000DF 616E205B323032345D 
  3488 000000E8 0D0A2400                	db	13,10,"$", 0 
  3489                                  
  3490                                  ;============================================================================
  3491                                  ; MSTABLE.ASM, MSDOS 6.0, 1991
  3492                                  ;============================================================================
  3493                                  ; 11/07/2018 - Retro DOS v3.0
  3494                                  
  3495                                  	%define short_addr dw  ; 03/03/2018 - Retro DOS v2.0
  3496                                  align 2
  3497                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 0E00h
  3498                                  
  3499                                  ; Standard Functions
  3500                                  ;DISPATCH  LABEL WORD
  3501                                  DISPATCH:
  3502                                  	; 16/07/2018 - Retro DOS v3.0
  3503                                  	; (MSDOS 3.3)
  3504                                  
  3505                                  ; 29/04/2019
  3506                                  ; DOSCODE:3E9Eh (MSDOS 6.21, MSDOS.SYS)
  3507                                  
  3508                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3509                                  ; DOSCODE:3E8Eh (MSDOS 5.0, MSDOS.SYS)
  3510                                  
  3511                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  3512                                  ; DOSCODE:3FD2h (PCDOS 7.1, IBMDOS.COM)
  3513                                  
  3514 000000EC [9B72]                          short_addr  _$ABORT			    ;  0      0
  3515 000000EE [221C]                          short_addr  _$STD_CON_INPUT		    ;  1      1
  3516 000000F0 [2B1C]                          short_addr  _$STD_CON_OUTPUT		    ;  2      2
  3517 000000F2 [DD1C]                          short_addr  _$STD_AUX_INPUT		    ;  3      3
  3518 000000F4 [F81C]                          short_addr  _$STD_AUX_OUTPUT		    ;  4      4
  3519 000000F6 [FE1C]                          short_addr  _$STD_PRINTER_OUTPUT	    ;  5      5
  3520 000000F8 [691B]                          short_addr  _$RAW_CON_IO		    ;  6      6
  3521 000000FA [951B]                          short_addr  _$RAW_CON_INPUT		    ;  7      7
  3522 000000FC [4319]                          short_addr  _$STD_CON_INPUT_NO_ECHO	    ;  8      8
  3523 000000FE [9C19]                          short_addr  _$STD_CON_STRING_OUTPUT	    ;  9      9
  3524 00000100 [A819]                          short_addr  _$STD_CON_STRING_INPUT	    ; 10      A
  3525 00000102 [121D]                          short_addr  _$STD_CON_INPUT_STATUS	    ; 11      B
  3526 00000104 [1B1D]                          short_addr  _$STD_CON_INPUT_FLUSH	    ; 12      C
  3527 00000106 [1414]                          short_addr  _$DISK_RESET		    ; 13      D
  3528 00000108 [4F0F]                          short_addr  _$SET_DEFAULT_DRIVE		    ; 14      E
  3529 0000010A [1824]                          short_addr  _$FCB_OPEN			    ; 15      F
  3530 0000010C [BA1D]                          short_addr  _$FCB_CLOSE			    ; 16     10
  3531 0000010E [2F25]                          short_addr  _$DIR_SEARCH_FIRST		    ; 17     11
  3532 00000110 [7525]                          short_addr  _$DIR_SEARCH_NEXT		    ; 18     12
  3533 00000112 [601D]                          short_addr  _$FCB_DELETE		    ; 19     13
  3534 00000114 [7322]                          short_addr  _$FCB_SEQ_READ		    ; 20     14
  3535 00000116 [7722]                          short_addr  _$FCB_SEQ_WRITE	            ; 21     15
  3536 00000118 [1F25]                          short_addr  _$FCB_CREATE		    ; 22     16
  3537 0000011A [261E]                          short_addr  _$FCB_RENAME		    ; 23     17
  3538                                  	; 16/07/2018
  3539                                          ;short_addr _CPMFUNC			    ; 24     18	
  3540 0000011C [8606]                          short_addr  NO_OP			    ; 24     18
  3541 0000011E [4A0F]                          short_addr  _$GET_DEFAULT_DRIVE		    ; 25     19
  3542 00000120 [3F0F]                          short_addr  _$SET_DMA			    ; 26     1A
  3543                                  
  3544                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3545                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3546                                  ;                                                                          ;
  3547 00000122 [ED12]                          short_addr  _$SLEAZEFUNC		    ; 27     1B
  3548 00000124 [EF12]                          short_addr  _$SLEAZEFUNCDL		    ; 28     1C
  3549                                  ;                                                                          ;
  3550                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3551                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3552                                  
  3553                                          ;short_addr  _CPMFUNC			    ; 29     1D
  3554                                          ;short_addr  _CPMFUNC			    ; 30     1E
  3555                                  
  3556                                  ; 08/07/2018 - Retro DOS v3.0
  3557                                  ; MSDOS 6.0 - MSTABLE.ASM, 1991
  3558                                  
  3559 00000126 [8606]                  	short_addr  NO_OP			    ; 29     1D
  3560 00000128 [8606]                  	short_addr  NO_OP			    ; 30     1E
  3561                                  
  3562                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3563                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3564                                  ;                                                                          ;
  3565 0000012A [3A13]                          short_addr  _$GET_DEFAULT_DPB               ; 31     1F
  3566                                  ;                                                                          ;
  3567                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3568                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3569                                          ;short_addr _CPMFUNC			    ; 32     20
  3570                                  
  3571                                  ; 08/07/2018 - Retro DOS v3.0
  3572                                  ; MSDOS 6.0 - MSTABLE.ASM, 1991
  3573                                  
  3574 0000012C [8606]                  	short_addr  NO_OP			    ; 32     20
  3575                                  
  3576 0000012E [7B22]                          short_addr  _$FCB_RANDOM_READ               ; 33     21
  3577 00000130 [7F22]                          short_addr  _$FCB_RANDOM_WRITE              ; 34     22
  3578 00000132 [721D]                          short_addr  _$GET_FCB_FILE_LENGTH	    ; 35     23
  3579 00000134 [481D]                          short_addr  _$GET_FCB_POSITION		    ; 36     24
  3580                                  
  3581                                  ;MAXCALL = ($-DISPATCH)/2 - 1
  3582                                  MAXCALL EQU ($-DISPATCH)/2 - 1
  3583                                  
  3584                                  ; Extended Functions
  3585 00000136 [700F]                          short_addr  _$SET_INTERRUPT_VECTOR	    ; 37     25
  3586                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3587                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3588                                  ;                                                                          ;
  3589 00000138 [4716]                          short_addr  _$CREATE_PROCESS_DATA_BLOCK	    ; 38     26
  3590                                  ;                                                                          ;
  3591                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3592                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3593 0000013A [6F22]                          short_addr  _$FCB_RANDOM_READ_BLOCK	    ; 39     27
  3594 0000013C [6B22]                          short_addr  _$FCB_RANDOM_WRITE_BLOCK        ; 40     28
  3595 0000013E [CA12]                          short_addr  _$PARSE_FILE_DESCRIPTOR	    ; 41     29
  3596 00000140 [D40A]                          short_addr  _$GET_DATE                      ; 42     2A
  3597 00000142 [F10A]                          short_addr  _$SET_DATE                      ; 43     2B
  3598 00000144 [100B]                          short_addr  _$GET_TIME                      ; 44     2C
  3599 00000146 [210B]                          short_addr  _$SET_TIME                      ; 45     2D
  3600 00000148 [BF0C]                          short_addr  _$SET_VERIFY_ON_WRITE           ; 46     2E
  3601                                  
  3602                                  ; Extended functionality group
  3603 0000014A [2C0F]                          short_addr  _$GET_DMA                       ; 47     2F
  3604 0000014C [960C]                          short_addr  _$GET_VERSION                   ; 48     30
  3605 0000014E [3F72]                          short_addr  _$KEEP_PROCESS		    ; 49     31
  3606                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3607                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3608                                  ;                                                                          ;
  3609 00000150 [3C13]                          short_addr  _$GET_DPB			    ; 50     32
  3610                                  ;                                                                          ;
  3611                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3612                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3613 00000152 [3D02]                          short_addr  _$SET_CTRL_C_TRAPPING           ; 51     33
  3614 00000154 [2413]                          short_addr  _$GET_INDOS_FLAG                ; 52     34
  3615 00000156 [610F]                          short_addr  _$GET_INTERRUPT_VECTOR          ; 53     35
  3616 00000158 [FF0E]                          short_addr  _$GET_DRIVE_FREESPACE           ; 54     36
  3617 0000015A [9D0F]                          short_addr  _$CHAR_OPER                     ; 55     37
  3618 0000015C [C60C]                          short_addr  _$INTERNATIONAL                 ; 56     38
  3619                                  ; XENIX CALLS
  3620                                  ;   Directory Group
  3621 0000015E [2228]                          short_addr  _$MKDIR			    ; 57     39
  3622 00000160 [4527]                          short_addr  _$RMDIR			    ; 58     3A
  3623 00000162 [9227]                          short_addr  _$CHDIR			    ; 59     3B
  3624                                  ;   File Group
  3625 00000164 [CE80]                          short_addr  _$CREAT			    ; 60     3C
  3626 00000166 [FD7F]                          short_addr  _$OPEN			    ; 61     3D
  3627 00000168 [9A77]                          short_addr  _$CLOSE		 	    ; 62     3E
  3628 0000016A [A278]                          short_addr  _$READ			    ; 63     3F
  3629 0000016C [FF78]                          short_addr  _$WRITE			    ; 64     40
  3630 0000016E [4081]                          short_addr  _$UNLINK			    ; 65     41
  3631 00000170 [0479]                          short_addr  _$LSEEK			    ; 66     42
  3632 00000172 [DB80]                          short_addr  _$CHMOD			    ; 67     43
  3633 00000174 [8A28]                          short_addr  _$IOCTL			    ; 68     44
  3634 00000176 [6879]                          short_addr  _$DUP			    ; 69     45
  3635 00000178 [8679]                          short_addr  _$DUP2			    ; 70     46
  3636 0000017A [E126]                          short_addr  _$CURRENT_DIR		    ; 71     47
  3637                                  ;   Memory Group
  3638 0000017C [3873]                          short_addr  _$ALLOC			    ; 72     48
  3639 0000017E [AD74]                          short_addr  _$DEALLOC                       ; 73     49
  3640 00000180 [8974]                          short_addr  _$SETBLOCK                      ; 74     4A
  3641                                  ;   Process Group
  3642 00000182 [156C]                          short_addr  _$EXEC			    ; 75     4B
  3643 00000184 [7772]                          short_addr  _$EXIT			    ; 76     4C
  3644 00000186 [0B6C]                          short_addr  _$WAIT			    ; 77     4D
  3645 00000188 [2B26]                          short_addr  _$FIND_FIRST		    ; 78     4E
  3646                                  ;   Special Group
  3647 0000018A [7F26]                          short_addr  _$FIND_NEXT			    ; 79     4F
  3648                                  ; SPECIAL SYSTEM GROUP
  3649                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3650                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3651                                  ;                                                                          ;
  3652 0000018C [A202]                          short_addr  _$SET_CURRENT_PDB		    ; 80     50
  3653 0000018E [AE02]                          short_addr  _$GET_CURRENT_PDB               ; 81     51
  3654 00000190 [3013]                          short_addr  _$GET_IN_VARS                   ; 82     52
  3655 00000192 [5B14]                          short_addr  _$SETDPB			    ; 83     53
  3656                                  ;                                                                          ;
  3657                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3658                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3659 00000194 [BA0C]                          short_addr  _$GET_VERIFY_ON_WRITE	    ; 84     54
  3660                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3661                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3662                                  ;                                                                          ;
  3663 00000196 [3616]                          short_addr  _$DUP_PDB                       ; 85     55
  3664                                  ;                                                                          ;
  3665                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3666                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3667 00000198 [6681]                          short_addr  _$RENAME			    ; 86     56
  3668 0000019A [9479]                          short_addr  _$FILE_TIMES                    ; 87     57
  3669 0000019C [E274]                          short_addr  _$ALLOCOPER                     ; 88     58
  3670                                  
  3671                                  ; 08/07/2018 - Retro DOS v3.0
  3672                                  ; -------------------------------------------------------------------------;
  3673                                  ; MSDOS 6.0 - MSTABLE.ASM, 1991
  3674                                  
  3675                                  ; Network extention system calls
  3676 0000019E [B10F]                          short_addr  _$GetExtendedError              ; 89     59
  3677 000001A0 [F281]                          short_addr  _$CreateTempFile                ; 90     5A
  3678 000001A2 [DA81]                          short_addr  _$CreateNewFile                 ; 91     5B
  3679 000001A4 [B583]                          short_addr  _$LockOper                      ; 92     5C
  3680 000001A6 [AD75]                          short_addr  _$ServerCall                    ; 93     5D
  3681 000001A8 [507B]                          short_addr  _$UserOper                      ; 94     5E
  3682 000001AA [B57A]                          short_addr  _$AssignOper                    ; 95     5F
  3683 000001AC [987F]                          short_addr  _$NameTrans                     ; 96     60
  3684 000001AE [8606]                  	short_addr  NO_OP			    ; 97     61
  3685 000001B0 [AE02]                          short_addr  _$GET_CURRENT_PDB		    ; 98     62
  3686                                  ; the next call is reserved for hangool sys call
  3687                                  	; 29/04/2019 - Retro DOS v4.0 (MSDOS 6.0)
  3688 000001B2 [D10F]                  	short_addr  _$ECS_Call			    ; 99     63
  3689                                  	;short_addr  NO_OP  ;  MSDOS 3.3	    ; 99     63
  3690                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3691                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3692                                  ;                                                                          ;
  3693 000001B4 [BA02]                          short_addr  _$SET_PRINTER_FLAG              ; 100    64
  3694                                  ;                                                                          ;
  3695                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3696                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3697 000001B6 [830D]                          short_addr  _$GetExtCntry                   ; 101    65
  3698 000001B8 [AD0E]                          short_addr  _$GetSetCdPg                    ; 102    66
  3699 000001BA [E577]                          short_addr  _$ExtHandle                     ; 103    67
  3700 000001BC [CD77]                          short_addr  _$COMMIT                        ; 104    68
  3701                                  
  3702                                  ; 08/07/2018
  3703                                  ; Above system calls are valid for Retro DOS v3.0 (MSDOS 3.3) 
  3704                                  ; Following system calls are valid for Retro DOS v4.0 (MSDOS 6.0)
  3705                                  
  3706                                  ; 29/04/2019 - Retro DOS v4.0 (MSDOS 6.0)
  3707 000001BE [3917]                  	short_addr  _$GSetMediaID                   ; 105    69   ;AN000;
  3708 000001C0 [CD77]                  	short_addr  _$COMMIT                        ; 106    6A   ;AN000;
  3709 000001C2 [8606]                  	short_addr  NO_OP                           ; 107    6B   
  3710                                  						    ; IFS_IOCTL no longer 
  3711                                  						    ; supported
  3712 000001C4 [9D82]                  	short_addr  _$Extended_Open                 ; 108    6C   ;AN000;
  3713                                  
  3714                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3715                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3716                                  ;                                                                          ;
  3717                                  ;ifdef ROMEXEC
  3718                                  ;       short_addr  $ROM_FIND_FIRST	   	    ; 109    6D
  3719                                  ;       short_addr  $ROM_FIND_NEXT	   	    ; 110    6E
  3720                                  ;	short_addr  $ROM_EXCLUDE		    ; 111    6F	  ; M078
  3721                                  ;endif
  3722                                  ;                                                                          ;
  3723                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3724                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3725                                  
  3726                                  ; --------------------------------------------------------------------------
  3727                                  
  3728                                  ; 01/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  3729                                  
  3730 000001C6 [8606]                  	short_addr NO_OP	; 6Dh, OS/2 "DosMkDir2" - ROM DOS: Find first ROM program
  3731 000001C8 [8606]                  	short_addr NO_OP	; 6Eh, OS/2 "DosEnumAttrib" - ROM DOS: Find next ROM program
  3732 000001CA [8606]                  	short_addr NO_OP	; 6Fh, OS/2 "DosQMaxEASize" - ROM DOS: Get/set searched ROM area
  3733 000001CC [490D]                  	short_addr _$ExtCountryInfo ; 70h, MSDOS 7 (WIN 95) - Get/set extended country information
  3734                                  				; GET/SET INTERNATIONALIZATION INFORMATION
  3735 000001CE [EC0F]                  	short_addr _$LONGNAME	; 71h, MSDOS 7 (WIN 95) LONG FILENAME FUNCTIONS
  3736 000001D0 [EC0F]                  	short_addr _$LONGNAME	; 72h, MSDOS 7 (WIN 95) LFN-FindClose
  3737 000001D2 [F90F]                  	short_addr _$FAT32EXT	; 73h, MSDOS 7 - FAT32 extended drive functions
  3738                                  
  3739                                  ;MAXCOM  = ($-DISPATCH)/2 - 1
  3740                                  
  3741                                  MAXCOM  EQU ($-DISPATCH)/2 - 1
  3742                                  
  3743                                  ; 08/07/2018 - Retro DOS v3.0
  3744                                  ; MSDOS 6.0 - MSTABLE.ASM, 1991
  3745                                  
  3746                                  ;	If Installed
  3747                                  
  3748                                  align 2
  3749                                  
  3750                                  ;PUBLIC FOO
  3751                                  
  3752                                  FOO:	; LABEL WORD
  3753 000001D4 [4307]                          short_addr Leave2F
  3754                                  
  3755 000001D6 [D801]                  DTab:	DW DOSTable
  3756                                  
  3757                                  	;PUBLIC FOO,DTAB
  3758                                  
  3759                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 0ED6h
  3760                                  
  3761                                  ; 29/04/2019
  3762                                  ; DOSCODE:3F7Ch (MSDOS 6.21, MSDOS.SYS)
  3763                                  
  3764                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3765                                  ; DOSCODE:3F6Ch (MSDOS 5.0, MSDOS.SYS)
  3766                                  
  3767                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  3768                                  ; DOSCODE:40BEh (PCDOS 7.1, IBMDOS.COM)
  3769                                         
  3770                                  DOSTable:  ; LABEL  WORD
  3771 000001D8 32                              DB	(DOSTableEnd-DOSTable-1)/2 ; db 50 ; 01/01/2024 
  3772 000001D9 [B509]                          short_addr  DOSInstall          ;   0 install check
  3773 000001DB [2137]                          short_addr  DOS_CLOSE           ;   1   DOS_CLOSE
  3774 000001DD [920F]                          short_addr  RECSET              ;   2   RECSET
  3775 000001DF [AF09]                          short_addr  DosGetGroup         ;   3   Get DOSGROUP
  3776 000001E1 [175E]                          short_addr  PATHCHRCMP          ;   4   PATHCHRCMP
  3777 000001E3 [2D1C]                          short_addr  OUTT                ;   5   OUT
  3778 000001E5 [2761]                          short_addr  NET_I24_ENTRY       ;   6   NET_I24_ENTRY
  3779 000001E7 [0269]                          short_addr  PLACEBUF            ;   7   PLACEBUF
  3780 000001E9 [8938]                          short_addr  FREE_SFT            ;   8   FREE_SFT
  3781 000001EB [496B]                          short_addr  BUFWRITE            ;   9   BUFWRITE
  3782 000001ED [7984]                          short_addr  SHARE_VIOLATION     ;   10  SHARE_VIOLATION
  3783 000001EF [FE32]                          short_addr  SHARE_ERROR         ;   11  SHARE_ERROR
  3784 000001F1 [E832]                          short_addr  SET_SFT_MODE        ;   12  SET_SFT_MODE
  3785 000001F3 [5C0B]                          short_addr  DATE16              ;   13  DATE16
  3786 000001F5 [DC17]                          short_addr  Idle		;   14      empty slot
  3787 000001F7 [FB68]                          short_addr  SCANPLACE           ;   15  SCANPLACE
  3788 000001F9 [DC17]                          short_addr  Idle		;   16      empty slot
  3789 000001FB [A917]                          short_addr  StrCpy              ;   17  StrCpy
  3790 000001FD [C117]                          short_addr  StrLen              ;   18  StrLen
  3791 000001FF [C45D]                          short_addr  UCase		;   19  UCase
  3792 00000201 [3F69]                          short_addr  POINTCOMP           ;   20  POINTCOMP
  3793 00000203 [146B]                          short_addr  CHECKFLUSH          ;   21  CHECKFLUSH
  3794 00000205 [1677]                          short_addr  SFFromSFN           ;   22  SFFromSFN
  3795 00000207 [0C7C]                          short_addr  GetCDSFromDrv       ;   23  GetCDSFromDrv
  3796 00000209 [7704]                          short_addr  Get_User_Stack      ;   24  Get_User_Stack
  3797 0000020B [BD7B]                          short_addr  GETTHISDRV          ;   25  GetThisDrv
  3798 0000020D [BD7F]                          short_addr  DriveFromText       ;   26  DriveFromText
  3799 0000020F [FD0B]                          short_addr  SETYEAR             ;   27  SETYEAR
  3800 00000211 [8C0C]                          short_addr  DSUM                ;   28  DSUM
  3801 00000213 [F30B]                          short_addr  DSLIDE              ;   29  DSLIDE
  3802 00000215 [8717]                          short_addr  StrCmp              ;   30  StrCmp
  3803 00000217 [037B]                          short_addr  InitCDS             ;   31  initcds
  3804 00000219 [E376]                          short_addr  pJFNFromHandle      ;   32  pJfnFromHandle
  3805 0000021B [987F]                          short_addr  _$NameTrans		;   33  $NameTrans
  3806 0000021D [AD06]                          short_addr  CAL_LK              ;   34  CAL_LK
  3807 0000021F [EF4D]                          short_addr  DEVNAME             ;   35  DEVNAME
  3808 00000221 [DC17]                          short_addr  Idle                ;   36  Idle
  3809 00000223 [CF17]                          short_addr  DStrLen             ;   37  DStrLen
  3810 00000225 [7E18]                          short_addr  NLS_OPEN            ;   38  NLS_OPEN      DOS 3.3
  3811 00000227 [9A77]                          short_addr  _$CLOSE		;   39  $CLOSE        DOS 3.3
  3812 00000229 [8418]                          short_addr  NLS_LSEEK           ;   40  NLS_LSEEK     DOS 3.3
  3813 0000022B [A278]                          short_addr  _$READ		;   41  $READ         DOS 3.3
  3814 0000022D [4018]                          short_addr  FastInit            ;   42  FastInit      DOS 3.4  ;AN000;
  3815 0000022F [C118]                          short_addr  NLS_IOCTL           ;   43  NLS_IOCTL     DOS 3.3
  3816 00000231 [B018]                          short_addr  GetDevList          ;   44  GetDevList    DOS 3.3
  3817 00000233 [DE18]                          short_addr  NLS_GETEXT          ;   45  NLS_GETEXT    DOS 3.3
  3818                                          
  3819                                  	; 29/04/2019 - Retro DOS v4.0
  3820 00000235 [E218]                  	short_addr  MSG_RETRIEVAL	;   46  MSG_RETRIEVAL DOS 4.0  ;AN000;
  3821                                  
  3822 00000237 [8606]                  	short_addr  NO_OP		;   M006: 47  no longer supported
  3823                                  ;*** 	short_addr  Fake_Version	;   47  Fake_Version  DOS 4.0  ;AN006;
  3824                                  
  3825                                  	; -------------------------------
  3826                                  
  3827                                  	; 01/01/2024 - Retro DOS v5.0 (PCDOS 7.1)
  3828 00000239 [B04A]                  	short_addr  int_2Fh_1230h	;   48
  3829                                  				; FIND SFT ENTRY IN INTERNAL FILE TABLES
  3830 0000023B [6809]                  	short_addr  int_2Fh_1231h	;   49
  3831                                  				; SET/CLEAR REPORT WINDOWS TO DOS PROGRAMS FLAG	
  3832                                  
  3833                                  DOSTableEnd:  ; LABEL BYTE
  3834                                  
  3835                                  	;ENDIF
  3836                                  
  3837                                  ; ----------------------------------------------------------------------------
  3838                                  ; BREAK   <Copyright notice and version>
  3839                                  ; ----------------------------------------------------------------------------
  3840                                  
  3841                                  ;CODSTRT EQU	$
  3842                                  
  3843                                  ; 08/07/2018 - Retro DOS v3.0 by Erdogan Tan
  3844                                  ; (MSTABLE.ASM, MSDOS 6.0, 1991)
  3845                                  
  3846                                  ; NOTE WARNING: This declaration of HEADER must be THE LAST thing in this
  3847                                  ;       module. The reason is so that the data alignments are the same in
  3848                                  ;       IBM-DOS and MS-DOS up through header.
  3849                                  
  3850                                  	;PUBLIC	HEADER
  3851                                  
  3852                                  HEADER:	; LABEL	BYTE
  3853                                          ;IF	DEBUG
  3854                                          ;DB	13,10,"Debugging DOS version "
  3855                                          ;DB	MAJOR_VERSION + "0"
  3856                                          ;DB	"."
  3857                                          ;DB	(MINOR_VERSION / 10) + "0"
  3858                                          ;DB	(MINOR_VERSION MOD 10) + "0"
  3859                                          ;ENDIF
  3860                                  
  3861                                  ; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3862                                  ; (MSDOS 5.0 MSDOS.SYS compatibility)
  3863                                  %if 0
  3864                                          ;IF	NOT IBM
  3865                                          DB	13,10,"MS-DOS version "
  3866                                          DB	MAJOR_VERSION + "0"
  3867                                          DB	"."
  3868                                          DB	(MINOR_VERSION / 10) + "0"
  3869                                          ;DB	(MINOR_VERSION MOD 10) + "0"
  3870                                          DB	(MINOR_VERSION % 10) + "0"
  3871                                  
  3872                                          ;IF	HIGHMEM
  3873                                          ;DB	"H"
  3874                                          ;ENDIF
  3875                                  
  3876                                  	;DB	13,10,"Copyright 1981,82,83,84,88 Microsoft Corp.",13,10,"$"
  3877                                  	; 30/04/2019 - Retro DOS v4.0
  3878                                  	DB	13,10,"Copyright 1981-1993 Microsoft Corp.",13,10,"$"	
  3879                                  
  3880                                  	;ENDIF
  3881                                  
  3882                                  %endif
  3883                                  
  3884                                  ;IF DEBUG
  3885                                  ;	DB	13,10,"$"
  3886                                  ;ENDIF
  3887                                  
  3888                                  ;include copyrigh.inc
  3889                                  
  3890                                  ; DOSCODE:3FDDh (MSDOS 6.21, MSDOS.SYS)
  3891                                  
  3892                                  	;DB	"MS DOS Version 6 (C)Copyright 1981-1993 Microsoft Corp "
  3893                                  	;DB	"Licensed Material - Property of Microsoft "
  3894                                  	;DB	"All rights reserved "
  3895                                  
  3896                                  ; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3897                                  ; DOSCODE:3FCDh (MSDOS 5.0, MSDOS.SYS)
  3898                                  
  3899                                  ; 28/12/2022 - Retro DOS v4.1
  3900                                  %if 0
  3901                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  3902                                  ms_copyright:
  3903                                  	db	'MS DOS Version 5.00 (C)Copyright 1981-1991 Microsoft Corp '
  3904                                  	db	'Licensed Material - Property of Microsoft '
  3905                                  	db	'All rights reserved '
  3906                                  
  3907                                  %endif
  3908                                  	;; 28/12/2022 - Retro DOS v4.1
  3909                                  ;ms_copyright:	
  3910                                    	;db	13,10,"MS DOS Version 5.0"
  3911                                  	;db	13,10,"Copyright 1981-1991 Microsoft Corp.",13,10,"$",0	
  3912                                  
  3913                                  ;	; 21/09/2023 - Retro DOS v4.2 MSDOS.SYS
  3914                                  ;	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:3FDDh (File offset: 509))
  3915                                  ;ms_copyright:
  3916                                  ;	db 'MS DOS Version 6 (C)Copyright 1981-1994 Microsoft Corp '
  3917                                  ;	db 'Licensed Material - Property of Microsoft All rights reserved '
  3918                                  
  3919                                  	; 01/01/2024 - Retro DOS v5.0
  3920                                  	
  3921                                  	; 20/09/2023 - Retro DOS v4.2
  3922                                  ;ms_copyright:	
  3923                                  	;db	13,10,"MS DOS Version 6.22"
  3924                                  	;db	13,10,"Copyright 1981-1994 Microsoft Corp.",13,10,"$",0	
  3925                                  
  3926                                  ;============================================================================
  3927                                  ; MSCODE.ASM
  3928                                  ;============================================================================
  3929                                  
  3930                                  ; Retro DOS v2.0 (NASM 2.11) source code modifications by Erdogan Tan
  3931                                  ; 03/03/2018
  3932                                  
  3933                                  ;
  3934                                  ; MSCODE.ASM -- MSDOS code
  3935                                  ;
  3936                                  
  3937                                  ;INCLUDE DOSSEG.ASM
  3938                                  ;INCLUDE STDSW.ASM
  3939                                  
  3940                                  ;CODE    SEGMENT BYTE PUBLIC  'CODE'
  3941                                  ;ASSUME  CS:DOSGROUP,DS:NOTHING,ES:NOTHING,SS:NOTHING
  3942                                  
  3943                                  ;.xcref
  3944                                  ;INCLUDE DOSSYM.ASM
  3945                                  ;INCLUDE DEVSYM.ASM
  3946                                  ;.cref
  3947                                  ;.list
  3948                                  
  3949                                  ;IFNDEF  KANJI
  3950                                  ;KANJI   EQU     0       ; FALSE
  3951                                  ;ENDIF
  3952                                  
  3953                                  ;IFNDEF  IBM
  3954                                  ;IBM     EQU     0
  3955                                  ;ENDIF
  3956                                  
  3957                                  ;IFNDEF  HIGHMEM
  3958                                  ;HIGHMEM  EQU     0
  3959                                  ;ENDIF
  3960                                  
  3961                                          ;i_need  USER_SP,WORD
  3962                                          ;i_need  USER_SS,WORD
  3963                                          ;i_need  SAVEDS,WORD
  3964                                          ;i_need  SAVEBX,WORD
  3965                                          ;i_need  INDOS,BYTE
  3966                                          ;i_need  NSP,WORD
  3967                                          ;i_need  NSS,WORD
  3968                                          ;i_need  CURRENTPDB,WORD
  3969                                          ;i_need  AUXSTACK,BYTE
  3970                                          ;i_need  CONSWAP,BYTE
  3971                                          ;i_need  IDLEINT,BYTE
  3972                                          ;i_need  NOSETDIR,BYTE
  3973                                          ;i_need  ERRORMODE,BYTE
  3974                                          ;i_need  IOSTACK,BYTE
  3975                                          ;i_need  WPERR,BYTE
  3976                                          ;i_need  DSKSTACK,BYTE
  3977                                          ;i_need  CNTCFLAG,BYTE
  3978                                          ;i_need  LEAVEADDR,WORD
  3979                                          ;i_need  NULLDEVPT,DWORD
  3980                                  
  3981                                          ;IF NOT IBM
  3982                                          ;i_need  OEM_HANDLER,DWORD
  3983                                          ;ENDIF
  3984                                  
  3985                                          ;EXTRN   DSKSTATCHK:NEAR,GETBP:NEAR,DSKREAD:NEAR,DSKWRITE:NEAR
  3986                                  
  3987                                  ;============================================================================
  3988                                  ; MSDISP.ASM, MSDOS 6.0, 1991
  3989                                  ;============================================================================
  3990                                  ; 11/07/2018 - Retro DOS v3.0
  3991                                  ; 01/05/2019 - Retro DOS v4.0
  3992                                  
  3993                                  ; DosCode SEGMENT
  3994                                  
  3995                                  ; ==========================================================================
  3996                                  ;
  3997                                  ; $Set_CTRL_C_Trapping
  3998                                  ;
  3999                                  ; Function:
  4000                                  ;	Enable disable ^C checking in dispatcher
  4001                                  ;
  4002                                  ; Inputs:
  4003                                  ;		AL = 0 read ^C status
  4004                                  ;		AL = 1 Set ^C status, DL = 0/1 for ^C off/on
  4005                                  ;		AL = 2 Set ^C status to contents of DL.	Output is old state.
  4006                                  ;		AL = 5 get DOS boot drive
  4007                                  ;		AL = 6 Get version number
  4008                                  ;			RETURNS:
  4009                                  ;				BH = Minor version number
  4010                                  ;				BL = Major version number
  4011                                  ;				DL = DOS internal revision
  4012                                  ;				DH = DOS type flags
  4013                                  ;					Bit 3 	- DOS in ROM
  4014                                  ;					Bit 4 	- DOS in HMA
  4015                                  ;					Bit 0-2, 5-7 - Reserved
  4016                                  ; Outputs:
  4017                                  ;		If AL = 0 then DL = 0/1 for ^C off/on
  4018                                  ;
  4019                                  ; History:
  4020                                  ;      removed	AL = 3 Get CPSW state to DL	    DOS 3.4
  4021                                  ;      removed	AL = 4 Set CPSW state from DL	    DOS 3.4
  4022                                  ; ==========================================================================
  4023                                  
  4024                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  4025                                  ; DOSCODE:4045h (MSDOS 5.0, MSDOS.SYS)
  4026                                  
  4027                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  4028                                  ; DOSCODE:4123h (PCDOS 7.1, IBMDOS.COM)
  4029                                  
  4030                                  _$SET_CTRL_C_TRAPPING:
  4031                                  	; 01/05/2019 - Retro DOS v4.0
  4032                                  
  4033 0000023D 3C07                    	cmp	al,7	; 01/01/2024 - Retro DOS v5.0
  4034                                  	;cmp	AL,6			; Is this a valid subfunction?
  4035 0000023F 7603                    	jbe	short scct_1		; If yes continue processing
  4036                                  
  4037 00000241 B0FF                    	mov	AL,0FFh			; Else set AL to -1 and
  4038 00000243 CF                      	iret
  4039                                  scct_1:
  4040 00000244 1E                      	push	DS
  4041                                  
  4042                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4043 00000245 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4044                                  	
  4045 0000024A 50                      	push	AX			; DL only register that can change
  4046 0000024B 56                      	push	SI
  4047                                  
  4048 0000024C BE[3703]                	mov	SI,CNTCFLAG		; DS:SI --> Ctrl C Status byte
  4049 0000024F 30E4                    	xor	AH,AH			; Clear high byte of AX
  4050 00000251 09C0                    	or	AX,AX			; Check for subfunction 0
  4051 00000253 7504                    	jnz	short scct_2		; If not 0 jmp to next check
  4052                                  
  4053 00000255 8A14                    	mov	DL,[SI]			; Else move current ctrl C status
  4054 00000257 EB32                    	jmp	SHORT scct_9s		; into DL and jmp to exit
  4055                                  scct_2:
  4056 00000259 48                      	dec	AX			; Now dec AX and see if it was 1
  4057 0000025A 7507                    	jnz	short scct_3		; If not 0 it wasn't 1 so do next chk
  4058                                  
  4059 0000025C 80E201                  	and	DL,1			; Else mask off bit 0 of DL and
  4060 0000025F 8814                    	mov	[SI],DL			; save it as new Ctrl C status
  4061 00000261 EB28                    	jmp	SHORT scct_9s		; Jmp to exit
  4062                                  scct_3:
  4063 00000263 48                      	dec	AX			; Dec AX again to see if it was 2
  4064 00000264 7507                    	jnz	short scct_4		; If not 0 wasn't 2 so go to next chk
  4065                                  
  4066 00000266 80E201                  	and	DL,1			; Else mask off bit 0 of DL and
  4067 00000269 8614                    	xchg	[SI],DL			; Exchange DL with old status byte
  4068 0000026B EB1E                    	jmp	SHORT scct_9s		; Jump to exit (returning old status)
  4069                                  scct_4:
  4070 0000026D 3C03                    	cmp	al,3 ; 01/01/2024
  4071                                  	;cmp	AX,3 			; Test for 5 after it was dec twice
  4072 0000026F 7506                    	jne	short scct_5		; If not equal then not get boot drv
  4073 00000271 8A16[6900]              	mov	DL,[BOOTDRIVE]		; Else return boot drive in DL
  4074 00000275 EB14                    	jmp	SHORT scct_9s		; Jump to exit (returning boot drive)
  4075                                  scct_5:
  4076                                  	; 01/01/2024 - Retro DOS v5.0
  4077 00000277 7212                    	jb	short scct_9s ; PCDOS 7.1
  4078                                  	;
  4079 00000279 3C04                    	cmp	al,4 ; 01/01/2024
  4080                                  	;cmp	AX,4 			; Test for 6 after it was dec twice
  4081                                  	;jne	short scct_9s		; If not equal then not get version
  4082 0000027B 7512                    	jne	short scct_6 ; 01/01/2024 ; PCDOS 7.1	
  4083                                  
  4084                                  	;mov	BX,(Minor_Version SHL 8) + Major_Version
  4085                                  
  4086                                  	;;mov	bx,1406h ; 6.20	; DOSCODE:4092h (MSDOS 6.21, MSDOS.SYS)
  4087                                  	;;mov	bx,1606h ; 6.22	; DOSCODE:4092h (MSDOS 6.22, MSDOS.SYS)
  4088                                  
  4089                                  	;mov	bx,0A07h ; 7.10	; DOSCODE:4163h (PCDOS 7.1, IMBDOS.COM)
  4090 0000027D BB070A                  	mov	bx,(MINOR_VERSION<<8)+MAJOR_VERSION  ; true dos version
  4091                                  	
  4092                                  	;mov	dl,0			; revision 0
  4093                                  	;mov	DL,DOSREVNM ; 0
  4094                                  
  4095                                  	;xor	dh,dh			; assume vanilla DOS
  4096                                  	; 01/01/2024
  4097 00000280 BA0000                  	mov	dx,0	
  4098 00000283 3836[660D]              	cmp	byte [DosHasHMA],dh ; 0
  4099                                  	;cmp	byte [DosHasHMA],0	; is DOS in HMA?  (M021)
  4100                                  	;;je	short @F
  4101                                  	;je	short scct_6
  4102 00000287 7402                    	je	short scct_9s ; 01/01/2024	
  4103                                  	; 01/01/2024
  4104 00000289 B610                    	mov	dh,10h			; version flags bit 4
  4105                                  	;or	DH,DOSINHMA ; 10h	; 'DOS in HMA' status
  4106                                  ;@@:
  4107                                  ;scct_6:
  4108                                  ;ifdef ROMDOS
  4109                                  ;	or	DH,DOSINROM ; 08h
  4110                                  ;endif ; ROMDOS
  4111                                  
  4112                                  	; 01/01/2024 (PCDOS 7.1)
  4113                                  	;jmp	short short scct_9s
  4114                                  
  4115                                  	; 01/01/2024
  4116                                  ;scct_6:
  4117                                  	; ....
  4118                                  
  4119                                  scct_9s:
  4120 0000028B 5E                      	pop	SI
  4121 0000028C 58                      	pop	AX
  4122 0000028D 1F                      	pop	DS
  4123                                  scct_9f:
  4124 0000028E CF                      	iret
  4125                                  
  4126                                  	; 01/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  4127                                  scct_6:
  4128 0000028F 8026[8600]DF            	and	byte [DOS_FLAG],0DFh	; clear bit 5 of DOS flag
  4129 00000294 80FA01                  	cmp	dl, 1
  4130 00000297 75F2                    	jne	short scct_9s
  4131 00000299 800E[8600]20            	or	byte [DOS_FLAG],20h	; set bit 5 of DOS flag
  4132 0000029E EBEB                    	jmp	short scct_9s
  4133                                  
  4134                                  SetCtrlShortEntry:			; This allows a conditional entry
  4135                                  					; from main dispatch code
  4136 000002A0 EB9B                    	jmp	SHORT _$SET_CTRL_C_TRAPPING
  4137                                  
  4138                                  ; ==========================================================================
  4139                                  ;
  4140                                  ; The following two routines are dispatched to directly with ints disabled
  4141                                  ; immediately after the int 21h entry.	no DIS state is set.
  4142                                  ;
  4143                                  ; $Set_current_PDB takes BX and sets it to be the current process
  4144                                  ;   *** THIS FUNCTION CALL IS SUBJECT TO CHANGE!!! ***
  4145                                  ;
  4146                                  ; ==========================================================================
  4147                                  
  4148                                  _$SET_CURRENT_PDB:
  4149 000002A2 1E                      	push	DS
  4150                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4151 000002A3 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4152 000002A8 891E[3003]              	mov	[CurrentPDB],BX		; Set new PSP segment from caller's BX
  4153 000002AC 1F                      	pop	DS
  4154 000002AD CF                      	iret
  4155                                  
  4156                                  ; ==========================================================================
  4157                                  ;
  4158                                  ; $get_current_PDB returns in BX the current process
  4159                                  ;   *** THIS FUNCTION CALL IS SUBJECT TO CHANGE!!! ***
  4160                                  ;
  4161                                  ; ==========================================================================
  4162                                  
  4163                                  _$GET_CURRENT_PDB:
  4164 000002AE 1E                      	push	DS
  4165                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4166 000002AF 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4167 000002B4 8B1E[3003]              	mov	BX,[CurrentPDB]		; Return current PSP segment in BX
  4168 000002B8 1F                      	pop	DS
  4169 000002B9 CF                      	iret
  4170                                  
  4171                                  ; ==========================================================================
  4172                                  ;
  4173                                  ; Sets the Printer Flag to whatever is in AL.
  4174                                  ; NOTE: THIS PROCEDURE IS SUBJECT TO CHANGE!!!
  4175                                  ;
  4176                                  ; ==========================================================================
  4177                                  
  4178                                  _$SET_PRINTER_FLAG:
  4179 000002BA 1E                      	push	ds
  4180                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4181 000002BB 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4182 000002C0 A2[A00A]                	mov	[PRINTER_FLAG],AL 	; Set printer flag from caller's AL
  4183 000002C3 1F                      	pop	ds
  4184 000002C4 CF                      	iret
  4185                                  
  4186                                  ; 01/05/2019 - Retro DOS v4.0
  4187                                  ; 08/07/2018 - Retro DOS v3.0
  4188                                  ; (MSDISP.ASM, MSDOS 6.0, 1991)
  4189                                  
  4190                                  ; ----------------------------------------------------------------------------
  4191                                  ; BREAK   <System call entry points and dispatcher>
  4192                                  ; ----------------------------------------------------------------------------
  4193                                  
  4194                                  ; DOSCODE:40CCh (MSDOS 6.21, MSDOS.SYS)
  4195                                  
  4196                                  ; ==========================================================================
  4197                                  ;
  4198                                  ; The Quit entry point is where all INT 20h's come from. These are old- style
  4199                                  ; exit system calls. The CS of the caller indicates which Process is dying.
  4200                                  ; The error code is presumed to be 0. We simulate an ABORT system call.
  4201                                  ;
  4202                                  ; ==========================================================================
  4203                                  
  4204                                  SYSTEM_CALL:    ; PROC NEAR
  4205                                  
  4206                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  4207                                  ; DOSCODE:40BFh (MSDOS 5.0, MSDOS.SYS)
  4208                                  
  4209                                  ;entry	QUIT				
  4210                                  QUIT:				; INT 20H entry point	
  4211                                  	;MOV	AH,0
  4212 000002C5 30E4                    	xor	ah,ah ; 08/07/2018
  4213 000002C7 EB36                    	JMP     SHORT SAVREGS
  4214                                  
  4215                                  ; ---------------------------------------------------------------------------
  4216                                  
  4217                                  	; The system call in AH is out of the range that we know how
  4218                                  	; to handle. We arbitrarily set the contents of AL to 0 and
  4219                                  	; IRET. Note that we CANNOT set the carry flag to indicate an
  4220                                  	; error as this may break some programs compatability.
  4221                                  
  4222                                  BADCALL:
  4223                                          ;MOV	AL,0
  4224 000002C9 30C0                    	xor	al,al ; 08/07/2018
  4225                                  IRETT:	; 06/05/2019
  4226                                  _IRET:
  4227 000002CB CF                              IRET
  4228                                  
  4229                                  ; ---------------------------------------------------------------------------
  4230                                  
  4231                                  ; 01/05/2019 - Retro DOS v4.0
  4232                                  ; DOSCODE:40D3h (MSDOS 6.21 MSDOS.SYS)
  4233                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  4234                                  ; DOSCODE:40C6h (MSDOS 5.0 MSDOS.SYS)
  4235                                  
  4236                                  	; An alternative method of entering the system is to perform a
  4237                                  	; CALL 5 in the program segment prefix with the contents of CL
  4238                                  	; indicating what system call the user would like. A subset of
  4239                                  	; the possible system calls is allowed here only the
  4240                                  	; CPM-compatible calls may get dispatched.
  4241                                  
  4242                                  		; System call entry point and dispatcher
  4243                                  CALL_ENTRY:
  4244 000002CC 1E                      	push	DS
  4245                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4246 000002CD 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4247 000002D2 8F06[EC05]              	pop	word [SAVEDS]		; Save original DS
  4248                                  
  4249 000002D6 58                              POP     AX                      ; IP from the long call at 5
  4250 000002D7 58                              POP     AX                      ; Segment from the long call at 5
  4251 000002D8 8F06[8405]              	POP	WORD [USER_SP]		; IP from the CALL 5
  4252                                  
  4253                                  		; Re-order the stack to simulate an interrupt 21.
  4254                                  
  4255 000002DC 9C                      	PUSHF				; Start re-ordering the stack
  4256 000002DD FA                      	CLI
  4257 000002DE 50                              PUSH    AX                      ; Save segment
  4258 000002DF FF36[8405]                      PUSH	WORD [USER_SP]		; Stack now ordered as if INT had been used
  4259                                  	; 04/11/2022
  4260                                  	; DOSCODE:40EAh (MSDOS 6.21 MSDOS.SYS)
  4261                                  	; DOSCODE:40DDh (MSDOS 5.0 MSDOS.SYS)
  4262 000002E3 FF36[EC05]              	push	word [SAVEDS]
  4263 000002E7 1F                      	pop	ds
  4264                                  	;
  4265                                  	;cmp	cl,36
  4266 000002E8 80F924                          CMP     CL,MAXCALL              ; This entry point doesn't get as many calls
  4267 000002EB 77DC                            JA      SHORT BADCALL
  4268 000002ED 88CC                            MOV     AH,CL
  4269                                  	; 08/07/2018
  4270 000002EF EB0E                    	jmp	short SAVREGS
  4271                                  
  4272                                  ; ---------------------------------------------------------------------------
  4273                                  
  4274                                  ; 01/05/2019 - Retro DOS v4.0
  4275                                  ; 01/01/2024 - Retro DOS v5.0
  4276                                  
  4277                                  	; This is the normal INT 21 entry point. We first perform a
  4278                                  	; quick test to see if we need to perform expensive DOS-entry
  4279                                  	; functions. Certain system calls are done without interrupts
  4280                                  	; being enabled.
  4281                                  
  4282                                  	;entry	COMMAND 		; Interrupt call entry point (int 21h)
  4283                                  
  4284                                  ; DOSCODE:40F8h (MSDOS 6.21, MSDOS.SYS)
  4285                                  ; 04/11/2022
  4286                                  ; DOSCODE:40EBh (MSDOS 5.0, MSDOS.SYS)
  4287                                  ; 01/01/2024
  4288                                  ; DOSCODE:41D7h (PCDOS 7.1, IBMDOS.COM)
  4289                                  
  4290                                  COMMAND:
  4291                                  	; 22/12/2022
  4292 000002F1 FA                      	cli
  4293                                  
  4294                                  	; 01/05/2019 - Retro DOS v4.0
  4295                                  	; 08/07/2018 - Retro DOS v3.0
  4296                                  
  4297                                  ; 22/12/2022
  4298                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  4299                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  4300                                  
  4301                                  	;IF	NOT IBM
  4302 000002F2 80FCF8                  	CMP	AH,SET_OEM_HANDLER
  4303 000002F5 7203                    	JB	SHORT NOTOEM
  4304 000002F7 E98701                  	JMP	_$SET_OEM_HANDLER
  4305                                  
  4306                                  NOTOEM:
  4307                                  	;ENDIF
  4308                                  
  4309                                  ; DOSCODE:40F8h (MSDOS 6.21, MSDOS.SYS)
  4310                                  ; DOSCODE:40EBh (MSDOS 5.0, MSDOS.SYS)
  4311                                  ; 01/01/2024 - Retro DOS v5.0
  4312                                  ; DOSCODE:41D7h (PCDOS 7.1, IBMDOS.COM)
  4313                                  
  4314                                  	; 22/12/2022
  4315                                  	;cli	; 08/07/2018
  4316                                  	
  4317                                  	; 01/01/2024
  4318                                  _COMMAND: ; MSDOS 3.3 (IBMDOS)
  4319                                  	;;cmp	ah,6Ch  ; MSDOS 6.21
  4320                                  	;cmp	ah,73h	; PCDOS 7.1 ; Max int 21h function call number 
  4321                                  	; 04/11/2022
  4322 000002FA 80FC73                  	CMP     AH,MAXCOM ; 6Ch for MSDOS 6.0 (6.21,6.22) & MSDOS 5.0
  4323                                  			; 73h for PCDOS 7.1	
  4324                                  	;JBE	SHORT SAVREGS
  4325 000002FD 77CA                            JA	SHORT BADCALL ; 08/07/2018
  4326                                  
  4327                                  	; 31/05/2019
  4328                                  
  4329                                  	; The following set of calls are issued by the server at
  4330                                  	; *arbitrary* times and, therefore, must be executed on
  4331                                  	; the user's entry stack and executed with interrupts off.
  4332                                  
  4333                                  SAVREGS:
  4334                                  	; 01/05/2019 - Retro DOS v4.0
  4335                                  	; 10/08/2018
  4336                                  	; 08/07/2018 - Retro DOS v3.0
  4337 000002FF 80FC33                  	cmp	ah,33h			; Check Minimum special case #
  4338                                  	;;je	_$SET_CTRL_C_TRAPPING
  4339                                  	;je	short SetCtrlShortEntry ; If equal jmp directly to function
  4340 00000302 7218                    	jb	short SaveAllRegs	; Not special case so continue	
  4341                                  	; 04/11/2022
  4342 00000304 749A                    	je	short SetCtrlShortEntry ; If equal jmp directly to function
  4343 00000306 80FC64                  	cmp	ah,64h			; Check Max case number
  4344 00000309 7711                    	ja	short SaveAllRegs	; Not special case so continue
  4345 0000030B 74AD                    	je	short _$SET_PRINTER_FLAG ; If equal jmp directly to function
  4346 0000030D 80FC51                  	cmp	ah,51h			; Is this a Get PSP call (51h)?
  4347 00000310 749C                    	je	short _$GET_CURRENT_PDB	; Yes, jmp directly to function
  4348 00000312 80FC62                  	cmp	ah,62h			; Is this a Get PSP call (62h)?
  4349 00000315 7497                    	je	short _$GET_CURRENT_PDB	; Yes, jmp directly to function
  4350 00000317 80FC50                  	cmp     ah,50h			; Is this a Set PSP call (50h) ?
  4351 0000031A 7486                    	je	short _$SET_CURRENT_PDB	; Yes, jmp directly to function
  4352                                  
  4353                                  SaveAllRegs:
  4354                                  	; 01/05/2019 - Retro DOS v4.0
  4355                                  	; 01/01/2024 - Retro DOS v5.0
  4356                                  
  4357 0000031C 06                              push	ES
  4358 0000031D 1E                      	push	DS
  4359 0000031E 55                      	push	BP
  4360 0000031F 57                      	push	DI
  4361 00000320 56                      	push	SI
  4362 00000321 52                      	push	DX
  4363 00000322 51                      	push	CX
  4364 00000323 53                      	push	BX
  4365 00000324 50                      	push	AX
  4366                                  
  4367 00000325 8CD8                    	mov	AX,DS
  4368                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4369 00000327 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4370 0000032C A3[EC05]                	mov	[SAVEDS],AX		; save caller's DS
  4371 0000032F 891E[EA05]              	mov	[SAVEBX],BX
  4372                                  
  4373                                          ;INC     BYTE [INDOS]		; Flag that we're in the DOS
  4374                                  	
  4375                                  	; 08/07/2018 - Retro DOS v3.0
  4376                                  	;xor     ax,ax
  4377                                  	;mov     [USER_ID],ax
  4378                                  	;mov     ax,[CurrentPDB]
  4379                                  	;mov     [PROC_ID],ax
  4380                                  
  4381                                  	; 01/05/2019
  4382                                  
  4383                                  	; Note: Nsp and Nss have to be unconditionally initialized here 
  4384                                  	; even if InDOS is zero. Programs like CROSSTALK 3.7 depend on
  4385                                  	; this!!!
  4386                                  
  4387 00000333 A1[8405]                	MOV     AX,[USER_SP]
  4388 00000336 A3[F205]                        MOV     [NSP],AX
  4389 00000339 A1[8605]                        MOV     AX,[USER_SS]
  4390 0000033C A3[F005]                        MOV     [NSS],AX
  4391                                  
  4392 0000033F 31C0                    	xor	AX,AX ; 0
  4393 00000341 A2[7205]                	mov	[FSHARING],AL		; allow redirection
  4394                                  
  4395 00000344 F606[5B0F]01            	test	byte [IsWin386],1	; WIN386 patch. Do not update USER_ID
  4396 00000349 7503                    	jnz	short set_indos_flag	; if win386 present
  4397 0000034B A3[3E03]                	mov	[USER_ID],AX
  4398                                  set_indos_flag:
  4399 0000034E FE06[2103]              	INC     BYTE [INDOS]		; Flag that we're in the DOS
  4400                                  
  4401                                  	; 01/01/2024 (PCDOS 7.1 IBMDOS.COM)
  4402 00000352 FE06[B812]              	inc	byte [INDOS_FLAG]	; duplicated INDOS flag (what for ?)
  4403                                  
  4404 00000356 8926[8405]                      MOV     [USER_SP],SP
  4405 0000035A 8C16[8605]                      MOV     [USER_SS],SS
  4406                                  
  4407 0000035E A1[3003]                	mov	AX,[CurrentPDB]
  4408 00000361 A3[3C03]                	mov	[PROC_ID],AX
  4409 00000364 8ED8                    	mov	DS,AX
  4410 00000366 58                      	pop	AX
  4411 00000367 50                      	push	AX
  4412                                  
  4413                                  	; save user stack in his area for later returns (possibly from EXEC)
  4414                                  
  4415 00000368 89262E00                        MOV     [PDB.USER_STACK],SP	; mov [2Eh], sp
  4416 0000036C 8C163000                        MOV     [PDB.USER_STACK+2],SS	; mov [30h], ss
  4417                                  
  4418                                  	; 18/07/2018
  4419                                  	;mov	byte [CS:FSHARING], 0
  4420                                  
  4421                                  	;MOV     BX,CS			; no holes here.
  4422                                  	;MOV     SS,BX
  4423                                  
  4424                                  	;getdseg <ss>			; ss -> dosdat, already flag is CLI
  4425 00000370 2E8E16[0700]            	mov	ss,[cs:DosDSeg]
  4426                                  					;entry	REDISP
  4427                                  REDISP:
  4428 00000375 BC[A007]                        MOV     SP,AUXSTACK		; Enough stack for interrupts
  4429 00000378 FB                              STI                             ; stack is in our space now...
  4430                                  
  4431 00000379 8CD3                    	mov	bx,ss
  4432 0000037B 8EDB                    	mov	ds,bx
  4433                                  
  4434 0000037D 93                      	xchg	ax,bx
  4435                                  
  4436 0000037E 31C0                    	xor	ax,ax ; 0
  4437                                  
  4438                                  	; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  4439                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:416Eh  (from org 3DD0h)
  4440                                  	; MSDOS 6.21 MSDOS.SYS - DOSCODE:417Bh (from org 3DE0h)
  4441                                  
  4442                                  	; (Note: ss: segment prefix was not needed here! ds=ss ! -04/11/2022-)
  4443                                  
  4444                                  	;mov	[ss:EXTOPEN_ON],al ; 0	; Clear extended open flag
  4445                                  	;;and	word [ss:DOS34_FLAG],EXEC_AWARE_REDIR
  4446                                  	;and	word [ss:DOS34_FLAG],800h ; clear all bits except bit 11
  4447                                  	;mov	[ss:CONSWAP],al  ; 0	; random clean up of possibly mis-set flags
  4448                                  	;mov	[ss:NoSetDir],al ; 0	; set directories on search
  4449                                  	;mov	[ss:FAILERR],al ; 0	; FAIL not in progress
  4450                                  	;inc	ax
  4451                                  	;;inc	AL			; AL = 1
  4452                                  	;mov	[ss:IDLEINT],al		; presume that we can issue INT 28h
  4453                                  
  4454                                  	; 15/12/2022
  4455 00000380 A2[F605]                	mov	[EXTOPEN_ON],al ; 0	; Clear extended open flag
  4456                                  	;and	word [DOS34_FLAG],EXEC_AWARE_REDIR
  4457 00000383 8126[1106]0008          	and	word [DOS34_FLAG],800h	; clear all bits except bit 11
  4458 00000389 A2[5703]                	mov	[CONSWAP],al  ; 0	; random clean up of possibly mis-set flags
  4459                                  	;mov	byte [IDLEINT],1
  4460 0000038C A2[4C03]                	mov	[NoSetDir],al ; 0	; set directories on search
  4461 0000038F A2[4A03]                	mov	[FAILERR],al ; 0	; FAIL not in progress
  4462 00000392 40                      	inc	ax
  4463                                  	;inc	al			; AL = 1
  4464 00000393 A2[5803]                	mov	[IDLEINT],al		; presume that we can issue INT 28h
  4465                                  
  4466 00000396 93                      	XCHG	AX,BX			; Restore AX and BX = 1
  4467                                  
  4468 00000397 88E3                    	MOV     BL,AH			
  4469 00000399 D1E3                            SHL     BX,1			; 2 bytes per call in table
  4470                                         
  4471 0000039B FC                      	CLD
  4472                                  		; Since the DOS maintains mucho state information across system
  4473                                  		; calls, we must be very careful about which stack we use.
  4474                                  		; First, all abort operations must be on the disk stack. This
  4475                                  		; is due to the fact that we may be hitting the disk (close
  4476                                  		; operations, flushing) and may need to report an INT 24.
  4477                                          
  4478 0000039C 08E4                    	OR      AH,AH
  4479 0000039E 7416                            JZ      SHORT DSKROUT		; ABORT
  4480                                  
  4481                                          ;CMP	AH,12
  4482                                          ;JBE	SHORT IOROUT		; Character I/O
  4483                                          ;CMP	AH,GET_CURRENT_PDB      ; INT 24h needs GET,SET PDB
  4484                                          ;JZ	SHORT IOROUT
  4485                                          ;CMP	AH,SET_CURRENT_PDB
  4486                                          ;JNZ	SHORT DSKROUT
  4487                                  
  4488                                  		; Second, PRINT and PSPRINT and the server issue
  4489                                  		; GetExtendedError calls at INT 28 and INT 24 time.
  4490                                  		; This call MUST, therefore, use the AUXSTACK.
  4491                                  
  4492                                  	; 10/08/2018
  4493 000003A0 80FC59                  	cmp     ah,GETEXTENDEDERROR ; 59h
  4494 000003A3 7439                    	je      short DISPCALL
  4495                                  	
  4496                                  	; 01/05/2019
  4497                                  	
  4498                                  		; Old 1-12 system calls may be either on the IOSTACK (normal
  4499                                  		; operation) or on the AUXSTACK (at INT 24 time).
  4500                                  
  4501 000003A5 80FC0C                  	cmp     ah,12 ; STD_CON_INPUT_FLUSH ; 0Ch
  4502 000003A8 770C                    	ja      short DSKROUT
  4503                                  
  4504                                  IOROUT:
  4505                                  	; 04/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  4506                                  	; (ss: prefix was not needed here! ds=ss)
  4507                                  	;cmp	byte [ss:ERRORMODE],0	; Are we in an INT 24h? 
  4508                                  	; 15/12/2022
  4509 000003AA 803E[2003]00            	cmp     BYTE [ERRORMODE],0	; Are we in an INT 24h?
  4510 000003AF 752D                            JNZ     SHORT DISPCALL		; Stay on AUXSTACK if INT 24h
  4511 000003B1 BC[A00A]                        MOV     SP,IOSTACK
  4512 000003B4 EB28                            JMP     SHORT DISPCALL
  4513                                  
  4514                                  		; We are on a system call that is classified as "the rest".
  4515                                  		; We place ourselves onto the DSKSTACK and away we go.
  4516                                  		; We know at this point:
  4517                                  		; *  An INT 24 cannot be in progress. Therefore we reset
  4518                                  		;    ErrorMode and WpErr
  4519                                  		; *  That there can be no critical sections in effect.
  4520                                  		;    We signal the server to remove all the resources.
  4521                                  
  4522                                  DSKROUT:
  4523                                  	; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  4524                                  	; 15/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  4525                                  	; 08/07/2018 - Retro DOS v3.0
  4526 000003B6 A3[3A03]                	mov     [USER_IN_AX],ax		; Remember what user is doing
  4527                                  	; 01/01/2024
  4528                                  	;mov	byte [EXTERR_LOCUS],1	; errLOC_Unk (Default)
  4529                                  	;MOV	BYTE [WPERR],-1		; error mode, so good place to
  4530                                  	                   		; make sure flags are reset
  4531 000003B9 C706[2203]FF01          	mov	word [WPERR],1FFh
  4532                                  
  4533 000003BF C606[2003]00            	MOV     BYTE [ERRORMODE],0	; Cannot make non 1-12 calls in
  4534                                  
  4535                                  
  4536                                  	; 04/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  4537                                  	; (ss: prefix was not needed here! ds=ss)
  4538                                  
  4539                                  	;mov	[ss:USER_IN_AX],ax	; Remember what user is doing
  4540                                  	;mov	byte [ss:EXTERR_LOCUS],1 ; errLOC_Unk (Default)
  4541                                  	;mov	byte [ss:ERRORMODE],0	; Cannot make non 1-12 calls in
  4542                                  	;mov	byte [ss:WPERR],-1	; error mode, so good place to
  4543                                                                          ; make sure flags are reset
  4544 000003C4 50                      	push    ax
  4545 000003C5 B482                    	mov     ah,82h			; Release all resource information
  4546 000003C7 CD2A                    	int     2Ah 		; Microsoft Networks 
  4547                                  				; END DOS CRITICAL SECTIONS 0 THROUGH 7
  4548 000003C9 58                      	pop     ax
  4549                                  
  4550                                  		; Since we are going to be running on the DSKStack and since
  4551                                  		; INT 28 people will use the DSKStack, we must turn OFF the
  4552                                  		; generation of INT 28's.
  4553                                  
  4554                                  	; 15/12/2022
  4555                                  	;mov     byte [ss:IDLEINT],0
  4556                                  	;
  4557                                          ;mov	sp,DSKSTACK
  4558                                  	;test	byte [ss:CNTCFLAG],-1  ; 0FFh
  4559                                          ;jz	short DISPCALL
  4560                                  
  4561 000003CA C606[5803]00            	mov     byte [IDLEINT],0
  4562                                  
  4563 000003CF BC[2009]                	MOV     SP,DSKSTACK
  4564 000003D2 F606[3703]FF            	TEST    BYTE [CNTCFLAG],-1
  4565 000003D7 7405                    	JZ      SHORT DISPCALL
  4566                                  
  4567 000003D9 50                              PUSH    AX
  4568                                          ;invoke	DSKSTATCHK
  4569 000003DA E8535A                          CALL	DSKSTATCHK
  4570 000003DD 58                      	POP     AX
  4571                                  DISPCALL:
  4572                                  	; 01/05/2019 - Retro DOS v4.0
  4573 000003DE 2E8B9F[EC00]            	mov	bx,[CS:BX+DISPATCH]
  4574                                  
  4575                                  	; 15/12/2022
  4576 000003E3 871E[EA05]              	xchg	bx,[SAVEBX]
  4577 000003E7 8E1E[EC05]              	MOV	DS,[SAVEDS]
  4578                                  
  4579                                  	; 04/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  4580                                  	; (ss: prefix was not needed here! ds=ss)        
  4581                                  	;xchg	bx,[ss:SAVEBX]
  4582                                  	;mov	ds,[ss:SAVEDS]
  4583                                  
  4584 000003EB 36FF16[EA05]            	call	word [SS:SAVEBX] ; near call
  4585                                  
  4586                                  	; The EXEXA20OFF bit of DOS_FLAG will now be unconditionally cleared
  4587                                  	; here. Please see under M003, M009 and M068 tags in dossym.inc
  4588                                  	; for explanation. Also NOTE that a call to ExecReady (ax=4b05) will
  4589                                  	; return to LeaveDos and hence will not clear this bit. This is 
  4590                                  	; because this bit is used to indicate to the next int 21 call that
  4591                                  	; the previous int 21 was an exec.
  4592                                  	;
  4593                                  	; So do not add any code between the call above and the label 
  4594                                  	; LeaveDOS if it needs to be executed even for ax=4b05
  4595                                  
  4596                                  	;;and	byte [ss:DOS_FLAG],~EXECA20OFF
  4597                                  	;and	byte [ss:DOS_FLAG],0FBh ; clear bit 2
  4598                                  
  4599                                  	; 01/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  4600 000003F0 368026[8600]DB          	and	byte [ss:DOS_FLAG],0DBh ; clear bit 2 and bit 5
  4601                                  
  4602                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  4603                                  ; DOSCODE:41F7h
  4604                                  
  4605                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  4606                                  ; DOSCODE:42D4h
  4607                                  
  4608                                  ;entry LEAVE
  4609                                  ;;;_LEAVE:				; Exit from a system call
  4610                                  LeaveDOS: ; 18/07/2018 
  4611                                  ;ASSUME	SS:NOTHING			; User routines may misbehave
  4612 000003F6 FA                      	CLI
  4613                                  
  4614                                  	; 01/05/2019
  4615                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4616 000003F7 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4617 000003FC 803E[8500]00            	cmp	byte [A20OFF_COUNT],0	; M068: Q: is count 0
  4618 00000401 752A                    	jne	short disa20		; M068: N: dec count and turn a20 off
  4619                                  
  4620                                  LeaveA20On:
  4621 00000403 FE0E[2103]                      DEC     BYTE [INDOS]
  4622                                  	
  4623                                  	; 01/01/2024 (PCDOS 7.1 IBMDOS.COM)
  4624 00000407 FE0E[B812]              	dec	byte [INDOS_FLAG]	; duplicated INDOS flag (what for ?)
  4625                                  
  4626                                          ; 04/11/2022
  4627 0000040B 8E16[8605]              	mov	ss,[USER_SS]
  4628 0000040F 8B26[8405]              	MOV     SP,[USER_SP]
  4629                                  	;MOV	SS,[USER_SS]
  4630 00000413 89E5                    	MOV     BP,SP
  4631                                  	;MOV	[BP.user_AX],AL	
  4632                                          ; 04/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  4633                                  	;;mov	[bp+0],al ; MSDOS 5.0 MSDOS.SYS - DOSCODE:4212h	
  4634                                  	;MOV	[BP+user_env.user_AX],AL  ; user_env.user_AX = 0
  4635                                  	
  4636                                  	; 15/12/2022
  4637 00000415 884600                  	MOV	[BP],AL	; mov [bp+0],al
  4638                                  	
  4639                                  	;MOV	AX,[NSP]
  4640                                          ;MOV	[USER_SP],AX
  4641                                          ;MOV	AX,[NSS]
  4642                                          ;MOV	[USER_SS],AX
  4643                                  	; 01/01/2024
  4644 00000418 C406[F005]              	les	ax,[NSS]
  4645 0000041C A3[8605]                	mov	[USER_SS],ax
  4646 0000041F 8C06[8405]              	mov	[USER_SP],es
  4647                                  
  4648 00000423 58                      	pop	AX
  4649 00000424 5B                      	pop	BX
  4650 00000425 59                      	pop	CX
  4651 00000426 5A                      	pop	DX
  4652 00000427 5E                      	pop	SI
  4653 00000428 5F                      	pop	DI
  4654 00000429 5D                      	pop	BP
  4655 0000042A 1F                      	pop	DS
  4656 0000042B 07                      	pop	ES
  4657                                  
  4658 0000042C CF                              IRET
  4659                                  
  4660                                  disa20:	   				; M068 - Start
  4661 0000042D 8B1E[6300]              	mov	bx,[A20OFF_PSP]		; bx = PSP for which a20 to be off'd
  4662 00000431 3B1E[3003]              	cmp	bx,[CurrentPDB]		; Q: do the PSP's match
  4663 00000435 75CC                    	jne	short LeaveA20On	; N: don't clear bit and don't turn 
  4664                                  					;    a20 off
  4665                                  					; Y: turn a20 off and dec a20off_count
  4666 00000437 FE0E[8500]              	dec	byte [A20OFF_COUNT]	; M068 - End
  4667                                   					; Start - M004
  4668 0000043B 1E                      	push	ds			; segment of stub
  4669 0000043C BB[4210]                	mov	bx,disa20_iret		; offset in stub
  4670 0000043F 53                      	push	bx
  4671 00000440 CB                      	retf	  			; go to stub
  4672                                  					; End - M004
  4673                                  ;SYSTEM_CALL ENDP
  4674                                  
  4675                                  ; DOSCODE:424Ch (MSDOS 6.21, MSDOS.SYS)
  4676                                  ; 04/11/2022
  4677                                  ; DOSCODE:423Fh (MSDOS 5.0, MSDOS.SYS)
  4678                                  
  4679                                  ; ==========================================================================
  4680                                  ;
  4681                                  ; Restore_World restores all registers ('cept SS:SP, CS:IP, flags) from
  4682                                  ; the stack prior to giving the user control
  4683                                  ;
  4684                                  ; ==========================================================================
  4685                                  
  4686                                  ; 01/05/2019 - Retro DOS v4.0
  4687                                  
  4688                                          ;procedure restore_world,NEAR
  4689                                  restore_world:
  4690                                  	;getdseg <es>		; es -> dosdata
  4691 00000441 2E8E06[0700]            	mov	es,[cs:DosDSeg]
  4692                                  
  4693 00000446 268F06[EE05]                    POP	WORD [ES:RESTORE_TMP]
  4694                                  
  4695 0000044B 58                              POP     AX
  4696 0000044C 5B                              POP     BX
  4697 0000044D 59                              POP     CX
  4698 0000044E 5A                              POP     DX
  4699 0000044F 5E                              POP     SI
  4700 00000450 5F                              POP     DI
  4701 00000451 5D                              POP     BP
  4702 00000452 1F                              POP     DS
  4703                                  
  4704 00000453 26FF26[EE05]                   	jmp	word [ES:RESTORE_TMP]
  4705                                  
  4706                                  ;restore_world	ENDP
  4707                                  
  4708                                  ; 01/05/2019 - Retro DOS v4.0 (MSDOS 6.0, MSDISP.ASM, 1991)
  4709                                  
  4710                                  ; DOSCODE:4263h (MSDOS 6.21, MSDOS.SYS)
  4711                                  ; 04/11/2022
  4712                                  ; DOSCODE:4256h (MSDOS 5.0, MSDOS.SYS)
  4713                                  
  4714                                  ; ==========================================================================
  4715                                  ;
  4716                                  ; Save_World saves complete registers on the stack
  4717                                  ;
  4718                                  ; ==========================================================================
  4719                                  
  4720                                          ;procedure save_world,NEAR
  4721                                  save_world:
  4722                                  	;getdseg <es>		; es -> dosdata
  4723 00000458 2E8E06[0700]            	mov	es,[cs:DosDSeg]
  4724                                  
  4725 0000045D 268F06[EE05]                    POP	WORD [ES:RESTORE_TMP]
  4726                                  
  4727                                  	; 12/05/2019
  4728                                          
  4729 00000462 1E                      	PUSH    DS
  4730 00000463 55                              PUSH    BP
  4731 00000464 57                              PUSH    DI
  4732 00000465 56                              PUSH    SI
  4733 00000466 52                              PUSH    DX
  4734 00000467 51                              PUSH    CX
  4735 00000468 53                              PUSH    BX
  4736 00000469 50                              PUSH    AX
  4737                                  
  4738 0000046A 26FF36[EE05]            	push	word [ES:RESTORE_TMP]
  4739                                  
  4740 0000046F 55                      	push	BP
  4741 00000470 89E5                    	mov	BP,SP
  4742 00000472 8E4614                  	mov	ES,[BP+20]	; es was pushed before call
  4743 00000475 5D                      	pop	BP
  4744                                  	
  4745 00000476 C3                      	retn
  4746                                  
  4747                                  ;save_world	ENDP
  4748                                  
  4749                                  ; 01/05/2019
  4750                                  
  4751                                  ; DOSCODE:4282h (MSDOS 6.21, MSDOS.SYS)
  4752                                  ; 04/11/2022
  4753                                  ; DOSCODE:4275h (MSDOS 5.0, MSDOS.SYS)
  4754                                  
  4755                                  ; ==========================================================================
  4756                                  ;
  4757                                  ; Get_User_Stack returns the user's stack (and hence registers) in DS:SI
  4758                                  ;
  4759                                  ; ==========================================================================
  4760                                  
  4761                                          ;procedure get_user_stack,NEAR
  4762                                  Get_User_Stack:
  4763                                          ;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4764 00000477 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4765 0000047C C536[8405]                      lds	si,[USER_SP]
  4766 00000480 C3                      	retn
  4767                                  
  4768                                  ;get_user_stack  ENDP
  4769                                  
  4770                                  ; 22/12/2022
  4771                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0, MSDOS.SYS)
  4772                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1, IBMDOS.COM)
  4773                                  ;%if 0
  4774                                  
  4775                                  ; ---------------------------------------------------------------------------
  4776                                  ;
  4777                                  ; Set_OEM_Handler -- Set OEM sys call address and handle OEM Calls
  4778                                  ; Inputs:
  4779                                  ;	User registers, User Stack, INTS disabled
  4780                                  ;	If CALL F8, DS:DX is new handler address
  4781                                  ; Function:
  4782                                  ;	Process OEM INT 21 extensions
  4783                                  ; Outputs:
  4784                                  ;	Jumps to OEM_HANDLER if appropriate
  4785                                  ;
  4786                                  ; ---------------------------------------------------------------------------
  4787                                  
  4788                                  ;IF	NOT IBM
  4789                                  
  4790                                  _$SET_OEM_HANDLER:
  4791                                  	; 01/05/2019 - Retro DOS v4.0
  4792                                  	
  4793                                  	;(cmp	ah,SET OEM HANDLER  ; 0F8h)
  4794                                  	;(jb	short NOTOOEM)
  4795                                  
  4796 00000481 06                      	push	es ; *
  4797                                  	;getdseg <es>			; es -> dosdata
  4798 00000482 2E8E06[0700]            	mov	es,[cs:DosDSeg]
  4799                                  
  4800 00000487 750C                    	jne	short check_trueversion_request ; check Retro DOS true version
  4801                                  						; (message) request
  4802                                  	; AH = 0F8h = SET OEM HANDLER
  4803                                  
  4804 00000489 268916[1400]            	MOV     [es:OEM_HANDLER],DX	; Set Handler
  4805 0000048E 268C1E[1600]            	MOV     [es:OEM_HANDLER+2],DS
  4806                                  
  4807 00000493 07                      	pop	es ; *
  4808                                  
  4809 00000494 CF                      	IRET                            ; Quick return, Have altered no registers
  4810                                  
  4811                                  check_trueversion_request:
  4812                                  	; 18/07/2019 - Retro DOS v3.0
  4813                                  
  4814                                  	; Retro DOS v2.0 - 20/04/2018
  4815 00000495 83F8FF                  	CMP	AX,0FFFFh
  4816                                  	; 18/07/2018
  4817 00000498 7520                    	jne	short DO_OEM_FUNC ; 01/05/2019
  4818                                  
  4819                                  	; 01/05/2019
  4820 0000049A 07                      	pop	es ; *
  4821                                  
  4822 0000049B B40E                    	mov	ah,0Eh
  4823                                  
  4824                                  	; Retro DOS v4.0 feature only!
  4825 0000049D 81FBA101                	cmp	bx,417  ; Signature to bypass
  4826                                  			; Retro DOS true version message
  4827 000004A1 7414                    	je	short true_version_iret
  4828                                  
  4829 000004A3 56                      	push	si
  4830 000004A4 53                      	push	bx
  4831                                  
  4832 000004A5 BE[C200]                	mov	si,RETRODOSMSG
  4833                                  wrdosmsg:
  4834                                  	;movb	ah,0Eh
  4835 000004A8 BB0700                  	mov	bx,7
  4836                                  wrdosmsg_nxt:
  4837 000004AB 2EAC                    	cs	lodsb
  4838 000004AD 3C24                    	cmp	al,'$'
  4839 000004AF 7404                    	je	short wrdosmsg_ok		
  4840 000004B1 CD10                    	int	10h
  4841 000004B3 EBF6                    	jmp	short wrdosmsg_nxt
  4842                                  
  4843                                  wrdosmsg_ok:
  4844 000004B5 5B                      	pop	bx
  4845 000004B6 5E                      	pop	si
  4846                                  
  4847                                  true_version_iret:
  4848                                  	; ah = 0Eh
  4849                                  	;mov	al,40h ; Retro DOS v4.0
  4850                                  	; 
  4851                                  	;mov	al,41h ; Retro DOS v4.1 
  4852                                  	; 30/12/2022
  4853                                  	;mov	al,42h ; Retro DOS v4.2
  4854                                  	; 01/01/2024
  4855 000004B7 B050                    	mov	al,50h ; Retro DOS v5.0	
  4856 000004B9 CF                      	iret
  4857                                  
  4858                                  	; If above F8 try to jump to handler
  4859                                  
  4860                                  DO_OEM_FUNC:
  4861                                  	; 01/05/2019
  4862 000004BA 26833E[1400]FF          	cmp     word [es:OEM_HANDLER],-1
  4863 000004C0 7504                    	JNE     short OEM_JMP
  4864 000004C2 07                      	pop	es ; *
  4865 000004C3 E903FE                  	JMP     BADCALL                 ; Handler not initialized
  4866                                  OEM_JMP:
  4867 000004C6 06                      	push	es
  4868 000004C7 1F                      	pop	ds ; DOSDATA segment !
  4869 000004C8 07                      	pop	es ; *
  4870                                  
  4871                                  	; 22/12/2022
  4872 000004C9 FB                      	sti	; (enable interrupts before jumping to private handler)  
  4873                                  
  4874 000004CA FF2E[1400]              	JMP     FAR [OEM_HANDLER]
  4875                                  
  4876                                  ;       ENDIF
  4877                                  
  4878                                  ; ---------------------------------------------------------------------------
  4879                                  
  4880                                  ;%endif
  4881                                  
  4882                                  ;============================================================================
  4883                                  ; MCODE.ASM, MSDOS 6.0, 1991
  4884                                  ;============================================================================
  4885                                  ; 17/07/2018 - Retro DOS v3.0
  4886                                  
  4887                                  ;	TITLE	MISC DOS ROUTINES - Int 25 and 26 handlers and other
  4888                                  ;	NAME	IBMCODE
  4889                                  
  4890                                  ;BREAK <NullDev -- Driver for null device>
  4891                                  
  4892                                  ; ROMDOS note:
  4893                                  ;	NUL device driver used to be here, but it was removed and placed in
  4894                                  ;	DOSDATA, because the entry points have to be in the segment as the
  4895                                  ;	header, which is also in DOSDATA.
  4896                                  
  4897                                  ;BREAK <AbsDRD, AbsDWRT -- INT int_disk_read, int_disk_write handlers>
  4898                                  
  4899                                  ;----------------------------------------------------------------------------
  4900                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0, MSDOS.SYS)
  4901                                  ;----------------------------------------------------------------------------
  4902                                  ; DOSCODE:428Ch (MSDOS 6.21 MSDOS.SYS)
  4903                                  ; DOSCODE:427Fh (MSDOS 5.0 MSDOS.SYS)
  4904                                  
  4905                                  ; 01/01/2024 - Retro DOS v5.0
  4906                                  ; DOSCODE:435Fh (PCDOS 7.1 IBMDOS.COM)
  4907                                  
  4908                                  ;Public MSC001S,MSC001E
  4909                                  ;MSC001S label byte
  4910                                  	;IF	IBM
  4911                                  ; Codes returned by BIOS
  4912                                  ERRIN:
  4913 000004CE 02                      	DB	2			; NO RESPONSE
  4914 000004CF 06                      	DB	6			; SEEK FAILURE
  4915 000004D0 0C                      	DB	12			; GENERAL ERROR
  4916 000004D1 04                      	DB	4			; BAD CRC
  4917 000004D2 08                      	DB	8			; SECTOR NOT FOUND
  4918 000004D3 00                      	DB	0			; WRITE ATTEMPT ON WRITE-PROTECT DISK
  4919                                  ERROUT:
  4920                                  ; DISK ERRORS RETURNED FROM INT 25 and 26
  4921 000004D4 80                      	DB	80H			; NO RESPONSE
  4922 000004D5 40                      	DB	40H			; Seek failure
  4923 000004D6 02                      	DB	2			; Address Mark not found
  4924 000004D7 10                      	DB	10H			; BAD CRC
  4925 000004D8 04                      	DB	4			; SECTOR NOT FOUND
  4926 000004D9 03                      	DB	3			; WRITE ATTEMPT TO WRITE-PROTECT DISK
  4927                                  
  4928                                  NUMERR	EQU	$-ERROUT
  4929                                  	;ENDIF
  4930                                  ;MSC001E label byte
  4931                                  ;----------------------------------------------------------------------------
  4932                                  
  4933                                  ;============================================================================
  4934                                  ; MSCODE.ASM - MSDOS 6.0 - 1991
  4935                                  ;============================================================================
  4936                                  ; 18/07/2018 - Retro DOS v3.0
  4937                                  ; 15/05/2019 - Retro DOS v4.0
  4938                                  
  4939                                  ; 02/01/2024 - Retro DOS v5.0
  4940                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:436Bh
  4941                                  
  4942                                  ;BREAK <AbsDRD, AbsDWRT -- INT int_disk_read, int_disk_write handlers>>
  4943                                  
  4944                                  ;   AbsSetup - setup for abs disk functions
  4945                                  ;----------------------------------------------------------------------------
  4946                                  
  4947                                  AbsSetup:
  4948                                  	; 02/01/2024 (PCDOS 7.1, Retro DOS 5.0)
  4949                                  	;;;
  4950                                  	;
  4951 000004DA 1E                      	push	ds ; *
  4952 000004DB 16                      	push	ss
  4953 000004DC 1F                      	pop	ds
  4954                                  	;
  4955 000004DD 8826[DB0A]              	mov	[absdrw_extd],ah
  4956                                  	;mov	[ss:absdrw_extd],ah	; Extended ABS Disk Read/Write flag
  4957                                  					; (AH=1 for INT 21h ax=7305h function)
  4958 000004E1 08E4                    	or	ah,ah
  4959 000004E3 7508                    	jnz	short AbsSetup1		; INT 21h AX=7305h
  4960                                  
  4961                                  	; INT 25h
  4962 000004E5 FE06[B812]              	inc	byte [INDOS_FLAG]
  4963                                  	;inc	byte [ss:INDOS_FLAG]	; Windows DOSBOX's INDOS flag ?
  4964                                  	;;;
  4965 000004E9 FE06[2103]              	inc	byte [INDOS]
  4966                                  	;INC	byte [SS:INDOS]		; SS override
  4967                                  AbsSetup1:
  4968 000004ED FB                      	STI
  4969 000004EE FC                      	CLD
  4970                                  	; 02/01/2024
  4971                                  	;PUSH	DS
  4972                                  	;push	ss
  4973                                  	;pop	ds
  4974 000004EF E83A01                  	CALL	GETBP
  4975                                  	; 02/01/2024
  4976 000004F2 1F                      	pop	ds ; *
  4977 000004F3 7229                    	JC	short errdriv 		; PM. error drive ;AN000;
  4978                                  	
  4979                                  	; 02/01/2024
  4980                                  	;;mov	word [es:bp+1Fh]
  4981                                  	;MOV	WORD [ES:BP+DPB.FREE_CNT],-1 ; do not trust user at all.
  4982                                  ;errdriv:
  4983                                  	;POP	DS
  4984                                  	;jnc	short AbsSetup2
  4985                                  ;AbsSetup_retn:
  4986                                  	;retn
  4987                                  
  4988                                  AbsSetup2:
  4989                                  	; 15/05/2019 - Retro DOS v4.0
  4990                                  	; MSDOS 6.0
  4991                                  					; SS override
  4992 000004F5 36C706[0706]0000        	MOV	word [SS:HIGH_SECTOR],0 ;>32mb	from API		;AN000;
  4993 000004FC E8B904                  	CALL	RW32_CONVERT		;>32mb convert 32bit format to 16bit ;AN000;
  4994                                  	;jc	short AbsSetup_retn
  4995                                  	;call	SET_RQ_SC_PARMS 	;LB. set up SC parms		;AN000;
  4996                                  	; 02/01/2024 - Retro DOS v5.0
  4997 000004FF 721D                    	jc	short errdriv
  4998                                  	;call	null_sub ; retn	; PCDOS 7.1 IBMDOS.COM
  4999                                  
  5000                                  	; MSDOS 3.3 (& MSDOS 6.0)
  5001 00000501 1E                      	PUSH	DS
  5002 00000502 56                      	PUSH	SI
  5003 00000503 50                      	PUSH	AX
  5004                                  
  5005 00000504 16                      	push	ss
  5006 00000505 1F                      	pop	ds
  5007                                  	
  5008 00000506 BE[BE03]                	MOV	SI,OPENBUF
  5009 00000509 8804                    	MOV	[SI],AL
  5010 0000050B 800441                  	ADD	BYTE [SI],"A"
  5011 0000050E C744013A00              	MOV	WORD [SI+1],003AH ; ":",0
  5012 00000513 B80003                  	MOV	AX,0300H
  5013 00000516 F8                      	CLC
  5014 00000517 CD2A                    	INT	int_IBM ; int 2Ah	; Will set carry if shared
  5015                                  		
  5016                                  		; 04/11/2022
  5017                                  		; (INT 2Ah - AX = 0300h)
  5018                                  		; Microsoft Networks - CHECK DIRECT I/O
  5019                                  		; DS:SI -> ASCIIZ disk device name (may be full path or
  5020                                  		;    only drive specifier--must include the colon)
  5021                                  		; Return: CF clear if absolute disk access allowed
  5022                                  
  5023 00000519 58                      	POP	AX
  5024 0000051A 5E                      	POP	SI
  5025 0000051B 1F                      	POP	DS
  5026 0000051C 730E                    	jnc	short AbsSetup_retn
  5027                                  
  5028                                  	; 02/01/2024
  5029                                  errdriv:
  5030                                  	;mov	word [ss:EXTERR],32h
  5031 0000051E 36C706[2403]3200        	MOV	word [ss:EXTERR],error_not_supported
  5032                                  	; 02/01/2024 - Retro DOS v5.0
  5033 00000525 36C706[BF0D]0702        	mov	word [ss:AbsDskErr],207h ; PCDOS 7.1 IBMDOS.COM
  5034                                  
  5035                                  	; 02/01/2024
  5036                                  AbsSetup_retn:
  5037 0000052C C3                      	retn
  5038                                  
  5039                                  ;---------------------------------------------------------------------------
  5040                                  ;
  5041                                  ; Procedure Name : ABSDRD
  5042                                  ;
  5043                                  ; Interrupt 25 handler. Performs absolute disk read.
  5044                                  ; Inputs:	AL - 0-based drive number
  5045                                  ;		DS:BX point to destination buffer
  5046                                  ;		CX number of logical sectors to read
  5047                                  ;		DX starting logical sector number (0-based)
  5048                                  ; Outputs:	Original flags still on stack
  5049                                  ;		Carry set
  5050                                  ;		    AH error from BIOS
  5051                                  ;		    AL same as low byte of DI from INT 24
  5052                                  ;
  5053                                  ;---------------------------------------------------------------------------
  5054                                          ;procedure   ABSDRD,FAR
  5055                                  ABSDRD:
  5056                                  	; 15/05/2019 - Retro DOS v4.0
  5057                                  	; MSDOS 6.21 (DOSCODE:42E5h)
  5058                                  	; 04/11/2022
  5059                                  	; MSDOS 5.0 (DOSCODE:42D8h)
  5060                                  
  5061                                  	; 02/01/2024 - Retro DOS v5.0
  5062                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:43C4h
  5063                                  	
  5064                                  	;;;
  5065 0000052D 30E4                    	xor     ah,ah	; ah=0		; Interrupt 25h handler (ah=0)
  5066 0000052F 31F6                    	xor     si,si	; si=0		; clear read/write mode flags
  5067                                  					; (used with INT 21h ax=7305h)
  5068                                  FAT32_ABSDRD:	; ah=1 si=0 cf=0 (jump from '_$FAT32EXT')
  5069 00000531 FA                      	cli
  5070                                  	;clc ; not necessary
  5071                                  				; INT 21h
  5072                                  				;	AX = 7305h
  5073                                  				; FAT32 - EXTENDED ABSOLUTE DISK READ/WRITE
  5074                                  				;	CX = FFFFh
  5075                                  				;	DL = drive number (01h=A:, etc.)
  5076                                  				;	SI = read/write mode flags
  5077                                  				;	DS:BX -> disk I/O packet
  5078                                  				;
  5079                                  				; Extended Absolute Disk Read/Write mode flags:
  5080                                  				;
  5081                                  				;	Bit(s)  Description
  5082                                  				;	0	direction (0=read, 1=write)
  5083                                  				;	12-1	reserved (0)
  5084                                  				;	14-13	write type (should be 00 on reads).
  5085                                  				;		00 unknown data.
  5086                                  				;		01 FAT data.
  5087                                  				;		10 directory data.
  5088                                  				;		11 file data
  5089                                  				;	15     reserved (0)
  5090                                  				;
  5091                                  				; Format of disk read/write packet:
  5092                                  				;
  5093                                  				;	Offset Size    Description
  5094                                  				;	00h    DWORD   sector number
  5095                                  				;	04h    WORD    number of sectors to r/w
  5096                                  				;	06h    DWORD   transfer address
  5097                                  				;
  5098                                  				; ref: Ralf Brown's Interrupt List
  5099                                  	;;;
  5100                                  absdrd_1:
  5101                                  	; MSDOS 6.0
  5102                                  	;CLI
  5103                                  	
  5104                                  ;	set up ds to point to DOSDATA
  5105                                  
  5106 00000532 50                      	push	ax			; preserve AX value
  5107 00000533 8CD8                    	mov	ax,ds			; store DS value in AX
  5108                                  	;getdseg <ds>
  5109 00000535 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  5110 0000053A A3[630D]                	mov	[TEMPSEG],ax		; store DS value in TEMPSEG
  5111 0000053D 58                      	pop	ax			; restore AX value
  5112                                  
  5113                                  	; M072:
  5114                                  	; We shall save es on the user stack here. We need to use ES in
  5115                                  	; order to access the DOSDATA variables AbsRdWr_SS/SP at exit 
  5116                                  	; time in order to restore the user stack.
  5117                                  
  5118 0000053E 06                      	push	es  ; ****		; M072
  5119                                  
  5120                                  	; 02/01/2024 - Retrodos v5.0 (PCDOS 7.1 IBMDOS.COM)
  5121                                  	;;;
  5122                                  	; 02/01/2024
  5123 0000053F 9C                      	pushf	; !*!
  5124 00000540 7300                    	jnc	short absdrd_2		; (not jumped from ABSDWRT) absolute disk read
  5125                                  	
  5126                                  	;(jumped from ABSDRWT)
  5127                                  	; 02/01/2023 ; (!*!)
  5128                                  	;or	ah,ah
  5129                                  	;stc				; absolute disk write
  5130                                  	;jmp	short absdrd_3
  5131                                  absdrd_2:
  5132 00000542 08E4                    	or	ah,ah
  5133                                  absdrd_3:
  5134 00000544 7510                    	jnz	short absdrd_4		; EXTENDED ABSOLUTE DISK READ/WRITE
  5135                                  	;;;
  5136                                  
  5137 00000546 8C16[1B06]              	MOV	[AbsRdWr_SS],SS		; M013
  5138 0000054A 8926[1D06]              	MOV	[AbsRdWr_SP],SP		; M013
  5139                                  
  5140                                  ; 	set up ss to point to DOSDATA
  5141                                  ;
  5142                                  ; NOTE! Due to an obscure bug in the 80286, you cannot use the ROMDOS
  5143                                  ; version of the getdseg macro with the SS register! An interrupt will
  5144                                  ; sneak through.
  5145                                  
  5146                                  ;ifndef ROMDOS
  5147                                  	;getdseg <ss>			; cli in entry of routine
  5148                                  
  5149 0000054E 2E8E16[0700]            	mov     ss,[cs:DosDSeg]
  5150                                  
  5151                                  ;else
  5152                                  ;	mov	ds, cs:[BioDataSeg]
  5153                                  ;	assume	ds:bdata
  5154                                  ;
  5155                                  ;	mov	ss, ds:[DosDataSg]
  5156                                  ;	assume	ss:DOSDATA
  5157                                  ;
  5158                                  ;endif ; ROMDOS
  5159                                  					; 02/01/2024
  5160 00000553 BC[2009]                	MOV	SP,DSKSTACK	 	;"@#IBM:12.01.2003.build_1.32#@ IBMDOS.COM(USA)"
  5161                                  					; (PCDOS 7.1 IBMDOS.COM)
  5162                                  absdrd_4:
  5163                                  	; 02/01/2024
  5164 00000556 9D                      	popf	; !*!
  5165                                  	;
  5166 00000557 8E1E[630D]              	mov	ds,[TEMPSEG]		; restore DS value
  5167                                  
  5168 0000055B 06                      	push	es ; *** (MSDOS 6.21)
  5169 0000055C E8F9FE                  	call	save_world		; save all regs
  5170                                  
  5171 0000055F 06                      	PUSH	ES ; **
  5172                                  
  5173                                  	; 02/01/2024 - Retrodos v5.0
  5174                                  	;;;
  5175 00000560 7303                    	jnc	short absdrd_5  ; (!*!)	; absolute disk read
  5176 00000562 E9A500                  	jmp     absdrwt_3       ; (!*!)	; (jumping back to) absolute disk write
  5177                                  absdrd_5:
  5178                                  	;;;
  5179                                  
  5180 00000565 E872FF                  	CALL	AbsSetup
  5181 00000568 723D                    	JC	short ILEAVE
  5182                                  
  5183                                  	; Here is a gross temporary fix to get around a serious design flaw in
  5184                                  	;  the secondary cache. The secondary cache does not check for media
  5185                                  	;  changed (it should). Hence, you can change disks, do an absolute
  5186                                  	;  read, and get data from the previous disk. To get around this,
  5187                                  	;  we just won't use the secondary cache for absolute disk reads.
  5188                                  	;                                                      -mw 8/5/88
  5189                                  
  5190                                  	;EnterCrit critDisk
  5191 0000056A E87613                  	call	ECritDisk
  5192 0000056D 36C606[7511]FF          	MOV	byte [ss:CurSC_DRIVE],-1 ; invalidate SC  ;AN000;
  5193                                  	;LeaveCrit critDisk
  5194 00000573 E89A13                  	call	LCritDisk
  5195                                  
  5196                                          ;invoke	DSKREAD
  5197 00000576 E8CF3A                  	CALL	DSKREAD
  5198 00000579 7513                            jnz	short ERR_LEAVE		;Jump if read unsuccessful.
  5199                                  
  5200 0000057B 89F9                            mov     cx,di
  5201 0000057D 368C1E[0E06]                    mov     [ss:TEMP_VAR2],ds
  5202 00000582 36891E[0C06]                    mov     [ss:TEMP_VAR],bx
  5203                                  
  5204                                  ;       CX = # of contiguous sectors read. (These constitute a block of
  5205                                  ;            sectors, also termed an "Extent".)
  5206                                  ;       [HIGH_SECTOR]:DX = physical sector # of first sector in extent.
  5207                                  ;       [TEMP_VAR2]:[TEMP_VAR] = Transfer address (destination data address).
  5208                                  ;       ES:BP -> Drive Parameter Block (DPB).
  5209                                  ;
  5210                                  ;	The Buffer Queue must now be scanned: the contents of any dirty
  5211                                  ;	buffers must be "read" into the transfer memory block, so that the
  5212                                  ;       transfer memory reflects the most recent data.
  5213                                  
  5214                                  	;invoke	DskRdBufScan		;This trashes DS, but don't care.
  5215 00000587 E8503D                          call	DskRdBufScan
  5216 0000058A EB1B                    	jmp     short ILEAVE
  5217                                  
  5218                                  TLEAVE:
  5219 0000058C 7419                    	JZ	short ILEAVE
  5220                                  
  5221                                  ERR_LEAVE:				; M039
  5222                                  	; 15/07/2018 - Retro DOS v3.0
  5223                                          ;IF	IBM
  5224                                  ; Translate the error code to ancient 1.1 codes
  5225 0000058E 06                              PUSH    ES ; *
  5226 0000058F 0E                              PUSH    CS
  5227 00000590 07                              POP     ES
  5228 00000591 30E4                            XOR     AH,AH			; Nul error code
  5229                                  	;mov	cx,6
  5230 00000593 B90600                          MOV     CX,NUMERR		; Number of possible error conditions
  5231 00000596 BF[CE04]                        MOV     DI,ERRIN		; Point to error conditions
  5232 00000599 F2AE                            REPNE   SCASB
  5233 0000059B 7504                            JNZ     SHORT LEAVECODE		; Not found
  5234                                  	;mov	ah,[ES:DI+5]
  5235 0000059D 268A6505                        MOV     AH,[ES:DI+NUMERR-1]	; Get translation
  5236                                  LEAVECODE:
  5237 000005A1 07                              POP     ES ; *
  5238                                  	; 15/05/2019 - Retro DOS v4.0
  5239 000005A2 36A3[BF0D]              	mov	[ss:AbsDskErr],ax
  5240                                          ;ENDIF
  5241                                  
  5242 000005A6 F9                              STC
  5243                                  ILEAVE:
  5244                                  	; 15/05/2019
  5245 000005A7 07                              POP     ES ; **
  5246 000005A8 E896FE                  	call	restore_world
  5247 000005AB 07                              pop	es ; *** (MSDOS 6.21)
  5248                                  
  5249                                  	; 02/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  5250                                  	;;;
  5251 000005AC 9C                      	pushf
  5252 000005AD 36803E[DB0A]00          	cmp	byte [ss:absdrw_extd],0
  5253                                  			; FAT32- EXTENDED ABSOLUTE DISK READ/WRITE flag
  5254 000005B3 751F                    	jnz     short ILEAVE_EXTD	; INT 21h AX=7305h
  5255                                  	; INT 25h
  5256 000005B5 9D                      	popf
  5257                                  	;;;
  5258                                  
  5259 000005B6 FA                      	CLI
  5260 000005B7 36A1[BF0D]              	mov     ax,[ss:AbsDskErr]	; restore error
  5261 000005BB 36FE0E[2103]            	DEC	BYTE [SS:INDOS]
  5262                                  	;
  5263                                  	; 02/01/2024 (PCDOS 7.1 IBMDOS.COM)
  5264 000005C0 36FE0E[B812]            	dec	byte [ss:INDOS_FLAG]	; Windows DOSBOX's INDOS flag ?
  5265                                  	;
  5266 000005C5 16                              push	ss			; M072 - Start
  5267 000005C6 07                      	pop	es			; es - dosdata
  5268 000005C7 268E16[1B06]                    mov	ss,[es:AbsRdWr_SS]	; M013
  5269 000005CC 268B26[1D06]            	mov	sp,[es:AbsRdWr_SP]	; M013
  5270 000005D1 07                      	pop	es  ; ****		; Note es was saved on user
  5271                                  					; stack at entry 
  5272                                  					; M072 - End
  5273 000005D2 FB                              STI
  5274 000005D3 CB                      	RETF   ; ! FAR return !
  5275                                  
  5276                                  	; 02/01/2024 - Retro DOS v5.0
  5277                                  	; (PCDOS 7.1 IBMDOS.COM)
  5278                                  	;;;
  5279                                  ILEAVE_EXTD:	; return from INT 21h AX=7305h
  5280 000005D4 9D                      	popf
  5281 000005D5 36A1[BF0D]              	mov	ax,[ss:AbsDskErr]	; restore error
  5282 000005D9 07                      	pop	es ; ****
  5283 000005DA FB                      	sti
  5284 000005DB C3                      	retn
  5285                                  	;;;
  5286                                  
  5287                                  ;ABSDRD	ENDP
  5288                                  
  5289                                  ;---------------------------------------------------------------------------
  5290                                  ;
  5291                                  ; Procedure Name : ABSDWRT
  5292                                  ;
  5293                                  ; Interrupt 26 handler. Performs absolute disk write.
  5294                                  ; Inputs:	AL - 0-based drive number
  5295                                  ;		DS:BX point to source buffer
  5296                                  ;		CX number of logical sectors to write
  5297                                  ;		DX starting logical sector number (0-based)
  5298                                  ; Outputs:	Original flags still on stack
  5299                                  ;		Carry set
  5300                                  ;		    AH error from BIOS
  5301                                  ;		    AL same as low byte of DI from INT 24
  5302                                  ;
  5303                                  ;---------------------------------------------------------------------------
  5304                                          ;procedure   ABSDWRT,FAR
  5305                                  ABSDWRT:
  5306                                  	; 15/05/2019 - Retro DOS v4.0
  5307                                  	; MSDOS 6.21 (DOSCODE:436Ch)
  5308                                  	; 04/11/2022
  5309                                  	; MSDOS 5.0 (DOSCODE:435Fh)
  5310                                  
  5311                                  	; 03/01/2024 - Retro DOS v5.0
  5312                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:4477h
  5313                                  
  5314                                  	;;;
  5315 000005DC 30E4                    	xor     ah,ah	; ah=0		; Interrupt 26h handler (ah=0)
  5316 000005DE BE0100                  	mov	si,1			; set direction flag/bit to write
  5317                                  					; (used with INT 21h ax=7305h)
  5318                                  FAT32_ABSDWRT:	; ah=1 si=1 cf=0 (jump from '_$FAT32EXT')
  5319                                  
  5320                                  				; INT 21h
  5321                                  				;	AX = 7305h
  5322                                  				; FAT32 - EXTENDED ABSOLUTE DISK READ/WRITE
  5323                                  				;	CX = FFFFh
  5324                                  				;	DL = drive number (01h=A:, etc.)
  5325                                  				;	SI = read/write mode flags
  5326                                  				;	DS:BX -> disk I/O packet
  5327                                  				;
  5328                                  				; Extended Absolute Disk Read/Write mode flags:
  5329                                  				;
  5330                                  				;	Bit(s)  Description
  5331                                  				;	0	direction (0=read, 1=write)
  5332                                  				;	12-1	reserved (0)
  5333                                  				;	14-13	write type (should be 00 on reads).
  5334                                  				;		00 unknown data.
  5335                                  				;		01 FAT data.
  5336                                  				;		10 directory data.
  5337                                  				;		11 file data
  5338                                  				;	15     reserved (0)
  5339                                  				;
  5340                                  				; Format of disk read/write packet:
  5341                                  				;
  5342                                  				;	Offset Size    Description
  5343                                  				;	00h    DWORD   sector number
  5344                                  				;	04h    WORD    number of sectors to r/w
  5345                                  				;	06h    DWORD   transfer address
  5346                                  				;
  5347                                  				; ref: Ralf Brown's Interrupt List
  5348 000005E1 3C02                    	cmp	al,2
  5349 000005E3 7220                    	jb	short absdrwt_2	; floppy disk
  5350                                  	; hard disk
  5351 000005E5 53                      	push	bx
  5352 000005E6 1E                      	push	ds
  5353 000005E7 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  5354 000005EC 30FF                    	xor	bh,bh
  5355 000005EE 88C3                    	mov	bl,al			;
  5356                                  					; NOTE: PCDOS 7.1 kernel does not set
  5357                                  					; DOS_FLAG bit 6 or drive_flags bit 7
  5358                                  					; (It appears that these bits are set
  5359                                  					; by Windows or a system utility or
  5360                                  					; driver that knows the addresses of
  5361                                  					; these FLAGs in the DOSDATA segment.)
  5362                                  					; Erdogan Tan - 03/01/2024
  5363                                  					;
  5364 000005F0 F687[0813]80            	test	byte [drive_flags+bx],80h 
  5365                                  					; test bit 7 (locked bit) ; 29/01/2024
  5366 000005F5 7505                    	jnz	short absdwrt_1		; locked (logical drive) -allowed to abs write-
  5367                                  					; NOTE: lock/unlock are MSDOS/PCDOS 7 extd functions
  5368 000005F7 F606[8600]40            	test	byte [DOS_FLAG],40h	; test bit 6 (large disk support -windows- bit?)
  5369                                  					; (Windows OS running bit ?) ; 23/02/2024
  5370                                  					; NOTE: Retro DOS v5 kernel must set this bit.
  5371                                  absdwrt_1:
  5372 000005FC 1F                      	pop     ds
  5373 000005FD 5B                      	pop     bx
  5374 000005FE 7505                    	jnz     short absdrwt_2	; allowed
  5375 00000600 F9                      	stc
  5376 00000601 E81AFF                  	call    errdriv		; error
  5377 00000604 CB                      	retf
  5378                                  
  5379                                  ;absdrwt_2:
  5380                                  	;;;
  5381                                  
  5382                                  ; 03/01/2024
  5383                                  %if 0
  5384                                  	CLI
  5385                                  
  5386                                  ;	set up ds to point to DOSDATA
  5387                                  
  5388                                  	push	ax
  5389                                  	mov	ax,ds
  5390                                  	;getdseg <ds>
  5391                                  	mov	ds,[cs:DosDSeg]
  5392                                  	mov	[TEMPSEG],ax
  5393                                  	pop	ax
  5394                                  
  5395                                  	; M072:
  5396                                  	; We shall save es on the user stack here. We need to use ES in
  5397                                  	; order to access the DOSDATA variables AbsRdWr_SS/SP at exit 
  5398                                  	; time in order to restore the user stack.
  5399                                  
  5400                                  	push	es ; ****		; M072
  5401                                  
  5402                                  	MOV	[AbsRdWr_SS],SS		; M013
  5403                                  	MOV	[AbsRdWr_SP],SP		; M013
  5404                                  
  5405                                  	; set up ss to point to DOSDATA
  5406                                  	;
  5407                                  	; NOTE! Due to an obscure bug in the 80286, you cannot use the 
  5408                                  	; ROMDOS version of the getdseg macro with the SS register!
  5409                                  	; An interrupt will sneak through.
  5410                                  
  5411                                  ;ifndef ROMDOS
  5412                                  	;getdseg <ss>			; cli in entry of routine
  5413                                  	mov     ss,[cs:DosDSeg]
  5414                                  ;else
  5415                                  ;	mov	ds, cs:[BioDataSeg]
  5416                                  ;	assume	ds:bdata
  5417                                  ;
  5418                                  ;	mov	ss, ds:[DosDataSg]
  5419                                  ;	assume	ss:DOSDATA
  5420                                  ;
  5421                                  ;endif ; ROMDOS
  5422                                  
  5423                                  	MOV	SP,DSKSTACK
  5424                                  		; we are now switched to DOS's disk stack
  5425                                  
  5426                                  	mov	ds,[TEMPSEG]		; restore user's ds
  5427                                  
  5428                                  	push	es ; *** (MSDOS 6.21)
  5429                                  
  5430                                  	call	save_world	      	; save all regs
  5431                                  
  5432                                  	PUSH	ES ; **
  5433                                  %endif
  5434                                  	; 03/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  5435                                  	;;;
  5436                                  absdrwt_2:
  5437 00000605 FA                      	cli
  5438 00000606 F9                      	stc			; writable disk
  5439                                  				; ('jumped from ABSDWRT' sign for common r/w code)
  5440 00000607 E928FF                  	jmp	absdrd_1        ; jump to ABSDRD (common r/w) code
  5441                                  	;;;
  5442                                  
  5443                                  absdrwt_3:
  5444 0000060A E8CDFE                  	CALL	AbsSetup
  5445 0000060D 7298                    	JC	short ILEAVE
  5446                                  
  5447                                  	; 03/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  5448 0000060F E8D05F                  	call	chk_set_first_access
  5449                                  
  5450                                  	;EnterCrit critDisk
  5451 00000612 E8CE12                  	call	ECritDisk
  5452 00000615 36C606[7511]FF          	MOV	byte [ss:CurSC_DRIVE],-1 ; invalidate SC ;AN000;
  5453 0000061B E8D903                  	CALL	Fastxxx_Purge		 ; purge fatopen ;AN000;
  5454                                  	;LeaveCrit critDisk
  5455 0000061E E8EF12                  	call	LCritDisk
  5456                                  
  5457                                  ;M039
  5458                                  ;       DS:BX = transfer address (source data address).
  5459                                  ;       CX = # of contiguous sectors to write. (These constitute a block of
  5460                                  ;	     sectors, also termed an "Extent".)
  5461                                  ;       [HIGH_SECTOR]:DX = physical sector # of first sector in extent.
  5462                                  ;       ES:BP -> Drive Parameter Block (DPB).
  5463                                  ;       [CURSC_DRIVE] = -1 (invalid drive).
  5464                                  ;
  5465                                  ;       Free any buffered sectors which are in Extent; they are being over-
  5466                                  ;       written. Note that all the above registers are preserved for
  5467                                  ;       DSKWRITE.
  5468                                  
  5469 00000621 1E                              push    ds
  5470                                  	;invoke	DskWrtBufPurge          ; This trashes DS.
  5471 00000622 E8A540                  	call	DskWrtBufPurge
  5472 00000625 1F                              pop     ds
  5473                                  ;M039
  5474                                  	;invoke	DSKWRITE
  5475 00000626 E8433A                  	call	DSKWRITE
  5476 00000629 E960FF                  	JMP	TLEAVE
  5477                                  
  5478                                  ;ABSDWRT ENDP
  5479                                  
  5480                                  ;----------------------------------------------------------------------------
  5481                                  ;
  5482                                  ; Procedure Name : GETBP
  5483                                  ;
  5484                                  ; Inputs:
  5485                                  ;	AL = Logical unit number (A = 0)
  5486                                  ; Function:
  5487                                  ;	Find Drive Parameter Block
  5488                                  ; Outputs:
  5489                                  ;	ES:BP points to DPB
  5490                                  ;	[THISDPB] = ES:BP
  5491                                  ;	Carry set if unit number bad or unit is a NET device.
  5492                                  ;		Later case sets extended error error_I24_not_supported
  5493                                  ; No other registers alteredjjj
  5494                                  ;
  5495                                  ;----------------------------------------------------------------------------
  5496                                  
  5497                                  	; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  5498                                  	; 04/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  5499                                  	; PCDOS 76.1 IBMDOS.COM - DOSCODE:44C7h
  5500                                  GETBP:
  5501                                  	; 15/05/2019 - Retro DOS v4.0
  5502                                  	; 11/07/2018 - Retro DOS v3.0
  5503 0000062C 50                      	PUSH	AX
  5504 0000062D 0401                    	ADD	AL, 1		; No increment; need carry flag
  5505 0000062F 7210                    	JC	SHORT SKIPGET
  5506 00000631 E88975                  	CALL	GETTHISDRV
  5507                                  	; MSDOS 6.0
  5508 00000634 730B                    	JNC	SHORT SKIPGET		;PM. good drive		;AN000;
  5509                                  	
  5510                                  	; 23/03/2024 - Retro DOS v5.0
  5511                                  	;XOR	AH,AH			;DCR. ax= error code 	;AN000;
  5512                                  	;CMP	AX,error_not_DOS_disk	;DCR. is unknown media ? ;AN000;
  5513                                  	;JZ	SHORT SKIPGET 		;DCR. yes, let it go 	;AN000;
  5514                                  	;STC				;DCR.			;AN000;
  5515 00000636 B400                    	mov	ah,0	
  5516                                  
  5517 00000638 A3[2403]                	MOV	[EXTERR],AX	;PM. invalid drive or Non DOS drive ;AN000;
  5518 0000063B C706[BF0D]0102          	MOV	WORD [AbsDskErr],201h
  5519                                  SKIPGET:
  5520 00000641 58                      	POP	AX
  5521 00000642 7212                    	JC	SHORT GETBP_RETN ; 15/12/2022
  5522                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  5523                                  	;jnc	short getbp_t
  5524                                  	;retn
  5525                                  getbp_t:
  5526 00000644 C42E[A205]              	LES	BP,[THISCDS]
  5527                                  	; 15/12/2022
  5528 00000648 26F6464480              	test	byte [es:bp+curdir.flags+1],curdir_isnet>>8
  5529                                  	; 07/12/2022
  5530                                  	;TEST	WORD [ES:BP+43H],8000H
  5531                                  	;TEST	WORD [ES:BP+curdir.flags],curdir_isnet ; Clears carry
  5532 0000064D 7408                    	JZ	SHORT GETBP_CDS
  5533                                  GETBP_err:	; 04/01/2024
  5534 0000064F C706[2403]3200          	MOV	WORD [EXTERR],error_not_supported  ; 32h
  5535 00000655 F9                      	STC
  5536                                  GETBP_RETN:
  5537 00000656 C3                      	RETN
  5538                                  
  5539                                  GETBP_CDS:
  5540                                  	;LES	BP,[ES:BP+45H]
  5541 00000657 26C46E45                	LES	BP,[ES:BP+curdir.devptr]
  5542                                  	; 04/01/2024 (PCDOS 7.1 IBMDOS.COM)
  5543                                  	;;;
  5544 0000065B 50                      	push	ax
  5545 0000065C 09E8                    	or	ax,bp
  5546 0000065E 58                      	pop	ax
  5547 0000065F 74EE                    	jz	short GETBP_err ; zero address, error
  5548                                  	;;;
  5549                                  ;----------------------------------------------------------------------------
  5550                                  GOTDPB:
  5551                                  	; Load THISDPB from ES:BP
  5552 00000661 892E[8A05]              	MOV	[THISDPB],BP
  5553 00000665 8C06[8C05]              	MOV	[THISDPB+2],ES
  5554 00000669 C3                      	RETN
  5555                                  
  5556                                  ;BREAK <SYS_RET_OK SYS_RET_ERR CAL_LK ETAB_LK set system call returns>
  5557                                  
  5558                                  ;----------------------------------------------------------------------------
  5559                                  ;
  5560                                  ; Procedure Name : SYS_RETURN
  5561                                  ;
  5562                                  ; These are the general system call exit mechanisms. All internal system
  5563                                  ; calls will transfer (jump) to one of these at the end. Their sole purpose
  5564                                  ; is to set the user's flags and set his AX register for return.
  5565                                  ;
  5566                                  ;----------------------------------------------------------------------------
  5567                                  
  5568                                          ;procedure   SYS_RETURN,NEAR
  5569                                  SYS_RETURN:        
  5570                                          ;entry	SYS_RET_OK
  5571                                  SYS_RET_OK:   
  5572 0000066A E80AFE                  	call    Get_User_Stack
  5573                                  		; turn off user's carry flag
  5574                                  SYS_RET_OK_clc: ; 25/06/2019 
  5575                                          ;;and	word [SI+16h],0FFFEh 
  5576                                  	;and	word [SI+user_env.user_F],~f_Carry 
  5577                                          ; 25/06/2019
  5578 0000066D 806416FE                	and	byte [SI+user_env.user_F],~f_Carry ; 0FEh
  5579                                  	; 04/01/2024
  5580                                  	;JMP	SHORT DO_RET
  5581                                  DO_RET:
  5582                                          ;MOV	[SI+user_env.user_AX],AX ; Really only sets AH
  5583 00000671 8904                    	MOV	[SI],AX
  5584 00000673 C3                      	RETN
  5585                                  
  5586                                          ;entry   SYS_RET_ERR
  5587                                  SYS_RET_ERR:        
  5588 00000674 30E4                    	XOR     AH,AH 		; hack to allow for smaller error rets
  5589 00000676 E86B00                  	call	ETAB_LK 	; Make sure code is OK, EXTERR gets set
  5590 00000679 E81900                  	CALL	ErrorMap
  5591                                  
  5592                                  	;entry	From_GetSet
  5593                                  From_GetSet:
  5594 0000067C E8F8FD                          call    Get_User_Stack
  5595                                  		 ; signal carry to user
  5596                                  	;;or	word [SI+16h],1
  5597                                  	;OR	word [SI+user_env.user_F],f_Carry
  5598                                  	; 25/06/2019
  5599 0000067F 804C1601                	or	byte [SI+user_env.user_F],f_Carry
  5600 00000683 F9                      	STC			; also, signal internal error
  5601                                  	; 04/01/2024
  5602 00000684 EBEB                    	jmp	short DO_RET
  5603                                  ;DO_RET:
  5604                                  	;;MOV	[SI+user_env.user_AX],AX ; Really only sets AH
  5605                                  	;MOV	[SI],AX
  5606                                  	;RETN
  5607                                  
  5608                                  	;entry	FCB_RET_OK
  5609                                  FCB_RET_OK:
  5610                                  	;entry	NO_OP		; obsolete system calls dispatch to here
  5611                                  NO_OP:
  5612 00000686 30C0                    	XOR	AL,AL
  5613 00000688 C3                      	retn
  5614                                  
  5615                                  	;entry	FCB_RET_ERR
  5616                                  FCB_RET_ERR:
  5617 00000689 30E4                    	XOR	AH,AH
  5618 0000068B 36A3[2403]              	mov	[ss:EXTERR],AX
  5619 0000068F E80300                  	CALL	ErrorMap
  5620 00000692 B0FF                    	MOV	AL,-1
  5621 00000694 C3                      	retn
  5622                                  
  5623                                  	;entry	ErrorMap
  5624                                  ErrorMap:
  5625 00000695 56                      	PUSH	SI
  5626                                  				; ERR_TABLE_21 is now in DOSDATA
  5627 00000696 BE[DB0D]                	MOV	SI,ERR_TABLE_21
  5628                                  				; SS override for FAILERR and EXTERR
  5629 00000699 36803E[4A03]00          	CMP	byte [SS:FAILERR],0 ; Check for SPECIAL case.
  5630 0000069F 7407                    	JZ	short EXTENDED_NORMAL ; All is OK.
  5631                                  		 ; Ooops, this is the REAL reason
  5632                                  	;mov	word [SS:EXTERR],53h
  5633 000006A1 36C706[2403]5300        	MOV	word [SS:EXTERR],error_FAIL_I24
  5634                                  EXTENDED_NORMAL:
  5635 000006A8 E80200                  	call	CAL_LK		; Set CLASS,ACTION,LOCUS for EXTERR
  5636 000006AB 5E                      	POP	SI
  5637 000006AC C3                      	retn
  5638                                  
  5639                                  	;EndProc SYS_RETURN
  5640                                  
  5641                                  ;---------------------------------------------------------------------------
  5642                                  ;
  5643                                  ; Procedure Name : CAL_LK
  5644                                  ;
  5645                                  ; Inputs:
  5646                                  ;	SI is OFFSET in DOSDATA of CLASS,ACTION,LOCUS Table to use
  5647                                  ;		(DS NEED not be DOSDATA)
  5648                                  ;	[EXTERR] is set with error
  5649                                  ; Function:
  5650                                  ;	Look up and set CLASS ACTION and LOCUS values for GetExtendedError
  5651                                  ; Outputs:
  5652                                  ;	[EXTERR_CLASS] set
  5653                                  ;	[EXTERR_ACTION] set
  5654                                  ;	[EXTERR_LOCUS] set  (EXCEPT on certain errors as determined by table)
  5655                                  ; Destroys SI, FLAGS
  5656                                  ;
  5657                                  ;---------------------------------------------------------------------------
  5658                                  
  5659                                  	;procedure CAL_LK,NEAR
  5660                                  CAL_LK:
  5661 000006AD 1E                      	PUSH	DS
  5662 000006AE 50                      	PUSH	AX
  5663 000006AF 53                      	PUSH	BX
  5664                                  
  5665                                  ;M048	Context DS		; DS:SI -> Table
  5666                                  ;
  5667                                  ; Since this function can be called thru int 2f we shall not assume that SS
  5668                                  ; is DOSDATA
  5669                                  
  5670                                  	;getdseg  <ds>	; M048: DS:SI -> Table
  5671                                  	; 15/05/2019 - Retro DOS v4.0
  5672 000006B0 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  5673                                  
  5674                                  	; 18/07/2018
  5675                                  	;push	ss
  5676                                  	;pop	ds
  5677                                  
  5678 000006B5 8B1E[2403]              	MOV	BX,[EXTERR]	; Get error in BL
  5679                                  TABLK1:
  5680 000006B9 AC                      	LODSB
  5681                                  
  5682 000006BA 3CFF                    	CMP	AL,0FFH
  5683 000006BC 7409                    	JZ	short GOT_VALS	; End of table
  5684 000006BE 38D8                    	CMP	AL,BL
  5685 000006C0 7405                    	JZ	short GOT_VALS	; Got entry
  5686 000006C2 83C603                  	ADD	SI,3		; Next table entry
  5687                                  	; 15/08/2018
  5688 000006C5 EBF2                    	JMP	short TABLK1
  5689                                  
  5690                                  GOT_VALS:
  5691 000006C7 AD                      	LODSW			; AL is CLASS, AH is ACTION
  5692                                  
  5693 000006C8 80FCFF                  	CMP	AH,0FFH
  5694 000006CB 7404                    	JZ	short NO_SET_ACT
  5695 000006CD 8826[2603]              	MOV	[EXTERR_ACTION],AH ; Set ACTION
  5696                                  NO_SET_ACT:
  5697 000006D1 3CFF                    	CMP	AL,0FFH
  5698 000006D3 7403                    	JZ	short NO_SET_CLS
  5699 000006D5 A2[2703]                	MOV	[EXTERR_CLASS],AL ; Set CLASS
  5700                                  NO_SET_CLS:
  5701 000006D8 AC                      	LODSB			; Get LOCUS
  5702                                  
  5703 000006D9 3CFF                    	CMP	AL,0FFH
  5704 000006DB 7403                    	JZ	short NO_SET_LOC
  5705 000006DD A2[2303]                	MOV	[EXTERR_LOCUS],AL
  5706                                  NO_SET_LOC:
  5707 000006E0 5B                      	POP	BX
  5708 000006E1 58                      	POP	AX
  5709 000006E2 1F                      	POP	DS
  5710 000006E3 C3                      	retn
  5711                                  
  5712                                  	;EndProc CAL_LK
  5713                                  
  5714                                  ;---------------------------------------------------------------------------
  5715                                  ;
  5716                                  ; Procedure Name : ETAB_LK
  5717                                  ;
  5718                                  ; Inputs:
  5719                                  ;	AX is error code
  5720                                  ;	[USER_IN_AX] has AH value of system call involved
  5721                                  ; Function:
  5722                                  ;	Make sure error code is appropriate to this call.
  5723                                  ; Outputs:
  5724                                  ;	AX MAY be mapped error code
  5725                                  ;	[EXTERR] = Input AX
  5726                                  ; Destroys ONLY AX and FLAGS
  5727                                  ;
  5728                                  ;---------------------------------------------------------------------------
  5729                                  
  5730                                  	;procedure ETAB_LK,NEAR
  5731                                  
  5732                                  ETAB_LK: ; 10/08/2018 - Retro DOS v3.0
  5733 000006E4 1E                      	PUSH	DS
  5734 000006E5 56                      	PUSH	SI
  5735 000006E6 51                      	PUSH	CX
  5736 000006E7 53                      	PUSH	BX
  5737                                  
  5738                                  	;Context DS			; SS is DOSDATA
  5739                                  
  5740 000006E8 16                      	push	ss
  5741 000006E9 1F                      	pop	ds
  5742                                  
  5743 000006EA A3[2403]                	MOV	[EXTERR],AX		; Set EXTERR with "real" error
  5744                                  
  5745                                  					; I21_MAP_E_TAB is now in DOSCODE
  5746 000006ED BE[0B00]                	MOV	SI,I21_MAP_E_TAB
  5747 000006F0 88C7                    	MOV	BH,AL			; Real code to BH
  5748 000006F2 8A1E[3B03]              	MOV	BL,[USER_IN_AX+1]	; Sys call to BL
  5749                                  TABLK2:
  5750                                  	; 15/05/2019 - Retro DOS v4.0
  5751 000006F6 2E                      	cs
  5752 000006F7 AD                      	lodsw	; MSDOS 6.0 (MSDOS 6.21 - MSDOS.SYS, DOSCODE:447Dh)
  5753                                  	
  5754                                  	; 18/07/2018 - Retro DOS v3.0
  5755                                  	;lodsw		; IBMDOS.COM (MSDOS 3.3) - Offset 16F7h
  5756                                  
  5757 000006F8 3CFF                    	CMP	AL,0FFH 		; End of table?
  5758 000006FA 740C                    	JZ	short NOT_IN_TABLE	; Yes
  5759 000006FC 38D8                    	CMP	AL,BL			; Found call?
  5760 000006FE 740C                    	JZ	short GOT_CALL		; Yes
  5761 00000700 86E0                    	XCHG	AH,AL			; Count to AL
  5762 00000702 30E4                    	XOR	AH,AH			; Make word for add
  5763 00000704 01C6                    	ADD	SI,AX			; Next table entry
  5764 00000706 EBEE                    	JMP	short TABLK2
  5765                                  
  5766                                  NOT_IN_TABLE:
  5767 00000708 88F8                    	MOV	AL,BH			; Restore original code
  5768 0000070A EB0C                    	JMP	SHORT NO_MAP
  5769                                  
  5770                                  GOT_CALL:
  5771 0000070C 88E1                    	MOV	CL,AH
  5772 0000070E 30ED                    	XOR	CH,CH			; Count of valid err codes to CX
  5773                                  CHECK_CODE:
  5774                                  	; 15/05/2019 - Retro DOS v4.0
  5775 00000710 2E                      	cs
  5776 00000711 AC                      	lodsb	; MSDOS 6.0 (MSDOS 6.21 - MSDOS.SYS, DOSCODE:4497h)
  5777                                  
  5778                                  	; 18/07/2018
  5779                                  	;lodsb		; IBMDOS.COM (MSDOS 3.3) - Offset 1710h
  5780                                  
  5781 00000712 38F8                    	CMP	AL,BH			; Code OK?
  5782 00000714 7402                    	JZ	short NO_MAP		; Yes
  5783 00000716 E2F8                    	LOOP	CHECK_CODE
  5784                                  NO_MAP:
  5785 00000718 30E4                    	XOR	AH,AH			; AX is now valid code
  5786 0000071A 5B                      	POP	BX
  5787 0000071B 59                      	POP	CX
  5788 0000071C 5E                      	POP	SI
  5789 0000071D 1F                      	POP	DS
  5790 0000071E C3                      	retn
  5791                                  
  5792                                  	;EndProc ETAB_LK
  5793                                  
  5794                                  ; 18/07/2018 - Retro DOS v3.0
  5795                                  ;---------------------------------------------------------------------------
  5796                                  ; BREAK <DOS 2F Handler and default NET 2F handler>
  5797                                  
  5798                                  ;IF installed ; (*)
  5799                                  
  5800                                  ;---------------------------------------------------------------------------
  5801                                  ;
  5802                                  ; Procedure Name : SetBad
  5803                                  ;
  5804                                  ; SetBad sets up info for bad functions
  5805                                  ;
  5806                                  ;---------------------------------------------------------------------------
  5807                                  
  5808                                  SetBad:
  5809                                  	;mov	ax,1
  5810 0000071F B80100                  	MOV	AX,error_invalid_function ; ALL NET REQUESTS get inv func
  5811                                  
  5812                                  	; MSDOS 3.3
  5813                                  	;;mov	byte [cs:EXTERR_LOCUS],1
  5814                                  	;MOV	byte [CS:EXTERR_LOCUS],errLOC_Unk
  5815                                  
  5816                                  ;	set up ds to point to DOSDATA
  5817                                  
  5818                                  	; 15/05/2019 - Retro DOS v4.0
  5819                                  	; MSDOS 6.0
  5820 00000722 1E                      	push	ds
  5821                                  
  5822                                  	;getdseg <ds>
  5823 00000723 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  5824                                  
  5825 00000728 C606[2303]01            	MOV	byte [EXTERR_LOCUS],errLOC_Unk ; 1	
  5826                                  
  5827 0000072D 1F                      	pop	ds	  	;hkn; restore ds
  5828                                  
  5829 0000072E F9                      	STC
  5830 0000072F C3                      	retn
  5831                                  
  5832                                  ;--------------------------------------------------------------------------
  5833                                  ;
  5834                                  ; Procedure Name : BadCall
  5835                                  ;
  5836                                  ; BadCall is the initial routine for bad function calls
  5837                                  ;
  5838                                  ;--------------------------------------------------------------------------
  5839                                  
  5840                                  BadCall:
  5841 00000730 E8ECFF                  	call	SetBad
  5842 00000733 CB                      	retf
  5843                                  
  5844                                  ;--------------------------------------------------------------------------
  5845                                  ;
  5846                                  ; OKCall always sets carry to off.
  5847                                  ;
  5848                                  ;-----------------------------------------------------------------------
  5849                                  
  5850                                  OKCall:
  5851 00000734 F8                      	CLC
  5852 00000735 CB                      	retf
  5853                                  
  5854                                  ;---------------------------------------------------------------------------
  5855                                  ;
  5856                                  ; Procedure Name : INT2F
  5857                                  ;
  5858                                  ; INT 2F handler works as follows:
  5859                                  ;   PUSH    AX
  5860                                  ;   MOV     AX,multiplex:function
  5861                                  ;   INT     2F
  5862                                  ;   POP     ...
  5863                                  ; The handler itself needs to make the AX available for the various routines.
  5864                                  ;
  5865                                  ;----------------------------------------------------------------------------
  5866                                  
  5867                                  ; 15/05/2019 - Retro DOS v4.0
  5868                                  
  5869                                  ;KERNEL_SEGMENT equ 70h
  5870                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  5871                                  DOSBIODATASEG equ 70h
  5872                                  
  5873                                  ; retrodos4.s - offset in BIOSDATA
  5874                                  bios_i2f equ 5
  5875                                  
  5876                                  ;PUBLIC	Int2F
  5877                                  ;INT2F	PROC	FAR
  5878                                  
  5879                                  ; 15/05/2019
  5880                                  ; DOSCODE:44BDh (MSDOS 6.21, MSDOS.SYS)
  5881                                  
  5882                                  ; 04/11/2022
  5883                                  ; DOSCODE:44B0h (MSDOS 5.0, MSDOS.SYS)
  5884                                  
  5885                                  	; 15/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  5886                                  	; 18/07/2018 - Retro DOS v3.0
  5887                                  	; 05/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  5888                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:45DAh
  5889                                  INT2F:
  5890                                  	; Offset 172Fh in IBMDOS.COM (MSDOS 3.3), 1987
  5891                                  INT2FNT:
  5892                                  	;ASSUME	CS:DOSCODE,DS:NOTHING,ES:NOTHING,SS:NOTHING
  5893 00000736 FB                      	STI
  5894                                  	;cmp	ah,11h
  5895 00000737 80FC11                  	CMP	AH,MultNET
  5896 0000073A 750A                    	JNZ	short INT2FSHR
  5897                                  TestInstall:
  5898 0000073C 08C0                    	OR	AL,AL
  5899 0000073E 7403                    	JZ	short Leave2F
  5900                                  BadFunc:
  5901 00000740 E8DCFF                  	CALL	SetBad
  5902                                  
  5903                                  	;entry	Leave2F
  5904                                  Leave2F:
  5905 00000743 CA0200                  	RETF	2			; long return + clear flags off stack
  5906                                  
  5907                                  INT2FSHR:
  5908                                  	;cmp	ah,10h
  5909 00000746 80FC10                  	CMP	AH,MultSHARE		; is this a share request
  5910 00000749 74F1                    	JZ	short TestInstall	; yes, check for installation
  5911                                  INT2FNLS:
  5912                                  	;cmp	ah,14h
  5913 0000074B 80FC14                  	CMP	AH,NLSFUNC		; is this a DOS 3.3 NLSFUNC request
  5914 0000074E 74EC                    	JZ	short TestInstall	; yes check for installation
  5915                                  INT2FDOS:
  5916                                  	;ASSUME	CS:DOSCODE,DS:NOTHING,ES:NOTHING,SS:NOTHING
  5917                                  
  5918                                  	; 18/07/2018
  5919                                  	; MSDOS 3.3
  5920                                  	;;cmp	ah,12h	
  5921                                  	;CMP	AH,MultDOS
  5922                                  	;jz	short DispatchDOS
  5923                                  	;iret
  5924                                  
  5925                                  	; 15/05/2019
  5926                                  	; MSDOS 6.0
  5927                                  	;cmp	ah,12h	; 07/12/2022
  5928 00000750 80FC12                  	CMP	AH,MultDOS
  5929 00000753 7503                    	JNZ	short check_win		;check if win386 broadcast
  5930 00000755 E93F02                  	jmp	DispatchDOS
  5931                                  
  5932                                  	; .... win386 .... 
  5933                                  
  5934                                  check_win:
  5935                                  	;cmp	ah,16h
  5936 00000758 80FC16                  	cmp	ah,MultWin386		; Is this a broadcast from Win386?
  5937 0000075B 7408                    	je	short Win386_Msg
  5938                                  
  5939                                  	; M044
  5940                                  	; Check if the callout is from Winoldap indicating swapping out or in 
  5941                                  	; of Windows. If so, do special action of going and saving last para
  5942                                  	; of the Windows memory arena which Winoldap does not save due to a 
  5943                                  	; bug
  5944                                  
  5945 0000075D 80FC46                  	cmp	ah,WINOLDAP ; 46h	; from Winoldap?
  5946                                  	;jne	short next_i2f		; no, chain on
  5947                                  	; 15/12/2022
  5948                                  	;jmp	winold_swap		; yes, do desired action
  5949 00000760 7460                    	je	short winold_swap
  5950 00000762 E92301                  	jmp	next_i2f
  5951                                  
  5952                                  	; 15/12/2022
  5953                                  ;next_i2f:
  5954                                  ;	;;;jmp	bios_i2f
  5955                                  ;	;;jmp	far ptr 70h:5 ; MSDOS 6.21 (MSDOS.SYS, DOSCODE:44F1h)
  5956                                  ;	;jmp	KERNEL_SEGMENT:bios_i2f
  5957                                  ;	; 04/11/2022
  5958                                  ;	jmp	DOSBIODATASEG:bios_i2f
  5959                                  
  5960                                  ;	IRET				; This assume that we are at the head
  5961                                  					; of the list
  5962                                  ;INT2F	ENDP
  5963                                  
  5964                                  ; 15/05/2019 - Retro DOS v4.0
  5965                                  
  5966                                  ; We have received a message from Win386. There are three possible
  5967                                  ; messages we could get from Win386:
  5968                                  ;
  5969                                  ; Init 		- for this, we set the IsWin386 flag and return a pointer
  5970                                  ;		  to the Win386 startup info structure.
  5971                                  ; Exit		- for this, we clear the IsWin386 flag.
  5972                                  ; DOSMGR query 	- for this, we need to indicate that instance data
  5973                                  ;		  has already been handled. this is indicated by setting
  5974                                  ;		  CX to a non-zero value.
  5975                                  
  5976                                  Win386_Msg:
  5977 00000765 1E                      	push	ds
  5978                                  
  5979                                  	;getdseg <DS>			; ds is DOSDATA
  5980 00000766 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  5981                                  
  5982                                  	; For WIN386 2.xx instance data
  5983                                  
  5984 0000076B 3C03                    	cmp	al,3			; win386 2.xx instance data call?
  5985 0000076D 7503                    	jne	short Win386_Msg_exit
  5986 0000076F E94801                  	jmp	OldWin386Init		; yes, return instance data
  5987                                  Win386_Msg_exit:
  5988 00000772 3C06                    	cmp	al,Win386_Exit	 ; 6	; is it an exit call?
  5989 00000774 7503                    	jne	short Win386_Msg_devcall
  5990 00000776 E94A01                  	jmp	Win386_Leaving
  5991                                  Win386_Msg_devcall:
  5992 00000779 3C07                    	cmp	al,Win386_Devcall ; 7	; is it call from DOSMGR?
  5993 0000077B 7503                    	jne	short Win386_Msg_init
  5994 0000077D E97E01                  	jmp	Win386_Query
  5995                                  Win386_Msg_init:
  5996 00000780 3C05                    	cmp	al,Win386_Init	; 5	; is it an init call?
  5997 00000782 7403                    	je	short Win386_Starting
  5998 00000784 E90001                  	jmp	win_nexti2f		; no, return
  5999                                  
  6000                                  Win386_Starting:
  6001                                  	; 05/01/2024 - Retro DOS v5.0
  6002                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:4630h
  6003                                  	;;;
  6004 00000787 50                      	push	ax
  6005 00000788 51                      	push	cx
  6006 00000789 57                      	push	di
  6007 0000078A 06                      	push	es
  6008 0000078B 1E                      	push	ds
  6009 0000078C 07                      	pop	es
  6010 0000078D BF[FB01]                	mov	di,INBUF
  6011 00000790 B90500                  	mov	cx,5
  6012 00000793 FC                      	cld
  6013                                  Win386_s_floop:
  6014 00000794 B8434F                  	mov	ax,'CO'	; 4F43h
  6015 00000797 AB                      	stosw
  6016 00000798 B84E20                  	mov	ax,'N '	; 204Eh
  6017 0000079B AB                      	stosw
  6018 0000079C 83C737                  	add	di,55	; (write 5 times 'CON ' and skip 55 bytes between them)
  6019                                  			; what for ?
  6020 0000079F E2F3                    	loop	Win386_s_floop
  6021 000007A1 07                      	pop	es
  6022 000007A2 5F                      	pop	di
  6023 000007A3 59                      	pop	cx
  6024 000007A4 58                      	pop	ax
  6025                                  	;;;
  6026                                  
  6027                                  	; 17/12/2022
  6028 000007A5 F6C201                  	test	dl,1
  6029                                  	;test	dx,1			; is this really win386?
  6030 000007A8 7403                    	jz	short Win386_vchk	; YES! go and handle it
  6031 000007AA E9DA00                  	jmp	win_nexti2f		; NO! It's win 286 dos extender! M002
  6032                                  Win386_vchk:
  6033                                  	; M018 -- start of block changes
  6034                                  	; The VxD needs to be loaded only for Win 3.0. If version is greater 
  6035                                  	; than 030Ah, we skip the VxD presence check
  6036                                  
  6037                                  ;M067 -- Begin changes
  6038                                  ; If Win 3.0 is run, the VxD ptr has been initialized. If Win 3.1 is now
  6039                                  ;run, it tries to unnecesarily load the VxD even though it is not needed.
  6040                                  ;So, we null out the VxD ptr before the check.
  6041                                  
  6042                                  	;mov	word [Win386_Info+6],0
  6043 000007AD C706[E70E]0000          	mov	word [Win386_Info+Win386_SIS.Virt_Dev_File_Ptr],0
  6044                                  	;mov	word [Win386_Info+8],0
  6045 000007B3 C706[E90E]0000          	mov	word [Win386_Info+Win386_SIS.Virt_Dev_File_Ptr+2],0
  6046                                  
  6047                                  ;M067 -- End changes
  6048                                  
  6049                                  ;ifdef JAPAN
  6050                                  ;	cmp	di,0300h		; version >= 300 i.e 3.10 ;M037
  6051                                  ;else
  6052                                  	;cmp	di,030Ah		; version >= 30a i.e 3.10 ;M037
  6053                                  	; 05/01/2024 - PCDOS 7.1 - Retro DOS v5.0
  6054 000007B9 81FF0004                	cmp	di,0400h		; version >= 400 ; 05/01/2024
  6055                                  ;endif
  6056                                  	;ljae	noVxD31			; yes, VxD not needed 	 ;M037
  6057 000007BD 724E                    	jb	short Win386_vxd
  6058 000007BF E9DD00                  	jmp	noVxD31
  6059                                  
  6060                                  	; 15/12/2022
  6061                                  winold_swap:
  6062 000007C2 1E                      	push	ds
  6063 000007C3 06                      	push	es
  6064 000007C4 56                      	push	si
  6065 000007C5 57                      	push	di
  6066 000007C6 51                      	push	cx
  6067                                  
  6068                                  	;getdseg <ds>			;ds = DOSDATA
  6069 000007C7 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  6070                                  
  6071 000007CC 3C01                    	cmp	al,1			;swap Windows out call
  6072 000007CE 751B                    	jne	short swapin		;no, check if Swap in call
  6073 000007D0 E88801                  	call	getwinlast
  6074 000007D3 1E                      	push	ds
  6075 000007D4 07                      	pop	es
  6076 000007D5 8EDE                    	mov	ds,si			;ds = memory arena of Windows
  6077 000007D7 31F6                    	xor	si,si
  6078                                  	;mov	di,6 ; 05/01/2024
  6079 000007D9 BF[0600]                	mov	di,WinoldPatch1 ; 6
  6080 000007DC B90800                  	mov	cx,8
  6081 000007DF FC                      	cld
  6082 000007E0 51                      	push	cx
  6083 000007E1 F3A4                    	rep	movsb			;save first 8 bytes
  6084 000007E3 59                      	pop	cx
  6085                                  	;mov	di,1176h ; 05/01/2024
  6086 000007E4 BF[7611]                	mov	di,WinoldPatch2 ; 1176h
  6087 000007E7 F3A4                    	rep	movsb			;save next 8 bytes
  6088 000007E9 EB1B                    	jmp	short winold_done
  6089                                  swapin:
  6090 000007EB 3C02                    	cmp	al,2			;swap Windows in call?
  6091 000007ED 7517                    	jne	short winold_done	;no, something else, pass it on
  6092 000007EF E86901                  	call	getwinlast
  6093 000007F2 8EC6                    	mov	es,si
  6094 000007F4 31FF                    	xor	di,di
  6095 000007F6 BE[0600]                	mov	si,WinoldPatch1
  6096 000007F9 B90800                  	mov	cx,8
  6097 000007FC FC                      	cld
  6098 000007FD 51                      	push	cx
  6099 000007FE F3A4                    	rep	movsb			;restore first 8 bytes
  6100 00000800 59                      	pop	cx
  6101 00000801 BE[7611]                	mov	si,WinoldPatch2
  6102 00000804 F3A4                    	rep	movsb			;restore next 8 bytes
  6103                                  winold_done:
  6104 00000806 59                      	pop	cx
  6105 00000807 5F                      	pop	di
  6106 00000808 5E                      	pop	si
  6107 00000809 07                      	pop	es
  6108 0000080A 1F                      	pop	ds
  6109 0000080B EB7B                    	jmp	short next_i2f		;chain on
  6110                                  	; 15/12/2022
  6111                                  	;jmp	next_i2f	
  6112                                  
  6113                                  Win386_vxd:
  6114 0000080D 50                      	push	ax
  6115 0000080E 53                      	push	bx
  6116 0000080F 51                      	push	cx
  6117 00000810 52                      	push	dx
  6118 00000811 56                      	push	si
  6119 00000812 57                      	push	di			; save regs !!dont change order!!
  6120                                  
  6121 00000813 8B1E[8C00]              	mov	bx,[UMB_HEAD]		; M062 - Start
  6122 00000817 83FBFF                  	cmp	bx,0FFFFh    		; Q: have umbs been initialized
  6123 0000081A 741F                    	je	short Vxd31		; N: continue
  6124                                  					; Y: save arena associated with 
  6125                                  					;    umb_head
  6126                                  
  6127 0000081C C606[DA0D]01            	mov	byte [UmbSaveFlag],1	; indicate that we're saving 
  6128                                  					; umb_arena
  6129 00000821 1E                      	push	ds
  6130 00000822 06                      	push	es
  6131                                  
  6132                                  	;mov	ax,ds
  6133                                  	;mov	es,ax			; es - > dosdata
  6134                                  	; 05/01/2024
  6135 00000823 1E                      	push	ds
  6136 00000824 07                      	pop	es
  6137                                  
  6138 00000825 8EDB                    	mov	ds,bx
  6139 00000827 31F6                    	xor	si,si			; ds:si -> umb_head
  6140                                  
  6141                                  	; 05/01/2024 PCDOS 7.1
  6142                                  	;;;			
  6143                                  	;clc	; not necessary (XOR already clears CF)
  6144                                  
  6145                                  restore_ubmhead:		; !! PCDOS 7.1 bug !!
  6146                                  				; jump from 'Win386_Leaving' here was/is wrong
  6147                                  				; (DI and SI would be reversed for 'Win386_Leaving')
  6148                                  				; Erdogan Tan - 05/01/2024
  6149                                  	;;;
  6150                                  
  6151 00000829 FC                      	cld
  6152                                  
  6153 0000082A BF[2F11]                	mov	di,UmbSave1
  6154 0000082D B90B00                  	mov	cx,11
  6155 00000830 F3A4                    	rep	movsb
  6156                                  
  6157 00000832 BF[D50D]                	mov	di,UmbSave2
  6158                                  	;mov	cx,5
  6159                                  	; 18/12/2022
  6160 00000835 B105                    	mov	cl,5
  6161 00000837 F3A4                    	rep	movsb
  6162                                  	
  6163                                  	; 05/01/2024 PCDOS 7.1
  6164                                  	;;;	
  6165                                  	;jnb	short restore_ubmhead_c ; (not jumped from 'Win386_Leaving')
  6166                                  	;jmp	restore_ubmhead_ok ; (jumped from 'Win386_Leaving' just after 'stc')
  6167                                  ;restore_ubmhead_c:
  6168                                  	;;;
  6169                                  
  6170 00000839 07                      	pop	es
  6171 0000083A 1F                      	pop	ds			; M062 - End
  6172                                  
  6173                                  Vxd31:
  6174                                  	;test	byte [DOS_FLAG],2
  6175 0000083B F606[8600]02            	test	byte [DOS_FLAG],SUPPRESS_WINA20	; M066
  6176 00000840 7408                    	jz	short Dont_Supress		; M066
  6177 00000842 5F                      	pop	di				; M066
  6178 00000843 5E                      	pop	si				; M066
  6179 00000844 5A                      	pop	dx				; M066
  6180 00000845 59                      	pop	cx				; M066
  6181 00000846 5B                      	pop	bx				; M066
  6182 00000847 58                      	pop	ax				; M066
  6183 00000848 EB55                    	jmp	short noVxD31			; M066
  6184                                  
  6185                                  	; We check here if the VxD is available in the root of the boot drive. 
  6186                                  	; We do an extended open to suppress any error messages
  6187                                  	
  6188                                  Dont_Supress:
  6189 0000084A A0[6900]                	mov	al,[BOOTDRIVE]
  6190 0000084D 0440                    	add	al,'A' - 1		; get drive letter
  6191 0000084F A2[F812]                	mov	[VxDpath],al		; path is root of bootdrive
  6192                                  	;mov	ah,ExtOpen  ;6Ch	; extended open
  6193                                  	;mov	al,0			; no extended attributes
  6194                                  	; 18/12/2022
  6195 00000852 B8006C                  	mov	ax,ExtOpen<<8 ; 6C00h
  6196 00000855 BB8020                  	mov	bx,2080h		; read access, compatibility mode
  6197                                  					; no inherit, suppress crit err
  6198 00000858 B90700                  	mov	cx,7			; hidden,system,read-only attr
  6199                                  	;05/01/2024
  6200                                  	;inc	dx			; dx bit 0 = 1 ; fail if file does not exist
  6201 0000085B BA0100                  	mov	dx,1			; fail if file does not exist
  6202                                  	
  6203 0000085E BE[F812]                	mov	si,VxDpath ; "c:\\wina20.386"	
  6204                                  					; path of VxD file
  6205 00000861 BFFFFF                  	mov	di,0FFFFh		; no extended attributes
  6206                                  
  6207 00000864 CD21                    	int	21h			; do extended open
  6208                                  
  6209 00000866 5F                      	pop	di
  6210 00000867 5E                      	pop	si
  6211 00000868 5A                      	pop	dx
  6212 00000869 59                      	pop	cx
  6213                                  
  6214 0000086A 7321                    	jnc	short VxDthere		; we found the VxD, go ahead
  6215                                  
  6216                                  	; We could not find the VxD. Cannot let windows load. Return cx != 0 
  6217                                  	; to indicate error to Windows after displaying message to user that 
  6218                                  	; VxD needs to be present to run Windows in enhanced mode.
  6219                                  
  6220 0000086C 52                      	push	dx
  6221 0000086D 1E                      	push	ds
  6222 0000086E 56                      	push	si
  6223 0000086F BE[2C0A]                	mov	si,NoVxDErrMsg
  6224 00000872 0E                      	push	cs
  6225 00000873 1F                      	pop	ds
  6226 00000874 B96300                  	mov	cx,VxDMesLen ; 99	;
  6227 00000877 B402                    	mov	ah,2			; write char to console
  6228 00000879 FC                      	cld
  6229                                  vxdlp:
  6230 0000087A AC                      	lodsb
  6231 0000087B 86D0                    	xchg	dl,al			; get char in dl
  6232 0000087D CD21                    	int	21h
  6233 0000087F E2F9                    	loop	vxdlp
  6234                                  
  6235 00000881 5E                      	pop	si
  6236 00000882 1F                      	pop	ds
  6237 00000883 5A                      	pop	dx
  6238 00000884 5B                      	pop	bx
  6239 00000885 58                      	pop	ax			;all registers restored
  6240 00000886 41                      	inc	cx			;cx != 0 to indicate error
  6241                                  	; 15/12/22022
  6242                                  	;jmp	win_nexti2f		;chain on
  6243                                  	;jmp	short win_nexti2f
  6244                                  
  6245                                  	; 15/12/2022
  6246                                  win_nexti2f:
  6247 00000887 1F                      	pop	ds
  6248                                  	;jmp	short next_i2f		; go to BIOS i2f handler
  6249                                  	; 15/12/2022
  6250                                  next_i2f:
  6251                                  	;;;jmp	bios_i2f
  6252                                  	;;jmp	far ptr 70h:5 ; MSDOS 6.21 (MSDOS.SYS, DOSCODE:44F1h)
  6253                                  	;jmp	KERNEL_SEGMENT:bios_i2f
  6254                                  	; 04/11/2022
  6255 00000888 EA05007000              	jmp	DOSBIODATASEG:bios_i2f
  6256                                  
  6257                                  VxDthere:
  6258 0000088D 89C3                    	mov	bx,ax
  6259 0000088F B43E                    	mov	ah,CLOSE ; 3Eh
  6260 00000891 CD21                    	int	21h			;close the file
  6261                                  
  6262                                  	; Update the VxD ptr in the instance data structure with path to VxD
  6263                                  
  6264                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  6265                                  	;mov	bx,Win386_Info
  6266                                  	;mov	word [bx+Win386_SIS.Virt_Dev_File_Ptr],VxDpath
  6267                                  	;mov	word [bx+Win386_SIS.Virt_Dev_File_Ptr+2],ds
  6268                                  	; 15/12/2022
  6269 00000893 C706[E70E][F812]        	mov	word [Win386_Info+Win386_SIS.Virt_Dev_File_Ptr],VxDpath
  6270 00000899 8C1E[E90E]              	mov	word [Win386_Info+Win386_SIS.Virt_Dev_File_Ptr+2],ds
  6271                                  
  6272 0000089D 5B                      	pop	bx
  6273 0000089E 58                      	pop	ax
  6274                                  noVxD31:
  6275                                  	; M018; End of block changes
  6276                                  
  6277 0000089F 800E[5B0F]01            	or	byte [IsWin386],1 	; Indicate WIN386 present
  6278 000008A4 800E[650D]01            	or	byte [redir_patch],1	; Enable critical sections; M002
  6279                                  
  6280                                  	; M002;
  6281                                  	; Save the previous es:bx (instance data ptr) into our instance table
  6282                                  
  6283 000008A9 52                      	push	dx			; M002
  6284 000008AA 89DA                    	mov	dx,bx			; M002
  6285                                  					; point ES:BX to Win386_Info ; M002
  6286 000008AC BB[E10E]                	mov	bx,Win386_Info 
  6287 000008AF 895702                  	mov	[bx+2],dx		; M002
  6288 000008B2 8C4704                  	mov	[bx+4],es		; M002
  6289 000008B5 5A                      	pop	dx			; M002
  6290 000008B6 1E                      	push	ds			; M002
  6291 000008B7 07                      	pop	es			; M002
  6292                                  	;jmp	win_nexti2f		; M002
  6293                                  	; 15/12/2022
  6294 000008B8 EBCD                    	jmp	short win_nexti2f
  6295                                  
  6296                                  	; 15/12/2022
  6297                                  	; Code to return Win386 2.xx instance table
  6298                                  OldWin386Init:
  6299 000008BA 58                      	pop	ax			; discard ds pushed on stack
  6300 000008BB BE[FC10]                	mov	si,OldInstanceJunk 
  6301                                  					; ds:si = instance table
  6302 000008BE B84852                  	mov	ax,5248h ; 'HR'		; indicate instance data present
  6303                                  	;jmp	next_i2f
  6304                                  	; 15/12/2022
  6305 000008C1 EBC5                    	jmp	short next_i2f
  6306                                  
  6307                                  Win386_Leaving:
  6308                                  	; 15/12/2022
  6309 000008C3 F6C201                  	test 	dl,1
  6310                                  	;test	dx,1			; is this really win386?
  6311                                  	;jz	short Win386_Leaving_c
  6312                                  	;jmp	win_nexti2f		; NO! It's win 286 dos extender! M002
  6313                                  	; 15/12/2022
  6314 000008C6 75BF                    	jnz	short win_nexti2f	
  6315                                  
  6316                                  Win386_Leaving_c:
  6317                                  					; M062 - Start
  6318 000008C8 803E[DA0D]01            	cmp	byte [UmbSaveFlag],1	; Q: was umb_arena saved at win start
  6319                                  					;    up.
  6320 000008CD 7523                    	jne	short noumb		; N: not saved 
  6321 000008CF C606[DA0D]00            	mov	byte [UmbSaveFlag],0	; Y: clear UmbSaveFlag and restore 
  6322                                  					;    previously saved umb_head
  6323                                  
  6324                                  	; 05/01/2024 - PCDOS 7.1 (has BUG here!)
  6325                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:472Bh
  6326                                  	;;;
  6327                                  	;push	ax ; (not necessary)
  6328                                  	;push	es
  6329                                  	;push	cx
  6330                                  	;push	si
  6331                                  	;push	di
  6332                                  	;mov	es,[UMB_HEAD]
  6333                                  	;xor	di,di
  6334                                  	;stc
  6335                                  	;jmp	restore_ubmhead	; !! PCDOS 7.1 bug !! IBMDOS.COM - DOSCODE:4737h
  6336                                  	;			; (jumped code does not restore umbhead,
  6337                                  	;			; MSDOS 6.22 "Win386_Leaving" code was/is correct,
  6338                                  	;			; modified code -in PCDOS 7.1 IBMDOS.COM- is wrong)
  6339                                  	;			; Erdogan Tan - 05/01/2024
  6340                                  	;
  6341                                  	;;;
  6342                                  
  6343                                  	; 05/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1)
  6344                                  	;push	ax ; (not necessary)
  6345 000008D4 06                      	push	es
  6346 000008D5 51                      	push	cx
  6347 000008D6 56                      	push	si
  6348 000008D7 57                      	push	di
  6349                                  
  6350                                  	;mov	ax,[UMB_HEAD]
  6351                                  	;mov	es,ax
  6352                                  	; 05/01/2024
  6353 000008D8 8E06[8C00]              	mov	es,[UMB_HEAD]
  6354 000008DC 31FF                    	xor	di,di			; es:di -> umb_head
  6355                                  
  6356 000008DE FC                      	cld
  6357                                  
  6358 000008DF BE[2F11]                	mov	si,UmbSave1
  6359 000008E2 B90B00                  	mov	cx,11
  6360 000008E5 F3A4                    	rep	movsb
  6361 000008E7 BE[D50D]                	mov	si,UmbSave2
  6362                                  	;mov	cx,5
  6363                                  	; 18/12/2022
  6364 000008EA B105                    	mov	cl,5
  6365 000008EC F3A4                    	rep	movsb
  6366                                  
  6367                                  restore_ubmhead_ok:	; 05/01/2024 - PCDOS 7.1 IBMDOS.COM - DOSCODE:473Ah
  6368 000008EE 5F                      	pop	di
  6369 000008EF 5E                      	pop	si
  6370 000008F0 59                      	pop	cx
  6371 000008F1 07                      	pop	es
  6372                                  	; 05/01/2024
  6373                                  	;pop	ax
  6374                                  noumb:					; M062 - End
  6375 000008F2 8026[5B0F]00            	and	byte [IsWin386],0	; Win386 is gone
  6376 000008F7 8026[650D]00            	and	byte [redir_patch],0	; Disable critical sections ; M002
  6377 000008FC EB89                    	jmp	short win_nexti2f
  6378                                  
  6379                                  ;	; 15/12/2022
  6380                                  ;	; Code to return Win386 2.xx instance table
  6381                                  ;OldWin386Init:
  6382                                  ;	pop	ax			; discard ds pushed on stack
  6383                                  ;	mov	si,OldInstanceJunk 
  6384                                  ;					; ds:si = instance table
  6385                                  ;	mov	ax,5248h ; 'RH'		; indicate instance data present
  6386                                  ;	;jmp	next_i2f
  6387                                  ;	; 15/12/2022
  6388                                  ;	jmp	short _next_i2f
  6389                                  
  6390                                  Win386_Query:
  6391 000008FE 83FB15                  	cmp	bx,Win386_DOSMGR ; 15h	; is this from DOSMGR?
  6392 00000901 7584                    	jne	short win_nexti2f     	; no, ignore it & chain to next
  6393 00000903 09C9                    	or	cx,cx			; is it an instance query?
  6394 00000905 7508                    	jnz	short dosmgr_func	; no, some DOSMGR query
  6395 00000907 41                      	inc	cx			; indicate that data is instanced
  6396                                  ;
  6397                                  ; M001; We were previously returning a null ptr in es:bx. This will not work.
  6398                                  ; M001; WIN386 needs a ptr to a table in es:bx with the following offsets:
  6399                                  ; M001;  
  6400                                  ; M001; OFFSETS STRUC
  6401                                  ; M001; 	Major_version	db	?
  6402                                  ; M001; 	Minor_version	db	?
  6403                                  ; M001; 	SaveDS		dw	?
  6404                                  ; M001; 	SaveBX		dw	?
  6405                                  ; M001; 	Indos		dw	?
  6406                                  ; M001; 	User_id		dw	?
  6407                                  ; M001; 	CritPatch	dw	?
  6408                                  ; M001; OFFSETS	ENDS
  6409                                  ; M001; 
  6410                                  ; M001; User_Id is the only variable really important for proper functioning  
  6411                                  ; M001; of Win386. The other variables are used at init time to patch stuff
  6412                                  ; M001; out. In DOS 5.0, we do the patching ourselves. But we still need to 
  6413                                  ; M001; pass this table because Win386 depends on this table to get the 
  6414                                  ; M001; User_Id offset.
  6415                                  ; M001; 
  6416 00000908 BB[4D0F]                	mov	bx,Win386_DOSVars	; M001 
  6417 0000090B 1E                      	push	ds			; M001
  6418 0000090C 07                      	pop	es			; es:bx points at offset table ; M001
  6419 0000090D EB40                    	jmp	short PopIret		; M001
  6420                                  
  6421                                  ; 15/12/2022
  6422                                  ;	; Code to return Win386 2.xx instance table
  6423                                  ;OldWin386Init:
  6424                                  ;	pop	ax			; discard ds pushed on stack
  6425                                  ;	mov	si,OldInstanceJunk 
  6426                                  ;					; ds:si = instance table
  6427                                  ;	mov	ax,5248h ; 'RH'		; indicate instance data present
  6428                                  ;	;jmp	next_i2f
  6429                                  ;	; 15/12/2022
  6430                                  ;	jmp	short _next_i2f
  6431                                  
  6432                                  dosmgr_func:
  6433 0000090F 49                      	dec	cx
  6434 00000910 7435                    	jz	short win386_patch	; call to patch DOS
  6435 00000912 49                      	dec	cx
  6436 00000913 743A                    	jz	short PopIret		; remove DOS patches, ignore
  6437 00000915 49                      	dec	cx
  6438 00000916 7439                    	jz	short win386_size	; get size of DOS data structures
  6439 00000918 49                      	dec	cx
  6440 00000919 7428                    	jz	short win386_inst	; instance more data
  6441                                  	;dec	cx
  6442                                  	;jnz	short PopIret		; no functions above this
  6443                                  	; 05/01/2024 (PCDOS 7.1 IBMDOS.COM DOSCODE:4771h)
  6444 0000091B E232                    	loop	PopIret
  6445                                  
  6446                                  	; Get DOS device driver size -- es:di points at device driver header
  6447                                  	; In DOS 4.x, the para before the device header contains an arena 
  6448                                  	; header for the driver.
  6449                                  
  6450 0000091D 8CC0                    	mov	ax,es			; ax = device header segment
  6451                                  
  6452                                  	; We check to see if we have a memory arena for this device driver. 
  6453                                  	; The way to do this would be to look at the previous para to see if
  6454                                  	; it has a 'D' marking it as an arena and also see if the owner-field 
  6455                                  	; in the arena is the same as the device header segment. These two 
  6456                                  	; checks together should take care of all cases
  6457                                  
  6458 0000091F 48                      	dec	ax			; get arena header
  6459 00000920 06                      	push	es
  6460 00000921 8EC0                    	mov	es,ax			; arena header for device driver
  6461                                  
  6462 00000923 26803D44                	cmp	byte [es:di],'D'	; is it a device arena?
  6463 00000927 7517                    	jnz	short cantsize		; no, cant size this driver
  6464 00000929 40                      	inc	ax			; get back device header segment
  6465 0000092A 26394501                	cmp	[es:di+1],ax		; owner field pointing at driver?
  6466 0000092E 7510                    	jnz	short cantsize		; no, not a proper arena
  6467                                  
  6468 00000930 268B4503                	mov	ax,[es:di+3]		; get arena size in paras
  6469 00000934 07                      	pop	es
  6470                                  
  6471                                  	; We have to multiply by 16 to get the number of bytes in (bx:cx)
  6472                                  	; Speed is not critical and so we choose the shortest method 
  6473                                  	; -- use "mul"
  6474                                  
  6475 00000935 BB1000                  	mov	bx,16
  6476 00000938 F7E3                    	mul	bx
  6477 0000093A 89C1                    	mov	cx,ax
  6478 0000093C 89D3                    	mov	bx,dx
  6479 0000093E EB09                    	jmp	short win386_done	; return with device driver size
  6480                                  cantsize:
  6481 00000940 07                      	pop	es
  6482 00000941 31C0                    	xor	ax,ax
  6483                                  win386_inst:	; 05/01/2024
  6484 00000943 31D2                    	xor	dx,dx			; ask DOSMGR to use its methods
  6485 00000945 EB08                    	jmp	short PopIret		; return
  6486                                  
  6487                                  win386_patch:
  6488                                  	; dx contains bits marking the patches to be applied. We return 
  6489                                  	; the field with all bits set to indicate that all patches have been
  6490                                  	; done
  6491                                  
  6492 00000947 89D3                    	mov	bx,dx			; move patch bitfield to bx
  6493                                   	;jmp	short win386_done	; done, return
  6494                                  	; 15/12/2022
  6495                                  	; 15/12/2022
  6496                                  win386_done:
  6497 00000949 B87CB9                  	mov	ax,WIN_OP_DONE		; 0B97Ch
  6498 0000094C BAABA2                  	mov	dx,DOSMGR_OP_DONE	; 0A2ABh
  6499                                  PopIret:
  6500 0000094F 1F                      	pop	ds
  6501 00000950 CF                      	iret	
  6502                                  
  6503                                  win386_size:
  6504                                  	; Return the size of DOS data structures -- currently only CDS size
  6505                                  
  6506                                  	; 17/12/2022
  6507 00000951 F6C201                  	test	dl,1
  6508                                  	;test	dx,1			; check for CDS size bit
  6509 00000954 74F9                    	jz	short PopIret		; no, unknown structure -- return
  6510                                  
  6511 00000956 B95800                  	mov	cx,curdirLen	; 88 	; cx = CDS size
  6512 00000959 EBEE                    	jmp	short win386_done	; return with the size
  6513                                  
  6514                                  ; 05/01/2024
  6515                                  %if 0
  6516                                  win386_inst:
  6517                                  	; WIN386 check to see if DOS has identified the CDS,SFT and device
  6518                                  	; chain as instance data. Currently, we let the WIN386 DOSMGR handle
  6519                                  	; this by returning a status of not previously instanced. The basic
  6520                                  	; structure of these things have not changed and so the current 
  6521                                  	; DOSMGR code should be able to work it out
  6522                                  
  6523                                  	xor	dx,dx			; make sure dx has a not done value
  6524                                  	jmp	short PopIret		; skip done indication
  6525                                  %endif
  6526                                  
  6527                                  	; 15/12/2022
  6528                                  ;win386_done:
  6529                                  ;	mov	ax,WIN_OP_DONE		; 0B97Ch
  6530                                  ;	mov	dx,DOSMGR_OP_DONE	; 0A2ABh
  6531                                  ;PopIret:
  6532                                  ;	pop	ds
  6533                                  ;	iret				; return back up the chain
  6534                                  
  6535                                  	; 15/12/2022
  6536                                  ;win_nexti2f:
  6537                                  	;pop	ds
  6538                                  	;jmp	next_i2f		; go to BIOS i2f handler
  6539                                  
  6540                                  ;End WIN386 support
  6541                                  
  6542                                  ; 15/05/2019
  6543                                  
  6544                                  ;M044; Start of changes
  6545                                  ; Winoldap has a bug in that its calculations for the Windows memory image
  6546                                  ; to save is off by 1 para. This para can happen to be a Windows arena if the
  6547                                  ; DOS top of memory happens to be at an odd boundary (as is the case when
  6548                                  ; UMBs are present). This is because Windows builds its arenas only at even
  6549                                  ; para boundaries. This arena now gets trashed when Windows is swapped back
  6550                                  ; in leading to a crash. Winoldap issues callouts when it swaps Windows out
  6551                                  ; and back in. We sit on these callouts. On the Windows swapout, we save the
  6552                                  ; last para of the Windows memory block and then restore this para on the
  6553                                  ; Windows swapin callout. 
  6554                                  
  6555                                  getwinlast:
  6556                                  	; 07/12/2022
  6557 0000095B 8B36[3003]              	mov	si,[CurrentPDB]
  6558 0000095F 4E                      	dec	si
  6559 00000960 8EC6                    	mov	es,si
  6560 00000962 2603360300              	add	si,[es:3]
  6561 00000967 C3                      	retn
  6562                                  
  6563                                  ; 15/12/2022
  6564                                  %if 0
  6565                                  winold_swap:
  6566                                  	push	ds
  6567                                  	push	es
  6568                                  	push	si
  6569                                  	push	di
  6570                                  	push	cx
  6571                                  
  6572                                  	;getdseg <ds>			;ds = DOSDATA
  6573                                  	mov	ds,[cs:DosDSeg]
  6574                                  
  6575                                  	cmp	al,1			;swap Windows out call
  6576                                  	jne	short swapin		;no, check if Swap in call
  6577                                  	call	getwinlast
  6578                                  	push	ds
  6579                                  	pop	es
  6580                                  	mov	ds,si			;ds = memory arena of Windows
  6581                                  	xor	si,si
  6582                                  	mov	di,WinoldPatch1
  6583                                  	mov	cx,8
  6584                                  	cld
  6585                                  	push	cx
  6586                                  	rep	movsb			;save first 8 bytes
  6587                                  	pop	cx
  6588                                  	mov	di,WinoldPatch2
  6589                                  	rep	movsb			;save next 8 bytes
  6590                                  	jmp	short winold_done
  6591                                  swapin:
  6592                                  	cmp	al,2			;swap Windows in call?
  6593                                  	jne	short winold_done	;no, something else, pass it on
  6594                                  	call	getwinlast
  6595                                  	mov	es,si
  6596                                  	xor	di,di
  6597                                  	mov	si,WinoldPatch1
  6598                                  	mov	cx,8
  6599                                  	cld
  6600                                  	push	cx
  6601                                  	rep	movsb			;restore first 8 bytes
  6602                                  	pop	cx
  6603                                  	mov	si,WinoldPatch2
  6604                                  	rep	movsb			;restore next 8 bytes
  6605                                  winold_done:
  6606                                  	pop	cx
  6607                                  	pop	di
  6608                                  	pop	si
  6609                                  	pop	es
  6610                                  	pop	ds
  6611                                  	jmp	next_i2f		;chain on
  6612                                  
  6613                                  %endif
  6614                                  
  6615                                  ;M044; End of changes
  6616                                  
  6617                                  ; ---------------------------------------------------------------------
  6618                                  ; 06/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM/MSDOS.SYS)
  6619                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:4811h
  6620                                  
  6621                                  	; INT 2Fh AX=1231h
  6622                                  	; Windows95 - SET/CLEAR "REPORT WINDOWS TO DOS PROGRAMS" FLAG
  6623                                  	; 			(Ref: Ralf Brown's Interrupt List)
  6624                                  int_2Fh_1231h:
  6625 00000968 1E                      	push	ds
  6626 00000969 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  6627 0000096E 31C0                    	xor	ax,ax ; 0
  6628 00000970 08D2                    	or	dl,dl
  6629 00000972 7507                    	jnz	short not_1231_dl_0
  6630 00000974 C606[5C0F]01            	mov	byte [IsWin386+1],1	; set byte after "IsWIN386" to 01h
  6631 00000979 EB1A                    	jmp	short int_2f_1231h_retn
  6632                                  
  6633                                  	;nop
  6634                                  
  6635                                  not_1231_dl_0:
  6636 0000097B 80FA01                  	cmp	dl,1
  6637 0000097E 7507                    	jne	short not_1231_dl_1	; clear "IsWIN386" bit 1
  6638 00000980 800E[5B0F]02            	or	byte [IsWin386],2	; set "IsWIN386" bit 1
  6639 00000985 EB0E                    	jmp	short int_2f_1231h_retn
  6640                                  
  6641                                  	;nop
  6642                                  
  6643                                  not_1231_dl_1:
  6644 00000987 80FA02                  	cmp	dl,2
  6645 0000098A 7507                    	jne	short not_1231_dl_2
  6646 0000098C 8026[5B0F]FD            	and	byte [IsWin386],0FDh	; clear bit 1
  6647 00000991 EB02                    	jmp	short int_2f_1231h_retn
  6648                                  not_1231_dl_2:
  6649 00000993 40                      	inc	ax              	; return error, ax = 1
  6650 00000994 F9                      	stc
  6651                                  int_2f_1231h_retn:
  6652 00000995 1F                      	pop	ds
  6653 00000996 C3                      	retn
  6654                                  
  6655                                  ; ---------------------------------------------------------------------
  6656                                  
  6657                                  ; 15/05/2019
  6658                                  
  6659                                  ; 06/01/2024 - Retro DOS v5.0
  6660                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:4842h
  6661                                  
  6662                                  DispatchDOS:
  6663 00000997 2EFF36[D401]            	PUSH	word [CS:FOO]		; push return address
  6664 0000099C 2EFF36[D601]            	PUSH	word [CS:DTab]		; push table address
  6665 000009A1 50                      	PUSH	AX			; push index
  6666 000009A2 55                      	PUSH	BP
  6667 000009A3 89E5                    	MOV	BP,SP
  6668                                  		; stack looks like:
  6669                                  		;   0	BP
  6670                                  		;   2	DISPATCH
  6671                                  		;   4	TABLE
  6672                                  		;   6	RETURN
  6673                                  		;   8	LONG-RETURN
  6674                                  		;   C	FLAGS
  6675                                  		;   E	AX
  6676                                  	
  6677 000009A5 8B460E                  	MOV	AX,[BP+0Eh]		; get AX value
  6678 000009A8 5D                      	POP	BP
  6679 000009A9 E84A0E                  	call	TableDispatch
  6680 000009AC E991FD                  	JMP	BadFunc 		; return indicates invalid function
  6681                                  
  6682                                  INT2F_etcetera:
  6683                                  	;entry	DosGetGroup
  6684                                  DosGetGroup:
  6685                                  	; MSDOS 3.3
  6686                                  	;push	cs
  6687                                  	;pop	ds
  6688                                  	;retn
  6689                                  
  6690                                  	; MSDOS 6.0
  6691                                  ;SR; Cannot use CS now
  6692                                  ;
  6693                                  ;	PUSH	CS
  6694                                  ;	POP	DS
  6695                                  
  6696                                  	; 04/11/2022
  6697                                  	; (MSDOS 5.0 MSDOS.SYS - DOSCODE:46FBh)
  6698                                  
  6699                                  	;getdseg <ds>
  6700 000009AF 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  6701 000009B4 C3                      	retn
  6702                                  
  6703                                  	;entry	DOSInstall
  6704                                  DOSInstall:
  6705 000009B5 B0FF                    	MOV	AL,0FFh
  6706 000009B7 C3                      	retn
  6707                                  
  6708                                  ;ENDIF ; (*)
  6709                                  
  6710                                  
  6711                                  ; 15/05/2019 - Retro DOS v4.0
  6712                                  ; 06/01/2024 - Retro DOS v5.0
  6713                                  
  6714                                  ;------------------------------------------------------------------------
  6715                                  ;
  6716                                  ; Procedure Name : RW32_CONVERT
  6717                                  ;
  6718                                  ;Input: same as ABSDRD and ABSDWRT
  6719                                  ;	 ES:BP -> DPB
  6720                                  ;Functions: convert 32bit absolute RW input parms to 16bit input parms
  6721                                  ;Output: carry set when CX=-1 and drive is less then 32mb
  6722                                  ;	 carry clear, parms ok
  6723                                  ;
  6724                                  ;------------------------------------------------------------------------
  6725                                  
  6726                                  	; 06/01/2024
  6727                                  RW32_CONVERT:
  6728 000009B8 83F9FF                  	CMP	CX,-1			   ;>32mb  new format ?	;AN000;
  6729                                  	;inc	cx ; *	; 01 -> 0
  6730 000009BB 7423                    	JZ	short new32format	   ;>32mb  yes		;AN000;
  6731                                  	;dec	dx
  6732                                  	
  6733                                  	;cmp	word [es:bp+0Fh],0
  6734 000009BD 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0 ; PCDOS 7.1
  6735 000009C2 741A                    	jz	short rw32_conv_err ; FAT32 fs
  6736                                  
  6737 000009C4 50                      	PUSH	AX			   ;>32mb  save ax	;AN000;
  6738 000009C5 52                      	PUSH	DX			   ;>32mb  save dx	;AN000;
  6739                                  	;mov	ax,[es:bp+0Dh]
  6740 000009C6 268B460D                	MOV	AX,[ES:BP+DPB.MAX_CLUSTER] ;>32mb  get max cluster # ;AN000;
  6741                                  	;mov	dl,[es:bp+4]
  6742 000009CA 268A5604                	MOV	DL,[ES:BP+DPB.CLUSTER_MASK] ;>32mb		;AN000;
  6743 000009CE 80FAFE                  	CMP	DL,0FEh ; 254		;>32mb  removable ?	;AN000;
  6744 000009D1 7407                    	JZ	short letold		;>32mb  yes		;AN000;
  6745                                  	;INC	DL			;>32mb			;AN000;
  6746                                  	; 17/12/2022
  6747 000009D3 42                      	inc	dx
  6748 000009D4 30F6                    	XOR	DH,DH			;>32mb  dx = sector/cluster ;AN000;
  6749 000009D6 F7E2                    	MUL	DX			;>32mb  dx:ax= max sector # ;AN000;
  6750 000009D8 09D2                    	OR	DX,DX	; (clears CF)	;>32mb  > 32mb ?	;AN000;
  6751                                  letold:
  6752 000009DA 5A                      	POP	DX			;>32mb  restore dx	;AN000;
  6753 000009DB 58                      	POP	AX			;>32mb  restore ax 	;AN000;
  6754 000009DC 7418                    	JZ	short old_style	; cf=0	;>32mb  no 		;AN000;
  6755                                  
  6756                                  	; 06/01/2024
  6757                                  	;push	ds
  6758                                  	;;getdseg <ds>
  6759                                  	;mov	ds,[cs:DosDSeg]
  6760                                  	;mov	word [AbsDskErr],207h	;>32mb  bad address mark
  6761                                  	;pop	ds
  6762                                  rw32_conv_err:
  6763 000009DE F9                      	STC				;>32mb			;AN000;
  6764 000009DF C3                      	retn				;>32mb			;AN000;
  6765                                  
  6766                                  new32format:
  6767                                  	;mov	dx,[bx+2]
  6768 000009E0 8B5702                  	MOV	DX,[BX+ABS_32RW.SECTOR_RBA+2] ;>32mb		;AN000;
  6769                                  
  6770 000009E3 1E                      	push	ds			; set up ds to DOSDATA
  6771                                  	;getdseg <ds>
  6772 000009E4 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  6773 000009E9 8916[0706]              	MOV	[HIGH_SECTOR],DX	;>32mb			;AN000;
  6774 000009ED 1F                      	pop	ds
  6775                                  
  6776 000009EE 8B17                    	mov	dx,[bx]
  6777                                  	;MOV	DX,[BX+ABS_32RW.SECTOR_RBA]  ;>32mb		;AN000;
  6778                                  	;mov	cx,[bx+4]
  6779 000009F0 8B4F04                  	MOV	CX,[BX+ABS_32RW.ABS_RW_COUNT] ;>32mb		;AN000;
  6780                                  	;lds	bx,[bx+6]
  6781 000009F3 C55F06                  	LDS	BX,[BX+ABS_32RW.BUFFER_ADDR] ;>32mb		;AN000;
  6782                                  old_style:				;>32mb			;AN000;
  6783                                  	; 06/01/2024
  6784                                  	; cf=0
  6785                                  	;CLC				;>32mb			;AN000;
  6786 000009F6 C3                      	retn				;>32mb			;AN000;
  6787                                  
  6788                                  ;------------------------------------------------------------------------
  6789                                  ;
  6790                                  ; Procedure Name : Fastxxx_Purge
  6791                                  ;
  6792                                  ; Input: None
  6793                                  ; Functions: Purge Fastopen/ Cache Buffers
  6794                                  ; Output: None
  6795                                  ;
  6796                                  ;------------------------------------------------------------------------
  6797                                  
  6798                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  6799                                  
  6800                                  Fastxxx_Purge:
  6801 000009F7 50                      	PUSH	AX			; save regs.	;AN000;
  6802 000009F8 56                      	PUSH	SI						;AN000;
  6803 000009F9 52                      	PUSH	DX						;AN000;
  6804                                  topen:
  6805 000009FA 1E                      	push	ds			; set up ds to DOSDATA
  6806                                  	;getdseg <ds>
  6807 000009FB 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  6808                                  
  6809 00000A00 F606[4611]80            	TEST	byte [FastOpenFlg],Fast_yes ; 80h 
  6810                                  					; fastopen installed ?	;AN000;
  6811 00000A05 1F                      	pop	ds
  6812 00000A06 740B                    	JZ	short nofast		; no			;AN000;
  6813 00000A08 B401                    	MOV	AH,FastOpen_ID	; 1				;AN000;
  6814                                  dofast:
  6815 00000A0A B005                    	MOV	AL,FONC_purge  ;5	; purge			;AN000;
  6816                                  	;;mov	dl,[es:bp+0]
  6817                                  	; 05/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  6818                                  	;MOV	DL,[ES:BP+DPB.DRIVE]	; set up drive number	;AN000;
  6819                                  	; 15/12/2022
  6820 00000A0C 268A5600                	mov	dl,[es:bp]
  6821                                  	;invoke	Fast_Dispatch		; call fastopen/seek	;AN000;
  6822 00000A10 E85E23                  	call	Fast_Dispatch
  6823                                  nofast:
  6824 00000A13 5A                      	POP	DX						;AN000;
  6825 00000A14 5E                      	POP	SI			; restore regs		;AN000;
  6826 00000A15 58                      	POP	AX			 			;AN000;
  6827 00000A16 C3                      	retn				; exit
  6828                                  
  6829                                  ;============================================================================
  6830                                  ; DOSMES.INC (MSDOS 6.0, 1991)
  6831                                  ;============================================================================
  6832                                  ; 29/04/2019 - Retro DOS v4.0
  6833                                  
  6834                                  ;include dossym.inc
  6835                                  ;include dosmac.inc
  6836                                  ;include doscntry.inc
  6837                                  
  6838                                  ; DOSCODE Segment
  6839                                  
  6840                                  ; 17/07/2018 - Retro DOS v3.0  [ DOSMES.INC (MSDOS 3.3, 1987) ]
  6841                                  ; ---------------------------------------------------------------------------
  6842                                  ;include divmes.inc
  6843                                  
  6844                                  ; DOSCODE:48C3h (PCDOS 7.1, IBMDOS.COM) - 06/04/2024 -
  6845                                  ; -------------------------------------
  6846                                  ; DOSCODE:4778h (MSDOS 6.21, MSDOS.SYS)
  6847                                  ; -------------------------------------
  6848                                  ; DOSCODE:476Bh (MSDOS 5.0, MSDOS.SYS) - 05/11/2022 -
  6849                                  
  6850                                  ; THIS IS THE ONLY DOS "MESSAGE". IT DOES NOT NEED A TERMINATOR.
  6851                                  	;PUBLIC	DIVMES
  6852                                  
  6853 00000A17 0D0A44697669646520-     DIVMES:	DB	13,10,"Divide overflow",13,10
  6853 00000A20 6F766572666C6F770D-
  6853 00000A29 0A                 
  6854                                  
  6855                                  	;PUBLIC	DivMesLen
  6856                                  DivMesLen:
  6857 00000A2A 1300                    	DW	$-DIVMES  ; 19	; Length of the above message in bytes
  6858                                  
  6859                                  ; DOSCODE:478Dh (MSDOS 6.21, MSDOS.SYS)
  6860                                  ; -------------------------------------
  6861                                  ; DOSCODE:4780h (MSDOS 5.0, MSDOS.SYS) - 05/11/2022 -
  6862                                  
  6863                                  ; (MSDOS 6.0)
  6864                                  ; VxD not found error message
  6865                                  
  6866                                  NoVxDErrMsg:
  6867 00000A2C 596F75206D75737420-     	db  'You must have the file WINA20.386 in the root of your boot drive'
  6867 00000A35 686176652074686520-
  6867 00000A3E 66696C652057494E41-
  6867 00000A47 32302E33383620696E-
  6867 00000A50 2074686520726F6F74-
  6867 00000A59 206F6620796F757220-
  6867 00000A62 626F6F742064726976-
  6867 00000A6B 65                 
  6868 00000A6C 0D0A746F2072756E20-     	db  0Dh,0Ah,'to run Windows in Enhanced Mode',0Dh,0Ah
  6868 00000A75 57696E646F77732069-
  6868 00000A7E 6E20456E68616E6365-
  6868 00000A87 64204D6F64650D0A   
  6869                                  
  6870                                  VxDMesLen equ $ - NoVxDErrMsg  ; 99
  6871                                  
  6872                                  ; 13/05/2019 - Retro DOS v4.0
  6873                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  6874                                  
  6875                                  ;include yesno.asm  (MNSDOS 6.0)
  6876                                  ; -------------------------------------
  6877                                  ; DOSCODE:47F0h (MSDOS 6.21, MSDOS.SYS)
  6878                                  ; DOSCODE:47E3h (MSDOS 5.0, MSDOS.SYS) - 05/11/2022 -
  6879                                  
  6880                                  ; This is for country Yes and No
  6881                                  
  6882                                  ; 06/01/2024 (Retro DOS 5.0 - PCDOS 7.1 IBMDOS.COM)
  6883                                  ;NLS_YES:	db 'Y'
  6884                                  ;NLS_NO:	db 'N'
  6885                                  ;NLS_yes2:	db 'y'
  6886                                  ;NLS_no2:	db 'n'
  6887                                  
  6888                                  ; ---------------------------------------------------------------------------
  6889                                  
  6890                                  ; DOSCODE:493Bh (PCDOS 7.1, IBMDOS.COM) - 06/04/2024 -
  6891                                  ; -------------------------------------
  6892                                  ; DOSCODE:47F4h (MSDOS 6.21, MSDOS.SYS)
  6893                                  ; DOSCODE:47E7h (MSDOS 5.0, MSDOS.SYS) - 05/11/2022 -
  6894                                  
  6895                                  ;SUBTTL EDIT FUNCTION ASSIGNMENTS AND HEADERS
  6896                                  
  6897                                  ; The following two tables implement the current buffered input editing
  6898                                  ; routines. The tables are pairwise associated in reverse order for ease
  6899                                  ; in indexing. That is; The first entry in ESCTAB corresponds to the last
  6900                                  ; entry in ESCFUNC, and the last entry in ESCTAB to the first entry in ESCFUNC.
  6901                                  
  6902                                  	;PUBLIC	CANCHAR
  6903                                  CANCHAR:
  6904 00000A8F 1B                      	DB	CANCEL	; 1Bh	;Cancel line character
  6905                                  	
  6906                                  	;PUBLIC	ESCCHAR
  6907                                  ESCCHAR:
  6908 00000A90 00                      	DB	ESCCH	; 0	;Lead-in character for escape sequences
  6909                                  	
  6910                                  	;IF	NOT Rainbow
  6911                                  
  6912                                  ESCTAB:	; LABEL BYTE
  6913                                  
  6914                                  	;IF	IBM
  6915 00000A91 40                      	DB	64		; Ctrl-Z - F6
  6916 00000A92 4D                      	DB	77		; Copy one char - -->
  6917 00000A93 3B                      	DB	59		; Copy one char - F1
  6918 00000A94 53                      	DB	83		; Skip one char - DEL
  6919 00000A95 3C                      	DB	60		; Copy to char - F2
  6920 00000A96 3E                      	DB	62		; Skip to char - F4
  6921 00000A97 3D                      	DB	61		; Copy line - F3
  6922 00000A98 3D                      	DB	61		; Kill line (no change to template ) - Not used
  6923 00000A99 3F                      	DB	63		; Reedit line (new template) - F5
  6924 00000A9A 4B                      	DB	75		; Backspace - <--
  6925 00000A9B 52                      	DB	82		; Enter insert mode - INS (toggle)
  6926 00000A9C 52                      	DB	82		; Exit insert mode - INS (toggle)
  6927 00000A9D 41                      	DB	65		; Escape character - F7
  6928 00000A9E 41                      	DB	65		; End of table
  6929                                  	;ENDIF
  6930                                  
  6931                                  ESCEND: ; LABEL BYTE
  6932                                  
  6933                                  ESCTABLEN EQU ESCEND-ESCTAB
  6934                                  
  6935                                  ESCFUNC: ; LABEL WORD
  6936                                  	
  6937 00000A9F [E119]                  	short_addr  GETCH	; Ignore the escape sequence
  6938 00000AA1 [5E1A]                  	short_addr  TWOESC
  6939 00000AA3 [531B]                  	short_addr  EXITINS
  6940 00000AA5 [531B]                  	short_addr  ENTERINS
  6941 00000AA7 [591A]                  	short_addr  BACKSP
  6942 00000AA9 [3F1B]                  	short_addr  REEDIT
  6943 00000AAB [461A]                  	short_addr  KILNEW
  6944 00000AAD [D51A]                  	short_addr  COPYLIN
  6945 00000AAF [071B]                  	short_addr  SKIPSTR
  6946 00000AB1 [DB1A]                  	short_addr  COPYSTR
  6947 00000AB3 [FE1A]                  	short_addr  SKIPONE
  6948 00000AB5 [E01A]                  	short_addr  COPYONE
  6949 00000AB7 [E01A]                  	short_addr  COPYONE
  6950 00000AB9 [5A1B]                  	short_addr  CTRLZ
  6951                                  
  6952                                  	;ENDIF
  6953                                  
  6954                                  ; DOSMES.INC (MSDOS 6.0, 1991)
  6955                                  ; ---------------------------------------------------------------------------
  6956                                  ; DOSMES.ASM (MSDOS 2.11, 1983)
  6957                                  
  6958                                  ; OEMFunction key is expected to process a single function
  6959                                  ;   key input from a device and dispatch to the proper
  6960                                  ;   routines leaving all registers UNTOUCHED.
  6961                                  ;
  6962                                  ; Inputs:   CS, SS are DOSGROUP
  6963                                  ; Outputs:  None. This function is expected to JMP to onw of
  6964                                  ;           the following labels:
  6965                                  ;
  6966                                  ;           GetCh       - ignore the sequence
  6967                                  ;           TwoEsc      - insert an ESCChar in the buffer
  6968                                  ;           ExitIns     - toggle insert mode
  6969                                  ;           EnterIns    - toggle insert mode
  6970                                  ;           BackSp      - move backwards one space
  6971                                  ;           ReEdit      - reedit the line with a new template
  6972                                  ;           KilNew      - discard the current line and start from scratch
  6973                                  ;           CopyLin     - copy the rest of the template into the line
  6974                                  ;           SkipStr     - read the next character and skip to it in the template
  6975                                  ;           CopyStr     - read next char and copy from template to line until char
  6976                                  ;           SkipOne     - advance position in template one character
  6977                                  ;           CopyOne     - copy next character in template into line
  6978                                  ;           CtrlZ       - place a ^Z into the template
  6979                                  ; Registers that are allowed to be modified by this function are:
  6980                                  ;           AX, CX, BP
  6981                                  
  6982                                  ; 13/05/2019 - Retro DOS v4.0
  6983                                  ; -------------------------------------
  6984                                  ; DOSCODE:4820h (MSDOS 6.21, MSDOS.SYS)
  6985                                  
  6986                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  6987                                  ; -------------------------------------
  6988                                  ; DOSCODE:4813h (MSDOS 5.0, MSDOS.SYS)
  6989                                  
  6990                                  ; 06/01/2024 - Retro DOS v5.0
  6991                                  ; -------------------------------------
  6992                                  ; DOSCODE:4967h (PCDOS 7.1, IBMDOS.COM)
  6993                                  
  6994                                  OEMFunctionKey:
  6995 00000ABB E8850E                  	CALL	_$STD_CON_INPUT_NO_ECHO	; Get the second byte of the sequence
  6996 00000ABE B10E                    	MOV     CL,ESCTABLEN ; 14	; length of table for scan
  6997 00000AC0 57                      	PUSH    DI                      ; save DI (cannot change it!)
  6998 00000AC1 BF[910A]                	MOV     DI,ESCTAB		; offset of second byte table
  6999 00000AC4 06                      	push	es
  7000 00000AC5 0E                      	push	cs
  7001 00000AC6 07                      	pop	es
  7002 00000AC7 F2AE                    	REPNE   SCASB                   ; Look it up in the table
  7003 00000AC9 07                      	pop	es
  7004 00000ACA 5F                      	POP     DI                      ; restore DI
  7005 00000ACB D1E1                    	SHL     CX,1                    ; convert byte offset to word
  7006 00000ACD 89CD                    	MOV     BP,CX                   ; move to indexable register
  7007                                  	;JMP	word [BP+ESCFUNC]	; Go to the right routine
  7008 00000ACF 2EFFA6[9F0A]            	JMP	word [CS:BP+ESCFUNC]
  7009                                  
  7010                                  ;DOSCODE ENDS
  7011                                  	
  7012                                  ;============================================================================
  7013                                  ; TIME.ASM (MSDOS 6.0, 1991)
  7014                                  ;============================================================================
  7015                                  ; Retro DOS v3.0 - 18/07/2018
  7016                                  
  7017                                  ; SYSCALL.ASM (MSDOS 2.11, 1983)
  7018                                  ;----------------------------------------------------------------------------
  7019                                  ; Retro DOS v2.0 - 13/03/2018
  7020                                  
  7021                                  ;**	TIME.ASM - System Calls and low level routines for DATE and TIME
  7022                                  
  7023                                  	;BREAK <DATE AND TIME - SYSTEM CALLS 42,43,44,45>
  7024                                  
  7025                                  ;**	$GET_DATE - Get Current Date
  7026                                  ;----------------------------------------
  7027                                  ;	ENTRY	none
  7028                                  ;	EXIT	(cx:dx) = current date
  7029                                  ;	USES	all
  7030                                  
  7031                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  7032                                  ; 06/01/2024 - Retro DOS v5.0 (Modified MSDOS 7.1 IBMDOS.COM)	
  7033                                  
  7034                                  _$GET_DATE:	;System call 42
  7035                                  
  7036 00000AD4 16                      	PUSH	SS
  7037 00000AD5 1F                      	POP	DS
  7038 00000AD6 E8AD00                  	CALL	READTIME	;Check for rollover to next day
  7039 00000AD9 A1[5203]                	MOV	AX,[YEAR]
  7040                                  
  7041                                  ;	WARNING!!!! DAY and MONTH must be adjacently allocated!
  7042                                  
  7043 00000ADC 8B1E[5003]              	MOV	BX,[DAY]	; fetch both day and month
  7044 00000AE0 E894F9                  	CALL	Get_User_Stack	;Get pointer to user registers
  7045                                  	;MOV	[SI+6],BX	;DH=month, DL=day
  7046 00000AE3 895C06                  	MOV	[SI+user_env.user_DX],BX
  7047 00000AE6 05BC07                  	ADD	AX,1980		;Put bias back
  7048                                  	;MOV	[SI+4],AX	;CX=year
  7049 00000AE9 894404                  	MOV	[SI+user_env.user_CX],AX
  7050 00000AEC 36A0[5603]              	MOV	AL,[SS:WEEKDAY]	;hkn; SS override
  7051                                  RET20:	; 05/11/2022
  7052                                  RET24:	; 18/12/2022
  7053 00000AF0 C3                      	RETN
  7054                                  
  7055                                  ;**	$SET_DATE - Set Current Date
  7056                                  ;----------------------------------------
  7057                                  ;	ENTRY	(cx:dx) = current date
  7058                                  ;	EXIT	(al) = -1 iff bad date
  7059                                  ;		(al) = 0 if ok
  7060                                  ;	USES	all
  7061                                  
  7062                                  _$SET_DATE:	;System call 43
  7063                                  
  7064 00000AF1 B0FF                    	MOV	AL,-1		;Be ready to flag error
  7065 00000AF3 81E9BC07                	SUB	CX,1980		;Fix bias in year
  7066                                  	;JC	SHORT RET24	;Error if not big enough
  7067                                  	; 05/11/2022
  7068 00000AF7 72F7                    	jc	short RET20
  7069 00000AF9 83F977                  	CMP	CX,119		;Year must be less than 2100
  7070 00000AFC 77F2                    	JA	SHORT RET24
  7071 00000AFE 08F6                    	OR	DH,DH
  7072                                  	;JZ	SHORT RET24
  7073                                   	; 05/11/2022
  7074 00000B00 74EE                    	jz	short RET20
  7075 00000B02 08D2                    	OR	DL,DL
  7076                                  	;JZ	SHORT RET24	;Error if either month or day is 0
  7077                                  	; 05/11/2022
  7078 00000B04 74EA                    	jz	short RET20
  7079 00000B06 80FE0C                  	CMP	DH,12		;Check against max. month
  7080 00000B09 77E5                    	JA	SHORT RET24
  7081 00000B0B 16                      	PUSH	SS
  7082 00000B0C 1F                      	POP	DS
  7083                                  	;CALL	DODATE
  7084                                  	; 18/12/2022
  7085 00000B0D E90301                  	jmp	DODATE
  7086                                  ;RET24:  
  7087                                  	;RETN
  7088                                  
  7089                                  ;**	$GET_TIME - Get Current Time
  7090                                  ;----------------------------------------
  7091                                  ;	ENTRY	none
  7092                                  ;	EXIT	(cx:dx) = current time
  7093                                  ;	USES	all
  7094                                  
  7095                                  _$GET_TIME:			;System call 44
  7096                                  
  7097 00000B10 16                      	PUSH	SS
  7098 00000B11 1F                      	POP	DS
  7099 00000B12 E87100                  	CALL	READTIME
  7100 00000B15 E85FF9                  	CALL	Get_User_Stack	;Get pointer to user registers
  7101                                  	;MOV	[SI+6],DX
  7102 00000B18 895406                  	MOV	[SI+user_env.user_DX],DX
  7103                                  	;MOV	[SI+4],CX
  7104 00000B1B 894C04                  	MOV	[SI+user_env.user_CX],CX
  7105                                  set_time_ok:	; 06/01/2024
  7106 00000B1E 30C0                    	XOR	AL,AL
  7107                                  RET26:  
  7108 00000B20 C3                      	RETN
  7109                                  
  7110                                  ;**	$SET_TIME - Set Current Time
  7111                                  ;----------------------------------------
  7112                                  ;	ENTRY	(cx:dx) = time
  7113                                  ;	EXIT	(al) = 0 if 0k
  7114                                  ;		(al) = -1 if invalid
  7115                                  ;	USES	ALL
  7116                                  
  7117                                  _$SET_TIME:			;System call 45
  7118                                  
  7119 00000B21 B0FF                    	MOV	AL,-1		;Flag in case of error
  7120 00000B23 80FD18                  	CMP	CH,24		;Check hours
  7121 00000B26 73F8                    	JAE	SHORT RET26
  7122 00000B28 80F93C                  	CMP	CL,60		;Check minutes
  7123 00000B2B 73F3                    	JAE	SHORT RET26
  7124 00000B2D 80FE3C                  	CMP	DH,60		;Check seconds
  7125 00000B30 73EE                    	JAE	SHORT RET26
  7126 00000B32 80FA64                  	CMP	DL,100		;Check 1/100's
  7127 00000B35 73E9                    	JAE	SHORT RET26
  7128 00000B37 51                      	PUSH	CX
  7129 00000B38 52                      	PUSH	DX
  7130 00000B39 16                      	PUSH	SS
  7131 00000B3A 1F                      	POP	DS
  7132                                  
  7133                                  ; 07/02/2024
  7134                                  %if 0
  7135                                  	MOV	BX,TIMEBUF
  7136                                  	MOV	CX,6
  7137                                  	; 06/02/2024 ; *
  7138                                  	;;XOR	DX,DX
  7139                                  	;;MOV	AX,DX
  7140                                  	;xor	ax,ax
  7141                                  	;cwd	; 06/01/2024
  7142                                  	PUSH	BX
  7143                                  	;CALL	SETREAD
  7144                                  	; 06/02/2024 ; *
  7145                                  	call	SETREAD_X
  7146                                  %else
  7147 00000B3B E8F047                  	call	SETREAD_XT
  7148                                  %endif
  7149                                  
  7150 00000B3E 1E                      	PUSH	DS
  7151 00000B3F C536[2E00]              	LDS	SI,[BCLOCK]
  7152 00000B43 E87147                  	CALL	DEVIOCALL2	;Get correct day count
  7153 00000B46 1F                      	POP	DS
  7154 00000B47 5B                      	POP	BX
  7155 00000B48 E82048                  	CALL	SETWRITE
  7156 00000B4B 8F06[BA03]              	POP	WORD [TIMEBUF+4]
  7157 00000B4F 8F06[B803]              	POP	WORD [TIMEBUF+2]
  7158 00000B53 C536[2E00]              	LDS	SI,[BCLOCK]
  7159 00000B57 E85D47                  	CALL	DEVIOCALL2	;Set the time
  7160                                  	; 06/01/2024
  7161                                  	;XOR	AL,AL
  7162                                  	;RETN
  7163 00000B5A EBC2                    	jmp	short set_time_ok
  7164                                  
  7165                                  ; 11/07/2018 - Retro DOS v3.0
  7166                                  ; Retro DOS v2.0 - 14/03/2018
  7167                                  
  7168                                  FOURYEARS EQU 3*365 + 366  ; = 1461 
  7169                                  
  7170                                  ;SUBTTL DATE16, READTIME, DODATE -- GUTS OF TIME AND DATE
  7171                                  ;----------------------------------------------------------
  7172                                  ; Date16 returns the current date in AX, current time in DX
  7173                                  ;   AX - YYYYYYYMMMMDDDDD  years months days
  7174                                  ;   DX - HHHHHMMMMMMSSSSS  hours minutes seconds/2
  7175                                  
  7176                                  DATE16:
  7177                                  	
  7178                                  ;M048	Context DS
  7179                                  ;
  7180                                  ; Since this function can be called thru int 2f we shall not assume that SS
  7181                                  ; is DOSDATA
  7182                                  
  7183                                  	;push	ss
  7184                                  	;pop	ds
  7185                                  
  7186                                  	;getdseg <ds>		; M048
  7187                                  
  7188                                  	; 13/05/2019 - Retro DOS v4.0
  7189 00000B5C 2E8E1E[0700]            	mov	ds, [cs:DosDSeg]	
  7190                                  
  7191 00000B61 51                      	PUSH	CX
  7192 00000B62 06                      	PUSH	ES
  7193 00000B63 E82000                  	CALL	READTIME
  7194 00000B66 07                      	POP	ES
  7195 00000B67 D0E1                    	SHL	CL,1		;Minutes to left part of byte
  7196 00000B69 D0E1                    	SHL	CL,1
  7197 00000B6B D1E1                    	SHL	CX,1		;Push hours and minutes to left end
  7198 00000B6D D1E1                    	SHL	CX,1
  7199 00000B6F D1E1                    	SHL	CX,1
  7200 00000B71 D0EE                    	SHR	DH,1		;Count every two seconds
  7201 00000B73 08F1                    	OR	CL,DH		;Combine seconds with hours and minutes
  7202 00000B75 89CA                    	MOV	DX,CX
  7203                                  
  7204                                  ;	WARNING! MONTH and YEAR must be adjacently allocated
  7205                                  
  7206 00000B77 A1[5103]                	MOV	AX,[MONTH]	;Fetch month and year
  7207 00000B7A B104                    	MOV	CL,4
  7208 00000B7C D2E0                    	SHL	AL,CL		;Push month to left to make room for day
  7209 00000B7E D1E0                    	SHL	AX,1
  7210 00000B80 59                      	POP	CX
  7211 00000B81 0A06[5003]              	OR	AL,[DAY]
  7212                                  RET21:
  7213 00000B85 C3                      	RETN
  7214                                  
  7215                                  ;----------------------------------------------------------
  7216                                  
  7217                                  READTIME:
  7218                                  
  7219                                  ;Gets time in CX:DX. Figures new date if it has changed.
  7220                                  ;Uses AX, CX, DX.
  7221                                  
  7222 00000B86 C706[BD0D]0000          	MOV	word [DATE_FLAG],0 ; reset date flag for CPMIO
  7223 00000B8C 56                      	PUSH	SI
  7224 00000B8D 53                      	PUSH	BX
  7225                                  
  7226 00000B8E BB[B603]                	MOV	BX,TIMEBUF
  7227                                  ; 07/02/2024
  7228                                  %if 0
  7229                                  	MOV	CX,6
  7230                                  	; 06/02/2024
  7231                                  	;;XOR	DX,DX
  7232                                  	;;MOV	AX,DX
  7233                                  	;; 06/01/2024
  7234                                  	;xor	ax,ax
  7235                                  	;cwd
  7236                                  	;CALL	SETREAD
  7237                                  	; 06/02/2024
  7238                                  	call	SETREAD_X
  7239                                  %else
  7240 00000B91 E89E47                  	call	SETREAD_XTC
  7241                                  %endif
  7242 00000B94 1E                      	PUSH	DS
  7243 00000B95 C536[2E00]              	LDS	SI,[BCLOCK]
  7244 00000B99 E81B47                  	CALL	DEVIOCALL2	;Get correct date and time
  7245 00000B9C 1F                      	POP	DS
  7246 00000B9D 5B                      	POP	BX
  7247 00000B9E 5E                      	POP	SI
  7248 00000B9F A1[B603]                	MOV	AX,[TIMEBUF]
  7249 00000BA2 8B0E[B803]              	MOV	CX,[TIMEBUF+2]
  7250 00000BA6 8B16[BA03]              	MOV	DX,[TIMEBUF+4]
  7251 00000BAA 3B06[5403]              	CMP	AX,[DAYCNT]	;See if day count is the same
  7252                                  	;JZ	SHORT RET22
  7253 00000BAE 74D5                    	JZ	SHORT RET21 ; 18/07/2018
  7254                                  	;cmp	ax,43830
  7255 00000BB0 3D36AB                  	CMP	AX,FOURYEARS*30 ;Number of days in 120 years
  7256 00000BB3 733D                    	JAE	SHORT RET22	;Ignore if too large
  7257 00000BB5 A3[5403]                	MOV	[DAYCNT],AX
  7258 00000BB8 56                      	PUSH	SI
  7259 00000BB9 51                      	PUSH	CX
  7260 00000BBA 52                      	PUSH	DX		;Save time
  7261 00000BBB 31D2                    	XOR	DX,DX
  7262                                  	;mov	cx,1461
  7263 00000BBD B9B505                  	MOV	CX,FOURYEARS	;Number of days in 4 years
  7264 00000BC0 F7F1                    	DIV	CX		;Compute number of 4-year units
  7265 00000BC2 D1E0                    	SHL	AX,1
  7266 00000BC4 D1E0                    	SHL	AX,1
  7267 00000BC6 D1E0                    	SHL	AX,1		;Multiply by 8 (no. of half-years)
  7268 00000BC8 89C1                    	MOV	CX,AX		;<240 implies AH=0
  7269                                  
  7270 00000BCA BE[140D]                	MOV	SI,YRTAB	;Table of days in each year
  7271                                  
  7272 00000BCD E82300                  	CALL	DSLIDE		;Find out which of four years we're in
  7273 00000BD0 D1E9                    	SHR	CX,1		;Convert half-years to whole years
  7274 00000BD2 7304                    	JNC	SHORT SK	;Extra half-year?
  7275 00000BD4 81C2C800                	ADD	DX,200
  7276                                  SK:
  7277 00000BD8 E82200                  	CALL	SETYEAR
  7278 00000BDB B101                    	MOV	CL,1		;At least at first month in year
  7279                                  
  7280 00000BDD BE[1C0D]                	MOV	SI,MONTAB	;Table of days in each month
  7281                                  	
  7282 00000BE0 E81000                  	CALL	DSLIDE		;Find out which month we're in
  7283 00000BE3 880E[5103]              	MOV	[MONTH],CL
  7284 00000BE7 42                      	INC	DX		;Remainder is day of month (start with one)
  7285 00000BE8 8816[5003]              	MOV	[DAY],DL
  7286 00000BEC E88A00                  	CALL	WKDAY		;Set day of week
  7287 00000BEF 5A                      	POP	DX
  7288 00000BF0 59                      	POP	CX
  7289 00000BF1 5E                      	POP	SI
  7290                                  RET22:  
  7291 00000BF2 C3                      	RETN
  7292                                  
  7293                                  ;----------------------------------------------------------
  7294                                  
  7295                                  DSLIDE:
  7296                                  	;MOV	AH,0
  7297                                  	; 06/01/2024
  7298                                  	; (AH=0)
  7299                                  DSLIDE1:
  7300 00000BF3 AC                      	LODSB			;Get count of days
  7301 00000BF4 39C2                    	CMP	DX,AX		;See if it will fit
  7302                                  	;JB	SHORT RET23	;If not, done
  7303 00000BF6 72FA                    	jb	short RET22 ; 13/05/2019 - Retro DOS v4.0
  7304 00000BF8 29C2                    	SUB	DX,AX
  7305 00000BFA 41                      	INC	CX		;Count one more month/year
  7306 00000BFB EBF6                    	JMP	SHORT DSLIDE1
  7307                                  
  7308                                  ;----------------------------------------------------------
  7309                                  
  7310                                  SETYEAR:
  7311                                  
  7312                                  ;Set year with value in CX. Adjust length of February for this year.
  7313                                  
  7314                                  ; NOTE: This can also be called thru int 2f. If this is called then it will
  7315                                  ;	  set DS to DOSDATA. Since the only guy calling this should be the DOS
  7316                                  ;	redir, DS will be DOSDATA anyway. It is going to be in-efficient to
  7317                                  ;	preserve DS as CHKYR is also called as a routine.
  7318                                  
  7319                                  	; MSDOS 6.0 (18/07/2018) ; *
  7320                                  
  7321                                  	;GETDSEG DS
  7322                                  
  7323                                  	;PUSH	CS  ; *
  7324                                  	;POP	DS  ; *
  7325                                  
  7326                                  	; 13/05/2019 - Retro DOS v4.0
  7327 00000BFD 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  7328                                  
  7329                                  	; Offset 18CEh in IBMDOS.COM (MSDOS 3.3), 1987
  7330                                  	; 05/11/2022 
  7331                                  	; DOSCODE:4970h in MSDOS.SYS (MSDOS 5.0), 1991 
  7332                                  
  7333 00000C02 880E[5203]              	MOV	[YEAR],CL
  7334                                  CHKYR:
  7335 00000C06 F6C103                  	TEST	CL,3		;Check for leap year
  7336 00000C09 B01C                    	MOV	AL,28
  7337 00000C0B 7502                    	JNZ	SHORT SAVFEB	;28 days if no leap year
  7338 00000C0D FEC0                    	INC	AL		;Add leap day
  7339                                  SAVFEB:
  7340 00000C0F A2[1D0D]                	mov	[february],al
  7341                                  	;MOV	[MONTAB+1],AL	;Store for February
  7342                                  RET23:  
  7343 00000C12 C3                      	RETN
  7344                                  
  7345                                  ;----------------------------------------------------------
  7346                                  
  7347                                  DODATE:
  7348 00000C13 E8F0FF                  	CALL	CHKYR		;Set Feb. up for new year
  7349 00000C16 88F0                    	MOV	AL,DH
  7350                                  
  7351 00000C18 BB[1B0D]                	MOV	BX,MONTAB-1	;DOSDATA:0D1Bh for MSDOS 6.21
  7352                                  				; 06/01/2024
  7353                                  				;DOSDATA:0D1Bh for PCDOS 7.1 
  7354                                  
  7355 00000C1B D7                      	XLAT			;Look up days in month
  7356 00000C1C 38D0                    	CMP	AL,DL
  7357 00000C1E B0FF                    	MOV	AL,-1		;Restore error flag, just in case
  7358                                  	;JB	SHORT RET25	;Error if too many days
  7359 00000C20 72F0                    	jb	short RET23 ; 18/07/2018
  7360 00000C22 E8D8FF                  	CALL	SETYEAR
  7361                                  ;
  7362                                  ; WARNING! DAY and MONTH must be adjacently allocated
  7363                                  ;
  7364 00000C25 8916[5003]              	MOV	[DAY],DX	;Set both day and month
  7365 00000C29 D1E9                    	SHR	CX,1
  7366 00000C2B D1E9                    	SHR	CX,1
  7367                                  	;mov	ax,1461
  7368 00000C2D B8B505                  	MOV	AX,FOURYEARS
  7369 00000C30 89D3                    	MOV	BX,DX
  7370 00000C32 F7E1                    	MUL	CX
  7371 00000C34 8A0E[5203]              	MOV	CL,[YEAR]
  7372 00000C38 80E103                  	AND	CL,3
  7373                                  
  7374 00000C3B BE[140D]                	MOV	SI,YRTAB
  7375                                  
  7376 00000C3E 89C2                    	MOV	DX,AX
  7377 00000C40 D1E1                    	SHL	CX,1		;Two entries per year, so double count
  7378 00000C42 E84700                  	CALL	DSUM		;Add up the days in each year
  7379 00000C45 88F9                    	MOV	CL,BH		;Month of year
  7380                                  
  7381 00000C47 BE[1C0D]                	MOV	SI,MONTAB
  7382                                  
  7383 00000C4A 49                      	DEC	CX		;Account for months starting with one
  7384 00000C4B E83E00                  	CALL	DSUM		;Add up days in each month
  7385 00000C4E 88D9                    	MOV	CL,BL		;Day of month
  7386 00000C50 49                      	DEC	CX		;Account for days starting with one
  7387 00000C51 01CA                    	ADD	DX,CX		;Add in to day total
  7388 00000C53 92                      	XCHG	AX,DX		;Get day count in AX
  7389 00000C54 A3[5403]                	MOV	[DAYCNT],AX
  7390 00000C57 56                      	PUSH	SI
  7391 00000C58 53                      	PUSH	BX
  7392 00000C59 50                      	PUSH	AX
  7393                                  
  7394                                  ; 07/02/2024
  7395                                  %if 0
  7396                                  	MOV	BX,TIMEBUF
  7397                                  	MOV	CX,6
  7398                                  	; 06/02/2024 ; *
  7399                                  	;;XOR	DX,DX
  7400                                  	;;MOV	AX,DX
  7401                                  	;; 06/01/2024
  7402                                  	;xor	ax,ax
  7403                                  	;cwd
  7404                                  	PUSH	BX
  7405                                  	;CALL	SETREAD
  7406                                  	; 06/02/2024 ; *
  7407                                  	call	SETREAD_X
  7408                                  %else
  7409 00000C5A E8D146                  	call	SETREAD_XT
  7410                                  %endif
  7411                                  
  7412 00000C5D 1E                      	PUSH	DS
  7413 00000C5E C536[2E00]              	LDS	SI,[BCLOCK]
  7414 00000C62 E85246                  	CALL	DEVIOCALL2	;Get correct date and time
  7415 00000C65 1F                      	POP	DS
  7416 00000C66 5B                      	POP	BX
  7417 00000C67 E80147                  	CALL	SETWRITE
  7418 00000C6A 8F06[B603]              	POP	WORD [TIMEBUF]
  7419 00000C6E 1E                      	PUSH	DS
  7420 00000C6F C536[2E00]              	LDS	SI,[BCLOCK]
  7421 00000C73 E84146                  	CALL	DEVIOCALL2	;Set the date
  7422 00000C76 1F                      	POP	DS
  7423 00000C77 5B                      	POP	BX
  7424 00000C78 5E                      	POP	SI
  7425                                  WKDAY:
  7426 00000C79 A1[5403]                	MOV	AX,[DAYCNT]
  7427 00000C7C 31D2                    	XOR	DX,DX
  7428 00000C7E B90700                  	MOV	CX,7
  7429 00000C81 40                      	INC	AX
  7430 00000C82 40                      	INC	AX		;First day was Tuesday
  7431 00000C83 F7F1                    	DIV	CX		;Compute day of week
  7432 00000C85 8816[5603]              	MOV	[WEEKDAY],DL
  7433 00000C89 30C0                    	XOR	AL,AL		;Flag OK
  7434                                  RET25:
  7435 00000C8B C3                      	RETN
  7436                                  
  7437                                  ;----------------------------------------------------------
  7438                                  
  7439                                  ;**	DSUM - Compute the sum of a string of bytes
  7440                                  ;
  7441                                  ;	ENTRY	(cx) = byte count
  7442                                  ;		(ds:si) = byte address
  7443                                  ;		(dx) = sum register, initialized by caller
  7444                                  ;	EXIT	(dx) updated
  7445                                  ;	USES	ax, cx, dx, si, flags
  7446                                  
  7447                                  DSUM:
  7448 00000C8C B400                    	MOV	AH,0
  7449 00000C8E E305                    	JCXZ	DSUM9 ; 13/05/2019 - Retro DOS v4.0
  7450                                  	;JCXZ	RET25 ; 18/07/2018
  7451                                  DSUM1:
  7452 00000C90 AC                      	LODSB
  7453 00000C91 01C2                    	ADD	DX,AX
  7454 00000C93 E2FB                    	LOOP	DSUM1
  7455                                  DSUM9:
  7456 00000C95 C3                      	RETN
  7457                                  
  7458                                  ;============================================================================
  7459                                  ; GETSET.ASM (MSDOS 6.0, 1991)
  7460                                  ;============================================================================
  7461                                  ; 29/04/2019 - Retro DOS v4.0
  7462                                  ; 18/07/2018 - Retro DOS v3.0 (GETSET.ASM, MSDOS 6.0, 1991)
  7463                                  
  7464                                  ; 12/03/2018 - Retro DOS v2.0 
  7465                                  
  7466                                  ;TITLE	GETSET - GETting and SETting MS-DOS system calls
  7467                                  ;NAME	GETSET
  7468                                  
  7469                                  ;CODE	SEGMENT BYTE PUBLIC  'CODE'
  7470                                  ;       ASSUME  SS:DOSGROUP,CS:DOSGROUP
  7471                                  
  7472                                  ;USERNUM:
  7473                                  ;	DW	0			; 24 bit user number
  7474                                  ;       DB      0
  7475                                  ;;	IF      IBM
  7476                                  ;;OEMNUM: DB    0			; 8 bit OEM number
  7477                                  ;;	ELSE
  7478                                  ;OEMNUM: DB     0FFH			; 8 bit OEM number
  7479                                  ;;	ENDIF
  7480                                  
  7481                                  ;MSVERS:		; MS-DOS version in hex for $GET_VERSION
  7482                                  ;; 08/07/2018 - Retro DOS v3.0
  7483                                  ;MSMAJOR: DB	MAJOR_VERSION	; DOS_MAJOR_VERSION
  7484                                  ;MSMINOR: DB	MINOR_VERSION	; DOS_MINOR_VERSION  
  7485                                  
  7486                                  ;BREAK <$Get_Version -- Return MSDOS version number>
  7487                                  ;----------------------------------------------------------------------------
  7488                                  
  7489                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  7490                                  ; DOSCODE:4A0Fh (MSDOS 5.0 MSDOS.SYS)
  7491                                  
  7492                                  ; 06/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  7493                                  ; DOSCODE:4B5Fh (PCDOS 7.1 IBMDOS.COM)
  7494                                  
  7495                                  _$GET_VERSION:
  7496                                  
  7497                                  ; Inputs:
  7498                                  ;       None
  7499                                  ; Function:
  7500                                  ;       Return MS-DOS version number
  7501                                  ; Outputs:
  7502                                  ;       OEM number in BH
  7503                                  ;       User number in BL:CX (24 bits)
  7504                                  ;       Version number as AL.AH in binary
  7505                                  ;       NOTE: On pre 1.28 DOSs AL will be zero
  7506                                  
  7507                                  ; MSDOS 6.0
  7508                                  ;
  7509                                  ;	Fake_Count is used to lie about the version numbers to support
  7510                                  ;	old binarys. See ms_table.asm for more info.
  7511                                  ;
  7512                                  ;		if input al = 00
  7513                                  ;		  (bh) = OEM number			
  7514                                  ;		else if input al = 01
  7515                                  ;		  (bh) = version flags
  7516                                  ;		 
  7517                                  ;		       	 bits 0-2 = DOS internal revision
  7518                                  ;		       	 bits 3-7 = DOS type flags
  7519                                  ;		              bit 3    = DOS is in ROM
  7520                                  ;		              bit 4    = DOS in in HMA
  7521                                  ;		              bits 5-7 = reserved
  7522                                  ;               M007 change - only bit 3 is now valid. Other bits
  7523                                  ;               are 0 when AL = 1
  7524                                  
  7525                                  	; 06/01/2024 (PCDOS 7.1 IBMDOS.COM)
  7526 00000C96 36C50E[B203]            	lds	cx, [ss:USERNUM]
  7527 00000C9B 8CDB                    	mov	bx, ds
  7528                                  
  7529                                  	; MSDOS 3.3 (IBMDOS.COM, offset 196Dh)
  7530                                  	;--------------------------------------
  7531                                  	; MSDOS 6.21 (MSDOS.SYS, DOSCODE:4A1Ch)
  7532                                  
  7533 00000C9D 16                              PUSH    SS
  7534 00000C9E 1F                              POP     DS
  7535                                          
  7536                                  	; 06/01/2024
  7537                                  	;MOV	BX,[USERNUM+2]
  7538                                          ;MOV	CX,[USERNUM]
  7539                                  
  7540                                  	; 13/05/2019 - Retro DOS v4.0
  7541                                  
  7542                                  	;If AL == 1, ROMDOS will return BH = dos internal version # &
  7543                                  	;DOS flags
  7544                                  
  7545 00000C9F 3C01                    	cmp	AL,1
  7546 00000CA1 7502                    	jne	short Norm_Vers
  7547                                  
  7548                                  ;ifdef ROMDOS
  7549                                  ;	mov	BH,DOSINROM 	; Just set the bit for ROM version
  7550                                  ;				(DOSINROM = 8)
  7551                                  ;else
  7552 00000CA3 30FF                            xor     bh,bh		; Otherwise return 0
  7553                                  ;endif				;M007 end
  7554                                  
  7555                                  Norm_Vers:
  7556                                  	;MOV	AX,[MSVERS]  ; MSDOS 3.3
  7557                                  
  7558                                          	; MSDOS 6.0	; MSVERS is a label in TABLE segment	
  7559                                  	; 13/05/2019 - Retro DOS v4.0
  7560 00000CA5 1E                      	push	ds		; Get the version number from the
  7561 00000CA6 8E1E[3003]              	mov	ds,[CurrentPDB]	; current app's PSP segment
  7562                                  	;mov	ax,[40h]
  7563 00000CAA A14000                  	mov	ax,[PDB.Version] ; AX = DOS version number	
  7564                                  	; 07/12/2022
  7565 00000CAD 1F                      	pop	ds
  7566 00000CAE E8C6F7                  	call	Get_User_Stack
  7567                                  				; Put values for return registers
  7568                                  				; in the proper place on the user's	 
  7569                                  				; stack addressed by DS:SI
  7570                                  	; 06/01/2024 (PCDOS 7.1 IBMDOS.COM)
  7571                                  gdrvfspc_ret:
  7572                                          ;MOV	[SI+user_env.user_AX],AX
  7573 00000CB1 8904                            MOV	[SI],AX
  7574                                          ;MOV	[SI+4],CX
  7575 00000CB3 894C04                  	mov	[SI+user_env.user_CX],CX
  7576                                  set_user_bx:
  7577                                  	;MOV	[SI+2],BX
  7578 00000CB6 895C02                  	mov	[SI+user_env.user_BX],BX
  7579                                  
  7580 00000CB9 C3                      	RETN
  7581                                  
  7582                                  ; 18/07/2018 - Retro DOS v3.0
  7583                                  
  7584                                  ;BREAK <$Get/Set_Verify_on_Write - return/set verify-after-write flag>
  7585                                  ;----------------------------------------------------------------------------
  7586                                  
  7587                                  ;**	$Get_Verify_On_Write - Get Status of Verify on write flag
  7588                                  ;
  7589                                  ;	ENTRY	none
  7590                                  ;	EXIT	(al) = value of VERIFY flag
  7591                                  ;	USES	all
  7592                                  
  7593                                  
  7594                                  _$GET_VERIFY_ON_WRITE:
  7595                                  
  7596                                  ;hkn; SS override
  7597 00000CBA 36A0[FF02]              	MOV	AL,[SS:VERFLG]	; Retro DOS v2.0 - 12/03/2018
  7598 00000CBE C3                      	retn
  7599                                  
  7600                                  ;**	$Set_Verify_On_Write - Set Status of Verify on write flag
  7601                                  ;
  7602                                  ;	ENTRY	(al) = value of VERIFY flag
  7603                                  ;	EXIT	none
  7604                                  ;	USES	all
  7605                                  
  7606                                  _$SET_VERIFY_ON_WRITE:
  7607                                  
  7608 00000CBF 2401                    	AND	AL,1
  7609                                  ;hkn; SS override
  7610 00000CC1 36A2[FF02]              	MOV	[SS:VERFLG],AL	; Retro DOS v2.0 - 12/03/2018
  7611                                  RET27:	; 18/07/2018
  7612 00000CC5 C3                      	retn
  7613                                  
  7614                                  ; 19/07/2018 - Retro DOS v3.0
  7615                                  
  7616                                  ;BREAK <$International - return country-dependent information>
  7617                                  ;----------------------------------------------------------------------------
  7618                                  ;
  7619                                  ; Procedure Name : $INTERNATIONAL
  7620                                  ;
  7621                                  ; Inputs:
  7622                                  ;	MOV	AH,International
  7623                                  ;	MOV	AL,country	(al = 0 => current country)
  7624                                  ;      [MOV	BX,country]
  7625                                  ;	LDS	DX,block
  7626                                  ;	INT	21
  7627                                  ; Function:
  7628                                  ;	give users an idea of what country the application is running
  7629                                  ; Outputs:
  7630                                  ;	IF DX != -1 on input (get country)
  7631                                  ;	  AL = 0 means return current country table.
  7632                                  ;	  0<AL<0FFH means return country table for country AL
  7633                                  ;	  AL = 0FF means return country table for country BX
  7634                                  ;	  No Carry:
  7635                                  ;	     Register BX will contain the 16-bit country code.
  7636                                  ;	     Register AL will contain the low 8 bits of the country code.
  7637                                  ;	     The block pointed to by DS:DX is filled in with the information
  7638                                  ;	     for the particular country.
  7639                                  ;		BYTE  Size of this table excluding this byte and the next
  7640                                  ;		BYTE  Country code represented by this table
  7641                                  ;			A sequence of n bytes, where n is the number specified
  7642                                  ;			by the first byte above and is not > internat_block_max,
  7643                                  ;			in the correct order for being returned by the
  7644                                  ;			INTERNATIONAL call as follows:
  7645                                  ;		WORD	Date format 0=mdy, 1=dmy, 2=ymd
  7646                                  ;		5 BYTE	Currency symbol null terminated
  7647                                  ;		2 BYTE	thousands separator null terminated
  7648                                  ;		2 BYTE	Decimal point null terminated
  7649                                  ;		2 BYTE	Date separator null terminated
  7650                                  ;		2 BYTE	Time separator null terminated
  7651                                  ;		1 BYTE	Bit field.  Currency format.
  7652                                  ;			Bit 0.	=0 $ before #  =1 $ after #
  7653                                  ;			Bit 1.	no. of spaces between # and $ (0 or 1)
  7654                                  ;		1 BYTE	No. of significant decimal digits in currency
  7655                                  ;		1 BYTE	Bit field.  Time format.
  7656                                  ;			Bit 0.	=0 12 hour clock  =1 24 hour
  7657                                  ;		DWORD	Call address of case conversion routine
  7658                                  ;		2 BYTE	Data list separator null terminated.
  7659                                  ;	  Carry:
  7660                                  ;	     Register AX has the error code.
  7661                                  ;	IF DX = -1 on input (set current country)
  7662                                  ;	  AL = 0 is an error
  7663                                  ;	  0<AL<0FFH means set current country to country AL
  7664                                  ;	  AL = 0FF means set current country to country BX
  7665                                  ;	  No Carry:
  7666                                  ;	    Current country SET
  7667                                  ;	    Register AL will contain the low 8 bits of the country code.
  7668                                  ;	  Carry:
  7669                                  ;	     Register AX has the error code.
  7670                                  ;-----------------------------------------------------------------------------
  7671                                  
  7672                                  ;procedure   $INTERNATIONAL,NEAR   ; DOS 3.3
  7673                                  
  7674                                  ; 13/05/2019 - Retro DOS v4.0
  7675                                  ; DOSCODE:4A4Dh (MSDOS 6.21, MSDOS.SYS)
  7676                                  
  7677                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  7678                                  ; DOSCODE:4A40h (MSDOS 5.0, MSDOS.SYS)
  7679                                  
  7680                                  ; 06/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 PCDOS.COM)
  7681                                  ; DOSCODE:4B8Dh (PCDOS 7.1, IBMDOS.COM)
  7682                                  
  7683                                  _$INTERNATIONAL:  ; IBMDOS.COM (MSDOS 3.3), offset 1992h
  7684                                  	 
  7685 00000CC6 3CFF                    	CMP	AL,0FFH
  7686 00000CC8 7404                    	JZ	short BX_HAS_CODE	; -1 means country code is in BX
  7687 00000CCA 88C3                    	MOV	BL,AL			; Put AL country code in BX
  7688 00000CCC 30FF                    	XOR	BH,BH
  7689                                  BX_HAS_CODE:
  7690 00000CCE 1E                      	PUSH	DS
  7691 00000CCF 07                      	POP	ES
  7692 00000CD0 52                      	PUSH	DX
  7693 00000CD1 5F                      	POP	DI			; User buffer to ES:DI
  7694                                  
  7695                                  ;hkn; SS is DOSDATA
  7696                                  ;	context DS
  7697                                  
  7698 00000CD2 16                      	push	ss
  7699 00000CD3 1F                      	pop	ds
  7700                                  
  7701 00000CD4 83FFFF                  	CMP	DI,-1
  7702 00000CD7 745D                    	JZ	short international_set
  7703 00000CD9 09DB                    	OR	BX,BX
  7704 00000CDB 7505                    	JNZ	short international_find
  7705                                  
  7706                                  ;hkn; country_cdpg is in DOSDATA segment.
  7707 00000CDD BE[2A12]                	MOV	SI,COUNTRY_CDPG
  7708                                  
  7709 00000CE0 EB39                    	JMP	SHORT international_copy
  7710                                  
  7711                                  international_find:
  7712                                  	;MOV	BP,0			 ; flag it for GetCntry only
  7713                                  	; 06/01/2024
  7714 00000CE2 31ED                    	xor	bp,bp ; 0
  7715 00000CE4 E80A00                  	CALL	international_get
  7716 00000CE7 7255                    	JC	short errtn
  7717                                  	;CMP	BX,0			 ; nlsfunc finished it ?
  7718                                  	; 06/01/2024
  7719 00000CE9 09DB                    	or	bx,bx
  7720 00000CEB 752E                    	JNZ	SHORT international_copy ; no, copy by myself
  7721 00000CED 89D3                    	MOV	BX,DX			 ; put country back
  7722 00000CEF EB3A                    	JMP	SHORT international_ok3
  7723                                  
  7724                                  international_get:
  7725 00000CF1 BE[2A12]                	MOV	SI,COUNTRY_CDPG
  7726                                  
  7727                                  ;hkn; country_cdpg is in DOSDATA segment.
  7728                                  ;hkn; use ss override to access COUNTRY_CDPG fields
  7729                                  
  7730                                  	; MSDOS 3.3
  7731                                  	;;cmp	bx,[SI+63h]
  7732                                  	;CMP	BX,[SI+DOS_CCDPG.ccDosCountry]
  7733                                  	;jz	short RET27
  7734                                  
  7735                                  	; 13/05/2019 - Retro DOS v4.0
  7736                                  
  7737                                  	; MSDOS 6.0
  7738                                  	;cmp	bx,[ss:si+68h]
  7739 00000CF4 363B5C68                	CMP	BX,[ss:SI+DOS_CCDPG.ccDosCountry] ; = current country id
  7740 00000CF8 74CB                    	jz	short RET27			; return if equal
  7741                                  
  7742 00000CFA 89DA                    	MOV	DX,BX
  7743 00000CFC 31DB                    	XOR	BX,BX			; bx = 0, default code page
  7744                                  	;CallInstall NLSInstall,NLSFUNC,0 ; check if NLSFUNC in memory
  7745 00000CFE B80014                  	mov	ax,1400h
  7746 00000D01 CD2F                    	int     2Fh	; - Multiplex - NLSFUNC.COM - INSTALLATION CHECK
  7747                                  			; Return: AL = 00h not installed, OK to install
  7748                                  			; 01h not installed, not OK
  7749                                  			; FFh installed
  7750 00000D03 3CFF                    	CMP	AL,0FFH
  7751 00000D05 7510                    	JNZ	short interr		; not in memory
  7752                                  	
  7753                                  	; 06/01/2024
  7754 00000D07 B80314                  	mov	ax,1403h		; set country info
  7755                                  
  7756                                  	;cmp	bp,0
  7757 00000D0A 09ED                    	or	bp,bp			; GetCntry ?
  7758 00000D0C 7501                    	JNZ	short stcdpg
  7759                                  	
  7760                                  	;CallInstall GetCntry,NLSFUNC,4	; get country info
  7761                                  	;mov	ax,1404h
  7762 00000D0E 40                      	inc	ax	; AX = 1404h ; get country info
  7763                                  
  7764                                  	; 06/01/2024
  7765                                  	;int	2Fh	; - Multiplex - NLSFUNC.COM - GET COUNTRY INFO
  7766                                  	;		; BX = code page, DX = country code,
  7767                                  	;		; DS:SI -> internal code page structure
  7768                                  	;		; ES:DI -> user buffer
  7769                                  	;		; Return: AL = status
  7770                                  	;
  7771                                  	;JMP	short chkok
  7772                                  	
  7773                                  	;nop
  7774                                  
  7775                                  stcdpg:
  7776                                  	;CallInstall SetCodePage,NLSFUNC,3  ; set country info
  7777                                  	; 06/01/2024
  7778                                  	;mov     ax,1403h
  7779                                  gscdpg:
  7780 00000D0F CD2F                    	int     2Fh	; - Multiplex - NLSFUNC.COM - SET COUNTRY INFO
  7781                                  			; DS:SI -> internal code page structure
  7782                                  			; BX = code page, DX = country code
  7783                                  			; Return: AL = status
  7784                                  chkok:
  7785 00000D11 08C0                    	or	al,al			; success ?
  7786                                  	;retz				; yes
  7787 00000D13 74B0                    	jz	short RET27
  7788                                  
  7789                                  setcarry:
  7790 00000D15 F9                      	STC				; set carry
  7791 00000D16 C3                      	retn
  7792                                  interr:
  7793 00000D17 B0FF                    	MOV	AL,0FFH			; flag nlsfunc error
  7794 00000D19 EBFA                    	JMP	short setcarry
  7795                                  
  7796                                  international_copy:
  7797                                  
  7798                                  ;hkn; country_cdpg is in DOSDATA segment.
  7799                                  ;hkn; use ss override to access COUNTRY_CDPG fields
  7800                                  
  7801                                  	; MSDOS 3.3
  7802                                  	;;mov	bx,[SI+63h]
  7803                                  	;mov	BX,[SI+DOS_CCDPG.ccDosCountry]
  7804                                  	;mov	SI,COUNTRY_CDPG+DOS_CCDPG.ccDFormat ; 08/09/2018
  7805                                  
  7806                                  	; 13/05/2019 - Retro DOS v4.0
  7807                                  
  7808                                  	; MSDOS 6.0
  7809                                  	;mov	bx,[ss:si+68h]
  7810 00000D1B 368B5C68                	MOV	BX,[ss:SI+DOS_CCDPG.ccDosCountry] ; = current country id
  7811 00000D1F BE[9612]                	MOV	SI,COUNTRY_CDPG+DOS_CCDPG.ccDFormat ; COUNTRY_CDPG + 108
  7812                                  
  7813                                  	;mov	cx,24
  7814 00000D22 B91800                  	MOV	CX,OLD_COUNTRY_SIZE
  7815                                  
  7816                                  	; MSDOS 6.0
  7817                                  
  7818                                  ;hkn;	must set up DS to SS so that international info can be copied
  7819                                  	
  7820 00000D25 1E                      	push	ds
  7821                                  
  7822 00000D26 16                      	push	ss			; cs -> ss
  7823 00000D27 1F                      	pop	ds
  7824                                  
  7825 00000D28 F3A4                    	REP	MOVSB			; copy country info
  7826                                  
  7827                                  	; MSDOS 6.0
  7828                                  
  7829 00000D2A 1F                      	pop	ds	;hkn;	restore ds
  7830                                  
  7831                                  international_ok3:
  7832 00000D2B E849F7                  	call	Get_User_Stack
  7833                                  ;ASSUME	DS:NOTHING
  7834                                  	;MOV	[SI+2],BX
  7835 00000D2E 895C02                  	MOV	[SI+user_env.user_BX],BX
  7836                                  international_ok:
  7837 00000D31 89D8                    	MOV	AX,BX			; Return country code in AX too.
  7838                                  ;SYS_RET_OK_jmp:
  7839                                  	; 05/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  7840                                  	; 09/01/2024
  7841                                  ;nono:	; 15/12/2022
  7842                                  SYS_RET_OK_jmp:
  7843 00000D33 E934F9                  	jmp	SYS_RET_OK
  7844                                  
  7845                                  international_set:
  7846                                  
  7847                                  ;hkn; ASSUME	DS:DOSGROUP
  7848                                  ;ASSUME	DS:DOSDATA
  7849                                  
  7850 00000D36 BD0100                  	MOV	BP,1			; flag it for SetCodePage only
  7851 00000D39 E8B5FF                  	CALL	international_get
  7852 00000D3C 73F3                    	JNC	short international_ok
  7853                                  errtn:
  7854 00000D3E 3CFF                    	CMP	AL,0FFH
  7855 00000D40 7403                    	JZ	short errtn2
  7856                                  errtn1:
  7857 00000D42 E92FF9                  	jmp	SYS_RET_ERR		; return what we got from NLSFUNC
  7858                                  errtn2:
  7859                                  	;error	error_invalid_function	; NLSFUNC not existent
  7860                                  
  7861                                  	;mov	al,1
  7862 00000D45 B001                    	mov	al,error_invalid_function
  7863 00000D47 EBF9                    	jmp	short errtn1 ; 13/05/2019 - Retro DOS v4.0
  7864                                  ;errtn3:
  7865                                  ;	jmp	SYS_RET_ERR
  7866                                  
  7867                                  ;EndProc $INTERNATIONAL
  7868                                  
  7869                                  
  7870                                  ; ---------------------------------------------------------------------------
  7871                                  
  7872                                  	; 06/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 PCDOS.COM)
  7873                                  	; DOSCODE:4C10h (PCDOS 7.1, IBMDOS.COM)
  7874                                  
  7875                                  _$ExtCountryInfo:
  7876                                  			; INT 21h, AH = 70h
  7877                                  			; GET/SET INTERNATIONALIZATION INFORMATION
  7878                                  			; ****
  7879                                  			; AL = subfunction
  7880                                  			; 00h SET general internationalization info
  7881                                  			;    CX = buffer size (up to 38 bytes)
  7882                                  			;    DS:SI -> buffer containing internationalization info
  7883                                  			;  first three bytes are skipped, the rest is copied to
  7884                                  			;  somewhere in the DOS data segment
  7885                                  			; 01h SET extended internationalization info
  7886                                  			;    CX = number of bytes to set (up to 58 bytes)
  7887                                  			;    DS:SI -> buffer containing internationalization info
  7888                                  			; 02h GET extended internationalization info
  7889                                  			;    CX = buffer size in bytes (up to 58 bytes used)
  7890                                  			;    ES:DI -> buffer
  7891                                  			; ****
  7892                                  			; (Ref: Ralf Brown's Interrupt List) - had some mistakes -
  7893 00000D49 3C02                    	cmp	al,2 
  7894 00000D4B 77F8                    	ja	short errtn2
  7895 00000D4D 06                      	push    es
  7896 00000D4E 16                      	push    ss
  7897 00000D4F 750F                    	jnz	short ext_cntry_inf_1
  7898 00000D51 07                      	pop	es		; AX = GET 35 bytes info (from offset 3 to 37)
  7899                                  				; (38 bytes buffer is used)
  7900 00000D52 BF[9212]                	mov	di,_COUNTRY_ID
  7901 00000D55 268B45FE                	mov	ax,[es:di-2]	; NEW_COUNTRY_SIZE = 38
  7902 00000D59 BB0300                  	mov	bx,3		; skip the 1st 3 bytes of the buffer
  7903 00000D5C 01DE                    	add	si,bx
  7904 00000D5E EB13                    	jmp	short ext_cntry_inf_4
  7905                                  
  7906                                  ext_cntry_inf_1:
  7907 00000D60 FEC8                    	dec	al
  7908 00000D62 7506                    	jnz	short ext_cntry_inf_2 ; AX = 2
  7909                                  				; AX = 1 (set)
  7910 00000D64 07                      	pop	es
  7911 00000D65 BF[BA12]                	mov	di,_ENU		; "ENU"
  7912 00000D68 EB04                    	jmp	short ext_cntry_inf_3
  7913                                  
  7914                                  ext_cntry_inf_2:
  7915 00000D6A 1F                      	pop	ds		; AX = 2 (get)
  7916 00000D6B BE[BA12]                	mov	si,_ENU		; "ENU"
  7917                                  
  7918                                  ext_cntry_inf_3:		; CODE XREF: DOSCODE:4C2F^j
  7919 00000D6E 31DB                    	xor	bx,bx		; 0
  7920 00000D70 B83A00                  	mov	ax,58		; 3Ah
  7921                                  
  7922                                  ext_cntry_inf_4:
  7923 00000D73 39C1                    	cmp	cx,ax		; > 38 ? (58)
  7924                                  	;jb	short ext_cntry_inf_5 ; no
  7925 00000D75 7602                    	jna	short ext_cntry_inf_5 ; 06/01/2024
  7926 00000D77 89C1                    	mov	cx,ax		; yes, decrease size to 38 (58)
  7927                                  
  7928                                  ext_cntry_inf_5:
  7929 00000D79 89C8                    	mov	ax,cx		; buffer (filled) size
  7930 00000D7B 29D9                    	sub	cx,bx		; copy byte count
  7931 00000D7D F3A4                    	rep movsb
  7932 00000D7F 07                      	pop	es
  7933 00000D80 E91903                  	jmp	ret_ax_to_user_cx ; ax -> user's cx
  7934                                  
  7935                                  ; ---------------------------------------------------------------------------
  7936                                  
  7937                                  ; 19/07/2018
  7938                                  
  7939                                  ;BREAK <$GetExtCntry - return extended country-dependent information>
  7940                                  
  7941                                  ;----------------------------------------------------------------------------
  7942                                  ;
  7943                                  ; Procedure Name : $GetExtCntry
  7944                                  ;
  7945                                  ; Inputs:
  7946                                  ;	if AL >= 20H
  7947                                  ;	  AL= 20H    capitalize single char, DL= char
  7948                                  ;	      21H    capitalize string, CX= string length
  7949                                  ;	      22H    capitalize ASCIIZ string
  7950                                  ;	      23H    YES/NO check, DL=1st char DH= 2nd char (DBCS)
  7951                                  ;	      80H bit 0 = use normal upper case table
  7952                                  ;		      1 = use file upper case table
  7953                                  ;	   DS:DX points to string
  7954                                  ;
  7955                                  ;	else
  7956                                  ;
  7957                                  ;	MOV	AH,GetExtCntry	 ; DOS 3.3
  7958                                  ;	MOV	AL,INFO_ID	( info type,-1 selects all )
  7959                                  ;	MOV	BX,CODE_PAGE	( -1 = active code page )
  7960                                  ;	MOV	DX,COUNTRY_ID	( -1 = active country )
  7961                                  ;	MOV	CX,SIZE 	( amount of data to return )
  7962                                  ;	LES	DI,COUNTRY_INFO ( buffer for returned data )
  7963                                  ;	INT	21
  7964                                  ; Function:
  7965                                  ;	give users extended country dependent information
  7966                                  ;	or capitalize chars
  7967                                  ; Outputs:
  7968                                  ;	  No Carry:
  7969                                  ;	     extended country info is succesfully returned
  7970                                  ;	  Carry:
  7971                                  ;	     Register AX has the error code.
  7972                                  ;	     AX=0, NO	 for YES/NO CHECK
  7973                                  ;		1, YES
  7974                                  ;----------------------------------------------------------------------------
  7975                                  
  7976                                  ;procedure   $GetExtCntry,NEAR	; DOS 3.3
  7977                                  
  7978                                  	; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  7979                                  	; 06/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  7980                                  
  7981                                  	; MSDOS 6.0
  7982                                  _$GetExtCntry:
  7983 00000D83 3C20                    	CMP	AL,CAP_ONE_CHAR 	; < 20H ?
  7984 00000D85 726A                    	JB	short notcap
  7985                                  capcap: 				;
  7986 00000D87 A880                    	TEST	AL,UPPER_TABLE	; 80h	; which upper case table
  7987 00000D89 7505                    	JNZ	short fileupper		; file upper case
  7988                                  
  7989                                  ;hkn; UCASE_TAB in DOSDATA
  7990 00000D8B BB[FC0A]                	MOV	BX,UCASE_TAB+2		; get normal upper case
  7991 00000D8E EB05                    	JMP	SHORT capit
  7992                                  
  7993                                  fileupper:
  7994                                  	; 06/01/2024 (PCDOS 7.1 IBMDOS.COM - DOSCODE:4C57h)
  7995                                  	; ((Note: This must be a bugfix, because bit 7 of AX is 1 here!))
  7996                                  	; AL >= 80h
  7997 00000D90 247F                    	and	al,7Fh 
  7998                                  
  7999                                  ;hkn; FILE_UCASE_TAB in DOSDATA
  8000 00000D92 BB[7E0B]                	MOV	BX,FILE_UCASE_TAB+2 ; get file upper case
  8001                                  capit:					;
  8002 00000D95 3C20                    	CMP	AL,CAP_ONE_CHAR ; 20h	; cap one char ?
  8003 00000D97 750D                    	JNZ	short chkyes		; no
  8004 00000D99 88D0                    	MOV	AL,DL			; set up AL
  8005 00000D9B E84B50                  	call	GETLET3 		; upper case it
  8006 00000D9E E8D6F6                  	call	Get_User_Stack		; get user stack
  8007                                  	;mov	[si+6],al
  8008 00000DA1 884406                  	MOV	[SI+user_env.user_DX],AL ; user's DL=AL
  8009 00000DA4 EB24                    	JMP	SHORT nono		; done
  8010                                  chkyes: 				;
  8011 00000DA6 3C23                    	CMP	AL,CHECK_YES_NO	; 23h	; check YES or NO ?
  8012 00000DA8 7523                    	JNZ	short capstring		; no
  8013                                  
  8014 00000DAA 31C0                    	XOR	AX,AX			; presume NO
  8015                                  		      
  8016                                  ;hkn; NLS_YES, NLS_NO, NLS_yes2, NLS_no2 is defined in msdos.cl3 which is
  8017                                  ;hkn; included in yesno.asm in the DOSCODE segment.
  8018                                  
  8019                                  	; 06/08/2018 - Retro DOS v3.0
  8020                                  	; 13/05/2019 - Retro DOS v4.0
  8021                                  	;cmp	dl,'Y'
  8022 00000DAC 2E3A16[3613]            	CMP	DL,[cs:NLS_YES]		; is 'Y' ?
  8023 00000DB1 7416                    	JZ	short yesyes		; yes
  8024                                  	;cmp	dl,'y'
  8025 00000DB3 2E3A16[3813]            	CMP	DL,[cs:NLS_yes2]	; is 'y' ?
  8026 00000DB8 740F                    	JZ	short yesyes		; yes
  8027                                  	;cmp	dl,'N'
  8028 00000DBA 2E3A16[3713]            	CMP	DL,[cs:NLS_NO]		; is  'N'?
  8029 00000DBF 7409                    	JZ	short nono		; no
  8030                                  	;cmp	dl,'n'
  8031 00000DC1 2E3A16[3913]            	CMP	DL,[cs:NLS_no2]		; is 'n' ?
  8032 00000DC6 7402                    	JZ	short nono		; no
  8033                                  ;dbcs_char:				;
  8034 00000DC8 40                      	INC	AX			; not YES or NO
  8035                                  yesyes: 				;
  8036 00000DC9 40                      	INC	AX			; return 1
  8037                                  	; 15/12/2022
  8038                                  	; 09/01/2024 - Retro DOS v5.0
  8039                                  nono:	
  8040                                  	;jmp	short SYS_RET_OK_jmp	;
  8041                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8042                                  	; 09/01/2024
  8043 00000DCA E99DF8                  	jmp	SYS_RET_OK		; done
  8044                                  
  8045                                  capstring:				;
  8046 00000DCD 89D6                    	MOV	SI,DX			; si=dx
  8047 00000DCF 3C21                    	CMP	AL,CAP_STRING	; 21h	; cap string ?
  8048 00000DD1 750D                    	JNZ	short capascii		; no
  8049                                  	;OR	CX,CX			; check count 0
  8050                                  	;JZ	short nono		; yes finished
  8051                                  	; 06/01/2024
  8052 00000DD3 E3F5                    	jcxz	nono
  8053                                  concap: 				;
  8054 00000DD5 AC                      	LODSB				; get char
  8055 00000DD6 E81050                  	call	GETLET3 		; upper case it
  8056 00000DD9 8844FF                  	MOV	byte [SI-1],AL		; store back
  8057                                  ;next99: 				;
  8058 00000DDC E2F7                    	LOOP	concap			; continue
  8059 00000DDE EBEA                    	JMP	short nono		; done
  8060                                  capascii:				;
  8061 00000DE0 3C22                    	CMP	AL,CAP_ASCIIZ	; 22h	; cap ASCIIZ string ?
  8062 00000DE2 7573                    	JNZ	short capinval		; no
  8063                                  concap2:				;
  8064 00000DE4 AC                      	LODSB				; get char
  8065 00000DE5 08C0                    	or	al,al			; end of string ?
  8066 00000DE7 74E1                    	JZ	short nono		; yes
  8067 00000DE9 E8FD4F                  	call	GETLET3 		; upper case it
  8068 00000DEC 8844FF                  	MOV	[SI-1],AL		; store back
  8069 00000DEF EBF3                    	JMP	short concap2 		; continue
  8070                                  
  8071                                  	; MSDOS 3.3 (& MSDOS 6.0)
  8072                                  
  8073                                  ; Offset 1A19h in IBMDOS.COM (MSDOS 3.3), 1987 	
  8074                                  ; _$GetExtCntry:
  8075                                  
  8076                                  notcap:
  8077 00000DF1 83F905                  	CMP	CX,5			; minimum size is 5
  8078                                  	;jb	short sizeerror
  8079                                  	; 09/01/2024
  8080 00000DF4 7261                    	jb	short capinval		; (size error)
  8081                                  
  8082                                  GEC_CONT:
  8083                                  ;hkn; SS is DOSDATA
  8084                                  	;context DS
  8085                                  
  8086 00000DF6 16                      	push	ss
  8087                                  	;pop	es  ; ! (Retro DOS v3.0 BUG) !
  8088 00000DF7 1F                      	pop	ds  ; 13/05/2019 - Retro DOS v4.0	
  8089                                  	
  8090                                  ;hkn; COUNTRY_CDPG is in DOSDATA
  8091 00000DF8 BE[2A12]                	MOV	SI,COUNTRY_CDPG
  8092                                  
  8093                                  ; ------------------------------------------------------------
  8094                                  	; 06/01/2024 - Retro DOS v5.0
  8095                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:4CC6h
  8096                                  	;;;
  8097 00000DFB 08C0                    	or	al,al
  8098 00000DFD 752A                    	jnz	short GETCNTRY
  8099                                  			; AL = 0 (INT 21h, AX=6500h)
  8100                                  			; Set extended country-dependent information
  8101                                  			; (SET GENERAL INTERNATIONALIZATION INFO)
  8102                                  
  8103 00000DFF 83E907                  	sub	cx,7		; minimum 8 bytes
  8104 00000E02 7653                    	jbe	short capinval	; error_invalid_function
  8105 00000E04 8B5C48                  	mov	bx,[si+48h]	; [SI+DOS_CCDPG.ccSysCodePage]
  8106 00000E07 8D7466                  	lea	si,[si+66h]	; SI+DOS_CCDPG.ccCountryInfoLen
  8107 00000E0A 8B04                    	mov	ax,[si]
  8108 00000E0C 83E804                  	sub	ax,4
  8109 00000E0F 39C1                    	cmp	cx,ax
  8110 00000E11 7602                    	jbe	short set_intern_inf
  8111 00000E13 89C1                    	mov	cx,ax
  8112                                  set_intern_inf:
  8113 00000E15 89C8                    	mov	ax,cx
  8114 00000E17 83C004                  	add	ax,4
  8115 00000E1A 26894501                	mov	[es:di+1], ax	; info length/size (will be written)
  8116 00000E1E 83C606                  	add	si,6		; DOS_CCDPG.ccDFormat
  8117 00000E21 83C707                  	add	di,7		; points to date format
  8118 00000E24 E8AE09                  	call	XCHGP		; ds:si = user's buffer + 6
  8119                                  				; es:di = country info buffer + 7
  8120 00000E27 EB3F                    	jmp	short OK_RETN
  8121                                  	;;;
  8122                                  ; ------------------------------------------------------------
  8123                                  	
  8124                                  	; 06/01/2024
  8125                                  GETCNTRY:
  8126 00000E29 83FAFF                  	CMP	DX,-1 ; COUNTRY_ID	; active country ?
  8127 00000E2C 7503                    	JNZ	short GETCDPG 		; no
  8128                                  
  8129                                  ;hkn; use DS override to accesss country_cdpg fields
  8130                                  	;;mov	dx,[si+63h] ; MSDOS 3.3
  8131                                  	;mov	dx,[si+68h] ; MSDOS 6.0
  8132 00000E2E 8B5468                  	MOV	DX,[SI+DOS_CCDPG.ccDosCountry]
  8133                                  					; get active country id;smr;use DS
  8134                                  GETCDPG:
  8135 00000E31 83FBFF                  	CMP	BX,-1 ; CODE_PAGE	; active code page?
  8136 00000E34 7503                    	JNZ	short CHKAGAIN		; no, check again
  8137                                  
  8138                                  ;hkn; use DS override to accesss country_cdpg fields
  8139                                  	;;mov	bx,[si+65h] ; MSDOS 3.3	
  8140                                  	;mov	bx,[si+6Ah] ; MSDOS 6.0
  8141 00000E36 8B5C6A                  	MOV	BX,[SI+DOS_CCDPG.ccDosCodePage]
  8142                                  					; get active code page id;smr;Use DS
  8143                                  CHKAGAIN:
  8144                                  	;cmp	dx,[si+68h] ; MSDOS 6.0
  8145 00000E39 3B5468                  	CMP	DX,[SI+DOS_CCDPG.ccDosCountry]
  8146                                  					; same as active country id?;smr;use DS
  8147 00000E3C 7550                    	JNZ	short CHKNLS		; no
  8148                                  	;cmp	bx,[si+6Ah] ; MSDOS 6.0	
  8149 00000E3E 3B5C6A                  	CMP	BX,[SI+DOS_CCDPG.ccDosCodePage]	
  8150                                  					; same as active code pg id?;smr;use DS
  8151 00000E41 754B                    	JNZ	short CHKNLS		; no
  8152                                  CHKTYPE:
  8153                                  	;mov	bx,[si+48h]
  8154 00000E43 8B5C48                  	MOV	BX,[SI+DOS_CCDPG.ccSysCodePage]	
  8155                                  					; bx = sys code page id;smr;use DS
  8156 00000E46 51                      	PUSH	CX			; save cx
  8157                                  	;mov	cx,[si+4Ah]
  8158 00000E47 8B4C4A                  	MOV	CX,[SI+DOS_CCDPG.ccNumber_of_entries]  ;smr;use DS
  8159                                  	;mov	si,COUNTRY_CDPG+76
  8160 00000E4A BE[7612]                	MOV	SI,COUNTRY_CDPG+DOS_CCDPG.ccSetUcase   ;smr;CDPG in DOSDATA
  8161                                  NXTENTRY:
  8162 00000E4D 3A04                    	CMP	AL,[SI] 		; compare info type;smr;use DS
  8163 00000E4F 740B                    	JZ	short FOUNDIT
  8164 00000E51 83C605                  	ADD	SI,5			; next entry
  8165 00000E54 E2F7                    	LOOP	NXTENTRY
  8166 00000E56 59                      	POP	CX
  8167                                  capinval:
  8168                                  	;error	error_invalid_function	; info type not found
  8169                                  	;mov	al,1
  8170 00000E57 B001                    	mov	al,error_invalid_function
  8171                                  ;SYS_RET_ERR_jmp:
  8172                                  	;jmp	SYS_RET_ERR
  8173                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8174                                  SYS_RET_ERR_jmp:
  8175 00000E59 E918F8                  	jmp	SYS_RET_ERR	
  8176                                  
  8177                                  FOUNDIT:
  8178 00000E5C A4                      	MOVSB				; move info id byte
  8179 00000E5D 59                      	POP	CX			; restore char count
  8180                                  	;cmp	al,1
  8181 00000E5E 3C01                    	CMP	AL,SetCountryInfo	; select country info type ?
  8182 00000E60 7415                    	JZ	short setsize
  8183 00000E62 B90400                  	MOV	CX,4			; 4 bytes will be moved
  8184 00000E65 B80500                  	MOV	AX,5			; 5 bytes will be returned in CX
  8185                                  OK_RETN:
  8186 00000E68 F3A4                    	REP	MOVSB			; copy info
  8187 00000E6A 89C1                    	MOV	CX,AX			; CX = actual length returned
  8188 00000E6C 89D8                    	MOV	AX,BX			; return sys code page in ax
  8189                                  GETDONE:
  8190 00000E6E E806F6                  	call	Get_User_Stack		; return actual length to user's CX
  8191                                  	;mov	[si+4],cx 
  8192 00000E71 894C04                  	MOV	[SI+user_env.user_CX],CX
  8193                                  	;jmp	SYS_RET_OK
  8194                                  	; 15/12/2022
  8195                                  	; 25/06/2019
  8196 00000E74 E9F6F7                  	jmp	SYS_RET_OK_clc
  8197                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8198                                  	; 15/12/2022
  8199                                  ;nono_jmp:
  8200                                  	;jmp	short nono
  8201                                  setsize:
  8202 00000E77 83E903                  	SUB	CX,3			; size after length field
  8203 00000E7A 390C                    	CMP	[SI],CX			; less than table size ;smr;use ds
  8204 00000E7C 7302                    	JAE	short setsize2		; no
  8205 00000E7E 8B0C                    	MOV	CX,[SI]			; truncate to table size ;smr;use ds
  8206                                  setsize2:
  8207 00000E80 26890D                  	MOV	[ES:DI],CX		; copy actual length to user's buffer
  8208                                  	;ADD	DI,2			; update index
  8209                                  	;ADD	SI,2
  8210                                  	; 06/01/2024
  8211 00000E83 47                      	inc	di
  8212 00000E84 47                      	inc	di
  8213 00000E85 46                      	inc	si
  8214 00000E86 46                      	inc	si
  8215 00000E87 89C8                    	MOV	AX,CX
  8216 00000E89 83C003                  	ADD	AX,3			; AX has the actual length
  8217 00000E8C EBDA                    	JMP	short OK_RETN 		; go move it
  8218                                  CHKNLS:
  8219 00000E8E 30E4                    	XOR	AH,AH
  8220                                  	;PUSH	AX			; save info type
  8221                                  	;POP	BP			; bp = info type
  8222                                  	; 06/01/2024
  8223 00000E90 89C5                    	mov	bp,ax
  8224                                  
  8225                                  	;CallInstall NLSInstall,NLSFUNC,0 ; check if NLSFUNC in memory
  8226 00000E92 B80014                  	mov     ax,1400h
  8227 00000E95 CD2F                    	int     2Fh     ; - Multiplex - NLSFUNC.COM - INSTALLATION CHECK
  8228                                  			; Return: AL = 00h not installed, OK to install
  8229                                  			; 01h not installed, not OK
  8230                                  			; FFh installed
  8231 00000E97 3CFF                    	CMP	AL,0FFH
  8232 00000E99 7402                    	JZ	short NLSNXT		; in memory
  8233                                  
  8234                                  sizeerror:
  8235                                  	; 09/01/2024 - Retro DOS v5.0
  8236                                  	;
  8237                                  ;	;error	error_invalid_function
  8238                                  ;	;mov	al,1
  8239                                  ;	mov	al,error_invalid_function
  8240                                  ;	;jmp	SYS_RET_ERR
  8241                                  ;	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8242                                  ;sys_ret_err_jmp2:
  8243                                  ;	jmp	short SYS_RET_ERR_jmp
  8244                                  	; 09/01/2024
  8245 00000E9B EBBA                    	jmp	short capinval
  8246                                  
  8247                                  NLSNXT: 
  8248                                  	;CallInstall GetExtInfo,NLSFUNC,2 ;get extended info
  8249 00000E9D B80214                  	mov     ax,1402h
  8250 00000EA0 CD2F                    	int     2Fh	; - Multiplex - NLSFUNC.COM - GET COUNTRY INFO
  8251                                  			; BP = subfunction, BX = code page
  8252                                  			; DX = country code, DS:SI -> internal code page structure
  8253                                  			; ES:DI -> user buffer, CX = size of user buffer
  8254                                  			; Return: AL = status
  8255                                  			; 00h successful
  8256                                  			; else DOS error code
  8257                                  
  8258 00000EA2 3C00                    	CMP	AL,0			; success ?
  8259 00000EA4 7505                    	JNZ	short NLSERROR
  8260                                  	;mov	ax,[si+48h] ; 13/05/2019 
  8261 00000EA6 8B4448                  	MOV	AX,[SI+DOS_CCDPG.ccSysCodePage]
  8262                                  			; ax = sys code page id;smr;use ds;
  8263                                  			;BUGBUG;check whether DS is OK after the above calls
  8264 00000EA9 EBC3                    	JMP	short GETDONE
  8265                                  seterr:
  8266                                  	; 15/12/2022
  8267                                  NLSERROR:
  8268                                  	;jmp	SYS_RET_ERR		; return what is got from NLSFUNC
  8269                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8270                                  	;jmp	short sys_ret_err_jmp2
  8271                                  	; 15/12/2022
  8272 00000EAB EBAC                    	jmp	short SYS_RET_ERR_jmp
  8273                                  
  8274                                  ;EndProc $GetExtCntry
  8275                                  
  8276                                  ; 13/05/2019 - Retro DOS v4.0
  8277                                  ; DOSCODE:4BD6h (MSDOS 6.21, MSDOS.SYS)
  8278                                  
  8279                                  ;BREAK <$GetSetCdPg - get or set global code page>
  8280                                  ;----------------------------------------------------------------------------
  8281                                  ;**	$GetSetCdPg - Get or Set Global Code Page
  8282                                  ;
  8283                                  ;   System call format:
  8284                                  ;
  8285                                  ;	MOV	AH,GetSetCdPg	; DOS 3.3
  8286                                  ;	MOV	AL,n		; n = 1 : get code page, n = 2 : set code page
  8287                                  ;	MOV	BX,CODE_PAGE	(set code page only)
  8288                                  ;	INT	21
  8289                                  ;
  8290                                  ;	ENTRY	(al) = n
  8291                                  ;		(bx) = code page
  8292                                  ;	EXIT	'C' clear
  8293                                  ;		  global code page is set	(set global code page)
  8294                                  ;		  (BX) = active code page id	(get global code page)
  8295                                  ;		  (DX) = system code page id	(get global code page)
  8296                                  ;		'C' set
  8297                                  ;		  (AX) = error code
  8298                                  
  8299                                  ;procedure  $GetSetCdPg,NEAR   ; DOS 3.3
  8300                                  
  8301                                  	; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  8302                                  	; DOSCODE:4BC9h
  8303                                  
  8304                                  	; 06/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  8305                                  	; DOSCODE:4D73h
  8306                                  
  8307                                  _$GetSetCdPg:
  8308                                  
  8309                                  ;hkn; SS is DOSDATA
  8310                                  	;context DS
  8311                                  
  8312 00000EAD 16                      	push	ss
  8313 00000EAE 1F                      	pop	ds
  8314                                  
  8315                                  ;hkn; COUNTRY_CDPG is in DOSDATA
  8316 00000EAF BE[2A12]                	MOV	SI,COUNTRY_CDPG	  ; (DOSDATA:122Ah for MSDOS 6.21)
  8317                                  
  8318 00000EB2 3C01                    	CMP	AL,1		       ; get global code page
  8319 00000EB4 7512                    	JNZ	short setglpg 	       ; set global code page
  8320                                  	
  8321                                  	;;mov	bx,[si+65h] ; MSDOS 3.3
  8322                                  	;mov	bx,[si+6Ah] ; MSDOS 6.0
  8323 00000EB6 8B5C6A                  	MOV	BX,[SI+DOS_CCDPG.ccDosCodePage]
  8324                                  					; get active code page id;smr;use ds
  8325                                  	;mov	dx,[si+48h]
  8326 00000EB9 8B5448                  	MOV	DX,[SI+DOS_CCDPG.ccSysCodePage]
  8327                                  				  	; get sys code page id;smr;use ds
  8328 00000EBC E8B8F5                  	call	Get_User_Stack
  8329                                  ;ASSUME DS:NOTHING
  8330                                  	;;mov	[si+2],bx
  8331                                  	;MOV	[SI+user_env.user_BX],BX ; update returned bx
  8332                                  	; 06/01/2024 (PCDOS 7.1 IBMDOS.COM)
  8333 00000EBF E8F4FD                  	call    set_user_bx	; MOV [SI+user_env.user_BX],BX 
  8334                                  	;mov	[si+6],dx
  8335 00000EC2 895406                  	MOV	[SI+user_env.user_DX],DX ; update returned dx
  8336                                  OK_RETURN:
  8337                                  	; 15/12/2022
  8338                                  	;transfer SYS_RET_OK
  8339 00000EC5 E9A2F7                  	jmp	SYS_RET_OK
  8340                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8341                                  	;jmp	short nono_jmp
  8342                                  
  8343                                  ;hkn; ASSUME DS:DOSGROUP
  8344                                  ;ASSUME	DS:DOSDATA
  8345                                  
  8346                                  setglpg:
  8347 00000EC8 3C02                    	CMP	AL,2
  8348 00000ECA 752F                    	JNZ	short nomem
  8349                                  	
  8350                                  	;;mov	dx,[si+63h] ; MSDOS 3.3
  8351                                  	;mov	dx,[si+68h] ; MSDOS 6.0
  8352 00000ECC 8B5468                  	MOV	DX,[SI+DOS_CCDPG.ccDosCountry]	;smr;use ds
  8353                                  	
  8354                                  	;CallInstall NLSInstall,NLSFUNC,0 ; check if NLSFUNC in memory
  8355 00000ECF B80014                  	mov     ax,1400h
  8356 00000ED2 CD2F                    	int     2Fh	; - Multiplex - NLSFUNC.COM - INSTALLATION CHECK
  8357                                  			; Return: AL = 00h not installed, OK to install
  8358                                  			; 01h not installed, not OK
  8359                                  			; FFh installed
  8360 00000ED4 3CFF                    	CMP	AL,0FFH
  8361 00000ED6 7523                    	JNZ	short nomem		; not in memory
  8362                                  
  8363                                  	;CallInstall SetCodePage,NLSFUNC,1 ;set the code page
  8364 00000ED8 B80114                  	mov     ax,1401h
  8365 00000EDB CD2F                    	int     2Fh	; - Multiplex - NLSFUNC.COM - CHANGE CODE PAGE
  8366                                  			; DS:SI -> internal code page structure
  8367                                  			; BX = new code page, DX = country code???
  8368                                  			; Return: AL = status
  8369                                  			; 00h successful
  8370                                  			; else DOS error code
  8371                                  	;cmp	al,0
  8372 00000EDD 08C0                    	or	al,al			; success ?
  8373 00000EDF 74E4                    	JZ	short OK_RETURN		; yes
  8374                                  
  8375 00000EE1 3C41                    	CMP	AL,65			; set device code page failed
  8376 00000EE3 75C6                    	JNZ	short seterr
  8377                                  	;MOV	AX,65
  8378                                  	; 06/01/2024
  8379 00000EE5 98                      	cbw
  8380 00000EE6 A3[2403]                	MOV	[EXTERR],AX
  8381                                  	;mov	byte [EXTERR_ACTION],6
  8382                                  	;mov	byte [EXTERR_CLASS],5
  8383                                  	;mov	byte [EXTERR_LOCUS],4
  8384 00000EE9 C606[2603]06            	MOV	byte [EXTERR_ACTION],errACT_Ignore
  8385 00000EEE C606[2703]05            	MOV	byte [EXTERR_CLASS],errCLASS_HrdFail
  8386 00000EF3 C606[2303]04            	MOV	byte [EXTERR_LOCUS],errLOC_SerDev
  8387                                  	;transfer From_GetSet
  8388 00000EF8 E981F7                  	jmp	From_GetSet
  8389                                  
  8390                                  	; 15/12/2022
  8391                                  ;seterr:
  8392                                  	;;;transfer SYS_RET_ERR
  8393                                  	;;jmp	SYS_RET_ERR
  8394                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8395                                  	;jmp	short NLSERROR
  8396                                  
  8397                                  nomem:
  8398                                  	;error	error_invalid_function	; function not defined
  8399                                  	;mov	al,1
  8400 00000EFB B001                    	mov	al,error_invalid_function
  8401 00000EFD EBAC                    	jmp	short seterr
  8402                                  
  8403                                  ;EndProc $GetSetCdPg
  8404                                  
  8405                                  ; 13/05/2019 - Retro DOS v4.0
  8406                                  ; DOSCODE:4C2Bh (MSDOS 6.21, MSDOS.SYS)
  8407                                  
  8408                                  ;BREAK <$Get_Drive_Freespace -- Return bytes of free disk space on a drive>
  8409                                  ;----------------------------------------------------------------------------
  8410                                  ;**	$Get_Drive_Freespace - Return amount of drive free space
  8411                                  ;
  8412                                  ;	$Get_Drive_Freespace returns the # of free allocation units on a
  8413                                  ;		drive.
  8414                                  ;
  8415                                  ;	This call returns the same info in the same registers (except for the
  8416                                  ;	FAT pointer) as the old FAT pointer calls
  8417                                  ;
  8418                                  ;	ENTRY	DL = Drive number
  8419                                  ;	EXIT	AX = Sectors per allocation unit
  8420                                  ;		   = -1 if bad drive specified
  8421                                  ;		On User Stack
  8422                                  ;		    BX = Number of free allocation units
  8423                                  ;		    DX = Total Number of allocation units on disk
  8424                                  ;		    CX = Sector size
  8425                                  
  8426                                  ;procedure   $GET_DRIVE_FREESPACE,NEAR
  8427                                  
  8428                                  	; 09/01/2024
  8429                                  	; 06/01/2024 - Retro DOS v5.0
  8430                                  	; (PCDOS 7.1 IBMDOS.COM - DOSCODE:4DC4h)
  8431                                  
  8432                                  _$GET_DRIVE_FREESPACE:
  8433                                  
  8434                                  ;hkn; SS is DOSDATA
  8435                                  	;context DS
  8436 00000EFF 16                      	push	ss
  8437 00000F00 1F                      	pop	ds
  8438                                  
  8439 00000F01 88D0                    	MOV	AL,DL
  8440                                  	;invoke	GetThisDrv		; Get drive
  8441 00000F03 E8B76C                  	call	GETTHISDRV
  8442                                  SET_AX_RET:
  8443 00000F06 721C                    	JC	short BADFDRV
  8444                                  	;invoke	DISK_INFO
  8445 00000F08 E85924                  	call	DISK_INFO
  8446                                  	; 09/01/2024
  8447                                  	;XCHG	DX,BX
  8448                                  	;;JC	short SET_AX_RET	; User FAILed to I 24
  8449                                  	; 06/01/2024
  8450 00000F0B 7217                    	jc	short BADFDRV
  8451                                  	; 09/01/2024 - Retro DOS v5.0 (PCDOS 7.1)
  8452                                  gdrvfspc_1:
  8453 00000F0D 30E4                    	XOR	AH,AH			; Chuck Fat ID byte
  8454                                  	;;;
  8455 00000F0F 57                      	push	di
  8456 00000F10 E80E09                  	call	TestNet
  8457 00000F13 5F                      	pop	di
  8458 00000F14 7203                    	jc	short gdrvfspc_2
  8459 00000F16 E84F25                  	call    modify_cluster_count
  8460                                  			; if hw of total clusters (di) > 0
  8461                                  			; sectors per cluster and cluster counts
  8462                                  			; will be modified (shifted)
  8463                                  			; (but sectors per clust * clust count will be same)
  8464                                  			; /// disk size -calculation- limit = 2 GB ///
  8465                                  gdrvfspc_2:
  8466 00000F19 87D3                    	xchg	dx,bx		; bx = free clusters (after xchg)
  8467                                  	;;;
  8468                                  DoSt:
  8469 00000F1B E859F5                  	call	Get_User_Stack
  8470                                  ;ASSUME	DS:NOTHING
  8471                                  	;mov	[si+6],dx
  8472                                  	;;mov	[si+4],cx
  8473                                  	;;mov	[si+2],bx
  8474                                  	; 09/01/2024
  8475 00000F1E 895406                  	MOV	[SI+user_env.user_DX],DX ; total clusters
  8476                                  	;MOV	[SI+user_env.user_CX],CX
  8477                                  	;MOV	[SI+user_env.user_BX],BX
  8478                                  	;;MOV	[SI+user_env.user_AX],AX
  8479                                  	;mov	[si],ax
  8480                                  	;;return
  8481                                  	;retn
  8482                                  	; 09/01/2024
  8483 00000F21 E98DFD                  	jmp     gdrvfspc_ret	; ax = sectors per cluster (modified)
  8484                                  
  8485                                  BADFDRV:
  8486                                  	; MSDOS 3.3
  8487                                  	;;mov	al,0Fh
  8488                                  	;mov	al,error_invalid_drive	; Assume error
  8489                                  
  8490                                  	; 13/05/2019 - Retro DOS v4.0
  8491                                  
  8492                                  	; MSDOS 6.0 & MSDOS 3.3
  8493                                  	;invoke	FCB_RET_ERR
  8494 00000F24 E862F7                  	call	FCB_RET_ERR
  8495                                  	
  8496 00000F27 B8FFFF                  	MOV	AX,-1
  8497 00000F2A EBEF                    	JMP	short DoSt
  8498                                  
  8499                                  ;EndProc $GET_DRIVE_FREESPACE
  8500                                  
  8501                                  ;	BREAK <$Get_DMA, $Set_DMA -- Get/Set current DMA address>
  8502                                  ;----------------------------------------------------------------------------
  8503                                  ;**	$Get_DMA - Get Disk Transfer Address
  8504                                  ;
  8505                                  ;	ENTRY	none
  8506                                  ;	EXIT	ES:BX is current transfer address
  8507                                  ;	USES	all
  8508                                  
  8509                                  	; 09/01/2024
  8510                                  _$GET_DMA:
  8511 00000F2C 368B1E[2C03]            	MOV	BX,[SS:DMAADD]
  8512 00000F31 368B0E[2E03]            	MOV	CX,[SS:DMAADD+2]
  8513 00000F36 E83EF5                  	call	Get_User_Stack
  8514                                  	;mov	[si+2],bx
  8515                                  	;mov	[si+10h],cx
  8516                                  	; 09/01/2024
  8517                                  	;MOV	[SI+user_env.user_BX],BX
  8518 00000F39 894C10                  	MOV	[SI+user_env.user_ES],CX
  8519                                  	;retn
  8520                                  	; 09/01/2024
  8521 00000F3C E977FD                  	jmp	set_user_bx
  8522                                  
  8523                                  ;**	$Set_DMA - Set Disk Transfer Address
  8524                                  ;----------------------------------------------------------------------------
  8525                                  ;	ENTRY	DS:DX is current transfer address
  8526                                  ;	EXIT	none
  8527                                  ;	USES	all
  8528                                  
  8529                                  _$SET_DMA:
  8530 00000F3F 368916[2C03]            	MOV	[SS:DMAADD],DX
  8531 00000F44 368C1E[2E03]            	MOV	[SS:DMAADD+2],DS
  8532 00000F49 C3                      	retn
  8533                                  
  8534                                  ;	BREAK <$Get_Default_Drive, $Set_Default_Drive -- Set/Get default drive>
  8535                                  ;------------------------------------------------------------------------------
  8536                                  
  8537                                  ;**	$Get_Default_Drive - Get Current Default Drive
  8538                                  ;-----------------------------------------------------
  8539                                  ;	ENTRY	none
  8540                                  ;	EXIT	(AL) = drive number
  8541                                  ;	USES	all
  8542                                  
  8543                                  _$GET_DEFAULT_DRIVE:
  8544 00000F4A 36A0[3603]              	MOV	AL,[SS:CURDRV]
  8545 00000F4E C3                      	retn
  8546                                  
  8547                                  ;**	$Set_Default_Drive - Specify new Default Drive
  8548                                  ;-----------------------------------------------------
  8549                                  ;	ENTRY	(DL) = Drive number for new default drive
  8550                                  ;	EXIT	(AL) = Number of drives, NO ERROR RETURN IF DRIVE NUMBER BAD
  8551                                  
  8552                                  _$SET_DEFAULT_DRIVE:
  8553 00000F4F 88D0                    	MOV	AL,DL
  8554 00000F51 FEC0                    	INC	AL			; A=1, B=2...
  8555 00000F53 E84B6C                  	call	GetVisDrv		; see if visible drive
  8556 00000F56 7204                    	JC	short SETRET		; errors do not set
  8557 00000F58 36A2[3603]              	MOV	[SS:CURDRV],AL		; no, set
  8558                                  
  8559                                  SETRET:
  8560 00000F5C 36A0[4700]              	MOV	AL,[SS:CDSCOUNT]	; let user see what the count really is
  8561 00000F60 C3                      	retn
  8562                                  
  8563                                  ;BREAK <$Get/Set_Interrupt_Vector - Get/Set interrupt vectors>
  8564                                  ;----------------------------------------------------------------------------
  8565                                  
  8566                                  ;**	$Get_Interrupt_Vector - Get Interrupt Vector
  8567                                  ;---------------------------------------------------
  8568                                  ;	$Get_Interrupt_Vector is the official way for user pgms to get the
  8569                                  ;	contents of an interrupt vector.
  8570                                  ;
  8571                                  ;	ENTRY	(AL) = interrupt number
  8572                                  ;	EXIT	(ES:BX) = current interrupt vector
  8573                                  
  8574                                  _$GET_INTERRUPT_VECTOR:
  8575 00000F61 E82E00                  	CALL	RECSET
  8576 00000F64 26C41F                  	LES	BX,[ES:BX]
  8577 00000F67 E80DF5                  	call	Get_User_Stack
  8578                                  set_user_es_bx:
  8579                                  	; 09/01/2024 (PCDOS 7.1 IBMDOS.COM)
  8580                                  	;;mov	[si+2],bx
  8581                                  	;mov	[si+10h],es
  8582                                  	;MOV	[SI+user_env.user_BX],BX
  8583 00000F6A 8C4410                  	MOV	[SI+user_env.user_ES],ES
  8584                                  	;retn
  8585 00000F6D E946FD                  	jmp	set_user_bx
  8586                                  
  8587                                  ;**	$Set_Interrupt_Vector - Set Interrupt Vector
  8588                                  ;---------------------------------------------------
  8589                                  ;	$Set_Interrupt_Vector is the official way for user pgms to set the
  8590                                  ;	contents of an interrupt vector.
  8591                                  ;
  8592                                  ;	M004, M068: Also set A20OFF_COUNT to 1 if EXECA20OFF bit has been set 
  8593                                  ;	and if A20OFF_COUNT is non-zero. See under tag M003 in inc\dossym.inc 
  8594                                  ;	for explanation.
  8595                                  ;
  8596                                  ;	ENTRY	(AL) = interrupt number
  8597                                  ;		(ds:dx) = desired new vector value
  8598                                  ;	EXIT	none
  8599                                  ;	USES	all
  8600                                  
  8601                                  ; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  8602                                  ; 13/05/2019 - Retro DOS v4.0
  8603                                  
  8604                                  _$SET_INTERRUPT_VECTOR:
  8605 00000F70 E81F00                  	CALL	RECSET
  8606 00000F73 FA                      	CLI				; Watch out!!!!! Folks sometimes use
  8607 00000F74 268917                  	MOV	[ES:BX],DX		;   this for hardware ints (like timer).
  8608 00000F77 268C5F02                	MOV	[ES:BX+2],DS
  8609 00000F7B FB                      	STI
  8610                                  					; M004, M068 - Start
  8611                                  	; MSDOS 6.0
  8612 00000F7C 36F606[8600]04          	test	byte [ss:DOS_FLAG],EXECA20OFF ; 4
  8613                                  					; Q: was the previous call an int 21h
  8614                                  					;    exec call
  8615                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8616                                  	;jnz	short siv_1		; Y: go set count
  8617                                  	;retn				; N: return
  8618                                  	; 15/12/2022
  8619 00000F82 740D                    	jz	short siv_2
  8620                                  siv_1:	
  8621 00000F84 36803E[8500]00          	cmp	byte [ss:A20OFF_COUNT],0 ; Q: is count 0
  8622 00000F8A 7505                    	jnz	short siv_2		 ; N: done 
  8623                                  	; 20/09/2023
  8624 00000F8C 36FE06[8500]            	inc	byte [ss:A20OFF_COUNT]
  8625                                  	;mov	byte [ss:A20OFF_COUNT],1 ; Y: set it to 1 to indicate to dos
  8626                                  					 ; dispatcher to turn A20 Off before
  8627                                  					 ; returning to user.
  8628                                  siv_2:
  8629                                  	; 07/12/2022
  8630 00000F91 C3                      	retn				; M004, M068 - End
  8631                                  	
  8632                                  RECSET:
  8633 00000F92 31DB                    	XOR	BX,BX
  8634 00000F94 8EC3                    	MOV	ES,BX
  8635 00000F96 88C3                    	MOV	BL,AL
  8636 00000F98 D1E3                    	SHL	BX,1
  8637 00000F9A D1E3                    	SHL	BX,1
  8638 00000F9C C3                      	retn
  8639                                  
  8640                                  ;	BREAK <$Char_Oper - hack on paths, switches so that xenix can look like PCDOS>
  8641                                  ;-------------------------------------------------------------------------------------
  8642                                  
  8643                                  ;**	$Char_Oper - Manipulate Switch Character
  8644                                  ;
  8645                                  ;	This function was put in to facilitate XENIX path/switch compatibility
  8646                                  ;
  8647                                  ;	ENTRY	AL = function:
  8648                                  ;		    0 - read switch char
  8649                                  ;		    1 - set switch char (char in DL)
  8650                                  ;		    2 - read device availability
  8651                                  ;			Always returns available
  8652                                  ;		    3 - set device availability
  8653                                  ;			No longer supported (NOP)
  8654                                  ;	EXIT	(al) = 0xff iff error
  8655                                  ;		(al) != 0xff if ok
  8656                                  ;		  (dl) = character/flag, if "read switch char" subfunction
  8657                                  ;	USES	AL, DL
  8658                                  ;
  8659                                  ;	NOTE	This already obsolete function has been deactivated in DOS 5.0
  8660                                  ;		The character / is always returned for subfunction 0,
  8661                                  ;		subfunction 2 always returns -1, all other subfunctions are ignored.
  8662                                  
  8663                                  ; 13/05/2019 - Retro DOS v4.0
  8664                                  ; DOSCODE:4CC9h (MSDOS 6.21, MSDOS.SYS)
  8665                                  
  8666                                  ; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  8667                                  ; DOSCODE:4CBCh (MSDOS 5.0, MSDOS.SYS)
  8668                                  
  8669                                  _$CHAR_OPER:
  8670                                  	; MSDOS 6.0
  8671 00000F9D 08C0                    	or	al,al				; get switch?
  8672 00000F9F B22F                    	mov	dl,'/'				; assume yes
  8673 00000FA1 7407                    	jz	short chop_1			; jump if yes
  8674 00000FA3 3C02                    	cmp	al,2				; check device availability?
  8675 00000FA5 B2FF                    	mov	dl,-1				; assume yes
  8676 00000FA7 7401                    	jz	short chop_1			; jump if yes
  8677 00000FA9 C3                      	retn					; otherwise just quit
  8678                                  
  8679                                  ; subfunctions requiring return of value to user come here. DL holds
  8680                                  ; value to return
  8681                                  
  8682                                  chop_1:
  8683 00000FAA E8CAF4                  	call	Get_User_Stack
  8684 00000FAD 895406                  	mov	[SI+user_env.user_DX],dx	; store value for user
  8685 00000FB0 C3                      	retn
  8686                                  
  8687                                  	; MSDOS 3.3
  8688                                  	; Offset 1B87h in IBMDOS.COM (MSDOS 3.3), 1987
  8689                                  	;push	ss
  8690                                  	;pop	ds
  8691                                  	;cmp	al,1
  8692                                  	;jb	short chop_1
  8693                                  	;jz	short chop_2
  8694                                  	;cmp	al,3
  8695                                  	;jb	short chop_3
  8696                                  	;jz	short chop_5
  8697                                  	;mov	al,0FFh
  8698                                  	;retn
  8699                                  ;chop_1:
  8700                                  	;mov	dl,[chSwitch]
  8701                                  	;jmp	short chop_4
  8702                                  ;chop_2:
  8703                                  	;mov	[chSwitch],dl
  8704                                  	;retn
  8705                                  ;chop_3:
  8706                                  	;mov	dl, FFh
  8707                                  ;chop_4:
  8708                                  	;call	Get_User_Stack
  8709                                  	;mov	[si+6],dx
  8710                                  ;chop_5:
  8711                                  	;retn
  8712                                  
  8713                                  ;**	$GetExtendedError - Return Extended error code
  8714                                  ;----------------------------------------------------------------------------
  8715                                  ;	This function reads up the extended error info from the static
  8716                                  ;	variables where it was stored.
  8717                                  ;
  8718                                  ;	ENTRY	none
  8719                                  ;	EXIT	AX = Extended error code (0 means no extended error)
  8720                                  ;		BL = recommended action
  8721                                  ;		BH = class of error
  8722                                  ;		CH = locus of error
  8723                                  ;		ES:DI = may be pointer
  8724                                  ;	USES	ALL
  8725                                  
  8726                                  	; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  8727                                  
  8728                                  _$GetExtendedError:
  8729 00000FB1 16                      	push	ss
  8730 00000FB2 1F                      	pop	ds
  8731 00000FB3 A1[2403]                	MOV	AX,[EXTERR]
  8732 00000FB6 C43E[2803]              	LES	DI,[EXTERRPT]
  8733 00000FBA 8B1E[2603]              	MOV	BX,[EXTERR_ACTION]	; BL = Action, BH = Class
  8734 00000FBE 8A2E[2303]              	MOV	CH,[EXTERR_LOCUS]
  8735 00000FC2 E8B2F4                  	call	Get_User_Stack
  8736                                  	;mov	[si+0Ah],di
  8737 00000FC5 897C0A                  	MOV	[SI+user_env.user_DI],DI
  8738                                  
  8739                                  	; 09/01/2024 (PCDOS 7.1 IBMDOS.COM)
  8740                                  	;;mov	[si+10h],es
  8741                                  	;MOV	[SI+user_env.user_ES],ES
  8742                                  	;;mov	[si+2],bx
  8743                                  	;MOV	[SI+user_env.user_BX],BX
  8744 00000FC8 E89FFF                  	call	set_user_es_bx
  8745                                  
  8746                                  	;mov	[si+4],cx
  8747 00000FCB 894C04                  	MOV	[SI+user_env.user_CX],CX
  8748                                  jmp_SYS_RET_OK:
  8749                                  	; 15/12/2022
  8750                                  	;jmp	SYS_RET_OK
  8751                                  	; 25/06/2019
  8752 00000FCE E99CF6                  	jmp	SYS_RET_OK_clc ; 15/12/2022
  8753                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8754                                  ;jmp_SYS_RET_OK:
  8755                                  	;jmp	SYS_RET_OK
  8756                                  
  8757                                  ; --------------------------------------------------------------------------
  8758                                  ; 09/01/2024
  8759                                  %if 0
  8760                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8761                                  	; DOSCODE:4CF3h
  8762                                  ;patch_or_unknown:
  8763                                  ;get_code_page:
  8764                                  	push    si
  8765                                  	mov     si, COUNTRY_CDPG
  8766                                  	;mov	ax, [si+DOS_CCDPG.ccDosCodePage]
  8767                                  	mov     ax, [ss:si+6Ah]
  8768                                  	pop     si
  8769                                  	retn
  8770                                  %endif
  8771                                  ; --------------------------------------------------------------------------
  8772                                  
  8773                                  ; 29/04/2019 - Retro DOS v4.0
  8774                                  
  8775                                  ;BREAK	<ECS_call - Extended Code System support function>
  8776                                  ;---------------------------------------------------------------------------
  8777                                  ; Inputs:
  8778                                  ;	AL = 0	get lead byte table
  8779                                  ;		on return DS:SI has the table location
  8780                                  ;
  8781                                  ;	AL = 1	set / reset interim console flag
  8782                                  ;		DL = flag (00H or 01H)
  8783                                  ;		no return
  8784                                  ;
  8785                                  ;	AL = 2	get interim console flag
  8786                                  ;		on return DL = current flag value
  8787                                  ;
  8788                                  ;	AL = OTHER then error, and returns with:
  8789                                  ;		AX = error_invalid_function
  8790                                  ;
  8791                                  ;  NOTE: THIS CALL DOES GUARANTEE THAT REGISTER OTHER THAN
  8792                                  ;	 SS:SP WILL BE PRESERVED!
  8793                                  ;---------------------------------------------------------------------------
  8794                                  
  8795                                  _$ECS_Call:
  8796 00000FD1 08C0                    	or	al,al			; AL = 0 (get table)?
  8797                                  	;jnz	short _okok
  8798                                  	; 15/12/2022
  8799 00000FD3 7403                    	jz	short get_lbt
  8800                                  ;_okok:
  8801 00000FD5 E992F6                  	jmp	SYS_RET_OK
  8802                                  get_lbt:
  8803 00000FD8 E89CF4                  	call	Get_User_Stack		; *
  8804                                  
  8805                                  ;hkn; dbcs_table moved low to dosdata
  8806                                  	;mov	word [si+8],DBCS_TAB+2
  8807 00000FDB C74408[020D]            	mov	word [SI+user_env.user_SI],DBCS_TAB+2
  8808                                  
  8809 00000FE0 06                      	push	es
  8810                                  	;getdseg <es>			; es = DOSDATA
  8811 00000FE1 2E8E06[0700]            	mov	es,[cs:DosDSeg]
  8812                                  	;mov	[si+14],es
  8813 00000FE6 8C440E                  	mov	[SI+user_env.user_DS],es
  8814 00000FE9 07                      	pop	es
  8815                                  
  8816                                  	; 15/12/2022
  8817 00000FEA EBE2                    	jmp	short jmp_SYS_RET_OK ; jmp SYS_RET_OK_clc ; *
  8818                                  ;_okok:
  8819                                  	; 15/12/2022	
  8820                                  	;;transfer SYS_RET_OK
  8821                                  	;jmp	short jmp_SYS_RET_OK
  8822                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8823                                  	;;jmp	SYS_RET_OK
  8824                                  	;jmp	short jmp_SYS_RET_OK
  8825                                  
  8826                                  ; --------------------------------------------------------------------------
  8827                                  ; 10/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM - DOSCODE:4EB4h)
  8828                                  ; --------------------------------------------------------------------------
  8829                                  
  8830                                  	; INT 21h, AH=71h - LONG FILENAME FUNCTIONS
  8831                                  	; INT 21h, AH=72h - LFN FindClose
  8832                                  _$LONGNAME:
  8833 00000FEC 30C0                    	xor	al,al			; longname functions are not supported
  8834                                  lfn_error:
  8835 00000FEE E886F4                  	call	Get_User_Stack
  8836 00000FF1 834C1601                	or	word [si+16h],1		; [SI+user_env.user_F],f_Carry
  8837 00000FF5 F9                      	stc
  8838 00000FF6 8904                    	mov	[si],ax			; [SI+user_env.user_ax]
  8839 00000FF8 C3                      	retn
  8840                                  ; ---------------------------------------------------------------------------
  8841                                  
  8842                                  	; FAT32 - EXTENDED FUNCTIONS 
  8843                                  	; INT 21h, AH=73h
  8844                                  _$FAT32EXT:
  8845 00000FF9 3C05                    	cmp	al,5			; INT 21h AX = 7305h
  8846 00000FFB 7609                    	jbe	short valid_fat32_ext_function
  8847 00000FFD B001                    	mov	al,1			; error_invalid_function
  8848                                  fat32_ext_func_err:
  8849 00000FFF E972F6                  	jmp	SYS_RET_ERR
  8850                                  
  8851                                  function_5_invalid_cx:
  8852 00001002 B057                    	mov	al,57h			; error_invalid_parameter
  8853                                  fat32_ext_func_err_j:
  8854 00001004 EBF9                    	jmp	short fat32_ext_func_err
  8855                                  
  8856                                  valid_fat32_ext_function:
  8857 00001006 7524                    	jnz	short not_function_5
  8858 00001008 83F9FF                  	cmp	cx,0FFFFh 	; Function 5 - FAT32 - EXTENDED ABSOLUTE DISK READ/WRITE
  8859 0000100B 75F5                    	jne	short function_5_invalid_cx
  8860 0000100D F7C6FE9F                	test	si,9FFEh		; read/write mode flags
  8861 00001011 75EF                    	jnz	short function_5_invalid_cx
  8862 00001013 88D0                    	mov	al,dl			; drive number, 1 = A
  8863 00001015 FEC8                    	dec	al
  8864 00001017 B401                    	mov	ah,1
  8865 00001019 F7C60100                	test	si,1
  8866 0000101D 7405                    	jz	short function_5_read
  8867 0000101F E8BFF5                  	call	FAT32_ABSDWRT		; INT 21h AX = 7305h (SI bit 0 = 1)
  8868 00001022 EB03                    	jmp	short fat32_absdrw_ret
  8869                                  
  8870                                  function_5_read:
  8871 00001024 E80AF5                  	call	FAT32_ABSDRD		; INT 21h AX = 7305h (SI bit 0 = 0)
  8872                                  fat32_absdrw_ret:
  8873 00001027 72C5                    	jc	short lfn_error
  8874 00001029 E93EF6                  	jmp	SYS_RET_OK
  8875                                  
  8876                                  not_function_5:
  8877 0000102C 3C03                    	cmp	al,3		; Function 3 - FAT32 - GET EXTENDED FREE SPACE ON DRIVE
  8878 0000102E 7475                    	je	short function_73_3
  8879 00001030 3C02                    	cmp	al,2
  8880 00001032 7203                    	jb	short chk_drive_lock_flush
  8881 00001034 E90503                  	jmp	_$GET_DPB	; Function 2 - FAT32 - "Get_ExtDPB" - GET EXTENDED DPB
  8882                                  			  	; Function 4 - FAT32 - Set DPB TO USE FOR FORMATTING
  8883                                  
  8884                                  chk_drive_lock_flush:
  8885 00001037 80FA1A                  	cmp	dl,26			; MSDOS 7 - DRIVE LOCKING AND FLUSHING
  8886 0000103A 7604                    	jbe	short drv_lock_flush_1
  8887 0000103C B00F                    	mov	al,0Fh			; invalid drive number
  8888                                  drv_lock_flush_err:
  8889                                  	;jmp	short fat32_ext_func_err_j ; ax = error code
  8890                                  	; 10/01/2024
  8891 0000103E EBBF                    	jmp	short fat32_ext_func_err
  8892                                  
  8893                                  drv_lock_flush_1:
  8894 00001040 FECA                    	dec	dl
  8895 00001042 7905                    	jns	short drv_lock_flush_2
  8896 00001044 368A16[3603]            	mov	dl,[ss:CURDRV]		; 0 = default/current drive)
  8897                                  drv_lock_flush_2:
  8898 00001049 B600                    	mov	dh,0
  8899 0000104B 89D3                    	mov	bx,dx
  8900 0000104D 80F901                  	cmp	cl,1			; which flag to get or set
  8901 00001050 7604                    	jbe	short drv_lock_flush_3
  8902 00001052 B001                    	mov	al,1			; error_invalid_function
  8903                                  	;jmp	short drv_lock_flush_err
  8904                                  	; 10/01/2024
  8905 00001054 EBA9                    	jmp	short fat32_ext_func_err
  8906                                  
  8907                                  drv_lock_flush_3:
  8908 00001056 368AA7[0813]            	mov	ah,[ss:drive_flags+bx]
  8909 0000105B 08C9                    	or	cl,cl
  8910 0000105D 7422                    	jz	short get_set_indctd_flag ; use bit 1 and bit 2
  8911 0000105F 08C0                    	or	al,al			; get drive's dirty-buffers flag
  8912 00001061 7419                    	jz	short get_dirty_buf_flag ; use bit 3
  8913 00001063 80E4F7                  	and	ah,0F7h			; clear bit 3
  8914 00001066 80E508                  	and	ch,8			; izolate bit 3 of the new flag value
  8915 00001069 08EC                    	or	ah,ch			; set AH bit 3 according to CH bit 3
  8916 0000106B 3688A7[0813]            	mov	[ss:drive_flags+bx],ah	; set or reset dirty buffer flag
  8917 00001070 F6C408                  	test	ah,8
  8918 00001073 7505                    	jnz	short set_dirty_flag_ok	; bit 3 is set/1
  8919 00001075 B0FF                    	mov	al,0FFh
  8920 00001077 E84B5A                  	call	FLUSHBUF
  8921                                  set_dirty_flag_ok:
  8922 0000107A EB26                    	jmp	short jmp_to_SYS_RET_OK
  8923                                  
  8924                                  get_dirty_buf_flag:
  8925 0000107C 80E408                  	and	ah,8			; izolate dirty buffers flag
  8926 0000107F EB19                    	jmp	short mov_flag_cl_to_al	; AH = new flag and 08h (bit 3 used)
  8927                                  
  8928                                  get_set_indctd_flag:
  8929 00001081 08C0                    	or	al,al
  8930 00001083 7412                    	jz	short get_indicated_flag
  8931 00001085 80E4F9                  	and	ah,0F9h			; clear bit 1 and bit 2
  8932 00001088 F6C502                  	test	ch,2			; new value for indicated flag
  8933 0000108B 7403                    	jz	short reset_indctd_flags ; bit 1 is zero
  8934 0000108D 80CC06                  	or	ah,6			; set bit 1 and bit 2
  8935                                  reset_indctd_flags:
  8936 00001090 3688A7[0813]            	mov	[ss:drive_flags+bx],ah
  8937 00001095 EB0B                    	jmp	short jmp_to_SYS_RET_OK
  8938                                  
  8939                                  get_indicated_flag:
  8940 00001097 80E406                  	and	ah,6			; AH = new flag and 06h (bits 1 and 2 used)
  8941                                  mov_flag_cl_to_al:			; CODE XREF: DOSCODE:4F47^j
  8942 0000109A 88C8                    	mov	al,cl			; value of CL on entry
  8943                                  ret_ax_to_user_cx:  ; ax -> user's cx
  8944 0000109C E8D8F3                  	call	Get_User_Stack
  8945 0000109F 894404                  	mov	[si+4],ax		; [SI+user_env.user_cx] ; requested flag
  8946                                  jmp_to_SYS_RET_OK:
  8947 000010A2 E9C5F5                  	jmp	SYS_RET_OK
  8948                                  
  8949                                  function_73_3:
  8950 000010A5 89D6                    	mov	si,dx		; FAT32 - GET EXTENDED FREE SPACE ON DRIVE
  8951                                  				; AX = 7303h
  8952                                  				; DS:DX -> ASCIZ string for drive ("C:\" or "\\SERVER\Share")
  8953                                  				; ES:DI -> buffer for extended free space structure
  8954                                  				; CX = length of buffer for extended free space
  8955 000010A7 E8136F                  	call	DriveFromText
  8956 000010AA 92                      	xchg	ax,dx
  8957 000010AB AD                      	lodsw
  8958 000010AC FECA                    	dec	dl
  8959 000010AE 80FA1A                  	cmp	dl,26
  8960 000010B1 7323                    	jnb	short func_73_3_err2
  8961 000010B3 08E4                    	or	ah,ah
  8962 000010B5 751F                    	jnz	short func_73_3_err2
  8963 000010B7 E85D4D                  	call	PATHCHRCMP
  8964 000010BA 751A                    	jnz	short func_73_3_err2
  8965 000010BC FEC2                    	inc	dl
  8966 000010BE 83F92C                  	cmp	cx,44			; buffer (Structure) size must be 44
  8967 000010C1 721C                    	jb	short func_73_3_err4
  8968 000010C3 26837D0200              	cmp	word [es:di+2],0	; buffer structure version (must be 0)
  8969 000010C8 7511                    	jnz	short func_73_3_err3
  8970 000010CA 16                      	push	ss
  8971 000010CB 1F                      	pop	ds
  8972 000010CC 88D0                    	mov	al,dl
  8973 000010CE E8EC6A                  	call	GETTHISDRV
  8974 000010D1 7310                    	jnc	short fill_efs_struc_b
  8975                                  func_73_3_err1:
  8976 000010D3 E8B3F5                  	call	FCB_RET_ERR
  8977                                  func_73_3_err2:
  8978 000010D6 B00F                    	mov	al,0Fh			; error_invalid_drive
  8979                                  jmp_to_SYS_RET_ERR:
  8980 000010D8 E999F5                  	jmp	SYS_RET_ERR
  8981                                  
  8982                                  func_73_3_err3:
  8983 000010DB B057                    	mov	al,57h			; error_invalid_parameter
  8984                                  jmp_to_jmp_SYS_RET_ERR:
  8985 000010DD EBF9                    	jmp	short jmp_to_SYS_RET_ERR
  8986                                  
  8987                                  func_73_3_err4:
  8988 000010DF B018                    	mov	al,18h	   		; error_bad_length
  8989 000010E1 EBFA                    	jmp	short jmp_to_jmp_SYS_RET_ERR
  8990                                  
  8991                                  fill_efs_struc_b:
  8992 000010E3 E87E22                  	call	DISK_INFO
  8993 000010E6 72EB                    	jc	short func_73_3_err1
  8994 000010E8 30E4                    	xor	ah,ah
  8995 000010EA 56                      	push	si			; si:dx = free cluster count
  8996 000010EB 57                      	push	di			; di:bx = number of clusters
  8997 000010EC E888F3                  	call	Get_User_Stack
  8998 000010EF 8E4410                  	mov	es,[si+10h]		; user's buffer segment (in ES)
  8999 000010F2 8B7C0A                  	mov	di,[si+0Ah]		; user's buffer offset/address (in DI)
  9000                                  	; 10/01/2024
  9001 000010F5 06                      	push	es
  9002 000010F6 1F                      	pop	ds ; (*)
  9003                                  	;
  9004                                  	;mov	[es:di+10h],bx		; total number of clusters on the drive
  9005                                  	;mov	[es:di+20h],bx		; total allocation units, without adjustment for compression
  9006 000010F7 895D10                  	mov	[di+10h],bx
  9007 000010FA 895D20                  	mov	[di+20h],bx
  9008 000010FD 5B                      	pop	bx
  9009                                  	;mov	[es:di+12h],bx		; total number of clusters on the drive, hw
  9010                                  	;mov	[es:di+22h],bx		; total allocation units, hw
  9011                                  	;mov	[es:di+0Ch],dx		; number of available clusters
  9012                                  	;mov	[es:di+1Ch],dx		; number of available allocation units, without adjustment
  9013 000010FE 895D12                  	mov	[di+12h],bx
  9014 00001101 895D22                  	mov	[di+22h],bx
  9015 00001104 89550C                  	mov	[di+0Ch],dx
  9016 00001107 89551C                  	mov	[di+1Ch],dx
  9017 0000110A 5A                      	pop	dx
  9018                                  	;mov	[es:di+0Eh],dx		; number of available clusters, hw
  9019                                  	;mov	[es:di+1Eh],dx		; number of available allocation units, hw
  9020                                  	;mov	[es:di+8],cx		; bytes per sector
  9021                                  	;mov	[es:di+4],ax		; sectors per cluster (with adjustment for compression)
  9022 0000110B 89550E                  	mov	[di+0Eh],dx
  9023 0000110E 89551E                  	mov	[di+1Eh],dx
  9024 00001111 894D08                  	mov	[di+8],cx
  9025 00001114 894504                  	mov	[di+4],ax	
  9026 00001117 89C1                    	mov	cx,ax
  9027 00001119 F7E3                    	mul	bx			; 32 bit multiplication
  9028 0000111B 720B                    	jc	short dsk_cap_calc_overf ; disk capacity calculation overflow error
  9029 0000111D 89C3                    	mov	bx,ax
  9030                                  	;mov	ax,[es:di+20h]		; total allocation units, lw
  9031 0000111F 8B4520                  	mov	ax,[di+20h]
  9032 00001122 F7E1                    	mul	cx
  9033 00001124 01DA                    	add	dx,bx
  9034 00001126 7305                    	jnb	short dsk_cap_calc_ok
  9035                                  dsk_cap_calc_overf:
  9036 00001128 B8FFFF                  	mov	ax,0FFFFh		; set to 0FFFFFFFFh
  9037 0000112B 89C2                    	mov	dx,ax
  9038                                  dsk_cap_calc_ok:
  9039                                  	; 10/01/2024
  9040                                  	; ds = es (*)
  9041                                  	;mov	[es:di+1Ah],dx
  9042                                  	;mov	[es:di+18h],ax		; total number of physical sectors on the drive,
  9043                                  					; without adjustment for compression
  9044 0000112D 89551A                  	mov	[di+1Ah],dx
  9045 00001130 894518                  	mov	[di+18h],ax
  9046 00001133 89C8                    	mov	ax,cx			; 32 bit multiplication
  9047                                  	;mul	word [es:di+0Eh]	; number of available clusters, hw
  9048 00001135 F7650E                  	mul	word [di+0Eh]
  9049 00001138 720B                    	jc	short dsk_free_calc_overf
  9050 0000113A 89C3                    	mov	bx,ax
  9051                                  	;mov	ax,[es:di+0Ch]		; number of available clusters, lw
  9052 0000113C 8B450C                  	mov	ax,[di+0Ch]
  9053 0000113F F7E1                    	mul	cx
  9054 00001141 01DA                    	add	dx,bx
  9055 00001143 7305                    	jnc	short dsk_free_calc_ok
  9056                                  dsk_free_calc_overf:
  9057 00001145 B8FFFF                  	mov	ax,0FFFFh
  9058 00001148 89C2                    	mov	dx,ax
  9059                                  dsk_free_calc_ok:
  9060                                  	; 10/01/2024
  9061                                  	;mov	[es:di+16h],dx		; hw
  9062                                  	;mov	[es:di+14h],ax		; number of physical sectors available on the drive,
  9063                                  					; without adjustment for compression
  9064 0000114A 895516                  	mov	[di+16h],dx
  9065 0000114D 894514                  	mov	[di+14h],ax
  9066 00001150 31C0                    	xor	ax,ax	; 0
  9067                                  	;mov	[es:di+0Ah],ax		; number of bytes per sector, high word = 0
  9068                                  	;mov	[es:di+6],ax		; number of sectors per cluster, high word = 0
  9069 00001152 89450A                  	mov	[di+0Ah],ax
  9070 00001155 894506                  	mov	[di+6],ax
  9071                                  	
  9072                                  	;mov	[es:di+24h],ax		; reserved, 8 bytes zero
  9073                                  	;mov	[es:di+26h],ax
  9074                                  	;mov	[es:di+28h],ax
  9075                                  	;mov	[es:di+2Ah],ax
  9076 00001158 83C724                  	add	di,24h ; 36 ; 10/01/2024
  9077 0000115B AB                      	stosw
  9078 0000115C AB                      	stosw
  9079 0000115D AB                      	stosw
  9080 0000115E AB                      	stosw
  9081 0000115F B82C00                  	mov	ax,44
  9082 00001162 29C7                    	sub	di,ax ; 10/01/2024 
  9083                                  	;mov	[es:di],ax		; size of returned structure = 44
  9084                                  	; 10/01/2024
  9085                                  	;mov	[di],ax
  9086 00001164 AB                      	stosw
  9087 00001165 E902F5                  	jmp	SYS_RET_OK
  9088                                  
  9089                                  ; ---------------------------------------------------------------------------
  9090                                  
  9091                                  ; 12/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM/MSDOS.SYS)
  9092                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:504Ah
  9093                                  
  9094                                  Set_DPBforFormat:	; INT 21h, AX = 7304h (continues from _$GET_DPB)
  9095                                  	; 12/01/2024			; (Ref: Ralf Brown's Interrupt List)
  9096 00001168 B81800                  	mov	ax,18h
  9097 0000116B 394404                  	cmp	[si+4],ax	
  9098                                  	;cmp	word ptr [si+4],24	; [SI+user_env.user_CX]
  9099                                  					; size of buffer (must be at least 18h)
  9100                                  	;jnb	short setdpbf_2
  9101                                  	;mov	al,18h			; error_bad_length
  9102                                  ;setdpbf_1:
  9103                                  	;jmp	SYS_RET_ERR
  9104 0000116E 7223                    	jb	short setdpbf_1 ; al = 18h
  9105                                  setdpbf_2:
  9106 00001170 06                      	push	es			; ES:BP = Drive parameter block
  9107 00001171 55                      	push	bp
  9108 00001172 8E4410                  	mov	es,[si+10h]		; [SI+user_env.user_ES]
  9109 00001175 8B7C0A                  	mov	di,[si+0Ah]		; [SI+user_env.user_DI]
  9110 00001178 5E                      	pop	si
  9111 00001179 1F                      	pop	ds
  9112                                  
  9113 0000117A 268B4504                	mov	ax,[es:di+4]		; (call) function number
  9114 0000117E 26837D0200              	cmp	word [es:di+2],0	; structure version (must be 0)
  9115 00001183 750C                    	jnz	short setdpbf_3
  9116 00001185 26837D0600              	cmp	word [es:di+6],0	; (must be 0)
  9117 0000118A 7505                    	jnz	short setdpbf_3
  9118 0000118C 83F804                  	cmp	ax,4			; (max) 5 functions (0 to 4)
  9119 0000118F 7605                    	jbe	short setdpbf_4
  9120                                  setdpbf_3:
  9121 00001191 B057                    	mov	al,57h			; error_invalid_parameter
  9122                                  	;jmp	short setdpbf_1
  9123                                  setdpbf_1:
  9124 00001193 E9DEF4                  	jmp	SYS_RET_ERR
  9125                                  
  9126                                  setdpbf_4:
  9127 00001196 26C7051800              	mov	word [es:di],18h	; (call) size
  9128 0000119B 08C0                    	or	al,al
  9129 0000119D 7403                    	jz	short setdpbf_5		; invalidate DPB counts
  9130 0000119F E98200                  	jmp	setdpbf_18
  9131                                  
  9132                                  setdpbf_5:
  9133 000011A2 31D2                    	xor	dx,dx	; 0
  9134 000011A4 8B5C0D                  	mov	bx,[si+0Dh]		; DPB.MAX_CLUSTER
  9135 000011A7 39540F                  	cmp	[si+0Fh],dx ; 0
  9136                                  	;cmp	word [si+0Fh],0		; DPB.FAT_SIZE
  9137 000011AA 7506                    	jnz	short setdpbf_6		; not FAT32
  9138 000011AC 8B542F                  	mov	dx,[si+2Fh]
  9139 000011AF 8B5C2D                  	mov	bx,[si+2Dh]		; DPB.LAST_CLUSTER
  9140                                  setdpbf_6:
  9141 000011B2 268B450A                	mov	ax,[es:di+0Ah]
  9142 000011B6 268B4D08                	mov	cx,[es:di+8]		; new DPB free count
  9143                                  		  		; (00000000h=no change, FFFFFFFFh=unknown)
  9144 000011BA 09C0                    	or	ax,ax
  9145 000011BC 7502                    	jnz	short setdpbf_7
  9146 000011BE E322                    	jcxz	setdpbf_11
  9147                                  setdpbf_7:
  9148 000011C0 83F8FF                  	cmp	ax,0FFFFh
  9149 000011C3 7505                    	jne	short setdpbf_8
  9150 000011C5 83F9FF                  	cmp	cx,0FFFFh
  9151 000011C8 7408                    	je	short setdpbf_10	; (set as UNKNOWN/INITIAL)
  9152                                  setdpbf_8:
  9153 000011CA 39D0                    	cmp	ax,dx			; must be < DPB.LAST_CLUSTER
  9154 000011CC 7502                    	jne	short setdpbf_9
  9155 000011CE 39D9                    	cmp	cx,bx
  9156                                  setdpbf_9:
  9157 000011D0 73BF                    	jnb	short setdpbf_3
  9158                                  setdpbf_10:
  9159 000011D2 804C1801                	or	byte [si+18h],1		; DPB.FIRST_ACCESS (bit 0 = 1)
  9160 000011D6 894C1F                  	mov	[si+1Fh],cx		; DPB.FREE_CNT
  9161 000011D9 837C0F00                	cmp	word [si+0Fh],0		; DP.FAT_SIZE
  9162 000011DD 7503                    	jnz	short setdpbf_11	; FAT12 or FAT16
  9163 000011DF 894421                  	mov	[si+21h],ax		; DPB.FREE_CNT_HW
  9164                                  setdpbf_11:
  9165 000011E2 268B450E                	mov	ax,[es:di+0Eh]
  9166 000011E6 268B4D0C                	mov	cx,[es:di+0Ch]		; new DPB next-free
  9167                                  		  		; (00000000h=no change, FFFFFFFFh=unknown)
  9168 000011EA 09C0                    	or	ax,ax
  9169 000011EC 7502                    	jnz	short setdpbf_12
  9170 000011EE E32E                    	jcxz	setdpbf_17
  9171                                  setdpbf_12:
  9172 000011F0 83F8FF                  	cmp	ax,0FFFFh
  9173 000011F3 7505                    	jne	short setdpbf_13
  9174 000011F5 83F9FF                  	cmp	cx,0FFFFh
  9175 000011F8 7411                    	je	short setdpbf_16	; (set as UNKNOWN/INITIAL)
  9176                                  setdpbf_13:
  9177 000011FA 21C0                    	and	ax,ax
  9178                                  	;cmp	ax,0			; must be >= 2
  9179 000011FC 7505                    	jnz	short setdpbf_14
  9180 000011FE 83F902                  	cmp	cx,2
  9181                                  ;setdpbf_14:
  9182 00001201 728E                    	jb	short setdpbf_3
  9183                                  setdpbf_14:
  9184 00001203 39D0                    	cmp	ax,dx			; must be < DPB.LAST_CLUSTER
  9185 00001205 7502                    	jne	short setdpbf_15
  9186 00001207 39D9                    	cmp	cx,bx
  9187                                  setdpbf_15:
  9188 00001209 7786                    	ja	short setdpbf_3
  9189                                  setdpbf_16:
  9190 0000120B 804C1801                	or	byte [si+18h],1		; DPB.FIRST_ACCESS (bit 0 = 1)
  9191 0000120F 894C1D                  	mov	[si+1Dh],cx		; DPB.NEXT_FREE
  9192 00001212 837C0F00                	cmp	word [si+0Fh],0		; DPB.FAT_SIZE
  9193 00001216 7506                    	jnz	short setdpbf_17	; FAT16 or FAT12
  9194 00001218 89443B                  	mov	[si+3Bh],ax
  9195 0000121B 894C39                  	mov	[si+39h],cx		; DPB.FAT32_NXTFREE
  9196                                  setdpbf_17:
  9197 0000121E B80473                  	mov	ax,7304h		; done (successful)
  9198 00001221 E946F4                  	jmp	SYS_RET_OK
  9199                                  
  9200                                  setdpbf_18:
  9201                                  	;dec	al
  9202 00001224 48                      	dec	ax
  9203 00001225 7514                    	jnz	short setdpbf_19
  9204 00001227 1E                      	push	ds			; rebuild DPB from BPB
  9205 00001228 56                      	push	si
  9206 00001229 26C57508                	lds	si,[es:di+8]		; BIOS Parameter Block
  9207 0000122D 5D                      	pop	bp
  9208 0000122E 07                      	pop	es
  9209 0000122F B95845                  	mov	cx,4558h		; 'XE' (NASM syntax)
  9210 00001232 BA5241                  	mov	dx,4152h		; 'RA' (NASM syntax)
  9211 00001235 E82302                  	call	_$SETDPB
  9212 00001238 E92FF4                  	jmp	SYS_RET_OK
  9213                                  
  9214                                  setdpbf_19:
  9215                                  	;dec	al
  9216 0000123B 48                      	dec	ax
  9217 0000123C 7507                    	jnz	short setdpbf_20
  9218                                  		  ; force media change
  9219                                  		  ; (next access to drive rebuild DPB)
  9220 0000123E 804C1880                	or	byte [si+18h],80h	; DPB.FIRST_ACCESS (bit 7 = 1)
  9221                                  setdpbf_29:	; 12/01/2024
  9222 00001242 E925F4                  	jmp	SYS_RET_OK
  9223                                  
  9224                                  setdpbf_20:
  9225 00001245 837C0F00                	cmp	word [si+0Fh],0		; DPB.FAT_SIZE
  9226 00001249 7405                    	jz	short setdpbf_22 ; FAT32
  9227 0000124B B00F                    	mov	al,0Fh			; error_invalid_drive
  9228                                  		 ; (function 3 or 4 are only for drives with FAT32 fs)
  9229                                  setdpbf_21:
  9230 0000124D E924F4                  	jmp	SYS_RET_ERR
  9231                                  
  9232                                  setdpbf_22:
  9233                                  	;dec	al
  9234 00001250 48                      	dec	ax
  9235 00001251 7454                    	jz	short setdpbf_30	; get/set active FAT number and mirroring
  9236 00001253 8B4435                  	mov	ax,[si+35h]		; DPB.ROOT_CLUSTER		
  9237                                  			; get/set root directory cluster number
  9238 00001256 2689450C                	mov	[es:di+0Ch],ax		; (ret) previous root directory cluster number
  9239 0000125A 8B4437                  	mov	ax,[si+37h]
  9240 0000125D 2689450E                	mov	[es:di+0Eh],ax
  9241 00001261 268B4D0A                	mov	cx,[es:di+0Ah]
  9242 00001265 268B4508                	mov	ax,[es:di+8]		; (call) new root directory cluster number
  9243 00001269 83F8FF                  	cmp	ax,0FFFFh		; -1 --> return only previous root dir cluster number
  9244 0000126C 7505                    	jne	short setdpbf_23
  9245 0000126E 83F9FF                  	cmp	cx,0FFFFh
  9246 00001271 74CF                    	je	short setdpbf_29
  9247                                  setdpbf_23:
  9248 00001273 21C9                    	and	cx,cx
  9249                                  	;cmp	cx,0			; cluster number must be >= 2
  9250                                  	;jnz	short setdpbf_24
  9251 00001275 7509                    	jnz	short setdpbf_26
  9252 00001277 83F802                  	cmp	ax,2
  9253                                  setdpbf_24:
  9254 0000127A 7304                    	jnb	short setdpbf_26
  9255                                  setdpbf_25:
  9256                                  	;jmp	setdpbf_3		; error (invalid parameter)
  9257                                  	; 12/01/2024
  9258 0000127C B057                    	mov	al,57h			; error_invalid_parameter
  9259 0000127E EBCD                    	jmp	short setdpbf_21
  9260                                  
  9261                                  setdpbf_26:
  9262 00001280 3B4C2F                  	cmp	cx,[si+2Fh]		; must be <= DPB.LAST_CLUSTER
  9263 00001283 7503                    	jne	short setdpbf_27
  9264 00001285 3B442D                  	cmp	ax,[si+2Dh]
  9265                                  setdpbf_27:
  9266 00001288 77F2                    	ja	short setdpbf_25	; error
  9267 0000128A 894C37                  	mov	[si+37h],cx		; DPB.ROOT_CLUSTER
  9268 0000128D 894435                  	mov	[si+35h],ax
  9269 00001290 804C1802                	or	byte [si+18h],2		; DPB.FIRST_ACCESS (bit 1 = 1)
  9270 00001294 1E                      	push    ds
  9271 00001295 56                      	push    si
  9272 00001296 5D                      	pop	bp
  9273 00001297 07                      	pop	es
  9274 00001298 E84806                  	call    ECritDisk
  9275 0000129B E8CF21                  	call    update_fat32_fsinfo
  9276 0000129E E86F06                  	call    LCritDisk
  9277 000012A1 739F                    	jnc	short setdpbf_29
  9278 000012A3 B01F                    	mov	al,1Fh			; error_gen_failure
  9279                                  setdpbf_28:
  9280 000012A5 EBA6                    	jmp	short setdpbf_21
  9281                                  
  9282                                  	; 12/01/2024
  9283                                  ;setdpbf_29:
  9284                                  	;jmp	SYS_RET_OK
  9285                                  
  9286                                  setdpbf_30:
  9287                                  	; 12/01/2024
  9288                                  	; ax = 0
  9289 000012A7 8164238F00              	and	word [si+23h],8Fh	; DPB.EXT_FLAGS (clear bit 4-6)
  9290 000012AC 8B4C23                  	mov	cx,[si+23h]
  9291 000012AF 26894D0C                	mov	[es:di+0Ch],cx		; (ret) previous active FAT/mirroring state
  9292 000012B3 2689450E                	mov	[es:di+0Eh],ax ; 0
  9293                                  	;mov	word [es:di+0Eh],0	; put zero to Set_DPBforFormat struc offset 14
  9294 000012B7 268B5508                	mov	dx,[es:di+8]		; (call) new active FAT/mirroring state,
  9295                                  		  			;  or FFFFFFFFh to get
  9296 000012BB 83FAFF                  	cmp	dx,0FFFFh
  9297                                  	;jnz	short setdpbf_31
  9298                                  	;jmp	SYS_RET_OK
  9299                                  	; 12/01/2024
  9300 000012BE 7482                    	je	short setdpbf_29
  9301                                  
  9302                                  setdpbf_31:
  9303 000012C0 F7C270FF                	test    dx,0FF70h
  9304                                  	;jz	short setdpbf_33	; bit 4-6 of DPB.EXT_FLAGS must be 0
  9305                                  	;mov	al,57h			; error_invalid_parameter
  9306                                  	; 12/01/2024
  9307 000012C4 75B6                    	jnz	short setdpbf_25
  9308                                  setdpbf_32:
  9309                                  	;;jmp	short setdpbf_28
  9310                                  	; 12/01/2024
  9311                                  	;jmp	short setdpbf_21
  9312                                  	
  9313                                  setdpbf_33:
  9314 000012C6 B001                    	mov	al,1			; error_invalid_function
  9315                                  					; (modification is not allowed)
  9316                                  	;jmp	short setdpbf_32
  9317                                  	; 12/01/2024
  9318 000012C8 EB83                    	jmp	short setdpbf_21
  9319                                  
  9320                                  ; ---------------------------------------------------------------------------
  9321                                  
  9322                                  ;============================================================================
  9323                                  ; PARSE.ASM, MSDOS 6.0, 1991
  9324                                  ;============================================================================
  9325                                  ; 19/07/2018 - Retro DOS v3.0
  9326                                  ; 15/05/2019 - Retro DOS v4.0
  9327                                  
  9328                                  ; System calls for parsing command lines
  9329                                  ;
  9330                                  ;   $PARSE_FILE_DESCRIPTOR
  9331                                  ;
  9332                                  ;   Modification history:
  9333                                  ;
  9334                                  ;       Created: ARR 30 March 1983
  9335                                  ;               EE PathParse 10 Sept 1983
  9336                                  ;
  9337                                  
  9338                                  ;BREAK <$Parse_File_Descriptor -- Parse an arbitrary string into an FCB>
  9339                                  ;---------------------------------------------------------------------------
  9340                                  ; Inputs:
  9341                                  ;       DS:SI Points to a command line
  9342                                  ;       ES:DI Points to an empty FCB
  9343                                  ;       Bit 0 of AL = 1 At most one leading separator scanned off
  9344                                  ;                   = 0 Parse stops if separator encountered
  9345                                  ;       Bit 1 of AL = 1 If drive field blank in command line - leave FCB
  9346                                  ;                   = 0  "    "    "     "         "      "  - put 0 in FCB
  9347                                  ;       Bit 2 of AL = 1 If filename field blank - leave FCB
  9348                                  ;                   = 0  "       "      "       - put blanks in FCB
  9349                                  ;       Bit 3 of AL = 1 If extension field blank - leave FCB
  9350                                  ;                   = 0  "       "      "        - put blanks in FCB
  9351                                  ; Function:
  9352                                  ;       Parse command line into FCB
  9353                                  ; Returns:
  9354                                  ;       AL = 1 if '*' or '?' in filename or extension, 0 otherwise
  9355                                  ;       DS:SI points to first character after filename
  9356                                  ;---------------------------------------------------------------------------
  9357                                  
  9358                                  	; 13/01/2024
  9359                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:51BFh
  9360                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:4D22h
  9361                                  
  9362                                  _$PARSE_FILE_DESCRIPTOR:
  9363 000012CA E8C449                  	call	MAKEFCB
  9364 000012CD 56                      	PUSH    SI
  9365 000012CE E8A6F1                  	call	Get_User_Stack
  9366                                  	;pop	word [si+8]
  9367 000012D1 8F4408                  	POP     word [SI+user_env.user_SI]
  9368 000012D4 C3                      	retn
  9369                                  
  9370                                  ; --------------------------------------------------------------------------
  9371                                  ; 13/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM - DOSCODE:51CAh)
  9372                                  ; --------------------------------------------------------------------------
  9373                                  
  9374                                  set_exerr_locus_unk:
  9375 000012D5 50                      	push    ax
  9376 000012D6 B001                    	mov     al,1		; errLOC_Unk
  9377                                  set_exerr_locus:
  9378 000012D8 36A2[2303]                      mov	[ss:EXTERR_LOCUS],al
  9379 000012DC 58                              pop	ax
  9380 000012DD C3                              retn
  9381                                  
  9382                                  set_exerr_locus_disk:
  9383 000012DE 50                      	push	ax
  9384 000012DF B002                    	mov	al,2		; errLOC_Disk
  9385 000012E1 EBF5                    	jmp	short set_exerr_locus
  9386                                  
  9387                                  set_exerr_locus_ser:
  9388 000012E3 50                      	push	ax
  9389 000012E4 B004                    	mov	al,4		; errLOC_SerDev
  9390 000012E6 EBF0                    	jmp	short set_exerr_locus
  9391                                  
  9392                                  set_exerr_locus_mem:
  9393 000012E8 50                      	push	ax
  9394 000012E9 B005                    	mov	al,5		; errLOC_Mem
  9395 000012EB EBEB                    	jmp	short set_exerr_locus
  9396                                  
  9397                                  ; ---------------------------------------------------------------------------
  9398                                  
  9399                                  ;============================================================================
  9400                                  ; MISC.ASM, MSDOS 6.0, 1991
  9401                                  ;============================================================================
  9402                                  ; 19/07/2018 - Retro DOS v3.0
  9403                                  
  9404                                  ; 29/04/2019 - Retro DOS v4.0
  9405                                  
  9406                                  ;ENTRYPOINTSEG	EQU	0CH
  9407                                  ;MAXDIF		EQU	0FFFH
  9408                                  ;SAVEXIT 	EQU	10
  9409                                  ;WRAPOFFSET	EQU	0FEF0h
  9410                                  
  9411                                  ;
  9412                                  ;----------------------------------------------------------------------------
  9413                                  ;
  9414                                  ;**	$SLEAZEFUNC - Get a Pointer to the Media Byte
  9415                                  ;
  9416                                  ;	Return Stuff sort of like old get fat call
  9417                                  ;
  9418                                  ;	ENTRY	none
  9419                                  ;	EXIT	DS:BX = Points to FAT ID byte (IBM only)
  9420                                  ;			GOD help anyone who tries to do ANYTHING except
  9421                                  ;			READ this ONE byte.
  9422                                  ;		DX = Total Number of allocation units on disk
  9423                                  ;		CX = Sector size
  9424                                  ;		AL = Sectors per allocation unit
  9425                                  ;		   = -1 if bad drive specified
  9426                                  ;	USES	all
  9427                                  ;
  9428                                  ;**	$SLEAZEFUNCDL - Get a Pointer to the Media Byte
  9429                                  ;
  9430                                  ;	Identical to $SLEAZEFUNC except (dl) = drive
  9431                                  ;
  9432                                  ;	ENTRY	(dl) = drive (0=default, 1=A, 2=B, etc.)
  9433                                  ;	EXIT	DS:BX = Points to FAT ID byte (IBM only)
  9434                                  ;			GOD help anyone who tries to do ANYTHING except
  9435                                  ;			READ this ONE byte.
  9436                                  ;		DX = Total Number of allocation units on disk
  9437                                  ;		CX = Sector size
  9438                                  ;		AL = Sectors per allocation unit
  9439                                  ;		   = -1 if bad drive specified
  9440                                  ;	USES	all
  9441                                  ;
  9442                                  ;----------------------------------------------------------------------------
  9443                                  ;
  9444                                  	; 10/01/2024 - Retro DOS v5.0
  9445                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:51E2h
  9446                                  
  9447                                  _$SLEAZEFUNC:
  9448                                  	; 15/05/2019 - Retro DOS v4.0
  9449 000012ED B200                    	MOV	DL,0
  9450                                  _$SLEAZEFUNCDL:
  9451 000012EF 16                      	push	ss
  9452 000012F0 1F                      	pop	ds
  9453                                  	
  9454 000012F1 88D0                    	MOV	AL,DL
  9455 000012F3 E8C768                  	call	GETTHISDRV		; Get CDS structure
  9456                                  SET_AL_RET:
  9457                                  	; MSDOS 3.3
  9458                                  	;;mov	al, 0Fh
  9459                                  	;MOV	AL,error_invalid_drive	; Assume error	;AC000;
  9460                                  	
  9461                                  	; MSDOS 6.0 & MSDOS 3.3
  9462 000012F6 7229                    	JC	short BADSLDRIVE
  9463                                  
  9464 000012F8 E86920                  	call	DISK_INFO
  9465                                  	;JC	short SET_AL_RET	; User FAILed to I 24
  9466 000012FB 7224                    	jc	short BADSLDRIVE
  9467 000012FD 8826[9805]              	MOV	[FATBYTE],AH	; FAT (MEDIA) ID byte
  9468                                  
  9469                                  	; 10/01/2024 - Retro DOS v5.0 (PCDOS 7.1)
  9470                                  	;;;
  9471 00001301 30E4                    	xor     ah, ah		; AH = 0
  9472                                  				; AL = sectors per cluster
  9473 00001303 57                      	push    di		; di:bx = number of clusters
  9474 00001304 E81A05                  	call    TestNet
  9475 00001307 5F                      	pop     di
  9476 00001308 7205                    	jc      short sleazefunc1
  9477 0000130A 51                      	push    cx		; bytes per sector
  9478 0000130B E85A21                  	call    modify_cluster_count
  9479 0000130E 59                      	pop     cx		; ax = sectors per cluster (modified)
  9480                                  				; dx = number of clusters (modified)
  9481                                  				; if bytes per cluster > 16384
  9482                                  				;    and hw of cluster count > 0
  9483                                  				;    bx = 0FFFEh (invalidated parm sign)
  9484                                  sleazefunc1:
  9485                                  	;;;
  9486                                  
  9487                                  ; NOTE THAT A FIXED MEMORY CELL IS USED --> THIS CALL IS NOT
  9488                                  ; RE-ENTRANT. USERS BETTER GET THE ID BYTE BEFORE THEY MAKE THE
  9489                                  ; CALL AGAIN
  9490                                  
  9491                                  	;MOV	DI,FATBYTE
  9492                                  	; 10/01/2024 
  9493                                  	;XOR	AH,AH			; AL has sectors/cluster
  9494 0000130F E865F1                  	call	Get_User_Stack
  9495                                  	;mov	[si+4],cx
  9496                                  	;mov	[si+6],bx
  9497                                  	;mov	[si+2],di
  9498 00001312 894C04                  	MOV	[SI+user_env.user_CX],CX
  9499 00001315 895C06                  	MOV	[SI+user_env.user_DX],BX
  9500                                  	;MOV	[SI+user_env.user_BX],DI
  9501                                  	; 10/01/2024
  9502 00001318 C74402[9805]            	MOV	word [SI+user_env.user_BX],FATBYTE
  9503                                  	
  9504                                  	;mov	[si+0Eh],ss
  9505 0000131D 8C540E                  	MOV     [SI+user_env.user_DS],SS ; stash correct pointer
  9506                                  
  9507 00001320 C3                      	retn
  9508                                  
  9509                                  BADSLDRIVE:
  9510 00001321 E965F3                  	jmp	FCB_RET_ERR
  9511                                  
  9512                                  ;
  9513                                  ;----------------------------------------------------------------------------
  9514                                  ;
  9515                                  ;**	$Get_INDOS_Flag - Return location of DOS Critical Section Flag
  9516                                  ;
  9517                                  ;	Returns location of DOS status for interrupt routines
  9518                                  ;
  9519                                  ;	ENTRY	none
  9520                                  ;	EXIT	(es:bx) = flag location
  9521                                  ;	USES	all
  9522                                  ;
  9523                                  ;----------------------------------------------------------------------------
  9524                                  ;
  9525                                  
  9526                                  _$GET_INDOS_FLAG:
  9527 00001324 E850F1                  	CALL	Get_User_Stack
  9528                                  	;MOV	WORD [SI+2],INDOS
  9529 00001327 C74402[2103]            	MOV	word [SI+user_env.user_BX],INDOS
  9530                                  getin_segm:	; 13/01/2024
  9531                                  	;MOV	[SI+10H],SS
  9532 0000132C 8C5410                  	MOV	[SI+user_env.user_ES],SS
  9533 0000132F C3                      	RETN 
  9534                                  
  9535                                  ;
  9536                                  ;----------------------------------------------------------------------------
  9537                                  ;
  9538                                  ;**	$Get_IN_Vars - Return Pointer to DOS Variables
  9539                                  ;
  9540                                  ;	Return a pointer to interesting DOS variables This call is version
  9541                                  ;	dependent and is subject to change without notice in future versions.
  9542                                  ;	Use at risk.
  9543                                  ;
  9544                                  ;	ENTRY	none
  9545                                  ;	EXIT	(es:bx) = address of SYSINITVAR
  9546                                  ;	uses	ALL
  9547                                  ;
  9548                                  ;----------------------------------------------------------------------------
  9549                                  ;
  9550                                  
  9551                                  	; 13/01/2024 - Retro DOS v5.0
  9552                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:5226h
  9553                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:4D65h
  9554                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:4D58h
  9555                                  
  9556                                  _$GET_IN_VARS:
  9557 00001330 E844F1                  	CALL	Get_User_Stack
  9558                                  	;MOV	WORD [SI+2],SYSINITVAR
  9559                                  	;MOV	word [SI+user_env.user_BX],SYSINITVAR
  9560 00001333 C74402[2600]            	MOV	word [SI+user_env.user_BX],SYSINITVARS
  9561                                  	; 13/01/2024
  9562                                  	;;MOV	[SI+10H],SS
  9563                                  	;MOV	[SI+user_env.user_ES],SS
  9564                                  	;RETN
  9565 00001338 EBF2                    	jmp	short getin_segm
  9566                                  ;
  9567                                  ;----------------------------------------------------------------------------
  9568                                  ;
  9569                                  ;**	$Get_Default_DPB - Return a pointer to the Default DPB
  9570                                  ;
  9571                                  ;	Return pointer to drive parameter table for default drive
  9572                                  ;
  9573                                  ;	ENTRY	none
  9574                                  ;	EXIT	(ds:bx) = DPB address
  9575                                  ;	USES	all
  9576                                  ;
  9577                                  ;**	$Get_DPB - Return a pointer to a specified DPB
  9578                                  ;
  9579                                  ;	Return pointer to a specified drive parameter table
  9580                                  ;
  9581                                  ;	ENTRY	(dl) = drive # (0 = default, 1=A, 2=B, etc.)
  9582                                  ;	EXIT	(al) = 0 iff ok
  9583                                  ;		  (ds:bx) = DPB address
  9584                                  ;		(al) = -1 if bad drive
  9585                                  ;	USES	all
  9586                                  ;
  9587                                  ;----------------------------------------------------------------------------
  9588                                  ;
  9589                                  
  9590                                  ; 10/01/2024
  9591                                  %if 0
  9592                                  
  9593                                  ; 15/05/2019 - Retro DOS v4.0
  9594                                  
  9595                                  _$GET_DEFAULT_DPB:
  9596                                  	MOV	DL,0
  9597                                  _$GET_DPB:
  9598                                  	push	ss
  9599                                  	pop	ds
  9600                                  
  9601                                  	MOV	AL,DL
  9602                                  	call	GETTHISDRV		; Get CDS structure
  9603                                  	JC	short ISNODRV 		; no valid drive
  9604                                  	LES	DI,[THISCDS]		; check for net CDS
  9605                                  	;;test	word [es:di+43h],8000h
  9606                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
  9607                                  	;test	byte [es:di+44h],80h
  9608                                  	test	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8)
  9609                                  	JNZ	short ISNODRV 		; No DPB to point at on NET stuff
  9610                                  	call	ECritDisk
  9611                                  	call	FATREAD_CDS		; Force Media Check and return DPB
  9612                                  	call	LCritDisk
  9613                                  	JC	short ISNODRV 		; User FAILed to I 24, only error we
  9614                                  					;   have.
  9615                                  	call	Get_User_Stack
  9616                                  	;mov	[si+2],bp
  9617                                  	MOV	[SI+user_env.user_BX],BP
  9618                                  	;mov	[si+0Eh],es
  9619                                  	MOV	[SI+user_env.user_DS],ES
  9620                                  	XOR	AL,AL
  9621                                  	retn
  9622                                  ISNODRV:
  9623                                  	MOV	AL,-1
  9624                                  	retn
  9625                                  
  9626                                  %else
  9627                                  
  9628                                  ; 13/01/2024
  9629                                  ; 10/01/2024 - Retro DOS v5.0
  9630                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:5230h
  9631                                  
  9632                                  _$GET_DEFAULT_DPB:
  9633 0000133A B200                    	MOV	DL,0
  9634                                  _$GET_DPB:
  9635 0000133C 16                      	push	ss
  9636 0000133D 1F                      	pop	ds
  9637                                  
  9638 0000133E 88D0                    	MOV	AL,DL
  9639 00001340 E87A68                  	call	GETTHISDRV		; Get CDS structure
  9640 00001343 B00F                    	mov	al,0Fh			; error_invalid_drive
  9641 00001345 7315                    	jnc	short getdpb_3		
  9642                                  
  9643                                  	; no valid drive
  9644                                  getdpb_1:
  9645                                  	; 13/01/2024
  9646 00001347 E82DF1                  	call	Get_User_Stack
  9647 0000134A 813C0273                	cmp	word [si],7302h		; INT 21h, AX = 7302h ? Get_ExtDPB
  9648                                  					; GET EXTENDED DPB
  9649 0000134E 7406                    	je      short getdpb_2
  9650 00001350 813C0473                	cmp	word [si],7304h		; INT 21h, AX = 7304h ? Set_DPBforFormat
  9651                                  					; Set DPB TO USE FOR FORMATTING
  9652 00001354 7503                    	jne	short ISNODRV
  9653                                  getdpb_2:
  9654 00001356 E91BF3                  	jmp     SYS_RET_ERR
  9655                                  
  9656                                  ISNODRV:
  9657 00001359 B0FF                    	mov	al,0FFh	; -1		; invalid (or network) drive
  9658 0000135B C3                      	retn
  9659                                  
  9660                                  getdpb_3:
  9661 0000135C C43E[A205]              	LES	DI,[THISCDS]		; check for net CDS
  9662                                  	;;test	word [es:di+43h],8000h
  9663                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
  9664                                  	;test	byte [es:di+44h],80h
  9665 00001360 26F6454480              	test	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8)
  9666                                  	;JNZ	short ISNODRV 		; No DPB to point at on NET stuff
  9667                                  	; 10/01/2024
  9668 00001365 75E0                    	jnz	short getdpb_1
  9669 00001367 E87905                  	call	ECritDisk
  9670 0000136A E81E52                  	call	FATREAD_CDS		; Force Media Check and return DPB
  9671 0000136D E8A005                  	call	LCritDisk
  9672                                  	;JC	short ISNODRV 		; User FAILed to I 24,
  9673 00001370 B053                    	mov	al,53h ; error_FAIL_I24 ;  only error we have.
  9674 00001372 72D3                    	jc	short getdpb_1
  9675 00001374 E800F1                  	call	Get_User_Stack
  9676                                  	; 13/01/2024
  9677 00001377 813C0473                	cmp	word [si],7304h		; INT 21h, AX = 7304h ?
  9678 0000137B 7503                    	jnz	short getdpb_4
  9679 0000137D E9E8FD                  	jmp	Set_DPBforFormat
  9680                                  
  9681                                  	; 13/01/2024
  9682                                  getdpb_4:
  9683 00001380 813C0273                	cmp	word [si],7302h		; INT 21h, AX = 7302h ?
  9684 00001384 7410                    	je	short getdpb_5
  9685 00001386 26837E0F00              	cmp	word [es:bp+0Fh],0
  9686 0000138B 74BA                    	jz	short getdpb_1
  9687 0000138D 896C02                  	mov	[si+2],bp
  9688 00001390 8C440E                  	mov	[si+0Eh],es
  9689 00001393 30C0                    	xor	al,al			; status = 0 = successful
  9690 00001395 C3                      	retn
  9691                                  
  9692                                  getdpb_5:
  9693 00001396 B018                    	mov	al,18h			; error_bad_length
  9694 00001398 837C043F                	cmp	word [si+4],63		; [SI+user_env.user_CX]
  9695                                  					; length of buffer (must be 63 bytes)
  9696 0000139C 72B8                    	jb	short getdpb_2		; error
  9697                                  
  9698 0000139E 06                      	push	es			; ES:BP = Drive parameter block
  9699 0000139F 55                      	push	bp
  9700 000013A0 8E4410                  	mov	es,[si+16]		; [SI+user_env.user_ES]
  9701 000013A3 8B7C0A                  	mov	di,[si+10]		; [SI+user_env.user_DI]
  9702 000013A6 8B5C08                  	mov	bx,[si+8]		; [SI+user_env.user_SI] (!)
  9703 000013A9 5E                      	pop	si
  9704 000013AA 1F                      	pop	ds
  9705                                  
  9706 000013AB B83D00                  	mov	ax,61			; length of following data (003Dh)
  9707 000013AE AB                      	stosw
  9708 000013AF 89C1                    	mov	cx,ax
  9709 000013B1 57                      	push	di
  9710 000013B2 F3A4                    	rep movsb
  9711 000013B4 5F                      	pop	di
  9712                                  	
  9713                                  	; 13/01/2024
  9714 000013B5 06                      	push	es
  9715 000013B6 1F                      	pop	ds
  9716 000013B7 31C0                    	xor	ax,ax ; 0
  9717                                  
  9718 000013B9 81FBA6F1                	cmp	bx,0F1A6h		; (!) signature (undocumented),
  9719                                  					;  must be 0F1A6h to get device driver
  9720                                  					;  address and next-DPB pointer
  9721                                  					; (Ref: Ralf Brown's Interrupt List)
  9722 000013BD 740E                    	je	short getdpb_6
  9723                                  	
  9724                                  	;xor	ax,ax	; 0
  9725 000013BF 48                      	dec	ax 	; -1
  9726                                  	;mov	[es:di+19h],ax		; pointer to next DPB (invalidated)
  9727                                  	;mov	[es:di+1Bh],ax
  9728                                  	;mov	[es:di+13h],ax		; pointer to driver address (invalidated)
  9729                                  	;mov	[es:di+15h],ax
  9730                                  	; 13/01/2024
  9731 000013C0 894519                  	mov	[di+19h],ax ; -1	; pointer to next DPB (invalidated)
  9732 000013C3 89451B                  	mov	[di+1Bh],ax
  9733 000013C6 894513                  	mov	[di+13h],ax		; pointer to driver address (invalidated)
  9734 000013C9 894515                  	mov	[di+15h],ax	
  9735                                  
  9736                                  	; 13/01/2024
  9737 000013CC 40                      	inc	ax ; 0
  9738                                  getdpb_6:
  9739                                  	; 13/01/2024
  9740                                  	; ax = 0
  9741 000013CD 39450F                  	cmp	[di+0Fh],ax ; 0
  9742                                  	;cmp	[es:di+0Fh],ax ; 0	; FAT (16 bit) size ?
  9743                                  	;;cmp	word [es:di+0Fh],0
  9744 000013D0 743F                    	jz	short getdpb_8		; FAT32
  9745                                  			  ; FAT16 or FAT12
  9746                                  	;mov	ax,[es:di+0Dh]		; DPB.MAX_CLUSTER
  9747                                  	;mov	[es:di+2Dh],ax		; DPB.LAST_CLUSTER
  9748                                  	;mov	ax,[es:di+0Fh]		; DPB.FAT_SIZE
  9749                                  	;mov	[es:di+31h],ax		; DPB.FAT32_SIZE
  9750                                  	;mov	ax,[es:di+1Dh]		; DPB.NEXT_FREE
  9751                                  	;mov	[es:di+39h],ax		; DPB.FAT32_NXTFREE
  9752                                  	;mov	ax,[es:di+0Bh]		; DPB.FIRST_SECTOR
  9753                                  	;mov	[es:di+29h],ax		; DPB.FCLUS_FSECTOR
  9754                                  	; 13/01/2024
  9755 000013D2 8B450D                  	mov	ax,[di+0Dh]		; DPB.MAX_CLUSTER
  9756 000013D5 89452D                  	mov	[di+2Dh],ax		; DPB.LAST_CLUSTER
  9757 000013D8 8B450F                  	mov	ax,[di+0Fh]		; DPB.FAT_SIZE
  9758 000013DB 894531                  	mov	[di+31h],ax		; DPB.FAT32_SIZE
  9759 000013DE 8B451D                  	mov	ax,[di+1Dh]		; DPB.NEXT_FREE
  9760 000013E1 894539                  	mov	[di+39h],ax		; DPB.FAT32_NXTFREE
  9761 000013E4 8B450B                  	mov	ax,[di+0Bh]		; DPB.FIRST_SECTOR
  9762 000013E7 894529                  	mov	[di+29h],ax		; DPB.FCLUS_FSECTOR	
  9763                                  
  9764 000013EA 31C0                    	xor	ax,ax	; 0
  9765                                  	;mov	[es:di+2Fh],ax		; DPB.LAST_CLUSTER high word
  9766                                  	;mov	[es:di+33h],ax		; DPB.FAT32_SIZE high word
  9767                                  	;mov	[es:di+3Bh],ax		; DPB.FAT32_NXTFREE high word
  9768                                  	;mov	[es:di+2Bh],ax		; DPB.FCLUS_FSECTOR high word
  9769                                  	;mov	[es:di+35h],ax		; DPB.ROOT_CLUSTER
  9770                                  	;mov	[es:di+37h],ax		; DPB.ROOT_CLUSTER high word
  9771                                  	;mov	[es:di+23h],ax		; DPB.EXT_FLAGS
  9772                                  	; 13/01/2024
  9773 000013EC 89452F                  	mov	[di+2Fh],ax ; 0		; DPB.LAST_CLUSTER high word
  9774 000013EF 894533                  	mov	[di+33h],ax		; DPB.FAT32_SIZE high word
  9775 000013F2 89453B                  	mov	[di+3Bh],ax		; DPB.FAT32_NXTFREE high word
  9776 000013F5 89452B                  	mov	[di+2Bh],ax		; DPB.FCLUS_FSECTOR high word
  9777 000013F8 894535                  	mov	[di+35h],ax		; DPB.ROOT_CLUSTER
  9778 000013FB 894537                  	mov	[di+37h],ax		; DPB.ROOT_CLUSTER high word
  9779 000013FE 894523                  	mov	[di+23h],ax		; DPB.EXT_FLAGS
  9780 00001401 48                      	dec	ax	; -1
  9781                                  	;mov	[es:di+25h],ax		; DPB.FSINFO_SECTOR (invalidated)
  9782                                  	;mov	[es:di+27h],ax		; DPB.BKBOOT_SECTOR (invalidated)
  9783                                  	; 13/01/2024
  9784 00001402 894525                  	mov	[di+25h],ax		; DPB.FSINFO_SECTOR (invalidated)
  9785 00001405 894527                  	mov	[di+27h],ax		; DPB.BKBOOT_SECTOR (invalidated)
  9786 00001408 3B451F                  	cmp	ax,[di+1Fh]
  9787                                  	;cmp	ax,[es:di+1Fh]		; DPB.FREE_COUNT (= -1 ?)
  9788 0000140B 7401                    	je	short getdpb_7
  9789 0000140D 40                      	inc	ax	; -1 -> 0
  9790                                  getdpb_7:
  9791 0000140E 894521                  	mov	[di+21h],ax
  9792                                  	;mov	[es:di+21h],ax		; DPB.PB.FREE_COUNT high word
  9793                                  getdpb_8:
  9794                                  	;xor	ax,ax			; status = 0 = successful
  9795 00001411 E956F2                  	jmp	SYS_RET_OK
  9796                                  
  9797                                  %endif
  9798                                  
  9799                                  ;
  9800                                  ;----------------------------------------------------------------------------
  9801                                  ;
  9802                                  ;**	$Disk_Reset - Flush out Dirty Buffers
  9803                                  ;
  9804                                  ;	$DiskReset flushes and invalidates all buffers. BUGBUG - do
  9805                                  ;		we really invalidate? SHould we? THis screws non-removable
  9806                                  ;		caching. Maybe CHKDSK relies upon it, though....
  9807                                  ;
  9808                                  ;	ENTRY	none
  9809                                  ;	EXIT	none
  9810                                  ;	USES	all
  9811                                  ;
  9812                                  ;----------------------------------------------------------------------------
  9813                                  ;
  9814                                  	; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  9815                                  	; DOSCODE:4D94h
  9816                                  	; 13/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  9817                                  	; DOSCODE:5322h
  9818                                  _$DISK_RESET:
  9819                                  	; 15/05/2019 - Retro DOS v4.0
  9820 00001414 B0FF                    	mov	al,0FFh	; -1
  9821 00001416 16                      	push	ss
  9822 00001417 1F                      	pop	ds
  9823                                  	; 06/11/2022
  9824                                  	;MOV	AL,-1
  9825 00001418 E8C804                  	call	ECritDisk
  9826                                  	; MSDOS 6.0
  9827                                  	;;or	word [DOS34_FLAG],4
  9828                                  	;or	word [DOS34_FLAG],FROM_DISK_RESET    ;AN000;
  9829 0000141B 800E[1106]04            	or	byte [DOS34_FLAG],FROM_DISK_RESET ; 4 ; 15/05/2019
  9830 00001420 E8A256                  	call	FLUSHBUF
  9831                                  	; MSDOS 6.0
  9832                                  	;and	word [DOS34_FLAG],0FFFBh
  9833                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  9834                                  	;and	word [DOS34_FLAG],NO_FROM_DISK_RESET ;AN000;
  9835                                  	; 15/12/2022
  9836 00001423 8026[1106]FB            	and	byte [DOS34_FLAG],NO_FROM_DISK_RESET ; 0FBh ; 15/05/2019
  9837                                  
  9838                                  	; 13/01/2024 - Retro DOS v5.0
  9839                                  	; (PCDOS 7.1 IBMDOS.COM)
  9840                                  	;;;
  9841 00001428 C42E[2600]              	les     bp,[DPBHEAD]
  9842                                  drst_1:
  9843 0000142C 83FDFF                  	cmp	bp,0FFFFh	; -1 ?
  9844 0000142F 7409                    	je	short drst_2	; yes, it is the last DPB
  9845 00001431 E83920                  	call	update_fat32_fsinfo ; update FSINFO (sector) parameters 
  9846 00001434 26C46E19                	les	bp,[es:bp+19h]	; DPB.NEXT_DPB
  9847 00001438 EBF2                    	jmp	short drst_1
  9848                                  drst_2:
  9849                                  	;;;
  9850                                  
  9851 0000143A C706[8310]0000          	mov	word [SC_STATUS],0	; Throw out secondary cache ; M041
  9852                                  ;
  9853                                  ; We will "ignore" any errors on the flush, and go ahead and invalidate. This
  9854                                  ; call doesn't return any errors and it is supposed to FORCE a known state, so
  9855                                  ; let's do it.
  9856                                  ;
  9857                                  ; Invalidate 'last-buffer' used
  9858                                  ;
  9859 00001440 BBFFFF                  	MOV	BX,-1 ; 0FFFFh	
  9860 00001443 891E[2000]              	MOV	[LastBuffer+2],BX
  9861 00001447 891E[1E00]              	MOV	[LastBuffer],BX
  9862                                  
  9863                                  	; MSDOS 3.3 
  9864                                  	; IBMDOS.COM, Offset 1C66h
  9865                                  	;;;;
  9866                                  	;lds	si,[BUFFHEAD]
  9867                                  	;mov	ax,20FFh	; .buf_ID,    AL = FFh (Free buffer)
  9868                                  				; .buf_flags, AH = 0, reset/clear
  9869                                  ;DRST_1:
  9870                                  	;;mov	[si+4],ax
  9871                                  	;mov	[si+BUFFINFO.buf_ID],ax
  9872                                  	;lds	si,[SI]
  9873                                  	;cmp	si,bx ; -1
  9874                                  	;je	short DRST_2
  9875                                  	;;mov	[si+4],ax
  9876                                  	;mov	[si+BUFFINFO.buf_ID],ax
  9877                                  	;lds	si,[SI]
  9878                                  	;cmp	si,bx
  9879                                  	;jne	short DRST_1
  9880                                  	;;;;
  9881                                  ;DRST_2:
  9882 0000144B E8C204                  	call	LCritDisk
  9883 0000144E B8FFFF                  	MOV	AX,-1
  9884                                  	; 07/12/2022
  9885                                  	;mov	ax,0FFFFh
  9886                                  	;CallInstall NetFlushBuf,MultNET,32,AX,AX
  9887 00001451 50                      	push	ax ; * MSDOS 6.0 ; 15/05/2019
  9888 00001452 B82011                  	mov     ax,1120h
  9889 00001455 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - FLUSH ALL DISK BUFFERS
  9890                                  			; DS = DOS CS
  9891                                  			; Return: CF clear (successful)
  9892 00001457 58                      	pop	ax ; * MSDOS 6.0 ; 15/05/2019
  9893                                  	
  9894 00001458 C3                      	retn
  9895                                  
  9896                                  	; 19/07/2018 - Retro DOS v3.0
  9897                                  
  9898                                  ;
  9899                                  ;	BREAK <$SetDPB - Create a valid DPB from a user-specified BPB>
  9900                                  ;
  9901                                  ;----------------------------------------------------------------------------
  9902                                  ;
  9903                                  ;**	$SetDPB - Create a DPB
  9904                                  ;
  9905                                  ;	SetDPB Creates a valid DPB from a user-specified BPB
  9906                                  ;
  9907                                  ;	ENTRY	ES:BP Points to DPB
  9908                                  ;		DS:SI Points to BPB
  9909                                  ;	EXIT	DPB setup
  9910                                  ;	USES	ALL but BP, DS, ES
  9911                                  ;
  9912                                  ;----------------------------------------------------------------------------
  9913                                  ;
  9914                                  
  9915                                  ; 10/05/2019 - Retro DOS v4.0
  9916                                  
  9917                                  ; DOSCODE:4DD6h (MSDOS 6.21, MSDOS.SYS)
  9918                                  
  9919                                  ; MSDOS 6.0
  9920 00001459 0300                    word3:	dw	3			; M008 -- word value for divides
  9921                                  
  9922                                  ; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0)
  9923                                  ; DOSCODE:4DC9h (MSDOS 5.0, MSDOS.SYS)
  9924                                  
  9925                                  ; 13/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1)
  9926                                  ; DOSCODE:5369h (PCDOS 7.1, IBMDOS.COM)
  9927                                  
  9928                                  ; 13/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1)
  9929                                  ; Windows ME IO.SYS (Extracted) - BIOSCODE:4EF8h 
  9930                                  
  9931                                  ;procedure   $SETDPB,NEAR
  9932                                  
  9933                                  _$SETDPB:
  9934 0000145B 89EF                    	MOV	DI,BP
  9935                                  	;ADD	DI,2			; Skip over dpb_drive and dpb_UNIT
  9936                                  	; 13/01/2024
  9937 0000145D 47                      	inc	di
  9938 0000145E 47                      	inc	di
  9939 0000145F AD                      	LODSW
  9940 00001460 AB                      	STOSW				; dpb_sector_size
  9941                                  
  9942                                  	; 13/01/2024
  9943                                  	; Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  9944                                  	;;;
  9945 00001461 81F95845                	cmp	cx,4558h	; 'XE' (NASM syntax)
  9946                                  				; CX = signature 4558h ('EX') for FAT32 extended BPB/DPB
  9947 00001465 7506                    	jne	short not_fat32_extension
  9948 00001467 81FA5241                	cmp	dx,4152h	; 'RA' (NASM syntax)
  9949                                  				; DX = signature 4152h ('AR') for FAT32 extended BPB/DPB
  9950 0000146B 7402                    	je	short chk_fat32_conditions
  9951                                  not_fat32_extension:                    ; ...
  9952 0000146D 31C9                    	xor	cx,cx	; 0	; (Do not use FAT32 extensions -32 bit parameters-)
  9953                                  chk_fat32_conditions:  
  9954 0000146F 51                      	push	cx	; (*)
  9955                                  	;;;
  9956                                  	
  9957                                  	; 13/01/2024
  9958                                  	; MSDOS 6.0
  9959                                  	;cmp	byte [si+3],0
  9960                                  	;CMP	BYTE [SI+A_BPB.BPB_NUMBEROFFATS-2],0
  9961 00001470 807C0300                	cmp	byte [SI+A_BPB.NUMBEROFFATS-2],0 ; FAT file system drive ;AN000;
  9962                                  	;JNZ	short yesfat			 ; yes			 ;AN000;
  9963 00001474 740C                    	jz	short nofat ; 13/01/2024 (PCDOS 7.1)
  9964                                  
  9965                                  	; 13/01/2024 - Retro DOS v5.0
  9966                                  	;;;
  9967                                  	;cmp	word [si+9],0	; .BPB_SECTORSPERFAT ; BPB_FATSz16
  9968 00001476 837C0900                	cmp	word [si+A_BPB.SECTORSPERFAT-2],0
  9969 0000147A 7516                    	jnz	short yesfat
  9970                                  	;cmp	word [si+29],0	; .BPB_FAT32VERSION ; BPB_FSVer
  9971 0000147C 837C1D00                	cmp	word [si+A_BPB.FSVER-2],0
  9972 00001480 7410                    	jz	short yesfat
  9973                                  nofat:             
  9974                                  	;;;
  9975                                  
  9976                                  	; 13/01/2024
  9977                                  	;;mov	byte [es:di+4],0
  9978                                  	;MOV	BYTE [ES:DI+DPB.FAT_COUNT-4],0
  9979                                  	;JMP	short setend			; NO		;AN000;
  9980                                  
  9981                                  	; 13/01/2024 (WINME IO.SYS)
  9982                                  	;mov	byte [es:di+4],0 ; DPB.FAT_COUNT
  9983                                  	;xor	eax,eax
  9984                                  	;jmp	setend
  9985                                  
  9986                                  	; 13/01/2024 (PCDOS7.1 IBMDOS.COM)
  9987 00001482 31C0                    	xor	ax,ax ; 0
  9988 00001484 26884504                	mov	[es:di+DPB.FAT_COUNT-4],al ; DPB.FAT_COUNT = 0
  9989                                  
  9990                                  	; 13/01/2024 (not necessary) 
  9991                                  	;add	di,15	; DPB.DRIVER_ADDR
  9992                                  
  9993 00001488 83C60B                  	add	si,11	; .BPB_SECTORSPERTRACK
  9994                                  
  9995                                  	;mov	[es:bp+15],ax	; DPB.FAT_SIZE = 0
  9996 0000148B 2689460F                	mov	[es:bp+DPB.FAT_SIZE],ax
  9997                                  
  9998 0000148F E9B500                  	jmp	setend
  9999                                  
 10000                                  yesfat: ; 10/08/2018
 10001 00001492 89C2                    	MOV	DX,AX
 10002 00001494 AC                      	LODSB
 10003                                  	;;;
 10004                                  	; 13/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 10005 00001495 08C0                    	or	al,al
 10006 00001497 74E9                    	jz	short nofat
 10007                                  	;;;
 10008                                  	;DEC	AL
 10009                                  	; 17/12/2022
 10010 00001499 48                      	dec	ax
 10011 0000149A AA                      	STOSB				; dpb_cluster_mask
 10012                                  	;INC	AL
 10013 0000149B 40                      	inc	ax
 10014 0000149C 30E4                    	XOR	AH,AH
 10015                                  LOG2LOOP:
 10016 0000149E A801                    	test	AL,1
 10017 000014A0 7506                    	JNZ	short SAVLOG
 10018 000014A2 FEC4                    	INC	AH
 10019 000014A4 D0E8                    	SHR	AL,1
 10020 000014A6 EBF6                    	JMP	SHORT LOG2LOOP
 10021                                  SAVLOG:
 10022 000014A8 88E0                    	MOV	AL,AH
 10023 000014AA AA                      	STOSB				; dpb_cluster_shift
 10024 000014AB 88C3                    	MOV	BL,AL
 10025 000014AD A5                      	MOVSW				; dpb_first_FAT Start of FAT (# of reserved sectors)
 10026 000014AE AC                      	LODSB
 10027 000014AF AA                      	STOSB				; dpb_FAT_count Number of FATs
 10028                                  ;	OR	AL,AL			; NONFAT ?				;AN000;
 10029                                  ;	JZ	short setend		; yes, don't do anything                ;AN000;
 10030 000014B0 88C7                    	MOV	BH,AL
 10031 000014B2 AD                      	LODSW
 10032 000014B3 AB                      	STOSW				; dpb_root_entries Number of directory entries
 10033 000014B4 B105                    	MOV	CL,5
 10034 000014B6 D3EA                    	SHR	DX,CL			; Directory entries per sector
 10035 000014B8 48                      	DEC	AX
 10036 000014B9 01D0                    	ADD	AX,DX			; Cause Round Up
 10037 000014BB 89D1                    	MOV	CX,DX
 10038 000014BD 31D2                    	XOR	DX,DX
 10039 000014BF F7F1                    	DIV	CX
 10040 000014C1 89C1                    	MOV	CX,AX			; Number of (root) directory sectors
 10041 000014C3 47                      	INC	DI
 10042 000014C4 47                      	INC	DI			; Skip dpb_first_sector
 10043 000014C5 A5                      	MOVSW			; Total number of sectors in DSKSIZ (temp as dpb_max_cluster)
 10044 000014C6 AC                      	LODSB
 10045                                  	;mov	[es:bp+17h],al
 10046 000014C7 26884617                	MOV	[ES:BP+DPB.MEDIA],AL	; Media byte
 10047 000014CB AD                      	LODSW				; Number of sectors in a FAT
 10048                                  	
 10049                                  	;;;
 10050                                  	;MSDOS 3.3
 10051                                  	;
 10052                                  	;STOSB		; DPB.FAT_SIZE
 10053                                  	;MUL	BH
 10054                                  	
 10055                                  	;MSDOS 6.0
 10056                                  	;
 10057 000014CC AB                      	STOSW		; DPB.FAT_SIZE	;AC000;;>32mb dpb_FAT_size
 10058                                  
 10059                                  ; 13/01/2024
 10060                                  %if 0
 10061                                  	MOV	DL,BH			;AN000;;>32mb
 10062                                  	XOR	DH,DH			;AN000;;>32mb
 10063                                  	MUL	DX			;AC000;;>32mb Space occupied by all FATs
 10064                                  	;;;
 10065                                  	
 10066                                  	;add	ax,[es:bp+6]
 10067                                  	ADD	AX,[ES:BP+DPB.FIRST_FAT]
 10068                                  	STOSW				; dpb_dir_sector
 10069                                  	ADD	AX,CX			; Add number of (root) directory sectors
 10070                                  	;mov	[es:bp+0Bh],ax
 10071                                  	MOV	[ES:BP+DPB.FIRST_SECTOR],AX
 10072                                  	
 10073                                  	; MSDOS 6.0
 10074                                  	MOV	CL,BL			;F.C. >32mb				;AN000;
 10075                                  	;;cmp	word [es:bp+0Dh],0
 10076                                  	;CMP	WORD [ES:BP+DSKSIZ],0	;F.C. >32mb				;AN000;
 10077                                  	;JNZ	short normal_dpb	;F.C. >32mb				;AN000;
 10078                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10079                                  	; 15/12/2022
 10080                                  	; 28/07/2019
 10081                                  	mov	bx,[ES:BP+DSKSIZ]
 10082                                  	or	bx,bx
 10083                                  	JNZ	short normal_dpb	;F.C. >32mb				;AN000;
 10084                                  	;CMP	WORD [ES:BP+DSKSIZ],0	;F.C. >32mb				;AN000;
 10085                                  	;JNZ	short normal_dpb	;F.C. >32mb				;AN000;
 10086                                  	
 10087                                  
 10088                                  	XOR	CH,CH			;F.C. >32mb				;AN000;
 10089                                  	;mov	bx,[si+8]
 10090                                  	mov	bx,[si+A_BPB.BIGTOTALSECTORS-A_BPB.SECTORSPERTRACK] ; 01/01/2024 (temporary)
 10091                                  	;MOV	BX,[SI+A_BPB.BPB_BIGTOTALSECTORS-A_BPB.BPB_SECTORSPERTRACK]	;AN000;
 10092                                  	;mov	dx,[si+10]
 10093                                  	mov	dx,[si+A_BPB.BIGTOTALSECTORS-A_BPB.SECTORSPERTRACK+2] ; 01/01/2024 (temporary)
 10094                                  	;MOV	DX,[SI+A_BPB.BPB_BIGTOTALSECTORS-A_BPB.BPB_SECTORSPERTRACK+2]	;AN000;
 10095                                  	SUB	BX,AX			;AN000;;F.C. >32mb
 10096                                  	SBB	DX,0			;AN000;;F.C. >32mb
 10097                                  	OR	CX,CX			;AN000;;F.C. >32mb
 10098                                  	JZ	short norot		;AN000;;F.C. >32mb
 10099                                  rott:					;AN000;;F.C. >32mb
 10100                                  	CLC				;AN000;;F.C. >32mb
 10101                                  	RCR	DX,1			;AN000;;F.C. >32mb
 10102                                  	RCR	BX,1			;AN000;;F.C. >32mb
 10103                                  	LOOP	rott			;AN000;;F.C. >32mb
 10104                                  norot:					;AN000;
 10105                                  	; 15/12/2022
 10106                                  	;MOV	AX,BX			;AN000;;F.C. >32mb
 10107                                  	JMP	short setend		;AN000;;F.C. >32mb
 10108                                  normal_dpb:
 10109                                  	;;sub	ax,[es:bp+0Dh]
 10110                                  	;SUB	AX,[ES:BP+DSKSIZ]
 10111                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10112                                  	; 15/12/2022
 10113                                  	; bx = [es:bp+DSKSIZ]
 10114                                  	;sub	ax,bx ; 28/07/2019
 10115                                  	;;SUB	AX,[ES:BP+DSKSIZ]
 10116                                  	; 15/12/2022
 10117                                  	sub	bx,ax
 10118                                  	;NEG	AX			; Sectors in data area
 10119                                  ;;	MOV	CL,BL			; dpb_cluster_shift
 10120                                  	; 15/12/2022
 10121                                  	; CL = cluster shift
 10122                                  	; BX = number of data sectors 
 10123                                  	;SHR	AX,CL			; Div by sectors/cluster
 10124                                  	shr	bx,cl 
 10125                                  setend:
 10126                                  ;	M008 - CAS
 10127                                  ;
 10128                                  	; 15/12/2022
 10129                                  	inc	bx
 10130                                  	;INC	AX			; +2 (reserved), -1 (count -> max)
 10131                                  ;
 10132                                  ;	There has been a bug in our fatsize calculation for so long
 10133                                  ;	  that we can't correct it now without causing some user to
 10134                                  ;	  experience data loss. There are even cases where allowing
 10135                                  ;	  the number of clusters to exceed the fats is the optimal
 10136                                  ;	  case -- where adding 2 more fat sectors would make the
 10137                                  ;	  data field smaller so that there's nothing to use the extra
 10138                                  ;	  fat sectors for.
 10139                                  ;
 10140                                  ;	Note that this bug had very minor known symptoms. CHKDSK would
 10141                                  ;	  still report that there was a cluster left when the disk was
 10142                                  ;	  actually full. Very graceful failure for a corrupt system
 10143                                  ;	  configuration. There may be worse cases that were never
 10144                                  ;	  properly traced back to this bug. The problem cases only
 10145                                  ;	  occurred when partition sizes were very near FAT sector
 10146                                  ;	  rounding boundaries, which were rare cases.
 10147                                  ;
 10148                                  ;	Also, it's possible that some third-party partition program might
 10149                                  ;	  create a partition that had a less-than-perfect FAT calculation
 10150                                  ;	  scheme. In this hypothetical case, the number of allocation
 10151                                  ;	  clusters which don't actually have FAT entries to represent
 10152                                  ;	  them might be larger and might create a more catastrophic
 10153                                  ;	  failure. So we'll provide the safeguard of limiting the
 10154                                  ;	  max_cluster to the amount that will fit in the FATs.
 10155                                  ;
 10156                                  ;	ax = maximum legal cluster, ES:BP -> dpb
 10157                                  
 10158                                  ;	make sure the number of fat sectors is actually enough to
 10159                                  ;	  hold that many clusters. otherwise, back the number of
 10160                                  ;	  clusters down
 10161                                  
 10162                                  	; 15/12/2022
 10163                                  	; bx = number of clusters
 10164                                  
 10165                                  	; 19/07/2018 - Retro DOS v3.0
 10166                                  	; MSDOS 6.0
 10167                                  	; 15/12/2022
 10168                                  	;mov	bx,ax			; remember calculated # clusters
 10169                                  
 10170                                  	; 01/08/2018 (MSDOS 3.3)
 10171                                  	;mov	al,[ES:BP+DPB.FAT_SIZE]
 10172                                  	;xor	ah,ah 
 10173                                  
 10174                                  	; 10/05/2019 - Retro DOS v4.0
 10175                                  	;mov	ax,[ES:BP+0Fh]
 10176                                  	mov	ax,[ES:BP+DPB.FAT_SIZE]
 10177                                  
 10178                                  	;mul	word [es:bp+2]	
 10179                                  	mul	word [ES:BP+DPB.SECTOR_SIZE] ; how big is the FAT?
 10180                                  	cmp	bx,4096-10  ; 0FF6h	; test for 12 vs. 16 bit fat
 10181                                  	jb	short setend_fat12
 10182                                  	shr	dx,1
 10183                                  
 10184                                  ; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10185                                  	; 15/12/2022
 10186                                  ;cs3 7/2/92
 10187                                  	jnz	short setend_faterr	; some bonehead gave us more fatspace
 10188                                  					; than enough for the maximum FAT,
 10189                                  					; so go ahead and use the calculated
 10190                                  					; number of clusters.
 10191                                  ;cs3 7/2/92
 10192                                  
 10193                                  	rcr	ax,1			; find number of entries
 10194                                  	cmp	ax,4096-10+1		; would this truncation move us
 10195                                  ;					;  into 12-bit fatland?
 10196                                  	jb	short setend_faterr	; then go ahead and let the
 10197                                  ;					;  inconsistency pass through
 10198                                  ;					;  rather than lose data by
 10199                                  ;					;  correcting the fat type
 10200                                  	jmp	short setend_fat16
 10201                                  
 10202                                  setend_fat12:
 10203                                  	add	ax,ax			; (fatsiz*2)/3 = # of fat entries
 10204                                  	adc	dx,dx
 10205                                  
 10206                                  ; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10207                                  ;cs3 7/2/92
 10208                                  	; 15/12/2022
 10209                                  	cmp	dx,3			; if our fatspace is WAY more than
 10210                                  	jnb	short setend_faterr	; we need, we may get an overflow
 10211                                  					; here. Check for it and use
 10212                                  					; the calculated size in this case.
 10213                                  ;cs3 7/2/92
 10214                                  
 10215                                  	div	word [cs:word3]
 10216                                  
 10217                                  setend_fat16:
 10218                                  	dec	ax			; limit at 1
 10219                                  	cmp	ax,bx			; is fat big enough?
 10220                                  	jbe	short setend_fat	; use max value that'll fit
 10221                                  
 10222                                  setend_faterr:
 10223                                  	mov	ax,bx			; use calculated value
 10224                                  
 10225                                  setend_fat:
 10226                                  
 10227                                  ;	now ax = maximum legal cluster
 10228                                  
 10229                                  ;	end M008
 10230                                  
 10231                                  
 10232                                  	;mov	[es:bp+0Dh], ax
 10233                                  	MOV	[ES:BP+DPB.MAX_CLUSTER],AX
 10234                                  
 10235                                  	;;mov	word [es:bp+1Ch],0  ; MSDOS 3.3
 10236                                  	;mov	word [es:bp+1Dh],0  ; MSDOS 6.0
 10237                                  	MOV	word [ES:BP+DPB.NEXT_FREE],0 
 10238                                  					; Init so first ALLOC starts at
 10239                                  					; begining of FAT
 10240                                  	;;mov	word [es:bp+1Eh],-1 ; MSDOS 3.3
 10241                                  	;mov	word [es:bp+1Fh],-1 ; MSDOS 6.0
 10242                                  	MOV	word [ES:BP+DPB.FREE_CNT],-1 ; current count is invalid.
 10243                                  
 10244                                  	retn
 10245                                  
 10246                                  %else
 10247                                  	; 13/01/2024 - Retro DOS v5.0
 10248                                  	;;;
 10249 000014CD 31D2                    	xor	dx,dx ; 0
 10250 000014CF 09C0                    	or	ax,ax
 10251 000014D1 750C                    	jnz	short savlog1	; 16 bit FAT size
 10252 000014D3 5A                      	pop	dx		; (*) FAT32 extensions
 10253                                  				; (use 32 bit FAT and Root Dir size if >0)
 10254 000014D4 52                      	push    dx		; (*)
 10255 000014D5 09D2                    	or	dx,dx
 10256 000014D7 7406                    	jz	short savlog1	; Do not use FAT32 extensions
 10257                                  				; (do not use 32 bit FAT size field)
 10258 000014D9 8B440C                  	mov	ax,[si+12]	; .BPB_SECTORSPERFAT32 ; BPB_FATSz32
 10259 000014DC 8B540E                  	mov	dx,[si+14]	; .BPB_SECTORSPERFAT32+2
 10260                                  savlog1:
 10261 000014DF 51                      	push    cx		; (**) Root directory sectors
 10262 000014E0 89C1                    	mov	cx,ax		; 32 bit multiply
 10263 000014E2 88F8                    	mov	al,bh		; FAT count
 10264 000014E4 30E4                    	xor	ah,ah
 10265 000014E6 F7E2                    	mul	dx
 10266 000014E8 91                      	xchg    ax,cx
 10267 000014E9 88FA                    	mov	dl,bh		; FAT count
 10268 000014EB 30F6                    	xor	dh,dh
 10269 000014ED F7E2                    	mul	dx
 10270 000014EF 01CA                    	add	dx,cx
 10271 000014F1 59                      	pop	cx		; (**)
 10272 000014F2 39D0                    	cmp	ax,dx
 10273 000014F4 7504                    	jne	short savlog2
 10274                                  
 10275                                  	; 13/01/2024
 10276                                  	;or	ax,ax
 10277                                  	;jnz	short savlog2
 10278                                  
 10279                                  	; 13/01/2024 (not necessary)
 10280                                  	;inc	di
 10281                                  	;inc	di
 10282                                  	; di = 	DPB.DRIVER_ADDR	
 10283                                  
 10284                                  	;jmp	short setend
 10285                                  
 10286                                  	; 13/01/2024
 10287 000014F6 09C0                    	or	ax,ax
 10288 000014F8 744D                    	jz	short setend
 10289                                  
 10290                                  savlog2:
 10291 000014FA 26034606                	add	ax,[es:bp+DPB.FIRST_FAT]
 10292                                  	;add	ax,[es:bp+6]	; dx:ax = (total) FAT sectors
 10293 000014FE 83D200                  	adc	dx,0
 10294 00001501 AB                      	stosw			; DPB.DIR_SECTOR
 10295 00001502 01C8                    	add	ax,cx		; + root directory size
 10296 00001504 2689460B                	mov	[es:bp+DPB.FIRST_SECTOR],ax
 10297                                  	;mov	[es:bp+11],ax	; DPB.FIRST_SECTOR ; First data sector
 10298 00001508 83D200                  	adc	dx,0
 10299 0000150B 59                      	pop	cx		; (*)
 10300 0000150C 51                      	push    cx
 10301 0000150D E308                    	jcxz    savlog3
 10302 0000150F 26894629                	mov	[es:bp+DPB.FCLUS_FSECTOR],ax
 10303                                  	;mov	[es:bp+41],ax	; DPB.BIG_FIRST_SECTOR ; FAT32 first sector field
 10304 00001513 2689562B                	mov	[es:bp+DPB.FCLUS_FSECTOR+2],dx
 10305                                  	;mov	[es:bp+43],dx
 10306                                  savlog3: 
 10307 00001517 88D9                    	mov	cl,bl		; cluster shift
 10308 00001519 26837E0D00              	cmp	word [es:bp+DPB.MAX_CLUSTER],0
 10309                                  	;cmp	word [es:bp+13],0 ; DPB.MAX_CLUSTER
 10310                                  				; (contains 16 bit .BPB_TOTALSECTORS as temporary)
 10311 0000151E 751D                    	jnz	short normal_dpb
 10312 00001520 30ED                    	xor	ch,ch
 10313 00001522 52                      	push    dx	; (**)
 10314 00001523 8B5C08                  	mov	bx,[si+8]	; SI points to .BPB_SECTORSPERTRACK and SI+8 is
 10315                                  				; .BPB_BIGTOTALSECTORS (32 bit total sectors)
 10316 00001526 8B540A                  	mov	dx,[si+10]
 10317 00001529 29C3                    	sub	bx,ax
 10318 0000152B 58                      	pop	ax	; (**)
 10319 0000152C 19C2                    	sbb	dx,ax		; dx:bx = data sectors (for cluster count calc)
 10320 0000152E 09C9                    	or	cx,cx
 10321 00001530 7407                    	jz	short norot
 10322                                  rott:
 10323 00001532 F8                      	clc
 10324 00001533 D1DA                    	rcr	dx,1
 10325 00001535 D1DB                    	rcr	bx,1
 10326 00001537 E2F9                    	loop    rott
 10327                                  norot:
 10328 00001539 89D8                    	mov	ax,bx		; dx:ax = cluster count
 10329 0000153B EB0A                    	jmp	short setend
 10330                                  
 10331                                  normal_dpb:
 10332 0000153D 262B460D                	sub	ax,[es:bp+DPB.MAX_CLUSTER]
 10333                                  	;sub	ax,[es:bp+13]	; first sector - total sectors
 10334 00001541 31D2                    	xor	dx,dx
 10335 00001543 F7D8                    	neg	ax		; data sectors = total sectors - first sector
 10336 00001545 D3E8                    	shr	ax,cl		; cluster count
 10337                                  
 10338                                  setend:
 10339                                  	; 13/01/2024 (PCDOS 7.1 IBMDOS.COM)
 10340 00001547 59                      	pop	cx		; (*) 0 = not 32 bit fat sectors
 10341 00001548 51                      	push	cx		; (*)
 10342                                  	
 10343                                  	; 13/01/2024
 10344                                  	; (PCDOS 7.1 IBMDOS.COM BUGfix)
 10345 00001549 31D2                    	xor	dx,dx ; 0
 10346                                  	; si = BIOS Parameter Block + 13
 10347                                  	
 10348                                  	; 13/01/2024 (PCDOS 7.1 IBMDOS.COM)
 10349 0000154B 83C001                  	add	ax,1
 10350 0000154E 83D200                  	adc	dx,0			; calculated # clusters HW
 10351 00001551 89C3                    	mov	bx,ax			; calculated # clusters LW
 10352 00001553 268B460F                	mov	ax,[es:bp+DPB.FAT_SIZE]
 10353                                  	;mov	ax,[es:bp+15]		; FAT size (16 bit)
 10354 00001557 E30C                    	jcxz	setend1			; Do not use 32 bit FAT sectors field
 10355 00001559 31C9                    	xor	cx,cx
 10356 0000155B 09C0                    	or	ax,ax
 10357 0000155D 7506                    	jnz	short setend1
 10358 0000155F 8B440C                  	mov	ax,[si+12]		; .BPB_SECTORSPERFAT32  ; 32 bit FAT size field.
 10359 00001562 8B4C0E                  	mov	cx,[si+14]		; .BPB_SECTORSPERFAT32+2
 10360                                  setend1:
 10361 00001565 52                      	push    dx	; (**)		; cx:ax = FAT size (in sectors)
 10362                                  					; dx:bx = calculated number of clusters
 10363 00001566 91                      	xchg    ax,cx
 10364 00001567 26F76602                	mul	word [es:bp+DPB.SECTOR_SIZE]
 10365                                  	;mul	word [es:bp+2]		; DPB.SECTOR_SIZE
 10366 0000156B 91                      	xchg    ax,cx
 10367 0000156C 26F76602                	mul	word [es:bp+DPB.SECTOR_SIZE]
 10368                                  	;mul	word [es:bp+2]
 10369 00001570 01CA                    	add	dx,cx			; dx:ax = FAT size in bytes
 10370 00001572 59                      	pop	cx	; (**)		; calculated # clusters HW
 10371 00001573 09C9                    	or	cx,cx
 10372 00001575 7506                    	jnz	short setend2		; FAT32
 10373 00001577 81FBF60F                	cmp	bx,0FF6h
 10374 0000157B 721E                    	jb	short setend_fat12	; FAT12
 10375                                  setend2:
 10376                                  	; (PCDOS 7.1 IBMDOS.COM BUGfix)
 10377                                  	;or	cx,cx			; HW of calculated cluster count
 10378                                  	;jnz	short setend3
 10379 0000157D 83FBF6                  	cmp	bx,0FFF6h
 10380 00001580 720C                    	jb	short setend4		; FAT16
 10381                                  setend3:
 10382 00001582 D1EA                    	shr	dx,1			; FAT32 ; 4 byte (32 bit) cluster number
 10383                                  					; fatsiz/4 = # of fat entries
 10384 00001584 D1D8                    	rcr	ax,1
 10385 00001586 D1EA                    	shr	dx,1
 10386 00001588 7408                    	jz	short setend5		; dx = 0
 10387 0000158A D1D8                    	rcr	ax,1
 10388 0000158C EB1B                    	jmp	short setend_fat16
 10389                                  
 10390                                  setend4:
 10391 0000158E D1EA                    	shr	dx,1			; FAT16 ; 2 byte (16 bit) cluster number
 10392                                  					; fatsiz/2 = # of fat entries
 10393 00001590 7525                    	jnz	short setend_faterr ; dx > 0
 10394                                  setend5:
 10395 00001592 D1D8                    	rcr	ax,1			; FAT16 ; 2 byte (16 bit) cluster number
 10396                                  					; fatsiz/2 = # of fat entries
 10397 00001594 3DF70F                  	cmp	ax,0FF7h		; 4096-10+1
 10398 00001597 721E                    	jb	short setend_faterr
 10399 00001599 EB0E                    	jmp	short setend_fat16
 10400                                  
 10401                                  setend_fat12:
 10402 0000159B 01C0                    	add	ax,ax			; FAT12 ; 1.5 byte (12 bit) cluster number
 10403                                  					; (fatsiz*2)/3 = # of fat entries
 10404 0000159D 11D2                    	adc	dx,dx
 10405 0000159F 83FA03                  	cmp	dx,3			; if our fatspace is more than we need
 10406                                  					; use calculated size
 10407 000015A2 7313                    	jnb	short setend_faterr
 10408 000015A4 2EF736[5914]            	div	word [cs:word3]
 10409                                  setend_fat16:
 10410 000015A9 83E801                  	sub	ax,1
 10411 000015AC 83DA00                  	sbb	dx,0
 10412 000015AF 39CA                    	cmp	dx,cx			; is fat big enough?
 10413 000015B1 7704                    	ja	short setend_faterr
 10414 000015B3 39D8                    	cmp	ax,bx
 10415 000015B5 7604                    	jbe	short setend_fat32	; use max value that'll fit
 10416                                  setend_faterr:
 10417 000015B7 89D8                    	mov	ax,bx			; use calculated value
 10418 000015B9 89CA                    	mov	dx,cx
 10419                                  setend_fat32:
 10420 000015BB 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 10421                                  	;cmp	word [es:bp+15],0	; DPB.FAT_SIZE ; 16 bit FAT size
 10422 000015C0 750E                    	jnz	short setend6
 10423 000015C2 26C74611FFFF            	mov	word [es:bp+DPB.DIR_SECTOR],-1 
 10424                                  	;mov	word [es:bp+17],0FFFFh	; DPB.DIR_SECTOR
 10425                                  					; (16 bit directory sector field)
 10426 000015C8 26C7460D0000            	mov	word [es:bp+DPB.MAX_CLUSTER],0 
 10427                                  	;mov	word [es:bp+13],0	; DPB.MAX_CLUSTER (16 bit)
 10428 000015CE EB04                    	jmp	short setend7
 10429                                  
 10430                                  setend6:
 10431 000015D0 2689460D                	mov	[es:bp+DPB.MAX_CLUSTER],ax
 10432                                  	;mov	[es:bp+13],ax	; DPB.MAX_CLUSTER = calculated last cluster number
 10433                                  setend7:
 10434 000015D4 59                      	pop	cx	; (*)		; 1 = use FAT32 extensions
 10435                                  					; 0 = don't use FAT32 extensions (32 bit fields)
 10436 000015D5 E353                    	jcxz	setend_fat		; do not use FAT32 extensions
 10437                                  	;mov	[es:bp+45],ax		; DPB.MAX_CLUSTER32 ; dx:ax = last cluster number
 10438                                  	;mov	[es:bp+47],dx
 10439 000015D7 2689462D                	mov	[es:bp+DPB.LAST_CLUSTER],ax
 10440 000015DB 2689562F                	mov	[es:bp+DPB.LAST_CLUSTER+2],dx
 10441 000015DF B8FFFF                  	mov	ax,0FFFFh ; -1
 10442 000015E2 8D7E21                  	lea	di,[bp+DPB.FREE_CNT_HW]
 10443                                  	;lea	di,[bp+33]		; DPB.FAT32_EXT ; FAT32 extensions
 10444                                  					; -1 = ready
 10445 000015E5 AB                      	stosw
 10446 000015E6 8D7410                  	lea	si,[si+16]		; FAT32 flags
 10447 000015E9 A5                      	movsw	   			; DPB FAT32 flags ; [bp+23h]
 10448 000015EA 83C606                  	add	si,6
 10449 000015ED AD                      	lodsw				; FSINFO structure sector number
 10450 000015EE 8B54DC                  	mov	dx,[si-24h]		; .BPB_RESERVEDSECTORS ; Number of reserved sectors.
 10451 000015F1 09C0                    	or	ax,ax
 10452 000015F3 7404                    	jz	short setend8
 10453 000015F5 39D0                    	cmp	ax,dx
 10454 000015F7 7203                    	jb	short setend9
 10455                                  setend8:
 10456 000015F9 B8FFFF                  	mov	ax,0FFFFh ; -1		; invalid
 10457                                  setend9:
 10458 000015FC AB                      	stosw				; DPB FSINFO structure sector number
 10459                                  					; [bp+25h]
 10460 000015FD AD                      	lodsw				; Sector number of the backup boot sector
 10461 000015FE 09C0                    	or	ax,ax
 10462 00001600 7404                    	jz	short setend10
 10463 00001602 39D0                    	cmp	ax,dx
 10464 00001604 7203                    	jb	short setend11
 10465                                  setend10:
 10466 00001606 B8FFFF                  	mov	ax,0FFFFh ; -1		; invalid
 10467                                  setend11:
 10468 00001609 AB                      	stosw	   			; DPB backup boot sector address
 10469                                  					; [bp+27h]
 10470 0000160A 83C708                  	add	di,8			; [bp+31h]
 10471 0000160D 31D2                    	xor	dx,dx
 10472 0000160F 268B45DE                	mov	ax,[es:di-34]		; [bp+0Fh] ; DPB.MAX_CLUSTER
 10473 00001613 39D0                    	cmp	ax,dx
 10474 00001615 7506                    	jnz	short setend12		; > 0 (not FAT32)
 10475 00001617 8B44F0                  	mov	ax,[si-16]		; FAT32 Sectors per FAT ; .BPB_SECTORSPERFAT32
 10476 0000161A 8B54F2                  	mov	dx,[si-14]
 10477                                  setend12:
 10478 0000161D AB                      	stosw				; DPB FAT32 FAT size in sectors ; [bp+31h]
 10479 0000161E 89D0                    	mov	ax,dx
 10480 00001620 AB                      	stosw
 10481 00001621 83EE08                  	sub	si,8			; Root directory cluster number
 10482 00001624 A5                      	movsw				; DPB Root Dir Cluster ; [bp+35h]
 10483 00001625 A5                      	movsw
 10484 00001626 31C0                    	xor	ax,ax			; DPB reserved ; [bp+39h]
 10485 00001628 AB                      	stosw
 10486 00001629 AB                      	stosw	
 10487                                  %endif
 10488                                  	;;;
 10489                                  
 10490                                  setend_fat:
 10491                                  
 10492                                  	; 13/01/2024 - Retro DOS v5.0
 10493 0000162A 31C0                    	xor	ax,ax ; 0
 10494                                  
 10495                                  	;mov	word [es:bp+1Dh],ax ; 0
 10496 0000162C 2689461D                	mov	word [es:bp+DPB.NEXT_FREE],ax ; 0 
 10497                                  					; Init so first ALLOC starts at
 10498                                  					; begining of FAT
 10499 00001630 48                      	dec	ax  ; -1
 10500                                  	;mov	word [es:bp+1Fh],ax ; -1
 10501 00001631 2689461F                	mov	word [es:bp+DPB.FREE_CNT],ax ; -1 ; current count is invalid.
 10502                                  
 10503 00001635 C3                      	retn
 10504                                  
 10505                                  ;EndProc $SETDPB
 10506                                  
 10507                                  ;BREAK <$Create_Process_Data_Block,SetMem -- Set up process data block>
 10508                                  
 10509                                  ;
 10510                                  ;----------------------------------------------------------------------------
 10511                                  ;
 10512                                  ;**	$Dup_PDB
 10513                                  ;
 10514                                  ; Inputs:   DX is new segment address of process
 10515                                  ;	    SI is end of new allocation block
 10516                                  ;
 10517                                  ;----------------------------------------------------------------------------
 10518                                  ;
 10519                                  	; 14/01/2024 - Retro DOS 5.0
 10520                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:554Fh
 10521                                  
 10522                                  _$DUP_PDB:
 10523                                  
 10524                                  ;hkn;	CreatePDB would have a CS override. This is not valid.
 10525                                  ;hkn;	Must set up ds in order to acess CreatePDB. Also SS is 
 10526                                  ;hkn;	has been assumed to be NOTHING. It may not have DOSDATA.
 10527                                  
 10528                                  	; MSDOS 3.3
 10529                                  	;MOV	byte [CS:CreatePDB],0FFh  ; indicate a new process
 10530                                  	;MOV	DS,[CS:CurrentPDB]
 10531                                  
 10532                                  	; 15/05/2019 - Retro DOS v4.0
 10533                                  	; MSDOS 6.0
 10534 00001636 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 10535 0000163B C606[A803]FF            	MOV	byte [CreatePDB],0FFh
 10536 00001640 8E1E[3003]              	MOV	DS,[CurrentPDB]
 10537                                  
 10538 00001644 56                      	PUSH	SI
 10539 00001645 EB0A                    	JMP	SHORT CreateCopy
 10540                                  
 10541                                  ;
 10542                                  ;----------------------------------------------------------------------------
 10543                                  ;
 10544                                  ; Inputs:
 10545                                  ;	DX = Segment number of new base
 10546                                  ; Function:
 10547                                  ;	Set up program base and copy term and ^C from int area
 10548                                  ; Returns:
 10549                                  ;	None
 10550                                  ; Called at DOS init
 10551                                  ;
 10552                                  ;----------------------------------------------------------------------------
 10553                                  ;
 10554                                  
 10555                                  ; 15/05/2019 - Retro DOS v4.0
 10556                                  ; DOSCODE:4EB6h (MSDOS 6.21, MSDOS.SYS)
 10557                                  
 10558                                  ; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 10559                                  ; DOSCODE:4EA2h (MSDOS 5.0, MSDOS.SYS)
 10560                                  
 10561                                  _$CREATE_PROCESS_DATA_BLOCK:
 10562                                  			; Offset 1D02h in IBMDOS.COM (MSDOS 3.3), 1987
 10563 00001647 E82DEE                  	CALL	Get_User_Stack
 10564                                  	;mov	ds,[si+14h]
 10565 0000164A 8E5C14                  	MOV	DS,[SI+user_env.user_CS]
 10566                                  	;push	word [2]
 10567 0000164D FF360200                	PUSH	word [PDB.BLOCK_LEN] ;*
 10568                                  CreateCopy:
 10569 00001651 8EC2                    	MOV	ES,DX
 10570                                  
 10571 00001653 31F6                    	XOR	SI,SI			; copy entire PDB
 10572 00001655 89F7                    	MOV	DI,SI
 10573 00001657 B98000                  	MOV	CX,128
 10574 0000165A F3A5                    	REP	MOVSW
 10575                                  
 10576                                  ; DOS 3.3 7/9/86
 10577                                  	;mov	cx,20
 10578                                  	;MOV	CX,FILPERPROC		; copy handles in case of
 10579                                  	; 15/12/2022
 10580 0000165C B114                    	mov	cl,FILPERPROC ; 06/07/2019
 10581                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10582                                  	;mov	cx,FILPERPROC
 10583                                  
 10584                                  	;mov	di,18h
 10585 0000165E BF1800                  	MOV	DI,PDB.JFN_TABLE	; Set Handle Count has been issued
 10586                                  	;;PUSH	DS ; * 15/05/2019
 10587                                  	;;lds	si,[34h]
 10588                                  	;LDS	SI,[PDB.JFN_Pointer]
 10589                                  	;REP	MOVSB
 10590                                  	;;POP	DS ; * 15/05/2019
 10591                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10592                                  	; 05/12/2022
 10593                                  	; (push ds then pop ds is not needed here!)
 10594                                  	;push	ds
 10595                                  	;lds	si,[34h]
 10596 00001661 C5363400                	lds	si,[PDB.JFN_Pointer]
 10597 00001665 F3A4                    	rep	movsb
 10598                                  	;pop	ds
 10599                                  
 10600                                  ; DOS 3.3 7/9/86
 10601                                  	;hkn ;CreatePDB would have a CS override. This is not valid.
 10602                                  	;hkn ;Must set up ds in order to access CreatePDB. Also SS is 
 10603                                  	;hkn ;has been assumed to be NOTHING. It may not have DOSDATA.
 10604                                  
 10605 00001667 2E8E1E[0700]            	mov	ds,[cs:DosDSeg] ; 15/05/2019
 10606                                  
 10607                                  	;;test	byte [cs:CreatePDB],0FFh
 10608                                  	;cmp	byte [CS:CreatePDB],0	; Shall we create a process?
 10609                                  	; 17/12/2022
 10610 0000166C 380E[A803]              	cmp	[CreatePDB],cl ; 0
 10611                                  	;cmp	byte [CreatePDB],0 ; 15/05/2019
 10612 00001670 744A                    	JZ	short Create_PDB_cont 	; nope, old style call
 10613                                  
 10614                                  ; Here we set up for a new process...
 10615                                  
 10616                                  	;PUSH	CS			; Called at DOSINIT time, NO SS
 10617                                  	;POP	DS
 10618                                  
 10619                                  	; MSDOS 6.0
 10620                                  	;;getdseg <ds>			; ds -> dosdata
 10621                                  	;mov	ds,[cs:DosDSeg] ; 15/05/2019
 10622                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10623                                  	; (nonsense! but i put this for addr compatibility as temporary)
 10624                                  	; 15/12/2022
 10625                                  	;mov	ds,[cs:DosDSeg] ; 15/05/2019
 10626                                  
 10627 00001672 31DB                    	XOR	BX,BX			; dup all jfns
 10628                                  	;mov	cx,20
 10629                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10630                                  	;MOV	CX,FILPERPROC		; only 20 of them
 10631                                  	; 15/12/2022
 10632 00001674 B114                    	mov	cl,FILPERPROC ; 06/07/2019
 10633                                  
 10634                                  Create_dup_jfn:
 10635 00001676 06                      	PUSH	ES ;**			; save new PDB
 10636 00001677 E88660                  	call	SFFromHandle		; get sf pointer
 10637 0000167A B0FF                    	MOV	AL,-1			; unassigned JFN
 10638 0000167C 7224                    	JC	short CreateStash	; file was not really open
 10639                                  	;;test	word [es:di+5],1000h
 10640                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_no_inherit
 10641                                  	; 15/05/2019
 10642                                  	;test	byte [es:di+6],10h
 10643 0000167E 26F6450610              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_no_inherit>>8)
 10644 00001683 751D                    	JNZ	short CreateStash	; if no-inherit bit is set, skip dup.
 10645                                  
 10646                                  ; We do not inherit network file handles.
 10647                                  
 10648                                  	;mov	ah,[es:di+2]
 10649 00001685 268A6502                	MOV	AH,[ES:DI+SF_ENTRY.sf_mode]
 10650                                  	;and	ah,0F0h
 10651 00001689 80E4F0                  	AND	AH,SHARING_MASK
 10652                                  	;cmp	ah,70h
 10653 0000168C 80FC70                  	CMP	AH,SHARING_NET_FCB
 10654 0000168F 7411                    	jz	short CreateStash
 10655                                  
 10656                                  ; The handle we have found is duplicatable (and inheritable). Perform
 10657                                  ; duplication operation.
 10658                                  
 10659 00001691 893E[9E05]              	MOV	[THISSFT],DI
 10660 00001695 8C06[A005]              	MOV	[THISSFT+2],ES
 10661 00001699 E8191A                  	call	DOS_DUP 		; signal duplication
 10662                                  
 10663                                  ; get the old sfn for copy
 10664                                  
 10665 0000169C E84460                  	call	pJFNFromHandle		; ES:DI is jfn
 10666 0000169F 268A05                  	MOV	AL,[ES:DI]		; get sfn
 10667                                  
 10668                                  ; Take AL (old sfn or -1) and stash it into the new position
 10669                                  
 10670                                  CreateStash:
 10671 000016A2 07                      	POP	ES ;**
 10672                                  	;mov	[es:bx+18h],al
 10673 000016A3 26884718                	MOV	[ES:BX+PDB.JFN_TABLE],AL ; copy into new place!
 10674 000016A7 43                      	INC	BX			; next jfn...
 10675 000016A8 E2CC                    	LOOP	Create_dup_jfn
 10676                                  
 10677 000016AA 8B1E[3003]              	MOV	BX,[CurrentPDB]		; get current process
 10678                                  	; 06/11/2022
 10679                                  	;mov	[es:16h],bx
 10680 000016AE 26891E1600              	MOV	[ES:PDB.PARENT_PID],BX	; stash in child
 10681 000016B3 8C06[3003]              	MOV	[CurrentPDB],ES
 10682                                  	;MOV	DS,BX ; 28/07/2019
 10683                                  	; 07/12/2022
 10684                                  	;mov	ds,[cs:DosDSeg]
 10685                                  	; 15/12/2022
 10686                                  	; ds = [cs:DosDSeg]
 10687 000016B7 C606[A803]00            	mov	byte [CreatePDB],0	; reset flag
 10688                                  	;mov	ds,bx
 10689                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10690                                  	; 15/12/2022
 10691                                  	;mov	ds,bx
 10692                                  
 10693                                  ; end of new process create
 10694                                  
 10695                                  Create_PDB_cont:
 10696                                  	;MOV	BYTE [CS:CreatePDB],0	; reset flag
 10697                                  
 10698                                  ;hkn; It comes to this point from 2 places. So, change to DOSDATA temporarily	
 10699                                  
 10700                                  	;; 28/07/2019
 10701                                  	;;push	ds
 10702                                  	;;mov	ds,[cs:DosDSeg]
 10703                                  	;mov	byte [CreatePDB],0
 10704                                  	;;pop	ds
 10705                                  
 10706                                  ; 05/12/2022
 10707                                  ;	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10708                                  ;	; (push-pop ds is nonsense here! 
 10709                                  ;	;  but i am using same code with original MSDOS.SYS
 10710                                  ;	;  for address compatibility.)
 10711                                  ;	push	ds
 10712                                  ;	; ds = [cs:DosDSeg] !
 10713                                  ;	mov	ds,[cs:DosDSeg]  ; again !
 10714                                  ;	mov	byte [CreatePDB],0
 10715                                  ;	pop	ds
 10716                                  
 10717 000016BC 58                      	POP	AX ;*
 10718                                  
 10719                                  	;entry	SETMEM
 10720                                  
 10721                                  	; 17/12/2022
 10722                                  	; cx = 0
 10723                                  
 10724                                  ;---------------------------------------------------------------------------
 10725                                  ; Inputs:
 10726                                  ;	AX = Size of memory in paragraphs
 10727                                  ;	DX = Segment
 10728                                  ; Function:
 10729                                  ;	Completely prepares a program base at the
 10730                                  ;	specified segment.
 10731                                  ; Called at DOS init
 10732                                  ; Outputs:
 10733                                  ;	DS = DX
 10734                                  ;	ES = DX
 10735                                  ;	[0] has INT int_abort
 10736                                  ;	[2] = First unavailable segment
 10737                                  ;	[5] to [9] form a long call to the entry point
 10738                                  ;	[10] to [13] have exit address (from int_terminate)
 10739                                  ;	[14] to [17] have ctrl-C exit address (from int_ctrl_c)
 10740                                  ;	[18] to [21] have fatal error address (from int_fatal_abort)
 10741                                  ; DX,BP unchanged. All other registers destroyed.
 10742                                  ;---------------------------------------------------------------------------
 10743                                  
 10744                                  SETMEM:
 10745                                  	;XOR	CX,CX
 10746                                  	; 17/12/2022
 10747                                  	; cx = 0
 10748 000016BD 8ED9                    	MOV	DS,CX
 10749 000016BF 8EC2                    	MOV	ES,DX
 10750                                  	;mov	si,88h
 10751 000016C1 BE8800                  	MOV	SI,addr_int_terminate
 10752                                  	;mov	di,10 ; 0Ah
 10753 000016C4 BF0A00                  	MOV	DI,SAVEXIT
 10754                                  	;MOV	CX,6
 10755                                  	; 15/12/2022
 10756 000016C7 B106                    	mov	cl,6
 10757 000016C9 F3A5                    	REP	MOVSW
 10758 000016CB 26A30200                	MOV	[ES:2],AX
 10759 000016CF 29D0                    	SUB	AX,DX
 10760 000016D1 3DFF0F                  	CMP	AX,MAXDIF ; 0FFFh
 10761 000016D4 7603                    	JBE	short HAVDIF
 10762 000016D6 B8FF0F                  	MOV	AX,MAXDIF
 10763                                  HAVDIF:
 10764 000016D9 83E810                  	SUB	AX,10h			; Allow for 100h byte "stack"
 10765 000016DC BB0C00                  	MOV	BX,ENTRYPOINTSEG ; 0Ch	;	in .COM files
 10766 000016DF 29C3                    	SUB	BX,AX
 10767 000016E1 B104                    	MOV	CL,4
 10768 000016E3 D3E0                    	SHL	AX,CL
 10769 000016E5 8EDA                    	MOV	DS,DX
 10770                                  
 10771                                  	; (MSDOS 6.0 note)
 10772                                  	;
 10773                                  	; The address in BX:AX will be F01D:FEF0 if there is 64K or more 
 10774                                  	; memory in the system. This is equivalent to 0:c0 if A20 is OFF.
 10775                                  	; If DOS is in HMA this equivalence is no longer valid as A20 is ON.
 10776                                  	; But the BIOS which now resides in FFFF:30 has 5 bytes in FFFF:D0
 10777                                  	; (F01D:FEF0) which is the same as the ones in 0:C0, thereby 
 10778                                  	; making this equvalence valid for this particular case. If however
 10779                                  	; there is less than 64K remaining the address in BX:AX will not 
 10780                                  	; be the same as above. We will then stuff 0:c0, the call 5 address
 10781                                  	; into the PSP.
 10782                                  	;
 10783                                  	; Therefore for the case where there is less than 64K remaining in 
 10784                                  	; the system old CPM Apps that look at PSP:6 to determine memory
 10785                                  	; requirements will not work. Call 5, however will continue to work
 10786                                  	; for all cases.
 10787                                  	;
 10788                                  
 10789                                  	;mov	[6],ax
 10790                                  	;mov	[8],bx
 10791                                  
 10792 000016E7 A30600                  	MOV	[PDB.CPM_CALL+1],AX
 10793 000016EA 891E0800                	MOV	[PDB.CPM_CALL+3],BX
 10794                                  
 10795                                  	; 06/05/2019 - Retro DOS v4.0
 10796 000016EE 3DF0FE                  	cmp	ax,WRAPOFFSET ; 0FEF0h	; Q: does the system have >= 64k of
 10797                                  					;    memory left
 10798 000016F1 740C                    	je	short addr_ok		; Y: the above calculated address is
 10799                                  					;    OK
 10800                                  					; N: 
 10801                                  
 10802 000016F3 C7060600C000            	MOV	WORD [PDB.CPM_CALL+1],0C0h
 10803 000016F9 C70608000000            	MOV	WORD [PDB.CPM_CALL+3],0
 10804                                  addr_ok:
 10805                                  	;mov	word [0],20CDh
 10806 000016FF C7060000CD20            	MOV	word [PDB.EXIT_CALL],(int_abort*256) + mi_INT
 10807                                  	;mov	byte [5],9Ah
 10808 00001705 C60605009A              	MOV	BYTE [PDB.CPM_CALL],mi_Long_CALL
 10809                                  	;mov	word [50h],21CDh
 10810 0000170A C7065000CD21            	MOV	WORD [PDB.CALL_SYSTEM],(int_command*256) + mi_INT
 10811                                  	;mov	byte [52h],0CBh
 10812 00001710 C6065200CB              	MOV	BYTE [PDB.CALL_SYSTEM+2],mi_Long_RET
 10813                                  	;mov	word [34h],18h
 10814 00001715 C70634001800            	MOV	WORD [PDB.JFN_Pointer],PDB.JFN_TABLE
 10815                                  	;mov	word [36h],ds
 10816 0000171B 8C1E3600                	MOV	WORD [PDB.JFN_Pointer+2],DS
 10817                                  	;mov	word [32h],20
 10818 0000171F C70632001400            	MOV	WORD [PDB.JFN_Length],FILPERPROC
 10819                                  ;
 10820                                  ; The server runs several PDB's without creating them VIA EXEC.  We need to
 10821                                  ; enumerate all PDB's at CPS time in order to find all references to a
 10822                                  ; particular SFT.  We perform this by requiring that the server link together
 10823                                  ; for us all sub-PDB's that he creates. The requirement for us, now, is to
 10824                                  ; initialize this pointer.
 10825                                  ;
 10826                                   	;mov	word [38h],-1
 10827 00001725 C7063800FFFF            	MOV	word [PDB.Next_PDB],-1
 10828                                  	;mov	word [3Ah],-1
 10829 0000172B C7063A00FFFF            	MOV	word [PDB.Next_PDB+2],-1
 10830                                  
 10831                                  	; 06/05/2019
 10832                                  	; Set the real version number in the PSP - 5.00
 10833                                  
 10834                                  	;mov	word [es:PDB.Version],1406h ; MSDOS 6.21 (DOSCODE:4FB6h)
 10835                                  	; 07/12/2022
 10836 00001731 26C7064000070A          	mov	word [ES:PDB.Version],(MINOR_VERSION*256)+MAJOR_VERSION
 10837                                  
 10838 00001738 C3                      	retn
 10839                                  
 10840                                  ; 29/04/2019 - Retro DOS v4.0
 10841                                  
 10842                                  ;BREAK <$GSetMediaID -- get set media ID>
 10843                                  
 10844                                  ;---------------------------------------------------------------------------
 10845                                  ; Inputs:
 10846                                  ;	BL= drive number as defined in IOCTL
 10847                                  ;	AL= 0 get media ID
 10848                                  ;	    1 set media ID
 10849                                  ;	DS:DX= buffer containing information
 10850                                  ;		DW  0  info level (set on input)
 10851                                  ;		DD  ?  serial #
 10852                                  ;		DB  11 dup(?)  volume id
 10853                                  ;		DB   8 dup(?)  file system type
 10854                                  ; Function:
 10855                                  ;	Get or set media ID
 10856                                  ; Returns:
 10857                                  ;	carry clear, DS:DX is filled
 10858                                  ;	carry set, error
 10859                                  ;---------------------------------------------------------------------------
 10860                                  
 10861                                  	; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 10862                                  
 10863                                  ; 14/01/2024
 10864                                  %if 0
 10865                                  
 10866                                  _$GSetMediaID:
 10867                                  	; RAWIO - GET_MEDIA_ID
 10868                                  	mov	cx,0866h	      ;AN000;MS.; assume get for IOCTL
 10869                                  	cmp	al,0		      ;AN001;MS.; get ?
 10870                                  	je	short doioctl 	      ;AN000;MS.; yes
 10871                                  	;cmp	al,1		      ;AN000;MS.; set ?
 10872                                  	;jne	short errorfunc	      ;AN000;MS.; no
 10873                                  	; 15/12/2022
 10874                                  	dec	al
 10875                                  	jnz	short errorfunc ; al > 1
 10876                                  	; RAWIO - SET_MEDIA_ID
 10877                                  	;mov	cx,0846h	      ;AN001;MS.;
 10878                                  	; 15/12/2022
 10879                                  	mov	cl,46h	; cx = 0846h
 10880                                  doioctl:			      ;AN000;
 10881                                  	mov	al,0Dh		      ;AN000;MS.; generic IOCTL
 10882                                  	;invoke	$IOCTL		      ;AN000;MS.; let IOCTL take care of it
 10883                                  	;call	_$IOCTL
 10884                                  	;retn			      ;AN000;MS.;
 10885                                  	; 15/12/2022
 10886                                  	jmp	_$IOCTL
 10887                                  errorfunc:			      ;AN000;
 10888                                  	;error	error_invalid_function;AN000;MS. ; invalid function
 10889                                  	;mov	al,1
 10890                                  	mov	al,error_invalid_function
 10891                                  	jmp	SYS_RET_ERR
 10892                                  
 10893                                  %else
 10894                                  	; 14/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 10895                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:5667h
 10896                                  
 10897                                  _$GSetMediaID:
 10898 00001739 1E                      	push	ds
 10899 0000173A 56                      	push	si
 10900 0000173B 36C536[A205]            	lds	si,[ss:THISCDS]
 10901 00001740 C57445                  	lds	si,[si+45h]		; [si+curdir.devptr]
 10902                                  					; local pointer to DPB or net device
 10903 00001743 8B740F                  	mov	si,[si+0Fh]		; [si+DPB.FAT_SIZE]
 10904 00001746 B96608                  	mov	cx,0866h		; assume get for IOCTL
 10905 00001749 3C01                    	cmp	al,1			; set ?
 10906 0000174B 7208                    	jb	short doioctl1		; get
 10907 0000174D 7733                    	ja	short errorfunc		; invalid
 10908 0000174F B146                    	mov	cl,46h	; cx = 0846h
 10909                                  	;or	si,si
 10910 00001751 21F6                    	and	si,si ; 14/01/2024
 10911 00001753 7424                    	jz	short doioctl2
 10912                                  doioctl1:
 10913 00001755 09F6                    	or	si,si
 10914 00001757 7522                    	jnz	short doioctl
 10915 00001759 1F                      	pop	ds
 10916 0000175A 1E                      	push	ds
 10917 0000175B 89D6                    	mov	si,dx	; disk info
 10918                                  			; .................................
 10919                                  			;
 10920                                  			; 00h    WORD    0000h (info level)
 10921                                  			; 02h    DWORD   disk serial number (binary)
 10922                                  			; 06h 11 BYTEs   volume label or "NO NAME    " if none present
 10923                                  			; 11h  8 BYTEs   (AL=00h only) filesystem type
 10924                                  			;		"FAT12   "
 10925                                  			;		"FAT16   "
 10926                                  			;		"FAT32   " ; PCDOS 7.1
 10927                                  			;		"CDROM   "
 10928                                  			;		"CD001   " 
 10929                                  			;		"CDAUDIO "
 10930                                  			; .................................
 10931                                  			; (ref: Ralf Brown's Interrupt List) 		
 10932                                  
 10933 0000175D 817C114641              	cmp	word [si+11h],4146h ; 'FA'
 10934 00001762 7517                    	jne	short doioctl
 10935 00001764 817C135433              	cmp	word [si+13h],3354h ; 'T3'
 10936 00001769 7510                    	jne	short doioctl
 10937 0000176B 817C153220              	cmp     word [si+15h],2032h ; '2 '
 10938 00001770 7509                    	jne	short doioctl
 10939 00001772 817C172020              	cmp	word [si+17h],2020h ; '  '
 10940 00001777 7502                    	jne	short doioctl
 10941                                  doioctl2:
 10942 00001779 B548                    	mov	ch,48h	; cx = 4846h
 10943                                  doioctl:
 10944 0000177B 5E                      	pop	si
 10945 0000177C 1F                      	pop	ds
 10946 0000177D B00D                    	mov	al,0Dh			; generic IOCTL
 10947                                  	;call	_$IOCTL
 10948                                          ;retn
 10949 0000177F E90811                  	jmp	_$IOCTL			; let IOCTL take care of it
 10950                                  
 10951                                  errorfunc:
 10952 00001782 B001                    	mov	al,1			; error_invalid_function
 10953 00001784 E9EDEE                  	jmp	SYS_RET_ERR
 10954                                  
 10955                                  %endif
 10956                                  
 10957                                  ; 16/05/2019 - Retro DOS v4.0
 10958                                  
 10959                                  ;============================================================================
 10960                                  ; MISC2.ASM, MSDOS 6.0, 1991
 10961                                  ;============================================================================
 10962                                  ; 20/07/2018 - Retro DOS v3.0
 10963                                  ; 29/04/2019 - Retro DOS v4.0
 10964                                  
 10965                                  ; Break <STRCMP - compare two ASCIZ strings DS:SI to ES:DI>
 10966                                  ;----------------------------------------------------------------------------
 10967                                  ;
 10968                                  ;   Strcmp - compare ASCIZ DS:SI to ES:DI. Case INSENSITIVE. '/' = '\'
 10969                                  ;	     Strings of different lengths don't match.
 10970                                  ;   Inputs:  DS:SI - pointer to source string  ES:DI - pointer to dest string
 10971                                  ;   Outputs: Z if strings same, NZ if different
 10972                                  ;   Registers modified: NONE
 10973                                  ;----------------------------------------------------------------------------
 10974                                  
 10975                                  	; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 10976                                  
 10977                                  	; 14/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 10978                                  	; (PCDOS 7.1 IBMDOS.COM DOSCODE:56B6h)
 10979                                  	; (MSDOS 6.22 MSDOS.SYS DOSCODE:4FD7h)
 10980                                  StrCmp:
 10981 00001787 56                      	push	si
 10982 00001788 57                      	push	di
 10983 00001789 50                      	push	ax
 10984                                  Cmplp:
 10985 0000178A AC                      	LODSB
 10986 0000178B E83646                  	call	UCase			; convert to upper case
 10987 0000178E E88646                  	call	PATHCHRCMP		; convert '/' to '\' ; 07/12/2022 ('\')
 10988 00001791 88C4                    	MOV	AH,AL
 10989 00001793 268A05                  	MOV	AL,[ES:DI]
 10990 00001796 47                      	INC	DI
 10991 00001797 E82A46                  	call	UCase			; convert to upper case
 10992 0000179A E87A46                  	call	PATHCHRCMP		; convert '/' to '\' ; 07/12/2022 ('\')
 10993 0000179D 38C4                    	CMP	AH,AL
 10994 0000179F 7504                    	JNZ	short PopRet		; Strings dif
 10995                                  
 10996 000017A1 08C0                    	OR	AL,AL
 10997 000017A3 75E5                    	JNZ	short Cmplp		; More string
 10998                                  PopRet:
 10999 000017A5 58                      	pop	ax
 11000 000017A6 5F                      	pop	di
 11001 000017A7 5E                      	pop	si
 11002 000017A8 C3                      	retn
 11003                                  
 11004                                  ;Break <STRCPY - copy ASCIZ string from DS:SI to ES:DI>
 11005                                  ;----------------------------------------------------------------------------
 11006                                  ;
 11007                                  ;   Strcpy - copy an ASCIZ string from DS:SI to ES:DI and make uppercase
 11008                                  ;   FStrcpy - copy an ASCIZ string from DS:SI to ES:DI. no modification of
 11009                                  ;	characters.
 11010                                  ;
 11011                                  ;   Inputs:	DS:SI - pointer to source string
 11012                                  ;		ES:DI - pointer to destination string
 11013                                  ;   Outputs:	ES:DI point byte after nul byte at end of dest string
 11014                                  ;		DS:SI point byte after nul byte at end of source string
 11015                                  ;   Registers modified: SI,DI
 11016                                  ;----------------------------------------------------------------------------
 11017                                  
 11018                                  StrCpy:
 11019 000017A9 50                      	push	ax
 11020                                  CPYLoop:
 11021 000017AA AC                      	LODSB
 11022 000017AB E81646                  	call	UCase			; convert to upper case
 11023 000017AE E86646                  	call	PATHCHRCMP		; convert / to \ ;
 11024 000017B1 AA                      	STOSB
 11025                                  
 11026 000017B2 08C0                    	OR	AL,AL
 11027 000017B4 75F4                    	JNZ	short CPYLoop
 11028 000017B6 58                      	pop	ax
 11029 000017B7 C3                      	retn
 11030                                  
 11031                                  ;----------------------------------------------------------------------------
 11032                                  ; Procedure Name : FStrCpy
 11033                                  ;----------------------------------------------------------------------------
 11034                                  
 11035                                  FStrCpy:
 11036 000017B8 50                      	push	ax
 11037                                  FCPYLoop:
 11038 000017B9 AC                      	LODSB
 11039 000017BA AA                      	STOSB
 11040 000017BB 08C0                    	OR	AL,AL
 11041 000017BD 75FA                    	JNZ	short FCPYLoop
 11042 000017BF 58                      	pop	ax
 11043 000017C0 C3                      	retn
 11044                                  
 11045                                  ; 20/07/2018 - Retro DOS v3.0
 11046                                  ;----------------------------------------------------------------------------
 11047                                  ; UCase, IBMDOS.COM (MSDOS 3.3), 1987 - Offset 1E2Fh
 11048                                  ;----------------------------------------------------------------------------
 11049                                  ;
 11050                                  ;UCase:	
 11051                                  ;	call	_UCase	 ; Offset 5518h (GetLet, Offset 5517h)
 11052                                  ;	retn
 11053                                  
 11054                                  ;Break <StrLen - compute length of string ES:DI>
 11055                                  ;----------------------------------------------------------------------------
 11056                                  ;**	StrLen - Compute Length of String
 11057                                  ;
 11058                                  ;	StrLen computes the length of a string, including the trailing 00
 11059                                  ;
 11060                                  ;	ENTRY	(es:di) = address of string
 11061                                  ;	EXIT	(cx) = size of string
 11062                                  ;	USES	cx, flags
 11063                                  ;----------------------------------------------------------------------------
 11064                                  
 11065                                  StrLen:
 11066 000017C1 57                      	push	di
 11067 000017C2 50                      	push	ax
 11068                                  	;MOV	CX,-1
 11069 000017C3 B9FFFF                  	mov	cx,65535
 11070 000017C6 30C0                    	XOR	AL,AL
 11071 000017C8 F2AE                    	REPNE	SCASB
 11072 000017CA F7D1                    	NOT	CX
 11073 000017CC 58                      	pop	ax
 11074 000017CD 5F                      	pop	di
 11075 000017CE C3                      	retn
 11076                                  
 11077                                  ;----------------------------------------------------------------------------
 11078                                  ;**	DStrLen - Compute Length of String
 11079                                  ;
 11080                                  ;	ENTRY	(ds:si) = address of string
 11081                                  ;	EXIT	(cx) = size of string, including trailing NUL
 11082                                  ;	USES	cx, flags
 11083                                  ;----------------------------------------------------------------------------
 11084                                  
 11085                                  DStrLen:	; BUGBUG - this guy is a pig, who uses him?
 11086 000017CF E80300                  	CALL	XCHGP
 11087 000017D2 E8ECFF                  	CALL	StrLen
 11088                                  	;CALL	XCHGP
 11089                                  	;retn
 11090                                  	; 18/12/2022
 11091                                  	;jmp	short XCHGP
 11092                                  
 11093                                  ;----------------------------------------------------------------------------
 11094                                  ;**	XCHGP - Exchange Source and Destination Pointers
 11095                                  ;
 11096                                  ;	XCHGP exchanges (DS:SI) and (ES:DI)
 11097                                  ;
 11098                                  ;	ENTRY	none
 11099                                  ;	EXIT	pairs exchanged
 11100                                  ;	USES	SI, DI, DS, ES
 11101                                  ;----------------------------------------------------------------------------
 11102                                  
 11103                                  XCHGP:
 11104 000017D5 1E                      	push	ds
 11105 000017D6 06                      	push	es
 11106 000017D7 1F                      	pop	ds
 11107 000017D8 07                      	pop	es
 11108 000017D9 87F7                    	XCHG	SI,DI
 11109                                  xchgp_retn:
 11110 000017DB C3                      	retn
 11111                                  
 11112                                  ;Break	<Idle - wait for a specified amount of time>
 11113                                  ;----------------------------------------------------------------------------
 11114                                  ;
 11115                                  ;   Idle - when retrying an operation due to a lock/sharing violation,
 11116                                  ;   	   we spin until RetryLoop is exhausted.
 11117                                  ;
 11118                                  ;   Inputs:	RetryLoop is the number of times we spin
 11119                                  ;   Outputs:	Wait
 11120                                  ;   Registers modified: none
 11121                                  ;----------------------------------------------------------------------------
 11122                                  
 11123                                  Idle:
 11124                                  	;test	byte [SS:FSHARING],0FFh
 11125 000017DC 36803E[7205]00          	cmp	byte [SS:FSHARING],0	;hkn; SS override
 11126                                  	;retnz
 11127 000017E2 75F7                    	jnz	short xchgp_retn
 11128                                  	;SAVE	<CX>
 11129 000017E4 51                      	push	cx
 11130 000017E5 368B0E[1C00]            	MOV	CX,[ss:RetryLoop]	;hkn; SS override
 11131 000017EA E308                    	JCXZ	Idle3
 11132                                  Idle1:	
 11133 000017EC 51                      	PUSH	CX
 11134 000017ED 31C9                    	XOR	CX,CX
 11135                                  Idle2:	
 11136 000017EF E2FE                    	LOOP	Idle2
 11137 000017F1 59                      	POP	CX
 11138 000017F2 E2F8                    	LOOP	Idle1
 11139                                  Idle3:	
 11140                                  	;RESTORE <CX>
 11141 000017F4 59                      	pop	cx
 11142 000017F5 C3                      	retn
 11143                                  
 11144                                  ;Break	<TableDispatch - dispatch to a table>
 11145                                  ;----------------------------------------------------------------------------
 11146                                  ;
 11147                                  ;   TableDispatch - given a table and an index, jmp to the approptiate
 11148                                  ;   routine. Preserve all input registers to the routine.
 11149                                  ;
 11150                                  ;   Inputs:	Push	return address
 11151                                  ;		Push	Table address
 11152                                  ;		Push	index (byte)
 11153                                  ;   Outputs:	appropriate routine gets jumped to.
 11154                                  ;		return indicates invalid index
 11155                                  ;   Registers modified: none.
 11156                                  ;----------------------------------------------------------------------------
 11157                                  
 11158                                  struc TFrame	 ; TableFrame
 11159 00000000 ????                    .OldBP:	 resw 1  ; 0
 11160 00000002 ????                    .OldRet: resw 1  ; 2
 11161 00000004 ??                      .Index:	 resb 1  ; 4
 11162 00000005 ??                      .Pad:	 resb 1  ; 5  
 11163 00000006 ????                    .Tab:	 resw 1  ; 6
 11164 00000008 ????                    .NewRet: resw 1  ; 8
 11165                                  endstruc
 11166                                  
 11167                                  TableDispatch:
 11168 000017F6 55                      	PUSH	BP
 11169 000017F7 89E5                    	MOV	BP,SP
 11170 000017F9 53                      	PUSH	BX			; save BX
 11171                                  	;mov	bx,[bp+6]
 11172 000017FA 8B5E06                  	MOV	BX,[BP+TFrame.Tab]	; get pointer to table
 11173 000017FD 2E8A1F                  	MOV	BL,[CS:BX]		; maximum index
 11174                                  	;cmp	[bp+4],bl
 11175 00001800 385E04                  	CMP	[BP+TFrame.Index],BL	; table error?
 11176 00001803 7317                    	JAE	short TableError	; yes
 11177                                  	;mov	bl,[bp+4]
 11178 00001805 8A5E04                  	MOV	BL,[BP+TFrame.Index]	; get desired table index
 11179 00001808 30FF                    	XOR	BH,BH			; convert to word
 11180 0000180A D1E3                    	SHL	BX,1			; convert to word pointer
 11181 0000180C 43                      	INC	BX			; point past first length byte
 11182                                  	; 17/08/2018
 11183                                  	;add	bx,[bp+6]
 11184 0000180D 035E06                  	ADD	BX,[BP+TFrame.Tab]	; get real offset
 11185 00001810 2E8B1F                  	MOV	BX,[CS:BX]		; get contents of table entry
 11186                                  	;mov	[bp+6],bx
 11187 00001813 895E06                  	MOV	[BP+TFrame.Tab],BX	; put table entry into return address
 11188 00001816 5B                      	POP	BX			; restore BX
 11189 00001817 5D                      	POP	BP			; restore BP
 11190 00001818 83C404                  	ADD	SP,4			; clean off Index and our return addr
 11191 0000181B C3                      	retn				; do operation
 11192                                  TableError:
 11193 0000181C 5B                      	POP	BX			; restore BX
 11194 0000181D 5D                      	POP	BP			; restore BP
 11195 0000181E C20600                  	RETN	6			; clean off Index, Table and RetAddr
 11196                                  
 11197                                  ;Break	<TestNet - determine if a CDS is for the network>
 11198                                  ;----------------------------------------------------------------------------
 11199                                  ;
 11200                                  ;   TestNet - examine CDS pointed to by ThisCDS and see if it indicates a
 11201                                  ;	network CDS. This will handle NULL cds also.
 11202                                  ;
 11203                                  ;   Inputs:	ThisCDS points to CDS or NULL
 11204                                  ;   Outputs:	ES:DI = ThisCDS
 11205                                  ;		carry Set => network
 11206                                  ;		carry Clear => local
 11207                                  ;   Registers modified: none.
 11208                                  ;----------------------------------------------------------------------------
 11209                                  
 11210                                  TestNet:
 11211                                  	;LES	DI,[CS:THISCDS]
 11212                                  
 11213                                  	; 16/05/2019 - Retro DOS v4.0
 11214 00001821 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 11215 00001826 26C43E[A205]            	LES	DI,[ES:THISCDS]
 11216 0000182B 83FFFF                  	CMP	DI,-1
 11217 0000182E 7408                    	JZ	short CMCRet		; UNC? carry is clear
 11218                                  	;;test	word [es:di+43h],8000h
 11219                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
 11220                                  	;test	byte [es:di+44h],80h
 11221 00001830 26F6454480              	TEST	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8)
 11222 00001835 7501                    	JNZ	short CMCRet		; jump has carry clear
 11223 00001837 C3                      	retn				; carry is clear
 11224                                  CMCRet: 
 11225 00001838 F5                      	CMC
 11226 00001839 C3                      	retn
 11227                                  
 11228                                  ;Break	<IsSFTNet - see if an sft is for the network>
 11229                                  ;----------------------------------------------------------------------------
 11230                                  ;
 11231                                  ;   IsSFTNet - examine SF pointed to by ES:DI and see if it indicates a
 11232                                  ;	network file.
 11233                                  ;
 11234                                  ;   Inputs:	ES:DI point to SFT
 11235                                  ;   Outputs:	Zero set if not network sft
 11236                                  ;		zero reset otherwise
 11237                                  ;		Carry CLEAR!!!
 11238                                  ;   Registers modified: none.
 11239                                  ;----------------------------------------------------------------------------
 11240                                  
 11241                                  IsSFTNet:
 11242                                  	;;test	word [es:di+5],8000h
 11243                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 11244                                  	; 16/05/2019 
 11245                                  	;test	byte [es:di+6],80h
 11246 0000183A 26F6450680              	TEST	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 11247 0000183F C3                      	retn
 11248                                  
 11249                                  ;Break	<FastInit - Initialize FastTable entries >
 11250                                  ;----------------------------------------------------------------------------
 11251                                  ;   DOS 4.00   2/9/87
 11252                                  ;   FastInit  - initialize the FASTXXX routine entry
 11253                                  ;		  in the FastTable
 11254                                  ;
 11255                                  ;   Inputs:	BX = FASTXXX ID ( 1=fastopen )
 11256                                  ;		DS:SI = address of FASTXXX routine entry
 11257                                  ;		   SI = -1 for query only
 11258                                  ;   Outputs:	Carry flag clear, if success
 11259                                  ;		Carry flag set,   if failure
 11260                                  ;
 11261                                  ;
 11262                                  ;----------------------------------------------------------------------------
 11263                                  
 11264                                  ;Procedure FastInit,NEAR
 11265                                  ;	ASSUME	CS:DOSCODE,SS:NOTHING
 11266                                  
 11267                                  ;	; MSDOS 3.3
 11268                                  ;	; IBMDOS.COM (1987) - Offset 1EB3h
 11269                                  ;FastInit:
 11270                                  ;	mov	di,FastTable ; FastOpenTable
 11271                                  ;	mov	ax,[cs:di+4]		; Entry segment
 11272                                  ;	mov	bx,cs			; get DOS segment
 11273                                  ;	cmp	ax,bx			; first time installed ?	
 11274                                  ;	je	short ok_install	; yes
 11275                                  ;	stc				; set carry
 11276                                  ;	retn				; (cf=1 means) already installed !
 11277                                  ;
 11278                                  ;ok_install:
 11279                                  ;	mov	bx,FastTable ; FastOpenTable
 11280                                  ;	mov	cx,ds
 11281                                  ;	; set address of FASTXXX (FASTOPEN) routine entry
 11282                                  ;	mov	[cs:bx+4],cx
 11283                                  ;	mov	[cs:bx+2],si
 11284                                  ;	retn
 11285                                  
 11286                                  ; 16/05/2019 - Retro DOS v4.0
 11287                                  
 11288                                  ; 14/01/2024 - Retro DOS v5.0
 11289                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:5773h
 11290                                  
 11291                                  FastInit:
 11292                                  	; MSDOS 6.0
 11293                                  	;hkn; set up es to dosdataseg.
 11294 00001840 06                      	push	es
 11295                                  	;getdseg <es>			; es -> dosdata
 11296 00001841 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 11297                                  
 11298                                  	;hkn; FastTable is in DOSDATA
 11299 00001846 BF[3E11]                	MOV	DI,FastTable+2		;AN000;FO. points to fastxxx entry
 11300 00001849 4B                      	DEC	BX			;AN000;FO.;; decrement index
 11301 0000184A 89DA                    	MOV	DX,BX			;AN000;FO.;; save bx
 11302 0000184C D1E3                    	SHL	BX,1			;AN000;FO.;; times 4, each entry is DWORD
 11303 0000184E D1E3                    	SHL	BX,1			;AN000;FO.
 11304 00001850 01DF                    	ADD	DI,BX			;AN000;FO. index to the entry
 11305 00001852 268B4502                	MOV	AX,[ES:DI+2]		;AN000;FO. get entry segment
 11306                                  fcheck: 				;AN000;
 11307 00001856 8CC9                    	MOV	CX,CS			;AN000;FO.;; get DOS segment
 11308 00001858 39C8                    	CMP	AX,CX			;AN000;FO.;; first time installed ?
 11309 0000185A 7405                    	JZ	short ok_install	;AN000;FO.;; yes
 11310 0000185C 09C0                    	OR	AX,AX			;AN000;FO.;
 11311                                  	;JZ	short ok_install	;AN000;FO.;
 11312                                  	;STC				;AN000;FO.;; already installed !
 11313                                  	;JMP	SHORT FSret		;AN000;FO. set carry
 11314                                  	; 14/01/2024
 11315 0000185E F9                      	stc
 11316 0000185F 7517                    	jnz	short FSret
 11317                                  ok_install:				;AN000;
 11318 00001861 83FEFF                  	CMP	SI,-1			;AN000;FO.; Query only ?
 11319 00001864 7412                    	JZ	short FSret		;AN000;FO.; yes
 11320 00001866 8CD9                    	MOV	CX,DS			;AN000;FO.; get FASTXXX entry segment
 11321 00001868 26894D02                	MOV	[ES:DI+2],CX		;AN000;FO.; initialize routine entry
 11322 0000186C 268935                  	MOV	[ES:DI],SI		;AN000;FO.; initialize routine offset
 11323                                  
 11324                                  ;hkn; FastFlg moved to DOSDATA
 11325 0000186F BF[4611]                	MOV	DI,FastFlg		;AN000;FO.; get addr of FASTXXX flags
 11326 00001872 01D7                    	ADD	DI,DX			;AN000;FO.; index to a FASTXXX flag
 11327                                  	;or	byte [es:di],80h
 11328 00001874 26800D80                	OR	byte [ES:DI],Fast_yes	;AN000;FO.; indicate installed
 11329                                  FSret:					;AN000;
 11330 00001878 07                      	pop	es
 11331 00001879 C3                      	retn				;AN000;FO.
 11332                                  
 11333                                  ;EndProc FastInit
 11334                                  
 11335                                  ;Break	<FastRet - initial routine in FastOpenTable >
 11336                                  ;----------------------------------------------------------------------------
 11337                                  ;   DOS 3.3   6/10/86
 11338                                  ;   FastRet	- indicate FASTXXXX  not in memory
 11339                                  ;
 11340                                  ;   Inputs:	None
 11341                                  ;   Outputs:	AX = -1 and carry flag set
 11342                                  ;
 11343                                  ;   Registers modified: none.
 11344                                  ;----------------------------------------------------------------------------
 11345                                  
 11346                                  FastRet:
 11347                                  	;mov	ax,-1
 11348                                  	;stc
 11349                                  	;retf
 11350 0000187A F9                      	STC
 11351 0000187B 19C0                    	sbb	ax,ax		; (ax) = -1, 'C' set
 11352 0000187D CB                      	RETF
 11353                                  
 11354                                  ;Break	<NLS_OPEN - do $open for NLSFUNC>
 11355                                  ;----------------------------------------------------------------------------
 11356                                  ;   DOS 3.3   6/10/86
 11357                                  ;   NLS_OPEN	- call $OPEN for NLSFUNC
 11358                                  ;
 11359                                  ;   Inputs:	Same input as $OPEN except CL = mode
 11360                                  ;   Outputs:	same output as $OPEN
 11361                                  ;
 11362                                  ;----------------------------------------------------------------------------
 11363                                  
 11364                                  ;hkn; NOTE! SS MUST HAVE BEEN SET UP TO DOSDATA BY THE TIME THESE
 11365                                  ;hkn; NLS FUNCTIONS ARE CALLED!!! THERE FORE WE WILL USE SS OVERRIDES
 11366                                  ;hkn; IN ORDER TO ACCESS DOS DATA VARIABLES!
 11367                                  
 11368                                  NLS_OPEN:
 11369                                  ;	MOV	BL,[CPSWFLAG]	 ; disable code page matching logic
 11370                                  ;	MOV	BYTE [CPSWFLAG],0
 11371                                  ;	PUSH	BX		 ; save current state
 11372                                  
 11373 0000187E 88C8                    	MOV	AL,CL		 ; set up correct interface for $OPEN
 11374 00001880 E87A67                  	call	_$OPEN
 11375                                  
 11376                                  ;	POP	BX		 ; restore current state
 11377                                  ;	MOV	[CPSWFLAG],BL
 11378                                  
 11379 00001883 C3                      	RETN
 11380                                  
 11381                                  ;Break	<NLS_LSEEK - do $LSEEK for NLSFUNC>
 11382                                  ;----------------------------------------------------------------------------
 11383                                  ;   DOS 3.3   6/10/86
 11384                                  ;   NLS_LSEEK	- call $LSEEK for NLSFUNC
 11385                                  ;
 11386                                  ;   Inputs:	BP = open mode
 11387                                  ;   Outputs:	same output as $LSEEK
 11388                                  ;
 11389                                  ;----------------------------------------------------------------------------
 11390                                  
 11391                                  ; 16/05/2019 - Retro DOS v4.0
 11392                                  
 11393                                  NLS_LSEEK:
 11394 00001884 36FF36[8405]            	PUSH	word [SS:USER_SP] ; save user stack
 11395 00001889 36FF36[8605]            	PUSH	word [SS:USER_SS]
 11396 0000188E E81000                  	CALL	Fake_User_Stack
 11397 00001891 89E8                    	MOV	AX,BP		; set up correct interface for $LSEEK
 11398 00001893 E86E60                  	call	_$LSEEK
 11399 00001896 368F06[8605]            	POP	word [SS:USER_SS] ; restore user stack
 11400 0000189B 368F06[8405]            	POP	word [SS:USER_SP]
 11401 000018A0 C3                      	RETN
 11402                                  
 11403                                  ;Break	<Fake_User_Stack - save user stack>
 11404                                  ;----------------------------------------------------------------------------
 11405                                  ;   DOS 3.3   6/10/86
 11406                                  ;   Fake_User_Stack - save user stack pointer
 11407                                  ;
 11408                                  ;----------------------------------------------------------------------------
 11409                                  
 11410                                  Fake_User_Stack:
 11411 000018A1 36A1[9E0D]              	MOV	AX,[SS:USER_SP_2F] ; replace with INT 2Fh stack
 11412 000018A5 36A3[8405]              	MOV	[SS:USER_SP],AX
 11413 000018A9 8CD0                    	MOV	AX,SS
 11414 000018AB 36A3[8605]              	MOV	[SS:USER_SS],AX
 11415 000018AF C3                      	RETN
 11416                                  
 11417                                  ;Break	<GetDevList - get device header list pointer>
 11418                                  ;----------------------------------------------------------------------------
 11419                                  ;   DOS 3.3   7/25/86
 11420                                  ;   GetDevList - get device header list pointer
 11421                                  ;
 11422                                  ;   Output: AX:BX points to the device header list
 11423                                  ;----------------------------------------------------------------------------
 11424                                  
 11425                                  GetDevList:
 11426                                  	; 16/05/2019 - Retro DOS v4.0
 11427 000018B0 BE[580D]                	MOV	SI,SysInitTable
 11428 000018B3 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 11429 000018B8 C534                    	LDS	SI,[SI]
 11430                                  	;mov	ax,[si+34]  ; SSYSINITVARS offset 34 = [SI+SYSI.DEV]
 11431 000018BA 8B4422                  	MOV	AX,[SI+SYSI.DEV]
 11432                                  	;mov	bx,[si+36]  ; SSYSINITVARS offset 36 = [SI+SYSI.DEV+2]
 11433 000018BD 8B5C24                  	MOV	BX,[SI+SYSI.DEV+2]
 11434 000018C0 C3                      	RETN
 11435                                  
 11436                                  ;Break	<NLS_IOCTL - do $IOCTL for NLSFUNC>
 11437                                  ;----------------------------------------------------------------------------
 11438                                  ;   DOS 3.3   7/25/86
 11439                                  ;   NLS_IOCTL	- call $IOCTL for NLSFUNC
 11440                                  ;
 11441                                  ;   Inputs:	BP = function code 0CH
 11442                                  ;   Outputs:	same output as generic $IOCTL
 11443                                  ;
 11444                                  ;----------------------------------------------------------------------------
 11445                                  
 11446                                  NLS_IOCTL:
 11447                                  	; 16/05/2019 - Retro DOS v4.0
 11448 000018C1 36FF36[8405]            	PUSH	word [SS:USER_SP] ; save user stack
 11449 000018C6 36FF36[8605]            	PUSH	word [SS:USER_SS]
 11450 000018CB E8D3FF                  	CALL	Fake_User_Stack
 11451 000018CE 89E8                    	MOV	AX,BP		; set up correct interface for $IOCTL
 11452 000018D0 E8B70F                  	call	_$IOCTL
 11453 000018D3 368F06[8605]            	POP	word [SS:USER_SS] ; restore user stack
 11454 000018D8 368F06[8405]            	POP	word [SS:USER_SP]
 11455 000018DD C3                      	RETN
 11456                                  
 11457                                  ;Break	<NLS_GETEXT- get extended error for NLSFUNC>
 11458                                  ;----------------------------------------------------------------------------
 11459                                  ;   DOS 3.3   7/25/86
 11460                                  ;   NLS_GETEXT	-
 11461                                  ;
 11462                                  ;   Inputs:	none
 11463                                  ;   Outputs:	AX = extended error
 11464                                  ;
 11465                                  ;----------------------------------------------------------------------------
 11466                                  
 11467                                  NLS_GETEXT:
 11468                                  	; 16/05/2019 - Retro DOS v4.0
 11469 000018DE 36A1[2403]              	MOV	AX,[SS:EXTERR]	 ; return extended error
 11470                                  	; 23/09/2023
 11471                                  MSG_RETRIEVAL:
 11472 000018E2 C3                      	RETN
 11473                                  
 11474                                  ; 29/04/2019 - Retro DOS v4.0
 11475                                  
 11476                                  ;Break	<MSG_RETRIEVAL- get beginning addr of system and parser messages>
 11477                                  
 11478                                  ;----------------------------------------------------------------------------
 11479                                  ;   DOS 4.00
 11480                                  ;
 11481                                  ;   Inputs:	DL=0 get extended error message addr
 11482                                  ;		  =1 set extended error message addr
 11483                                  ;		  =2 get parser error message addr
 11484                                  ;		  =3 set parser error message addr
 11485                                  ;		  =4 get critical error message addr
 11486                                  ;		  =5 set critical error message addr
 11487                                  ;		  =6 get file system error message addr
 11488                                  ;		  =7 set file system error message addr
 11489                                  ;		  =8 get address for code reduction
 11490                                  ;		  =9 set address for code reduction
 11491                                  ;   Function:	get/set message address
 11492                                  ;   Outputs:	ES:DI points to addr when get
 11493                                  ;----------------------------------------------------------------------------
 11494                                  
 11495                                  ;Procedure MSG_RETRIEVAL,NEAR
 11496                                  ;	ASSUME	CS:DOSCODE,SS:NOTHING
 11497                                  
 11498                                  ; 23/09/2023
 11499                                  ;MSG_RETRIEVAL:
 11500                                  
 11501                                  ;;	NOTE:  This function lives in command.com resident code now.
 11502                                  ;;	If the int 2F ever gets this far, we'll return registers
 11503                                  ;;	unchanged, which produces the same result as before, if
 11504                                  ;;	command.com wasn't present (and therefore no messages available).
 11505                                  ;;
 11506                                  ;;	I didn't point the entry in the 2F table to No_Op because
 11507                                  ;;	No_Op zeroes AL.
 11508                                  ;;
 11509                                  ;;;hkn; set up ds to point to DOSDATA
 11510                                  ;;	push	ds
 11511                                  ;;	getdseg	<ds>			; ds -> dosdata
 11512                                  ;;
 11513                                  ;;	PUSH	AX		    ;AN000;;MS. save regs
 11514                                  ;;	PUSH	SI		    ;AN000;;MS. save regs
 11515                                  ;;	MOV	AX,DX		    ;AN000;;MS.
 11516                                  ;;	MOV	SI,OFFSET DOSDATA:MSG_EXTERROR ;AN000;;MS.
 11517                                  ;;	test	AL,1		    ;AN000;;MS. get ?
 11518                                  ;;	JZ	toget		    ;AN000;;MS. yes
 11519                                  ;;	DEC	AL		    ;AN000;;MS.
 11520                                  ;;toget:				    ;AN000;
 11521                                  ;;	SHL	AL,1		    ;AN000;;MS. times 2
 11522                                  ;;	XOR	AH,AH		    ;AN000;;MS.
 11523                                  ;;	ADD	SI,AX		    ;AN000;;MS. position to the entry
 11524                                  ;;	test	DL,1		    ;AN000;;MS. get ?
 11525                                  ;;	JZ	getget			     ;AN000;;MS. yes
 11526                                  ;;	MOV	WORD PTR DS:[SI],DI    ;AN000;;MS. set MSG
 11527                                  ;;	MOV	WORD PTR DS:[SI+2],ES  ;AN000;;MS. address to ES:DI
 11528                                  ;;	JMP	SHORT MSGret		     ;AN000;;MS. exit
 11529                                  ;;getget: 				     ;AN000;
 11530                                  ;;	LES	DI,DWORD PTR DS:[SI]	     ;AN000;;MS. get msg addr
 11531                                  ;;MSGret: 				     ;AN000;
 11532                                  ;;	POP	SI			     ;AN000;;MS.
 11533                                  ;;	POP	AX			     ;AN000;;MS.
 11534                                  ;;
 11535                                  ;;	pop	ds
 11536                                  
 11537                                  ;	return				     ;AN000;;MS. exit
 11538                                  
 11539                                  ; 23/09/2023
 11540                                  ;	retn	; 29/04/2019
 11541                                  
 11542                                  ;============================================================================
 11543                                  ; ECritDisk, LCritDisk, ECritDevice, LCritDevice
 11544                                  ; IBMDOS.COM (MSDOS 3.3), 1987 - Offset 1F36h
 11545                                  ;============================================================================
 11546                                  ; 20/07/2018 - Retro DOS v3.0
 11547                                  
 11548                                  ;	; MSDOS 3.3
 11549                                  ;	; 08/08/2018 - Retro DOS v3.0
 11550                                  ;ECritMEM:
 11551                                  ;ECritSFT:
 11552                                  ;	;
 11553                                  ;ECritDisk:
 11554                                  ;	retn
 11555                                  ;	;push	ax
 11556                                  ;	
 11557                                  ;	mov	ax,8001h
 11558                                  ;	int	2Ah	; Microsoft Networks - BEGIN DOS CRITICAL SECTION
 11559                                  ;			; AL = critical section number (00h-0Fh)
 11560                                  ;	pop	ax
 11561                                  ;	retn
 11562                                  ;
 11563                                  ;	; MSDOS 3.3
 11564                                  ;	; 08/08/2018 - Retro DOS v3.0
 11565                                  ;LCritMEM:
 11566                                  ;LCritSFT:
 11567                                  ;	;
 11568                                  ;LCritDisk:
 11569                                  ;	retn
 11570                                  ;	;push	ax
 11571                                  ;	
 11572                                  ;	mov	ax,8101h
 11573                                  ;	int	2Ah	; Microsoft Networks - END DOS CRITICAL SECTION
 11574                                  ;			; AL = critical section number (00h-0Fh)
 11575                                  ;	pop	ax
 11576                                  ;	retn
 11577                                  ;
 11578                                  ;ECritDevice:
 11579                                  ;	retn
 11580                                  ;	;push	ax
 11581                                  ;	
 11582                                  ;	mov	ax,8002h
 11583                                  ;	int	2Ah	; Microsoft Networks - BEGIN DOS CRITICAL SECTION
 11584                                  ;			; AL = critical section number (00h-0Fh)
 11585                                  ;	pop	ax
 11586                                  ;	retn
 11587                                  ;
 11588                                  ;LCritDevice:
 11589                                  ;	retn
 11590                                  ;	;push	ax
 11591                                  ;	
 11592                                  ;	mov	ax,8102h
 11593                                  ;	int	2Ah	; Microsoft Networks - END DOS CRITICAL SECTION
 11594                                  ;			; AL = critical section number (00h-0Fh)
 11595                                  ;	pop	ax
 11596                                  ;	retn
 11597                                  
 11598                                  ;============================================================================
 11599                                  ; CRIT.ASM, MSDOS 6.0, 1991
 11600                                  ;============================================================================
 11601                                  ; 12/05/2019 - Retro DOS v4.0
 11602                                  
 11603                                  ; Critical Section Routines
 11604                                  
 11605                                  ; MSDOS 6.21 - MSDOS.SYS - DOSCODE:513Ah
 11606                                  
 11607                                  ; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 11608                                  ; DOSCODE:5126h (MSDOS 5.0 MSDOS.SYS)
 11609                                  
 11610                                  ; ---------------------------------------------------------------------------
 11611                                  ; Each handler must leave everything untouched; including flags!
 11612                                  ;
 11613                                  ; Sleaze for time savings: first instruction is a return. This is patched
 11614                                  ; by the sharer to be a PUSH AX to complete the correct routines.
 11615                                  ; ---------------------------------------------------------------------------
 11616                                  
 11617                                  ; (DOSMAC.INC, MSDOS 6.0, 1991)
 11618                                  ; ---------------------------------------------------------------------------
 11619                                  ; Some old versions of the 80286 have a bug in the chip. The popf instruction
 11620                                  ; will enable interrupts. Therefore in a section of code with interrupts
 11621                                  ; disabled and you need a popf instruction use the 'popff' macro instead.
 11622                                  ; ---------------------------------------------------------------------------
 11623                                  
 11624                                  ;%macro POPFF 0
 11625                                  ;	jmp	$+3
 11626                                  ;	iret
 11627                                  ;	push	cs
 11628                                  ;	call	$-2
 11629                                  ;%endmacro
 11630                                  
 11631                                  ; ---------------------------
 11632                                  
 11633                                  ; 14/01/2024 - Retro DOS v5.0
 11634                                  %if 0
 11635                                  
 11636                                  ;Procedure  ECritDisk,NEAR
 11637                                  	;public  ECritMEM
 11638                                  	;public  ECritSFT
 11639                                  ECritMEM:
 11640                                  ECritSFT:
 11641                                  ;
 11642                                  ECritDisk:
 11643                                  
 11644                                  ;SR; Check if critical section is to be entered
 11645                                  
 11646                                  	pushf
 11647                                  	cmp	byte [ss:redir_patch],0
 11648                                  	jz	short ECritDisk_2
 11649                                  
 11650                                  ; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 11651                                  ;	;popff  ; * (macro)
 11652                                  ;	jmp	short ECritDisk_1 ; *
 11653                                  ;
 11654                                  ;ECritDisk_iret: ; *
 11655                                  ;	iret ; *
 11656                                  
 11657                                  	; 16/12/2022
 11658                                  	; 13/11/2022
 11659                                  	;jmp	short ECritDisk_1
 11660                                  	; 06/11/2022
 11661                                  ;ECritDisk_iret:
 11662                                  ;	iret	
 11663                                  
 11664                                  	; 06/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 11665                                  ECritDisk_1:
 11666                                  	push	cs ; *
 11667                                  	call	ECritDisk_iret ; *		
 11668                                  	
 11669                                  ECritDisk_0:
 11670                                  	PUSH    AX
 11671                                  	;MOV	AX,8000h+critDisk
 11672                                  	;INT	int_IBM
 11673                                  	mov	ax,8001h
 11674                                  	int	2Ah	; Microsoft Networks - BEGIN DOS CRITICAL SECTION
 11675                                  			; AL = critical section number (00h-0Fh)
 11676                                  	POP     AX
 11677                                  	retn
 11678                                  
 11679                                  	; 16/12/2022
 11680                                  	; 13/11/2022
 11681                                  ECritDisk_iret:  ; 12/05/2019 - Retro DOS v4.0
 11682                                  LCritDisk_iret: 
 11683                                  	iret
 11684                                  
 11685                                  ECritDisk_2:
 11686                                  	;;popff ; *
 11687                                  	;;retn
 11688                                  ;	jmp	short ECritDisk_3 ; *
 11689                                  ;ECritDisk_iret2: ; *
 11690                                  ;	iret
 11691                                  	
 11692                                  	; 16/12/2022
 11693                                  	; 13/11/2022
 11694                                  	;jmp	short ECritDisk_3
 11695                                  ;ECritDisk_iret2:
 11696                                  	;iret
 11697                                  
 11698                                  ECritDisk_3:
 11699                                  	push    cs ; *
 11700                                  	; 13/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 11701                                  	;call	ECritDisk_iret2 ; *
 11702                                  	;retn
 11703                                  	; 16/12/2022
 11704                                  	call	ECritDisk_iret
 11705                                  	retn
 11706                                  
 11707                                  ;EndProc ECritDisk
 11708                                  
 11709                                  ; ---------------------------
 11710                                  
 11711                                  ;Procedure   LCritDisk,NEAR
 11712                                  	;public  LCritMEM
 11713                                  	;public  LCritSFT
 11714                                  LCritMEM:
 11715                                  LCritSFT:
 11716                                  ;
 11717                                  LCritDisk:
 11718                                  
 11719                                  ;SR; Check if critical section is to be entered
 11720                                  
 11721                                  	pushf
 11722                                  	cmp	byte [ss:redir_patch],0
 11723                                  	jz	short LCritDisk_2
 11724                                  	;popff  ; * (macro)
 11725                                  ;	jmp	short LCritDisk_1 ; *
 11726                                  ;
 11727                                  ;LCritDisk_iret: ; *
 11728                                  ;	iret ; *
 11729                                  
 11730                                  	; 16/12/2022
 11731                                  	; 13/11/2022
 11732                                  	;jmp	short LCritDisk_1
 11733                                  ;LCritDisk_iret:
 11734                                  	;iret
 11735                                  
 11736                                  LCritDisk_1:
 11737                                  	push	cs ; *
 11738                                  	call	LCritDisk_iret ; *		
 11739                                  	
 11740                                  LCritDisk_0:
 11741                                  	PUSH	AX
 11742                                  	;MOV	AX,8100h+critDisk
 11743                                  	;INT	int_IBM
 11744                                  	mov	ax,8101h
 11745                                  	int	2Ah	; Microsoft Networks - END DOS CRITICAL SECTION
 11746                                  			; AL = critical section number (00h-0Fh)
 11747                                  	POP	AX
 11748                                  	retn
 11749                                  
 11750                                  ;LCritDisk_iret:  ; 12/05/2019 - Retro DOS v4.0 
 11751                                  ;	iret
 11752                                  
 11753                                  LCritDisk_2:
 11754                                  	;;popff ; *
 11755                                  	;;retn
 11756                                  ;	jmp	short LCritDisk_3 ; *
 11757                                  ;LCritDisk_iret2: ; *
 11758                                  ;	iret
 11759                                  
 11760                                  	; 16/12/2022
 11761                                  	; 13/11/2022
 11762                                  	;jmp	short LCritDisk_3
 11763                                  ;LCritDisk_iret2:
 11764                                  	;iret
 11765                                  
 11766                                  LCritDisk_3:
 11767                                  	push    cs ; *
 11768                                  	; 13/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 11769                                  	;call	LCritDisk_iret2 ; *
 11770                                  	;retn
 11771                                  	; 16/12/2022
 11772                                  	call	LCritDisk_iret
 11773                                  	retn
 11774                                  
 11775                                  ;EndProc LCritDisk
 11776                                  
 11777                                  ; ---------------------------
 11778                                  
 11779                                  ;Procedure   ECritDevice,NEAR
 11780                                  
 11781                                  ECritDevice:
 11782                                  
 11783                                  ;SR; Check if critical section is to be entered
 11784                                  
 11785                                  	pushf
 11786                                  	cmp	byte [ss:redir_patch],0
 11787                                  	jz	short ECritDevice_2
 11788                                  	;popff  ; * (macro)
 11789                                  ;	jmp	short ECritDevice_1 ; *
 11790                                  ;
 11791                                  ;ECritDevice_iret: ; *
 11792                                  ;	iret ; *
 11793                                  
 11794                                  	; 16/12/2022	
 11795                                  	; 13/11/2022
 11796                                  	;jmp	short ECritDevice_1
 11797                                  ;ECritDevice_iret:
 11798                                  	;iret
 11799                                  
 11800                                  ECritDevice_1:
 11801                                  	push	cs ; *
 11802                                  	call	ECritDevice_iret ; *		
 11803                                  	
 11804                                  ECritDevice_0:
 11805                                  	PUSH	AX
 11806                                  	;MOV	AX,8000h+critDevice
 11807                                  	;INT	int_IBM
 11808                                  	mov	ax,8002h
 11809                                  	int	2Ah	; Microsoft Networks - BEGIN DOS CRITICAL SECTION
 11810                                  			; AL = critical section number (00h-0Fh)
 11811                                  	POP     AX
 11812                                  	retn
 11813                                  
 11814                                  	; 16/12/2022
 11815                                  	; 06/12/2022
 11816                                  ECritDevice_iret:  ; 12/05/2019 - Retro DOS v4.0
 11817                                  LCritDevice_iret: 
 11818                                  	iret
 11819                                  
 11820                                  ECritDevice_2:
 11821                                  	;;popff ; *
 11822                                  	;;retn
 11823                                  ;	jmp	short ECritDevice_3 ; *
 11824                                  ;ECritDevice_iret2: ; *
 11825                                  ;	iret
 11826                                  
 11827                                  	; 16/12/2022
 11828                                  	; 13/11/2022
 11829                                  	;jmp	short ECritDevice_3
 11830                                  ;ECritDevice_iret2:
 11831                                  	;iret
 11832                                  
 11833                                  ECritDevice_3:
 11834                                  	push    cs ; *
 11835                                  	; 13/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 11836                                  	;call	ECritDevice_iret2 ; *
 11837                                  	;retn
 11838                                  	; 16/12/2022
 11839                                  	call	ECritDevice_iret
 11840                                  	retn
 11841                                  
 11842                                  ;EndProc ECritDevice
 11843                                  
 11844                                  ; ---------------------------
 11845                                  
 11846                                  ;Procedure   LCritDevice,NEAR
 11847                                  
 11848                                  LCritDevice:
 11849                                  
 11850                                  ;SR; Check if critical section is to be entered
 11851                                  
 11852                                  	pushf
 11853                                  	cmp	byte [ss:redir_patch],0
 11854                                  	jz	short LCritDevice_2
 11855                                  	;popff  ; * (macro)
 11856                                  ;	jmp	short LCritDevice_1 ; *
 11857                                  ;
 11858                                  ;LCritDevice_iret: ; *
 11859                                  ;	iret ; *
 11860                                  
 11861                                  	; 16/12/2022
 11862                                  	; 13/11/2022
 11863                                  	;jmp	short LCritDevice_1
 11864                                  ;LCritDevice_iret:
 11865                                  	;iret
 11866                                  
 11867                                  LCritDevice_1:
 11868                                  	push	cs ; *
 11869                                  	call	LCritDevice_iret ; *		
 11870                                  	
 11871                                  LCritDevice_0:
 11872                                  	PUSH	AX
 11873                                  	;MOV	AX,8100h+critDevice
 11874                                  	;INT	int_IBM
 11875                                  	mov	ax,8102h
 11876                                  	int	2Ah	; Microsoft Networks - END DOS CRITICAL SECTION
 11877                                  			; AL = critical section number (00h-0Fh)
 11878                                  	POP     AX
 11879                                  	retn
 11880                                  
 11881                                  ;LCritDevice_iret:  ; 12/05/2019 - Retro DOS v4.0 
 11882                                  ;	iret
 11883                                  
 11884                                  LCritDevice_2:
 11885                                  	;;popff ; *
 11886                                  	;;retn
 11887                                  ;	jmp	short LCritDevice_3 ; *
 11888                                  ;LCritDevice_iret2: ; *
 11889                                  ;	iret
 11890                                  
 11891                                  	; 16/12/2022
 11892                                  	; 13/11/2022
 11893                                  	;jmp	short LCritDevice_3
 11894                                  ;LCritDevice_iret2:
 11895                                  	;iret
 11896                                  
 11897                                  LCritDevice_3:
 11898                                  	push    cs ; *
 11899                                  	; 13/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 11900                                  	;call	LCritDevice_iret2 ; *
 11901                                  	;retn
 11902                                  	; 16/12/2022
 11903                                  	call	LCritDevice_iret
 11904                                  	retn
 11905                                  
 11906                                  ;EndProc LCritDevice
 11907                                  
 11908                                  %endif
 11909                                  
 11910                                  	; 15/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1)
 11911                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:580Dh
 11912                                  
 11913                                  ; 15/01/2024 - Retro DOS v5.0
 11914                                  %if 1
 11915                                  	;;;
 11916                                  ; ---------------------------------------------------------------------------
 11917                                  ECritMEM:
 11918                                  ECritSFT:
 11919                                  ; ---------------------------------------------------------------------------
 11920                                  	; PCDOS 7.1 IBMDOS.COM
 11921                                  ECritDisk:
 11922 000018E3 51                      	push	cx
 11923 000018E4 B500                    	mov	ch,0
 11924 000018E6 368A0E[650D]            	mov	cl,[ss:redir_patch]
 11925 000018EB E321                    	jcxz	ECritDisk_3
 11926 000018ED 59                      	pop	cx
 11927 000018EE 50                      	push	ax
 11928 000018EF B80180                  	mov	ax,8001h	; BEGIN DOS CRITICAL SECTION
 11929                                  				; AL = critical section number (01h)
 11930                                  ECritDisk_1:
 11931                                  ; ----------------------------------------
 11932                                  LCritDisk_1:
 11933                                  ECritDevice_1:
 11934                                  LCritDevice_1:
 11935 000018F2 51                      	push	cx
 11936 000018F3 B500                    	mov	ch,0
 11937 000018F5 368A0E[5B0F]            	mov	cl,[ss:IsWin386]
 11938 000018FA E305                    	jcxz	ECritDisk2
 11939 000018FC 59                      	pop	cx
 11940 000018FD CD2A                    	int	2Ah		; Microsoft Networks - BEGIN DOS CRITICAL SECTION
 11941                                  				; AL = critical section number (00h-0Fh)
 11942 000018FF 58                      	pop	ax
 11943 00001900 C3                      	retn
 11944                                  
 11945                                  ECritDisk2:
 11946 00001901 06                      	push	es
 11947                                  	;mov	cx,0
 11948                                  	; 15/01/2024
 11949                                  	; cx = 0
 11950 00001902 8EC1                    	mov	es,cx
 11951 00001904 9C                      	pushf			; simulate INT 2Ah
 11952 00001905 26FF1EA800              	call	far [es:00A8h]	; call far (INT 2Ah vector)
 11953 0000190A 07                      	pop	es
 11954 0000190B 59                      	pop	cx
 11955 0000190C 58                      	pop	ax
 11956 0000190D C3                      	retn
 11957                                  
 11958                                  ECritDisk_3:
 11959                                  ; ----------------------------------------
 11960                                  LCritDisk_3:
 11961                                  ECritDevice_3:
 11962                                  LCritDevice_3:
 11963 0000190E 59                      	pop	cx
 11964 0000190F C3                      	retn
 11965                                  
 11966                                  ; ---------------------------------------------------------------------------
 11967                                  LCritMEM:
 11968                                  LCritSFT:
 11969                                  ; ---------------------------------------------------------------------------
 11970                                  	; PCDOS 7.1 IBMDOS.COM
 11971                                  LCritDisk:
 11972 00001910 51                      	push	cx
 11973 00001911 B500                    	mov	ch,0
 11974 00001913 368A0E[650D]            	mov	cl,[ss:redir_patch]
 11975 00001918 E3F4                    	jcxz	LCritDisk_3
 11976 0000191A 59                      	pop	cx
 11977 0000191B 50                      	push	ax
 11978 0000191C B80181                  	mov	ax,8101h	; END DOS CRITICAL SECTION
 11979                                  				; AL = critical section number (01h)
 11980 0000191F EBD1                    	jmp	short LCritDisk_1
 11981                                  
 11982                                  ; ---------------------------------------------------------------------------
 11983                                  
 11984                                  ECritDevice:
 11985 00001921 51                      	push	cx
 11986 00001922 B500                    	mov	ch,0
 11987 00001924 368A0E[650D]            	mov	cl,[ss:redir_patch]
 11988 00001929 E3E3                    	jcxz	ECritDevice_3
 11989 0000192B 59                      	pop	cx
 11990 0000192C 50                      	push	ax
 11991 0000192D B80280                  	mov	ax,8002h	; BEGIN DOS CRITICAL SECTION
 11992                                  				; AL = critical section number (02h)
 11993 00001930 EBC0                    	jmp	short ECritDevice_1
 11994                                  
 11995                                  ; ---------------------------------------------------------------------------
 11996                                  
 11997                                  LCritDevice:
 11998 00001932 51                      	push	cx
 11999 00001933 B500                    	mov	ch,0
 12000 00001935 368A0E[650D]            	mov	cl,[ss:redir_patch]
 12001 0000193A E3D2                    	jcxz	LCritDevice_3
 12002 0000193C 59                      	pop	cx
 12003 0000193D 50                      	push	ax
 12004 0000193E B80281                  	mov	ax,8102h	; END DOS CRITICAL SECTION
 12005                                  				; AL = critical section number (02h)
 12006 00001941 EBAF                    	jmp	short LCritDevice_1
 12007                                  
 12008                                  ; ---------------------------------------------------------------------------
 12009                                  	;;;
 12010                                  %endif
 12011                                  
 12012                                  ;============================================================================
 12013                                  ; CPMIO.ASM, MSDOS 6.0, 1991
 12014                                  ;============================================================================
 12015                                  ; 20/07/2018 - Retro DOS v3.0
 12016                                  
 12017                                  ;============================================================================
 12018                                  ; STDIO.ASM - (MSDOS 2.0)
 12019                                  ;============================================================================
 12020                                  
 12021                                  ;
 12022                                  ; Standard device IO for MSDOS (first 12 function calls)
 12023                                  ;
 12024                                  
 12025                                  ;.xlist
 12026                                  ;.xcref
 12027                                  ;INCLUDE STDSW.ASM
 12028                                  ;INCLUDE DOSSEG.ASM
 12029                                  ;.cref
 12030                                  ;.list
 12031                                  
 12032                                  ;TITLE   STDIO - device IO for MSDOS
 12033                                  ;NAME    STDIO
 12034                                  
 12035                                  ;INCLUDE IO.ASM
 12036                                  
 12037                                  ; ---------------------------------------------------------------------------
 12038                                  ;
 12039                                  ; NOTE for Retro DOS v2.0 :  (ERDOGAN TAN - 13/03/2018)
 12040                                  ;	  I0.ASM is missing in MSDOS 2.0 kernel source code files !!!
 12041                                  ;	  INSTEAD of IO.ASM, I have disassembled IBMDOS.COM (MSDOS 2.0)
 12042                                  ;			    and I have used CPMIO.ASM (MSDOS 6.0 source code)
 12043                                  ;			    to restore MSDOS 2.0 device IO source code 
 12044                                  ;
 12045                                  ;		(STRIN.ASM has '$STD_CON_STRING_INPUT' code.)	
 12046                                  	
 12047                                  ;============================================================================
 12048                                  ; STDIO.ASM - (MSDOS 2.0)
 12049                                  ;============================================================================
 12050                                  
 12051                                  ;
 12052                                  ; Standard device IO for MSDOS (first 12 function calls)
 12053                                  ;
 12054                                  
 12055                                  ;.xlist
 12056                                  ;.xcref
 12057                                  ;INCLUDE STDSW.ASM
 12058                                  ;INCLUDE DOSSEG.ASM
 12059                                  ;.cref
 12060                                  ;.list
 12061                                  
 12062                                  ;TITLE   STDIO - device IO for MSDOS
 12063                                  ;NAME    STDIO
 12064                                  
 12065                                  ;INCLUDE IO.ASM
 12066                                  
 12067                                  ; ---------------------------------------------------------------------------
 12068                                  ;
 12069                                  ; NOTE for Retro DOS v2.0 :  (ERDOGAN TAN - 13/03/2018)
 12070                                  ;	  I0.ASM is missing in MSDOS 2.0 kernel source code files !!!
 12071                                  ;	  INSTEAD of IO.ASM, I have disassembled IBMDOS.COM (MSDOS 2.0)
 12072                                  ;			    and I have used CPMIO.ASM (MSDOS 6.0 source code)
 12073                                  ;			    to restore MSDOS 2.0 device IO source code 
 12074                                  ;
 12075                                  ;		(STRIN.ASM has '$STD_CON_STRING_INPUT' code.)		
 12076                                  ;
 12077                                  ;============================================================================
 12078                                  ; IO.ASM (MSDOS 2.0) (IBMDOS.COM 2.0) - STRIN.ASM (MSDOS 2.0, 19/08/1983)
 12079                                  ;============================================================================
 12080                                  ; Retro DOS v2.0 by Erdogan Tan, 13/03/2018 - 14/03/2018
 12081                                  
 12082                                  ; (Disassembled code of IBMDOS.COM, 08/03/1983) - Dissassembler: IDA Pro Free
 12083                                  ; (Comments are from CPMIO.ASM - 1991, MSDOS 6.0) 
 12084                                  
 12085                                  ;============================================================================
 12086                                  ; CPMIO.ASM (MSDOS 6.0, 1991)
 12087                                  ;============================================================================
 12088                                  ; Retro DOS v4.0 by Erdogan Tan, 04/05/2019
 12089                                  
 12090                                  	; 08/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 12091                                  
 12092                                  ;**	Standard device IO for MSDOS (first 12 function calls)
 12093                                  ;
 12094                                  ;	TITLE	IBMCPMIO - device IO for MSDOS
 12095                                  ;	NAME	IBMCPMIO
 12096                                  
 12097                                  ;	Old style CP/M 1-12 system calls to talk to reserved devices
 12098                                  ;
 12099                                  ;	$Std_Con_Input_No_Echo
 12100                                  ;	$Std_Con_String_Output
 12101                                  ;	$Std_Con_String_Input
 12102                                  ;	$RawConIO
 12103                                  ;	$RawConInput
 12104                                  ;	RAWOUT
 12105                                  ;	RAWOUT2
 12106                                  ;
 12107                                  
 12108                                  ; The following routines form the console I/O group (funcs 1,2,6,7,8,9,10,11).
 12109                                  ; They assume ES and DS NOTHING, while not strictly correct, this forces data
 12110                                  ; references to be SS or CS relative which is desired.
 12111                                  
 12112                                  ; ---------------------------------------------------------------------------
 12113                                  
 12114                                  ;	TITLE	CPMIO2 - device IO for MSDOS
 12115                                  ;	NAME	CPMIO2
 12116                                  
 12117                                  ;
 12118                                  ;	Microsoft Confidential
 12119                                  ;	Copyright (C) Microsoft Corporation 1991
 12120                                  ;	All Rights Reserved.
 12121                                  ;
 12122                                  
 12123                                  ;**	Old style CP/M 1-12 system calls to talk to reserved devices
 12124                                  ;
 12125                                  ;	$Std_Con_Input
 12126                                  ;	$Std_Con_Output
 12127                                  ;	OUTT
 12128                                  ;	TAB
 12129                                  ;	BUFOUT
 12130                                  ;	$Std_Aux_Input
 12131                                  ;	$Std_Aux_Output
 12132                                  ;	$Std_Printer_Output
 12133                                  ;	$Std_Con_Input_Status
 12134                                  ;	$Std_Con_Input_Flush
 12135                                  ;
 12136                                  ;	Revision History:
 12137                                  ;
 12138                                  ;	  AN000	 version 4.00 - Jan. 1988
 12139                                  
 12140                                  ; The following routines form the console I/O group (funcs 1,2,6,7,8,9,10,11).
 12141                                  ; They assume ES and DS NOTHING, while not strictly correct, this forces data
 12142                                  ; references to be SS or CS relative which is desired.
 12143                                  
 12144                                  ;DOSCODE SEGMENT
 12145                                  ;	ASSUME	SS:DOSDATA,CS:DOSCODE
 12146                                  
 12147                                  
 12148                                  ;hkn; 	All the variables use SS override or DS. Therefore there is
 12149                                  ;hkn;	no need to specifically set up any seg regs unless SS assumption is
 12150                                  ;hkn;	not valid. 
 12151                                  
 12152                                  ; DOSCODE:51BAh (MSDOS 6.21, MSDOS.SYS)
 12153                                  ; 08/11/2022
 12154                                  ; DOSCODE:51A6h (MSDOS 5.0, MSDOS.SYS)
 12155                                  
 12156                                  ;
 12157                                  ;----------------------------------------------------------------------------
 12158                                  ;
 12159                                  ; Procedure : $Std_Con_Input_No_Echo
 12160                                  ;
 12161                                  ;----------------------------------------------------------------------------
 12162                                  ;
 12163                                  
 12164                                  _$STD_CON_INPUT_NO_ECHO:   ;System call 8
 12165                                  
 12166                                  ; Inputs:
 12167                                  ;	None
 12168                                  ; Function:
 12169                                  ;	Input character from console, no echo
 12170                                  ; Returns:
 12171                                  ;	AL = character
 12172                                  
 12173 00001943 1E                      	push	ds
 12174 00001944 56                      	push	si
 12175                                  INTEST:
 12176 00001945 E89745                  	call	STATCHK
 12177 00001948 753B                    	jnz	short GET ; 08/09/2018
 12178                                  ;*************************************************************************
 12179                                  ;hkn; SS override
 12180 0000194A 36803E[A00A]00          	cmp	byte [SS:PRINTER_FLAG],0  ; is printer idle?
 12181 00001950 7505                    	jnz	short no_sys_wait
 12182 00001952 B405                    	mov	ah,5			; get input status with system wait
 12183 00001954 E89137                  	call	IOFUNC
 12184                                  no_sys_wait:
 12185                                  ;**************************************************************************
 12186 00001957 B484                    	MOV	AH,84h		; (Microsoft Networks - KEYBOARD BUSY LOOP)
 12187 00001959 CD2A                    	INT	int_IBM	 ; int 2Ah
 12188                                  
 12189                                  ;;; 7/15/86  update the date in the idle loop
 12190                                  ;;; Dec 19, 1986 D.C.L. changed following CMP to Byte Ptr from Word Ptr
 12191                                  ;;;;		 to shorten loop in consideration of the PC Convertible
 12192                                  
 12193                                  ;hkn; SS override
 12194 0000195B 36803E[BD0D]FF          	CMP	byte [SS:DATE_FLAG],-1	; date is updated may be every
 12195 00001961 751B                    	JNZ	short NoUpdate		; 65535 x ? ms if no one calls
 12196                                  
 12197 00001963 50                      	PUSH	AX
 12198 00001964 53                      	PUSH	BX			; following is tricky,
 12199 00001965 51                      	PUSH	CX			; it may be called by critical handler
 12200 00001966 52                      	PUSH	DX			; at that time, DEVCALL is used by
 12201                                  					; other's READ or WRITE
 12202 00001967 1E                      	PUSH	DS			; save DS = SFT's segment
 12203                                  
 12204                                  ;hkn; READTIME must use ds = DOSDATA
 12205                                  ;hkn;	PUSH	CS			; READTIME must use DS=CS
 12206                                  
 12207 00001968 16                      	PUSH	SS ; 04/05/2019
 12208 00001969 1F                      	POP	DS
 12209                                  
 12210 0000196A B80000                  	MOV	AX,0			; therefore, we save DEVCALL
 12211 0000196D E89402                  	CALL	Save_Restore_Packet	; save DEVCALL packet
 12212                                  	;invoke	READTIME		; readtime
 12213 00001970 E813F2                  	call	READTIME
 12214 00001973 B80100                  	MOV	AX,1
 12215 00001976 E88B02                  	CALL	Save_Restore_Packet	; restore DEVCALL packet
 12216                                  
 12217                                  ;	; MSDOS 3.3 (IBMDOS.COM, Offset 1F8Ch)
 12218                                  ;	; (MSDOS 6.0 code does not contain IBM DOS FETCHI_TAG check)
 12219                                  ;	push	bx
 12220                                  ;	mov	bx,DATE_FLAG
 12221                                  ;	add	bx,2  ; mov bx,FETCHI_FLAG
 12222                                  ;	cmp	word [cs:bx],5872h
 12223                                  ;	jz	short FETCHI_TAG_chk_ok
 12224                                  ;	call	DOSINIT
 12225                                  ;FETCHI_TAG_chk_ok:
 12226                                  ;	pop	bx
 12227                                  
 12228 00001979 1F                      	POP	DS			; restore DS
 12229 0000197A 5A                      	POP	DX
 12230 0000197B 59                      	POP	CX
 12231 0000197C 5B                      	POP	BX
 12232 0000197D 58                      	POP	AX
 12233                                  NoUpdate:
 12234                                  
 12235                                  ;hkn; SS override
 12236 0000197E 36FF06[BD0D]            	INC	word [SS:DATE_FLAG]
 12237                                  
 12238                                  ;;; 7/15/86 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 12239 00001983 EBC0                    	JMP	short INTEST
 12240                                  GET:
 12241 00001985 30E4                    	XOR	AH,AH
 12242 00001987 E85E37                  	call	IOFUNC
 12243 0000198A 5E                      	POP	SI
 12244 0000198B 1F                      	POP	DS
 12245                                  ;;; 7/15/86
 12246                                  
 12247                                  ;hkn; SS override
 12248                                  	; MSDOS 6.0
 12249 0000198C 36C606[BC0D]00          	MOV	BYTE [SS:SCAN_FLAG],0
 12250                                  	;
 12251 00001992 3C00                    	CMP	AL,0	    ; extended code ( AL )
 12252 00001994 7505                    	JNZ	short noscan
 12253                                  
 12254                                  ;hkn; SS override
 12255                                  	;MOV	BYTE [SS:SCAN_FLAG],1 ; set this flag for ALT_Q key
 12256                                  	; 20/06/2023
 12257 00001996 36FE06[BC0D]            	inc	byte [SS:SCAN_FLAG]
 12258                                  noscan:
 12259 0000199B C3                      	retn
 12260                                  ;
 12261                                  ;----------------------------------------------------------------------------
 12262                                  ;
 12263                                  ;**	$STD_CON_STRING_OUTPUT - Console String Output
 12264                                  ;
 12265                                  ;
 12266                                  ;	ENTRY	(DS:DX) Point to output string '$' terminated
 12267                                  ;	EXIT	none
 12268                                  ;	USES	ALL
 12269                                  ;
 12270                                  ;----------------------------------------------------------------------------
 12271                                  ;
 12272                                  
 12273                                  _$STD_CON_STRING_OUTPUT:	;System call 9
 12274                                  
 12275 0000199C 89D6                    	mov	si,dx
 12276                                  STRING_OUT1:	
 12277 0000199E AC                      	lodsb
 12278 0000199F 3C24                    	cmp	al,'$'
 12279 000019A1 74F8                    	je	short noscan
 12280                                  NEXT_STR1:
 12281 000019A3 E88702                  	call	OUTT
 12282 000019A6 EBF6                    	jmp	short STRING_OUT1
 12283                                  
 12284                                  ;----------------------------------------------------------------------------
 12285                                  ;
 12286                                  ;**	$STD_CON_STRING_INPUT - Input Line from Console
 12287                                  ;
 12288                                  ;	$STD_CON_STRING_INPUT Fills a buffer from console input until CR
 12289                                  ;
 12290                                  ;	ENTRY	(ds:dx) = input buffer
 12291                                  ;	EXIT	none
 12292                                  ;	USES	ALL
 12293                                  ;
 12294                                  ;----------------------------------------------------------------------------
 12295                                  
 12296                                  	; 15/01/2024 - Retro DOS v5.0
 12297                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:58D4h
 12298                                  
 12299                                  _$STD_CON_STRING_INPUT:		;System call 10
 12300                                  
 12301                                  	; 15/01/2024
 12302                                  	;mov	ax,ss
 12303                                  	;mov	es,ax
 12304 000019A8 16                      	push	ss
 12305 000019A9 07                      	pop	es
 12306                                  
 12307 000019AA 89D6                    	mov	si,dx
 12308 000019AC 30ED                    	xor	ch,ch
 12309 000019AE AD                      	lodsw
 12310                                  
 12311                                  ;	(AL) = the buffer length
 12312                                  ;	(AH) = the template length
 12313                                  
 12314 000019AF 08C0                            or	al,al
 12315 000019B1 74E8                            jz	short noscan	;Buffer is 0 length!!?
 12316 000019B3 88E3                    	mov	bl,ah		;Init template counter
 12317 000019B5 88EF                            mov	bh,ch		;Init template counter
 12318                                  
 12319                                  ;	(BL) = the number of bytes in the template
 12320                                  
 12321 000019B7 38D8                            cmp	al,bl
 12322 000019B9 7605                            jbe	short NOEDIT	;If length of buffer inconsistent with contents
 12323 000019BB 80380D                          cmp	byte [bx+si],c_CR ; 0Dh
 12324 000019BE 7402                            jz	short EDITON	;If CR correctly placed EDIT is OK
 12325                                  
 12326                                  ; The number of chars in the template is >= the number of chars in buffer or
 12327                                  ; there is no CR at the end of the template. This is an inconsistant state
 12328                                  ; of affairs. Pretend that the template was empty:
 12329                                  ;
 12330                                  
 12331                                  NOEDIT:	
 12332 000019C0 88EB                    	mov	bl,ch		;Reset buffer
 12333                                  EDITON: 
 12334 000019C2 88C2                    	mov	dl,al
 12335 000019C4 4A                      	dec	dx		;DL is # of bytes we can put in the buffer
 12336                                  
 12337                                  ;	Top level. We begin to read a line in.
 12338                                  
 12339                                  NEWLIN: 
 12340 000019C5 36A0[F901]              	mov	al,[SS:CARPOS]
 12341 000019C9 36A2[FA01]              	mov	[SS:STARTPOS],al ;Remember position in raw buffer
 12342                                  
 12343 000019CD 56                      	push	si
 12344 000019CE BF[FB01]                	mov	di,INBUF ;Build the new line here
 12345 000019D1 36882E[7905]            	mov	byte [SS:INSMODE],ch ;Insert mode off
 12346 000019D6 88EF                    	mov	bh,ch		;No chars from template yet
 12347 000019D8 88EE                    	mov	dh,ch		;No chars to new line yet
 12348 000019DA E866FF                  	call	_$STD_CON_INPUT_NO_ECHO ;Get first char
 12349 000019DD 3C0A                    	cmp	al,c_LF		; 0Ah	;Linefeed 
 12350 000019DF 7503                    	jnz	short GOTCH
 12351                                  
 12352                                  ;	This is the main loop of reading in a character and processing it.
 12353                                  ;
 12354                                  ;	(BH) = the index of the next byte in the template
 12355                                  ;	(BL) = the length of the template
 12356                                  ;	(DH) = the number of bytes in the buffer
 12357                                  ;	(DL) = the length of the buffer
 12358                                  
 12359                                  GETCH:
 12360 000019E1 E85FFF                  	call	_$STD_CON_INPUT_NO_ECHO
 12361                                  GOTCH:
 12362                                  ;
 12363                                  ; Brain-damaged Tim Patterson ignored ^F in case his BIOS did not flush the
 12364                                  ; input queue.
 12365                                  ;
 12366 000019E4 3C06                            cmp	al,"F"-"@"  ; CMP AL, 6  ; Ignore ^F
 12367 000019E6 74F9                    	jz	short GETCH
 12368                                  
 12369                                  ;	If the leading char is the function-key lead byte
 12370                                  
 12371                                  	;cmp	al,[SS:ESCCHAR]
 12372                                  
 12373                                  	; 04/05/2019 - Retro DOS v4.0
 12374                                  
 12375                                  ;hkn; 	ESCCHAR is in TABLE seg (DOSCODE)
 12376                                  
 12377 000019E8 2E3A06[900A]            	CMP	AL,[cs:ESCCHAR]
 12378 000019ED 7439                            jz	short ESCAPE	;change reserved keyword DBM 5-7-87
 12379                                  
 12380                                  ;	Rubout and ^H are both destructive backspaces.
 12381                                  
 12382 000019EF 3C7F                            cmp	al,c_DEL ; 7FH
 12383                                          ;jz	short BACKSPJ
 12384                                          ; 15/01/2024
 12385 000019F1 7466                    	je	short BACKSP
 12386 000019F3 3C08                    	cmp	al,c_BS  ; 8
 12387                                          ;jz	short BACKSPJ
 12388                                          ; 15/01/2024
 12389 000019F5 7462                    	je	short BACKSP
 12390                                  
 12391                                  	; 04/05/2019 -	MSDOS 6.0, also MSDOS 6.21 has bug (bullshit) here.
 12392                                  	;		Two NOPs -instead of a JMP short, as two bytes-
 12393                                  	;	   	after CMP and a CMP again!
 12394                                  	;		
 12395                                  	;		-It would be better if they use a 'JMP short' to 
 12396                                  	;	      	DOSCODE:5279h from DOSCODE:5271h and leave NOPs
 12397                                  	;		between them. Then, they would be able use a patch
 12398                                  	;		between 5271h and 5279h when if it will be required.
 12399                                  	;		I think Tim Patterson would not do this CMP mistake!-
 12400                                  	;	
 12401                                  	; (MSDOS.SYS, from DOSCODE:5271h to DOSCODE:5279h)
 12402                                  
 12403                                  	; 08/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 12404                                  	;
 12405                                  	; (Note: nops below might be used for patching code for Windows 3.1)
 12406                                  
 12407                                  ;DOSCODE:526D	cmp     al, 8
 12408                                  ;DOSCODE:526F	jz      short BACKSPJ
 12409                                  ;DOSCODE:5271	cmp     al, 17h
 12410                                  ;DOSCODE:5273	nop
 12411                                  ;DOSCODE:5274	nop
 12412                                  ;DOSCODE:5275	cmp     al, 15h
 12413                                  ;DOSCODE:5277	nop
 12414                                  ;DOSCODE:5278	nop
 12415                                  ;DOSCODE:5279	cmp     al, 0Dh
 12416                                  ;DOSCODE:527B	jz      short ENDLIN
 12417                                  ;DOSCODE:527D	cmp     al, 0Ah
 12418                                  ;DOSCODE:527F	jz      short PHYCRLF
 12419                                  	
 12420                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 12421                                  	; DOSCODE:525Dh
 12422                                  
 12423                                  ; 16/12/2022
 12424                                  %if 0
 12425                                  	; MSDOS 6.0
 12426                                  ;	^W deletes backward once and then backs up until a letter is before the
 12427                                  ;	cursor
 12428                                  
 12429                                  	CMP     AL,"W"-"@" ; 17h
 12430                                  
 12431                                  ;	The removal of the comment characters before the jump statement will
 12432                                  ;	cause ^W to backup a word.
 12433                                  
 12434                                  ;***	JZ	short WordDel
 12435                                  	NOP
 12436                                  	NOP
 12437                                  
 12438                                  	CMP     AL,"U"-"@" ; 15h
 12439                                  
 12440                                  ;	The removal of the comment characters before the jump statement will
 12441                                  ;	cause ^U to clear a line.
 12442                                  
 12443                                  ;***	JZ	short LineDel
 12444                                  	NOP
 12445                                  	NOP
 12446                                  
 12447                                  %endif
 12448                                  
 12449                                  ;	CR terminates the line.
 12450                                  
 12451 000019F7 3C0D                            cmp	al,c_CR ; 0Dh
 12452 000019F9 7430                            jz	short ENDLIN
 12453                                  
 12454                                  ;	LF goes to a new line and keeps on reading.
 12455                                  
 12456 000019FB 3C0A                            cmp	al,c_LF ; 0Ah
 12457 000019FD 7442                    	jz	short PHYCRLF
 12458                                  
 12459                                  ;	^X (or ESC) deletes the line and starts over
 12460                                  
 12461                                  	; MSDOS 3.3
 12462                                  	;cmp	al,[ss:CANCHAR] ; 1Bh
 12463                                  	;jz	short KILNEW
 12464                                  
 12465                                  	; MSDOS 6.0 (& MSDOS 6.21)
 12466                                  
 12467                                  ;hkn; 	CANCHAR is in TABLE seg (DOSCODE), so CS override
 12468                                  
 12469 000019FF 2E3A06[8F0A]            	cmp	al,[cs:CANCHAR] ; 1Bh
 12470 00001A04 7440                    	jz	short KILNEW
 12471                                  	
 12472                                  	;cmp	al,CANCEL ; 1Bh	; Retro DOS v3.0
 12473                                  	;jz	short KILNEW
 12474                                  
 12475                                  ; Otherwise, we save the input character.
 12476                                  
 12477                                  SAVCH:	
 12478 00001A06 38D6                    	cmp	dh,dl
 12479 00001A08 7317                    	jnb	short BUFFUL		; buffer is full.
 12480 00001A0A AA                              stosb
 12481 00001A0B FEC6                    	inc	dh                      ; increment count in buffer.
 12482 00001A0D E8B102                  	call	BUFOUT			; Print control chars nicely
 12483                                  
 12484 00001A10 36803E[7905]00                  cmp	byte [SS:INSMODE], 0
 12485 00001A16 75C9                    	jnz	short GETCH		; insertmode => don't advance template
 12486 00001A18 38DF                            cmp	bh,bl
 12487 00001A1A 73C5                            jnb	short GETCH		; no more characters in template
 12488 00001A1C 46                              inc	si                      ; Skip to next char in template
 12489 00001A1D FEC7                            inc	bh                      ; remember position in template
 12490 00001A1F EBC0                            jmp	short GETCH
 12491                                  
 12492                                  	; 15/01/2024
 12493                                  ;BACKSPJ: 
 12494                                  	;jmp	short BACKSP
 12495                                  
 12496                                  BUFFUL: 
 12497 00001A21 B007                    	mov	al, 7			; Bell to signal full buffer
 12498 00001A23 E80702                  	call	OUTT
 12499 00001A26 EBB9                    	jmp	short GETCH
 12500                                  
 12501                                  ESCAPE: 
 12502                                  	;transfer OEMFunctionKey
 12503 00001A28 E990F0                  	JMP	OEMFunctionKey		; let the OEM's handle the key dispatch
 12504                                  
 12505                                  ENDLIN:
 12506 00001A2B AA                              stosb				; Put the CR in the buffer
 12507 00001A2C E8FE01                  	call	OUTT                    ; Echo it
 12508 00001A2F 5F                              pop	di                      ; Get start of user buffer
 12509 00001A30 8875FF                          mov	[di-1], dh		; Tell user how many bytes
 12510 00001A33 FEC6                            inc	dh			; DH is length including CR
 12511                                  
 12512                                  COPYNEW:
 12513                                  	; (IBMDOS.COM, MSDOS 2.0, STRIN.ASM)
 12514                                  	;mov	bp, es
 12515                                  	;mov	bx, ds
 12516                                  	;mov	es, bx
 12517                                  	;mov	ds, bp
 12518                                  	;mov	si, INBUF
 12519                                  	;mov	cl, dh
 12520                                  	;rep	movsb
 12521                                  	;retn
 12522                                  
 12523                                  	; CPMIO.ASM (MSDOS 6.0)
 12524                                  	; (IBMDOS.COM, MSDOS 3.3, Offset 2061h) 
 12525                                  	;SAVE	<DS,ES>
 12526 00001A35 1E                      	PUSH	DS
 12527 00001A36 06                      	PUSH	ES
 12528                                  	;RESTORE <DS,ES>		; XCHG ES,DS
 12529 00001A37 1F                      	POP	DS
 12530 00001A38 07                      	POP	ES
 12531                                  
 12532                                  ;;hkn; INBUF is in DOSDATA
 12533 00001A39 BE[FB01]                        MOV     SI,INBUF
 12534 00001A3C 88F1                            MOV     CL,DH                   ; set up count
 12535 00001A3E F3A4                            REP     MOVSB                   ; Copy final line to user buffer
 12536                                  OLDBAK_RETN:
 12537 00001A40 C3                              RETN
 12538                                  
 12539                                  ;	Output a CRLF to the user screen and do NOT store it into the buffer
 12540                                  
 12541                                  PHYCRLF:
 12542 00001A41 E81B01                  	CALL	CRLF
 12543 00001A44 EB9B                            JMP	short GETCH
 12544                                  
 12545                                  	; MSDOS 6.0 (& MSDOS 3.3, IBMDOS.COM, 1987)
 12546                                  
 12547                                  ; DOSCODE:52CAh (MSDOS 621, MSDOS.SYS)
 12548                                  
 12549                                  	; Note: Following routines were not used in IBMDOS.COM
 12550                                  	;	-CRTL+W, CRTL+U is not activated-
 12551                                  	;	but they were in the kernel code!?)
 12552                                  
 12553                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 12554                                  	; DOSCODE:52B6h
 12555                                  
 12556                                  ;;;;;;;;
 12557                                  
 12558                                  ; 16/12/2022
 12559                                  %if 0
 12560                                  ;
 12561                                  ; Delete the previous line
 12562                                  ;
 12563                                  LineDel:
 12564                                  	OR      DH,DH
 12565                                  	JZ	short GETCH	 ; 06/12/2022
 12566                                  	Call    BackSpace
 12567                                  	JMP	short LineDel
 12568                                  
 12569                                  %endif
 12570                                  
 12571                                  ;
 12572                                  ; delete the previous word.
 12573                                  ;
 12574                                  WordDel:
 12575                                  WordLoop:
 12576                                  ;	Call    BackSpace               ; backspace the one spot
 12577                                  ;	OR      DH,DH
 12578                                  ;	JZ	short GetChj
 12579                                  ;	MOV     AL,[ES:DI-1]
 12580                                  ;	cmp     al,'0'
 12581                                  ;	jb	short GetChj
 12582                                  ;	cmp     al,'9'
 12583                                  ;	jbe	short WordLoop
 12584                                  ;	OR      AL,20h
 12585                                  ;	CMP     AL,'a'
 12586                                  ;	JB	short GetChj
 12587                                  ;	CMP     AL,'z'
 12588                                  ;	JBE	short WordLoop
 12589                                  ;GetChj: 
 12590                                  ;	JMP	GETCH
 12591                                  
 12592                                  ; 16/12/2022
 12593                                  %if 0
 12594                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 12595                                  	; (Worddel is not called or jumped from anywhere!)
 12596                                  WordDel:
 12597                                  WordLoop:
 12598                                  	Call    BackSpace               ; backspace the one spot
 12599                                  	OR      DH,DH
 12600                                  	JZ	short GetChj
 12601                                  	MOV     AL,[ES:DI-1]
 12602                                  	cmp     al,'0'
 12603                                  	jb	short GetChj
 12604                                  	cmp     al,'9'
 12605                                  	jbe	short WordLoop
 12606                                  	OR      AL,20h
 12607                                  	CMP     AL,'a'
 12608                                  	JB	short GetChj
 12609                                  	CMP     AL,'z'
 12610                                  	JBE	short WordLoop
 12611                                  GetChj: 
 12612                                  	JMP	GETCH
 12613                                  
 12614                                  %endif
 12615                                  
 12616                                  ;;;;;;;;
 12617                                  
 12618                                  ; DOSCODE:52F3h (MSDOS 621, MSDOS.SYS)
 12619                                  
 12620                                  ; The user wants to throw away what he's typed in and wants to start over.
 12621                                  ; We print the backslash and then go to the next line and tab to the correct
 12622                                  ; spot to begin the buffered input.
 12623                                  
 12624                                  KILNEW:
 12625 00001A46 B05C                            mov	al,'\'
 12626 00001A48 E8E201                          call	OUTT            ;Print the CANCEL indicator
 12627 00001A4B 5E                              pop	si		;Remember start of edit buffer
 12628                                  PUTNEW:
 12629 00001A4C E81001                  	call	CRLF            ;Go to next line on screen
 12630 00001A4F 36A0[FA01]              	mov	al,[SS:STARTPOS]
 12631 00001A53 E84B02                  	call	TAB             ;Tab over
 12632 00001A56 E96CFF                          JMP     NEWLIN		;Start over again
 12633                                  
 12634                                  ;	Destructively back up one character position
 12635                                  
 12636                                  BACKSP:
 12637                                  	; 09/09/2018
 12638 00001A59 E80800                  	Call    BackSpace
 12639 00001A5C EB83                    	JMP     short GETCH	; 15/01/2024
 12640                                  
 12641                                  	; 15/01/2024
 12642                                  ;User really wants an ESC character in his line
 12643                                  TWOESC:	
 12644 00001A5E 2EA0[900A]              	mov	al,[cs:ESCCHAR] ; 10/06/2019
 12645 00001A62 EBA2                    	jmp	short SAVCH
 12646                                  
 12647                                  BackSpace:
 12648 00001A64 08F6                    	or	dh,dh
 12649 00001A66 7419                    	jz	short OLDBAK	;No chars in line, do nothing to line
 12650 00001A68 E85800                  	call	BACKUP          ;Do the backup
 12651 00001A6B 268A05                  	mov	al,[es:di]	;Get the deleted char
 12652 00001A6E 3C20                            cmp	al,20h	; ' '
 12653 00001A70 730F                    	jnb	short OLDBAK	;Was a normal char
 12654 00001A72 3C09                            cmp	al,c_HT ; 9
 12655 00001A74 741B                    	jz	short BAKTAB	;Was a tab, fix up users display
 12656                                  ;; 9/27/86 fix for ctrl-U backspace
 12657 00001A76 3C15                    	CMP     AL,"U"-"@" ; 15h ; ctrl-U is a section symbol not ^U
 12658 00001A78 7407                    	JZ	short OLDBAK
 12659 00001A7A 3C14                           	CMP     AL,"T"-"@" ; 14h ; ctrl-T is a paragraphs symbol not ^T
 12660 00001A7C 7403                    	JZ	short OLDBAK
 12661                                  ;; 9/27/86 fix for ctrl-U backspace
 12662 00001A7E E84500                          call	BACKMES         ;Was a control char, zap the '^'
 12663                                  OLDBAK:
 12664 00001A81 36803E[7905]00                  cmp	byte [SS:INSMODE], 0
 12665 00001A87 75B7                    	jnz	short OLDBAK_RETN ;In insert mode, done
 12666 00001A89 08FF                    	or	bh,bh
 12667 00001A8B 74B3                            jz	short OLDBAK_RETN 
 12668                                  				;Not advanced in template, stay where we are
 12669 00001A8D FECF                    	dec	bh		;Go back in template
 12670 00001A8F 4E                              dec	si
 12671 00001A90 C3                      	retn
 12672                                  BAKTAB:
 12673 00001A91 57                              push	di
 12674 00001A92 4F                              dec	di		;Back up one char
 12675 00001A93 FD                              std			;Go backward
 12676 00001A94 88F1                            mov	cl,dh		;Number of chars currently in line
 12677 00001A96 B020                            mov	al,20h	; ' '
 12678 00001A98 53                              push	bx
 12679 00001A99 B307                            mov	bl,7		;Max
 12680 00001A9B E30E                            jcxz	FIGTAB		;At start, do nothing
 12681                                  FNDPOS:
 12682 00001A9D AE                              scasb			;Look back
 12683 00001A9E 7609                    	jbe	short CHKCNT
 12684 00001AA0 26807D0109              	cmp	byte [es:di+1],9
 12685 00001AA5 7409                    	jz	short HAVTAB	;Found a tab
 12686 00001AA7 FECB                    	dec	bl		;Back one char if non tab control char
 12687                                  CHKCNT:
 12688 00001AA9 E2F2                            loop	FNDPOS
 12689                                  FIGTAB:		
 12690 00001AAB 362A1E[FA01]            	sub	bl,[SS:STARTPOS]
 12691                                  HAVTAB:
 12692 00001AB0 28F3                    	sub	bl,dh
 12693 00001AB2 00D9                    	add	cl,bl
 12694 00001AB4 80E107                  	and	cl,7		;CX has correct number to erase
 12695 00001AB7 FC                      	cld			;Back to normal
 12696 00001AB8 5B                      	pop	bx
 12697 00001AB9 5F                      	pop	di
 12698 00001ABA 74C5                    	jz	short OLDBAK	;Nothing to erase
 12699                                  TABBAK:
 12700 00001ABC E80700                  	call	BACKMES
 12701 00001ABF E2FB                    	loop	TABBAK		;Erase correct number of chars
 12702 00001AC1 EBBE                    	jmp	short OLDBAK
 12703                                  
 12704                                  BACKUP:
 12705 00001AC3 FECE                            dec	dh		;Back up in line
 12706 00001AC5 4F                              dec	di
 12707                                  BACKMES:
 12708 00001AC6 B008                            mov	al,c_BS ; 8	;Backspace
 12709 00001AC8 E86201                          call	OUTT
 12710 00001ACB B020                            mov	al,20h ; ' '	;Erase
 12711 00001ACD E85D01                          call	OUTT
 12712 00001AD0 B008                            mov	al,c_BS ; 8	;Backspace
 12713 00001AD2 E95801                  	jmp	OUTT		;Done
 12714                                  
 12715                                  	; 15/01/2024
 12716                                  ;User really wants an ESC character in his line
 12717                                  ;TWOESC:	
 12718                                  ;	mov	al,[cs:ESCCHAR] ; 10/06/2019
 12719                                  ;	jmp	SAVCH
 12720                                  
 12721                                  ;Copy the rest of the template
 12722                                  COPYLIN:
 12723 00001AD5 88D9                            mov	cl,bl		;Total size of template
 12724 00001AD7 28F9                    	sub	cl,bh		;Minus position in template, is number to move
 12725 00001AD9 EB07                            jmp	short COPYEACH
 12726                                  
 12727                                  COPYSTR:
 12728 00001ADB E83200                  	call	FINDOLD         ;Find the char
 12729 00001ADE EB02                    	jmp	short COPYEACH  ;Copy up to it
 12730                                  
 12731                                  ;Copy one char from template to line
 12732                                  COPYONE:
 12733 00001AE0 B101                            mov	cl,1
 12734                                  ;Copy CX chars from template to line
 12735                                  COPYEACH:
 12736 00001AE2 36C606[7905]00                  mov	byte [SS:INSMODE],0	;All copies turn off insert mode
 12737 00001AE8 38D6                    	cmp	dh,dl
 12738 00001AEA 740F                            jz	short GETCH2		;At end of line, can't do anything
 12739 00001AEC 38DF                            cmp	bh,bl
 12740 00001AEE 740B                            jz	short GETCH2		;At end of template, can't do anything
 12741 00001AF0 AC                              lodsb
 12742 00001AF1 AA                              stosb
 12743 00001AF2 E8CC01                  	call	BUFOUT
 12744 00001AF5 FEC7                            inc	bh			;Ahead in template
 12745 00001AF7 FEC6                            inc	dh			;Ahead in line
 12746 00001AF9 E2E7                            loop	COPYEACH
 12747                                  GETCH2:
 12748 00001AFB E9E3FE                          jmp	GETCH
 12749                                  
 12750                                  ;Skip one char in template
 12751                                  SKIPONE:
 12752 00001AFE 38DF                    	cmp	bh,bl
 12753 00001B00 74F9                    	jz	short GETCH2		;At end of template
 12754 00001B02 FEC7                    	inc	bh			;Ahead in template
 12755 00001B04 46                      	inc	si
 12756                                          ;jmp	GETCH
 12757                                  	; 15/01/2024
 12758 00001B05 EBF4                    	jmp	short GETCH2
 12759                                  
 12760                                  SKIPSTR:
 12761 00001B07 E80600                  	call	FINDOLD                 ;Find out how far to go
 12762 00001B0A 01CE                            add	si,cx			;Go there
 12763 00001B0C 00CF                            add	bh,cl
 12764                                          ;jmp	GETCH
 12765                                  	; 15/01/2024
 12766 00001B0E EBEB                    	jmp	short GETCH2
 12767                                  
 12768                                  ;Get the next user char, and look ahead in template for a match
 12769                                  ;CX indicates how many chars to skip to get there on output
 12770                                  ;NOTE: WARNING: If the operation cannot be done, the return
 12771                                  ;       address is popped off and a jump to GETCH is taken.
 12772                                  ;       Make sure nothing extra on stack when this routine
 12773                                  ;       is called!!! (no PUSHes before calling it).
 12774                                  
 12775                                  FINDOLD:
 12776 00001B10 E830FE                          call	_$STD_CON_INPUT_NO_ECHO
 12777                                  
 12778                                  	; STRIN.ASM (MSDOS 2.11, 19/07/2018) 
 12779                                  
 12780                                  	;CMP     AL,[SS:ESCCHAR]	
 12781                                  	;JNZ     SHORT FINDSETUP
 12782                                  
 12783                                  	; CPMIO.ASM (MSDOS 6.0, 04/05/2019 - Retro DOS v4.0)
 12784                                  
 12785                                  ;hkn; ESCCHAR is in TABLE seg (DOSCODE), so CS override
 12786                                  
 12787 00001B13 2E3A06[900A]            	CMP	AL,[CS:ESCCHAR]		; did he type a function key?
 12788 00001B18 7505                    	JNZ	SHORT FINDSETUP		; no, set up for scan
 12789                                  
 12790 00001B1A E826FE                  	CALL	_$STD_CON_INPUT_NO_ECHO	; eat next char
 12791 00001B1D EB1D                            JMP	SHORT NOTFND		; go try again
 12792                                  FINDSETUP:
 12793 00001B1F 88D9                    	mov	cl,bl
 12794 00001B21 28F9                            sub	cl,bh		;CX is number of chars to end of template
 12795 00001B23 7417                    	jz	short NOTFND	;At end of template
 12796 00001B25 49                              dec	cx		;Cannot point past end, limit search
 12797 00001B26 7414                            jz	short NOTFND	;If only one char in template, forget it
 12798 00001B28 06                      	push	es
 12799 00001B29 1E                      	push	ds
 12800 00001B2A 07                      	pop	es
 12801 00001B2B 57                      	push	di
 12802 00001B2C 89F7                    	mov	di,si		;Template to ES:DI
 12803 00001B2E 47                      	inc	di
 12804 00001B2F F2AE                    	repne	scasb		;Look
 12805 00001B31 5F                      	pop	di
 12806 00001B32 07                      	pop	es
 12807 00001B33 7507                    	jnz	short NOTFND	;Didn't find the char
 12808 00001B35 F6D1                            not	cl		;Turn how far to go into how far we went
 12809 00001B37 00D9                            add	cl,bl		;Add size of template
 12810 00001B39 28F9                            sub	cl,bh		;Subtract current pos, result distance to skip
 12811                                  FINDOLD_RETN:
 12812 00001B3B C3                      	retn
 12813                                  
 12814                                  NOTFND:
 12815 00001B3C 5D                      	pop	bp              ;Chuck return address
 12816                                  	;jmp	GETCH
 12817                                  	; 15/01/2024
 12818                                  GETCH2_j:
 12819 00001B3D EBBC                    	jmp	short GETCH2
 12820                                  
 12821                                  REEDIT:
 12822 00001B3F B040                    	mov	al,'@'		;Output re-edit character
 12823 00001B41 E8E900                  	call	OUTT
 12824 00001B44 5F                      	pop	di
 12825 00001B45 57                      	push	di
 12826 00001B46 06                      	push	es
 12827 00001B47 1E                      	push	ds
 12828 00001B48 E8EAFE                  	call	COPYNEW		;Copy current line into template
 12829 00001B4B 1F                      	pop	ds
 12830 00001B4C 07                      	pop	es
 12831 00001B4D 5E                      	pop	si
 12832 00001B4E 88F3                    	mov	bl,dh		;Size of line is new size template
 12833 00001B50 E9F9FE                  	jmp	PUTNEW		;Start over again
 12834                                  
 12835                                  EXITINS:
 12836                                  ENTERINS:
 12837 00001B53 36F616[7905]            	not	byte [SS:INSMODE]
 12838                                  	;jmp	GETCH
 12839                                  	; 15/01/2024
 12840 00001B58 EBE3                    	jmp	short GETCH2_j
 12841                                  
 12842                                  ;Put a real live ^Z in the buffer (embedded)
 12843                                  CTRLZ:
 12844 00001B5A B01A                    	mov	al,"Z"-"@" ; 1Ah
 12845 00001B5C E9A7FE                          jmp	SAVCH
 12846                                  
 12847                                  ;Output a CRLF
 12848                                  CRLF:
 12849 00001B5F B00D                    	mov	al,c_CR ; 0Dh 
 12850 00001B61 E8C900                  	call	OUTT
 12851 00001B64 B00A                    	mov	al,c_LF ; 0Ah
 12852 00001B66 E9C400                  	jmp	OUTT
 12853                                  
 12854                                  ;
 12855                                  ;----------------------------------------------------------------------------
 12856                                  ;
 12857                                  ;**	$RAW_CON_IO - Do Raw Console I/O
 12858                                  ;
 12859                                  ;	Input or output raw character from console, no echo
 12860                                  ;
 12861                                  ;	ENTRY	DL = -1 if input
 12862                                  ;		   =  output character if output
 12863                                  ;	EXIT	(AL) = input character if input
 12864                                  ;	USES	all
 12865                                  ;
 12866                                  ;----------------------------------------------------------------------------
 12867                                  ; 20/07/2018 - Retro DOS v3.0
 12868                                  
 12869                                  ; 04/05/2019 - Retro DOS v4.0
 12870                                  ; DOSCODE:541Ch (MSDOS 6.21, MSDOS.SYS)
 12871                                  
 12872                                  ; 08/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 12873                                  ; DOSCODE:5408h (MSDOS 5.0, MSDOS.SYS)
 12874                                  
 12875                                  _$RAW_CON_IO:			; System call 6
 12876                                  
 12877 00001B69 88D0                            MOV	AL,DL
 12878 00001B6B 3CFF                            CMP	AL,-1
 12879 00001B6D 7541                    	JNZ	SHORT RAWOUT ; 16/12/2022
 12880                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 12881                                  	;jz	short rci1
 12882                                  	;jmp	short RAWOUT
 12883                                  	; 16/12/202
 12884                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 12885                                  	;nop
 12886                                  rci1:
 12887                                  			; Get pointer to register save area
 12888 00001B6F 36C43E[8405]            	LES	DI,[SS:USER_SP] ; 12/03/2018
 12889 00001B74 31DB                    	XOR	BX,BX
 12890                                      	;CALL	GET_IO_FCB	; MSDOS 2.11 (Retro DOS v2.0)
 12891 00001B76 E85523                  	CALL	GET_IO_SFT	; MSDOS 3.3 & MSDOS 6.0
 12892                                          ;JC	SHORT RET17
 12893 00001B79 72C0                            jc	short FINDOLD_RETN
 12894 00001B7B B401                    	MOV	AH,1
 12895 00001B7D E86835                  	CALL	IOFUNC
 12896 00001B80 750B                    	JNZ	SHORT RESFLG
 12897 00001B82 E82C43                  	CALL	SPOOLINT
 12898                                  	;OR	BYTE [ES:DI+16H],40H
 12899 00001B85 26804D1640              	OR	BYTE [ES:DI+user_env.user_F],40H ; Set user's zero flag
 12900 00001B8A 30C0                    	XOR	AL,AL
 12901                                  RET17:
 12902 00001B8C C3                      	RETN
 12903                                  
 12904                                  RESFLG:
 12905                                  	;AND	BYTE [ES:DI+16H],0FFH-40H  ; 0BFh
 12906 00001B8D 26806516BF              	AND	BYTE [ES:DI+user_env.user_F],0FFH-40H
 12907                                  				; Reset user's zero flag
 12908                                  ;RILP:
 12909                                  rci0:
 12910 00001B92 E81C43                       	CALL	SPOOLINT
 12911                                  ;
 12912                                  ;----------------------------------------------------------------------------
 12913                                  ;
 12914                                  ;**	$Raw_CON_INPUT - Raw Console Input
 12915                                  ;
 12916                                  ;	Input raw character from console, no echo
 12917                                  ;
 12918                                  ;	ENTRY	none
 12919                                  ;	EXIT	(al) = character
 12920                                  ;	USES	all
 12921                                  ;
 12922                                  ;----------------------------------------------------------------------------
 12923                                  ;
 12924                                  
 12925                                  ;rci0:	invoke	SPOOLINT
 12926                                  
 12927                                  	;entry	$RAW_CON_INPUT
 12928                                  
 12929                                  	; 04/05/2019 - Retro DOS v4.0
 12930                                  
 12931                                  ; DOSCODE:544Bh (MSDOS 6.21, MSDOS.SYS)
 12932                                  
 12933                                  	; 15/01/2024 - Retro DOS v5.0
 12934                                  
 12935                                  ; DOSCODE:5ACBh (PCDOS 7.1, IBMDOS.COM)
 12936                                  
 12937                                  _$RAW_CON_INPUT:		; System call 7
 12938 00001B95 53                      	push	bx
 12939 00001B96 31DB                    	XOR	BX,BX
 12940                                  	;CALL	GET_IO_FCB	; MSDOS 2.11 (Retro DOS v2.0)
 12941 00001B98 E83323                  	CALL	GET_IO_SFT	; MSDOS 3.3 & MSDOS 6.0
 12942 00001B9B 5B                      	pop	bx
 12943 00001B9C 72EE                    	JC	SHORT RET17
 12944 00001B9E B401                    	MOV	AH,1
 12945 00001BA0 E84535                  	CALL	IOFUNC
 12946                                  	;JZ	SHORT RILP	; MSDOS 2.11
 12947                                  	;XOR	AH,AH
 12948                                          ;CALL	IOFUNC
 12949                                          ;RETN
 12950 00001BA3 7506                    	jnz	short rci5	; MSDOS 3.3 & MSDOS 6.0
 12951 00001BA5 B484                    	MOV	AH,84h
 12952 00001BA7 CD2A                    	INT	int_IBM  ; int 2Ah
 12953 00001BA9 EBE7                    	JMP	short rci0
 12954                                  rci5:	
 12955 00001BAB 30E4                    	XOR	AH,AH
 12956                                  	;CALL	IOFUNC
 12957                                  	;RETN
 12958                                  	; 18/12/2022
 12959 00001BAD E93835                  	jmp	IOFUNC
 12960                                  
 12961                                  ;       Output the character in AL to stdout
 12962                                  ;
 12963                                  	;entry	RAWOUT
 12964                                  RAWOUT:
 12965 00001BB0 53                      	PUSH    BX
 12966 00001BB1 BB0100                  	MOV     BX,1
 12967                                  
 12968                                  	;CALL	GET_IO_FCB	; MSDOS 2.11 (Retro DOS v2.0)
 12969 00001BB4 E81723                  	CALL	GET_IO_SFT	; MSDOS 3.3 & MSDOS 6.0
 12970 00001BB7 721E                    	JC	SHORT RAWRET1
 12971                                  
 12972                                  	;
 12973                                  	; MSDOS 2.11
 12974                                          ;TEST	BYTE [SI+18H],080H	; output to file?
 12975                                          ;JZ	SHORT RAWNORM		; if so, do normally
 12976                                          ;PUSH	DS
 12977                                          ;PUSH	SI
 12978                                          ;LDS	SI,[SI+19H]		; output to special?
 12979                                  	;TEST	BYTE [SI+4],ISSPEC
 12980                                  	;POP	SI
 12981                                  	;
 12982                                          
 12983                                  	; MSDOS 3.3 & MSDOS 6.0
 12984                                  	;mov	bx,[si+5]
 12985 00001BB9 8B5C05                  	MOV	BX,[SI+SF_ENTRY.sf_flags] ;hkn; DS set up by get_io_sft
 12986                                   ;
 12987                                   ; If we are a network handle OR if we are not a local device then go do the
 12988                                   ; output the hard way.
 12989                                   ;	
 12990                                  	;and	bx,8080h
 12991 00001BBC 81E38080                	AND	BX,sf_isnet+devid_device
 12992                                  	;cmp	bx,80h
 12993 00001BC0 81FB8000                	CMP	BX,devid_device
 12994 00001BC4 7513                    	jnz     short RAWNORM
 12995 00001BC6 1E                      	push    ds
 12996                                  	;lds	bx,[si+7]
 12997 00001BC7 C55C07                  	LDS	BX,[SI+SF_ENTRY.sf_devptr] ; output to special?
 12998                                  	;test	byte [bx+4],10h
 12999 00001BCA F6470410                	TEST	BYTE [BX+SYSDEV.ATT],ISSPEC
 13000                                  	;
 13001                                  
 13002 00001BCE 1F                      	POP	DS
 13003 00001BCF 7408                    	JZ	SHORT RAWNORM		; if not, do normally
 13004                                  
 13005                                  	;INT	int_fastcon  ; int 29h	; quickly output the char
 13006                                  	; 15/01/2024
 13007 00001BD1 9C                      	pushf			; simulate INT 29h
 13008 00001BD2 FF1EA400                	call    far [29h*4]	; call far [00A4h]
 13009                                  
 13010                                  	;JMP	SHORT RAWRET
 13011                                  ;RAWNORM:
 13012                                  ;	CALL    RAWOUT3
 13013                                  RAWRET: 
 13014 00001BD6 F8                      	CLC
 13015                                  RAWRET1:
 13016 00001BD7 5B                      	POP     BX
 13017                                  RAWRET2:
 13018 00001BD8 C3                      	RETN
 13019                                  RAWNORM:
 13020 00001BD9 E80700                  	CALL    RAWOUT3
 13021 00001BDC EBF8                    	jmp	short RAWRET
 13022                                  
 13023                                  ;	Output the character in AL to handle in BX
 13024                                  ;
 13025                                  ;	entry	RAWOUT2
 13026                                  
 13027                                  RAWOUT2:
 13028                                  	;CALL	GET_IO_FCB	; MSDOS 2.11 (Retro DOS v2.0)
 13029                                  	;JC	SHORT RET18
 13030 00001BDE E8ED22                  	CALL	GET_IO_SFT	; MSDOS 3.3 & MSDOS 6.0
 13031 00001BE1 72F5                    	JC	SHORT RAWRET2
 13032                                  RAWOUT3:
 13033 00001BE3 50                      	PUSH	AX
 13034 00001BE4 EB0C                    	JMP	SHORT RAWOSTRT
 13035                                  ROLP:
 13036 00001BE6 E8C842                  	CALL	SPOOLINT
 13037                                  
 13038                                  	; 01/05/2019 - Retro DOS v4.0
 13039                                  
 13040                                  	; MSDOS 6.0
 13041                                  	;OR	word [ss:DOS34_FLAG],CTRL_BREAK_FLAG ; 001000000000b
 13042                                  	; 17/12/2022
 13043 00001BE9 36800E[1206]02          	or	byte [ss:DOS34_FLAG+1],(CTRL_BREAK_FLAG>>8) ; 02h
 13044                                  	;or	word [ss:DOS34_FLAG],200h
 13045                                  				;AN002; set control break
 13046                                  	;invoke DSKSTATCHK
 13047 00001BEF E83E42                  	call	DSKSTATCHK	;AN002; check control break
 13048                                  RAWOSTRT:
 13049 00001BF2 B403                    	MOV	AH,3
 13050 00001BF4 E8F134                  	CALL	IOFUNC
 13051 00001BF7 74ED                    	JZ	SHORT ROLP
 13052                                  
 13053                                  	; MSDOS 6.0
 13054                                  ;SR;
 13055                                  ; IOFUNC now returns ax = 0ffffh if there was an I24 on a status call and
 13056                                  ;the user failed. We do not send a char if this happens. We however return
 13057                                  ;to the caller with carry clear because this DOS call does not return any
 13058                                  ;status. 
 13059                                  ;
 13060 00001BF9 40                      	inc	ax		;fail on I24 if ax = -1
 13061 00001BFA 58                      	POP	AX
 13062 00001BFB 7405                    	jz	short nosend	;yes, do not send char
 13063 00001BFD B402                    	MOV	AH,2
 13064 00001BFF E8E634                  	call	IOFUNC
 13065                                  nosend:
 13066 00001C02 F8                      	CLC			; Clear carry indicating successful
 13067 00001C03 C3                      	retn
 13068                                  
 13069                                  	; MSDOS 3.3 & MSDOS 2.11
 13070                                  	;POP	AX
 13071                                  	;MOV	AH,2
 13072                                          ;CALL	IOFUNC
 13073                                  	;CLC			; Clear carry indicating successful
 13074                                  ;RET18:    
 13075                                  	;RETN
 13076                                  
 13077                                  ;;10/08/2018
 13078                                  ; 20/07/2018 - Retro DOS v3.0
 13079                                  ; ---------------------------------------------------------------------------
 13080                                  ; Retro DOS v2.0 (MSDOS 2.11) - OUTMES
 13081                                  ; ---------------------------------------------------------------------------
 13082                                  
 13083                                  ; This routine is called at DOS init
 13084                                  
 13085                                  ;;	;procedure OUTMES,NEAR ; String output for internal messages
 13086                                  ;;OUTMES:
 13087                                  ;;	;LODS	CS:BYTE PTR [SI]
 13088                                  ;;	CS	LODSB
 13089                                  ;;	CMP     AL,"$" ; 24h
 13090                                  ;;	JZ	SHORT RET18
 13091                                  ;;	CALL	OUTT
 13092                                  ;;	JMP     SHORT OUTMES
 13093                                  
 13094                                  ; ---------------------------------------------------------------------------
 13095                                  
 13096                                  ; 20/07/2018 - Retro DOS v3.0
 13097                                  
 13098                                  ; IBMDOS.COM (MSDOS 3.3 kernel) - Offset 2252h
 13099                                  
 13100                                  ;
 13101                                  ;----------------------------------------------------------------------------
 13102                                  ;
 13103                                  ; Inputs:
 13104                                  ;	AX=0 save the DEVCALL request packet
 13105                                  ;	  =1 restore the DEVCALL request packet
 13106                                  ; Function:
 13107                                  ;	save or restore the DEVCALL packet
 13108                                  ; Returns:
 13109                                  ;	none
 13110                                  ;
 13111                                  ;----------------------------------------------------------------------------
 13112                                  ;
 13113                                  
 13114                                  ; 04/05/2019 - Retro DOS v4.0
 13115                                  ; DOSCODE:54B9h (MSDOS 6.21, MSDOS.SYS)
 13116                                  
 13117                                  ; 08/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 13118                                  ; DOSCODE:54A5h (MSDOS 5.0, MSDOS.SYS)
 13119                                  
 13120                                  ; 12/05/2019
 13121                                  
 13122                                  	; 15/01/2024 - Retro DOS v5.0
 13123                                  	; DOSCODE:5B42h (PCDOS 7.1, IBMDOS.COM)
 13124                                  
 13125                                  Save_Restore_Packet:
 13126 00001C04 1E                      	PUSH	DS
 13127 00001C05 06                      	PUSH	ES
 13128 00001C06 56                      	PUSH	SI
 13129 00001C07 57                      	PUSH	DI
 13130                                  
 13131                                  	; 16/12/2022
 13132                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13133                                  	; 09/09/2018
 13134 00001C08 BF[A00D]                	mov	di,FAKE_STACK_2F 
 13135 00001C0B BE[5A03]                	mov	si,DEVCALL
 13136                                  	;
 13137                                  	; 21/09/2023
 13138 00001C0E 09C0                    	or	ax,ax 
 13139                                  	;CMP	AX,0		; save packet
 13140 00001C10 7402                    	JZ	short save_packet ; 16/12/2022
 13141                                  	;je	short set_seg
 13142                                  
 13143                                  	; MSDOS 6.0
 13144                                  restore_packet:
 13145                                  ;	MOV	SI,OFFSET DOSDATA:Packet_Temp	;source
 13146                                  ;	MOV	DI,OFFSET DOSDATA:DEVCALL	;destination
 13147                                  	; MSDOS 3.3
 13148                                  	;mov	si,FAKE_STACK_2F ; DOS_TEMP ; Packed_Temp 
 13149                                  	;mov	di,DEVCALL  ; 09/09/2018
 13150                                  	;
 13151                                  	;JMP	short set_seg
 13152                                  
 13153                                  	; 16/12/2022	
 13154                                  	; 09/09/2018
 13155 00001C12 87F7                    	xchg	si,di  ; DI = offset DEVCALL, SI = offset FAKE_STACK_2F
 13156                                  
 13157                                  ; 16/12/2022
 13158                                  %if 0
 13159                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13160                                  	cmp	ax,0		; save packet
 13161                                  	jz	short save_packet
 13162                                  	mov	si,FAKE_STACK_2F ; 07/12/2022
 13163                                  	mov	di,DEVCALL 
 13164                                  	jmp	short set_seg
 13165                                  
 13166                                  	; MSDOS 6.0
 13167                                  save_packet:
 13168                                  ;	MOV	DI,OFFSET DOSDATA:Packet_Temp	;destination
 13169                                  ;	MOV	SI,OFFSET DOSDATA:DEVCALL	;source
 13170                                  	; 09/09/2018
 13171                                  	; MSDOS 3.3
 13172                                  	;mov	di,FAKE_STACK_2F ; DOS_TEMP ; Packed_Temp 
 13173                                  	;mov	si,DEVCALL ; 09/09/2018
 13174                                  
 13175                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13176                                  	mov	di,FAKE_STACK_2F ; DOS_TEMP ; Packed_Temp 
 13177                                  	mov	si,DEVCALL
 13178                                  %endif
 13179                                  
 13180                                  ; 16/12/2022
 13181                                  save_packet:
 13182                                  ;set_seg:
 13183                                  	; MSDOS 3.3
 13184                                  	;mov	ax,cs
 13185                                  
 13186                                  	; MSDOS 6.0
 13187                                  	;MOV	AX,SS		; set DS,ES to DOSDATA
 13188                                  	;MOV	DS,AX
 13189                                  	;MOV	ES,AX
 13190                                  	; 15/01/2024
 13191 00001C14 16                      	push	ss
 13192 00001C15 1F                      	pop	ds
 13193 00001C16 1E                      	push	ds
 13194 00001C17 07                      	pop	es
 13195                                  
 13196 00001C18 B90B00                  	MOV	CX,11		; 11 words to move
 13197 00001C1B F3A5                    	REP	MOVSW
 13198                                  
 13199 00001C1D 5F                      	POP	DI
 13200 00001C1E 5E                      	POP	SI
 13201 00001C1F 07                      	POP	ES
 13202 00001C20 1F                      	POP	DS
 13203 00001C21 C3                      	retn
 13204                                  
 13205                                  ;============================================================================
 13206                                  ; CPMIO2.ASM, MSDOS 6.0, 1991
 13207                                  ;============================================================================
 13208                                  ; 20/07/2018 - Retro DOS v3.0
 13209                                  ; 01/05/2019 - Retro DOS v4.0
 13210                                  
 13211                                  ;hkn; 	All the variables use SS override or DS. Therefore there is
 13212                                  ;hkn;	no need to specifically set up any seg regs unless SS assumption is
 13213                                  ;hkn;	not valid. 
 13214                                  
 13215                                  ;
 13216                                  ;----------------------------------------------------------------------------
 13217                                  ;
 13218                                  ;**	$STD_CON_INPUT - System Call 1
 13219                                  ;
 13220                                  ;	Input character from console, echo
 13221                                  ;
 13222                                  ;	ENTRY	none
 13223                                  ;	EXIT	(al) = character
 13224                                  ;	USES	ALL
 13225                                  ;
 13226                                  ;----------------------------------------------------------------------------
 13227                                  ;
 13228                                  
 13229                                  _$STD_CON_INPUT:	;System call 1
 13230                                  	
 13231 00001C22 E81EFD                  	CALL	_$STD_CON_INPUT_NO_ECHO
 13232 00001C25 50                      	PUSH	AX
 13233 00001C26 E80400                  	CALL	OUTT
 13234 00001C29 58                      	POP	AX
 13235                                  CON_INPUT_RETN:	
 13236 00001C2A C3                      	RETN
 13237                                  
 13238                                  ;
 13239                                  ;----------------------------------------------------------------------------
 13240                                  ;
 13241                                  ;**	$STD_CON_OUTPUT - System Call 2
 13242                                  ;
 13243                                  ;	Output character to console
 13244                                  ;
 13245                                  ;	ENTRY	(dl) = character
 13246                                  ;	EXIT	none
 13247                                  ;	USES	all
 13248                                  ;
 13249                                  ;----------------------------------------------------------------------------
 13250                                  ;
 13251                                  
 13252                                  ; DOSCODE:54E9h (MSDOS 6.21, MSDOS.SYS)
 13253                                  
 13254                                  ; 08/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 13255                                  ; DOSCODE:54D5h (MSDOS 5.0, MSDOS.SYS)
 13256                                  
 13257                                  ; 15/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 13258                                  ; DOSCODE:5B70h (PCDOS 7.1, IBMDOS.COM)
 13259                                  
 13260                                  _$STD_CON_OUTPUT:	;System call 2
 13261                                  
 13262 00001C2B 88D0                    	MOV	AL,DL
 13263                                  OUTT:
 13264 00001C2D 3C20                    	CMP	AL,20H ; " "
 13265 00001C2F 725C                    	JB	SHORT CTRLOUT
 13266 00001C31 3C7F                    	CMP	AL,c_DEL ; 7Fh
 13267 00001C33 7405                    	JZ	SHORT OUTCH
 13268                                  OUTCHA:	
 13269                                  	;INC	BYTE PTR [CARPOS]
 13270 00001C35 36FE06[F901]            	INC	BYTE [SS:CARPOS]
 13271                                  OUTCH:
 13272 00001C3A 1E                      	PUSH	DS
 13273 00001C3B 56                      	PUSH	SI
 13274                                  	;INC	BYTE PTR [CHARCO]		;invoke statchk...
 13275                                  	;AND	BYTE PTR [CHARCO],00111111B	;AN000; every 64th char
 13276 00001C3C 36FE06[0003]            	INC	BYTE [SS:CHARCO]	
 13277                                  	;AND	BYTE [SS:CHARCO],00111111B
 13278                                  	; 01/05/2019 - Retro DOS v4.0
 13279 00001C41 368026[0003]3F          	and	byte [SS:CHARCO],3Fh
 13280 00001C47 7505                    	JNZ	SHORT OUTSKIP
 13281                                  
 13282 00001C49 50                      	PUSH	AX
 13283 00001C4A E89242                  	CALL	STATCHK
 13284 00001C4D 58                      	POP	AX
 13285                                  OUTSKIP:
 13286 00001C4E E85FFF                  	CALL	RAWOUT				;output the character
 13287                                  
 13288 00001C51 5E                      	POP	SI
 13289 00001C52 1F                      	POP	DS
 13290                                  
 13291                                  	;TEST	BYTE PTR [PFLAG],-1
 13292                                  	;retz
 13293 00001C53 36F606[FE02]FF          	TEST	BYTE [SS:PFLAG],0FFh
 13294 00001C59 74CF                    	JZ	SHORT CON_INPUT_RETN
 13295                                  
 13296 00001C5B 53                      	PUSH	BX
 13297 00001C5C 1E                      	PUSH	DS
 13298 00001C5D 56                      	PUSH	SI
 13299 00001C5E BB0100                  	MOV	BX,1
 13300                                  	; 20/07/2018 - Retro DOS v3.0
 13301                                  	; MSDOS 3.3
 13302                                  	; MSDOS 6.0 (CPMIO2.ASM)
 13303 00001C61 E86A22                  	CALL	GET_IO_SFT		;hkn; GET_IO_SFT will set up DS:SI
 13304                                  					;hkn; to sft entry
 13305 00001C64 7224                    	JC	SHORT TRIPOPJ
 13306                                  
 13307                                  	; 01/05/2019 - Retro DOS v4.0
 13308                                  
 13309                                  	;mov	bx,[si+5]
 13310 00001C66 8B5C05                  	MOV	BX,[SI+SF_ENTRY.sf_flags]
 13311                                  	;test	bx,8000h
 13312                                  	;TEST	BX,sf_isnet	; 8000h		; output to NET?
 13313 00001C69 F6C780                  	test	bh,(sf_isnet>>8) ; 80h
 13314 00001C6C 751C                    	JNZ	short TRIPOPJ 			; if so, no echo
 13315                                  	;;test	bx,80h
 13316                                  	;TEST	BX,devid_device 		; output to file?
 13317 00001C6E F6C380                  	test	bl,devid_device ; 80h
 13318 00001C71 7417                    	JZ	SHORT TRIPOPJ 			; if so, no echo
 13319                                  	; 14/03/2018
 13320                                  	;call	GET_IO_FCB	 	; IBMDOS.COM, MSDOS 2.11
 13321                                  	;jc	short TRIPOPJ
 13322                                  	; MSDOS 2.11
 13323                                  	;test	byte [SI+18H], 80h
 13324                                  	;jz	short TRIPOPJ
 13325 00001C73 BB0400                  	MOV	BX,4
 13326 00001C76 E85522                  	CALL	GET_IO_SFT
 13327 00001C79 720F                    	JC	SHORT TRIPOPJ
 13328                                  	;;test	word [si+5], 800h
 13329                                  	;TEST	word [SI+SF_ENTRY.sf_flags],sf_net_spool ; 800H
 13330                                  	;test	byte [si+6],8 ; 08/11/2022
 13331 00001C7B F6440608                	test	byte [SI+SF_ENTRY.sf_flags+1],(sf_net_spool>>8) ; 8 
 13332                                  						; StdPrn redirected?
 13333                                  	;;JZ	SHORT LISSTRT2J			; No, OK to echo
 13334                                  	;jz	LISSTRT2 ; 10/08/2018 
 13335                                  	; 16/12/2022
 13336 00001C7F 7503                    	jnz	short outch1
 13337 00001C81 E98700                  	jmp	LISSTRT2
 13338                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13339                                  	;jz	short LISSTRT2J
 13340                                  outch1:
 13341                                  	;MOV	BYTE [PFLAG],0
 13342 00001C84 36C606[FE02]00          	MOV	BYTE [SS:PFLAG],0		; If a spool, NEVER echo
 13343                                  	; MSDOS 2.11
 13344                                  	;mov	bx,4
 13345                                  	;jmp	short LISSTRT2
 13346                                  	
 13347                                  TRIPOPJ:
 13348                                  	; 20/07/2018
 13349 00001C8A E98100                  	JMP	TRIPOP
 13350                                  
 13351                                  	; 16/12/2022
 13352                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13353                                  ;LISSTRT2J:
 13354                                  ;	JMP	LISSTRT2
 13355                                  
 13356                                  CTRLOUT:
 13357 00001C8D 3C0D                    	CMP	AL,c_CR ; 0Dh
 13358 00001C8F 7420                    	JZ	SHORT ZERPOS
 13359 00001C91 3C08                    	CMP	AL,c_BS ; 8
 13360 00001C93 7424                    	JZ	SHORT BACKPOS
 13361 00001C95 3C09                    	CMP	AL,c_HT ; 9
 13362 00001C97 75A1                    	JNZ	SHORT OUTCH
 13363                                  	;MOV	AL,[CARPOS]
 13364 00001C99 36A0[F901]              	MOV	AL,[SS:CARPOS]
 13365 00001C9D 0CF8                    	OR	AL,0F8H
 13366 00001C9F F6D8                    	NEG	AL
 13367                                  TAB:
 13368 00001CA1 51                      	PUSH	CX
 13369 00001CA2 88C1                    	MOV	CL,AL
 13370 00001CA4 B500                    	MOV	CH,0
 13371 00001CA6 E307                    	JCXZ	POPTAB
 13372                                  TABLP:
 13373 00001CA8 B020                    	MOV	AL," "
 13374 00001CAA E880FF                  	CALL	OUTT
 13375 00001CAD E2F9                    	LOOP	TABLP
 13376                                  POPTAB:
 13377 00001CAF 59                      	POP	CX
 13378                                  
 13379 00001CB0 C3                      	RETN
 13380                                  
 13381                                  ZERPOS:
 13382                                  	;MOV	BYTE PTR [CARPOS],0
 13383 00001CB1 36C606[F901]00          	MOV	BYTE [SS:CARPOS],0
 13384                                  	; 10/08/2018
 13385 00001CB7 EB81                    	JMP	short OUTCH ; 04/05/2019
 13386                                  	
 13387                                  	; 18/12/2022
 13388                                  ;OUTJ:	
 13389                                  	;JMP	OUTT
 13390                                  
 13391                                  BACKPOS:
 13392                                  	;DEC	BYTE PTR [CARPOS]
 13393 00001CB9 36FE0E[F901]            	DEC	BYTE [SS:CARPOS]
 13394 00001CBE E979FF                  	JMP	OUTCH
 13395                                  
 13396                                  BUFOUT:
 13397 00001CC1 3C20                    	CMP	AL," "
 13398 00001CC3 7315                    	JAE	SHORT OUTJ		;Normal char
 13399 00001CC5 3C09                    	CMP	AL,9
 13400 00001CC7 7411                    	JZ	SHORT OUTJ		;OUT knows how to expand tabs
 13401                                  	;DOS 3.3  7/14/86
 13402 00001CC9 3C15                    	CMP	AL,"U"-"@" ; 15h	; turn ^U to section symbol
 13403 00001CCB 740D                    	JZ	short CTRLU
 13404 00001CCD 3C14                    	CMP	AL,"T"-"@" ; 14h	; turn ^T to paragraph symbol
 13405 00001CCF 7409                    	JZ	short CTRLU
 13406                                  NOT_CTRLU:
 13407                                  	;DOS 3.3  7/14/86
 13408 00001CD1 50                      	PUSH	AX
 13409 00001CD2 B05E                    	MOV	AL,"^"
 13410 00001CD4 E856FF                  	CALL	OUTT		;Print '^' before control chars
 13411 00001CD7 58                      	POP	AX
 13412 00001CD8 0C40                    	OR	AL,40H		;Turn it into Upper case mate
 13413                                  CTRLU:
 13414                                  	;CALL	OUTT
 13415                                  	; 18/12/2022
 13416                                  OUTJ:
 13417 00001CDA E950FF                  	jmp	OUTT
 13418                                  ;BUFOUT_RETN:
 13419                                  	;RETN
 13420                                  
 13421                                  ;
 13422                                  ;----------------------------------------------------------------------------
 13423                                  ;
 13424                                  ;**	$STD_AUX_INPUT - System Call 3
 13425                                  ;
 13426                                  ;	$STD_AUX_INPUT returns a character from Aux Input
 13427                                  ;
 13428                                  ;	ENTRY	none
 13429                                  ;	EXIT	(al) = character
 13430                                  ;	USES	all
 13431                                  ;
 13432                                  ;----------------------------------------------------------------------------
 13433                                  ;
 13434                                  
 13435                                  	; 08/11/2022 Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 13436                                  
 13437                                  _$STD_AUX_INPUT:	;System call 3
 13438                                  
 13439 00001CDD E8FF41                  	CALL	STATCHK
 13440 00001CE0 BB0300                  	MOV	BX,3
 13441 00001CE3 E8E821                  	CALL	GET_IO_SFT	; 20/07/2018 - MSDOS 3.3 (MSDOS 6.0)
 13442                                  	;CALL	GET_IO_FCB	; 14/03/2018 - MSDOS 2.11
 13443                                  	;retc
 13444                                  	; 16/12/2022
 13445                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13446                                  	;JC	SHORT BUFOUT_RETN
 13447                                  	;JMP	SHORT TAISTRT
 13448                                  	; 07/12/2022
 13449 00001CE6 7304                    	jnc	SHORT TAISTRT
 13450 00001CE8 C3                      	retn	
 13451                                  
 13452                                  AUXILP:
 13453 00001CE9 E8C541                  	CALL	SPOOLINT
 13454                                  TAISTRT:
 13455 00001CEC B401                    	MOV	AH,1
 13456 00001CEE E8F733                  	CALL	IOFUNC
 13457 00001CF1 74F6                    	JZ	SHORT AUXILP
 13458 00001CF3 30E4                    	XOR	AH,AH
 13459                                  	; 16/12/2022
 13460                                  	;CALL	IOFUNC
 13461                                  	;RETN
 13462                                  	; 07/12/2022
 13463 00001CF5 E9F033                  	jmp	IOFUNC
 13464                                  
 13465                                  ;
 13466                                  ;----------------------------------------------------------------------------
 13467                                  ;
 13468                                  ;**	$STD_AUX_OUTPUT - Output character to AUX
 13469                                  ;
 13470                                  ;	ENTRY	(dl) = character
 13471                                  ;	EXIT	none
 13472                                  ;	USES	all
 13473                                  ;
 13474                                  ;----------------------------------------------------------------------------
 13475                                  ;
 13476                                  
 13477                                  _$STD_AUX_OUTPUT:	;System call 4
 13478                                  
 13479 00001CF8 53                      	PUSH	BX
 13480 00001CF9 BB0300                  	MOV	BX,3
 13481 00001CFC EB04                    	JMP	SHORT SENDOUT
 13482                                  
 13483                                  ;
 13484                                  ;----------------------------------------------------------------------------
 13485                                  ;
 13486                                  ;**	$STD_PRINTER_OUTPUT - Output character to printer
 13487                                  ;
 13488                                  ;	ENTRY	(dl) = character
 13489                                  ;	EXIT	none
 13490                                  ;	USES	all
 13491                                  ;
 13492                                  ;----------------------------------------------------------------------------
 13493                                  ;
 13494                                  
 13495                                  _$STD_PRINTER_OUTPUT:	;System call 5
 13496                                  
 13497 00001CFE 53                      	PUSH	BX
 13498 00001CFF BB0400                  	MOV	BX,4
 13499                                  
 13500                                  SENDOUT:
 13501 00001D02 88D0                    	MOV	AL,DL
 13502 00001D04 50                      	PUSH	AX
 13503 00001D05 E8D741                  	CALL	STATCHK
 13504 00001D08 58                      	POP	AX
 13505 00001D09 1E                      	PUSH	DS
 13506 00001D0A 56                      	PUSH	SI
 13507                                  LISSTRT2:
 13508 00001D0B E8D0FE                  	CALL	RAWOUT2
 13509                                  TRIPOP:
 13510 00001D0E 5E                      	POP	SI
 13511 00001D0F 1F                      	POP	DS
 13512 00001D10 5B                      	POP	BX
 13513                                  SCIS_RETN:	; 20/07/2018
 13514 00001D11 C3                      	RETN
 13515                                  ;
 13516                                  ;----------------------------------------------------------------------------
 13517                                  ;
 13518                                  ;**	$STD_CON_INPUT_STATUS - System Call 11
 13519                                  ;
 13520                                  ;	Check console input status
 13521                                  ;
 13522                                  ;	ENTRY	none
 13523                                  ;	EXIT	AL = -1 character available, = 0 no character
 13524                                  ;	USES	all
 13525                                  ;
 13526                                  ;----------------------------------------------------------------------------
 13527                                  ;
 13528                                  
 13529                                  _$STD_CON_INPUT_STATUS:		;System call 11
 13530                                  
 13531 00001D12 E8CA41                  	CALL	STATCHK
 13532 00001D15 B000                    	MOV	AL,0		; no xor!!
 13533                                  	;retz
 13534 00001D17 74F8                    	JZ	SHORT SCIS_RETN ; 15/04/2018
 13535                                  	;OR	AL,-1
 13536                                  	; 15/01/2024 (PCDOS 7.1 IBMDOS.COM)
 13537 00001D19 48                      	dec	ax ; al = -1 
 13538                                  ;SCIS_RETN:
 13539 00001D1A C3                      	RETN
 13540                                  
 13541                                  ;
 13542                                  ;----------------------------------------------------------------------------
 13543                                  ;
 13544                                  ;**	$STD_CON_INPUT_FLUSH - System Call 12
 13545                                  ;
 13546                                  ;	Flush console input buffer and perform call in AL
 13547                                  ;
 13548                                  ;	ENTRY	(AL) = DOS function to be called after flush (1,6,7,8,10)
 13549                                  ;	EXIT	(al) = 0 iff (al) was not one of the supported fcns
 13550                                  ;		return arguments for the fcn supplied in (AL)
 13551                                  ;	USES	all
 13552                                  ;
 13553                                  ;----------------------------------------------------------------------------
 13554                                  ;
 13555                                  
 13556                                  _$STD_CON_INPUT_FLUSH:		;System call 12
 13557                                  
 13558 00001D1B 50                      	PUSH	AX
 13559 00001D1C 52                      	PUSH	DX
 13560 00001D1D 31DB                    	XOR	BX,BX
 13561 00001D1F E8AC21                  	CALL	GET_IO_SFT	; 20/07/2018 - MSDOS 3.3 (MSDOS 6.0)
 13562                                  	;CALL	GET_IO_FCB	; 14/03/2018 - MSDOS 2.11
 13563 00001D22 7205                    	JC	SHORT BADJFNCON
 13564 00001D24 B404                    	MOV	AH,4
 13565 00001D26 E8BF33                  	CALL	IOFUNC
 13566                                  
 13567                                  BADJFNCON:
 13568 00001D29 5A                      	POP	DX
 13569 00001D2A 58                      	POP	AX
 13570 00001D2B 88C4                    	MOV	AH,AL
 13571 00001D2D 3C01                    	CMP	AL,1
 13572 00001D2F 7413                    	JZ	SHORT REDISPJ
 13573 00001D31 3C06                    	CMP	AL,6
 13574 00001D33 740F                    	JZ	SHORT REDISPJ
 13575 00001D35 3C07                    	CMP	AL,7
 13576 00001D37 740B                    	JZ	SHORT REDISPJ
 13577 00001D39 3C08                    	CMP	AL,8
 13578 00001D3B 7407                    	JZ	SHORT REDISPJ
 13579 00001D3D 3C0A                    	CMP	AL,10
 13580 00001D3F 7403                    	JZ	SHORT REDISPJ
 13581 00001D41 B000                    	MOV	AL,0
 13582 00001D43 C3                      	RETN
 13583                                  
 13584                                  REDISPJ:
 13585 00001D44 FA                      	CLI
 13586                                  	;transfer REDISP
 13587 00001D45 E92DE6                  	JMP	REDISP
 13588                                  
 13589                                  ;============================================================================
 13590                                  ; FCBIO.ASM, MSDOS 6.0, 1991
 13591                                  ;============================================================================
 13592                                  ; 20/07/2018 - Retro DOS v3.0
 13593                                  ; 17/05/2019 - Retro DOS v4.0
 13594                                  
 13595                                  ;**	FCBIO.ASM - Ancient 1.0 1.1 FCB system calls
 13596                                  ;
 13597                                  ;	$GET_FCB_POSITION
 13598                                  ;	$FCB_DELETE
 13599                                  ;	$GET_FCB_FILE_LENGTH
 13600                                  ;	$FCB_CLOSE
 13601                                  ;	$FCB_RENAME
 13602                                  ;	SaveFCBInfo
 13603                                  ;	ResetLRU
 13604                                  ;	SetOpenAge
 13605                                  ;	LRUFCB
 13606                                  ;	FCBRegen
 13607                                  ;	BlastSFT
 13608                                  ;	CheckFCB
 13609                                  ;	SFTFromFCB
 13610                                  ;	FCBHardErr
 13611                                  ;
 13612                                  ;	Revision history:
 13613                                  ;
 13614                                  ;		Created: ARR 4 April 1983"
 13615                                  ;			 MZ  6 June  1983 completion of functions
 13616                                  ;			 MZ 15 Dec   1983 Brain damaged programs close FCBs multiple
 13617                                  ;					  times.  Change so successive closes work by
 13618                                  ;					  always returning OK.	Also, detect I/O to
 13619                                  ;					  already closed FCB and return EOF.
 13620                                  ;			 MZ 16 Jan   1984 More braindamage.  Need to separate info
 13621                                  ;					  out of sft into FCB for reconnection
 13622                                  ;
 13623                                  ;		A000	 version 4.00  Jan. 1988
 13624                                  
 13625                                  ;Break <$Get_FCB_Position - set random record fields to current pos>
 13626                                  ;----------------------------------------------------------------------------
 13627                                  ;
 13628                                  ;   $Get_FCB_Position - look at an FCB, retrieve the current position from the
 13629                                  ;	extent and next record field and set the random record field to point
 13630                                  ;	to that record
 13631                                  ;
 13632                                  ;   Inputs:	DS:DX point to a possible extended FCB
 13633                                  ;   Outputs:	The random record field of the FCB is set to the current record
 13634                                  ;   Registers modified: all
 13635                                  ;
 13636                                  ;----------------------------------------------------------------------------
 13637                                  ;
 13638                                  
 13639                                  _$GET_FCB_POSITION:
 13640 00001D48 E80605                  	call	GetExtended		; point to FCB
 13641 00001D4B E8D704                  	call	GetExtent		; DX:AX is current record
 13642                                  	;mov	[si+21h],ax
 13643 00001D4E 894421                  	MOV	[SI+SYS_FCB.RR],AX 	; drop in low order piece
 13644                                  	;mov	[si+23h],dl
 13645 00001D51 885423                  	MOV	[SI+SYS_FCB.RR+2],DL	; drop in high order piece
 13646                                  	;cmp	word [si+0Eh],64
 13647 00001D54 837C0E40                	CMP	word [SI+SYS_FCB.RECSIZ],64
 13648 00001D58 7303                    	JAE	short GetFCBBye
 13649                                  	;mov	[si+24h],dh
 13650 00001D5A 887424                  	MOV	[SI+SYS_FCB.RR+2+1],DH	; Set 4th byte only if record size < 64
 13651                                  GoodPath:	; 16/12/2022
 13652                                  GetFCBBye:
 13653 00001D5D E926E9                  	jmp	FCB_RET_OK
 13654                                  
 13655                                  ;Break <$FCB_Delete - remove several files that match the input FCB>
 13656                                  ;----------------------------------------------------------------------------
 13657                                  ;
 13658                                  ;**	$FCB_Delete - Delete from FCB Template
 13659                                  ;
 13660                                  ;	given an FCB, remove all directory entries in the current
 13661                                  ;	directory that have names that match the FCB's ?  marks.
 13662                                  ;
 13663                                  ;	ENTRY	(DS:DX) = address of FCB
 13664                                  ;	EXIT	entries matching the FCB are deleted
 13665                                  ;		(al) = ff iff no entries were deleted
 13666                                  ;	USES	all
 13667                                  ;
 13668                                  ;----------------------------------------------------------------------------
 13669                                  ;
 13670                                  	; 08/11/2022 Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 13671                                  
 13672                                  _$FCB_DELETE:		; System call 19
 13673                                  					; OpenBuf is in DOSDATA
 13674 00001D60 BF[BE03]                	MOV	DI,OPENBUF 		; appropriate place 
 13675                                  
 13676 00001D63 E8C65E                  	call	TransFCB		; convert FCB to path
 13677 00001D66 7207                    	JC	short BadPath 		; signal no deletions
 13678                                  
 13679 00001D68 16                      	push	SS
 13680 00001D69 1F                      	pop	DS			; SS is DOSDATA
 13681                                  
 13682 00001D6A E8F80D                  	call	DOS_DELETE		; wham
 13683                                  	;JC	short BadPath
 13684                                  	; 16/12/2022
 13685 00001D6D 73EE                    	jnc 	short GoodPath
 13686                                  ;GoodPath:
 13687                                  ;	;jmp	FCB_RET_OK		; do a good return
 13688                                  ;	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13689                                  ;	jmp	short GetFCBBye
 13690                                  
 13691                                  BadPath:
 13692                                  	; Error code is in AX
 13693                                  
 13694 00001D6F E917E9                  	jmp	FCB_RET_ERR		; let someone else signal the error
 13695                                  
 13696                                  ;Break <$Get_FCB_File_Length - return the length of a file>
 13697                                  ;----------------------------------------------------------------------------
 13698                                  ;
 13699                                  ;   $Get_FCB_File_Length - set the random record field to the length of the
 13700                                  ;	file in records (rounded up if partial).
 13701                                  ;
 13702                                  ;   Inputs:	DS:DX - point to a possible extended FCB
 13703                                  ;   Outputs:	Random record field updated to reflect the number of records
 13704                                  ;   Registers modified: all
 13705                                  ;
 13706                                  ;----------------------------------------------------------------------------
 13707                                  ;
 13708                                  	; 15/01/2024 - Retrodos v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 13709                                  
 13710                                  _$GET_FCB_FILE_LENGTH:
 13711                                  
 13712 00001D72 E8DC04                  	call	GetExtended		; get real FCB pointer
 13713                                  					; DX points to Input FCB
 13714                                  
 13715                                  					; OpenBuf is in DOSDATA
 13716 00001D75 BF[BE03]                	MOV	DI,OPENBUF		; appropriate buffer
 13717                                  
 13718 00001D78 1E                      	push	ds			; save pointer to true FCB
 13719 00001D79 56                      	push	si
 13720 00001D7A E8AF5E                  	call	TransFCB		; Trans name DS:DX, sets SATTRIB
 13721 00001D7D 5E                      	pop	si
 13722 00001D7E 1F                      	pop	ds
 13723 00001D7F 72EE                    	JC	short BadPath
 13724 00001D81 1E                      	push	ds			; save pointer
 13725 00001D82 56                      	push	si
 13726 00001D83 16                      	push	ss		
 13727 00001D84 1F                      	pop	ds
 13728 00001D85 E83C12                  	call	GET_FILE_INFO		; grab the info
 13729 00001D88 5E                      	pop	si			; get pointer back
 13730 00001D89 1F                      	pop	ds
 13731 00001D8A 72E3                    	JC	short BadPath 		; invalid something
 13732                                  	; 15/01/2024
 13733                                  	;MOV	DX,BX (*)		; get high order size
 13734                                  	;MOV	AX,DI (**)		; get low order size
 13735 00001D8C 89D8                    	mov	ax,bx ; hw of file size
 13736                                  	;
 13737                                  	;mov	bx,[si+0Eh]
 13738 00001D8E 8B5C0E                  	MOV	BX,[SI+SYS_FCB.RECSIZ]	; get his record size
 13739 00001D91 09DB                    	OR	BX,BX			; empty record => 0 size for file
 13740 00001D93 7502                    	JNZ	short GetSize 		; not empty
 13741                                  	;MOV	BX,128
 13742 00001D95 B380                    	mov	bl,128	; 15/01/2024
 13743                                  GetSize:
 13744                                  	; 15/01/2024
 13745                                  	;MOV	DI,AX			; save low order word
 13746                                  	;MOV	AX,DX			; move high order for divide
 13747                                  	;xchg	ax,dx ; (*)
 13748                                  	; ax = hw of file size
 13749                                  
 13750 00001D97 31D2                    	XOR	DX,DX			; clear out high
 13751 00001D99 F7F3                    	DIV	BX			; wham
 13752 00001D9B 50                      	PUSH	AX			; save dividend
 13753 00001D9C 89F8                    	MOV	AX,DI ; (**)		; get low order piece
 13754 00001D9E F7F3                    	DIV	BX			; wham
 13755 00001DA0 89D1                    	MOV	CX,DX			; save remainder
 13756 00001DA2 5A                      	POP	DX			; get high order dividend
 13757 00001DA3 E306                    	JCXZ	LengthStore		; no roundup
 13758 00001DA5 83C001                  	ADD	AX,1
 13759 00001DA8 83D200                  	ADC	DX,0			; 32-bit increment
 13760                                  LengthStore:
 13761                                  	;mov	[si+21h],ax
 13762 00001DAB 894421                  	MOV	[SI+SYS_FCB.RR],AX	; store low order
 13763                                  	;mov	[si+23h],dl
 13764 00001DAE 885423                  	MOV	[SI+SYS_FCB.RR+2],DL	; store high order
 13765 00001DB1 08F6                    	OR	DH,DH
 13766 00001DB3 74A8                    	JZ	short GoodPath		; not storing insignificant zero
 13767                                  	;mov	[si+24h],dh
 13768 00001DB5 887424                  	MOV	[SI+SYS_FCB.RR+3],DH	; save that high piece
 13769                                  	; 16/12/2022
 13770                                  GoodRet:
 13771                                  	;jmp	FCB_RET_OK
 13772 00001DB8 EBA3                    	jmp	short GoodPath
 13773                                  
 13774                                  ;Break <$FCB_Close - close a file>
 13775                                  ;----------------------------------------------------------------------------
 13776                                  ;
 13777                                  ;   $FCB_Close - given an FCB, look up the SFN and close it. Do not free it
 13778                                  ;	as the FCB may be used for further I/O
 13779                                  ;
 13780                                  ;   Inputs:	DS:DX point to FCB
 13781                                  ;   Outputs:	AL = FF if file was not found on disk
 13782                                  ;   Registers modified: all
 13783                                  ;
 13784                                  ;----------------------------------------------------------------------------
 13785                                  ;
 13786                                  	; 16/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 13787                                  
 13788                                  _$FCB_CLOSE:		; System call 16
 13789                                  
 13790 00001DBA 30C0                    	XOR	AL,AL			; default search attributes
 13791 00001DBC E89204                  	call	GetExtended		; DS:SI point to real FCB
 13792 00001DBF 7403                    	JZ	short NoAttr		; not extended
 13793 00001DC1 8A44FF                  	MOV	AL,[SI-1]		; get attributes
 13794                                  NoAttr:
 13795                                  					; SS override
 13796 00001DC4 36A2[6B05]              	MOV	[SS:ATTRIB],AL		; stash away found attributes
 13797 00001DC8 E8D903                  	call	SFTFromFCB
 13798 00001DCB 72EB                    	JC	short GoodRet 		; MZ 16 Jan Assume death
 13799                                  
 13800                                  	; If the sharer is present, then the SFT is not regenable. Thus, 
 13801                                  	; there is no need to set the SFT's attribute.
 13802                                  
 13803                                  	;;; 9/8/86 F.C. save SFT attribute and restore it back when close is 
 13804                                  	;;; done
 13805                                  
 13806                                  	;mov	al,[es:di+4]
 13807 00001DCD 268A4504                	MOV	AL,[ES:DI+SF_ENTRY.sf_attr]
 13808 00001DD1 30E4                    	XOR	AH,AH
 13809 00001DD3 50                      	PUSH	AX
 13810                                  
 13811                                  	;;; 9/8/86 F.C. save SFT attribute and restore it back when close is 
 13812                                  	;;; done
 13813                                  
 13814 00001DD4 E89066                  	call	CheckShare
 13815 00001DD7 7508                    	JNZ	short NoStash
 13816 00001DD9 36A0[6B05]              	MOV	AL,[SS:ATTRIB]
 13817                                  	;mov	[es:di+4],al
 13818 00001DDD 26884504                	MOV	[ES:DI+SF_ENTRY.sf_attr],AL ; attempted attribute for close
 13819                                  NoStash:
 13820                                  
 13821                                  ; 16/01/2024
 13822                                  %if 0
 13823                                  	;mov	ax,[si+14h]
 13824                                  	MOV	AX,[SI+SYS_FCB.FDATE] ; move in the time and date
 13825                                  	;mov	[es:di+0Fh],ax
 13826                                  	MOV	[ES:DI+SF_ENTRY.sf_date],AX
 13827                                  	;mov	ax,[si+16h]
 13828                                  	MOV	AX,[SI+SYS_FCB.FTIME]
 13829                                  	;mov	[es:di+0Dh],ax
 13830                                  	MOV	[ES:DI+SF_ENTRY.sf_time],AX
 13831                                  	;mov	ax,[si+10h]
 13832                                  	MOV	AX,[SI+SYS_FCB.FILSIZ]
 13833                                  	;mov	[es:di+11h],ax
 13834                                  	MOV	[ES:DI+SF_ENTRY.sf_size],AX
 13835                                  	;mov	ax,[si+12h]
 13836                                  	MOV	AX,[SI+SYS_FCB.FILSIZ+2]
 13837                                  	;mov	[es:di+13h],ax
 13838                                  	MOV	[ES:DI+SF_ENTRY.sf_size+2],AX
 13839                                  	;or	word [es:di+5],4000h
 13840                                  	; 17/12/2022
 13841                                  	or	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_close_nodate>>8) ; 40h
 13842                                  	;OR	word [ES:DI+SF_ENTRY.sf_flags],sf_close_nodate
 13843                                  %else
 13844                                  	; 16/01/2024 (PCDOS 7.1 IBMDOS.COM)
 13845 00001DE1 1E                      	push	ds
 13846                                  	;lds	ax,[si+14h]
 13847 00001DE2 C54414                  	lds	ax,[si+SYS_FCB.FDATE]	; move in the time and date
 13848                                  	;mov	[es:di+0Fh],ax
 13849 00001DE5 2689450F                	mov	[es:di+SF_ENTRY.sf_date],ax
 13850                                  	;mov	[es:di+0Dh],ds		
 13851 00001DE9 268C5D0D                	mov	[es:di+SF_ENTRY.sf_time],ds
 13852 00001DED 1F                      	pop	ds
 13853                                  	;lds	ax,[si+10h]
 13854 00001DEE C54410                  	lds	ax,[si+SYS_FCB.FILSIZ]
 13855                                  	;mov	[es:di+11h],ax
 13856 00001DF1 26894511                	mov	[es:di+SF_ENTRY.sf_size],ax
 13857                                  	;mov	[es:di+13h],ds
 13858 00001DF5 268C5D13                	mov	[es:di+SF_ENTRY.sf_size+2],ds
 13859                                  	; 16/01/2024
 13860                                  	;;or	word [es:di+5],4000h
 13861                                  	;or	word [es:di+SF_ENTRY.sf_flags],sf_close_nodate
 13862 00001DF9 26804D0640              	or	byte [es:di+SF_ENTRY.sf_flags+1],(sf_close_nodate>>8) ; 40h
 13863                                  %endif
 13864                                  
 13865 00001DFE 16                      	push	ss
 13866 00001DFF 1F                      	pop	ds
 13867 00001E00 E81E19                  	call	DOS_CLOSE	; wham
 13868 00001E03 C43E[9E05]              	LES	DI,[THISSFT]
 13869                                  
 13870                                  	;;; 9/8/86 F.C. restore SFT attribute
 13871 00001E07 59                      	POP	CX
 13872                                  	;mov	[es:di+4],cl
 13873 00001E08 26884D04                	MOV	[ES:DI+SF_ENTRY.sf_attr],CL
 13874                                  	;;; 9/8/86 F.C. restore SFT attribute
 13875                                  
 13876 00001E0C 9C                      	PUSHF
 13877                                  	;test	word [es:di],0FFFFh
 13878                                  	;cmp	word [ES:DI+SF_ENTRY.sf_ref_count],0
 13879                                  				; zero ref count gets blasted
 13880 00001E0D 26833D00                	cmp	word [ES:DI],0
 13881 00001E11 7507                    	jnz     short CloseOK
 13882 00001E13 50                      	PUSH	AX
 13883 00001E14 B04D                    	MOV	AL,'M' ; 4Dh
 13884 00001E16 E80503                  	call	BlastSFT
 13885 00001E19 58                      	POP	AX
 13886                                  CloseOK:
 13887 00001E1A 9D                      	POPF
 13888 00001E1B 739B                    	JNC	short GoodRet
 13889                                  	;cmp	al,6
 13890 00001E1D 3C06                    	CMP	AL,error_invalid_handle
 13891 00001E1F 7497                    	JZ	short GoodRet
 13892                                  	;mov	al,2
 13893 00001E21 B002                    	MOV	AL,error_file_not_found
 13894                                  fren90:
 13895                                  	; 16/12/2022
 13896                                  fcb_close_err:
 13897 00001E23 E963E8                  	jmp	FCB_RET_ERR
 13898                                  
 13899                                  ;
 13900                                  ;----------------------------------------------------------------------------
 13901                                  ;
 13902                                  ;**	$FCB_Rename - Rename a File
 13903                                  ;
 13904                                  ;	$FCB_Rename - rename a file in place within a directory. Renames
 13905                                  ;	multiple files copying from the meta characters.
 13906                                  ;
 13907                                  ;	ENTRY	DS:DX point to an FCB. The normal name field is the source
 13908                                  ;		    name of the files to be renamed. Starting at offset 11h
 13909                                  ;		    in the FCB is the destination name.
 13910                                  ;	EXIT	AL = 0 -> no error occurred and all files were renamed
 13911                                  ;		AL = FF -> some files may have been renamed but:
 13912                                  ;			rename to existing file or source file not found
 13913                                  ;	USES	ALL
 13914                                  ;
 13915                                  ;----------------------------------------------------------------------------
 13916                                  ;
 13917                                  	; 08/11/2022 Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 13918                                  	; 16/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 13919                                  
 13920                                  _$FCB_RENAME:		; System call 23
 13921                                  
 13922 00001E26 E82804                  	call	GetExtended		; get pointer to real FCB
 13923 00001E29 52                      	push	dx
 13924 00001E2A 8A04                    	MOV	AL,[SI] 		; get drive byte
 13925 00001E2C 83C610                  	ADD	SI,10h			; point to destination
 13926                                  
 13927                                  					; RenBuf is in DOSDATA
 13928 00001E2F BF[3E04]                	MOV	DI,RENBUF		; point to destination buffer
 13929 00001E32 FF34                    	push	word [SI]
 13930 00001E34 1E                      	push	ds
 13931                                  	;push	di			; save source pointer for TransFCB
 13932                                  	; 16/01/2024 (Retro DOS v4 BugFix!)
 13933 00001E35 56                      	push	si
 13934 00001E36 8804                    	MOV	[SI],AL			; drop in real drive
 13935 00001E38 89F2                    	MOV	DX,SI			; let TransFCB know where the FCB is
 13936 00001E3A E8EF5D                  	call	TransFCB		; munch this pathname
 13937 00001E3D 5E                      	pop	si
 13938 00001E3E 1F                      	pop	ds	
 13939 00001E3F 8F04                    	pop	WORD [SI]		; get path back
 13940 00001E41 5A                      	pop	dx			; Original FCB pointer
 13941 00001E42 72DF                    	JC	short fren90		; bad path -> error
 13942                                  
 13943                                  					; SS override for WFP_Start & Ren_WFP
 13944 00001E44 368B36[B205]            	MOV	SI,[ss:WFP_START]	; get pointer
 13945 00001E49 368936[B405]            	MOV	[ss:REN_WFP],SI		; stash it
 13946                                  
 13947                                  					; OpenBuf is in DOSDATA
 13948 00001E4E BF[BE03]                	MOV	DI,OPENBUF		; appropriate spot
 13949 00001E51 E8D85D                  	call	TransFCB		; wham
 13950                                  					; NOTE that this call is pointing
 13951                                  					;  back to the ORIGINAL FCB so
 13952                                  					;  SATTRIB gets set correctly
 13953 00001E54 72CD                    	JC	short fren90		; error
 13954                                  	;;;
 13955                                  	; 16/01/2024 - Retro DOS 5.0
 13956                                  	; (PCDOS 7.1 IBMDOS.COM)
 13957 00001E56 36C606[5411]43          	mov	byte [ss:PATHNAMELEN], 67 ; DIRSTRLEN = 67
 13958                                  	;mov	word [ss:PATHNAMELEN], 67 ; set pathname length to 67
 13959                                  	;;;
 13960 00001E5C E8190F                  	call	DOS_RENAME
 13961 00001E5F 72C2                    	JC	short fren90
 13962                                  	; 16/12/2022
 13963 00001E61 E922E8                  	jmp	FCB_RET_OK
 13964                                  	
 13965                                  ;	Error -
 13966                                  ;
 13967                                  ;	(al) = error code
 13968                                  
 13969                                  	; 16/12/2022
 13970                                  ;fren90:	
 13971                                  ;	;jmp	FCB_RET_ERR
 13972                                  ;	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13973                                  ;	jmp	short fcb_close_err
 13974                                  
 13975                                  ;Break <Misbehavior fixers>
 13976                                  ;
 13977                                  ;   FCBs suffer from several problems. First, they are maintained in the
 13978                                  ;   user's space so he may move them at will. Second, they have a small
 13979                                  ;   reserved area that may be used for system information. Third, there was
 13980                                  ;   never any "rules for behavior" for FCBs; there was no protocol for their
 13981                                  ;   usage.
 13982                                  ;
 13983                                  ;   This results in the following misbehavior:
 13984                                  ;
 13985                                  ;	infinite opens of the same file:
 13986                                  ;
 13987                                  ;	While (TRUE) {			While (TRUE) {
 13988                                  ;	    FCBOpen (FCB);		    FCBOpen (FCB);
 13989                                  ;	    Read (FCB); 		    Write (FCB);
 13990                                  ;	    }				    }
 13991                                  ;
 13992                                  ;	infinite opens of different files:
 13993                                  ;
 13994                                  ;	While (TRUE) {			While (TRUE) {
 13995                                  ;	    FCBOpen (FCB[i++]); 	    FCBOpen (FCB[i++]);
 13996                                  ;	    Read (FCB); 		    Write (FCB);
 13997                                  ;	    }				    }
 13998                                  ;
 13999                                  ;	multiple closes of the same file:
 14000                                  ;
 14001                                  ;	FCBOpen (FCB);
 14002                                  ;	while (TRUE)
 14003                                  ;	    FCBClose (FCB);
 14004                                  ;
 14005                                  ;	I/O after closing file:
 14006                                  ;
 14007                                  ;	FCBOpen (FCB);
 14008                                  ;	while (TRUE) {
 14009                                  ;	    FCBWrite (FCB);
 14010                                  ;	    FCBClose (FCB);
 14011                                  ;	    }
 14012                                  ;
 14013                                  ;   The following is am implementation of a methodology for emulating the
 14014                                  ;   above with the exception of I/O after close. We are NOT attempting to
 14015                                  ;   resolve that particular misbehavior. We will enforce correct behaviour in
 14016                                  ;   FCBs when they refer to a network file or when there is file sharing on
 14017                                  ;   the local machine.
 14018                                  ;
 14019                                  ;   The reserved fields of the FCB (10 bytes worth) is divided up into various
 14020                                  ;   structures depending on the file itself and the state of operations of the
 14021                                  ;   OS. The information contained in this reserved field is enough to
 14022                                  ;   regenerate the SFT for the local non-shared file. It is assumed that this
 14023                                  ;   regeneration procedure may be expensive. The SFT for the FCB is
 14024                                  ;   maintained in a LRU cache as the ONLY performance inprovement.
 14025                                  ;
 14026                                  ;   No regeneration of SFTs is attempted for network FCBs.
 14027                                  ;
 14028                                  ;   To regenerate the SFT for a local FCB, it is necessary to determine if the
 14029                                  ;   file sharer is working. If the file sharer is present then the SFT is not
 14030                                  ;   regenerated.
 14031                                  ;
 14032                                  ;   Finally, if there is no local sharing, the full name of the file is no
 14033                                  ;   longer available. We can make up for this by using the following
 14034                                  ;   information:
 14035                                  ;
 14036                                  ;	The Drive number (from the DPB).
 14037                                  ;	The physical sector of the directory that contains the entry.
 14038                                  ;	The relative position of the entry in the sector.
 14039                                  ;	The first cluster field.
 14040                                  ;	The last used SFT.
 14041                                  ;      OR In the case of a device FCB
 14042                                  ;	The low 6 bits of sf_flags (indicating device type)
 14043                                  ;	The pointer to the device header
 14044                                  ;
 14045                                  ;   We read in the particular directory sector and examine the indicated
 14046                                  ;   directory entry. If it matches, then we are kosher; otherwise, we fail.
 14047                                  ;
 14048                                  ;   Some key items need to be remembered:
 14049                                  ;
 14050                                  ;	Even though we are caching SFTs, they may contain useful sharing
 14051                                  ;	information. We enforce good behavior on the FCBs.
 14052                                  ;
 14053                                  ;	Network support must not treat FCBs as impacting the ref counts on
 14054                                  ;	open VCs. The VCs may be closed only at process termination.
 14055                                  ;
 14056                                  ;	If this is not an installed version of the DOS, file sharing will
 14057                                  ;	always be present.
 14058                                  ;
 14059                                  ;	We MUST always initialize lstclus to = firclus when regenerating a
 14060                                  ;	file. Otherwise we start allocating clusters up the wazoo.
 14061                                  ;
 14062                                  ;	Always initialize, during regeneration, the mode field to both isFCB
 14063                                  ;	and open_for_both. This is so the FCB code in the sharer can find the
 14064                                  ;	proper OI record.
 14065                                  ;
 14066                                  ;   The test bits are:
 14067                                  ;
 14068                                  ;	00 -> local file
 14069                                  ;	40 -> sharing local
 14070                                  ;	80 -> network
 14071                                  ;	C0 -> local device
 14072                                  
 14073                                  ;Break	<SaveFCBInfo - store pertinent information from an SFT into the FCB>
 14074                                  ;----------------------------------------------------------------------------
 14075                                  ;
 14076                                  ;   SaveFCBInfo - given an FCB and its associated SFT, copy the relevant
 14077                                  ;	pieces of information into the FCB to allow for subsequent
 14078                                  ;	regeneration. Poke LRU also.
 14079                                  ;
 14080                                  ;   Inputs:	ThisSFT points to a complete SFT.
 14081                                  ;		DS:SI point to the FCB (not an extended one)
 14082                                  ;   Outputs:	The relevant reserved fields in the FCB are filled in.
 14083                                  ;		DS:SI preserved
 14084                                  ;		ES:DI point to sft
 14085                                  ;   Registers modified: All
 14086                                  ;
 14087                                  ;
 14088                                  ;----------------------------------------------------------------------------
 14089                                  ;
 14090                                  
 14091                                  	; 08/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 14092                                  	; 20/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 14093                                  	
 14094                                  SaveFCBInfo:
 14095                                  
 14096 00001E64 36C43E[9E05]            	LES	DI,[SS:THISSFT]		; SS override
 14097 00001E69 E8CEF9                  	call	IsSFTNet
 14098 00001E6C 740B                    	JZ	short SaveLocal		; if not network then save local info
 14099                                  ;
 14100                                  ;----- In net support -----
 14101                                  ;
 14102                                  	; 17/05/2019 - Retro DOS v4.0
 14103                                  
 14104                                  	; MSDOS 3.3
 14105                                  	;;mov	ax,[es:di+1Dh]
 14106                                  	;mov	ax,[es:di+SF_ENTRY.sf_dirsec]
 14107                                  	;;mov	[si+1Ah],ax
 14108                                  	;mov	[si+fcb_net_handle],ax
 14109                                  	;push	es
 14110                                  	;push	di
 14111                                  	;;les	di,[es:di+19h]
 14112                                  	;LES	DI,[ES:DI+sf_netid]
 14113                                  	;;mov	[si+1Ch],di
 14114                                  	;MOV	[SI+fcb_netID],DI	; save net ID
 14115                                  	;;mov 	[si+1Eh],es
 14116                                  	;MOV	[SI+fcb_netID+2],ES
 14117                                  	;pop	di
 14118                                  	;pop	es
 14119                                  
 14120                                  	; MSDOS 6.0
 14121                                  	;mov	ax,[es:di+0Bh]
 14122 00001E6E 268B450B                	MOV	AX,[ES:DI+sf_serial_ID] ;AN000;;IFS. save IFS ID
 14123                                  	;mov	[si+1Ch],ax
 14124 00001E72 89441C                  	MOV	[SI+fcb_netID],ax	;AN000;;IFS.
 14125                                  	
 14126                                  	;mov	bl,80h
 14127 00001E75 B380                    	MOV	BL,FCBNETWORK
 14128                                  ;
 14129                                  ;----- END In net support -----
 14130                                  ;
 14131 00001E77 EB63                    	jmp	SHORT SaveSFN
 14132                                  
 14133                                  SaveLocal:
 14134                                  	;IF	Installed
 14135 00001E79 E8EB65                  	call	CheckShare
 14136                                  	;JZ	short SaveNoShare	; no sharer
 14137                                  	;JMP	short SaveShare		; sharer present
 14138                                  	; 16/12/2022
 14139                                  	; 28/07/2019
 14140 00001E7C 7559                    	jnz	short SaveShare
 14141                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 14142                                  	;JZ	short SaveNoShare	; no sharer
 14143                                  	;JMP	short SaveShare		; sharer present
 14144                                  
 14145                                  SaveNoShare:
 14146                                  	;;test 	word [es:di+5],80h
 14147                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device
 14148 00001E7E 26F6450580              	test	byte [ES:DI+SF_ENTRY.sf_flags],devid_device ; 80h	
 14149 00001E83 7542                    	JNZ	short SaveNoShareDev	; Device
 14150                                  
 14151                                  	; Save no sharing local file information
 14152                                  
 14153                                  	;;mov	ax,[es:di+1Dh]  ; MSDOS 3.3
 14154                                  	;mov	ax,[es:di+1Bh]  ; MSDOS 6.0
 14155 00001E85 268B451B                	MOV	AX,[ES:DI+SF_ENTRY.sf_dirsec] ; get directory sector F.C.
 14156                                  	;mov	[si+1Dh],ax
 14157 00001E89 89441D                  	MOV	[SI+fcb_nsl_dirsec],AX
 14158                                  
 14159                                  	; MSDOS 6.0
 14160                                  
 14161                                  	;SR; Store high byte of directory sector
 14162                                  	;mov	ax,[es:di+1Dh]
 14163 00001E8C 268B451D                	mov	ax,[es:di+SF_ENTRY.sf_dirsec+2] ; get high word
 14164                                  	
 14165                                  	; SR;
 14166                                  	; We have to store the read-only and archive attributes of the file.
 14167                                  	; We extract it from the SFT and store it in the top two bits of the 
 14168                                  	; sector number ( sector number == 22 bits only )
 14169                                  
 14170                                  	;mov	bl,[es:di+4]
 14171 00001E90 268A5D04                	mov	bl,[es:di+SF_ENTRY.sf_attr]
 14172 00001E94 88DF                    	mov	bh,bl
 14173 00001E96 D0CB                    	ror	bl,1
 14174 00001E98 D0E7                    	shl	bh,1
 14175 00001E9A 08FB                    	or	bl,bh
 14176 00001E9C 80E3C0                  	and	bl,0C0h
 14177 00001E9F 08D8                    	or	al,bl
 14178                                  	;mov	[si+18h],al ; 08/11/2022
 14179 00001EA1 884418                  	mov	[si+fcb_sfn],al	; sector number = 22 bits
 14180                                  
 14181                                  	; MSDOS 6.0 (& MSDOS 3.3)
 14182                                  	;mov	al,[es:di+1Fh]
 14183 00001EA4 268A451F                	MOV	AL,[ES:DI+SF_ENTRY.sf_dirpos] ; location in sector
 14184                                  	;mov	[si+1Fh],al
 14185 00001EA8 88441F                  	MOV	[SI+fcb_nsl_dirpos],AL
 14186                                  
 14187                                  	; 20/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 14188                                  	;;;
 14189                                  	;;mov	ax,[es:di+0Bh]	; .sf_firclus:
 14190                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_firclus] ; first cluster
 14191                                  	; 20/01/2024
 14192                                  	; (PCDOS 7.1 IBMDOS.COM - DOSCODE:5DF5h)
 14193                                  	; (Windows ME IO.SYS - BIOSCODE:5D60h)
 14194 00001EAB 268B452B                	mov	ax,[es:di+2Bh]  ; .sf_chain !!! (MSDOS 6.22)
 14195                                  	;mov	ax,[es:di+SF_ENTRY.sf_chain] ; first cluster (32 bit) !?
 14196                                  	;;;
 14197                                  	;mov	[si+1Bh],ax
 14198 00001EAF 89441B                  	MOV	[SI+fcb_nsl_firclus],AX
 14199 00001EB2 B300                    	MOV	BL,0
 14200                                  
 14201                                  	; Create the bits field from the dirty/device bits of the flags word 
 14202                                  	; and the mode byte
 14203                                  
 14204                                  SetFCBBits:
 14205                                  	;mov	ax,[es:di+5]
 14206 00001EB4 268B4505                	MOV	AX,[ES:DI+SF_ENTRY.sf_flags]
 14207 00001EB8 24C0                    	AND	AL,0C0h 		; mask off drive bits
 14208                                  	;or	al,[es:di+2]
 14209 00001EBA 260A4502                	OR	AL,[ES:DI+SF_ENTRY.sf_mode] ; stick in open mode
 14210                                  	;mov	[si+1Ah], al
 14211 00001EBE 88441A                  	MOV	[SI+fcb_nsl_bits],AL	; save dirty info
 14212                                  
 14213                                  	; MSDOS 6.0
 14214                                  	
 14215                                  	; SR;
 14216                                  	; Check if we came here for local file or device. If for local file, 
 14217                                  	; skip setting of SFT index
 14218                                  	
 14219 00001EC1 08DB                    	or	bl,bl
 14220 00001EC3 7428                    	jz	short SaveNoSFN		; do not save SFN if local file
 14221                                  
 14222 00001EC5 EB15                    	JMP	short SaveSFN 		; go and save SFN
 14223                                  
 14224                                  	; Save no sharing local device information
 14225                                  
 14226                                  SaveNoShareDev:
 14227                                  	; 20/01/2024
 14228                                  	;;mov	ax,[es:di+7]
 14229                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_devptr]
 14230                                  	;;mov	[si+1Ah],ax
 14231                                  	;MOV	[SI+fcb_nsld_drvptr],AX
 14232                                  	;;mov	ax,[es:di+9]
 14233                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_devptr+2]
 14234                                  	;MOV	[SI+fcb_nsld_drvptr+2],AX
 14235                                  	; 20/01/2024 (PCDOS 7.1 IBMDOS.COM)
 14236 00001EC7 06                      	push	es
 14237 00001EC8 26C44507                	les	ax,[es:di+SF_ENTRY.sf_devptr]
 14238 00001ECC 89441A                  	mov	[si+fcb_nsld_drvptr],ax
 14239 00001ECF 8C441C                  	mov	[si+fcb_nsld_drvptr+2],es
 14240 00001ED2 07                      	pop	es
 14241                                  	
 14242                                  	;mov	bl,40h
 14243 00001ED3 B340                    	MOV	BL,FCBDEVICE
 14244                                  	; 28/12/2022
 14245 00001ED5 EBDD                    	JMP	short SetFCBBits	; go and save SFN
 14246                                  
 14247                                  SaveShare:
 14248                                  	;ENDIF
 14249                                  
 14250                                  ;----- In share support -----
 14251                                  
 14252                                  	;call	far [ss:ShSave]
 14253 00001ED7 36FF1E[B800]            	Call	far [ss:JShare+(10*4)] ; 10 = ShSave ; SS Override
 14254                                  
 14255                                  ;----- end in share support -----
 14256                                  
 14257                                  	; 17/05/2019
 14258                                  
 14259                                  SaveSFN:
 14260                                  	;lea	ax,[di-6]
 14261 00001EDC 8D45FA                  	LEA	AX,[DI-SFT.SFTable]
 14262                                  	
 14263                                  	; Adjust for offset to table.
 14264                                  	
 14265 00001EDF 362B06[4000]            	SUB	AX,[SS:SFTFCB]		; SS override for SftFCB
 14266                                  
 14267 00001EE4 53                      	push	bx			;bx = FCB type (net/Share or local)
 14268                                  	;;mov	bl,53 ; MSDOS 3.3
 14269                                  	;mov	bl,59 ; MSDOS 6.0
 14270 00001EE5 B33B                    	MOV	BL,SF_ENTRY.size
 14271 00001EE7 F6F3                    	DIV	BL
 14272                                  	;mov	[si+18h],al
 14273 00001EE9 884418                  	MOV	[SI+fcb_sfn],AL		; last used SFN
 14274 00001EEC 5B                      	pop	bx			;restore bx
 14275                                  
 14276                                  SaveNoSFN:
 14277                                  	;mov	ax,[es:di+5]
 14278 00001EED 268B4505                	MOV	AX,[ES:DI+SF_ENTRY.sf_flags]
 14279 00001EF1 243F                    	AND	AL,3Fh			; get real drive
 14280 00001EF3 08D8                    	OR	AL,BL
 14281                                  	;mov	[si+19h],al
 14282 00001EF5 884419                  	MOV	[SI+fcb_l_drive],AL
 14283                                  
 14284 00001EF8 36A1[1000]              	MOV	AX,[SS:FCBLRU]		; get lru count
 14285 00001EFC 40                      	INC	AX
 14286                                  	;mov	[es:di+15h],ax
 14287 00001EFD 26894515                	MOV	[ES:DI+sf_LRU],AX
 14288 00001F01 7506                    	JNZ	short SimpleStuff
 14289                                  	
 14290                                  	; lru flag overflowed. Run through all FCB sfts and adjust:  
 14291                                  	; LRU < 8000H get set to 0. Others -= 8000h. This LRU = 8000h
 14292                                  	
 14293                                  	;mov	bx,15h
 14294 00001F03 BB1500                  	MOV	BX,SF_ENTRY.sf_position
 14295 00001F06 E80500                  	call	ResetLRU
 14296                                  
 14297                                  	; Set new LRU to AX
 14298                                  SimpleStuff:
 14299 00001F09 36A3[1000]              	MOV	[SS:FCBLRU],AX
 14300 00001F0D C3                      	retn
 14301                                  
 14302                                  ;Break	<ResetLRU - reset overflowed lru counts>
 14303                                  ;----------------------------------------------------------------------------
 14304                                  ;
 14305                                  ;   ResetLRU - during lru updates, we may wrap at 64K. We must walk the
 14306                                  ;   entire set of SFTs and subtract 8000h from their lru counts and truncate
 14307                                  ;   at 0.
 14308                                  ;
 14309                                  ;   Inputs:	BX is offset into SFT field where lru firld is kept
 14310                                  ;		ES:DI point to SFT currently being updated
 14311                                  ;   Outputs:	All FCB SFTs have their lru fields truncated
 14312                                  ;		AX has 8000h
 14313                                  ;   Registers modified: none
 14314                                  ;
 14315                                  ;----------------------------------------------------------------------------
 14316                                  ;
 14317                                  
 14318                                  	; 17/05/2019 - Retro DOS v4.0
 14319                                  ResetLRU:
 14320                                  	; ResetLRU is only called from fcbio.asm. So SS can be assumed to be 
 14321                                  	; DOSDATA
 14322                                  
 14323 00001F0E B80080                  	MOV	AX,8000h
 14324 00001F11 06                      	push	es
 14325 00001F12 57                      	push	di
 14326                                  	;LES	DI,[CS:SFTFCB]		; get pointer to head
 14327 00001F13 36C43E[4000]            	LES	DI,[SS:SFTFCB] ; MSDOS 6.0
 14328                                  	;mov	cx,[es:di+4]
 14329 00001F18 268B4D04                	MOV	CX,[ES:DI+SFT.SFCount]
 14330                                  	;lea	di,[di+6]
 14331 00001F1C 8D7D06                  	LEA	DI,[DI+SFT.SFTable] 	; point at table
 14332                                  ovScan:
 14333 00001F1F 262901                  	SUB	[ES:DI+BX],AX		; decrement lru count
 14334 00001F22 7703                    	JA	short ovLoop
 14335 00001F24 268901                  	MOV	[ES:DI+BX],AX		; truncate at 0
 14336                                  ovLoop:
 14337                                  	;;add	di,53	; MSDOS 3.3
 14338                                  	;add	di,59	; MSDOS 6.0	
 14339 00001F27 83C73B                  	ADD	DI,SF_ENTRY.size	; advance to next
 14340 00001F2A E2F3                    	LOOP	ovScan
 14341 00001F2C 5F                      	pop	di
 14342 00001F2D 07                      	pop	es
 14343 00001F2E 268901                  	MOV	[ES:DI+BX],AX
 14344 00001F31 C3                      	retn
 14345                                  
 14346                                  ;IF  0  ; We dont need this routine any more.
 14347                                  ;
 14348                                  ;Break	<SetOpenAge - update the open age of a SFT>
 14349                                  ;----------------------------------------------------------------------------
 14350                                  ;
 14351                                  ;   SetOpenAge - In order to maintain the first N open files in the FCB cache,
 14352                                  ;   we keep the 'open age' or an LRU count based on opens. We update the
 14353                                  ;   count here and fill in the appropriate field.
 14354                                  ;
 14355                                  ;   Inputs:	ES:DI point to SFT
 14356                                  ;   Outputs:	ES:DI has the open age field filled in.
 14357                                  ;		If open age has wraparound, we will have subtracted 8000h
 14358                                  ;		    from all open ages.
 14359                                  ;   Registers modified: AX
 14360                                  ;
 14361                                  ;----------------------------------------------------------------------------
 14362                                  ;
 14363                                  ;SetOpenAge:
 14364                                  ;	; 20/07/2018 - Retro DOS v3.0
 14365                                  ;	; MSDOS 3.3 - IBMDOS.COM, Offset 2597h 
 14366                                  ;	; (& MSDOS 6.0, FCBIO.ASM)
 14367                                  ;
 14368                                  ;	; SetOpenAge is called from fcbio2.asm. SS can be assumed to be valid.
 14369                                  ;
 14370                                  ;	MOV	AX,[CS:OpenLRU]	; SS override
 14371                                  ;	INC	AX
 14372                                  ;	;mov	[es:di+17h],ax
 14373                                  ;	MOV	[ES:DI+sf_OpenAge],AX
 14374                                  ;	JNZ	short SetDone
 14375                                  ;	;mov	bx,17h
 14376                                  ;	MOV	BX,SF_ENTRY.sf_position+2 ; mov bx,sf_OpenAge
 14377                                  ;	call	ResetLRU
 14378                                  ;SetDone:
 14379                                  ;	MOV	[CS:OpenLRU],AX
 14380                                  ;	retn
 14381                                  ;
 14382                                  ;ENDIF	; SetOpenAge no longer needed
 14383                                  
 14384                                  ; 21/07/2018 - Retro DOS v3.0
 14385                                  ; LRUFCB for MSDOS 6.0 !
 14386                                  
 14387                                  ;Break	<LRUFCB - perform LRU on FCB sfts>
 14388                                  ;----------------------------------------------------------------------------
 14389                                  ;
 14390                                  ;   LRUFCB - find LRU fcb in cache. Set ThisSFT and return it. We preserve
 14391                                  ;	the first keepcount sfts if they are network sfts or if sharing is
 14392                                  ;	loaded.  If carry is set then NO BLASTING is NECESSARY.
 14393                                  ;
 14394                                  ;   Inputs:	none
 14395                                  ;   Outputs:	ES:DI point to SFT
 14396                                  ;		ThisSFT points to SFT
 14397                                  ;		SFT is zeroed
 14398                                  ;		Carry set of closes failed
 14399                                  ;   Registers modified: none
 14400                                  ;
 14401                                  ;----------------------------------------------------------------------------
 14402                                  ;
 14403                                  ; MSDOS 6.0
 14404                                  ;IF 0	; rewritten this routine
 14405                                  ;
 14406                                  ;LRUFCB: ; MSDOS 3.3 - IBMDOS.COM (1987) - Offset 25ADh
 14407                                  ;	call	save_world
 14408                                  ;	
 14409                                  ; Find nth oldest NET/SHARE FCB. We want to find its age for the second scan
 14410                                  ; to find the lease recently used one that is younger than the open age.  We
 14411                                  ; operate be scanning the list n times finding the least age that is greater
 14412                                  ; or equal to the previous minimum age.
 14413                                  ;
 14414                                  ;   BP is the count of times we need to go through this loop.
 14415                                  ;   AX is the current acceptable minimum age to consider
 14416                                  ;
 14417                                  ;	mov	bp,[CS:KEEPCOUNT]	; k = keepcount;
 14418                                  ;	XOR	AX,AX			; low = 0;
 14419                                  ;
 14420                                  ; If we've scanned the table n times, then we are done.
 14421                                  ;
 14422                                  ;lru1:
 14423                                  ;	CMP	bp,0			; while (k--) {
 14424                                  ;	JZ	short lru75
 14425                                  ;	DEC	bp
 14426                                  ;
 14427                                  ; Set up for scan.
 14428                                  ;
 14429                                  ;   AX is the minimum age for consideration
 14430                                  ;   BX is the minimum age found during the scan
 14431                                  ;   SI is the position of the entry that corresponds to BX
 14432                                  ;
 14433                                  ;	MOV	BX,-1			;     min = 0xffff;
 14434                                  ;	MOV	si,BX			;     pos = 0xffff;
 14435                                  ;	LES	DI,[CS:SFTFCB]		;     for (CX=FCBCount; CX>0; CX--)
 14436                                  ;	;mov	cx,[es:di+4]
 14437                                  ;	MOV	CX,[ES:DI+SFT.SFCount]
 14438                                  ;	;lea	di,[di+6]
 14439                                  ;	LEA	DI,[DI+SFT.SFTable]
 14440                                  ;
 14441                                  ; Innermost loop.  If the current entry is free, then we are done.  Or, if the
 14442                                  ; current entry is busy (indicating a previous aborted allocation), then we
 14443                                  ; are done.  In both cases, we use the found entry.
 14444                                  ;
 14445                                  ;lru2:
 14446                                  ;	cmp	word [es:di],0
 14447                                  ;	;cmp	word [es:di+SF_ENTRY.sf_ref_count],0
 14448                                  ;	jz	short lru25
 14449                                  ;	;cmp	word [es:di],-1
 14450                                  ;	;cmp	word [es:di+SF_ENTRY.sf_ref_count],sf_busy
 14451                                  ;	cmp	word [es:di],sf_busy
 14452                                  ;	jnz	short lru3
 14453                                  ;
 14454                                  ; The entry is usable without further scan.  Go and use it.
 14455                                  ;
 14456                                  ;lru25:
 14457                                  ;	MOV	si,DI			;	      pos = i;
 14458                                  ;	JMP	short lru11		;	      goto got;
 14459                                  ;
 14460                                  ; See if the entry is for the network or for the sharer.
 14461                                  ;
 14462                                  ;  If for the sharer or network then
 14463                                  ;	if the age < current minimum AND >= allowed minimum then
 14464                                  ;	    this entry becomes current minimum
 14465                                  ;
 14466                                  ;lru3:
 14467                                  ;	;test	word [es:di+5],8000h
 14468                                  ;	TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet 
 14469                                  ;					;	  if (!net[i]
 14470                                  ;	JNZ	short lru35
 14471                                  ;if installed
 14472                                  ;	call	CheckShare		;		&& !sharing)
 14473                                  ;	JZ	short lru5		;	  else
 14474                                  ;ENDIF
 14475                                  ;
 14476                                  ; This SFT is for the net or is for the sharer. See if it less than the
 14477                                  ; current minimum.
 14478                                  ;
 14479                                  ;lru35:
 14480                                  ;	;mov	dx,[es:di+17h]
 14481                                  ;	MOV	DX,[ES:DI+sf_OpenAge]
 14482                                  ;	CMP	DX,AX			;	  if (age[i] >= low &&
 14483                                  ;	JB	short lru5
 14484                                  ;	CMP	DX,BX
 14485                                  ;	JAE	short lru5		;	      age[i] < min) {
 14486                                  ;
 14487                                  ; entry is new minimum.  Remember his age.
 14488                                  ;
 14489                                  ;	mov	bx,DX			;	      min = age[i];
 14490                                  ;	mov	si,di			;	      pos = i;
 14491                                  ;
 14492                                  ; End of loop.	gp back for more
 14493                                  ;
 14494                                  ;lru5:
 14495                                  ;	;add	di,53
 14496                                  ;	add	di,SF_ENTRY.size
 14497                                  ;	loop	lru2			;	      }
 14498                                  ;
 14499                                  ; The scan is complete. If we have successfully found a new minimum (pos != -1)
 14500                                  ; set then threshold value to this new minimum + 1. Otherwise, the scan is
 14501                                  ; complete.  Go find LRU.
 14502                                  ;
 14503                                  ;lru6:	
 14504                                  ;	cmp	si,-1			; position not -1?
 14505                                  ;	jz	short lru75		; no, done with everything
 14506                                  ;	lea	ax,[bx+1]		; set new threshold age
 14507                                  ;	jmp	short lru1		; go and loop for more
 14508                                  ;lru65:	
 14509                                  ;	stc
 14510                                  ;	jmp	short LRUDead		;	  return -1;
 14511                                  ;
 14512                                  ; Main loop is done. We have AX being the age+1 of the nth oldest sharer or
 14513                                  ; network entry. We now make a second pass through to find the LRU entry
 14514                                  ; that is local-no-share or has age >= AX
 14515                                  ;
 14516                                  ;lru75:
 14517                                  ;	mov	bx,-1			; min = 0xffff;
 14518                                  ;	mov	si,bx			; pos = 0xffff;
 14519                                  ;	LES	DI,[CS:SFTFCB]		; for (CX=FCBCount; CX>0; CX--)
 14520                                  ;	;mov	cx,[es:di+4]
 14521                                  ;	MOV	CX,[ES:DI+SFT.SFCount]
 14522                                  ;	;lea	di,[di+6]
 14523                                  ;	LEA	DI,[DI+SFT.SFTable]
 14524                                  ;
 14525                                  ; If this is is local-no-share then go check for LRU else if age >= threshold
 14526                                  ; then check for lru.
 14527                                  ;
 14528                                  ;lru8:
 14529                                  ;	;test	word [es:di+5],8000h
 14530                                  ;	TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 14531                                  ;	jnz	short lru85		; is for network, go check age
 14532                                  ;	call	CheckShare		; sharer here?
 14533                                  ;	jz	short lru86		; no, go check lru
 14534                                  ;
 14535                                  ; Network or sharer.  Check age
 14536                                  ;
 14537                                  ;lru85:
 14538                                  ;	;cmp	[es:di+17h],ax
 14539                                  ;	cmp	[es:di+sf_OpenAge],ax
 14540                                  ;	jb	short lru9		; age is before threshold, skip it
 14541                                  ;
 14542                                  ; Check LRU
 14543                                  ;
 14544                                  ;lru86:
 14545                                  ;	;cmp	[es:di+15h],bx
 14546                                  ;	cmp	[es:di+sf_LRU],bx	; is LRU less than current LRU?
 14547                                  ;	jae	short lru9		; no, skip this
 14548                                  ;	mov	si,di			; remember position
 14549                                  ;	;mov	bx,[es:di+15h]
 14550                                  ;	mov	bx,[es:di+sf_LRU]	; remember new minimum LRU
 14551                                  ;
 14552                                  ; Done with this entry, go back for more.
 14553                                  ;
 14554                                  ;lru9:
 14555                                  ;	;add	di, 53
 14556                                  ;	add	di,SF_ENTRY.size
 14557                                  ;	loop	lru8
 14558                                  ;
 14559                                  ; Scan is complete. If we found NOTHING that satisfied us then we bomb
 14560                                  ; out. The conditions here are:
 14561                                  ;
 14562                                  ;  No local-no-shares AND all net/share entries are older than threshold
 14563                                  ;
 14564                                  ;lru10:
 14565                                  ;	cmp	si,-1			; if no one f
 14566                                  ;	jz	short lru65		;     return -1;
 14567                                  ;lru11:
 14568                                  ;	mov	di,si
 14569                                  ;	MOV	[CS:THISSFT],DI		; set thissft
 14570                                  ;	MOV	[CS:THISSFT+2],ES
 14571                                  ;
 14572                                  ; If we have sharing or thisSFT is a net sft, then close it until ref count
 14573                                  ; is 0.
 14574                                  ;
 14575                                  ;	;test	word [es:di+5],8000h
 14576                                  ;	TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 14577                                  ;	JNZ	short LRUClose
 14578                                  ;IF INSTALLED
 14579                                  ;	call	CheckShare
 14580                                  ;	JZ	short LRUDone
 14581                                  ;ENDIF
 14582                                  ;
 14583                                  ; Repeat close until ref count is 0
 14584                                  ;
 14585                                  ;LRUClose:
 14586                                  ;	push	ss
 14587                                  ;	pop	ds
 14588                                  ;	LES	DI,[THISSFT]
 14589                                  ;	cmp     word [es:di],0
 14590                                  ;	;CMP	word [ES:DI+SFT.sf_ref_count],0 ; is ref count still <> 0?
 14591                                  ;	JZ	short LRUDone 		; nope, all done
 14592                                  ;	call	DOS_CLOSE
 14593                                  ;	jnc	short LRUClose		; no error => clean up
 14594                                  ;	;cmp	al,6
 14595                                  ;	cmp	al,error_invalid_handle
 14596                                  ;	jz	short LRUClose
 14597                                  ;	stc
 14598                                  ;	JMP	short LRUDead
 14599                                  ;LRUDone:
 14600                                  ;	XOR	AL,AL
 14601                                  ;	call	BlastSFT		; fill SFT with 0 (AL), 'C' cleared
 14602                                  ;
 14603                                  ;LRUDead:
 14604                                  ;	call	restore_world
 14605                                  ;	LES     DI,[CS:THISSFT]
 14606                                  ;	jnc	short LRUFCB_retn
 14607                                  ;LRUFCB_err:
 14608                                  ;	; mov	al, 23h	
 14609                                  ;	MOV	AL,error_FCB_unavailable
 14610                                  ;LRUFCB_retn:	
 14611                                  ;	retn:
 14612                                  ;
 14613                                  ;ENDIF	; LRUFCB has been rewritten below.
 14614                                  
 14615                                  ; 17/05/2019 - Retro DOS v4.0
 14616                                  ; LRUFCB for MSDOS 6.0 !
 14617                                  ;----------------------------------------------------------------------------
 14618                                  ;
 14619                                  ; LruFCB -- allocate the LRU SFT from the SFT Table. The LRU scheme
 14620                                  ; maintains separate counts for net/Share and local SFTs. We allocate a 
 14621                                  ; net/Share SFT only if we do not find a local SFT. This helps keep
 14622                                  ; net/Share SFTs which cannot be regenerated for as long as possible. We
 14623                                  ; optimize regeneration operations by keeping track of the current local
 14624                                  ; SFT. This avoids scanning of the SFTs as long as we have at least one 
 14625                                  ; local SFT in the SFT Block.
 14626                                  ;
 14627                                  ; Inputs: al = 0 => Regenerate SFT operation
 14628                                  ;	    = 1 => Allocate new SFT for Open/Create
 14629                                  ;
 14630                                  ; Outputs: Carry clear
 14631                                  ;	 	es:di = Address of allocated SFT
 14632                                  ;	  	ThisSFT = Address of allocated SFT
 14633                                  ;
 14634                                  ;	  carry set if closes of net/Share files failed 
 14635                                  ;		al = error_FCB_unavailable
 14636                                  ;
 14637                                  ; Registers affected: None
 14638                                  ;
 14639                                  ;----------------------------------------------------------------------------
 14640                                  
 14641                                  ;LruFCB	PROC	NEAR
 14642                                  LRUFCB:
 14643                                  	; 17/05/2019 - Retro DOS v4.0
 14644                                  	; DOSCODE:5805h (MSDOS 6.21, MSDOS.SYS)
 14645                                  
 14646                                  	; 08/11/2022 Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 14647                                  	; DOSCODE:57F1h (MSDOS 5.0, MSDOS.SYS)
 14648                                  
 14649                                  	; 20/01/2024 Retro DOS v5.0 (Modified PCDOS 7.1 IBMMDOS.COM)
 14650                                  	; DOSCODE:5E7Ch (PCDOS 7.1, IBMDOS.COM)
 14651                                  
 14652 00001F32 06                      	push	es	; * (MSDOS 6.21)
 14653                                  	
 14654 00001F33 E822E5                  	call	save_world
 14655                                  	
 14656                                  	;getdseg <ds>		;ds = DOSDATA
 14657 00001F36 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 14658                                  
 14659 00001F3B 08C0                    	or	al,al		;Check if regenerate allocation
 14660 00001F3D 7516                    	jnz	short lru1	;Try to find SFT to use
 14661                                  
 14662                                  	; This is a regen call. If LocalSFT contains the address of a valid 
 14663                                  	; local SFT, just return that SFT to reuse
 14664                                  
 14665                                  	; 20/01/2024
 14666                                  	;mov	di,[LocalSFT]
 14667                                  	;or	di,[LocalSFT+2]	;is address == 0?
 14668                                  	;jz	short lru1	;invalid local SFT, find one
 14669                                  
 14670                                  	; We have found a valid local SFT. Recycle this SFT
 14671                                  
 14672 00001F3F C43E[760F]              	les	di,[LocalSFT]
 14673                                  
 14674                                  	; 20/01/2024 (PCDOS 7.1 IBMDOS.COM)
 14675 00001F43 8CC1                    	mov	cx,es
 14676 00001F45 09F9                    	or	cx,di		; is address == 0?
 14677 00001F47 740C                    	jz	short lru1	; invalid local SFT, find one
 14678                                  
 14679                                  gotlocalSFT:
 14680 00001F49 893E[9E05]              	mov	[THISSFT],di
 14681 00001F4D 8C06[A005]              	mov	[THISSFT+2],es
 14682 00001F51 F8                      	clc
 14683 00001F52 E9A900                  	jmp	LRUDone		;clear up SFT and return
 14684                                  
 14685                                  lru1:
 14686 00001F55 C43E[4000]              	les	di,[SFTFCB]	;es:di = SF Table for FCBs
 14687                                  	;mov	cx,[es:di+4]
 14688 00001F59 268B4D04                	mov	cx,[es:di+SFT.SFCount]	;cx = number of SFTs
 14689                                  	;lea	di,[di+6]
 14690 00001F5D 8D7D06                  	lea	di,[di+SFT.SFTable]	;es:di = first SFT
 14691                                  
 14692                                  	; We scan through all the SFTs scanning for a free one. It also 
 14693                                  	; remembers the LRU SFT for net/Share SFTs and local SFTs separately. 
 14694                                  	; bx = min. LRU for local SFTs
 14695                                  	; si = pos. of local SFT with min. LRU
 14696                                  	; dx = min. LRU for net/Share SFTs
 14697                                  	; bp = pos. of net/Share SFT with min. LRU
 14698                                  
 14699 00001F60 BBFFFF                  	mov	bx,-1		; init. to 0xffff ( max. LRU value )
 14700 00001F63 89DE                    	mov	si,bx
 14701 00001F65 89DA                    	mov	dx,bx
 14702 00001F67 89DD                    	mov	bp,bx
 14703                                  
 14704                                  findSFT:
 14705                                  	;See if this SFT is a free one. If so, return it
 14706 00001F69 26830D00                	or	word [es:di],0
 14707                                  	;or	word [es:di+SF_ENTRY.sf_ref_count],0 ;reference count = 0 ?
 14708 00001F6D 744C                    	jz	short gotSFT	;yes, SFT is free
 14709                                  	;;cmp	word [es:di],-1
 14710                                  	;cmp	word [es:di+SF_ENTRY.sf_ref_count],sf_busy ;Is it busy?
 14711 00001F6F 26833DFF                	cmp	word [es:di],sf_busy ; -1 
 14712 00001F73 7446                    	jz	short gotSFT	;no, can use it
 14713                                  
 14714                                  	; Check if this SFT is local and store its address in LocalSFT. Can be 
 14715                                  	; used for a later regen.
 14716                                  
 14717                                  	; 16/12/2022
 14718                                  	; 08/11/2022
 14719                                  	;test	byte [es:di+6],80h
 14720 00001F75 26F6450680              	test	byte [es:di+SF_ENTRY.sf_flags+1],(sf_isnet>>8) ; 80h
 14721                                  	; 08/11/2022 Retro DOS v4.0 (MSDOS 5.0 MSDOS.SYS compatibility)
 14722                                  	;;test	word [es:di+5],8000h
 14723                                  	;test	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet ; network SFT?
 14724 00001F7A 7531                    	jnz	short lru5	;yes, get net/Share LRU
 14725                                  
 14726                                  ;IF installed
 14727 00001F7C E8E864                  	call	CheckShare	;Share present?
 14728                                  ;ENDIF
 14729 00001F7F 752C                    	jnz	short lru5	;yes, get net/Share LRU
 14730                                  
 14731                                  	;Local SFT, register its address
 14732                                  
 14733                                  	; !!HACK!!!
 14734                                  	; There is a slightly dirty hack out here in a desperate bid to save  
 14735                                  	; code space. There is similar code duplicated at label 'gotSFT'. We 
 14736                                  	; enter from there if al = 0, update the LocalSFT variable, and since 
 14737                                  	; al = 0, we jump out of the loop to the exit point. I have commented 
 14738                                  	; out the code that previously existed at label 'gotSFT'
 14739                                  
 14740                                  hackpoint:
 14741 00001F81 893E[760F]              	mov	[LocalSFT],di
 14742 00001F85 8C06[780F]              	mov	[LocalSFT+2],es	;store local SFT address
 14743                                  
 14744 00001F89 08C0                    	or	al,al		;Is operation = REGEN?
 14745 00001F8B 74BC                    	jz	short gotlocalSFT ;yes, return this SFT for reuse
 14746                                  
 14747                                  	;Get LRU for local files
 14748                                  	
 14749                                  	;cmp	[es:di+15h],bx
 14750 00001F8D 26395D15                	cmp	[es:di+sf_LRU],bx ;SFT.LRU < min?
 14751 00001F91 7306                    	jae	short lru4	;no, skip 
 14752                                  
 14753                                  	;mov	bx,[es:di+15h]
 14754 00001F93 268B5D15                	mov	bx,[es:di+sf_LRU] ;yes, store new minimum
 14755 00001F97 89FE                    	mov	si,di		;store SFT position
 14756                                  lru4:
 14757                                  	;add	di,59
 14758 00001F99 83C73B                  	add	di,SF_ENTRY.size ;go to next SFT
 14759 00001F9C E2CB                    	loop	findSFT
 14760                                  	
 14761                                  	; 20/01/2024
 14762 00001F9E 49                      	dec	cx ; -1
 14763                                  
 14764                                  	; Check whether we got a net/Share or local SFT. If local SFT
 14765                                  	; available, we will reuse it instead of net/Share LRU
 14766                                  
 14767 00001F9F 89F7                    	mov	di,si
 14768                                  	;cmp	si,-1		;local SFT available?
 14769 00001FA1 39CE                    	cmp	si,cx ; 20/01/2024
 14770 00001FA3 7516                    	jnz	short gotSFT	;yes, return it
 14771                                  
 14772                                  	;No local SFT, see if we got a net/Share SFT
 14773                                  
 14774 00001FA5 89EF                    	mov	di,bp
 14775                                  
 14776 00001FA7 39CD                    	cmp	bp,cx ; -1 ; 20/01/2024
 14777                                  	;cmp	bp,-1		;net/Share SFT available?
 14778 00001FA9 752D                    	jnz	short gotnetSFT	;yes, return it
 14779                                  noSFT:
 14780                                  	; NB: This error should never occur. We always must have an LRU SFT.
 14781                                  	; This error can occur only if the SFT has been corrupted or the LRU
 14782                                  	; count is not maintained properly.
 14783                                  
 14784 00001FAB EB4E                    	jmp	short errorbadSFT ;error, no FCB available.
 14785                                  
 14786                                  	; Handle the LRU for net/Share SFTs
 14787                                  lru5:
 14788                                  	;cmp	[es:di+15h],dx
 14789 00001FAD 26395515                	cmp	[es:di+sf_LRU],dx ;SFT.LRU < min?
 14790 00001FB1 73E6                    	jae	short lru4	;no, skip
 14791                                  
 14792                                  	;mov	dx,[es:di+15h]
 14793 00001FB3 268B5515                	mov	dx,[es:di+sf_LRU] ;yes, store new minimum
 14794                                  
 14795 00001FB7 89FD                    	mov	bp,di		;store SFT position
 14796 00001FB9 EBDE                    	jmp	short lru4	;continue with next SFT
 14797                                  
 14798                                  gotSFT:
 14799 00001FBB 08C0                    	or	al,al
 14800 00001FBD 74C2                    	jz	short hackpoint	;save es:di in LocalSFT
 14801                                  
 14802                                  	; HACK!!!
 14803                                  	; The code here differs from the code at 'hackpoint' only in the 
 14804                                  	; order of the check for al. If al = 0, we can jump to 'hackpoint'
 14805                                  	; and then from there jump out to 'gotlocalSFT'. The original code
 14806                                  	; has been commented out below and replaced by the code just above.
 14807                                  
 14808                                  ;If regen, then this SFT can be registered as a local one ( even if free ).
 14809                                  ;
 14810                                  ;	or	al,al		  ;Regen?
 14811                                  ;	jnz	short notlocaluse ;yes, register it and return
 14812                                  ;
 14813                                  ;Register this SFT as a local one
 14814                                  ;
 14815                                  ;	mov	[LocalSFT],di
 14816                                  ;	mov	[LocalSFT+2],es
 14817                                  ;	jmp	gotlocalSFT	;return to caller
 14818                                  ;
 14819                                  ;notlocaluse:
 14820                                  
 14821                                  	; The caller is probably going to use this SFT for a net/Share file.
 14822                                  	; We will come here only on a Open/Create when the caller($FCB_OPEN)
 14823                                  	; does not really know whether it is a local file or not. We
 14824                                  	; invalidate LocalSFT if the SFT we are going to use was previously
 14825                                  	; registered as a local SFT that can be recycled.
 14826                                  
 14827 00001FBF 8CC0                    	mov	ax,es
 14828 00001FC1 393E[760F]              	cmp	[LocalSFT],di		;Offset same?
 14829 00001FC5 750E                    	jne	short notinvalid
 14830 00001FC7 3906[780F]              	cmp	[LocalSFT+2],ax		;Segments same?
 14831                                  	;je	short zerolocalSFT	;no, no need to invalidate
 14832                                  	; 20/01/2024 (PCDOS 7.1 IBMDOS.COM)
 14833 00001FCB 7508                    	jne	short notinvalid
 14834                                  zerolocalSFT:	
 14835 00001FCD 31C0                    	xor	ax,ax ; 0
 14836 00001FCF A3[760F]                	mov	[LocalSFT],ax
 14837 00001FD2 A3[780F]                	mov	[LocalSFT+2],ax
 14838                                  	
 14839                                  notinvalid:
 14840 00001FD5 E971FF                  	jmp	gotlocalSFT
 14841                                  
 14842                                  	; The SFT we are going to use was registered in the LocalSFT variable.
 14843                                  	; Invalidate this variable i.e LocalSFT = NULL
 14844                                  
 14845                                  ;zerolocalSFT:
 14846                                  	;xor	ax,ax ; 0
 14847                                  	;mov	[LocalSFT],ax
 14848                                  	;mov	[LocalSFT+2],ax
 14849                                  	;
 14850                                  	;jmp	gotlocalSFT
 14851                                  
 14852                                  gotnetSFT:
 14853                                  	; We have an SFT that is currently net/Share. If it is going to be
 14854                                  	; used for a regen, we know it has to be a local SFT. Update the
 14855                                  	; LocalSFT variable
 14856                                  
 14857 00001FD8 08C0                    	or	al,al
 14858 00001FDA 7508                    	jnz	short closenet
 14859                                  
 14860 00001FDC 893E[760F]              	mov	[LocalSFT],di
 14861 00001FE0 8C06[780F]              	mov	[LocalSFT+2],es	;store local SFT address
 14862                                  closenet:
 14863 00001FE4 893E[9E05]              	mov	[THISSFT],di	; set thissft
 14864 00001FE8 8C06[A005]              	mov	[THISSFT+2],es	
 14865                                  
 14866                                  	; If we have sharing or thisSFT is a net sft, then close it until ref
 14867                                  	; count is 0.
 14868                                  	; NB: We come here only if it is a net/Share SFT that is going to be
 14869                                  	; recycled -- no need to check for this.
 14870                                  
 14871                                  LRUClose:
 14872 00001FEC 26833D00                	cmp	word [es:di],0
 14873                                  	;cmp	word [es:di+SF_ENTRY.sf_ref_count],0 ; is ref count still <> 0?
 14874 00001FF0 740C                    	jz	short LRUDone	; nope, all done
 14875                                  
 14876 00001FF2 E82C17                  	call	DOS_CLOSE
 14877 00001FF5 73F5                    	jnc	short LRUClose	; no error => clean up
 14878                                  
 14879                                  	; Bugbug: I dont know why we are trying to close after we get an
 14880                                  	; error closing. Seems like we could have a potential infinite loop
 14881                                  	; here. This has to be verified.
 14882                                  
 14883 00001FF7 3C06                    	cmp	al,error_invalid_handle ; 6
 14884 00001FF9 74F1                    	je	short LRUClose
 14885                                  errorbadSFT:
 14886 00001FFB F9                      	stc
 14887 00001FFC EB05                    	JMP	short LRUDead
 14888                                  LRUDone:
 14889 00001FFE 30C0                    	XOR	AL,AL
 14890 00002000 E81B01                  	call	BlastSFT		; fill SFT with 0 (AL), 'C' cleared
 14891                                  
 14892                                  LRUDead:
 14893 00002003 E83BE4                  	call	restore_world		; use macro
 14894                                  	
 14895 00002006 07                      	pop	es ; * (MSDOS 6.21)
 14896                                  
 14897                                  	;getdseg <es>
 14898 00002007 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 14899 0000200C 26C43E[9E05]            	les	di,[es:THISSFT]		;es:di points at allocated SFT
 14900                                  
 14901                                  	;;retnc
 14902                                  	;jc	short LruFCB_err
 14903                                  	;retn
 14904                                  
 14905                                  	; 16/12/2022
 14906                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 14907 00002011 7302                    	jnc	short LruFCB_retn
 14908                                  	;jc	short LruFCB_err
 14909                                  	;retn
 14910                                  		
 14911                                  LruFCB_err:
 14912 00002013 B023                    	MOV	AL,error_FCB_unavailable ; 23h
 14913                                  LruFCB_retn:
 14914 00002015 C3                      	retn
 14915                                  	
 14916                                  ;LruFCB	ENDP
 14917                                  
 14918                                  ; 17/05/2019 - Retro DOS v4.0
 14919                                  
 14920                                  ; DOSCODE:58F3h (MSDOS 6.21, MSDOS.SYS)
 14921                                  
 14922                                  ; --------------------------------------------------------------------------
 14923                                  ;**** RegenCopyName -- This function copies the filename from the FCB to
 14924                                  ; SFT and also to DOS local buffers. There was duplicate code in FCBRegen
 14925                                  ; to copy the name to different destinations
 14926                                  ;
 14927                                  ; Inputs: ds:si = source string
 14928                                  ;	 es:di = destination string
 14929                                  ;	 cx = length of string
 14930                                  ;
 14931                                  ; Outputs: String copied to destination
 14932                                  ;
 14933                                  ; Registers affected: cx,di,si
 14934                                  ; --------------------------------------------------------------------------
 14935                                  
 14936                                  RegenCopyName:
 14937                                  CopyName:
 14938 00002016 AC                      	lodsb			;load character
 14939 00002017 E8AA3D                  	call	UCase		; convert char to upper case
 14940                                  StuffChar2:
 14941 0000201A AA                      	STOSB			;store converted character
 14942 0000201B E2F9                    	LOOP	CopyName	;
 14943                                  DoneName:
 14944 0000201D C3                      	retn
 14945                                  
 14946                                  ; --------------------------------------------------------------------------
 14947                                  
 14948                                  	; 09/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 14949                                  	; 21/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 14950                                  
 14951                                  FCBRegen:
 14952                                  	; called from SFTFromFCB. SS already DOSDATA
 14953                                  
 14954                                  	; General data filling. Mode is sf_isFCB + open_for_both, date/time 
 14955                                  	; we do not fill, size we do no fill, position we do not fill,
 14956                                  	; bit 14 of flags = TRUE, other bits = FALSE
 14957                                  
 14958                                  	;mov	al,[si+19h]
 14959 0000201E 8A4419                  	MOV	AL,[SI+fcb_l_drive]
 14960                                  
 14961                                  	; We discriminate based on the first two bits in the reserved field.
 14962                                  	
 14963                                  	;test	al,80h
 14964 00002021 A880                    	test	AL,FCBSPECIAL		; check for no sharing test
 14965 00002023 741C                    	JZ	short RegenNoSharing	; yes, go regen from no sharing
 14966                                  
 14967                                  	; The FCB is for a network or a sharing based system. At this point 
 14968                                  	; we have already closed the SFT for this guy and reconnection is 
 14969                                  	; impossible.
 14970                                  	;
 14971                                  	; Remember that he may have given us a FCB with bogus information in
 14972                                  	; it. Check to see if sharing is present or if the redir is present.
 14973                                  	; If either is around, presume that we have cycled out the FCB and 
 14974                                  	; give the hard error. Otherwise, just return with carry set.
 14975                                  
 14976 00002025 E83F64                  	call	CheckShare		; test for sharer
 14977 00002028 7509                    	JNZ	short RegenFail		; yep, fail this.
 14978                                  	
 14979                                  	;mov	ax,1100h
 14980 0000202A B80011                  	MOV	AX,MultNET<<8		; install check on multnet
 14981 0000202D CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - INSTALLATION CHECK
 14982                                  			; Return: AL = 00h  not installed, OK to install
 14983                                  			; 01h  not installed, not OK to install
 14984                                  			; FFh  installed
 14985 0000202F 08C0                    	OR	AL,AL			; is it there?
 14986 00002031 740C                    	JZ	short RegenDead		; no, just fail the operation
 14987                                  RegenFail:
 14988                                  	; 17/05/2019 - Retro DOS v4.0
 14989                                  	;MOV	AX,[CS:USER_IN_AX]	; SS override
 14990 00002033 36A1[3A03]              	mov	ax,[SS:USER_IN_AX] ; MSDOS 6.0
 14991                                  
 14992                                  	;cmp	ah,10h
 14993 00002037 80FC10                  	cmp	AH,FCB_CLOSE
 14994 0000203A 7403                    	jz	short RegenDead
 14995 0000203C E89B01                  	call	FCBHardErr		; massive hard error.
 14996                                  RegenDead:
 14997 0000203F F9                      	STC				; carry set
 14998                                  FCBRegen_retn:
 14999 00002040 C3                      	retn
 15000                                  
 15001                                  	; Local FCB without sharing. Check to see if sharing is loaded. If 
 15002                                  	; so fail the operation.
 15003                                  
 15004                                  RegenNoSharing:
 15005 00002041 E82364                  	call	CheckShare		; Sharing around?
 15006 00002044 75ED                    	JNZ	short RegenFail
 15007                                  	
 15008                                  	; Find an SFT for this guy.
 15009                                  	
 15010                                  	; 17/05/2019 - Retro DOS v4.0
 15011                                  
 15012                                  	; MSDOS 3.3
 15013                                  	;call	LRUFCB
 15014                                  	;jc	short FCBRegen_retn
 15015                                  	
 15016                                  	; MSDOS 6.0
 15017 00002046 50                      	push	ax
 15018 00002047 B000                    	mov	al,0			;indicate it is a regen operation
 15019 00002049 E8E6FE                  	call	LRUFCB
 15020 0000204C 58                      	pop	ax
 15021 0000204D 72F1                    	jc	short FCBRegen_retn
 15022                                  
 15023                                  	;mov	word [es:di+2],8002h
 15024 0000204F 26C745020280            	MOV	word [ES:DI+SF_ENTRY.sf_mode],sf_isFCB+open_for_both+SHARING_COMPAT
 15025 00002055 243F                    	AND	AL,3Fh			; get drive number for flags
 15026 00002057 98                      	CBW
 15027                                  	;or	ax,4000h
 15028 00002058 0D0040                  	OR	AX,sf_close_nodate	; normal FCB operation
 15029                                  
 15030                                  	; The bits field consists of the upper two bits (dirty and device) 
 15031                                  	; from the SFT and the low 4 bits from the open mode.
 15032                                  
 15033                                  	;mov	cl,[si+1Ah]
 15034 0000205B 8A4C1A                  	MOV	CL,[SI+fcb_nsl_bits]	; stick in dirty bits.
 15035 0000205E 88CD                    	MOV	CH,CL
 15036 00002060 80E5C0                  	AND	CH,0C0h 		; mask off the dirty/device bits
 15037 00002063 08E8                    	OR	AL,CH
 15038                                  	;and	cl,0Fh
 15039 00002065 80E10F                  	AND	CL,access_mask		; get the mode bits
 15040                                  	;mov	[es:di+2],cl
 15041 00002068 26884D02                	MOV	[ES:DI+SF_ENTRY.sf_mode],CL
 15042                                  	;mov	[es:di+5],ax
 15043 0000206C 26894505                	MOV	[ES:DI+SF_ENTRY.sf_flags],AX ; initial flags
 15044                                  	;MOV	AX,[CS:PROC_ID]		; SS override
 15045 00002070 36A1[3C03]              	mov	ax,[ss:PROC_ID] ; MSDOS 6.0
 15046                                  	;mov	[es:di+31h],ax
 15047 00002074 26894531                	MOV	[ES:DI+SF_ENTRY.sf_PID],AX
 15048 00002078 1E                      	push	ds
 15049 00002079 56                      	push	si
 15050 0000207A 06                      	push	es
 15051 0000207B 57                      	push	di
 15052 0000207C 16                      	push	ss
 15053 0000207D 07                      	pop	es
 15054 0000207E BF[4B05]                	MOV	DI,NAME1		; NAME1 is in DOSDATA
 15055                                  
 15056 00002081 B90800                  	MOV	CX,8
 15057 00002084 46                      	INC	SI			; Skip past drive byte to name in FCB
 15058                                  
 15059                                  	; MSDOS 3.3
 15060                                  ;RegenCopyName:
 15061                                  	;lodsb
 15062                                  	;call	UCase
 15063                                  	;stosb
 15064                                  	;loop	RegenCopyName
 15065                                  
 15066                                  	; MSDOS 6.0
 15067 00002085 E88EFF                  	call	RegenCopyName		;copy the name to NAME1
 15068                                  
 15069 00002088 16                      	push	ss	; SS is DOSDATA
 15070 00002089 1F                      	pop	ds
 15071                                  
 15072                                  	;mov	byte [ATTRIB],16h
 15073 0000208A C606[6B05]16            	MOV	byte [ATTRIB],attr_hidden+attr_system+attr_directory
 15074                                  					; Must set this to something interesting
 15075                                  					; to call DEVNAME.
 15076 0000208F E85D2D                  	call	DEVNAME 		; check for device
 15077 00002092 5E                      	pop	si
 15078 00002093 07                      	pop	es
 15079 00002094 5E                      	pop	si
 15080 00002095 1F                      	pop	ds
 15081 00002096 7219                    	JC	short RegenFileNoSharing ; not found on device list => file
 15082                                  
 15083                                  	; Device found. We can ignore disk-specific info
 15084                                  
 15085                                  	;mov	[es:di+5],bh
 15086 00002098 26887D05                	MOV	[ES:DI+SF_ENTRY.sf_flags],BH ; device parms
 15087                                  	;mov	byte [es:di+4],0
 15088 0000209C 26C6450400              	MOV	byte [ES:DI+SF_ENTRY.sf_attr],0 ; attribute
 15089                                  					; SS override
 15090                                  	;LDS	SI,[CS:DEVPT]		; get device driver
 15091 000020A1 36C536[9A05]            	lds	si,[ss:DEVPT] ; MSDOS 6.0
 15092                                  	;mov	[es:di+7],si
 15093 000020A6 26897507                	MOV	[ES:DI+SF_ENTRY.sf_devptr],SI
 15094                                  	;mov	[es:di+9],ds
 15095 000020AA 268C5D09                	MOV	[ES:DI+SF_ENTRY.sf_devptr+2],DS
 15096 000020AE C3                      	retn				; carry is clear
 15097                                  
 15098                                  RegenDeadJ:
 15099 000020AF EB8E                    	JMP	short RegenDead
 15100                                  
 15101                                  	; File found. Just copy in the remaining pieces.
 15102                                  
 15103                                  RegenFileNoSharing:
 15104                                  	;mov	ax,[es:di+5]
 15105 000020B1 268B4505                	MOV	AX,[ES:DI+SF_ENTRY.sf_flags]
 15106 000020B5 83E03F                  	AND	AX,03Fh
 15107 000020B8 1E                      	push	ds
 15108 000020B9 56                      	push	si
 15109 000020BA E8315A                  	call	FIND_DPB
 15110                                  	;mov	[es:di+7],si
 15111 000020BD 26897507                	MOV	[ES:DI+SF_ENTRY.sf_devptr],SI
 15112                                  	;mov	[es:di+9],ds
 15113 000020C1 268C5D09                	MOV	[ES:DI+SF_ENTRY.sf_devptr+2],DS
 15114 000020C5 5E                      	pop	si
 15115 000020C6 1F                      	pop	ds
 15116 000020C7 72E6                    	jc	short RegenDeadJ	; if find DPB fails, then drive
 15117                                  					; indicator was bogus
 15118                                  	;mov	ax,[si+1Dh]
 15119 000020C9 8B441D                  	MOV	AX,[SI+fcb_nsl_dirsec]
 15120                                  	;;mov	[es:di+1Dh],ax ; MSDOS 3.3
 15121                                  	;mov	[es:di+1Bh],ax ; MSDOS 6.0
 15122 000020CC 2689451B                	MOV	[ES:DI+SF_ENTRY.sf_dirsec],AX
 15123                                  
 15124                                  	; MSDOS 6.0
 15125                                  
 15126                                  	; SR;
 15127                                  	; Extract the read-only and archive bits from the top 2 bits of the sector
 15128                                  	; number
 15129                                  
 15130                                  	;mov	al,[si+18h]
 15131 000020D0 8A4418                  	mov	al,[si+fcb_sfn]
 15132 000020D3 24C0                    	and	al,0C0h		;get the 2 attribute bits
 15133 000020D5 88C4                    	mov	ah,al
 15134 000020D7 D0C4                    	rol	ah,1
 15135 000020D9 D0E8                    	shr	al,1
 15136 000020DB 08E0                    	or	al,ah
 15137 000020DD 243F                    	and	al,03Fh		;mask off unused bits
 15138                                  	;mov	[es:di+4],al
 15139 000020DF 26884504                	mov	[es:di+SF_ENTRY.sf_attr],al
 15140                                  
 15141                                  	; SR;
 15142                                  	; Update the higher word of the directory sector from the FCB
 15143                                  
 15144                                  	;;mov	al,[si+18h]
 15145 000020E3 8A4418                  	mov	al,[si+fcb_sfn]
 15146 000020E6 243F                    	and	al,03Fh		;mask off top 2 bits -- attr bits
 15147 000020E8 28E4                    	sub	ah,ah
 15148                                  	;mov	[es:di+1Dh],ax
 15149 000020EA 2689451D                	mov	[es:di+SF_ENTRY.sf_dirsec+2],ax ;update high word
 15150                                  
 15151                                  	; 21/01/2024
 15152                                  	; MSDOS 6.0 (& MSDOS 3.3)
 15153                                  	;mov	ax,[si+1Bh]
 15154 000020EE 8B441B                  	MOV	AX,[SI+fcb_nsl_firclus]
 15155                                  	;;mov	[es:di+0Bh],ax
 15156                                  	;MOV	[ES:DI+SF_ENTRY.sf_firclus],AX
 15157                                  	;;;
 15158                                  	; 21/01/2024 (PCDOS 7.1 IBMDOS.COM)
 15159 000020F1 2689452B                	mov	[es:di+2Bh],ax	; .sf_chain !!! (MSDOS 6.22)
 15160                                  	;mov	[es:di+SF_ENTRY.sf_chain],ax ; first cluster (32 bit) !?
 15161                                  	;;;	
 15162                                  
 15163                                  	;;mov	[es:di+1Bh],ax ; MSDOS 3.3
 15164                                  	;mov	[es:di+35h],ax ; MSDOS 6.0
 15165 000020F5 26894535                	MOV	[ES:DI+SF_ENTRY.sf_lstclus],AX
 15166                                  
 15167                                  	;;;
 15168                                  	; 21/01/2024 (PCDOS 7.1 IBMDOS.COM)
 15169 000020F9 31C0                    	xor	ax,ax	; 0
 15170 000020FB 2689452D                	mov	[es:di+2Dh], ax ; 0
 15171                                  	;mov	[es:di+SF_ENTRY.sf_chain+2],ax
 15172                                  				; .sf_chain ! (MSDOS 6.22)
 15173                                  				; high word of first cluster (32 bit) !?
 15174 000020FF 26894537                	mov	[es:di+37h],ax ; 0
 15175                                  	;mov	[es:di+SF_ENTRY.sf_lstclus+2],ax ; hw of last cluster
 15176                                  	;;;
 15177                                  
 15178                                  	;mov	al,[si+1Fh]
 15179 00002103 8A441F                  	MOV	AL,[SI+fcb_nsl_dirpos]
 15180                                  	;mov  	[es:di+1Fh],al
 15181 00002106 2688451F                	MOV	[ES:DI+SF_ENTRY.sf_dirpos],AL
 15182                                  	;INC	word [ES:DI+SF_ENTRY.sf_ref_count]
 15183 0000210A 26FF05                  	inc	word [ES:DI]		; Increment reference count.
 15184                                  					; Existing FCB entries would be
 15185                                  					; flushed unnecessarily because of
 15186                                  					; check in CheckFCB of the ref_count.
 15187                                  					; July 22/85 - BAS
 15188                                  	;;;
 15189                                  	; 21/01/2024 (PCDOS 7.1 IBMDOS.COM)
 15190 0000210D E81829                  	call	set_sftfcb_entry ; put SFT entry number in the SFTFCB table
 15191                                  				 ; as FCB index number
 15192                                  	;;;
 15193                                  
 15194                                  	;lea	si,[si+1]
 15195 00002110 8D7401                  	LEA	SI,[SI+SYS_FCB.name]
 15196                                  	;lea	di,[di+20h]
 15197 00002113 8D7D20                  	LEA	DI,[DI+SF_ENTRY.sf_name]
 15198                                  	;mov	cx,11
 15199 00002116 B90B00                  	MOV	CX,SYS_FCB.EXTENT-SYS_FCB.name ; 12-1
 15200                                  	
 15201                                  	; MSDOS 6.0
 15202 00002119 E8FAFE                  	call	RegenCopyName	;copy name to SFT 
 15203                                  	
 15204                                  	; MSDOS 3.3
 15205                                  ;RegenCopyName2:
 15206                                  	;lodsb
 15207                                  	;call    UCase
 15208                                  	;stosb
 15209                                  	;loop    RegenCopyName2
 15210                                  
 15211 0000211C F8                      	clc
 15212 0000211D C3                      	retn
 15213                                  
 15214                                  ; 17/05/2019 - Retro DOS v4.0
 15215                                  ; 21/01/2024 - Retro DOS v5.0
 15216                                  
 15217                                  ;**	BlastSFT - FIll SFT with Garbage
 15218                                  ; --------------------------------------------------------------------------
 15219                                  ;	BlastSFT is used when an SFT is no longer needed; it's called with
 15220                                  ;	various garbage values to put into the SFT.  I don't know why,
 15221                                  ;	presumably to help with debugging (jgl).  We clear the few fields
 15222                                  ;	necessary to show that the SFT is free after filling it.
 15223                                  ;
 15224                                  ;	ENTRY	(es:di) = address of SFT
 15225                                  ;		(al) = fill character
 15226                                  ;	EXIT	(ax) = -1
 15227                                  ;		'C' clear
 15228                                  ;	USES	AX, CX, Flags
 15229                                  
 15230                                  BlastSFT:
 15231                                  	; 21/01/2024 (PCDOS 7.1 IBMDOS.COM)
 15232                                  	;;;
 15233 0000211E E8DA29                  	call	SFT_FREE
 15234                                  	;;;
 15235 00002121 57                      	push	di
 15236                                  	;mov	cx,53 ; MSDOS 3.3
 15237                                  	;mov	cx,59 ; MSDOS 6.0
 15238 00002122 B93B00                  	mov	cx,SF_ENTRY.size
 15239 00002125 F3AA                    	rep	stosb
 15240 00002127 5F                      	pop	di
 15241 00002128 29C0                    	sub	ax,ax	; 0		; clear 'C'-----------------;
 15242 0000212A 268905                  	mov	[es:di],ax
 15243                                  	;mov	[es:di+SF_ENTRY.sf_ref_count],ax ; set ref count    ;
 15244                                  	;mov	[es:di+15h],ax
 15245 0000212D 26894515                	mov	[es:di+sf_LRU],ax	; set lru		    ;
 15246 00002131 48                      	dec	ax	; -1					    ;
 15247                                  	;mov	[es:di+17h],ax ; 0FFFFh ; -1
 15248 00002132 26894517                	mov	[es:di+sf_OpenAge],ax	; set open age to -1	    ;
 15249                                  BlastSFT_retn:
 15250 00002136 C3                      	retn				; return with 'C' clear     ;
 15251                                  
 15252                                  ;Break	<CheckFCB - see if the SFT pointed to by the FCB is still OK>
 15253                                  ; --------------------------------------------------------------------------
 15254                                  ;
 15255                                  ;   CheckFCB - examine an FCB and its contents to see if it needs to be
 15256                                  ;   regenerated.
 15257                                  ;
 15258                                  ;   Inputs:	DS:SI point to FCB (not extended)
 15259                                  ;		AL is SFT index
 15260                                  ;   Outputs:	Carry Set - FCB needs to be regened
 15261                                  ;		Carry clear - FCB is OK. ES:DI point to SFT
 15262                                  ;   Registers modified: AX and BX
 15263                                  ;
 15264                                  ; --------------------------------------------------------------------------
 15265                                  
 15266                                  	; 09/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 15267                                  	; DOSCODE:59F0h (MSDOS 5.0, MSDOS.SYS)
 15268                                  
 15269                                  	; 21/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 15270                                  	; DOSCODE:607Eh (PCDOS 7.1 IBMDOS.COM)
 15271                                  CheckFCB:
 15272                                  		
 15273                                  	; called from $fcb_open and sftfromfcb. SS already set up to DOSDATA
 15274                                  
 15275                                  	; MSDOS 3.3
 15276                                  
 15277                                  	; LES	DI,[CS:SFTFCB]
 15278                                  
 15279                                  	; MSDOS 6.0
 15280                                  	
 15281                                  	; SR;
 15282                                  	; We check if the given FCB is for a local file. If so, we return a 
 15283                                  	; bad SFT status forcing the caller to regenerate the SFT.
 15284                                  
 15285                                  	;test	byte [si+19h],0C0h
 15286 00002137 F64419C0                	test	byte [si+fcb_l_drive],FCBNETWORK|FCBSHARE|FCBDEVICE
 15287 0000213B 7447                    	jz	short BadSFT		;Local file, return bad SFT
 15288 0000213D 36C43E[4000]            	LES     DI,[SS:SFTFCB]		; SS override
 15289                                  
 15290                                  	; MSDOS 6.0 (& MSDOS 3.3)
 15291                                  	;cmp	[es:di+4],al
 15292 00002142 26384504                	CMP	[ES:DI+SFT.SFCount],AL
 15293 00002146 723C                    	JC	short BadSFT
 15294                                  	;;mov	bl,53 ; MSDOS 3.3
 15295                                  	;mov	bl,59 ; MSDOS 6.0
 15296 00002148 B33B                    	MOV	BL,SF_ENTRY.size
 15297 0000214A F6E3                    	MUL	BL
 15298                                  	;lea	di,[di+6]
 15299 0000214C 8D7D06                  	LEA	DI,[DI+SFT.SFTable]
 15300 0000214F 01C7                    	ADD	DI,AX
 15301                                  	;MOV	AX,[CS:PROC_ID]	; MSDOS 3.3
 15302 00002151 36A1[3C03]              	mov	ax,[SS:PROC_ID] ; MSDOS 6.0  ; SS override
 15303                                  	;cmp	[es:di+31h],ax
 15304 00002155 26394531                	CMP	[ES:DI+SF_ENTRY.sf_PID],AX
 15305 00002159 7529                    	JNZ	short BadSFT		; must match process
 15306 0000215B 26833D00                	cmp	word [es:di],0
 15307                                  	;CMP	word [ES:DI+SF_ENTRY.sf_ref_count],0
 15308 0000215F 7423                    	JZ	short BadSFT		; must also be in use
 15309                                  	;mov	al,[si+19h]
 15310 00002161 8A4419                  	MOV	AL,[SI+fcb_l_drive]
 15311                                  	;test	al,80h
 15312 00002164 A880                    	test	AL,FCBSPECIAL		; a special FCB?
 15313 00002166 7428                    	JZ	short CheckNoShare	; No. try local or device
 15314                                  
 15315                                  	; Since we are a special FCB, try NOT to use a bogus test instruction.
 15316                                  	; FCBSHARE is a superset of FCBNETWORK.
 15317                                  
 15318 00002168 50                      	PUSH	AX
 15319                                  	;and	al,0C0h
 15320 00002169 24C0                    	AND	AL,FCBMASK
 15321                                  	;cmp	al,0C0h
 15322 0000216B 3CC0                    	CMP	AL,FCBSHARE		; net FCB?
 15323 0000216D 58                      	POP	AX
 15324 0000216E 7516                    	JNZ	short CheckNet		; no
 15325                                  					; yes
 15326                                  ;
 15327                                  ;----- In share support -----
 15328                                  ;
 15329                                  	;call	far [cs:JShare+(11*4)]
 15330 00002170 36FF1E[BC00]            	Call    far [ss:JShare+(11*4)] ; 11 = ShChk ; SS Override
 15331 00002175 720D                    	JC	short BadSFT
 15332                                  
 15333                                  ; 21/01/2024
 15334                                  %if 0
 15335                                  	JMP	SHORT CheckD
 15336                                  ;
 15337                                  ;----- End in share support -----
 15338                                  ;
 15339                                  	; 09/11/2022
 15340                                  	; (There is not any procedure/sub
 15341                                  	;  which calls or jumps to CheckFirClus here)
 15342                                  	;;;
 15343                                  CheckFirClus:
 15344                                  	;cmp     bx,[es:di+0Bh]
 15345                                  	; 07/12/2022
 15346                                  	CMP	BX,[ES:DI+SF_ENTRY.sf_firclus]
 15347                                  	JNZ	short BadSFT
 15348                                  	;;;
 15349                                  %endif
 15350                                  
 15351                                  CheckD: 
 15352 00002177 243F                    	AND	AL,3Fh
 15353                                  	;mov	ah,[es:di+5]
 15354 00002179 268A6505                	MOV	AH,[ES:DI+SF_ENTRY.sf_flags]
 15355 0000217D 80E43F                  	AND	AH,3Fh
 15356 00002180 38C4                    	CMP	AH,AL
 15357                                  	; 16/12/2022
 15358 00002182 74B2                    	jz	short BlastSFT_retn	; carry is clear
 15359                                  	; 09/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 15360                                  	;jnz	short BadSFT
 15361                                  ;CheckD_retn:
 15362                                  	;retn
 15363                                  BadSFT: 
 15364 00002184 F9                      	STC
 15365 00002185 C3                      	retn
 15366                                  				
 15367                                  CheckNet:
 15368                                  	; 17/05/2019 - Retro DOS v4.0
 15369                                  	
 15370                                  ;----- In net support -----
 15371                                  
 15372                                  	; MSDOS 3.3
 15373                                  	;;mov	ax,[si+1Ah]
 15374                                  	;mov	ax,[si+fcb_net_handle]
 15375                                  	;;cmp	ax,[es:di+1Dh]
 15376                                  	;cmp	ax,[ES:DI+SF_ENTRY.sf_dirsec]
 15377                                  	;jnz	short BadSFT
 15378                                  	;;cmp	ax,[es:di+19h]
 15379                                  	;cmp	ax,[ES:DI+sf_netid]
 15380                                  	;jnz     short BadSFT
 15381                                  	;;mov	ax,[si+1Eh]
 15382                                  	;mov	ax,[si+fcb_l_attr]
 15383                                  	;;cmp	ax,[es:di+1Bh]
 15384                                  	;cmp	ax,[es:di+SF_ENTRY.sf_lstclus]
 15385                                  	;jnz     short BadSFT
 15386                                  
 15387                                  	; MSDOS 6.0
 15388                                  	;mov	ax,[si+1Ch]
 15389 00002186 8B441C                  	MOV	AX,[SI+fcb_netID]	;AN000;IFS.DOS 4.00
 15390                                  	; 09/11/2022
 15391                                  	;cmp	ax,[es:di+0Bh] 
 15392 00002189 263B450B                	CMP	AX,[ES:DI+sf_serial_ID]	;AN000;IFS.DOS 4.00
 15393 0000218D 75F5                    	JNZ	short BadSFT
 15394                                  
 15395                                  ;----- END In net support -----
 15396                                  
 15397                                  CheckNet_retn:
 15398 0000218F C3                      	retn
 15399                                  
 15400                                  CheckNoShare:
 15401                                  
 15402                                  ; 16/12/2022
 15403                                  ;	; 09/11/2022 (following test instruction is nonsense!)
 15404                                  ;	; (I am leaving it here for MSDOS 5.0 MSDOS.SYS compatibility)
 15405                                  ;	;test	al,40h
 15406                                  ;	test	AL,FCBDEVICE		; Device?
 15407                                  ;	;jnz	short $+2 ; 09/11/2022
 15408                                  ;	JNZ	short CheckNoShareDev 	; Yes
 15409                                  
 15410                                  	; MSDOS 3.3 - IBMDOS.COM - Offset 27EFh
 15411                                  	;;mov	bx,[si+1Dh]
 15412                                  	;MOV	BX,[SI+fcb_nsl_dirsec]
 15413                                  	;;cmp	bx,[es:di+1Dh]
 15414                                  	;cmp	bx,[ES:DI+SF_ENTRY.sf_dirsec]
 15415                                  	;jnz	short BadSFT
 15416                                  	;;mov	bl,[si+1Fh]
 15417                                  	;MOV	bl,[SI+fcb_nsl_dirpos]
 15418                                  	;;cmp	bl,[es:di+1Fh]
 15419                                  	;cmp	bl,[ES:DI+SF_ENTRY.sf_dirpos]
 15420                                  	;jnz	short BadSFT
 15421                                  	;;mov	bl,[si+1Ah]
 15422                                  	;MOV	bl,[SI+fcb_nsl_bits]
 15423                                  	;;mov	bh,[es:di+5]
 15424                                  	;MOV	bh,[ES:DI+SF_ENTRY.sf_flags]
 15425                                  	;xor	bh,bl
 15426                                  	;and	bh,0C0h
 15427                                  	;jnz	short BadSFT
 15428                                  	;;xor	bl,[es:di+2]
 15429                                  	;xor	bl,[ES:DI+SF_ENTRY.sf_mode]
 15430                                  	;and	bl,0Fh
 15431                                  	;jnz	short BadSFT
 15432                                  	;push	di
 15433                                  	;push	si
 15434                                  	;;lea	di,[di+20h]  ; MSDOS 3.3
 15435                                  	;LEA	DI,[DI+SF_ENTRY.sf_name]
 15436                                  	;;lea	si,[si+1]
 15437                                  	;LEA	SI,[SI+SYS_FCB.name]
 15438                                  	;;mov	cx,11
 15439                                  	;MOV	CX,SYS_FCB.EXTENT-SYS_FCB.name ; 12-1
 15440                                  	;repe	cmpsb
 15441                                  	;pop	si
 15442                                  	;pop	di
 15443                                  	;jnz	short BadSFT
 15444                                  	;;mov	bx,[si+1Bh]
 15445                                  	;MOV	bX,[SI+fcb_nsl_firclus]
 15446                                  	;jmp	short CheckFirClus
 15447                                  
 15448                                  	; MSDOS 6.0
 15449                                  
 15450                                  	; SR;
 15451                                  	; The code below to match a local FCB with its SFT can no longer be
 15452                                  	; used. We just return a no-match status. This check is done right
 15453                                  	; at the top.
 15454                                  
 15455                                  CheckNoShareDev:
 15456                                  	;mov	bx,[si+1Ah]
 15457 00002190 8B5C1A                  	MOV	BX,[SI+fcb_nsld_drvptr]
 15458                                  	;cmp	bx,[es:di+7]
 15459 00002193 263B5D07                	CMP	BX,[ES:DI+SF_ENTRY.sf_devptr]
 15460 00002197 75EB                    	JNZ	short BadSFT
 15461                                  	;mov	bx,[si+1Ch]
 15462 00002199 8B5C1C                  	MOV	BX,[SI+fcb_nsld_drvptr+2]
 15463                                  	;cmp	bx,[es:di+9]
 15464 0000219C 263B5D09                	CMP	BX,[ES:DI+SF_ENTRY.sf_devptr+2]
 15465 000021A0 75E2                    	JNZ	short BadSFT
 15466 000021A2 EBD3                    	JMP	short CheckD
 15467                                  
 15468                                  ;Break	<SFTFromFCB - take a FCB and obtain a SFT from it>
 15469                                  ;----------------------------------------------------------------------------
 15470                                  ;
 15471                                  ;   SFTFromFCB - the workhorse of this compatability crap. Check to see if
 15472                                  ;	the SFT for the FCB is Good. If so, make ThisSFT point to it. If not
 15473                                  ;	good, get one from the cache and regenerate it. Overlay the LRU field
 15474                                  ;	with PID
 15475                                  ;
 15476                                  ;   Inputs:	DS:SI point to FCB
 15477                                  ;   Outputs:	ThisSFT point to appropriate SFT
 15478                                  ;		Carry clear -> OK ES:DI -> SFT
 15479                                  ;		Carry set -> error in ax
 15480                                  ;   Registers modified: ES,DI, AX
 15481                                  ;
 15482                                  ;----------------------------------------------------------------------------
 15483                                  
 15484                                  SFTFromFCB:
 15485                                  	; called from fcbio and $fcb_close. SS already set up to DOSDATA
 15486                                  
 15487                                  	; 17/05/2019 - Retro DOS v4.0
 15488                                  
 15489 000021A4 50                      	push	ax
 15490 000021A5 53                      	push	bx
 15491                                  	;mov	al,[si+18h]
 15492 000021A6 8A4418                  	MOV	AL,[SI+fcb_sfn] 	; set SFN for check
 15493 000021A9 E88BFF                  	call	CheckFCB
 15494 000021AC 5B                      	pop	bx
 15495 000021AD 58                      	pop	ax
 15496                                  	;MOV	[CS:THISSFT],DI		; SS override
 15497                                  	;MOV	[CS:THISSFT+2],ES
 15498 000021AE 36893E[9E05]            	MOV	[SS:THISSFT],DI		; SS override
 15499 000021B3 368C06[A005]            	MOV	[SS:THISSFT+2],ES
 15500 000021B8 7311                    	JNC	short Set_SFT		; no problems, just set thissft
 15501                                  	
 15502                                  	; 09/11/2022 (MSDOS 5.0)
 15503                                  	; 31/05/2019
 15504 000021BA 06                      	push	es ; * (MSDOS 6.21) & (MSDOS 5.0)
 15505 000021BB E89AE2                  	call	save_world
 15506 000021BE E85DFE                  	call	FCBRegen
 15507 000021C1 E87DE2                  	call	restore_world		; use macro restore world
 15508 000021C4 07                      	pop	es ; * (MSDOS 6.21) ; 31/05/2019 ; 09/11/2022 (MSDOS 5.0)	
 15509                                  
 15510                                  	;MOV	AX,[CS:EXTERR]		; SS override
 15511 000021C5 36A1[2403]              	MOV	AX,[SS:EXTERR]		; SS override
 15512 000021C9 72C4                    	jc	short CheckNet_retn
 15513                                  
 15514                                  Set_SFT: 
 15515                                  	;LES	DI,[CS:THISSFT]		; SS override for THISSFT & PROC_ID
 15516 000021CB 36C43E[9E05]            	les	di,[ss:THISSFT]
 15517                                  	;PUSH	word [CS:PROC_ID]	; set process id
 15518 000021D0 36FF36[3C03]            	push	word [ss:PROC_ID]
 15519                                  	;pop	word [es:di+31h]
 15520 000021D5 268F4531                	POP     word [ES:DI+SF_ENTRY.sf_PID]
 15521 000021D9 C3                      	retn				; carry is clear
 15522                                  
 15523                                  ;Break	<FCBHardErr - generate INT 24 for hard errors on FCBS>
 15524                                  ;----------------------------------------------------------------------------
 15525                                  ;
 15526                                  ;   FCBHardErr - signal to a user app that he is trying to use an
 15527                                  ;	unavailable FCB.
 15528                                  ;
 15529                                  ;   Inputs:	none.
 15530                                  ;   Outputs:	none.
 15531                                  ;   Registers modified: all
 15532                                  ;
 15533                                  ;----------------------------------------------------------------------------
 15534                                  
 15535                                  	; 21/01/2024 - Retro DOS v5.0
 15536                                  FCBHardErr:
 15537                                  	; 17/05/2019 - Retro DOS v4.0
 15538 000021DA 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 15539                                  	;
 15540                                  	;mov	ax,23h
 15541 000021DF B82300                  	MOV	AX,error_FCB_unavailable
 15542                                  	;;mov	byte [cs:ALLOWED],8
 15543                                  	;MOV	byte [CS:ALLOWED],Allowed_FAIL
 15544 000021E2 26C606[4B03]08          	mov	byte [es:ALLOWED],Allowed_FAIL	
 15545                                  	
 15546                                  	;LES	BP,[CS:THISDPB]
 15547 000021E8 26C42E[8A05]            	les	bp,[es:THISDPB]
 15548                                  	
 15549 000021ED BF0100                  	MOV	DI,1			; Fake some registers
 15550 000021F0 89F9                    	MOV	CX,DI
 15551                                  	;;;
 15552                                  	; 21/01/2024 (PCDOS 7.1 IBMDOS.COM) 
 15553 000021F2 31D2                    	xor	dx,dx ; 0
 15554                                  	;cmp	[es:bp+0Fh],dx
 15555 000021F4 2639560F                	cmp	[es:bp+DPB.FAT_SIZE],dx ; 0
 15556 000021F8 740B                    	jz	short fcbharderr_fat32 ; FAT32
 15557 000021FA 268916[0706]            	mov	[es:HIGH_SECTOR],dx ; 0
 15558                                  	;mov	dx,[es:bp+0Bh]
 15559 000021FF 268B560B                	mov	dx,[es:bp+DPB.FIRST_SECTOR]
 15560 00002203 EB0D                    	jmp	short fcbharderr_fat
 15561                                  fcbharderr_fat32:
 15562                                  	;mov	dx,[es:bp+2Bh]
 15563 00002205 268B562B                	mov	dx,[es:bp+DPB.FCLUS_FSECTOR+2]
 15564 00002209 268916[0706]            	mov	[es:HIGH_SECTOR],dx
 15565                                  	;mov	dx,[es:bp+29h]
 15566 0000220E 268B5629                	mov	dx,[es:bp+DPB.FCLUS_FSECTOR]
 15567                                  fcbharderr_fat: 
 15568                                  	;;;
 15569                                  	; 21/01/2024
 15570                                  	;;mov	dx,[es:bp+0Bh]
 15571                                  	;MOV	DX,[ES:BP+DPB.FIRST_SECTOR]
 15572                                  	
 15573 00002212 E86C3E                  	call	HARDERR
 15574 00002215 F9                      	STC
 15575 00002216 C3                      	retn
 15576                                  
 15577                                  ;============================================================================
 15578                                  ; FCBIO2.ASM, MSDOS 6.0, 1991
 15579                                  ;============================================================================
 15580                                  ; 21/07/2018 - Retro DOS v3.0
 15581                                  ; 17/05/2019 - Retro DOS v4.0
 15582                                  
 15583                                  ;**	FCBIO2.ASM - Ancient 1.0 1.1 FCB system calls
 15584                                  ;
 15585                                  ;	GetRR
 15586                                  ;	GetExtent
 15587                                  ;	SetExtent
 15588                                  ;	GetExtended
 15589                                  ;	GetRecSize
 15590                                  ;	FCBIO
 15591                                  ;	$FCB_OPEN
 15592                                  ;	$FCB_CREATE
 15593                                  ;	$FCB_RANDOM_WRITE_BLOCK
 15594                                  ;	$FCB_RANDOM_READ_BLOCK
 15595                                  ;	$FCB_SEQ_READ
 15596                                  ;	$FCB_SEQ_WRITE
 15597                                  ;	$FCB_RANDOM_READ
 15598                                  ;	$FCB_RANDOM_WRITE
 15599                                  ;
 15600                                  ;	Revision history:
 15601                                  ;
 15602                                  ;		Created: ARR 4 April 1983
 15603                                  ;			 MZ  6 June  1983 completion of functions
 15604                                  ;			 MZ 15 Dec   1983 Brain damaged programs close FCBs multiple
 15605                                  ;				  times.  Change so successive closes work by
 15606                                  ;				  always returning OK.	Also, detect I/O to
 15607                                  ;				  already closed FCB and return EOF.
 15608                                  ;		 MZ 16 Jan   1984 More braindamage.  Need to separate info
 15609                                  ;				  out of sft into FCB for reconnection
 15610                                  ;
 15611                                  ;	    A000   version 4.00	Jan. 1988
 15612                                  
 15613                                  ; Defintions for FCBOp flags
 15614                                  
 15615                                  RANDOM	equ 2				; random operation
 15616                                  FCBREAD equ 4				; doing a read
 15617                                  BLOCK	equ 8				; doing a block I/O
 15618                                  
 15619                                  ;Break <GetRR - return the random record field in DX:AX>
 15620                                  ;---------------------------------------------------------------------------
 15621                                  ;
 15622                                  ;   GetRR - correctly load DX:AX with the random record field (3 or 4 bytes)
 15623                                  ;	from the FCB pointed to by DS:SI
 15624                                  ;
 15625                                  ;   Inputs:	DS:SI point to an FCB
 15626                                  ;		BX has record size
 15627                                  ;   Outputs:	DX:AX contain the contents of the random record field
 15628                                  ;   Registers modified: none
 15629                                  ;---------------------------------------------------------------------------
 15630                                  
 15631                                  GetRR:
 15632                                  	;mov	ax,[si+21h]
 15633 00002217 8B4421                  	MOV	AX,[SI+SYS_FCB.RR]	; get low order part
 15634                                  	;mov	dx,[si+23h]
 15635 0000221A 8B5423                  	MOV	DX,[SI+SYS_FCB.RR+2]	; get high order part
 15636 0000221D 83FB40                  	CMP	BX,64			; ignore MSB of RR if recsiz > 64
 15637 00002220 7202                    	JB	short GetRRBye
 15638                                  GetExtent_bye:	; 21/01/2024
 15639 00002222 30F6                    	XOR	DH,DH
 15640                                  GetRRBye:
 15641 00002224 C3                      	retn
 15642                                  
 15643                                  ;Break <GetExtent - retrieve next location for sequential IO>
 15644                                  ;---------------------------------------------------------------------------
 15645                                  ;
 15646                                  ;   GetExtent - Construct the next record to perform I/O from the EXTENT and
 15647                                  ;	NR fields in the FCB.
 15648                                  ;
 15649                                  ;   Inputs:	DS:SI - point to FCB
 15650                                  ;   Outputs:	DX:AX contain the contents of the random record field
 15651                                  ;   Registers modified: none
 15652                                  ;---------------------------------------------------------------------------
 15653                                  
 15654                                  GetExtent:
 15655                                  	;mov	al,[si+20h]
 15656 00002225 8A4420                  	MOV	AL,[SI+SYS_FCB.NR]	; get low order piece
 15657                                  	;mov	dx,[si+0Ch]
 15658 00002228 8B540C                  	MOV	DX,[SI+SYS_FCB.EXTENT]	; get high order piece
 15659 0000222B D0E0                    	SHL	AL,1
 15660 0000222D D1EA                    	SHR	DX,1
 15661 0000222F D0D8                    	RCR	AL,1	; move low order bit of DL to high order of AH
 15662 00002231 88D4                    	MOV	AH,DL
 15663 00002233 88F2                    	MOV	DL,DH
 15664                                  	; 21/01/2024 (PCDOS 7.1 IBMDOS.COM)
 15665                                  	;XOR	DH,DH
 15666                                  	;retn
 15667 00002235 EBEB                    	jmp	short GetExtent_bye
 15668                                  
 15669                                  ;Break <SetExtent - update the extent/NR field>
 15670                                  ;---------------------------------------------------------------------------
 15671                                  ;
 15672                                  ;   SetExtent - change the position of an FCB by filling in the extent/NR
 15673                                  ;	fields
 15674                                  ;
 15675                                  ;   Inputs:	DS:SI point to FCB
 15676                                  ;		DX:AX is a record location in file
 15677                                  ;   Outputs:	Extent/NR fields are filled in
 15678                                  ;   Registers modified: CX
 15679                                  ;---------------------------------------------------------------------------
 15680                                  
 15681                                  SetExtent:
 15682 00002237 50                      	push	ax
 15683 00002238 52                      	push	dx
 15684 00002239 89C1                    	MOV	CX,AX
 15685 0000223B 247F                    	AND	AL,7FH			; next rec field
 15686                                  	;mov	[si+20h],al
 15687 0000223D 884420                  	MOV	[SI+SYS_FCB.NR],AL
 15688 00002240 80E180                  	AND	CL,80H			; save upper bit
 15689 00002243 D1E1                    	SHL	CX,1
 15690 00002245 D1D2                    	RCL	DX,1			; move high bit of CX to low bit of DX
 15691 00002247 88E8                    	MOV	AL,CH
 15692 00002249 88D4                    	MOV	AH,DL
 15693                                  	;mov	[si+0Ch], ax
 15694 0000224B 89440C                  	MOV	[SI+SYS_FCB.EXTENT],AX	; all done
 15695 0000224E 5A                      	pop	dx
 15696 0000224F 58                      	pop	ax
 15697 00002250 C3                      	retn
 15698                                  
 15699                                  ;Break <GetExtended - find FCB in potential extended fcb>
 15700                                  ;---------------------------------------------------------------------------
 15701                                  ;
 15702                                  ;   GetExtended - Make DS:SI point to FCB from DS:DX
 15703                                  ;
 15704                                  ;   Inputs:	DS:DX point to a possible extended FCB
 15705                                  ;   Outputs:	DS:SI point to the FCB part
 15706                                  ;		zeroflag set if not extended fcb
 15707                                  ;   Registers modified: SI
 15708                                  ;---------------------------------------------------------------------------
 15709                                  
 15710                                  GetExtended:
 15711 00002251 89D6                    	MOV	SI,DX			; point to Something
 15712 00002253 803CFF                  	CMP	BYTE [SI],-1		; look for extention
 15713 00002256 7503                    	JNZ	short GetBye		; not there
 15714 00002258 83C607                  	ADD	SI,7			; point to FCB
 15715                                  GetBye:
 15716 0000225B 39D6                    	CMP	SI,DX			; set condition codes
 15717                                  getextd_retn:
 15718 0000225D C3                      	retn
 15719                                  
 15720                                  ;Break <GetRecSize - return in BX the FCB record size>
 15721                                  ;---------------------------------------------------------------------------
 15722                                  ;
 15723                                  ;   GetRecSize - return in BX the record size from the FCB at DS:SI
 15724                                  ;
 15725                                  ;   Inputs:	DS:SI point to a non-extended FCB
 15726                                  ;   Outputs:	BX contains the record size
 15727                                  ;   Registers modified: None
 15728                                  ;---------------------------------------------------------------------------
 15729                                  
 15730                                  	; 22/01/2024
 15731                                  	; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 15732                                  GetRecSize:
 15733                                  	;mov	bx,[si+0Eh]
 15734 0000225E 8B5C0E                  	MOV	BX,[SI+SYS_FCB.RECSIZ]	; get his record size
 15735 00002261 09DB                    	OR	BX,BX			; is it nul?
 15736                                  	;jz	short getextd_retn
 15737                                  	; 22/01/2024 (BugFix)
 15738 00002263 75F8                    	jnz	short getextd_retn
 15739                                  	;MOV	BX,128			; use default size
 15740 00002265 B380                    	mov	bl,128	; (PCDOS 7.1 IBMDOS.COM)
 15741                                  	;mov	[si+0Eh],bx
 15742 00002267 895C0E                  	MOV	[SI+SYS_FCB.RECSIZ],BX	; stuff it back
 15743 0000226A C3                      	retn
 15744                                  
 15745                                  ; 23/01/2024 - Retro DOS v5.0
 15746                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:61B3h
 15747                                  
 15748                                  ; 22/07/2018 - Retro DOS v3.0
 15749                                  
 15750                                  ;BREAK <$FCB_Random_write_Block - write a block of records to a file >
 15751                                  ;----------------------------------------------------------------------------
 15752                                  ;
 15753                                  ;   $FCB_Random_Write_Block - retrieve a location from the FCB, seek to it
 15754                                  ;	and write a number of blocks from it.
 15755                                  ;
 15756                                  ;   Inputs:	DS:DX point to an FCB
 15757                                  ;   Outputs:	AL = 0 write was successful and the FCB position is updated
 15758                                  ;		AL <> 0 Not enough room on disk for the output
 15759                                  ;
 15760                                  ;----------------------------------------------------------------------------
 15761                                  
 15762                                  _$FCB_RANDOM_WRITE_BLOCK:
 15763                                  	;mov	AL,0Ah	
 15764 0000226B B00A                    	MOV	AL,RANDOM+BLOCK
 15765 0000226D EB12                    	JMP	short FCBIO	; 23/01/2024
 15766                                  
 15767                                  ;BREAK <$FCB_Random_Read_Block - read a block of records to a file >
 15768                                  ;----------------------------------------------------------------------------
 15769                                  ;
 15770                                  ;   $FCB_Random_Read_Block - retrieve a location from the FCB, seek to it
 15771                                  ;	and read a number of blocks from it.
 15772                                  ;
 15773                                  ;   Inputs:	DS:DX point to an FCB
 15774                                  ;   Outputs:	AL = error codes defined above
 15775                                  ;
 15776                                  ;----------------------------------------------------------------------------
 15777                                  
 15778                                  _$FCB_RANDOM_READ_BLOCK:
 15779                                  	;mov	AL,0Eh	
 15780 0000226F B00E                    	MOV	AL,RANDOM+FCBREAD+BLOCK
 15781 00002271 EB0E                    	JMP	short FCBIO	; 23/01/2024
 15782                                  
 15783                                  ;BREAK <$FCB_Seq_Read - read the next record from a file >
 15784                                  ;----------------------------------------------------------------------------
 15785                                  ;
 15786                                  ;   $FCB_Seq_Read - retrieve the next record from an FCB and read it into
 15787                                  ;	memory
 15788                                  ;
 15789                                  ;   Inputs:	DS:DX point to an FCB
 15790                                  ;   Outputs:	AL = error codes defined above
 15791                                  ;
 15792                                  ;----------------------------------------------------------------------------
 15793                                  
 15794                                  _$FCB_SEQ_READ:
 15795                                  	;mov	AL,4	
 15796 00002273 B004                    	MOV	AL,FCBREAD
 15797 00002275 EB0A                    	JMP	short FCBIO	; 23/01/2024
 15798                                  
 15799                                  ;BREAK <$FCB_Seq_Write - write the next record to a file >
 15800                                  ;----------------------------------------------------------------------------
 15801                                  ;
 15802                                  ;   $FCB_Seq_Write - retrieve the next record from an FCB and write it to the
 15803                                  ;	file
 15804                                  ;
 15805                                  ;   Inputs:	DS:DX point to an FCB
 15806                                  ;   Outputs:	AL = error codes defined above
 15807                                  ;
 15808                                  ;----------------------------------------------------------------------------
 15809                                  
 15810                                  _$FCB_SEQ_WRITE:
 15811 00002277 B000                    	MOV	AL,0
 15812 00002279 EB06                    	JMP	short FCBIO	; 23/01/2024
 15813                                  
 15814                                  ;BREAK <$FCB_Random_Read - Read a single record from a file >
 15815                                  ;----------------------------------------------------------------------------
 15816                                  ;
 15817                                  ;   $FCB_Random_Read - retrieve a location from the FCB, seek to it and read a
 15818                                  ;	record from it.
 15819                                  ;
 15820                                  ;   Inputs:	DS:DX point to an FCB
 15821                                  ;   Outputs:	AL = error codes defined above
 15822                                  ;
 15823                                  ;----------------------------------------------------------------------------
 15824                                  
 15825                                  _$FCB_RANDOM_READ:
 15826                                  	;mov	AL,6	
 15827 0000227B B006                    	MOV	AL,RANDOM+FCBREAD
 15828                                  	; 23/01/2024
 15829                                  	;jmp	FCBIO 		; single block
 15830 0000227D EB02                    	jmp	short FCBIO
 15831                                  
 15832                                  ;BREAK <$FCB_Random_Write - write a single record to a file >
 15833                                  ;----------------------------------------------------------------------------
 15834                                  ;
 15835                                  ;   $FCB_Random_Write - retrieve a location from the FCB, seek to it and write
 15836                                  ;	a record to it.
 15837                                  ;
 15838                                  ;   Inputs:	DS:DX point to an FCB
 15839                                  ;   Outputs:	AL = error codes defined above
 15840                                  ;
 15841                                  ;----------------------------------------------------------------------------
 15842                                  
 15843                                  _$FCB_RANDOM_WRITE:
 15844                                  	;mov	AL,2	
 15845 0000227F B002                    	MOV	AL,RANDOM
 15846                                  	; 23/01/2024
 15847                                  	;;jmp	FCBIO
 15848                                  	;jmp	short FCBIO
 15849                                  
 15850                                  ;BREAK <FCBIO - do internal FCB I/O>
 15851                                  ;---------------------------------------------------------------------------
 15852                                  ;
 15853                                  ;   FCBIO - look at FCBOP and merge all FCB operations into a single routine.
 15854                                  ;
 15855                                  ;   Inputs:	FCBOP flags which operations need to be performed
 15856                                  ;		DS:DX point to FCB
 15857                                  ;		CX may have count of number of records to xfer
 15858                                  ;   Outputs:	AL has error code
 15859                                  ;   Registers modified: all
 15860                                  ;---------------------------------------------------------------------------
 15861                                  
 15862                                  	; 09/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 15863                                  	; DOSCODE:5B17h (MSDOS 5.0 MSDOS.SYS)
 15864                                  
 15865                                  	; 23/01/2024
 15866                                  	; DOSCODE:5B2Bh (MSDOS 6.22 MSDOS.SYS)
 15867                                  
 15868                                  	; 23/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 15869                                  	; DOSCODE:61C9h (PCDOS 7.1 IBMDOS.COM)
 15870                                  
 15871                                  FCBIO:
 15872                                  
 15873                                  FEOF	EQU	1
 15874                                  FTRIM	EQU	2
 15875                                  
 15876                                  %define	FCBErr	byte [bp-1]  ; byte	
 15877                                  %define	cRec	word [bp-3]  ; word	
 15878                                  ;%define RecPos	word [bp-7]  ; dword
 15879                                  %define RecPosL	word [bp-7]  ; word
 15880                                  %define RecPosH	word [bp-5]  ; word
 15881                                  %define	RecSize	word [bp-9]  ; word
 15882                                  ;%define bPos	word [bp-13] ; dword
 15883                                  %define bPosL	word [bp-13] ; word
 15884                                  %define bPosH	word [bp-11] ; word
 15885                                  %define cByte	word [bp-15] ; word	
 15886                                  %define cResult word [bp-17] ; word	
 15887                                  %define	cRecRes	word [bp-19] ; word
 15888                                  %define	FCBOp	byte [bp-20] ; byte
 15889                                  ; 23/01/2024
 15890                                  %define bPos bp-13
 15891                                  
 15892                                  	;Enter
 15893                                  
 15894 00002281 55                      	push	bp
 15895 00002282 89E5                    	mov	bp,sp
 15896 00002284 83EC14                  	sub	sp,20
 15897                                  	;mov	[bp-20],al
 15898 00002287 8846EC                  	MOV	FCBOp,AL
 15899                                  	;mov	byte [bp-1],0
 15900 0000228A C646FF00                	MOV	FCBErr,0		;   FCBErr = 0;
 15901 0000228E E8C0FF                  	call	GetExtended		;   FCB = GetExtended ();
 15902                                  	;test	byte [bp-20],8
 15903 00002291 F646EC08                	TEST	FCBOp,BLOCK		;   if ((OP&BLOCK) == 0)
 15904 00002295 7503                    	JNZ	short GetPos
 15905 00002297 B90100                  	MOV	CX,1			;	cRec = 1;
 15906                                  GetPos:
 15907                                  	;mov	[bp-3],cx
 15908 0000229A 894EFD                  	MOV	cRec,CX 		;*Tail coalesce
 15909 0000229D E885FF                  	call	GetExtent		;   RecPos = GetExtent ();
 15910 000022A0 E8BBFF                  	call	GetRecSize		;   RecSize = GetRecSize ();
 15911                                  	;mov	[bp-9],bx
 15912 000022A3 895EF7                  	MOV	RecSize,BX
 15913                                  	;test	byte [bp-20],2
 15914 000022A6 F646EC02                	TEST	FCBOp,RANDOM		;   if ((OP&RANDOM) <> 0)
 15915 000022AA 7403                    	JZ	short GetRec
 15916 000022AC E868FF                  	call	GetRR			;	RecPos = GetRR ();
 15917                                  GetRec:
 15918                                  	;mov	[bp-7],ax
 15919 000022AF 8946F9                  	MOV	RecPosL,AX		;*Tail coalesce
 15920                                  	;mov	[bp-5],dx
 15921 000022B2 8956FB                  	MOV	RecPosH,DX
 15922 000022B5 E87FFF                  	call	SetExtent		;   SetExtent (RecPos);
 15923                                  	;mov	ax,[bp-5]
 15924 000022B8 8B46FB                  	MOV	AX,RecPosH		;   bPos = RecPos * RecSize;
 15925 000022BB F7E3                    	MUL	BX
 15926 000022BD 89C7                    	MOV	DI,AX
 15927                                  	;mov	ax,[bp-7]
 15928 000022BF 8B46F9                  	MOV	AX,RecPosL
 15929 000022C2 F7E3                    	MUL	BX
 15930 000022C4 01FA                    	ADD	DX,DI
 15931                                  	;mov	[bp-13],ax
 15932 000022C6 8946F3                  	MOV	bPosL,AX
 15933                                  	;mov	[bp-11],dx
 15934 000022C9 8956F5                  	MOV	bPosH,DX
 15935                                  	;mov	ax,[bp-3]
 15936 000022CC 8B46FD                  	MOV	AX,cRec 		;   cByte = cRec * RecSize;
 15937 000022CF F7E3                    	MUL	BX
 15938                                  	;mov	[bp-15],ax
 15939 000022D1 8946F1                  	MOV	cByte,AX
 15940                                  
 15941                                  ;hkn; 	SS override
 15942 000022D4 360306[2C03]            	ADD	AX,[SS:DMAADD]		;   if (cByte+DMA > 64K) {
 15943 000022D9 83D200                  	ADC	DX,0
 15944 000022DC 7419                    	JZ	short DoOper
 15945                                  	;mov	byte [bp-1],2
 15946 000022DE C646FF02                	MOV	FCBErr,FTRIM		;	FCBErr = FTRIM;
 15947                                  
 15948                                  ;hkn; 	SS override
 15949 000022E2 36A1[2C03]              	MOV	AX,[SS:DMAADD]		;	cRec = (64K-DMA)/RecSize;
 15950 000022E6 F7D8                    	NEG	AX
 15951 000022E8 7501                    	JNZ	short DoDiv
 15952 000022EA 48                      	DEC	AX
 15953                                  DoDiv:
 15954 000022EB 31D2                    	XOR	DX,DX
 15955 000022ED F7F3                    	DIV	BX
 15956                                  	;mov	[bp-3],ax
 15957 000022EF 8946FD                  	MOV	cRec,AX
 15958 000022F2 F7E3                    	MUL	BX			;	cByte = cRec * RecSize;
 15959                                  	;mov	[bp-15],ax
 15960 000022F4 8946F1                  	MOV	cByte,AX		;	}
 15961                                  DoOper:
 15962 000022F7 31DB                    	XOR	BX,BX
 15963                                  	;mov	[bp-17],bx
 15964 000022F9 895EEF                  	MOV	cResult,BX		;   cResult = 0;
 15965                                  	;cmp	[bp-15],bx
 15966 000022FC 395EF1                  	CMP	cByte,BX		;   if (cByte <> 0 ||
 15967 000022FF 7506                    	JNZ	short DoGetExt
 15968                                  	;test	byte [bp-1],2
 15969 00002301 F646FF02                	TEST	FCBErr,FTRIM		;	(FCBErr&FTRIM) == 0) {
 15970                                  	;JZ	short DoGetExt
 15971                                  	;JMP	short SkipOp
 15972                                  	; 16/12/2022
 15973 00002305 756E                    	jnz	short SkipOp
 15974                                  	; 09/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 15975                                  	;JZ	short DoGetExt
 15976                                  	;JMP	short SkipOp
 15977                                  DoGetExt:
 15978 00002307 E89AFE                  	call	SFTFromFCB		;	if (!SFTFromFCB (SFT,FCB))
 15979 0000230A 730F                    	JNC	short ContinueOp
 15980                                  FCBDeath:
 15981 0000230C E87AE3                  	call	FCB_RET_ERR		; signal error, map for extended
 15982                                  	;mov	word [bp-19],0
 15983 0000230F C746ED0000              	MOV	cRecRes,0		; no bytes transferred
 15984                                  	;mov	byte [bp-1],1
 15985 00002314 C646FF01                	MOV	FCBErr,FEOF		;	    return FTRIM;
 15986 00002318 E9E700                  	JMP	FCBSave 		; bam!
 15987                                  ContinueOp:
 15988                                  	; 23/01/2024
 15989                                  	; (PCDOS 7.1 IBMDOS.COM)
 15990                                  	;
 15991                                  	;;mov	ax,[si+10h]
 15992                                  	;MOV	AX,[SI+SYS_FCB.FILSIZ]
 15993                                  	;;mov	[es:di+11h],ax
 15994                                  	;MOV	[ES:DI+SF_ENTRY.sf_size],AX
 15995                                  	;;mov	ax,[si+12h]
 15996                                  	;MOV	AX,[SI+SYS_FCB.FILSIZ+2]
 15997                                  	;;mov	[es:di+13h],ax
 15998                                  	;MOV	[ES:DI+SF_ENTRY.sf_size+2],AX
 15999                                  	;;;
 16000 0000231B 1E                      	push	ds
 16001 0000231C C54410                  	lds	ax,[si+SYS_FCB.FILSIZ]
 16002 0000231F 26894511                	mov	[es:di+SF_ENTRY.sf_size],ax
 16003 00002323 268C5D13                	mov	[es:di+SF_ENTRY.sf_size+2],ds
 16004 00002327 C546F3                  	lds	ax,[bPos] ; lds ax,[bp-13]
 16005 0000232A 8CDA                    	mov	dx,ds
 16006 0000232C 1F                      	pop	ds
 16007                                  	;;;
 16008                                  	;;mov	ax,[bp-13]
 16009                                  	;MOV	AX,bPosL
 16010                                  	;;mov	dx,[bp-11]
 16011                                  	;MOV	DX,bPosH
 16012                                  	
 16013                                  	;mov	[es:di+15h],ax
 16014 0000232D 26894515                	MOV	[ES:DI+SF_ENTRY.sf_position],AX
 16015                                  	;xchg	dx,[es:di+17h]
 16016 00002331 26875517                	XCHG	[ES:DI+SF_ENTRY.sf_position+2],DX
 16017 00002335 52                      	PUSH	DX			; save away Open age.
 16018                                  	;mov	cx,[bp-15]
 16019 00002336 8B4EF1                  	MOV	CX,cByte		;	cResult =
 16020                                  
 16021                                  ;hkn; DOS_Read is in DOSCODE
 16022 00002339 BF[7B3B]                	MOV	DI,DOS_READ		;	    *(OP&FCBRead ? DOS_Read
 16023                                  	;test	byte [bp-20],4
 16024 0000233C F646EC04                	TEST	FCBOp,FCBREAD		;		 : DOS_Write)(cRec);
 16025 00002340 7503                    	JNZ	short DoContext
 16026                                  
 16027                                  ;hkn; DOS_Write is in DOSCODE
 16028 00002342 BF[7C3D]                	MOV	DI,DOS_WRITE
 16029                                  DoContext:
 16030 00002345 55                      	push	bp
 16031 00002346 1E                      	push	ds
 16032 00002347 56                      	push	si
 16033                                  
 16034                                  ;hkn; SS is DOSDATA
 16035 00002348 16                      	push	ss
 16036 00002349 1F                      	pop	ds
 16037                                  
 16038                                  ;; Fix for disk full
 16039 0000234A FFD7                    	CALL	DI	; DOS_READ or DOS_WRITE	
 16040                                  	
 16041 0000234C 5E                      	pop	si
 16042 0000234D 1F                      	pop	ds
 16043 0000234E 5D                      	pop	bp
 16044 0000234F 72BB                    	JC	short FCBDeath
 16045                                  	
 16046 00002351 36803E[0B06]00          	CMP	BYTE [SS:DISK_FULL],0	; treat disk full as error
 16047 00002357 7406                    	JZ	short NODSKFULL
 16048 00002359 36C606[0B06]00          	MOV	BYTE [SS:DISK_FULL],0	; clear the flag
 16049                                  
 16050                                  	; 23/01/2024
 16051                                  	; (PCDOS 7.1 IBMDOS.COM)
 16052                                  	;;mov	byte [bp-1],1 
 16053                                  	;MOV	FCBErr,FEOF		; set disk full flag
 16054                                  
 16055                                  NODSKFULL:
 16056                                  ;; Fix for disk full
 16057                                  	;mov	[bp-17],cx
 16058 0000235F 894EEF                  	MOV	cResult,CX
 16059 00002362 E8FFFA                  	call	SaveFCBInfo		;	SaveFCBInfo (FCB);
 16060                                  	;pop	word [es:di+17h]	
 16061 00002365 268F4517                	POP	WORD [ES:DI+SF_ENTRY.sf_position+2] ; restore open age
 16062                                  			       ; (sf_OpenAge = SF_ENTRY.sf_position+2)
 16063                                  
 16064                                  	; 23/01/2024
 16065                                  	; (PCDOS 7.1 IBMDOS.COM)
 16066                                  	;
 16067                                  	;;mov	ax,[es:di+11h]
 16068                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_size]
 16069                                  	;;mov	[si+10h],ax
 16070                                  	;MOV	[SI+SYS_FCB.FILSIZ],AX
 16071                                  	;;mov	ax,[es:di+13h]
 16072                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_size+2]
 16073                                  	;;mov	[si+12h],ax
 16074                                  	;MOV	[SI+SYS_FCB.FILSIZ+2],AX
 16075                                  	;;;
 16076 00002369 06                      	push	es
 16077 0000236A 26C44511                	les	ax,[es:di+SF_ENTRY.sf_size]
 16078 0000236E 894410                  	mov	[si+SYS_FCB.FILSIZ],ax
 16079 00002371 8C4412                  	mov	[si+SYS_FCB.FILSIZ+2],es
 16080 00002374 07                      	pop	es
 16081                                  	;;;
 16082                                  					;	}
 16083                                  SkipOp:
 16084                                  	;mov	ax,[bp-17]
 16085 00002375 8B46EF                  	MOV	AX,cResult		;   cRecRes = cResult / RecSize;
 16086 00002378 31D2                    	XOR	DX,DX
 16087                                  	;div	word [bp-9]
 16088 0000237A F776F7                  	DIV	RecSize
 16089                                  	;mov	[bp-19],ax
 16090 0000237D 8946ED                  	MOV	cRecRes,AX
 16091                                  	;add	[bp-7],ax
 16092 00002380 0146F9                  	ADD	RecPosL,AX		;   RecPos += cRecResult;
 16093                                  	;adc	word [bp-5],0
 16094 00002383 8356FB00                	ADC	RecPosH,0
 16095                                  
 16096                                  ; If we have not gotten the expected number of records, we signal an EOF
 16097                                  ; condition. On input, this is EOF. On output this is usually disk full.
 16098                                  ; BUT... Under 2.0 and before, all device output IGNORED this condition. So
 16099                                  ; do we.
 16100                                  
 16101                                  	;cmp	ax,[bp-3]
 16102 00002387 3B46FD                  	CMP	AX,cRec 		;   if (cRecRes <> cRec)
 16103 0000238A 7411                    	JZ	short TryBlank
 16104                                  	;test	byte [bp-20],4
 16105 0000238C F646EC04                	TEST	FCBOp,FCBREAD		;	if (OP&FCBRead || !DEVICE)
 16106 00002390 7507                    	JNZ	short SetEOF
 16107                                  	; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 16108                                  	; MSDOS 3.3
 16109                                  	;;test	word [es:di+5],80h
 16110                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device
 16111                                  	;JNZ	short TryBlank
 16112                                  	; MSDOS 5.0 & MSDOS 6.0
 16113                                  	;test	byte [es:di+5],80h
 16114 00002392 26F6450580              	test	byte [ES:DI+SF_ENTRY.sf_flags],devid_device
 16115 00002397 7504                    	jnz	short TryBlank
 16116                                  
 16117                                  SetEOF:
 16118                                  	;mov	byte [bp-1],1
 16119 00002399 C646FF01                	MOV	FCBErr,FEOF		;	FCBErr = FEOF;
 16120                                  TryBlank:				;
 16121 0000239D 09D2                    	OR	DX,DX			;   if (cResult%RecSize <> 0) {
 16122 0000239F 7426                    	JZ	short SetExt
 16123                                  	;add	word [bp-7],1
 16124 000023A1 8346F901                	ADD	RecPosL,1		;	RecPos++;
 16125                                  	;adc	word [bp-5],0
 16126 000023A5 8356FB00                	ADC	RecPosH,0
 16127                                  	;test	byte [bp-20],4
 16128 000023A9 F646EC04                	TEST	FCBOp,FCBREAD		;	if(OP&FCBRead) <> 0) {
 16129 000023AD 7418                    	JZ	short SetExt
 16130                                  	;inc	word [bp-19]
 16131 000023AF FF46ED                  	INC	cRecRes 		;	cRecRes++;
 16132                                  	;mov	byte [bp-1],3
 16133 000023B2 C646FF03                	MOV	FCBErr,FTRIM+FEOF	;	FCBErr = FTRIM | FEOF;
 16134                                  	;mov	cx,[bp-9]
 16135 000023B6 8B4EF7                  	MOV	CX,RecSize		;	Blank (RecSize-cResult%RecSize,
 16136 000023B9 29D1                    	SUB	CX,DX			;	       DMA+cResult);
 16137 000023BB 30C0                    	XOR	AL,AL
 16138                                  ;hkn; 	SS override
 16139 000023BD 36C43E[2C03]            	les     di,[ss:DMAADD]
 16140                                  	;add	di,[bp-17]
 16141 000023C2 037EEF                  	ADD	DI,cResult
 16142 000023C5 F3AA                    	REP	STOSB			;   }	}
 16143                                  SetExt:
 16144                                  	;mov	dx,[bp-5]
 16145 000023C7 8B56FB                  	MOV	DX,RecPosH
 16146                                  	;mov	ax,[bp-7]
 16147 000023CA 8B46F9                  	MOV	AX,RecPosL
 16148                                  	;test	byte [bp-20],2
 16149 000023CD F646EC02                	TEST	FCBOp,RANDOM		;   if ((OP&Random) == 0 ||
 16150 000023D1 7406                    	JZ	short DoSetExt
 16151                                  	;test	byte [bp-20],8
 16152 000023D3 F646EC08                	TEST	FCBOp,BLOCK		;	(OP&BLOCK) <> 0)
 16153 000023D7 7403                    	JZ	short TrySetRR
 16154                                  DoSetExt:
 16155 000023D9 E85BFE                  	call	SetExtent		;	SetExtent (RecPos, FCB);
 16156                                  TrySetRR:
 16157                                  	;test	byte [bp-20],8
 16158 000023DC F646EC08                	TEST	FCBOp,BLOCK		;   if ((op&BLOCK) <> 0)
 16159 000023E0 740F                    	JZ	short TryReturn
 16160                                  	;mov	[si+21h],ax
 16161 000023E2 894421                  	MOV	[SI+SYS_FCB.RR],AX	;	FCB->RR = RecPos;
 16162                                  	;mov	[si+23h],dl
 16163 000023E5 885423                  	MOV	[SI+SYS_FCB.RR+2],DL
 16164                                  	;cmp	word [si+0Eh],64
 16165 000023E8 837C0E40                	CMP	word [SI+SYS_FCB.RECSIZ],64
 16166 000023EC 7303                    	JAE	short TryReturn
 16167                                  	;mov	[si+24h],dh
 16168 000023EE 887424                  	MOV	[SI+SYS_FCB.RR+2+1],DH	; Set 4th byte only if record size < 64
 16169                                  TryReturn: 
 16170                                  	;test	byte [bp-20],4
 16171 000023F1 F646EC04                	TEST	FCBOp,FCBREAD		;   if (!(FCBOP & FCBREAD)) {
 16172 000023F5 750B                    	JNZ	short FCBSave
 16173 000023F7 1E                      	push	ds			;	FCB->FDate = date;
 16174 000023F8 E861E7                  	call	DATE16			;	FCB->FTime = time;
 16175 000023FB 1F                      	pop	ds
 16176                                  	;mov	[si+14h],ax
 16177 000023FC 894414                  	MOV	[SI+SYS_FCB.FDATE],AX
 16178                                  	;mov	[si+16h],dx
 16179 000023FF 895416                  	MOV	[SI+SYS_FCB.FTIME],DX	;	}
 16180                                  FCBSave: 
 16181                                  	;test	byte [bp-20],8
 16182 00002402 F646EC08                	TEST	FCBOp,BLOCK		;   if ((op&BLOCK) <> 0)
 16183 00002406 7409                    	jz	short DoReturn
 16184                                  	;mov	cx,[bp-19]
 16185 00002408 8B4EED                  	MOV	CX,cRecRes		;	user_CX = cRecRes;
 16186 0000240B E869E0                  	call    Get_User_Stack
 16187                                  	;mov	[si+4],cx
 16188 0000240E 894C04                  	MOV	[SI+user_env.user_CX],CX
 16189                                  DoReturn:
 16190                                  	;mov	al,[bp-1]
 16191 00002411 8A46FF                  	MOV	AL,FCBErr		;   return (FCBERR);
 16192                                  	;Leave	
 16193 00002414 89EC                    	mov     sp,bp
 16194 00002416 5D                      	pop     bp
 16195 00002417 C3                      	retn
 16196                                  
 16197                                  ; 22/07/2018 - Retro DOS v3.0
 16198                                  
 16199                                  ;Break <$FCB_Open - open an old-style FCB>
 16200                                  ;---------------------------------------------------------------------------
 16201                                  ;
 16202                                  ;   $FCB_Open - CPM compatability file open. The user has formatted an FCB
 16203                                  ;	for us and asked to have the rest filled in.
 16204                                  ;
 16205                                  ;   Inputs:	DS:DX point to an unopenned FCB
 16206                                  ;   Outputs:	AL indicates status 0 is ok FF is error
 16207                                  ;		FCB has the following fields filled in:
 16208                                  ;		    Time/Date Extent/NR Size
 16209                                  ;---------------------------------------------------------------------------
 16210                                  
 16211                                  	; 23/01/2024 - Retro DOS v5.0
 16212                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:6362h
 16213                                  
 16214                                  _$FCB_OPEN:			; System call 15
 16215                                  	
 16216                                  	;mov	ax,2 
 16217 00002418 B80200                  	MOV	AX,SHARING_COMPAT+open_for_both
 16218                                  
 16219                                  ;hkn; DOS_Open is in DOSCODE
 16220 0000241B B9[FC31]                	MOV	CX,DOS_OPEN
 16221                                  
 16222                                  ; The following is common code for Creation and openning of FCBs. AX is
 16223                                  ; either attributes (for create) or open mode (for open)... DS:DX points to
 16224                                  ; the FCB
 16225                                  
 16226                                  DoAccess:
 16227 0000241E 1E                      	push	ds
 16228 0000241F 52                      	push	dx
 16229 00002420 51                      	push	cx
 16230 00002421 50                      	push	ax			; save FCB pointer away
 16231                                  
 16232                                  ;hkn; 	OpenBuf is in DOSDATA
 16233 00002422 BF[BE03]                	MOV	DI,OPENBUF
 16234 00002425 E80458                  	call	TransFCB		; crunch the fcb
 16235 00002428 58                      	pop	ax
 16236 00002429 59                      	pop	cx
 16237 0000242A 5A                      	pop	dx
 16238 0000242B 1F                      	pop	ds			; get fcb
 16239 0000242C 7303                    	JNC	short FindFCB		; everything seems ok
 16240                                  FCBOpenErr:
 16241                                  	; AL has error code
 16242 0000242E E958E2                  	jmp	FCB_RET_ERR
 16243                                  FindFCB:
 16244 00002431 E81DFE                  	call	GetExtended		; DS:SI will point to FCB
 16245                                  
 16246                                  	; 17/05/2019 - Retro DOS v4.0
 16247                                  
 16248                                  	; MSDOS 3.3
 16249                                  	;call	LRUFCB
 16250                                  	;jc	short HardMessage
 16251                                  
 16252                                  	; MSDOS 6.0
 16253 00002434 50                      	push	ax
 16254 00002435 B001                    	mov	al,1			;indicate Open/Create operation
 16255 00002437 E8F8FA                  	call	LRUFCB			; get a sft entry (no error)
 16256 0000243A 58                      	pop	ax
 16257 0000243B 722A                    	jc	short HardMessage
 16258                                  	
 16259                                  	;mov	word [es:di+2],8000h
 16260 0000243D 26C745020080            	mov	word [es:di+SF_ENTRY.sf_mode],sf_isFCB
 16261 00002443 1E                      	push	ds
 16262 00002444 56                      	push	si	
 16263 00002445 53                      	push	bx			; save fcb pointer
 16264 00002446 89CE                    	MOV	SI,CX
 16265                                  
 16266                                  ;hkn; SS is DOSDATA
 16267 00002448 16                      	push	ss
 16268 00002449 1F                      	pop	ds			    ; let DOS_Open see variables
 16269 0000244A FFD6                    	CALL	SI ; DOS_OPEN or DOS_CREATE ; go open the file
 16270 0000244C 5B                      	pop	bx
 16271 0000244D 5E                      	pop	si
 16272 0000244E 1F                      	pop	ds			; get fcb
 16273                                  
 16274                                  ;hkn; SS override
 16275 0000244F 36C43E[9E05]            	LES	DI,[SS:THISSFT]		; get sf pointer
 16276 00002454 7318                    	JNC	short FCBOK		; operation succeeded
 16277                                  failopen:
 16278 00002456 50                      	PUSH	AX
 16279 00002457 B052                    	MOV	AL,"R"	; 52h		; clear out field (free sft)
 16280 00002459 E8C2FC                  	call	BlastSFT
 16281 0000245C 58                      	POP	AX
 16282                                  	;cmp	ax,4
 16283 0000245D 83F804                  	CMP	AX,error_too_many_open_files
 16284 00002460 7405                    	JZ	short HardMessage
 16285                                  	;cmp	ax,24h
 16286 00002462 83F824                  	CMP	AX,error_sharing_buffer_exceeded
 16287 00002465 7505                    	jnz	short DeadFCB
 16288                                  HardMessage:
 16289 00002467 50                      	PUSH	AX
 16290 00002468 E86FFD                  	call	FCBHardErr
 16291 0000246B 58                      	POP	AX
 16292                                  DeadFCB:
 16293                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 16294                                  	;jmp	FCB_RET_ERR
 16295 0000246C EBC0                    	jmp	short FCBOpenErr
 16296                                  FCBOK:
 16297                                  	; MSDOS 6.0
 16298 0000246E E8C9F3                  	call	IsSFTNet		;AN007;F.C. >32mb  Non Fat file?
 16299 00002471 7531                    	JNZ	short FCBOK2		;AN007;F.C. >32mb  yes
 16300 00002473 E8F15F                  	call	CheckShare		;AN000;F.C. >32mb  share around?
 16301                                  	;JNZ	short FCBOK2		;AN000;F.C. >32mb  yes
 16302                                  	; 23/01/2024 - Retro DOS v5.0
 16303                                  	; (PCDOS 7.1 IBMDOS.COM)
 16304 00002476 750A                    	jnz	short FCBOK1
 16305                                  
 16306                                  ;SR;
 16307                                  ; If we reach here, we know we have got a local SFT. Let's update the 
 16308                                  ; LocalSFT variable to reflect this.
 16309                                  
 16310 00002478 36893E[760F]            	mov	[ss:LocalSFT],di
 16311 0000247D 368C06[780F]            	mov	[ss:LocalSFT+2],es; Store the SFT address
 16312                                  ;;SR;
 16313                                  ;; The check below is not valid anymore since we regenerate for media > 32M.
 16314                                  ;;
 16315                                  ;;	CMP	WORD [ES:DI+SF_ENTRY.sf_dirsec+2],0 
 16316                                  ;;					       ;AN000;F.C. >32mb  if dirsec >32mb
 16317                                  ;;	JZ	short FCBOK2		       ;AN000;F.C. >32mb    then error
 16318                                  ;;	MOV	AX,error_sys_comp_not_loaded   ;AN000;F.C. >32mb
 16319                                  ;;	JMP	short failopen		       ;AN000;F.C. >32mb
 16320                                  
 16321                                  	; 23/01/2024 - Retro DOS v5.0
 16322                                  	; (PCDOS 7.1 IBMDOS.COM)
 16323                                  	;;;
 16324                                  FCBOK1:
 16325                                  	;test	byte [es:di+5],80h
 16326 00002482 26F6450580              	test	byte [es:di+SF_ENTRY.sf_flags],devid_device
 16327 00002487 751B                    	jnz	short FCBOK2	; local device
 16328                                  	;test	byte [es:di+4],8
 16329 00002489 26F6450408              	test	byte [es:di+SF_ENTRY.sf_attr],attr_volume_id
 16330 0000248E 7514                    	jnz	short FCBOK2
 16331                                  		; local file
 16332 00002490 06                      	push	es
 16333 00002491 57                      	push	di
 16334                                  	;les	di,[es:di+0Fh]
 16335 00002492 26C47D07                	les	di,[es:di+SF_ENTRY.sf_devptr] ; local file's DPB
 16336                                  	;cmp	word [es:di+0Fh],0
 16337 00002496 26837D0F00              	cmp	word [es:di+DPB.FAT_SIZE],0 ; (16 bit FAT size)	
 16338 0000249B 5F                      	pop	di
 16339 0000249C 07                      	pop	es
 16340 0000249D 7505                    	jnz	short FCBOK2	; not FAT32 (ok)
 16341                                  	;mov	ax,0Fh		; error_invalid_drive (for FAT32)
 16342 0000249F B80F00                  	mov	ax,error_invalid_drive
 16343 000024A2 EBB2                    	jmp	short failopen
 16344                                  	;;; 
 16345                                  
 16346                                  FCBOK2:
 16347                                  	; MSDOS 6.0 (& MSDOS 3.3)
 16348 000024A4 26FF05                  	inc	word [es:di]
 16349                                  	;INC	word [ES:DI+SF_ENTRY.sf_ref_count] ; increment reference count
 16350                                  
 16351                                  	; 23/01/2024 - Retro DOS v5.0
 16352                                  	; (PCDOS 7.1 IBMDOS.COM)
 16353                                  	;;;
 16354 000024A7 E87E25                  	call	set_sftfcb_entry
 16355                                  	;;;
 16356                                  
 16357 000024AA E8B7F9                  	call	SaveFCBInfo
 16358                                  
 16359                                  	; MSDOS 3.3
 16360                                  	;call	SetOpenAge
 16361                                  	; MSDOS 6.0 (& MSDOS 3.3)
 16362                                  	;test	word [es:di+5],80h
 16363                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device
 16364 000024AD 26F6450580              	test	byte [ES:DI+SF_ENTRY.sf_flags],devid_device  ; 28/07/2019
 16365 000024B2 7508                    	JNZ	short FCBNoDrive	; do not munge drive on devices
 16366                                  
 16367 000024B4 8A04                    	MOV	AL,[SI]			; get drive byte
 16368 000024B6 E80457                  	call	GETTHISDRV		; convert
 16369                                  	;INC	AL
 16370                                  	; 17/12/2022
 16371 000024B9 40                      	inc	ax
 16372 000024BA 8804                    	MOV	[SI],AL			; stash in good drive letter
 16373                                  
 16374                                  FCBNoDrive:
 16375                                  	;mov	word [si+0Eh],128
 16376 000024BC C7440E8000              	MOV	word [SI+SYS_FCB.RECSIZ],80h ; stuff in default record size
 16377                                  
 16378                                  	; 23/01/2024 - Retro DOS v5.0
 16379                                  	; (PCDOS 7.1 IBMDOS.COM)
 16380                                  	;;;
 16381                                  	;;mov	ax,[es:di+0Dh]
 16382                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_time] ; set time
 16383                                  	;;mov	[si+16h],ax
 16384                                  	;MOV	[SI+SYS_FCB.FTIME],AX
 16385                                  	;;mov	ax,[es:di+0Fh]
 16386                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_date] ; set date
 16387                                  	;;mov	[si+14h],ax
 16388                                  	;MOV	[SI+SYS_FCB.FDATE],AX
 16389                                  	;;mov	ax,[es:di+11h]
 16390                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_size] ; set sizes
 16391                                  	;;mov	[si+10h],ax
 16392                                  	;MOV	[SI+SYS_FCB.FILSIZ],AX
 16393                                  	;;mov	ax,[es:di+13h]
 16394                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_size+2]
 16395                                  	;;mov	[si+12h],ax
 16396                                  	;MOV	[SI+SYS_FCB.FILSIZ+2],AX
 16397                                  	;
 16398 000024C1 06                      	push	es
 16399                                  	;les	ax,[es:di+0Dh]
 16400 000024C2 26C4450D                	les	ax,[es:di+SF_ENTRY.sf_time]
 16401                                  	;mov	[si+16h],ax
 16402 000024C6 894416                  	mov	[si+SYS_FCB.FTIME],ax	; set time
 16403                                  	;mov	[si+14h],es
 16404 000024C9 8C4414                  	mov	[si+SYS_FCB.FDATE],es	; set date
 16405 000024CC 07                      	pop	es
 16406 000024CD 06                      	push	es
 16407                                  	;les	ax,[es:di+11h]
 16408 000024CE 26C44511                	les	ax,[es:di+SF_ENTRY.sf_size] ; set size
 16409                                  	;mov	[si+10h],ax
 16410 000024D2 894410                  	mov	[si+SYS_FCB.FILSIZ],ax
 16411                                  	;mov	[si+12h],ax
 16412 000024D5 8C4412                  	mov	[si+SYS_FCB.FILSIZ+2],es
 16413 000024D8 07                      	pop	es
 16414                                  	;;;
 16415                                  	
 16416 000024D9 31C0                    	XOR	AX,AX			; convenient zero
 16417                                  	;mov	[si+0Ch],ax
 16418 000024DB 89440C                  	MOV	[SI+SYS_FCB.EXTENT],AX	; point to beginning of file
 16419                                  
 16420                                  ; We must scan the set of FCB SFTs for one that appears to match the current
 16421                                  ; one.	We cheat and use CheckFCB to match the FCBs.
 16422                                  
 16423                                  ;hkn; 	SS override
 16424 000024DE 36C43E[4000]            	LES	DI,[SS:SFTFCB]		; get the pointer to head of the list
 16425                                  	;mov	ah,[es:di+4]
 16426 000024E3 268A6504                	MOV	AH,[ES:DI+SFT.SFCount]	; get number of SFTs to scan
 16427                                  OpenScan:
 16428                                  	;cmp	al,[si+18h]
 16429 000024E7 3A4418                  	CMP	AL,[SI+fcb_sfn]		; don't compare ourselves
 16430 000024EA 7407                    	JZ	short SkipCheck
 16431 000024EC 50                      	push	ax			; preserve count
 16432 000024ED E847FC                  	call	CheckFCB		; do they match
 16433 000024F0 58                      	pop	ax			; get count back
 16434 000024F1 7309                    	JNC	short OpenFound		; found a match!
 16435                                  SkipCheck:
 16436 000024F3 FEC0                    	INC	AL			; advance to next FCB
 16437 000024F5 38E0                    	CMP	AL,AH			; table full?
 16438 000024F7 75EE                    	JNZ	short OpenScan		; no, go for more
 16439                                  OpenDone:
 16440 000024F9 30C0                    	xor	al,al			; return success
 16441 000024FB C3                      	retn
 16442                                  
 16443                                  ; The SFT at ES:DI is the one that is already in use for this FCB. We set the
 16444                                  ; FCB to use this one. We increment its ref count. We do NOT close it at all.
 16445                                  ; Consider:
 16446                                  ;
 16447                                  ;   open (foo)	delete (foo) open (bar)
 16448                                  ;
 16449                                  ; This causes us to recycle (potentially) bar through the same local SFT as
 16450                                  ; foo even though foo is no longer needed; this is due to the server closing
 16451                                  ; foo for us when we delete it. Unfortunately, we cannot see this closure.
 16452                                  ; If we were to CLOSE bar, the server would then close the only reference to
 16453                                  ; bar and subsequent I/O would be lost to the redirector.
 16454                                  ;
 16455                                  ; This gets solved by NOT closing the sft, but zeroing the ref count
 16456                                  ; (effectively freeing the SFT) and informing the sharer (if relevant) that
 16457                                  ; the SFT is no longer in use. Note that the SHARER MUST keep its ref counts
 16458                                  ; around. This will allow us to access the same file through multiple network
 16459                                  ; connections and NOT prematurely terminate when the ref count on one
 16460                                  ; connection goes to zero.
 16461                                  
 16462                                  OpenFound:
 16463                                  	;mov	[si+18h],al
 16464 000024FC 884418                  	MOV	[SI+fcb_sfn],AL 	; assign with this
 16465 000024FF 26FF05                  	inc	word [es:di]
 16466                                  	;INC	word [ES:DI+SF_ENTRY.sf_ref_count]
 16467                                  					; remember this new invocation
 16468                                  	; 23/01/2024 - Retro DOS v5.0
 16469                                  	; (PCDOS 7.1 IBMDOS.COM)
 16470                                  	;;;
 16471 00002502 E82325                  	call	set_sftfcb_entry
 16472                                  	;;;
 16473                                  
 16474                                  	; 24/01/2024
 16475 00002505 16                      	push	ss
 16476 00002506 1F                      	pop	ds
 16477                                  	
 16478                                  	;MOV	AX,[SS:FCBLRU]		; update LRU counts
 16479 00002507 A1[1000]                	mov	ax,[FCBLRU] ; 24/01/2024
 16480                                  	;mov	[es:di+15h],ax
 16481 0000250A 26894515                	MOV	[ES:DI+sf_LRU],AX
 16482                                  ;
 16483                                  ; We have an FCB sft that is now of no use. We release sharing info and then
 16484                                  ; blast it to prevent other reuse.
 16485                                  ;
 16486                                  	;push	ss
 16487                                  	;pop	ds
 16488                                  	
 16489 0000250E C43E[9E05]              	LES	DI,[THISSFT]
 16490 00002512 26FF0D                  	dec	word [es:di]
 16491                                  	;DEC	word [ES:DI+SF_ENTRY.sf_ref_count]
 16492                                  					; free the newly allocated SFT
 16493 00002515 E8A05F                  	call	ShareEnd
 16494 00002518 B043                    	MOV	AL,'C'	 ; 43h
 16495 0000251A E801FC                  	call	BlastSFT
 16496 0000251D EBDA                    	JMP	short OpenDone
 16497                                  
 16498                                  ;BREAK	<$FCB_Create - create a new directory entry>
 16499                                  ;----------------------------------------------------------------------------
 16500                                  ;
 16501                                  ;   $FCB_Create - CPM compatability file create. The user has formatted an
 16502                                  ;	FCB for us and asked to have the rest filled in.
 16503                                  ;
 16504                                  ;   Inputs:	DS:DX point to an unopenned FCB
 16505                                  ;   Outputs:	AL indicates status 0 is ok FF is error
 16506                                  ;		FCB has the following fields filled in:
 16507                                  ;		    Time/Date Extent/NR Size
 16508                                  ;----------------------------------------------------------------------------
 16509                                  
 16510                                  _$FCB_CREATE:		; System call 22
 16511                                  
 16512                                  ;hkn; DOS_Create is in DOSCODE
 16513 0000251F B9[CB30]                	MOV	CX,DOS_CREATE		; routine to call
 16514 00002522 31C0                    	XOR	AX,AX			; attributes to create
 16515 00002524 E82AFD                  	call	GetExtended		; get extended FCB
 16516 00002527 7403                    	JZ	short DoAccessJ		; not an extended FCB
 16517 00002529 8A44FF                  	MOV	AL,[SI-1]		; get attributes
 16518                                  DoAccessJ:
 16519 0000252C E9EFFE                  	JMP	DoAccess		; do dirty work
 16520                                  
 16521                                  ;============================================================================
 16522                                  ; SEARCH.ASM, MSDOS 6.0, 1991
 16523                                  ;============================================================================
 16524                                  ; 22/07/2018 - Retro DOS v3.0
 16525                                  ; 17/05/2019 - Retro DOS v4.0
 16526                                  
 16527                                  ; DOSCODE:5DDFh (MSDOS 6.21, MSDOS.SYS)
 16528                                  
 16529                                  ; 09/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 16530                                  ; DOSCODE:5DCBh (MSDOS 5.0, MSDOS.SYS)
 16531                                  
 16532                                  ;**	Search.asm
 16533                                  ;----------------------------------------------------------------------------
 16534                                  ;	Directory search system calls.
 16535                                  ;	These will be passed direct text of the pathname from the user. 
 16536                                  ;	They will need to be passed through the macro expander prior to
 16537                                  ;	being sent through the low-level stuff. 
 16538                                  ;	I/O specs are defined in DISPATCH. The system calls are:
 16539                                  ;
 16540                                  ;	$Dir_Search_First	  written
 16541                                  ;	$Dir_Search_Next	  written
 16542                                  ;	$Find_First	  written
 16543                                  ;	$Find_Next		  written
 16544                                  ;	PackName		  written
 16545                                  ;
 16546                                  ;	Modification history:
 16547                                  ;
 16548                                  ;	  Created: ARR 4 April 1983
 16549                                  
 16550                                  ;----------------------------------------------------------------------------
 16551                                  ; Procedure Name : $DIR_SEARCH_FIRST
 16552                                  ;
 16553                                  ; Inputs:
 16554                                  ;	DS:DX Points to unopenned FCB
 16555                                  ; Function:
 16556                                  ;	Directory is searched for first matching entry and the directory
 16557                                  ;	entry is loaded at the disk transfer address
 16558                                  ; Returns:
 16559                                  ;	AL = -1 if no entries matched, otherwise 0
 16560                                  ;----------------------------------------------------------------------------
 16561                                  
 16562                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 2B88h
 16563                                  	
 16564                                  	; 24/01/2024
 16565                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:5DCBh
 16566                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:5DDFh
 16567                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:647Bh
 16568                                  	; Windows ME IO.SYS - BIOSCODE:61E5h
 16569                                  
 16570                                  _$DIR_SEARCH_FIRST:
 16571 0000252F 368916[A605]            	MOV	[SS:THISFCB],DX
 16572 00002534 368C1E[A805]            	MOV	[SS:THISFCB+2],DS
 16573 00002539 89D6                    	MOV	SI,DX
 16574 0000253B 803CFF                  	CMP	BYTE [SI],0FFH
 16575 0000253E 7503                    	JNZ	short NORMFCB4
 16576 00002540 83C607                  	ADD	SI,7			; Point to drive select byte
 16577                                  NORMFCB4:
 16578 00002543 FF34                    	push	word [SI]		; Save original drive byte for later
 16579                                  
 16580 00002545 16                      	push	ss
 16581 00002546 07                      	pop	es			; get es to address DOSGroup
 16582                                  
 16583 00002547 BF[BE03]                	MOV	DI,OPENBUF		; appropriate buffer
 16584 0000254A E8DF56                  	call	TransFCB		; convert the FCB, set SATTRIB EXTFCB
 16585 0000254D 7304                    	JNC	short SearchIt		; no error, go and look
 16586 0000254F 5B                      	pop	bx			; Clean stack
 16587                                  
 16588                                  ; Error code is in AX
 16589                                  
 16590                                  	; 09/11/2022
 16591                                  dcf_errj:
 16592 00002550 E936E1                  	jmp	FCB_RET_ERR		; error
 16593                                  
 16594                                  SearchIt:
 16595 00002553 16                      	push	ss
 16596 00002554 1F                      	pop	ds			; get ready for search
 16597                                  	;push	word [DMAADD]
 16598                                  	;push	word [DMAADD+2]
 16599                                  	; 24/01/2024
 16600 00002555 C43E[2C03]              	les	di,[DMAADD]
 16601 00002559 57                      	push	di
 16602 0000255A 06                      	push	es
 16603 0000255B C706[2C03][BE04]        	MOV	WORD [DMAADD],SEARCHBUF
 16604 00002561 8C1E[2E03]              	MOV	WORD [DMAADD+2],DS
 16605                                  	; MSDOS 3.3
 16606                                  	;call	DOS_SEARCH_FIRST
 16607                                  	; MSDOS 6.0
 16608 00002565 E8B70F                  	call	GET_FAST_SEARCH		; search
 16609 00002568 8F06[2E03]              	pop	word [DMAADD+2]
 16610 0000256C 8F06[2C03]              	pop	word [DMAADD]
 16611 00002570 735A                    	JNC	short SearchSet		; no error, transfer info
 16612 00002572 5B                      	pop	bx			; Clean stack
 16613                                  
 16614                                  ; Error code is in AX
 16615                                  
 16616                                  	; 09/11/2022
 16617                                  	;jmp	FCB_RET_ERR
 16618 00002573 EBDB                    	jmp	short dcf_errj
 16619                                  
 16620                                  ;----------------------------------------------------------------------------
 16621                                  ;
 16622                                  ; Procedure Name : $DIR_SEARCH_NEXT
 16623                                  ;
 16624                                  ; Inputs:
 16625                                  ;	DS:DX points to unopenned FCB returned by $DIR_SEARCH_FIRST
 16626                                  ; Function:
 16627                                  ;	Directory is searched for the next matching entry and the directory
 16628                                  ;	entry is loaded at the disk transfer address
 16629                                  ; Returns:
 16630                                  ;	AL = -1 if no entries matched, otherwise 0
 16631                                  ;----------------------------------------------------------------------------
 16632                                  
 16633                                  	; 24/01/2024
 16634                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:5E5Fh
 16635                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:5E73h
 16636                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:6517h
 16637                                  	; Windows ME IO.SYS - BIOSCODE:6273h
 16638                                  
 16639                                  _$DIR_SEARCH_NEXT:
 16640 00002575 368916[A605]            	MOV	[SS:THISFCB],DX
 16641 0000257A 368C1E[A805]            	MOV	[SS:THISFCB+2],DS
 16642                                  	; 24/01/2024 (PCDOS 7.1)
 16643                                  	;MOV	byte [SS:SATTRIB],0
 16644                                  	;MOV	byte [SS:EXTFCB],0
 16645 0000257F B000                    	mov	al,0
 16646 00002581 36A2[6D05]              	mov	[SS:SATTRIB],al ; 0
 16647 00002585 36A2[6D05]              	mov	[SS:SATTRIB],al ; 0
 16648                                  
 16649 00002589 16                      	push	ss
 16650 0000258A 07                      	pop	es
 16651                                  
 16652 0000258B BF[BE04]                	MOV	DI,SEARCHBUF
 16653                                  
 16654 0000258E 89D6                    	MOV	SI,DX
 16655 00002590 803CFF                  	CMP	BYTE [SI],0FFh
 16656 00002593 750D                    	JNZ	short NORMFCB6
 16657 00002595 83C606                  	ADD	SI,6
 16658 00002598 AC                      	LODSB
 16659                                  
 16660 00002599 36A2[6D05]              	MOV	[SS:SATTRIB],AL
 16661 0000259D 36FE0E[6C05]            	DEC	byte [SS:EXTFCB]
 16662                                  NORMFCB6:
 16663 000025A2 AC                      	LODSB				; Get original user drive byte
 16664 000025A3 50                      	push	ax			; Put it on stack
 16665 000025A4 8A4414                  	MOV	AL,[SI+20]		; Get correct search contin drive byte
 16666 000025A7 AA                      	STOSB				; Put in correct place
 16667 000025A8 B90A00                  	MOV	CX,20/2
 16668 000025AB F3A5                    	REP	MOVSW			; Transfer in rest of search contin info
 16669                                  
 16670 000025AD 16                      	push	ss
 16671 000025AE 1F                      	pop	ds
 16672                                  
 16673                                  	;push	word [DMAADD]
 16674                                  	;push	word [DMAADD+2]
 16675                                  	; 24/01/2024
 16676 000025AF C43E[2C03]              	les	di,[DMAADD]
 16677 000025B3 57                      	push	di
 16678 000025B4 06                      	push	es
 16679 000025B5 C706[2C03][BE04]        	MOV	WORD [DMAADD],SEARCHBUF
 16680 000025BB 8C1E[2E03]              	MOV	WORD [DMAADD+2],DS
 16681 000025BF E85D10                  	call	DOS_SEARCH_NEXT 	; Find it
 16682 000025C2 8F06[2E03]              	pop	word [DMAADD+2]
 16683 000025C6 8F06[2C03]              	pop	word [DMAADD]
 16684 000025CA 724A                    	JC	short SearchNoMore
 16685                                  	; 24/01/2024
 16686                                  	;JMP	SearchSet		; Ok set return
 16687                                  
 16688                                  ;;;	; 24/01/2024 - Retro DOS v5.0
 16689                                  
 16690                                  ; The search was successful (or the search-next). We store the information
 16691                                  ; into the user's FCB for continuation.
 16692                                  
 16693                                  SearchSet:
 16694 000025CC BE[BE04]                	MOV	SI,SEARCHBUF
 16695 000025CF C43E[A605]              	LES	DI,[THISFCB]		; point to the FCB
 16696 000025D3 F606[6C05]FF            	TEST	byte [EXTFCB],0FFh
 16697 000025D8 7403                    	JZ	short NORMFCB1
 16698 000025DA 83C707                  	ADD	DI,7			; Point past the extension
 16699                                  NORMFCB1:
 16700 000025DD 5B                      	pop	bx			; Get original drive byte
 16701 000025DE 08DB                    	OR	BL,BL
 16702 000025E0 7506                    	JNZ	short SearchDrv
 16703 000025E2 8A1E[3603]              	MOV	BL,[CURDRV]
 16704 000025E6 FEC3                    	INC	BL
 16705                                  SearchDrv:
 16706 000025E8 AC                      	LODSB				; Get correct search contin drive byte
 16707 000025E9 86C3                    	XCHG	AL,BL			; Search byte to BL, user byte to AL
 16708 000025EB 47                      	INC	DI
 16709                                  	;STOSB				; Store the correct "user" drive byte
 16710                                  					;  at the start of the search info
 16711 000025EC B90A00                  	MOV	CX,20/2
 16712 000025EF F3A5                    	REP	MOVSW			; Rest of search cont info, SI -> entry
 16713 000025F1 86C3                    	XCHG	AL,BL			; User drive byte back to BL, search
 16714                                  					;   byte to AL
 16715 000025F3 AA                      	STOSB				; Search contin drive byte at end of
 16716                                  					;   contin info
 16717 000025F4 C43E[2C03]              	LES	DI,[DMAADD]
 16718 000025F8 F606[6C05]FF            	TEST	byte [EXTFCB],0FFh
 16719 000025FD 740D                    	JZ	short NORMFCB2
 16720 000025FF B0FF                    	MOV	AL,0FFh
 16721 00002601 AA                      	STOSB
 16722 00002602 FEC0                    	INC	AL
 16723                                  	;MOV	CX,5
 16724                                  	; 17/12/2022
 16725 00002604 B105                    	mov	cl,5
 16726 00002606 F3AA                    	REP	STOSB
 16727 00002608 A0[6D05]                	MOV	AL,[SATTRIB]
 16728 0000260B AA                      	STOSB
 16729                                  NORMFCB2:
 16730 0000260C 88D8                    	MOV	AL,BL			; User Drive byte
 16731 0000260E AA                      	STOSB
 16732                                  	;MOV	CX,16			; 32 / 2 words of dir entry
 16733                                  	; 17/12/2022
 16734 0000260F B110                    	mov	cl,16
 16735 00002611 F3A5                    	REP	MOVSW
 16736 00002613 E970E0                  	jmp	FCB_RET_OK
 16737                                  ;;;
 16738                                  
 16739                                  SearchNoMore:
 16740 00002616 C43E[A605]              	LES	DI,[THISFCB]
 16741 0000261A F606[6C05]FF            	TEST	byte [EXTFCB],0FFh
 16742 0000261F 7403                    	JZ	short NORMFCB8
 16743 00002621 83C707                  	ADD	DI,7			; Point past the extension
 16744                                  NORMFCB8:
 16745 00002624 5B                      	pop	bx			; Get original drive byte
 16746 00002625 26881D                  	MOV	[ES:DI],BL		; Store the correct "user" drive byte
 16747                                  					;  at the right spot
 16748                                  ; error code is in AX
 16749                                  
 16750 00002628 E95EE0                  	jmp	FCB_RET_ERR
 16751                                  
 16752                                  ; 17/05/2019 - Retro DOS v4.0
 16753                                  
 16754                                  ; DOSCODE:5EE6h (MSDOS 6.21, MSDOS.SYS)
 16755                                  
 16756                                  ;---------------------------------------------------------------------------
 16757                                  ;
 16758                                  ;   Procedure Name : $FIND_FIRST
 16759                                  ; 
 16760                                  ;   Assembler usage:
 16761                                  ;	    MOV AH, FindFirst
 16762                                  ;	    LDS DX, name
 16763                                  ;	    MOV CX, attr
 16764                                  ;	    INT 21h
 16765                                  ;	; DMA address has datablock
 16766                                  ;
 16767                                  ;   Error Returns:
 16768                                  ;	    AX = error_path_not_found
 16769                                  ;	       = error_no_more_files
 16770                                  ;---------------------------------------------------------------------------
 16771                                  
 16772                                  	; 09/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 16773                                  	; DOSCODE:5ED2h (MSDOS 5.0, MSDOS.SYS)
 16774                                  
 16775                                  	; 24/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 16776                                  	; DOSCODE:6594h (PCDOS 7.1, IBMDOS.COM)
 16777                                  
 16778                                  _$FIND_FIRST:
 16779 0000262B 89D6                    	MOV	SI,DX			; get name in appropriate place
 16780 0000262D 36880E[6D05]            	MOV	[SS:SATTRIB],CL		; Search attribute to correct loc
 16781                                  
 16782 00002632 BF[BE03]                	MOV	DI,OPENBUF		; appropriate buffer
 16783                                  
 16784 00002635 E85A56                  	call	TransPathSet		; convert the path
 16785 00002638 7305                    	JNC	short Find_it 		; no error, go and look
 16786                                  FindError:
 16787                                  	;mov	al,3
 16788 0000263A B003                    	mov	al, error_path_not_found ; error and map into one.
 16789                                  	; 09/11/2022
 16790                                  FF_errj:
 16791 0000263C E935E0                  	jmp	SYS_RET_ERR
 16792                                  Find_it:
 16793 0000263F 16                      	push	ss
 16794 00002640 1F                      	pop	ds
 16795                                  
 16796                                  	;push	word [DMAADD]
 16797                                  	;push	word [DMAADD+2]
 16798                                  	; 24/01/2024 (PCDOS 7.1 IBMDOS.COM)
 16799 00002641 C43E[2C03]              	les	di,[DMAADD]
 16800 00002645 57                      	push	di
 16801 00002646 06                      	push	es
 16802                                  	
 16803 00002647 C706[2C03][BE04]        	MOV	WORD [DMAADD],SEARCHBUF
 16804 0000264D 8C1E[2E03]              	MOV	WORD [DMAADD+2],DS
 16805                                  	; MSDOS 3.3
 16806                                  	;call	DOS_SEARCH_FIRST
 16807                                  	; MSDOS 6.0
 16808 00002651 E8CB0E                  	call	GET_FAST_SEARCH 	; search
 16809 00002654 8F06[2E03]              	pop	word [DMAADD+2]
 16810 00002658 8F06[2C03]              	pop	word [DMAADD]
 16811                                  	
 16812                                  	; 16/12/2022
 16813                                  	;JNC	short FindSet 		; no error, transfer info
 16814 0000265C 72DE                    	jc	short FF_errj	; jmp SYS_RET_ERR
 16815                                  	;
 16816                                  	;jmp	SYS_RET_ERR
 16817                                  	; 09/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 16818                                  ;FFF_errj:
 16819                                  	;jmp	short FF_errj	; jmp SYS_RET_ERR
 16820                                  
 16821                                  FindSet:
 16822 0000265E BE[BE04]                	MOV	SI,SEARCHBUF
 16823 00002661 C43E[2C03]              	LES	DI,[DMAADD]
 16824 00002665 B91500                  	MOV	CX,21
 16825 00002668 F3A4                    	REP	MOVSB
 16826 0000266A 56                      	PUSH	SI			; Save pointer to start of entry
 16827                                  	;mov	al,[si+0Bh]
 16828 0000266B 8A440B                  	MOV	AL,[SI+dir_entry.dir_attr]
 16829 0000266E AA                      	STOSB
 16830                                  	;add	si,16h ; 22
 16831 0000266F 83C616                  	ADD	SI,dir_entry.dir_time
 16832 00002672 A5                      	MOVSW				; dir_time
 16833 00002673 A5                      	MOVSW				; dir_date
 16834 00002674 46                      	INC	SI
 16835 00002675 46                      	INC	SI			; Skip dir_first
 16836 00002676 A5                      	MOVSW				; dir_size (2 words)
 16837 00002677 A5                      	MOVSW
 16838 00002678 5E                      	POP	SI			; Point back to dir_name
 16839 00002679 E83300                   	CALL	PackName
 16840 0000267C E9EBDF                  	jmp	SYS_RET_OK		; bye with no errors
 16841                                  
 16842                                  ;---------------------------------------------------------------------------
 16843                                  ;
 16844                                  ;   Procedure Name : $FIND_NEXT
 16845                                  ;
 16846                                  ;   Assembler usage:
 16847                                  ;	; dma points at area returned by find_first
 16848                                  ;	    MOV AH, findnext
 16849                                  ;	    INT 21h
 16850                                  ;	; next entry is at dma
 16851                                  ;
 16852                                  ;   Error Returns:
 16853                                  ;	    AX = error_no_more_files
 16854                                  ;---------------------------------------------------------------------------
 16855                                  
 16856                                  	; 09/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 16857                                  
 16858                                  	; 24/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 16859                                  	; DOSCODE:65ECh (PCDOS 7.1, IBMDOS.COM)
 16860                                  
 16861                                  _$FIND_NEXT:
 16862 0000267F 16                      	push	ss
 16863 00002680 07                      	pop	es
 16864                                  
 16865 00002681 BF[BE04]                	MOV	DI,SEARCHBUF
 16866                                  
 16867 00002684 36C536[2C03]            	LDS	SI,[SS:DMAADD]
 16868                                  
 16869 00002689 B91500                  	MOV	CX,21
 16870 0000268C F3A4                    	REP	MOVSB			; Put the search continuation info
 16871                                  					;  in the right place
 16872 0000268E 16                      	push	ss
 16873 0000268F 1F                      	pop	ds			; get ready for search
 16874                                  	
 16875                                  	; 24/01/2024 (Retro DOS v5-v4)
 16876                                  	;push	word [DMAADD]
 16877                                  	;push	word [DMAADD+2]
 16878 00002690 C43E[2C03]              	les	di,[DMAADD]
 16879 00002694 57                      	push	di
 16880 00002695 06                      	push	es
 16881 00002696 C706[2C03][BE04]        	MOV	WORD [DMAADD],SEARCHBUF
 16882 0000269C 8C1E[2E03]              	MOV	WORD [DMAADD+2],DS
 16883 000026A0 E87C0F                  	call	DOS_SEARCH_NEXT 	; Find it
 16884 000026A3 8F06[2E03]              	pop	word [DMAADD+2]
 16885 000026A7 8F06[2C03]              	pop	word [DMAADD]
 16886 000026AB 73B1                    	JNC	short FindSet 		; No error, set info
 16887                                  	;jmp	SYS_RET_ERR
 16888                                  	; 16/12/2022
 16889 000026AD EB8D                    	jmp	short FF_errj	; jmp SYS_RET_ERR
 16890                                  	; 09/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 16891                                  	;jmp	short FFF_errj	; jmp SYS_RET_ERR
 16892                                  
 16893                                  ;---------------------------------------------------------------------------
 16894                                  ;**	PackName - Convert file names from FCB to ASCIZ format.
 16895                                  ;
 16896                                  ;	PackName transfers a file name from DS:SI to ES:DI and converts it to
 16897                                  ;	the ASCIZ format.
 16898                                  ;
 16899                                  ;	ENTRY	(DS:SI) = 11 character FCB or dir entry name
 16900                                  ;		(ES:DI) = destination area (13 bytes)
 16901                                  ;	EXIT	(ds:SI) and (es:DI) advanced
 16902                                  ;	USES	al, CX, SI, DI, Flags  (BUGBUG - not verified - jgl)
 16903                                  ;---------------------------------------------------------------------------
 16904                                  
 16905                                  	; 25/01/2024 - Retro DOS v5.0
 16906                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:6627h
 16907                                  
 16908                                  PackName:
 16909                                  ;	Move over 8 characters to cover the name component, then trim it's
 16910                                  ;	trailing blanks.
 16911                                  
 16912                                  	;MOV	CX,8			; Pack the name
 16913                                  	;REP	MOVSB			; Move all of it
 16914                                  	; 25/01/2024
 16915 000026AF B90400                  	mov	cx,4
 16916 000026B2 F3A5                    	rep	movsw
 16917                                  main_kill_tail:
 16918 000026B4 26807DFF20              	CMP	BYTE [ES:DI-1]," "
 16919 000026B9 7507                    	JNZ	short find_check_dot
 16920 000026BB 4F                      	DEC	DI			; Back up over trailing space
 16921 000026BC 41                      	INC	CX
 16922 000026BD 83F908                  	CMP	CX,8
 16923 000026C0 72F2                    	JB	short main_kill_tail
 16924                                  find_check_dot:
 16925                                  	;CMP	WORD [SI],(" " << 8) | " "
 16926 000026C2 813C2020                	cmp     word [si],2020h 
 16927 000026C6 7506                    	JNZ	short got_ext 		; Some chars in extension
 16928 000026C8 807C0220                	CMP	BYTE [SI+2]," "
 16929 000026CC 740F                    	JZ	short find_done		; No extension
 16930                                  got_ext:
 16931 000026CE B02E                    	MOV	AL,"."	; 2Eh
 16932 000026D0 AA                      	STOSB
 16933                                  	;MOV	CX,3
 16934                                  	;; 18/12/2022
 16935                                  	;;mov	cl,3
 16936                                  	;;REP	MOVSB
 16937                                  	;movsb
 16938                                  	;movsb
 16939                                  	;movsb
 16940                                  	; 25/01/2024
 16941 000026D1 A5                      	movsw
 16942 000026D2 A4                      	movsb
 16943                                  ext_kill_tail:
 16944 000026D3 26807DFF20              	CMP	BYTE [ES:DI-1]," "
 16945 000026D8 7503                    	JNZ	short find_done
 16946 000026DA 4F                      	DEC	DI			; Back up over trailing space
 16947 000026DB EBF6                    	JMP	short ext_kill_tail
 16948                                  find_done:
 16949 000026DD 31C0                    	XOR	AX,AX
 16950 000026DF AA                      	STOSB				; NUL terminate
 16951 000026E0 C3                      	retn
 16952                                  
 16953                                  ;---------------------------------------------------------------------------
 16954                                  
 16955                                  ; 24/01/2024
 16956                                  %if 0
 16957                                  	; 17/05/2019 - Retro DOS v4.0
 16958                                  GET_FAST_SEARCH:
 16959                                  	; 22/07/2018
 16960                                  	; MSDOS 6.0
 16961                                  	; 17/12/2022
 16962                                  	OR	byte [ss:DOS34_FLAG+1],(SEARCH_FASTOPEN>>8)  ; 04h
 16963                                  	;OR	word [ss:DOS34_FLAG],SEARCH_FASTOPEN  ; 400h
 16964                                  					;FO.trigger fastopen ;AN000;
 16965                                  	;call	DOS_SEARCH_FIRST
 16966                                  	;retn
 16967                                  	; 17/12/2022
 16968                                  	jmp	DOS_SEARCH_FIRST
 16969                                  %endif
 16970                                  
 16971                                  ;============================================================================
 16972                                  ; PATH.ASM, MSDOS 6.0, 1991
 16973                                  ;============================================================================
 16974                                  ; 06/08/2018 - Retro DOS v3.0
 16975                                  ; 17/05/2019 - Retro DOS v4.0
 16976                                  
 16977                                  ; DOSCODE:5FB0h (MSDOS 6.21, MSDOS.SYS)
 16978                                  
 16979                                  ;**	Directory related system calls. These will be passed direct text of the
 16980                                  ;	pathname from the user. They will need to be passed through the macro
 16981                                  ;	expander prior to being sent through the low-level stuff. I/O specs are
 16982                                  ;	defined in DISPATCH. The system calls are:
 16983                                  ;
 16984                                  ;	$CURRENT_DIR  Written
 16985                                  ;	$RMDIR	  Written
 16986                                  ;	$CHDIR	  Written
 16987                                  ;	$MKDIR	  Written
 16988                                  ;
 16989                                  ;
 16990                                  ;	Modification history:
 16991                                  ;
 16992                                  ;	    Created: ARR 4 April 1983
 16993                                  ;		 MZ 10 May 1983     CurrentDir implemented
 16994                                  ;		 MZ 11 May 1983     RmDir, ChDir, MkDir implemented
 16995                                  ;		 EE 19 Oct 1983     RmDir no longer allows you to delete a
 16996                                  ;				    current directory.
 16997                                  ;		 MZ 19 Jan 1983     Brain damaged applications rely on success
 16998                                  
 16999                                  ;	I_Need	ThisCDS,DWORD		; pointer to Current CDS
 17000                                  ;	I_Need	WFP_Start,WORD		; pointer to beginning of directory text
 17001                                  ;	I_Need	Curr_Dir_End,WORD	; offset to end of directory part
 17002                                  ;	I_Need	OpenBuf,128		; temp spot for translated name
 17003                                  ;	I_need	fSplice,BYTE		; TRUE => do splice
 17004                                  ;	I_Need	NoSetDir,BYTE		; TRUE => no exact match on splice
 17005                                  ;	I_Need	cMeta,BYTE
 17006                                  ;	I_Need	DrvErr,BYTE					;AN000;
 17007                                  
 17008                                  ;BREAK <$CURRENT_DIR - dump the current directory into user space>
 17009                                  ;----------------------------------------------------------------------------
 17010                                  ;
 17011                                  ;   Procedure Name : $CURRENT_DIR
 17012                                  ;
 17013                                  ;   Assembler usage:
 17014                                  ;		LDS	SI,area
 17015                                  ;		MOV	DL,drive
 17016                                  ;		INT	21h
 17017                                  ;	    ; DS:SI is a pointer to 64 byte area that contains drive
 17018                                  ;	    ; current directory.
 17019                                  ;   Error returns:
 17020                                  ;	    AX = error_invalid_drive
 17021                                  ;
 17022                                  ;----------------------------------------------------------------------------
 17023                                  
 17024                                  	; 06/08/2018 - Retro DOS v3.0
 17025                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 2D4Eh
 17026                                  
 17027                                  	; 25/01/2024 - Retro DOS v5.0
 17028                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:5F9Ch  ; Retro DOS v4.1 (& v4.0)
 17029                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:5FB0h ; Retro DOS v4.2
 17030                                  	; Windows ME IO.SYS - BIOSCODE:6393h
 17031                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:6664h ; Retro DOS v5.0
 17032                                  
 17033                                  _$CURRENT_DIR:
 17034 000026E1 E8FFF1                  	call	ECritDisk
 17035 000026E4 88D0                    	MOV	AL,DL			; get drive number (0=def, 1=A)
 17036 000026E6 E8B854                  	call	GetVisDrv		; grab it
 17037 000026E9 7310                    	JNC	short CurrentValidate 	; no error -> go and validate dir
 17038                                  CurdirErr:
 17039 000026EB E822F2                  	call	LCritDisk
 17040                                  
 17041                                  	; MSDOS 3.3
 17042                                  	;mov	al,0Fh
 17043                                  	
 17044                                  	; MSDOS 6.0
 17045 000026EE 1E                      	push	ds
 17046 000026EF 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 17047 000026F4 A0[1006]                	mov	al,[DrvErr]		;IFS.			;AN000;
 17048 000026F7 1F                      	pop	ds
 17049                                  
 17050                                  curdir_errj:
 17051 000026F8 E979DF                  	jmp	SYS_RET_ERR		;IFS. make noise	;AN000;
 17052                                  
 17053                                  CurrentValidate:
 17054 000026FB 1E                      	push	ds			; save destination
 17055 000026FC 56                      	push	si
 17056                                  	
 17057                                  	;LDS	SI,[CS:THISCDS] ; MSDOS 3.3
 17058                                  	
 17059                                  	; MSDOS 6.0
 17060 000026FD 2E8E1E[0700]            	mov     ds,[cs:DosDSeg]
 17061                                  	; 25/01/2024 (PCDOS 7.1 IBMDOS.COM)
 17062 00002702 C606[4C03]00            	mov	byte [NoSetDir],0 ; *
 17063                                  	
 17064                                  	; 25/01/2024
 17065                                  	;lds     si,[THISCDS]
 17066                                  
 17067                                  ; 16/12/2022
 17068                                  %if 0
 17069                                  	; 09/11/2022 (following test instruction is nonsense!)
 17070                                  	; (I am leaving it here for MSDOS 5.0 MSDOS.SYS compatibility)
 17071                                  
 17072                                  	;test	word [si+43h],8000h
 17073                                  	TEST	word [SI+curdir.flags],curdir_isnet
 17074                                  	;jnz	short $+2  ; 09/11/2022	
 17075                                  	jnz	short DoCheck
 17076                                  %endif
 17077                                  
 17078                                  ; Random optimization nuked due to some utilities using GetCurrentDir to do
 17079                                  ; media check.
 17080                                  ;	CMP	word [SI+curdir.ID],0
 17081                                  ;	JZ	short GetDst
 17082                                  DoCheck:
 17083                                  	;MOV	byte [cs:NoSetDir],0	; interested only in contents
 17084                                  
 17085                                  	; 25/01/2024
 17086                                  	; MSDOS 6.0
 17087                                  	;push	ds
 17088                                  	;mov	ds,[cs:DosDSeg]
 17089                                  	;mov	byte [NoSetDir],0 ; *
 17090                                  	;pop	ds
 17091                                  
 17092 00002707 BF[BE03]                	MOV	DI,OPENBUF
 17093 0000270A E86F27                  	call	ValidateCDS		; output is ES:DI -> CDS
 17094                                  
 17095 0000270D 06                      	push	es	 		; swap source and destination
 17096 0000270E 57                      	push	di
 17097 0000270F 5E                      	pop	si
 17098 00002710 1F                      	pop	ds
 17099                                  GetDst:
 17100 00002711 5F                      	pop	di
 17101 00002712 07                      	pop	es			; get real destination
 17102 00002713 72D6                    	JC	short CurdirErr
 17103                                  	;ADD	SI,curdir.text ; add si,0 ; 09/08/2018
 17104                                  	;
 17105                                  	; 09/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 17106                                  	; DOSCODE:5FE2h (MSDOS 5.0, MSDOS.SYS)
 17107                                  	; 16/12/2022
 17108                                  	;add	si,0  ; add si,curdir.text
 17109                                  	;
 17110                                  	;add	si,[si+4Fh] ; 17/05/2019
 17111 00002715 03744F                  	ADD	SI,[SI+curdir.end]
 17112 00002718 803C5C                  	CMP	BYTE [SI],'\'	; 5Ch	; root or subdirs present?
 17113 0000271B 7501                    	JNZ	short CurrentCopy
 17114 0000271D 46                      	INC	SI
 17115                                  CurrentCopy:
 17116                                  ;	call	FStrCpy
 17117                                  ;; 10/29/86 E5 char
 17118 0000271E 50                      	PUSH	AX
 17119 0000271F AC                      	LODSB				; get char
 17120 00002720 08C0                    	OR	AL,AL
 17121 00002722 7413                    	JZ	short FOK
 17122 00002724 3C05                    	CMP	AL,05H
 17123 00002726 740D                    	JZ	short FCHANGE
 17124 00002728 EB01                    	JMP	short FFF
 17125                                  FCPYNEXT:
 17126 0000272A AC                      	LODSB				; get char
 17127                                  FFF:
 17128 0000272B 3C5C                    	CMP	AL,'\'			; beginning of directory
 17129 0000272D 7508                    	JNZ	short FOK		; no
 17130 0000272F AA                      	STOSB				; put into user's buffer
 17131 00002730 AC                      	LODSB				; 1st char of dir is 05?
 17132 00002731 3C05                    	CMP	AL,05H
 17133 00002733 7502                    	JNZ	short FOK		; no
 17134                                  FCHANGE:
 17135 00002735 B0E5                    	MOV	AL,0E5H			; make it E5
 17136                                  FOK:
 17137 00002737 AA                      	STOSB				; put into user's buffer
 17138 00002738 08C0                    	OR	AL,AL			; final char
 17139 0000273A 75EE                    	JNZ	short FCPYNEXT		; no
 17140 0000273C 58                      	POP	AX
 17141                                  
 17142                                  ;; 10/29/86 E5 char
 17143 0000273D 30C0                    	xor	AL,AL			; MZ 19 Jan 84
 17144 0000273F E8CEF1                  	call	LCritDisk
 17145 00002742 E925DF                  	jmp	SYS_RET_OK		; no more, bye!
 17146                                  
 17147                                  ; 17/05/2019 - Retro DOS v4.0
 17148                                  
 17149                                  ; DOSCODE:6029h (MSDOS 6.21, MSDOS.SYS)
 17150                                  
 17151                                  ;BREAK <$RmDir -- Remove a directory>
 17152                                  ;----------------------------------------------------------------------------
 17153                                  ;
 17154                                  ; Procedure Name : $RmDir
 17155                                  ;
 17156                                  ; Inputs:
 17157                                  ;	DS:DX Points to asciz name
 17158                                  ; Function:
 17159                                  ;	Delete directory if empty
 17160                                  ; Returns:
 17161                                  ;	STD XENIX Return
 17162                                  ;	AX = error_path_not_found If path bad
 17163                                  ;	AX = error_access_denied If
 17164                                  ;		Directory not empty
 17165                                  ;		Path not directory
 17166                                  ;		Root directory specified
 17167                                  ;		Directory malformed (. and .. not first two entries)
 17168                                  ;		User tries to delete a current directory
 17169                                  ;	AX = error_current_directory
 17170                                  ;
 17171                                  ;----------------------------------------------------------------------------
 17172                                  
 17173                                  	; 10/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 17174                                  	; DOSCODE:6015h (MSDOS 5.0, MSDOS.SYS)
 17175                                  
 17176                                  	; 25/01/2025 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 17177                                  	; DOSCODE:66C8h (PCDOS 7.1, IBMDOS.COM)
 17178                                  
 17179                                  _$RMDIR:
 17180 00002745 52                      	push	dx			; Save ptr to name
 17181 00002746 1E                      	push	ds
 17182 00002747 89D6                    	mov	si,dx			; Load ptr into si
 17183 00002749 BF[BE03]                	mov	di,OPENBUF		; di = ptr to buf for trans name
 17184 0000274C 57                      	push	di
 17185 0000274D E84A55                  	call	TransPathNoSet		; Translate the name
 17186 00002750 5F                      	pop	di			; di = ptr to buf for trans name
 17187 00002751 7306                    	jnc	short rmlset		; If transpath succeeded, continue
 17188 00002753 1F                      	pop	ds
 17189 00002754 5A                      	pop	dx			; Restore the name
 17190                                  	;mov	al,3
 17191 00002755 B003                    	mov	al,error_path_not_found ; Otherwise, return an error
 17192                                  	; 16/12/2022
 17193                                  rmdir_errj: ; 10/08/2018
 17194                                  chdir_errj:
 17195 00002757 EB9F                    	jmp	short curdir_errj
 17196                                  	;jmp	SYS_RET_ERR
 17197                                  rmlset:
 17198 00002759 36803E[7A05]FF          	CMP	byte [ss:CMETA],-1	;   if (cMeta >= 0)
 17199 0000275F 7518                    	Jnz	short rmerr		;	return (-1);
 17200 00002761 16                      	push	ss
 17201 00002762 07                      	pop	es
 17202 00002763 30C0                    	xor	al,al			; al = 0 , ie drive a:
 17203                                  rmloop: 
 17204 00002765 E8A454                  	call	GetCDSFromDrv		; Get curdir for drive in al
 17205 00002768 7215                    	jc	short rmcont		; If error, exit loop & cont normally
 17206                                  
 17207                                  	; 25/01/2024 - Retro DOS v5.0
 17208                                  	; (PCDOS 7.1 IBMDOS.COM)
 17209                                  	;;;
 17210                                  	;;test	word [si+43h],4000h
 17211                                  	;test	word [si+curdir.flags],curdir_inuse
 17212 0000276A F6444440                	test	byte [si+curdir.flags+1],(curdir_inuse>>8)
 17213 0000276E 7405                    	jz	short rmdir_nxt
 17214                                  	;;;
 17215                                  
 17216 00002770 E814F0                  	call	StrCmp			; Are the 2 paths the same?
 17217 00002773 7404                    	jz	short rmerr		; Yes, report error.
 17218                                  rmdir_nxt:	; 25/01/2024
 17219 00002775 FEC0                    	inc	al			; No, inc al to next drive number
 17220 00002777 EBEC                    	jmp	short rmloop		; Go check next drive.
 17221                                  rmerr:
 17222 00002779 1F                      	pop	ds
 17223 0000277A 5A                      	pop	dx			; Restore ptr the name
 17224                                  	;mov	al,10h
 17225 0000277B B010                    	mov	al,error_current_directory ; error
 17226                                  	; 16/12/2022
 17227                                  	; 10/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 17228                                  ;chdir_errj:
 17229 0000277D EBD8                    	jmp	short rmdir_errj
 17230                                  rmcont:
 17231 0000277F 1F                      	pop	ds
 17232 00002780 5A                      	pop	dx			; Restore ptr the name
 17233 00002781 BE[7D3A]                	MOV	SI,DOS_RMDIR
 17234                                  
 17235                                  	; 25/01/2024 - Retro DOS v5.0
 17236                                  	; (PCDOS 7.1 IBMDOS.COM)
 17237                                  	;;;
 17238 00002784 E89AF0                  	call	TestNet
 17239 00002787 BF4300                  	mov	di,67		; DIRSTRLEN
 17240 0000278A 7303                    	jnc	short rmcont2   ; local directory
 17241 0000278C BF8000                  	mov	di,128
 17242                                  rmcont2:
 17243                                  	;;;
 17244 0000278F E99900                  	JMP	DoDirCall
 17245                                  
 17246                                  ; 17/05/2019 - Retro DOS v4.0
 17247                                  
 17248                                  ; DOSCODE:6065h (MSDOS 6.21, MSDOS.SYS)
 17249                                  
 17250                                  ;BREAK <$ChDir -- Change current directory on a drive>
 17251                                  ;----------------------------------------------------------------------------
 17252                                  ;
 17253                                  ; $ChDir - Top-level change directory system call.  This call is responsible
 17254                                  ; for setting up the CDS for the specified drive appropriately.  There are
 17255                                  ; several cases to consider:
 17256                                  ;
 17257                                  ;   o	Local, simple CDS.  In this case, we take the input path and convert
 17258                                  ;	it into a WFP.	We verify the existance of this directory and then
 17259                                  ;	copy the WFP into the CDS and set up the ID field to point to the
 17260                                  ;	directory cluster.
 17261                                  ;   o	Net CDS.  We form the path from the root (including network prefix)
 17262                                  ;	and verify its existance (via DOS_Chdir).  If successful, we copy the
 17263                                  ;	WFP back into the CDS.
 17264                                  ;   o	SUBST'ed CDS.  This is no different than the local, simple CDS.
 17265                                  ;   o	JOIN'ed CDS.  This is trouble as there are two CDS's at work.  If we
 17266                                  ;	call TransPath, we will get the PHYSICAL CDS that the path refers to
 17267                                  ;	and the PHYSICAL WFP that the input path refers to.  This is perfectly
 17268                                  ;	good for the validation but not for currency.  We call TransPathNoSet
 17269                                  ;	to process the path but to return the logical CDS and the logical
 17270                                  ;	path.  We then copy the logical path into the logical CDS.
 17271                                  ;
 17272                                  ; Inputs:
 17273                                  ;	DS:DX Points to asciz name
 17274                                  ; Returns:
 17275                                  ;	STD XENIX Return
 17276                                  ;	AX = chdir_path_not_found if error
 17277                                  ;
 17278                                  ;----------------------------------------------------------------------------
 17279                                  	
 17280                                  	; 25/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 17281                                  	
 17282                                  _$CHDIR:
 17283                                  	; 25/01/2024
 17284                                  	;;;
 17285 00002792 36C606[5411]43          	mov	byte [ss:PATHNAMELEN],67 ; Retro DOS v5.0
 17286                                  	;mov	word [ss:PATHNAMELEN],67 ; DIRSTRLEN = 67
 17287                                  	;;;
 17288 00002798 BF[BE03]                	MOV	DI,OPENBUF		; spot for translated name
 17289 0000279B 89D6                    	MOV	SI,DX			; get source
 17290 0000279D E8EE54                  	call	TransPath		; go munge the path and get real CDS
 17291 000027A0 7304                    	JNC	short ChDirCrack	; no errors, try path
 17292                                  ChDirErrP:
 17293                                  	;mov	al,3
 17294 000027A2 B003                    	MOV	AL,error_path_not_found
 17295                                  ChDirErr:
 17296                                  	;jmp	SYS_RET_ERR 	; oops!
 17297                                  	; 10/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 17298 000027A4 EBB1                    	jmp	short chdir_errj
 17299                                  
 17300                                  ChDirCrack:
 17301 000027A6 803E[7A05]FF            	CMP	byte [CMETA],-1		; No meta chars allowed.
 17302 000027AB 75F5                    	JNZ	short ChDirErrP
 17303                                  
 17304                                  ; We cannot do a ChDir (yet) on a raw CDS. This is treated as a path not
 17305                                  ; found.
 17306                                  
 17307 000027AD C43E[A205]              	LES	DI,[THISCDS]
 17308 000027B1 83FFFF                  	CMP	DI,-1			; if (ThisCDS == NULL)
 17309 000027B4 74EC                    	JZ	short ChDirErrP		;    error ();
 17310                                  
 17311                                  ; Find out if the directory exists.
 17312                                  
 17313 000027B6 E87B12                  	call	DOS_CHDIR
 17314                                  	;Jc	short ChDirErr
 17315                                  	; 16/12/2022
 17316 000027B9 729C                    	jc	short chdir_errj
 17317                                  ;
 17318                                  ; Get back CDS to see if a join as seen. Set the currency pointer (only if
 17319                                  ; not network). If one was seen, all we need to do is copy in the text
 17320                                  ;
 17321                                  	; 25/01/2024 - Retro DOS V5.0
 17322 000027BB FF36[DC0A]              	push	word [DIRSTART_HW] ; *
 17323                                  
 17324 000027BF C43E[A205]              	LES	DI,[THISCDS]
 17325                                  	;test	word [es:di+43h],2000h
 17326                                  	; 17/12/2022
 17327 000027C3 26F6454420              	test	byte [ES:DI+curdir.flags+1],curdir_splice>>8
 17328                                  	;TEST	word [ES:DI+curdir.flags],curdir_splice
 17329                                  
 17330                                  	; 25/01/2024 (PCDOS 7.1)
 17331                                  	;mov	dx,[DIRSTART_HW]
 17332                                  
 17333 000027C8 742B                    	JZ	short GotCDS
 17334                                  
 17335                                  ; The CDS was joined. Let's go back and grab the logical CDS.
 17336                                  
 17337 000027CA 06                      	push	es	
 17338 000027CB 57                      	push	di
 17339                                  	;push	dx ; 25/01/2024 (PCDOS 7.1)
 17340 000027CC 51                      	push	cx ; word [DIRSTART]	; save CDS and cluster...
 17341 000027CD E8A7DC                  	call	Get_User_Stack		; get original text
 17342                                  	
 17343                                  	;mov	di,[si+6]
 17344 000027D0 8B7C06                  	MOV	DI,[SI+user_env.user_DX]
 17345                                  	;mov	ds,[si+0Eh]
 17346 000027D3 8E5C0E                  	MOV	DS,[SI+user_env.user_DS]
 17347                                  	
 17348 000027D6 BE[BE03]                	MOV	SI,OPENBUF		; spot for translated name
 17349 000027D9 87F7                    	XCHG	SI,DI
 17350 000027DB 30C0                    	XOR	AL,AL			; do no splicing
 17351 000027DD 57                      	push	di
 17352 000027DE E8B954                  	call	TransPathNoSet		; Munge path
 17353 000027E1 5E                      	pop	si
 17354                                  
 17355                                  ; There should NEVER be an error here.
 17356                                  
 17357                                  ;IF FALSE
 17358                                  ;	JNC SKipErr
 17359                                  ;	fmt <>,<>,<"$p: Internal CHDIR error\n">
 17360                                  ;SkipErr:
 17361                                  ;ENDIF
 17362 000027E2 C43E[A205]              	LES	DI,[THISCDS]		; get new CDS
 17363                                  	;mov	word [es:di+49h],-1
 17364 000027E6 26C74549FFFF            	MOV	word [ES:DI+curdir.ID],-1
 17365                                  					; no valid cluster here...
 17366                                  	;;; 25/01/2024 (PCDOS 7.1)
 17367                                  	;mov	word [es:di+4Bh],-1
 17368 000027EC 26C7454BFFFF            	mov	word [es:di+curdir.ID+2],-1
 17369                                  	;;;
 17370 000027F2 59                      	pop	cx ; word [DIRSTART]
 17371                                  	;pop	dx ; 25/01/2024 (PCDOS 7.1)
 17372 000027F3 5F                      	pop	di
 17373 000027F4 07                      	pop	es
 17374                                  
 17375                                  ; ES:DI point to the physical CDS, CX is the ID (local only)
 17376                                  
 17377                                  GotCDS:
 17378                                  	; 25/01/2024 - Retro DOS v5.0
 17379 000027F5 5A                      	pop	dx ; word [DIRSTART_HW] ; *
 17380                                  
 17381                                  ; wfp_start points to the text. See if it is long enough
 17382                                  
 17383                                  	; MSDOS 3.3
 17384                                  	;push	ss
 17385                                  	;pop	ds
 17386                                  	;mov	si,[WFP_START]
 17387                                  	;push	cx
 17388                                  	;call	DStrLen
 17389                                  	;cmp	cx,67 ; cmp cx,DIRSTRLEN
 17390                                  	;pop	cx
 17391                                  	;ja	short ChDirErrP
 17392                                  
 17393                                  	; MSDOS 6.0
 17394 000027F6 E85C00                  	CALL	Check_PathLen		;PTM.		;AN000;
 17395 000027F9 77A7                    	JA	short ChDirErrP
 17396                                  	; MSDOS 3.3 & MSDOS 6.0
 17397                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet ; 8000h
 17398                                  	; 17/12/2022
 17399 000027FB 26F6454480              	test	byte [ES:DI+curdir.flags+1],curdir_isnet>>8
 17400 00002800 7518                    	JNZ	short SkipRecency
 17401                                  	; MSDOS 6.0
 17402                                  	;test	word [es:di+43h],2000h
 17403                                  	; 17/12/2022
 17404 00002802 26F6454420              	test	byte [ES:DI+curdir.flags+1],curdir_splice>>8
 17405                                  	;TEST	word [ES:DI+curdir.flags],curdir_splice 
 17406                                  					;PTM. for Join and Subst ;AN000;
 17407 00002807 7405                    	JZ	short setdirclus	;PTM.		;AN000;
 17408 00002809 B9FFFF                  	MOV	CX,-1			;PTM.		;AN000;
 17409                                  	;;; 25/01/2024 (PCDOS 7.1 IBMDOS.COM)
 17410 0000280C 89CA                    	mov	dx,cx
 17411                                  setdirclus:
 17412                                  	;mov	[es:di+49h],cx
 17413 0000280E 26894D49                	MOV	[ES:DI+curdir.ID],CX
 17414                                  	;;; 25/01/2024 (PCDOS 7.1 IBMDOS.COM)
 17415 00002812 2689554B                	mov	[es:di+curdir.ID+2],dx
 17416                                  	;;;
 17417 00002816 C43E[A205]              	LES	DI,[THISCDS]		; get logical CDS
 17418                                  SkipRecency:
 17419 0000281A E89BEF                  	call	FStrCpy
 17420 0000281D 30C0                    	XOR	AL,AL
 17421                                  mkdir_ok:
 17422 0000281F E948DE                  	jmp	SYS_RET_OK
 17423                                  
 17424                                  ; 17/05/2019 - Retro DOS v4.0
 17425                                  
 17426                                  ; DOSCODE:60E1h (MSDOS 6.21, MSDOS.SYS)
 17427                                  
 17428                                  ;BREAK <$MkDir - Make a directory entry>
 17429                                  ;---------------------------------------------------------------------------
 17430                                  ;
 17431                                  ; Procedure Name : $MkDir
 17432                                  ; Inputs:
 17433                                  ;	DS:DX Points to asciz name
 17434                                  ; Function:
 17435                                  ;	Make a new directory
 17436                                  ; Returns:
 17437                                  ;	STD XENIX Return
 17438                                  ;	AX = mkdir_path_not_found if path bad
 17439                                  ;	AX = mkdir_access_denied  If
 17440                                  ;		Directory cannot be created
 17441                                  ;		Node already exists
 17442                                  ;		Device name given
 17443                                  ;		Disk or directory(root) full
 17444                                  ;---------------------------------------------------------------------------
 17445                                  
 17446                                  	; 10/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 17447                                  
 17448                                  	; 25/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 17449                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:67B0h
 17450                                  
 17451                                  _$MKDIR:
 17452                                  	;MOV	SI,DOS_MKDIR
 17453                                  	;;;
 17454                                  	; 25/01/2024 (PCDOS 7.1 IBMDOS.COM)
 17455 00002822 36C606[5411]43          	mov	byte [ss:PATHNAMELEN],67 ; Retro DOS v5.0
 17456                                  	;mov	word [ss:PATHNAMELEN],67 ; DIRSTRLEN (standard length = 67)
 17457                                  mkdir_x:	; (windows) extended length (128)
 17458 00002828 BE[1F39]                	mov	si,DOS_MKDIR
 17459                                  	;;;
 17460                                  DoDirCall:
 17461 0000282B BF[BE03]                	MOV	DI,OPENBUF		; spot for translated name
 17462                                  
 17463 0000282E 56                      	push	si
 17464 0000282F 89D6                    	MOV	SI,DX			; get source
 17465 00002831 E85A54                  	call	TransPath		; go munge the path
 17466 00002834 5E                      	pop	si
 17467 00002835 7305                    	JNC	short MkDirCrack	; no errors, try path
 17468                                  MkErrP:
 17469 00002837 B003                    	MOV	AL,error_path_not_found	; oops!
 17470                                  MkErr:
 17471 00002839 E938DE                  	jmp	SYS_RET_ERR
 17472                                  MkDirCrack:
 17473 0000283C 36803E[7A05]FF          	CMP	byte [SS:CMETA],-1
 17474 00002842 75F3                    	JNZ	short MkErrP
 17475                                  
 17476                                  	; MSDOS 3.3
 17477                                  	;push	ss
 17478                                  	;pop	ds
 17479                                  	;call	si
 17480                                  	;jb	short MkErr
 17481                                  	;;jmp	short mkdir_ok
 17482                                  	;jmp	SYS_RET_OK
 17483                                  
 17484                                  	; MSDOS 6.0
 17485 00002844 56                      	PUSH	SI			;PTM.			;AN000;
 17486                                  		; 25/01/2024 (PCDOS 7.1 IBMDOS.COM)
 17487                                  		; check path len > [PATNAMELEN] ; 67 or 128
 17488 00002845 E80D00                  	CALL	Check_PathLen		;PTM. check path len > 67 ? ;AN000;
 17489 00002848 5E                      	POP	SI			;PTM.			;AN000;
 17490 00002849 7604                    	JBE	short pathok		;PTM.			;AN000;
 17491                                  	;mov	al,5
 17492 0000284B B005                    	MOV	AL,error_access_denied	;PTM. ops!
 17493                                  	;jmp	SYS_RET_ERR		;PTM.
 17494 0000284D EBEA                    	jmp	short MkErr
 17495                                  pathok:
 17496 0000284F FFD6                    	CALL	SI			; go get file
 17497 00002851 72E6                    	JC	short MkErr		; error
 17498                                  	; 16/12/2022
 17499                                  	; 10/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 17500 00002853 EBCA                    	jmp	short mkdir_ok		; ok
 17501                                  	;jmp	SYS_RET_OK
 17502                                  
 17503                                  ;----------------------------------------------------------------------------
 17504                                  ;
 17505                                  ; Procedure Name : Check_PathLen
 17506                                  ;
 17507                                  ; Inputs:
 17508                                  ;	nothing
 17509                                  ; Function:
 17510                                  ;	check if final path length greater than 67
 17511                                  ; Returns:
 17512                                  ;	Above flag set if > 67
 17513                                  ;
 17514                                  ;---------------------------------------------------------------------------
 17515                                  
 17516                                  	; 25/01/2024 - Retro DOS v5.0
 17517                                  	; (PCDOS 7.1 IBMDOS.COM)
 17518                                  
 17519                                  Check_PathLen:
 17520                                  	; 09/09/2018
 17521                                  	;mov	SI,[WFP_START]
 17522 00002855 368B36[B205]            	MOV	SI,[SS:WFP_START] ; MSDOS 6.0
 17523                                  Check_PathLen2:
 17524                                  	; 25/01/2024 - Retro DOS v5.0
 17525                                  	; Note: dx is not changed in 'Check_PathLen';
 17526                                  	;	no need to push/pop (*)
 17527                                  	;
 17528 0000285A 16                      	push	ss
 17529 0000285B 1F                      	pop	ds
 17530                                  	;mov	SI,[WFP_START]	  ; MSDOS 3.3
 17531 0000285C 51                      	push	CX
 17532                                  	; (PCDOS 7.1 IBMDOS.COM)
 17533                                  	;push	dx ; 25/01/2024	(*)
 17534 0000285D E86FEF                  	CALL	DStrLen
 17535                                  	; (PCDOS 7.1 IBMDOS.COM)
 17536 00002860 3B0E[5411]              	cmp	cx,[PATHNAMELEN] ; 67 or 128
 17537                                  	;CMP	CX,DIRSTRLEN ; 67
 17538                                  	;pop	dx
 17539 00002864 59                      	POP	CX
 17540 00002865 C3                      	retn
 17541                                  
 17542                                  ;============================================================================
 17543                                  ; IOCTL.ASM, MSDOS 6.0, 1991
 17544                                  ;============================================================================
 17545                                  ; 07/08/2018 - Retro DOS v3.0
 17546                                  ; 17/05/2019 - Retro DOS v4.0
 17547                                  
 17548                                  ;**	IOCTL system call.
 17549                                  ;----------------------------------------------------------------------------
 17550                                  ;	$IOCTL
 17551                                  ;
 17552                                  ;	  Revision history:
 17553                                  ;
 17554                                  ;		Created: ARR 4 April 1983
 17555                                  ;
 17556                                  ;		GenericIOCTL added:		KGS	22 April 1985
 17557                                  ;
 17558                                  ;		A000	version 4.00	Jan. 1988
 17559                                  ;
 17560                                  ;		Used jump table to dispatch IOCTL functions. HKN 3/12/90
 17561                                  ;
 17562                                  
 17563                                  ;BREAK <IOCTL - munge on a handle to do device specific stuff>
 17564                                  ;---------------------------------------------------------------------------
 17565                                  ;
 17566                                  ;   Assembler usage:
 17567                                  ;	    MOV     BX, Handle
 17568                                  ;	    MOV     DX, Data
 17569                                  ;
 17570                                  ;	(or LDS     DX,BUF
 17571                                  ;	    MOV     CX,COUNT)
 17572                                  ;
 17573                                  ;	    MOV     AH, Ioctl
 17574                                  ;	    MOV     AL, Request
 17575                                  ;	    INT     21h
 17576                                  ;
 17577                                  ;   AH = 0  Return a combination of low byte of sf_flags and device driver
 17578                                  ;	    attribute word in DX, handle in BX:
 17579                                  ;	    DH = high word of device driver attributes
 17580                                  ;	    DL = low byte of sf_flags
 17581                                  ;	 1  Set the bits contained in DX to sf_flags.  DH MUST be 0.  Handle
 17582                                  ;	    in BX.
 17583                                  ;	 2  Read CX bytes from the device control channel for handle in BX
 17584                                  ;	    into DS:DX.  Return number read in AX.
 17585                                  ;	 3  Write CX bytes to the device control channel for handle in BX from
 17586                                  ;	    DS:DX.  Return bytes written in AX.
 17587                                  ;	 4  Read CX bytes from the device control channel for drive in BX
 17588                                  ;	    into DS:DX.  Return number read in AX.
 17589                                  ;	 5  Write CX bytes to the device control channel for drive in BX from
 17590                                  ;	    DS:DX.  Return bytes written in AX.
 17591                                  ;	 6  Return input status of handle in BX. If a read will go to the
 17592                                  ;	    device, AL = 0FFh, otherwise 0.
 17593                                  ;	 7  Return output status of handle in BX. If a write will go to the
 17594                                  ;	    device, AL = 0FFh, otherwise 0.
 17595                                  ;	 8  Given a drive in BX, return 1 if the device contains non-
 17596                                  ;	    removable media, 0 otherwise.
 17597                                  ;	 9  Return the contents of the device attribute word in DX for the
 17598                                  ;	    drive in BX.  0200h is the bit for shared.	1000h is the bit for
 17599                                  ;	    network. 8000h is the bit for local use.
 17600                                  ;	 A  Return 8000h if the handle in BX is for the network or not.
 17601                                  ;	 B  Change the retry delay and the retry count for the system. BX is
 17602                                  ;	    the count and CX is the delay.
 17603                                  ;
 17604                                  ;   Error returns:
 17605                                  ;	    AX = error_invalid_handle
 17606                                  ;	       = error_invalid_function
 17607                                  ;	       = error_invalid_data
 17608                                  ;
 17609                                  ;-------------------------------------------------------------------------------
 17610                                  ;
 17611                                  ;   This is the documentation copied from DOS 4.0 it is much better
 17612                                  ;   than the above
 17613                                  ;
 17614                                  ;	There are several basic forms of IOCTL calls:
 17615                                  ;
 17616                                  ;
 17617                                  ;	** Get/Set device information:	**
 17618                                  ;
 17619                                  ;	ENTRY	(AL) = function code
 17620                                  ;		  0 - Get device information
 17621                                  ;		  1 - Set device information
 17622                                  ;		(BX) = file handle
 17623                                  ;		(DX) = info for "Set Device Information"
 17624                                  ;	EXIT	'C' set if error
 17625                                  ;		  (AX) = error code
 17626                                  ;		'C' clear if OK
 17627                                  ;		  (DX) = info for "Get Device Information"
 17628                                  ;	USES	ALL
 17629                                  ;
 17630                                  ;
 17631                                  ;	**  Read/Write Control Data From/To Handle  **
 17632                                  ;
 17633                                  ;	ENTRY	(AL) = function code
 17634                                  ;		  2 - Read device control info
 17635                                  ;		  3 - Write device control info
 17636                                  ;		(BX) = file handle
 17637                                  ;		(CX) = transfer count
 17638                                  ;		(DS:DX) = address for data
 17639                                  ;	EXIT	'C' set if error
 17640                                  ;		  (AX) = error code
 17641                                  ;		'C' clear if OK
 17642                                  ;		  (AX) = count of bytes transfered
 17643                                  ;	USES	ALL
 17644                                  ;
 17645                                  ;
 17646                                  ;	**  Read/Write Control Data From/To Block Device  **
 17647                                  ;
 17648                                  ;	ENTRY	(AL) = function code
 17649                                  ;		  4 - Read device control info
 17650                                  ;		  5 - Write device control info
 17651                                  ;		(BL) = Drive number (0=default, 1='A', 2='B', etc)
 17652                                  ;		(CX) = transfer count
 17653                                  ;		(DS:DX) = address for data
 17654                                  ;	EXIT	'C' set if error
 17655                                  ;		  (AX) = error code
 17656                                  ;		'C' clear if OK
 17657                                  ;		  (AX) = count of bytes transfered
 17658                                  ;	USES	ALL
 17659                                  ;
 17660                                  ;
 17661                                  ;	**  Get Input/Output Status  **
 17662                                  ;
 17663                                  ;	ENTRY	(AL) = function code
 17664                                  ;		  6 - Get Input status
 17665                                  ;		  7 - Get Output Status
 17666                                  ;		(BX) = file handle
 17667                                  ;	EXIT	'C' set if error
 17668                                  ;		  (AX) = error code
 17669                                  ;		'C' clear if OK
 17670                                  ;		  (AL) = 00 if not ready
 17671                                  ;		  (AL) = FF if ready
 17672                                  ;	USES	ALL
 17673                                  ;
 17674                                  ;
 17675                                  ;	**  Get Drive Information  **
 17676                                  ;
 17677                                  ;	ENTRY	(AL) = function code
 17678                                  ;		  8 - Check for removable media
 17679                                  ;		  9 - Get device attributes
 17680                                  ;		(BL) = Drive number (0=default, 1='A', 2='B', etc)
 17681                                  ;	EXIT	'C' set if error
 17682                                  ;		  (AX) = error code
 17683                                  ;		'C' clear if OK
 17684                                  ;		  (AX) = 0/1 media is removable/fixed (func. 8)
 17685                                  ;		  (DX) = device attribute word (func. 9)
 17686                                  ;	USES	ALL
 17687                                  ;
 17688                                  ;
 17689                                  ;	**  Get Redirected bit	**
 17690                                  ;
 17691                                  ;	ENTRY	(AL) = function code
 17692                                  ;		  0Ah - Network stuff
 17693                                  ;		(BX) = file handle
 17694                                  ;	EXIT	'C' set if error
 17695                                  ;		  (AX) = error code
 17696                                  ;		'C' clear if OK
 17697                                  ;		  (DX) = SFT flags word, 8000h set if network file
 17698                                  ;	USES	ALL
 17699                                  ;
 17700                                  ;
 17701                                  ;	**  Change sharer retry parameters  **
 17702                                  ;
 17703                                  ;	ENTRY	(AL) = function code
 17704                                  ;		  0Bh - Set retry parameters
 17705                                  ;		(CX) = retry loop count
 17706                                  ;		(DX) = number of retries
 17707                                  ;	EXIT	'C' set if error
 17708                                  ;		  (AX) = error code
 17709                                  ;		'C' clear if OK
 17710                                  ;	USES	ALL
 17711                                  ;
 17712                                  ;
 17713                                  ;   =================================================================
 17714                                  ;
 17715                                  ;	**  New Standard Control  **
 17716                                  ;
 17717                                  ;	ALL NEW IOCTL FACILITIES SHOULD USE THIS FORM.	THE OTHER
 17718                                  ;	FORMS ARE OBSOLETE.
 17719                                  ;
 17720                                  ;   =================================================================
 17721                                  ;
 17722                                  ;	ENTRY	(AL) = function code
 17723                                  ;		  0Ch - Control Function subcode
 17724                                  ;		(BX) = File Handle
 17725                                  ;		(CH) = Category Indicator
 17726                                  ;		(CL) = Function within category
 17727                                  ;		(DS:DX) = address for data, if any
 17728                                  ;		(SI) = Passed to device as argument, use depends upon function
 17729                                  ;		(DI) = Passed to device as argument, use depends upon function
 17730                                  ;	EXIT	'C' set if error
 17731                                  ;		  (AX) = error code
 17732                                  ;		'C' clear if OK
 17733                                  ;		  (SI) = Return value, meaning is function dependent
 17734                                  ;		  (DI) = Return value, meaning is function dependent
 17735                                  ;		  (DS:DX) = Return address, use is function dependent
 17736                                  ;	USES	ALL
 17737                                  ;
 17738                                  ;    ============== Generic IOCTL Definitions for DOS 3.2 ============
 17739                                  ;     (See inc\ioctl.inc for more info)
 17740                                  ;
 17741                                  ;	ENTRY	(AL) = function code
 17742                                  ;		  0Dh - Control Function subcode
 17743                                  ;		(BL) = Drive Number (0 = Default, 1= 'A')
 17744                                  ;		(CH) = Category Indicator
 17745                                  ;		(CL) = Function within category
 17746                                  ;		(DS:DX) = address for data, if any
 17747                                  ;		(SI) = Passed to device as argument, use depends upon function
 17748                                  ;		(DI) = Passed to device as argument, use depends upon function
 17749                                  ;
 17750                                  ;	EXIT	'C' set if error
 17751                                  ;		  (AX) = error code
 17752                                  ;		'C' clear if OK
 17753                                  ;		  (DS:DX) = Return address, use is function dependent
 17754                                  ;	USES	ALL
 17755                                  ;
 17756                                  ;---------------------------------------------------------------------------
 17757                                  	
 17758                                  	; 17/05/2019 - Retro DOS v4.0
 17759                                  	; DOSCODE:611Eh (MSDOS 6.21, MSDOS.SYS)
 17760                                  
 17761                                  	; 11/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 17762                                  	; DOSCODE:610Ah (MSDOS 5.0, MSDOS.SYS)
 17763                                  
 17764                                  	; 14/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 17765                                  	; DOSCODE:67F7h (PCDOS 7.1, IBMDOS.COM)
 17766                                  
 17767                                  IOCTLJMPTABLE:	;label	word
 17768                                  	; MSDOS 3.3 (& MSDOS 6.0)
 17769 00002866 [A228]                  	dw	ioctl_getset_data	; 0
 17770 00002868 [A228]                  	dw	ioctl_getset_data   	; 1
 17771 0000286A [EC28]                  	dw	ioctl_control_string	; 2
 17772 0000286C [EC28]                  	dw	ioctl_control_string	; 3
 17773 0000286E [7F2A]                  	dw	ioctl_get_dev		; 4
 17774 00002870 [7F2A]                  	dw	ioctl_get_dev		; 5
 17775 00002872 [0429]                  	dw	ioctl_status		; 6
 17776 00002874 [0429]                  	dw	ioctl_status		; 7
 17777 00002876 [DE29]                  	dw	ioctl_rem_media		; 8
 17778 00002878 [272A]                  	dw	ioctl_drive_attr	; 9
 17779 0000287A [712A]                  	dw	ioctl_handle_redir	; A
 17780 0000287C [192A]                  	dw	Set_Retry_Parameters	; B
 17781 0000287E [2029]                  	dw	GENERICIOCTLHANDLE	; C
 17782 00002880 [3A29]                  	dw	GENERICIOCTL		; D
 17783                                  	; MSDOS 6.0 (& MSDOS 3.3)
 17784 00002882 [202B]                  	dw	ioctl_drive_owner	; E
 17785 00002884 [202B]                  	dw	ioctl_drive_owner	; F
 17786                                  	; MSDOS 6.0
 17787 00002886 [2029]                  	dw	query_handle_support	; 10h
 17788 00002888 [3A29]                  	dw	query_device_support	; 11h
 17789                                  
 17790                                  	; 11/11/2022
 17791                                  _$IOCTL:
 17792 0000288A 8CDE                    	MOV	SI,DS			; Stash DS for calls 2,3,4 and 5
 17793 0000288C 16                      	push	ss
 17794 0000288D 1F                      	pop	ds			;hkn; SS is DOSDATA
 17795                                  
 17796                                  	; MSDOS 3.3
 17797                                  	;cmp	al,0Fh 
 17798                                  	; MSDOS 6.0
 17799 0000288E 3C11                    	cmp	al,11h			; al must be between 0 & 11h
 17800 00002890 770D                    	ja	short ioctl_bad_funj2	; if not bad function #
 17801                                  
 17802                                  	; 14/01/2024
 17803                                  	; 28/05/2019
 17804                                  	;push	AX	; 14/01/2024	; Need to save AL for generic IOCTL
 17805 00002892 89C7                    	mov	di,ax			; di NOT a PARM
 17806 00002894 81E7FF00                	and	di,0FFh			; di = al
 17807 00002898 D1E7                    	shl	di,1			; di = index into jmp table
 17808                                  	;pop	AX			; Restore AL for generic IOCTL
 17809                                  
 17810                                  
 17811 0000289A 2EFFA5[6628]            	jmp	word [CS:DI+IOCTLJMPTABLE]
 17812                                  
 17813                                  ioctl_bad_funj2:
 17814 0000289F E90401                  	JMP	ioctl_bad_fun  ; 10/08/2018
 17815                                  
 17816                                  ;--------------------------------------------------------------------------
 17817                                  ;
 17818                                  ; IOCTL: AL = 0,1
 17819                                  ;
 17820                                  ; ENTRY: DS = DOSDATA
 17821                                  ;
 17822                                  ;--------------------------------------------------------------------------
 17823                                  
 17824                                  	; 29/01/2024 - Retro DOS v5.0
 17825                                  ioctl_getset_data:
 17826                                  	; MSDOS 6.0
 17827 000028A2 E85B4E                  	call	SFFromHandle		; ES:DI -> SFT
 17828 000028A5 7305                    	JNC	short ioctl_check_permissions ; have valid handle
 17829                                  ioctl_bad_handle:
 17830                                  	;mov	al,6
 17831 000028A7 B006                    	mov	al,error_invalid_handle
 17832                                  ioctl_error:
 17833 000028A9 E9C8DD                  	jmp	SYS_RET_ERR
 17834                                  
 17835                                  ioctl_check_permissions:
 17836 000028AC 3C00                    	CMP	AL,0
 17837                                  	;mov	al,[es:di+5]
 17838 000028AE 268A4505                	MOV	AL,[ES:DI+SF_ENTRY.sf_flags]; Get low byte of flags
 17839 000028B2 7419                    	JZ	short ioctl_read	; read the byte
 17840                                  
 17841 000028B4 08F6                    	or	dh,dh
 17842 000028B6 7404                    	JZ	short ioctl_check_device ; can I set with this data?
 17843                                  	;mov	al,0Dh
 17844 000028B8 B00D                    	mov	al,error_invalid_data	; no DH <> 0
 17845                                  	;jmp	SYS_RET_ERR
 17846 000028BA EBED                    	jmp	short ioctl_error
 17847                                  
 17848                                  ioctl_check_device:
 17849 000028BC A880                    	test	AL,devid_device  ; 80h	; can I set this handle?
 17850 000028BE 74DF                    	jz	short ioctl_bad_funj2
 17851 000028C0 80CA80                  	OR	DL,devid_device 	; Make sure user doesn't turn off the
 17852                                  					;   device bit!! He can muck with the
 17853                                  					;   others at will.
 17854                                  	;MOV	byte [EXTERR_LOCUS],errLOC_SerDev ; 4
 17855                                  	; 29/01/2024
 17856                                  	;;;
 17857 000028C3 E81DEA                  	call	set_exerr_locus_ser ; (PCDOS 7.1 IBMDOS.COM)
 17858                                  	;;;
 17859 000028C6 26885505                	MOV	BYTE [ES:DI+SF_ENTRY.sf_flags],DL  ;AC000;MS.; Set flags
 17860                                  ioctl_ok:
 17861 000028CA E99DDD                  	jmp	SYS_RET_OK
 17862                                  
 17863                                  ioctl_read:
 17864                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Disk  ; 2
 17865                                  	; 29/01/2024
 17866                                  	;;;
 17867 000028CD E80EEA                  	call	set_exerr_locus_disk ; (PCDOS 7.1 IBMDOS.COM)
 17868                                  	;;;
 17869 000028D0 30E4                    	XOR	AH,AH
 17870 000028D2 A880                    	test	AL,devid_device 	; Should I set high byte
 17871 000028D4 740B                    	JZ	short ioctl_no_high	; no
 17872                                  	;MOV	byte [EXTERR_LOCUS],errLOC_SerDev ; 4
 17873                                  	; 29/01/2024
 17874                                  	;;;
 17875 000028D6 E80AEA                  	call	set_exerr_locus_ser ; (PCDOS 7.1 IBMDOS.COM)
 17876                                  	;;;
 17877                                  	;les	di,[es:di+7]
 17878 000028D9 26C47D07                	LES	DI,[ES:DI+SF_ENTRY.sf_devptr] ; Get device pointer
 17879                                  	;mov	ah,[es:di+5]
 17880 000028DD 268A6505                	MOV	AH,[ES:DI+SYSDEV.ATT+1] ; Get high byte
 17881                                  ioctl_no_high:
 17882 000028E1 89C2                    	MOV	DX,AX
 17883                                  ioctl_set_dx:	; 16/12/2022
 17884 000028E3 E891DB                  	call	Get_User_Stack
 17885                                  	;mov	[si+6],dx
 17886 000028E6 895406                  	MOV	[SI+user_env.user_DX],DX
 17887                                  	;;jmp	SYS_RET_OK
 17888                                  	; 11/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 17889                                  ioctl_ok_j:
 17890                                  	; 16/12/2022
 17891 000028E9 E981DD                  	jmp	SYS_RET_OK_clc	 ; (after 'Get_User_Stack') 
 17892                                  	;jmp	short ioctl_ok
 17893                                  	; 26/07/2019
 17894                                  	;jmp	SYS_RET_OK_clc
 17895                                  
 17896                                  ;--------------------------------------------------------------------------
 17897                                  ;
 17898                                  ; IOCTL: AL = 2,3
 17899                                  ;
 17900                                  ; ENTRY: DS = DOSDATA
 17901                                  ;	 SI = user's DS
 17902                                  ;
 17903                                  ;--------------------------------------------------------------------------
 17904                                  
 17905                                  	; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 17906                                  ioctl_control_string:
 17907 000028EC E8114E                  	call	SFFromHandle		; ES:DI -> SFT
 17908 000028EF 72B6                    	JC	short ioctl_bad_handle	; invalid handle
 17909                                  	; 07/12/2022
 17910                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device ; can I?
 17911                                  	;jz	short ioctl_bad_funj2			; No it is a file
 17912                                  	; MSDOS 5.0 & MSDOS 6.0
 17913 000028F1 26F6450580              	test	byte [ES:DI+SF_ENTRY.sf_flags],devid_device ; can I?
 17914 000028F6 74A7                    	jz	short ioctl_bad_funj2			; No it is a file
 17915                                  	;MOV	byte [EXTERR_LOCUS],errLOC_SerDev ; 4
 17916                                  	; 29/01/2024
 17917                                  	;;;
 17918 000028F8 E8E8E9                  	call	set_exerr_locus_ser ; (PCDOS 7.1 IBMDOS.COM)
 17919                                  	;;;
 17920 000028FB 26C47D07                	LES	DI,[ES:DI+SF_ENTRY.sf_devptr] ; Get device pointer
 17921 000028FF 30DB                    	XOR	BL,BL			; Unit number of char dev = 0
 17922 00002901 E98301                  	JMP	ioctl_do_string
 17923                                  
 17924                                  ;--------------------------------------------------------------------------
 17925                                  ;
 17926                                  ; IOCTL: AL = 6,7
 17927                                  ;
 17928                                  ; ENTRY: DS = DOSDATA
 17929                                  ;
 17930                                  ;--------------------------------------------------------------------------
 17931                                  
 17932                                  ioctl_status:
 17933 00002904 B401                    	MOV	AH,1
 17934 00002906 2C06                    	SUB	AL,6			; 6=0,7=1
 17935 00002908 7402                    	JZ	short ioctl_get_status
 17936 0000290A B403                    	MOV	AH,3
 17937                                  ioctl_get_status:
 17938 0000290C 50                      	PUSH	AX
 17939 0000290D E8BE15                  	call	GET_IO_SFT
 17940 00002910 58                      	POP	AX
 17941                                  	;JNC	short DO_IOFUNC
 17942                                  	;JMP	short ioctl_bad_handle	; invalid SFT
 17943                                  	; 16/12/2022
 17944 00002911 7294                    	jc	short ioctl_bad_handle
 17945                                  DO_IOFUNC:
 17946 00002913 E8D227                  	call	IOFUNC
 17947 00002916 88C4                    	MOV	AH,AL
 17948 00002918 B0FF                    	MOV	AL,0FFH
 17949                                  	;JNZ	short ioctl_status_ret
 17950                                  	; 29/01/2024
 17951 0000291A 75AE                    	jnz	short ioctl_ok
 17952 0000291C FEC0                    	INC	AL
 17953                                  ioctl_status_ret:
 17954                                  	;jmp	SYS_RET_OK
 17955                                  	; 11/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 17956                                  	;jmp	short ioctl_ok_j
 17957                                  	; 16/12/2022
 17958 0000291E EBAA                    	jmp	short ioctl_ok
 17959                                  
 17960                                  ;--------------------------------------------------------------------------
 17961                                  ;
 17962                                  ; Generic IOCTL entry point. AL = C, D, 10h, 11h
 17963                                  ;
 17964                                  ;	here we invoke the Generic IOCTL using the IOCTL_Req structure.
 17965                                  ;	SI:DX -> Users Device Parameter Table
 17966                                  ;	IOCALL -> IOCTL_Req structure
 17967                                  ;
 17968                                  ; 	If on entry AL >= IOCTL_QUERY_HANDLE the function is a
 17969                                  ;	QueryIOCtlSupport call ELSE it's a standard generic IOCtl
 17970                                  ;	call.
 17971                                  ;
 17972                                  ; BUGBUG: Don't push anything on the stack between GENERIOCTL: and 
 17973                                  ;         the call to Check_If_Net because Check_If_Net gets our
 17974                                  ;         return address off the stack if the drive is invalid.
 17975                                  ;
 17976                                  ;--------------------------------------------------------------------------
 17977                                  
 17978                                  	; 29/01/2024 - Retro DOS v5.0
 17979                                  
 17980                                  query_handle_support:	; Entry point for handles
 17981                                  GENERICIOCTLHANDLE:
 17982 00002920 E8DD4D                  	call	SFFromHandle		; Get SFT for device.
 17983 00002923 727E                    	jc	short ioctl_bad_handlej
 17984                                  
 17985                                  	;test	word [es:di+5],8000h
 17986                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet	; M031;
 17987                                  	;test	byte [es:di+6],80h
 17988 00002925 26F6450680              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 17989 0000292A 757A                    	jnz	short ioctl_bad_fun	; Cannot do this over net.
 17990                                  
 17991                                  	;mov	byte [EXTERR_LOCUS],errLOC_SerDev ; 4
 17992                                  	; 29/01/2024
 17993                                  	;;;
 17994 0000292C E8B4E9                  	call	set_exerr_locus_ser ; (PCDOS 7.1 IBMDOS.COM)
 17995                                  	;;;
 17996                                  
 17997                                  	;les	di,[es:di+7]
 17998 0000292F 26C47D07                	les	di,[es:di+SF_ENTRY.sf_devptr]	; Get pointer to device.
 17999                                  	;;;
 18000                                  	; 29/01/2024 - PCDOS 7.1 IBMDOS.COM
 18001 00002933 C606[B103]FF            	mov	byte [IOCTL_drvnum],0FFh	; invalidate drive number
 18002                                  					; (for extended -lock/unlock- functions)
 18003                                  	;;;
 18004 00002938 EB16                    	jmp	short Do_GenIOCTL
 18005                                  
 18006                                  	; 29/01/2024 - Retro DOS v5.0
 18007                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:68DAh
 18008                                  	; (WINME IO.SYS - BIOSCODE:6612h)
 18009                                  
 18010                                  query_device_support:	; Entry point for devices:
 18011                                  GENERICIOCTL:
 18012                                  	;mov	byte [EXTERR_LOCUS],errLOC_Disk ; 2
 18013                                  	; 29/01/2024
 18014                                  	;;;
 18015 0000293A E8A1E9                  	call	set_exerr_locus_disk
 18016 0000293D 80FD48                  	cmp	ch,48h			; category (extended, disk lock/unlock)
 18017 00002940 7405                    	je      short GenIOCTL_chk_net	; extended (MSDOS/PCDOS 7)
 18018                                  	;;;
 18019                                  
 18020 00002942 80FD08                  	cmp	ch,IOC_DC ; 8		; Only disk devices are allowed to use
 18021 00002945 755F                    	jne	short ioctl_bad_fun	; no handles with Generic IOCTL.
 18022                                  
 18023                                  	; 29/01/2024 
 18024                                  	;;;
 18025                                  GenIOCTL_chk_net:
 18026 00002947 881E[B103]              	mov	[IOCTL_drvnum],bl	; drive number
 18027                                  	;;;
 18028                                  
 18029 0000294B E8C301                  	CALL	Check_If_Net		; ES:DI := Get_hdr_block of device in BL
 18030 0000294E 7556                    	JNZ	short ioctl_bad_fun	; There are no "net devices", and they
 18031                                  
 18032                                  Do_GenIOCTL:
 18033                                  	; 29/01/2024 - Retro DOS v5.0 
 18034                                  	;;;
 18035 00002950 80FD48                  	cmp	ch,48h			; category code 48h for FAT32
 18036 00002953 7456                    	je	short GenIOCTL_extended ; MSDOS/PCDOS 7 functions (lock/unlock)
 18037                                  	;cmp	ch,8
 18038 00002955 80FD08                  	cmp	ch,IOC_DC ; 8          	; disk control
 18039 00002958 7451                    	je	short GenIOCTL_extended
 18040                                  GenIOCTL_normal:			; MSDOS 5-6.22 functions
 18041                                  	;;;
 18042                                  
 18043                                  	;TEST	word [ES:DI+SYSDEV.ATT],DEV320 
 18044                                  					; Can device handle Generic IOCTL funcs
 18045                                  	; 09/09/2018
 18046                                  	;test	byte [es:di+4],40h
 18047 0000295A 26F6450440              	TEST	byte [ES:DI+SYSDEV.ATT],DEV320 ; 0040h
 18048 0000295F 7445                    	jz	short ioctl_bad_fun
 18049                                  
 18050                                  	; 17/05/2019 - Retro DOS v4.0
 18051                                  
 18052                                  	; MSDOS 6.0
 18053                                  	;mov	byte [IOCALL_REQFUNC],19 ; 13h
 18054 00002961 C606[7E03]13            	mov	byte [IOCALL_REQFUNC],GENIOCTL ; Assume real Request
 18055                                  	;cmp	al,10h
 18056 00002966 3C10                    	cmp	AL,IOCTL_QUERY_HANDLE	; See if this is just a query
 18057 00002968 7C0C                    	jl	short SetIOCtlBlock
 18058                                  	
 18059                                  	;TEST	word [ES:DI+SYSDEV.ATT],IOQUERY ; See if device supports a query
 18060                                  	;test	byte [es:di+4],80h 
 18061 0000296A 26F6450480              	TEST	byte [ES:DI+SYSDEV.ATT],IOQUERY ; See if device supports a query
 18062 0000296F 7435                    	jz	short ioctl_bad_fun	; No support for query 
 18063                                  	;
 18064                                  	;mov	byte [IOCALL_REQFUNC],19h	
 18065 00002971 C606[7E03]19            	mov	byte [IOCALL_REQFUNC],IOCTL_QUERY ; Just a query (5.00)
 18066                                  
 18067                                  SetIOCtlBlock:
 18068 00002976 06                      	PUSH	ES			; DEVIOCALL2 expects Device header block
 18069 00002977 57                      	PUSH	DI			; in DS:SI
 18070                                  					; Setup Generic IOCTL Request Block
 18071                                  	;mov	byte [IOCALL_REQLEN],23
 18072 00002978 C606[7C03]17            	mov	byte [IOCALL_REQLEN],IOCTL_REQ.size
 18073                                  	; 07/09/2018 (MSDOS 3.3)
 18074                                  	;;mov	byte [IOCALL_REQFUNC],19
 18075                                  	;mov	byte [IOCALL_REQFUNC],GENIOCTL ; 07/09/2018
 18076                                  	;
 18077 0000297D 881E[7D03]              	MOV	[IOCALL_REQUNIT],BL
 18078 00002981 882E[8903]              	MOV	[IOCALL+IOCTL_REQ.MAJORFUNCTION],CH
 18079 00002985 880E[8A03]              	MOV	[IOCALL+IOCTL_REQ.MINORFUNCTION],CL
 18080 00002989 8936[8B03]              	MOV	[IOCALL+IOCTL_REQ.REG_SI],SI
 18081 0000298D 893E[8D03]              	MOV	[IOCALL+IOCTL_REQ.REG_DI],DI
 18082 00002991 8916[8F03]              	MOV	[IOCALL+IOCTL_REQ.GENERICIOCTL_PACKET],DX
 18083 00002995 8936[9103]              	MOV	[IOCALL+IOCTL_REQ.GENERICIOCTL_PACKET+2],SI
 18084                                  
 18085                                  ;hkn; IOCALL is in DOSDATA
 18086 00002999 BB[7C03]                	MOV	BX,IOCALL
 18087                                  
 18088 0000299C 16                      	PUSH	SS
 18089 0000299D 07                      	POP	ES
 18090                                  					; DS:SI -> Device header.
 18091 0000299E 5E                      	POP	SI
 18092 0000299F 1F                      	POP	DS
 18093                                  	; 10/08/2018
 18094 000029A0 E91D01                  	jmp	ioctl_do_IO		; Perform Call to device driver
 18095                                  	
 18096                                  ioctl_bad_handlej:
 18097 000029A3 E901FF                  	jmp	ioctl_bad_handle
 18098                                  
 18099                                  	; 29/01/2024
 18100                                  ioctl_bad_fun:
 18101 000029A6 B001                    	mov	al, error_invalid_function  ; 1
 18102 000029A8 E9C9DC                  	jmp	SYS_RET_ERR	
 18103                                  
 18104                                  	; 29/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 18105                                  GenIOCTL_extended:
 18106 000029AB 80F96A                  	cmp	cl,6Ah			; UNLOCK LOGICAL VOLUME
 18107                                  	;je	short GenIOCTL_chk_lock
 18108 000029AE 740E                    	je	short GenIOCTL_lock_unlock
 18109 000029B0 80F94A                  	cmp	cl,4Ah			; LOCK LOGICAL VOLUME
 18110 000029B3 75A5                    	jne	short GenIOCTL_normal
 18111                                  ;GenIOCTL_chk_lock:
 18112                                  	;cmp	cl,4Ah			; LOCK LOGICAL VOLUME
 18113                                  	;jne	short GenIOCTL_lock_unlock
 18114 000029B5 80FF04                  	cmp	bh,4			; lock level (0-4)
 18115 000029B8 7404                    	je	short GenIOCTL_lock_unlock
 18116 000029BA 08FF                    	or	bh,bh
 18117 000029BC 75E8                    	jnz	short ioctl_bad_fun
 18118                                  GenIOCTL_lock_unlock:
 18119 000029BE 8A1E[B103]              	mov	bl,[IOCTL_drvnum]	; drive number (1=A:, 2=B: ..)
 18120 000029C2 30FF                    	xor	bh,bh
 18121 000029C4 4B                      	dec	bx
 18122 000029C5 80FB1A                  	cmp	bl,26			; logical disk number limit
 18123 000029C8 73DC                    	jnb	short ioctl_bad_fun
 18124 000029CA 80F96A                  	cmp	cl,6Ah			; UNLOCK LOGICAL VOLUME
 18125 000029CD 7507                    	jne	short GenIOCTL_lock
 18126 000029CF 80A7[0813]7F            	and	byte [bx+drive_flags],7Fh ; UNLOCK
 18127 000029D4 EB05                    	jmp	short GenIOCTL_OK
 18128                                  GenIOCTL_lock:
 18129 000029D6 808F[0813]80            	or	byte [bx+drive_flags],80h ; LOCK
 18130                                  GenIOCTL_OK:
 18131 000029DB E98CDC                  	jmp	SYS_RET_OK
 18132                                  
 18133                                  ;---------------------------------------------------------------------------
 18134                                  ;
 18135                                  ; IOCTL: AL = 8
 18136                                  ;
 18137                                  ; ENTRY: DS = DOSDATA
 18138                                  ;
 18139                                  ; BUGBUG: Don't push anything on the stack between ioctl_rem_media: and 
 18140                                  ;         the call to Check_If_Net because Check_If_Net gets our
 18141                                  ;         return address off the stack if the drive is invalid.
 18142                                  ;
 18143                                  ;-------------------------------------------------------------------------
 18144                                  
 18145                                  	; 30/01/2024
 18146                                  ioctl_rem_media:
 18147                                  	; MSDOS 3.3 (& MSDOS 6.0)
 18148 000029DE E83001                  	CALL	Check_If_Net
 18149 000029E1 75C3                    	JNZ	short ioctl_bad_fun	; There are no "net devices", and they
 18150                                  					;   certainly don't know how to do this
 18151                                  					;   call.
 18152                                  	;test	word [es:di+4],800h
 18153                                  	;TEST	word [ES:DI+SYSDEV.ATT],DEVOPCL ; See if device can
 18154                                  	;test	byte [es:di+5],8
 18155 000029E3 26F6450508              	TEST	byte [es:di+SYSDEV.ATT+1],(DEVOPCL>>8)
 18156 000029E8 74BC                    	JZ	short ioctl_bad_fun		; NO
 18157                                  
 18158                                  ;hkn; SS override for IOCALL
 18159                                  	; 30/01/2024
 18160                                  	; ds = ss = DOSDATA segment ('Get_Driver_BL' in 'Check_If_Net')
 18161                                  	;MOV	byte [SS:IOCALL_REQFUNC],DEVRMD ; 15
 18162 000029EA C606[7E03]0F            	mov	byte [IOCALL_REQFUNC],DEVRMD ; 15
 18163 000029EF B00D                    	MOV	AL,REMHL  ; 13
 18164 000029F1 88DC                    	MOV	AH,BL			; Unit number
 18165                                  	;MOV	[SS:IOCALL_REQLEN],AX
 18166 000029F3 A3[7C03]                	mov	[IOCALL_REQLEN],ax	
 18167 000029F6 31C0                    	XOR	AX,AX
 18168                                  	;MOV	[SS:IOCALL_REQSTAT],AX
 18169 000029F8 A3[7F03]                	mov	[IOCALL_REQSTAT],ax ; 0
 18170                                  	
 18171 000029FB 06                      	PUSH	ES
 18172 000029FC 1F                      	POP	DS
 18173 000029FD 89FE                    	MOV	SI,DI			; DS:SI -> driver
 18174 000029FF 16                      	PUSH	SS
 18175 00002A00 07                      	POP	ES
 18176                                  
 18177                                  ;hkn; IOCALL is in DOSDATA (msconst.asm)
 18178                                  	; 30/01/2024
 18179                                  	; (ds <> ss, ss = DOSDATA segment)
 18180 00002A01 BB[7C03]                	MOV	BX,IOCALL		; ES:BX -> Call header
 18181 00002A04 1E                      	push	ds
 18182 00002A05 56                      	push	si
 18183 00002A06 E8AE28                  	call	DEVIOCALL2
 18184 00002A09 5E                      	pop	si
 18185 00002A0A 1F                      	pop	ds
 18186                                  
 18187                                  ;hkn; SS override
 18188 00002A0B 36A1[7F03]              	MOV	AX,[SS:IOCALL_REQSTAT]	; Get Status word
 18189                                  	;AND	AX,STBUI ; 200h		; Mask to busy bit
 18190                                  	; 29/01/2024
 18191 00002A0F 80E402                  	and	ah,STBUI>>8 ; 2
 18192 00002A12 B109                    	MOV	CL,9
 18193 00002A14 D3E8                    	SHR	AX,CL			; Busy bit to bit 0
 18194                                  ioctl_da_ok_j:	; 11/11/2022
 18195 00002A16 E951DC                  	jmp	SYS_RET_OK
 18196                                  
 18197                                  	; 29/01/2024
 18198                                  ;--------------------------------------------------------------------------
 18199                                  ;
 18200                                  ; IOCTL: AL = B
 18201                                  ;
 18202                                  ; ENTRY: DS = DOSDATA
 18203                                  ;
 18204                                  ;--------------------------------------------------------------------------
 18205                                  
 18206                                  Set_Retry_Parameters:
 18207                                  	; 09/09/2018
 18208 00002A19 890E[1C00]              	MOV	[RetryLoop],CX		; 0 retry loop count allowed
 18209 00002A1D 09D2                    	OR	DX,DX			; zero retries not allowed
 18210 00002A1F 7485                    	JZ	short ioctl_bad_fun
 18211                                  	; 29/01/2024
 18212                                  	;jnz	short set_new_retry_cnt
 18213                                  	;jmp	ioctl_bad_fun
 18214                                  ;set_new_retry_cnt:
 18215 00002A21 8916[1A00]              	MOV	[RetryCount],DX		; Set new retry count
 18216                                  doneok:
 18217                                  	;jmp	SYS_RET_OK		; Done
 18218                                  	; 11/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 18219                                  	;jmp	short ioctl_status_ret
 18220                                  	; 16/12/2022
 18221                                  	;jmp	short ioctl_ok	 ; jmp SYS_RET_OK
 18222                                  	; 29/01/2024
 18223 00002A25 EBEF                    	jmp	short ioctl_da_ok_j
 18224                                  
 18225                                  ;-------------------------------------------------------------------------
 18226                                  ;
 18227                                  ; IOCTL: AL = 9
 18228                                  ;
 18229                                  ; ENTRY: DS = DOSDATA
 18230                                  ;
 18231                                  ;-------------------------------------------------------------------------
 18232                                  
 18233                                  	; 30/01/2024 - Retro DOS v5.0
 18234                                  
 18235                                  ioctl_drive_attr:
 18236                                  	; MSDOS 3.3 (& MSDOS 6.0)
 18237 00002A27 88D8                    	mov	al,bl
 18238 00002A29 E89151                  	call	GETTHISDRV
 18239 00002A2C 723E                    	jc	short ioctl_drv_err
 18240 00002A2E E8B500                  	call	Get_Driver_BL
 18241                                  	; MSDOS 6.0
 18242 00002A31 7239                    	JC	short ioctl_drv_err	; drive not valid
 18243                                  
 18244                                  	; 30/01/2024 - Retro DOS v5.0
 18245                                  	; 30/01/2024 - PCDOS 7.1 IBMDOS.COM
 18246                                  	;;;
 18247                                  	;mov	dx,942h		; 0942h -> Attribute word
 18248                                  	;			; bit 11 - open/close/remmedia calls supported
 18249                                  	;			; bit 8 - (new type driver)
 18250                                  	;			; bit 6 - Generic IOCTL call supported
 18251                                  	;			; bit 1 - driver supports 32-bit sector addressing
 18252                                  	;jnz     short ioctl_drive_attr2 ; NET device
 18253                                  			; 30/01/2024
 18254                                  			; NOTE: 'jnz' condition is correct for Windows ME
 18255                                  			; 'Get_Driver_BL ' because it tests bit 0 of [drive_flags] 	
 18256                                  			; but in PCDOS 7.1 'Get_Driver_BL', this flag
 18257                                  			;	 (remote or removable? disk flag) is not tested
 18258                                  			; the last test is net device test)
 18259                                  	;;;;
 18260                                  
 18261                                  	;mov	dx,[es:di+4]
 18262 00002A33 268B5504                	mov	dx,[es:di+SYSDEV.ATT]	
 18263                                  				; get device attribute word
 18264                                  ;ioctl_drive_attr2: ; 30/01/2024
 18265 00002A37 88C3                    	MOV	BL,AL		; Phys letter to BL (A=0)
 18266                                  
 18267                                  ;hkn; SS override
 18268                                  	; 30/01/2024
 18269                                  	; (MSDOS 6.22 IO.SYS - DOSCODE:62B8h)
 18270                                  	; (PCDOS 7.1 IBMDOS.COM - DOSCODE:69DBh)
 18271                                  	;LES	DI,[SS:THISCDS]	; NOTE: PCDOS 7.1 has bug here,
 18272                                  				; ds must be same with ss here...
 18273                                  				; because there is 'les di, [ds:THISCDS]' in
 18274                                  				; Get_Driver_BL
 18275                                  				; and a second 'test byte ptr es:[ di+44h],80h'
 18276                                  				; is not necessary; also its result (jnz)
 18277                                  				; overwrites DS. /// Erdogan Tan - 30/01/2024
 18278                                  	; 30/01/2024
 18279                                  	; Retro DOS v5.0
 18280                                  	; (Windows ME IO.SYS - BIOSCODE:67ABh)
 18281 00002A39 C43E[A205]              	les	di,[THISCDS] 
 18282                                  
 18283                                  	;test	word [es:di+43h],8000h
 18284                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
 18285                                  	;test	byte [es:di+44h],80h
 18286 00002A3D 26F6454480              	TEST	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8)
 18287 00002A42 7403                    	JZ	short IOCTLShare
 18288                                  
 18289                                  	;or	dx,1000h ; (MSDOS 3.3)
 18290                                  
 18291                                  ;	Net devices don't return a device attribute word.
 18292                                  ;	Bit 12 = 1, meaning net device, all others = 0.
 18293                                  
 18294 00002A44 BA0010                  	MOV	DX,1000h ; MSDOS 6.0
 18295                                  
 18296                                  IOCTLShare:
 18297                                  	; 30/01/2024
 18298                                  	; ds = ss = DOSDATA segment
 18299                                  	;push	ss
 18300                                  	;pop	ds
 18301                                  	
 18302 00002A47 BE[BE03]                	MOV	SI,OPENBUF
 18303 00002A4A 80C341                  	ADD	BL,"A"	; 41h
 18304 00002A4D 881C                    	MOV	[SI],BL
 18305 00002A4F C744013A00              	MOV	WORD [SI+1],003AH ; ":",0
 18306 00002A54 B80003                  	MOV	AX,0300h
 18307 00002A57 F8                      	CLC
 18308                                  	;INT	int_IBM
 18309 00002A58 CD2A                    	int     2Ah	; Microsoft Networks - CHECK DIRECT I/O
 18310                                  			; DS:SI -> ASCIZ disk device name 
 18311                                  			; (may be full path or only drive
 18312                                  			; specifier--must include the colon)
 18313                                  			; Return: CF clear if absolute disk access allowed
 18314 00002A5A 7303                    	JNC	short IOCTLLocal	; Not shared
 18315                                  	;OR	DX,0200H		; Shared, bit 9
 18316                                  	; 17/12/2022
 18317 00002A5C 80CE02                  	or	dh,02h
 18318                                  IOCTLLocal:
 18319                                  	;test	word [es:di+43h],1000h
 18320                                  	;TEST	word [ES:DI+curdir.flags],curdir_local
 18321                                  	;test	byte [es:di+44h],10h
 18322 00002A5F 26F6454410              	TEST	byte [ES:DI+curdir.flags+1],(curdir_local>>8)
 18323                                  	;JZ	short ioctl_set_DX
 18324                                  	; 16/12/2022
 18325 00002A64 7403                    	jz	short _ioctl_set_DX
 18326                                  	;OR	DX,8000h
 18327                                  	; 17/12/2022
 18328 00002A66 80CE80                  	or	dh,80h
 18329                                  ;ioctl_set_DX:
 18330                                  _ioctl_set_DX:
 18331                                  	; 16/12/2022
 18332 00002A69 E977FE                  	jmp	ioctl_set_dx
 18333                                  ; 16/12/2022
 18334                                  %if 0	
 18335                                  	call	Get_User_Stack
 18336                                  	MOV	[SI+user_env.user_DX],DX
 18337                                  	;;jmp	SYS_RET_OK
 18338                                  	;; 25/06/2019
 18339                                  	;jmp	SYS_RET_OK_clc
 18340                                  	; 11/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 18341                                  ioctl_gd_ok_j:
 18342                                  	jmp	short ioctl_da_ok_j
 18343                                  %endif
 18344                                  
 18345                                  ioctl_drv_err:
 18346 00002A6C B00F                    	mov	al,error_invalid_drive ; 0Fh
 18347                                  ioctl_gd_err_j:	; 11/11/2022
 18348 00002A6E E903DC                  	jmp	SYS_RET_ERR
 18349                                  
 18350                                  ;--------------------------------------------------------------------------
 18351                                  ;
 18352                                  ; IOCTL: AL = A
 18353                                  ;
 18354                                  ; ENTRY: DS = DOSDATA
 18355                                  ;
 18356                                  ;--------------------------------------------------------------------------
 18357                                  
 18358                                  ioctl_handle_redir:
 18359 00002A71 E88C4C                  	call	SFFromHandle		; ES:DI -> SFT
 18360 00002A74 7303                    	JNC	short ioctl_got_sft	; have valid handle
 18361 00002A76 E92EFE                  	jmp	ioctl_bad_handle ; 10/08/2018
 18362                                  
 18363                                  ioctl_got_sft:
 18364                                  	;mov	dx,[es:di+5]
 18365 00002A79 268B5505                	MOV	DX,[ES:DI+SF_ENTRY.sf_flags] ; Get flags
 18366                                  	;JMP	short ioctl_set_DX	; pass dx to user and return
 18367                                  	; 16/12/2022
 18368 00002A7D EBEA                    	jmp	short _ioctl_set_DX
 18369                                  
 18370                                  	; 16/12/2022
 18371                                  ;ioctl_bad_funj:
 18372                                  	;JMP	ioctl_bad_fun
 18373                                  
 18374                                  ;--------------------------------------------------------------------------
 18375                                  ;
 18376                                  ; IOCTL: AL= 4,5
 18377                                  ;
 18378                                  ; ENTRY: DS = DOSDATA
 18379                                  ;	 SI = user's DS
 18380                                  ;
 18381                                  ;
 18382                                  ; BUGBUG: Don't push anything on the stack between ioctl_get_dev: and 
 18383                                  ;         the call to Check_If_Net because Check_If_Net gets our
 18384                                  ;         return address off the stack if the drive is invalid.
 18385                                  ;
 18386                                  ;-------------------------------------------------------------------------
 18387                                  
 18388                                  	; 30/01/2024 - Retro DOS v5.0
 18389                                  
 18390                                  ioctl_get_dev:
 18391 00002A7F E88F00                  	CALL	Check_If_Net
 18392                                  	;JNZ	short ioctl_bad_funj	; There are no "net devices", and they
 18393                                  					; certainly don't know how to do this
 18394                                  					; call.
 18395                                  	; 16/12/2022
 18396 00002A82 7403                    	jz	short ioctl_do_string
 18397                                  ioctl_bad_funj:
 18398 00002A84 E91FFF                  	JMP	ioctl_bad_fun
 18399                                  
 18400                                  ioctl_do_string:
 18401                                  	;test	word [es:di+4],4000h
 18402                                  	;TEST	word [ES:DI+SYSDEV.ATT],DEVIOCTL; See if device accepts control
 18403                                  	;test	byte [es:di+5],40h
 18404 00002A87 26F6450540              	TEST	byte [ES:DI+SYSDEV.ATT+1],(DEVIOCTL>>8)
 18405 00002A8C 74F6                    	JZ	short ioctl_bad_funj		; NO
 18406                                  					; assume IOCTL read
 18407 00002A8E C606[7E03]03            	MOV	byte [IOCALL_REQFUNC],DEVRDIOCTL  ; 3
 18408                                  
 18409 00002A93 A801                    	TEST	AL,1			; is it func. 4/5 or 2/3
 18410 00002A95 7405                    	JZ	short ioctl_control_call ; it is read. goto ioctl_control_call
 18411                                  
 18412                                  					; it is an IOCTL write
 18413 00002A97 C606[7E03]0C            	MOV	byte [IOCALL_REQFUNC],DEVWRIOCTL ; 12
 18414                                  
 18415                                  ioctl_control_call:
 18416                                  	; 30/01/2024
 18417 00002A9C B016                    	MOV	AL,DRDWRHL ; 22	; MSDOS 6.22 MSDOS.SYS, Windows ME IO.SYS
 18418                                  	;mov	al,20 ; PCDOS 7.1 IBMDOS.COM
 18419                                  ioctl_setup_pkt:
 18420 00002A9E 88DC                    	MOV	AH,BL			; Unit number
 18421 00002AA0 A3[7C03]                	MOV	[IOCALL_REQLEN],AX
 18422 00002AA3 31C0                    	XOR	AX,AX
 18423 00002AA5 A3[7F03]                	MOV	[IOCALL_REQSTAT],AX ; 0
 18424 00002AA8 A2[8903]                	MOV	[IOMED],AL
 18425 00002AAB 890E[8E03]              	MOV	[IOSCNT],CX
 18426 00002AAF 8916[8A03]              	MOV	[IOXAD],DX
 18427 00002AB3 8936[8C03]              	MOV	[IOXAD+2],SI
 18428 00002AB7 06                      	PUSH	ES
 18429 00002AB8 1F                      	POP	DS
 18430 00002AB9 89FE                    	MOV	SI,DI			; DS:SI -> driver
 18431 00002ABB 16                      	PUSH	SS
 18432 00002ABC 07                      	POP	ES
 18433                                  
 18434 00002ABD BB[7C03]                	MOV	BX,IOCALL		; ES:BX -> Call header
 18435                                  ioctl_do_IO:
 18436 00002AC0 E8F427                  	call	DEVIOCALL2
 18437                                  
 18438                                  ;hkn; SS override for IOCALL
 18439                                  	;test	word [SS:IOCALL_REQSTAT],8000h
 18440                                  	;TEST	word [SS:IOCALL_REQSTAT],STERR ;Error?
 18441                                  	;test	byte [SS:IOCALL_REQSTAT+1],80h
 18442 00002AC3 36F606[8003]80          	TEST	byte [SS:IOCALL_REQSTAT+1],(STERR>>8)
 18443 00002AC9 7507                    	JNZ	short ioctl_string_err
 18444                                  
 18445                                  ;hkn; SS override
 18446 00002ACB 36A1[8E03]              	MOV	AX,[SS:IOSCNT]		; Get actual bytes transferred
 18447                                  	; 16/12/2022
 18448 00002ACF E998DB                  	jmp	SYS_RET_OK
 18449                                  	; 11/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 18450                                  	;jmp	short ioctl_gd_ok_j
 18451                                  
 18452                                  ioctl_string_err:
 18453 00002AD2 368B3E[7F03]            	MOV	DI,[SS:IOCALL_REQSTAT]	;Get Error
 18454                                  device_err:
 18455 00002AD7 81E7FF00                	AND	DI,STECODE ; 00FFh	; mask out irrelevant bits
 18456 00002ADB 89F8                    	MOV	AX,DI
 18457 00002ADD E8E037                  	call	SET_I24_EXTENDED_ERROR
 18458                                  
 18459                                  ;hkn; use SS override
 18460                                  ;hkn;	mov	ax,[CS:EXTERR]
 18461 00002AE0 36A1[2403]              	mov	ax,[SS:EXTERR]
 18462                                  	;jmp	SYS_RET_ERR
 18463                                  	; 11/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 18464 00002AE4 EB88                    	jmp	short ioctl_gd_err_j
 18465                                  
 18466                                  ; 17/05/2019 - Retro DOS v4.0
 18467                                  
 18468                                  ;--------------------------------------------------------------------------
 18469                                  ; Proc name : Get_Driver_BL
 18470                                  ;
 18471                                  ;	DS is DOSDATA
 18472                                  ;	BL is drive number (0=default)
 18473                                  ;	Returns pointer to device in ES:DI, unit number in BL if carry clear
 18474                                  ;	No regs modified
 18475                                  ;
 18476                                  ;---------------------------------------------------------------------------
 18477                                  
 18478                                  	; 30/01/2024 - Retro DOS v5.0
 18479                                  
 18480                                  Get_Driver_BL:
 18481 00002AE6 50                      	PUSH	AX
 18482 00002AE7 88D8                    	MOV	AL,BL			; Drive
 18483 00002AE9 E8D150                  	call	GETTHISDRV
 18484 00002AEC 7221                    	jc	short ioctl_bad_drv
 18485 00002AEE 30DB                    	XOR	BL,BL			; Unit zero on Net device
 18486 00002AF0 C606[2303]03            	MOV	byte [EXTERR_LOCUS],errLOC_Net ; 3
 18487 00002AF5 C43E[A205]              	LES	DI,[THISCDS]
 18488                                  	;test	word [es:di+43h],8000h
 18489                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
 18490                                  	;test	byte [es:di+44h],80h
 18491 00002AF9 26F6454480              	TEST	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8)
 18492                                  	;les	di,[es:di+45h]
 18493 00002AFE 26C47D45                	LES	DI,[ES:DI+curdir.devptr] ; ES:DI -> Dpb or net dev
 18494 00002B02 750B                    	JNZ	short got_dev_ptr	 ; Is net
 18495                                  	;;;
 18496                                  	; 30/01/2024 - PCDOS 7.1 IBMDOS.COM
 18497                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Disk ; 2
 18498 00002B04 E8D7E7                  	call	set_exerr_locus_disk
 18499                                  	;;;
 18500                                  	;mov	bl,[es:di+1]
 18501 00002B07 268A5D01                	MOV	BL,[ES:DI+DPB.UNIT]	; Unit number
 18502                                  	;les	di,[es:di+13h]
 18503 00002B0B 26C47D13                	LES	DI,[ES:DI+DPB.DRIVER_ADDR] ; Driver addr
 18504                                  got_dev_ptr:
 18505                                  	; 30/01/2024
 18506                                  	; cf=0
 18507                                  	;CLC
 18508                                  ioctl_bad_drv:
 18509 00002B0F 58                      	POP	AX
 18510 00002B10 C3                      	retn
 18511                                  
 18512                                  ;-------------------------------------------------------------------------
 18513                                  ; Proc Name : Check_If_Net:
 18514                                  ;
 18515                                  ;
 18516                                  ; Checks if the device is over the net or not. Returns result in ZERO flag.
 18517                                  ; If no device is found, the return address is popped off the stack, and a
 18518                                  ; jump is made to ioctl_drv_err.
 18519                                  ;
 18520                                  ; On Entry:
 18521                                  ; Registers same as those for Get_Driver_BL
 18522                                  ;
 18523                                  ; On Exit:
 18524                                  ; ZERO flag	- set if not a net device
 18525                                  ;		- reset if net device
 18526                                  ; ES:DI -> the device
 18527                                  ;
 18528                                  ;
 18529                                  ; BUGBUG: This function assumes the following stack setup on entry
 18530                                  ;
 18531                                  ;	  SP+2 -> Error return address
 18532                                  ;	  SP   -> Normal return address
 18533                                  ;
 18534                                  ;-------------------------------------------------------------------------
 18535                                  
 18536                                  	; 30/01/2024 - Retro DOS v5.0
 18537                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:639Ch
 18538                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:6A91h
 18539                                  	; Windows ME IO.SYS - BIOSCODE:68E1h
 18540                                  
 18541                                  Check_If_Net:
 18542                                  	; MSDOS 3.3 (& MSDOS 6.0)
 18543 00002B11 E8D2FF                  	CALL	Get_Driver_BL
 18544 00002B14 7201                    	JC	short ioctl_drv_err_pop	; invalid drive letter
 18545                                  
 18546                                  ; 30/01/2024 ('Get_Driver_BL' returns with
 18547                                  ;	      'curdir_isnet' condition/ZF, no need to a second test)
 18548                                  %if 0
 18549                                  	;;;
 18550                                  	; (PCDOS 7.1 IBMDOS.COM, Windows ME IO.SYS)
 18551                                  	PUSH	ES
 18552                                  	PUSH	DI
 18553                                  	LES	DI,[THISCDS]
 18554                                  	;test	word [es:di+43h],8000h
 18555                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
 18556                                  	;test	byte [es:di+44h],80h
 18557                                  	TEST	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8)
 18558                                  	POP	DI
 18559                                  	POP	ES
 18560                                  	;;;
 18561                                  %endif
 18562 00002B16 C3                      	retn
 18563                                  
 18564                                  ioctl_drv_err_pop:
 18565 00002B17 58                      	pop	ax			; pop off return address
 18566 00002B18 E951FF                  	jmp	ioctl_drv_err
 18567                                  
 18568                                  ioctl_bad_funj3:
 18569 00002B1B E988FE                  	jmp	ioctl_bad_fun
 18570                                  
 18571                                  ioctl_string_errj:
 18572 00002B1E EBB2                    	jmp	short ioctl_string_err  ; 25/05/2019
 18573                                  
 18574                                  ;--------------------------------------------------------------------------
 18575                                  ;
 18576                                  ; IOCTL: AL = E, F
 18577                                  ;
 18578                                  ; ENTRY: DS = DOSDATA
 18579                                  ;
 18580                                  ;
 18581                                  ; BUGBUG: Don't push anything on the stack between ioctl_drive_owner: and 
 18582                                  ;         the call to Check_If_Net because Check_If_Net gets our
 18583                                  ;         return address off the stack if the drive is invalid.
 18584                                  ;
 18585                                  ;--------------------------------------------------------------------------
 18586                                  
 18587                                  ioctl_drive_owner:
 18588                                  	; MSDOS 3.3 (& MSDOS 6.0)
 18589 00002B20 E8EEFF                  	Call	Check_If_Net
 18590 00002B23 75F6                    	JNZ	short ioctl_bad_funj3 	; There are no "net devices", and they
 18591                                  					;   certainly don't know how to do this
 18592                                  					;   call.
 18593                                  	;TEST	word [ES:DI+SYSDEV.ATT],DEV320	; See if device can handle this
 18594                                  	; 09/09/2018
 18595                                  	;test	byte [es:di+4],40h
 18596 00002B25 26F6450440              	TEST	byte [ES:DI+SYSDEV.ATT],DEV320 ; 0040h
 18597 00002B2A 74EF                    	JZ	short ioctl_bad_funj3 	; NO
 18598                                  	;mov	byte [IOCALL_REQFUNC],23
 18599 00002B2C C606[7E03]17            	mov	byte [IOCALL_REQFUNC],DEVGETOWN	; default to get owner
 18600 00002B31 3C0E                    	cmp	al,0Eh			; Get Owner ?
 18601 00002B33 7405                    	jz	short GetOwner
 18602                                  SetOwner:
 18603 00002B35 C606[7E03]18            	MOV	byte [IOCALL_REQFUNC],DEVSETOWN ; 24
 18604                                  GetOwner:
 18605 00002B3A B00D                    	MOV	AL,OWNHL ; 13
 18606 00002B3C 88DC                    	MOV	AH,BL			; Unit number
 18607 00002B3E A3[7C03]                	MOV	[IOCALL_REQLEN],AX
 18608 00002B41 31C0                    	XOR	AX,AX
 18609 00002B43 A3[7F03]                	MOV	[IOCALL_REQSTAT],AX
 18610 00002B46 06                      	PUSH	ES
 18611 00002B47 1F                      	POP	DS
 18612 00002B48 89FE                    	MOV	SI,DI			; DS:SI -> driver
 18613 00002B4A 16                      	PUSH	SS
 18614 00002B4B 07                      	POP	ES
 18615 00002B4C BB[7C03]                	MOV	BX,IOCALL		; ES:BX -> Call header
 18616 00002B4F 1E                      	push	ds
 18617 00002B50 56                      	push	si
 18618 00002B51 E86327                  	call	DEVIOCALL2
 18619 00002B54 5E                      	pop	si
 18620 00002B55 1F                      	pop	ds
 18621                                  ;hkn; SS override
 18622                                  	;TEST	word [SS:IOCALL_REQSTAT],STERR ;Error?
 18623                                  	;test	byte [SS:IOCALL_REQSTAT+1],80h
 18624 00002B56 36F606[8003]80          	TEST	byte [SS:IOCALL_REQSTAT+1],(STERR>>8)
 18625 00002B5C 75C0                    	jnz	short ioctl_string_errj
 18626 00002B5E 36A0[7D03]              	MOV	AL,[SS:IOCALL_REQUNIT]	; Get owner returned by device
 18627                                  					; owner returned is 1-based.
 18628 00002B62 E905DB                  	jmp	SYS_RET_OK
 18629                                  
 18630                                  ;============================================================================
 18631                                  ; DELETE.ASM, MSDOS 6.0, 1991
 18632                                  ;============================================================================
 18633                                  ; 07/08/2018 - Retro DOS v3.0
 18634                                  ; 17/05/2019 - Retro DOS v4.0
 18635                                  
 18636                                  ;	TITLE	DOS_DELETE - Internal DELETE call for MS-DOS
 18637                                  ;	NAME	DOS_DELETE
 18638                                  
 18639                                  ;
 18640                                  ;	Microsoft Confidential
 18641                                  ;	Copyright (C) Microsoft Corporation 1991
 18642                                  ;	All Rights Reserved.
 18643                                  ;
 18644                                  
 18645                                  ;**	DELETE.ASM - Low level routine for deleting files
 18646                                  ;----------------------------------------------------------------------------
 18647                                  ;		DOS_DELETE
 18648                                  ;		REN_DEL_Check
 18649                                  ;		FastOpen_Delete	       ; DOS 3.3
 18650                                  ;		FastOpen_Update	       ; DOS 3.3
 18651                                  
 18652                                  ;   Revision history:
 18653                                  ;
 18654                                  ;   A000  version 4.00	Jan. 1988
 18655                                  ;   A001  Fastopen Rename fix	April 1989
 18656                                  
 18657                                  ;Installed = TRUE
 18658                                  
 18659                                  ;	i_need	NoSetDir,BYTE
 18660                                  ;	i_need	Creating,BYTE
 18661                                  ;	i_need	DELALL,BYTE
 18662                                  ;	i_need	THISDPB,DWORD
 18663                                  ;	i_need	THISSFT,DWORD
 18664                                  ;	i_need	THISCDS,DWORD
 18665                                  ;	i_need	CURBUF,DWORD
 18666                                  ;	i_need	ATTRIB,BYTE
 18667                                  ;	i_need	SATTRIB,BYTE
 18668                                  ;	i_need	WFP_START,WORD
 18669                                  ;	i_need	REN_WFP,WORD			 ;BN001
 18670                                  ;	i_need	NAME1,BYTE			 ;BN001
 18671                                  ;	i_need	FoundDel,BYTE
 18672                                  ;	i_need	AUXSTACK,BYTE
 18673                                  ;	i_need	VOLCHNG_FLAG,BYTE
 18674                                  ;	i_need	JShare,DWORD
 18675                                  ;	i_need	FastOpenTable,BYTE		  ; DOS 3.3
 18676                                  ;	i_need	FastTable,BYTE			  ; DOS 4.00
 18677                                  ;
 18678                                  ;	i_need	Del_ExtCluster,WORD		  ; DOS 4.00
 18679                                  ;
 18680                                  ;	i_need	SAVE_BX,WORD			  ; DOS 4.00
 18681                                  ;	i_need	DMAADD,DWORD
 18682                                  ;	i_need	RENAMEDMA,BYTE
 18683                                  
 18684                                  ;----------------------------------------------------------------------------
 18685                                  ;
 18686                                  ; Procedure Name : DOS_DELETE
 18687                                  ;
 18688                                  ; Inputs:
 18689                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 18690                                  ;		terminated)
 18691                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 18692                                  ;		( = -1 if current dir not involved, else
 18693                                  ;		 Points to first char after last "/" of current dir part)
 18694                                  ;	[THISCDS] Points to CDS being used
 18695                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 18696                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 18697                                  ; Function:
 18698                                  ;	Delete the specified file(s)
 18699                                  ; Outputs:
 18700                                  ;	CARRY CLEAR
 18701                                  ;		OK
 18702                                  ;	CARRY SET
 18703                                  ;	    AX is error code
 18704                                  ;		error_file_not_found
 18705                                  ;			Last element of path not found
 18706                                  ;		error_path_not_found
 18707                                  ;			Bad path (not in curr dir part if present)
 18708                                  ;		error_bad_curr_dir
 18709                                  ;			Bad path in current directory part of path
 18710                                  ;		error_access_denied
 18711                                  ;			Attempt to delete device or directory
 18712                                  ;		***error_sharing_violation***
 18713                                  ;			Deny both access required, generates an INT 24.
 18714                                  ;			This error is NOT returned. The INT 24H is generated,
 18715                                  ;			  and the file is ignored (not deleted). Delete will
 18716                                  ;			  simply continue on looking for more files.
 18717                                  ;			  Carry will NOT be set in this case.
 18718                                  ; DS preserved, others destroyed
 18719                                  ;
 18720                                  ;----------------------------------------------------------------------------
 18721                                  
 18722                                  FILEFOUND   equ 01h
 18723                                  FILEDELETED equ 10h
 18724                                  
 18725                                  	; 12/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 18726                                  	; DOSCODE:63E9h (MSDOS 5.0, MSDOS.SYS)
 18727                                  
 18728                                  	; 30/01/2024 - Retro DOS v5.0 (Modified MSDOS 5.0 IBMDOS.COM)
 18729                                  	; DOSCODE:6B11h (PCDOS 7.1, IBMDOS.COM)
 18730                                  
 18731                                  DOS_DELETE:
 18732                                  
 18733                                  ;hkn; DOS_Delete is called from file.asm and fcbio.asm. DS has been set up 
 18734                                  ;hkn; appropriately at this point.
 18735                                  
 18736 00002B65 E8B9EC                  	call	TestNet
 18737 00002B68 7306                    	JNC	short LOCAL_DELETE
 18738                                  
 18739                                  ;IF NOT Installed
 18740                                  ;	transfer NET_DELETE
 18741                                  ;ELSE
 18742                                  	;MOV	AX,(MultNET SHL 8) | 19
 18743                                  	;INT	2FH
 18744                                  	;return
 18745                                  
 18746 00002B6A B81311                  	mov	ax,1113h
 18747 00002B6D CD2F                    	int     2Fh 	; Multiplex - NETWORK REDIRECTOR - DELETE REMOTE FILE
 18748                                  			; SS = DS = DOS CS, SDA first filename pointer -> 
 18749                                  			;		fully-qualified filename in DOS CS
 18750                                  			; SDA CDS pointer -> current directory structure for drive with file
 18751                                  			; Return: CF set on error
 18752 00002B6F C3                      	retn
 18753                                  ;ENDIF
 18754                                  
 18755                                  LOCAL_DELETE:
 18756 00002B70 C606[6F05]00            	MOV	byte [FOUNDDEL],0	; No files found and no files deleted
 18757 00002B75 E86BED                  	call	ECritDisk
 18758                                  	;mov	word [CREATING],0E500h
 18759 00002B78 C706[7E05]00E5          	MOV	WORD [CREATING],DIRFREE*256+0 ; Assume not del *.*
 18760 00002B7E 8B36[B205]              	MOV	SI,[WFP_START]
 18761                                  SKPNUL:
 18762 00002B82 AC                      	LODSB
 18763 00002B83 08C0                    	OR	AL,AL
 18764 00002B85 75FB                    	JNZ	short SKPNUL		; go to end
 18765 00002B87 83EE04                  	SUB	SI,4			; Back over possible "*.*"
 18766 00002B8A 813C2A2E                	CMP	WORD [SI],2E2Ah ; "*."
 18767 00002B8E 7506                    	JNZ	short TEST_QUEST
 18768 00002B90 807C022A                	CMP	BYTE [SI+2],"*"
 18769 00002B94 741F                    	JZ	short CHECK_ATTS
 18770                                  TEST_QUEST:
 18771 00002B96 83EE09                  	SUB	SI,9		; Back over possible "????????.???"
 18772 00002B99 87FE                    	XCHG	DI,SI
 18773                                  
 18774 00002B9B 16                      	push	ss
 18775                                  	;pop	ds ; ! Retro DOS v3.0 BUG !
 18776 00002B9C 07                      	pop	es ; 17/05/2019
 18777                                  
 18778 00002B9D B83F3F                  	MOV	AX,"??" ; 3F3Fh
 18779 00002BA0 B90400                  	MOV	CX,4		; four sets of "??"
 18780 00002BA3 F3AF                    	REPE	SCASW
 18781 00002BA5 751C                    	JNZ	short NOT_ALL
 18782 00002BA7 87FE                    	XCHG	DI,SI
 18783 00002BA9 AD                      	LODSW
 18784 00002BAA 3D2E3F                  	CMP	AX,3F2Eh ; ".?"
 18785 00002BAD 7514                    	JNZ	short NOT_ALL
 18786 00002BAF AD                      	LODSW
 18787 00002BB0 3D3F3F                  	CMP	AX,"??"
 18788 00002BB3 750E                    	JNZ	short NOT_ALL
 18789                                  CHECK_ATTS:
 18790 00002BB5 A0[6D05]                	MOV	AL,[SATTRIB]
 18791                                  	;and	al,1Fh
 18792 00002BB8 241F                    	AND	AL,attr_hidden+attr_system+attr_directory+attr_volume_id+attr_read_only
 18793                                  					; Look only at hidden bits
 18794                                  	;cmp	al,1Fh
 18795 00002BBA 3C1F                    	CMP	AL,attr_hidden+attr_system+attr_directory+attr_volume_id+attr_read_only
 18796                                  					; All must be set
 18797 00002BBC 7505                    	JNZ	short NOT_ALL
 18798                                  
 18799                                  ; NOTE WARNING DANGER-----
 18800                                  ;    This DELALL stuff is not safe. It allows directories to be deleted.
 18801                                  ;	It should ONLY be used by FORMAT in the ROOT directory.
 18802                                  
 18803 00002BBE C606[7F05]00            	MOV	byte [DELALL],0		; DEL *.* - flag deleting all
 18804                                  NOT_ALL:
 18805 00002BC3 C606[4C03]01            	MOV	byte [NoSetDir],1
 18806 00002BC8 E85E1F                  	call	GetPathNoSet
 18807 00002BCB 7312                    	JNC	short Del_found
 18808 00002BCD 750B                    	JNZ	short _bad_path
 18809 00002BCF 08C9                    	OR	CL,CL
 18810 00002BD1 7407                    	JZ	short _bad_path
 18811                                  No_file:
 18812 00002BD3 B80200                  	MOV	AX,error_file_not_found
 18813                                  ErrorReturn:
 18814 00002BD6 F9                      	STC
 18815                                  	;call	LCritDisk
 18816                                  	;retn
 18817                                  	; 18/12/2022
 18818 00002BD7 E936ED                  	jmp	LCritDisk
 18819                                  
 18820                                  _bad_path:
 18821 00002BDA B80300                  	MOV	AX,error_path_not_found
 18822 00002BDD EBF7                    	JMP	short ErrorReturn
 18823                                  
 18824                                  Del_found:
 18825 00002BDF 750C                    	JNZ	short NOT_DIR		; Check for dir specified
 18826 00002BE1 803E[7F05]00            	CMP	byte [DELALL],0		; DelAll = 0 allows delete of dir.
 18827 00002BE6 7405                    	JZ	short NOT_DIR
 18828                                  Del_access_err:
 18829 00002BE8 B80500                  	MOV	AX,error_access_denied
 18830 00002BEB EBE9                    	JMP	short ErrorReturn
 18831                                  
 18832                                  NOT_DIR:
 18833 00002BED 08E4                    	OR	AH,AH			; Check if device name
 18834 00002BEF 78F7                    	JS	short Del_access_err	; Can't delete I/O devices
 18835                                  
 18836                                  ; Main delete loop. CURBUF+2:BX points to a matching directory entry.
 18837                                  
 18838                                  DELFILE:
 18839 00002BF1 800E[6F05]01            	OR	byte [FOUNDDEL],FILEFOUND ; file found, not deleted yet
 18840                                  
 18841                                  ; If we are deleting the Volume ID, then we set VOLUME_CHNG flag to make
 18842                                  ; DOS issue a build BPB call the next time this drive is accessed.
 18843                                  
 18844 00002BF6 1E                      	PUSH	DS
 18845 00002BF7 8A26[7F05]              	MOV	AH,[DELALL]
 18846 00002BFB C53E[E205]              	LDS	DI,[CURBUF]
 18847                                  	
 18848                                  ;hkn; SS override
 18849 00002BFF 36F606[6B05]01          	TEST	byte [SS:ATTRIB],attr_read_only ; are we deleting RO files too?
 18850 00002C05 7509                    	JNZ	short DoDelete		; yes
 18851                                  
 18852 00002C07 F6470B01                	TEST	byte [BX+dir_entry.dir_attr],attr_read_only
 18853 00002C0B 7403                    	JZ	short DoDelete		; not read only
 18854                                  
 18855                                  	; 30/01/2024 (PCDOS 7.1 IBMDOS.COM)
 18856                                  Skip_it:
 18857 00002C0D 1F                      	POP	DS
 18858 00002C0E EB57                    	JMP	SHORT DELNXT		; Skip it (Note ES:BP not set)
 18859                                  
 18860                                  DoDelete:
 18861 00002C10 E8AF00                  	call	REN_DEL_Check		; Sets ES:BP = [THISDPB]
 18862                                  	;JNC	short DEL_SHARE_OK
 18863                                  	;POP	DS
 18864                                  	;JMP	SHORT DELNXT		; Skip it
 18865                                  	; 30/01/2024
 18866 00002C13 72F8                    	jc	short Skip_it
 18867                                  
 18868                                  DEL_SHARE_OK:
 18869                                  	; 17/05/2019 - Retro DOS v4.0
 18870                                  	; MSDOS 6.0
 18871                                  	;test	byte [di+5],40h
 18872 00002C15 F6450540                	TEST	byte [DI+BUFFINFO.buf_flags],buf_dirty
 18873                                  					;LB. if already dirty		  ;AN000;
 18874 00002C19 7507                    	JNZ	short yesdirty		;LB.  don't increment dirty count ;AN000;
 18875 00002C1B E8D93F                  	call	INC_DIRTY_COUNT		;LB.				  ;AN000;
 18876                                  	;or	byte [di+5],40h
 18877 00002C1E 804D0540                	OR	byte [DI+BUFFINFO.buf_flags],buf_dirty
 18878                                  yesdirty:
 18879 00002C22 8827                    	mov	[bx],ah 
 18880                                  	;MOV	[BX+dir_entry.dir_name],AH ; Put in E5H or 0
 18881                                  	;;;
 18882                                  	; 30/01/2024 - Retro DOS v5.0
 18883                                  	; (PCDOS 7.1 IBMDOS.COM)
 18884 00002C24 31DB                    	xor	bx,bx ; 0
 18885                                  	;cmp	[es:bp+0Fh],bx
 18886 00002C26 26395E0F                	cmp	[es:bp+DPB.FAT_SIZE],bx ; 0
 18887 00002C2A 7503                    	jnz     short yesdirty_fc_1	;  not FAT32
 18888 00002C2C 8B5CFA                  	mov     bx,[si-6]		;  high word of the first cluster (FAT32)
 18889                                  yesdirty_fc_1:
 18890                                  	;mov	[ss:CLUSTNUM_HW],bx 
 18891 00002C2F 89DA                    	mov	dx,bx ; * ; 30/01/2024 - Retro DOS v5.0
 18892                                  	;;;
 18893                                  
 18894 00002C31 8B1C                    	MOV	BX,[SI] 		; Get firclus pointer
 18895 00002C33 1F                      	POP	DS
 18896                                  	;;;
 18897 00002C34 8916[E80A]              	mov	[CLUSTNUM_HW],dx ; * ; 30/01/2024 - Retro DOS v5.0
 18898                                  	;;;
 18899 00002C38 800E[6F05]10            	OR	byte [FOUNDDEL],FILEDELETED ; 10h ; Deleted file
 18900                                  
 18901                                  	; 30/01/2024
 18902                                  	;CMP	BX,2
 18903                                  	;JB	short DELNXT		; File has invalid FIRCLUS (too small)
 18904                                  	;;;
 18905                                  	; 30/01/2024 - Retro DOS v5.0
 18906                                  	; (PCDOS 7.1 IBMDOS.COM)
 18907                                  	;cmp	word [CLUSTNUM_HW],0
 18908 00002C3D 21D2                    	and	dx,dx ; 30/01/2024 - Retro DOS v5.0
 18909 00002C3F 7505                    	jnz	short yesdirty_fc_2
 18910 00002C41 83FB02                  	cmp	bx,2
 18911 00002C44 7221                    	jb	short DELNXT		; File has invalid FIRCLUS (too small)
 18912                                  yesdirty_fc_2:
 18913                                  	;cmp	word [es:bp+0Fh],0
 18914 00002C46 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 18915 00002C4B 750C                    	jnz     short yesdirty_fc_3	; not FAT32
 18916                                  	;push	bx
 18917                                  	;mov	bx,[CLUSTNUM_HW]
 18918                                  	;;cmp	bx,[es:bp+2Fh]
 18919                                  	;cmp	bx,[es:bp+DPB.LAST_CLUSTER+2]
 18920                                  	;30/01/2024 - Retro DOS v5.0
 18921                                  	;mov	dx,[CLUSTNUM_HW]
 18922                                  	; dx = [CLUSTNUM_HW] ; *
 18923 00002C4D 263B562F                	cmp	dx,[es:bp+DPB.LAST_CLUSTER+2]
 18924                                  	;pop	bx
 18925 00002C51 750A                    	jne	short yesdirty_fc_4
 18926                                  	;cmp	bx,[es:bp+2Dh]
 18927 00002C53 263B5E2D                	cmp	bx,[es:bp+DPB.LAST_CLUSTER]
 18928 00002C57 EB04                    	jmp     short yesdirty_fc_4
 18929                                  yesdirty_fc_3:
 18930                                  	;;;
 18931                                  	;cmp	bx,[es:bp+0Dh]
 18932 00002C59 263B5E0D                	CMP	BX,[ES:BP+DPB.MAX_CLUSTER]
 18933                                  yesdirty_fc_4:	; 30/01/2024
 18934 00002C5D 7708                    	JA	short DELNXT		; File has invalid FIRCLUS (too big)
 18935                                  
 18936 00002C5F E89B2F                  	call	RELEASE 		; Free file data
 18937 00002C62 7258                    	JC	short No_fileJ
 18938                                  
 18939                                  ; DOS 3.3  FastOpen
 18940                                  
 18941 00002C64 E8D900                  	CALL	FastOpen_Delete 	; delete the dir info in fastopen
 18942                                  
 18943                                  ; DOS 3.3  FastOpen
 18944                                  
 18945                                  DELNXT:
 18946 00002C67 C42E[8A05]              	LES	BP,[THISDPB]		; Possible to get here without this set
 18947 00002C6B E83D1C                  	call	GETENTRY		; Registers need to be reset
 18948 00002C6E 724C                    	JC	short No_fileJ
 18949 00002C70 E8341B                  	call	NEXTENT
 18950                                  	;JNC	short DELFILE
 18951                                  	; 30/01/2024
 18952 00002C73 7203                    	jc	short DELNXT2
 18953 00002C75 E979FF                  	jmp	DELFILE
 18954                                  DELNXT2:
 18955 00002C78 C42E[8A05]              	LES	BP,[THISDPB]		; NEXTENT sets ES=DOSGROUP
 18956                                  	
 18957                                  	;;;
 18958                                  	; 30/01/2024 - Retro DOS v5.0
 18959                                  	; (PCDOS 7.1 IBMDOS.COM)
 18960                                  	;
 18961 00002C7C E8EE07                  	call	update_fat32_fsinfo
 18962                                  	;;;
 18963                                  
 18964                                  	; 12/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 18965                                  	;MOV	AL,[ES:BP+DPB.DRIVE]
 18966                                  	;;mov	al,[es:bp+0]
 18967                                  	; 15/12/2022
 18968 00002C7F 268A4600                	MOV	AL,[ES:BP]
 18969 00002C83 E83F3E                  	call	FLUSHBUF
 18970 00002C86 7234                    	JC	short No_fileJ
 18971                                  ;
 18972                                  ; Now we need to test FoundDel for our flags. The cases to consider are:
 18973                                  ;
 18974                                  ;   not found not deleted		file not found
 18975                                  ;   not found	  deleted		*** impossible ***
 18976                                  ;	found not deleted		access denied (read-only)
 18977                                  ;	found	  deleted		no error
 18978                                  ;
 18979 00002C88 F606[6F05]10            	TEST	byte [FOUNDDEL],FILEDELETED ; did we delete a file?
 18980 00002C8D 7426                    	JZ	short DelError		; no, figure out what's wrong.
 18981                                  
 18982                                  ; We set VOLCHNG_FLAG to indicate that we have changed the volume label
 18983                                  ; and to force the DOS to issue a media check.
 18984                                  
 18985 00002C8F F606[6B05]08            	TEST	byte [ATTRIB],attr_volume_id ; 8
 18986 00002C94 741C                    	jz	short No_Set_Flag
 18987 00002C96 50                      	PUSH	AX
 18988 00002C97 06                      	PUSH	ES
 18989 00002C98 57                      	PUSH	DI
 18990 00002C99 C43E[A205]              	LES	DI,[THISCDS]
 18991 00002C9D 268A25                  	MOV	AH,[ES:DI]		; Get drive
 18992 00002CA0 80EC41                  	SUB	AH,'A'                  ; Convert to 0-based
 18993 00002CA3 8826[A10A]              	mov	[VOLCHNG_FLAG],AH
 18994                                  	
 18995                                  	; MSDOS 6.0
 18996 00002CA7 30FF                    	XOR	BH,BH			;>32mb delete volume id from boot record ;AN000;
 18997 00002CA9 E8EB04                  	call	Set_Media_ID		;>32mb set volume id to boot record	 ;AN000;
 18998                                  	 
 18999 00002CAC E8DC38                  	call	FATREAD_CDS		; force media check
 19000 00002CAF 5F                      	POP	DI
 19001 00002CB0 07                      	POP	ES
 19002 00002CB1 58                      	POP	AX
 19003                                  No_Set_Flag:
 19004                                  	;call	LCritDisk		; carry is clear
 19005                                  	;retn
 19006                                  	; 18/12/2022
 19007 00002CB2 E95BEC                  	jmp	LCritDisk
 19008                                  DelError:
 19009 00002CB5 F606[6F05]01            	TEST	byte [FOUNDDEL],FILEFOUND ; not deleted. Did we find file?
 19010 00002CBA 7503                    	JNZ	short Del_access_errJ 	; yes. Access denied
 19011                                  No_fileJ:
 19012 00002CBC E914FF                  	JMP	No_file ; 10/08/2018 		; Nope
 19013                                  Del_access_errJ:
 19014 00002CBF E926FF                  	JMP	Del_access_err ; 10/08/2018
 19015                                  
 19016                                  ; 08/08/2018 - Retro DOS v3.0
 19017                                  
 19018                                  ;Break	<REN_DEL_Check - check for access for rename and delete>
 19019                                  ;---------------------------------------------------------------------------
 19020                                  ; Procedure Name : REN_DEL_Check
 19021                                  ;
 19022                                  ; Inputs:
 19023                                  ;	[THISDPB] set
 19024                                  ;	[CURBUF+2]:BX points to entry
 19025                                  ;	[CURBUF+2]:SI points to firclus field of entry
 19026                                  ;	[WFP_Start] points to name
 19027                                  ; Function:
 19028                                  ;	Check for Exclusive access on given file.
 19029                                  ;	  Used by RENAME, SET_FILE_INFO, and DELETE.
 19030                                  ; Outputs:
 19031                                  ;	ES:BP = [THISDPB]
 19032                                  ;	NOTE: The WFP string pointed to by [WFP_Start] Will be Modified. The
 19033                                  ;		last element will be loaded from the directory entry. This is
 19034                                  ;		so the name given to the sharer doesn't have any meta chars in
 19035                                  ;		it.
 19036                                  ;	Carry set if sharing violation, INT 24H generated
 19037                                  ;	    NOTE THAT AX IS NOT error_sharing_violation.
 19038                                  ;		This is because input AX is preserved.
 19039                                  ;		Caller must set the error if needed.
 19040                                  ;	Carry clear
 19041                                  ;		OK
 19042                                  ; AX,DS,BX,SI,DI preserved
 19043                                  ;---------------------------------------------------------------------------
 19044                                  
 19045                                  	; 31/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 19046                                  	
 19047                                  REN_DEL_Check:
 19048                                  
 19049 00002CC2 1E                      	PUSH	DS
 19050 00002CC3 57                      	PUSH	DI
 19051 00002CC4 50                      	PUSH	AX
 19052 00002CC5 53                      	PUSH	BX
 19053 00002CC6 56                      	PUSH	SI		; Save CURBUF pointers
 19054                                  	
 19055 00002CC7 16                      	push	ss
 19056 00002CC8 07                      	pop	es
 19057                                  
 19058                                  ;hkn; context ES will assume ES to DOSDATA
 19059                                  ;hkn; ASSUME	ES:DOSGROUP
 19060                                  
 19061                                  ;hkn; SS override
 19062 00002CC9 368B3E[B205]            	MOV	DI,[SS:WFP_START] ; ES:DI -> WFP
 19063 00002CCE 89DE                    	MOV	SI,BX
 19064                                  
 19065                                  ;hkn; SS override
 19066 00002CD0 368E1E[E405]            	MOV	DS,[SS:CURBUF+2] ; DS:SI -> entry (FCB style name)
 19067 00002CD5 89FB                    	MOV	BX,DI		; Set backup limit for skipback
 19068                                  	;ADD	BX,2		; Skip over d: to point to leading '\'
 19069                                  	; 31/01/2024
 19070 00002CD7 43                      	inc	bx
 19071 00002CD8 43                      	inc	bx
 19072 00002CD9 E8E5EA                  	call	StrLen		; CX is length of ES:DI including NUL
 19073 00002CDC 49                      	DEC	CX		; Don't include nul in count
 19074 00002CDD 01CF                    	ADD	DI,CX		; Point to NUL at end of string
 19075 00002CDF E88F51                  	call	SkipBack	; Back up one element
 19076 00002CE2 47                      	INC	DI		; Point to start of last element
 19077                                  
 19078                                  	; 17/05/2019 - Retro DOS v4.0
 19079                                  ;hkn; SS override
 19080                                  	; MSDOS 6.0
 19081 00002CE3 36893E[0106]            	MOV	[SS:SAVE_BX],DI	;IFS. save for DOS_RENAME   ;AN000;
 19082                                  	;
 19083 00002CE8 E8C4F9                  	call	PackName	; Transfer name from entry to ASCIZ tail.
 19084 00002CEB 5E                      	POP	SI		; Get back entry pointers
 19085 00002CEC 5B                      	POP	BX
 19086 00002CED 53                      	PUSH	BX
 19087 00002CEE 56                      	PUSH	SI		; Back on stack
 19088                                  	
 19089 00002CEF 16                      	push	ss
 19090 00002CF0 1F                      	pop	ds
 19091                                  
 19092                                  ;hkn; context DS will assume ES to DOSDATA
 19093                                  ;hkn; ASSUME	DS:DOSGROUP
 19094                                  
 19095                                  ; Close the file if possible by us.
 19096                                  ;
 19097                                  ;if installed
 19098 00002CF1 FF1E[C400]              	Call	far [JShare+(13*4)] ; 13 = ShCloseFile
 19099                                  ;else
 19100                                  ;	Call	ShCloseFile
 19101                                  ;endif
 19102                                  	;;;
 19103                                  	; 31/01/2024 - Retro DOS v5.0
 19104                                  	; PCDOS 7.1 IBMDOS.COM
 19105 00002CF5 803E[0303]FF            	cmp	byte [fShare],0FFh
 19106 00002CFA 750A                    	jne	short rdc_1
 19107 00002CFC 8C06[A005]              	mov	[THISSFT+2],es
 19108 00002D00 893E[9E05]              	mov	[THISSFT],di
 19109 00002D04 EB0A                    	jmp	short rdc_2
 19110                                  rdc_1:
 19111                                  	;;;
 19112 00002D06 8C1E[A005]              	MOV	[THISSFT+2],DS
 19113                                  
 19114                                  ;hkn; AUXSTACK is in DOSDATA
 19115 00002D0A C706[9E05][6507]        	MOV	word [THISSFT],AUXSTACK-SF_ENTRY.size  ; RENAMEDMA+(384-59)
 19116                                  				; Scratch space
 19117                                  rdc_2:		; 30/01/2024
 19118 00002D10 30E4                    	XOR	AH,AH		; Indicate file to DOOPEN (high bit off)
 19119 00002D12 E81129                  	call	DOOPEN		; Fill in SFT for share check
 19120 00002D15 C43E[9E05]              	LES	DI,[THISSFT]
 19121                                  	;mov	word [es:di+2],10h
 19122 00002D19 26C745021000            	MOV	word [ES:DI+SF_ENTRY.sf_mode],SHARING_DENY_BOTH ; 10h
 19123                                  				; requires exclusive access
 19124                                  	;MOV	word [ES:DI+SF_ENTRY.sf_ref_count],1 ; Pretend open
 19125 00002D1F 26C7050100              	mov	word [ES:DI],1
 19126 00002D24 E89657                  	call	ShareEnter
 19127 00002D27 720D                    	jc	short CheckDone
 19128 00002D29 C43E[9E05]              	LES	DI,[THISSFT]
 19129                                  	;MOV	word [ES:DI+SF_ENTRY.sf_ref_count],0
 19130 00002D2D 26C7050000              	mov	word [ES:DI],0	; Pretend closed and free
 19131                                  	
 19132 00002D32 E88357                  	call	ShareEnd	; Tell sharer we're done with THISSFT
 19133 00002D35 F8                      	CLC
 19134                                  CheckDone:
 19135 00002D36 C42E[8A05]              	LES	BP,[THISDPB]
 19136 00002D3A 5E                      	POP	SI
 19137 00002D3B 5B                      	POP	BX
 19138 00002D3C 58                      	POP	AX
 19139 00002D3D 5F                      	POP	DI
 19140 00002D3E 1F                      	POP	DS
 19141 00002D3F C3                      	retn
 19142                                  
 19143                                  ;Break	<FastOpen_Delete - delete dir info in fastopen>
 19144                                  ;---------------------------------------------------------------------------
 19145                                  ; Procedure Name : FastOpen_Delete
 19146                                  ; Inputs:
 19147                                  ;	None
 19148                                  ; Function:
 19149                                  ;	Call FastOpen to delete the dir info.
 19150                                  ; Outputs:
 19151                                  ;	None
 19152                                  ;---------------------------------------------------------------------------
 19153                                  
 19154                                  	; 31/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 19155                                  
 19156                                  FastOpen_Delete:
 19157 00002D40 9C                      	PUSHF			; save flag
 19158 00002D41 56                      	PUSH	SI		; save registers
 19159 00002D42 57                      	push	di ; 31/01/2024 (PCDOS 7.1 IBMDOS.COM)
 19160 00002D43 53                      	PUSH	BX
 19161 00002D44 50                      	PUSH	AX
 19162                                  	;mov	si,[WFP_START] ; MSDOS 3.3
 19163                                  ;hkn; SS override
 19164                                  	; 17/05/2019 - Retro DOS v4.0
 19165                                  	; MSDOS 6.0
 19166 00002D45 368B36[B205]            	MOV	SI,[ss:WFP_START] ; ds:si points to path name
 19167                                  	
 19168 00002D4A B003                    	MOV	AL,FONC_delete	; al = 3
 19169                                  
 19170                                  ; 31/01/2024 (PCDOS 7.1 IBMDOS.COM)
 19171                                  %if 0 
 19172                                  fastinvoke:
 19173                                  ;hkn; FastTable is in DOSDATA
 19174                                  	MOV	BX,FastTable+2
 19175                                  	CALL	far [BX]	; call fastopen
 19176                                  	POP	AX		; restore registers
 19177                                  	POP	BX
 19178                                  	;pop	di ; 31/01/2024 (PCDOS 7.1 IBMDOS.COM)
 19179                                  	POP	SI
 19180                                  	POPF			; restore flag
 19181                                  	retn
 19182                                  %else
 19183 00002D4C EB0F                    	jmp	short fastinvoke ; 31/01/2024
 19184                                  %endif
 19185                                  
 19186                                  	; 13/11/2022 Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 19187                                  	; DOSCODE:65A0h (MSDOS 5.0 MSDOS.SYS)
 19188                                  
 19189                                  	; 31/01/2024 Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 19190                                  	; DOSCODE:65B4h (MSDOS 6.22 MSDOS.SYS)
 19191                                  	; DOSCODE:6D07h (PCDOS 7.1 IBMDOS.COM)
 19192                                  
 19193                                  ;Break	<FastOpen_Rename - Rename directory>	   ; PTR 5622
 19194                                  ;---------------------------------------------------------------------------
 19195                                  ; PROCEDURE Name : FastOpen_Rename
 19196                                  ;
 19197                                  ; Inputs:
 19198                                  ;	 REN_WFP   = Path Name
 19199                                  ;	 NAME1	   = New Name
 19200                                  ; Function:
 19201                                  ;	Call FastOpen to rename the dir entry in the cache
 19202                                  ; Outputs:
 19203                                  ;	None
 19204                                  ;---------------------------------------------------------------------------
 19205                                  
 19206                                  FastOpen_Rename:
 19207                                  	; 17/05/2019 - Retro DOS v4.0
 19208                                  	; 08/08/2018 - Retro DOS v3.0
 19209                                  	; MSDOS 6.0
 19210 00002D4E 9C                      	PUSHF			;AN001 save flag
 19211 00002D4F 56                      	PUSH	SI		;AN001 save registers
 19212 00002D50 57                      	PUSH	DI		;AN001
 19213 00002D51 53                      	PUSH	BX		;AN001
 19214 00002D52 50                      	PUSH	AX		;AN001
 19215                                  	;
 19216                                  ;hkn; SS override
 19217 00002D53 368B36[B405]            	MOV	SI,[SS:REN_WFP]	;AN001	;;AN001  ds:si-->Path name addrs
 19218                                  
 19219                                  ;hkn; NAME1 is in DOSDATA
 19220 00002D58 BF[4B05]                	MOV	DI,NAME1	;;AN001  ds:di-->New name addrs
 19221                                  	;mov	al,6
 19222 00002D5B B006                    	MOV	AL,FONC_Rename	;;AN001  al = 6
 19223                                  
 19224                                  fastinvoke:	; 31/01/2024 (PCDOS 7.1 IBMDOS.COM)
 19225                                  	
 19226                                  ;hkn; FastTable is in DOSDATA
 19227 00002D5D BB[3E11]                	MOV	BX,FastTable+2
 19228 00002D60 FF1F                    	CALL	far [BX]	;;AN001  call fastopen
 19229                                  	
 19230 00002D62 58                      	POP	AX		; restore registers  ;AN001
 19231 00002D63 5B                      	POP	BX				     ;AN001
 19232 00002D64 5F                      	POP	DI				     ;AN001
 19233 00002D65 5E                      	POP	SI				     ;AN001
 19234 00002D66 9D                      	POPF			; restore flag	     ;AN001
 19235 00002D67 C3                      	retn					     ;AN001
 19236                                  
 19237                                  ;Break	<FastOpen_Update - update dir info in fastopen>
 19238                                  ;---------------------------------------------------------------------------
 19239                                  ; Procedure Name : FastOpen_Update
 19240                                  ;
 19241                                  ; Inputs:
 19242                                  ;	DL     drive number (A=0,B=1,,,)
 19243                                  ;	CX     first cluster #
 19244                                  ;	AH     0 updates dir entry
 19245                                  ;	       1 updates CLUSNUM , BP = new CLUSNUM
 19246                                  ;	ES:DI  directory entry
 19247                                  ; Function:
 19248                                  ;	Call FastOpen to update the dir info.
 19249                                  ; Outputs:
 19250                                  ;	None
 19251                                  ;---------------------------------------------------------------------------
 19252                                  
 19253                                  FastOpen_Update:
 19254 00002D68 9C                      	PUSHF			; save flag
 19255 00002D69 56                      	PUSH	SI
 19256 00002D6A 57                      	push	di ; 31/01/2024 (PCDOS 7.1 IBMDOS.COM)
 19257 00002D6B 53                      	PUSH	BX		; save regs
 19258 00002D6C 50                      	PUSH	AX
 19259 00002D6D B004                    	MOV	AL,FONC_update	; al = 4
 19260 00002D6F EBEC                    	JMP	short fastinvoke
 19261                                  
 19262                                  	; 17/05/2019
 19263                                  
 19264                                  	; MSDOS 6.0
 19265                                  ;entry Fast_Dispatch		; future fastxxxx entry	;AN000;
 19266                                  ;---------------------------------------------------------------------------
 19267                                  Fast_Dispatch:
 19268                                  ;hkn; FastTable is in DOSDATA
 19269 00002D71 BE[3E11]                	MOV	SI,FastTable+2	; index to the	     ;AN000;
 19270                                  ;hkn; use SS override
 19271 00002D74 36FF1C                  	CALL	far [SS:SI]	; RMFD call fastopen
 19272 00002D77 C3                      	retn
 19273                                  
 19274                                  ;============================================================================
 19275                                  ; RENAME.ASM, MSDOS 6.0, 1991
 19276                                  ;============================================================================
 19277                                  ; 08/08/2018 - Retro DOS v3.0
 19278                                  ; 17/05/2019 - Retro DOS v4.0
 19279                                  
 19280                                  ;	TITLE	DOS_RENAME - Internal RENAME call for MS-DOS
 19281                                  ;	NAME	DOS_RENAME
 19282                                  
 19283                                  ;**	Low level routine for renaming files
 19284                                  ;----------------------------------------------------------------------------
 19285                                  ;	DOS_RENAME
 19286                                  ;
 19287                                  ;	Modification history:
 19288                                  ;
 19289                                  ;	    Created: ARR 30 March 1983
 19290                                  
 19291                                  ;----------------------------------------------------------------------------
 19292                                  ;
 19293                                  ; Procedure Name : DOS_RENAME
 19294                                  ;
 19295                                  ; Inputs:
 19296                                  ;	[WFP_START] Points to SOURCE WFP string ("d:/" must be first 3
 19297                                  ;		chars, NUL terminated)
 19298                                  ;	[CURR_DIR_END] Points to end of Current dir part of string [SOURCE]
 19299                                  ;		( = -1 if current dir not involved, else
 19300                                  ;		 Points to first char after last "/" of current dir part)
 19301                                  ;	[REN_WFP] Points to DEST WFP string ("d:/" must be first 3
 19302                                  ;		chars, NUL terminated)
 19303                                  ;	[THISCDS] Points to CDS being used
 19304                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 19305                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 19306                                  ; Function:
 19307                                  ;	Rename the specified file(s)
 19308                                  ;	NOTE: This routine uses most of AUXSTACK as a temp buffer.
 19309                                  ; Outputs:
 19310                                  ;	CARRY CLEAR
 19311                                  ;	    OK
 19312                                  ;	CARRY SET
 19313                                  ;	    AX is error code
 19314                                  ;		error_file_not_found
 19315                                  ;			No match for source, or dest path invalid
 19316                                  ;		error_not_same_device
 19317                                  ;			Source and dest are on different devices
 19318                                  ;		error_access_denied
 19319                                  ;			Directory specified (not simple rename),
 19320                                  ;			Device name given, Destination exists.
 19321                                  ;			NOTE: In third case some renames may have
 19322                                  ;			 been done if metas.
 19323                                  ;		error_path_not_found
 19324                                  ;			Bad path (not in curr dir part if present)
 19325                                  ;			SOURCE ONLY
 19326                                  ;		error_bad_curr_dir
 19327                                  ;			Bad path in current directory part of path
 19328                                  ;			SOURCE ONLY
 19329                                  ;		error_sharing_violation
 19330                                  ;			Deny both access required, generates an INT 24.
 19331                                  ; DS preserved, others destroyed
 19332                                  ;
 19333                                  ;----------------------------------------------------------------------------
 19334                                  
 19335                                  	; 14/11/2022 Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 19336                                  	; 31/01/2024 Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 19337                                  
 19338                                  DOS_RENAME:
 19339                                  
 19340                                  ;hkn; DOS_RENAME is called from file.asm and fcbio.asm. DS has been set up
 19341                                  ;hkn; at this point to DOSDATA.
 19342                                  
 19343 00002D78 E8A6EA                  	call	TestNet
 19344 00002D7B 7306                    	JNC	short LOCAL_RENAME
 19345                                  
 19346                                  ;IF NOT Installed
 19347                                  ;	transfer NET_RENAME
 19348                                  ;ELSE
 19349                                  	;MOV	AX,(MultNET SHL 8) OR 17
 19350                                  	;INT	2FH
 19351                                  	;return
 19352                                  
 19353 00002D7D B81111                  	mov     ax, 1111h
 19354 00002D80 CD2F                    	int     2Fh 	; Multiplex - NETWORK REDIRECTOR - RENAME REMOTE FILE
 19355                                  			; SS = DS = DOS CS, 
 19356                                  			; SDA first filename pointer = offset of fully-qualified old name
 19357                                  			; SDA CDS pointer -> current directory
 19358                                  			; Return: CF set on error
 19359 00002D82 C3                      	retn
 19360                                  ;ENDIF
 19361                                  
 19362                                  LOCAL_RENAME:
 19363 00002D83 C606[2303]02            	MOV	byte [EXTERR_LOCUS],errLOC_Disk ; 2
 19364 00002D88 8B36[B205]              	MOV	SI,[WFP_START]
 19365 00002D8C 8B3E[B405]              	MOV	DI,[REN_WFP]
 19366 00002D90 8A04                    	MOV	AL,[SI]
 19367 00002D92 8A25                    	MOV	AH,[DI]
 19368 00002D94 0D2020                  	OR	AX,2020H		; Lower case
 19369 00002D97 38E0                    	CMP	AL,AH
 19370 00002D99 7405                    	JZ	short SAMEDRV
 19371 00002D9B B81100                  	MOV	AX,error_not_same_device ; 11h
 19372 00002D9E F9                      	STC
 19373 00002D9F C3                      	retn
 19374                                  
 19375                                  SAMEDRV:
 19376 00002DA0 FF36[2E03]              	PUSH	WORD [DMAADD+2]
 19377 00002DA4 FF36[2C03]              	PUSH	WORD [DMAADD]
 19378 00002DA8 8C1E[2E03]              	MOV	[DMAADD+2],DS
 19379                                  
 19380                                  ;hkn; RENAMEDMA is in DOSDATA
 19381 00002DAC C706[2C03][2006]        	MOV	WORD [DMAADD],RENAMEDMA
 19382 00002DB2 C606[7005]00            	MOV	byte [FOUND_DEV],0	; Rename fails on DEVS, assume not a dev
 19383 00002DB7 E829EB                  	call	ECritDisk
 19384 00002DBA E86807                  	call	DOS_SEARCH_FIRST	; Sets [NoSetDir] to 1, [CURBUF+2]:BX
 19385                                  					;    points to entry
 19386 00002DBD 7314                    	JNC	short Check_Dev
 19387 00002DBF 83F812                  	CMP	AX,error_no_more_files ; 12h
 19388 00002DC2 7503                    	JNZ	short GOTERR
 19389 00002DC4 B80200                  	MOV	AX,error_file_not_found ; 2
 19390                                  GOTERR:
 19391 00002DC7 F9                      	STC
 19392                                  RENAME_POP:
 19393 00002DC8 8F06[2C03]              	POP	WORD [DMAADD]
 19394 00002DCC 8F06[2E03]              	POP	WORD [DMAADD+2]
 19395                                  	;call	LCritDisk
 19396                                  	;retn
 19397                                  	; 16/12/2022
 19398 00002DD0 E93DEB                  	jmp	LCritDisk
 19399                                  
 19400                                  Check_Dev:
 19401                                  	; 17/05/2019 - Retro DOS v4.0
 19402                                  	;mov	ax,5
 19403 00002DD3 B80500                  	MOV	AX,error_access_denied	; Assume error
 19404                                  	
 19405                                  	; MSDOS 6.0
 19406 00002DD6 1E                      	PUSH	DS			      ;PTM.			    ;AN000;
 19407 00002DD7 C536[2C03]              	LDS	SI,[DMAADD]		      ;PTM.  check if source a dir  ;AN000;
 19408                                  	;add	si,21
 19409 00002DDB 83C615                  	ADD	SI,find_buf.attr	      ;PTM.			    ;AN000;
 19410                                  	;test	byte [si+11],10h
 19411 00002DDE F6440B10                	TEST	byte [SI+dir_entry.dir_attr],attr_directory ;PTM.	    ;AN000;
 19412 00002DE2 7407                    	JZ	short notdir		      ;PTM.			    ;AN000;
 19413 00002DE4 8B36[B405]              	MOV	SI,[REN_WFP]		      ;PTM.  if yes, make sure path ;AN000;
 19414 00002DE8 E86FFA                  	call	Check_PathLen2		      ;PTM.   length < 67	    ;AN000;
 19415                                  notdir:
 19416 00002DEB 1F                      	POP	DS			      ;PTM.			    ;AN000;
 19417 00002DEC 77D9                    	JA	short GOTERR		      ;PTM.			    ;AN000;
 19418                                  
 19419                                  	; MSDOS 3.3 & MSDOS 6.0
 19420 00002DEE 803E[7005]00            	CMP	byte [FOUND_DEV],0
 19421 00002DF3 75D2                    	JNZ	short GOTERR
 19422                                  
 19423                                  ; At this point a source has been found. There is search continuation info (a
 19424                                  ; la DOS_SEARCH_NEXT) for the source at RENAMEDMA, together with the first
 19425                                  ; directory entry found.
 19426                                  ; [THISCDS], [THISDPB], and [THISDRV] are set and will remain correct
 19427                                  ; throughout the RENAME since it is known at this point that the source and
 19428                                  ; destination are both on the same device.
 19429                                  ; [SATTRIB] is also set.
 19430                                  
 19431 00002DF5 89DE                    	MOV	SI,BX
 19432                                  	;add	si,26
 19433 00002DF7 83C61A                  	ADD	SI,dir_entry.dir_first
 19434 00002DFA E8C5FE                  	call	REN_DEL_Check
 19435 00002DFD 7305                    	JNC	short REN_OK1
 19436 00002DFF B82000                  	MOV	AX,error_sharing_violation  ; 20h
 19437 00002E02 EBC4                    	JMP	short RENAME_POP
 19438                                  
 19439                                  ;------------------------------------------------------------------------------
 19440                                  ; Check if the source is a file or directory. If file, delete the entry
 19441                                  ; from the Fastopen cache. If directory, rename it later
 19442                                  ;------------------------------------------------------------------------------
 19443                                  
 19444                                  REN_OK1:				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 19445                                  	; MSDOS 6.0
 19446                                  	; 31/01/2024 (PCDOS 7.1 IBMDOS.COM)
 19447                                  	;PUSH	SI
 19448 00002E04 C536[2C03]              	LDS	SI,[DMAADD]		;BN00X; PTM. check if source a dir ;AN000;
 19449                                  	;add	si,21
 19450 00002E08 83C615                  	ADD	SI,find_buf.attr	;;BN00XPTM.P5520		;AN000;
 19451                                  	;test	byte [si+11],10h
 19452 00002E0B F6440B10                	TEST	byte [SI+dir_entry.dir_attr],attr_directory ;;BN00XPTM. ;AN000;
 19453                                  	;JZ	short NOT_DIR1		;;BN00XPTM.			;AN000;
 19454 00002E0F 7503                    	jnz	short SWAP_SOURCE ; 31/01/2024
 19455                                  	;POP	SI			;BN00X
 19456                                  	;JMP	SHORT SWAP_SOURCE	;BN00X
 19457                                  ;NOT_DIR1:				;;BN00X it is a file, delete the entry
 19458                                  	;POP	SI
 19459                                  
 19460                                  	; MSDOS 3.3 (& MSDOS 6.0)
 19461 00002E11 E82CFF                  	call	FastOpen_Delete 	; delete dir info in fastopen DOS 3.3
 19462                                  SWAP_SOURCE:
 19463                                  	; MSDOS 3.3
 19464                                  	;MOV	SI,[REN_WFP]
 19465                                  	;MOV	[WFP_START],SI
 19466                                  	; MSDOS 6.0
 19467 00002E14 A1[B205]                	MOV	AX,[WFP_START]		; Swap source and destination
 19468 00002E17 8B36[B405]              	MOV	SI,[REN_WFP]		; Swap source and destination
 19469 00002E1B 8936[B205]              	MOV	[WFP_START],SI		; WFP_START = Destination path
 19470 00002E1F A3[B405]                	MOV	[REN_WFP],AX		; REN_WFP   = Source path
 19471                                  	; MSDOS 3.3 (& MSDOS 6.0)
 19472 00002E22 C706[B605]FFFF          	MOV	word [CURR_DIR_END],-1	; No current dir on dest
 19473                                  	;mov	word [CREATING],0E5FFh
 19474 00002E28 C706[7E05]FFE5          	MOV	WORD [CREATING],DIRFREE*256+0FFh  ; Creating, not DEL *.*
 19475                                  					; A rename is like a CREATE_NEW as far
 19476                                  					; as the destination is concerned.
 19477 00002E2E E8F81C                  	call	GetPathNoSet
 19478                                  
 19479                                  ;   If this GETPATH fails due to file not found, we know all renames will work
 19480                                  ;   since no files match the destination name. If it fails for any other
 19481                                  ;   reason, the rename fails on a path not found, or whatever (also fails if
 19482                                  ;   we find a device or directory). If the GETPATH succeeds, we aren't sure
 19483                                  ;   if the rename should fail because we haven't built an explicit name by
 19484                                  ;   substituting for the meta chars in it. In this case the destination file
 19485                                  ;   spec with metas is in [NAME1] and the explicit source name is at RENAMEDMA
 19486                                  ;   in the directory entry part.
 19487                                  	
 19488 00002E31 722A                    	JC	short NODEST
 19489                                  	
 19490                                  	; MSDOS 6.0
 19491                                  	;JZ	short BAD_ACC 		; Dest string is a directory	;AC000;
 19492                                  	; !! MSDOS 3.3 !!
 19493                                  	;JZ	short BAD_ACC ; !!	; Dest string is a directory
 19494                                  
 19495 00002E33 08E4                    	OR	AH,AH			; Device?
 19496 00002E35 7933                    	JNS	short SAVEDEST		; No, continue
 19497                                  BAD_ACC:
 19498 00002E37 B80500                  	MOV	AX,error_access_denied
 19499 00002E3A F9                      	STC
 19500                                  RENAME_CLEAN:
 19501 00002E3B 9C                      	PUSHF				; Save carry state
 19502 00002E3C 50                      	PUSH	AX			; and error code (if carry set)
 19503                                  	;;;
 19504                                  	; 31/01/2024 - Retro DOS v5.0
 19505                                  	; (PCDOS 7.1 IBMDOS.COM)
 19506 00002E3D C42E[8A05]              	les	bp,[THISDPB]
 19507 00002E41 E82906                  	call	update_fat32_fsinfo
 19508                                  	;;;
 19509 00002E44 A0[7605]                	MOV	AL,[THISDRV]
 19510 00002E47 E87B3C                  	call	FLUSHBUF
 19511 00002E4A 58                      	POP	AX
 19512 00002E4B 803E[4A03]00            	CMP	byte [FAILERR],0
 19513 00002E50 7504                    	JNZ	short BAD_ERR		; User FAILed to I 24
 19514 00002E52 9D                      	POPF
 19515 00002E53 E972FF                  	JMP	RENAME_POP
 19516                                  
 19517                                  BAD_ERR:
 19518 00002E56 58                      	POP	AX			; Saved flags
 19519                                  	; 16/12/202
 19520                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 19521                                  BAD_PATH: ; *
 19522 00002E57 B80300                  	MOV	AX,error_path_not_found
 19523 00002E5A E96AFF                  	JMP	GOTERR
 19524                                  
 19525                                  NODEST:
 19526 00002E5D 75F8                    	JNZ	short BAD_PATH
 19527 00002E5F 803E[4A03]00            	CMP	byte [FAILERR],0
 19528 00002E64 75F1                    	JNZ	short BAD_PATH		; Search for dest failed 
 19529                                  					; because user FAILed on I 24
 19530                                  	; 14/11/2022
 19531 00002E66 08C9                    	OR	CL,CL
 19532                                  	;JNZ	short SAVEDEST
 19533                                  	; 17/05/2019
 19534 00002E68 74ED                    	jz	short BAD_PATH ; *
 19535                                  ;BAD_PATH: ; *
 19536                                  ;	MOV	AX,error_path_not_found
 19537                                  ;	;STC
 19538                                  ;	;JMP	RENAME_POP
 19539                                  ;	; 17/05/2019
 19540                                  ;	jmp	GOTERR 
 19541                                  
 19542                                  ; 16/12/2022
 19543                                  %if 0
 19544                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 19545                                  	or	cl,cl
 19546                                  	jnz	short SAVEDEST
 19547                                  	;jz	short BAD_PATH ; *
 19548                                  BAD_PATH: ; *
 19549                                  	;mov	ax,3
 19550                                  	mov	ax,error_path_not_found
 19551                                  	stc
 19552                                  	jmp	RENAME_POP
 19553                                  %endif
 19554                                  
 19555                                  SAVEDEST:
 19556 00002E6A 16                      	push	ss
 19557 00002E6B 07                      	pop	es
 19558                                  
 19559                                  ;hkn; NAME1 & NAME2 is in DOSDATA
 19560 00002E6C BF[5705]                	MOV	DI,NAME2
 19561 00002E6F BE[4B05]                	MOV	SI,NAME1
 19562                                  
 19563 00002E72 B90B00                  	MOV	CX,11
 19564 00002E75 F3A4                    	REP	MOVSB			; Save dest with metas at NAME2
 19565                                  	;;;
 19566                                  	; 31/01/2024
 19567                                  	; (PCDOS 7.1 IBMDOS.COM)
 19568 00002E77 A1[DC0A]                	mov	ax,[DIRSTART_HW]
 19569 00002E7A A3[E60A]                	mov	[DESTSTART_HW],ax
 19570                                  	;;;
 19571 00002E7D A1[C205]                	MOV	AX,[DIRSTART]
 19572 00002E80 A3[6405]                	MOV	[DESTSTART],AX
 19573                                  BUILDDEST:
 19574                                  	; 31/01/2024
 19575                                  	;push	ss
 19576                                  	;pop	es			; needed due to JMP BUILDDEST below
 19577                                  
 19578                                  ;hkn; RENAMEDMA, NAME1, NAME2 in DOSDATA
 19579 00002E83 BB[3506]                	MOV	BX,RENAMEDMA+21		; Source of replace chars
 19580 00002E86 BF[4B05]                	MOV	DI,NAME1		; Real dest name goes here
 19581 00002E89 BE[5705]                	MOV	SI,NAME2		; Raw dest
 19582                                  
 19583 00002E8C B90B00                  	MOV	CX,11
 19584                                  
 19585                                  	; 17/05/2019 - Retro DOS v4.0
 19586                                  
 19587                                  	; MSDOS 6.0
 19588 00002E8F E82601                  	CALL	NEW_RENAME		;IFS. replace ? chars	;AN000;
 19589                                  
 19590                                  	; MSDOS 3.3
 19591                                  
 19592                                  ; 08/08/2018 - Retro DOS v3.0
 19593                                  ; MSDOS 6.0 
 19594                                  ;---------------------------------------------------------------------------
 19595                                  ;Procedure: NEW_RENAME
 19596                                  ;
 19597                                  ;Input: DS:SI -> raw string with ?
 19598                                  ;	ES:DI -> destination string
 19599                                  ;	DS:BX -> source string
 19600                                  ;Function: replace ? chars of raw string with chars in source string and
 19601                                  ;	   put in destination string
 19602                                  ;Output: ES:DI-> new string
 19603                                  ;---------------------------------------------------------------------------
 19604                                  ;
 19605                                  ;NEW_RENAME:
 19606                                  ;NEWNAM:
 19607                                  ;	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 341Ah
 19608                                  ;	LODSB
 19609                                  ;	CMP	AL,"?"
 19610                                  ;	JNZ	short NOCHG
 19611                                  ;	MOV	AL,[BX] 		; Get replace char
 19612                                  ;NOCHG:
 19613                                  ;	STOSB
 19614                                  ;	INC	BX			; Next replace char
 19615                                  ;	LOOP	NEWNAM
 19616                                  ;	; MSDOS 6.0
 19617                                  ;	;retn
 19618                                  
 19619                                  	; MSDOS 3.3 & MSDOS 6.0
 19620                                  	;mov	byte [ATTRIB],16h
 19621 00002E92 C606[6B05]16            	MOV	byte [ATTRIB],attr_all	; Stop duplicates with any attributes
 19622 00002E97 C606[7E05]FF            	MOV	byte [CREATING],0FFH
 19623 00002E9C E8501F                  	call	DEVNAME 		; Check if we built a device name
 19624 00002E9F 7396                    	JNC	short BAD_ACC
 19625                                  	;;;
 19626                                  	; 31/01/2024
 19627                                  	; (PCDOS 7.1 IBMDOS.COM)
 19628 00002EA1 8B1E[E60A]              	mov	bx,[DESTSTART_HW]
 19629 00002EA5 891E[EE0A]              	mov	[ROOTCLUST_HW],bx
 19630                                  	;;;
 19631 00002EA9 8B1E[6405]              	MOV	BX,[DESTSTART]
 19632 00002EAD C42E[8A05]              	LES	BP,[THISDPB]
 19633 00002EB1 E8B71A                  	call	SETDIRSRCH		; Reset search to start of dir
 19634 00002EB4 7281                    	JC	short BAD_ACC 		; Screw up
 19635 00002EB6 E89418                  	call	FINDENTRY		; See if new name already exists
 19636                                  	;JNC	short BAD_ACC 		; Error if found
 19637                                  	; 31/01/2024
 19638 00002EB9 7346                    	jnc	short BAD_ACCJ
 19639 00002EBB 803E[4A03]00            	CMP	byte [FAILERR],0
 19640 00002EC0 753F                    	JNZ	short BAD_ACCJ		; Find failed because user FAILed to I 24
 19641 00002EC2 A1[6405]                	MOV	AX,[DESTSTART]		; DIRSTART of dest
 19642                                  	;;;
 19643                                  	; 31/01/2024
 19644 00002EC5 8B16[E60A]              	mov	dx,[DESTSTART_HW]
 19645 00002EC9 C42E[8A05]              	les	bp,[THISDPB]
 19646 00002ECD 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 19647                                  	;cmp	word [es:bp+0Fh],0
 19648 00002ED2 7506                    	jnz	short builddst_1	; not FAT32
 19649 00002ED4 3B16[3106]              	cmp	dx,[RENAMEDMA+17]	; DIRSTART_HW of source
 19650 00002ED8 7506                    	jne	short builddst_2
 19651                                  builddst_1:
 19652                                  	;;;
 19653 00002EDA 3B06[2F06]              	CMP	AX,[RENAMEDMA+15]	; DIRSTART of source
 19654 00002EDE 7451                    	JZ	short SIMPLE_RENAME	; If =, just give new name
 19655                                  builddst_2:	; 31/01/2024
 19656                                  	;mov	al,[RENAMEDMA+32]
 19657 00002EE0 A0[4006]                	MOV	AL,[RENAMEDMA+21+dir_entry.dir_attr]
 19658 00002EE3 A810                    	TEST	AL,attr_directory ; 10h
 19659 00002EE5 751A                    	JNZ	short BAD_ACCJ		; Can only do a simple rename on dirs,
 19660                                  					; otherwise the . and .. entries get
 19661                                  					; wiped.
 19662 00002EE7 A2[6B05]                	MOV	[ATTRIB],AL
 19663 00002EEA 8C1E[A005]              	MOV	[THISSFT+2],DS
 19664                                  
 19665                                  ;hkn; AUXSTACK is in DOSDATA
 19666                                  	;mov	si,RENAMEDMA+145h
 19667 00002EEE BE[6507]                	MOV	SI,AUXSTACK-SF_ENTRY.size ; RENAMEDMA+325
 19668 00002EF1 8936[9E05]              	MOV	[THISSFT],SI
 19669                                  	;mov	word [SI+2],2
 19670 00002EF5 C744020200              	MOV	word [SI+SF_ENTRY.sf_mode],SHARING_COMPAT+open_for_both
 19671 00002EFA 31C9                    	XOR	CX,CX			; Set "device ID" for call into makenode
 19672 00002EFC E8A325                  	call	RENAME_MAKE		; This is in mknode
 19673 00002EFF 7303                    	JNC	short GOT_DEST
 19674                                  BAD_ACCJ:
 19675 00002F01 E933FF                  	JMP	BAD_ACC
 19676                                  
 19677                                  GOT_DEST:
 19678 00002F04 53                      	push	bx
 19679 00002F05 C43E[9E05]              	LES	DI,[THISSFT]		; RENAME_MAKE entered this into sharing
 19680 00002F09 E8AC55                  	call	ShareEnd		; we need to remove it.
 19681 00002F0C 5B                      	pop	bx
 19682                                  
 19683                                  ; A zero length entry with the correct new name has now been made at
 19684                                  ;   [CURBUF+2]:BX.
 19685                                  
 19686 00002F0D C43E[E205]              	LES	DI,[CURBUF]
 19687                                  
 19688                                  ; 31/01/2024 - Retro DOS v5.0
 19689                                  %if 0
 19690                                  	; MSDOS 6.0
 19691                                  	;test	byte [es:di+5],40h
 19692                                  	TEST	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty  
 19693                                  					;LB. if already dirty		  ;AN000;
 19694                                  	JNZ	short yesdirty1		;LB.  don't increment dirty count ;AN000;
 19695                                  	call	INC_DIRTY_COUNT 	;LB.				  ;AN000;
 19696                                  	;or	byte [es:di+5],40h
 19697                                  	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 19698                                  yesdirty1:
 19699                                  %else
 19700                                  	; 31/01/2024 (PCDOS 7.1 IBMDOS.COM)
 19701 00002F11 E8D73C                  	call	SET_BUF_DIRTY
 19702                                  %endif
 19703 00002F14 89DF                    	MOV	DI,BX
 19704                                  	;add	di,11
 19705 00002F16 83C70B                  	ADD	DI,dir_entry.dir_attr	; Skip name
 19706                                  
 19707                                  ;hkn; RENAMEDMA is in DOSDATA
 19708                                  	;mov	si,[RENAMEDMA+32]
 19709 00002F19 BE[4006]                	MOV	SI,RENAMEDMA+21+dir_entry.dir_attr
 19710                                  	;mov	cx,21
 19711 00002F1C B91500                  	MOV	CX,dir_entry.size-dir_entry.dir_attr
 19712 00002F1F F3A4                    	REP	MOVSB
 19713 00002F21 E86E00                  	CALL	GET_SOURCE
 19714 00002F24 7269                    	JC	short RENAME_OVER
 19715 00002F26 89DF                    	MOV	DI,BX
 19716 00002F28 8E06[E405]              	MOV	ES,[CURBUF+2]
 19717 00002F2C B0E5                    	MOV	AL,DIRFREE ; 0E5h
 19718 00002F2E AA                      	STOSB				; "free" the source
 19719 00002F2F EB13                    	JMP	SHORT DIRTY_IT
 19720                                  
 19721                                  SIMPLE_RENAME:
 19722 00002F31 E85E00                  	CALL	GET_SOURCE		; Get the source back
 19723 00002F34 7259                    	JC	short RENAME_OVER
 19724 00002F36 89DF                    	MOV	DI,BX
 19725 00002F38 8E06[E405]              	MOV	ES,[CURBUF+2]
 19726                                  
 19727                                  ;hkn; NAME1 is in DOSDATA
 19728 00002F3C BE[4B05]                	MOV	SI,NAME1		; New Name
 19729 00002F3F B90B00                  	MOV	CX,11
 19730 00002F42 F3A4                    	REP	MOVSB
 19731                                  DIRTY_IT:
 19732 00002F44 8B3E[E205]              	MOV	DI,[CURBUF]
 19733                                  
 19734                                  ; 31/01/2024 - Retro DOS v5.0
 19735                                  %if 0
 19736                                  	; MSDOS 6.0
 19737                                  	TEST	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty  
 19738                                  					;LB. if already dirty		  ;AN000;
 19739                                  	JNZ	short yesdirty2		;LB.  don't increment dirty count ;AN000;
 19740                                  	call	INC_DIRTY_COUNT 	;LB.				  ;AN000;
 19741                                  	
 19742                                  	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 19743                                  %else
 19744                                  	; 31/01/2024 (PCDOS 7.1 IBMDOS.COM)
 19745 00002F48 E8A03C                  	call	SET_BUF_DIRTY
 19746                                  %endif
 19747                                  	
 19748                                  ;------------------------------------------------------------------------------
 19749                                  ; Check if the source is a directory of file. If directory rename it to the
 19750                                  ; the new name in the Fastopen cache buffer. If file name it has been
 19751                                  ; previously deleted.
 19752                                  ;------------------------------------------------------------------------------
 19753                                  
 19754                                  ;yesdirty2:	; 31/01/2024
 19755                                  	; MSDOS 6.0
 19756 00002F4B 56                      	PUSH	SI
 19757 00002F4C C536[2C03]              	LDS	SI,[DMAADD]		;;BN00XPTM. chek if source a dir ;AN000;
 19758                                  	;add	si,21
 19759 00002F50 83C615                  	ADD	SI,find_buf.attr	;;BN00XPTM.P5520		;AN000;
 19760                                  	;test	byte [si+0Bh],10h
 19761 00002F53 F6440B10                	TEST	byte [SI+dir_entry.dir_attr],attr_directory ;;BN00XPTM.	;AN000;
 19762 00002F57 7403                    	JZ	short NOT_DIR2		;;BN00XPTM.			;AN000;
 19763 00002F59 E8F2FD                  	call	FastOpen_Rename		;;BN00X rename dir entry in fastopen
 19764                                  	; 31/01/2024
 19765                                  	;POP	SI
 19766                                  	;JMP	SHORT NOT_DIRTY1
 19767                                  NOT_DIR2:				;;BN00X it is a file, delete the entry
 19768 00002F5C 5E                      	POP	SI
 19769                                  NOT_DIRTY1:				;;BN00X
 19770                                  NEXT_SOURCE:
 19771                                  ;hkn; RENAMEDMA is in DOSDATA
 19772 00002F5D BE[2106]                	MOV	SI,RENAMEDMA+1		;Name
 19773                                  
 19774                                  ; WARNING! Rename_Next leaves the disk critical section *ALWAYS*. We need
 19775                                  ; to enter it before going to RENAME_Next.
 19776                                  
 19777 00002F60 E880E9                  	call	ECritDisk
 19778 00002F63 C606[7E05]00            	MOV	byte [CREATING],0 ; Correct setting for search (we changed it
 19779                                  				  ;  to FF when we made the prev new file).
 19780 00002F68 E80007                  	call	RENAME_NEXT
 19781                                  
 19782                                  ; Note, now, that we have exited the previous ENTER and so are back to where
 19783                                  ; we were before.
 19784                                  
 19785 00002F6B 7222                    	JC	short RENAME_OVER
 19786                                  
 19787                                  	;lea	si,[bx+26]
 19788 00002F6D 8D771A                  	LEA	SI,[BX+dir_entry.dir_first]
 19789 00002F70 E84FFD                  	call	REN_DEL_Check
 19790 00002F73 7306                    	JNC	short REN_OK2
 19791 00002F75 B82000                  	MOV	AX,error_sharing_violation ; 20h
 19792                                  jmp_to_rename_clean: ; 28/12/2022
 19793 00002F78 E9C0FE                  	JMP	RENAME_CLEAN ; 10/08/2018
 19794                                  
 19795                                  ;------------------------------------------------------------------------------
 19796                                  ; Check if file or directory. If file, delete file from the Fastopen cache,
 19797                                  ; if directory, rename directory name in the Fastopen cache.
 19798                                  ;-----------------------------------------------------------------------------
 19799                                  
 19800                                  REN_OK2:
 19801                                  	; MSDOS 6.0
 19802                                  	;mov	al,[RERNAMEDMA+32]
 19803 00002F7B A0[4006]                	MOV	AL,[RENAMEDMA+21+dir_entry.dir_attr] ; PTR P5622
 19804                                  	;test	al,10h
 19805 00002F7E A810                    	TEST	AL,attr_directory	;;BN00X directory
 19806 00002F80 7408                    	JZ	short Ren_Directory	;;BN00X no - file, delete it
 19807                                  	
 19808                                  	; MSDOS 3.3 & MSDOS 6.0
 19809 00002F82 E8BBFD                  	call	FastOpen_Delete 	;;BN00X delete dir info in fastopen DOS 3.3
 19810                                  jmp_to_builddest: ; 28/12/2022
 19811                                  	; 31/01/2024
 19812 00002F85 16                      	push	ss
 19813 00002F86 07                      	pop	es
 19814 00002F87 E9F9FE                  	JMP	BUILDDEST		;;BN00X
 19815                                  
 19816                                  	; MSDOS 6.0
 19817                                  Ren_Directory:
 19818 00002F8A E8C1FD                  	call	FastOpen_Rename 	;;BN00X delete dir info in fastopen DOS 3.3
 19819                                  	;JMP	BUILDDEST
 19820                                  	; 28/12/2022
 19821 00002F8D EBF6                    	jmp	short jmp_to_builddest
 19822                                  
 19823                                  RENAME_OVER:
 19824 00002F8F F8                      	CLC
 19825                                  	;JMP	RENAME_CLEAN ; 10/08/2018
 19826                                  	; 28/12/2022
 19827 00002F90 EBE6                    	jmp	short jmp_to_rename_clean
 19828                                  
 19829                                  ;----------------------------------------------------------------------------
 19830                                  ; Procedure: GET_SOURCE
 19831                                  ;
 19832                                  ; Inputs:
 19833                                  ;	RENAMEDMA has source info
 19834                                  ; Function:
 19835                                  ;	Re-find the source
 19836                                  ; Output:
 19837                                  ;	[CURBUF] set
 19838                                  ;	[CURBUF+2]:BX points to entry
 19839                                  ;	Carry set if error (currently user FAILed to I 24)
 19840                                  ; DS preserved, others destroyed
 19841                                  ;----------------------------------------------------------------------------
 19842                                  
 19843                                  GET_SOURCE:
 19844                                  	;;;
 19845                                  	; 01/02/2024 - Retro DOS v5.0
 19846                                  	; (PCDOS 7.1 IBMDOS.COM)
 19847 00002F92 C42E[8A05]              	les	bp,[THISDPB]
 19848 00002F96 31DB                    	xor	bx,bx ; 0
 19849                                  	;cmp	[es:bp+0Fh],bx
 19850 00002F98 26395E0F                	cmp	[es:bp+DPB.FAT_SIZE],bx ; > 0 ?
 19851 00002F9C 7504                    	jnz	short gs_cont		; yes, it is not FAT32
 19852 00002F9E 8B1E[3106]              	mov	bx,[RENAMEDMA+17]	; DirStart+2
 19853                                  gs_cont:
 19854 00002FA2 891E[EE0A]              	mov	[ROOTCLUST_HW],bx	; hw of cluster number
 19855                                  	;;;
 19856 00002FA6 8B1E[2F06]              	MOV	BX,[RENAMEDMA+15]	; DirStart
 19857                                  	; 01/02/2024
 19858                                  	;LES	BP,[THISDPB]
 19859 00002FAA E8BE19                  	call	SETDIRSRCH
 19860 00002FAD 7214                    	JC	short gs_ret_label	; retc
 19861 00002FAF E81C1E                  	call	STARTSRCH
 19862 00002FB2 A1[2D06]                	MOV	AX,[RENAMEDMA+13]	; Lastent
 19863                                  	;call	GETENT
 19864                                  	; 18/12/2022
 19865 00002FB5 E9F618                  	jmp	GETENT
 19866                                  ;gs_ret_label:
 19867                                  	;retn
 19868                                  
 19869                                  ; MSDOS 6.0 
 19870                                  ;---------------------------------------------------------------------------
 19871                                  ;Procedure: NEW_RENAME
 19872                                  ;
 19873                                  ;Input: DS:SI -> raw string with ?
 19874                                  ;	ES:DI -> destination string
 19875                                  ;	DS:BX -> source string
 19876                                  ;Function: replace ? chars of raw string with chars in source string and
 19877                                  ;	   put in destination string
 19878                                  ;Output: ES:DI-> new string
 19879                                  ;---------------------------------------------------------------------------
 19880                                  
 19881                                  NEW_RENAME:
 19882                                  	; 17/05/2019 - Retro DOS v4.0
 19883                                  NEWNAM:
 19884                                  	; DOSCODE:680Eh (MSDOS 6.21, MSDOS.SYS)
 19885 00002FB8 AC                      	LODSB
 19886 00002FB9 3C3F                    	CMP	AL,"?" ; 3Fh
 19887 00002FBB 7502                    	JNZ	short NOCHG
 19888 00002FBD 8A07                    	MOV	AL,[BX] 		; Get replace char
 19889                                  NOCHG:
 19890 00002FBF AA                      	STOSB
 19891 00002FC0 43                      	INC	BX			; Next replace char
 19892 00002FC1 E2F5                    	LOOP	NEWNAM
 19893                                  	; MSDOS 6.0
 19894                                  gs_ret_label:	; 18/12/2022
 19895 00002FC3 C3                      	retn
 19896                                  
 19897                                  ;============================================================================
 19898                                  ; FINFO.ASM, MSDOS 6.0, 1991
 19899                                  ;============================================================================
 19900                                  ; 08/08/2018 - Retro DOS v3.0
 19901                                  ; 17/05/2019 - Retro DOS v4.0
 19902                                  
 19903                                  ;**	Low level routines for returning file information and setting file
 19904                                  ;	attributes
 19905                                  ;
 19906                                  ;	GET_FILE_INFO
 19907                                  ;	SET_FILE_ATTRIBUTE
 19908                                  ;
 19909                                  ;	Modification history:
 19910                                  ;
 19911                                  ;	    Created: ARR 30 March 1983
 19912                                  ;
 19913                                  ;	M025: Return access_denied if attempting to set
 19914                                  ;	      attribute of root directory.
 19915                                  ;
 19916                                  
 19917                                  ;SUBTTL GET_FILE_INFO -- Get File Information
 19918                                  
 19919                                  ;---------------------------------------------------------------------------
 19920                                  ; Procedure Name : GET_FILE_INFO
 19921                                  ;
 19922                                  ; Inputs:
 19923                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 19924                                  ;		terminated)
 19925                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 19926                                  ;		( = -1 if current dir not involved, else
 19927                                  ;		 Points to first char after last "/" of current dir part)
 19928                                  ;	[THISCDS] Points to CDS being used
 19929                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 19930                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 19931                                  ; Function:
 19932                                  ;	Get Information about a file
 19933                                  ; Returns:
 19934                                  ;	CARRY CLEAR
 19935                                  ;	    AX = Attribute of file
 19936                                  ;	    CX = Time stamp of file
 19937                                  ;	    DX = Date stamp of file
 19938                                  ;	    BX:DI = Size of file (32 bit)
 19939                                  ;	CARRY SET
 19940                                  ;	    AX is error code
 19941                                  ;		error_file_not_found
 19942                                  ;			Last element of path not found
 19943                                  ;		error_path_not_found
 19944                                  ;			Bad path (not in curr dir part if present)
 19945                                  ;		error_bad_curr_dir
 19946                                  ;			Bad path in current directory part of path
 19947                                  ; DS preserved, others destroyed
 19948                                  ;---------------------------------------------------------------------------
 19949                                  
 19950                                  	; 14/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 19951                                  
 19952                                  GET_FILE_INFO:
 19953                                  
 19954                                  ;hkn; get_file_info is called from file.asm and fcbio.asm. DS has been set 
 19955                                  ;hkn; to DOSDATA at this point. So DOSassume is OK.
 19956                                  
 19957 00002FC4 E85AE8                  	call	TestNet
 19958 00002FC7 7306                    	JNC	short LOCAL_INFO
 19959                                  
 19960                                  ;IF NOT Installed
 19961                                  ;	transfer NET_GET_FILE_INFO
 19962                                  ;ELSE
 19963                                  ;	MOV	AX,(MultNET SHL 8) OR 15
 19964                                  ;	INT	2FH
 19965                                  ;	return
 19966                                  
 19967 00002FC9 B80F11                  	mov     ax, 110Fh
 19968 00002FCC CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - GET REMOTE FILE'S ATTRIBUTES
 19969                                  			; SS = DOS CS, SDA first filename pointer -> fully-qualified name of file
 19970                                  			; SDA CDS pointer -> current directory
 19971                                  			; Return: CF set on error, AX = file attributes
 19972 00002FCE C3                      	retn
 19973                                  ;ENDIF
 19974                                  
 19975                                  LOCAL_INFO:
 19976 00002FCF E811E9                  	call	ECritDisk
 19977 00002FD2 C606[4C03]01            	MOV	byte [NoSetDir],1	; if we find a dir, don't change to it
 19978                                  	; MSDOS 3.3
 19979                                  	;call	GETPATH
 19980                                  	; MSDOS 6.0
 19981 00002FD7 E8C900                  	call	GET_FAST_PATH
 19982                                  	; MSDOS 3.3 & MSDOS 6.0
 19983 00002FDA 7312                    	JNC	short info_check_dev
 19984                                  NO_PATH:
 19985 00002FDC 750B                    	JNZ	short bad_path1
 19986 00002FDE 08C9                    	OR	CL,CL
 19987 00002FE0 7407                    	JZ	short bad_path1
 19988                                  info_no_file:
 19989 00002FE2 B80200                  	MOV	AX,error_file_not_found
 19990                                  BadRet:
 19991 00002FE5 F9                      	STC
 19992                                  JustRet:
 19993                                  	;call	LCritDisk
 19994                                  	;retn
 19995                                  	; 18/12/2022
 19996 00002FE6 E927E9                  	jmp	LCritDisk
 19997                                  
 19998                                  bad_path1:
 19999 00002FE9 B80300                  	MOV	AX,error_path_not_found
 20000 00002FEC EBF7                    	jmp	short BadRet
 20001                                  
 20002                                  info_check_dev:
 20003 00002FEE 08E4                    	OR	AH,AH
 20004 00002FF0 78F0                    	JS	short info_no_file	; device
 20005                                  
 20006                                  	; MSDOS 6.0
 20007                                  ;SR;
 20008                                  ; If root dir then CurBuf == -1. Check for this case and return subdir attr
 20009                                  ;for a root dir
 20010                                  
 20011 00002FF2 833E[E205]FF            	cmp	word [CURBUF],-1	;is it a root dir?
 20012 00002FF7 7506                    	jne	short not_root		;no, CurBuf ptr is valid
 20013                                  
 20014 00002FF9 30E4                    	xor	ah,ah
 20015 00002FFB B010                    	mov	al,attr_directory ; 10h
 20016                                  	;clc
 20017                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 20018                                  	; (DOSCODE:683Eh)
 20019                                  	; 16/12/2022
 20020                                  	;clc
 20021 00002FFD EBE7                    	jmp	short JustRet
 20022                                  
 20023                                  not_root:
 20024                                  	; MSDOS 3.3 (& MSDOS 6.0)
 20025 00002FFF 1E                      	PUSH	DS
 20026 00003000 8E1E[E405]              	MOV	DS,[CURBUF+2]
 20027 00003004 89DE                    	MOV	SI,BX
 20028 00003006 31DB                    	XOR	BX,BX			; Assume size=0 (dir)
 20029 00003008 89DF                    	MOV	DI,BX
 20030                                  	;mov	cx,[si+16h]
 20031 0000300A 8B4C16                  	MOV	CX,[SI+dir_entry.dir_time]
 20032                                  	;mov	dx,[si+18h]
 20033 0000300D 8B5418                  	MOV	DX,[SI+dir_entry.dir_date]
 20034 00003010 30E4                    	XOR	AH,AH
 20035                                  	;mov	al,[si+0Bh]
 20036 00003012 8A440B                  	MOV	AL,[SI+dir_entry.dir_attr]
 20037                                  	;test	al,10h
 20038 00003015 A810                    	TEST	AL,attr_directory
 20039 00003017 7506                    	JNZ	short NO_SIZE
 20040                                  	;mov	di,[si+1Ch]
 20041 00003019 8B7C1C                  	MOV	DI,[SI+dir_entry.dir_size_l]
 20042                                  	;mov	bx,[si+1Eh]
 20043 0000301C 8B5C1E                  	MOV	BX,[SI+dir_entry.dir_size_h]
 20044                                  NO_SIZE:
 20045 0000301F 1F                      	POP	DS
 20046                                  	;CLC
 20047                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 20048                                  	; (DOSCODE:6864h)
 20049                                  	; 16/12/2022
 20050                                  	;clc
 20051 00003020 EBC4                    	jmp	short JustRet
 20052                                  
 20053                                  ;Break	<SET_FILE_ATTRIBUTE -- Set File Attribute>
 20054                                  ;-------------------------------------------------------------------------------
 20055                                  ; Procedure Name : SET_FILE_ATTRIBUTE
 20056                                  ; Inputs:
 20057                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 20058                                  ;		terminated)
 20059                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 20060                                  ;		( = -1 if current dir not involved, else
 20061                                  ;		 Points to first char after last "/" of current dir part)
 20062                                  ;	[THISCDS] Points to CDS being used
 20063                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 20064                                  ;	[SATTRIB] is attribute of search (determines what files may be found)
 20065                                  ;	AX is new attributes to give to file
 20066                                  ; Function:
 20067                                  ;	Set File Attributes
 20068                                  ; Returns:
 20069                                  ;	CARRY CLEAR
 20070                                  ;	    No error
 20071                                  ;	CARRY SET
 20072                                  ;	    AX is error code
 20073                                  ;		error_file_not_found
 20074                                  ;			Last element of path not found
 20075                                  ;		error_path_not_found
 20076                                  ;			Bad path (not in curr dir part if present)
 20077                                  ;		error_bad_curr_dir
 20078                                  ;			Bad path in current directory part of path
 20079                                  ;		error_access_denied
 20080                                  ;			Attempt to set an attribute which cannot be set
 20081                                  ;			(attr_directory, attr_volume_ID)
 20082                                  ;		error_sharing_violation
 20083                                  ;			Sharing mode of file did not allow the change
 20084                                  ;			(this request requires exclusive write/read access)
 20085                                  ;			(INT 24H generated)
 20086                                  ; DS preserved, others destroyed
 20087                                  ;----------------------------------------------------------------------------
 20088                                  
 20089                                  	; 01/02/2024 - Retro DOS v5.0
 20090                                  
 20091                                  SET_FILE_ATTRIBUTE:
 20092                                  
 20093                                  ;hkn; set_file_attr is called from file.asm. DS has been set 
 20094                                  ;hkn; to DOSDATA at this point. So DOSassume is OK.
 20095                                  
 20096 00003022 A9D8FF                  	TEST	AX,~attr_changeable ; 0FFD8h
 20097 00003025 7412                    	JZ	short set_look
 20098                                  _BAD_ACC:
 20099                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Unk ; 1
 20100                                  	;;;
 20101                                  	; 01/02/2024 - Retro DOS v5.0
 20102                                  	; (PCDOS 7.1 IBMDOS.COM)
 20103 00003027 E8ABE2                  	call	set_exerr_locus_unk
 20104                                  	;;;
 20105 0000302A C606[2703]07            	MOV	byte [EXTERR_CLASS],errCLASS_Apperr ; 7
 20106 0000302F C606[2603]04            	MOV	byte [EXTERR_ACTION],errACT_Abort ; 4
 20107 00003034 B80500                  	MOV	AX,error_access_denied ; 5
 20108 00003037 F9                      	STC
 20109 00003038 C3                      	retn
 20110                                  	
 20111                                  set_look:
 20112 00003039 E8E5E7                  	call	TestNet
 20113 0000303C 7308                    	JNC	short LOCAL_SET
 20114                                  
 20115                                  ;IF NOT Installed
 20116                                  ;	transfer NET_SEQ_SET_FILE_ATTRIBUTE
 20117                                  ;ELSE
 20118 0000303E 50                      	PUSH	AX
 20119                                  	
 20120                                  	;MOV	AX,(MultNET SHL 8) OR 14
 20121                                  	;INT	2FH
 20122                                  
 20123 0000303F B80E11                  	mov     ax, 110Eh
 20124 00003042 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - SET REMOTE FILE'S ATTRIBUTES
 20125                                  			; SS = DOS CS, SDA first filename pointer -> fully-qualified name of file
 20126                                  			; SDA CDS pointer -> current directory
 20127                                  			; STACK: WORD new file attributes
 20128                                  			; Return: CF set on error
 20129                                  
 20130 00003044 5B                      	POP	BX			; clean stack
 20131 00003045 C3                      	retn
 20132                                  ;ENDIF
 20133                                  
 20134                                  LOCAL_SET:
 20135 00003046 E89AE8                  	call	ECritDisk
 20136 00003049 50                      	PUSH	AX			; Save new attributes
 20137 0000304A C606[4C03]01            	MOV	byte [NoSetDir],1	; if we find a dir, don't change to it
 20138 0000304F E8D11A                  	call	GETPATH 		; get path through fastopen if there	;AC000;
 20139 00003052 7308                    	JNC	short set_check_device
 20140 00003054 5B                      	POP	BX			; Clean stack (don't zap AX)
 20141 00003055 EB85                    	JMP	short NO_PATH
 20142                                  
 20143                                  	; MSDOS 6.0
 20144                                  cannot_set_root:			; M025:
 20145 00003057 B80500                  	mov	ax,error_access_denied	; M025: return error is attempting
 20146                                  	;stc				; M025: to set attr. of root
 20147                                  	;jmp	short OK_BYE		; M025:
 20148                                  	; 01/02/2024
 20149 0000305A EB89                    	jmp	short BadRet
 20150                                  
 20151                                  set_check_device:
 20152 0000305C 08E4                    	OR	AH,AH
 20153 0000305E 7906                    	JNS	short set_check_share
 20154 00003060 58                      	POP	AX
 20155 00003061 E8ACE8                  	call	LCritDisk
 20156 00003064 EBC1                    	JMP	short _BAD_ACC 		; device
 20157                                  
 20158                                  set_check_share:
 20159 00003066 58                      	POP	AX			; Get new attributes
 20160                                  
 20161                                  	; MSDOS 6.0
 20162 00003067 833E[E205]FF            	cmp	word [CURBUF], -1	; M025: Q: is this the root dir
 20163 0000306C 74E9                    	je	short cannot_set_root	; M025: Y: return error
 20164                                  
 20165                                  	; MSDOS 3.3 & MSDOS 6.0
 20166 0000306E E851FC                  	call	REN_DEL_Check
 20167 00003071 7305                    	JNC	short set_do
 20168 00003073 B82000                  	MOV	AX,error_sharing_violation ; 32
 20169 00003076 EB28                    	jmp	short OK_BYE
 20170                                  
 20171                                  set_do:
 20172                                  	; MSDOS 3.3 & MSDOS 6.0
 20173 00003078 C43E[E205]              	LES	DI,[CURBUF]
 20174 0000307C 2680670BD8              	AND	BYTE [ES:BX+dir_entry.dir_attr],~attr_changeable ; 0D8h
 20175 00003081 2608470B                	OR	BYTE [ES:BX+dir_entry.dir_attr],AL
 20176                                  
 20177                                  ; 01/02/2024 - Retro DOS v5.0
 20178                                  %if 0
 20179                                  	; MSDOS 6.0
 20180                                  	TEST	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty  
 20181                                  					;LB. if already dirty		  ;AN000;
 20182                                  	JNZ	short yesdirty3		;LB.  don't increment dirty count ;AN000;
 20183                                  	call	INC_DIRTY_COUNT 	;LB.				  ;AN000;
 20184                                  	
 20185                                  	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 20186                                  yesdirty3:
 20187                                  %else
 20188                                  	; 01/02/2024
 20189                                  	; (PCDOS 7.1 IBMDOS.COM)
 20190 00003085 E8633B                  	call	SET_BUF_DIRTY
 20191                                  %endif
 20192 00003088 A0[7605]                	MOV	AL,[THISDRV]
 20193                                  ;;;; 10/1/86 F.C update fastopen cache
 20194 0000308B 52                      	PUSH	DX
 20195 0000308C 57                      	PUSH	DI
 20196 0000308D B400                    	MOV	AH,0		  ; dir entry update
 20197 0000308F 88C2                    	MOV	DL,AL		  ; drive number A=0,B=1,,
 20198 00003091 89DF                    	MOV	DI,BX		  ; ES:DI -> dir entry
 20199 00003093 E8D2FC                  	call	FastOpen_Update
 20200 00003096 5F                      	POP	DI
 20201 00003097 5A                      	POP	DX
 20202                                  ;;;; 9/11/86 F.C update fastopen cache
 20203 00003098 E82A3A                  	call	FLUSHBUF
 20204 0000309B 7303                    	JNC	short OK_BYE
 20205 0000309D B80200                  	MOV	AX,error_file_not_found
 20206                                  OK_BYE:
 20207                                  	;call	LCritDisk
 20208                                  	;retn
 20209                                  	; 16/12/2022
 20210 000030A0 E96DE8                  	jmp	LCritDisk
 20211                                  
 20212                                  ;----------------------------------------------------------------------------
 20213                                  
 20214                                  	; 17/05/2019 - Retro DOS v4.0
 20215                                  
 20216                                  	; MSDOS 6.0
 20217                                  GET_FAST_PATH:
 20218                                  ;hkn; use SS override for FastOpenFlg
 20219 000030A3 36800E[4611]01          	OR	byte [ss:FastOpenFlg],FastOpen_Set
 20220                                  					;FO. trigger fastopen	;AN000;
 20221 000030A9 E8771A                  	call	GETPATH
 20222 000030AC 9C                      	PUSHF			 	;FO.			;AN000;
 20223 000030AD 368026[4611]80          	AND	byte [ss:FastOpenFlg],Fast_yes 
 20224                                  					;FO. clear all fastopen flags ;AN000;
 20225 000030B3 9D                      	POPF				;FO.			;AN000;
 20226 000030B4 C3                      	retn
 20227                                  
 20228                                  ;============================================================================
 20229                                  ; DUP.ASM, MSDOS 6.0, 1991
 20230                                  ;============================================================================
 20231                                  ; 08/08/2018 - Retro DOS v3.0
 20232                                  ; 17/05/2019 - Retro DOS v4.0
 20233                                  
 20234                                  ;** 	Low level DUP routine for use by EXEC when creating a new process.
 20235                                  ;   	Exports the DUP to the server machine and increments the SFT ref count
 20236                                  ;
 20237                                  ;	DOS_DUP
 20238                                  ;
 20239                                  ;	Modification history:
 20240                                  ;
 20241                                  ;	  Created: ARR 30 March 1983
 20242                                  
 20243                                  ;BREAK <DOS_DUP -- DUP SFT across network>
 20244                                  ;---------------------------------------------------------------------------
 20245                                  ; Procedure Name : DOS_DUP
 20246                                  ;
 20247                                  ; Inputs:
 20248                                  ;	[THISSFT] set to the SFT for the file being DUPed
 20249                                  ;		(a non net SFT is OK, in this case the ref
 20250                                  ;		 count is simply incremented)
 20251                                  ; Function:
 20252                                  ;	Signal to the devices that a logical open is occurring
 20253                                  ; Returns:
 20254                                  ;	ES:DI point to SFT
 20255                                  ;    Carry clear
 20256                                  ;	SFT ref_count is incremented
 20257                                  ; Registers modified: None.
 20258                                  ; NOTE:
 20259                                  ;	This routine is called from $CREATE_PROCESS_DATA_BLOCK at DOSINIT
 20260                                  ;	time with SS NOT DOSGROUP. There will be no Network handles at
 20261                                  ;	that time.
 20262                                  ;---------------------------------------------------------------------------
 20263                                  
 20264                                  DOS_DUP:
 20265                                  	;LES	DI,[CS:THISSFT]  ; MSDOS 3.3
 20266                                  
 20267                                  	; MSDOS 6.0
 20268 000030B5 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 20269 000030BA 26C43E[9E05]            	les	di,[es:THISSFT]
 20270                                  
 20271                                  	;Entry	Dos_Dup_Direct
 20272                                  DOS_Dup_Direct:
 20273 000030BF E878E7                  	call	IsSFTNet
 20274 000030C2 7503                    	JNZ	short DO_INC
 20275 000030C4 E86F21                  	call	DEV_OPEN_SFT
 20276                                  DO_INC:
 20277                                  	;INC	word [ES:DI+SF_ENTRY.sf_ref_count]
 20278 000030C7 26FF05                  	inc	word [ES:DI]		; Clears carry (if this ever wraps
 20279                                  					;   we're in big trouble anyway)
 20280 000030CA C3                      	retn
 20281                                  
 20282                                  ;============================================================================
 20283                                  ; CREATE.ASM, MSDOS 6.0, 1991
 20284                                  ;============================================================================
 20285                                  ; 08/08/2018 - Retro DOS v3.0
 20286                                  ; 18/05/2019 - Retro DOS v4.0
 20287                                  
 20288                                  ;TITLE	DOS_CREATE/DOS_CREATE_NEW - Internal CREATE calls for MS-DOS
 20289                                  ;NAME	DOS_CREATE
 20290                                  ;----------------------------------------------------------------------------
 20291                                  ;**	Internal Create and Create new to create a local or NET file and SFT.
 20292                                  ;
 20293                                  ;	DOS_CREATE
 20294                                  ;	DOS_CREATE_NEW
 20295                                  ;	SET_MKND_ERR
 20296                                  ;	SET_Media_ID
 20297                                  ;	SET_EXT_Mode
 20298                                  ;
 20299                                  ;	Revision history:
 20300                                  ;
 20301                                  ;	    A000 version 4.00	  Jan. 1988
 20302                                  ;	    A001  D490 -- Change IOCTL subfunctios from 63h,43h to 66h, 46h
 20303                                  
 20304                                  ;Installed = TRUE
 20305                                  
 20306                                  ;	i_need	THISSFT,DWORD
 20307                                  ;	i_need	THISCDS,DWORD
 20308                                  ;	I_need	EXTERR,WORD
 20309                                  ;	I_Need	ExtErr_locus,BYTE
 20310                                  ;	I_need	JShare,DWORD
 20311                                  ;	I_need	VOLCHNG_FLAG,BYTE
 20312                                  ;	I_need	SATTRIB,BYTE
 20313                                  ;	I_need	CALLVIDM,DWORD
 20314                                  ;	I_need	EXTOPEN_ON,BYTE 		  ;AN000; extended open
 20315                                  ;	I_need	NAME1,BYTE			  ;AN000;
 20316                                  ;	I_need	NO_NAME_ID,BYTE 		  ;AN000;
 20317                                  ;	I_need	Packet_Temp,WORD		  ;AN000;
 20318                                  ;	I_need	DOS34_FLAG,WORD 		  ;AN000;
 20319                                  ;	I_need	SAVE_BX,WORD			  ;AN000;
 20320                                  
 20321                                  ;***	DOS_CREATE - Create a File
 20322                                  ;----------------------------------------------------------------------------
 20323                                  ;	DOS_Create is called to create the specified file, truncating
 20324                                  ;	the old one if it exists.
 20325                                  ;
 20326                                  ;	ENTRY	AX is Attribute to create
 20327                                  ;		(ds) = DOSDATA
 20328                                  ;		[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 20329                                  ;			terminated)
 20330                                  ;		[CURR_DIR_END] Points to end of Current dir part of string
 20331                                  ;			( = -1 if current dir not involved, else
 20332                                  ;			 Points to first char after last "/" of current dir part)
 20333                                  ;		[THISCDS] Points to CDS being used
 20334                                  ;			(Low word = -1 if NUL CDS (Net direct request))
 20335                                  ;		[THISSFT] Points to SFT to fill in if file created
 20336                                  ;			(sf_mode field set so that FCB may be detected)
 20337                                  ;		[SATTRIB] Is attribute of search, determines what files can be found
 20338                                  ;
 20339                                  ;	EXIT	sf_ref_count is NOT altered
 20340                                  ;		CARRY CLEAR
 20341                                  ;		    THISSFT filled in.
 20342                                  ;			sf_mode = unchanged for FCB, sharing_compat + open_for_both
 20343                                  ;		CARRY SET
 20344                                  ;		    AX is error code
 20345                                  ;			error_path_not_found
 20346                                  ;				Bad path (not in curr dir part if present)
 20347                                  ;			error_bad_curr_dir
 20348                                  ;				Bad path in current directory part of path
 20349                                  ;			error_access_denied
 20350                                  ;				Attempt to re-create read only file , or
 20351                                  ;				create a second volume id or create a dir
 20352                                  ;			error_sharing_violation
 20353                                  ;				The sharing mode was correct but not allowed
 20354                                  ;				generates an INT 24
 20355                                  ;	USES	all but DS
 20356                                  ;----------------------------------------------------------------------------
 20357                                  
 20358                                  	; 14/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 20359                                  	; DOSCODE:6920h (MSDOS 5.0, MSDOS.SYS)
 20360                                  
 20361                                  	; 01/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 20362                                  	; DOSCODE:708Ah (PCDOS 7.1, IBMDOS.COM)
 20363                                  
 20364                                  DOS_CREATE:
 20365                                  	; 18/05/2019 - Retro DOS v4.0
 20366                                  	; DOSCODE:6934h (MSDOS 6.21, MSDOS.SYS)
 20367                                  
 20368                                  ;hkn; dispatched to from file.asm and fcbio.asm. DS set up to DOSDATA at 
 20369                                  ;hkn; this point.
 20370                                  
 20371 000030CB 30E4                    	XOR	AH,AH		; Truncate is OK
 20372                                  
 20373                                  ;	Enter here from Dos_Create_New
 20374                                  ;
 20375                                  ;	(ah) = 0 iff truncate OK
 20376                                  
 20377                                  Create_inter:
 20378 000030CD A8C0                    	TEST	AL,~(attr_all+attr_ignore+attr_volume_id) ; 80h
 20379                                  				; Mask out any meaningless bits
 20380 000030CF 7511                    	JNZ	short AttErr
 20381 000030D1 A808                    	TEST	AL,attr_volume_id
 20382 000030D3 7407                    	JZ	short NoReset
 20383                                  	
 20384                                  	; MSDOS 6.0
 20385                                  	; 16/12/2022
 20386 000030D5 800E[1106]80            	OR	byte [DOS34_FLAG],DBCS_VOLID ; 80h ;AN000;FOR dbcs volid
 20387                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 20388                                  	;or	word [DOS34_FLAG],DBCS_VOLID ; 80h 
 20389                                  	
 20390 000030DA B008                    	MOV	AL,attr_volume_id ; 8
 20391                                  NoReset:
 20392 000030DC 0C20                    	OR	AL,attr_archive ; File changed  ; 20h
 20393 000030DE A850                    	TEST	AL,attr_directory+attr_device ; 50h
 20394 000030E0 7408                    	JZ	short ATT_OK
 20395                                  AttErr:
 20396 000030E2 B80500                  	MOV	AX,5		; Attribute problem
 20397                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Unk ; 1
 20398                                  	; 01/02/2024
 20399 000030E5 E8EDE1                  	call	set_exerr_locus_unk
 20400 000030E8 EB62                    	JMP	SHORT SET_MKND_ERR ; Gotta use MKDIR to make dirs, NEVER allow
 20401                                  				   ;	attr_device to be set.
 20402                                  ATT_OK:
 20403 000030EA C43E[9E05]              	LES	DI,[THISSFT]
 20404 000030EE 06                      	PUSH	ES
 20405 000030EF C436[A205]              	LES	SI,[THISCDS]
 20406 000030F3 83FEFF                  	CMP	SI,-1
 20407 000030F6 751B                    	JNE	short TEST_RE_NET
 20408                                  
 20409                                  ;	No CDS, it must be redirected.
 20410                                  
 20411 000030F8 07                      	POP	ES
 20412                                  
 20413                                  	; MSDOS 6.0
 20414                                  ;Extended open hooks
 20415                                  	;test	byte [EXTOPEN_ON],1
 20416 000030F9 F606[F605]01            	TEST	byte [EXTOPEN_ON],EXT_OPEN_ON ;AN000;EO. from extended open
 20417 000030FE 740D                    	JZ	short NOEXTOP 		    ;AN000;EO. no, do normal
 20418                                  IFS_extopen:				    ;AN000;EO.
 20419 00003100 50                      	PUSH	AX			    ;AN000;EO. pass create attr
 20420                                  	;MOV	AX,(MultNET SHL 8) OR 46    ;AN000;EO. issue extended open verb
 20421 00003101 B82E11                  	mov	ax,112Eh
 20422                                  NOEXTOP2:	; 01/02/2024 (PCDOS 7.1 IBMDOS.COM)
 20423 00003104 CD2F                    	INT	2FH			    ;AN000;EO.
 20424 00003106 5B                      	POP	BX			    ;AN000;EO. trash bx
 20425 00003107 C606[F605]00            	MOV	byte [EXTOPEN_ON],0	    ;AN000;EO.
 20426 0000310C C3                      	retn				    ;AN000;EO.
 20427                                  NOEXTOP:				    ;AN000;
 20428                                  ;Extended open hooks
 20429                                  
 20430                                  ;IF NOT Installed
 20431                                  ;	transfer NET_SEQ_CREATE
 20432                                  ;ELSE
 20433 0000310D 50                      	PUSH	AX
 20434                                  
 20435                                  	;MOV	AX,(MultNET SHL 8) OR 24
 20436                                  	;INT	2FH
 20437                                  
 20438 0000310E B81811                  	mov     ax,1118h
 20439                                  	; 01/02/2024
 20440                                  	;int     2Fh	; Multiplex - NETWORK REDIRECTOR - CREATE/TRUNCATE FILE
 20441                                  			; ES:DI -> uninitialized SFT, SS = DOS CS
 20442                                  			; SDA first filename pointer -> fully-qualified name of file
 20443                                  			; STACK: WORD file creation mode???
 20444                                  
 20445                                  	;POP	BX			; BX is trashed anyway
 20446                                  	;retn
 20447 00003111 EBF1                    	jmp	short NOEXTOP2 ; 01/02/2024
 20448                                  ;ENDIF
 20449                                  
 20450                                  ;	We have a CDS. See if it's network
 20451                                  
 20452                                  TEST_RE_NET:
 20453                                  	;;test	word [es:si+43h],8000h
 20454                                  	;TEST	word [ES:SI+curdir.flags],curdir_isnet
 20455                                  	; 07/12/2022
 20456                                  	;test	byte [es:si+44h],80h
 20457                                  	; 17/12/2022
 20458 00003113 26F6444480              	test	byte [ES:SI+curdir.flags+1],curdir_isnet>>8
 20459 00003118 07                      	POP	ES
 20460 00003119 7417                    	JZ	short LOCAL_CREATE
 20461                                  
 20462                                  	; MSDOS 6.0
 20463 0000311B E8CA00                  	CALL	Set_EXT_mode		    ;AN000;EO.
 20464 0000311E 7205                    	JC	SHORT dochk		    ;AN000;EO.
 20465                                  	;;or	word [es:di+2],2
 20466                                  	;OR	word [ES:DI+SF_ENTRY.sf_mode],SHARING_COMPAT+open_for_both ;IFS.
 20467                                  	; 17/12/2022
 20468 00003120 26804D0202              	or	byte [ES:DI+SF_ENTRY.sf_mode],SHARING_COMPAT+open_for_both ;IFS.
 20469                                  
 20470                                  ;Extended open hooks
 20471                                  dochk:
 20472 00003125 F606[F605]01            	TEST	byte [EXTOPEN_ON],EXT_OPEN_ON ;AN000;EO. from extended open
 20473 0000312A 75D4                    	JNZ	short IFS_extopen	    ;AN000;EO. yes, issue extended open
 20474                                  ;Extended open hooks
 20475                                  
 20476                                  ;IF NOT Installed
 20477                                  ;	transfer NET_CREATE
 20478                                  ;ELSE
 20479 0000312C 50                      	PUSH	AX
 20480                                  	
 20481                                  	;MOV	AX,(MultNET SHL 8) OR 23
 20482                                  	;INT	2FH
 20483                                  	
 20484 0000312D B81711                  	mov     ax,1117h
 20485                                  	
 20486                                  	; 01/02/2024
 20487                                  	;int     2Fh	; Multiplex - NETWORK REDIRECTOR - CREATE/TRUNCATE REMOTE FILE
 20488                                  			; ES:DI -> uninitialized SFT, SS = DOS CS
 20489                                  			; SDA first filename pointer -> fully-qualified name of file to open
 20490                                  			; SDA CDS pointer -> current directory
 20491                                  			; Return: CF set on error
 20492                                  
 20493                                  	;POP	BX			; BX is trashed anyway
 20494                                  ;nomore:
 20495                                  	;retn
 20496 00003130 EBD2                    	jmp	short NOEXTOP2 ; 01/02/2024
 20497                                  ;ENDIF
 20498                                  
 20499                                  ;**	It's a local create. We have a local CDS for it.
 20500                                  
 20501                                  LOCAL_CREATE:
 20502                                  	; MSDOS 6.0
 20503 00003132 E8B300                  	CALL	Set_EXT_mode	;AN000;EO. set mode if from extended open
 20504 00003135 7205                    	JC	short setdone	;AN000;EO.
 20505                                  	
 20506                                  	; MSDOS 3.3 & MSDOS 6.0
 20507                                  	; 17/12/2022
 20508                                  	;;or	word [es:di+2],2
 20509                                  	;OR	word [ES:DI+SF_ENTRY.sf_mode],SHARING_COMPAT+open_for_both
 20510                                  	;or	byte [es:di+2],2
 20511 00003137 26804D0202              	or	byte [ES:DI+SF_ENTRY.sf_mode],SHARING_COMPAT+open_for_both
 20512                                  setdone:
 20513 0000313C E8A4E7                  	call	ECritDisk
 20514 0000313F E83C23                  	call	MakeNode
 20515 00003142 7317                    	JNC	short Create_ok
 20516 00003144 C606[A10A]FF            	mov	byte [VOLCHNG_FLAG],-1	; indicate no change in volume label
 20517 00003149 E8C4E7                  	call	LCritDisk
 20518                                  
 20519                                  	;entry	SET_MKND_ERR
 20520                                  SET_MKND_ERR:
 20521                                  
 20522                                  ;	Looks up MakeNode errors and converts them. AL is MakeNode
 20523                                  ;	error, SI is GETPATH bad spot return if path_not_found error.
 20524                                  
 20525                                  ;hkn; CRTERRTAB is in TABLE seg (DOSCODE)
 20526 0000314C BB[5331]                	MOV     BX,CRTERRTAB
 20527                                  	;XLAT  ; MSDOS 3.3
 20528                                  	; 18/05/2019 - Retro DOS v4.0
 20529 0000314F 2E                      	CS
 20530 00003150 D7                      	XLAT
 20531                                  CreatBadRet:
 20532 00003151 F9                      	STC
 20533 00003152 C3                      	retn
 20534                                  
 20535                                  ; 13/05/2019 - Retro DOS v4.0
 20536                                  ; DOSCODE:69C4h (MSDOS 6.21, MSDOS.SYS)
 20537                                  ; ---------------------------------------------------------------------------
 20538                                  
 20539                                  ;** Internal Create and Create new to create a local or NET file and SFT.
 20540                                  
 20541                                  ; 17/07/2018 - Retro DOS v3.0
 20542                                  ; Offset 12B1h of IBMDOS.COM (MSDOS 3.3), 1987
 20543                                  
 20544                                  ;CRTERRTAB: ; 19/07/2018 - MSDOS 3.3	
 20545                                  ;	db	0,5,52h,50h,3,5,20h
 20546                                  
 20547                                  ;CRTERRTAB: ; 18/05/2019 - MSDOS 6.0	
 20548                                  ;	db	0,5,52h,50h,3,5,20h,2
 20549                                  
 20550                                  ; 08/08/2018
 20551                                  
 20552                                  CRTERRTAB:	;LABEL BYTE	; Lookup table for MakeNode returns
 20553 00003153 00                      	DB	0			; none
 20554 00003154 05                      	DB	error_access_denied	; MakeNode error 1
 20555 00003155 52                      	DB	error_cannot_make	; MakeNode error 2
 20556 00003156 50                      	DB	error_file_exists	; MakeNode error 3
 20557 00003157 03                      	DB	error_path_not_found	; MakeNode error 4
 20558 00003158 05                      	DB	error_access_denied	; MakeNode error 5
 20559 00003159 20                      	DB	error_sharing_violation ; MakeNode error 6
 20560                                  	; MSDOS 6.0
 20561 0000315A 02                      	DB	error_file_not_found	; MakeNode error 7
 20562                                  
 20563                                  ; ---------------------------------------------------------------------------
 20564                                  
 20565                                  ; We have just created a new file. This results in the truncation of old
 20566                                  ; files. We must inform the sharer to slash all the open SFT's for this
 20567                                  ; file to the current size.
 20568                                  
 20569                                  ; If we created a volume id on the diskette, set the VOLCHNG_FLAG to logical
 20570                                  ; drive number to force a Build BPB after Media Check.
 20571                                  
 20572                                  ;;; FASTOPEN 8/29/86
 20573                                  Create_ok:
 20574 0000315B E8E2FB                  	call	FastOpen_Delete
 20575                                  ;;; FASTOPEN 8/29/86
 20576 0000315E A0[6D05]                	mov	al,[SATTRIB]
 20577 00003161 A808                    	test	al,attr_volume_id
 20578 00003163 741C                    	jz	short NoVolLabel
 20579 00003165 C43E[A205]              	LES	DI,[THISCDS]
 20580                                  	;mov	ah,[ES:DI+curdir.text]	; get drive letter
 20581 00003169 268A25                  	mov	ah,[ES:DI] ; 09/08/2018
 20582 0000316C 80EC41                  	sub	ah,'A'	; 41h		; convert to drive number
 20583 0000316F 8826[A10A]              	mov	[VOLCHNG_FLAG],ah	;Set flag to indicate volid change
 20584                                  	
 20585                                  	; 18/05/2019 - Retro DOS v4.0
 20586                                  
 20587                                  	; MSDOS 6.0
 20588 00003173 B701                    	MOV	BH,1			;AN000;>32mb set volume id to boot record
 20589 00003175 E81F00                  	CALL	Set_Media_ID		;AN000;>32mb
 20590                                  	
 20591 00003178 E868E7                  	call	ECritDisk
 20592 0000317B E80D34                  	call	FATREAD_CDS		; force a media check
 20593 0000317E E88FE7                  	call	LCritDisk
 20594                                  
 20595                                  NoVolLabel:
 20596 00003181 B80200                  	MOV	ax,2
 20597 00003184 C43E[9E05]              	LES	DI,[THISSFT]
 20598                                  ;if installed
 20599                                  	;call	JShare + 14 * 4
 20600 00003188 FF1E[C800]              	call	far [JShare+(14*4)] ; 14 = ShSU
 20601                                  ;else
 20602                                  ;	Call	ShSU
 20603                                  ;endif
 20604 0000318C E881E7                  	call	LCritDisk
 20605 0000318F E95601                  	jmp	SET_SFT_MODE
 20606                                  
 20607                                  ;---------------------------------------------------------------------------
 20608                                  ; Procedure Name : Dos_Create_New
 20609                                  ;
 20610                                  ; Inputs:
 20611                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 20612                                  ;		terminated)
 20613                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 20614                                  ;		( = -1 if current dir not involved, else
 20615                                  ;		 Points to first char after last "/" of current dir part)
 20616                                  ;	[THISCDS] Points to CDS being used
 20617                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 20618                                  ;	[THISSFT] Points to SFT to fill in if file created
 20619                                  ;		(sf_mode field set so that FCB may be detected)
 20620                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 20621                                  ;	AX is Attribute to create
 20622                                  ; Function:
 20623                                  ;	Try to create the specified file truncating an old one that exists
 20624                                  ; Outputs:
 20625                                  ;	sf_ref_count is NOT altered
 20626                                  ;	CARRY CLEAR
 20627                                  ;	    THISSFT filled in.
 20628                                  ;		sf_mode = sharing_compat + open_for_both for Non-FCB SFT
 20629                                  ;	CARRY SET
 20630                                  ;	    AX is error code
 20631                                  ;		error_path_not_found
 20632                                  ;			Bad path (not in curr dir part if present)
 20633                                  ;		error_bad_curr_dir
 20634                                  ;			Bad path in current directory part of path
 20635                                  ;		error_access_denied
 20636                                  ;			Create a second volume id or create a dir
 20637                                  ;		error_file_exists
 20638                                  ;			Already a file by this name
 20639                                  ; DS preserved, others destroyed
 20640                                  ;---------------------------------------------------------------------------
 20641                                  
 20642                                  DOS_Create_New:
 20643 00003192 B401                    	MOV	AH,1		; Truncate is NOT OK
 20644 00003194 E936FF                  	JMP	Create_inter
 20645                                  
 20646                                  ; MSDOS 6.0
 20647                                  ;---------------------------------------------------------------------------
 20648                                  ; Procedure Name : Set_Media_ID
 20649                                  ;
 20650                                  ; Inputs:
 20651                                  ;	NAME1= Volume ID
 20652                                  ;	BH= 0, delete volume id
 20653                                  ;	    1, set new volume id
 20654                                  ;	DS= DOSGROUP
 20655                                  ; Function:
 20656                                  ;	Set Volume ID to DOS 4.00 Boot record.
 20657                                  ; Outputs:
 20658                                  ;	CARRY CLEAR
 20659                                  ;	    volume id set
 20660                                  ;	CARRY SET
 20661                                  ;	    AX is error code
 20662                                  ;---------------------------------------------------------------------------
 20663                                  
 20664                                  	; 18/05/2019 - Retro DOS v4.0
 20665                                  	; 01/02/2024 - Retro DOS v5.0
 20666                                  Set_Media_ID:
 20667 00003197 50                      	PUSH	AX		;AN000;;>32mb
 20668 00003198 06                      	PUSH	ES		;AN000;;>32mb
 20669 00003199 57                      	PUSH	DI		;AN000;;>32mb
 20670                                  
 20671 0000319A FEC4                    	INC	AH		;AN000;;>32mb  bl=drive #
 20672 0000319C 88E3                    	MOV	BL,AH		;AN000;;>32mb  bl=drive # (A=1,B=2,,,)
 20673 0000319E B00D                    	MOV	AL,0DH		;AN000;;>32mb  generic IOCTL
 20674                                  	;MOV	CX,0866H	;AN001;;>32mb  get media id
 20675                                  	; 01/02/2024
 20676                                  	; (PCDOS 7.1 IBMDOS.COM)
 20677 000031A0 B96648                  	mov	cx,4866h	; ch = FAT32 disk drive (CATEGORY CODE)
 20678                                  				; cl = minor code,
 20679                                  				;      get volume serial number (and name)
 20680                                  
 20681                                  ;hkn; PACKET_TEMP is in DOSDATA
 20682 000031A3 BA[A00D]                	MOV	DX,Packet_Temp	;AN000;>32mb
 20683                                  
 20684                                  Set_Media_ID_1:
 20685                                  	; 01/02/2024
 20686 000031A6 51                      	push	cx
 20687                                  
 20688 000031A7 53                      	PUSH	BX		;AN000;;>32mb
 20689 000031A8 52                      	PUSH	DX		;AN000;;>32mb
 20690 000031A9 30FF                    	XOR	BH,BH		;AN000;;>32mb
 20691                                  
 20692                                  	;invoke	$IOCTL		;AN000;;>32mb
 20693 000031AB E8DCF6                  	call	_$IOCTL	
 20694                                  
 20695 000031AE 5A                      	POP	DX		;AN000;;>32mb
 20696 000031AF 5B                      	POP	BX		;AN000;;>32mb
 20697                                  
 20698                                  	; 01/02/2024
 20699 000031B0 59                      	pop	cx
 20700                                  	;JC	short geterr	;AN000;;>32mb
 20701 000031B1 730A                    	jnc	short Set_Media_ID_2
 20702 000031B3 80FD48                  	cmp	ch,48h		; is it FAT32 disk drive request?
 20703 000031B6 F9                      	stc
 20704 000031B7 7529                    	jne	short geterr	; (ch=8 request failed!)
 20705 000031B9 B508                    	mov	ch,8		; set category code for (old) FAT disk drive
 20706                                  				; (except FAT32)
 20707 000031BB EBE9                    	jmp     short Set_Media_ID_1 ; and try again
 20708                                  
 20709                                  Set_Media_ID_2:
 20710 000031BD 08FF                    	OR	BH,BH		;AN000;;>32mb delete volume id
 20711 000031BF 7405                    	JZ	short NoName	;AN000;>32mb yes
 20712                                  
 20713                                  ;hkn; NAME1 is in DOSDATA
 20714 000031C1 BE[4B05]                	MOV	SI,NAME1	;AN000;>32mb
 20715                                  
 20716 000031C4 EB03                    	JMP	SHORT doset	;AN000;>32mb yes
 20717                                  NoName: 			;AN000;
 20718                                  
 20719                                  ;hkn; NO_NAME_ID is in DOSDATA
 20720 000031C6 BE[C10D]                	MOV	SI,NO_NAME_ID	;AN000;>32mb
 20721                                  
 20722                                  doset:				;AN000;
 20723 000031C9 89D7                    	MOV	DI,DX		;AN000;;>32mb
 20724                                  	;add	di,6
 20725 000031CB 83C706                  	ADD	DI,MEDIA_ID_INFO.MEDIA_Label ;AN000;;>32mb
 20726                                  
 20727                                  ;hkn; ES & DS must point to SS
 20728                                  ;hkn;	PUSH	CS		;AN000;;>32mb  move new volume id to packet
 20729 000031CE 16                      	PUSH	SS		;AN000;;>32mb  move new volume id to packet
 20730                                  
 20731 000031CF 1F                      	POP	DS		;AN000;;>32mb
 20732                                  
 20733                                  ;hkn;	PUSH	CS		;AN000;;>32mb
 20734 000031D0 16                      	PUSH	SS		;AN000;;>32mb
 20735                                  
 20736 000031D1 07                      	POP	ES		;AN000;;>32mb
 20737                                  
 20738                                  	; 01/02/2024
 20739 000031D2 51                      	push	cx
 20740                                  
 20741 000031D3 B90B00                  	MOV	CX,11		;AN000;;>32mb
 20742 000031D6 F3A4                    	REP	MOVSB		;AN000;;>32mb
 20743                                  
 20744                                  	;MOV	CX,0846H	;AN001;;>32mb
 20745                                  	; 01/02/2024
 20746 000031D8 59                      	pop	cx
 20747 000031D9 B146                    	mov	cl,46h		; set volume serial number (and name)
 20748                                  	;
 20749 000031DB B00D                    	MOV	AL,0DH		;AN000;;>32mb
 20750 000031DD 30FF                    	XOR	BH,BH		;AN000;;>32mb
 20751                                  	;invoke	$IOCTL		;AN000;;>32mb  set volume id
 20752 000031DF E8A8F6                  	call	_$IOCTL	
 20753                                  geterr: 			;AN000;
 20754                                  ;hkn;	PUSH	CS		;AN000;>32mb
 20755 000031E2 16                      	PUSH	SS		;AN000;>32mb
 20756                                  
 20757 000031E3 1F                      	POP	DS		;AN000;>32mb   ds= dosgroup
 20758                                  
 20759 000031E4 5F                      	POP	DI		;AN000;;>32mb
 20760 000031E5 07                      	POP	ES		;AN000;;>32mb
 20761 000031E6 58                      	POP	AX		;AN000;;>32mb
 20762 000031E7 C3                      	retn			;AN000;>32mb
 20763                                  
 20764                                  ; MSDOS 6.0
 20765                                  ;---------------------------------------------------------------------------
 20766                                  ; Procedure Name : Set_EXT_mode
 20767                                  ;
 20768                                  ; Inputs:
 20769                                  ;	[EXTOPEN_ON]= flag for extended open
 20770                                  ;	SAVE_BX= mode specified in Extended Open
 20771                                  ; Function:
 20772                                  ;	Set mode in ThisSFT
 20773                                  ; Outputs:
 20774                                  ;	carry set,mode is set if from Extended Open
 20775                                  ;	carry clear, mode not set yet
 20776                                  ;---------------------------------------------------------------------------
 20777                                  
 20778                                  ; 13/05/2019 - Retro DOS v4.0
 20779                                  
 20780                                  Set_EXT_mode:
 20781                                  
 20782                                  ;hkn; SS override
 20783 000031E8 36F606[F605]01          	TEST	byte [ss:EXTOPEN_ON],EXT_OPEN_ON ;AN000;EO. from extended open
 20784 000031EE 740B                    	JZ	short NOTEX		    ;AN000;EO. no, do normal
 20785 000031F0 50                      	PUSH	AX			    ;AN000;EO.
 20786                                  
 20787                                  ;hkn; SS override
 20788 000031F1 36A1[0106]              	MOV	AX,[ss:SAVE_BX]		    ;AN000;EO.
 20789                                  	;or	[es:di+2],ax
 20790 000031F5 26094502                	OR	[ES:DI+SF_ENTRY.sf_mode],AX ;AN000;EO.
 20791 000031F9 58                      	POP	AX			    ;AN000;EO.
 20792 000031FA F9                      	STC				    ;AN000;EO.
 20793                                  NOTEX:					    ;AN000;
 20794 000031FB C3                      	retn				    ;AN000;EO.
 20795                                  
 20796                                  ;============================================================================
 20797                                  ; OPEN.ASM, MSDOS 6.0, 1991
 20798                                  ;============================================================================
 20799                                  ; 08/08/2018 - Retro DOS v3.0
 20800                                  ; 18/05/2019 - Retro DOS v4.0
 20801                                  
 20802                                  ;	TITLE	DOS_OPEN - Internal OPEN call for MS-DOS
 20803                                  ;	NAME	DOS_OPEN
 20804                                  
 20805                                  ;**	OPEN.ASM - File Open
 20806                                  ;----------------------------------------------------------------------------
 20807                                  ;	Low level routines for openning a file from a file spec.
 20808                                  ;	Also misc routines for sharing errors
 20809                                  ;
 20810                                  ;	DOS_Open
 20811                                  ;	Check_Access_AX
 20812                                  ;	SHARE_ERROR
 20813                                  ;	SET_SFT_MODE
 20814                                  ;	Code_Page_Mismatched_Error		   ; DOS 4.00
 20815                                  ;
 20816                                  ;	Revision history:
 20817                                  ;
 20818                                  ;	    Created: ARR 30 March 1983
 20819                                  ;	    A000	version 4.00   Jan. 1988
 20820                                  ;
 20821                                  ;	M034 - The value in save_bx must be pushed on to the stack for
 20822                                  ; 	       remote extended opens and not save_cx.
 20823                                  ;
 20824                                  ;	M035 - if open made from exec then we must set the appropriate bits
 20825                                  ;	       on the stack before calling off to the redir.
 20826                                  ;	M042 - Bit 11 of DOS34_FLAG set indicates that the redir knows how 
 20827                                  ;	       to handle open from exec. In this case set the appropriate bit
 20828                                  ;	       else do not.
 20829                                  ;----------------------------------------------------------------------------	
 20830                                  
 20831                                  ;Installed = TRUE
 20832                                  
 20833                                  ;	i_need	NoSetDir,BYTE
 20834                                  ;	i_need	THISSFT,DWORD
 20835                                  ;	i_need	THISCDS,DWORD
 20836                                  ;	i_need	CURBUF,DWORD
 20837                                  ;	i_need	CurrentPDB,WORD
 20838                                  ;	i_need	CURR_DIR_END,WORD
 20839                                  ;	I_need	RetryCount,WORD
 20840                                  ;	I_need	Open_Access,BYTE
 20841                                  ;	I_need	fSharing,BYTE
 20842                                  ;	i_need	JShare,DWORD
 20843                                  ;	I_need	FastOpenFlg,byte
 20844                                  ;	I_need	EXTOPEN_ON,BYTE 		  ;AN000;; DOS 4.00
 20845                                  ;	I_need	ALLOWED,BYTE			  ;AN000;; DOS 4.00
 20846                                  ;	I_need	EXTERR,WORD			  ;AN000;; DOS 4.00
 20847                                  ;	I_need	EXTERR_LOCUS,BYTE		  ;AN000;; DOS 4.00
 20848                                  ;	I_need	EXTERR_ACTION,BYTE		  ;AN000;; DOS 4.00
 20849                                  ;	I_need	EXTERR_CLASS,BYTE		  ;AN000;; DOS 4.00
 20850                                  ;	I_need	CPSWFLAG,BYTE			  ;AN000;; DOS 4.00
 20851                                  ;	I_need	EXITHOLD,DWORD			  ;AN000;; DOS 4.00
 20852                                  ;	I_need	THISDPB,DWORD			  ;AN000;; DOS 4.00
 20853                                  ;	I_need	SAVE_CX,WORD			  ;AN000;; DOS 4.00
 20854                                  ;	I_need	SAVE_BX,WORD			  ;M034
 20855                                  ;
 20856                                  ;	I_need	DOS_FLAG,BYTE
 20857                                  ;	I_need	DOS34_FLAG,WORD			  ;M042
 20858                                  
 20859                                  ;Break	<DOS_Open - internal file access>
 20860                                  ;---------------------------------------------------------------------------
 20861                                  ; Procedure Name : DOS_Open
 20862                                  ;
 20863                                  ; Inputs:
 20864                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 20865                                  ;		terminated)
 20866                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 20867                                  ;		( = -1 if current dir not involved, else
 20868                                  ;		 Points to first char after last "/" of current dir part)
 20869                                  ;	[THISCDS] Points to CDS being used
 20870                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 20871                                  ;	[THISSFT] Points to SFT to fill in if file found
 20872                                  ;		(sf_mode field set so that FCB may be detected)
 20873                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 20874                                  ;	AX is Access and Sharing mode
 20875                                  ;	  High NIBBLE of AL (Sharing Mode)
 20876                                  ;		sharing_compat	   file is opened in compatibility mode
 20877                                  ;		sharing_deny_none  file is opened Multi reader, Multi writer
 20878                                  ;		sharing_deny_read  file is opened Only reader, Multi writer
 20879                                  ;		sharing_deny_write file is opened Multi reader, Only writer
 20880                                  ;		sharing_deny_both  file is opened Only reader, Only writer
 20881                                  ;	  Low NIBBLE of AL (Access Mode)
 20882                                  ;		open_for_read	file is opened for reading
 20883                                  ;		open_for_write	file is opened for writing
 20884                                  ;		open_for_both	file is opened for both reading and writing.
 20885                                  ;
 20886                                  ;	  For FCB SFTs AL should = sharing_compat + open_for_both
 20887                                  ;		(not checked)
 20888                                  ; Function:
 20889                                  ;	Try to open the specified file
 20890                                  ; Outputs:
 20891                                  ;	sf_ref_count is NOT altered
 20892                                  ;	CARRY CLEAR
 20893                                  ;	    THISSFT filled in.
 20894                                  ;	CARRY SET
 20895                                  ;	    AX is error code
 20896                                  ;		error_file_not_found
 20897                                  ;			Last element of path not found
 20898                                  ;		error_path_not_found
 20899                                  ;			Bad path (not in curr dir part if present)
 20900                                  ;		error_bad_curr_dir
 20901                                  ;			Bad path in current directory part of path
 20902                                  ;		error_invalid_access
 20903                                  ;			Bad sharing mode or bad access mode or bad combination
 20904                                  ;		error_access_denied
 20905                                  ;			Attempt to open read only file for writting, or
 20906                                  ;			open a directory
 20907                                  ;		error_sharing_violation
 20908                                  ;			The sharing mode was correct but not allowed
 20909                                  ;			generates an INT 24 on compatibility mode SFTs
 20910                                  ; DS preserved, others destroyed
 20911                                  ;----------------------------------------------------------------------------
 20912                                  
 20913                                  ; 18/05/2019 - Retro DOS v4.0
 20914                                  ; DOSCODE:6A60h (MSDOS 6.21, MSDOS.SYS)
 20915                                  ; 14/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 20916                                  ; DOSCODE:6A4Ch (MSDOS 5.0, MSDOS.SYS)
 20917                                  
 20918                                  ; 01/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 20919                                  ; DOSCODE:71BBh (PCDOS 7.1, IBMDOS.COM)
 20920                                  
 20921                                  DOS_OPEN:
 20922                                  	; DS has been set up to DOSDATA in file.asm and fcbio2.asm. 
 20923                                  
 20924 000031FC C606[4C03]00            	MOV	byte [NoSetDir],0
 20925 00003201 E83301                  	CALL	Check_Access_AX
 20926 00003204 722B                    	JC	short do_ret_label	    ; retc
 20927                                  
 20928 00003206 C43E[9E05]              	LES	DI,[THISSFT]
 20929 0000320A 30E4                    	XOR	AH,AH
 20930                                  
 20931                                  	; sleaze! move only access/sharing mode in. Leave sf_isFCB unchanged
 20932                                  
 20933 0000320C 26884502                	MOV	[ES:DI+SF_ENTRY.sf_mode],AL ; For moment do this on FCBs too
 20934 00003210 06                      	PUSH	ES
 20935 00003211 C436[A205]              	LES	SI,[THISCDS]
 20936                                  	; 18/08/2018
 20937 00003215 83FEFF                  	CMP	SI,-1 ; 0FFFFh
 20938 00003218 7530                    	JNZ	short TEST_RE_NET1
 20939 0000321A 07                      	POP	ES
 20940                                  
 20941                                  	; MSDOS 6.0
 20942                                  ;Extended open hooks
 20943 0000321B F606[F605]01            	TEST	byte [EXTOPEN_ON],EXT_OPEN_ON ;FT. from extended open		;AN000;
 20944 00003220 7410                    	JZ	short _NOEXTOP 		    ;FT. no, do normal			;AN000;
 20945                                  _IFS_extopen:									;AN000;
 20946 00003222 A0[0106]                	MOV	AL,[SAVE_BX]		    ; M034 - save_bx has original bx  
 20947                                  					    ; with which call was made. This
 20948                                  					    ; has the open access bits. 
 20949                                  	;;MOV	AL,[SAVE_CX]		    ; M034 - FT. al= create attribute
 20950                                  	
 20951 00003225 50                      	PUSH	AX			    ;FT. pass create attr to IFS	;AN000;
 20952                                  	;mov	ax,112Eh
 20953                                  	;MOV	AX,(MultNET SHL 8) OR 46    ;FT. issue extended open verb	;AN000;
 20954 00003226 B82E11                  	mov	ax,(MultNET*256)+46 
 20955 00003229 CD2F                    	INT	2FH			    ;FT.				;AN000;
 20956 0000322B 5B                      	POP	BX			    ;FT. trash bx			;AN000;
 20957 0000322C C606[F605]00            	MOV	byte [EXTOPEN_ON],0	    ;FT.				;AN000;
 20958                                  
 20959                                  do_ret_label:
 20960 00003231 C3                      	retn				    ;FT.				;AN000;
 20961                                  _NOEXTOP:
 20962                                  ;Extended open hooks
 20963                                  	;
 20964                                  ;IF NOT Installed
 20965                                  	;transfer NET_SEQ_OPEN
 20966                                  ;ELSE
 20967                                  	
 20968                                  do_net_int2f:
 20969 00003232 F606[8600]01            	test	byte [DOS_FLAG],EXECOPEN ; Q: was this open call made from exec
 20970 00003237 7409                    	jz	short not_exec_open	; N: just do net open
 20971                                  					; Y: check to see if redir is aware
 20972                                  					;    of this 
 20973                                  	
 20974                                  					; M042 - start
 20975                                  	;test	word [DOS34_FLAG],EXEC_AWARE_REDIR ; 800h
 20976 00003239 F606[1206]08            	test	byte [DOS34_FLAG+1],(EXEC_AWARE_REDIR>>8)
 20977                                  					; Q: does this redir know how to 
 20978                                  					;    this
 20979 0000323E 7402                    	jz	short not_exec_open	; N: just do net open
 20980                                  					; Y: set bit 3 of access byte and 
 20981                                  					;    set sharing mode to DENY_WRITE
 20982                                  					; M042 - end
 20983                                  	
 20984                                  	; NOTE: This specific mode has not been set for the code assembled
 20985                                  	; under the "NOT Installed" conditional. Currently Installed is 
 20986                                  	; always one.
 20987                                  					; M035 - set the bits on the stack
 20988                                  	;mov	al,23h
 20989 00003240 B023                    	mov	AL,SHARING_DENY_WRITE+EXEC_OPEN
 20990                                  	
 20991                                  not_exec_open:
 20992                                  	; MSDOS 3.3 & MSDOS 6.0
 20993 00003242 50                      	PUSH	AX
 20994                                  
 20995                                  	;MOV	AX,(MultNET SHL 8) OR 22
 20996                                  	;INT	2FH
 20997                                  
 20998 00003243 B81611                  	mov     ax,1116h
 20999 00003246 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - OPEN EXISTING REMOTE FILE
 21000                                  			; ES:DI -> uninitialized SFT, SS = DOS CS
 21001                                  			; SDA first filename pointer -> fully-qualified name of file to open
 21002                                  			; STACK: WORD file open mode
 21003                                  			; Return: CF set on error
 21004                                  
 21005 00003248 5B                      	POP	BX			; clean stack
 21006                                  ;do_ret_label: ; 09/08/2018
 21007 00003249 C3                      	retn
 21008                                  ;ENDIF
 21009                                  
 21010                                  TEST_RE_NET1:
 21011                                  	;TEST	word [ES:SI+curdir.flags],curdir_isnet
 21012                                  	; 17/12/2022
 21013 0000324A 26F6444480              	test	byte [ES:SI+curdir.flags+1],curdir_isnet>>8
 21014 0000324F 07                      	POP	ES
 21015                                  	; 18/05/2019
 21016 00003250 7409                    	JZ	short LOCAL_OPEN
 21017                                  
 21018                                  ;Extended open hooks
 21019                                  	; MSDOS 6.0
 21020 00003252 F606[F605]01            	TEST	byte [EXTOPEN_ON],EXT_OPEN_ON ;FT. from extended open	;AN000;
 21021 00003257 75C9                    	JNZ	short _IFS_extopen	      ;FT. issue extended open	;AN000;
 21022                                  ;Extended open hooks
 21023                                  
 21024                                  ;IF NOT Installed
 21025                                  ;	transfer NET_OPEN
 21026                                  ;ELSE
 21027 00003259 EBD7                    	jmp	short do_net_int2f
 21028                                  ;ENDIF
 21029                                  
 21030                                  LOCAL_OPEN:
 21031                                  	; MSDOS 3.3 & MSDOS 6.0
 21032 0000325B E885E6                  	call	ECritDisk
 21033                                  
 21034                                  ; DOS 3.3 FastOPen 6/16/86
 21035                                  
 21036                                  	;or	byte [FastOpenFlg],5
 21037 0000325E 800E[4611]05            	OR	byte [FastOpenFlg],FastOpen_Set+Special_Fill_Set ; only open can
 21038                                  
 21039 00003263 E8BD18                  	call	GETPATH
 21040                                  
 21041                                  ; DOS 3.3 FastOPen 6/16/86
 21042                                  
 21043 00003266 731D                    	JNC	short Open_found
 21044 00003268 7511                    	JNZ	short bad_path2
 21045 0000326A 08C9                    	OR	CL,CL
 21046 0000326C 740D                    	JZ	short bad_path2
 21047                                  OpenFNF:
 21048 0000326E B80200                  	MOV	AX,error_file_not_found	; 2
 21049                                  OpenBadRet:
 21050                                  ;hkn; FastOpenFlg is in DOSDATA use SS override
 21051                                  	; 12/08/2018
 21052                                  	;mov	byte [cs:FastOpenFlg],0 ; IBMDOS.COM (MSDOS 3.3) offset 36CAh
 21053                                  	; MSDOS 6.0
 21054 00003271 368026[4611]80          	AND	BYTE [SS:FastOpenFlg],Fast_yes    ;; DOS 3.3
 21055 00003277 F9                      	STC
 21056                                  	;call	LCritDisk
 21057                                  	; 16/12/2022
 21058 00003278 E995E6                  	jmp	LCritDisk
 21059                                  	;;JMP	Clear_FastOpen ; 10/08/2018
 21060                                  	;retn 	; 08/09/2018
 21061                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 21062                                  	;jmp	Clear_FastOpen
 21063                                  
 21064                                  bad_path2:
 21065 0000327B B80300                  	MOV	AX,error_path_not_found	; 3
 21066 0000327E EBF1                    	JMP	short OpenBadRet
 21067                                  
 21068                                  Open_Bad_Access:
 21069 00003280 B80500                  	MOV	AX,error_access_denied	; 5
 21070 00003283 EBEC                    	JMP	short OpenBadRet
 21071                                  
 21072                                  Open_found:
 21073 00003285 74F9                    	JZ	short Open_Bad_Access 	; test for directories
 21074 00003287 08E4                    	OR	AH,AH
 21075 00003289 783E                    	JS	short open_ok		; Devices don't have attributes
 21076 0000328B 8E06[E405]              	MOV	ES,[CURBUF+2]		; get buffer location
 21077                                  	;mov	al,[es:bx+0Bh]
 21078 0000328F 268A470B                	MOV	AL,[ES:BX+dir_entry.dir_attr]
 21079 00003293 A808                    	TEST	AL,attr_volume_id	; can't open volume ids
 21080 00003295 75E9                    	JNZ	short Open_Bad_Access
 21081 00003297 A801                    	TEST	AL,attr_read_only	; check write on read only
 21082 00003299 742E                    	JZ	short open_ok
 21083                                  
 21084                                  ; The file is marked READ-ONLY. We verify that the open mode allows access to
 21085                                  ; the read-only file. Unfortunately, with FCB's and net-FCB's we cannot
 21086                                  ; determine at the OPEN time if such access is allowed. Thus, we defer such
 21087                                  ; processing until the actual write operation:
 21088                                  ;
 21089                                  ; If FCB, then we change the mode to be read_only.
 21090                                  ; If net_FCB, then we change the mode to be read_only.
 21091                                  ; If not open for read then error.
 21092                                  
 21093 0000329B 1E                      	push	ds
 21094 0000329C 56                      	push	si
 21095 0000329D C536[9E05]              	LDS	SI,[THISSFT]
 21096                                  	;mov	cx,[si+2]
 21097 000032A1 8B4C02                  	MOV	CX,[SI+SF_ENTRY.sf_mode]
 21098                                  	; 17/12/2022
 21099                                  	;test	ch,80h
 21100 000032A4 F6C580                  	test	ch,sf_isFCB>>8
 21101                                  	;TEST	CX,sf_isFCB ; 8000h	; is it FCB?
 21102 000032A7 750A                    	JNZ	short ResetAccess	; yes, reset the access
 21103 000032A9 88CA                    	MOV	DL,CL
 21104 000032AB 80E2F0                  	AND	DL,SHARING_MASK	; 0F0h
 21105 000032AE 80FA70                  	CMP	DL,SHARING_NET_FCB ; 70h ; is it net FCB?
 21106 000032B1 7508                    	JNZ	short NormalOpen	; no
 21107                                  ResetAccess:
 21108                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)	
 21109                                  	;AND	CX,~access_mask	; 0FFF0h ; clear access
 21110                                  	; 16/12/2022
 21111                                  	;and	cl,0F0h ; 18/05/2019
 21112                                  	;;;
 21113                                  	; 01/02/2024 - Retro DOS v5.0
 21114                                  	; (PCDOS 7.1 IBMDOS.COM)
 21115                                  	;and	cx,0FFFCh
 21116 000032B3 80E1FC                  	and	cl,0FCh ; ~3 ; ~open_mode_mask ; clear access
 21117                                  	;;;
 21118                                  ;	OR	CX,open_for_read ; 0	; stick in open_for_read
 21119 000032B6 894C02                  	MOV	[SI+SF_ENTRY.sf_mode],CX
 21120 000032B9 EB0C                    	JMP	SHORT FillSFT
 21121                                  
 21122                                  ; The SFT is normal. See if the requested access is open_for_read
 21123                                  
 21124                                  NormalOpen:
 21125                                  	;AND	CL,access_mask	; 0Fh	; remove extras
 21126                                  	;;;
 21127                                  	; 01/02/2024 - Retro DOS v5.0
 21128                                  	; (PCDOS 7.1 IBMDOS.COM)
 21129 000032BB 80E103                  	and     cl,3		; it was 'and cl,0Fh' in MSDOS 6.22
 21130                                  				; (and cl,access_mask)
 21131                                  				; this may be open_mode_mask
 21132                                  	;;;
 21133 000032BE 80F900                  	CMP	CL,open_for_read ; 0	; is it open for read?
 21134 000032C1 7404                    	JZ	short FillSFT	; yes
 21135 000032C3 5E                      	pop	si
 21136 000032C4 1F                      	pop	ds
 21137 000032C5 EBB9                    	JMP	short Open_Bad_Access
 21138                                  ;
 21139                                  ; All done, restore registers and fill the SFT.
 21140                                  ;
 21141                                  FillSFT:
 21142 000032C7 5E                      	pop	si
 21143 000032C8 1F                      	pop	ds
 21144                                  open_ok:
 21145 000032C9 E85A23                  	call	DOOPEN			; Fill in SFT
 21146                                  
 21147                                  ;hkn; FastOpenFlg is in DOSDATA. use SS override
 21148                                  	; 18/05/2019
 21149                                  	;and	byte [ss:FastOpenFlag],80h
 21150 000032CC 368026[4611]80          	AND	BYTE [SS:FastOpenFlg],Fast_yes	;; DOS 3.3
 21151                                  	; 12/08/2018
 21152                                  	;and	byte [FastOpenFlg],Fast_yes	
 21153                                  
 21154                                  	; MSDOS 6.0
 21155 000032D2 E84300                  	CALL	DO_SHARE_CHECK
 21156 000032D5 7303                    	JNC	short SHARE_OK
 21157                                  	;call	LCritDisk
 21158                                  	; 16/12/2022
 21159 000032D7 E936E6                  	jmp	LCritDisk
 21160                                  	;;JMP	short Clear_FastOpen
 21161                                  	;retn	; 18/05/2019
 21162                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 21163                                  	;jmp	short Clear_FastOpen	
 21164                                  
 21165                                  	; MSDOS 3.3
 21166                                  ;DO_SHARE_CHECK:
 21167                                  ;	MOV	CX,[RetryCount]		; Get # tries to do
 21168                                  ;OpenShareRetry:
 21169                                  ;	push	cx			; Save number left to do
 21170                                  ;	call	SHARE_CHECK		; Final Check
 21171                                  ;	pop	cx			; CX = # left
 21172                                  ;	JNC	short SHARE_OK		; No problem with access
 21173                                  ;	call	Idle
 21174                                  ;	LOOP	OpenShareRetry		; One more retry used up
 21175                                  ;OpenShareFail:
 21176                                  ;	LES	DI,[THISSFT]
 21177                                  ;	call	SHARE_ERROR
 21178                                  ;	JNC	short DO_SHARE_CHECK	; User wants more retry
 21179                                  	
 21180                                  	;12/08/2018
 21181                                  	;mov	byte [ss:FastOpenFlg],0
 21182                                  	;08/09/2018
 21183                                  	;mov	byte [FastOpenFlg],0
 21184                                  	;call	LCritDisk
 21185                                  	;JMP	short Clear_FastOpen
 21186                                  	;retn
 21187                                  
 21188                                  SHARE_OK:
 21189                                  	; MSDOS 3.3 & MSDOS 6.0
 21190 000032DA B80300                  	MOV	AX,3
 21191 000032DD C43E[9E05]              	LES	DI,[THISSFT]
 21192                                  ;if installed
 21193                                  	;call	JShare + 14 * 4
 21194 000032E1 FF1E[C800]              	call	far [JShare+(14*4)]  ; 14 = ShSU
 21195                                  ;else
 21196                                  ;	Call	ShSU
 21197                                  ;endif
 21198 000032E5 E828E6                  	call	LCritDisk
 21199                                  	
 21200                                  	;FallThru Set_SFT_Mode
 21201                                  
 21202                                  ;----------------------------------------------------------------------------
 21203                                  ; Procedure Name : SET_SFT_MODE
 21204                                  ;
 21205                                  ; Finish SFT initialization for new reference. Set the correct mode.
 21206                                  ;
 21207                                  ;   Inputs:
 21208                                  ;	ThisSFT points to SFT
 21209                                  ;
 21210                                  ;   Outputs:
 21211                                  ;	Carry clear
 21212                                  ;   Registers modified: AX.
 21213                                  ;---------------------------------------------------------------------------
 21214                                  
 21215                                  ;hkn; called from create. DS already set up to DOSDATA.
 21216                                  
 21217                                  SET_SFT_MODE:
 21218 000032E8 C43E[9E05]              	LES	DI,[THISSFT]
 21219 000032EC E8471F                  	call	DEV_OPEN_SFT
 21220                                  	;test	word [es:di+2],8000h
 21221                                  	; 17/12/2022
 21222                                  	;test	byte [es:di+3],80h
 21223 000032EF 26F6450380              	test	byte [ES:DI+SF_ENTRY.sf_mode+1],sf_isFCB>>8
 21224                                  	;TEST	word [ES:DI+SF_ENTRY.sf_mode],sf_isFCB ; Clears carry
 21225 000032F4 7407                    	JZ	short Clear_FastOpen	; sf_mode correct (retz)
 21226 000032F6 A1[3003]                	MOV	AX,[CurrentPDB]
 21227                                  	;mov	[es:di+31h],ax
 21228 000032F9 26894531                	MOV	[ES:DI+SF_ENTRY.sf_PID],AX ; For FCB sf_PID=PDB
 21229                                  
 21230                                  Clear_FastOpen:
 21231 000032FD C3                      	retn			       ;;;;; DOS 3.3
 21232                                  
 21233                                  ;----------------------------------------------------------------------------
 21234                                  ; Procedure Name : SHARE_ERROR
 21235                                  ;
 21236                                  ; Called on sharing violations. ES:DI points to SFT. AX has error code
 21237                                  ; If SFT is FCB or compatibility mode gens INT 24 error.
 21238                                  ; Returns carry set AX=error_sharing_violation if user says ignore (can't
 21239                                  ; really ignore). Carry clear if user wants a retry. ES, DI, DS preserved
 21240                                  ;---------------------------------------------------------------------------
 21241                                  
 21242                                  SHARE_ERROR:
 21243                                  	; 17/12/2022
 21244                                  	;test	byte [es:di+3],80h
 21245 000032FE 26F6450380              	test	byte [ES:DI+SF_ENTRY.sf_mode+1],sf_isFCB>>8 ; 80h
 21246                                  	;TEST	word [ES:DI+SF_ENTRY.sf_mode],sf_isFCB ; 8000h
 21247 00003303 7509                    	JNZ	short _HARD_ERR
 21248 00003305 268A4D02                	MOV	CL,[ES:DI+SF_ENTRY.sf_mode]
 21249 00003309 80E1F0                  	AND	CL,SHARING_MASK  ; 0F0h
 21250                                  	;CMP	CL,SHARING_COMPAT ; 0
 21251                                  	;JNE	short _NO_HARD_ERR
 21252                                  	; 21/09/2023
 21253 0000330C 7505                    	jnz	short _NO_HARD_ERR
 21254                                  _HARD_ERR:
 21255 0000330E E86851                  	call	SHARE_VIOLATION
 21256                                  	;retnc				; User wants retry
 21257 00003311 73EA                    	jnc	short Clear_FastOpen
 21258                                  _NO_HARD_ERR:
 21259 00003313 B82000                  	MOV	AX,error_sharing_violation  ; 20h
 21260 00003316 F9                      	STC
 21261 00003317 C3                      	retn
 21262                                  
 21263                                  ; MSDOS 6.0
 21264                                  ;----------------------------------------------------------------------------
 21265                                  ; Procedure Name : DO_SHARE_CHECK
 21266                                  ;
 21267                                  ; Input: THISDPB, WFP_Start, THISSFT set
 21268                                  ; Functions: check file sharing mode is valid
 21269                                  ; Output: carry set, error
 21270                                  ;	  carry clear, share ok
 21271                                  ;----------------------------------------------------------------------------
 21272                                  
 21273                                  	; 18/05/2019 - Retro DOS v4.0
 21274                                  DO_SHARE_CHECK:
 21275 00003318 E8C8E5                  	call	ECritDisk		; enter critical section
 21276                                  OPN_RETRY:
 21277 0000331B 8B0E[1A00]              	MOV	CX,[RetryCount]		; Get # tries to do
 21278                                  OpenShareRetry:
 21279 0000331F 51                      	push	cx			; Save number left to do
 21280 00003320 E85151                  	call	SHARE_CHECK		; Final Check
 21281 00003323 59                      	pop	cx			; CX = # left
 21282 00003324 730E                    	JNC	short Share_Ok2		; No problem with access
 21283 00003326 E8B3E4                  	call	Idle
 21284 00003329 E2F4                    	LOOP	OpenShareRetry		; One more retry used up
 21285                                  OpenShareFail:
 21286 0000332B C43E[9E05]              	LES	DI,[THISSFT]
 21287 0000332F E8CCFF                  	call	SHARE_ERROR
 21288 00003332 73E7                    	JNC	short OPN_RETRY		; User wants more retry
 21289                                  Share_Ok2:
 21290                                  	;call	LCritDisk		; leave critical section
 21291                                  	;retn
 21292                                  	; 18/12/2022
 21293 00003334 E9D9E5                  	jmp	LCritDisk
 21294                                  
 21295                                  ;-----------------------------------------------------------------------------
 21296                                  ; Procedure Name : Check_Access
 21297                                  ;
 21298                                  ; Inputs:
 21299                                  ;	AX is mode
 21300                                  ;	  High NIBBLE of AL (Sharing Mode)
 21301                                  ;		sharing_compat	   file is opened in compatibility mode
 21302                                  ;		sharing_deny_none  file is opened Multi reader, Multi writer
 21303                                  ;		sharing_deny_read  file is opened Only reader, Multi writer
 21304                                  ;		sharing_deny_write file is opened Multi reader, Only writer
 21305                                  ;		sharing_deny_both  file is opened Only reader, Only writer
 21306                                  ;	  Low NIBBLE of AL (Access Mode)
 21307                                  ;		open_for_read	file is opened for reading
 21308                                  ;		open_for_write	file is opened for writing
 21309                                  ;		open_for_both	file is opened for both reading and writing.
 21310                                  ; Function:
 21311                                  ;	Check this access mode for correctness
 21312                                  ; Outputs:
 21313                                  ;	[open_access] = AL input
 21314                                  ;	Carry Clear
 21315                                  ;		Mode is correct
 21316                                  ;		AX unchanged
 21317                                  ;	Carry Set
 21318                                  ;		Mode is bad
 21319                                  ;		AX = error_invalid_access
 21320                                  ; No other registers effected
 21321                                  ;----------------------------------------------------------------------------
 21322                                  
 21323                                  	; 23/01/2024 - Retro DOS v5.0
 21324                                  Check_Access_AX:
 21325 00003337 A2[6E05]                	MOV	[OPEN_ACCESS],AL
 21326 0000333A 53                      	PUSH	BX
 21327                                  
 21328                                  ;	If sharing, then test for special sharing mode for FCBs
 21329                                  
 21330 0000333B 88C3                    	MOV	BL,AL
 21331 0000333D 80E3F0                  	AND	BL,SHARING_MASK ; 0F0h
 21332                                  
 21333                                  	;CMP	byte [FSHARING],-1
 21334                                  	;JNZ	short CheckShareMode	; not through server call, must be ok
 21335                                  	; 23/01/2024
 21336                                  	; PCDOS 7.1 IBMDOS.COM
 21337 00003340 803E[7205]00            	cmp	byte [FSHARING],0
 21338 00003345 7405                    	jz	short CheckShareMode	; not through server call, must be ok
 21339                                  
 21340 00003347 80FB70                  	CMP	BL,SHARING_NET_FCB ; 70h
 21341 0000334A 7405                    	JZ	short CheckAccessMode	; yes, we have an FCB
 21342                                  CheckShareMode:
 21343 0000334C 80FB40                  	CMP	BL,40h			; is this a good sharing mode?
 21344 0000334F 770D                    	JA	short Make_Bad_Access
 21345                                  CheckAccessMode:
 21346 00003351 88C3                    	MOV	BL,AL
 21347                                  	; 23/01/2024
 21348 00003353 80E303                  	and	bl,3 ; PCDOS 7.1 IBMDOS.COM	
 21349                                  	;AND	BL,access_mask ; 0Fh
 21350 00003356 80FB02                  	CMP	BL,2
 21351 00003359 7703                    	JA	short Make_Bad_Access
 21352 0000335B 5B                      	POP	BX
 21353 0000335C F8                      	CLC
 21354 0000335D C3                      	retn
 21355                                  
 21356                                  Make_Bad_Access:
 21357 0000335E B80C00                  	MOV	AX,error_invalid_access ; 0Ch
 21358 00003361 5B                      	POP	BX
 21359 00003362 F9                      	STC
 21360 00003363 C3                      	retn
 21361                                  
 21362                                  ;============================================================================
 21363                                  ; DINFO.ASM, MSDOS 6.0, 1991
 21364                                  ;============================================================================
 21365                                  ; 08/08/2018 - Retro DOS v3.0
 21366                                  ; 18/05/2019 - Retro DOS v4.0
 21367                                  ; 02/02/2024 - Retro DOS v5.0
 21368                                  
 21369                                  ;**	Low level routine for returning disk drive information from a local
 21370                                  ;	  or NET device
 21371                                  ;
 21372                                  ;	DISK_INFO
 21373                                  ;
 21374                                  ;	  Modification history:
 21375                                  ;
 21376                                  ;		Created: ARR 30 March 1983
 21377                                  
 21378                                  ;	Break	<DISK_INFO -- Get Disk Drive Information>
 21379                                  ;---------------------------------------------------------------------------
 21380                                  ; Procedure Name : DISK_INFO
 21381                                  ;
 21382                                  ; Inputs:
 21383                                  ;	[THISCDS] Points to the Macro List Structure of interest
 21384                                  ;		(It MAY NOT be NUL, error not detected)
 21385                                  ; Function:
 21386                                  ;	Get Interesting Drive Information
 21387                                  ; Returns:
 21388                                  ;	DX = Number of free allocation units
 21389                                  ;	BX = Total Number of allocation units on disk
 21390                                  ;	CX = Sector size
 21391                                  ;	AL = Sectors per allocation unit
 21392                                  ;	AH = FAT ID BYTE
 21393                                  ;	Carry set if error (currently user FAILed to I 24)
 21394                                  ; Segs except ES preserved, others destroyed
 21395                                  ;----------------------------------------------------------------------------
 21396                                  
 21397                                  ;hkn; called from getset.asm and misc.asm. DS has already been set up to
 21398                                  ;hkn; DOSDATA. 
 21399                                  
 21400                                  	; 02/02/2024 - Retro DOS v5.0
 21401                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:732Bh
 21402                                  
 21403                                  DISK_INFO:
 21404                                  	; 08/08/2018 - Retro DOS v3.0
 21405                                  	; IBM DOS.COM (MSDOS 3.3, 1987) - Offset 37C5h
 21406                                  
 21407 00003364 E8BAE4                  	call	TestNet
 21408 00003367 7318                    	JNC	short LOCAL_DSK_INFO
 21409                                  
 21410                                  	;;;
 21411                                  	; 02/02/2024 (PCDOS 7.1 IBMDOS.COM)
 21412 00003369 31F6                    	xor     si,si	; free cluster count hw = 0
 21413 0000336B 31FF                    	xor     di,di	; number of clusters hw = 0
 21414                                  	;;;
 21415                                  
 21416                                  ;IF NOT Installed
 21417                                  ;	transfer NET_DISK_INFO
 21418                                  ;ELSE
 21419                                  	;MOV	AX,(MultNET SHL 8) OR 12
 21420                                  	;INT	2FH
 21421                                  	;return
 21422                                  
 21423 0000336D B80C11                  	mov     ax,110Ch
 21424 00003370 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - GET DISK SPACE
 21425                                  			; ES:DI -> current directory
 21426                                  			; Return: AL = sectors per cluster, BX = total clusters
 21427                                  			; CX = bytes per sector, DX = number of available clusters
 21428                                  	;;;
 21429                                  	; 02/02/2024 (PCDOS 7.1 IBMDOS.COM)
 21430 00003372 83FBFF                  	cmp	bx,0FFFFh
 21431 00003375 7502                    	jne	short dsk_info_1
 21432 00003377 89DF                    	mov	di,bx
 21433                                  dsk_info_1:
 21434 00003379 83FAFF                  	cmp	dx,0FFFFh
 21435 0000337C 7502                    	jne	short disk_info_retn
 21436 0000337E 89D6                    	mov	si,dx
 21437                                  disk_info_retn:
 21438                                  	;;;
 21439 00003380 C3                      	retn
 21440                                  ;ENDIF
 21441                                  
 21442                                  LOCAL_DSK_INFO:
 21443                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Disk
 21444                                  	;;;
 21445                                  	; 02/02/2024 (PCDOS 7.1 IBMDOS.COM)
 21446 00003381 E85ADF                  	call	set_exerr_locus_disk
 21447                                  	;;;
 21448 00003384 E85CE5                  	call	ECritDisk
 21449 00003387 E80132                  	call	FATREAD_CDS		; perform media check.
 21450                                  	;JC	short CRIT_LEAVE
 21451                                  	;;; 02/02/2024
 21452 0000338A 720D                    	jc	short dsk_info_2
 21453 0000338C 31C0                    	xor	ax,ax
 21454 0000338E A3[E80A]                	mov	[CLUSTNUM_HW],ax ; 0	; clear high word of cluster number
 21455                                  	;;;
 21456 00003391 BB0200                  	MOV	BX,2
 21457 00003394 E8792F                  	call	UNPACK			; Get first FAT sector into CURBUF
 21458                                  	;JC	short CRIT_LEAVE
 21459                                  	;;;
 21460                                  	; 02/02/2024 - Retro DOS v5.0
 21461 00003397 7303                    	jnc	short dsk_info_3
 21462                                  dsk_info_2:
 21463                                  	;jmp	CRIT_LEAVE
 21464 00003399 E974E5                  	jmp	LCritDisk
 21465                                  dsk_info_3:
 21466                                  	;;;
 21467 0000339C C536[E205]              	LDS	SI,[CURBUF]
 21468                                  	; 02/02/2024
 21469                                  	;;mov	ah,[si+20]
 21470                                  	;mov	ah,[si+24] ; PCDOS 7.1 IBMDOS.COM
 21471 000033A0 8A6418                  	MOV	AH,[SI+BUFINSIZ]	; get FAT ID BYTE
 21472                                  
 21473                                  ;hkn; SS is DOSDATA
 21474 000033A3 16                      	push	ss
 21475 000033A4 1F                      	pop	ds
 21476                                  
 21477                                  ; 02/02/2024 - Retro DOS v5.0
 21478                                  %if 0
 21479                                  	;mov	cx,[es:bp+0Dh]
 21480                                  	MOV	CX,[ES:BP+DPB.MAX_CLUSTER]
 21481                                  
 21482                                  ; Examine the current free count. If it indicates that we have an invalid
 21483                                  ; count, do the expensive calculation.
 21484                                  
 21485                                  	;mov	dx,[es:bp+1Fh]
 21486                                  	MOV	DX,[ES:BP+DPB.FREE_CNT] ; get free count
 21487                                  	CMP	DX,-1			; is it valid?
 21488                                  	JZ	short DoScan
 21489                                  
 21490                                  ; Check to see if it is in a reasonable range. If so, trust it and return.
 21491                                  ; Otherwise, we need to blast out an internal error message and then recompute
 21492                                  ; the count.
 21493                                  
 21494                                  	CMP	DX,CX			; is it in a reasonable range?
 21495                                  	JB	short GotVal		; yes, trust it.
 21496                                  DoScan:
 21497                                  	XOR	DX,DX
 21498                                  	DEC	CX
 21499                                  SCANFREE:
 21500                                  	call	UNPACK
 21501                                  	JC	short CRIT_LEAVE
 21502                                  	JNZ	short NOTFREECLUS
 21503                                  	INC	DX			; A free one
 21504                                  NOTFREECLUS:
 21505                                  	INC	BX			; Next cluster
 21506                                  	LOOP	SCANFREE
 21507                                  	DEC	BX			; BX was next cluster. Convert to
 21508                                  ReturnVals:
 21509                                  	DEC	BX			; count
 21510                                  	;mov	al,[es:bp+4]
 21511                                  	MOV	AL,[ES:BP+DPB.CLUSTER_MASK]
 21512                                  	INC	AL			; Sectors/cluster
 21513                                  	;mov	cx,[es:bp+2]
 21514                                  	MOV	CX,[ES:BP+DPB.SECTOR_SIZE] ; Bytes/sector
 21515                                  	;mov	[es:bp+1Fh],dx
 21516                                  	MOV	[ES:BP+DPB.FREE_CNT],DX
 21517                                  	CLC
 21518                                  CRIT_LEAVE:
 21519                                  	;call	LCritDisk
 21520                                  	;retn
 21521                                  	; 17/12/2022
 21522                                  	jmp	LCritDisk
 21523                                  
 21524                                  ; We have correctly computed everything previously. Load up registers for
 21525                                  ; return.
 21526                                  
 21527                                  GotVal: 
 21528                                  	MOV	BX,CX			; get cluster count
 21529                                  	JMP	short ReturnVals
 21530                                  
 21531                                  %else
 21532                                  	; 02/02/2024 (PCDOS 7.1 IBMDOS.COM)
 21533 000033A5 31F6                    	xor	si,si	; 0
 21534 000033A7 89F7                    	mov	di,si	; 0
 21535                                  	;mov	dx,[es:bp+1Fh]
 21536 000033A9 268B561F                	mov	dx,[es:bp+DPB.FREE_CNT]	; get free count
 21537                                  	;cmp	[es:bp+0Fh],si
 21538 000033AD 2639760F                	cmp	[es:bp+DPB.FAT_SIZE],si ; FAT32 (16 bit FAT size = 0) ?
 21539 000033B1 7406                    	jz	short dsk_info_4	; yes
 21540                                  	;mov	cx,[es:bp+0Dh]
 21541 000033B3 268B4E0D                	mov	cx,[es:bp+DPB.MAX_CLUSTER]
 21542 000033B7 EB18                    	jmp	short dsk_info_5 ; zf=0, si=di=0
 21543                                  
 21544                                  dsk_info_4:
 21545                                  	;mov	di,[es:bp+2Fh]
 21546 000033B9 268B7E2F                	mov	di,[es:bp+DPB.LAST_CLUSTER+2]
 21547                                  	;mov	cx,[es:bp+2Dh]
 21548 000033BD 268B4E2D                	mov	cx,[es:bp+DPB.LAST_CLUSTER]
 21549                                  	;mov	si,[es:bp+21h]
 21550 000033C1 268B7621                	mov	si,[es:bp+DPB.FREE_CNT_HW] ; hw of free cluster count
 21551 000033C5 39F2                    	cmp	dx,si			; same (zero) ?
 21552                                  ;dsk_info_5:
 21553 000033C7 7504                    	jnz	short dsk_info_6	; not same (not zero)
 21554 000033C9 42                      	inc	dx
 21555 000033CA 740B                    	jz	short dsk_info_8	; 0FFFFh -> 0 (free count is invalid/initial)
 21556                                  					; free count calculation is needed
 21557 000033CC 4A                      	dec	dx
 21558                                  dsk_info_6:
 21559 000033CD 39FE                    	cmp	si,di			; same hw ?
 21560 000033CF 7502                    	jne	short dsk_info_7	; no
 21561                                  dsk_info_5:	; 02/02/2024 - Retro DOS v5.0 
 21562 000033D1 39CA                    	cmp	dx,cx			; same lw ?
 21563                                  dsk_info_7:
 21564 000033D3 7268                    	jb	short GotVal		; free cluster count < last cluster number
 21565 000033D5 31D2                    	xor	dx,dx	; 0
 21566                                  dsk_info_8:
 21567 000033D7 31F6                    	xor	si,si	; 0
 21568 000033D9 83E901                  	sub	cx,1			; last cluster number - 1 = number of clusters
 21569 000033DC 19F7                    	sbb	di,si
 21570                                  	;or	byte [es:bp+18h],1
 21571 000033DE 26804E1801              	or	byte [es:bp+DPB.FIRST_ACCESS],1 ; set first access bit 0
 21572                                  					; (Update flag for FSINFO sector)
 21573                                  SCANFREE:
 21574 000033E3 56                      	push	si
 21575 000033E4 FF36[EC0A]              	push	word [CCONTENT_HW]
 21576 000033E8 57                      	push	di
 21577 000033E9 E8242F                  	call	UNPACK
 21578 000033EC 5F                      	pop	di
 21579 000033ED 8F06[EC0A]              	pop	word [CCONTENT_HW]
 21580 000033F1 5E                      	pop	si
 21581 000033F2 7246                    	jc	short CRIT_LEAVE
 21582 000033F4 7504                    	jnz	short NOTFREECLUS
 21583 000033F6 42                      	inc	dx			; a free one
 21584 000033F7 7501                    	jnz	short NOTFREECLUS
 21585 000033F9 46                      	inc	si			; increase hw of free cluster count
 21586                                  
 21587                                  NOTFREECLUS:
 21588 000033FA 43                      	inc	bx			; next cluster
 21589 000033FB 7504                    	jnz	short NOTFREECLUS2
 21590 000033FD FF06[E80A]              	inc	word [CLUSTNUM_HW]	; increase hw of (next) cluster number
 21591                                  
 21592                                  NOTFREECLUS2:
 21593 00003401 83E901                  	sub	cx,1			; decrease remain cluster count for calculation
 21594 00003404 83DF00                  	sbb	di,0
 21595 00003407 75DA                    	jnz	short SCANFREE
 21596 00003409 E302                    	jcxz	NOTFREECLUS3		; calculation completed
 21597 0000340B EBD6                    	jmp	short SCANFREE
 21598                                  
 21599                                  NOTFREECLUS3:
 21600 0000340D 8B3E[E80A]              	mov	di,[CLUSTNUM_HW]
 21601 00003411 83EB01                  	sub	bx,1
 21602 00003414 83DF00                  	sbb	di,0			; di:bx = last cluster number
 21603                                  
 21604                                  ReturnVals:
 21605 00003417 31C9                    	xor	cx,cx
 21606 00003419 83EB01                  	sub	bx,1
 21607 0000341C 19CF                    	sbb	di,cx			; di:bx = number of clusters
 21608                                  	;mov	al,[es:bp+4]
 21609 0000341E 268A4604                	mov	al,[es:bp+DPB.CLUSTER_MASK] ; spc - 1
 21610 00003422 FEC0                    	inc	al			; sectors per cluster
 21611                                  	;mov	[es:bp+1Fh],dx		
 21612 00003424 2689561F                	mov	[es:bp+DPB.FREE_CNT],dx	; free cluster count,lw
 21613                                  	;cmp	[es:bp+0Fh],cx ; 0
 21614 00003428 26394E0F                	cmp	[es:bp+DPB.FAT_SIZE],cx ; 0 ; FAT32 (16 bit FAT size = 0) ?
 21615 0000342C 7507                    	jnz	short ReturnVals2	; no
 21616                                  	;mov	[es:bp+21h],si
 21617 0000342E 26897621                	mov	[es:bp+DPB.FREE_CNT_HW],si ; hw of free cluster count
 21618                                  
 21619 00003432 E83800                  	call	update_fat32_fsinfo
 21620                                  
 21621                                  ReturnVals2:
 21622                                  	;mov	cx,[es:bp+2]
 21623 00003435 268B4E02                	mov	cx,[es:bp+DPB.SECTOR_SIZE] ; bytes per sector
 21624 00003439 F8                      	clc
 21625                                  
 21626                                  CRIT_LEAVE:
 21627                                  	;call	LCritDisk
 21628                                  	;retn
 21629 0000343A E9D3E4                  	jmp	LCritDisk
 21630                                  
 21631                                  GotVal:
 21632 0000343D 89CB                    	mov	bx,cx
 21633 0000343F EBD6                    	jmp	short ReturnVals
 21634                                  
 21635                                  %endif
 21636                                  
 21637                                  ; =============== S U B R O U T I N E =======================================
 21638                                  
 21639                                  ; 03/02/2024 - Retro DOS v5.0
 21640                                  
 21641                                  modify_spc:
 21642 00003441 50                      	push	ax			; ax = sectors per cluster
 21643 00003442 52                      	push	dx
 21644 00003443 F7E1                    	mul	cx			; bytes per sector
 21645                                  	;cmp	dx,0
 21646 00003445 21D2                    	and	dx,dx
 21647 00003447 7503                    	jnz	short mspc_1
 21648 00003449 3D0040                  	cmp	ax,16384		; 16 kilobytes (per cluster)
 21649                                  					; ***
 21650                                  					; actual disk size limit
 21651                                  					; without invalidating cluster counts is
 21652                                  					; 2 GB (512K clusters * 8 sectors per cluster)
 21653                                  					;      (128K clusters * 32 sectors per cluster)
 21654                                  mspc_1:
 21655 0000344C 5A                      	pop	dx
 21656 0000344D 58                      	pop	ax
 21657 0000344E 760E                    	jbe	short mspc_3		; bytes per cluster <= 16 KB
 21658                                                                          ; ***
 21659                                                                          ; bytes per cluster > 16 KB
 21660 00003450 31FF                    	xor	di,di			; 0
 21661 00003452 BBFEFF                  	mov	bx,0FFFEh		; (invalidated)
 21662 00003455 09F6                    	or	si,si			; hw of free cluster count
 21663 00003457 7404                    	jz	short mspc_2		; si = 0
 21664 00003459 89FE                    	mov	si,di			; si = 0
 21665 0000345B 89DA                    	mov	dx,bx			; dx = bx = 0FFFEh (invalidated)
 21666                                  mspc_2:
 21667 0000345D C3                      	retn
 21668                                  
 21669                                  mspc_3:
 21670 0000345E D1E0                    	shl	ax,1			; sectors per clust = sectors per clust * 2
 21671                                  					; (ax <= 32768) -modified spc limit-
 21672 00003460 D1EF                    	shr	di,1			; cluster count = cluster count /2
 21673                                  					; di:bx = modified value of total clusters
 21674                                  mspc_4:
 21675 00003462 D1DB                    	rcr	bx,1
 21676 00003464 D1EE                    	shr	si,1			; free clusters = free clusters / 2
 21677 00003466 D1DA                    	rcr	dx,1			; si:dx = modified value of free clusters
 21678                                  
 21679                                  ; ---------------------------------------------------------------------------
 21680                                  
 21681                                  	; 03/02/2024
 21682                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:7431h
 21683                                  
 21684                                  modify_cluster_count:
 21685 00003468 09FF                    	or	di,di			; hw of cluster count
 21686 0000346A 75D5                    	jnz	short modify_spc
 21687 0000346C C3                      	retn
 21688                                  
 21689                                  ; =============== S U B R O U T I N E =======================================
 21690                                  
 21691                                  ; write FSINFO sector onto disk
 21692                                  
 21693                                  ; 03/02/2024 - Retro DOS v5.0
 21694                                  ; --------------------------------
 21695                                  ; FAT32 FSInfo Sector Structure
 21696                                  ; --------------------------------
 21697                                  ; ref: Microsoft FAT32 File System Specification (2000)
 21698                                  
 21699                                  struc FSINFO		; Offset ;
 21700 00000000 ????????                .LeadSig:	resb 4	  ; 0		; Value 0x41615252. Lead Signature.
 21701 00000004 <res 1E0h>              .Reserved1:	resb 480  ; 4		; Reserved. Must be 0. Never be used.
 21702 000001E4 ????????                .StrucSig:	resb 4	  ; 484		; Value 0x61417272. Fields Signature.
 21703 000001E8 ????????                .Free_Count:	resb 4	  ; 488		; Last known free cluster count. (*) 
 21704 000001EC ????????                .Nxt_Free:	resb 4	  ; 492		; Start clus for free clus srch. (**)
 21705 000001F0 <res Ch>                .Reserved2:	resb 12	  ; 496		; Reserved. Must be 0. Never be used.
 21706 000001FC ????????                .TrailSig:	resb 4	  ; 508		; Value 0xAA550000. Trail Signature.
 21707                                  .size:
 21708                                  endstruc
 21709                                  
 21710                                  ; (*) If the value is 0xFFFFFFFF, then the free count is unknown
 21711                                  ;     and must be computed.
 21712                                  ; (**) If the value is 0xFFFFFFFF, then free cluster search must be started
 21713                                  ;     from cluster 2.
 21714                                  ; Lead Signature, Fields (Structure) Signature and Trail Signature
 21715                                  ; are used to validate FSInfo sector.
 21716                                  
 21717                                  ; --------------------------------
 21718                                  
 21719                                  	; 03/02/2024 - Retro DOS v5.0
 21720                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:7436h
 21721                                  	; (Windows ME IO.SYS - BIOSCODE:7227h)
 21722                                  
 21723                                  update_fat32_fsinfo:
 21724 0000346D 51                      	push	cx
 21725 0000346E 52                      	push	dx
 21726 0000346F 31C9                    	xor	cx,cx
 21727                                  	;mov	dx,[es:bp+25h]
 21728 00003471 268B5625                	mov	dx,[es:bp+DPB.FSINFO_SECTOR]
 21729                                  	;cmp	[es:bp+0Fh],cx
 21730 00003475 26394E0F                	cmp	[es:bp+DPB.FAT_SIZE],cx ; 0
 21731                                  				; (16bit FAT size field = 0 for FAT32 fs)
 21732 00003479 7505                    	jne	short u_fat32_inf_1
 21733 0000347B 83FAFF                  	cmp	dx,0FFFFh ; -1
 21734 0000347E 7508                    	jne	short u_fat32_inf_2
 21735                                  
 21736                                  u_fat32_inf_1:
 21737 00003480 5A                      	pop	dx
 21738 00003481 59                      	pop	cx
 21739                                  	;and	byte [es:bp+18h],0F4h
 21740 00003482 26806618F4              	and	byte [es:bp+DPB.FIRST_ACCESS],0F4h ; clear bit 0,1 and 3
 21741                                  					; bit 0 - FSINFO update (dirty) bit
 21742                                  					; bit 1 - BPB_RootClus update bit
 21743                                  					; bit 3 - BPB_ExtFlags update bit
 21744 00003487 C3                      	retn
 21745                                  
 21746                                  u_fat32_inf_2:
 21747 00003488 50                      	push	ax
 21748 00003489 53                      	push	bx
 21749 0000348A 57                      	push	di
 21750 0000348B 56                      	push	si
 21751 0000348C 1E                      	push	ds
 21752 0000348D 36803E[7900]00          	cmp	byte [ss:BuffInHMA],0	; is buffers in HMA?
 21753 00003493 740A                    	jz	short u_fat32_inf_3	; no
 21754 00003495 36C53E[7A00]            	lds	di,[ss:LoMemBuff]	; read it into scratch buffer
 21755                                  	;sub	di,24
 21756 0000349A 83EF18                  	sub	di,BUFINSIZ		; space for buffer header
 21757                                  					; (buffer header size = 24)
 21758                                  	;clc
 21759 0000349D EB0E                    	jmp	short u_fat32_inf_4
 21760                                  
 21761                                  u_fat32_inf_3:
 21762 0000349F 06                      	push	es
 21763 000034A0 55                      	push	bp
 21764 000034A1 E84534                  	call	GETCURHEAD		; ds:di = first buffer in queue
 21765 000034A4 52                      	push	dx
 21766 000034A5 E8A136                  	call	BUFWRITE		; BufWrite writes a buffer to the disk,
 21767                                  					;  if it's dirty.
 21768 000034A8 5A                      	pop	dx
 21769 000034A9 5D                      	pop	bp
 21770 000034AA 07                      	pop	es
 21771                                  ;u_fat32_inf_4:
 21772 000034AB 726A                    	jc	short u_fat32_inf_5
 21773                                  u_fat32_inf_4:
 21774 000034AD 31C9                    	xor	cx,cx
 21775                                  	;lea	bx,[di+24]
 21776 000034AF 8D5D18                  	lea	bx,[di+BUFINSIZ]	; buffer data address
 21777                                  	;mov	byte [ss:ALLOWED],18h
 21778 000034B2 36C606[4B03]18          	mov	byte [ss:ALLOWED],Allowed_FAIL+Allowed_RETRY
 21779 000034B8 36890E[0706]            	mov	[ss:HIGH_SECTOR],cx ; 0
 21780 000034BD 41                      	inc	cx			; cx = sector count = 1
 21781                                  					; es:bp = DPB
 21782 000034BE 53                      	push	bx			; ds:bx = buffer (data) address
 21783 000034BF 52                      	push	dx			; HIGH_SECTOR:dx = disk sector address
 21784 000034C0 E8300B                  	call	DREAD		 	; read fs info sector
 21785 000034C3 5A                      	pop	dx
 21786 000034C4 5B                      	pop	bx
 21787 000034C5 7250                    	jc	short u_fat32_inf_5
 21788                                  
 21789                                  	;cmp	word [bx+FSINFO.LeadSig],5252h	
 21790 000034C7 813F5252                	cmp	word [bx],5252h		; 'RR'
 21791 000034CB 754A                    	jne	short u_fat32_inf_5
 21792                                  	;cmp	word [bx+2],4161h	; 'aA' ; (NASM syntax)
 21793 000034CD 817F026141              	cmp	word [bx+FSINFO.LeadSig+2],4161h
 21794 000034D2 7543                    	jne	short u_fat32_inf_5
 21795                                  	
 21796                                  	;cmp	word [bx+1E4h],7272h	; 'rr' at offset 484
 21797 000034D4 81BFE4017272            	cmp	word [bx+FSINFO.StrucSig],7272h
 21798 000034DA 753B                    	jne	short u_fat32_inf_5
 21799                                  
 21800                                  	;cmp	word [bx+1E6h],6141h	; 'Aa' at offset 486
 21801 000034DC 81BFE6014161            	cmp	word [bx+FSINFO.StrucSig+2],6141h
 21802 000034E2 7533                    	jne	short u_fat32_inf_5
 21803                                  
 21804                                  	;cmp	word [bx+1FEh],0AA55h	; boot signature at offset 510
 21805 000034E4 81BFFE0155AA            	cmp	word [bx+FSINFO.TrailSig+2],0AA55h
 21806 000034EA 752B                    	jne	short u_fat32_inf_5
 21807                                  	
 21808                                  	;mov	ax,[es:bp+1Fh]
 21809 000034EC 268B461F                	mov	ax,[es:bp+DPB.FREE_CNT]
 21810                                  	;mov	[bx+1E8h],ax 
 21811 000034F0 8987E801                	mov	[bx+FSINFO.Free_Count],ax ; at offset 488
 21812                                  	;mov	ax,[es:bp+21h]
 21813 000034F4 268B4621                	mov	ax,[es:bp+DPB.FREE_CNT+2]
 21814                                  	;mov	[bx+1EAh],ax
 21815 000034F8 8987EA01                	mov	[bx+FSINFO.Free_Count+2],ax
 21816                                  
 21817                                  	;mov	ax,[es:bp+39h]
 21818 000034FC 268B4639                	mov	ax,[es:bp+DPB.FAT32_NXTFREE]
 21819                                  	;mov	[bx+1ECh],ax
 21820 00003500 8987EC01                	mov	[bx+FSINFO.Nxt_Free],ax	; at offset 492
 21821                                  	;mov	ax,[es:bp+3Bh]
 21822 00003504 268B463B                	mov	ax,[es:bp+DPB.FAT32_NXTFREE+2]
 21823                                  	;mov	[bx+1EEh],ax
 21824 00003508 8987EE01                	mov	[bx+FSINFO.Nxt_Free+2],ax
 21825                                  
 21826 0000350C 31C9                    	xor	cx,cx
 21827 0000350E 36890E[0706]            	mov	[ss:HIGH_SECTOR],cx ; 0
 21828 00003513 41                      	inc	cx	; 1
 21829 00003514 E8410B                  	call	DWRITE
 21830                                  
 21831                                  u_fat32_inf_5:
 21832 00003517 1F                      	pop	ds
 21833 00003518 5E                      	pop	si
 21834 00003519 5F                      	pop	di
 21835 0000351A 5B                      	pop	bx
 21836 0000351B 58                      	pop	ax
 21837 0000351C E961FF                  	jmp	u_fat32_inf_1
 21838                                  
 21839                                  ;============================================================================
 21840                                  ; ISEARCH.ASM, MSDOS 6.0, 1991
 21841                                  ;============================================================================
 21842                                  ; 22/07/2018 - Retro DOS v3.0
 21843                                  
 21844                                  ;	TITLE	DOS_SEARCH - Internal SEARCH calls for MS-DOS
 21845                                  ;	NAME	DOS_SEARCH
 21846                                  
 21847                                  ;**	Low level routines for doing local and NET directory searches
 21848                                  ;
 21849                                  ;	DOS_SEARCH_FIRST
 21850                                  ;	DOS_SEARCH_NEXT
 21851                                  ;	RENAME_NEXT
 21852                                  ;
 21853                                  ;	Revision history:
 21854                                  ;
 21855                                  ;	    Created: ARR 30 March 1983
 21856                                  ;	    A000	version 4.00  Jan. 1988
 21857                                  ;	    A001	PTM 3564 -- search for fastopen
 21858                                  
 21859                                  ;Installed = TRUE
 21860                                  
 21861                                  ;--------------------------------------------------------------------------
 21862                                  ;
 21863                                  ; Procedure Name : DOS_SEARCH_FIRST
 21864                                  ;
 21865                                  ; Inputs:
 21866                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 21867                                  ;		terminated)
 21868                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 21869                                  ;		( = -1 if current dir not involved, else
 21870                                  ;		 Points to first char after last "/" of current dir part)
 21871                                  ;	[THISCDS] Points to CDS being used
 21872                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 21873                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 21874                                  ;	[DMAADD] Points to 53 byte buffer
 21875                                  ; Function:
 21876                                  ;	Initiate a search for the given file spec
 21877                                  ; Outputs:
 21878                                  ;	CARRY CLEAR
 21879                                  ;	    The 53 bytes ot DMAADD are filled in as follows:
 21880                                  ;
 21881                                  ;	LOCAL
 21882                                  ;	    Drive Byte (A=1, B=2, ...) High bit clear
 21883                                  ;		NEVER STORE DRIVE BYTE AFTER  found_it
 21884                                  ;	    11 byte search name with Meta chars in it
 21885                                  ;	    Search Attribute Byte, attribute of search
 21886                                  ;	    WORD LastEnt value
 21887                                  ;	    WORD DirStart
 21888                                  ;	    4 byte pad
 21889                                  ;	    32 bytes of the directory entry found
 21890                                  ;	NET
 21891                                  ;	    21 bytes First byte has high bit set
 21892                                  ;	    32 bytes of the directory entry found
 21893                                  ;
 21894                                  ;	CARRY SET
 21895                                  ;	    AX = error code
 21896                                  ;		error_no_more_files
 21897                                  ;			No match for this file
 21898                                  ;		error_path_not_found
 21899                                  ;			Bad path (not in curr dir part if present)
 21900                                  ;		error_bad_curr_dir
 21901                                  ;			Bad path in current directory part of path
 21902                                  ; DS preserved, others destroyed
 21903                                  ;---------------------------------------------------------------------------
 21904                                  
 21905                                  ; 24/01/2024
 21906                                  %if 1
 21907                                  	; 17/05/2019 - Retro DOS v4.0
 21908                                  GET_FAST_SEARCH:
 21909                                  	; 22/07/2018
 21910                                  	; MSDOS 6.0
 21911                                  	; 17/12/2022
 21912 0000351F 36800E[1206]04          	OR	byte [ss:DOS34_FLAG+1],(SEARCH_FASTOPEN>>8)  ; 04h
 21913                                  	;OR	word [ss:DOS34_FLAG],SEARCH_FASTOPEN  ; 400h
 21914                                  					;FO.trigger fastopen ;AN000;
 21915                                  	;call	DOS_SEARCH_FIRST
 21916                                  	;retn
 21917                                  	; 24/01/2024
 21918                                  	; 17/12/2022
 21919                                  	;jmp	DOS_SEARCH_FIRST
 21920                                  %endif
 21921                                  
 21922                                  	; 14/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 21923                                  	; DOSCODE:6C22h (MSDOS 5.0, MSDOS.SYS)
 21924                                  
 21925                                  	; 03/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 21926                                  	; DOSCODE:74E9h (PCDOS 7.1, IBMDOS.COM)
 21927                                  
 21928                                  DOS_SEARCH_FIRST:
 21929                                  	; IBMDOS.COM (MSDOS 3.3 kernel) - Offset 3826h
 21930                                  
 21931 00003525 C43E[A205]              	LES	DI,[THISCDS]
 21932 00003529 83FFFF                  	CMP	DI,-1
 21933 0000352C 7506                    	JNZ	short TEST_RE_NET2
 21934                                  
 21935                                  ;IF NOT Installed
 21936                                  ;	transfer NET_SEQ_SEARCH_FIRST
 21937                                  ;ELSE
 21938                                  	;mov	ax,1119h
 21939 0000352E B81911                  	MOV	AX,(MultNET<<8)|25
 21940 00003531 CD2F                    	INT	2Fh
 21941 00003533 C3                      	retn
 21942                                  ;ENDIF
 21943                                  
 21944                                  TEST_RE_NET2:
 21945                                  	;test	word [es:di+43h],8000h
 21946                                  	; 17/12/2022
 21947                                  	;test	byte [es:di+44h],80h
 21948                                  	; 28/12/2022
 21949 00003534 26F6454480              	test	byte [ES:DI+curdir.flags+1],curdir_isnet>>8
 21950                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
 21951 00003539 7406                    	JZ	short LOCAL_SEARCH_FIRST
 21952                                  
 21953                                  ;IF NOT Installed
 21954                                  ;	transfer NET_SEARCH_FIRST
 21955                                  ;ELSE
 21956                                  	;mov	ax,111Bh
 21957 0000353B B81B11                  	MOV	AX,(MultNET<<8)|27
 21958 0000353E CD2F                    	INT	2FH
 21959 00003540 C3                      	retn
 21960                                  ;ENDIF
 21961                                  	; 18/05/2019 - Retro DOS v4.0
 21962                                  LOCAL_SEARCH_FIRST:
 21963 00003541 E89FE3                  	call	ECritDisk
 21964                                  	; MSDOS 6.0
 21965                                  	;;test	word [DOS34_FLAG],400h
 21966                                  	; 17/12/2022
 21967                                  	;test	byte [DOS34_FLAG+1],04h
 21968 00003544 F606[1206]04            	test	byte [DOS34_FLAG+1],(SEARCH_FASTOPEN>>8)
 21969                                  	;TEST	word [DOS34_FLAG],SEARCH_FASTOPEN ;AN000;
 21970 00003549 7405                    	JZ	short NOFN			;AN000;
 21971                                  	;or	byte [FastOpenFlg],1
 21972 0000354B 800E[4611]01            	OR	byte [FastOpenFlg],FastOpen_Set	;AN000;
 21973                                  NOFN:						;AN000;
 21974 00003550 C606[4C03]01            	MOV	byte [NoSetDir],1	; if we find a dir, don't change to it
 21975                                  
 21976                                  ; 03/02/2024
 21977                                  %if 0
 21978                                  	; MSDOS 6.0
 21979                                  	CALL	CHECK_QUESTION		;AN000;;FO. is '?' in path
 21980                                  	JNC	short norm_GETPATH	;AN000;;FO. no
 21981                                  %else
 21982                                  	; 03/02/2024
 21983 00003555 16                      	push	ss
 21984 00003556 1F                      	pop	ds			;AN000;;FO. ds:si -> final path
 21985 00003557 8B36[B205]              	mov	si,[WFP_START]		;AN000;;FO.
 21986                                  getnext:				;AN000;
 21987 0000355B AC                      	lodsb				;AN000;;FO. get char
 21988 0000355C 08C0                    	or	al,al			;AN000;;FO. is it null
 21989 0000355E 7409                    	jz	short NO_Question	;AN000;;FO. yes
 21990 00003560 3C3F                    	cmp	al,'?'                  ;AN000;;FO. is '?'
 21991 00003562 75F7                    	jne	short getnext 		;AN000;;FO. no
 21992                                  %endif
 21993                                  	;and	byte [FastOpenFlg],80h
 21994 00003564 8026[4611]80            	AND	byte [FastOpenFlg],Fast_yes ;AN000;;FO. reset fastopen
 21995                                  NO_Question:	; 03/02/2024
 21996                                  norm_GETPATH:
 21997 00003569 E8B715                  	call	GETPATH
 21998                                  	; BX = offset NAME1
 21999                                  ;_getdone:
 22000 0000356C 7318                    	JNC	short find_check_dev
 22001 0000356E 7511                    	JNZ	short bad_path3
 22002 00003570 08C9                    	OR	CL,CL
 22003 00003572 740D                    	JZ	short bad_path3
 22004                                  find_no_more:
 22005                                  	;mov	ax,12h
 22006 00003574 B81200                  	MOV	AX,error_no_more_files
 22007                                  BadBye:
 22008                                  	; MSDOS 6.0
 22009 00003577 368026[4611]80          	AND	byte [SS:FastOpenFlg],Fast_yes  ;AN000;;FO. reset fastopen
 22010                                  
 22011 0000357D F9                      	STC
 22012                                  	;call	LCritDisk
 22013                                  	;retn
 22014                                  	; 18/12/2022
 22015 0000357E E98FE3                  	jmp	LCritDisk
 22016                                  
 22017                                  bad_path3:
 22018                                  	;mov	ax,3
 22019 00003581 B80300                  	MOV	AX,error_path_not_found
 22020 00003584 EBF1                    	JMP	short BadBye
 22021                                  
 22022                                  find_check_dev:
 22023 00003586 08E4                    	OR	AH,AH
 22024 00003588 790A                    	JNS	short found_entry
 22025 0000358A C706[4803]FFFF          	MOV	word [LASTENT],-1	; Cause DOS_SEARCH_NEXT to fail
 22026 00003590 FE06[7005]              	INC	byte [FOUND_DEV]	; Tell DOS_RENAME we found a device
 22027                                  found_entry:
 22028                                  
 22029                                  ; We set the physical drive byte here Instead of after found_it; Doing
 22030                                  ; a search-next may not have wfp_start set correctly
 22031                                  
 22032 00003594 C43E[2C03]              	LES	DI,[DMAADD]
 22033 00003598 8B36[B205]              	MOV	SI,[WFP_START]		; get pointer to beginning
 22034 0000359C AC                      	LODSB
 22035 0000359D 2C40                    	SUB	AL,'A'-1                ; logical drive
 22036 0000359F AA                      	STOSB				; High bit not set (local)
 22037                                  found_it:
 22038 000035A0 C43E[2C03]              	LES	DI,[DMAADD]
 22039 000035A4 47                      	INC	DI
 22040                                  
 22041                                  	; MSDOS 6.0
 22042 000035A5 1E                      	PUSH	DS				  ;FO.;AN001; save ds
 22043                                  	;test	byte [FastOpenFlg],10h
 22044 000035A6 F606[4611]10            	TEST	byte [FastOpenFlg],Set_For_Search ;FO.;AN001; from fastopen
 22045 000035AB 7408                    	JZ	short notfast			  ;FO.;AN001;
 22046 000035AD 89DE                    	MOV	SI,BX				  ;FO.;AN001;
 22047 000035AF 8E1E[E405]              	MOV	DS,[CURBUF+2]			  ;FO.;AN001;
 22048 000035B3 EB03                    	JMP	SHORT movmov			  ;FO.;AN001;
 22049                                  
 22050                                  notfast:
 22051 000035B5 BE[4B05]                	MOV	SI,NAME1		; find_buf 2 = formatted name
 22052                                  movmov:
 22053                                  ; Special E5 code
 22054 000035B8 A4                      	MOVSB
 22055 000035B9 26807DFF05              	CMP	BYTE [ES:DI-1],5
 22056 000035BE 7505                    	JNZ	short NOTKANJB
 22057 000035C0 26C645FFE5              	MOV	BYTE [ES:DI-1],0E5H
 22058                                  NOTKANJB:
 22059                                  	;MOV	CX,10
 22060                                  	;REP	MOVSB
 22061                                  	; 03/02/2024
 22062 000035C5 B90500                  	mov	cx,5
 22063 000035C8 F3A5                    	rep	movsw
 22064                                  
 22065                                  	; 08/09/2018
 22066 000035CA 1F                      	POP	DS			;FO.;AN001; restore ds
 22067                                  
 22068 000035CB A0[6B05]                	MOV	AL,[ATTRIB]
 22069 000035CE AA                      	STOSB
 22070 000035CF 50                      	PUSH	AX			; Save AH device info
 22071 000035D0 A1[4803]                	MOV	AX,[LASTENT]
 22072 000035D3 AB                      	STOSW
 22073 000035D4 A1[C205]                	MOV	AX,[DIRSTART]
 22074 000035D7 AB                      	STOSW
 22075                                  
 22076                                  	; 03/02/2024 - Retro DOS v5.0
 22077                                  	; PCDOS 7.1 IBMDOS.COM
 22078                                  	;;;
 22079 000035D8 A1[DC0A]                	MOV	AX,[DIRSTART_HW]
 22080 000035DB AB                      	STOSW
 22081 000035DC 83C702                  	add	di,2
 22082                                  ; 4 bytes of 21 byte cont structure left for NET stuff
 22083                                  	;ADD	DI,4
 22084                                  	;;;
 22085                                  	
 22086 000035DF 58                      	POP	AX			; Recover AH device info
 22087 000035E0 08E4                    	OR	AH,AH
 22088 000035E2 781B                    	JS	short DOSREL		; Device entry is DOSGROUP relative
 22089 000035E4 833E[E205]FF            	CMP	WORD [CURBUF],-1
 22090 000035E9 7510                    	JNZ	short OKSTORE
 22091                                  
 22092                                  	; MSDOS 6.0
 22093 000035EB F606[4611]10            	TEST	byte [FastOpenFlg],Set_For_Search
 22094                                  					;AN000;;FO. from fastopen and is good
 22095 000035F0 7509                    	JNZ	short OKSTORE		;AN000;;FO.
 22096                                  
 22097                                  	; The user has specified the root directory itself, rather than some
 22098                                  	; contents of it. We can't "find" that.
 22099                                  
 22100 000035F2 26C745F8FFFF            	MOV	WORD [ES:DI-8],-1	; Cause DOS_SEARCH_NEXT to fail by
 22101                                  					;   stuffing a -1 at Lastent
 22102 000035F8 E979FF                  	JMP	find_no_more
 22103                                  
 22104                                  OKSTORE:
 22105 000035FB 8E1E[E405]              	MOV	DS,[CURBUF+2]
 22106                                  DOSREL:
 22107                                  	; BX = offset NAME1 (from GETPATH)
 22108 000035FF 89DE                    	MOV	SI,BX			; SI-> start of entry
 22109                                  
 22110                                  ; NOTE: DOS_RENAME depends on BX not being altered after this point
 22111                                  
 22112                                  	;;mov	cx,32
 22113                                  	;MOV	CX,dir_entry.size
 22114                                  	; 03/02/2024
 22115 00003601 B91000                  	mov	cx,dir_entry.size>>1
 22116                                  ;;;;; 7/29/86
 22117 00003604 89F8                    	MOV	AX,DI			; save the 1st byte addr
 22118                                  	;REP	MOVSB
 22119 00003606 F3A5                    	rep	movsw
 22120                                  	;
 22121 00003608 89C7                    	MOV	DI,AX			; restore 1st byte addr
 22122 0000360A 26803D05                	CMP	BYTE [ES:DI],05H	; special char check
 22123 0000360E 7504                    	JNZ	short NO05
 22124 00003610 26C605E5                	MOV	BYTE [ES:DI],0E5H	; convert it back to E5
 22125                                  NO05:
 22126                                  
 22127                                  ;;;;; 7/29/86
 22128                                  
 22129                                  ;hkn; FastOpenflg is in DOSDATA use SS
 22130                                  	; 16/12/2022
 22131                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 22132                                  	; MSDOS 6.0
 22133                                  	;AND	byte [SS:FastOpenFlg],Fast_yes ;AN000;;FO. reset fastopen
 22134                                  	; 18/05/2019 - Retro DOS v4.0
 22135 00003614 16                      	push	ss
 22136 00003615 1F                      	pop	ds
 22137                                  	; 16/12/2022
 22138 00003616 8026[4611]80            	AND	byte [FastOpenFlg],Fast_yes ; 80h
 22139                                  
 22140                                  ;hkn; SS is DOSDATA
 22141                                  	;push	ss
 22142                                  	;pop	ds
 22143 0000361B F8                      	CLC
 22144                                  	;call	LCritDisk
 22145                                  	;retn
 22146                                  	; 16/12/2022
 22147 0000361C E9F1E2                  	jmp	LCritDisk
 22148                                  
 22149                                  ;BREAK <DOS_SEARCH_NEXT - scan for subsequent matches>
 22150                                  ;----------------------------------------------------------------------------
 22151                                  ;
 22152                                  ; Procedure Name : DOS_SEARCH_NEXT
 22153                                  ;
 22154                                  ; Inputs:
 22155                                  ;	[DMAADD] Points to 53 byte buffer returned by DOS_SEARCH_FIRST
 22156                                  ;	    (only first 21 bytes must have valid information)
 22157                                  ; Function:
 22158                                  ;	Look for subsequent matches
 22159                                  ; Outputs:
 22160                                  ;	CARRY CLEAR
 22161                                  ;	    The 53 bytes at DMAADD are updated for next call
 22162                                  ;		(see DOS_SEARCH_FIRST)
 22163                                  ;	CARRY SET
 22164                                  ;	    AX = error code
 22165                                  ;		error_no_more_files
 22166                                  ;			No more files to find
 22167                                  ; DS preserved, others destroyed
 22168                                  ;---------------------------------------------------------------------------
 22169                                  
 22170                                  ;hkn; called from search.asm. DS already set up at this point.
 22171                                  
 22172                                  	; 03/02/2024 - Retro DOS v5.0
 22173                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:75ECh
 22174                                  
 22175                                  DOS_SEARCH_NEXT:
 22176 0000361F C43E[2C03]              	LES	DI,[DMAADD]	; 24/01/2024 (Retro DOS v5-v4)
 22177 00003623 268A05                  	MOV	AL,[ES:DI]
 22178 00003626 A880                    	TEST	AL,80H			; Test for NET
 22179 00003628 7406                    	JZ	short LOCAL_SEARCH_NEXT
 22180                                  ;IF NOT Installed
 22181                                  ;	transfer NET_SEARCH_NEXT
 22182                                  ;ELSE
 22183                                  	;mov	ax,111Ch
 22184 0000362A B81C11                  	MOV	AX,(MultNET<<8)|28
 22185 0000362D CD2F                    	INT	2FH  ; Multiplex - NETWORK REDIRECTOR - FINDNEXT
 22186                                  		     ; SS = DS = DOS CS, [DTA] = 21-byte findfirst search data
 22187                                  		     ; Return: CF set on error, AX = DOS error code
 22188                                  		     ; CF clear if successful
 22189 0000362F C3                      	retn
 22190                                  ;ENDIF
 22191                                  
 22192                                  LOCAL_SEARCH_NEXT:
 22193                                  	;AL is drive A=1
 22194                                  	;mov	byte [EXTERR_LOCUS],2
 22195 00003630 C606[2303]02            	MOV	byte [EXTERR_LOCUS],errLOC_Disk
 22196 00003635 E8ABE2                  	call	ECritDisk
 22197                                  
 22198                                  ;hkn; DummyCDS is in DOSDATA
 22199 00003638 C706[A205][F304]        	MOV     word [THISCDS],DUMMYCDS
 22200                                  ;hkn; Segment address is DOSDATA - use ds
 22201                                  ;hkn;	MOV     WORD [THISCDS+2],CS
 22202 0000363E 8C1E[A405]              	mov	[THISCDS+2],DS
 22203                                  
 22204 00003642 0440                    	ADD	AL,'A'-1
 22205 00003644 E8BC44                  	call	InitCDS
 22206                                  
 22207                                  ;	call	GETTHISDRV		; Set CDS pointer
 22208                                  
 22209 00003647 7253                    	JC	short No_files		; Bogus drive letter
 22210 00003649 C43E[A205]              	LES	DI,[THISCDS]		; Get CDS pointer
 22211                                  	;les	bp,[es:di+45h]
 22212 0000364D 26C46D45                	LES	BP,[ES:DI+curdir.devptr] ; Get DPB pointer
 22213 00003651 E80DD0                  	call	GOTDPB			; [THISDPB] = ES:BP
 22214                                  
 22215                                  	; 16/12/2022
 22216 00003654 268A4600                	mov	al,[ES:BP]
 22217                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 22218                                  	;mov	AL,[ES:BP+DPB.DRIVE] ; mov al,[ES:BP+0]
 22219 00003658 A2[7605]                	mov	[THISDRV],AL
 22220                                  	;mov	word [CREATING],0E500h
 22221 0000365B C706[7E05]00E5          	MOV	WORD [CREATING],(DIRFREE*256)+0
 22222 00003661 C606[4C03]01            	MOV	byte [NoSetDir],1	; if we find a dir, don't change to it
 22223 00003666 C536[2C03]              	LDS	SI,[DMAADD]
 22224 0000366A AC                      	LODSB				; Drive Byte
 22225                                  
 22226                                  	;entry	RENAME_NEXT		; Entry used by DOS_RENAME
 22227                                  RENAME_NEXT:
 22228                                  	;context ES
 22229 0000366B 16                      	push	ss
 22230 0000366C 07                      	pop	es			; THIS BLOWS ES:BP POINTER TO DPB
 22231                                  
 22232                                  ;hkn; NAME1 is in DOSDATA
 22233 0000366D BF[4B05]                	MOV	DI,NAME1
 22234                                  
 22235 00003670 B90B00                  	MOV	CX,11
 22236 00003673 F3A4                    	REP	MOVSB			; Search name
 22237 00003675 AC                      	LODSB				; Attribute
 22238                                  
 22239                                  ;hkn; SS override
 22240 00003676 36A2[6B05]              	MOV	[SS:ATTRIB],AL
 22241 0000367A AD                      	LODSW				; LastEnt
 22242 0000367B 09C0                    	OR	AX,AX
 22243                                  	; 03/02/2024
 22244                                  	;JNS	short cont_load
 22245 0000367D 781D                    	js	short No_files
 22246                                  ;No_files:
 22247                                  	;JMP	find_no_more
 22248                                  
 22249                                  cont_load:
 22250 0000367F 50                      	PUSH	AX			; Save LastEnt
 22251 00003680 AD                      	LODSW				; DirStart
 22252 00003681 89C3                    	MOV	BX,AX
 22253                                  
 22254                                  	;;;
 22255                                  	; 03/02/2024 - Retro DOS v5.0
 22256                                  	; (PCDOS 7.1 IBMDOS.COM)
 22257 00003683 AD                      	lodsw				; DIRSTART_HW
 22258                                  	;;;
 22259                                  
 22260                                  ;hkn; SS is DOSDATA
 22261                                  	;context DS
 22262 00003684 16                      	push	ss
 22263 00003685 1F                      	pop	ds
 22264 00003686 C42E[8A05]              	LES	BP,[THISDPB]		; Recover ES:BP
 22265                                  
 22266                                  	;;;
 22267                                  	; 03/02/2024 - Retro DOS v5.0
 22268                                  	; (PCDOS 7.1 IBMDOS.COM)
 22269                                  	
 22270                                  	;cmp	word [es:bp+0Fh],0
 22271 0000368A 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 22272 0000368F 7402                    	jz	short cont_load2 ; FAT32 fs
 22273 00003691 31C0                    	xor	ax,ax ; 0
 22274                                  cont_load2:
 22275 00003693 A3[EE0A]                	mov	[ROOTCLUST_HW],ax	; 0 or DIRSTART_HW
 22276                                  	;;;
 22277                                  
 22278                                  	;invoke	SetDirSrch
 22279 00003696 E8D212                  	call	SETDIRSRCH
 22280 00003699 7304                    	JNC	short SEARCH_GOON
 22281 0000369B 58                      	POP	AX			; Clean stack
 22282                                  	;JMP	short No_files
 22283                                  	; 03/02/2024
 22284                                  No_files:
 22285 0000369C E9D5FE                  	JMP	find_no_more
 22286                                  
 22287                                  SEARCH_GOON:
 22288 0000369F E82C17                  	call	STARTSRCH
 22289 000036A2 58                      	POP	AX			; Restore LastEnt
 22290 000036A3 E80812                  	call	GETENT
 22291 000036A6 72F4                    	JC	short No_files
 22292 000036A8 E8FC10                  	call	NEXTENT
 22293 000036AB 72EF                    	JC	short No_files
 22294 000036AD 30E4                    	XOR	AH,AH			; If Search_Next, can't be a DEV
 22295 000036AF E9EEFE                  	JMP	found_it ; 10/08/2018
 22296                                  
 22297                                  ; MSDOS 6.0
 22298                                  ;---------------------------------------------------------------------------
 22299                                  ;
 22300                                  ; Procedure Name : CHECK_QUESTION
 22301                                  ;
 22302                                  ; Input: [WFP_START]= pointer to final path
 22303                                  ; Function: check '?' char
 22304                                  ; Output: carry clear, if no '?'
 22305                                  ;	 carry set, if '?' exists
 22306                                  ;---------------------------------------------------------------------------
 22307                                  
 22308                                  ; 03/02/2024
 22309                                  %if 0
 22310                                  	; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 22311                                  CHECK_QUESTION:
 22312                                  ;hkn;	wfp_start is in DOSDATA;hkn;	MOV	WORD PTR ThisCDS+2,CS
 22313                                  ;hkn;	PUSH	CS			;AN000;;FO.
 22314                                  	push	ss
 22315                                  	POP	DS			;AN000;;FO. ds:si -> final path
 22316                                  	; 16/12/2022
 22317                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 22318                                  	MOV	SI,[WFP_START]		;AN000;;FO.
 22319                                  	;mov	si,[ss:WFP_START]
 22320                                  getnext:				;AN000;
 22321                                  	LODSB				;AN000;;FO. get char
 22322                                  	OR	AL,AL			;AN000;;FO. is it null
 22323                                  	JZ	short NO_Question	;AN000;;FO. yes
 22324                                  	CMP	AL,'?'                  ;AN000;;FO. is '?'
 22325                                  	JNZ	short getnext 		;AN000;;FO. no
 22326                                  	STC				;AN000;;FO.
 22327                                  NO_Question:				;AN000;
 22328                                  	retn				;AN000;;FO.
 22329                                  %endif
 22330                                  
 22331                                  ;============================================================================
 22332                                  ; ABORT.ASM, MSDOS 6.0, 1991
 22333                                  ;============================================================================
 22334                                  ; 23/07/2018 - Retro DOS v3.0
 22335                                  ; 18/05/2019 - Retro DOS v4.0
 22336                                  
 22337                                  ;**
 22338                                  ;
 22339                                  ; Internal Abort call closes all handles and FCBs associated with a process.
 22340                                  ;  If process has NET resources a close all is sent out over the net.
 22341                                  ;
 22342                                  ;   DOS_ABORT
 22343                                  ;
 22344                                  ;   Modification history:
 22345                                  ;
 22346                                  ;       Created: ARR 30 March 1983
 22347                                  ;
 22348                                  ;	M038	SR	10/16/90	Free SFT with the PSP of the process
 22349                                  ;				being terminated only if it is busy.
 22350                                  ;
 22351                                  
 22352                                  ;Break   <DOS_ABORT -- CLOSE all files for process>
 22353                                  ;--------------------------------------------------------------------------
 22354                                  ;
 22355                                  ; Procedure Name : DOS_ABORT
 22356                                  ;
 22357                                  ; Inputs:
 22358                                  ;       [CurrentPDB] set to PID of process aborting
 22359                                  ; Function:
 22360                                  ;       Close all files and free all SFTs for this PID
 22361                                  ; Returns:
 22362                                  ;       None
 22363                                  ; All destroyed except stack
 22364                                  ;---------------------------------------------------------------------------
 22365                                  
 22366                                  	; 03/02/2024 - Retro DOS v5.0
 22367                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:7685h
 22368                                  	; (Win ME IO.SYS - BIOSCODE:74F4h) 
 22369                                  
 22370                                  DOS_ABORT:
 22371 000036B2 368E06[3003]            	MOV     ES,[SS:CurrentPDB]	; SS override
 22372 000036B7 268B0E3200              	MOV     CX,[ES:PDB.JFN_Length]  ; Number of JFNs
 22373                                  reset_free_jfn:
 22374 000036BC 89CB                    	MOV     BX,CX
 22375 000036BE 51                      	PUSH    CX
 22376 000036BF 4B                      	DEC     BX                      ; get jfn (start with last one)
 22377                                  
 22378 000036C0 E8D740                  	CALL	_$CLOSE
 22379 000036C3 59                      	POP     CX
 22380 000036C4 E2F6                    	LOOP    reset_free_jfn          ; and do 'em all
 22381                                  
 22382                                  ; Note: We do need to explicitly close FCBs. Reasons are as follows: If we
 22383                                  ; are running in the no-sharing no-network environment, we are simulating the
 22384                                  ; 2.0 world and thus if the user doesn't close the file, that is his problem
 22385                                  ; BUT... the cache remains in a state with garbage that may be reused by the
 22386                                  ; next process. We scan the set and blast the ref counts of the FCBs we own.
 22387                                  ;
 22388                                  ; If sharing is loaded, then the following call to close process will
 22389                                  ; correctly close all FCBs. We will then need to walk the list AFTER here.
 22390                                  ;
 22391                                  ; Finally, the following call to NET_Abort will cause an EOP to be sent to all
 22392                                  ; known network resources. These resources are then responsible for cleaning
 22393                                  ; up after this process.
 22394                                  ;
 22395                                  ; Sleazy, eh?
 22396                                  
 22397                                  	;context DS			; SS is DOSDATA
 22398 000036C6 16                      	push	ss
 22399 000036C7 1F                      	pop	ds  ; 09/09/2018
 22400                                  
 22401                                  	;CallInstall Net_Abort, MultNET, 29
 22402 000036C8 B81D11                  	mov	ax,111Dh
 22403 000036CB CD2F                    	int     2Fh 	; Multiplex - NETWORK REDIRECTOR 
 22404                                  			;	    - CLOSE ALL REMOTE FILES FOR PROCESS
 22405                                  			; DS???, SS = DOS CS
 22406                                  ;if installed
 22407 000036CD FF1E[A000]              	call	far [JShare+(4*4)]	; 4 = MFTCloseP
 22408                                  ;else
 22409                                  ;	call 	MFTCloseP
 22410                                  ;endif
 22411                                  
 22412                                  ; Scan the FCB cache for guys that belong to this process and zap their ref
 22413                                  ; counts.
 22414                                  					; SS override
 22415 000036D1 36C43E[4000]            	les     di,[ss:SFTFCB]		; grab the pointer to the table
 22416                                  
 22417                                  	;;;
 22418                                  	; 03/02/2024 - Retro DOS v5.0
 22419                                  	; PCDOS 7.1 IBMDOS.COM
 22420                                  SFTFCB_check:
 22421 000036D6 8CC1                    	mov	cx,es
 22422 000036D8 09F9                    	or	cx,di
 22423 000036DA E31C                    	jcxz	FCBScanDone
 22424 000036DC 57                      	push	di
 22425                                  SFTFCB_OK:
 22426                                  	;;;
 22427                                  	;mov	cx,[es:di+4]
 22428 000036DD 268B4D04                	mov     cx,[es:di+SFT.SFCount]
 22429 000036E1 E315                    	jcxz    FCBScanDone
 22430                                  	;lea	di,[di+6]
 22431 000036E3 8D7D06                  	LEA     DI,[DI+SFT.SFTable]	; point at table
 22432 000036E6 36A1[3C03]              	mov     ax,[SS:PROC_ID]		; SS override
 22433                                  FCBTest:
 22434                                  	;cmp	[es:di+31h],ax
 22435 000036EA 26394531                	cmp	[es:di+SF_ENTRY.sf_PID],ax ; is this one of ours
 22436 000036EE 7503                    	jnz	short FCBNext		; no, skip it
 22437                                  
 22438                                  ; 03/02/2024 - Retro DOS v5.0
 22439                                  %if 0
 22440                                  	mov	word [es:di],0
 22441                                  	;mov	word [es:di+SF_ENTRY.sf_ref_count],0 ; yes, blast ref count
 22442                                  %else
 22443                                  	; 03/02/2024
 22444                                  	; PCDOS 7.1 IBMDOS.COM
 22445 000036F0 E80814                  	call    SFT_FREE
 22446                                  %endif
 22447                                  
 22448                                  FCBNext:
 22449 000036F3 83C73B                  	add     di,SF_ENTRY.size ; 59 (for MSDOS 6.0)
 22450 000036F6 E2F2                    	loop    FCBTest
 22451                                  FCBScanDone:
 22452                                  
 22453                                  ; Walk the SFT to eliminate all busy SFT's for this process.
 22454                                  
 22455 000036F8 31DB                    	XOR     BX,BX
 22456                                  Scan:
 22457 000036FA 53                      	push    bx
 22458 000036FB E81840                  	call	SFFromSFN
 22459 000036FE 5B                      	pop     bx
 22460                                  	;jnc	short Scan1
 22461                                  	;retn
 22462                                  
 22463                                  	; 18/12/2022
 22464                                  	;jc	short NO_Question ; retn
 22465                                  	; 03/02/2024
 22466 000036FF 7232                    	jc	short RET2
 22467                                  
 22468                                  ;M038
 22469                                  ; Do what the comment above says, check for busy state
 22470                                  
 22471                                  Scan1:
 22472                                  	;cmp	word [es:di],0
 22473                                  	;jz	short scan_next  ; MSDOS 3.3
 22474                                  	; MSDOS 6.0
 22475 00003701 26833DFF                	cmp	word [es:di],sf_busy ; -1
 22476                                  	;cmp	word [es:di+SF_ENTRY.sf_ref_count],sf_busy
 22477                                  				; Is Sft busy? ;M038
 22478 00003705 7517                    	jnz	short scan_next ; no
 22479                                  ;
 22480                                  ; we have a SFT that is busy. See if it is for the current process
 22481                                  ;
 22482 00003707 36A1[3C03]              	mov     ax,[SS:PROC_ID]		; SS override
 22483                                  	;cmp	[es:di+31h],ax
 22484 0000370B 26394531                	cmp	[es:di+SF_ENTRY.sf_PID],ax
 22485 0000370F 750D                    	jnz	short scan_next
 22486 00003711 36A1[3E03]              	mov     ax,[SS:USER_ID]		; SS override
 22487                                  	;sub	ax,[es:di+2Fh] ; PCDOS 7.1 IBMDOS.COM ; 03/02/2024
 22488                                  	;cmp	[es:di+2Fh],ax
 22489 00003715 2639452F                	cmp	[es:di+SF_ENTRY.sf_UID],ax
 22490 00003719 7503                    	jnz	short scan_next
 22491                                  
 22492                                  ; This SFT is labelled as ours.
 22493                                  
 22494                                  ; 03/02/2024 - Retro DOS v5.0
 22495                                  %if 0
 22496                                  	mov	word [es:di],0
 22497                                  	;mov	word [es:di+SF_ENTRY.sf_ref_count],0
 22498                                  %else
 22499                                  	; 03/02/2024
 22500                                  	; PCDOS 7.1 IBMDOS.COM
 22501 0000371B E8DD13                  	call    SFT_FREE
 22502                                  %endif
 22503                                  
 22504                                  scan_next:
 22505 0000371E 43                      	inc     bx
 22506 0000371F EBD9                    	jmp     short Scan
 22507                                  
 22508                                  ;============================================================================
 22509                                  ; CLOSE.ASM, MSDOS 6.0, 1991
 22510                                  ;============================================================================
 22511                                  ; 23/07/2018 - Retro DOS v3.0
 22512                                  ; 18/05/2019 - Retro DOS v4.0
 22513                                  
 22514                                  ;**	Internal Close and Commit calls to close a local or NET SFT.
 22515                                  ;
 22516                                  ;	DOS_CLOSE
 22517                                  ;	DOS_COMMIT
 22518                                  ;	FREE_SFT
 22519                                  ;	SetSFTTimes
 22520                                  ;
 22521                                  ;	Revision history:
 22522                                  ;
 22523                                  ;	   AN000  version 4.00	Jan. 1988
 22524                                  ;	   A005   PTM 3718 --- lost clusters when fastopen installed
 22525                                  ;	   A011   PTM 4766 --- C2 fastopen problem
 22526                                  
 22527                                  ;Installed = TRUE
 22528                                  
 22529                                  ;Break <DOS_CLOSE -- CLOSE FILE from SFT>
 22530                                  ;---------------------------------------------------------------------------
 22531                                  ;
 22532                                  ; Procedure Name : DOS_CLOSE
 22533                                  ;
 22534                                  ; Inputs:
 22535                                  ;	[THISSFT] set to the SFT for the file being used
 22536                                  ; Function:
 22537                                  ;	Close the indicated file via the SFT
 22538                                  ; Returns:
 22539                                  ;	sf_ref_count decremented otherwise
 22540                                  ;	ES:DI point to SFT
 22541                                  ;	Carry set if error
 22542                                  ;	    AX has error code
 22543                                  ; DS preserved, others destroyed
 22544                                  ;---------------------------------------------------------------------------
 22545                                  
 22546                                  ;hkn; DOS_CLOSE called from fcbio.asm and handle.asm. DS alreday set up.
 22547                                  
 22548                                  ; 18/05/2019 - Retro DOS v4.0
 22549                                  ; DOSCODE:6E2Eh (MSDOS 6.21, MSDOS.SYS)
 22550                                  
 22551                                  ; 14/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 22552                                  ; DOSCODE:6E1Ah (MSDOS 5.0, MSDOS.SYS)
 22553                                  
 22554                                  ; 23/07/2018 - IBMDOS.COM (MSDOS 3.3), 1987 - Offset 39D0h
 22555                                  
 22556                                  	; 03/02/2024 - Retro DOS v5.0
 22557                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:76FEh
 22558                                  	; (Win ME IO.SYS - BIOSCODE:7579h) 
 22559                                  
 22560                                  DOS_CLOSE:
 22561 00003721 C43E[9E05]              	LES	DI,[THISSFT]
 22562                                  	;mov	bx,[ES:DI+5]
 22563 00003725 268B5D05                	MOV	BX,[ES:DI+SF_ENTRY.sf_flags]
 22564                                  
 22565                                  ; Network closes are handled entirely by the net code.
 22566                                  
 22567                                  	;;test	bx,8000h
 22568                                  	;TEST	BX,sf_isnet
 22569                                  	; 17/12/2022
 22570                                  	;test	bh,80h
 22571 00003729 F6C780                  	test	bh,(sf_isnet>>8)
 22572 0000372C 7406                    	JZ	short LocalClose
 22573                                  
 22574                                  	;CallInstall Net_Close,MultNET,6
 22575 0000372E B80611                  	mov     ax,1106h
 22576 00003731 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - CLOSE REMOTE FILE
 22577                                  			; ES:DI -> SFT
 22578                                  			; SFT DPB field -> DPB of drive containing file
 22579                                  			; Return: CF set on error, AX = DOS error code
 22580                                  			; CF clear if successful
 22581                                  RET2:		; 03/02/2024
 22582 00003733 C3                      	retn
 22583                                  
 22584                                  ; All closes release the sharing information.
 22585                                  ; No commit releases sharing information
 22586                                  ;
 22587                                  ; All closes decrement the ref count.
 22588                                  ; No commit decrements the ref count.
 22589                                  
 22590                                  LocalClose:
 22591 00003734 E8ACE1                  	call	ECritDisk
 22592 00003737 E8C901                  	CALL	SetSFTTimes
 22593 0000373A E84C01                  	CALL	FREE_SFT		; dec ref count or mark as busy
 22594                                  
 22595                                  ;hkn; SS is DOSDATA
 22596                                  	;Context DS
 22597 0000373D 16                      	push	ss
 22598 0000373E 1F                      	pop	ds
 22599                                  
 22600 0000373F 50                      	push	ax
 22601 00003740 53                      	push	bx
 22602 00003741 E8744D                  	call	ShareEnd
 22603 00003744 5B                      	pop	bx
 22604 00003745 58                      	pop	ax
 22605                                  
 22606                                  ; Commit enters here. AX from commit MUST be <> 1, BX is flags word
 22607                                  
 22608                                  CloseEntry:
 22609 00003746 50                      	PUSH	AX
 22610                                  
 22611                                  ; File clean or device does not get stamped nor disk looked at.
 22612                                  
 22613                                  	;test	bx,0C0h
 22614                                  	; 17/12/2022
 22615 00003747 F6C3C0                  	test	bl,devid_file_clean+devid_device
 22616                                  	;TEST	BX,devid_file_clean+devid_device
 22617 0000374A 7403                    	JZ	short rdir
 22618                                  	; 14/11/2022
 22619 0000374C E90101                  	JMP	FREE_SFT_OK		; either clean or device
 22620                                  	;jnz	short FREE_SFT_OK ; 24/07/2019	
 22621                                  
 22622                                  ; Retrieve the directory entry for the file
 22623                                  
 22624                                  rdir:
 22625 0000374F E84401                  	CALL	DirFromSFT
 22626                                  	;mov	al,5
 22627 00003752 B005                    	MOV	AL,error_access_denied
 22628                                  	
 22629                                  	; 03/02/2024
 22630                                  	;JNC	short clook
 22631                                  	;; 14/11/2022
 22632                                  	;JMP	CloseFinish		; pretend the close worked.
 22633                                  	;;jc	short CloseFinish ; 24/07/2019
 22634                                  	
 22635                                  	;;;
 22636                                  	; 03/02/2024 - Retro DOS v5.0
 22637                                  	; (PCDOS 7.1 IBMDOS.COM)
 22638 00003754 7240                    	jc	short jmp_to_CloseFinish ; pretend the close worked.
 22639                                  rdir2:
 22640                                  	;test	word [si+2],4
 22641 00003756 F6440204                	test	byte [si+SF_ENTRY.sf_mode],4 ; devid_device_null
 22642                                  					; bit 2 - null device
 22643 0000375A 751F                    	jnz	short clook
 22644                                  
 22645 0000375C 1E                      	push	ds
 22646 0000375D 53                      	push	bx
 22647 0000375E C55C07                  	lds	bx,[si+7]
 22648 00003761 C55C07                  	lds	bx,[si+SF_ENTRY.sf_devptr] ; pointer to DPB
 22649                                  
 22650 00003764 8A1F                    	mov	bl,[bx]			; DPB.DRIVE
 22651 00003766 30FF                    	xor	bh,bh  ; 0
 22652 00003768 36F687[0813]04          	test	byte [ss:bx+drive_flags],4
 22653                                  					; bit 2 - last access date/time flag?
 22654                                  					; or disk accessed flag !?
 22655 0000376E 5B                       	pop	bx
 22656 0000376F 7409                    	jz	short skip_upd_laccdt	; no support for last access date&time
 22657 00003771 1F                      	pop	ds
 22658 00003772 1E                      	push	ds
 22659 00003773 E8E6D3                  	call	DATE16
 22660                                  	;mov	[es:di+12h],ax
 22661 00003776 26894512                	mov	[es:di+dir_entry.dir_lstaccdate],ax
 22662                                  skip_upd_laccdt:
 22663 0000377A 1F                      	pop	ds
 22664                                  	;;;
 22665                                  
 22666                                  clook:
 22667                                  
 22668                                  ; ES:DI points to entry
 22669                                  ; DS:SI points to SFT
 22670                                  ; ES:BX points to buffer header
 22671                                  
 22672 0000377B 57                      	push	di
 22673 0000377C 56                      	push	si
 22674                                  	;lea	si,[si+20h]
 22675 0000377D 8D7420                  	LEA	SI,[SI+SF_ENTRY.sf_name]
 22676                                  
 22677                                  ; ES:DI point to directory entry
 22678                                  ; DS:SI point to unpacked name
 22679                                  
 22680 00003780 E852E0                  	call	XCHGP
 22681                                  
 22682                                  ; ES:DI point to unpacked name
 22683                                  ; DS:SI point to directory entry
 22684                                  
 22685 00003783 E89F10                  	call	MetaCompare
 22686 00003786 E84CE0                  	call	XCHGP
 22687 00003789 5E                      	pop	si
 22688 0000378A 5F                      	pop	di
 22689 0000378B 740C                    	JZ	short CLOSE_GO		; Name OK
 22690                                  Bye:	
 22691 0000378D 89F7                    	MOV	DI,SI
 22692 0000378F 1E                      	PUSH	DS
 22693 00003790 07                      	POP	ES			; ES:DI points to SFT
 22694 00003791 16                      	PUSH	SS
 22695 00003792 1F                      	POP	DS
 22696 00003793 F9                      	STC
 22697                                  	;mov	al,2
 22698 00003794 B002                    	MOV	AL,error_file_not_found
 22699                                  	
 22700                                  jmp_to_CloseFinish: ; 03/02/2024
 22701                                  	;JMP	CloseFinish ; 24/07/2019
 22702                                  	; 03/02/2024
 22703                                  	; (PCDOS 7.1 IBMDOS.COM)
 22704 00003796 E9DF00                  	jmp	CloseFinish2
 22705                                  
 22706                                  	; 18/05/2019 - Retro DOS v4.0
 22707                                  CLOSE_GO:
 22708                                  	; 03/02/2024
 22709                                  	;mov	al,[si+4]
 22710 00003799 8A4404                  	mov	al,[si+SF_ENTRY.sf_attr]
 22711                                  	
 22712                                  	; MSDOS 6.0
 22713                                  	;test	word [si+2],8000h
 22714                                  	;TEST	word [SI+SF_ENTRY.sf_mode],sf_isFCB ; FCB ?
 22715                                  	; 17/12/2022
 22716                                  	;test	byte [si+3],80h
 22717 0000379C F6440380                	test	byte [SI+SF_ENTRY.sf_mode+1],(sf_isFCB>>8) ; FCB ?
 22718 000037A0 740A                    	JZ	short nofcb		; no, set dir attr, sf_attr
 22719                                  	; MSDOS 3.3 & MSDOS 6.0
 22720                                  	;mov	ch,[es:di+0Bh]
 22721 000037A2 268A6D0B                	MOV	CH,[ES:DI+dir_entry.dir_attr]
 22722                                  
 22723                                  	; 03/02/2024
 22724                                  	;;mov	al,[si+4]
 22725                                  	;MOV	AL,[SI+SF_ENTRY.sf_attr]
 22726                                  
 22727                                  ;hkn; SS override
 22728 000037A6 36A2[6B05]              	MOV	[SS:ATTRIB],AL
 22729                                  	; MSDOS 3.3
 22730                                  	;;call	MatchAttributes
 22731                                  	;;JNZ	short Bye		; attributes do not match
 22732                                  	; 18/05/2019
 22733 000037AA EB04                    	JMP	SHORT setattr		;FT.
 22734                                  nofcb:
 22735                                  	; 03/02/2024
 22736                                  	; MSDOS 6.0
 22737                                  	;;mov	al,[si+4]
 22738                                  	;MOV	AL,[SI+SF_ENTRY.sf_attr] ;FT.		;AN000;
 22739                                  
 22740 000037AC 2688450B                	MOV	[ES:DI+dir_entry.dir_attr],AL ;FT.	;AN000;
 22741                                  setattr:
 22742                                  	; MSDOS 3.3 (& MSDOS 6.0)
 22743                                  	;or	byte [es:di+0Bh],20h
 22744 000037B0 26804D0B20              	OR	BYTE [ES:DI+dir_entry.dir_attr],attr_archive ;Set archive
 22745                                  	; MSDOS 6.0
 22746                                  	;mov	ax,[es:di+1Ah]
 22747 000037B5 268B451A                	MOV	AX,[ES:DI+dir_entry.dir_first] ;AN011
 22748                                  					;F.O. save old first cluster
 22749                                  ;hkn; SS override
 22750 000037B9 36A3[BD0E]              	MOV	[SS:OLD_FIRSTCLUS],AX	;AN011;F.O. save old first cluster
 22751                                  
 22752                                  	;;;
 22753                                  	; 03/02/2024
 22754                                  	; PCDOS 7.1 IBMDOS.COM
 22755                                  	;mov	ax,[es:di+14h]
 22756 000037BD 268B4514                	mov	ax,[ES:DI+dir_entry.dir_fclus_hi] ; old first cluster, hw
 22757 000037C1 36A3[BD0E]              	MOV	[ss:OLD_FIRSTCLUS],ax
 22758                                  	;;;
 22759                                  
 22760                                  	;;mov	ax,[si+0Bh]
 22761                                  	;MOV	AX,[SI+SF_ENTRY.sf_firclus]
 22762                                  	;;;
 22763                                  	; 03/02/2024
 22764                                  	; PCDOS 7.1 IBMDOS.COM
 22765 000037C5 8B442B                  	mov     ax,[si+2Bh]	; mov ax,[si+SF_ENTRY.sf_chain]
 22766                                  				; first cluster (32 bit) low word !
 22767                                  	;;;	
 22768                                  	;mov	[es:di+1Ah],ax
 22769 000037C8 2689451A                	MOV	[ES:DI+dir_entry.dir_first],AX	;Set firclus pointer
 22770                                  	;;; 03/02/2024
 22771 000037CC 8B442D                  	mov     ax,[si+2Dh]	; mov ax,[si+SF_ENTRY.sf_chain+2]
 22772                                  				; first cluster (32 bit) high word !
 22773                                  	;mov	[es:di+14h],ax
 22774 000037CF 26894514                	mov	[es:di+dir_entry.dir_fclus_hi],ax
 22775                                  	;;;
 22776                                  
 22777                                  ; 03/02/2024
 22778                                  %if 0
 22779                                  	;mov	ax,[si+11h]
 22780                                  	MOV	AX,[SI+SF_ENTRY.sf_size]
 22781                                  	;mov	[es:di+1Ch],ax
 22782                                  	MOV	[ES:DI+dir_entry.dir_size_l],AX	;Set size
 22783                                  	;mov	ax,[si+13h]
 22784                                  	MOV	AX,[SI+SF_ENTRY.sf_size+2]
 22785                                  	;mov	[es:di+1Eh],ax
 22786                                  	MOV	[ES:DI+dir_entry.dir_size_h],AX
 22787                                  	;mov	ax,[si+0Fh]
 22788                                  	MOV	AX,[SI+SF_ENTRY.sf_date]
 22789                                  	;mov	[es:di+18h],ax
 22790                                  	MOV	[ES:DI+dir_entry.dir_date],AX	;Set date
 22791                                  	;mov	ax,[si+0Dh]
 22792                                  	MOV	AX,[SI+SF_ENTRY.sf_time]
 22793                                  	;mov	[es:di+16h],ax
 22794                                  	MOV	[ES:DI+dir_entry.dir_time],AX	;Set time
 22795                                  %else
 22796                                  	; 03/02/2024 - Retro DOS v5.0
 22797 000037D3 56                      	push	si
 22798 000037D4 83C60D                  	add	si,0Dh
 22799 000037D7 AD                      	lodsw	; [si+SF_ENTRY.sf_time]
 22800 000037D8 26894516                	mov	[es:di+dir_entry.dir_time],ax	; Set time
 22801 000037DC AD                      	lodsw	; [si+SF_ENTRY.sf_date]
 22802 000037DD 26894518                	mov	[es:di+dir_entry.dir_date],ax	; Set date
 22803 000037E1 AD                      	lodsw	; [si+SF_ENTRY.sf_size]
 22804 000037E2 2689451C                	mov	[es:di+dir_entry.dir_size_l],ax	; Set size
 22805 000037E6 AD                      	lodsw	; [si+SF_ENTRY.sf_size+2]
 22806 000037E7 2689451E                	mov	[es:di+dir_entry.dir_size_h],ax
 22807 000037EB 5E                      	pop	si
 22808                                  %endif
 22809                                  
 22810                                  	; MSDOS 6.0
 22811                                  ;; File Tagging
 22812 000037EC 26F6470540              	TEST	byte [ES:BX+BUFFINFO.buf_flags],buf_dirty
 22813                                  				  ;LB. if already dirty		    ;AN000;
 22814 000037F1 7508                    	JNZ	short yesdirty4	  ;LB.  don't increment dirty count ;AN000;
 22815                                  	; 02/06/2019
 22816 000037F3 E80134                  	call	INC_DIRTY_COUNT   ;LB.				    ;AN000;
 22817                                  	; MSDOS 3.3 (& MSDOS 6.0)
 22818                                  	;or	byte [es:bx+5],40h
 22819 000037F6 26804F0540              	OR	byte [ES:BX+BUFFINFO.buf_flags],buf_dirty ;Buffer dirty
 22820                                  yesdirty4:
 22821 000037FB 1E                      	push	ds
 22822 000037FC 56                      	push	si
 22823                                  
 22824                                  ; 03/02/2024
 22825                                  %if 0
 22826                                  	; MSDOS 6.0
 22827                                  	;mov	cx,[si+0Bh]
 22828                                  	; 07/12/2022
 22829                                  	MOV	CX,[SI+SF_ENTRY.sf_firclus] ; do this for Fastopen
 22830                                  %else
 22831                                  	; 03/02/2024
 22832                                  	; PCDOS 7.1
 22833 000037FD 8B4C2B                  	mov	cx,[si+2Bh]		; [es:di+SF_ENTRY.sf_chain]
 22834                                  					; first cluster (32 bit) low word !?
 22835                                  %endif
 22836                                  
 22837                                  ;hkn; SS override
 22838 00003800 36A0[7605]              	MOV	AL,[SS:THISDRV]
 22839                                  	; MSDOS 3.3 
 22840                                  	;push	ss
 22841                                  	;pop	ds
 22842                                  	;MOV	AL,[THISDRV]
 22843                                  ;;; 10/1/86  update fastopen cache
 22844                                  	; MSDOS 3.3 & MSDOS 6.0
 22845 00003804 52                      	PUSH	DX
 22846 00003805 B400                    	MOV	AH,0			; dir entry update
 22847 00003807 88C2                    	MOV	DL,AL			; drive number A=0, B=1,,,
 22848                                  	;;;
 22849                                  	; 03/02/2024 - Retro DOS v5.0
 22850                                  	; PCDOS 7.1
 22851 00003809 53                      	push	bx ; *
 22852 0000380A 8B5C2D                  	mov	bx,[si+2Dh]		; [es:di+SF_ENTRY.sf_chain+2]
 22853                                  					; first cluster (32 bit) high word !?
 22854 0000380D 09DB                    	or	bx,bx
 22855 0000380F 7511                    	jnz	short do_update2
 22856                                  	;;;
 22857                                  	; MSDOS 6.0
 22858 00003811 09C9                    	OR	CX,CX			;AN005; first cluster 0; may be truncated
 22859 00003813 750D                    	JNZ	short do_update2	;AN005; no, do update
 22860 00003815 B403                    	MOV	AH,3			;AN005; do a delete cache entry
 22861                                  	;mov	di,[si+1Bh]
 22862 00003817 8B7C1B                  	MOV	DI,[SI+SF_ENTRY.sf_dirsec] ;AN005; cx:di = dir sector
 22863                                  	;mov	cx,[si+1Dh]
 22864 0000381A 8B4C1D                  	MOV	CX,[SI+SF_ENTRY.sf_dirsec+2] ;AN005;
 22865                                  	;mov	dh,[si+1Fh]
 22866 0000381D 8A741F                  	MOV	DH,[SI+SF_ENTRY.sf_dirpos] ;AN005; dh = dir pos
 22867 00003820 EB1A                    	JMP	SHORT do_update 	;AN011;F.O.
 22868                                  
 22869                                  do_update2:				;AN011;F.O.
 22870                                  	;;;
 22871                                  	; 03/02/2024
 22872                                  	; PCDOS 7.1
 22873 00003822 363B1E[3A11]            	cmp	bx,[ss:OLD_FIRSTCLUS_HW] ; same as old first cluster?
 22874 00003827 7507                    	jnz	short do_update3 ; no
 22875                                  	;;;
 22876                                  
 22877                                  ;hkn; SS override fort OLD_FIRSTCLUS
 22878                                  	; 
 22879 00003829 363B0E[BD0E]            	CMP	CX,[SS:OLD_FIRSTCLUS]	;AN011;F.O. same as old first cluster?
 22880 0000382E 740C                    	JZ	short do_update		;AN011;F.O. yes
 22881                                  do_update3:	; 03/02/2024
 22882 00003830 B402                    	MOV	AH,2			;AN011;F.O. delete the old entry
 22883 00003832 368B0E[BD0E]            	MOV	CX,[SS:OLD_FIRSTCLUS]	;AN011;F.O.
 22884                                  	;;;
 22885                                  	; 03/02/2024
 22886                                  	; PCDOS 7.1
 22887 00003837 368B1E[3A11]            	mov	bx,[ss:OLD_FIRSTCLUS_HW]
 22888                                  	;;; 
 22889                                  do_update:				;AN005;
 22890                                  ;hkn; SS is DOSDATA
 22891                                  	;Context DS
 22892 0000383C 16                      	push	ss
 22893 0000383D 1F                      	pop	ds
 22894                                  	;;;
 22895                                  	; 03/02/2024 - Retro DOS v5.0
 22896 0000383E 87DE                    	xchg	bx,si	; PCDOS 7.1 IBMDOS.COM
 22897                                  	;;;
 22898                                  	; MSDOS 3.3 & MSDOS 6.0
 22899 00003840 E825F5                  	call	FastOpen_Update 	; invoke fastopen
 22900                                  	;;;
 22901                                  	; 03/02/2024
 22902 00003843 87DE                    	xchg	bx,si	; PCDOS 7.1 IBMDOS.COM
 22903 00003845 5B                      	pop	bx ; *
 22904                                  	;;;
 22905 00003846 5A                      	POP	DX
 22906                                  
 22907                                  ;;; 10/1/86  update fastopen cache
 22908 00003847 E87B32                  	call	FLUSHBUF		; flush all relevant buffers
 22909 0000384A 5F                      	pop	di
 22910 0000384B 07                      	pop	es
 22911                                  	;mov	al,5
 22912 0000384C B005                    	MOV	AL,error_access_denied
 22913 0000384E 7215                    	JC	short CloseFinish
 22914                                  FREE_SFT_OK:
 22915                                  	; 03/02/2024
 22916                                  	;CLC				; signal no error.
 22917                                  	
 22918                                  	;;;
 22919                                  	; 03/02/2024 - Retro DOS v5.0
 22920                                  	; PCDOS 7.1 IBMDOS.COM
 22921                                  	;test	word [es:di+5],8080h
 22922 00003850 26F745058080            	test	word [es:di+SF_ENTRY.sf_flags],sf_isnet+devid_device
 22923 00003856 7520                    	jnz	short CloseFinish2
 22924 00003858 06                      	push	es
 22925 00003859 55                      	push	bp
 22926                                  	;les	bp,[es:di+7]
 22927 0000385A 26C46D07                	les	bp,[es:di+SF_ENTRY.sf_devptr] ; DPB
 22928 0000385E E80CFC                  	call	update_fat32_fsinfo
 22929 00003861 5D                      	pop	bp
 22930 00003862 07                      	pop	es
 22931 00003863 EB13                    	jmp	short CloseFinish2
 22932                                  	
 22933                                  CloseFinish:	; 03/02/2024 - Retro DOS v5.0
 22934 00003865 1E                      	push    ds
 22935 00003866 53                      	push    bx
 22936 00003867 26C55D07                	lds     bx,[es:di+7]		; [es:di+SF_ENTRY.sf_devptr] ; DPB
 22937 0000386B 8A1F                    	mov     bl,[bx]			; DPB.DRIVE
 22938 0000386D 30FF                    	xor     bh,bh ; 0
 22939 0000386F 3680A7[0813]FB          	and     byte [ss:bx+drive_flags],0FBh ; clear bit 2
 22940                                  					; bit 2 - last access date/time flag?
 22941                                  					; or disk accessed (successful) flag !?
 22942 00003875 5B                      	pop     bx
 22943 00003876 1F                      	pop     ds
 22944 00003877 F9                      	stc
 22945                                  	;;;
 22946                                  
 22947                                  CloseFinish2:	 ; 03/02/2024 - Retro DOS v5.0
 22948                                  ;Closefinish:
 22949                                  
 22950                                  ; Indicate to the device that the SFT is being closed.
 22951                                  
 22952                                  ;;;; 7/21/86
 22953 00003878 9C                      	PUSHF				; save flag from DirFromSFT
 22954 00003879 E8C219                  	call	DEV_CLOSE_SFT
 22955 0000387C 9D                      	POPF
 22956                                  ;;;; 7/21/86
 22957                                  ;
 22958                                  ; See if the ref count indicates that we have busied the SFT. If so, mark the
 22959                                  ; SFT as being free. Note that we do NOT need to be in critSFT as we are ONLY
 22960                                  ; going to be moving from busy to free.
 22961                                  ;
 22962 0000387D 59                      	POP	CX			; get old ref count
 22963 0000387E 9C                      	PUSHF
 22964                                  	; 03/02/2024
 22965                                  	;DEC	CX			; if cx != 1
 22966                                  	;JNZ	short NoFree		; then do NOT free SFT
 22967 0000387F E203                    	loop	NoFree ; PCDOS 7.1 IBMDOS.COM
 22968                                  
 22969                                  ; 03/02/2024 - Retro DOS v5.0
 22970                                  %if 0
 22971                                  	mov	[es:di],cx
 22972                                  	;MOV	[ES:DI+SF_ENTRY.sf_ref_Count],CX ; mov [es:di+0],cx
 22973                                  %else
 22974                                  	; 03/02/2024
 22975                                  	; PCDOS 7.1 IBMDOS.COM
 22976 00003881 E87712                  	call    SFT_FREE
 22977                                  %endif
 22978                                  
 22979                                  NoFree:
 22980 00003884 E889E0                  	call	LCritDisk
 22981 00003887 9D                      	POPF
 22982 00003888 C3                      	retn
 22983                                  
 22984                                  ;---------------------------------------------------------------------------
 22985                                  ;
 22986                                  ; Procedure Name : FREE_SFT
 22987                                  ;
 22988                                  ; ES:DI -> SFT. Decs sft_ref_count. If the count goes to 0, mark it as busy.
 22989                                  ; Flags preserved. Return old ref count in AX
 22990                                  ;
 22991                                  ; Note that busy is indicated by the SFT ref count being -1.
 22992                                  ;
 22993                                  ;---------------------------------------------------------------------------
 22994                                  
 22995                                  FREE_SFT:
 22996 00003889 9C                      	PUSHF		; Save carry state
 22997 0000388A 268B05                  	mov	ax,[es:di]
 22998                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_ref_count]
 22999 0000388D 48                      	DEC	AX
 23000 0000388E 7501                    	JNZ	short SetCount
 23001 00003890 48                      	DEC	AX
 23002                                  SetCount:
 23003 00003891 268705                  	xchg	ax,[es:di]
 23004                                  	;XCHG	AX,[ES:DI+SF_ENTRY.sf_ref_count]
 23005 00003894 9D                      	POPF
 23006 00003895 C3                      	retn
 23007                                  
 23008                                  	; 18/05/2019 - Retro DOS v4.0
 23009                                  
 23010                                  ;----------------------------------------------------------------------------
 23011                                  ;
 23012                                  ; Procedure Name : DirFromSFT
 23013                                  ;
 23014                                  ;   DirFromSFT - locate a directory entry given an SFT.
 23015                                  ;
 23016                                  ;   Inputs:	ES:DI point to SFT
 23017                                  ;		DS = DOSDATA
 23018                                  ;   Outputs:
 23019                                  ;		EXTERR_LOCUS = errLOC_Disk
 23020                                  ;		CurBuf points to buffer
 23021                                  ;		Carry Clear -> operation OK
 23022                                  ;		    ES:DI point to entry
 23023                                  ;		    ES:BX point to buffer
 23024                                  ;		    DS:SI point to SFT
 23025                                  ;		Carry SET   -> operation failed
 23026                                  ;		    registers trashified
 23027                                  ;   Registers modified: ALL
 23028                                  ;----------------------------------------------------------------------------
 23029                                  
 23030                                  	; 04/02/2024 - Retro DOS v5.0
 23031                                  	; PCDOS 7.1 IBMDOS.COM
 23032                                  
 23033                                  DirFromSFT:
 23034                                  	;;mov	byte [EXTERR_LOCUS],2
 23035                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Disk
 23036                                  	; 04/02/2024
 23037 00003896 E845DA                  	call	set_exerr_locus_disk
 23038                                  	;
 23039 00003899 06                      	push	es
 23040 0000389A 57                      	push	di
 23041                                  	; MSDOS 3.3
 23042                                  	;;mov	dx,[es:di+1Dh]
 23043                                  	;MOV	dx,[ES:DI+SF_ENTRY.sf_dirsec]
 23044                                  	; MSDOS 6.0
 23045                                  	;mov	dx,[es:[di+1Dh]
 23046 0000389B 268B551D                	MOV	DX,[ES:DI+SF_ENTRY.sf_dirsec+2]  ;F.C. >32mb
 23047 0000389F 8916[0706]              	MOV	[HIGH_SECTOR],DX		 ;F.C. >32mb
 23048                                  	; 04/02/2024
 23049 000038A3 52                      	push	dx
 23050                                  	;mov	dx,[es:di+1Bh]
 23051 000038A4 268B551B                	MOV	DX,[ES:DI+SF_ENTRY.sf_dirsec]
 23052                                  	; 04/02/2024
 23053                                  	; 19/05/2019
 23054                                  	;PUSH	word [HIGH_SECTOR]	;F.C. >32mb
 23055                                  	; MSDOS 3.3 & MSDOS 6.0
 23056 000038A8 52                      	PUSH	DX
 23057 000038A9 E8CE2C                  	call	FATREAD_SFT		; ES:BP points to DPB, [THISDRV] set
 23058                                  					; [THISDPB] set
 23059 000038AC 5A                      	POP	DX
 23060 000038AD 8F06[0706]              	POP	word [HIGH_SECTOR]	;F.C. >32mb
 23061 000038B1 721E                    	JC	short PopDone
 23062                                  	; 22/09/2023
 23063                                  	;XOR	AL,AL	; *		; Pre read
 23064                                  	;;mov	byte [ALLOWED],18h
 23065                                  	;MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY ; *
 23066                                  	;call	GETBUFFR
 23067                                  	; 22/09/2023
 23068 000038B3 E8A330                  	call	GETBUFFER ; * 		; Pre read
 23069 000038B6 7219                    	JC	short PopDone
 23070 000038B8 5E                      	pop	si
 23071 000038B9 1F                      	pop	ds			; Get back SFT pointer
 23072                                  
 23073                                  ;hkn; SS override
 23074 000038BA 36C43E[E205]            	LES	DI,[SS:CURBUF]
 23075                                  	;or	byte [es:di+5],4
 23076 000038BF 26804D0504              	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_isDIR
 23077 000038C4 89FB                    	MOV	BX,DI			; ES:BX point to buffer header
 23078                                  	;;;lea	di,[di+16] ; MSDOS 3.3
 23079                                  	;;lea	di,[di+20] ; MSDOS 6.0
 23080                                  	; 04/02/2024
 23081                                  	;lea	di,[di+24] ; MSDOS 7.1
 23082 000038C6 8D7D18                  	LEA	DI,[DI+BUFINSIZ] 	; Point to buffer
 23083                                  	;mov	al,32
 23084 000038C9 B020                    	MOV	AL,dir_entry.size
 23085                                  	;mul	byte [si+1Fh] ; MSDOS 6.0
 23086 000038CB F6641F                  	MUL	byte [SI+SF_ENTRY.sf_dirpos]
 23087 000038CE 01C7                    	ADD	DI,AX			; Point at the entry
 23088 000038D0 C3                      	retn				; carry is clear
 23089                                  PopDone:
 23090 000038D1 5F                      	pop	di
 23091 000038D2 07                      	pop	es
 23092                                  PopDone_retn:
 23093 000038D3 C3                      	retn
 23094                                  
 23095                                  ;----------------------------------------------------------------------------
 23096                                  ;
 23097                                  ;**	DOS_Commit - UPdate Directory Entries
 23098                                  ;
 23099                                  ;	ENTRY	same as DOS_CLOSE (??? BUGBUG - update this jgl)
 23100                                  ;		(DS) = DOSGROUP
 23101                                  ;	EXIT	Same as DOS_CLOSE except ref_count field is not altered
 23102                                  ;	USES	all but DS
 23103                                  ;
 23104                                  ;----------------------------------------------------------------------------
 23105                                  
 23106                                  ; 14/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 23107                                  ; DOSCODE:6F72h (MSDOS 5.0, MSDOS.SYS)
 23108                                  
 23109                                  ; 04/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 23110                                  ; DOSCODE:78B8h (PCDOS 7.1 IBMDOS.COM)
 23111                                  
 23112                                  DOS_COMMIT:
 23113                                  	;hkn; called from srvcall. DS already set up.
 23114 000038D4 C43E[9E05]              	LES	DI,[THISSFT]
 23115                                  	;mov	bx,[es:di+5]
 23116 000038D8 268B5D05                	MOV	BX,[ES:DI+SF_ENTRY.sf_flags]
 23117                                  	;test	bx,0C0h
 23118                                  	; 17/12/2022
 23119 000038DC F6C3C0                  	test	bl,devid_file_clean+devid_device ;Clears carry
 23120                                  	;TEST	BX,devid_file_clean+devid_device ;Clears carry
 23121 000038DF 75F2                    	jnz	short PopDone_retn
 23122                                  	;test	bx,8000h
 23123                                  	; 17/12/2022
 23124                                  	;test	bh,80h
 23125 000038E1 F6C780                  	test	bh,(sf_isnet>>8) ; 80h
 23126                                  	;TEST	BX,sf_isnet ; 8000h
 23127 000038E4 7406                    	JZ	short LOCAL_COMMIT
 23128                                  
 23129                                  ;IF NOT Installed
 23130                                  ;	transfer NET_COMMIT
 23131                                  ;ELSE
 23132                                  	;mov	ax,1107h
 23133 000038E6 B80711                  	MOV	AX,(MultNET<<8)|7
 23134 000038E9 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - COMMIT REMOTE FILE
 23135                                  			; ES:DI -> SFT
 23136                                  			; SFT DPB field -> DPB of drive containing file
 23137                                  			; Return: CF set on error, AX = DOS error code
 23138                                  			; CF clear if successful
 23139                                  localcommit_retn: ; 18/12/2022	
 23140 000038EB C3                      	retn
 23141                                  ;ENDIF
 23142                                  
 23143                                  ; Perform local commit operation by doing a close but not releaseing the SFT.
 23144                                  ; There are three ways we can do this. One is to enter a critical section to
 23145                                  ; protect a potential free. The second is to increment the ref count to mask
 23146                                  ; the close decrementing.
 23147                                  ;
 23148                                  ; The proper way is to let the caller's of close decide if a decrement should
 23149                                  ; be done. We do this by providing another entry into close after the
 23150                                  ; decrement and after the share information release.
 23151                                  
 23152                                  ; DOSCODE:6FA0h (MSDOS 6.21, MSDOS.SYS)
 23153                                  ; DOSCODE:6F8Ch (MSDOS 5.0, MSDOS.SYS) 
 23154                                  
 23155                                  LOCAL_COMMIT:
 23156 000038EC E8F4DF                  	call	ECritDisk
 23157                                  	; MSDOS 6.0
 23158 000038EF E8F1DF                  	call	ECritDisk	;PTM.
 23159 000038F2 E80E00                  	call	SetSFTTimes
 23160 000038F5 B8FFFF                  	MOV	AX,-1 ; 0FFFFh
 23161 000038F8 E84BFE                  	call	CloseEntry
 23162                                  	; MSDOS 6.0
 23163 000038FB 9C                      	PUSHF			;PTM.				;AN000;
 23164 000038FC E83719                  	call	DEV_OPEN_SFT	;PTM.  increment device count	;AN000;
 23165 000038FF 9D                      	POPF			;PTM.				;AN000;
 23166                                  	;call	LCritDisk	;PTM.				;AN000;
 23167                                  	; 18/12/2022
 23168 00003900 E90DE0                  	jmp	LCritDisk
 23169                                  ;localcommit_retn:
 23170                                  ;	retn
 23171                                  
 23172                                  ;Break	<SetSFTTimes - signal a change in the times for an SFT>
 23173                                  ;----------------------------------------------------------------------------
 23174                                  ;
 23175                                  ; Procedure Name : SetSFTTimes
 23176                                  ;
 23177                                  ;   SetSFTTimes - Examine the flags for a SFT and set the time appropriately.
 23178                                  ;   Reflect these times in other SFT's for the same file.
 23179                                  ;
 23180                                  ;   Inputs:	ES:DI point to SFT
 23181                                  ;		BX = sf_flags set appropriately
 23182                                  ;   Outputs:	Set sft times to current time if File & dirty & !nodate
 23183                                  ;   Registers modified: All except ES:DI, BX, AX
 23184                                  ;
 23185                                  ;----------------------------------------------------------------------------
 23186                                  
 23187                                  	; 04/02/2024 - Retro DOS v5.0
 23188                                  	; PCDOS 7.1 IBMDOS.COM 
 23189                                  
 23190                                  SetSFTTimes:
 23191                                  
 23192                                  ; 04/02/2024
 23193                                  %if 0
 23194                                  ;	File clean or device does not get stamped nor disk looked at.
 23195                                  	
 23196                                  	;test	bx,0C0h
 23197                                  	; 17/12/2022
 23198                                  	test	bl,devid_file_clean+devid_device
 23199                                  	;TEST	BX,devid_file_clean+devid_device
 23200                                  	;retnz				; clean or device => no timestamp
 23201                                  	jnz	short localcommit_retn
 23202                                  
 23203                                  ;	file and dirty. See if date is good
 23204                                  
 23205                                  	;test	bx,4000h
 23206                                  	; 17/12/2022
 23207                                  	;test	bh,40h
 23208                                  	test	bh,(sf_close_nodate>>8)
 23209                                  	;TEST	BX,sf_close_nodate
 23210                                  	;retnz				; nodate => no timestamp
 23211                                  	jnz	short localcommit_retn
 23212                                  %else
 23213                                  	; 04/02/2024
 23214                                  	; (PCDOS 7.1 IBMDOS.COM)
 23215                                  	;test	bx,40C0h
 23216 00003903 F7C3C040                	test	bx,sf_close_nodate+devid_file_clean+devid_device
 23217 00003907 75E2                    	jnz	short localcommit_retn
 23218                                  %endif
 23219                                  
 23220 00003909 50                      	push	ax
 23221 0000390A 53                      	push	bx
 23222 0000390B E84ED2                  	call	DATE16			; Date/Time to AX/DX
 23223                                  	;mov	[es:di+0Fh],ax
 23224 0000390E 2689450F                	MOV	[ES:DI+SF_ENTRY.sf_date],AX
 23225                                  	;mov	[es:di+0Dh],dx
 23226 00003912 2689550D                	MOV	[ES:DI+SF_ENTRY.sf_time],DX
 23227 00003916 31C0                    	XOR	AX,AX
 23228                                  ;if installed
 23229                                  	;call	JShare + 14 * 4
 23230 00003918 FF1E[C800]              	call	far [JShare+(14*4)]	; 14 = ShSU
 23231                                  ;else
 23232                                  ;	call	ShSU
 23233                                  ;endif
 23234 0000391C 5B                      	pop	bx
 23235 0000391D 58                      	pop	ax
 23236 0000391E C3                      	retn
 23237                                  
 23238                                  ;============================================================================
 23239                                  ; DIRCALL.ASM, MSDOS 6.0, 1991
 23240                                  ;============================================================================
 23241                                  ; 23/07/2018 - Retro DOS v3.0
 23242                                  ; 18/05/2019 - Retro DOS v4.0
 23243                                  
 23244                                  ; DOSCODE:6FDAh (MSDOS 6.21, MSDOS.SYS)
 23245                                  
 23246                                  ;TITLE DIRCALL - Directory manipulation internal calls
 23247                                  ;NAME  DIRCALL
 23248                                  
 23249                                  ;**	Low level directory manipulation routines for making removing and
 23250                                  ;	  verifying local or NET directories
 23251                                  ;
 23252                                  ;	DOS_MKDIR
 23253                                  ;	DOS_CHDIR
 23254                                  ;	DOS_RMDIR
 23255                                  ;
 23256                                  ;	Modification history:
 23257                                  ;
 23258                                  ;		Created: ARR 30 March 1983
 23259                                  
 23260                                  ;BREAK <DOS_MkDir - Make a directory entry>
 23261                                  ;---------------------------------------------------------------------------
 23262                                  ;
 23263                                  ; Procedure Name : DOS_MkDir
 23264                                  ;
 23265                                  ; Inputs:
 23266                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 23267                                  ;		terminated)
 23268                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 23269                                  ;		( = -1 if current dir not involved, else
 23270                                  ;		 Points to first char after last "/" of current dir part)
 23271                                  ;	[THISCDS] Points to CDS being used
 23272                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 23273                                  ; Function:
 23274                                  ;	Make a new directory
 23275                                  ; Returns:
 23276                                  ;	Carry Clear
 23277                                  ;		No error
 23278                                  ;	Carry Set
 23279                                  ;	    AX is error code
 23280                                  ;		error_path_not_found
 23281                                  ;			Bad path (not in curr dir part if present)
 23282                                  ;		error_bad_curr_dir
 23283                                  ;			Bad path in current directory part of path
 23284                                  ;		error_access_denied
 23285                                  ;			Already exists, device name
 23286                                  ; DS preserved, Others destroyed
 23287                                  ;---------------------------------------------------------------------------
 23288                                  
 23289                                  ;hkn; called from path.asm. DS already set up.
 23290                                  
 23291                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 23292                                  ; DOSCODE:6FC6h (MSDOS 5.0, MSDOS.SYS)
 23293                                  
 23294                                  ; 04/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 23295                                  ; DOSCODE:78FFh (PCDOS 7.1, IBMDOS.COM)
 23296                                  
 23297                                  DOS_MKDIR:
 23298 0000391F E8FFDE                  	call	TestNet
 23299 00003922 7313                    	JNC	short LOCAL_MKDIR
 23300                                  
 23301                                  ;IF NOT Installed
 23302                                  ;	transfer NET_MKDIR
 23303                                  ;ELSE
 23304                                  	;mov	ax,1103h
 23305 00003924 B80311                  	MOV	AX,(MultNET<<8)|3
 23306 00003927 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - MAKE REMOTE DIRECTORY
 23307                                  			; SS = DOS CS
 23308                                  			; SDA first filename pointer -> fully-qualified directory name
 23309                                  			; SDA CDS pointer -> current directory
 23310                                  			; Return: CF set on error, AX = DOS error code
 23311                                  			; CF clear if successful
 23312 00003929 C3                      	retn
 23313                                  ;ENDIF
 23314                                  
 23315                                  NODEACCERRJ:
 23316                                  	;mov	ax,5
 23317 0000392A B80500                  	MOV	AX,error_access_denied
 23318                                  _BadRet:
 23319 0000392D F9                      	STC
 23320                                  	;call	LCritDisk
 23321                                  	;retn
 23322                                  	; 18/12/2022
 23323 0000392E E9DFDF                  	jmp	LCritDisk
 23324                                  
 23325                                  PATHNFJ:
 23326 00003931 E8DCDF                  	call	LCritDisk
 23327 00003934 E915F8                  	jmp	SET_MKND_ERR	; Map the MakeNode error and return
 23328                                  
 23329                                  LOCAL_MKDIR:
 23330 00003937 E8A9DF                  	call	ECritDisk
 23331                                  
 23332                                  ; MakeNode requires an SFT to fiddle with. We Use a temp spot (RENBUF)
 23333                                  
 23334 0000393A 8C16[A005]              	MOV	[THISSFT+2],SS
 23335                                  
 23336                                  ;hkn; DOSDATA
 23337 0000393E C706[9E05][3E04]        	MOV	WORD [THISSFT],RENBUF
 23338                                  
 23339                                  ;  NOTE: Need WORD PTR because MASM takes type of
 23340                                  ;   TempSFT (byte) instead of type of sf_mft (word).
 23341                                  
 23342                                  	;mov	word [RENBUF+33h],0 ; MSDOS 6.0
 23343 00003944 C706[7104]0000          	MOV	WORD [RENBUF+SF_ENTRY.sf_MFT],0
 23344                                  				; make sure SHARER won't complain.
 23345                                  	;mov	al,10h
 23346 0000394A B010                    	MOV	AL,attr_directory
 23347 0000394C E82F1B                  	call	MakeNode
 23348 0000394F 72E0                    	JC	short PATHNFJ
 23349 00003951 83F803                  	CMP	AX,3
 23350 00003954 74D4                    	JZ	short NODEACCERRJ ; Can't make a device into a directory
 23351 00003956 C42E[8A05]              	LES	BP,[THISDPB]	; Makenode zaps this
 23352 0000395A C53E[E205]              	LDS	DI,[CURBUF]
 23353 0000395E 29FE                    	SUB	SI,DI
 23354 00003960 56                      	PUSH	SI		; Pointer to dir_first
 23355                                  
 23356                                  ; 04/02/2024
 23357                                  %if 0
 23358                                  	; MSDOS 6.0
 23359                                  	;push	word [DI+8]
 23360                                  	PUSH	WORD [DI+BUFFINFO.buf_sector+2]	;F.C. >32mb
 23361                                  	; MSDOS 3.3 & MSDOS 6.0
 23362                                  	;push	word [di+6]
 23363                                  	PUSH	WORD [DI+BUFFINFO.buf_sector] ; Sector of new node
 23364                                  %else
 23365                                  	; 04/02/2024
 23366                                  	; (PCDOS 7.1 IBMDOS.COM)
 23367 00003961 C54506                  	lds	ax,[di+BUFFINFO.buf_sector] ; Sector of new node
 23368 00003964 1E                      	push	ds
 23369 00003965 50                      	push	ax
 23370                                  %endif
 23371                                  
 23372 00003966 16                      	push	ss
 23373 00003967 1F                      	pop	ds
 23374                                  
 23375                                  	; 04/02/2024
 23376                                  	;PUSH	word [DIRSTART]	; Parent for .. entry
 23377 00003968 31C0                    	XOR	AX,AX
 23378                                  	;MOV	[DIRSTART],AX	; Null directory
 23379                                  	;;;
 23380                                  	; Retro DOS v5.0
 23381                                  	; PCDOS 7.1 IBMDOS.COM
 23382 0000396A 89C2                    	mov	dx,ax ; 0
 23383 0000396C 8716[DC0A]              	xchg	dx,[DIRSTART_HW] ; Null directory
 23384 00003970 8706[C205]              	xchg	ax,[DIRSTART]
 23385                                  	;
 23386                                  	;cmp	word [es:bp+0Fh],0
 23387 00003974 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 23388 00003979 7510                    	jnz	short LOCAL_MKDIR_cont ; not FAT32
 23389                                  	;cmp	[es:bp+35h],ax
 23390 0000397B 26394635                	cmp	[es:bp+DPB.ROOT_CLUSTER],ax
 23391 0000397F 750A                    	jne     short LOCAL_MKDIR_cont
 23392                                  	;cmp	[es:bp+37h],dx
 23393 00003981 26395637                	cmp	[es:bp+DPB.ROOT_CLUSTER+2],dx
 23394 00003985 7504                    	jne	short LOCAL_MKDIR_cont
 23395                                  	;
 23396 00003987 31D2                    	xor	dx,dx
 23397 00003989 31C0                    	xor	ax,ax
 23398                                  		; dx:ax = 0 for root directory
 23399                                  LOCAL_MKDIR_cont:
 23400 0000398B 52                      	push	dx
 23401                                  	;;;
 23402 0000398C 50                      	push	ax
 23403                                  
 23404 0000398D E8FF19                  	call	NEWDIR
 23405 00003990 7278                    	JC	short NODEEXISTSPOPDEL ; No room
 23406 00003992 E8190F                  	call	GETENT		; First entry
 23407 00003995 7273                    	JC	short NODEEXISTSPOPDEL ; Screw up
 23408 00003997 C43E[E205]              	LES	DI,[CURBUF]
 23409                                  
 23410                                  ; 04/02/2024
 23411                                  %if 0
 23412                                  	; MSDOS 6.0
 23413                                  	TEST	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty  
 23414                                  				 ;LB. if already dirty		    ;AN000;
 23415                                  	JNZ	short yesdirty5	 ;LB.   don't increment dirty count ;AN000;
 23416                                  	call	INC_DIRTY_COUNT  ;LB.				    ;AN000;
 23417                                  	
 23418                                  	; MSDOS 3.3 & MSDOS 6.0
 23419                                  	;or	byte [es:di+5],40h  ; 07/12/2022
 23420                                  	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 23421                                  %else
 23422                                  	; 04/02/2024
 23423                                  	; (PCDOS 7.1 IBMDOS.COM)
 23424 0000399B E84D32                  	call    SET_BUF_DIRTY
 23425                                  %endif
 23426                                  
 23427                                  yesdirty5:
 23428                                  	;;;add	di,16 ; MSDOS 3.3
 23429                                  	;;add	di,20 ; MSDOS 6.0
 23430                                  	; 04/02/2024
 23431                                  	;add	di,24 ; PCDOS 7.1	
 23432 0000399E 83C718                  	ADD	DI,BUFINSIZ	; Point at buffer
 23433 000039A1 B82E20                  	MOV	AX,202EH	; ". "
 23434                                  	;;;
 23435                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23436 000039A4 8B16[DC0A]              	mov	dx,[DIRSTART_HW]
 23437 000039A8 8916[F20A]              	mov	[CLUSTERS_HW],dx
 23438                                  	;;;
 23439 000039AC 8B16[C205]              	MOV	DX,[DIRSTART]	; Point at itself
 23440 000039B0 E8A41A                  	call	SETDOTENT
 23441 000039B3 B82E2E                  	MOV	AX,2E2EH	; ".."
 23442 000039B6 5A                      	POP	DX		; Parent
 23443                                  	;;;
 23444                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23445 000039B7 8F06[F20A]              	pop	word [CLUSTERS_HW]
 23446                                  	;;;
 23447 000039BB E8991A                  	call	SETDOTENT
 23448 000039BE C42E[8A05]              	LES	BP,[THISDPB]
 23449                                  	; 22/09/2023
 23450                                  	;;mov	byte [ALLOWED],18h
 23451                                  	;MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY ; *
 23452 000039C2 5A                      	POP	DX		; Entry sector
 23453                                  	; MSDOS 6.0
 23454 000039C3 8F06[0706]              	POP	word [HIGH_SECTOR] ;F.C. >32mb
 23455                                  
 23456                                  	;XOR	AL,AL ; *	; Pre read
 23457                                  	;call	GETBUFFR
 23458                                  	; 22/09/2023
 23459 000039C7 E88F2F                  	call	GETBUFFER ; *	; Pre read
 23460 000039CA 7265                    	JC	short NODEEXISTSP
 23461                                  	;;;
 23462                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23463 000039CC A1[DC0A]                	mov	ax,[DIRSTART_HW]
 23464                                  	;;;
 23465 000039CF 8B16[C205]              	MOV	DX,[DIRSTART]
 23466 000039D3 C53E[E205]              	LDS	DI,[CURBUF]
 23467                                  	;or	byte [di+5],4
 23468 000039D7 804D0504                	OR	byte [DI+BUFFINFO.buf_flags],buf_isDIR
 23469 000039DB 5E                      	POP	SI		; dir_first pointer
 23470 000039DC 01FE                    	ADD	SI,DI
 23471 000039DE 8914                    	MOV	[SI],DX		; dir_entry.dir_first
 23472                                  	;;;
 23473                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23474 000039E0 8944FA                  	mov	[si-6],ax	; dir_entry.dir_fclus_hi
 23475                                  	;;;
 23476                                  
 23477 000039E3 31D2                    	XOR	DX,DX
 23478 000039E5 895402                  	MOV	[SI+2],DX	; Zero size
 23479 000039E8 895404                  	MOV	[SI+4],DX
 23480                                  DIRUP:
 23481                                  	; MSDOS 6.0
 23482 000039EB F6450540                	TEST	byte [DI+BUFFINFO.buf_flags],buf_dirty  
 23483                                  	;			 ;LB. if already dirty 		   ;AN000;
 23484 000039EF 7507                    	JNZ	short yesdirty6	 ;LB.  don't increment dirty count ;AN000;
 23485 000039F1 E80332                  	call	INC_DIRTY_COUNT  ;LB.				   ;AN000;
 23486                                  	
 23487                                  	; MSDOS 3.3 & MSDOS 6.0
 23488                                  	;or	byte [di+5],40h
 23489 000039F4 804D0540                	OR	byte [DI+BUFFINFO.buf_flags],buf_dirty	; Dirty buffer
 23490                                  yesdirty6:
 23491 000039F8 16                      	push	ss
 23492 000039F9 1F                      	pop	ds
 23493                                  	;;;
 23494                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23495 000039FA E870FA                  	call	update_fat32_fsinfo
 23496                                  	;;;
 23497 000039FD 268A4600                	mov	al,[es:bp]
 23498                                  	;MOV	AL,[ES:BP+DPB.DRIVE]  ; mov al,[es:bp+0]
 23499 00003A01 E8C130                  	call	FLUSHBUF
 23500                                  	;mov	ax,5
 23501 00003A04 B80500                  	MOV	AX,error_access_denied
 23502                                  	;call	LCritDisk
 23503                                  	;retn
 23504                                  	; 18/12/2022
 23505 00003A07 E906DF                  	jmp	LCritDisk
 23506                                  
 23507                                  NODEEXISTSPOPDEL:
 23508                                  	;;;
 23509                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23510 00003A0A 5A                      	pop	dx		; Parent
 23511                                  	;;;
 23512 00003A0B 5A                      	POP	DX		; Parent
 23513 00003A0C 5A                      	POP	DX		; Entry sector
 23514                                  	; MSDOS 6.0 
 23515 00003A0D 8F06[0706]              	POP	word [HIGH_SECTOR] ; F.C. >32mb
 23516 00003A11 C42E[8A05]              	LES	BP,[THISDPB]
 23517                                  	; 22/09/2023
 23518                                  	;;mov	byte [ALLOWED],18h
 23519                                  	;MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY ; *
 23520                                  	;XOR	AL,AL ; *	; Pre read
 23521                                  	;call	GETBUFFR
 23522                                  	; 22/09/2023
 23523 00003A15 E8412F                  	call	GETBUFFER ; *	; Pre read
 23524 00003A18 7217                    	JC	short NODEEXISTSP
 23525 00003A1A C53E[E205]              	LDS	DI,[CURBUF]
 23526                                  	;or	byte [di+5],4
 23527 00003A1E 804D0504                	OR	byte [DI+BUFFINFO.buf_flags],buf_isDIR
 23528 00003A22 5E                      	POP	SI		; dir_first pointer
 23529 00003A23 01FE                    	ADD	SI,DI
 23530                                  	;sub	si,1Ah ; 26
 23531 00003A25 83EE1A                  	SUB	SI,dir_entry.dir_first	;Point back to start of dir entry
 23532 00003A28 C604E5                  	MOV	BYTE [SI],0E5H	; Free the entry
 23533 00003A2B E8BDFF                  	CALL	DIRUP		; Error doesn't matter since erroring anyway
 23534                                  NODEEXISTS:
 23535 00003A2E E9F9FE                  	JMP	NODEACCERRJ ; 10/08/2018
 23536                                  
 23537                                  NODEEXISTSP:
 23538 00003A31 5E                      	POP	SI		; Clean stack
 23539 00003A32 EBFA                    	JMP	short NODEEXISTS
 23540                                  
 23541                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 23542                                  
 23543                                  ;BREAK <DOS_ChDir -- Verify a directory>
 23544                                  ;----------------------------------------------------------------------------
 23545                                  ;
 23546                                  ; Procedure Name : DOS_ChDir
 23547                                  ;
 23548                                  ; Inputs:
 23549                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 23550                                  ;		terminated)
 23551                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 23552                                  ;		( = -1 if current dir not involved, else
 23553                                  ;		 Points to first char after last "/" of current dir part)
 23554                                  ;	[THISCDS] Points to CDS being used May not be NUL
 23555                                  ; Function:
 23556                                  ;	Validate the path for potential new current directory
 23557                                  ; Returns:
 23558                                  ;	NOTE:
 23559                                  ;	    [SATTRIB] is modified by this call
 23560                                  ;	Carry Clear
 23561                                  ;	    CX is cluster number of the DIR, LOCAL CDS ONLY
 23562                                  ;		Caller must NOT set ID fields on a NET CDS.
 23563                                  ;	Carry Set
 23564                                  ;	    AX is error code
 23565                                  ;		error_path_not_found
 23566                                  ;			Bad path
 23567                                  ;		error_access_denied
 23568                                  ;			device or file name
 23569                                  ; DS preserved, Others destroyed
 23570                                  ;----------------------------------------------------------------------------
 23571                                  
 23572                                  ;hkn; called from path.asm and dir2.asm. DS already set up.
 23573                                  
 23574                                  ; 18/05/2019 - Retro DOS v4.0
 23575                                  ; DOSCODE:70DAh (MSDOS 6.21, MSDOS.SYS)
 23576                                  
 23577                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 23578                                  ; DOSCODE:70C6h (MSDOS 5.0, MSDOS.SYS)
 23579                                  
 23580                                  ; 04/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 23581                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:7A23h
 23582                                  
 23583                                  ; (Windows ME IO.SYS - BIOSCODE:7839h)
 23584                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:70DAh)
 23585                                  
 23586                                  DOS_CHDIR:
 23587 00003A34 E8EADD                  	call	TestNet
 23588 00003A37 7306                    	JNC	short LOCAL_CHDIR
 23589                                  
 23590                                  ;IF NOT Installed
 23591                                  ;	transfer NET_CHDIR
 23592                                  ;ELSE
 23593                                  	;mov	ax,1105h
 23594 00003A39 B80511                  	MOV	AX,(MultNET<<8)|5
 23595 00003A3C CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - CHDIR
 23596                                  			; SS = DOS CS
 23597                                  			; SDA first filename pointer -> fully-qualified directory name
 23598                                  			; SDA CDS pointer -> current directory
 23599                                  			; Return: CF set on error, AX = DOS error code
 23600                                  			; CF clear if successful
 23601 00003A3E C3                      	retn
 23602                                  ;ENDIF
 23603                                  
 23604                                  LOCAL_CHDIR:
 23605 00003A3F E8A1DE                  	call	ECritDisk
 23606                                  	; MSDOS 6.0
 23607                                  	;;test	word [es:di+43h],2000h
 23608                                  	;TEST	word [ES:DI+curdir.flags],curdir_splice ;PTM.
 23609                                  	; 17/12/2022
 23610                                  	;test	byte [es:di+44h],20h
 23611 00003A42 26F6454420              	test	byte [ES:DI+curdir.flags+1],(curdir_splice>>8) ;PTM.
 23612 00003A47 740C                    	JZ	short nojoin		   ;PTM.
 23613                                  	;mov	word [es:di+49h], 0FFFFh
 23614 00003A49 26C74549FFFF            	MOV	word [ES:DI+curdir.ID],0FFFFH ;PTM.
 23615                                  	;;;
 23616                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23617                                  	;mov	word [es:di+4Bh], 0FFFFh
 23618 00003A4F 26C7454BFFFF            	mov	word [es:di+curdir.ID+2],0FFFFh
 23619                                  	;;;
 23620                                  nojoin:
 23621                                  	; MSDOS 3.3 & MSDOS 6.0
 23622 00003A55 C606[4C03]00            	MOV	byte [NoSetDir],0 ; FALSE
 23623                                  	;mov	byte [SATTRIB],16h
 23624 00003A5A C606[6D05]16            	MOV	byte [SATTRIB],attr_directory+attr_system+attr_hidden
 23625                                  				; Dir calls can find these
 23626                                  ; DOS 3.3  6/24/86 FastOpen
 23627 00003A5F 800E[4611]01            	OR	byte [FastOpenFlg],FastOpen_Set	; set fastopen flag
 23628 00003A64 E8BC10                  	call	GETPATH
 23629                                  
 23630                                  	; 04/02/2024
 23631                                  	;PUSHF						;AN000;
 23632 00003A67 9F                      	lahf						
 23633 00003A68 8026[4611]80            	AND	byte [FastOpenFlg],Fast_yes ; clear it all ;AC000;
 23634                                  	;POPF						;AN000;
 23635 00003A6D 9E                      	sahf
 23636                                  
 23637                                  ; DOS 3.3  6/24/86 FastOpen
 23638                                  
 23639                                  	; MSDOS 3.3
 23640                                  	;mov	byte [FastOpenFlg],0
 23641                                  	
 23642                                  	;mov	ax,3
 23643 00003A6E B80300                  	MOV	AX,error_path_not_found
 23644 00003A71 7207                    	JC	short ChDirDone
 23645 00003A73 7557                    	JNZ	short NOTDIRPATH	; Path not a DIR
 23646 00003A75 8B0E[C205]              	MOV	CX,[DIRSTART]		; Get cluster number
 23647 00003A79 F8                      	CLC
 23648                                  ChDirDone:
 23649                                  	;call	LCritDisk
 23650                                  	;retn
 23651                                  	; 18/12/2022
 23652 00003A7A E993DE                  	jmp	LCritDisk
 23653                                  
 23654                                  ;BREAK <DOS_RmDir -- Remove a directory>
 23655                                  ;----------------------------------------------------------------------------
 23656                                  ;
 23657                                  ; Procedure Name : DOS_RmDir
 23658                                  ;
 23659                                  ; Inputs:
 23660                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 23661                                  ;		terminated)
 23662                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 23663                                  ;		( = -1 if current dir not involved, else
 23664                                  ;		 Points to first char after last "/" of current dir part)
 23665                                  ;	[THISCDS] Points to CDS being used
 23666                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 23667                                  ; Function:
 23668                                  ;	Remove a directory
 23669                                  ;	NOTE: Attempt to remove current directory must be detected by caller
 23670                                  ; Returns:
 23671                                  ;	NOTE:
 23672                                  ;	    [SATTRIB] is modified by this call
 23673                                  ;	Carry Clear
 23674                                  ;		No error
 23675                                  ;	Carry Set
 23676                                  ;	    AX is error code
 23677                                  ;		error_path_not_found
 23678                                  ;			Bad path (not in curr dir part if present)
 23679                                  ;		error_bad_curr_dir
 23680                                  ;			Bad path in current directory part of path
 23681                                  ;		error_access_denied
 23682                                  ;			device or file name, root directory
 23683                                  ;			Bad directory ('.' '..' messed up)
 23684                                  ; DS preserved, Others destroyed
 23685                                  ;----------------------------------------------------------------------------
 23686                                  
 23687                                  ;hkn; called from path.asm. DS already set up.
 23688                                  
 23689                                  ; 18/05/2019 - Retro DOS v4.0
 23690                                  ; DOSCODE:711Fh (MSDOS 6.21, MSDOS.SYS)
 23691                                  
 23692                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 23693                                  ; DOSCODE:710Bh (MSDOS 5.0, MSDOS.SYS)
 23694                                  
 23695                                  ; 06/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 23696                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:7A6Bh
 23697                                  
 23698                                  DOS_RMDIR:
 23699 00003A7D E8A1DD                  	call	TestNet
 23700 00003A80 7306                    	JNC	short LOCAL_RMDIR
 23701                                  
 23702                                  ;IF NOT Installed
 23703                                  ;	transfer NET_RMDIR
 23704                                  ;ELSE
 23705                                  	;mov	ax,1101h
 23706 00003A82 B80111                  	MOV	AX,(MultNET<<8)|1
 23707 00003A85 CD2F                    	int	2Fh	; Multiplex - NETWORK REDIRECTOR - REMOVE REMOTE DIRECTORY
 23708                                  			; SS = DOS CS
 23709                                  			; SDA first filename pointer -> fully-qualified directory name
 23710                                  			; SDA CDS pointer -> current directory
 23711                                  			; Return: CF set on error, AX = DOS error code
 23712                                  			; CF clear if successful
 23713 00003A87 C3                      	retn
 23714                                  ;ENDIF
 23715                                  
 23716                                  LOCAL_RMDIR:
 23717 00003A88 E858DE                  	call	ECritDisk
 23718 00003A8B C606[4C03]00            	MOV	byte [NoSetDir],0
 23719                                  	;mov	byte [SATTRIB],16h
 23720 00003A90 C606[6D05]16            	MOV	byte [SATTRIB],attr_directory+attr_system+attr_hidden
 23721                                  					; Dir calls can find these
 23722 00003A95 E88B10                  	call	GETPATH
 23723 00003A98 7229                    	JC	short NOPATH		; Path not found
 23724 00003A9A 7530                    	JNZ	short NOTDIRPATH	; Path not a DIR
 23725                                  
 23726                                  ; 06/04/2024
 23727                                  %if 0	
 23728                                  	MOV	DI,[DIRSTART]
 23729                                  	OR	DI,DI			; Root ?
 23730                                  	JNZ	short rmdir_get_buf	; No
 23731                                  	JMP	SHORT NOTDIRPATH
 23732                                  %else
 23733                                  	; 06/02/2024 - Retro DOS v5.0
 23734                                  	; PCDOS 7.1 IBMDOS.COM
 23735 00003A9C 8B3E[C205]              	mov	di,[DIRSTART]
 23736 00003AA0 09FF                    	or	di,di			; Root ?
 23737 00003AA2 7506                    	jnz	short LOCAL_RMDIR_cont	; No
 23738                                  	
 23739                                  	;cmp	word [DIRSTART_HW],0
 23740 00003AA4 393E[DC0A]              	cmp	[DIRSTART_HW],di ; 0
 23741 00003AA8 7422                    	jz      short NOTDIRPATH ; root directory
 23742                                  
 23743                                  LOCAL_RMDIR_cont:
 23744                                  	;cmp	word [es:bp+0Fh],0
 23745 00003AAA 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 23746 00003AAF 751E                    	jnz	short rmdir_get_buf	; not FAT32
 23747                                  	;cmp	di,[es:bp+35h]
 23748 00003AB1 263B7E35                	cmp	di,[es:bp+DPB.ROOT_CLUSTER]
 23749 00003AB5 7518                    	jne	short rmdir_get_buf
 23750 00003AB7 8B3E[DC0A]              	mov	di,[DIRSTART_HW]
 23751                                  	;cmp	di,[es:bp+37h]
 23752 00003ABB 263B7E37                	cmp	di,[es:bp+DPB.ROOT_CLUSTER+2]
 23753 00003ABF 750E                    	jne	short rmdir_get_buf
 23754 00003AC1 EB09                    	jmp	short NOTDIRPATH
 23755                                  %endif		
 23756                                  
 23757                                  NOPATH:
 23758                                  	;mov	ax,3
 23759 00003AC3 B80300                  	MOV	AX,error_path_not_found
 23760 00003AC6 E964FE                  	JMP	_BadRet
 23761                                  
 23762                                  NOTDIRPATHPOP:
 23763 00003AC9 58                      	POP	AX  ; MSDOS 6.0		;F.C. >32mb
 23764 00003ACA 58                      	POP	AX
 23765                                  NOTDIRPATHPOP2:
 23766 00003ACB 58                      	POP	AX
 23767                                  NOTDIRPATH:
 23768 00003ACC E95BFE                  	JMP	NODEACCERRJ
 23769                                  
 23770                                  rmdir_get_buf:
 23771 00003ACF C53E[E205]              	LDS	DI,[CURBUF]
 23772 00003AD3 29FB                    	SUB	BX,DI		; Compute true offset
 23773 00003AD5 53                      	PUSH	BX		; Save entry pointer
 23774                                  
 23775                                  ; 06/04/2024
 23776                                  %if 0		
 23777                                  	; MSDOS 6.0
 23778                                  	;push	word [di+8]
 23779                                  	PUSH	WORD [DI+BUFFINFO.buf_sector+2] ;F.C. >32mb
 23780                                  	
 23781                                  	; MSDOS 3.3 (& MSDOS 6.0)
 23782                                  	;push	word [di+6]
 23783                                  	PUSH	WORD [DI+BUFFINFO.buf_sector] ; Save sector number
 23784                                  %else
 23785                                  	; 06/02/2024 - Retro DOS v5.0
 23786                                  	; PCDOS 7.1 IBMDOS.COM
 23787                                  
 23788                                  	;les	di,[di+6]
 23789 00003AD6 C47D06                  	les	di,[di+BUFFINFO.buf_sector]
 23790 00003AD9 06                      	push	es
 23791 00003ADA 57                      	push	di
 23792                                  %endif
 23793                                  
 23794                                  ;hkn; SS is DOSDATA
 23795                                  	;context DS
 23796 00003ADB 16                      	push	ss
 23797 00003ADC 1F                      	pop	ds
 23798                                  	;context ES
 23799 00003ADD 16                      	push	ss
 23800 00003ADE 07                      	pop	es
 23801                                  
 23802                                  ;hkn; NAME1 is in DOSDATA
 23803 00003ADF BF[4B05]                	MOV	DI,NAME1
 23804 00003AE2 B03F                    	MOV	AL,'?'
 23805 00003AE4 B90B00                  	MOV	CX,11
 23806 00003AE7 F3AA                    	REP	STOSB
 23807 00003AE9 30C0                    	XOR	AL,AL
 23808 00003AEB AA                      	STOSB				; Nul terminate it
 23809 00003AEC E8DF12                  	call	STARTSRCH		; Set search
 23810 00003AEF E8B90D                  	call	GETENTRY		; Get start of directory
 23811 00003AF2 72D5                    	JC	short NOTDIRPATHPOP	; Screw up
 23812 00003AF4 8E1E[E405]              	MOV	DS,[CURBUF+2]
 23813 00003AF8 89DE                    	MOV	SI,BX
 23814 00003AFA AD                      	LODSW
 23815                                  	;CMP	AX,(' ' SHL 8) OR '.'   ; First entry '.'?
 23816 00003AFB 3D2E20                  	cmp	ax,202Eh ; ". "
 23817 00003AFE 75C9                    	JNZ	short NOTDIRPATHPOP	; Nope
 23818                                  	;add	si,30
 23819 00003B00 83C61E                  	ADD	SI,dir_entry.size-2 ; Next entry
 23820 00003B03 AD                      	LODSW
 23821                                  	;CMP	AX,('.' SHL 8) OR '.'   ; Second entry '..'?
 23822                                  	;cmp	ax, '..'
 23823 00003B04 3D2E2E                  	cmp	ax,2E2Eh
 23824 00003B07 75C0                    	JNZ	short NOTDIRPATHPOP	; Nope
 23825                                  
 23826                                  ;hkn; SS is DOSDATA
 23827                                  	;context DS
 23828 00003B09 16                      	push	ss
 23829 00003B0A 1F                      	pop	ds
 23830 00003B0B C706[4803]0200          	MOV	word [LASTENT],2	; Skip . and ..
 23831 00003B11 E8970D                  	call	GETENTRY		; Get next entry
 23832 00003B14 72B3                    	JC	short NOTDIRPATHPOP	; Screw up
 23833                                  	;mov	byte [ATTRIB],16h
 23834 00003B16 C606[6B05]16            	MOV	byte [ATTRIB],attr_directory+attr_hidden+attr_system
 23835 00003B1B E8430C                  	call	SRCH			; Do a search
 23836 00003B1E 73A9                    	JNC	short NOTDIRPATHPOP	; Found another entry!
 23837 00003B20 803E[4A03]00            	CMP	byte [FAILERR],0
 23838 00003B25 75A2                    	JNZ	short NOTDIRPATHPOP	; Failure of search due to I 24 FAIL
 23839 00003B27 C42E[8A05]              	LES	BP,[THISDPB]
 23840                                  	;;;
 23841                                  	; 06/02/2024 - Retro DOS v5.0
 23842                                  	; PCDOS 7.1 IBMDOS.COM
 23843 00003B2B 8B1E[DC0A]              	mov	bx,[DIRSTART_HW]
 23844 00003B2F 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 23845                                  	;;;
 23846 00003B33 8B1E[C205]              	MOV	BX,[DIRSTART]
 23847 00003B37 E8C320                  	call	RELEASE 		; Release data in sub dir
 23848 00003B3A 728D                    	JC	short NOTDIRPATHPOP	; Screw up
 23849                                  	;;;
 23850                                  	; 06/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 23851 00003B3C E82EF9                  	call	update_fat32_fsinfo
 23852                                  	;;;
 23853 00003B3F 5A                      	POP	DX			; Sector # of entry
 23854 00003B40 8F06[0706]              	POP	word [HIGH_SECTOR] ; MSDOS 6.0	; F.C. >32mb
 23855                                  	; 22/09/2023
 23856                                  	;;mov	byte [ALLOWED],18h
 23857                                  	;MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY ; *
 23858                                  	;XOR	AL,AL ; *		; Pre read
 23859                                  	;call	GETBUFFR		; Get sector back
 23860 00003B44 E8122E                  	call	GETBUFFER ; *		; Pre Read
 23861 00003B47 7282                    	JC	short NOTDIRPATHPOP2	; Screw up
 23862                                  
 23863                                  rmdir_fde:	; 06/02/2024
 23864 00003B49 C53E[E205]              	LDS	DI,[CURBUF]
 23865                                  	;or	byte [di+5],4
 23866 00003B4D 804D0504                	OR	byte [DI+BUFFINFO.buf_flags],buf_isDIR
 23867 00003B51 5B                      	POP	BX			; Pointer to start of entry
 23868 00003B52 01FB                    	ADD	BX,DI			; Corrected
 23869 00003B54 C607E5                  	MOV	BYTE [BX],0E5H		; Free the entry
 23870                                  
 23871                                  ;DOS 3.3 FastOpen  6/16/86  F.C.
 23872 00003B57 1E                      	PUSH	DS
 23873                                  
 23874                                  ;hkn; SS is DOSDATA
 23875                                  	;context DS
 23876 00003B58 16                      	push	ss
 23877 00003B59 1F                      	pop	ds
 23878                                  
 23879                                  	; MSDOS 6.0
 23880 00003B5A E8E3F1                  	call	FastOpen_Delete 	; call fastopen to delete an entry
 23881                                  
 23882                                  ;	; MSDOS 3.3
 23883                                  ;_FastOpen_Delete:
 23884                                  ;	push	ax
 23885                                  ;	mov	si,[WFP_START]
 23886                                  ;	mov	bx,FastTable
 23887                                  ;	;mov	al,3  ; FONC_delete
 23888                                  ;	mov	al,FONC_delete
 23889                                  ;	call	far [BX+2]  ; FastTable+2
 23890                                  ;	pop	ax
 23891                                  
 23892 00003B5D 1F                      	POP	DS
 23893                                  ;DOS 3.3 FastOpen  6/16/86  F.C.
 23894                                  
 23895 00003B5E E98AFE                  	JMP	DIRUP			; In MKDIR, dirty buffer and flush
 23896                                  
 23897                                  ;============================================================================
 23898                                  ; DISK.ASM, MSDOS 6.0, 1991
 23899                                  ;============================================================================
 23900                                  ; 23/07/2018 - Retro DOS v3.0 
 23901                                  ; 04/05/2019 - Retro DOS v4.0
 23902                                  ; 06/02/2024 - Retro DOS v5.0
 23903                                  
 23904                                  ;	TITLE	DISK - Disk utility routines
 23905                                  ;	NAME	Disk
 23906                                  
 23907                                  ;**	Low level Read and write routines for local SFT I/O on files and devs
 23908                                  ;
 23909                                  ;	SWAPCON
 23910                                  ;	SWAPBACK
 23911                                  ;	DOS_READ
 23912                                  ;	DOS_WRITE
 23913                                  ;	get_io_sft
 23914                                  ;	DirRead
 23915                                  ;	FIRSTCLUSTER
 23916                                  ;	SET_BUF_AS_DIR
 23917                                  ;	FATSecRd
 23918                                  ;	DREAD
 23919                                  ;	CHECK_WRITE_LOCK
 23920                                  ;	CHECK_READ_LOCK
 23921                                  ;
 23922                                  ;	Revision history:
 23923                                  ;
 23924                                  ;		A000   version 4.00  Jan. 1988
 23925                                  ;
 23926                                  ;----------------------------------------------------------------------------
 23927                                  ;
 23928                                  ; M065 : B#5276. On raw read/write of a block of characters if a critical
 23929                                  ;		error happens, DOS retries the entire block assuming that
 23930                                  ;		zero characters were transferred. Modified the code to take
 23931                                  ;		into account the number of characters transfered before
 23932                                  ;		retrying the operation.
 23933                                  ;
 23934                                  ;----------------------------------------------------------------------------
 23935                                  ;
 23936                                  
 23937                                  ;Installed = TRUE
 23938                                  
 23939                                  ;Break	<SwapCon, Swap Back - Old-style I/O to files>
 23940                                  
 23941                                  ; **** Drivers for file input from devices ****
 23942                                  ;----------------------------------------------------------------------------
 23943                                  ;   Indicate that there is no more I/O occurring through another SFT outside
 23944                                  ;   of handles 0 and 1
 23945                                  ;
 23946                                  ;   Inputs:	DS is DOSDATA
 23947                                  ;   Outputs:	CONSWAP is set to false.
 23948                                  ;   Registers modified: none
 23949                                  ;----------------------------------------------------------------------------
 23950                                  
 23951                                  ; IBMDOS.COM (MSDOS 3.3) - Offset 3CF8h
 23952                                  
 23953                                  ; DOSCODE:71E3h (MSDOS 6.21, MSDOS.SYS)
 23954                                  ; 04/05/2019 - Retro DOS v4.0
 23955                                  
 23956                                  ; DOSCODE:71CFh (MSDOS 5.0, MSDOS.SYS)
 23957                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 23958                                  
 23959                                  SWAPBACK:
 23960 00003B61 C606[5703]00            	MOV	BYTE [CONSWAP],0	; signal no conswaps
 23961 00003B66 C3                      	retn
 23962                                  
 23963                                  ;----------------------------------------------------------------------------
 23964                                  ;
 23965                                  ; Procedure Name : SWAPCON
 23966                                  ;
 23967                                  ;   Copy ThisSFT to CONSFT for use by the 1-12 primitives.
 23968                                  ;
 23969                                  ;   Inputs:	ThisSFT as the sft of the desired file
 23970                                  ;		DS is DOSDATA
 23971                                  ;   Outputs:	CONSWAP is set.  CONSFT = ThisSFT.
 23972                                  ;   Registers modified: none
 23973                                  ;--------------------------------------------------------------------------
 23974                                  
 23975                                  SWAPCON:
 23976                                  	; MSDOS 3.3
 23977                                  	;push	es
 23978                                  	;push	di
 23979                                  	;mov	byte [CONSWAP],1
 23980                                  	;les	di,[THISSFT]
 23981                                  	;mov	word [CONSFT],di
 23982                                  	;mov	word [CONSFT+2],es
 23983                                  	;pop	di
 23984                                  	;pop	es
 23985                                  	;retn
 23986                                  
 23987                                  	; MSDOS 6.0
 23988 00003B67 C606[5703]01            	mov	byte [CONSWAP],1	; ConSwap = TRUE
 23989 00003B6C 50                      	push	ax
 23990 00003B6D A1[9E05]                	mov	ax,[THISSFT]
 23991 00003B70 A3[E605]                	mov	[CONSFT],ax
 23992 00003B73 A1[A005]                	mov	ax,[THISSFT+2]
 23993 00003B76 A3[E805]                	mov	[CONSFT+2],ax
 23994 00003B79 58                      	pop	ax
 23995 00003B7A C3                      	retn
 23996                                  
 23997                                  ; DOSCODE:71FDh (MSDOS 6.21, MSDOS.SYS)
 23998                                  ; 04/05/2019 - Retro DOS v4.0
 23999                                  
 24000                                  ;Break	<DOS_READ -- MAIN READ ROUTINE AND DEVICE IN ROUTINES>
 24001                                  ;-----------------------------------------------------------------------------
 24002                                  ;
 24003                                  ; Inputs:
 24004                                  ;	ThisSFT set to the SFT for the file being used
 24005                                  ;	[DMAADD] contains transfer address
 24006                                  ;	CX = No. of bytes to read
 24007                                  ;	DS = DOSDATA
 24008                                  ; Function:
 24009                                  ;	Perform read operation
 24010                                  ; Outputs:
 24011                                  ;    Carry clear
 24012                                  ;	SFT Position and cluster pointers updated
 24013                                  ;	CX = No. of bytes read
 24014                                  ;	ES:DI point to SFT
 24015                                  ;    Carry set
 24016                                  ;	AX is error code
 24017                                  ;	CX = 0
 24018                                  ;	ES:DI point to SFT
 24019                                  ; DS preserved, all other registers destroyed
 24020                                  ;
 24021                                  ;-----------------------------------------------------------------------------
 24022                                  
 24023                                  ;hkn; called from fcbio.asm, handle.asm and dev.asm. DS is be set up.
 24024                                  
 24025                                  ; DOSCODE:71E9h (MSDOS 5.0, MSDOS.SYS)
 24026                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 24027                                  
 24028                                  ; 07/02/2024
 24029                                  ; 06/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 24030                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:7B76h
 24031                                  
 24032                                  ; (Windows ME IO.SYS - BIOSCODE:7997h)
 24033                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:71FDh)
 24034                                  
 24035                                  DOS_READ:
 24036 00003B7B C43E[9E05]              	LES	DI,[THISSFT]
 24037                                  
 24038                                  ; Verify that the sft has been opened in a mode that allows reading.
 24039                                  
 24040                                  	;mov	al,[es:di+2]
 24041 00003B7F 268A4502                	MOV	AL,[ES:DI+SF_ENTRY.sf_mode]
 24042                                  	;;and	al,0Fh	; (MSDOS 5.0 & 6.22)
 24043                                  	;AND	AL,access_mask
 24044                                  	; 06/02/2024 - Retro DOS v5.0
 24045                                  	; (PCDOS 7.1 & Win Me)
 24046 00003B83 2403                    	and	al,3	; open_mode_mask ?
 24047                                  
 24048                                  	;cmp	al,1
 24049 00003B85 3C01                    	CMP	AL,open_for_write
 24050 00003B87 7503                    	JNE	short READ_NO_MODE	; Is read or both
 24051 00003B89 E96506                  	jmp	SET_ACC_ERR
 24052                                  
 24053                                  READ_NO_MODE:
 24054 00003B8C E82505                  	call	SETUP
 24055 00003B8F E30B                    	JCXZ	NoIORet 		; no bytes to read - fast return
 24056 00003B91 E8A6DC                  	call	IsSFTNet
 24057 00003B94 7408                    	JZ	short LOCAL_READ
 24058                                  
 24059                                  ;IF NOT Installed
 24060                                  ;	transfer NET_READ
 24061                                  ;ELSE
 24062                                  	;mov	ax,1108h
 24063 00003B96 B80811                  	MOV	AX,(MultNET<<8)|8
 24064 00003B99 CD2F                    	int	2Fh	; Multiplex - NETWORK REDIRECTOR - READ FROM REMOTE FILE
 24065                                  			; ES:DI -> SFT
 24066                                  			; SFT DPB field -> DPB of drive containing file
 24067                                  			; CX = number of bytes, SS = DOS CS, SDA DTA field -> user buffer
 24068                                  			; Return: CF set on error, CX = bytes read
 24069 00003B9B C3                      	retn
 24070                                  ;ENDIF
 24071                                  
 24072                                  ; The user ended up requesting 0 bytes of input. We do nothing for this case
 24073                                  ; except return immediately.
 24074                                  
 24075                                  NoIORet:
 24076 00003B9C F8                      	CLC
 24077 00003B9D C3                      	retn
 24078                                  
 24079                                  LOCAL_READ:
 24080                                  	;test	word [es:di+5],80h
 24081                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device  ; Check for named device I/O
 24082 00003B9E 26F6450580              	test	byte [ES:DI+SF_ENTRY.sf_flags],devid_device ; 02/06/2019
 24083 00003BA3 750E                    	JNZ	short READDEV
 24084                                  
 24085                                  	;mov	byte [EXTERR_LOCUS],2
 24086 00003BA5 C606[2303]02            	MOV	byte [EXTERR_LOCUS],errLOC_Disk
 24087 00003BAA E836DD                  	call	ECritDisk
 24088 00003BAD E8F805                  	call	DISKREAD
 24089                                  
 24090                                  critexit:
 24091                                  	;call	LCritDisk
 24092                                  	;retn
 24093                                  	; 16/12/2022
 24094 00003BB0 E95DDD                  	jmp	LCritDisk
 24095                                  
 24096                                  ; We are reading from a device. Examine the status of the device to see if we
 24097                                  ; can short-circuit the I/O. If the device in the EOF state or if it is the
 24098                                  ; null device, we can safely indicate no transfer.
 24099                                  
 24100                                  READDEV:
 24101                                  	;mov	byte [EXTERR_LOCUS],4
 24102 00003BB3 C606[2303]04            	MOV	byte [EXTERR_LOCUS],errLOC_SerDev
 24103                                  	;mov	bl,[es:di+5]
 24104 00003BB8 268A5D05                	MOV	BL,[ES:DI+SF_ENTRY.sf_flags]
 24105 00003BBC C43E[2C03]              	LES	DI,[DMAADD]
 24106                                  	;test	bl,40h
 24107 00003BC0 F6C340                  	test	BL,devid_device_EOF	; End of file?
 24108 00003BC3 7407                    	JZ	short ENDRDDEVJ3
 24109                                  	;test	bl,4
 24110 00003BC5 F6C304                  	test	BL,devid_device_null	; NUL device?
 24111 00003BC8 7405                    	JZ	short TESTRAW 		; NO
 24112 00003BCA 30C0                    	XOR	AL,AL			; Indicate EOF by setting zero
 24113                                  ENDRDDEVJ3:
 24114                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility!)
 24115                                  	;JMP	short ENDRDDEVJ2
 24116                                  	; 16/12/2022
 24117 00003BCC E93F01                  	jmp	ENDRDDEV ; 04/05/2019
 24118                                  
 24119                                  ; We need to hit the device. Figure out if we do a raw read or we do the
 24120                                  ; bizarre std_con_string_input.
 24121                                  
 24122                                  TESTRAW:
 24123                                  	;test	bl,20h
 24124 00003BCF F6C320                  	test	BL,devid_device_raw	; Raw mode?
 24125 00003BD2 7508                    	JNZ	short DVRDRAW 		; Yes, let the device do all local editing
 24126                                  	;test	bl,1
 24127 00003BD4 F6C301                  	test	BL,devid_device_con_in	; Is it console device?
 24128 00003BD7 7458                    	JZ	short NOTRDCON
 24129 00003BD9 E96701                  	JMP	READCON
 24130                                  
 24131                                  DVRDRAW:
 24132 00003BDC 06                      	PUSH	ES
 24133 00003BDD 1F                      	POP	DS			; Xaddr to DS:DI
 24134                                  
 24135                                  	; 04/05/2019 - Retro DOS v4.0
 24136                                  
 24137                                  	; MSDOS 6.0
 24138                                  ;SR;
 24139                                  ;Check for win386 presence -- if present, do polled read of characters
 24140                                  
 24141 00003BDE 36F606[5B0F]01          	test	byte [ss:IsWin386],1 ; 19/05/2019
 24142 00003BE4 7408                    	jz	short ReadRawRetry	;not present
 24143 00003BE6 F6C301                  	test	bl,devid_device_con_in	;is it console device?
 24144 00003BE9 7403                    	jz	short ReadRawRetry	;no, do normal read
 24145 00003BEB E9A800                  	jmp	do_polling		;yes, do win386 polling loop
 24146                                  
 24147                                  ReadRawRetry:
 24148                                  
 24149                                  ; 07/02/2024
 24150                                  %if 0
 24151                                  	MOV	BX,DI			; DS:BX transfer addr
 24152                                  	; 06/02/2024 ; *
 24153                                  	;XOR	AX,AX			; Media Byte, unit = 0
 24154                                  	;;MOV	DX,AX			; Start at 0
 24155                                  	;; 06/02/2024
 24156                                  	;cwd
 24157                                  	;call	SETREAD
 24158                                  	; 06/02/2024 ; *
 24159                                  	call	SETREAD_X
 24160                                  %else
 24161 00003BEE E83917                  	call	SETREAD_XJ
 24162                                  %endif
 24163                                  
 24164 00003BF1 1E                      	PUSH	DS			; Save Seg part of Xaddr
 24165                                  
 24166                                  ;hkn; SS override
 24167 00003BF2 36C536[9E05]            	LDS	SI,[SS:THISSFT]
 24168 00003BF7 E8BA16                  	call	DEVIOCALL
 24169 00003BFA 89FA                    	MOV	DX,DI			; DS:DX is preserved by INT 24
 24170 00003BFC B486                    	MOV	AH,86H			; Read error
 24171                                  
 24172                                  ;hkn; SS override
 24173 00003BFE 368B3E[5D03]            	MOV	DI,[SS:DEVCALL_REQSTAT]
 24174                                  	; MSDOS 3.3
 24175                                  	;test	di,8000h
 24176                                  	;jz	short CRDROK
 24177                                  	; MSDOS 6.0
 24178 00003C03 09FF                    	or	di,di
 24179 00003C05 7920                    	jns	short CRDROK		; no errors
 24180                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24181 00003C07 E84624                  	call	CHARHARD
 24182                                  
 24183                                  ; 06/02/2024 - Retrro DOS v5.0
 24184                                  %if 0
 24185                                  	MOV	DI,DX			; DS:DI is Xaddr
 24186                                  	; 04/05/2019
 24187                                  	; MSDOS 6.0
 24188                                  	add	di,[ss:CALLSCNT]	; update ptr and count to reflect the	M065
 24189                                  	sub	cx,[ss:CALLSCNT]	; number of chars xferred		M065
 24190                                  %else
 24191 00003C0A 368B3E[6C03]            	mov	di,[ss:CALLSCNT]
 24192 00003C0F 29F9                    	sub	cx,di			; update transfer count
 24193 00003C11 01D7                    	add	di,dx			; update pointer
 24194                                  %endif
 24195                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24196 00003C13 08C0                    	OR	AL,AL
 24197 00003C15 7410                    	JZ	short CRDROK		; Ignore
 24198 00003C17 3C03                    	CMP	AL,3
 24199 00003C19 7403                    	JZ	short CRDFERR 		; fail.
 24200 00003C1B 1F                      	POP	DS			; Recover saved seg part of Xaddr
 24201 00003C1C EBD0                    	JMP	short ReadRawRetry	; Retry
 24202                                  
 24203                                  ; We have encountered a device-driver error. We have informed the user of it
 24204                                  ; and he has said for us to fail the system call.
 24205                                  
 24206                                  CRDFERR:
 24207 00003C1E 5F                      	POP	DI			; Clean stack
 24208                                  DEVIOFERR:
 24209                                  
 24210                                  ;hkn; SS override
 24211 00003C1F 36C43E[9E05]            	LES	DI,[SS:THISSFT]
 24212 00003C24 E9C805                  	jmp	SET_ACC_ERR_DS
 24213                                  
 24214                                  CRDROK:
 24215 00003C27 5F                      	POP	DI			; Chuck saved seg of Xaddr
 24216 00003C28 89D7                    	MOV	DI,DX
 24217                                  
 24218                                  ;hkn; SS override
 24219 00003C2A 36033E[6C03]            	ADD	DI,[ss:CALLSCNT]	; Amount transferred
 24220                                  	;JMP	SHORT ENDRDDEVJ3
 24221                                  	; 16/12/2022
 24222 00003C2F EB63                    	jmp	short ENDRDDEVJ2
 24223                                  
 24224                                  ; We are going to do a cooked read on some character device. There is a
 24225                                  ; problem here, what does the data look like? Is it a terminal device, line
 24226                                  ; CR line CR line CR, or is it file data, line CR LF line CR LF? Does it have
 24227                                  ; a ^Z at the end which is data, or is the ^Z not data?  In any event we're
 24228                                  ; going to do this: Read in pieces up to CR (CRs included in data) or ^z (^z
 24229                                  ; included in data). this "simulates" the way con works in cooked mode
 24230                                  ; reading one line at a time. With file data, however, the lines will look
 24231                                  ; like, LF line CR. This is a little weird.
 24232                                  
 24233                                  NOTRDCON:
 24234                                  	;MOV	AX,ES
 24235                                  	;MOV	DS,AX
 24236                                  	; 07/02/2024
 24237 00003C31 06                      	push	es
 24238 00003C32 1F                      	pop	ds
 24239                                  
 24240                                  ; 07/02/2024
 24241                                  %if 0
 24242                                  	MOV	BX,DI
 24243                                  	; 06/02/2024 ; *
 24244                                  	;;XOR	DX,DX
 24245                                  	;;MOV	AX,DX
 24246                                  	;; 06/02/2024
 24247                                  	;xor	ax,ax
 24248                                  	;cwd
 24249                                  	PUSH	CX
 24250                                  	MOV	CX,1
 24251                                  	;call	SETREAD
 24252                                  	; 06/02/2024 ; *
 24253                                  	call	SETREAD_X
 24254                                  	POP	CX
 24255                                  %else
 24256 00003C33 51                      	push	cx
 24257 00003C34 B90100                  	mov	cx,1
 24258 00003C37 E8F016                  	call	SETREAD_XJ
 24259 00003C3A 59                      	pop	cx
 24260                                  %endif
 24261                                  
 24262                                  ;hkn; SS override
 24263 00003C3B 36C536[9E05]            	LDS	SI,[SS:THISSFT]
 24264                                  	;lds	si,[si+7]
 24265 00003C40 C57407                  	LDS	SI,[SI+SF_ENTRY.sf_devptr]
 24266                                  DVRDLP:
 24267 00003C43 E8EA21                  	call	DSKSTATCHK
 24268 00003C46 E86E16                  	call	DEVIOCALL2
 24269 00003C49 57                      	PUSH	DI			; Save "count" done
 24270 00003C4A B486                    	MOV	AH,86H
 24271                                  
 24272                                  ;hkn; SS override
 24273 00003C4C 368B3E[5D03]            	MOV	DI,[SS:DEVCALL_REQSTAT]
 24274                                  	
 24275                                  	; MSDOS 3.3
 24276                                  	;test	di,8000h
 24277                                  	;jz	short CRDOK
 24278                                  	; MSDOS 6.0
 24279 00003C51 09FF                    	or	di,di
 24280 00003C53 7917                    	jns	short CRDOK
 24281                                  	
 24282 00003C55 E8F823                  	call	CHARHARD
 24283 00003C58 5F                      	POP	DI
 24284                                  
 24285                                  ;hkn; SS override
 24286 00003C59 36C706[6C03]0100        	MOV	word [SS:CALLSCNT],1
 24287 00003C60 3C01                    	CMP	AL,1
 24288 00003C62 74DF                    	JZ	short DVRDLP		; Retry
 24289 00003C64 3C03                    	CMP	AL,3
 24290 00003C66 74B7                    	JZ	short DEVIOFERR		; FAIL
 24291 00003C68 30C0                    	XOR	AL,AL			; Ignore, Pick some random character
 24292 00003C6A EB12                    	JMP	SHORT DVRDIGN
 24293                                  
 24294                                  CRDOK:
 24295 00003C6C 5F                      	POP	DI
 24296                                  
 24297                                  ;hkn; SS override
 24298 00003C6D 36833E[6C03]01          	CMP	word [SS:CALLSCNT],1
 24299                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility!)
 24300 00003C73 751F                    	JNZ	short ENDRDDEVJ2
 24301                                  	; 16/12/2022
 24302                                  	;jnz	short ENDRDDEV ; 24/07/2019
 24303                                  
 24304 00003C75 1E                      	PUSH	DS
 24305                                  
 24306                                  ;hkn; SS override
 24307 00003C76 368E1E[6A03]            	MOV	DS,[SS:CALLXAD+2]
 24308 00003C7B 8A05                    	MOV	AL,[DI]			; Get the character we just read
 24309 00003C7D 1F                      	POP	DS
 24310                                  DVRDIGN:
 24311                                  
 24312                                  ;hkn; SS override
 24313 00003C7E 36FF06[6803]            	INC	WORD [SS:CALLXAD]	; Next character
 24314 00003C83 36C706[5D03]0000        	MOV	word [SS:DEVCALL_REQSTAT],0
 24315 00003C8A 47                      	INC	DI			; Next character
 24316 00003C8B 3C1A                    	CMP	AL,1Ah			; ^Z?
 24317                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility!)
 24318 00003C8D 7405                    	JZ	short ENDRDDEVJ2	; Yes, done zero set (EOF)
 24319                                  	; 16/12/2022
 24320                                  	;jz	short ENDRDDEV ; 24/07/2019	
 24321 00003C8F 3C0D                    	CMP	AL,c_CR  ; 0Dh		; CR?
 24322 00003C91 E0B0                    	LOOPNZ	DVRDLP			; Loop if no, else done
 24323 00003C93 40                      	INC	AX			; Resets zero flag so NOT EOF, unless
 24324                                  					;  AX=FFFF which is not likely
 24325                                  ENDRDDEVJ2:
 24326                                  	; 16/12/2022
 24327                                  	;JMP	short ENDRDDEV		; changed short to long for win386
 24328                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 24329 00003C94 EB78                    	jmp	ENDRDDEV
 24330                                  
 24331                                  	; 04/05/2019
 24332                                  
 24333                                  	; MSDOS 6.0
 24334                                  ;SR;
 24335                                  ;Polling code for raw read on CON when WIN386 is present
 24336                                  ;
 24337                                  ;At this point -- ds:di is transfer address
 24338                                  ;		  cx is count
 24339                                  
 24340                                  do_polling:
 24341                                  
 24342                                  ; 07/02/2024
 24343                                  %if 0
 24344                                  	mov	bx,di			;ds:bx is Xfer address
 24345                                  	; 06/02/2024 ; *
 24346                                  	;xor	ax,ax
 24347                                  	;;mov	dx,ax
 24348                                  	;; 06/02/2024
 24349                                  	;cwd
 24350                                  	;call	SETREAD			;prepare device packet
 24351                                  	; 06/02/2024 ; *
 24352                                  	call	SETREAD_X
 24353                                  %else
 24354 00003C96 E89116                  	call	SETREAD_XJ
 24355                                  %endif
 24356                                  
 24357                                  do_io:
 24358                                  ;Change read to a NON-DESTRUCTIVE READ, NO WAIT
 24359                                  
 24360 00003C99 26C6470205              	mov	byte [es:bx+2],DEVRDND ; 5 ;Change command code
 24361 00003C9E 1E                      	push	ds
 24362 00003C9F 36C536[9E05]            	lds	si,[ss:THISSFT]		;get device header
 24363 00003CA4 E80D16                  	call	DEVIOCALL		;call device driver
 24364 00003CA7 1F                      	pop	ds
 24365                                  	
 24366                                  	;test	word [es:bx+3],8000h
 24367                                  	; 16/12/2022
 24368                                  	;test	byte [es:bx+4],80h
 24369 00003CA8 26F6470480              	test	byte [es:bx+SRHEAD.REQSTAT+1],STERR>>8 
 24370                                  	;test	word [es:bx+SRHEAD.REQSTAT],STERR ;check if error
 24371 00003CAD 7413                    	jz	short check_busy	;no
 24372                                  
 24373 00003CAF 1E                      	push	ds
 24374 00003CB0 89FA                    	mov	dx,di
 24375                                  
 24376                                  invoke_charhard:	; 07/02/2024
 24377                                  	;invoke charhard		;invoke int 24h handler
 24378 00003CB2 E89B23                  	call	CHARHARD
 24379 00003CB5 89D7                    	mov	di,dx
 24380 00003CB7 08C0                    	or	al,al
 24381 00003CB9 744D                    	jz	short pop_done_read	;ignore by user, assume read done
 24382 00003CBB 3C03                    	cmp	al,3
 24383 00003CBD 7438                    	jz	short devrderr		;user asked to fail
 24384 00003CBF 1F                      	pop	ds
 24385 00003CC0 EBD7                    	jmp	short do_io		;user asked to retry
 24386                                  
 24387                                  check_busy:
 24388                                  	;test	word [es:bx+3],200h
 24389                                  	; 16/12/2022
 24390 00003CC2 26F6470402              	test	byte [es:bx+SRHEAD.REQSTAT+1],02h
 24391                                  	;test	word [es:bx+SRHEAD.REQSTAT],0200h ;see if busy bit set
 24392 00003CC7 7537                    	jnz	short no_char		;yes, no character available
 24393                                  
 24394                                  ;Character is available. Read in 1 character at a time until all characters
 24395                                  ;are read in or no character is available
 24396                                  
 24397 00003CC9 26C6470204              	mov	byte [es:bx+2],DEVRD ; 4 ;command code is READ now
 24398 00003CCE 26C747120100            	mov	word [es:bx+18],1	;change count to 1 character
 24399 00003CD4 1E                      	push	ds
 24400 00003CD5 36C536[9E05]            	lds	si,[ss:THISSFT]
 24401 00003CDA E8D715                  	call	DEVIOCALL
 24402                                  
 24403 00003CDD 89FA                    	mov	dx,di
 24404 00003CDF B486                    	mov	ah,86h
 24405                                  	;mov	di,[es:bx+3]
 24406 00003CE1 268B7F03                	mov	di,[es:bx+SRHEAD.REQSTAT] ;get returned status
 24407 00003CE5 F7C70080                	test	di,STERR ; 8000h	;was there an error during read?
 24408                                  	;jz	short next_char		;no,read next character
 24409                                  	; 07/02/2024
 24410 00003CE9 75C7                    	jnz	short invoke_charhard
 24411                                  
 24412                                  ; 07/02/2024
 24413                                  %if 0
 24414                                  	;invoke	charhard		;invoke int 24h handler
 24415                                  	call	CHARHARD
 24416                                  	mov	di,dx			;restore di
 24417                                  	or	al,al			;
 24418                                  	jz	short pop_done_read	;ignore by user,assume read is done
 24419                                  	cmp	al,3
 24420                                  	jz	short devrderr		;user issued a 'fail',indicate error
 24421                                  	pop	ds
 24422                                  	jmp	short do_io		;user issued a retry
 24423                                  %endif
 24424                                  
 24425                                  next_char:
 24426 00003CEB 1F                      	pop	ds
 24427 00003CEC 89D7                    	mov	di,dx
 24428 00003CEE 49                      	dec	cx			;decrement count
 24429                                  	;jcxz	done_read		;all characters read in
 24430                                  	; 07/02/2024
 24431 00003CEF 7418                    	jz	short done_read
 24432 00003CF1 26FF470E                	inc	word [es:bx+14]		;update transfer address
 24433 00003CF5 EBA2                    	jmp	short do_io		;read next character in
 24434                                  
 24435                                  devrderr:
 24436 00003CF7 5F                      	pop	di			;discard segment address
 24437 00003CF8 36C43E[9E05]            	les	di,[ss:THISSFT]
 24438                                  	;transfer SET_ACC_ERR_DS	;indicate error
 24439 00003CFD E9EF04                  	jmp     SET_ACC_ERR_DS
 24440                                  
 24441                                  no_char:
 24442                                  ;Since no character is available, we let win386 switch the VM out
 24443                                  
 24444 00003D00 50                      	push	ax
 24445 00003D01 B484                    	mov	ah,84h	; Microsoft Networks - KEYBOARD BUSY LOOP
 24446 00003D03 CD2A                    	int	2Ah			;indicate idle to WIN386
 24447                                  
 24448                                  ;When control returns from WIN386, we continue the raw read
 24449                                  
 24450 00003D05 58                      	pop	ax
 24451 00003D06 EB91                    	jmp	do_io
 24452                                  
 24453                                  pop_done_read:
 24454 00003D08 1F                      	pop	ds
 24455                                  done_read:
 24456 00003D09 36033E[6C03]            	add	di,[ss:CALLSCNT] ; 19/05/2019
 24457                                  
 24458                                  	; 16/12/2022
 24459                                  
 24460                                  	;jmp	ENDRDDEVJ3	;jump back to normal DOS raw read exit
 24461                                  	;jmp	ENDRDDEV ; 04/05/2019
 24462                                  
 24463                                  	; 04/05/2019 - Retro DOS v4.0
 24464                                  ENDRDDEV:
 24465 00003D0E 16                      	push	ss
 24466 00003D0F 1F                      	pop	ds
 24467 00003D10 EB1F                    	jmp	short endrddev1
 24468                                  
 24469                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 24470                                  	;jmp	ENDRDDEVJ3	;jump back to normal DOS raw read exit
 24471                                  
 24472                                  TRANBUF:
 24473 00003D12 AC                      	LODSB
 24474 00003D13 AA                      	STOSB
 24475 00003D14 3C0D                    	CMP	AL,c_CR ; 0Dh	; Check for carriage return
 24476 00003D16 7503                    	JNZ	short NORMCH
 24477 00003D18 C6040A                  	MOV	BYTE [SI],c_LF ; 0Ah
 24478                                  NORMCH:
 24479 00003D1B 3C0A                    	CMP	AL,c_LF ; 0Ah
 24480 00003D1D E0F3                    	LOOPNZ	TRANBUF
 24481 00003D1F 7507                    	JNZ	short ENDRDCON
 24482 00003D21 31F6                    	XOR	SI,SI		; Cause a new buffer to be read
 24483 00003D23 E807DF                  	call	OUTT		; Transmit linefeed
 24484 00003D26 0C01                    	OR	AL,1		; Clear zero flag--not end of file
 24485                                  ENDRDCON:
 24486                                  ;hkn; SS is DOSDATA
 24487 00003D28 16                      	push	ss
 24488 00003D29 1F                      	pop	ds
 24489 00003D2A E834FE                  	CALL	SWAPBACK
 24490 00003D2D 8936[2200]              	MOV	[CONTPOS],SI
 24491                                  
 24492                                  	; 16/12/2022
 24493                                  ;ENDRDDEV:
 24494                                  ;;hkn; SS is DOSDATA
 24495                                  ;	push	ss
 24496                                  ;	pop	ds
 24497                                  endrddev1:	; 04/05/2019
 24498 00003D31 893E[B805]              	MOV	[NEXTADD],DI
 24499 00003D35 7509                    	JNZ	short SETSFTC 	; Zero set if Ctrl-Z found in input
 24500 00003D37 C43E[9E05]              	LES	DI,[THISSFT]
 24501                                  	;and	byte [es:di+5],0BFh
 24502 00003D3B 26806505BF              	AND	BYTE [ES:DI+SF_ENTRY.sf_flags],~devid_device_EOF
 24503                                  				; Mark as no more data available
 24504                                  SETSFTC:
 24505                                  	; 31/07/2019
 24506                                  	;call	SETSFT
 24507                                  	;retn
 24508 00003D40 E95B05                  	jmp	SETSFT
 24509                                  
 24510                                  ; 16/12/2022
 24511                                  %if 0
 24512                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 24513                                  ENDRDDEV:
 24514                                  ;hkn; SS is DOSDATA
 24515                                  	push	ss
 24516                                  	pop	ds
 24517                                  	MOV	[NEXTADD],DI
 24518                                  	JNZ	short SETSFTC 	; Zero set if Ctrl-Z found in input
 24519                                  	LES	DI,[THISSFT]
 24520                                  	;and	byte [es:di+5],0BFh
 24521                                  	AND	BYTE [ES:DI+SF_ENTRY.sf_flags],~devid_device_EOF
 24522                                  				; Mark as no more data available
 24523                                  SETSFTC:
 24524                                  	;call	SETSFT
 24525                                  	;retn
 24526                                  	jmp	SETSFT	
 24527                                  %endif
 24528                                  
 24529                                  READCON:
 24530 00003D43 E821FE                  	CALL	SWAPCON
 24531 00003D46 8B36[2200]              	MOV	SI,[CONTPOS]
 24532 00003D4A 09F6                    	OR	SI,SI
 24533 00003D4C 75C4                    	JNZ	short TRANBUF
 24534 00003D4E 803E[7B02]80            	CMP	BYTE [CONBUF],128 ; 80h
 24535 00003D53 7406                    	JZ	short GETBUF
 24536 00003D55 C706[7B02]80FF          	MOV	WORD [CONBUF],0FF80H ; Set up 128-byte buffer with no template
 24537                                  GETBUF:
 24538 00003D5B 51                      	PUSH	CX
 24539 00003D5C 06                      	PUSH	ES
 24540 00003D5D 57                      	PUSH	DI
 24541                                  
 24542                                  ;hkn; CONBUF is in DOSDATA
 24543 00003D5E BA[7B02]                	MOV	DX,CONBUF
 24544                                  
 24545 00003D61 E844DC                  	call	_$STD_CON_STRING_INPUT	; Get input buffer
 24546 00003D64 5F                      	POP	DI
 24547 00003D65 07                      	POP	ES
 24548 00003D66 59                      	POP	CX
 24549                                  
 24550                                  ;hkn; CONBUF is in DOSDATA
 24551 00003D67 BE[7D02]                	MOV	SI,CONBUF+2
 24552                                  
 24553 00003D6A 803C1A                  	CMP	BYTE [SI],1AH	; Check for Ctrl-Z in first character
 24554 00003D6D 75A3                    	JNZ	short TRANBUF
 24555 00003D6F B01A                    	MOV	AL,1AH
 24556 00003D71 AA                      	STOSB
 24557 00003D72 4F                      	DEC	DI
 24558 00003D73 B00A                    	MOV	AL,c_LF
 24559 00003D75 E8B5DE                  	call	OUTT		; Send linefeed
 24560 00003D78 31F6                    	XOR	SI,SI
 24561 00003D7A EBAC                    	JMP	short ENDRDCON ; 04/05/2019
 24562                                  
 24563                                  ; 24/07/2018 - Retro DOS v3.0
 24564                                  
 24565                                  ;Break	<DOS_WRITE -- MAIN WRITE ROUTINE AND DEVICE OUT ROUTINES>
 24566                                  ;---------------------------------------------------------------------------
 24567                                  ;
 24568                                  ; Procedure Name : DOS_WRITE
 24569                                  ;
 24570                                  ; Inputs:
 24571                                  ;	ThisSFT set to the SFT for the file being used
 24572                                  ;	[DMAADD] contains transfer address
 24573                                  ;	CX = No. of bytes to write
 24574                                  ; Function:
 24575                                  ;	Perform write operation
 24576                                  ;	NOTE: If CX = 0 on input, file is truncated or grown
 24577                                  ;		to current sf_position
 24578                                  ; Outputs:
 24579                                  ;    Carry clear
 24580                                  ;	SFT Position and cluster pointers updated
 24581                                  ;	CX = No. of bytes written
 24582                                  ;	ES:DI point to SFT
 24583                                  ;    Carry set
 24584                                  ;	AX is error code
 24585                                  ;	CX = 0
 24586                                  ;	ES:DI point to SFT
 24587                                  ; DS preserved, all other registers destroyed
 24588                                  ;---------------------------------------------------------------------------
 24589                                  
 24590                                  ;hkn; called from fcbio2.asm, handle.asm and dev.asm. DS is set up at this 
 24591                                  ;hkn; point to DOSDATA.
 24592                                  
 24593                                  ; 04/05/2019 - Retro DOS v4.0
 24594                                  ; DOSCODE:742Ch (MSDOS 6.21, MSDOS.SYS)
 24595                                  
 24596                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 24597                                  ; DOSCODE:7418h (MSDOS 5.0, MSDOS.SYS)
 24598                                  
 24599                                  ; 08/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 24600                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:7D8Fh
 24601                                  
 24602                                  DOS_WRITE:
 24603 00003D7C C43E[9E05]              	LES	DI,[THISSFT]
 24604                                  	;mov	al,[ES:DI+2]
 24605 00003D80 268A4502                	MOV	AL,[ES:DI+SF_ENTRY.sf_mode]
 24606                                  	;;and	al,0Fh
 24607                                  	;AND	AL,access_mask
 24608                                  	; 07/02/2024 - Retro DOS v5.0
 24609                                  	; (PCDOS 7.1 & Win Me)
 24610 00003D84 2403                    	and	al,3	; open_mode_mask ?
 24611                                  	;cmp	al,0
 24612 00003D86 3C00                    	CMP	AL,open_for_read
 24613 00003D88 7503                    	JNE	short Check_FCB_RO		 ;Is write or both
 24614                                  BadMode:
 24615 00003D8A E96404                  	jmp	SET_ACC_ERR
 24616                                  
 24617                                  ; NOTE: The following check for writting to a Read Only File is performed
 24618                                  ;	    ONLY on FCBs!!!!
 24619                                  ;	We ALLOW writes to Read Only files via handles to allow a CREATE
 24620                                  ;	    of a read only file which can then be written to.
 24621                                  ;	This is OK because we are NOT ALLOWED to OPEN a RO file via handles
 24622                                  ;	    for writting, or RE-CREATE an EXISTING RO file via handles. Thus,
 24623                                  ;	    CREATing a NEW RO file, or RE-CREATing an existing file which
 24624                                  ;	    is NOT RO to be RO, via handles are the only times we can write
 24625                                  ;	    to a read-only file.
 24626                                  
 24627                                  Check_FCB_RO:
 24628                                  	;;test	word [es:di+2],8000h
 24629                                  	;TEST	word [ES:DI+SF_ENTRY.sf_mode],sf_isFCB
 24630                                  	;JZ	short WRITE_NO_MODE	; Not an FCB
 24631                                  	
 24632                                  	;test	byte [es:di+3],80h
 24633 00003D8D 26F6450380              	TEST	byte [ES:DI+SF_ENTRY.sf_mode+1],(sf_isFCB>>8)
 24634 00003D92 7407                    	JZ	short WRITE_NO_MODE	; Not an FCB
 24635                                  
 24636                                  	;test	byte [es:di+4],1
 24637 00003D94 26F6450401              	TEST	byte [ES:DI+SF_ENTRY.sf_attr],attr_read_only
 24638 00003D99 75EF                    	JNZ	short BadMode 		; Can't write to Read_Only files via FCB
 24639                                  WRITE_NO_MODE:
 24640 00003D9B E81603                  	call	SETUP
 24641 00003D9E E899DA                  	call	IsSFTNet
 24642 00003DA1 7406                    	JZ	short LOCAL_WRITE
 24643                                  
 24644                                  ;IF NOT Installed
 24645                                  ;	transfer NET_WRITE
 24646                                  ;ELSE
 24647                                  	;mov	ax,1109h
 24648 00003DA3 B80911                  	MOV	AX,(MultNET<<8)|9
 24649 00003DA6 CD2F                    	int	2Fh	; Multiplex - NETWORK REDIRECTOR - WRITE TO REMOTE FILE
 24650                                  			; ES:DI -> SFT
 24651                                  			; SFT DPB field -> DPB of drive containing file
 24652                                  			; CX = number of bytes, SS = DOS CS, SDA DTA field -> user buffer
 24653                                  			; Return: CF set on error, CX = bytes written
 24654 00003DA8 C3                      	retn
 24655                                  ;ENDIF
 24656                                  
 24657                                  LOCAL_WRITE:
 24658                                  	;;test	word [es:di+5],80h
 24659                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device
 24660                                  	;jnz	short WRTDEV
 24661                                  
 24662                                  	;test	byte [es:di+5],80h
 24663 00003DA9 26F6450580              	TEST	byte [ES:DI+SF_ENTRY.sf_flags],devid_device ; Check for named device I/O
 24664 00003DAE 756D                    	jnz	short WRTDEV
 24665                                  
 24666                                  	;mov	byte [EXTERR_LOCUS],2
 24667 00003DB0 C606[2303]02            	MOV	byte [EXTERR_LOCUS],errLOC_Disk
 24668 00003DB5 E82BDB                  	call	ECritDisk
 24669                                  
 24670 00003DB8 E8A905                  	call	DISKWRITE
 24671                                  
 24672                                  	; 04/05/2019 - Retro DOS v4.0
 24673                                  
 24674                                  	; MSDOS 6.0
 24675                                  ; Extended Open
 24676 00003DBB 7210                    	JC	short nocommit
 24677                                  	
 24678 00003DBD C43E[9E05]              	LES	DI,[THISSFT]
 24679                                  	
 24680                                  	;;test	word [ES:DI+2],4000h
 24681                                  	;TEST	word [ES:DI+SF_ENTRY.sf_mode],AUTO_COMMIT_WRITE
 24682                                  	;JZ	short nocommit
 24683                                  	
 24684                                  	;test	byte [ES:DI+3],40h
 24685 00003DC1 26F6450340              	TEST	byte [ES:DI+SF_ENTRY.sf_mode+1],(AUTO_COMMIT_WRITE>>8)
 24686 00003DC6 7405                    	JZ	short nocommit
 24687                                  	
 24688 00003DC8 51                      	PUSH	CX
 24689 00003DC9 E808FB                  	call	DOS_COMMIT
 24690 00003DCC 59                      	POP	CX
 24691                                  nocommit:
 24692                                  ; Extended Open
 24693                                  	;call	LCritDisk
 24694                                  	;retn
 24695                                  	; 18/12/2022
 24696 00003DCD E940DB                  	jmp	LCritDisk
 24697                                  
 24698                                  DVWRTRAW:
 24699 00003DD0 31C0                    	XOR	AX,AX			; Media Byte, unit = 0
 24700 00003DD2 E89615                  	call	SETWRITE
 24701 00003DD5 1E                      	PUSH	DS			; Save seg of transfer
 24702                                  
 24703                                  ;hkn; SS override
 24704 00003DD6 36C536[9E05]            	LDS	SI,[SS:THISSFT]
 24705 00003DDB E8D614                  	call	DEVIOCALL		; DS:SI -> DEVICE
 24706                                  
 24707 00003DDE 89FA                    	MOV	DX,DI			; Offset part of Xaddr saved in DX
 24708 00003DE0 B487                    	MOV	AH,87H
 24709                                  
 24710                                  ;hkn; SS override
 24711 00003DE2 368B3E[5D03]            	MOV	DI,[SS:DEVCALL_REQSTAT]
 24712                                  
 24713                                  	; MSDOS 3.3
 24714                                  	;test	di,8000h
 24715                                  	;jz	short CWRTROK
 24716                                  
 24717                                  	; MSDOS 6.0
 24718 00003DE7 09FF                    	or	di,di
 24719 00003DE9 791F                    	jns	short CWRTROK
 24720                                  	
 24721                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24722 00003DEB E86222                  	call	CHARHARD
 24723                                  
 24724                                  	; 04/05/2019  - Retro DOS v4.0
 24725                                  
 24726                                  	; 08/02/2024
 24727 00003DEE 368B3E[6C03]            	mov	di,[ss:CALLSCNT]
 24728                                  	; MSDOS 6.0
 24729                                  	;sub	cx,[ss:CALLSCNT]	; update ptr & count to reflect	M065
 24730 00003DF3 29F9                    	sub	cx,di
 24731 00003DF5 89D3                    	mov	bx,dx			; number of chars xferred	M065
 24732                                  	;add	bx,[ss:CALLSCNT]	;				M065
 24733 00003DF7 01FB                    	add	bx,di
 24734 00003DF9 89DF                    	mov	di,bx			;				M065
 24735                                  	
 24736                                  	; MSDOS 3.3
 24737                                  	;MOV	BX,DX			; Recall transfer addr		M065
 24738                                  
 24739                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24740 00003DFB 08C0                    	OR	AL,AL
 24741 00003DFD 740B                    	JZ	short CWRTROK 		; Ignore
 24742 00003DFF 3C03                    	CMP	AL,3
 24743 00003E01 7403                    	JZ	short CWRFERR
 24744 00003E03 1F                      	POP	DS			; Recover saved seg of transfer
 24745 00003E04 EBCA                    	JMP	short DVWRTRAW		; Try again
 24746                                  CWRFERR:
 24747 00003E06 58                      	POP	AX			; Chuck saved seg of transfer
 24748 00003E07 E914FE                  	JMP	CRDFERR 		; Will pop one more stack element
 24749                                  CWRTROK:
 24750 00003E0A 58                      	POP	AX			; Chuck saved seg of transfer
 24751 00003E0B 1F                      	POP	DS
 24752 00003E0C A1[6C03]                	MOV	AX,[CALLSCNT]		; Get actual number of bytes transferred
 24753                                  ENDWRDEV:
 24754 00003E0F C43E[9E05]              	LES	DI,[THISSFT]
 24755 00003E13 89C1                    	MOV	CX,AX
 24756                                  	;call	ADDREC
 24757                                  	;retn
 24758                                  	; 16/12/2022
 24759                                  	; 10/06/2019
 24760 00003E15 E9B504                  	jmp	ADDREC
 24761                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 24762                                  	;call	ADDREC
 24763                                  	;retn
 24764                                  	
 24765                                  WRTNUL:
 24766 00003E18 89CA                    	MOV	DX,CX			; Entire transfer done
 24767                                  WRTCOOKJ:
 24768 00003E1A E98D00                  	JMP	WRTCOOKDONE
 24769                                  WRTDEV:
 24770                                  	;mov	byte [EXTERR_LOCUS],4
 24771 00003E1D C606[2303]04            	MOV	byte [EXTERR_LOCUS],errLOC_SerDev
 24772                                  	;or	byte [es:di+5],40h
 24773 00003E22 26804D0540              	OR	BYTE [ES:DI+SF_ENTRY.sf_flags],devid_device_EOF
 24774                                  					; Reset EOF for input
 24775                                  	;mov	bl,[es:di+5]
 24776 00003E27 268A5D05                	MOV	BL,[ES:DI+SF_ENTRY.sf_flags]
 24777 00003E2B 31C0                    	XOR	AX,AX
 24778 00003E2D E3E0                    	JCXZ	ENDWRDEV		; problem of creating on a device.
 24779 00003E2F 1E                      	PUSH	DS
 24780 00003E30 88D8                    	MOV	AL,BL
 24781 00003E32 C51E[2C03]              	LDS	BX,[DMAADD]		; Xaddr to DS:BX
 24782 00003E36 89DF                    	MOV	DI,BX			; Xaddr to DS:DI
 24783                                  	; 08/02/2024
 24784                                  	;cwd
 24785 00003E38 31D2                    	XOR	DX,DX			; Set starting point
 24786                                  	;test	al,20h
 24787 00003E3A A820                    	test	AL,devid_device_raw	; Raw?
 24788                                  	;JZ	short TEST_DEV_CON
 24789                                  	;JMP	DVWRTRAW
 24790                                  	; 16/12/2022
 24791 00003E3C 7592                    	jnz	short DVWRTRAW
 24792                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 24793                                  	;JZ	short TEST_DEV_CON
 24794                                  	;JMP	short DVWRTRAW
 24795                                  
 24796                                  TEST_DEV_CON:
 24797                                  	;test	al,2
 24798 00003E3E A802                    	test	AL,devid_device_con_out ; Console output device?
 24799 00003E40 756E                    	jnz	short WRITECON
 24800                                  	;test	al,4
 24801 00003E42 A804                    	test	AL,devid_device_null
 24802 00003E44 75D2                    	JNZ	short WRTNUL
 24803 00003E46 89D0                    	MOV	AX,DX
 24804 00003E48 803F1A                  	CMP	BYTE [BX],1Ah		; ^Z?
 24805 00003E4B 74CD                    	JZ	short WRTCOOKJ		; Yes, transfer nothing
 24806 00003E4D 51                      	PUSH	CX
 24807 00003E4E B90100                  	MOV	CX,1
 24808 00003E51 E81715                  	call	SETWRITE
 24809 00003E54 59                      	POP	CX
 24810                                  
 24811                                  ;hkn; SS override
 24812 00003E55 36C536[9E05]            	LDS	SI,[SS:THISSFT]
 24813                                  ;
 24814                                  ;SR; Removed X25 support from here
 24815                                  ;
 24816                                  	;lds	si,[si+7]
 24817 00003E5A C57407                  	LDS	SI,[SI+SF_ENTRY.sf_devptr]
 24818                                  DVWRTLP:
 24819 00003E5D E8D01F                  	call	DSKSTATCHK
 24820 00003E60 E85414                  	call	DEVIOCALL2
 24821 00003E63 57                      	PUSH	DI
 24822 00003E64 B487                    	MOV	AH,87H
 24823                                  
 24824                                  ;hkn; SS override
 24825 00003E66 368B3E[5D03]            	MOV	DI,[SS:DEVCALL_REQSTAT]
 24826                                  	
 24827                                  	; MSDOS 3.3
 24828                                  	;test	di,8000h
 24829                                  	;jz	short CWROK
 24830                                  
 24831                                  	; MSDOS 6.0
 24832 00003E6B 09FF                    	or	di,di
 24833 00003E6D 7916                    	jns	short CWROK
 24834                                  	
 24835                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24836 00003E6F E8DE21                  	call	CHARHARD
 24837 00003E72 5F                      	POP	DI
 24838                                  
 24839                                  ;hkn; SS override
 24840 00003E73 36C706[6C03]0100        	MOV	word [SS:CALLSCNT],1
 24841 00003E7A 3C01                    	CMP	AL,1
 24842 00003E7C 74DF                    	JZ	short DVWRTLP 	; Retry
 24843 00003E7E 08C0                    	OR	AL,AL
 24844 00003E80 740C                    	JZ	short DVWRTIGN	; Ignore
 24845                                  	; 10/08/2018
 24846 00003E82 E999FD                  	JMP	CRDFERR 	; Fail, pops one stack element
 24847                                  CWROK:
 24848 00003E85 5F                      	POP	DI
 24849                                  
 24850                                  ;hkn; SS override
 24851 00003E86 36833E[6C03]00          	CMP	word [SS:CALLSCNT],0
 24852 00003E8C 741C                    	JZ	short WRTCOOKDONE
 24853                                  DVWRTIGN:
 24854 00003E8E 42                      	INC	DX
 24855                                  
 24856                                  ;hkn; SS override for CALLXAD
 24857 00003E8F 36FF06[6803]            	INC	WORD [SS:CALLXAD]
 24858 00003E94 47                      	INC	DI
 24859 00003E95 1E                      	PUSH	DS
 24860 00003E96 368E1E[6A03]            	MOV	DS,[SS:CALLXAD+2]
 24861 00003E9B 803D1A                  	CMP	BYTE [DI],1Ah	; ^Z?
 24862 00003E9E 1F                      	POP	DS
 24863 00003E9F 7409                    	JZ	short WRTCOOKDONE
 24864                                  
 24865                                  ;hkn; SS override
 24866 00003EA1 36C706[5D03]0000        	MOV	word [SS:DEVCALL_REQSTAT],0
 24867 00003EA8 E2B3                    	LOOP	DVWRTLP
 24868                                  WRTCOOKDONE:
 24869 00003EAA 89D0                    	MOV	AX,DX
 24870 00003EAC 1F                      	POP	DS
 24871 00003EAD E95FFF                  	JMP	ENDWRDEV ; 10/08/2018
 24872                                  
 24873                                  WRITECON:
 24874 00003EB0 1E                      	PUSH	DS
 24875                                  
 24876                                  ;hkn; SS is DOSDATA
 24877 00003EB1 16                      	push	ss
 24878 00003EB2 1F                      	pop	ds
 24879 00003EB3 E8B1FC                  	CALL	SWAPCON
 24880 00003EB6 1F                      	POP	DS
 24881 00003EB7 89DE                    	MOV	SI,BX
 24882 00003EB9 51                      	PUSH	CX
 24883                                  WRCONLP:
 24884 00003EBA AC                      	LODSB
 24885 00003EBB 3C1A                    	CMP	AL,1Ah		; ^Z?
 24886 00003EBD 7405                    	JZ	short CONEOF
 24887 00003EBF E86BDD                  	call	OUTT
 24888 00003EC2 E2F6                    	LOOP	WRCONLP
 24889                                  CONEOF:
 24890 00003EC4 58                      	POP	AX			; Count
 24891 00003EC5 29C8                    	SUB	AX,CX			; Amount actually written
 24892 00003EC7 1F                      	POP	DS
 24893 00003EC8 E896FC                  	CALL	SWAPBACK
 24894 00003ECB E941FF                  	JMP	ENDWRDEV
 24895                                  
 24896                                  ;---------------------------------------------------------------------------
 24897                                  ;
 24898                                  ; Procedure Name : get_io_sft
 24899                                  ;
 24900                                  ;   Convert JFN number in BX to sf_entry in DS:SI We get the normal SFT if
 24901                                  ;   CONSWAP is FALSE or if the handle desired is 2 or more. Otherwise, we
 24902                                  ;   retrieve the sft from ConSFT which is set by SwapCon.
 24903                                  ;
 24904                                  ;---------------------------------------------------------------------------
 24905                                  
 24906                                  ; 04/05/2019 - Retro DOS v4.0
 24907                                  ; DOSCODE:7583h (MSDOS 6.21, MSDOS.SYS)
 24908                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 24909                                  ; DOSCODE:756Fh (MSDOS 5.0, MSDOS.SYS)
 24910                                  
 24911                                  GET_IO_SFT:
 24912                                  	;test	byte [SS:CONSWAP],0FFh
 24913 00003ECE 36803E[5703]00          	cmp	byte [SS:CONSWAP],0			;smr;SS Override
 24914 00003ED4 7512                    	JNZ	short GetRedir
 24915                                  GetNormal:
 24916 00003ED6 16                      	push	ss
 24917 00003ED7 1F                      	pop	ds
 24918 00003ED8 06                      	PUSH	ES
 24919 00003ED9 57                      	PUSH	DI
 24920 00003EDA E82338                  	call	SFFromHandle
 24921 00003EDD 7206                    	JC	short RET44P
 24922 00003EDF 8CC6                    	MOV	SI,ES
 24923 00003EE1 8EDE                    	MOV	DS,SI
 24924 00003EE3 89FE                    	MOV	SI,DI
 24925                                  RET44P:
 24926 00003EE5 5F                      	POP	DI
 24927 00003EE6 07                      	POP	ES
 24928 00003EE7 C3                      	retn
 24929                                  GetRedir:
 24930 00003EE8 83FB01                  	CMP	BX,1
 24931 00003EEB 77E9                    	JA	short GetNormal
 24932 00003EED 36C536[E605]            	LDS	SI,[SS:CONSFT]
 24933 00003EF2 F8                      	CLC
 24934                                  get_io_sft_retn:
 24935 00003EF3 C3                      	retn
 24936                                  
 24937                                  ;Break	<DIRREAD -- READ A DIRECTORY SECTOR>
 24938                                  ;---------------------------------------------------------------------------
 24939                                  ;
 24940                                  ; Procedure Name : DIRREAD
 24941                                  ;
 24942                                  ; Inputs:
 24943                                  ;	AX = Directory block number (relative to first block of directory)
 24944                                  ;	ES:BP = Base of drive parameters
 24945                                  ;	[DIRSEC] = First sector of first cluster of directory
 24946                                  ;	[CLUSNUM] = Next cluster
 24947                                  ;	[CLUSFAC] = Sectors/Cluster
 24948                                  ; Function:
 24949                                  ;	Read the directory block into [CURBUF].
 24950                                  ; Outputs:
 24951                                  ;	[NXTCLUSNUM] = Next cluster (after the one skipped to)
 24952                                  ;	[SECCLUSPOS] Set
 24953                                  ;	ES:BP unchanged
 24954                                  ;	[CURBUF] Points to Buffer with dir sector
 24955                                  ;	Carry set if error (user said FAIL to I 24)
 24956                                  ; DS preserved, all other registers destroyed.
 24957                                  ;---------------------------------------------------------------------------
 24958                                  
 24959                                  ;hkn; called from dir.asm. DS already set up to DOSDATA.
 24960                                  
 24961                                  ; 08/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 24962                                  
 24963                                  DIRREAD:
 24964                                  
 24965                                  ; Note that ClusFac is the sectors per cluster. This is NOT necessarily
 24966                                  ; the same as what is in the DPB! In the case of the root directory, we have
 24967                                  ; ClusFac = # sectors in the root directory. The root directory is detected
 24968                                  ; by DIRStart = 0.
 24969                                  
 24970 00003EF4 31D2                    	XOR	DX,DX
 24971                                  	; 08/02/2024 (PCDOS 7.1)
 24972 00003EF6 3916[DC0A]              	cmp	[DIRSTART_HW],dx
 24973 00003EFA 7509                    	jnz	short SubDir
 24974                                  	;CMP	word [DIRSTART],0
 24975                                  	; 21/09/2023
 24976 00003EFC 3916[C205]              	cmp	[DIRSTART],dx ; 0
 24977 00003F00 7503                    	jnz	short SubDir
 24978 00003F02 92                      	XCHG	AX,DX
 24979 00003F03 EB0C                    	JMP	short DoRead
 24980                                  
 24981                                  ; Convert the sector number in AX into cluster and sector-within-cluster pair
 24982                                  
 24983                                  SubDir:
 24984 00003F05 88C2                    	MOV	DL,AL
 24985                                  	;and	dl,[es:bp+4]
 24986 00003F07 26225604                	AND	DL,[ES:BP+DPB.CLUSTER_MASK]
 24987                                  
 24988                                  ;	(DX) = sector-in-cluster
 24989                                  
 24990                                  	;mov	cl,[es:bp+5]
 24991 00003F0B 268A4E05                	MOV	CL,[ES:BP+DPB.CLUSTER_SHIFT]
 24992 00003F0F D3E8                    	SHR	AX,CL
 24993                                  
 24994                                  ;	(DX) = position in cluster
 24995                                  ;	(AX) = number of clusters to skip
 24996                                  
 24997                                  DoRead:
 24998 00003F11 8816[7305]              	MOV	[SECCLUSPOS],DL
 24999 00003F15 89C1                    	MOV	CX,AX
 25000 00003F17 88D4                    	MOV	AH,DL
 25001                                  
 25002                                  ;	(CX) = number of clusters to skip.
 25003                                  ;	(AH) = remainder
 25004                                  
 25005                                  	; 04/05/2019 - Retro DOS v4.0
 25006                                  
 25007                                  ; 08/02/2024
 25008                                  %if 0
 25009                                  	; MSDOS 6.0
 25010                                  	;MOV	DX,[DIRSEC+2]	     	  ;>32mb
 25011                                  	;MOV	[HIGH_SECTOR],DX	  ;>32mb
 25012                                  	;MOV	DX,[DIRSEC]
 25013                                  	;ADD	DL,AH
 25014                                  	;ADC	DH,0
 25015                                  	;ADC	word [HIGH_SECTOR],0	  ;>32mb
 25016                                  	; 21/09/2023
 25017                                  	xor	bx,bx ; 0
 25018                                  	mov	dx,[DIRSEC]
 25019                                  	add	dl,ah
 25020                                  	adc	dh,bl ; 0
 25021                                  	adc	bx,[DIRSEC+2]
 25022                                  	mov	[HIGH_SECTOR],bx
 25023                                  
 25024                                  	MOV	BX,[CLUSNUM]
 25025                                  	MOV	[NXTCLUSNUM],BX
 25026                                  	JCXZ	FIRSTCLUSTER
 25027                                  %else
 25028                                  	; 08/02/2024 (PCDOS 7.1)
 25029 00003F19 8B1E[DE0A]              	mov	bx,[CLUSNUM_HW]
 25030 00003F1D 891E[E00A]              	mov	[NXTCLUSNUM_HW],bx
 25031 00003F21 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 25032 00003F25 8B16[C005]              	mov	dx,[DIRSEC+2]
 25033 00003F29 8916[0706]              	mov	[HIGH_SECTOR],dx
 25034 00003F2D 8B16[BE05]              	mov	dx,[DIRSEC]
 25035 00003F31 00E2                    	add	dl,ah
 25036 00003F33 80D600                  	adc	dh,0
 25037 00003F36 8316[0706]00            	adc	word [HIGH_SECTOR],0
 25038 00003F3B 8B1E[BC05]              	mov	bx,[CLUSNUM]
 25039 00003F3F 891E[DC05]              	mov	[NXTCLUSNUM],bx
 25040 00003F43 E339                    	jcxz	FIRSTCLUSTER
 25041                                  %endif
 25042                                  
 25043                                  SKPCLLP:
 25044 00003F45 E8C823                  	call	UNPACK
 25045 00003F48 72A9                    	jc	short get_io_sft_retn
 25046                                  	;;;
 25047                                  	; 08/02/2024 (PCDOS 7.1)
 25048 00003F4A FF36[E80A]              	push	word [CLUSTNUM_HW]
 25049 00003F4E 8F06[F20A]              	pop	word [CLUSTERS_HW]
 25050 00003F52 FF36[EC0A]              	push	word [CCONTENT_HW]
 25051 00003F56 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 25052                                  	;;;
 25053 00003F5A 87DF                    	XCHG	BX,DI
 25054 00003F5C E88823                  	call	IsEOF			; test for eof based on fat size
 25055 00003F5F 7302                    	JAE	short HAVESKIPPED
 25056 00003F61 E2E2                    	LOOP	SKPCLLP
 25057                                  HAVESKIPPED:
 25058 00003F63 891E[DC05]              	MOV	[NXTCLUSNUM],BX
 25059                                  	;;;
 25060                                  	; 08/02/2024 (PCDOS 7.1)
 25061 00003F67 8B1E[E80A]              	mov	bx,[CLUSTNUM_HW]
 25062 00003F6B 891E[E00A]              	mov	[NXTCLUSNUM_HW],bx
 25063                                  	;
 25064 00003F6F 8B1E[F20A]              	mov	bx,[CLUSTERS_HW]
 25065 00003F73 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 25066                                  	;;;
 25067 00003F77 89FA                    	MOV	DX,DI
 25068 00003F79 88E3                    	MOV	BL,AH
 25069 00003F7B E83A1A                  	call	FIGREC
 25070                                  
 25071                                  	;entry	FIRSTCLUSTER
 25072                                  
 25073                                  FIRSTCLUSTER:
 25074                                  	; 22/09/2023
 25075                                  	;;mov	byte [ALLOWED],18h
 25076                                  	;MOV	byte [ALLOWED],Allowed_RETRY+Allowed_FAIL ; *
 25077                                  	;XOR	AL,AL ; *	; Indicate pre-read
 25078                                  	;call	GETBUFFR
 25079 00003F7E E8D829                  	call	GETBUFFER ; *	; pre-read
 25080                                  	;jc	short get_io_sft_retn
 25081                                  	; 08/02/2024
 25082 00003F81 720C                    	jc	short dirread_retn
 25083                                  
 25084                                  	;entry	SET_BUF_AS_DIR
 25085                                  
 25086                                  SET_BUF_AS_DIR:
 25087                                  
 25088                                  ;	Set the type of CURBUF to be a directory sector.
 25089                                  ;	Only flags are modified.
 25090                                  
 25091 00003F83 1E                      	PUSH	DS
 25092 00003F84 56                      	PUSH	SI
 25093 00003F85 C536[E205]              	LDS	SI,[CURBUF]
 25094                                  	;or	byte [si+5],4
 25095 00003F89 804C0504                	OR	byte [SI+BUFFINFO.buf_flags],buf_isDIR	; Clears carry
 25096 00003F8D 5E                      	POP	SI
 25097 00003F8E 1F                      	POP	DS
 25098                                  dirread_retn:
 25099 00003F8F C3                      	retn
 25100                                  
 25101                                  ;Break	<FATSECRD -- READ A FAT SECTOR>
 25102                                  ;----------------------------------------------------------------------------
 25103                                  ;
 25104                                  ; Procedure Name : FATSECRD
 25105                                  ; Inputs:
 25106                                  ;	Same as DREAD
 25107                                  ;	DS:BX = Transfer address
 25108                                  ;	CX = Number of sectors
 25109                                  ;	DX = Absolute record number
 25110                                  ;	ES:BP = Base of drive parameters
 25111                                  ; Function:
 25112                                  ;	Calls BIOS to perform FAT read.
 25113                                  ; Outputs:
 25114                                  ;	Same as DREAD
 25115                                  ;---------------------------------------------------------------------------
 25116                                  
 25117                                  	; 04/05/2019 - Retro DOS v4.0
 25118                                  	; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 25119                                  
 25120                                  	; 09/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 25121                                  
 25122                                  FATSECRD:
 25123                                  ;hkn; SS override
 25124                                  	;mov	byte [ss:ALLOWED],18h
 25125 00003F90 36C606[4B03]18          	MOV	byte [SS:ALLOWED],Allowed_RETRY+Allowed_FAIL
 25126 00003F96 89CF                    	MOV	DI,CX
 25127                                  	;mov	cl,[es:bp+8]
 25128 00003F98 268A4E08                	MOV	CL,[ES:BP+DPB.FAT_COUNT]
 25129                                  	; MSDOS 3.3
 25130                                  	;;mov	al,[es:bp+0Fh]
 25131                                  	;MOV	AL,[ES:BP+DPB.FAT_SIZE]
 25132                                  	;XOR	AH,AH
 25133                                  	; MSDOS 6.0
 25134                                  	;mov	ax,[es:bp+0Fh]
 25135 00003F9C 268B460F                	MOV	AX,[ES:BP+DPB.FAT_SIZE] ;>32mb
 25136 00003FA0 30ED                    	XOR	CH,CH
 25137                                  	;;;
 25138                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25139 00003FA2 09C0                    	or	ax,ax
 25140 00003FA4 7509                    	jnz	short FATSECRD_cont	; not FAT32
 25141                                  	;test	byte [es:bp+23h],80h
 25142 00003FA6 26F6462380              	test	byte [es:bp+DPB.EXT_FLAGS],80h ; (FAT32 bs extd flags bit 7)
 25143 00003FAB 7402                    	jz      short FATSECRD_cont
 25144                                  	;mov	cx,1           		; only one FAT is active
 25145 00003FAD B101                    	mov	cl,1
 25146                                  FATSECRD_cont:
 25147 00003FAF 36FF36[0706]            	push	word [ss:HIGH_SECTOR]
 25148                                  	;;;
 25149 00003FB4 52                      	PUSH	DX
 25150                                  NXTFAT:
 25151                                  	; MSDOS 6.0
 25152                                  ;hkn; SS override
 25153                                  	; 09/02/2024 (PCDOS 7.1)
 25154                                  	;MOV	word [SS:HIGH_SECTOR],0	;>32mb FAT sectors cannot exceed
 25155 00003FB5 51                      	PUSH	CX			;32mb
 25156 00003FB6 50                      	PUSH	AX
 25157                                  	;;;
 25158                                  	; 08/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25159 00003FB7 36FF36[0706]            	push	word [ss:HIGH_SECTOR]
 25160 00003FBC 52                      	push	dx
 25161                                  	;;;
 25162 00003FBD 89F9                    	MOV	CX,DI
 25163 00003FBF E88600                  	call	DSKREAD
 25164                                  	;;;
 25165                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25166 00003FC2 5A                      	pop	dx
 25167 00003FC3 368F06[0706]            	pop	word [ss:HIGH_SECTOR]
 25168                                  	;;;
 25169 00003FC8 58                      	POP	AX
 25170 00003FC9 59                      	POP	CX
 25171 00003FCA 7440                    	JZ	short RET41P		; Carry clear
 25172                                  	;;;
 25173                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25174 00003FCC 09C0                    	or	ax,ax
 25175 00003FCE 7511                    	jnz	short NXTFAT2	; not FAT32
 25176                                  	;add	dx,[es:bp+31h]
 25177 00003FD0 26035631                	add	dx,[es:bp+DPB.FAT32_SIZE]
 25178 00003FD4 50                      	push	ax
 25179                                  	;mov	ax,[es:bp+33h]
 25180 00003FD5 268B4633                	mov	ax,[es:bp+DPB.FAT32_SIZE+2]
 25181 00003FD9 361106[0706]            	adc	[ss:HIGH_SECTOR],ax
 25182 00003FDE 58                      	pop	ax
 25183 00003FDF EB08                    	jmp	short NXTFAT3
 25184                                  NXTFAT2:
 25185                                  	;;;
 25186 00003FE1 01C2                    	ADD	DX,AX
 25187                                  	;;;
 25188                                  	; 09/02/2024 (PCDOS 7.1)
 25189 00003FE3 368316[0706]00          	adc	word [ss:HIGH_SECTOR],0
 25190                                  NXTFAT3:
 25191                                  	;;;
 25192 00003FE9 E2CA                    	LOOP	NXTFAT
 25193 00003FEB 5A                      	POP	DX
 25194                                  	;;;
 25195                                  	; 09/02/2024 (PCDOS 7.1)
 25196 00003FEC 368F06[0706]            	pop	word [ss:HIGH_SECTOR]
 25197                                  	;;;
 25198 00003FF1 89F9                    	MOV	CX,DI
 25199                                  
 25200                                  ; NOTE FALL THROUGH
 25201                                  
 25202                                  ;Break	<DREAD -- DO A DISK READ>
 25203                                  ;---------------------------------------------------------------------------
 25204                                  ;
 25205                                  ; Procedure Name : DREAD
 25206                                  ;
 25207                                  ; Inputs:
 25208                                  ;	DS:BX = Transfer address
 25209                                  ;	CX = Number of sectors
 25210                                  ;	DX = Absolute record number	      (LOW)
 25211                                  ;	[HIGH_SECTOR] = Absolute record number (HIGH)
 25212                                  ;	ES:BP = Base of drive parameters
 25213                                  ;	[ALLOWED] must be set in case call to HARDERR needed
 25214                                  ; Function:
 25215                                  ;	Calls BIOS to perform disk read. If BIOS reports
 25216                                  ;	errors, will call HARDERRRW for further action.
 25217                                  ; Outputs:
 25218                                  ;	Carry set if error (currently user FAILED to INT 24)
 25219                                  ; DS,ES:BP preserved. All other registers destroyed.
 25220                                  ;---------------------------------------------------------------------------
 25221                                  
 25222                                  	;entry	DREAD
 25223                                  DREAD:
 25224 00003FF3 E85200                  	call	DSKREAD
 25225 00003FF6 7497                    	jz	short dirread_retn	; Carry clear
 25226                                  ;hkn; SS override
 25227 00003FF8 36C606[7505]00          	MOV	BYTE [SS:READOP],0	; Read
 25228 00003FFE E89A00                  	call	HARDERRRW
 25229 00004001 3C01                    	CMP	AL,1			; Check for retry
 25230 00004003 74EE                    	JZ	short DREAD
 25231                                  
 25232                                  fail_ignore:	; 09/02/2024
 25233 00004005 3C03                    	CMP	AL,3			; Check for FAIL
 25234 00004007 F8                      	CLC
 25235 00004008 7501                    	JNZ	short NO_CAR		; Ignore
 25236 0000400A F9                      	STC
 25237                                  NO_CAR:
 25238 0000400B C3                      	retn
 25239                                  
 25240                                  	; 09/02/2024 - Retro DOS v5.0
 25241                                  RET41P: 
 25242 0000400C 5A                      	POP	DX
 25243                                  	;;;
 25244                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25245 0000400D 368F06[0706]            	pop	word [ss:HIGH_SECTOR]
 25246                                  	;;;
 25247 00004012 C3                      	retn
 25248                                  
 25249                                  ; 24/07/2018 - Retro DOS v3.0
 25250                                  
 25251                                  ;Break	<CHECK_WRITE_LOCK>
 25252                                  ;---------------------------------------------------------------------------
 25253                                  ;
 25254                                  ; Procedure Name : CHECK_WRITE_LOCK
 25255                                  ;
 25256                                  ; Inputs:
 25257                                  ;	output of SETUP
 25258                                  ;	ES:DI -> SFT
 25259                                  ; Function:
 25260                                  ;	check write lock
 25261                                  ; Outputs:
 25262                                  ;	Carry set if error
 25263                                  ;	Carry clear if ok
 25264                                  ;
 25265                                  ;----------------------------------------------------------------------------
 25266                                  
 25267                                  	; 04/05/2019 - Retro DOS v4.0
 25268                                  	; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 25269                                  
 25270                                  CHECK_WRITE_LOCK:
 25271                                  	; MSDOS 6.0
 25272                                  	;test	byte [es:di+4],8
 25273 00004013 26F6450408              	TEST	byte [ES:DI+SF_ENTRY.sf_attr],attr_volume_id ;volume id
 25274                                  	;JZ	short write_cont			     ;no
 25275                                  	;;call	SET_ACC_ERR_DS
 25276                                  	;;retn
 25277                                  	;;jnz	SET_ACC_ERR_DS
 25278                                  	; 19/08/2018
 25279                                  	;jz	short write_cont
 25280                                  	;jmp	SET_ACC_ERR_DS
 25281                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 25282 00004018 7403                    	JZ	short write_cont
 25283                                  	;call	SET_ACC_ERR_DS
 25284                                  	;retn
 25285                                  	; 16/12/2022
 25286 0000401A E9D201                  	jmp	SET_ACC_ERR_DS
 25287                                  
 25288                                  write_cont:				;
 25289 0000401D 51                      	PUSH	CX			;save reg
 25290 0000401E 09C9                    	OR	CX,CX			;
 25291 00004020 7501                    	JNZ	short Not_Truncate	;
 25292 00004022 49                      	dec	cx			;(cx) = -1; check for lock on whole file
 25293                                  Not_Truncate:				;
 25294 00004023 B080                    	MOV	AL,80H			;check write access
 25295 00004025 E8E943                  	call	LOCK_CHECK		;check lock
 25296 00004028 59                      	POP	CX			;restore reg
 25297 00004029 7305                    	JNC	short WRITE_OK		;lock ok
 25298 0000402B E87301                  	call	WRITE_LOCK_VIOLATION	;issue I24
 25299 0000402E 73ED                    	JNC	short write_cont	;retry
 25300                                  WRITE_OK:				;
 25301 00004030 C3                      	retn				;
 25302                                  
 25303                                  ;Break	<CHECK_READ_LOCK>
 25304                                  ;---------------------------------------------------------------------------
 25305                                  ;
 25306                                  ; Procedure Name : CHECK_READ_LOC
 25307                                  ;
 25308                                  ; Inputs:
 25309                                  ;	ES:DI -> SFT
 25310                                  ;	output of SETUP
 25311                                  ; Function:
 25312                                  ;	check read lock
 25313                                  ; Outputs:
 25314                                  ;	Carry set if error
 25315                                  ;	Carry clear if ok
 25316                                  ;----------------------------------------------------------------------------
 25317                                  
 25318                                  CHECK_READ_LOCK:
 25319                                  	; MSDOS 6.0
 25320                                  	;test	byte [es:di+4],8
 25321 00004031 26F6450408              	TEST	byte [ES:DI+SF_ENTRY.sf_attr],attr_volume_id ;volume id
 25322                                  	;JZ	short do_retry			   	     ; no
 25323                                  	;;call	SET_ACC_ERR
 25324                                  	;;retn
 25325                                  	;;jnz	SET_ACC_ERR
 25326                                  	; 16/12/2022
 25327                                  	; 28/07/2019
 25328 00004036 7403                    	jz	short do_retry
 25329 00004038 E9B601                  	jmp	SET_ACC_ERR
 25330                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 25331                                  	;JZ	short do_retry
 25332                                  	;call	SET_ACC_ERR
 25333                                  	;retn
 25334                                  do_retry:				;
 25335 0000403B 30C0                    	xor	al,al			;check read access
 25336 0000403D E8D143                  	call	LOCK_CHECK		;check lock
 25337 00004040 7305                    	JNC	short READLOCK_OK 	;lock ok
 25338 00004042 E83C01                  	call	READ_LOCK_VIOLATION	;issue I24
 25339 00004045 73F4                    	JNC	short do_retry		;retry
 25340                                  READLOCK_OK:				;
 25341                                  dw_ret_label:	; 09/02/2024
 25342 00004047 C3                      	retn				;
 25343                                  
 25344                                  ;============================================================================
 25345                                  ; DISK2.ASM, MSDOS 6.0, 1991
 25346                                  ;============================================================================
 25347                                  ; 24/07/2018 - Retro DOS v3.0
 25348                                  ; 04/05/2019 - Retro DOS v4.0
 25349                                  
 25350                                  ;	TITLE	DISK2 - Disk utility routines
 25351                                  ;	NAME	Disk2
 25352                                  
 25353                                  ;**	Low level Read and write routines for local SFT I/O on files and devs
 25354                                  ;
 25355                                  ;	DskRead
 25356                                  ;	DWRITE
 25357                                  ;	DSKWRITE
 25358                                  ;	HarderrRW
 25359                                  ;	SETUP
 25360                                  ;	BREAKDOWN
 25361                                  ;	READ_LOCK_VIOLATION
 25362                                  ;	WRITE_LOCK_VIOLATION
 25363                                  ;	DISKREAD
 25364                                  ;	SET_ACC_ERR_DS
 25365                                  ;	SET_ACC_ERR
 25366                                  ;	SETSFT
 25367                                  ;	SETCLUS
 25368                                  ;	AddRec
 25369                                  ;
 25370                                  ;	Revision history:
 25371                                  ;
 25372                                  ;		AN000 version 4.00 Jan. 1988
 25373                                  ;		M039 DB 10/17/90 - Disk read/write optimization
 25374                                  
 25375                                  ; 04/05/2019 - Retro DOS v4.0
 25376                                  ; DOSCODE:7699h (MSDOS 6.21, MSDOS.SYS)
 25377                                  ; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 25378                                  ; DOSCODE:7685h (MSDOS 5.0, MSDOS.SYS)
 25379                                  
 25380                                  ;Break	<DSKREAD -- PHYSICAL DISK READ>
 25381                                  ;---------------------------------------------------------------------------
 25382                                  ;
 25383                                  ; Procedure Name : DSKREAD
 25384                                  ;
 25385                                  ; Inputs:
 25386                                  ;	DS:BX = Transfer addr
 25387                                  ;	CX = Number of sectors
 25388                                  ;	[HIGH_SECTOR] = Absolute record number (HIGH)
 25389                                  ;	DX = Absolute record number	       (LOW)
 25390                                  ;	ES:BP = Base of drive parameters
 25391                                  ; Function:
 25392                                  ;	Call BIOS to perform disk read
 25393                                  ; Outputs:
 25394                                  ;	DI = CX on entry
 25395                                  ;	CX = Number of sectors unsuccessfully transfered
 25396                                  ;	AX = Status word as returned by BIOS (error code in AL if error)
 25397                                  ;	Zero set if OK (from BIOS) (carry clear)
 25398                                  ;	Zero clear if error (carry clear)
 25399                                  ; SI Destroyed, others preserved
 25400                                  ;---------------------------------------------------------------------------
 25401                                  
 25402                                  DSKREAD:
 25403 00004048 51                      	PUSH	CX
 25404                                  	;mov	ah,[es:bp+17h] ; 04/05/2019
 25405 00004049 268A6617                	MOV	AH,[ES:BP+DPB.MEDIA]
 25406                                  	;mov	al,[es:bp+1]
 25407 0000404D 268A4601                	MOV	AL,[ES:BP+DPB.UNIT]
 25408 00004051 53                      	PUSH	BX
 25409 00004052 06                      	PUSH	ES
 25410 00004053 E8E212                  	call	SETREAD
 25411 00004056 EB22                    	JMP	short DODSKOP
 25412                                  
 25413                                  ;Break	<DWRITE -- SEE ABOUT WRITING>
 25414                                  ;--------------------------------------------------------------------------
 25415                                  ;
 25416                                  ; Procedure Name : DWRITE
 25417                                  ;
 25418                                  ; Inputs:
 25419                                  ;	DS:BX = Transfer address
 25420                                  ;	CX = Number of sectors
 25421                                  ;	[HIGH_SECTOR] = Absolute record number (HIGH)
 25422                                  ;	DX = Absolute record number	       (LOW)
 25423                                  ;	ES:BP = Base of drive parameters
 25424                                  ;	[ALLOWED] must be set in case HARDERR called
 25425                                  ; Function:
 25426                                  ;	Calls BIOS to perform disk write. If BIOS reports
 25427                                  ;	errors, will call HARDERRRW for further action.
 25428                                  ; Output:
 25429                                  ;	Carry set if error (currently, user FAILed to I 24)
 25430                                  ; BP preserved. All other registers destroyed.
 25431                                  ;----------------------------------------------------------------------------
 25432                                  
 25433                                  	;entry	DWRITE
 25434                                  DWRITE:
 25435 00004058 E81100                  	CALL	DSKWRITE
 25436 0000405B 74EA                    	jz	short dw_ret_label	; Carry clear (retz)
 25437                                  
 25438                                  ;hkn; SS override
 25439 0000405D 36C606[7505]01          	MOV	BYTE [SS:READOP],1	; Write
 25440 00004063 E83500                  	call	HARDERRRW
 25441 00004066 3C01                    	CMP	AL,1			; Check for retry
 25442 00004068 74EE                    	JZ	short DWRITE
 25443                                  
 25444                                  ; 09/02/2024
 25445                                  %if 0
 25446                                  	CMP	AL,3			; Check for FAIL
 25447                                  	CLC
 25448                                  	JNZ	short NO_CAR2 		; Ignore
 25449                                  	STC
 25450                                  NO_CAR2:
 25451                                  dw_ret_label:
 25452                                  	retn
 25453                                  %else
 25454                                  	; 09/02/2024 - Retro DOS v5.0
 25455 0000406A EB99                    	jmp	short fail_ignore
 25456                                  %endif
 25457                                  
 25458                                  ;Break	<DSKWRITE -- PHYSICAL DISK WRITE>
 25459                                  ;---------------------------------------------------------------------------
 25460                                  ;
 25461                                  ; Procedure Name : DSKWRITE
 25462                                  ;
 25463                                  ; Inputs:
 25464                                  ;	DS:BX = Transfer addr
 25465                                  ;	CX = Number of sectors
 25466                                  ;	DX = Absolute record number	       (LOW)
 25467                                  ;	[HIGH_SECTOR] = Absolute record number (HIGH)
 25468                                  ;	ES:BP = Base of drive parameters
 25469                                  ; Function:
 25470                                  ;	Call BIOS to perform disk read
 25471                                  ; Outputs:
 25472                                  ;	DI = CX on entry
 25473                                  ;	CX = Number of sectors unsuccessfully transfered
 25474                                  ;	AX = Status word as returned by BIOS (error code in AL if error)
 25475                                  ;	Zero set if OK (from BIOS) (carry clear)
 25476                                  ;	Zero clear if error (carry clear)
 25477                                  ; SI Destroyed, others preserved
 25478                                  ;
 25479                                  ;----------------------------------------------------------------------------
 25480                                  
 25481                                  	;entry	DSKWRITE
 25482                                  DSKWRITE:
 25483 0000406C 51                      	PUSH	CX
 25484                                  	;mov	ah,[es:bp+17h] ; 04/05/2019
 25485 0000406D 268A6617                	MOV	AH,[ES:BP+DPB.MEDIA]
 25486                                  	;mov	al,[es:bp+1]
 25487 00004071 268A4601                	MOV	AL,[ES:BP+DPB.UNIT]
 25488 00004075 53                      	PUSH	BX
 25489 00004076 06                      	PUSH	ES
 25490 00004077 E8F112                  	call	SETWRITE
 25491                                  DODSKOP:
 25492 0000407A 8CD9                    	MOV	CX,DS		; Save DS
 25493 0000407C 1F                      	POP	DS		; DS:BP points to DPB
 25494 0000407D 1E                      	PUSH	DS
 25495                                  
 25496                                  	;lds	si,[ds:bp+13h] ; 04/05/2019
 25497 0000407E 3EC57613                	LDS	SI,[ds:BP+DPB.DRIVER_ADDR] ; 07/09/2018
 25498 00004082 E83212                  	call	DEVIOCALL2
 25499                                  
 25500 00004085 8ED9                    	MOV	DS,CX		; Restore DS
 25501 00004087 07                      	POP	ES		; Restore ES
 25502 00004088 5B                      	POP	BX
 25503                                  
 25504                                  ;hkn; SS override
 25505 00004089 368B0E[6C03]            	MOV	CX,[SS:CALLSCNT] ; Number of sectors transferred
 25506 0000408E 5F                      	POP	DI
 25507 0000408F 29F9                    	SUB	CX,DI
 25508 00004091 F7D9                    	NEG	CX		; Number of sectors not transferred
 25509                                  
 25510                                  ;hkn; SS override
 25511 00004093 36A1[5D03]              	MOV	AX,[SS:DEVCALL_REQSTAT]
 25512                                  	;test	ax,8000h
 25513                                  	; 17/12/2022
 25514                                  	;test	ah,80h
 25515 00004097 F6C480                  	test	ah,(STERR>>8)
 25516                                  	;test	AX,STERR
 25517 0000409A C3                      	retn
 25518                                  
 25519                                  ;Break	<HardErrRW - map extended errors and call harderr>
 25520                                  ;---------------------------------------------------------------------------
 25521                                  ;
 25522                                  ; Procedure Name : HardErrRW
 25523                                  ;
 25524                                  ; Inputs:
 25525                                  ;	AX is error code from read or write
 25526                                  ;	Other registers set as per HARDERR
 25527                                  ; Function:
 25528                                  ;	Checks the error code for special extended
 25529                                  ;	errors and maps them if needed. Then invokes
 25530                                  ;	Harderr
 25531                                  ; Outputs:
 25532                                  ;	Of HARDERR
 25533                                  ; AX may be modified prior to call to HARDERR.
 25534                                  ; No other registers altered.
 25535                                  ;
 25536                                  ;---------------------------------------------------------------------------
 25537                                  
 25538                                  	; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 25539                                  HARDERRRW:
 25540                                  	;cmp	al,0Fh
 25541 0000409B 3C0F                    	CMP	AL,error_I24_wrong_disk
 25542 0000409D 7512                    	JNZ	short DO_ERR			; Nothing to do
 25543                                  
 25544                                  	; MSDOS 3.3
 25545                                  	;push	ds
 25546                                  	;push	si
 25547                                  	;lds	si,[ss:CALLVIDRW]
 25548                                  	;mov	[ss:EXTERRPT+2], ds
 25549                                  	;mov	[ss:EXTERRPT], si
 25550                                  	;pop	si
 25551                                  	;pop	ds
 25552                                  
 25553                                  	; MSDOS 6.0
 25554 0000409F 50                      	push	ax
 25555 000040A0 36A1[7003]              	mov	ax,[SS:CALLVIDRW]		; get ptr lo  ;smr;SS Override
 25556 000040A4 36A3[2803]              	mov	[ss:EXTERRPT],ax		; set ext err ptr lo
 25557 000040A8 36A1[7203]              	mov	ax,[SS:CALLVIDRW+2]		; get ptr hi from dev
 25558 000040AC 36A3[2A03]              	mov	[ss:EXTERRPT+2],ax		; set ext err ptr hi
 25559 000040B0 58                      	pop	ax
 25560                                  DO_ERR:
 25561                                  	;;call	HARDERR
 25562                                  	;;retn
 25563                                  	; 16/12/2022
 25564                                  	; 10/06/2019
 25565 000040B1 E9CD1F                  	jmp	HARDERR	
 25566                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 25567                                  	;call	HARDERR
 25568                                  	;retn
 25569                                  
 25570                                  ; 24/07/2018 - Retro DOS v3.0
 25571                                  
 25572                                  ;Break	<SETUP -- SETUP A DISK READ OR WRITE FROM USER>
 25573                                  ;----------------------------------------------------------------------------
 25574                                  ;
 25575                                  ; Procedure Name : SETUP
 25576                                  ;
 25577                                  ; Inputs:
 25578                                  ;	ES:DI point to SFT (value also in THISSFT)
 25579                                  ;	DMAAdd contains transfer address
 25580                                  ;	CX = Byte count
 25581                                  ;	DS = DOSDATA
 25582                                  ;   WARNING Stack must be clean, two ret addrs on stack, 1st of caller,
 25583                                  ;		2nd of caller of caller.
 25584                                  ; Outputs:
 25585                                  ;	    CX = byte count
 25586                                  ;	    [THISDPB] = Base of drive parameters if file
 25587                                  ;		      = Pointer to device header if device or NET
 25588                                  ;	    ES:DI Points to SFT
 25589                                  ;	    [NEXTADD] = Displacement of disk transfer within segment
 25590                                  ;	    [TRANS] = 0 (No transfers yet)
 25591                                  ;	    BytPos = Byte position in file
 25592                                  ;
 25593                                  ;	The following fields are relevant to local files (not devices) only:
 25594                                  ;
 25595                                  ;	    SecPos = Position of first sector (local files only)
 25596                                  ;	    [BYTSECPOS] = Byte position in first sector (local files only)
 25597                                  ;	    [CLUSNUM] = First cluster (local files only)
 25598                                  ;	    [SECCLUSPOS] = Sector within first cluster (local files only)
 25599                                  ;	    [THISDRV] = Physical unit number (local files only)
 25600                                  ;
 25601                                  ;      RETURNS ONE LEVEL UP WITH:
 25602                                  ;	   CX = 0
 25603                                  ;	   CARRY = Clear
 25604                                  ;	IF AN ERROR IS DETECTED
 25605                                  ; All other registers destroyed
 25606                                  ;----------------------------------------------------------------------------
 25607                                  
 25608                                  ;hkn; called from disk.asm. DS has been set up to DOSDATA.
 25609                                  
 25610                                  ; DOSCODE:770Bh (MSDOS 6.21, MSDOS.SYS)
 25611                                  
 25612                                  ; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 25613                                  ; DOSCODE:76F7h (MSDOS 5.0, MSDOS.SYS)
 25614                                  
 25615                                  ; 09/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 25616                                  ; DOSCODE:80D8h (PCDOS 7.1, IBMDOS.COM)
 25617                                  
 25618                                  SETUP:
 25619                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 411Bh
 25620                                  
 25621                                  	;lds 	si,[es:di+7]
 25622 000040B4 26C57507                	LDS	SI,[ES:DI+SF_ENTRY.sf_devptr]
 25623                                  
 25624                                  ;hkn; SS override
 25625 000040B8 368C1E[8C05]            	MOV	[SS:THISDPB+2],DS
 25626                                  
 25627                                  ;hkn; SS is DOSDATA
 25628 000040BD 16                      	push	ss
 25629 000040BE 1F                      	pop	ds
 25630                                  
 25631 000040BF 8936[8A05]              	MOV	[THISDPB],SI
 25632                                  
 25633 000040C3 8B1E[2C03]              	MOV	BX,[DMAADD]
 25634 000040C7 891E[B805]              	MOV	[NEXTADD],BX		;Set NEXTADD to start of Xaddr
 25635 000040CB C606[7405]00            	MOV	BYTE [TRANS],0		;No transferes
 25636                                  	;mov	ax,[es:di+15h]
 25637 000040D0 268B4515                	MOV	AX,[ES:DI+SF_ENTRY.sf_position]
 25638                                  	;mov	dx,[es:di+17h]
 25639 000040D4 268B5517                	MOV	DX,[ES:DI+SF_ENTRY.sf_position+2]
 25640 000040D8 8916[D005]              	MOV	[BYTPOS+2],DX		;Set it
 25641 000040DC A3[CE05]                	MOV	[BYTPOS],AX
 25642                                  	;test	word [es:di+5],8080h
 25643 000040DF 26F745058080            	TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet+devid_device
 25644 000040E5 7555                    	JNZ	short NOSETSTUFF	;Following not done on devs or NET
 25645 000040E7 06                      	PUSH	ES
 25646 000040E8 C42E[8A05]              	LES	BP,[THISDPB]		;Point at the DPB
 25647                                  
 25648                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 25649                                  	;;mov	bl,[es:bp+0]
 25650                                  	;MOV	BL,[ES:BP+DPB.DRIVE]
 25651                                  	; 05/12/2022
 25652 000040EC 268A5E00                	mov	bl,[es:bp]
 25653                                  	
 25654 000040F0 881E[7605]              	MOV	[THISDRV],BL		;Set THISDRV
 25655                                  	;mov	bx,[es:bp+2]
 25656 000040F4 268B5E02                	MOV	BX,[ES:BP+DPB.SECTOR_SIZE]
 25657                                  
 25658                                  	;; MSDOS 3.3
 25659                                  	;cmp	dx,bx
 25660                                  	;jnb	short EOFERR
 25661                                  	;div	bx
 25662                                  	;mov	[SECPOS],ax
 25663                                  	;mov	[BYTSECPOS],dx
 25664                                  	;mov	dx,ax
 25665                                  	;;and	al,[es:bp+4]
 25666                                  	;AND	AL,[ES:BP+DPB.CLUSTER_MASK]
 25667                                  	;mov	[SECCLUSPOS],al
 25668                                  	;mov	ax,cx
 25669                                  	;;mov	cl,[es:bp+5]
 25670                                  	;MOV	CL,[ES:BP+DPB.CLUSTER_SHIFT]
 25671                                  	;shr	dx,cl
 25672                                  	;mov	[CLUSNUM],dx
 25673                                  	;pop	es
 25674                                  	;mov	cx,ax
 25675                                  
 25676                                  	; 04/05/2019 - Retro DOS v4.0
 25677                                  
 25678                                  	; MSDOS 6.0
 25679                                  ;M039: Optimized this section.
 25680 000040F8 51                              PUSH    CX			;SHR32 and DIV32 use CX.
 25681 000040F9 E81B06                  	call	DIV32			;DX:AX/BX = CX:AX + DX (rem)
 25682 000040FC 8916[CC05]              	MOV	[BYTSECPOS],DX
 25683 00004100 A3[C405]                	MOV	[SECPOS],AX
 25684 00004103 890E[C605]              	MOV	[SECPOS+2],CX
 25685 00004107 89CA                    	MOV	DX,CX
 25686                                  
 25687 00004109 89C3                    	MOV	BX,AX
 25688                                  	;and	bl,[es:bp+4]
 25689 0000410B 26225E04                	AND	BL,[ES:BP+DPB.CLUSTER_MASK]
 25690 0000410F 881E[7305]              	MOV	[SECCLUSPOS],BL
 25691                                  
 25692 00004113 E82806                  	call	SHR32			;(DX:AX SHR dpb_cluster_shift)
 25693 00004116 59                      	POP	CX			;CX = byte count.
 25694                                  
 25695                                  	; 09/02/2024 (PCDOS7.1 IBMDOS.COM)
 25696                                  	;JNZ	short EOFERR		;cluster number above 64k
 25697                                  	;;;
 25698                                  	;cmp	word [es:bp+0Fh],0
 25699 00004117 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 25700 0000411C 750C                    	jnz	short setup_1		; not FAT32 fs
 25701                                  	;cmp	dx,[es:bp+2Fh]
 25702 0000411E 263B562F                	cmp	dx,[es:bp+DPB.LAST_CLUSTER+2]
 25703 00004122 750E                    	jne	short setup_2
 25704                                  	;cmp	ax,[es:bp+2Dh]
 25705 00004124 263B462D                	cmp	ax,[es:bp+DPB.LAST_CLUSTER]
 25706 00004128 EB08                    	jmp	short setup_2
 25707                                  setup_1:	; FAT12 or FAT16 fs
 25708 0000412A 09D2                    	or	dx,dx
 25709 0000412C 7523                    	jnz	short EOFERR
 25710                                  	;cmp	ax,[es:bp+0Dh]
 25711 0000412E 263B460D                	cmp	ax,[es:bp+DPB.MAX_CLUSTER]
 25712                                  setup_2:
 25713 00004132 771D                    	ja	short EOFERR
 25714 00004134 8916[DE0A]              	mov	[CLUSNUM_HW],dx
 25715                                  	;;;
 25716                                  
 25717                                  	;;cmp	ax,[es:bp+0Dh]
 25718                                  	;CMP	AX,[ES:BP+DPB.MAX_CLUSTER] ;>32mb  if > disk size ;AN000;
 25719                                  	;JA	short EOFERR		   ;>32mb  then EOF       ;AN000;
 25720                                  
 25721 00004138 A3[BC05]                	MOV	[CLUSNUM],AX
 25722 0000413B 07                      	POP	ES			; ES:DI point to SFT
 25723                                  ;M039
 25724                                  
 25725                                  NOSETSTUFF:
 25726 0000413C 89C8                    	MOV	AX,CX		; AX = Byte count.
 25727 0000413E 0306[2C03]              	ADD	AX,[DMAADD]	; See if it will fit in one segment
 25728 00004142 730C                    	JNC	short setup_OK	; Must be less than 64K
 25729 00004144 A1[2C03]                	MOV	AX,[DMAADD]
 25730 00004147 F7D8                    	NEG	AX		; Amount of room left in segment (know
 25731                                  				;    less than 64K since max value of CX
 25732                                  				;    is FFFF).
 25733 00004149 7501                    	JNZ	short NoDec
 25734 0000414B 48                      	DEC	AX
 25735                                  NoDec:
 25736 0000414C 89C1                    	MOV	CX,AX		; Can do this much
 25737 0000414E E304                    	JCXZ	NOROOM		; Silly user gave Xaddr of FFFF in segment
 25738                                  setup_OK:
 25739 00004150 C3                      	retn
 25740                                  
 25741                                  EOFERR:
 25742 00004151 07                      	POP	ES		; ES:DI point to SFT
 25743 00004152 31C9                    	XOR	CX,CX		; No bytes read
 25744                                  ;;;;;;;;;;; 7/18/86
 25745                                  	; MSDOS 3.3
 25746                                  	;MOV	BYTE [DISK_FULL],1 ; set disk full flag
 25747                                  ;;;;;;;;;;;
 25748                                  NOROOM:
 25749 00004154 5B                      	POP	BX		; Kill return address
 25750 00004155 F8                      	CLC
 25751 00004156 C3                      	retn			; RETURN TO CALLER OF CALLER
 25752                                  
 25753                                  ;Break	<BREAKDOWN -- CUT A USER READ OR WRITE INTO PIECES>
 25754                                  ;---------------------------------------------------------------------------
 25755                                  ;
 25756                                  ; Procedure Name : BREAKDOWN
 25757                                  ;
 25758                                  ; Inputs:
 25759                                  ;	CX = Length of disk transfer in bytes
 25760                                  ;	ES:BP = Base of drive parameters
 25761                                  ;	[BYTSECPOS] = Byte position within first sector
 25762                                  ;	DS = DOSDATA
 25763                                  ; Outputs:
 25764                                  ;	[BYTCNT1] = Bytes to transfer in first sector
 25765                                  ;	[SECCNT] = No. of whole sectors to transfer
 25766                                  ;	[BYTCNT2] = Bytes to transfer in last sector
 25767                                  ; AX, BX, DX destroyed. No other registers affected.
 25768                                  ;---------------------------------------------------------------------------
 25769                                  
 25770                                  BREAKDOWN:
 25771 00004157 A1[CC05]                	MOV	AX,[BYTSECPOS]
 25772 0000415A 89CB                    	MOV	BX,CX
 25773 0000415C 09C0                    	OR	AX,AX
 25774 0000415E 740E                    	JZ	short SAVFIR	; Partial first sector?
 25775                                  	;sub	ax,[es:bp+2]
 25776 00004160 262B4602                	SUB	AX,[ES:BP+DPB.SECTOR_SIZE]
 25777 00004164 F7D8                    	NEG	AX		; Max number of bytes left in first sector
 25778 00004166 29C3                    	SUB	BX,AX		; Subtract from total length
 25779 00004168 7304                    	JAE	short SAVFIR
 25780 0000416A 01D8                    	ADD	AX,BX		; Don't use all of the rest of the sector
 25781 0000416C 31DB                    	XOR	BX,BX		; And no bytes are left
 25782                                  SAVFIR:
 25783 0000416E A3[D205]                	MOV	[BYTCNT1],AX
 25784 00004171 89D8                    	MOV	AX,BX
 25785 00004173 31D2                    	XOR	DX,DX
 25786                                  	;div	word [ES:BP+2]
 25787 00004175 26F77602                	DIV	word [ES:BP+DPB.SECTOR_SIZE]  ; How many whole sectors?
 25788 00004179 A3[D605]                	MOV	[SECCNT],AX
 25789 0000417C 8916[D405]              	MOV	[BYTCNT2],DX	; Bytes remaining for last sector
 25790                                  	; MSDOS 3.3
 25791                                  	;OR	DX,[BYTCNT1]	; SMR ONESECTORFIX BUGBUG
 25792                                  	;retnz			; NOT (BYTCNT1 = BYTCNT2 = 0)
 25793                                  	;CMP	AX,1
 25794                                  	;retnz
 25795                                  	;MOV	AX,[ES:BP+DPB.SECTOR_SIZE] ; Buffer EXACT one sector I/O
 25796                                  	;MOV	[BYTCNT2],AX
 25797                                  	;MOV	[SECCNT],DX	; DX = 0
 25798                                  _RET45:
 25799 00004180 C3                      	retn
 25800                                  
 25801                                  ; DOSCODE:77BFh (MSDOS 6.21, MSDOS.SYS)
 25802                                  
 25803                                  ;----------------------------------------------------------------------------
 25804                                  ;
 25805                                  ; Procedure Name : READ_LOCK_VIOLATION
 25806                                  ;
 25807                                  ; ES:DI points to SFT. This entry used by NET_READ
 25808                                  ; Carry set if to return error (CX=0,AX=error_sharing_violation).
 25809                                  ; Else do retrys.
 25810                                  ; ES:DI,DS,CX preserved
 25811                                  ;
 25812                                  ;----------------------------------------------------------------------------
 25813                                  
 25814                                  READ_LOCK_VIOLATION:
 25815 00004181 C606[7505]00            	MOV	byte [READOP],0
 25816                                  ERR_ON_CHECK:
 25817                                  	;;test	word [es:di+2],8000h
 25818                                  	;TEST	word [ES:DI+SF_ENTRY.sf_mode],sf_isFCB
 25819                                  	;JNZ	short HARD_ERR
 25820                                  
 25821                                  	; 04/05/2019
 25822                                  	;test	byte [es:di+3],80h
 25823 00004186 26F6450380              	TEST	byte [ES:DI+SF_ENTRY.sf_mode+1],(sf_isFCB>>8)
 25824 0000418B 7508                    	JNZ	short HARD_ERR
 25825                                  
 25826                                  	;PUSH	CX
 25827                                  	;;mov	cl,[es:di+2]
 25828                                  	;MOV	CL,[ES:DI+SF_ENTRY.sf_mode]
 25829                                  	;;and	cl,0F0h
 25830                                  	;AND	CL,SHARING_MASK
 25831                                  	;;cmp	cl,0
 25832                                  	;CMP	CL,SHARING_COMPAT
 25833                                  	;POP	CX
 25834                                  	;JNE	short NO_HARD_ERR
 25835                                  	; 21/09/2023
 25836 0000418D 268A4502                	mov	al,[ES:DI+SF_ENTRY.sf_mode]
 25837 00004191 24F0                    	and	al,SHARING_MASK
 25838                                  	;cmp	al,SHARING_COMPAT
 25839                                  	;jne	short NO_HARD_ERR
 25840 00004193 7505                    	jnz	short NO_HARD_ERR
 25841                                  HARD_ERR:
 25842 00004195 E88F42                  	call	LOCK_VIOLATION
 25843 00004198 73E6                    	jnc	short _RET45		; User wants Retrys
 25844                                  NO_HARD_ERR:
 25845 0000419A 31C9                    	XOR	CX,CX			;No bytes transferred
 25846                                  	;mov	ax,21h
 25847 0000419C B82100                  	MOV	AX,error_lock_violation
 25848 0000419F F9                      	STC
 25849                                  RET3:		; 06/02/2024
 25850 000041A0 C3                      	retn
 25851                                  
 25852                                  ;----------------------------------------------------------------------------
 25853                                  ;
 25854                                  ; Procedure Name : WRITE_LOCK_VIOLATION
 25855                                  ;
 25856                                  ; Same as READ_LOCK_VIOLATION except for READOP.
 25857                                  ; This entry used by NET_WRITE
 25858                                  ;
 25859                                  ;----------------------------------------------------------------------------
 25860                                  
 25861                                  WRITE_LOCK_VIOLATION:
 25862 000041A1 C606[7505]01            	MOV	byte [READOP],1
 25863 000041A6 EBDE                    	JMP	short ERR_ON_CHECK
 25864                                  
 25865                                  ; 04/05/2019 - Retro DOS v4.0
 25866                                  
 25867                                  ; DOSCODE:77ECh (MSDOS 6.21, MSDOS.SYS)
 25868                                  
 25869                                  ;Break	<DISKREAD -- PERFORM USER DISK READ>
 25870                                  ;----------------------------------------------------------------------------
 25871                                  ;
 25872                                  ; Procedure Name : DISKREAD
 25873                                  ;
 25874                                  ; Inputs:
 25875                                  ;	Outputs of SETUP
 25876                                  ; Function:
 25877                                  ;	Perform disk read
 25878                                  ; Outputs:
 25879                                  ;    Carry clear
 25880                                  ;	CX = No. of bytes read
 25881                                  ;	ES:DI point to SFT
 25882                                  ;	SFT offset and cluster pointers updated
 25883                                  ;    Carry set
 25884                                  ;	CX = 0
 25885                                  ;	ES:DI point to SFT
 25886                                  ;	AX has error code
 25887                                  ;----------------------------------------------------------------------------
 25888                                  
 25889                                  ;hkn; called from disk.asm. DS already set up.
 25890                                  
 25891                                  ; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 25892                                  ; DOSCODE:77D8h (MSDOS 5.0, MSDOS.SYS)
 25893                                  
 25894                                  ; 09/02/2024
 25895                                  ; 06/02/2024 - Retro DOS v5.0
 25896                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:81D5h
 25897                                  
 25898                                  DISKREAD:
 25899                                  	;mov	ax,[es:di+11h]
 25900 000041A8 268B4511                	MOV	AX,[ES:DI+SF_ENTRY.sf_size]
 25901                                  	;mov	bx,[es:di+13h]
 25902 000041AC 268B5D13                	MOV	BX,[ES:DI+SF_ENTRY.sf_size+2]
 25903 000041B0 2B06[CE05]              	SUB	AX,[BYTPOS]
 25904 000041B4 1B1E[D005]              	SBB	BX,[BYTPOS+2]
 25905 000041B8 7226                    	JB	short RDERR		;Read starts past EOF
 25906 000041BA 750A                    	JNZ	short ENUF		;More than 64k to EOF
 25907 000041BC 09C0                    	OR	AX,AX
 25908 000041BE 7420                    	JZ	short RDERR		;Read starts at EOF
 25909 000041C0 39C8                    	CMP	AX,CX
 25910 000041C2 7302                    	JAE	short ENUF		;I/O fits
 25911 000041C4 89C1                    	MOV	CX,AX			;Limit read to up til EOF
 25912                                  ENUF:
 25913                                  	; MSDOS 3.3
 25914                                  	;test	byte [es:di+4],8
 25915                                  	;TEST	byte [ES:DI+SF_ENTRY.sf_attr],attr_volume_id
 25916                                  	;jnz	short SET_ACC_ERR
 25917                                  	;call	LOCK_CHECK
 25918                                  	;jnb	short _READ_OK
 25919                                  	;call	READ_LOCK_VIOLATION
 25920                                  	;jnb	short ENUF
 25921                                  	;retn
 25922                                  
 25923                                  	; MSDOS 6.0
 25924 000041C6 E868FE                  	call	CHECK_READ_LOCK		;IFS. check read lock	;AN000;
 25925                                  	;JNC	short _READ_OK 		; There are no locks
 25926                                  	;retn
 25927                                  	; 06/02/2024
 25928 000041C9 72D5                    	jc	short RET3
 25929                                  
 25930                                  _READ_OK:
 25931 000041CB C42E[8A05]              	LES	BP,[THISDPB]
 25932 000041CF E885FF                  	CALL	BREAKDOWN
 25933                                  
 25934                                  ; 10/02/2024
 25935                                  %if 0
 25936                                  	MOV	CX,[CLUSNUM] ; *
 25937                                  	;;;
 25938                                  	; 06/02/2023 (PCDOS 7.1 IBMDOS.COM)
 25939                                  	mov	dx,[CLUSNUM_HW] ; *
 25940                                  	;;;
 25941                                  	call	FNDCLUS
 25942                                       	; MSDOS 6.0			;M022 conditional removed here
 25943                                  	JC	short SET_ACC_ERR_DS	; fix to take care of I24 fail
 25944                                  					; migrated from 330a - HKN
 25945                                  %else
 25946                                  	; 10/02/2024 - Retro DOS v5.0
 25947 000041D2 E88515                  	call	FNDCLUS_X ; *
 25948 000041D5 721A                    	jc	short SET_ACC_ERR ; ds=ss
 25949                                  %endif
 25950                                  	;;;
 25951                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25952 000041D7 833E[F80A]00            	cmp	word [CLSKIP_HW],0
 25953 000041DC 7502                    	jnz	short RDERR
 25954                                  	;;;
 25955                                  
 25956                                  	;OR	CX,CX
 25957                                  	;JZ	short SKIPERR
 25958                                  	; 06/02/2024
 25959 000041DE E318                    	jcxz	SKIPERR
 25960                                  
 25961                                  RDERR:
 25962 000041E0 B40E                    	MOV	AH,0EH			;MS. read/data/fail ;AN000;
 25963 000041E2 E97502                  	jmp	WRTERR22
 25964                                  
 25965                                  ;RDLASTJ: 
 25966                                  	;JMP	RDLAST                  ;M039
 25967                                  
 25968                                  SETSFTJ2: 
 25969 000041E5 E9B600                  	JMP	SETSFT
 25970                                  
 25971                                  CANOT_READ:
 25972                                  	; MSDOS 3.3
 25973                                  	;POP	CX		;M039.
 25974                                  	; MSDOS 3.3 & MSDOS 6.0
 25975 000041E8 59                      	POP	CX              ;Clean stack.
 25976 000041E9 5B                      	POP	BX
 25977                                  	;;;
 25978                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25979                                  	;pop	word [CCONTENT_HW] ; PCDOS 7.1 BUG!?
 25980                                  			; I think, this would be 'pop word [ss:CCONTENT_HW]'
 25981                                  			; because ds<>ss while jumping here.
 25982                                  			; Erdogan Tan - 09/02/2024
 25983 000041EA 368F06[EC0A]            	pop	word [ss:CCONTENT_HW] ; *
 25984                                  	;;;
 25985                                  
 25986                                  	;entry	SET_ACC_ERR_DS
 25987                                  SET_ACC_ERR_DS:
 25988                                  
 25989                                  ;hkn; SS is DOSDATA
 25990                                  	;Context DS
 25991 000041EF 16                      	push	ss
 25992 000041F0 1F                      	pop	ds
 25993                                  
 25994                                  	;entry	SET_ACC_ERR
 25995                                  SET_ACC_ERR:
 25996 000041F1 31C9                    	XOR	CX,CX
 25997                                  	;mov	ax,5
 25998 000041F3 B80500                  	MOV	AX,error_access_denied
 25999 000041F6 F9                      	STC
 26000 000041F7 C3                      	retn
 26001                                  
 26002                                  SKIPERR:
 26003 000041F8 8916[BA05]              	MOV	[LASTPOS],DX
 26004 000041FC 891E[BC05]              	MOV	[CLUSNUM],BX
 26005                                  	;;;
 26006                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26007 00004200 8B1E[E80A]              	mov	bx,[CLUSTNUM_HW]
 26008 00004204 891E[DE0A]              	mov	[CLUSNUM_HW],bx
 26009                                  	;;;
 26010 00004208 833E[D205]00            	CMP	word [BYTCNT1],0
 26011 0000420D 7405                    	JZ	short RDMID
 26012                                  
 26013 0000420F E83E16                  	call	BUFRD
 26014                                  	;JC	short SET_ACC_ERR_DS ; ds<>ss ; 10/02/2024
 26015                                  	; 10/02/2024
 26016                                  	; ds=ss
 26017 00004212 72DD                    	jc	short SET_ACC_ERR
 26018                                  
 26019                                  RDMID:
 26020 00004214 833E[D605]00            	CMP	word [SECCNT],0
 26021                                  	;JZ	RDLAST ; 10/08/2018
 26022 00004219 7466                    	jz	short RDLAST
 26023                                  
 26024 0000421B E8C616                  	call	NEXTSEC
 26025 0000421E 72C5                    	JC	short SETSFTJ2
 26026                                  
 26027 00004220 C606[7405]01            	MOV	BYTE [TRANS],1		; A transfer is taking place
 26028                                  ONSEC:
 26029 00004225 8A16[7305]              	MOV	DL,[SECCLUSPOS]	; (dx/DL = Extent start) ((dh = ?))
 26030 00004229 8B0E[D605]              	MOV	CX,[SECCNT]
 26031                                  	;;;
 26032                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26033 0000422D 8B1E[DE0A]              	mov	bx,[CLUSNUM_HW]
 26034 00004231 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 26035                                  	;;;
 26036 00004235 8B1E[BC05]              	MOV	BX,[CLUSNUM]
 26037                                  RDLP:
 26038 00004239 E8EF16                  	call	OPTIMIZE
 26039                                  	;JC	short SET_ACC_ERR_DS ; ds<>ss ; 10/02/2024
 26040                                  	; 10/02/2024
 26041                                  	; ds=ss
 26042 0000423C 72B3                    	jc	short SET_ACC_ERR
 26043                                  	;;;
 26044                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26045 0000423E FF36[EC0A]              	push	word [CCONTENT_HW]	; (Next physical cluster, hw)
 26046                                  	;;;
 26047 00004242 57                      	PUSH	DI                      ;DI = Next physical cluster.
 26048 00004243 50                      	PUSH	AX                      ;AX = # of sectors remaining.
 26049 00004244 53                      	PUSH	BX			;[DMAADD+2]:BX = Transfer address.
 26050                                  	;mov	byte [ALLOWED],38h
 26051 00004245 C606[4B03]38            	MOV	byte [ALLOWED],Allowed_RETRY+Allowed_FAIL+Allowed_IGNORE
 26052 0000424A 8E1E[2E03]              	MOV	DS,[DMAADD+2]
 26053                                  
 26054 0000424E 52                      	PUSH	DX                      ;[HIGH_SECTOR]:DX = phys. sector #.
 26055 0000424F 51                      	PUSH	CX                      ;CX = # of contiguous sectors to read.
 26056                                  
 26057                                  	; 04/05/2019 - Retro DOS v4.0
 26058                                  
 26059                                  	; 09/02/2024 - Retro DOS v5.0
 26060                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:8284h
 26061                                  	; Windows ME IO.SYS - BIOSCODE:0B69Eh
 26062                                  	; MSDOS 6.22 IO.SYS - DOSCODE:787Bh
 26063                                  
 26064                                  	; NOTE: Secondary Buffer Cache is not used in PCDOS 7.1 IBMDOS.COM.
 26065                                  
 26066                                  	;call	nul_sub		; PCDOS 7.1 (nul_sub: retn)
 26067                                  	;			; 'nul-sub:' at DOSCODE:AD57
 26068                                  	
 26069                                  	; MSDOS 6.0 (& Windows ME)
 26070                                  	;call	SET_RQ_SC_PARMS		;LB. do this for SC ;AN000;
 26071                                  
 26072                                  	; MSDOS 3.3 (& MSDOS 6.0)
 26073 00004250 E8A0FD                  	call	DREAD
 26074                                  
 26075                                  	; 10/02/2024
 26076                                  	; ds<>ss
 26077                                  
 26078                                  	; MSDOS 3.3 
 26079                                  	;pop	bx
 26080                                  	;pop	dx
 26081                                  	;jc	short CANOT_READ
 26082                                  	;add	bx,dx	; (bx = Extent end)
 26083                                  	;mov	al,[es:bp] ; mov al,[es:bp+0]
 26084                                  	;;mov	al,[ES:BP+DPB.DRIVE] 
 26085                                  	;call	SETVISIT
 26086                                  	; ->***
 26087                                  ;M039
 26088                                  	; MSDOS 6.0 
 26089 00004253 59                      	pop	cx
 26090 00004254 5A                      	pop	dx
 26091 00004255 368F06[0C06]            	pop	WORD [ss:TEMP_VAR]
 26092 0000425A 728C                    	jc	short CANOT_READ ; * 09/02/2024	
 26093                                  
 26094 0000425C 368C1E[0E06]            	mov	[ss:TEMP_VAR2],ds
 26095                                  
 26096                                  ;       CX = # of contiguous sectors read. (These constitute a block of
 26097                                  ;            sectors, also termed an "Extent".)
 26098                                  ;       [HIGH_SECTOR]:DX = physical sector # of first sector in extent.
 26099                                  ;       [TEMP_VAR2]:[TEMP_VAR] = Transfer address (destination data address).
 26100                                  ;       ES:BP -> Drive Parameter Block (DPB).
 26101                                  ;
 26102                                  ;	The Buffer Queue must now be scanned: the contents of any dirty
 26103                                  ;	buffers must be "read" into the transfer memory block, so that the
 26104                                  ;       transfer memory reflects the most recent data.
 26105                                  
 26106 00004261 E87600                  	call	DskRdBufScan
 26107                                  
 26108                                  	;Context DS
 26109 00004264 16                      	push	ss
 26110 00004265 1F                      	pop	ds
 26111                                          
 26112 00004266 59                      	pop	cx
 26113 00004267 5B                              pop	bx
 26114                                  
 26115                                  ;       CX = # of sector remaining.
 26116                                  ;       BX = Next physical cluster.
 26117                                  
 26118                                  	;;;
 26119                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26120 00004268 8F06[E80A]              	pop	word [CLUSTNUM_HW]	; (Next physical cluster, hw)
 26121                                  	;;;
 26122                                  
 26123                                  ;M039
 26124                                  
 26125                                  ;;;;;;;;
 26126                                  ;	; 25/07/2018 - Retro DOS v3.0
 26127                                  ;	; ***->
 26128                                  ;	; MSDOS 3.3
 26129                                  ;	; IBMDOS.COM (1987) - Offset 42BDh
 26130                                  ;bufq:
 26131                                  ;;	DX = Extent start.
 26132                                  ;;	BX = Extent end.
 26133                                  ;;	 AL = Drive #.
 26134                                  ;;     DS:DI-> 1st buffer in queue.
 26135                                  ;
 26136                                  ;	;or	byte [di+5],20h
 26137                                  ;	or	byte [DI+BUFFINFO.buf_flags],buf_visit ; Bit 5 = reserved
 26138                                  ;	;cmp	al,[di+4]	
 26139                                  ;	cmp	al,[DI+BUFFINFO.buf_ID]
 26140                                  ;	jnz	short bufq3
 26141                                  ;	;cmp	[di+6],dx
 26142                                  ;	cmp	[DI+BUFFINFO.buf_sector],dx
 26143                                  ;	jb	short bufq3	; Jump if Extent start > buffer sector.
 26144                                  ;	;cmp	[di+6],bx
 26145                                  ;	cmp	[DI+BUFFINFO.buf_sector],bx
 26146                                  ;	jnb	short bufq3	; Jump if Extent end >= buffer sector.
 26147                                  ;	
 26148                                  ;	; Buffer sector is in the Extent (contiguous sectors to read)
 26149                                  ;
 26150                                  ;;      Buffer's sector is in Extent: if it is dirty, copy its contents to
 26151                                  ;;      transfer memory; otherwise, just re-position it in the buffer queue
 26152                                  ;;      as MRU (Most Recently Used).
 26153                                  ;
 26154                                  ;	;test	byte [di+5],40h
 26155                                  ;	test	byte [DI+BUFFINFO.buf_flags],buf_dirty ; Bit 6 = dirty flag
 26156                                  ;	jz	short bufq2	; clear buffer, check the next buff sec
 26157                                  ;	pop	ax ; transfer address
 26158                                  ;	push	ax
 26159                                  ;	push	di
 26160                                  ;	push	dx
 26161                                  ;	;sub	dx,[di+6]
 26162                                  ;	sub	dx,[DI+BUFFINFO.buf_sector]
 26163                                  ;	neg	dx
 26164                                  ;
 26165                                  ;;      DX = offset (in sectors) of buffer sector within Transfer memory
 26166                                  ;;           block.
 26167                                  ;
 26168                                  ;	mov	si,di
 26169                                  ;	mov	di,ax
 26170                                  ;	mov	ax,dx
 26171                                  ;	;mov	cx,[es:bp+6]	
 26172                                  ;	mov     cx,[ES:BP+DPB.SECTOR_SIZE] ; CX = sector size (in bytes).
 26173                                  ;	mul	cx
 26174                                  ;	add	di,ax
 26175                                  ;
 26176                                  ;	lea	si,[si+16]
 26177                                  ;	lea	si,[SI+BUFINSIZ] ;DS:SI -> buffer data.
 26178                                  ;	shr	cx,1
 26179                                  ;	push	es
 26180                                  ;	mov	es,[SS:DMAADD+2]
 26181                                  ;
 26182                                  ;;      CX = sector size (in WORDs) ; CF=1 if odd # of bytes.
 26183                                  ;;      DS:SI-> Buffer sector data.
 26184                                  ;;      ES:DI-> Destination within Transfer memory block.
 26185                                  ;
 26186                                  ;	rep	movsw			;Copy buffer sector to Transfer memory
 26187                                  ;	;adc	cx,0                    ;CX=1 if odd # of bytes, else CX=0.
 26188                                  ;	;rep	movsb                   ;Copy last byte.
 26189                                  ;	jnc	short bufq1
 26190                                  ;	movsb
 26191                                  ;bufq1:
 26192                                  ;	pop	es
 26193                                  ;	pop	dx
 26194                                  ;	pop	di
 26195                                  ;	mov	al,[es:bp]  ; mov al,[es:bp+0]
 26196                                  ;	;mov	al,[ES:BP+DPB.DRIVE]
 26197                                  ;bufq2:
 26198                                  ;	call	SCANPLACE
 26199                                  ;bufq3:
 26200                                  ;	call	SKIPVISIT
 26201                                  ;	jnz	short bufq
 26202                                  ;	
 26203                                  ;	push	ss
 26204                                  ;	pop	ds
 26205                                  ;	pop	cx
 26206                                  ;	pop	cx
 26207                                  ;	pop	bx	
 26208                                  ;bufq4:
 26209                                  ;;;;;;;
 26210                                  	
 26211 0000426C E313                    	JCXZ	RDLAST
 26212                                  
 26213 0000426E E87620                  	call	IsEOF			; test for eof on fat size
 26214 00004271 732B                    	JAE	short SETSFT
 26215                                  
 26216 00004273 B200                    	MOV	DL,0
 26217                                  	;INC	word [LASTPOS]		; We'll be using next cluster
 26218                                  	;;;
 26219                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26220                                  	;;add	word [LASTPOS],1
 26221                                  	;adc	word [LASTPOS_HW],0
 26222                                  	; 09/02/2024 - Retro DOS v5.0
 26223 00004275 FF06[BA05]              	inc	word [LASTPOS]
 26224 00004279 75BE                    	jnz	short RDLP
 26225 0000427B FF06[E20A]              	inc	word [LASTPOS_HW]
 26226                                  	;;;
 26227 0000427F EBB8                    	JMP	short RDLP ; 19/05/2019
 26228                                  
 26229                                  RDLAST:
 26230 00004281 A1[D405]                	MOV	AX,[BYTCNT2]
 26231 00004284 09C0                    	OR	AX,AX
 26232 00004286 7416                    	JZ	short SETSFT
 26233 00004288 A3[D205]                	MOV	[BYTCNT1],AX
 26234                                  
 26235 0000428B E85616                  	call	NEXTSEC
 26236 0000428E 720E                    	JC	short SETSFT
 26237                                  
 26238 00004290 C706[CC05]0000          	MOV	word [BYTSECPOS],0
 26239 00004296 E8B715                  	call	BUFRD
 26240                                  	; 10/08/2018
 26241 00004299 7303                    	JNC	short SETSFT
 26242                                  	;JMP	SET_ACC_ERR_DS
 26243                                  	; 10/02/2024
 26244                                  	; ds=ss
 26245 0000429B E953FF                  	jmp	SET_ACC_ERR
 26246                                  
 26247                                  ;------------------------------------------------------------------------------
 26248                                  ;
 26249                                  ; Procedure Name : SETSFT
 26250                                  ; Inputs:
 26251                                  ;	[NEXTADD],[CLUSNUM],[LASTPOS] set to determine transfer size
 26252                                  ;		and set cluster fields
 26253                                  ; Function:
 26254                                  ;	Update [THISSFT] based on the transfer
 26255                                  ; Outputs:
 26256                                  ;	sf_position, sf_lstclus, and sf_cluspos updated
 26257                                  ;	ES:DI points to [THISSFT]
 26258                                  ;	CX No. of bytes transferred
 26259                                  ;	Carry clear
 26260                                  ;
 26261                                  ;----------------------------------------------------------------------------
 26262                                  
 26263                                  	;entry	SETSFT
 26264                                  
 26265                                  ; 26/07/2018 - Retro DOS v3.0
 26266                                  
 26267                                  	; 09/02/2024 - Retro DOS v5.0
 26268                                  	; (PCDOS 7.1 IBMDOS.COM)
 26269                                  
 26270                                  SETSFT:
 26271 0000429E C43E[9E05]              	LES	DI,[THISSFT]
 26272                                  
 26273                                  ; Same as SETSFT except ES:DI already points to SFT
 26274                                  	;entry	SETCLUS
 26275                                  SETCLUS:	
 26276 000042A2 8B0E[B805]              	MOV	CX,[NEXTADD]
 26277 000042A6 2B0E[2C03]              	SUB	CX,[DMAADD]		; Number of bytes transfered
 26278                                  	;;test	word [es:di+5],80h
 26279                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device
 26280                                  	;JNZ	short ADDREC		; don't set clusters if device
 26281                                  
 26282                                  	; 04/05/2019 - Retro DOS v4.0
 26283                                  	;test	byte [es:di+5],80h
 26284 000042AA 26F6450580              	TEST	byte [ES:DI+SF_ENTRY.sf_flags],devid_device
 26285 000042AF 751C                    	JNZ	short ADDREC		; don't set clusters if device
 26286                                  	
 26287                                  	;;;
 26288                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26289 000042B1 A1[DE0A]                	mov	ax,[CLUSNUM_HW]
 26290 000042B4 26894537                	mov	[es:di+37h],ax
 26291                                  	;mov	[es:di+SF_ENTRY.sf_lstclus+2],ax
 26292 000042B8 A1[E20A]                	mov	ax,[LASTPOS_HW]
 26293 000042BB 2689450B                	mov	[es:di+0Bh],ax
 26294                                  	;mov	[es:di+SF_ENTRY.sf_cluspos_hw],ax ; PCDOS 7.1 & Win ME
 26295                                  	;;mov	[es:di+SF_ENTRY.sf_firclus],ax ; MSDOS 5.0-6.22
 26296                                  	;;;
 26297                                  
 26298 000042BF A1[BC05]                	MOV	AX,[CLUSNUM]
 26299                                  	;;mov	[es:di+1Bh],ax ; MSDOS 3.3
 26300                                  	;mov	[es:di+35h],ax ; MSDOS 6.0 (& MSDOS 6.21)
 26301 000042C2 26894535                	MOV	[ES:DI+SF_ENTRY.sf_lstclus],AX
 26302 000042C6 A1[BA05]                	MOV	AX,[LASTPOS]
 26303                                  	;mov	[es:di+19h],ax
 26304 000042C9 26894519                	MOV	[ES:DI+SF_ENTRY.sf_cluspos],AX
 26305                                  
 26306                                  ;----------------------------------------------------------------------------
 26307                                  ;
 26308                                  ; Procedure : AddRec
 26309                                  ; Inputs:
 26310                                  ;	ES:DI points to SFT
 26311                                  ;	CX is No. Bytes transferred
 26312                                  ; Function:
 26313                                  ;	Update the SFT offset based on the transfer
 26314                                  ; Outputs:
 26315                                  ;	sf_position updated to point to first byte after transfer
 26316                                  ;	ES:DI points to SFT
 26317                                  ;	CX No. of bytes transferred
 26318                                  ;	Carry clear
 26319                                  ;----------------------------------------------------------------------------
 26320                                  
 26321                                  	;entry	AddRec
 26322                                  ADDREC:
 26323 000042CD E309                    	JCXZ	RET28		; If no records read, don't change position
 26324                                  	;add	[es:di+15h],cx
 26325 000042CF 26014D15                	ADD	[ES:DI+SF_ENTRY.sf_position],CX  ; Update current position
 26326                                  	;adc	word [es:di+17h], 0
 26327 000042D3 2683551700              	ADC	WORD [ES:DI+SF_ENTRY.sf_position+2],0
 26328                                  RET28:	
 26329 000042D8 F8                      	CLC
 26330 000042D9 C3                      	retn
 26331                                  
 26332                                  ; 25/07/2018
 26333                                  ; MSDOS 6.0
 26334                                  ;Break   <DskRdBufScan -- Disk Read Buffer Scan>
 26335                                  ;----------------------------------------------------------------------------
 26336                                  ;
 26337                                  ; Procedure Name : DskRdBufScan
 26338                                  ;
 26339                                  ; Inputs:
 26340                                  ;       CX = # of contiguous sectors read. (These constitute a block of
 26341                                  ;            sectors, also termed an "Extent".)
 26342                                  ;       [HIGH_SECTOR]:DX = physical sector # of first sector in extent.
 26343                                  ;       [TEMP_VAR2]:[TEMP_VAR] = Transfer address (destination data address).
 26344                                  ;       ES:BP -> Drive Parameter Block (DPB).
 26345                                  ;
 26346                                  ; Function:
 26347                                  ;	The Buffer Queue is scanned: the contents of any dirty buffers are
 26348                                  ;	"read" into the transfer memory block, so that the transfer memory
 26349                                  ;	reflects the most recent data.
 26350                                  ;
 26351                                  ; Outputs:
 26352                                  ;       Transfer memory updated as required.
 26353                                  ;
 26354                                  ; Uses:
 26355                                  ;       DS,AX,BX,CX,SI,DI destroyed.
 26356                                  ;       SS override for all global variables.
 26357                                  ;
 26358                                  ; Notes:
 26359                                  ;       FIRST_BUFF_ADDR is set-up to contain the LAST buffer to check, rather
 26360                                  ;	than the FIRST.
 26361                                  ;----------------------------------------------------------------------------
 26362                                  ;M039: Created
 26363                                  
 26364                                  ; 04/05/2019 - Retro DOS v4.0
 26365                                  ; DOSCODE:78F0h (MSDOS 6.21, MSDOS.SYS)
 26366                                  
 26367                                  ; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 26368                                  ; DOSCODE:78DCh (MSDOS 5.0, MSDOS.SYS)
 26369                                  
 26370                                  ; 09/02/2024 - Retro DOS v5.0
 26371                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8313h
 26372                                  
 26373                                  ;procedure DskRdBufScan,NEAR
 26374                                  ;
 26375                                  ;ASSUME  DS:NOTHING
 26376                                  
 26377                                  DskRdBufScan:
 26378 000042DA 36833E[7100]00          	cmp	word [ss:DirtyBufferCount],0 ; Any dirty buffers?
 26379 000042E0 743C                    	je	short bufx		     ; -no, skip all work.
 26380                                  
 26381 000042E2 368B1E[0706]            	mov     bx,[ss:HIGH_SECTOR]
 26382 000042E7 89DE                    	mov     si,bx
 26383 000042E9 01D1                    	add     cx,dx
 26384 000042EB 83D600                  	adc     si,0
 26385                                  
 26386 000042EE E8F825                  	call	GETCURHEAD		;DS:DI -> 1st buf in queue.
 26387                                  	;mov	ax,[di+2]
 26388 000042F1 8B4502                  	mov     ax,[di+BUFFINFO.buf_prev]
 26389 000042F4 36A3[7E11]              	mov     [ss:FIRST_BUFF_ADDR],ax
 26390                                  		
 26391                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26392                                  	;;mov	al,[es:bp+0]
 26393                                  	;mov	al,[es:bp+DPB.DRIVE]
 26394                                  	; 15/12/2022
 26395 000042F8 268A4600                	mov	al,[es:bp]
 26396                                  
 26397                                  ;       BX:DX = Extent start.
 26398                                  ;       SI:CX = Extent end + 1.
 26399                                  ;          AL = Drive #.
 26400                                  ;       DS:DI-> 1st buffer in queue.
 26401                                  ;[FIRST_BUFF_ADDR] = Address offset of last buffer in queue.
 26402                                  
 26403                                  bufq:	
 26404                                  	;cmp	al,[di+4]
 26405 000042FC 3A4504                  	cmp     al,[di+BUFFINFO.buf_ID] ;Same drive?
 26406 000042FF 7514                    	jne	short bufq1        	;  -no, jump.
 26407                                  
 26408                                  ;       Cmp32   bx,dx,<WORD PTR [di.buf_sector+2]>,<WORD PTR [di.buf_sector]>
 26409                                  ;       ja	short bufq1		;Jump if Extent start > buffer sector.
 26410                                  
 26411                                  	;cmp	bx,[di+8]
 26412 00004301 3B5D08                  	cmp	bx,[di+BUFFINFO.buf_sector+2]
 26413 00004304 7503                    	jne	short bufq01
 26414                                  	;cmp	dx,[di+6]
 26415 00004306 3B5506                  	cmp	dx,[di+BUFFINFO.buf_sector]
 26416                                  bufq01:
 26417 00004309 770A                    	ja	short bufq1
 26418                                  
 26419                                  ;       Cmp32   si,cx,<WORD PTR [di.buf_sector+2]>,<WORD PTR [di.buf_sector]>
 26420                                  ;       ja	short bufq2		;Jump if Extent end >= buffer sector.
 26421                                  
 26422                                  	;cmp	si,[di+8]
 26423 0000430B 3B7508                  	cmp	si,[di+BUFFINFO.buf_sector+2]
 26424 0000430E 7503                    	jne	short bufq02
 26425                                  	;cmp	cx,[di+6]
 26426 00004310 3B4D06                  	cmp	cx,[di+BUFFINFO.buf_sector]
 26427                                  bufq02:
 26428 00004313 770A                    	ja	short bufq2
 26429                                  bufq1:	
 26430 00004315 363B3E[7E11]            	cmp     di,[ss:FIRST_BUFF_ADDR]	;Scanned entire buffer queue?
 26431 0000431A 8B3D                    	mov	di,[di]
 26432                                  	;mov	di,[di+BUFFINFO.buf_next] ; Set-up for next buffer.
 26433 0000431C 75DE                    	jne	short bufq		; -no, do next buffer
 26434                                  bufx:
 26435 0000431E C3                      	retn				;Exit.
 26436                                  
 26437                                  ;       Buffer's sector is in Extent: if it is dirty, copy its contents to
 26438                                  ;	transfer memory; otherwise, just re-position it in the buffer queue
 26439                                  ;       as MRU (Most Recently Used).
 26440                                  
 26441                                  bufq2:	
 26442 0000431F 50                      	push	ax
 26443                                  	;test	byte [di+5],40h
 26444 00004320 F6450540                	test	byte [di+BUFFINFO.buf_flags],buf_dirty ;Buffer dirty?
 26445 00004324 7430                    	jz	short bufq3                    ; -no, jump.
 26446                                  
 26447                                  ;       SaveReg <cx,dx,si,di,es>
 26448 00004326 51                      	push	cx
 26449 00004327 52                      	push	dx
 26450 00004328 56                      	push	si
 26451 00004329 57                      	push	di
 26452 0000432A 06                      	push	es
 26453                                  
 26454 0000432B 89D0                    	mov     ax,dx
 26455                                  	;sub	ax,[di+6]
 26456 0000432D 2B4506                  	sub	ax,[di+BUFFINFO.buf_sector]
 26457 00004330 F7D8                    	neg	ax
 26458                                  
 26459                                  ;       AX = offset (in sectors) of buffer sector within Transfer memory
 26460                                  ;            block. (Note: the upper word of the sector # may be ignored
 26461                                  ;	     since no more than 64k bytes will ever be read. This 64k limit
 26462                                  ;            is imposed by the input parameters of the disk read operation.)
 26463                                  
 26464                                  	;lea	si,[di+20]
 26465 00004332 8D7518                  	lea	si,[di+BUFINSIZ]	;DS:SI -> buffer data.
 26466                                  	;mov	cx,[es:bp+2]
 26467 00004335 268B4E02                	mov     cx,[es:bp+DPB.SECTOR_SIZE] ;CX = sector size (in bytes).
 26468 00004339 F7E1                    	mul     cx			;AX = offset (in bytes) of buf. sector
 26469                                  	;mov	di,[ss:TEMP_VAR]
 26470                                  	; 09/02/2024
 26471 0000433B 36C43E[0C06]            	les	di,[ss:TEMP_VAR]
 26472 00004340 01C7                    	add	di,ax
 26473                                  	;mov	es,[ss:TEMP_VAR2]
 26474 00004342 D1E9                    	shr	cx,1
 26475                                  
 26476                                  ;	   CX = sector size (in WORDs) ; CF=1 if odd # of bytes.
 26477                                  ;       DS:SI-> Buffer sector data.
 26478                                  ;       ES:DI-> Destination within Transfer memory block.
 26479                                  
 26480                                  ; 09/02/2024 - Retro DOS v5.0
 26481                                  %if 0
 26482                                  	rep	movsw			;Copy buffer sector to Transfer memory
 26483                                  	;; 04/05/2019
 26484                                  	;;adc	cx,0                    ;CX=1 if odd # of bytes, else CX=0.
 26485                                  	;;rep	movsb                   ;Copy last byte.
 26486                                  	;jnc	short bufq03
 26487                                  	;movsb
 26488                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26489                                  	;adc	cx,0
 26490                                  	;rep	movsb
 26491                                  	; 22/09/2023
 26492                                  	jnc	short bufq03
 26493                                  	movsb
 26494                                  %else
 26495                                  	;;;
 26496                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26497 00004344 36803E[6A00]00          	cmp	byte [ss:DDMOVE],0
 26498                                  	;jz	short bufq03+1 ; rep movsw (skip 32bit prefix)
 26499                                  	; 06/04/2024 
 26500 0000434A 7403                    	jz	short bufq03
 26501 0000434C D1E9                    	shr	cx,1
 26502                                  ;bufq03:
 26503                                  	;rep	movsd
 26504                                  	; 06/04/2024
 26505 0000434E 66                      	db	66h	; 32bit prefix
 26506                                  bufq03:
 26507 0000434F F3A5                    	rep	movsw
 26508                                  	;;;
 26509                                  %endif
 26510                                  
 26511                                  ;bufq03:	; 09/02/2024
 26512                                  	;RestoreReg <es,di,si,dx,cx>
 26513 00004351 07                      	pop	es
 26514 00004352 5F                      	pop	di
 26515 00004353 5E                      	pop	si
 26516 00004354 5A                      	pop	dx
 26517 00004355 59                      	pop	cx
 26518                                  
 26519                                  ;       DS:DI -> current buffer.
 26520                                  bufq3:	
 26521 00004356 89F8                    	mov     ax,di			;DS:AX -> Current buffer.
 26522                                          ;invoke SCANPLACE
 26523 00004358 E8A025                  	call	SCANPLACE
 26524 0000435B 363B06[7E11]            	cmp	ax,[ss:FIRST_BUFF_ADDR] ;Last buffer?
 26525 00004360 58                      	pop	ax
 26526                                  	;jne	short bufq		; -no, jump.
 26527                                  	;;jmp	short bufx		; -yes, exit.
 26528                                  	;; 12/06/2019
 26529                                  	;retn
 26530                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compability)
 26531 00004361 7599                    	jne	short bufq
 26532                                  	;jmp	short bufx
 26533                                  	; 09/02/2024
 26534 00004363 C3                      	retn	; Exit
 26535                                  
 26536                                  ;EndProc DskRdBufScan
 26537                                  
 26538                                  ;============================================================================
 26539                                  ; DISK3.ASM, MSDOS 6.0, 1991
 26540                                  ;============================================================================
 26541                                  ; 04/05/2019 - Retro DOS v4.0
 26542                                  ; 24/07/2018 - Retro DOS v3.0
 26543                                  
 26544                                  ;Break   <DISKWRITE -- PERFORM USER DISK WRITE>
 26545                                  ;----------------------------------------------------------------------------
 26546                                  ;
 26547                                  ; Procedure Name : DISKWRITE
 26548                                  ;
 26549                                  ; Inputs:
 26550                                  ;       Outputs of SETUP
 26551                                  ; Function:
 26552                                  ;       Perform disk write
 26553                                  ; Outputs:
 26554                                  ;    Carry clear
 26555                                  ;       CX = No. of bytes written
 26556                                  ;       ES:DI point to SFT
 26557                                  ;       SFT offset and cluster pointers updated
 26558                                  ;    Carry set
 26559                                  ;       CX = 0
 26560                                  ;       ES:DI point to SFT
 26561                                  ;       AX has error code
 26562                                  ;----------------------------------------------------------------------------
 26563                                  
 26564                                  ;hkn; called by DOS_WRITE. DS already set up at this point.
 26565                                  
 26566                                  ; DOSCODE:797Ah (MSDOS 6.21, MSDOS.SYS)
 26567                                  
 26568                                  ; 20/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 26569                                  ; DOSCODE:7966h (MSDOS 5.0, MSDOS.SYS)
 26570                                  
 26571                                  ; 10/02/2024
 26572                                  ; 09/02/2024 - Retro DOS v5.0
 26573                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:83A3h
 26574                                  
 26575                                  ; (Windows ME IO.SYS - BIOSCODE:0B7B2h)
 26576                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:797Ah)
 26577                                  
 26578                                  DISKWRITE:
 26579                                  	; MSDOS 3.3
 26580                                  	; IBMDOS.COM - Offset 436Dh
 26581                                  	;;test	byte [es:di+4],8
 26582                                  	;TEST	byte [ES:DI+SF_ENTRY.sf_attr],attr_volume_id
 26583                                  	;jz	short write_cont
 26584                                  	;jmp	SET_ACC_ERR_DS
 26585                                  ;write_cont:
 26586                                  	;push	cx
 26587                                  	;or	cx,cx
 26588                                  	;jnz	short Not_Truncate
 26589                                  	;;mov	cx,-1
 26590                                  	;dec	cx
 26591                                  ;Not_Truncate:
 26592                                  	;call	LOCK_CHECK
 26593                                  	;pop	cx
 26594                                  	;jnb	short _WRITE_OK
 26595                                  	;call	WRITE_LOCK_VIOLATION
 26596                                  	;jnb	short DISKWRITE
 26597                                  	;retn
 26598                                  
 26599                                  	; MSDOS 6.0
 26600 00004364 E8ACFC                  	call	CHECK_WRITE_LOCK	;IFS. check write lock	;AN000;
 26601                                  	; 19/08/2018
 26602 00004367 7304                    	JNC	short _WRITE_OK		;IFS. lock check ok	;AN000;
 26603 00004369 C3                      	retn
 26604                                  
 26605                                  WRTEOFJ:
 26606 0000436A E95902                  	JMP     WRTEOF
 26607                                  
 26608                                  _WRITE_OK:
 26609                                   	; 27/07/2018
 26610                                  	; IBMDOS.COM - Offset 438Eh
 26611                                  	
 26612                                  	; MSDOS 3.3 (& MSDOS 6.0)
 26613                                  	;and	word [es:di+5],0BFBFh
 26614 0000436D 26816505BFBF            	AND     word [ES:DI+SF_ENTRY.sf_flags],~(sf_close_nodate|devid_file_clean)
 26615                                  				; Mark file as dirty, clear no date on close
 26616                                  ; 10/02/2024
 26617                                  %if 0
 26618                                  	; 04/05/2019 - Retro DOS v4.0
 26619                                  
 26620                                  	; MSDOS 6.0
 26621                                  	;mov 	ax,[es:di+11h]
 26622                                  	MOV	AX,[ES:DI+SF_ENTRY.sf_size]		;M039
 26623                                          MOV	[TEMP_VAR],AX                           ;M039
 26624                                  	;mov	ax,[es:di+13h]
 26625                                  	MOV	AX,[ES:DI+SF_ENTRY.sf_size+2]		;M039
 26626                                          MOV	[TEMP_VAR2],AX                          ;M039
 26627                                  %else
 26628                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS COM)
 26629                                  	;les	ax,[es:di+11h]
 26630 00004373 26C44511                	les	ax,[es:di+SF_ENTRY.sf_size]
 26631 00004377 8C06[0E06]              	mov	[TEMP_VAR2],es
 26632 0000437B A3[0C06]                	mov	[TEMP_VAR],ax
 26633                                  %endif
 26634                                  
 26635                                  ;	TEMP_VAR2:TEMP_VAR = Current file size (sf_size);M039
 26636                                  
 26637                                  	; MSDOS 3.3 (& MSDOS 6.0)
 26638 0000437E C42E[8A05]              	LES     BP,[THISDPB]
 26639                                  
 26640 00004382 E8D2FD                  	call	BREAKDOWN
 26641                                  
 26642 00004385 A1[CE05]                	MOV     AX,[BYTPOS]
 26643 00004388 8B16[D005]              	MOV     DX,[BYTPOS+2]
 26644 0000438C E3DC                    	JCXZ    WRTEOFJ                 ;Make the file length = sf_position
 26645 0000438E 01C8                    	ADD     AX,CX
 26646 00004390 83D200                  	ADC     DX,0                    ;DX:AX = last byte to write + 1.
 26647                                  	
 26648                                  	;;;
 26649                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26650 00004393 7303                    	jnc	short dskwrt_1
 26651                                  ACC_ERRWJ2:
 26652                                  	;;jmp	SET_ACC_ERRW
 26653                                  	;jmp	SET_ACC_ERR_DS ; ds<>ss ; 10/02/2024
 26654                                  	; 10/02/2024
 26655                                  	; ds=ss
 26656 00004395 E959FE                  	jmp	SET_ACC_ERR
 26657                                  
 26658                                  dskwrt_1:
 26659                                  	;test	byte [es:di+3],10h
 26660 00004398 26F6450310              	test	byte [es:di+SF_ENTRY.sf_mode+1],10h
 26661 0000439D 750B                    	jnz	short dskwrt_3		; > 2GB file size (up to 4GB) allowed
 26662 0000439F 81FAFF7F                	cmp	dx,7FFFh		; check for 2GB file size limit
 26663 000043A3 7503                    	jne	short dskwrt_2
 26664 000043A5 83F8FF                  	cmp	ax,0FFFFh
 26665                                  dskwrt_2:
 26666 000043A8 77EB                    	ja	short ACC_ERRWJ2 ; error,
 26667                                  					; file position/pointer overs 2GB limit!
 26668                                  dskwrt_3:
 26669                                  	;;;
 26670                                  
 26671                                  	;mov	bx,[es:bp+2]
 26672 000043AA 268B5E02                	MOV     BX,[ES:BP+DPB.SECTOR_SIZE]
 26673                                  
 26674                                  	; MSDOS 3.3
 26675                                  	;cmp	dx,bx
 26676                                  	;jnb	short WRTERR33
 26677                                  	;div	bx
 26678                                  	;mov	bx,ax
 26679                                  	;OR	DX,DX
 26680                                  	;JNZ	short CALCLUS
 26681                                  	;dec	ax
 26682                                  ;CALCLUS:
 26683                                  	; MSDOS 3.3
 26684                                  	;mov	cl,[es:bp+5]
 26685                                  	;MOV	CL,[ES:BP+DPB.CLUSTER_SHIFT]
 26686                                  	;shr	ax,cl
 26687                                  	;push	ax
 26688                                  	;push	dx
 26689                                  	;push	es
 26690                                  	;les	di,[THISSFT]
 26691                                  	;;mov	ax,[es:di+11h]
 26692                                  	;;mov	dx,[es:di+13h]
 26693                                  	;mov	ax,[ES:DI+SF_ENTRY.sf_size]
 26694                                  	;mov	dx,[ES:DI+SF_ENTRY.sf_size+2]
 26695                                  	;pop	es
 26696                                  	;;DX:AX = current file size (in bytes).
 26697                                  	;;div	word [es:bp+2]
 26698                                  	;div	word [ES:BP+DPB.SECTOR_SIZE]
 26699                                  	;mov	cx,ax
 26700                                  	;or	dx,dx
 26701                                  	;jz	short NORND
 26702                                  	;inc	ax
 26703                                  ;NORND:
 26704                                  	; MSDOS 6.0
 26705 000043AE E86603                  	CALL	DIV32                   ;DX:AX/BX = CX:AX + DX (rem.).
 26706 000043B1 89C6                    	MOV	SI,AX
 26707 000043B3 890E[0706]                      MOV	[HIGH_SECTOR],CX
 26708                                  
 26709                                  ;       [HIGH_SECTOR]:SI = Last full sector to write.
 26710                                  
 26711 000043B7 09D2                    	OR	DX,DX
 26712 000043B9 52                      	PUSH	DX			;M039: Free DX for use by SHR32
 26713 000043BA 89CA                    	MOV	DX,CX			;M039
 26714 000043BC 7506                    	JNZ	short CALCLUS
 26715 000043BE 83E801                  	SUB	AX,1                    ;AX must be zero base indexed	;AC000;
 26716 000043C1 83DA00                  	SBB	DX,0			;M039 ;F.C. >32mb		;AN000;
 26717                                  
 26718                                  CALCLUS:
 26719                                  	; MSDOS 6.0
 26720 000043C4 E87703                  	CALL	SHR32                   ;F.C. >32mb			;AN000;
 26721                                  	;POP	DX
 26722                                  	;;;
 26723                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26724 000043C7 59                      	pop	cx
 26725 000043C8 87CA                    	xchg	cx,dx
 26726 000043CA 51                      	push	cx ; **!
 26727                                  	; cx:ax = Last cluster to write
 26728                                  	;;;
 26729                                  
 26730                                  ;       AX = Last cluster to write.
 26731                                  ;       DX = # of bytes in last sector to write (the "tail").
 26732                                  ;       BX = [ES:BP+DPB.SECTOR_SIZE]
 26733                                  
 26734 000043CB 50                      	PUSH	AX ; *!
 26735 000043CC 52                      	PUSH	DX
 26736                                  ;M039
 26737 000043CD 8B16[0E06]              	mov	dx,[TEMP_VAR2]
 26738 000043D1 A1[0C06]                	mov	ax,[TEMP_VAR]           ;DX:AX = current file size (in bytes).
 26739 000043D4 E84003                  	call	DIV32           	;DX:AX/BX = CX:AX + DX (rem.)
 26740 000043D7 890E[0E06]              	mov	[TEMP_VAR2],cx
 26741 000043DB 890E[CA05]              	mov	[VALSEC+2],cx
 26742 000043DF 89C1                    	mov	cx,ax
 26743 000043E1 89F3                    	mov	bx,si
 26744                                  
 26745                                  ;       [HIGH_SECTOR]:BX = Last full sector to write.
 26746                                  ;          [VALSEC+2]:CX = Last full sector of current file.
 26747                                  ;         [TEMP_VAR2]:CX = Last full sector of current file.
 26748                                  ;                     DX = # of bytes in last sector of current file.
 26749                                  ;M039
 26750 000043E3 09D2                    	OR	DX,DX
 26751 000043E5 7407                    	JZ	short NORND
 26752                                  	;ADD	AX,1            	;Round up if any remainder	;AC000;
 26753                                  	;ADC	word [VALSEC+2],0
 26754                                  	; 22/09/2023
 26755 000043E7 40                      	inc	ax  ; 0FFFFh -> 0
 26756 000043E8 7504                    	jnz	short NORND
 26757 000043EA FF06[CA05]              	inc	word [VALSEC+2]
 26758                                  NORND:	
 26759                                  	; MSDOS 3.3 & MSDOS 6.0
 26760 000043EE A3[C805]                	MOV     [VALSEC],AX
 26761                                  
 26762                                  ;       [VALSEC] = Last sector of current file.
 26763                                  
 26764 000043F1 31C0                    	XOR     AX,AX
 26765 000043F3 A3[DE05]                	MOV     [GROWCNT],AX
 26766 000043F6 A3[E005]                	MOV     [GROWCNT+2],AX
 26767 000043F9 58                      	POP     AX		; # of bytes in last sector to write (the "tail").
 26768                                  
 26769                                  	; MSDOS 6.0
 26770 000043FA 8B3E[0706]              	MOV	DI,[HIGH_SECTOR]        ;F.C. >32mb			;AN000;
 26771 000043FE 3B3E[0E06]              	CMP	DI,[TEMP_VAR2]		;M039; F.C. >32mb		;AN000;
 26772 00004402 726F                    	JB	short NOGROW		;F.C. >32mb                     ;AN000;
 26773 00004404 7408                    	JZ	short lowsec		;F.C. >32mb                     ;AN000;
 26774 00004406 29CB                    	SUB	BX,CX                   ;F.C. >32mb                     ;AN000;
 26775 00004408 1B3E[0E06]              	SBB	DI,[TEMP_VAR2]   	;M039; F.C. >32mb di:bx no. of sectors ;AN000;
 26776 0000440C EB08                    	JMP	short yesgrow           ;F.C. >32mb                     ;AN000;
 26777                                  lowsec:
 26778                                  	;MOV	DI,0			;F.C. >32mb
 26779                                  	; 22/09/2023
 26780 0000440E 31FF                    	xor	di,di
 26781                                  	; MSDOS 3.3 & MSDOS 6.0
 26782 00004410 29CB                    	SUB	BX,CX			; Number of full sectors
 26783 00004412 725F                    	JB	short NOGROW
 26784 00004414 7450                    	JZ	short TESTTAIL
 26785                                  yesgrow:
 26786                                  	; MSDOS 3.3 (& MSDOS 6.0)
 26787 00004416 89D1                    	MOV     CX,DX
 26788 00004418 93                      	XCHG    AX,BX
 26789                                  	;mul	word [es:bp+2]
 26790 00004419 26F76602                	MUL	word [ES:BP+DPB.SECTOR_SIZE] ; Bytes of full sector growth
 26791                                  	
 26792                                  	; MSDOS 6.0
 26793 0000441D 8916[0706]              	MOV	[HIGH_SECTOR],DX	;F.C. >32mb save dx		;AN000;
 26794 00004421 A3[0E06]                	MOV	[TEMP_VAR2],AX		;M039; F.C. >32mb save ax	;AN000;
 26795 00004424 89F8                    	MOV	AX,DI			;F.C. >32mb			;AN000;
 26796                                  	;mul	word [es:bp+2]
 26797 00004426 26F76602                	MUL	word [ES:BP+DPB.SECTOR_SIZE] ;F.C. >32mb do higher word multiply ;AN000;
 26798                                  	
 26799 0000442A 0306[0706]              	ADD	AX,[HIGH_SECTOR]	;F.C. >32mb add lower value	;AN000;
 26800                                  	;MOV	DX,AX			;F.C. >32mb DX:AX is the result of ;AN000;
 26801                                  	; 09/02/2024
 26802 0000442E 92                      	xchg	ax,dx
 26803 0000442F A1[0E06]                	MOV	AX,[TEMP_VAR2]		;M039; F.C. >32mb a 32 bit multiply ;AN000;
 26804                                  
 26805                                  	; MSDOS 3.3 (& MSDOS 6.0)
 26806 00004432 29C8                    	SUB     AX,CX			; Take off current "tail"
 26807 00004434 83DA00                  	SBB     DX,0			; 32-bit extension
 26808 00004437 01D8                    	ADD     AX,BX			; Add on new "tail"
 26809 00004439 83D200                  	ADC     DX,0			; ripple tim's head off
 26810 0000443C EB2E                    	JMP     SHORT SETGRW
 26811                                  
 26812                                  HAVSTART:
 26813                                  	;int 3
 26814                                  	;;;
 26815                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26816 0000443E 8936[F80A]              	mov	[CLSKIP_HW],si
 26817                                  	;;;
 26818 00004442 89C1                    	MOV     CX,AX
 26819 00004444 E87813                  	call	SKPCLP
 26820                                  	;;;
 26821                                  	; 09/02/2024
 26822 00004447 A1[F80A]                	mov     ax,[CLSKIP_HW]
 26823 0000444A 39C8                    	cmp     ax,cx
 26824 0000444C 7502                    	jne     short HAVSTART_cont
 26825                                  	;;;
 26826                                  	; 10/02/2024
 26827 0000444E E314                    	JCXZ	DOWRTJ
 26828                                  	; 16/12/2022
 26829                                  	;jcxz	DOWRT
 26830                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26831                                  	;jcxz	DOWRTJ
 26832                                  	;;;
 26833                                  	; 09/02/2024
 26834                                  HAVSTART_cont:
 26835 00004450 A3[F00A]                	mov	[CCOUNT_HW],ax
 26836 00004453 E8A415                  	call	ALLOCATE
 26837                                  	; 10/02/2024
 26838 00004456 730C                    	JNC	short DOWRTJ
 26839                                  	; 16/12/2022
 26840                                  	;jnc	short DOWRT
 26841                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26842                                  	;jnc	short DOWRTJ
 26843                                  
 26844                                  	; 10/02/2024
 26845                                  	;entry   WRTERR
 26846                                  WRTERR:
 26847 00004458 B40F                    	MOV     AH,0FH			;MS. write/data/fail/abort	;AN000;
 26848                                  
 26849                                  	;entry WRTERR22
 26850                                  WRTERR22:
 26851 0000445A A0[7605]                	MOV     AL,[THISDRV]		;MS.				;AN000;
 26852                                  
 26853                                  	; 27/07/2018
 26854                                  WRTERR33:
 26855                                  	;MOV	CX,0			;No bytes transferred
 26856 0000445D 31C9                    	XOR     CX,CX
 26857                                  
 26858 0000445F C43E[9E05]              	LES     DI,[THISSFT]
 26859                                  	;CLC ; 19/05/2019
 26860                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26861                                  	; 16/12/2022
 26862                                  	;clc
 26863 00004463 C3                      	retn
 26864                                  
 26865                                  	; 10/02/2024
 26866                                  	; 16/12/2022
 26867                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26868                                  DOWRTJ:
 26869 00004464 EB79                    	JMP	short DOWRT
 26870                                  
 26871                                  TESTTAIL:
 26872 00004466 29D0                    	SUB	AX,DX
 26873 00004468 7609                    	JBE	short NOGROW
 26874 0000446A 31D2                    	XOR	DX,DX
 26875                                  SETGRW:
 26876 0000446C A3[DE05]                	MOV	[GROWCNT],AX
 26877 0000446F 8916[E005]              	MOV	[GROWCNT+2],DX
 26878                                  NOGROW:
 26879                                  	; 09/02/2024
 26880                                  	;POP	AX ; *!
 26881                                  
 26882                                  ; 10/02/2024
 26883                                  %if 0
 26884                                  	MOV     CX,[CLUSNUM] ; *+ ; First cluster accessed
 26885                                  	;;;
 26886                                  	; 09/02/2024
 26887                                  	mov	dx,[CLUSNUM_HW] ; *+
 26888                                  	;;;
 26889                                  	call	FNDCLUS
 26890                                  %else
 26891                                  	; 10/02/2024 - Retro DOS v5.0
 26892 00004473 E8E412                  	call	FNDCLUS_X ; *+
 26893                                  %endif
 26894                                  	;;;
 26895                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26896 00004476 58                      	pop	ax ; *!
 26897 00004477 5E                      	pop	si ; **!	; si:ax = Last cluster
 26898                                  	;;;
 26899 00004478 7279                    	JC	short ACC_ERRWJ ; ds=ss
 26900 0000447A 891E[BC05]              	MOV	[CLUSNUM],BX
 26901 0000447E 8916[BA05]              	MOV	[LASTPOS],DX
 26902                                  
 26903 00004482 29D0                    	SUB	AX,DX           ; Last cluster minus current cluster
 26904                                  	; 09/02/2024
 26905                                  	;JZ	short DOWRT	; If we have last clus, we must have first
 26906                                  	;;;
 26907                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26908 00004484 1B36[E20A]              	sbb	si,[LASTPOS_HW]
 26909 00004488 8B16[E80A]              	mov	dx,[CLUSTNUM_HW]
 26910 0000448C 8916[DE0A]              	mov	[CLUSNUM_HW],dx
 26911 00004490 7504                    	jnz	short NOGROW2
 26912 00004492 09C0                    	or	ax,ax
 26913 00004494 7449                    	jz	short DOWRT
 26914                                  NOGROW2:
 26915 00004496 3B0E[F80A]              	cmp	cx,[CLSKIP_HW]
 26916 0000449A 7502                    	jne	short dskwrt_4
 26917                                  	;;;
 26918 0000449C E3A0                    	JCXZ	HAVSTART        ; See if no more data
 26919                                  dskwrt_4:	; 09/02/2024
 26920 0000449E 51                      	PUSH	CX              ; No. of clusters short of first
 26921                                  	;;;
 26922                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26923 0000449F FF36[F80A]              	push	word [CLSKIP_HW]
 26924 000044A3 8936[F00A]              	mov	[CCOUNT_HW],si
 26925                                  	;;;
 26926 000044A7 89C1                    	MOV	CX,AX
 26927 000044A9 E84E15                  	call	ALLOCATE
 26928                                  	;;;
 26929                                  	; 09/02/2024
 26930 000044AC 8F06[F80A]              	pop	word [CLSKIP_HW]
 26931                                  	;;;
 26932 000044B0 59                      	POP	CX
 26933 000044B1 72A5                    	JC	short WRTERR
 26934 000044B3 8B16[BA05]              	MOV	DX,[LASTPOS]
 26935                                  
 26936                                  ; 09/02/2024
 26937                                  %if 0
 26938                                  	INC	DX
 26939                                  	DEC	CX
 26940                                  	JZ	short NOSKIP
 26941                                  %else
 26942                                  	;;;
 26943                                  	; 09/02/2024 Retro DOS v5.0
 26944                                  	; (PCDOS 7.1 IBMDOS.COM)
 26945                                  	;add	dx,1
 26946                                  	;adc	word [LASTPOS_HW],0
 26947 000044B7 42                      	inc	dx
 26948 000044B8 7504                    	jnz	short dskwrt_10
 26949 000044BA FF06[E20A]              	inc	word [LASTPOS_HW]
 26950                                  dskwrt_10:
 26951 000044BE 83E901                  	sub	cx,1
 26952 000044C1 831E[F80A]00            	sbb	word [CLSKIP_HW],0
 26953 000044C6 7504                    	jnz	short dskwrt_5
 26954 000044C8 09C9                    	or	cx,cx
 26955 000044CA 7405                    	jz	short NOSKIP
 26956                                  dskwrt_5:
 26957                                  	;;;
 26958                                  %endif
 26959 000044CC E8F012                  	call	SKPCLP
 26960 000044CF 7222                    	JC	short ACC_ERRWJ ; ds=ss ; 10/02/2024
 26961                                  
 26962                                  NOSKIP:
 26963 000044D1 891E[BC05]              	MOV	[CLUSNUM],BX
 26964                                  	;;;
 26965                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26966 000044D5 A1[E80A]                	mov	ax,[CLUSTNUM_HW]
 26967 000044D8 A3[DE0A]                	mov	[CLUSNUM_HW],ax
 26968                                  	;;;
 26969 000044DB 8916[BA05]              	MOV	[LASTPOS],DX
 26970                                  DOWRT:
 26971 000044DF 833E[D205]00            	CMP	word [BYTCNT1],0
 26972 000044E4 7410                    	JZ	short WRTMID
 26973                                  	;;;
 26974                                  	; 09/02/2024
 26975 000044E6 8B1E[DE0A]              	mov	bx,[CLUSNUM_HW]
 26976 000044EA 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 26977                                  	;;;
 26978                                  	; 09/02/2024
 26979                                  	;MOV	BX,[CLUSNUM]	 ; (not used in 'BUFWRT') ; 09/02/2024
 26980 000044EE E89813                  	call	BUFWRT
 26981                                  	;JC	short ACC_ERRWJ
 26982                                  	; 09/02/2024
 26983 000044F1 7303                    	jnc	short WRTMID
 26984                                  
 26985                                  	; 09/02/2024
 26986                                  ACC_ERRWJ:
 26987                                  	; 10/08/2018
 26988                                  	;;JMP	SET_ACC_ERRW
 26989                                  	; 16/12/2022
 26990                                  	;jmp	SET_ACC_ERR_DS ; ds<>ss ; 10/02/2024
 26991                                  	; 10/02/2024
 26992                                  	; ds=ss
 26993 000044F3 E9FBFC                  	jmp	SET_ACC_ERR
 26994                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26995                                  	;;jmp	SET_ACC_ERRW
 26996                                  
 26997                                  WRTMID:
 26998 000044F6 A1[D605]                	MOV	AX,[SECCNT]
 26999 000044F9 09C0                    	OR	AX,AX
 27000                                  	; 20/11/2022
 27001                                  	;JZ	short WRTLAST	; 24/07/2019	;M039
 27002                                  	; 10/02/2024
 27003 000044FB 7503                    	jnz	short WRTMID2
 27004 000044FD E98600                  	jmp     WRTLAST
 27005                                  WRTMID2:
 27006 00004500 0106[C405]              	ADD	[SECPOS],AX
 27007                                  	; 19/05/2019
 27008                                  	; MSDOS 6.0
 27009 00004504 8316[C605]00            	ADC	WORD [SECPOS+2],0	;F.C. >32mb 	;AN000;
 27010 00004509 E8D813                  	call	NEXTSEC
 27011                                  	; 16/12/2022
 27012 0000450C 72E5                    	JC	short ACC_ERRWJ
 27013                                  	;JC	short SET_ACC_ERRW	;M039
 27014 0000450E C606[7405]01            	MOV	BYTE [TRANS],1		; A transfer is taking place
 27015 00004513 8A16[7305]              	MOV	DL,[SECCLUSPOS] 	; (dx/DL = Extent start) ((dh = ?))
 27016                                  	;;;
 27017                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27018 00004517 8B1E[DE0A]              	mov	bx,[CLUSNUM_HW]
 27019 0000451B 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 27020                                  	;;;
 27021 0000451F 8B1E[BC05]              	MOV	BX,[CLUSNUM]
 27022 00004523 8B0E[D605]              	MOV	CX,[SECCNT]
 27023                                  WRTLP:
 27024 00004527 E80114                  	call	OPTIMIZE
 27025                                  	; 09/02/2024
 27026                                  	;JC	short SET_ACC_ERRW
 27027                                  	; 16/12/2022
 27028 0000452A 72C7                    	JC	short ACC_ERRWJ  ; ds=ss ; 10/02/2024
 27029                                  
 27030                                  ;M039
 27031                                  ;       DI = Next physical cluster.
 27032                                  ;       AX = # sectors remaining.
 27033                                  ;       [DMAADD+2]:BX = transfer address (source data address).
 27034                                  ;       CX = # of contiguous sectors to write. (These constitute a block of
 27035                                  ;	     sectors, also termed an "Extent".)
 27036                                  ;       [HIGH_SECTOR]:DX = physical sector # of first sector in extent.
 27037                                  ;       ES:BP -> Drive Parameter Block (DPB).
 27038                                  ;
 27039                                  ;       Purge the Buffer Queue and the Secondary Cache of any buffers which
 27040                                  ;	are in Extent; they are being over-written.
 27041                                  
 27042                                  	;;;
 27043                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27044 0000452C FF36[EC0A]              	push    word [CCONTENT_HW]
 27045                                  	;;;
 27046                                  
 27047 00004530 57                      	push    di		; CCONTENT_HW:DI = Next physical cluster
 27048 00004531 50                      	push    ax		; AX = # sectors remaining
 27049                                  
 27050                                  	; MSDOS 3.3
 27051                                  	; IBMDOS.COM (1987) - Offset 4497h
 27052                                  	;push	dx
 27053                                  	;push	bx
 27054                                  	;mov	al,[es:bp]
 27055                                  	;;mov	AL,[ES:BP+DPB.DRIVE] ; mov al,[es:bp+0]
 27056                                  	;mov	bx,cx
 27057                                  	;add	bx,dx	; (bx = Extent end)
 27058                                  
 27059                                  ;	DX = Extent start.
 27060                                  ;	BX = Extent end.
 27061                                  ;	AL = Drive #.
 27062                                  
 27063                                  	;call	SETVISIT
 27064                                  
 27065                                  ;wbufq1:
 27066                                  	;;or	byte [di+5],20h
 27067                                  	;or	byte [DI+BUFFINFO.buf_flags],buf_visit ; Bit 5 = reserved
 27068                                  	;;cmp	al,[di+4]	
 27069                                  	;cmp	al,[DI+BUFFINFO.buf_ID]
 27070                                  	;jnz	short wbufq2	; Jump if Extent start > buffer sector.
 27071                                  	;;cmp	[di+6],dx
 27072                                  	;cmp	[DI+BUFFINFO.buf_sector],dx
 27073                                  	;jb	short wbufq2
 27074                                  	;;cmp	[di+6],bx
 27075                                  	;cmp	[DI+BUFFINFO.buf_sector],bx
 27076                                  	;jnb	short wbufq2	; Jump if Extent end >= buffer sector.
 27077                                  
 27078                                  	;; Buffer sector is in the Extent
 27079                                  
 27080                                  	;;mov	word [di+4],20FFh
 27081                                  	;mov	word [DI+BUFFINFO.buf_ID],20FFh
 27082                                  	;				; .buf_ID,    AL = FFh (Free buffer)
 27083                                  	;				; .buf_flags, AH = 0, reset/clear
 27084                                  	;call	SCANPLACE
 27085                                  ;wbufq2:
 27086                                  	;call	SKIPVISIT
 27087                                  	;jnz	short wbufq1
 27088                                  	;pop	bx
 27089                                  	;pop	dx
 27090                                  
 27091                                          ; MSDOS 6.0
 27092 00004532 E89501                  	call	DskWrtBufPurge		;DS trashed.
 27093                                  
 27094                                  ;ASSUME DS:NOTHING
 27095                                  ;M039
 27096                                  	; MSDOS 3.3 & MSDOS 6.0
 27097                                  ;hkn; SS override for DMAADD and ALLOWED
 27098 00004535 368E1E[2E03]            	MOV     DS,[SS:DMAADD+2]
 27099                                  	;mov	byte [ss:ALLOWED],38h
 27100 0000453A 36C606[4B03]38          	MOV	byte [SS:ALLOWED],Allowed_RETRY+Allowed_FAIL+Allowed_IGNORE
 27101                                  
 27102                                  ;	put logic from DWRITE in-line here so we can modify it
 27103                                  ;	for DISK FULL conditions.
 27104                                  
 27105                                  	; 20/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27106                                  	; DOSCODE:7AD8h (MSDOS 5.0 MSDOS.SYS)
 27107                                  
 27108                                  	; 16/12/2022
 27109                                  	; MSDOS 3.3 (& MSDOS 5.0)
 27110                                  	;call	DWRITE
 27111                                  
 27112                                  ;DWRITE_OKAY:
 27113                                  
 27114                                  	; 16/12/2022
 27115                                  	; MSDOS 5.0 (& MSDOS 3.3)
 27116                                  	;pop	cx
 27117                                  	;pop	bx
 27118                                  	;push	ss
 27119                                  	;pop	ds
 27120                                  	;jc	short SET_ACC_ERRW
 27121                                  	;jcxz	WRTLAST
 27122                                  	;mov	dl,0
 27123                                  	;inc	word [LASTPOS]
 27124                                  	;jmp	short WRTLP
 27125                                  
 27126                                  	; 16/12/2022
 27127                                  	; 20/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27128                                  DWRITE_LUP:
 27129                                  	; 23/07/2019 - Retro DOS v3.2
 27130                                  
 27131                                  	; MSDOS 6.0
 27132 00004540 E829FB                  	call	DSKWRITE
 27133 00004543 7417                    	jz	short DWRITE_OKAY ; ds<>ss
 27134                                  
 27135                                  ;;	int	3
 27136                                  
 27137 00004545 3C27                    	cmp	al,error_handle_Disk_Full	; compressed volume full?
 27138 00004547 742D                    	jz	short DWRITE_DISK_FULL
 27139                                  
 27140                                  	; 16/12/2022
 27141                                  
 27142                                  ;;hkn; SS override
 27143 00004549 36C606[7505]01          	MOV	BYTE [SS:READOP],1
 27144 0000454F E849FB                  	call	HARDERRRW
 27145 00004552 3C01                    	CMP	AL,1		; Check for retry
 27146 00004554 74EA                    	JZ	short DWRITE_LUP
 27147                                  
 27148                                  	; 16/12/2022
 27149                                  	; 23/07/2019
 27150                                  	;POP	CX ; *4*
 27151                                  	;POP	BX ; *5*
 27152                                  	;
 27153                                  	;push	ss
 27154                                  	;pop	ds
 27155                                  	;
 27156                                  
 27157                                  	; 20/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27158                                  
 27159                                  	; 16/12/2022
 27160 00004556 3C03                    	CMP	AL,3		; Check for FAIL
 27161 00004558 F8                      	CLC
 27162 00004559 7501                    	JNZ	short DWRITE_OKAY ; Ignore
 27163 0000455B F9                      	STC
 27164                                  
 27165                                  DWRITE_OKAY:
 27166                                  	; 16/12/2022
 27167                                  	; 23/07/2019
 27168                                  	; MSDOS 3.3 (& MSDOS 6.0)
 27169 0000455C 59                      	POP	CX ; *4*
 27170 0000455D 5B                      	POP	BX ; *5*
 27171                                  
 27172                                  ;       CX = # sectors remaining.
 27173                                  ;       BX = Next physical cluster.
 27174                                  
 27175                                  ;hkn; SS override
 27176                                          ;Context DS
 27177                                  	; 16/12/2022
 27178                                  	;push	ss
 27179                                  	;pop	ds
 27180                                  
 27181                                  	; 09/02/2024 - Retro DOS v5.0
 27182                                  	; 16/12/2022
 27183                                  	;jc	short SET_ACC_ERRW
 27184                                  
 27185                                  	; 16/12/2022
 27186 0000455E 16                      	push	ss
 27187 0000455F 1F                      	pop	ds
 27188                                  
 27189                                  	;;;
 27190                                  	; 09/02/2024 - Retro DOS v5.0
 27191                                  	; (PCDOS 7.1 IBMDOS.COM)
 27192 00004560 8F06[E80A]              	pop	word [CLUSTNUM_HW] ; CLUSTNUM_HW:BX = Next physical cluster
 27193 00004564 725D                    	jc	short SET_ACC_ERRW ; ds=ss
 27194                                  	;;;
 27195                                  
 27196 00004566 E31E                    	JCXZ    WRTLAST
 27197                                  
 27198                                  	; 10/02/2024
 27199 00004568 B200                    	MOV	DL,0
 27200                                  	;xor	dl,dl ; 23/07/2019
 27201 0000456A FF06[BA05]              	INC     word [LASTPOS]	; We'll be using next cluster
 27202                                  	;;;
 27203                                  	; 09/02/2024 - Retro DOS v5.0
 27204                                  	; (PCDOS 7.1 IBMDOS.COM)
 27205 0000456E 75B7                    	jnz	short WRTLP
 27206 00004570 FF06[E20A]              	inc	word [LASTPOS_HW]
 27207                                  	;;;
 27208 00004574 EBB1                    	JMP     short WRTLP
 27209                                  
 27210                                  	; 23/07/2019 - Retro DOS v3.2
 27211                                  	; 09/08/2018
 27212                                  	; MSDOS 6.0
 27213                                  DWRITE_DISK_FULL:
 27214                                  	;Context DS		;SQ 3-5-93 DS must be setup on return!
 27215                                  	; 16/12/2022
 27216 00004576 16                      	push	ss
 27217 00004577 1F                      	pop	ds
 27218 00004578 59                      	pop	cx		; unjunk stack
 27219 00004579 5B                      	pop	bx
 27220                                  	;;;
 27221                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27222 0000457A 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 27223                                  	;;;
 27224 0000457E C606[0B06]01            	mov	byte [DISK_FULL],1
 27225                                  	;stc
 27226 00004583 E9D2FE                  	jmp	WRTERR ; 24/07/2019 ; go to disk full exit
 27227                                  
 27228                                  WRTLAST:
 27229 00004586 A1[D405]                	MOV     AX,[BYTCNT2]
 27230 00004589 09C0                    	OR      AX,AX
 27231 0000458B 7413                    	JZ	short FINWRT
 27232 0000458D A3[D205]                	MOV     [BYTCNT1],AX
 27233 00004590 E85113                  	call	NEXTSEC
 27234 00004593 722E                    	JC	short SET_ACC_ERRW
 27235 00004595 C706[CC05]0000          	MOV     word [BYTSECPOS],0
 27236 0000459B E8EB12                  	call	BUFWRT
 27237 0000459E 7223                    	JC	short SET_ACC_ERRW
 27238                                  
 27239                                  FINWRT:
 27240 000045A0 C43E[9E05]              	LES     DI,[THISSFT]
 27241 000045A4 A1[DE05]                	MOV     AX,[GROWCNT]
 27242 000045A7 8B0E[E005]              	MOV     CX,[GROWCNT+2]
 27243 000045AB 09C0                    	OR      AX,AX
 27244 000045AD 7502                    	JNZ	short UPDATE_size
 27245 000045AF E30F                    	JCXZ    SAMSIZ
 27246                                  UPDATE_size:
 27247                                  	;add	[es:di+11h],ax
 27248 000045B1 26014511                	ADD     [ES:DI+SF_ENTRY.sf_size],AX
 27249                                  	;adc	[es:di+13h],cx
 27250 000045B5 26114D13                	ADC     [ES:DI+SF_ENTRY.sf_size+2],CX
 27251                                  
 27252                                  ; Make sure that all other SFT's see this growth also.
 27253                                  
 27254 000045B9 B80100                  	MOV     AX,1
 27255                                  ;if installed
 27256                                  	;Call	JShare + 14 * 4
 27257 000045BC FF1E[C800]              	call    far [JShare+(14*4)]	; 14 = ShSU
 27258                                  ;else
 27259                                  ;	Call    ShSU
 27260                                  ;endif
 27261                                  
 27262                                  SAMSIZ:
 27263 000045C0 E9DFFC                  	jmp	SETCLUS	; ES:DI already points to SFT
 27264                                  
 27265                                  	; 16/12/2022
 27266                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27267                                  SET_ACC_ERRW:
 27268                                  	;jmp	SET_ACC_ERR_DS ; ds<>ss ; 10/02/2024
 27269                                  	; 10/02/2024
 27270                                  	; ds=ss
 27271 000045C3 E92BFC                  	jmp	SET_ACC_ERR
 27272                                  
 27273                                  WRTEOF:
 27274 000045C6 89C1                    	MOV     CX,AX
 27275 000045C8 09D1                    	OR      CX,DX
 27276                                  	;JZ	short KILLFIL
 27277                                  	; 10/02/2024
 27278 000045CA 7503                    	jnz	short WRTEOF1
 27279 000045CC E9AA00                  	jmp	KILLFIL
 27280                                  
 27281                                  	;;;
 27282                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27283                                  WRTEOF1:
 27284 000045CF 81FAFF7F                	cmp	dx,7FFFh       ; 2GB file size limit
 27285 000045D3 7503                    	jne	short WRTEOF2
 27286 000045D5 83F8FF                  	cmp	ax,0FFFFh
 27287                                  WRTEOF2:
 27288 000045D8 760E                    	jna	short WRTEOF3
 27289                                  	;
 27290 000045DA 06                      	push	es
 27291 000045DB 3EC43E[9E05]            	les	di, ds:THISSFT
 27292                                  	;test	byte [es:di+3],10h
 27293 000045E0 26F6450310              	test	byte [es:di+SF_ENTRY.sf_mode+1],10h
 27294 000045E5 07                      	pop	es
 27295 000045E6 74DB                    	jz	short SET_ACC_ERRW ; > 2GB file size not allowed
 27296                                  WRTEOF3:
 27297                                  	;;;
 27298                                  
 27299 000045E8 83E801                  	SUB     AX,1
 27300 000045EB 83DA00                  	SBB     DX,0
 27301                                  
 27302                                  	; MSDOS 3.3
 27303                                  	;;div	word [es:bp+2]
 27304                                  	;div	word [ES:BP+DPB.SECTOR_SIZE]
 27305                                  	;;mov	cl,[es:bp+5]
 27306                                  	;mov	cl,[ES:BP+DPB.CLUSTER_SHIFT]
 27307                                  	;shr	ax,cl
 27308                                  
 27309                                  	; MSDOS 6.0
 27310 000045EE 53                      	PUSH	BX
 27311                                  	;mov	bx,[es:bp+2]
 27312 000045EF 268B5E02                	MOV	BX,[ES:BP+DPB.SECTOR_SIZE]    ;F.C. >32mb                       ;AN000;
 27313 000045F3 E82101                  	CALL	DIV32                         ;F.C. >32mb                       ;AN000;
 27314 000045F6 5B                      	POP	BX			      ;F.C. >32mb			;AN000;
 27315 000045F7 89CA                    	MOV	DX,CX			      ;M039
 27316 000045F9 890E[0706]                      MOV	[HIGH_SECTOR],CX              ;M039: Probably extraneous, but not sure.
 27317 000045FD E83E01                  	CALL	SHR32                         ;F.C. >32mb                       ;AN000;
 27318                                  
 27319 00004600 89C1                    	MOV     CX,AX
 27320 00004602 E85D11                  	call	FNDCLUS
 27321                                  SET_ACC_ERRWJ2:
 27322 00004605 72BC                    	JC	short SET_ACC_ERRW
 27323                                  	;;;
 27324                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27325 00004607 A1[F80A]                	mov	ax,[CLSKIP_HW]
 27326 0000460A 39C8                    	cmp	ax,cx
 27327 0000460C 7502                    	jne	short dskwrt_6
 27328                                  	;;;
 27329                                  	
 27330 0000460E E327                    	JCXZ    RELFILE
 27331                                  	
 27332                                  	;;;
 27333                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27334                                  dskwrt_6:
 27335 00004610 A3[F00A]                	mov	[CCOUNT_HW],ax
 27336                                  	;;;
 27337                                  
 27338 00004613 E8E413                  	call	ALLOCATE
 27339                                  	;JC	short WRTERRJ              ;;;;;;;;; disk full
 27340                                  	; 16/12/2022
 27341 00004616 7303                    	jnc	short UPDATE
 27342 00004618 E93DFE                  	JMP	WRTERR
 27343                                  UPDATE:
 27344 0000461B C43E[9E05]              	LES	DI,[THISSFT]
 27345 0000461F A1[CE05]                	MOV	AX,[BYTPOS]
 27346                                  	;mov	[es:di+11h],ax
 27347 00004622 26894511                	MOV	[ES:DI+SF_ENTRY.sf_size],AX
 27348 00004626 A1[D005]                	MOV	AX,[BYTPOS+2]
 27349                                  	;mov	[es:di+13h],ax
 27350 00004629 26894513                	MOV	[ES:DI+SF_ENTRY.sf_size+2],AX
 27351                                  ;
 27352                                  ; Make sure that all other SFT's see this growth also.
 27353                                  ;
 27354 0000462D B80200                  	MOV     AX,2
 27355                                  ;if installed
 27356                                  	;Call	JShare + 14 * 4
 27357 00004630 FF1E[C800]              	call    far [JShare+(14*4)]	; 14 = ShSU
 27358                                  ;else
 27359                                  ;	Call    ShSU
 27360                                  ;endif
 27361 00004634 31C9                    	XOR     CX,CX ; 0
 27362                                  	;jmp	ADDREC
 27363                                  	; 08/02/2024
 27364 00004636 C3                      	retn
 27365                                  
 27366                                  	; 16/12/2022
 27367                                  ;WRTERRJ: 
 27368                                  	;JMP	WRTERR
 27369                                  
 27370                                  ;;;;;;;;;;;;;;;; 7/18/86
 27371                                  ;;;;;;;;;;;;;;;;
 27372                                  
 27373                                  RELFILE:
 27374                                  	; MSDOS 6.0
 27375 00004637 06                      	PUSH	ES			;AN002; BL Reset Lstclus and cluspos to
 27376 00004638 C43E[9E05]              	LES	DI,[THISSFT]		;AN002; BL beginning of file if current
 27377                                  	;;;
 27378                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27379 0000463C 50                      	push	ax			; cluspos is past EOF.
 27380 0000463D A1[E20A]                	mov	ax,[LASTPOS_HW]
 27381 00004640 263B450B                	cmp	ax,[es:di+0Bh]		; [ES:DI+SF_ENTRY.sf_firclus]
 27382                                  	;cmp	ax,[es:di+SF_ENTRY.sf_cluspos_hw]
 27383 00004644 58                      	pop	ax
 27384 00004645 7504                    	jne	short dskwrt_7
 27385                                  	;;;
 27386                                  	;cmp	dx,[es:di+19h]
 27387 00004647 263B5519                	CMP	DX,[ES:DI+SF_ENTRY.sf_cluspos]	;AN002; BL cluspos is past EOF.
 27388                                  dskwrt_7:	; 10/02/2024
 27389 0000464B 731C                    	JAE	short SKIPRESET			;AN002; BL
 27390                                  	;;;
 27391                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27392 0000464D 268B552B                	mov     dx,[es:di+2Bh]		; [ES:DI+SF_ENTRY.sf_chain]
 27393                                  	;mov	dx,[es:di+SF_ENTRY_sf_fcluster]	; first cluster (32 bit) lw !?
 27394                                  	;;;
 27395                                  	;mov	[es:di+19h],0
 27396 00004651 26C745190000            	MOV	word [ES:DI+SF_ENTRY.sf_cluspos],0 ;AN002; BL
 27397                                  ; 10/02/2024
 27398                                  %if 0
 27399                                  	;mov	dx,[es:di+0Bh]
 27400                                  	MOV	DX,[ES:DI+SF_ENTRY.sf_firclus]	;AN002; BL
 27401                                  %else
 27402                                  	;;;
 27403                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27404 00004657 26C7450B0000            	mov     word [es:di+0Bh],0
 27405                                  	;mov	word [es:di+SF_ENTRY.sf_cluspos_hw],0
 27406                                  	;;;
 27407                                  %endif
 27408                                  	;mov	[es:di+35h],dx
 27409 0000465D 26895535                	MOV	[ES:DI+SF_ENTRY.sf_lstclus],DX	;AN002; BL
 27410                                  	;;;
 27411                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27412 00004661 268B552D                	mov	dx,[es:di+2Dh]		; [ES:DI+SF_ENTRY.sf_chain]
 27413                                  	;mov	di,[es:di+SF_ENTRY_sf_fcluster+2] ; first clust (32 bit) hw !?
 27414 00004665 26895537                	mov	[es:di+37h],dx	
 27415                                  	;mov	[es:di+SF_ENTRY.sf_lstclus+2],dx
 27416                                  	;;;
 27417                                  
 27418                                  SKIPRESET:                            		;AN002; BL
 27419 00004669 07                      	POP     ES                    		;AN002; BL
 27420                                  ;
 27421                                  ; 10/02/2024
 27422                                  %if 0
 27423                                  	MOV     DX,0FFFFH
 27424                                  %else
 27425                                  	;;;
 27426                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27427 0000466A 31D2                    	xor	dx,dx
 27428 0000466C 4A                      	dec	dx
 27429 0000466D 8916[EA0A]              	mov	[CLUSDATA_HW],dx ; 0FFFFh
 27430                                  	;;;
 27431                                  %endif
 27432 00004671 E88F15                  	call	RELBLKS
 27433                                  	; 16/12/2022
 27434                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27435                                  dskwrt_8:	; 10/02/2024
 27436 00004674 73A5                    	jnc	short UPDATE
 27437                                  SET_ACC_ERRWJ:
 27438                                  	;JC	short SET_ACC_ERRWJ2
 27439                                  	;JMP	SHORT UPDATE
 27440                                  	; 16/12/2022
 27441                                  	;jmp	SET_ACC_ERR_DS ; ds<>ss
 27442                                  	; 10/02/2024
 27443                                  	; ds=ss
 27444 00004676 E978FB                  	jmp	SET_ACC_ERR
 27445                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27446                                  	;JC	short SET_ACC_ERRWJ2
 27447                                  	;JMP	SHORT UPDATE
 27448                                  
 27449                                  KILLFIL:
 27450 00004679 31DB                    	XOR     BX,BX
 27451 0000467B 06                      	PUSH    ES
 27452 0000467C C43E[9E05]              	LES     DI,[THISSFT]
 27453                                  
 27454                                  ; 10/02/2024
 27455                                  %if 0
 27456                                  	;mov	[es:di+19h],bx
 27457                                  	MOV	[ES:DI+SF_ENTRY.sf_cluspos],BX
 27458                                  	;mov	[es:di+35h],bx ; 04/05/2019
 27459                                  	MOV	[ES:DI+SF_ENTRY.sf_lstclus],BX
 27460                                  	;xchg	bx,[es:di+0Bh]
 27461                                  	XCHG    BX,[ES:DI+SF_ENTRY.sf_firclus]
 27462                                  %else
 27463                                  	;;;
 27464                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27465 00004680 26875D2D                	xchg	bx,[es:di+2Dh]	; [ES:DI+SF_ENTRY.sf_chain+2]
 27466                                  	;xchg	bx,[es:di+SF_ENTRY.sf_fcluster+2] ; first clust (32 bit) hw !?
 27467 00004684 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 27468 00004688 31DB                    	xor	bx,bx	; 0
 27469 0000468A 26895D0B                	mov	[es:di+0Bh],bx	; [ES:DI+SF_ENTRY.sf_firclus]
 27470                                  	;mov	[es:di+SF_ENTRY.sf_cluspos_hw],bx
 27471 0000468E 26895D37                	mov	[es:di+37h],bx
 27472                                  	;mov	[es:di+SF_ENTRY.sf_lstclus+2],bx
 27473                                  	;mov	[es:di+19h],bx
 27474 00004692 26895D19                	mov	[es:di+SF_ENTRY.sf_cluspos],bx
 27475                                  	;mov	[es:di+35h],bx
 27476 00004696 26895D35                	mov	[es:di+SF_ENTRY.sf_lstclus],bx
 27477 0000469A 26875D2B                	xchg	bx,[es:di+2Bh]	; [ES:DI+SF_ENTRY.sf_chain]
 27478                                  	;xchg	bx,[es:di+SF_ENTRY.sf_fcluster]	; first cluster (32 bit) lw !?
 27479                                  	;;;
 27480                                  %endif
 27481                                  
 27482 0000469E 07                      	POP	ES
 27483                                  
 27484                                  	;;;
 27485                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27486 0000469F 3B1E[E80A]              	cmp	bx,[CLUSTNUM_HW]
 27487 000046A3 7507                    	jnz	short dskwrt_9
 27488                                  	;;;
 27489                                  
 27490 000046A5 09DB                    	OR	BX,BX
 27491                                  	;JZ	short UPDATEJ
 27492                                  	; 16/12/2022
 27493                                  	;jz	short UPDATE
 27494                                  	; 10/12/2024
 27495 000046A7 7503                    	jnz	short dskwrt_9
 27496 000046A9 E96FFF                  	jmp	UPDATE
 27497                                  
 27498                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27499                                  	;jz	short UPDATEJ
 27500                                  
 27501                                  dskwrt_9:	; 10/02/2024
 27502                                  ;; 10/23/86 FastOpen update
 27503 000046AC 06                      	PUSH	ES			; since first cluster # is 0
 27504 000046AD 55                      	PUSH	BP			; we must delete the old cache entry
 27505 000046AE 50                      	PUSH	AX
 27506 000046AF 51                      	PUSH	CX
 27507 000046B0 52                      	PUSH	DX
 27508 000046B1 C42E[8A05]              	LES	BP,[THISDPB]		; get current DPB
 27509                                  	; 15/12/2022
 27510 000046B5 268A5600                	mov	dl,[ES:BP] ; mov dl,[es:bp+0]
 27511                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27512                                  	;MOV	DL,[ES:BP+DPB.DRIVE]	; get current drive
 27513 000046B9 89D9                    	MOV	CX,BX			; first cluster #
 27514 000046BB B402                    	MOV	AH,2			; delete cache entry by drive:firclus
 27515 000046BD E8A8E6                  	call	FastOpen_Update		; call fastopen
 27516 000046C0 5A                      	POP	DX
 27517 000046C1 59                      	POP	CX
 27518 000046C2 58                      	POP	AX
 27519 000046C3 5D                      	POP	BP
 27520 000046C4 07                      	POP	ES
 27521                                  ;; 10/23/86 FastOpen update
 27522                                  
 27523 000046C5 E83515                  	call	RELEASE
 27524                                  	;JC	short SET_ACC_ERRWJ
 27525                                  ;UPDATEJ:
 27526                                  	; 20/11/2022
 27527                                  	;JMP	short UPDATE ; 10/08/2018
 27528                                  	; 10/02/2024
 27529 000046C8 EBAA                    	jmp	short dskwrt_8
 27530                                  
 27531                                  
 27532                                  ;Break   <DskWrtBufPurge -- Disk Write Buffer Purge>
 27533                                  ;----------------------------------------------------------------------------
 27534                                  ;
 27535                                  ; Procedure Name : DskWrtBufPurge
 27536                                  ;
 27537                                  ; Inputs:
 27538                                  ;       CX = # of contiguous sectors to write. (These constitute a block of
 27539                                  ;	     sectors, also termed an "Extent".)
 27540                                  ;       [HIGH_SECTOR]:DX = physical sector # of first sector in extent.
 27541                                  ;       ES:BP -> Drive Parameter Block (DPB).
 27542                                  ;
 27543                                  ; Function:
 27544                                  ;       Purge the Buffer Queue and the Secondary Cache of any buffers which
 27545                                  ;	are in Extent; they are being over-written.
 27546                                  ;
 27547                                  ; Outputs:
 27548                                  ;       (Same as Input.)
 27549                                  ; Uses:
 27550                                  ;       All registers except DS,AX,SI,DI preserved.
 27551                                  ;       SS override for all global variables.
 27552                                  ;----------------------------------------------------------------------------
 27553                                  ;M039: Created
 27554                                  
 27555                                  ;procedure   DskWrtBufPurge,NEAR
 27556                                  ;
 27557                                  ;ASSUME  DS:NOTHING
 27558                                  
 27559                                  ; 04/05/2019 - Retro DOS v4.0
 27560                                  ; DOSCODE:7C0Eh (MSDOS 6.21, MSDOS.SYS)
 27561                                  
 27562                                  ; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27563                                  ; DOSCODE:7BD4h (MSDOS 5.0, MSDOS.SYS)
 27564                                  
 27565                                  ; 10/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 27566                                  ; DOSCODE:8714h (PCDOS 7.1, IBMDOS.COM)
 27567                                  
 27568                                  ; NOTE: Secondary (Buffer) Cache is not used in PCDOS 7.1 IBMDOS.COM
 27569                                  
 27570                                  ; (Win ME IO.SYS - BIOSCODE:BB93h)
 27571                                  ; (MSDOS 6.22 IO.SYS - DOSCODE:7C0Eh)
 27572                                  
 27573                                  DskWrtBufPurge:
 27574                                  	;SaveReg <bx,cx>
 27575 000046CA 53                      	push	bx
 27576 000046CB 51                      	push	cx
 27577                                  
 27578 000046CC 368B1E[0706]            	mov	bx,[ss:HIGH_SECTOR]	;BX:DX = Extent start (sector #).
 27579 000046D1 89DE                    	mov	si,bx
 27580 000046D3 01D1                    	add	cx,dx
 27581 000046D5 83D600                  	adc	si,0                    ;SI:CX = Extent end + 1.
 27582                                  
 27583                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27584                                  	;;mov	al,[es:bp+0]
 27585                                  	;mov	al,[es:bp+DPB.DRIVE]
 27586                                  	; 15/12/2022
 27587 000046D8 268A4600                	mov	al,[es:bp]
 27588                                  
 27589                                  ; 10/02/2024 - Retro DOS v5.0
 27590                                  ; PCDOS 7.1 IBMDOS.COM
 27591                                  %if 0
 27592                                  
 27593                                  ;	BX:DX = Extent start.
 27594                                  ;	SI:CX = Extent end + 1.
 27595                                  ;	AL = Drive #
 27596                                  
 27597                                  	cmp	word [ss:SC_CACHE_COUNT],0 ;Secondary cache in-use?
 27598                                  	je	short nosc		; -no, jump.
 27599                                  
 27600                                  ;	If any of the sectors to be written are in the secondary cache (SC),
 27601                                  ;	invalidate the entire SC. (This is an optimization; we really only
 27602                                  ;	need to invalidate those sectors which intersect, but that's slower.)
 27603                                  
 27604                                  	cmp	al,[ss:CurSC_DRIVE]	;Same drive?
 27605                                  	jne	short nosc		; -no, jump.
 27606                                  
 27607                                  	push    ax
 27608                                  	mov     ax,[ss:CurSC_SECTOR]
 27609                                  	mov     di,[ss:CurSC_SECTOR+2]	;DI:AX = SC start.
 27610                                  
 27611                                  	;Cmp32	si,cx,di,ax		;Extent end < SC start?
 27612                                  	;jbe	short sc5		; -yes, jump.
 27613                                  
 27614                                  	cmp	si,di
 27615                                  	jne	short sc01
 27616                                  	cmp	cx,ax
 27617                                  sc01: 
 27618                                  	jbe	short sc5
 27619                                  
 27620                                  	add	ax,[ss:SC_CACHE_COUNT]
 27621                                  	adc	di,0                    ;DI:AX = SC end + 1.
 27622                                  	
 27623                                  	;Cmp32	bx,dx,di,ax             ;Extent start > SC end?
 27624                                  	;jae	short sc5		; -yes, jump.
 27625                                  
 27626                                  	cmp	bx,di
 27627                                  	jne	short sc02
 27628                                  	cmp	dx,ax
 27629                                  sc02:
 27630                                  	jnb	short sc5
 27631                                  
 27632                                  	mov	word [ss:SC_STATUS],0	;Extent intersects SC: invalidate SC.
 27633                                  sc5:	
 27634                                  	pop     ax
 27635                                  
 27636                                  %endif
 27637                                  
 27638                                  ;	Free any buffered sectors which are in Extent; they are being over-
 27639                                  ;	written.
 27640                                  
 27641                                  nosc:	
 27642 000046DC E80A22                  	call	GETCURHEAD		;DS:DI -> first buffer in queue.
 27643                                  
 27644                                  _bufq:	
 27645                                  	;cmpo	al,[di+4]
 27646 000046DF 3A4504                  	cmp     al,[di+BUFFINFO.buf_ID] ;Same drive?
 27647 000046E2 7527                    	jne	short bufq5		; -no, jump.
 27648                                  
 27649                                  ;       Cmp32   bx,dx,<WORD PTR [di.buf_sector+2]>,<WORD PTR [di.buf_sector]>
 27650                                  ;       ja	short bufq5		;Jump if Extent start > buffer sector.
 27651                                  
 27652                                  	;cmp	bx,[di+8]
 27653 000046E4 3B5D08                  	cmp	bx,[di+BUFFINFO.buf_sector+2]
 27654 000046E7 7503                    	jne	short bufq04
 27655                                  	;cmp	dx,[di+6]
 27656 000046E9 3B5506                  	cmp	dx,[di+BUFFINFO.buf_sector]
 27657                                  bufq04:
 27658 000046EC 771D                    	ja	short bufq5
 27659                                  
 27660                                  ;       Cmp32   si,cx,<WORD PTR [di.buf_sector+2]>,<WORD PTR [di.buf_sector]>
 27661                                  ;       jbe	short bufq5		;Jump if Extent end < buffer sector.
 27662                                  
 27663                                  	;cmp	si,[di+8]
 27664 000046EE 3B7508                  	cmp	si,[di+BUFFINFO.buf_sector+2]
 27665 000046F1 7503                    	jne	short bufq05
 27666                                  	;cmp	cx,[di+6]
 27667 000046F3 3B4D06                  	cmp	cx,[di+BUFFINFO.buf_sector]
 27668                                  bufq05:
 27669 000046F6 7613                    	jbe	short bufq5
 27670                                  
 27671                                  ;	Buffer's sector is in Extent, so free it; it is being over-written.
 27672                                  
 27673                                  	;test	byte [di+5],40h
 27674 000046F8 F6450540                	test	byte [di+BUFFINFO.buf_flags],buf_dirty ;Buffer dirty?
 27675 000046FC 7403                    	jz	short bufq4		; -no, jump.
 27676 000046FE E8FC24                  	call	DEC_DIRTY_COUNT		; -yes, decrement dirty count.
 27677                                  bufq4:
 27678                                  	;mov	word [di+4],20FFh
 27679 00004701 C74504FF20              	mov     word [di+BUFFINFO.buf_ID],((buf_visit<<8)|0FFh)
 27680                                  
 27681 00004706 E8F221                  	call	SCANPLACE
 27682 00004709 EB02                    	jmp     short bufq6
 27683                                  bufq5: 
 27684 0000470B 8B3D                    	mov     di,[di]
 27685                                  	;mov	di,[di+BUFFINFO.buf_next]
 27686                                  bufq6: 
 27687 0000470D 363B3E[7E11]            	cmp	di,[ss:FIRST_BUFF_ADDR]	;Scanned entire buffer queue?
 27688 00004712 75CB                    	jne	short _bufq		; --no, go do next buffer.
 27689                                  	
 27690                                  	;RestoreReg <cx,bx>
 27691 00004714 59                      	pop	cx
 27692 00004715 5B                      	pop	bx
 27693 00004716 C3                      	retn
 27694                                  
 27695                                  ;EndProc DskWrtBufPurge
 27696                                  
 27697                                  ;Break   <DIV32 -- PERFORM 32 BIT DIVIDE>
 27698                                  ;----------------------------------------------------------------------------
 27699                                  ;
 27700                                  ; Procedure Name : DIV32
 27701                                  ;
 27702                                  ; Inputs:
 27703                                  ;       DX:AX = 32 bit dividend   BX= divisor
 27704                                  ; Function:
 27705                                  ;       Perform 32 bit division:  DX:AX/BX = CX:AX + DX (rem.)
 27706                                  ; Outputs:
 27707                                  ;       CX:AX = quotient , DX= remainder
 27708                                  ; Uses:
 27709                                  ;       All registers except AX,CX,DX preserved.
 27710                                  ;----------------------------------------------------------------------------
 27711                                  ;M039: DIV32 optimized for divisor of 512 (common sector size).
 27712                                  
 27713                                  ; 04/05/2019 - Retro DOS v4.0
 27714                                  ; DOSCODE:7C94h (MSDOS 6.21, MSDOS.SYS)
 27715                                  
 27716                                  ; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27717                                  ; DOSCODE:7C5Ah (MSDOS 5.0, MSDOS.SYS) 
 27718                                  
 27719                                  DIV32:
 27720 00004717 81FB0002                	cmp	bx,512
 27721 0000471B 7515                    	jne	short div5
 27722                                  
 27723 0000471D 89D1                    	mov	cx,dx
 27724 0000471F 89C2                    	mov	dx,ax           ; CX:AX = Dividend
 27725 00004721 81E2FF01                	and	dx,(512-1)      ; DX = Remainder
 27726 00004725 88E0                    	mov	al,ah
 27727 00004727 88CC                    	mov	ah,cl
 27728 00004729 88E9                    	mov	cl,ch
 27729 0000472B 30ED                    	xor	ch,ch
 27730 0000472D D1E9                    	shr	cx,1
 27731 0000472F D1D8                    	rcr	ax,1
 27732 00004731 C3                      	retn
 27733                                  div5:	
 27734 00004732 89C1                    	mov	cx,ax
 27735 00004734 89D0                    	mov	ax,dx
 27736 00004736 31D2                    	xor	dx,dx
 27737 00004738 F7F3                    	div	bx              ; 0:AX/BX
 27738 0000473A 91                      	xchg	cx,ax
 27739 0000473B F7F3                    	div	bx              ; DX:AX/BX
 27740 0000473D C3                      	retn
 27741                                  
 27742                                  ;Break   <SHR32 -- PERFORM 32 BIT SHIFT RIGHT>
 27743                                  ;----------------------------------------------------------------------------
 27744                                  ;
 27745                                  ; Procedure Name : SHR32
 27746                                  ;
 27747                                  ; Inputs:
 27748                                  ;	DX:AX = 32 bit sector number
 27749                                  ; Function:
 27750                                  ;       Perform 32 bit shift right
 27751                                  ; Outputs:
 27752                                  ;	AX = cluster number
 27753                                  ;	ZF = 1 if no error
 27754                                  ;	   = 0 if error (cluster number > 64k)
 27755                                  ; Uses:
 27756                                  ;       DX,CX
 27757                                  ;---------------------------------------------------------------------------
 27758                                  ; M017	- SHR32 rewritten for better performance
 27759                                  ; M039	- Additional optimization
 27760                                  
 27761                                  ; 04/05/2019 - Retro DOS v4.0
 27762                                  ; DOSCODE:7CBBh (MSDOS 6.21, MSDOS.SYS)
 27763                                  ; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27764                                  ; DOSCODE:7C81h (MSDOS 5.0, MSDOS.SYS) 
 27765                                  
 27766                                  SHR32:
 27767                                  	;mov	cl,[es:bp+5]
 27768 0000473E 268A4E05                	mov	cl,[ES:BP+DPB.CLUSTER_SHIFT]
 27769 00004742 30ED                    	xor	ch,ch	    ;ZF=1
 27770 00004744 E306                    	jcxz	norota
 27771                                  
 27772                                  rotashft2:
 27773 00004746 D1EA                    	shr	dx,1	    ;ZF reflects state of DX.
 27774 00004748 D1D8                    	rcr	ax,1	    ;ZF not affected.
 27775 0000474A E2FA                    	loop	rotashft2
 27776                                  norota:
 27777 0000474C C3                      	retn
 27778                                  
 27779                                  ;============================================================================
 27780                                  ; DIR.ASM, MSDOS 6.0, 1991
 27781                                  ;============================================================================
 27782                                  ; 27/07/2018 - Retro DOS v3.0
 27783                                  ; 19/05/2019 - Retro DOS v4.0
 27784                                  
 27785                                  ;	TITLE	DIR - Directory and path cracking
 27786                                  ;	NAME	Dir
 27787                                  
 27788                                  ;Break	<FINDENTRY -- LOOK FOR AN ENTRY>
 27789                                  ;---------------------------------------------------------------------------
 27790                                  ;
 27791                                  ; Procedure Name : FINDENTRY,SEARCH
 27792                                  ;
 27793                                  ; Inputs:
 27794                                  ;	[THISDPB] set
 27795                                  ;	[SECCLUSPOS] = 0
 27796                                  ;	[DIRSEC] = Starting directory sector number
 27797                                  ;	[CLUSNUM] = Next cluster of directory
 27798                                  ;	[CLUSFAC] = Sectors/Cluster
 27799                                  ;	[NAME1] = Name to look for
 27800                                  ; Function:
 27801                                  ;	Find file name in disk directory.
 27802                                  ;	"?" matches any character.
 27803                                  ; Outputs:
 27804                                  ;	Carry set if name not found
 27805                                  ;	ELSE
 27806                                  ;	Zero set if attributes match (always except when creating)
 27807                                  ;	AH = Device ID (bit 7 set if not disk)
 27808                                  ;	[THISDPB] = Base of drive parameters
 27809                                  ;	DS = DOSGROUP
 27810                                  ;	ES = DOSGROUP
 27811                                  ;	[CURBUF+2]:BX = Pointer into directory buffer
 27812                                  ;	[CURBUF+2]:SI = Pointer to First Cluster field in directory entry
 27813                                  ;	[CURBUF] has directory record with match
 27814                                  ;	[NAME1] has file name
 27815                                  ;	[LASTENT] is entry number of the entry
 27816                                  ; All other registers destroyed.
 27817                                  ;----------------------------------------------------------------------------
 27818                                  
 27819                                  ;hkn; called from rename.asm and dir2.asm. DS must be already set up at
 27820                                  ;hkn; this point.
 27821                                  
 27822                                  SEARCH:
 27823                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27824                                  	; DOSCODE:7C90h (MSDOS 5.0, MSDOS.SYS)
 27825                                  
 27826                                  	; 19/05/2019 - Retro DOS v4.0
 27827                                  	; DOSCODE:7CCAh (MSDOS 6.21, MSDOS.SYS)
 27828                                  
 27829                                  	; 27/07/2018 - Retro DOS v3.0
 27830                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 45B3h
 27831                                  	; 15/03/2018 - Retro DOS v2.0
 27832                                  
 27833                                  	; 24/01/2024
 27834                                  
 27835                                  	; 13/02/2024 - Retro DOS v5.0
 27836                                  	; DOSCODE:8797h (PCDOS 7.1, IBMDOS.COM)
 27837                                  
 27838                                  	;entry	FindEntry
 27839                                  FINDENTRY:
 27840 0000474D E87E06                  	call	STARTSRCH
 27841 00004750 A0[6B05]                	MOV	AL,[ATTRIB]
 27842                                  	;and	al,9Eh
 27843 00004753 24DE                    	AND	AL,~attr_ignore		; Ignore useless bits
 27844                                  	;cmp	al,8
 27845 00004755 3C08                    	CMP	AL,attr_volume_id	; Looking for vol ID only ?
 27846 00004757 7503                    	JNZ	short NOTVOLSRCH	; No
 27847 00004759 E83B02                  	CALL	SETROOTSRCH		; Yes force search of root
 27848                                  NOTVOLSRCH:
 27849 0000475C E84C01                  	CALL	GETENTRY
 27850                                  	;JNC	short SRCH
 27851                                  	;JMP	SETESRET
 27852                                  	; 24/01/2024
 27853 0000475F 724F                    	jc	short SETESRET
 27854                                  
 27855                                  	;entry	Srch
 27856                                  SRCH:
 27857                                  	;;;
 27858                                  	; 13/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27859 00004761 C706[A50A]0000          	mov     word [LNE_COUNT],0	; reset long name entry count
 27860                                  SRCH2:
 27861                                  	;;;
 27862                                  
 27863 00004767 1E                      	PUSH	DS
 27864 00004768 8E1E[E405]              	MOV	DS,[CURBUF+2]
 27865                                  
 27866                                  ;	(DS:BX) = directory entry address
 27867                                  
 27868 0000476C 8A27                    	mov	ah,[BX]
 27869                                  	;MOV	AH,[BX+dir_entry.dir_name] ; mov ah,[bx+0]
 27870 0000476E 08E4                    	OR	AH,AH			; End of directory?
 27871 00004770 7461                    	JZ	short FREE
 27872                                  
 27873                                  	;;;
 27874                                  	; 13/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27875 00004772 50                      	push	ax
 27876 00004773 8A470B                  	mov	al,[bx+0Bh]		; [BX+dir_entry.dir_attr]
 27877 00004776 E8A503                  	call	check_longname
 27878 00004779 58                      	pop	ax
 27879 0000477A 7447                    	jz	short NEXTENT2
 27880                                  	;;;
 27881                                  
 27882                                  ;hkn; SS override
 27883 0000477C 363A26[7F05]            	CMP	AH,[SS:DELALL]		; Free entry?
 27884 00004781 7450                    	JZ	short FREE
 27885                                  	;test	byte [bx+0Bh],8
 27886 00004783 F6470B08                	TEST	byte [BX+dir_entry.dir_attr],attr_volume_id
 27887                                  					; Volume ID file?
 27888 00004787 7405                    	JZ	short CHKFNAM 		; NO
 27889                                  
 27890                                  ;hkn; SS override
 27891 00004789 36FE06[7B05]            	INC	BYTE [SS:VOLID]
 27892                                  CHKFNAM:
 27893                                  ;	Context ES
 27894 0000478E 8CD6                    	MOV	SI,SS
 27895 00004790 8EC6                    	MOV	ES,SI
 27896 00004792 89DE                    	MOV	SI,BX
 27897                                  
 27898                                  ;hkn; NAME1 is in DOSDATA
 27899 00004794 BF[4B05]                	MOV	DI,NAME1
 27900                                  ;;;;; 7/29/86
 27901                                  
 27902                                  ;hkn; SS override for NAME1
 27903                                  	;CMP	BYTE [SS:NAME1],0E5H	; special char check
 27904                                  	;JNZ	short NO_E5
 27905                                  	;MOV	BYTE [SS:NAME1],05H
 27906                                  	; 22/09/2023
 27907 00004797 26803DE5                	cmp	byte [es:di],0E5h
 27908 0000479B 7504                    	jnz	short NO_E5
 27909 0000479D 26C60505                	mov	byte [es:di],05h
 27910                                  NO_E5:
 27911                                  ;;;;; 7/29/86
 27912 000047A1 E88100                  	CALL	MetaCompare
 27913 000047A4 7449                    	JZ	short FOUND
 27914 000047A6 1F                      	POP	DS
 27915                                  
 27916                                  	;entry	NEXTENT
 27917                                  NEXTENT:
 27918 000047A7 C42E[8A05]              	LES	BP,[THISDPB]
 27919 000047AB E88600                  	CALL	NEXTENTRY
 27920 000047AE 73B1                    	JNC	short SRCH
 27921                                  	;JMP	SHORT SETESRET
 27922                                  	; 24/01/2024
 27923                                  SETESRET:
 27924 000047B0 16                      	PUSH	SS
 27925 000047B1 07                      	POP	ES
 27926                                  
 27927                                  	;;;
 27928                                  	; 13/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27929 000047B2 FF36[DA05]              	push	word [ENTLAST]
 27930 000047B6 8F06[B50A]              	pop	word [ENTLAST_PREV]	; previous ENTLAST
 27931 000047BA 7306                    	jnc	short SETESRETN
 27932 000047BC C706[A50A]0000          	mov	word [LNE_COUNT],0	; reset long name entry count
 27933                                  SETESRETN:
 27934                                  	;;;
 27935                                  
 27936 000047C2 C3                      	retn
 27937                                  
 27938                                  	;;;
 27939                                  	; 13/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27940                                  NEXTENT2:
 27941 000047C3 1F                      	pop	ds
 27942 000047C4 FF06[A50A]              	inc	word [LNE_COUNT]	; Long Name entry count
 27943                                  NEXTENT3:
 27944 000047C8 C42E[8A05]              	les	bp,[THISDPB]
 27945 000047CC E86500                  	call	NEXTENTRY
 27946 000047CF 7396                    	jnc	short SRCH2
 27947 000047D1 EBDD                    	jmp	short SETESRET
 27948                                  	;;;
 27949                                  
 27950                                  FREE:
 27951 000047D3 1F                      	POP	DS
 27952 000047D4 8B0E[4803]              	MOV	CX,[LASTENT]
 27953 000047D8 3B0E[D805]              	CMP	CX,[ENTFREE]
 27954 000047DC 7304                    	JAE	short TSTALL
 27955 000047DE 890E[D805]              	MOV	[ENTFREE],CX
 27956                                  TSTALL:
 27957 000047E2 3A26[7F05]              	CMP	AH,[DELALL]		; At end of directory?
 27958                                  NEXTENTJ:
 27959                                  	;je	short NEXTENT 		; No - continue search
 27960                                  	;;;
 27961                                  	; 13/02/2024
 27962 000047E6 74E0                    	je	short NEXTENT3		; No - continue search
 27963                                  	;;;
 27964 000047E8 890E[DA05]              	MOV	[ENTLAST],CX
 27965 000047EC F9                      	STC
 27966 000047ED EBC1                    	JMP	SHORT SETESRET
 27967                                  
 27968                                  FOUND:
 27969                                  ; We have a file with a matching name. We must now consider the attributes:
 27970                                  ; ATTRIB	Action
 27971                                  ; ------	------
 27972                                  ; Volume_ID	Is Volume_ID in test?
 27973                                  ; Otherwise	If no create then Is ATTRIB+extra superset of test?
 27974                                  ;		If create then Is ATTRIB equal to test?
 27975                                  
 27976 000047EF 8A2C                    	MOV	CH,[SI] 		; Attributes of file
 27977 000047F1 1F                      	POP	DS
 27978 000047F2 8A26[6B05]              	MOV	AH,[ATTRIB]		; Attributes of search
 27979                                  	;and	ah,9Eh
 27980 000047F6 80E4DE                  	AND	AH,~attr_ignore
 27981                                  	;lea	si,[si+15]
 27982 000047F9 8D740F                  	LEA	SI,[SI+dir_entry.dir_first-dir_entry.dir_attr]
 27983                                  					; point to first cluster field
 27984                                  	;test	ch,8
 27985 000047FC F6C508                  	TEST	CH,attr_volume_id	; Volume ID file?
 27986 000047FF 7409                    	JZ	short check_one_volume_id ; Nope check other attributes
 27987                                  	;test	ah,8
 27988 00004801 F6C408                  	TEST	AH,attr_volume_id	; Can we find Volume ID?
 27989                                  	;JZ	short NEXTENTJ		; Nope, (not even $FCB_CREATE)
 27990                                  	; 16/12/2022
 27991 00004804 74A1                    	jz	short NEXTENT ; 19/05/2019
 27992                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27993                                  	;JZ	short NEXTENTJ
 27994 00004806 30E4                    	XOR	AH,AH			; Set zero flag for $FCB_CREATE
 27995 00004808 EB11                    	JMP	SHORT RETFF		; Found Volume ID
 27996                                  check_one_volume_id:
 27997                                  	;CMP	ah,8
 27998 0000480A 80FC08                  	CMP	AH,attr_volume_id	; Looking only for Volume ID?
 27999                                  	;JZ	short NEXTENTJ		; Yes, continue search
 28000                                  	; 16/12/2022
 28001 0000480D 7498                    	je	short NEXTENT ; 19/05/2019
 28002                                  	;JZ	short NEXTENTJ
 28003 0000480F E8D005                  	CALL	MatchAttributes
 28004 00004812 7407                    	JZ	SHORT RETFF
 28005 00004814 F606[7E05]FF            	TEST	BYTE [CREATING],-1	; Pass back mismatch if creating
 28006                                  	; 16/12/2022
 28007                                  	;JZ	short NEXTENTJ		; Otherwise continue searching
 28008 00004819 748C                    	jz	short NEXTENT ; 19/05/2019
 28009                                  RETFF:
 28010 0000481B C42E[8A05]              	LES	BP,[THISDPB]
 28011                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 28012                                  	;MOV	AH,[ES:BP+DPB.DRIVE]  ; mov ah,[es:bp+0]
 28013                                  	; 15/12/2022
 28014 0000481F 268A6600                	MOV	AH,[ES:BP]
 28015                                  ;SETESRET:
 28016                                  	;PUSH	SS
 28017                                  	;POP	ES
 28018                                  	;retn
 28019                                  	; 24/01/2024
 28020 00004823 EB8B                    	jmp	short SETESRET
 28021                                  
 28022                                  ;----------------------------------------------------------------------------
 28023                                  ;
 28024                                  ; Procedure Name : MetaCompare
 28025                                  ;
 28026                                  ; Inputs:
 28027                                  ;	DS:SI -> 11 character FCB style name NO '?'
 28028                                  ;	    Typically this is a directory entry. It MUST be in upper case
 28029                                  ;	ES:DI -> 11 character FCB style name with possible '?'
 28030                                  ;	    Typically this is a FCB or SFT. It MUST be in upper case
 28031                                  ; Function:
 28032                                  ;	Compare FCB style names allowing for ? match to any char
 28033                                  ; Outputs:
 28034                                  ;	Zero if match else NZ
 28035                                  ; Destroys CX,SI,DI all others preserved
 28036                                  ;----------------------------------------------------------------------------
 28037                                  
 28038                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 28039                                  	; DOSCODE:7D3Fh (MSDOS 5.0, MSDOS.SYS) 
 28040                                  
 28041                                  MetaCompare:
 28042 00004825 B90B00                  	MOV	CX,11
 28043                                  WILDCRD:
 28044 00004828 F3A6                    	REPE	CMPSB
 28045 0000482A 7407                    	JZ	short MetaRet 		; most of the time we will fail.
 28046                                  CHECK_META:
 28047 0000482C 26807DFF3F              	CMP	BYTE [ES:DI-1],"?"
 28048 00004831 74F5                    	JZ	short WILDCRD
 28049                                  MetaRet:
 28050 00004833 C3                       	retn				; Zero set, Match
 28051                                  
 28052                                  ;Break	<NEXTENTRY -- STEP THROUGH DIRECTORY>
 28053                                  ;----------------------------------------------------------------------------
 28054                                  ;
 28055                                  ; Procedure Name : NEXTENTRY
 28056                                  ;
 28057                                  ; Inputs:
 28058                                  ;	Same as outputs of GETENTRY, above
 28059                                  ; Function:
 28060                                  ;	Update BX, and [LASTENT] for next directory entry.
 28061                                  ;	Carry set if no more.
 28062                                  ;----------------------------------------------------------------------------
 28063                                  
 28064                                  NEXTENTRY:
 28065                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 28066                                  	; DOSCODE:7D4Eh (MSDOS 5.0, MSDOS.SYS) 
 28067                                  
 28068                                  	; 19/05/2019 - Retro DOS v4.0
 28069                                  	; DOSCODE:7D88h (MSDOS 6.21, MSDOS.SYS)
 28070                                  
 28071                                  	; 27/07/2018 - Retro DOS v3.0
 28072                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 4671h 
 28073                                  	; 15/03/2018 - Retro DOS v2.0
 28074                                  
 28075                                  	; 14/02/2024 - Retro DOS v5.0
 28076                                  	; DOSCODE:8884h (PCDOS 7.1, IBMDOS.COM)
 28077                                  
 28078 00004834 A1[4803]                	MOV	AX,[LASTENT]
 28079 00004837 3B06[DA05]              	CMP	AX,[ENTLAST]
 28080 0000483B 741C                    	JZ	short NONE
 28081 0000483D 40                      	INC	AX
 28082                                  	;ADD	BX,32
 28083 0000483E 8D5F20                  	LEA	BX,[BX+32]
 28084 00004841 39D3                    	CMP	BX,DX
 28085                                  	; 21/11/2022 - MSDOS 5.0 MSDOS.SYS (DOSCODE:7D5Dh)
 28086                                  	;JB	short HAVIT ; MSDOS 6.0 src (dir.asm)
 28087                                  	; 16/12/2022
 28088 00004843 7540                    	jne	short HAVIT ; MSDOS 6.21 (DOSCODE:7D97h)
 28089                                  
 28090                                  	;;;
 28091                                  	; 14/02/2024 (PCDOS 7.1 IBMDOS.COM)
 28092 00004845 833E[C205]00            	cmp	word [DIRSTART],0
 28093 0000484A 750F                    	jnz	short nextentry_cont
 28094 0000484C 833E[DC0A]00            	cmp	word [DIRSTART_HW],0
 28095 00004851 7508                    	jnz	short nextentry_cont
 28096                                  	;cmp	ax,[es:bp+9]
 28097 00004853 263B4609                	cmp	ax,[es:bp+DPB.ROOT_ENTRIES] ; Number of root dir entries
 28098                                  	;jnb	short NONE
 28099                                  	;jmp	short GETENT
 28100 00004857 7255                    	jb	short GETENT
 28101                                  NONE:		; 14/02/2024
 28102 00004859 F9                      	stc
 28103 0000485A C3                      	retn
 28104                                  	
 28105                                  nextentry_cont:
 28106                                  	;;;
 28107                                  
 28108 0000485B 8A1E[7305]              	MOV	BL,[SECCLUSPOS]
 28109 0000485F FEC3                    	INC	BL
 28110 00004861 3A1E[7705]              	CMP	BL,[CLUSFAC]
 28111 00004865 7223                    	JB	short SAMECLUS
 28112                                  	;;;
 28113                                  	; 14/02/2024 (PCDOS 7.1 IBMDOS.COM)
 28114 00004867 8B1E[E00A]              	mov	bx,[NXTCLUSNUM_HW]
 28115 0000486B 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 28116                                  	;;;
 28117 0000486F 8B1E[DC05]              	MOV	BX,[NXTCLUSNUM]
 28118 00004873 E8711A                  	call	IsEOF
 28119 00004876 73E1                    	JAE	short NONE
 28120                                  	;;;
 28121                                  	; 14/02/2024
 28122 00004878 833E[E80A]00            	cmp	word [CLUSTNUM_HW],0
 28123 0000487D 752F                    	jnz	short GETENT
 28124                                  	;;;
 28125                                  	; 23/07/2019
 28126 0000487F 83FB02                  	CMP	BX,2
 28127                                  	;JB	short NONE
 28128                                  	;JMP	short GETENT
 28129                                  	; 16/12/2022
 28130 00004882 732A                    	jnb	short GETENT
 28131                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 28132                                  	;JB	short NONE
 28133                                  	;JMP	short GETENT
 28134                                  	; 14/02/2024 - Retro DOS v5.0
 28135                                  ;NONE:
 28136                                  	;STC
 28137 00004884 C3                      	retn
 28138                                  HAVIT:
 28139 00004885 A3[4803]                	MOV	[LASTENT],AX
 28140 00004888 F8                      	CLC
 28141                                  nextentry_retn:
 28142 00004889 C3                      	retn
 28143                                  
 28144                                  SAMECLUS:
 28145 0000488A 881E[7305]              	MOV	[SECCLUSPOS],BL
 28146 0000488E A3[4803]                	MOV	[LASTENT],AX
 28147 00004891 1E                      	PUSH	DS
 28148 00004892 C53E[E205]              	LDS	DI,[CURBUF]
 28149                                  	; 19/05/2019
 28150                                  	; MSDOS 6.0
 28151                                  	;;mov	dx,[di+8]
 28152                                  	; 23/09/2023
 28153                                  	;MOV	DX,[DI+BUFFINFO.buf_sector+2]	;AN000; >32mb
 28154                                  ;hkn; SS override
 28155                                  	;MOV	[SS:HIGH_SECTOR],DX 		;AN000; >32mb
 28156                                  
 28157                                  ; 14/02/2024
 28158                                  %if 0
 28159                                  	; 23/09/2023
 28160                                  	mov	si,[di+BUFFINFO.buf_sector+2]
 28161                                  	
 28162                                  	;mov	dx,[di+6]
 28163                                  	MOV	DX,[DI+BUFFINFO.buf_sector]	;AN000; >32mb
 28164                                  
 28165                                  	;inc	dx ; MSDOS 3.3
 28166                                  	; MSDOS 6.0
 28167                                  	;ADD	DX,1				;AN000; >32mb
 28168                                  	;ADC	word [SS:HIGH_SECTOR],0 	;AN000; >32mb
 28169                                  	; 23/09/2023
 28170                                  	inc	dx
 28171                                  	jnz	short nextexntry_fc
 28172                                  	inc	si
 28173                                  	;inc	word [SS:HIGH_SECTOR]
 28174                                  nextexntry_fc:
 28175                                  	; 23/09/2023
 28176                                  	mov	[SS:HIGH_SECTOR],si
 28177                                  	; MSDOS 3.3 & MSDOS 6.0
 28178                                  	POP	DS
 28179                                  %else
 28180                                  	; 14/02/2024 - Retro DOS v5.0
 28181 00004896 C55506                  	lds	dx,[di+BUFFINFO.buf_sector]
 28182 00004899 8CDE                    	mov	si,ds
 28183 0000489B 1F                      	pop	ds
 28184 0000489C 42                      	inc	dx
 28185 0000489D 7501                    	jnz	short nextexntry_fc
 28186 0000489F 46                      	inc	si
 28187                                  nextexntry_fc:
 28188 000048A0 8936[0706]              	mov	[HIGH_SECTOR],si
 28189                                  %endif
 28190                                  
 28191 000048A4 E8D7F6                  	call	FIRSTCLUSTER
 28192 000048A7 31DB                    	XOR	BX,BX
 28193 000048A9 EB21                    	JMP	short SETENTRY
 28194                                  
 28195                                  ;----------------------------------------------------------------------------
 28196                                  ;
 28197                                  ; Procedure Name : GETENTRY
 28198                                  ;
 28199                                  ; Inputs:
 28200                                  ;	[LASTENT] has directory entry
 28201                                  ;	ES:BP points to drive parameters
 28202                                  ;	[DIRSEC],[CLUSNUM],[CLUSFAC],[ENTLAST] set for DIR involved
 28203                                  ; Function:
 28204                                  ;	Locates directory entry in preparation for search
 28205                                  ;	GETENT provides entry for passing desired entry in AX
 28206                                  ; Outputs:
 28207                                  ;	[CURBUF+2]:BX = Pointer to next directory entry in CURBUF
 28208                                  ;	[CURBUF+2]:DX = Pointer to first byte after end of CURBUF
 28209                                  ;	[LASTENT] = New directory entry number
 28210                                  ;	[NXTCLUSNUM],[SECCLUSPOS] set via DIRREAD
 28211                                  ;	Carry set if error (currently user FAILed to I 24)
 28212                                  ;----------------------------------------------------------------------------
 28213                                  
 28214                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 28215                                  GETENTRY:
 28216                                  	; 27/07/2018 - Retro DOS v3.0
 28217 000048AB A1[4803]                	MOV	AX,[LASTENT]
 28218                                  
 28219                                  	;entry	GETENT
 28220                                  GETENT:
 28221 000048AE A3[4803]                	MOV	[LASTENT],AX
 28222                                  ;
 28223                                  ; Convert the entry number in AX into a byte offset from the beginning of the
 28224                                  ; directory.
 28225                                  ;
 28226 000048B1 B105                    	mov	cl,5			; shift left by 5 = mult by 32
 28227 000048B3 D3C0                    	rol	ax,cl			; keep hight order bits
 28228 000048B5 89C2                    	mov	dx,ax
 28229                                  	; 19/05/2019 - Retro DOS v4.0
 28230                                  	;and	ax,0FFE0h
 28231                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 28232                                  	;and	ax,~(32-1)		; mask off high order bits
 28233                                  	; 16/12/2022
 28234 000048B7 24E0                    	and	al,0E0h ; ~31
 28235 000048B9 83E21F                  	and	dx,1Fh
 28236                                  	;and	dx,32-1			; mask off low order bits
 28237                                  ;
 28238                                  ; DX:AX contain the byte offset of the required directory entry from the
 28239                                  ; beginning of the directory. Convert this to a sector number. Round the
 28240                                  ; sector size down to a multiple of 32.
 28241                                  ;
 28242                                  	;mov	bx,[es:bp+2]
 28243 000048BC 268B5E02                	MOV	BX,[ES:BP+DPB.SECTOR_SIZE]
 28244 000048C0 80E3E0                  	and	bl,0E0h
 28245                                  	;AND	BL,255-31		; Must be multiple of 32
 28246 000048C3 F7F3                    	DIV	BX
 28247                                  	; 14/02/2024
 28248                                  	;MOV	BX,DX			; Position within sector
 28249                                  				; NOTE: This BX value is not used in DIRREAD
 28250                                  				; Erdogan Tan - 14/02/2024
 28251                                  	;PUSH	BX
 28252 000048C5 52                      	push	dx
 28253                                  	;
 28254 000048C6 E82BF6                  	call	DIRREAD
 28255 000048C9 5B                      	POP	BX
 28256                                  	;retc
 28257 000048CA 72BD                    	jc	short nextentry_retn
 28258                                  SETENTRY:
 28259 000048CC 8B16[E205]              	MOV	DX,[CURBUF]
 28260                                  	;;;add	dx,16 ; MSDOS 3.3
 28261                                  	;;add	dx,20 ; MSDOS 6.0 
 28262                                  	;add	dx,24 ; PCDOS 7.1 ; 14/02/2024	
 28263 000048D0 83C218                  	ADD	DX,BUFINSIZ
 28264 000048D3 01D3                    	ADD	BX,DX
 28265                                  	;add	dx,[es:bp+2]
 28266 000048D5 26035602                	ADD	DX,[ES:BP+DPB.SECTOR_SIZE]  ; Always clears carry
 28267                                  	; 29/12/2022
 28268                                  	; MSDOS 6.21 MSDOS.SYS contains a 'CLC' here, at DOSCODE:7E15h
 28269 000048D9 F8                      	clc
 28270 000048DA C3                      	retn
 28271                                  
 28272                                  ;----------------------------------------------------------------------------
 28273                                  
 28274                                  ; 23/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28275                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8933h
 28276                                  
 28277                                  sft_fcb_table:
 28278 000048DB 00<rep 14h>             	times 20 db 0
 28279                                  sftfcb.cluster:
 28280 000048EF 00000000                	dd	0
 28281                                  sftfcb.direntry:
 28282 000048F3 0000                    	dw	0
 28283                                  sftfcb_entry_size equ $ - sftfcb.cluster ; = 6
 28284                                  
 28285 000048F5 00<rep 72h>             	times 114 db 0	; 6*20 = 120 ; entry size = 6 bytes 
 28286                                  
 28287                                  SRCH_CLUSTER:
 28288 00004967 0000                    	dw	0
 28289                                  SRCH_CLUSTER_HW:
 28290 00004969 0000                    	dw	0
 28291                                  
 28292                                  ;----------------------------------------------------------------------------
 28293                                  
 28294                                  ;Break	<SETDIRSRCH SETROOTSRCH -- Set Search environments>
 28295                                  ;----------------------------------------------------------------------------
 28296                                  ;
 28297                                  ; Procedure Name : SETDIRSRCH,SETROOTSRCH
 28298                                  ;
 28299                                  ; Inputs:
 28300                                  ;	BX cluster number of start of directory
 28301                                  ;	ES:BP Points to DPB
 28302                                  ;	DI next cluster number from fastopen extended info. DOS 3.3 only
 28303                                  ; Function:
 28304                                  ;	Set up a directory search
 28305                                  ; Outputs:
 28306                                  ;	[DIRSTART] = BX
 28307                                  ;	[CLUSFAC],[CLUSNUM],[SECCLUSPOS],[DIRSEC] set
 28308                                  ;	Carry set if error (currently user FAILed to I 24)
 28309                                  ; destroys AX,DX,BX
 28310                                  ;----------------------------------------------------------------------------
 28311                                  
 28312                                  ; 23/01/2024 - Retro DOS v5.0
 28313                                  %if 0
 28314                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 28315                                  SETDIRSRCH:
 28316                                  	OR	BX,BX
 28317                                  	JZ	short SETROOTSRCH
 28318                                  	MOV	[DIRSTART],BX
 28319                                  	;mov	al,[es:bp+4]
 28320                                  	MOV	AL,[ES:BP+DPB.CLUSTER_MASK]
 28321                                  	INC	AL
 28322                                  	MOV	[CLUSFAC],AL
 28323                                  
 28324                                  ; DOS 3.3 for FastOPen	F.C. 6/12/86
 28325                                  	;SAVE	<SI>
 28326                                  	push	si
 28327                                  	;test	byte [FastOpenFlg],2
 28328                                  	TEST	byte [FastOpenFlg],Lookup_Success
 28329                                  	JNZ	short UNP_OK
 28330                                  
 28331                                  ; DOS 3.3 for FastOPen	F.C. 6/12/86
 28332                                  	;invoke	UNPACK
 28333                                  	call	UNPACK
 28334                                  	JNC	short UNP_OK
 28335                                  	;RESTORE <SI>
 28336                                  	pop	si
 28337                                  	;return
 28338                                  	retn
 28339                                  
 28340                                  UNP_OK:
 28341                                  	MOV	[CLUSNUM],DI
 28342                                  	MOV	DX,BX
 28343                                  	XOR	BL,BL
 28344                                  	MOV	[SECCLUSPOS],BL
 28345                                  	;invoke	FIGREC
 28346                                  	call	FIGREC
 28347                                  	;RESTORE <SI>
 28348                                  	pop	si
 28349                                  	
 28350                                  	; 19/05/2019 - Retro DOS v4.0
 28351                                  
 28352                                  	; MSDOS 6.0
 28353                                  	;PUSH	DX			   ;AN000; >32mb
 28354                                  	;MOV	DX,[HIGH_SECTOR]	   ;AN000; >32mb
 28355                                  	;MOV	[DIRSEC+2],DX		   ;AN000; >32mb
 28356                                  	;POP	DX			   ;AN000; >32mb
 28357                                  
 28358                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 28359                                  	;push	dx
 28360                                  	;mov	dx,[HIGH_SECTOR]
 28361                                  	;mov	[DIRSEC+2],dx
 28362                                  	;pop	dx
 28363                                  	;MOV	[DIRSEC],dx
 28364                                  	; 16/12/2022
 28365                                  	mov	ax,[HIGH_SECTOR]
 28366                                  	mov	[DIRSEC+2],AX
 28367                                  	MOV	[DIRSEC],DX
 28368                                  
 28369                                  	; 16/12/2022
 28370                                  	; cf=0 (at the return of FIGREC)
 28371                                  	;CLC
 28372                                  	retn
 28373                                  
 28374                                  	;entry	SETROOTSRCH
 28375                                  SETROOTSRCH:
 28376                                  	XOR	AX,AX
 28377                                  	MOV	[DIRSTART],AX
 28378                                  	; 22/09/2023
 28379                                  	mov	[DIRSEC+2],ax ; 0
 28380                                  	MOV	[SECCLUSPOS],AL
 28381                                  	DEC	AX
 28382                                  	MOV	[CLUSNUM],AX
 28383                                  	;mov	ax,[es:bp+0Bh]
 28384                                  	MOV	AX,[ES:BP+DPB.FIRST_SECTOR]
 28385                                  	; 19/05/2019
 28386                                  	;;mov	dx,[es:bp+10h] ; MSDOS 3.3
 28387                                  	;mov	dx,[es:bp+11h] ; MSDOS 6.0
 28388                                  	MOV	DX,[ES:BP+DPB.DIR_SECTOR]
 28389                                  	SUB	AX,DX
 28390                                  	MOV	[CLUSFAC],AL
 28391                                  	MOV	[DIRSEC],DX		      ;F.C. >32mb
 28392                                  	; 22/09/2023
 28393                                  	; MSDOS 6.0
 28394                                  	;MOV	WORD [DIRSEC+2],0	      ;F.C. >32mb
 28395                                  	CLC
 28396                                  	retn
 28397                                  %else
 28398                                  	;;;
 28399                                  	; 23/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28400                                  	; PCDOS 7.1 IBMDOS.COM - 89C3h
 28401                                  	;;;
 28402                                  SETDIRSRCH:
 28403 0000496B A1[EE0A]                	mov	ax,[ROOTCLUST_HW]
 28404                                  	;cmp	word [ROOTCLUST_HW],0
 28405 0000496E 21C0                    	and	ax,ax	
 28406 00004970 7504                    	jnz	short SETDIRSRCH_FAT32
 28407                                  	
 28408 00004972 09DB                    	or	bx,bx
 28409                                  	;jz	short SETROOTSRCH
 28410 00004974 7423                    	jz	short SETROOTSRCH2 ; ax = 0
 28411                                  SETDIRSRCH_FAT32:
 28412                                  	;mov	ax,[ROOTCLUST_HW]
 28413 00004976 A3[DC0A]                	mov	[DIRSTART_HW],ax
 28414 00004979 A3[E80A]                	mov	[CLUSTNUM_HW],ax
 28415                                  
 28416 0000497C 891E[C205]              	mov	[DIRSTART],bx
 28417                                  	;mov	al,[es:bp+4]
 28418 00004980 268A4604                	mov	al,[es:bp+DPB.CLUSTER_MASK]
 28419                                  	;inc	al
 28420 00004984 40                      	inc	ax
 28421 00004985 A2[7705]                	mov	[CLUSFAC],al
 28422                                  
 28423 00004988 56                      	push	si
 28424                                  	;test	byte [FastOpenFlg],2
 28425 00004989 F606[4611]02            	test	byte [FastOpenFlg],Lookup_Success
 28426 0000498E 7538                    	jnz	short UNP_OK
 28427                                  
 28428 00004990 E87D19                  	call	UNPACK
 28429 00004993 7333                    	jnc	short UNP_OK
 28430                                  
 28431 00004995 5E                      	pop	si
 28432 00004996 C3                      	retn
 28433                                  
 28434                                  SETROOTSRCH:
 28435 00004997 31C0                    	xor	ax,ax ; 0
 28436                                  SETROOTSRCH2:
 28437 00004999 A3[EE0A]                	mov	[ROOTCLUST_HW],ax ;0
 28438                                  	;cmp	word [es:bp+0Fh],0
 28439 0000499C 2639460F                	cmp	[es:bp+DPB.FAT_SIZE],ax ; 0
 28440 000049A0 755A                    	jnz	short SETROOTSRCH_FAT ; not FAT32
 28441                                  SETROOTSRCH_FAT32:
 28442                                  	;mov	bx,[es:bp+37h]
 28443 000049A2 268B5E37                	mov	bx,[es:bp+DPB.ROOT_CLUSTER+2]
 28444 000049A6 891E[EE0A]              	mov	[ROOTCLUST_HW],bx
 28445                                  	;cmp	bx,[es:bp+2Fh]
 28446 000049AA 263B5E2F                	cmp	bx,[es:bp+DPB.LAST_CLUSTER+2]
 28447                                  	;mov	bx,[es:bp+35h]
 28448 000049AE 268B5E35                	mov	bx,[es:bp+DPB.ROOT_CLUSTER]
 28449 000049B2 7504                    	jne	short sdsrch_fat32_1
 28450                                  	;cmp	bx,[es:bp+2Dh]
 28451 000049B4 263B5E2D                	cmp	bx,[es:bp+DPB.LAST_CLUSTER]
 28452                                  sdsrch_fat32_1:
 28453 000049B8 770C                    	ja	short sdsrch_fat32_3 ; **
 28454 000049BA 833E[EE0A]00            	cmp	word [ROOTCLUST_HW],0
 28455                                  	;jnz	short sdsrtch_fat32_2
 28456 000049BF 75B5                    	jnz	short SETDIRSRCH_FAT32
 28457 000049C1 83FB02                  	cmp	bx,2
 28458                                  	;jb	short sdsrch_fat32_3
 28459                                  sdsrch_fat32_2:
 28460                                  	;jmp	SETDIRSRCH_FAT32
 28461 000049C4 73B0                    	jnb	short SETDIRSRCH_FAT32
 28462                                  
 28463                                  sdsrch_fat32_3:
 28464 000049C6 F9                      	stc	; **
 28465                                  	;jmp	short setdirsrch_retn
 28466 000049C7 C3                      	retn
 28467                                  
 28468                                  UNP_OK:
 28469                                  	; CCONTENT_HW:DI = Contents of FAT for given cluster
 28470                                  	;			(from UNPACK)
 28471 000049C8 893E[BC05]              	mov	[CLUSNUM],di
 28472 000049CC 8B16[EC0A]              	mov	dx,[CCONTENT_HW]
 28473 000049D0 8916[DE0A]              	mov	[CLUSNUM_HW],dx
 28474 000049D4 2E891E[6749]            	mov	[cs:SRCH_CLUSTER],bx ; Directory start cluster number
 28475                                  				; for searching/locating (directory entry)
 28476 000049D9 8B16[E80A]              	mov	dx,[CLUSTNUM_HW]
 28477 000049DD 2E8916[6949]            	mov	[cs:SRCH_CLUSTER_HW],dx
 28478                                  
 28479 000049E2 89DA                    	mov	dx,bx
 28480 000049E4 30DB                    	xor	bl,bl
 28481 000049E6 881E[7305]              	mov	[SECCLUSPOS],bl
 28482                                  
 28483                                  	;CLUSTNUM_HW:DX = Physical cluster number (to FIGREC)
 28484                                  
 28485 000049EA E8CB0F                  	call	FIGREC
 28486                                  
 28487 000049ED 8B36[0706]              	mov	si,[HIGH_SECTOR]
 28488 000049F1 8936[C005]              	mov	[DIRSEC+2],si
 28489 000049F5 5E                      	pop	si
 28490                                  SETROOTSRCH3:
 28491 000049F6 8916[BE05]              	mov	[DIRSEC],dx ; *
 28492                                  	
 28493                                  	;pop	si
 28494 000049FA F8                      	clc	; (this may not be needed,
 28495                                  		; FIGREC clears cf except an abnormal sector calc overflow)
 28496 000049FB C3                      	retn
 28497                                  
 28498                                  SETROOTSRCH_FAT:
 28499                                  	;xor	ax,ax
 28500 000049FC A3[C005]                	mov	[DIRSEC+2],ax ; 0
 28501 000049FF A3[C205]                	mov	[DIRSTART],ax ; 0
 28502 00004A02 A3[DC0A]                	mov	[DIRSTART_HW],ax ; 0
 28503 00004A05 2EA3[6949]              	mov	[cs:SRCH_CLUSTER_HW],ax ; 0
 28504 00004A09 40                      	inc	ax		; search start dir cluster num = 1
 28505                                  				; (root directory)
 28506 00004A0A 2EA3[6749]              	mov	[cs:SRCH_CLUSTER],ax ; 1 ; FAT root directory (<2)
 28507 00004A0E 48                      	dec	ax ; 0
 28508 00004A0F A2[7305]                	mov	[SECCLUSPOS],al
 28509 00004A12 48                      	dec	ax ; -1
 28510 00004A13 A3[BC05]                	mov	[CLUSNUM],ax ; 0FFFFh
 28511 00004A16 A3[DE0A]                	mov	[CLUSNUM_HW],ax ; 0FFFFh
 28512                                  
 28513                                  	;mov	ax,[es:bp+0Bh]
 28514 00004A19 268B460B                	mov	ax,[es:bp+DPB.FIRST_SECTOR]
 28515                                  	;mov	dx,[es:bp+11h]
 28516 00004A1D 268B5611                	mov	dx,[es:bp+DPB.DIR_SECTOR]
 28517 00004A21 29D0                    	sub	ax,dx
 28518 00004A23 A2[7705]                	mov	[CLUSFAC],al
 28519                                  	;mov	[DIRSEC],dx ; *
 28520                                  	;clc
 28521                                  ;setdirsrch_retn:
 28522                                  	;retn
 28523 00004A26 EBCE                    	jmp	short SETROOTSRCH3
 28524                                  	;;;
 28525                                  %endif
 28526                                  
 28527                                  ;----------------------------------------------------------------------------
 28528                                  
 28529                                  ; 23/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28530                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8A90h
 28531                                  
 28532                                  ; set SFT number and entry in the new internal table (only for FCB calls)
 28533                                  
 28534                                  set_sftfcb_entry:
 28535 00004A28 50                      	push	ax
 28536 00004A29 51                      	push	cx
 28537 00004A2A 52                      	push	dx
 28538 00004A2B 53                      	push	bx
 28539                                  
 28540                                  	;push	bp
 28541                                  	;push	si
 28542                                  	;push	di              ; ES:DI = SFT entry
 28543                                  
 28544 00004A2C E84B00                  	call	find_sft_entry_number
 28545                                  				; ax = SFT entry index number
 28546                                  				;      of the last SFT entry
 28547 00004A2F 31DB                    	xor	bx,bx
 28548 00004A31 B91400                  	mov	cx,20		; find empty entry (slot) in the table
 28549                                  	; Retro DOS v5.0
 28550 00004A34 31D2                    	xor	dx,dx ; *
 28551                                  set_sftfcbe_1:
 28552                                  	;;cmp	cs:(sftfcb_cluster+2)[bx],0
 28553                                  	;cmp	word [cs:bx+sftfcb.cluster+2],0
 28554                                  				; directory (search) starting cluster, hw
 28555 00004A36 2E3997[F148]            	cmp	[cs:bx+sftfcb.cluster+2],dx ; 0
 28556 00004A3B 7505                    	jnz	short set_sftfcbe_2
 28557                                  	;;cmp	cs:sftfcb_cluster[bx], 
 28558                                  	;cmp	word [cs:bx+sftfcb.cluster],0
 28559                                  				; directory (search) starting cluster, lw
 28560 00004A3D 2E3997[EF48]            	cmp	[cs:bx+sftfcb.cluster],dx ; 0
 28561                                  set_sftfcbe_2:
 28562 00004A42 752C                    	jnz	short set_sftfcbe_3
 28563                                  				; not empty (sfcb table) entry
 28564                                  	; Retro DOS v5.0
 28565                                  	;push	cx
 28566                                  
 28567 00004A44 2E8B0E[6749]            	mov	cx,[cs:SRCH_CLUSTER]
 28568                                  				; search start dir cluster number
 28569                                  	;mov	cs:sftfcb_cluster[bx],cx
 28570 00004A49 2E898F[EF48]            	mov	[cs:bx+sftfcb.cluster],cx
 28571                                  				; directory start cluster
 28572 00004A4E 2E8B0E[6949]            	mov     cx,[cs:SRCH_CLUSTER_HW]
 28573                                  	
 28574                                  	; PCDOS 7.1 BUG! (This would be '[cs:bx:sftfcb.cluster+2],cx')
 28575                                  	; Erdogan Tan - 23/01/2024
 28576                                  	;mov	cs:sftfcb_cluster[bx]
 28577                                  	;mov	[cs:bx:sftfcb.cluster],cx ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8ABFh
 28578                                  	; Retro DOS v5.0
 28579 00004A53 2E898F[F148]            	mov	[cs:bx+sftfcb.cluster+2],cx
 28580                                  
 28581                                  	;pop	cx
 28582                                  
 28583                                  	;mov	dx,[ss:LASTENT]	; LAST (found) entry in the directory
 28584                                  	;;mov	cs:sftfcb_direntry[bx],dx
 28585                                  	;mov	[cs:bx+sftfcb.direntry],dx
 28586                                  				; directory entry number
 28587 00004A58 368B0E[4803]            	mov	cx,[ss:LASTENT]
 28588 00004A5D 2E898F[F348]            	mov	[cs:bx+sftfcb.direntry],cx	
 28589                                  
 28590 00004A62 93                      	xchg	ax,bx
 28591                                  	;xor	dx,dx ; *
 28592                                  	; dx = 0
 28593 00004A63 B90600                  	mov	cx,6		; sftfcb table has 6 byte entries
 28594 00004A66 F7F1                    	div	cx
 28595 00004A68 93                      	xchg	ax,bx
 28596 00004A69 2E8887[DB48]            	mov	[cs:bx+sft_fcb_table], al
 28597                                  				; put SFT entry number in SFT-FCB
 28598                                  				; table (offset is FCB index number 0 to 19)
 28599 00004A6E EB05                    	jmp     short set_setfcbe_4
 28600                                  set_sftfcbe_3:
 28601                                  	;add	bx,6
 28602 00004A70 83C306                  	add	bx,sftfcb_entry_size ; 6
 28603 00004A73 E2C1                    	loop	set_sftfcbe_1
 28604                                  
 28605                                  set_setfcbe_4:
 28606                                  	;pop	di
 28607                                  	;pop	si
 28608                                  	;pop	bp
 28609                                  	
 28610 00004A75 5B                      	pop	bx
 28611 00004A76 5A                      	pop	dx
 28612 00004A77 59                      	pop	cx
 28613 00004A78 58                      	pop	ax
 28614 00004A79 C3                      	retn
 28615                                  
 28616                                  ;----------------------------------------------------------------------------
 28617                                  
 28618                                  ; 24/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28619                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8AECh
 28620                                  
 28621                                  	; 14/02/2024
 28622                                  find_sft_entry_number:
 28623 00004A7A 06                      	push	es		; es:di = SFT entry
 28624 00004A7B 31C9                    	xor	cx,cx
 28625 00004A7D 8CC2                    	mov	dx,es
 28626 00004A7F 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 28627 00004A84 26C41E[2A00]            	les	bx,[es:SFT_ADDR] ; address of the first SFT
 28628                                  f_sfte_1:
 28629 00004A89 8CC0                    	mov	ax,es
 28630 00004A8B 39D0                    	cmp	ax,dx		; same SFT segment ?
 28631 00004A8D 7512                    	jne	short f_sfte_2	; no
 28632 00004A8F 89F8                    	mov	ax,di
 28633 00004A91 29D8                    	sub	ax,bx		; ax = entry offset
 28634                                  	;sub	ax,6		; ax = offset from start of the SFT table
 28635 00004A93 83E806                  	sub	ax,SFT.SFTable
 28636                                  	;mov	bx,59
 28637 00004A96 BB3B00                  	mov	bx,SF_ENTRY.size ; (SFT entry size)
 28638 00004A99 31D2                    	xor	dx,dx
 28639 00004A9B F7F3                    	div	bx		; ax = SFT entry index in the table
 28640 00004A9D 01C8                    	add	ax,cx		; ax = SFT index number (for requested SFT entry)
 28641 00004A9F 07                      	pop	es
 28642 00004AA0 C3                      	retn
 28643                                  f_sfte_2:
 28644 00004AA1 26034F04                	add	cx,[es:bx+4]	; SFT.SFCount ; number of entries in the table
 28645 00004AA5 26C41F                  	les	bx,[es:bx]	; SFT.SFLink
 28646 00004AA8 83FBFF                  	cmp	bx,0FFFFh ; -1	; the last SFT
 28647 00004AAB 75DC                    	jnz	short f_sfte_1
 28648 00004AAD F9                      	stc			; (not found)
 28649 00004AAE 07                      	pop	es
 28650 00004AAF C3                      	retn
 28651                                  
 28652                                  ;----------------------------------------------------------------------------
 28653                                  
 28654                                  ; 24/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28655                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8B22h
 28656                                  
 28657                                  	; 14/02/2024
 28658                                  int_2Fh_1230h:		; Windows95 - FIND SFT ENTRY IN INTERNAL FILE TABLES
 28659 00004AB0 E8C7FF                  	call	find_sft_entry_number
 28660 00004AB3 7242                    	jc	short find_sfte_i_error
 28661 00004AB5 06                      	push	es	; ax = SFT enty index number (of the requested SFT entry)
 28662 00004AB6 57                      	push	di
 28663 00004AB7 0E                      	push	cs
 28664 00004AB8 07                      	pop	es
 28665 00004AB9 B91400                  	mov	cx,20		; statically allocated with 20 entries,
 28666                                  				; and used only for FCB calls
 28667 00004ABC BF[DB48]                	mov	di,sft_fcb_table ; new file system (internal) table
 28668                                  				;  only for fcb calls
 28669                                  scan_next_sftfcb:
 28670 00004ABF F2AE                    	repne scasb
 28671 00004AC1 F9                      	stc
 28672 00004AC2 7531                    	jnz	short sfte_i_notfound ; not found (cf=1)
 28673 00004AC4 8D5DFF                  	lea	bx,[di-1]	; offset of the entry in the table
 28674 00004AC7 81EB[DB48]              	sub	bx,sft_fcb_table ; index into new file system table
 28675 00004ACB 89DA                    	mov	dx,bx
 28676 00004ACD 01DB                    	add	bx,bx		; 2*bx
 28677 00004ACF 01D3                    	add	bx,dx		; 3*bx
 28678 00004AD1 01DB                    	add	bx,bx		; bx = 6*bx  ; entry size = 6 bytes
 28679 00004AD3 268BB7[F148]            	mov	si,[es:bx+sftfcb.cluster+2] ; dir start cluster number, hw
 28680 00004AD8 268B97[F348]            	mov	dx,[es:bx+sftfcb.direntry] ; directory entry number
 28681 00004ADD 51                      	push	cx
 28682 00004ADE 268B8F[EF48]            	mov	cx,[es:bx+sftfcb.cluster] ; dir start cluster number, lw
 28683 00004AE3 09C9                    	or	cx,cx
 28684 00004AE5 750C                    	jnz	short sfte_i_found
 28685 00004AE7 09F6                    	or	si,si
 28686 00004AE9 7508                    	jnz	short sfte_i_found
 28687 00004AEB 59                      	pop	cx
 28688 00004AEC 09C9                    	or	cx,cx
 28689 00004AEE 75CF                    	jnz	short scan_next_sftfcb
 28690 00004AF0 F9                      	stc			; not found (cf=1)
 28691 00004AF1 EB02                    	jmp	short sfte_i_notfound
 28692                                  
 28693                                  sfte_i_found:
 28694 00004AF3 58                      	pop	ax		; clear stack
 28695 00004AF4 F8                      	clc			; found (cf=0)
 28696                                  sfte_i_notfound:
 28697 00004AF5 5F                      	pop	di
 28698 00004AF6 07                      	pop	es
 28699                                  find_sfte_i_error:
 28700 00004AF7 B80000                  	mov	ax,0
 28701 00004AFA C3                      	retn
 28702                                  
 28703                                  ;----------------------------------------------------------------------------
 28704                                  
 28705                                  ; 24/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28706                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8B6Dh
 28707                                  
 28708                                  	; 14/02/2024
 28709                                  SFT_FREE:
 28710 00004AFB 50                      	push	ax
 28711 00004AFC 51                      	push	cx
 28712 00004AFD 52                      	push	dx
 28713 00004AFE 53                      	push	bx
 28714                                  	;push	bp	; 14/02/2024 - Retro DOS v5.0
 28715 00004AFF 56                      	push	si
 28716                                  	;push	di
 28717 00004B00 26C7050000              	mov     word [es:di],0 ; [ES:DI+SF_ENTRY.sf_ref_Count]
 28718 00004B05 E8A8FF                  	call    int_2Fh_1230h
 28719 00004B08 720E                    	jc      short sftf_1
 28720 00004B0A 2EC787[F148]0000        	mov	word [cs:bx+sftfcb.cluster+2],0 ; clear directory start cluster
 28721                                  						;  in the new (sftfcb) table
 28722 00004B11 2EC787[EF48]0000        	mov	word [cs:bx+sftfcb.cluster],0	; ((empty entry))
 28723                                  sftf_1:
 28724                                  	;pop	di
 28725 00004B18 5E                      	pop	si
 28726                                  	;pop	bp
 28727 00004B19 5B                      	pop	bx
 28728 00004B1A 5A                      	pop	dx
 28729 00004B1B 59                      	pop	cx
 28730 00004B1C 58                      	pop	ax
 28731 00004B1D C3                      	retn
 28732                                  
 28733                                  ; =============== S U B R O U T I N E =======================================
 28734                                  
 28735                                  ; 13/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28736                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8B94h
 28737                                  
 28738                                  check_longname:
 28739 00004B1E 240F                    	and     al,0Fh
 28740 00004B20 3C0F                    	cmp     al,0Fh
 28741 00004B22 C3                      	retn
 28742                                  
 28743                                  ;----------------------------------------------------------------------------
 28744                                  
 28745                                  ;============================================================================
 28746                                  ; DIR2.ASM, MSDOS 6.0, 1991
 28747                                  ;============================================================================
 28748                                  ; 27/07/2018 - Retro DOS v3.0
 28749                                  ; 19/05/2019 - Retro DOS v4.0
 28750                                  ; 14/02/2024 - Retro DOS v5.0
 28751                                  
 28752                                  ;	TITLE	DIR2 - Directory and path cracking
 28753                                  ;	NAME	Dir2
 28754                                  
 28755                                  ;Break	<GETPATH -- PARSE A WFP>
 28756                                  ;----------------------------------------------------------------------------
 28757                                  ;
 28758                                  ; Procedure Name : GETPATH
 28759                                  ;
 28760                                  ; Inputs:
 28761                                  ;	[WFP_START] Points to WFP string ("d:\" must be first 3 chars, NUL
 28762                                  ;		terminated; d:/ (note forward slash) indicates a real device).
 28763                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 28764                                  ;		( = -1 if current dir not involved, else
 28765                                  ;		 Points to first char after last "/" of current dir part)
 28766                                  ;	[THISCDS] Points to CDS being used
 28767                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 28768                                  ;	[NoSetDir] set
 28769                                  ;	[THISDPB] set to DPB if disk otherwise garbage.
 28770                                  ; Function:
 28771                                  ;	Crack the path
 28772                                  ; Outputs:
 28773                                  ;	Sets EXTERR_LOCUS = errLOC_Disk if disk file
 28774                                  ;	Sets EXTERR_LOCUS = errLOC_Unk if char device
 28775                                  ;	ID1 field of [THISCDS] updated appropriately
 28776                                  ;	[ATTRIB] = [SATTRIB]
 28777                                  ;	ES:BP Points to DPB
 28778                                  ;	Carry set if bad path
 28779                                  ;	   SI Points to path element causing failure
 28780                                  ;	   Zero set
 28781                                  ;	      [DIRSTART],[DIRSEC],[CLUSNUM], and [CLUSFAC] are set up to
 28782                                  ;	      start a search on the last directory
 28783                                  ;	      CL is zero if there is a bad name in the path
 28784                                  ;	      CL is non-zero if the name was simply not found
 28785                                  ;		 [ENTFREE] may have free spot in directory
 28786                                  ;		 [NAME1] is the name.
 28787                                  ;		 CL = 81H if '*'s or '?' in NAME1, 80H otherwise
 28788                                  ;	   Zero reset
 28789                                  ;	      File in middle of path or bad name in path or attribute mismatch
 28790                                  ;		or path too long or malformed path
 28791                                  ;	ELSE
 28792                                  ;	   [CurBuf] = -1 if root directory
 28793                                  ;	   [CURBUF] contains directory record with match
 28794                                  ;	   [CURBUF+2]:BX Points into [CURBUF] to start of entry
 28795                                  ;	   [CURBUF+2]:SI Points into [CURBUF] to dir_first field for entry
 28796                                  ;	   AH = device ID
 28797                                  ;	      bit 7 of AH set if device SI and BX
 28798                                  ;	      will point DOSGROUP relative The firclus
 28799                                  ;	      field of the device entry contains the device pointer
 28800                                  ;	   [NAME1] Has name looked for
 28801                                  ;	   If last element is a directory zero is set and:
 28802                                  ;	      [DIRSTART],[SECCLUSPOS],[DIRSEC],[CLUSNUM], and [CLUSFAC]
 28803                                  ;	      are set up to start a search on it.
 28804                                  ;	      unless [NoSetDir] is non zero in which case the return is
 28805                                  ;	      like that for a file (except for zero flag)
 28806                                  ;	   If last element is a file zero is reset
 28807                                  ;	      [DIRSEC],[CLUSNUM],[CLUSFAC],[NXTCLUSNUM],[SECCLUSPOS],
 28808                                  ;	      [LASTENT], [ENTLAST] are set to continue search of last
 28809                                  ;	      directory for furthur matches on NAME1 via the NEXTENT
 28810                                  ;	      entry point in FindEntry (or GETENT entry in GETENTRY in
 28811                                  ;	      which case [NXTCLUSNUM] and [SECCLUSPOS] need not be valid)
 28812                                  ; DS preserved, Others destroyed
 28813                                  ;---------------------------------------------------------------------------
 28814                                  
 28815                                  ;hkn; called from delete.asm, finfo.asm, mknode.asm and rename.asm.
 28816                                  ;hkn; DS already set up at this point.
 28817                                  
 28818                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 28819                                  
 28820                                  	; 15/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28821                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:8B99h
 28822                                  
 28823                                  GETPATH:
 28824                                  	;mov	word [CREATING],0E500h
 28825 00004B23 C706[7E05]00E5          	MOV	WORD [CREATING],DIRFREE*256+0 ; Not Creating, not DEL *.*
 28826                                  
 28827                                  ; Same as GetPath only CREATING and DELALL already set
 28828                                  
 28829                                  	;entry	GetPathNoSet
 28830                                  GetPathNoSet:
 28831                                  	;;mov	byte [EXTERR_LOCUS],2
 28832                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Disk
 28833                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 28834 00004B29 E8B2C7                  	call	set_exerr_locus_disk
 28835                                  	;
 28836 00004B2C C706[E205]FFFF          	MOV	word [CURBUF],-1	; initial setting
 28837                                  
 28838                                  ; See if the input indicates a device that has already been detected. If so,
 28839                                  ; go build the guy quickly. Otherwise, let findpath find the device.
 28840                                  
 28841 00004B32 8B3E[B205]              	MOV	DI,[WFP_START]		; point to the beginning of the name
 28842                                  	;cmp	word [DI+1],5C3Ah
 28843                                  	;CMP	WORD [DI+1],'\' << 8 + ':'
 28844 00004B36 817D013A5C              	cmp	word [DI+1],':\'
 28845 00004B3B 7435                    	JZ	short CrackIt
 28846                                  
 28847                                  ; Let ChkDev find it in the device list
 28848                                  
 28849 00004B3D 83C703                  	ADD	DI,3
 28850                                  	; 18/08/2018
 28851                                  	;MOV	SI,DI			; let CHKDEV see the original name
 28852                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 28853                                  	; 16/12/2022
 28854                                  	;mov	si,di ; not required ! (it is written in CHKDEV proc already!)
 28855 00004B40 E8B200                  	CALL	CHKDEV
 28856 00004B43 722B                    	JC	short InternalError
 28857                                  
 28858                                  Build_devJ:
 28859 00004B45 A0[6D05]                	MOV	AL,[SATTRIB]
 28860 00004B48 A2[6B05]                	MOV	[ATTRIB],AL
 28861                                  	; 15/02/2024
 28862                                  	;;mov	byte [EXTERR_LOCUS],1
 28863                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Unk ; In the particular case of
 28864                                  					; "finding" a char device
 28865                                  					; set LOCUS to Unknown. This makes
 28866                                  					; certain idiotic problems reported
 28867                                  					; by a certain 3 letter OEM go away.
 28868                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 28869 00004B4B E887C7                  	call	set_exerr_locus_unk
 28870                                  
 28871                                  
 28872                                  ; Take name in name1 and pack it back into where wfp_start points. This
 28873                                  ; guarantees wfp_start pointing to a canonical representation of a device.
 28874                                  ; We are allowed to do this as GetPath is *ALWAYS* called before entering a
 28875                                  ; wfp into the share set.
 28876                                  ;
 28877                                  ; We copy chars from name1 to wfp_start remembering the position of the last
 28878                                  ; non-space seen +1.  This position is kept in DX.
 28879                                  
 28880                                  ;hkn; SS is DOSDATA
 28881 00004B4E 16                      	push	ss
 28882 00004B4F 07                      	pop	es
 28883                                  
 28884                                  ;hkn; NAME1 is in DOSDATA
 28885 00004B50 BE[4B05]                	mov	si,NAME1
 28886 00004B53 8B3E[B205]              	mov	di,[WFP_START]
 28887 00004B57 89FA                    	mov	dx,di
 28888 00004B59 B90800                  	mov	cx,8			; 8 chars in device name
 28889                                  MoveLoop:
 28890 00004B5C AC                      	lodsb
 28891 00004B5D AA                      	stosb
 28892 00004B5E 3C20                    	cmp	al," "
 28893 00004B60 7402                    	jz	short NoSave
 28894                                  
 28895 00004B62 89FA                    	mov	dx,di
 28896                                  NoSave:
 28897 00004B64 E2F6                    	loop	MoveLoop
 28898                                  
 28899                                  ; DX is the position of the last seen non-space + 1. We terminate the name
 28900                                  ; at this point.
 28901                                  
 28902 00004B66 89D7                    	mov	di,dx
 28903                                  	;mov	byte [di],0		; end of string
 28904                                  	; 15/02/2024
 28905 00004B68 880D                    	mov	[di],cl ; 0
 28906 00004B6A E8E102                  	call	Build_device_ent	; Clears carry sets zero
 28907 00004B6D FEC0                    	INC	AL			; reset zero
 28908 00004B6F C3                      	retn
 28909                                  
 28910                                  InternalError:
 28911                                  InternalError_loop:
 28912 00004B70 EBFE                    	JMP	short InternalError_loop ; freeze
 28913                                  
 28914                                  ; Start off at the correct spot. Optimize if the current dir part is valid.
 28915                                  
 28916                                  CrackIt:
 28917                                  ; 15/02/2024
 28918                                  %if 0
 28919                                  	MOV	SI,[CURR_DIR_END]	; get current directory pointer
 28920                                  	CMP	SI,-1			; valid?
 28921                                  	JNZ	short LOOK_SING		; Yes, use it.
 28922                                  	LEA	SI,[DI+3]		; skip D:\.
 28923                                  LOOK_SING:
 28924                                  %endif
 28925                                  	;mov	byte [ATTRIB],16h
 28926 00004B72 C606[6B05]16            	MOV	byte [ATTRIB],attr_directory+attr_system+attr_hidden
 28927                                  					; Attributes to search through Dirs
 28928 00004B77 C43E[A205]              	LES	DI,[THISCDS]
 28929 00004B7B B8FFFF                  	MOV	AX,-1 ; 0FFFFh
 28930                                  	;;;
 28931                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 28932                                  	;mov	bx,[es:di+4Bh]
 28933 00004B7E 268B5D4B                	mov	bx,[es:di+curdir.ID+2]
 28934 00004B82 891E[EE0A]              	mov	[ROOTCLUST_HW],bx
 28935                                  	;;;
 28936                                  	;mov	bx,[es:di+73]
 28937 00004B86 268B5D49                	MOV	BX,[ES:DI+curdir.ID]
 28938 00004B8A 8B36[B605]              	MOV	SI,[CURR_DIR_END]
 28939                                  
 28940                                  ; AX = -1
 28941                                  ; BX = cluster number of current directory. THis number is -1 if the media
 28942                                  ;      has been uncertainly changed.
 28943                                  ; SI = offset in DOSGroup into path to end of current directory text. This
 28944                                  ;      may be -1 if no current directory part has been used.
 28945                                  
 28946 00004B8E 39C6                    	CMP	SI,AX			; if Current directory is not part
 28947 00004B90 7449                    	JZ	short NO_CURR_D		; then we must crack from root
 28948                                  	;;;
 28949                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 28950 00004B92 3906[EE0A]              	cmp	[ROOTCLUST_HW],ax ; 0FFFFh
 28951 00004B96 7504                    	jnz	short CrackIt2
 28952                                  	;;;
 28953 00004B98 39C3                    	CMP	BX,AX			; is the current directory cluster valid
 28954                                  
 28955                                  ; DOS 3.3  6/25/86
 28956 00004B9A 743F                    	JZ	short NO_CURR_D		; no, crack from the root
 28957                                  
 28958                                  CrackIt2:	; 15/02/2024 - Retro DOS v5.0
 28959                                  
 28960                                  	;test	byte [FastOpenFlg],1
 28961 00004B9C F606[4611]01            	TEST	byte [FastOpenFlg],FastOpen_Set ; for fastopen ?
 28962 00004BA1 7445                    	JZ	short GOT_SEARCH_CLUSTER	; no
 28963 00004BA3 06                      	PUSH	ES			; save registers
 28964 00004BA4 57                      	PUSH	DI
 28965 00004BA5 51                      	PUSH	CX
 28966 00004BA6 FF74FF                  	PUSH	word [SI-1]		; save \ and 1st char of next element
 28967 00004BA9 56                      	PUSH	SI
 28968 00004BAA 53                      	PUSH	BX
 28969                                  	;;; 15/02/2024
 28970 00004BAB FF36[EE0A]              	push	word [ROOTCLUST_HW]
 28971                                  	;;;
 28972 00004BAF C644FF00                	MOV	BYTE [SI-1],0		; call fastopen to look up cur dir info
 28973 00004BB3 8B36[B205]              	MOV	SI,[WFP_START]
 28974                                  
 28975                                  ;hkn; FastOpenTable, Dir_Info_Buff & FastOpen_Ext_Info are in DOSDATA
 28976 00004BB7 BB[3C11]                	MOV	BX,FastOpenTable
 28977 00004BBA BF[7C0D]                	MOV	DI,Dir_Info_Buff
 28978 00004BBD B9[4711]                	MOV	CX,FastOpen_Ext_Info
 28979                                  	;mov	al,1
 28980 00004BC0 B001                    	MOV	AL,FONC_Look_up
 28981 00004BC2 1E                      	PUSH	DS
 28982 00004BC3 07                      	POP	ES
 28983                                  	;call	far [BX+2]
 28984 00004BC4 FF5F02                  	CALL	far [BX+fastopen_entry.name_caching]
 28985 00004BC7 7203                    	JC	short GO_Chk_end1 	;fastopen not installed, or wrong drive.
 28986                                  					; Go to Got_Srch_cluster
 28987                                  	; 29/12/2022
 28988                                  	;CMP	BYTE [SI],0		;fastopen has current dir info?
 28989                                  	;JE	short GO_Chk_end	;yes. Go to got_search_cluster
 28990                                  	;stc
 28991                                  	;jmp	short GO_Chk_end	;Go to No_Curr_D
 28992                                  
 28993 00004BC9 803C01                  	cmp	byte [si],1
 28994                                  GO_Chk_end1:	; 29/12/2022
 28995 00004BCC F5                      	cmc 
 28996                                  	; [si] = 0 -> cf = 0
 28997                                  	; [si] > 0 -> cf = 1
 28998                                  
 28999                                  ;GO_Chk_end1:
 29000                                  	; 29/12/2022
 29001                                  	;clc
 29002                                  
 29003                                  GO_Chk_end:				; restore registers
 29004                                  	;;; 15/02/2024
 29005 00004BCD 8F06[EE0A]              	pop	word [ROOTCLUST_HW]
 29006                                  	;;;
 29007 00004BD1 5B                      	POP	BX
 29008 00004BD2 5E                      	POP	SI
 29009 00004BD3 8F44FF                  	POP	word [SI-1]
 29010 00004BD6 59                      	POP	CX
 29011 00004BD7 5F                      	POP	DI
 29012 00004BD8 07                      	POP	ES
 29013 00004BD9 730D                    	JNC	short GOT_SEARCH_CLUSTER ; crack based on cur dir
 29014                                  
 29015                                  ; DOS 3.3  6/25/86
 29016                                  ;
 29017                                  ; We must cract the path beginning at the root. Advance pointer to beginning
 29018                                  ; of path and go crack from root.
 29019                                  
 29020                                  NO_CURR_D:
 29021 00004BDB 8B36[B205]              	MOV	SI,[WFP_START]
 29022                                  	;LEA	SI,[SI+3]		; Skip "d:/"
 29023                                  	; 15/02/2024
 29024 00004BDF 83C603                  	add	si,3
 29025 00004BE2 C42E[8A05]              	LES	BP,[THISDPB]		; Get ES:BP
 29026 00004BE6 EB3B                    	JMP	short ROOTPATH
 29027                                  
 29028                                  ; We are able to crack from the current directory part. Go set up for search
 29029                                  ; of specified cluster.
 29030                                  
 29031                                  GOT_SEARCH_CLUSTER:
 29032 00004BE8 C42E[8A05]              	LES	BP,[THISDPB]		; Get ES:BP
 29033 00004BEC E87CFD                  	call	SETDIRSRCH
 29034                                  	;JC	short SETFERR
 29035                                  	;JMP	short FINDPATH
 29036                                  	; 16/12/2022
 29037 00004BEF 7342                    	jnc	short FINDPATH ; 17/08/2018
 29038                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 29039                                  	;JC	short SETFERR
 29040                                  	;JMP	short FINDPATH
 29041                                  SETFERR:
 29042 00004BF1 30C9                    	XOR	CL,CL			; set zero
 29043 00004BF3 F9                      	STC
 29044 00004BF4 C3                      	retn
 29045                                  
 29046                                  ;---------------------------------------------------------------------------
 29047                                  ;
 29048                                  ; Procedure Name : ChkDev
 29049                                  ;
 29050                                  ; Check to see if the name at DS:DI is a device. Returns carry set if not a
 29051                                  ;   device.
 29052                                  ; Blasts CX,SI,DI,AX,BX
 29053                                  ;---------------------------------------------------------------------------
 29054                                  
 29055                                  CHKDEV:
 29056 00004BF5 89FE                    	MOV	SI,DI
 29057 00004BF7 8CD7                    	MOV	DI,SS
 29058 00004BF9 8EC7                    	MOV	ES,DI
 29059                                  
 29060 00004BFB BF[4B05]                	MOV	DI,NAME1
 29061 00004BFE B90900                  	MOV	CX,9
 29062                                  TESTLOOP:
 29063 00004C01 E8BF11                  	call	GETLET
 29064                                  
 29065 00004C04 3C2E                    	CMP	AL,'.'
 29066 00004C06 740E                    	JZ	short TESTDEVICE
 29067 00004C08 E80C12                  	call	PATHCHRCMP
 29068 00004C0B 7407                    	JZ	short NOTDEV
 29069 00004C0D 08C0                    	OR	AL,AL
 29070 00004C0F 7405                    	JZ	short TESTDEVICE
 29071                                  
 29072 00004C11 AA                      	STOSB
 29073 00004C12 E2ED                    	LOOP	TESTLOOP
 29074                                  NOTDEV:
 29075 00004C14 F9                      	STC
 29076 00004C15 C3                      	retn
 29077                                  
 29078                                  TESTDEVICE:
 29079                                  	;ADD	CX,2
 29080                                  	; 24/09/2023
 29081 00004C16 41                      	inc	cx
 29082 00004C17 41                      	inc	cx
 29083 00004C18 B020                    	MOV	AL,' '
 29084 00004C1A F3AA                    	REP	STOSB
 29085 00004C1C 8CD0                    	MOV	AX,SS
 29086 00004C1E 8ED8                    	MOV	DS,AX
 29087                                  	;call	DEVNAME
 29088                                  	;retn
 29089                                  	; 18/12/2022
 29090 00004C20 E9CC01                  	jmp	DEVNAME
 29091                                  
 29092                                  ;Break	<ROOTPATH, FINDPATH -- PARSE A PATH>
 29093                                  ;----------------------------------------------------------------------------
 29094                                  ;
 29095                                  ; Procedure Name : ROOTPATH,FINDPATH
 29096                                  ;
 29097                                  ; Inputs:
 29098                                  ;	Same as FINDPATH but,
 29099                                  ;	SI Points to asciz string of path which is assumed to start at
 29100                                  ;		the root (no leading '/').
 29101                                  ; Function:
 29102                                  ;	Search from root for path
 29103                                  ; Outputs:
 29104                                  ;	Same as FINDPATH but:
 29105                                  ;	If root directory specified, [CURBUF] and [NAME1] are NOT set, and
 29106                                  ;	[NoSetDir] is ignored.
 29107                                  ;----------------------------------------------------------------------------
 29108                                  
 29109                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 29110                                  	; DOSCODE:7F47h (MSDOS 5.0, MSDOS.SYS)
 29111                                  
 29112                                  	; 15/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 29113                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:8C9Dh
 29114                                  
 29115                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:7F82h)
 29116                                  	; (Windows ME IO.SYS - BIOSCODE:829Eh)
 29117                                  
 29118                                  ROOTPATH:
 29119 00004C23 E871FD                  	call	SETROOTSRCH
 29120                                  	; 24/09/2023
 29121 00004C26 30E4                    	xor	ah,ah
 29122                                  	;CMP	BYTE [SI],0
 29123 00004C28 3824                    	cmp	[si],ah ; 0
 29124 00004C2A 7507                    	JNZ	short FINDPATH
 29125                                  
 29126                                  	;;;
 29127                                  	;; 15/02/2024
 29128                                  	; Windows ME IO.SYS - BIOSCODE:82A6h
 29129                                  	;mov	word [CURBUF],0FFFFh
 29130                                  	;;;
 29131                                  
 29132                                  ; Root dir specified
 29133 00004C2C A0[6D05]                	MOV	AL,[SATTRIB]
 29134 00004C2F A2[6B05]                	MOV	[ATTRIB],AL
 29135                                  	; 24/09/2023
 29136                                  	;XOR	AH,AH			; Sets "device ID" byte, sets zero
 29137                                  					; (dir), clears carry.
 29138 00004C32 C3                      	retn
 29139                                  
 29140                                  ; Inputs:
 29141                                  ;	[ATTRIB] Set to get through directories
 29142                                  ;	[SATTRIB] Set to find last element
 29143                                  ;	ES:BP Points to DPB
 29144                                  ;	SI Points to asciz string of path (no leading '/').
 29145                                  ;	[SECCLUSPOS] = 0
 29146                                  ;	[DIRSEC] = Phys sec # of first sector of directory
 29147                                  ;	[CLUSNUM] = Cluster # of next cluster
 29148                                  ;	[CLUSFAC] = Sectors per cluster
 29149                                  ;	[NoSetDir] set
 29150                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 29151                                  ;		( = -1 if current dir not involved, else
 29152                                  ;		 Points to first char after last "/" of current dir part)
 29153                                  ;	[THISCDS] Points to CDS being used
 29154                                  ;	[CREATING] and [DELALL] set
 29155                                  ; Function:
 29156                                  ;	Parse path name
 29157                                  ; Outputs:
 29158                                  ;	ID1 field of [THISCDS] updated appropriately
 29159                                  ;	[ATTRIB] = [SATTRIB]
 29160                                  ;	ES:BP Points to DPB
 29161                                  ;	[THISDPB] = ES:BP
 29162                                  ;	Carry set if bad path
 29163                                  ;	   SI Points to path element causing failure
 29164                                  ;	   Zero set
 29165                                  ;	      [DIRSTART],[DIRSEC],[CLUSNUM], and [CLUSFAC] are set up to
 29166                                  ;	      start a search on the last directory
 29167                                  ;	      CL is zero if there is a bad name in the path
 29168                                  ;	      CL is non-zero if the name was simply not found
 29169                                  ;		 [ENTFREE] may have free spot in directory
 29170                                  ;		 [NAME1] is the name.
 29171                                  ;		 CL = 81H if '*'s or '?' in NAME1, 80H otherwise
 29172                                  ;	   Zero reset
 29173                                  ;	      File in middle of path or bad name in path
 29174                                  ;		or path too long or malformed path
 29175                                  ;	ELSE
 29176                                  ;	   [CURBUF] contains directory record with match
 29177                                  ;	   [CURBUF+2]:BX Points into [CURBUF] to start of entry
 29178                                  ;	   [CURBUF+2]:SI Points to fcb_FIRCLUS field for entry
 29179                                  ;	   [NAME1] Has name looked for
 29180                                  ;	   AH = device ID
 29181                                  ;	      bit 7 of AH set if device SI and BX
 29182                                  ;	      will point DOSGROUP relative The firclus
 29183                                  ;	      field of the device entry contains the device pointer
 29184                                  ;	   If last element is a directory zero is set and:
 29185                                  ;	      [DIRSTART],[SECCLUSPOS],[DIRSEC],[CLUSNUM], and [CLUSFAC]
 29186                                  ;	      are set up to start a search on it,
 29187                                  ;	      unless [NoSetDir] is non zero in which case the return is
 29188                                  ;	      like that for a file (except for zero flag)
 29189                                  ;	   If last element is a file zero is reset
 29190                                  ;	      [DIRSEC],[CLUSNUM],[CLUSFAC],[NXTCLUSNUM],[SECCLUSPOS],
 29191                                  ;	      [LASTENT], [ENTLAST] are set to continue search of last
 29192                                  ;	      directory for furthur matches on NAME1 via the NEXTENT
 29193                                  ;	      entry point in FindEntry (or GETENT entry in GETENTRY in
 29194                                  ;	      which case [NXTCLUSNUM] and [SECCLUSPOS] need not be valid)
 29195                                  ; Destroys all other registers
 29196                                  
 29197                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 29198                                  	; DOSCODE:7F58h (MSDOS 5.0, MSDOS.SYS)
 29199                                  
 29200                                  	; 15/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 29201                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:8CAEh
 29202                                  
 29203                                      	;entry	FINDPATH
 29204                                  FINDPATH:
 29205 00004C33 06                      	PUSH	ES			; Save ES:BP
 29206 00004C34 56                      	PUSH	SI
 29207 00004C35 89F7                    	MOV	DI,SI
 29208 00004C37 8B0E[C205]              	MOV	CX,[DIRSTART]		; Get start clus of dir being searched
 29209 00004C3B 833E[B605]FF            	CMP	word [CURR_DIR_END],-1
 29210 00004C40 7415                    	JZ	short NOIDS		; No current dir part
 29211 00004C42 3B3E[B605]              	CMP	DI,[CURR_DIR_END]
 29212 00004C46 750F                    	JNZ	short NOIDS		; Not to current dir end yet
 29213 00004C48 C43E[A205]              	LES	DI,[THISCDS]
 29214                                  	;;;
 29215                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29216 00004C4C A1[DC0A]                	mov	ax,[DIRSTART_HW]
 29217                                  	;mov	[es:di+4Bh],ax
 29218 00004C4F 2689454B                	mov	[es:di+curdir.ID+2],ax
 29219                                  	;;;
 29220                                  	;mov	[es:di+73],cx
 29221 00004C53 26894D49                	MOV	[ES:DI+curdir.ID],CX	; Set current directory cluster
 29222                                  NOIDS:
 29223                                  
 29224                                  ; Parse the name off of DS:SI into NAME1. AL = 1 if there was a meta
 29225                                  ; character in the string. CX,DI may be destroyed.
 29226                                  ;
 29227                                  ;	invoke	NAMETRANS
 29228                                  ;	MOV	CL,AL
 29229                                  ;
 29230                                  ; The above is the slow method. The name has *already* been munged by
 29231                                  ; TransPath so no special casing needs to be done. All we do is try to copy
 29232                                  ; the name until ., \ or 0 is hit.
 29233                                  
 29234                                  	;MOV	AX,SS
 29235                                  	;MOV	ES,AX
 29236                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29237 00004C57 16                      	push	ss
 29238 00004C58 07                      	pop	es
 29239                                  
 29240                                  ;hkn; Name1 is in DOSDATA
 29241 00004C59 BF[4B05]                	MOV	DI,NAME1
 29242 00004C5C B82020                  	MOV	AX,'  ' ; 2020h
 29243 00004C5F AA                      	STOSB
 29244 00004C60 AB                      	STOSW
 29245 00004C61 AB                      	STOSW
 29246 00004C62 AB                      	STOSW
 29247 00004C63 AB                      	STOSW
 29248 00004C64 AB                      	STOSW
 29249                                  
 29250                                  ;hkn; Name1 is in DOSDATA
 29251 00004C65 BF[4B05]                	MOV	DI,NAME1
 29252 00004C68 30E4                    	XOR	AH,AH			; bits for CL
 29253                                  GetNam:
 29254                                  	; 19/05/2019 - Retro DOS v4.0
 29255                                  	;INC	CL ; ?*! ; MSDOS 6.0	;AN000; KK increment volid count
 29256                                  
 29257                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 29258                                  	; 16/12/2022
 29259                                  	;inc	cl ; not required !	
 29260                                  	
 29261 00004C6A AC                      	LODSB
 29262 00004C6B 3C2E                    	CMP	AL,'.'	; 2Eh
 29263 00004C6D 7412                    	JZ	short _SetExt
 29264 00004C6F 08C0                    	OR	AL,AL
 29265 00004C71 7424                    	JZ	short _GetDone
 29266 00004C73 3C5C                    	CMP	AL,'\'	; 5Ch
 29267 00004C75 7420                    	JZ	short _GetDone
 29268 00004C77 3C3F                    	CMP	AL,'?'	; 3Fh
 29269 00004C79 7503                    	JNZ	short StoNam
 29270 00004C7B 80CC01                  	OR	AH,1
 29271                                  StoNam: 
 29272 00004C7E AA                      	STOSB
 29273 00004C7F EBE9                    	JMP	short GetNam
 29274                                  _SetExt:
 29275 00004C81 BF[5305]                	MOV	DI,NAME1+8
 29276                                  GetExt:
 29277 00004C84 AC                      	LODSB
 29278 00004C85 08C0                    	OR	AL,AL
 29279 00004C87 740E                    	JZ	short _GetDone
 29280 00004C89 3C5C                    	CMP	AL,'\'
 29281 00004C8B 740A                    	JZ	short _GetDone
 29282 00004C8D 3C3F                    	CMP	AL,'?'
 29283 00004C8F 7503                    	JNZ	short StoExt
 29284 00004C91 80CC01                  	OR	AH,1
 29285                                  StoExt: 
 29286 00004C94 AA                      	STOSB
 29287 00004C95 EBED                    	JMP	short GetExt
 29288                                  _GetDone:
 29289 00004C97 4E                      	DEC	SI
 29290 00004C98 88E1                    	MOV	CL,AH  ; 0 or 1 ; 29/12/2022
 29291 00004C9A 80C980                  	OR	CL,80H
 29292 00004C9D 5F                      	POP	DI			; Start of this element
 29293 00004C9E 07                      	POP	ES			; Restore ES:BP
 29294 00004C9F 39FE                    	CMP	SI,DI
 29295 00004CA1 7503                    	JNZ	short check_device
 29296 00004CA3 E9F000                  	JMP	_BADPATH		; NUL parse (two delims most likely)
 29297                                  check_device:
 29298 00004CA6 56                      	PUSH	SI			; Start of next element
 29299                                  	;MOV	AL,[SI]
 29300                                  	; 15/02/2024
 29301 00004CA7 08C0                    	OR	AL,AL
 29302                                  	; 23/09/2023
 29303                                  	;cmp	byte [si],0
 29304 00004CA9 7508                    	JNZ	short NOT_LAST
 29305                                  
 29306                                  ; for last element of the path switch to the correct search attributes
 29307                                  
 29308 00004CAB 8A3E[6D05]              	MOV	BH,[SATTRIB]
 29309 00004CAF 883E[6B05]              	MOV	[ATTRIB],BH
 29310                                  
 29311                                  NOT_LAST:
 29312                                  
 29313                                  ; check name1 to see if we have a device...
 29314                                  
 29315 00004CB3 06                      	PUSH	ES			; Save ES:BP
 29316                                  
 29317                                  ;hkn; SS is DOSDATA
 29318                                  	;context ES
 29319 00004CB4 16                      	push	ss
 29320 00004CB5 07                      	pop	es
 29321 00004CB6 E83601                  	call	DEVNAME 		; blast BX
 29322 00004CB9 07                      	POP	ES			; Restore ES:BP
 29323 00004CBA 720B                    	JC	short FindFile		; Not a device
 29324 00004CBC 08C0                    	OR	AL,AL			; Test next char again
 29325 00004CBE 7403                    	JZ	short GO_BDEV
 29326 00004CC0 E9D700                  	JMP	FILEINPATH		; Device name in middle of path
 29327                                  
 29328                                  GO_BDEV:
 29329 00004CC3 5E                      	POP	SI			; Points to NUL at end of path
 29330 00004CC4 E97EFE                  	JMP	Build_devJ
 29331                                  
 29332                                  FindFile:
 29333                                  ;;;; 7/28/86
 29334 00004CC7 803E[4B05]E5            	CMP	BYTE [NAME1],0E5H	; if 1st char = E5
 29335 00004CCC 7505                    	JNZ	short NOE5		; no
 29336 00004CCE C606[4B05]05            	MOV	BYTE [NAME1],05H	; change it to 05
 29337                                  NOE5:
 29338                                  ;;;; 7/28/86
 29339 00004CD3 57                      	PUSH	DI			; Start of this element
 29340 00004CD4 06                      	PUSH	ES			; Save ES:BP
 29341 00004CD5 51                      	PUSH	CX			; CL return from NameTrans
 29342                                  ;DOS 3.3 FastOPen 6/12/86 F.C.
 29343                                  
 29344 00004CD6 E8B502                  	CALL	LookupPath		; call fastopen to get dir entry
 29345 00004CD9 7303                    	JNC	short DIR_FOUND		; found dir entry
 29346                                  
 29347                                  ;DOS 3.3 FastOPen 6/12/86 F.C.
 29348 00004CDB E86FFA                  	call	FINDENTRY
 29349                                  DIR_FOUND:
 29350 00004CDE 59                      	POP	CX
 29351 00004CDF 07                      	POP	ES
 29352 00004CE0 5F                      	POP	DI
 29353 00004CE1 7303                    	JNC	short LOAD_BUF
 29354 00004CE3 E9D900                  	JMP	BADPATHPOP
 29355                                  
 29356                                  LOAD_BUF:
 29357 00004CE6 C53E[E205]              	LDS	DI,[CURBUF]
 29358                                  	;test	byte [bx+0Bh],10h
 29359 00004CEA F6470B10                	TEST	BYTE [BX+dir_entry.dir_attr],attr_directory
 29360 00004CEE 7503                    	JNZ	short GO_NEXT 		; DOS 3.3
 29361 00004CF0 E9A700                  	JMP	FILEINPATH		; Error or end of path
 29362                                  
 29363                                  ; if we are not setting the directory, then check for end of string
 29364                                  
 29365                                  GO_NEXT:
 29366                                  ;hkn; SS override
 29367 00004CF3 36803E[4C03]00          	CMP	BYTE [SS:NoSetDir],0
 29368 00004CF9 7423                    	JZ	short SetDir
 29369 00004CFB 89FA                    	MOV	DX,DI			; Save pointer to entry
 29370 00004CFD 8CD9                    	MOV	CX,DS
 29371                                  
 29372                                  ;hkn; SS is DOSDATA
 29373                                  	;context DS
 29374 00004CFF 16                      	push	ss
 29375 00004D00 1F                      	pop	ds
 29376 00004D01 5F                      	POP	DI			; Start of next element
 29377                                  	; 19/05/2019 - Retro DOS v4.0
 29378                                  	; MSDOS 6.0
 29379 00004D02 F606[4611]01            	TEST	byte [FastOpenFlg],FastOpen_Set ;only DOSOPEN can take advantage of
 29380 00004D07 740B                    	JZ	short _nofast			; the FastOpen
 29381 00004D09 F606[4611]02            	TEST	byte [FastOpenFlg],Lookup_Success ; Lookup just happened
 29382 00004D0E 7404                    	JZ	short _nofast			; no
 29383 00004D10 8B3E[9C0D]              	MOV	DI,[Next_Element_Start]	; no need to insert it again
 29384                                  _nofast:
 29385 00004D14 803D00                  	CMP	BYTE [DI],0
 29386                                  	;;JNZ	short NEXT_ONE		; DOS 3.3
 29387                                  	;;JMP	_SETRET  ; retn		; Got it
 29388                                  	;retn	; 05/09/2018
 29389                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 29390                                  	;jmp	_SETRET
 29391                                  	; 16/12/2022
 29392 00004D17 7431                    	jz	short _SETRET
 29393                                  
 29394                                  NEXT_ONE:
 29395 00004D19 57                      	PUSH	DI			; Put start of next element back on stack
 29396 00004D1A 89D7                    	MOV	DI,DX
 29397 00004D1C 8ED9                    	MOV	DS,CX			; Get back pointer to entry
 29398                                  SetDir:
 29399                                  	;;;
 29400                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29401 00004D1E 31D2                    	xor	dx,dx ; 0
 29402                                  	;cmp	[es:bp+0Fh],dx
 29403 00004D20 2639560F                	cmp	[es:bp+DPB.FAT_SIZE],dx ; 0
 29404 00004D24 7503                    	jnz     short SetDir2 ; not FAT32
 29405 00004D26 8B54FA                  	mov     dx,[si-6]		; dir_entry.dir_fclus_hi
 29406                                  SetDir2:
 29407 00004D29 368916[EE0A]            	mov	[ss:ROOTCLUST_HW],dx
 29408                                  	;;;
 29409 00004D2E 8B14                    	MOV	DX,[SI] 		; dir_entry.dir_first
 29410                                  
 29411                                  ;DOS 3.3 FastOPen 6/12/86 F.C.
 29412 00004D30 1E                      	PUSH	DS		      ; save [curbuf+2]
 29413                                  ;hkn; SS is DOSDATA
 29414 00004D31 16                      	push	ss
 29415 00004D32 1F                      	pop	ds		      ; set DS Dosgroup
 29416                                  	;test	byte [FastOpenFlg],2
 29417 00004D33 F606[4611]02            	TEST	byte [FastOpenFlg],Lookup_Success
 29418 00004D38 7411                    	JZ	short DO_NORMAL	      ; fastopen not in memory or path not
 29419 00004D3A 89D3                    	MOV	BX,DX		      ; not found
 29420 00004D3C 8B3E[BC05]              	MOV	DI,[CLUSNUM]	      ; clusnum was set in LookupPath
 29421 00004D40 50                      	PUSH	AX		      ; save device id (AH)
 29422 00004D41 E827FC                  	call	SETDIRSRCH
 29423 00004D44 58                      	POP	AX		      ; restore device id (AH)
 29424 00004D45 83C402                  	ADD	SP,2		      ; pop ds in stack
 29425 00004D48 EB36                    	JMP	short FAST_OPEN_SKIP
 29426                                  
 29427                                  	; 16/12/2022
 29428                                  _SETRET:
 29429 00004D4A C3                      	retn
 29430                                  
 29431                                  DO_NORMAL:
 29432 00004D4B 1F                      	POP	DS			; DS = [curbuf + 2]
 29433                                  ;DOS 3.3 FastOPen 6/12/86 F.C.
 29434                                  
 29435 00004D4C 29FB                    	SUB	BX,DI			; Offset into sector of start of entry
 29436 00004D4E 29FE                    	SUB	SI,DI			; Offset into sector of dir_first
 29437 00004D50 53                      	PUSH	BX
 29438 00004D51 50                      	PUSH	AX
 29439 00004D52 56                      	PUSH	SI
 29440 00004D53 51                      	PUSH	CX
 29441                                  
 29442                                  ; 15/02/2024
 29443                                  %if 0
 29444                                  	;push	word [di+6]
 29445                                  	PUSH	WORD [DI+BUFFINFO.buf_sector]	;AN000;>32mb
 29446                                  	; 19/05/2019
 29447                                  	; MSDOS 6.0
 29448                                  	;push	word [di+8]
 29449                                  	PUSH	WORD [DI+BUFFINFO.buf_sector+2]	;AN000;>32mb
 29450                                  %else	
 29451                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29452                                  	;lds	bx,[di+6]
 29453 00004D54 C55D06                  	lds	bx,[di+BUFFINFO.buf_sector]
 29454 00004D57 53                      	push	bx
 29455 00004D58 1E                      	push	ds
 29456                                  %endif
 29457                                  
 29458 00004D59 89D3                    	MOV	BX,DX
 29459                                  
 29460                                  ;hkn; SS is DOSDATA
 29461                                  	;context DS
 29462 00004D5B 16                      	push	ss
 29463 00004D5C 1F                      	pop	ds
 29464                                  	;invoke	SETDIRSRCH		; This uses UNPACK which might blow
 29465 00004D5D E80BFC                  	call	SETDIRSRCH		; the entry sector buffer
 29466                                  	; 19/05/2019
 29467                                  	; MSDOS 6.0
 29468 00004D60 8F06[0706]              	POP	word [HIGH_SECTOR]
 29469 00004D64 5A                      	POP	DX
 29470 00004D65 7203                    	JC	short SKIP_GETB
 29471                                  	; 22/09/2023
 29472                                  	;;mov	byte [ALLOWED],18h
 29473                                  	;MOV	byte [ALLOWED],Allowed_RETRY+Allowed_FAIL ; *
 29474                                  	;XOR	AL,AL ; *
 29475                                  	;;invoke GETBUFFR		; Get the entry buffer back
 29476                                  	;call	GETBUFFR
 29477 00004D67 E8EF1B                  	call	GETBUFFER ; * ; pre-read
 29478                                  SKIP_GETB:
 29479 00004D6A 59                      	POP	CX
 29480 00004D6B 5E                      	POP	SI
 29481 00004D6C 58                      	POP	AX
 29482 00004D6D 5B                      	POP	BX
 29483 00004D6E 7305                    	JNC	short SET_THE_BUF
 29484 00004D70 5F                      	POP	DI			; Start of next element
 29485 00004D71 89FE                    	MOV	SI,DI			; Point with SI
 29486 00004D73 EB21                    	JMP	SHORT _BADPATH
 29487                                  
 29488                                  SET_THE_BUF:
 29489 00004D75 E80BF2                  	call	SET_BUF_AS_DIR
 29490 00004D78 8B3E[E205]              	MOV	DI,[CURBUF]
 29491 00004D7C 01FE                    	ADD	SI,DI			; Get the offsets back
 29492 00004D7E 01FB                    	ADD	BX,DI
 29493                                  ; DOS 3.3 FastOpen 6/12/86  F.C.
 29494                                  FAST_OPEN_SKIP:
 29495 00004D80 5F                      	POP	DI			; Start of next element
 29496 00004D81 E8CA02                  	CALL	InsertPath		; insert dir entry info
 29497                                  ; DOS 3.3 FastOpen 6/12/86  F.C.
 29498 00004D84 8A05                    	MOV	AL,[DI]
 29499 00004D86 08C0                    	OR	AL,AL
 29500 00004D88 74C0                    	JZ	short _SETRET		; At end
 29501 00004D8A 47                      	INC	DI			; Skip over "/"
 29502 00004D8B 89FE                    	MOV	SI,DI			; Point with SI
 29503 00004D8D E88710                  	call	PATHCHRCMP
 29504 00004D90 7503                    	JNZ	short find_bad_name	; oops
 29505 00004D92 E99EFE                  	JMP	FINDPATH		; Next element
 29506                                  
 29507                                  find_bad_name:
 29508 00004D95 4E                      	DEC	SI			; Undo above INC to get failure point
 29509                                  _BADPATH:
 29510 00004D96 30C9                    	XOR	CL,CL			; Set zero
 29511 00004D98 EB2C                    	JMP	SHORT BADPRET
 29512                                  
 29513                                  FILEINPATH:
 29514 00004D9A 5F                      	POP	DI			; Start of next element
 29515                                  
 29516                                  ;hkn; SS is DOSDATA
 29517                                  	;context DS			; Got to from one place with DS gone
 29518 00004D9B 16                      	push	ss
 29519 00004D9C 1F                      	pop	ds
 29520                                  
 29521                                  ; DOS 3.3 FastOpen
 29522                                  	;test	byte [FastOpenFlg],1
 29523 00004D9D F606[4611]01            	TEST	byte [FastOpenFlg],FastOpen_Set  ; do this here is we don't want to
 29524 00004DA2 740B                    	JZ	short NO_FAST		; device info to fastopen
 29525                                  	;test	byte [FastOpenFlg],2
 29526 00004DA4 F606[4611]02            	TEST	byte [FastOpenFlg],Lookup_Success
 29527 00004DA9 7404                    	JZ	short NO_FAST
 29528 00004DAB 8B3E[9C0D]              	MOV	DI,[Next_Element_Start]  ; This takes care of one time lookup
 29529                                  					 ; success
 29530                                  NO_FAST:
 29531                                  ; DOS 3.3 FastOpen
 29532 00004DAF 8A05                    	MOV	AL,[DI]
 29533 00004DB1 08C0                    	OR	AL,AL
 29534 00004DB3 7404                    	JZ	short INCRET
 29535 00004DB5 89FE                    	MOV	SI,DI			; Path too long
 29536 00004DB7 EB0D                    	JMP	SHORT BADPRET
 29537                                  
 29538                                  INCRET:
 29539                                  ; DOS 3.3 FasOpen 6/12/86  F.C.
 29540                                  
 29541 00004DB9 E89202                  	CALL   InsertPath		; insert dir entry info
 29542                                  
 29543                                  ; DOS 3.3 FasOpen 6/12/86  F.C.
 29544 00004DBC FEC0                    	INC	AL			; Reset zero
 29545                                  	; 16/12/2022	
 29546                                  ;_SETRET:
 29547 00004DBE C3                      	retn
 29548                                  
 29549                                  BADPATHPOP:
 29550 00004DBF 5E                      	POP	SI			; Start of next element
 29551 00004DC0 8A04                    	MOV	AL,[SI]
 29552 00004DC2 89FE                    	MOV	SI,DI			; Start of bad element
 29553 00004DC4 08C0                    	OR	AL,AL			; zero if bad element is last, non-zero if path too long
 29554                                  BADPRET:
 29555 00004DC6 A0[6D05]                	MOV	AL,[SATTRIB]
 29556 00004DC9 A2[6B05]                	MOV	[ATTRIB],AL		; Make sure return correct
 29557 00004DCC F9                      	STC
 29558 00004DCD C3                      	retn
 29559                                  
 29560                                  ;Break	<STARTSRCH -- INITIATE DIRECTORY SEARCH>
 29561                                  ;---------------------------------------------------------------------------
 29562                                  ;
 29563                                  ; Procedure Name : STARTSRCH
 29564                                  ;
 29565                                  ; Inputs:
 29566                                  ;	[THISDPB] Set
 29567                                  ; Function:
 29568                                  ;	Set up a search for GETENTRY and NEXTENTRY
 29569                                  ; Outputs:
 29570                                  ;	ES:BP = Drive parameters
 29571                                  ;	Sets up LASTENT, ENTFREE=ENTLAST=-1, VOLID=0
 29572                                  ; Destroys ES,BP,AX
 29573                                  ;--------------------------------------------------------------------------
 29574                                  
 29575                                  STARTSRCH:
 29576 00004DCE C42E[8A05]              	LES	BP,[THISDPB]
 29577 00004DD2 31C0                    	XOR	AX,AX
 29578 00004DD4 A3[4803]                	MOV	[LASTENT],AX
 29579 00004DD7 A2[7B05]                	MOV	[VOLID],AL		; No volume ID found
 29580 00004DDA 48                      	DEC	AX
 29581 00004DDB A3[D805]                	MOV	[ENTFREE],AX
 29582 00004DDE A3[DA05]                	MOV	[ENTLAST],AX
 29583 00004DE1 C3                      	retn
 29584                                  
 29585                                  ;BREAK <MatchAttributes - the final check for attribute matching>
 29586                                  ;----------------------------------------------------------------------------
 29587                                  ; Procedure Name : MatchAttributes
 29588                                  ;
 29589                                  ; Input:    [Attrib] = attribute to search for
 29590                                  ;	    CH = found attribute
 29591                                  ; Output:   JZ <match>
 29592                                  ;	    JNZ <nomatch>
 29593                                  ; Registers modified: noneski
 29594                                  ;----------------------------------------------------------------------------
 29595                                  
 29596                                  MatchAttributes:
 29597 00004DE2 50                      	PUSH	AX
 29598                                  
 29599                                  ;hkn; SS override
 29600 00004DE3 36A0[6B05]              	MOV	AL,[ss:ATTRIB]		; AL <- SearchSet
 29601 00004DE7 F6D0                    	NOT	AL			; AL <- SearchSet'
 29602 00004DE9 20E8                    	AND	AL,CH			; AL <- SearchSet' and FoundSet
 29603                                  	;and	al,16h
 29604 00004DEB 2416                    	AND	AL,attr_all	; AL <- SearchSet' and FoundSet and Important
 29605                                  ;
 29606                                  ; the result is non-zero if an attribute is not in the search set
 29607                                  ; and in the found set and in the important set. This means that we do not
 29608                                  ; have a match. Do a JNZ <nomatch> or JZ <match>
 29609                                  ;
 29610 00004DED 58                      	POP	AX
 29611 00004DEE C3                      	retn
 29612                                  
 29613                                  ; 19/05/2019 - Retro DOS v4.0
 29614                                  ; DOSCODE:8148h (MSDOS 6.21, MSDOS.SYS)
 29615                                  
 29616                                  ; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 29617                                  ; DOSCODE:810Dh (MSDOS 5.0, MSDOS.SYS)
 29618                                  
 29619                                  ; 16/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 29620                                  ; DOSCODE:8E74h (PCDOS 7.1, IBMDOS.COM)
 29621                                  
 29622                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8148h)
 29623                                  ; (Windows ME IO.SYS - BIOSCODE:843Ch)
 29624                                  
 29625                                  ;Break <DevName - Look for name of device>
 29626                                  ;---------------------------------------------------------------------------
 29627                                  ;
 29628                                  ; Procedure Name : DevName
 29629                                  ;
 29630                                  ; Inputs:
 29631                                  ;	DS,ES:DOSDATA
 29632                                  ;	Filename in NAME1
 29633                                  ;	ATTRIB set so that we can error out if looking for Volume IDs
 29634                                  ; Function:
 29635                                  ;	Determine if file is in list of I/O drivers
 29636                                  ; Outputs:
 29637                                  ;	Carry set if not a device
 29638                                  ;	ELSE
 29639                                  ;	Zero flag set
 29640                                  ;	BH = Bit 7,6 = 1, bit 5 = 0 (cooked mode)
 29641                                  ;	     bits 0-4 set from low byte of attribute word
 29642                                  ;	DEVPT = DWORD pointer to Device header of device
 29643                                  ; BX destroyed, others preserved
 29644                                  ;---------------------------------------------------------------------------
 29645                                  
 29646                                  DEVNAME:
 29647                                  	; 28/07/2018 - Retro DOS v3.0
 29648                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 49FBh
 29649                                  
 29650 00004DEF 56                      	PUSH	SI
 29651 00004DF0 57                      	PUSH	DI
 29652 00004DF1 51                      	PUSH	CX
 29653 00004DF2 50                      	PUSH	AX
 29654                                  
 29655                                  ; E5 special code
 29656 00004DF3 FF36[4B05]              	PUSH	WORD [NAME1]
 29657 00004DF7 803E[4B05]05            	CMP	byte [NAME1],5
 29658 00004DFC 7505                    	JNZ	short NOKTR
 29659 00004DFE C606[4B05]E5            	MOV	byte [NAME1],0E5h
 29660                                  NOKTR:
 29661                                  	;test	byte [ATTRIB],8
 29662 00004E03 F606[6B05]08            	TEST	byte [ATTRIB],attr_volume_id
 29663                                  					; If looking for VOL id don't find devs
 29664 00004E08 7521                    	JNZ	short RET31
 29665                                  
 29666                                  ;hkn; NULDEV is in DOSDATA
 29667 00004E0A BE[4800]                	MOV	SI,NULDEV
 29668                                  LOOKIO:
 29669                                  	; 21/11/2022
 29670                                  	;test	byte [SI+SYSDEV.ATT+1],80h
 29671                                  	; 17/12/2022
 29672                                  	;test	byte [si+5],80h
 29673 00004E0D F6440580                	test	byte [SI+SYSDEV.ATT+1],(DEVTYP>>8)
 29674                                  	;;test	word [si+4],8000h
 29675                                  	;TEST	word [SI+SYSDEV.ATT],DEVTYP
 29676 00004E11 7411                    	JZ	short SKIPDEV 		; Skip block devices (NET and LOCAL)
 29677 00004E13 89F0                    	MOV	AX,SI
 29678                                  	;add	si,10
 29679 00004E15 83C60A                  	ADD	SI,SYSDEV.NAME
 29680                                  
 29681                                  ;hkn; NAME1 is in DOSDATA
 29682 00004E18 BF[4B05]                	MOV	DI,NAME1
 29683 00004E1B B90400                  	MOV	CX,4			; All devices are 8 letters
 29684 00004E1E F3A7                    	REPE	CMPSW			; Check for name in list
 29685 00004E20 89C6                    	MOV	SI,AX
 29686 00004E22 7415                    	JZ	short IOCHK		; Found it?
 29687                                  SKIPDEV:
 29688 00004E24 C534                    	LDS	SI,[SI]			; Get address of next device
 29689 00004E26 83FEFF                  	CMP	SI,-1			; At end of list?
 29690 00004E29 75E2                    	JNZ	short LOOKIO
 29691                                  RET31:	
 29692 00004E2B F9                      	STC				; Not found
 29693                                  RETNV:	
 29694 00004E2C 8CD1                    	MOV	CX,SS
 29695 00004E2E 8ED9                    	MOV	DS,CX
 29696                                  
 29697 00004E30 8F06[4B05]              	POP	WORD [NAME1]
 29698 00004E34 58                      	POP	AX
 29699 00004E35 59                      	POP	CX
 29700 00004E36 5F                      	POP	DI
 29701 00004E37 5E                      	POP	SI
 29702 00004E38 C3                      	RETN
 29703                                  
 29704                                  IOCHK:
 29705                                  ;hkn; SS override for DEVPT
 29706 00004E39 368C1E[9C05]            	MOV	[SS:DEVPT+2],DS		; Save pointer to device
 29707                                  	;mov	bh,[si+4]
 29708 00004E3E 8A7C04                  	MOV	BH,[SI+SYSDEV.ATT]
 29709 00004E41 80CFC0                  	OR	BH,0C0h
 29710 00004E44 80E7DF                  	and	bh,0DFh
 29711                                  	;AND	BH,~(020h)		; Clears Carry
 29712 00004E47 368936[9A05]            	MOV	[SS:DEVPT],SI
 29713 00004E4C EBDE                    	JMP	short RETNV
 29714                                  
 29715                                  ;BREAK <Build_device_ent - Make a Directory entry>
 29716                                  ;---------------------------------------------------------------------------
 29717                                  ; Procedure Name : Build_device_ent
 29718                                  ;
 29719                                  ; Inputs:
 29720                                  ;	[NAME1] has name
 29721                                  ;	BH is attribute field (supplied by DEVNAME)
 29722                                  ;	[DEVPT] points to device header (supplied by DEVNAME)
 29723                                  ; Function:
 29724                                  ;	Build a directory entry for a device at DEVFCB
 29725                                  ; Outputs:
 29726                                  ;	BX points to DEVFCB
 29727                                  ;	SI points to dir_first field
 29728                                  ;	AH = input BH
 29729                                  ;	AL = 0
 29730                                  ;	dir_first = DEVPT
 29731                                  ;	Zero Set, Carry Clear
 29732                                  ; DS,ES,BP preserved, others destroyed
 29733                                  ;--------------------------------------------------------------------------
 29734                                  
 29735                                  Build_device_ent:
 29736 00004E4E B82020                  	MOV	AX,"  " ; 2020h
 29737                                  
 29738                                  ;hkn; DEVFCB is in DOSDATA
 29739 00004E51 BF[5305]                	MOV	DI,DEVFCB+8		; Point to extent field
 29740                                  
 29741                                  ;	Fill dir_ext  BUGBUG - use ERRNZs for this stuff!
 29742                                  
 29743 00004E54 AB                      	STOSW
 29744 00004E55 AA                      	STOSB				; Blank out extent field
 29745                                  	;mov	al,40h
 29746 00004E56 B040                    	MOV	AL,attr_device
 29747                                  
 29748                                  ;	Fill Dir_attr
 29749                                  
 29750 00004E58 AA                      	STOSB				; Set attribute field
 29751 00004E59 31C0                    	XOR	AX,AX
 29752 00004E5B B90A00                  	MOV	CX,10
 29753                                  
 29754                                  ; Fill dir_pad
 29755                                  
 29756 00004E5E F3AB                    	REP	STOSW			; Fill rest with zeros
 29757 00004E60 E8F9BC                  	call	DATE16
 29758                                  
 29759                                  ;hkn; DEVFCB is in DOSDATA
 29760 00004E63 BF[6105]                	MOV	DI,DEVFCB+dir_entry.dir_time ; 09/08/2018
 29761 00004E66 92                      	XCHG	AX,DX
 29762                                  
 29763                                  ; Fill dir_time
 29764                                  
 29765 00004E67 AB                      	STOSW
 29766 00004E68 92                      	XCHG	AX,DX
 29767                                  
 29768                                  ; Fill dir_date
 29769                                  
 29770 00004E69 AB                      	STOSW
 29771 00004E6A 89FE                    	MOV	SI,DI			; SI points to dir_first field
 29772 00004E6C A1[9A05]                	MOV	AX,[DEVPT]
 29773                                  
 29774                                  ; Fill dir_first
 29775                                  
 29776 00004E6F AB                      	STOSW				; Dir_first points to device
 29777 00004E70 A1[9C05]                	MOV	AX,[DEVPT+2]
 29778                                  ;
 29779                                  ; Fill dir_size_l
 29780                                  ;
 29781 00004E73 AB                      	STOSW
 29782 00004E74 88FC                    	MOV	AH,BH			; Put device atts in AH
 29783                                  
 29784                                  ;hkn; DEVFCB is in DOSDATA
 29785 00004E76 BB[4B05]                	MOV	BX,DEVFCB
 29786 00004E79 30C0                    	XOR	AL,AL			; Set zero, clear carry
 29787 00004E7B C3                      	retn
 29788                                  
 29789                                  ;Break	<ValidateCDS - given a CDS, validate the media and the current directory>
 29790                                  ;----------------------------------------------------------------------------
 29791                                  ;
 29792                                  ;   ValidateCDS - Get current CDS. Splice it. Call FatReadCDS to check
 29793                                  ;   media. If media has been changed, do DOS_Chdir to validate path.
 29794                                  ;   If invalid, reset original CDS to root.
 29795                                  ;
 29796                                  ;   Inputs:	ThisCDS points to CDS of interest
 29797                                  ;		SS:DI points to temp buffer
 29798                                  ;   Outputs:	The current directory string is validated on the appropriate
 29799                                  ;		    drive
 29800                                  ;		ThisDPB changed
 29801                                  ;		ES:DI point to CDS
 29802                                  ;		Carry set if error (currently user FAILed to I 24)
 29803                                  ;   Registers modified: all
 29804                                  ;----------------------------------------------------------------------------
 29805                                  
 29806                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 29807                                  	; DOSCODE:819Bh (MSDOS 5.0, MSDOS.SYS)
 29808                                  
 29809                                  	; 16/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 29810                                  	; DOSCODE:8F01h (PCDOS 7.1, IBMDOS.COM)
 29811                                  
 29812                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:81D6h)
 29813                                  	; (Windows ME IO.SYS - BIOSCODE:84CBh)
 29814                                  
 29815                                  ValidateCDS:
 29816                                  	; 19/05/2019 - Retro DOS v4.0
 29817                                  	; 28/07/2018 - Retro DOS v3.0
 29818                                  
 29819                                     %define  Temp	[bp-2]	; word
 29820                                     %define  SaveCDS	[bp-6]	; dword
 29821                                     %define  SaveCDSL	[bp-6]	; word
 29822                                     %define  SaveCDSH	[bp-4]	; word
 29823                                  
 29824                                  	;Enter
 29825 00004E7C 55                      	push	bp
 29826 00004E7D 89E5                    	mov	bp,sp
 29827 00004E7F 83EC06                  	sub	sp,6
 29828                                  
 29829 00004E82 897EFE                  	MOV	Temp,DI
 29830                                  
 29831                                  ;hkn; SS override
 29832 00004E85 36C536[A205]            	LDS	SI,[SS:THISCDS]
 29833 00004E8A 8976FA                  	MOV	SaveCDSL,SI
 29834 00004E8D 8C5EFC                  	MOV	SaveCDSH,DS
 29835                                  	;EnterCrit critDisk
 29836 00004E90 E850CA                  	call	ECritDisk
 29837                                  	; 21/11/2022
 29838                                  	;test	byte [SI+curdir.flags+1],80h
 29839                                  	;test	word [si+67],8000h
 29840                                  	; 17/12/2022
 29841                                  	;test	byte [SI+68],80h
 29842 00004E93 F6444480                	test	byte [SI+curdir.flags+1],(curdir_isnet>>8)
 29843                                  	;TEST	word [SI+curdir.flags],curdir_isnet	; Clears carry
 29844 00004E97 7403                    	JZ	short _DoSplice
 29845 00004E99 E9A300                  	JMP	FatFail
 29846                                  _DoSplice:
 29847 00004E9C 30D2                    	XOR	DL,DL
 29848 00004E9E 368616[4C03]            	XCHG	DL,[SS:NoSetDir]
 29849                                  
 29850                                  ;hkn; SS is DOSDATA
 29851                                  	;Context ES
 29852 00004EA3 16                      	push	ss
 29853 00004EA4 07                      	pop	es
 29854                                  	;Invoke	FStrcpy
 29855 00004EA5 E810C9                  	call	FStrCpy
 29856 00004EA8 8B76FE                  	MOV	SI,Temp
 29857                                  
 29858                                  ;hkn; SS is DOSDATA
 29859                                  	;Context DS
 29860 00004EAB 16                      	push	ss
 29861 00004EAC 1F                      	pop	ds	
 29862                                  	;Invoke	Splice
 29863 00004EAD E86230                  	call	Splice
 29864                                  
 29865                                   ;hkn; SS is DOSDATA
 29866                                  	;Context DS			;   FatReadCDS (ThisCDS);
 29867 00004EB0 16                      	push	ss
 29868 00004EB1 1F                      	pop	ds
 29869 00004EB2 8816[4C03]              	MOV	[NoSetDir],DL
 29870 00004EB6 C43E[A205]              	LES	DI,[THISCDS]
 29871                                  	;SAVE	<BP>
 29872 00004EBA 55                      	push	bp
 29873                                  	;Invoke	FATREAD_CDS
 29874 00004EBB E8CD16                  	call	FATREAD_CDS	
 29875                                  	;RESTORE <BP>
 29876 00004EBE 5D                      	pop	bp
 29877 00004EBF 727E                    	JC	short FatFail
 29878                                  
 29879 00004EC1 C536[A205]              	LDS	SI,[THISCDS]		;   if (ThisCDS->ID == -1) {
 29880                                  
 29881                                  	;;;
 29882                                  	; 16/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29883                                  	;cmp	word [si+4Bh],0FFFFh
 29884 00004EC5 837C4BFF                	cmp	word [si+curdir.ID+2],-1
 29885 00004EC9 7566                    	jnz	short RestoreCDS
 29886                                  	;;;
 29887                                  	
 29888                                  	;cmp	word [si+73],-1
 29889 00004ECB 837C49FF                	CMP	word [SI+curdir.ID],-1
 29890 00004ECF 7560                    	JNZ	short RestoreCDS
 29891                                  
 29892                                  ;hkn; SS is DOSDATA
 29893                                  	;Context ES
 29894 00004ED1 16                      	push	ss
 29895 00004ED2 07                      	pop	es
 29896                                  
 29897                                  ;hkn; SS override
 29898                                  	;SAVE	<wfp_Start>		;	t = wfp_Start;
 29899 00004ED3 36FF36[B205]            	push	word [SS:WFP_START]
 29900                                  	;cmp	si,[bp-6]
 29901 00004ED8 3B76FA                  	CMP	SI,SaveCDSL		; if not spliced
 29902 00004EDB 750B                    	JNZ	short DoChdir
 29903                                  	;mov	di,[bp-2]
 29904 00004EDD 8B7EFE                  	MOV	DI,Temp
 29905                                  
 29906                                  ;hkn; SS override
 29907 00004EE0 36893E[B205]            	MOV	[SS:WFP_START],DI	;	wfp_start = d;
 29908                                  	;Invoke	FStrCpy 		;	strcpy (d, ThisCDS->Text);
 29909 00004EE5 E8D0C8                  	call	FStrCpy
 29910                                  DoChdir:
 29911                                  ;hkn; SS is DOSDATA
 29912                                  	;Context DS
 29913 00004EE8 16                      	push	ss
 29914 00004EE9 1F                      	pop	ds
 29915                                  	;SAVE	<<WORD PTR SAttrib>,BP> ;	c = DOSChDir ();
 29916 00004EEA FF36[6D05]              	push	word [SATTRIB]
 29917 00004EEE 55                      	push	bp
 29918                                  	;Invoke	DOS_ChDir
 29919 00004EEF E842EB                  	call	DOS_CHDIR
 29920                                  	;RESTORE <BP,BX,wfp_start>	;	wfp_Start = t;
 29921 00004EF2 5D                      	pop	bp
 29922 00004EF3 5B                      	pop	bx
 29923 00004EF4 8F06[B205]              	pop	word [WFP_START]
 29924 00004EF8 881E[6D05]              	MOV	[SATTRIB],BL
 29925                                  	;;;
 29926                                  	; 16/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29927 00004EFC 8B3E[DC0A]              	mov	di,[DIRSTART_HW]
 29928                                  	;;;
 29929 00004F00 C576FA                  	LDS	SI,SaveCDS
 29930 00004F03 7311                    	JNC	short SetCluster	;	if (c == -1) {
 29931                                  
 29932                                  ;hkn; SS override for THISCDS
 29933 00004F05 368936[A205]            	MOV	[SS:THISCDS],SI		;	    ThisCDS = TmpCDS;
 29934 00004F0A 368C1E[A405]            	MOV	[SS:THISCDS+2],DS
 29935 00004F0F 31C9                    	XOR	CX,CX			;	    TmpCDS->text[3] = c = 0;
 29936                                  	;;;
 29937                                  	; 16/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29938 00004F11 31FF                    	xor	di,di
 29939                                  	;;;
 29940 00004F13 884C03                  	MOV	[SI+3],CL		;	    }
 29941                                  SetCluster:
 29942                                  	; 16/02/2024
 29943                                  	;;mov	word [si+73],0FFFFh
 29944                                  	;MOV	word [SI+curdir.ID],-1	;	TmpCDS->ID = -1;
 29945                                  	;
 29946 00004F16 36C536[A205]            	LDS	SI,[SS:THISCDS]		;	ThisCDS->ID = c;
 29947                                  	; 21/11/2022
 29948                                  	;test	byte [si+curdir.flags+1],20h
 29949                                  	; 19/05/2019
 29950                                  	; MSDOS 6.0
 29951                                  	; 17/12/2022
 29952                                  	;test	byte [si+68],20h
 29953 00004F1B F6444420                	test	byte [SI+curdir.flags+1],(curdir_splice>>8)	
 29954                                  	;;test	word [si+67],2000h
 29955                                  	;TEST	word [SI+curdir.flags],curdir_splice ;AN000;;MS. for Join and Subst
 29956 00004F1F 7405                    	JZ	short _setdirclus		     ;AN000;;MS.
 29957 00004F21 B9FFFF                  	MOV	CX,-1	; 0FFFFh		     ;AN000;;MS.
 29958                                  	;;;
 29959                                  	; 16/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29960 00004F24 89CF                    	mov	di,cx
 29961                                  	;;;
 29962                                  _setdirclus:
 29963                                  	;;;
 29964                                  	; 16/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29965 00004F26 36893E[DC0A]            	mov	[ss:DIRSTART_HW],di
 29966                                  	;mov	[si+4Bh],di
 29967 00004F2B 897C4B                  	mov	[si+curdir.ID+2],di
 29968                                  	;;;
 29969                                  	;mov	[si+73],cx
 29970 00004F2E 894C49                  	MOV	[SI+curdir.ID],CX	;	}
 29971                                  RestoreCDS:
 29972 00004F31 C47EFA                  	LES	DI,SaveCDS
 29973 00004F34 36893E[A205]            	MOV	[SS:THISCDS],DI
 29974 00004F39 368C06[A405]            	MOV	[SS:THISCDS+2],ES
 29975 00004F3E F8                      	CLC
 29976                                  FatFail:
 29977                                  	;LeaveCrit critDisk
 29978 00004F3F E8CEC9                  	call	LCritDisk
 29979                                  
 29980                                  	;les	di,[bp-6]
 29981 00004F42 C47EFA                  	LES	DI,SaveCDS
 29982                                  	;Leave
 29983 00004F45 89EC                    	mov	sp,bp
 29984 00004F47 5D                      	pop	bp
 29985 00004F48 C3                      	retn
 29986                                  
 29987                                  ; 28/07/2018 - Retro DOS v3.0
 29988                                  ; IBMDOS.COM (MSDOS 3.3, 1987) - offset 43BDh
 29989                                  
 29990                                  ;Break	<CheckThisDevice - Check for being a device>
 29991                                  ;---------------------------------------------------------------------------
 29992                                  ;
 29993                                  ;   CheckThisDevice - Examine the area at DS:SI to see if there is a valid
 29994                                  ;   device specified. We will return carry if there is a device present. 
 29995                                  ;   The forms of devices we will recognize are:
 29996                                  ;
 29997                                  ;	[path]device
 29998                                  ;
 29999                                  ;   Note that the drive letter has *already* been removed. All other forms
 30000                                  ;   are not considered to be devices. If such a device is found we change
 30001                                  ;   the source pointer to point to the device component.
 30002                                  ;
 30003                                  ;   Inputs:	ES is DOSDATA
 30004                                  ;		DS:SI contains name
 30005                                  ;   Outputs:	ES is DOSDATA
 30006                                  ;		DS:SI point to name or device
 30007                                  ;		Carry flag set if device was found
 30008                                  ;		Carry flag reset otherwise
 30009                                  ;   Registers Modified: all except ES:DI, DS
 30010                                  ;----------------------------------------------------------------------------
 30011                                  
 30012                                  CheckThisDevice:
 30013 00004F49 57                      	push	di
 30014 00004F4A 56                      	push	si
 30015 00004F4B 89F7                    	MOV	DI,SI
 30016                                  
 30017                                  ; Check for presence of \dev\ (Dam multiplan!)
 30018                                  
 30019 00004F4D 8A04                    	MOV	AL,[SI]
 30020 00004F4F E8C50E                  	call	PATHCHRCMP		; is it a path char?
 30021 00004F52 7517                    	JNZ	short ParseDev		; no, go attempt to parse device
 30022 00004F54 46                      	INC	SI			; simulate LODSB
 30023                                  
 30024                                  ; We have the leading path separator. Look for DEV part.
 30025                                  
 30026 00004F55 AD                      	LODSW
 30027 00004F56 0D2020                  	OR	AX,2020h
 30028 00004F59 3D6465                  	cmp	ax,"de"
 30029                                  	;CMP	AX,"e"<< 8 + "d"
 30030 00004F5C 752D                    	JNZ	short NotDevice		; not "de", assume not device
 30031 00004F5E AC                      	LODSB
 30032 00004F5F 0C20                    	OR	AL,20h
 30033 00004F61 3C76                    	CMP	AL,"v"                  ; Not "v", assume not device
 30034 00004F63 7526                    	JNZ	short NotDevice
 30035 00004F65 AC                      	LODSB
 30036 00004F66 E8AE0E                  	call	PATHCHRCMP		; do we have the last path separator?
 30037 00004F69 7520                    	JNZ	short NotDevice		; no. go for it.
 30038                                  
 30039                                  ; DS:SI now points to a potential drive. Preserve them as NameTrans advances
 30040                                  ; SI and DevName may destroy DS.
 30041                                  
 30042                                  ParseDev:
 30043 00004F6B 1E                      	push	ds
 30044 00004F6C 56                      	push	si			; preserve the source pointer
 30045 00004F6D E8EB0D                  	call	NameTrans		; advance DS:SI
 30046 00004F70 803C00                  	CMP	BYTE [SI],0		; parse entire string?
 30047 00004F73 F9                      	STC				; simulate a Carry return from DevName
 30048 00004F74 750B                    	JNZ	short SkipSearch	; no parse. simulate a file return.
 30049                                  
 30050                                  ;hkn; SS is DOSDATA
 30051 00004F76 16                      	push	ss
 30052 00004F77 1F                      	pop	ds
 30053                                  
 30054                                  ; M026 - start - fix ported from ROMDOS2 for bug # 2849
 30055                                  ;
 30056                                  ; SR;
 30057                                  ; We have to set Attrib before invoking DevName. Otherwise, the value from
 30058                                  ; a previous DOS call is used and DevName thinks it is not a device if the
 30059                                  ; old call set the volume attribute bit.
 30060                                  
 30061 00004F78 A0[6D05]                	mov	al,[SATTRIB]
 30062 00004F7B A2[6B05]                	mov	[ATTRIB],al		;set Attrib for DevName
 30063                                  
 30064                                  ; M026 - end
 30065                                  
 30066 00004F7E E86EFE                  	call	DEVNAME
 30067                                  
 30068                                  SkipSearch:
 30069 00004F81 5E                      	pop	si
 30070 00004F82 1F                      	pop	ds
 30071                                  
 30072                                  ; SI points to the beginning of the potential device. If we have a device
 30073                                  ; then we do not change SI. If we have a file, then we reset SI back to the
 30074                                  ; original value. At this point Carry set indicates FILE.
 30075                                  
 30076                                  CheckReturn:
 30077 00004F83 5F                      	pop	di			; get original SI
 30078 00004F84 7302                    	JNC	short Check_Done	; if device then do not reset pointer
 30079 00004F86 89FE                    	MOV	SI,DI
 30080                                  Check_Done:
 30081 00004F88 5F                      	pop	di
 30082 00004F89 F5                      	CMC				; invert carry. Carry => device
 30083 00004F8A C3                      	retn
 30084                                  NotDevice:
 30085 00004F8B F9                      	STC
 30086 00004F8C EBF5                    	JMP	short CheckReturn
 30087                                  
 30088                                  ;BREAK <LookupPath - call fastopen to get dir entry info>
 30089                                  ;-----------------------------------------------------------------------------
 30090                                  ;
 30091                                  ; Procedure Name : LookupPath
 30092                                  ;
 30093                                  ; Output  DS:SI -> path name,
 30094                                  ;	  ES:DI -> dir entry info buffer
 30095                                  ;	  ES:CX -> extended dir info buffer
 30096                                  ;
 30097                                  ;	  carry flag clear : tables pointed by ES:DI and ES:CX are filled by
 30098                                  ;			     FastOpen, DS:SI points to char just one after
 30099                                  ;			     the last char of path name which is fully or
 30100                                  ;			     partially found in FastOPen
 30101                                  ;	  carry flag set : FastOpen not in memory or path name not found
 30102                                  ;
 30103                                  ;----------------------------------------------------------------------------
 30104                                  
 30105                                  	; 21/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 30106                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9015h
 30107                                  	
 30108                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:82D9h)
 30109                                  
 30110                                  LookupPath:
 30111                                  ;	PUSH	AX
 30112                                  
 30113                                  ;hkn; SS override
 30114                                  	;test	byte [ss:FastOpenFlg],1
 30115 00004F8E 36F606[4611]01          	TEST	byte [ss:FastOpenFlg],FastOpen_Set  ; flg is set in DOSOPEN
 30116 00004F94 7515                    	JNZ	short FASTINST			    ; and this routine is
 30117                                  NOLOOK:
 30118 00004F96 EB11                    	JMP	NOLOOKUP			    ; executed once
 30119                                  
 30120                                  	; 21/02/2024
 30121                                  NOTFOUND:
 30122 00004F98 83F8FF                  	CMP	AX,-1				    ; not in memory ?
 30123 00004F9B 7506                    	JNZ	short Partial_Success 		    ; yes, in memory
 30124 00004F9D 36C606[4611]00          	MOV	byte [SS:FastOpenFlg],0		    ; no more fastopen
 30125                                  Partial_Success:
 30126                                  	;and	byte [SS:FastOpenFlg],0FBh
 30127 00004FA3 368026[4611]FB          	AND	byte [SS:FastOpenFlg],Special_Fill_Reset
 30128                                  NOLOOKUP:
 30129                                  ;	POP	AX
 30130 00004FA9 F9                      	STC
 30131 00004FAA C3                      	RETN
 30132                                  
 30133                                  FASTINST:
 30134                                  ;hkn; SS override
 30135                                  	;test	byte [ss:FastOpenFlg],8
 30136 00004FAB 36F606[4611]08          	TEST	byte [ss:FastOpenFlg],No_Lookup	    ; no more lookup?
 30137 00004FB1 75E3                    	JNZ	short NOLOOK			    ; yes
 30138                                  
 30139 00004FB3 BB[3C11]                	MOV	BX,FastOpenTable		    ; get fastopen related tab
 30140                                  
 30141                                  ;hkn; SS override
 30142 00004FB6 368B36[B205]            	MOV	SI,[SS:WFP_START]		    ; si points to path name
 30143 00004FBB BF[7C0D]                	MOV	DI,Dir_Info_Buff
 30144 00004FBE B9[4711]                	MOV	CX,FastOpen_Ext_Info
 30145 00004FC1 B001                    	MOV	AL,FONC_Look_up 		    ; al = 1
 30146 00004FC3 1E                      	PUSH	DS
 30147 00004FC4 07                      	POP	ES
 30148                                  
 30149                                  ;hkn; SS override
 30150                                  	;call	far [bx+2]
 30151 00004FC5 FF5F02                  	CALL	far [BX+fastopen_entry.name_caching] ;call fastopen
 30152 00004FC8 72CE                    	JC	short NOTFOUND			    ; fastopen not in memory
 30153                                  
 30154 00004FCA 8D5CFE                  	LEA	BX,[SI-2]
 30155                                  
 30156                                  ;hkn; SS override
 30157 00004FCD 363B1E[B205]            	CMP	BX,[SS:WFP_START]		    ; path found ?
 30158 00004FD2 74C4                    	JZ	short NOTFOUND			    ; no
 30159                                  
 30160                                  	; 19/05/2019 - Retro DOS v4.0
 30161                                  
 30162                                  	; MSDOS 6.0				    ; fully or partially found
 30163 00004FD4 803C00                  	CMP	BYTE [SI],0 ; * ; 21/02/2024	    ;AN000;FO.
 30164 00004FD7 752D                    	JNZ	short parfnd			    ;AN000;FO.; partiallyfound
 30165 00004FD9 51                      	PUSH	CX				    ;AN000;FO.; is attribute matched ?
 30166                                  
 30167                                  ;hkn; SS override for attrib/sattrib
 30168 00004FDA 368A0E[6B05]            	MOV	CL,[ss:ATTRIB]			    ;AN000;FO.;
 30169 00004FDF 368A2E[6D05]            	MOV	CH,[ss:SATTRIB]			    ;AN000;FO.; attrib=sattrib
 30170 00004FE4 36882E[6B05]            	MOV	[ss:ATTRIB],CH			    ;AN000;FO.;
 30171                                  	;mov	ch,[es:di+0Bh]
 30172 00004FE9 268A6D0B                	MOV	CH,[ES:DI+dir_entry.dir_attr]	    ;AN000;FO.;
 30173 00004FED E8F2FD                  	call	MatchAttributes 		    ;AN000;FO.;
 30174                                  ;;;	MOV	[ss:ATTRIB],CL			    ;AN001;FO.; restore attrib
 30175 00004FF0 59                      	POP	CX				    ;AN000;FO.;
 30176 00004FF1 75B6                    	JNZ	short NOLOOKUP			    ;AN000;FO.; not matched
 30177                                  
 30178                                  	; 21/02/2024 - Retro DOS v5.0
 30179                                  	; PCDOS 7.1 IBMDOS.COM
 30180                                  	;;;
 30181 00004FF3 36803E[4C03]00          	cmp	byte [ss:NoSetDir],0
 30182 00004FF9 740B                    	jz	short parfnd
 30183                                  	;
 30184                                  	;cmp	byte [si],0  ; * ; byte [si] = 0
 30185                                  	;jnz	short parfnd
 30186                                  	;
 30187                                  	;test	byte [es:di+0Bh],10h
 30188 00004FFB 26F6450B10              	test	byte [es:di+dir_entry.dir_attr],attr_directory
 30189 00005000 7404                    	jz	short parfnd
 30190 00005002 89CB                    	mov	bx,cx
 30191 00005004 EB1A                    	jmp	short parfnd2
 30192                                  parfnd:
 30193 00005006 89CB                    	mov	bx,cx
 30194                                  	;mov	ax,[bx+0Bh]
 30195 00005008 8B470B                  	mov	ax,[bx+FEI.dirstart]
 30196 0000500B 36A3[C205]              	mov	[ss:DIRSTART],ax
 30197 0000500F 8B4707                  	mov	ax,[bx+7]
 30198 00005012 8B4707                  	mov	ax,[bx+FEI.clusnum+2]
 30199 00005015 36A3[DE0A]              	mov	[ss:CLUSNUM_HW],ax
 30200                                  	;mov	ax,[bx+5]
 30201 00005019 8B4705                  	mov	ax,[bx+FEI.clusnum]
 30202 0000501C 36A3[BC05]              	mov	[ss:CLUSNUM],ax
 30203                                  parfnd2:
 30204 00005020 368936[9C0D]            	mov	[ss:Next_Element_Start],si
 30205                                  	;mov	ax,[bx+9]
 30206 00005025 8B4709                  	mov	ax,[bx+FEI.lastent]
 30207 00005028 36A3[4803]              	mov	[ss:LASTENT],ax
 30208                                  	;;;		
 30209                                  
 30210                                  ; 21/02/2024
 30211                                  %if 0
 30212                                  parfnd:
 30213                                  ;hkn; SS override
 30214                                  	MOV	[SS:Next_Element_Start],SI	    ; save si
 30215                                  	MOV	BX,CX
 30216                                  	; MSDOS 6.0
 30217                                  	;mov	ax,[bx+7]
 30218                                  	MOV	AX,[BX+FEI.lastent]		    ;AN000;;FO. restore lastentry
 30219                                  ;hkn; SS override for LASTENT, DIRSTART, CLUSNUM
 30220                                  	MOV	[SS:LASTENT],AX			    ;AN000;;FO.
 30221                                  	MOV	AX,[BX+FEI.dirstart]		    ;AN001;;FO. restore dirstart
 30222                                  	MOV	[SS:DIRSTART],AX		    ;AN001;;FO.
 30223                                  	; MSDOS 3.3 (& MSDOS 6.0)
 30224                                  	;;mov	ax,[bx+3] ; MSDOS 3.3
 30225                                  	;mov	ax,[bx+5] ; MSDOS 6.0
 30226                                  	MOV	AX,[BX+FEI.clusnum]		    ; restore next cluster num
 30227                                  	MOV	[SS:CLUSNUM],AX			    ;
 30228                                  %endif
 30229                                  
 30230 0000502C 06                      	PUSH	ES				    ; save ES
 30231                                  ;hkn; SS override
 30232 0000502D 36C41E[8A05]            	LES	BX,[SS:THISDPB]			    ; put drive id
 30233 00005032 268A27                  	mov	ah,[ES:BX] ; 15/08/2018
 30234                                  	;MOV	AH,[ES:BX+DPB.DRIVE]		    ; in AH for DOOPEN
 30235 00005035 07                      	POP	ES				    ; pop ES
 30236                                  ;SR;
 30237                                  ; We cannot have a root dir if we have come here. So, we zero out CurBuf to
 30238                                  ;indicate it is not a root dir
 30239                                  
 30240 00005036 36C706[E205]0000        	mov	word [SS:CURBUF],0		    ; indicate not root dir
 30241 0000503D 368C06[E405]            	MOV	WORD [SS:CURBUF+2],ES		    ; [curbuf+2].bx points to
 30242 00005042 89FB                    	MOV	BX,DI				    ; start of entry
 30243                                  	;lea	si,[di+1Ah]
 30244 00005044 8D751A                  	LEA	SI,[DI+dir_entry.dir_first]	    ; [curbuf+2]:si points to
 30245                                  						    ; dir_first field in the
 30246                                  						    ; dir entry
 30247                                  ;hkn; SS override for FastOpenFlg
 30248                                  	;or	byte [ss:FastOpenFlg],12h ; 29/12/2022
 30249 00005047 36800E[4611]12          	OR	byte [SS:FastOpenFlg],Lookup_Success+Set_For_Search
 30250                                  ;	POP	AX
 30251 0000504D C3                      	RETN
 30252                                  
 30253                                  ;BREAK <InsertPath - call fastopen to insert dir entry info>
 30254                                  ;-----------------------------------------------------------------------------
 30255                                  ;
 30256                                  ; Procedure Name : InsertPath
 30257                                  ; Input:  FastOpen_Set flag set when from DOSOPEN otherwise 0
 30258                                  ;	  Lookup_Success flag set when got dir entry info from FASTOPEN
 30259                                  ;	  DS = DOSDATA
 30260                                  ; Output: FastOPen_Ext_Info is set and path dir info is inserted
 30261                                  ;
 30262                                  ;-----------------------------------------------------------------------------
 30263                                  
 30264                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 30265                                  	; 21/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 30266                                  
 30267                                  InsertPath:
 30268 0000504E 9C                      	PUSHF
 30269                                  ;hkn; SS override for FastOpenFlag
 30270                                  	;test	byte [SS:FastOpenFlg], 1
 30271 0000504F 36F606[4611]01          	TEST	byte [SS:FastOpenFlg],FastOpen_Set ;only DOSOPEN can take advantage of
 30272 00005055 747D                    	JZ	short GET_NEXT_ELEMENT		; the FastOpen
 30273                                  	;test	byte [ss:FastOpenFlg],2
 30274 00005057 36F606[4611]02          	TEST	byte [SS:FastOpenFlg],Lookup_Success ; Lookup just happened
 30275 0000505D 740D                    	JZ	short INSERT_DIR_INFO		; no
 30276                                  	;and	byte [ss:FastOpenFlg],0FDh
 30277 0000505F 368026[4611]FD          	AND	byte [SS:FastOpenFlg],Lookup_Reset  ; we got dir info from fastopen so
 30278 00005065 368B3E[9C0D]            	MOV	DI,[SS:Next_Element_Start]	; no need to insert it again
 30279 0000506A EB62                    	JMP	short GET_NEXT2
 30280                                  
 30281                                  INSERT_DIR_INFO:				; save registers
 30282 0000506C 1E                      	PUSH	DS
 30283 0000506D 06                      	PUSH	ES
 30284 0000506E 53                      	PUSH	BX
 30285 0000506F 56                      	PUSH	SI
 30286 00005070 57                      	PUSH	DI
 30287 00005071 51                      	PUSH	CX
 30288 00005072 50                      	PUSH	AX
 30289                                  
 30290                                  ;hkn; SS override
 30291 00005073 36C53E[E205]            	LDS	DI,[SS:CURBUF]			; DS:DI -> buffer header
 30292 00005078 BE[4711]                	MOV	SI,FastOpen_Ext_Info
 30293                                  
 30294                                  ; 21/02/2024
 30295                                  %if 0
 30296                                  	;mov	ax,[di+6]
 30297                                  	MOV	AX,[DI+BUFFINFO.buf_sector]	; get directory sector
 30298                                  	; MSDOS 6.0
 30299                                  	;mov	[ss:si+1],ax
 30300                                  	MOV	[SS:SI+FEI.dirsec],AX 		;AN000; >32mb save dir sector
 30301                                  	; 19/05/2019 - Retro DOS v4.0
 30302                                  	MOV	AX,[DI+BUFFINFO.buf_sector+2]	;AN000; >32mb
 30303                                  
 30304                                  ;hkn; SS is DOSDATA
 30305                                  	push	ss
 30306                                  	pop	ds
 30307                                  	; MSDOS 3.3
 30308                                  	;;mov	[si+1],ax
 30309                                  	;MOV	[SI+FEI.dirsec],AX
 30310                                  	; MSDOS 6.0
 30311                                  	;mov	[si+3],ax
 30312                                  	MOV	[SI+FEI.dirsec+2],AX		;AN000;>32mb save high dir sector
 30313                                  %else
 30314                                  	;lds	ax,[di+6]
 30315 0000507B C54506                  	lds	ax,[di+BUFFINFO.buf_sector]	; get directory sector
 30316                                  	;mov	[ss:si+1],ax
 30317 0000507E 36894401                	mov	[ss:si+FEI.dirsec],ax
 30318                                  	;mov	[ss:si+3],ax
 30319 00005082 368C5C03                	mov	[ss:si+FEI.dirsec+2],ds
 30320 00005086 16                      	push	ss
 30321 00005087 1F                      	pop	ds
 30322                                  %endif
 30323                                  
 30324                                  	; 21/02/2024 (PCDOS 7.1 IBMDOS.COM)
 30325                                  	;;;
 30326 00005088 A1[DE0A]                	mov	ax,[CLUSNUM_HW]
 30327                                  	;mov	[si+7],ax
 30328 0000508B 894407                  	mov	[si+FEI.clusnum+2],ax
 30329                                  	;;;
 30330                                  
 30331                                  	; MSDOS 3.3 (& MSDOS 6.0)
 30332 0000508E A1[BC05]                	MOV	AX,[CLUSNUM]		; save next cluster number
 30333                                  	;;mov	[si+5],ax ; MSDOS 6.0
 30334                                  	;mov	[si+3],ax ; MSDOS 3.3
 30335 00005091 894405                  	MOV	[SI+FEI.clusnum],AX
 30336                                  	; MSDOS 6.0
 30337 00005094 A1[4803]                	MOV	AX,[LASTENT]		;AN000;FO. save lastentry for search first
 30338                                  	;;mov	[si+7],ax
 30339                                  	;mov	[si+9],ax ; PCDOS 7.1 ; 21/02/2024
 30340 00005097 894409                  	MOV	[SI+FEI.lastent],AX	;AN000;FO.
 30341 0000509A A1[C205]                	MOV	AX,[DIRSTART]		;AN001;FO. save  for search first
 30342                                  	;;mov	[si+9],ax
 30343                                  	;mov	[si+11],ax ; PCDOS 7.1 ; 21/02/2024
 30344 0000509D 89440B                  	MOV	[SI+FEI.dirstart],AX	;AN001;FO.
 30345                                  
 30346                                  	; MSDOS 3.3 (& MSDOS 6.0)
 30347 000050A0 89D8                    	MOV	AX,BX
 30348                                  	;;;add	di,16  ; MSDOS 3.3
 30349                                  	;;add	di,20  ; MSDOS 6.0
 30350                                  	;add	di,24  ; PCDOS 7.1 ; 21/02/2024	
 30351 000050A2 83C718                  	ADD	DI,BUFINSIZ		; DS:DI -> start of data in buffer
 30352 000050A5 29F8                    	SUB	AX,DI			; AX=BX relative to start of sector
 30353                                  	;mov	cl,32
 30354 000050A7 B120                    	MOV	CL,dir_entry.size
 30355 000050A9 F6F1                    	DIV	CL
 30356                                  	;MOV	[SI+FEI.dirpos],AL	; save directory entry # in buffer
 30357 000050AB 8804                    	mov	[si],al
 30358                                  
 30359 000050AD 1E                      	PUSH	DS
 30360 000050AE 07                      	POP	ES
 30361                                  
 30362 000050AF 8E1E[E405]              	MOV	DS,[CURBUF+2]
 30363 000050B3 89DF                    	MOV	DI,BX			; DS:DI -> dir entry info
 30364                                  	;cmp	word [di+1Ah],0
 30365 000050B5 837D1A00                	CMP	word [DI+dir_entry.dir_first],0 
 30366                                  					; never insert info when file is empty
 30367 000050B9 740C                    	JZ	short SKIP_INSERT	; e.g. newly created file
 30368                                  
 30369                                  	; 21/02/2024 - Erdogan Tan
 30370                                  	; Note: PCDOS 7.1 IBMDOS.COM code doesn't check high word
 30371                                  	;	of the 1st cluster here
 30372                                  	;;;
 30373                                  	; 21/02/2024 - Retro DOS v5.0
 30374                                  	;jnz	short dont_skip_insert
 30375                                  	;;cmp	word [di+14h],0
 30376                                  	;cmp	word [di+dir_entry.dir_fclus_hi],0
 30377                                  	;jz	short SKIP_INSERT
 30378                                  ;dont_skip_insert:	; Retro DOS v5.0
 30379                                  	;;;
 30380                                  
 30381 000050BB 56                      	PUSH	SI			; ES:BX -> extended info
 30382 000050BC 5B                      	POP	BX
 30383                                  
 30384                                  	;mov	al,2
 30385 000050BD B002                    	MOV	AL,FONC_insert		; call fastopen insert operation
 30386 000050BF BE[3C11]                	MOV	SI,FastOpenTable
 30387                                  	;call	far [es:si+2]	 ; call dword ptr es:[si+2] ; 29/12/2022
 30388                                  	; 07/12/2022
 30389 000050C2 26FF5C02                	CALL	far [ES:SI+fastopen_entry.name_caching]
 30390                                  
 30391 000050C6 F8                      	CLC
 30392                                  SKIP_INSERT:
 30393 000050C7 58                      	POP	AX
 30394 000050C8 59                      	POP	CX			; restore registers
 30395 000050C9 5F                      	POP	DI
 30396 000050CA 5E                      	POP	SI
 30397 000050CB 5B                      	POP	BX
 30398 000050CC 07                      	POP	ES
 30399 000050CD 1F                      	POP	DS
 30400                                  GET_NEXT2:
 30401                                  	;or	[ss:FastOpenFlg],8
 30402 000050CE 36800E[4611]08          	OR	byte [SS:FastOpenFlg],No_Lookup
 30403                                  					; we got dir info from fastopen so
 30404                                  GET_NEXT_ELEMENT:
 30405 000050D4 9D                      	POPF
 30406 000050D5 C3                      	RETN
 30407                                  
 30408                                  ;============================================================================
 30409                                  ; DEV.ASM (MSDOS 6.0, 1991)
 30410                                  ;============================================================================
 30411                                  ; 17/07/2018 - Retro DOS v3.0
 30412                                  ; 30/04/2019 - Retro DOS v4.0
 30413                                  ; 21/02/2024 - Retro DOS v5.0
 30414                                  
 30415                                  ;**	Misc Routines to do 1-12 low level I/O and call devices
 30416                                  
 30417                                  ; Offset 12B8h of IBMDOS.COM (MSDOS 3.3), 1987
 30418                                  
 30419                                  ;DOSCODE:8401h (MSDOS 6.21 & 6.22, MSDOS.SYS) ; 21/02/2024
 30420                                  ;BIOSCODE:8608h (Windows ME, IO.SYS) ; 21/02/2024
 30421                                  
 30422                                  ;DOSCODE:9163h (PCDOS 7.1, IBMDOS.COM) ; 21/02/2024
 30423                                  
 30424                                  ;Public DEV001S, DEV001E 		; Pathgen labels
 30425                                  ;DEV001s:
 30426                                  ;		length of packets
 30427 000050D6 160E160D0D0E            LenTab:	 DB	DRDWRHL, DRDNDHL, DRDWRHL, DSTATHL, DFLSHL, DRDNDHL
 30428                                  ; 21/02/2024
 30429                                  ;;LenTab: db	22,14,22,13,15,14 ; MSDOS 5.0-6.22 & Windows ME
 30430                                  ;LenTab: db	22,14,22,13,13,14 ; PCDOS 7.1
 30431                                  
 30432                                  ;	Error Function
 30433                                  
 30434                                  CmdTab:
 30435 000050DC 8604                    	DB	86h, DEVRD	; 0 input
 30436 000050DE 8605                    	DB	86h, DEVRDND	; 1 input status
 30437 000050E0 8708                    	DB	87h, DEVWRT	; 2 output
 30438 000050E2 870A                    	DB	87h, DEVOST	; 3 output status
 30439 000050E4 8607                    	DB	86h, DEVIFL	; 4 input flush
 30440 000050E6 8605                    	DB	86h, DEVRDND	; 5 input status with system WAIT
 30441                                  
 30442                                  ; Offset 12BEh of IBMDOS.COM (MSDOS 3.3), 1987
 30443                                  
 30444                                  ;CmdTab:
 30445                                  ;	db	86h, 4
 30446                                  ;	db	86h, 5
 30447                                  ;	db	87h, 8
 30448                                  ;	db	87h, 10
 30449                                  ;	db	86h, 7
 30450                                  ;	db	86h, 5
 30451                                  
 30452                                  ;DEV001E:
 30453                                  
 30454                                  ; 30/04/2019 - Retro DOS v4.0
 30455                                  ; DOSCODE:8413h (MSDOS 6.21, MSDOS.SYS)
 30456                                  
 30457                                  ;Break	<IOFUNC -- DO FUNCTION 1-12 I/O>
 30458                                  ;----------------------------------------------------------------------------
 30459                                  ;
 30460                                  ; Procedure Name : IOFUNC
 30461                                  ;
 30462                                  ; Inputs:
 30463                                  ;	DS:SI Points to SFT
 30464                                  ;	AH is function code
 30465                                  ;		= 0 Input
 30466                                  ;		= 1 Input Status
 30467                                  ;		= 2 Output
 30468                                  ;		= 3 Output Status
 30469                                  ;		= 4 Flush
 30470                                  ;		= 5 Input Status - System WAIT invoked for K09 if no char
 30471                                  ;				   present.
 30472                                  ;	AL = character if output
 30473                                  ; Function:
 30474                                  ;	Perform indicated I/O to device or file
 30475                                  ; Outputs:
 30476                                  ;	AL is character if input
 30477                                  ;	If a status call
 30478                                  ;		zero set if not ready
 30479                                  ;		zero reset if ready (character in AL for input status)
 30480                                  ; For regular files:
 30481                                  ;	Input Status
 30482                                  ;		Gets character but restores position
 30483                                  ;		Zero set on EOF
 30484                                  ;	Input
 30485                                  ;		Gets character advances position
 30486                                  ;		Returns ^Z on EOF
 30487                                  ;	Output Status
 30488                                  ;		Always ready
 30489                                  ; AX altered, all other registers preserved
 30490                                  ;----------------------------------------------------------------------------
 30491                                  
 30492                                  ; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 30493                                  ; DOSCODE:83D8h (MSDOS 5.0, MSDOS.SYS)
 30494                                  
 30495                                  ; 21/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 30496                                  ; DOSCODE:9175h (PCDOS 7.1, IBMDOS.COM)
 30497                                  
 30498                                  ; DOSCODE:8413h (MSDOS 6.22, MSDOS.SYS)
 30499                                  ; BIOSCODE:861Ah (Windows ME, IO.SYS)
 30500                                  
 30501                                  IOFUNC:
 30502 000050E8 368C16[8C03]            	MOV	[SS:IOXAD+2],SS		; SS override for IOXAD, IOSCNT, 
 30503                                  					; DEVIOBUF
 30504 000050ED 36C706[8A03][BC03]      	MOV	WORD [SS:IOXAD],DEVIOBUF
 30505 000050F4 36C706[8E03]0100        	MOV	WORD [SS:IOSCNT],1
 30506 000050FB 36A3[BC03]              	MOV	WORD [SS:DEVIOBUF],AX
 30507                                  	;test	byte [si+6],80h
 30508                                  	;TEST	word [SI+SF_ENTRY.sf_flags],sf_isnet ; 8000h
 30509 000050FF F6440680                	test	byte [SI+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 30510 00005103 7403                    	JZ	short IOTO22		;AN000;
 30511 00005105 E9A500                  	JMP	IOTOFILE		;AN000;
 30512                                  IOTO22:
 30513                                  	;test	word [si+5],80h
 30514                                  	;TEST	word [SI+SF_ENTRY.sf_flags],devid_device 
 30515 00005108 F6440580                	test	byte [SI+SF_ENTRY.sf_flags],devid_device	
 30516 0000510C 7503                    	JNZ	short IOTO33		;AN000;
 30517 0000510E E99C00                  	JMP	IOTOFILE		;AN000;
 30518                                  IOTO33:
 30519 00005111 06                      	push	es ; * (MSDOS 6.21)
 30520 00005112 E843B3                  	call	save_world
 30521 00005115 8CDA                    	MOV	DX,DS
 30522 00005117 8CD3                    	MOV	BX,SS
 30523 00005119 8EDB                    	MOV	DS,BX
 30524 0000511B 8EC3                    	MOV	ES,BX
 30525 0000511D 31DB                    	XOR	BX,BX
 30526 0000511F 80FC05                  	cmp	ah,5		    ; system wait enabled?
 30527 00005122 7503                    	jnz	short _no_sys_wait
 30528                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 30529                                  	; 16/12/2022
 30530 00005124 80CF04                  	or	bh,04h
 30531                                  	;or	bx,0400H	    ; Set bit 10 in status word for driver
 30532                                  				    ; It is up to device driver to carry out
 30533                                  				    ; appropriate action.
 30534                                  _no_sys_wait:
 30535 00005127 891E[7F03]              	MOV	[IOCALL_REQSTAT],BX
 30536 0000512B 31DB                    	XOR	BX,BX
 30537 0000512D 881E[8903]              	MOV	[IOMED],BL
 30538                                  
 30539 00005131 88E3                    	MOV	BL,AH		 	; get function
 30540 00005133 2E8AA7[D650]            	MOV	AH,[cs:BX+LenTab]
 30541 00005138 D1E3                    	SHL	BX,1
 30542 0000513A 2E8B8F[DC50]            	MOV	CX,[cs:BX+CmdTab]
 30543 0000513F BB[7C03]                	MOV	BX,IOCALL ; DOSDATA:037Ch
 30544 00005142 8826[7C03]              	MOV	[IOCALL_REQLEN],AH
 30545 00005146 882E[7E03]              	MOV	[IOCALL_REQFUNC],CH
 30546                                  
 30547 0000514A 8EDA                    	MOV	DS,DX
 30548 0000514C E86501                  	CALL	DEVIOCALL
 30549 0000514F 368B3E[7F03]            	MOV	DI,[SS:IOCALL_REQSTAT]	; SS override
 30550 00005154 21FF                    	and	di,di
 30551 00005156 7834                    	js	short DevErr
 30552                                  OKDevIO:
 30553 00005158 8CD0                    	MOV	AX,SS
 30554 0000515A 8ED8                    	MOV	DS,AX
 30555                                  
 30556                                  	;cmp	ch,5
 30557 0000515C 80FD05                  	CMP	CH,DEVRDND
 30558 0000515F 7506                    	JNZ	short DNODRD
 30559 00005161 A0[8903]                	MOV	AL,[IORCHR]
 30560 00005164 A2[BC03]                	MOV	[DEVIOBUF],AL
 30561                                  
 30562                                  DNODRD: 
 30563 00005167 8A26[8003]              	MOV	AH,[IOCALL_REQSTAT+1]
 30564 0000516B F6D4                    	NOT	AH			; Zero = busy, not zero = ready
 30565                                  	;and	ah,2
 30566 0000516D 80E402                  	AND	AH,STBUI>>8
 30567                                  
 30568                                  QuickReturn:				;AN000; 2/13/KK
 30569 00005170 E8CEB2                  	call	restore_world
 30570 00005173 07                      	pop	es ; * (MSDOS 6.21)
 30571                                  
 30572                                  	; SR;
 30573                                  	; We return ax = -1 if the user failed on I24. This is the case if 
 30574                                  	; IoStatFail = -1 (set after return from the I24)
 30575                                  
 30576                                  	; MSDOS 6.0
 30577 00005174 9C                      	pushf
 30578 00005175 36A0[8300]              	mov	al,[ss:IoStatFail]	;assume fail error
 30579 00005179 98                      	cbw				;sign extend to word
 30580                                  
 30581                                  ; 21/02/2024
 30582                                  %if 0
 30583                                  	; PCDOS 7.1 IBMDOS.COM
 30584                                  	; cbw
 30585                                  	inc	ax		; 21/02/2024 - Erdogan Tan
 30586                                  				; this may be a BUG
 30587                                  				; MSDOS 6.22 MSDOS.SYS & Win ME IO.SYS code is
 30588                                  				;  cbw
 30589                                  				;  cmp  ax,-1
 30590                                  				;  jne  short not_fail_ret
 30591                                  				;  inc  byte [ss:IoStatFail]
 30592                                  				;  popf
 30593                                  				;  retn
 30594                                  	jnz	short not_fail_ret
 30595                                  	dec	ax	
 30596                                  	jnz	short not_fail_ret ; jns ?
 30597                                  %else
 30598                                  	;cbw
 30599 0000517A 83F8FF                  	cmp	ax,-1		; (MSDOS 6.22 & Windows ME)
 30600 0000517D 7507                    	jne	short not_fail_ret
 30601                                  
 30602                                  %endif
 30603                                  
 30604 0000517F 36FE06[8300]            	inc	byte [ss:IoStatFail]
 30605 00005184 9D                      	popf
 30606 00005185 C3                      	retn
 30607                                  
 30608                                  not_fail_ret:
 30609 00005186 36A1[BC03]              	mov	ax,[ss:DEVIOBUF]	;ss override
 30610 0000518A 9D                      	popf
 30611 0000518B C3                      	retn
 30612                                  
 30613                                  DevErr:
 30614 0000518C 88CC                    	MOV	AH,CL
 30615 0000518E E8BF0E                  	call	CHARHARD
 30616 00005191 3C01                    	CMP	AL,1
 30617 00005193 7507                    	JNZ	short NO_RETRY
 30618 00005195 E8A9B2                  	call	restore_world
 30619                                  	; 12/05/2019
 30620 00005198 07                      	pop	es ; * (MSDOS 6.21)		
 30621 00005199 E94CFF                  	JMP	IOFUNC	; 10/08/2018
 30622                                  
 30623                                  NO_RETRY:
 30624                                  	; Know user must have wanted Ignore OR Fail. Make sure device shows ready
 30625                                  	; ready so that DOS doesn't get caught in a status loop when user 
 30626                                  	; simply wants to ignore the error.
 30627                                  	;
 30628                                  	; SR; If fail wanted by user set ax to special value (ax = -1). This 
 30629                                  	; should be checked by the caller on return
 30630                                  
 30631                                  					; SS override
 30632 0000519C 368026[8003]FD          	and	byte [SS:IOCALL_REQSTAT+1],0FDh
 30633                                  	;AND	BYTE [SS:IOCALL_REQSTAT+1],~(STBUI>>8)
 30634                                  
 30635                                  	; SR;
 30636                                  	; Check if user failed
 30637                                  
 30638                                  	; MSDOS 6.0
 30639 000051A2 3C03                    	cmp	al,3
 30640 000051A4 7505                    	jnz	short not_fail
 30641 000051A6 36FE0E[8300]            	dec	byte [ss:IoStatFail]	;set flag indicating fail on I24
 30642                                  not_fail:
 30643 000051AB EBAB                    	JMP	short OKDevIO
 30644                                  
 30645                                  IOTOFILE:
 30646 000051AD 08E4                    	OR	AH,AH
 30647 000051AF 7421                    	JZ	short IOIN
 30648 000051B1 FECC                    	DEC	AH
 30649 000051B3 7405                    	JZ	short IOIST
 30650 000051B5 FECC                    	DEC	AH
 30651 000051B7 7411                    	JZ	short IOUT
 30652                                  IOUT_retn:	; 18/12/2022
 30653 000051B9 C3                      	retn				; NON ZERO FLAG FOR OUTPUT STATUS
 30654                                  IOIST:
 30655                                  	;push	word [si+15h]
 30656 000051BA FF7415                  	PUSH	WORD [SI+SF_ENTRY.sf_position]   ; Save position
 30657                                  	;push	word [si+17h]
 30658 000051BD FF7417                  	PUSH	WORD [SI+SF_ENTRY.sf_position+2]
 30659 000051C0 E80F00                  	CALL	IOIN
 30660                                  	;pop	word [si+17h]
 30661 000051C3 8F4417                  	POP	WORD [SI+SF_ENTRY.sf_position+2] ; Restore position
 30662                                  	;pop	word [si+15h]
 30663 000051C6 8F4415                  	POP	WORD [SI+SF_ENTRY.sf_position]
 30664 000051C9 C3                      	retn
 30665                                  IOUT:
 30666 000051CA E82500                  	CALL	SETXADDR
 30667 000051CD E8ACEB                  	call	DOS_WRITE
 30668                                  	;CALL	RESTXADDR	; If you change this into a jmp don't
 30669                                  	; 18/12/2022
 30670 000051D0 EB4F                    	jmp	RESTXADDR
 30671                                  ;IOUT_retn:
 30672                                  	;retn			; come crying to me when things don't
 30673                                  				; work ARR
 30674                                  IOIN:
 30675 000051D2 E81D00                  	CALL	SETXADDR
 30676                                  					; SS override for DOS34_FLAG
 30677                                  	;OR	word [SS:DOS34_FLAG],Disable_EOF_I24	;AN000;
 30678                                  	;or	word [ss:DOS34_FLAG],40h
 30679                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 30680                                  	; 16/12/2022
 30681 000051D5 36800E[1106]40          	or	byte [ss:DOS34_FLAG],40h 
 30682 000051DB E89DE9                  	CALL	DOS_READ
 30683                                  	;AND	word [SS:DOS34_FLAG],NO_Disable_EOF_I24 ;AN000;
 30684                                  	;and	word [SS:DOS34_FLAG],0FFBFh
 30685                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 30686                                  	; 16/12/2022
 30687 000051DE 368026[1106]BF          	and	byte [SS:DOS34_FLAG],0BFh ; 07/12/2022
 30688 000051E4 09C9                    	OR	CX,CX			; Check EOF
 30689 000051E6 E83800                  	CALL	RESTXADDR
 30690                                  					; SS override
 30691 000051E9 36A0[BC03]              	MOV	AL,[SS:DEVIOBUF]	; Get byte from trans addr
 30692 000051ED 75CA                    	jnz	short IOUT_retn	
 30693 000051EF B01A                    	MOV	AL,1AH			; ^Z if no bytes
 30694 000051F1 C3                      	retn
 30695                                  
 30696                                  SETXADDR:
 30697                                  					; SS override
 30698 000051F2 368F06[6C03]            	POP	WORD [SS:CALLSCNT]	; Return address
 30699                                  
 30700 000051F7 06                      	push	es ; * (MSDOS 6.21)
 30701                                  
 30702 000051F8 E85DB2                  	call	save_world
 30703                                  					; SS override for DMAADD and THISSFT
 30704                                  	; 24/09/2023
 30705                                  	;PUSH	WORD [SS:DMAADD]	; Save Disk trans addr
 30706                                  	;PUSH	WORD [SS:DMAADD+2]
 30707 000051FB 368C1E[A005]            	MOV	[SS:THISSFT+2],DS
 30708                                  
 30709                                  ; 22/02/2024
 30710                                  %if 0
 30711                                  	push	ss
 30712                                  	pop	ds
 30713                                  
 30714                                  	; 24/09/2023
 30715                                  	push	word [DMAADD]
 30716                                  	push	word [DMAADD+2]
 30717                                  
 30718                                  	MOV	[THISSFT],SI		; Finish setting SFT pointer
 30719                                  	MOV	CX,[IOXAD+2]
 30720                                  	MOV	[DMAADD+2],CX
 30721                                  	MOV	CX,[IOXAD]
 30722                                  	MOV	[DMAADD],CX		; Set byte trans addr
 30723                                  %else
 30724                                  	; 22/02/2024
 30725                                  	; PCDOS 7.1 IBMDOS.COM
 30726                                  	
 30727 00005200 36C50E[2C03]            	lds	cx,[ss:DMAADD]		; Save Disk transfer address
 30728 00005205 51                      	push	cx
 30729 00005206 1E                      	push	ds
 30730 00005207 36C50E[8A03]            	lds	cx,[ss:IOXAD]		; Set byte trans address
 30731 0000520C 368C1E[2E03]            	mov	[ss:DMAADD+2],ds
 30732 00005211 16                      	push	ss
 30733 00005212 1F                      	pop	ds
 30734 00005213 890E[2C03]              	mov	[DMAADD],cx
 30735 00005217 8936[9E05]              	mov	[THISSFT],si
 30736                                  %endif
 30737 0000521B 8B0E[8E03]              	MOV	CX,[IOSCNT]		; ioscnt specifies length of buffer
 30738 0000521F EB10                    	JMP	SHORT RESTRET		; RETURN ADDRESS
 30739                                  
 30740                                  RESTXADDR:
 30741 00005221 8F06[6C03]              	POP	WORD [CALLSCNT]		; Return address
 30742 00005225 8F06[2E03]              	POP	WORD [DMAADD+2]		; Restore Disk trans addr
 30743 00005229 8F06[2C03]              	POP	WORD [DMAADD]
 30744                                  
 30745 0000522D E811B2                  	call	restore_world
 30746                                  
 30747 00005230 07                      	pop	es ; * (MSDOS 6.21)
 30748                                  					; SS override
 30749                                  RESTRET:
 30750 00005231 36FF26[6C03]            	JMP	WORD [SS:CALLSCNT]	; Return address
 30751                                  
 30752                                  ; DOSCODE:8569h (MSDOS 6.21, MSDOS.SYS)
 30753                                  ; 21/11/2022
 30754                                  ; DOSCODE:852Eh (MSDOS 5.0, MSDOS.SYS)
 30755                                  
 30756                                  ; 22/02/2024 - Retro DOS v5.0
 30757                                  ; DOSCODE:92CAh (PCDOS 7.1, IBMDOS.COM)
 30758                                  
 30759                                  ;Break <DEV_OPEN_SFT, DEV_CLOSE_SFT - OPEN or CLOSE A DEVICE>
 30760                                  
 30761                                  ;----------------------------------------------------------------------------
 30762                                  ;**	Dev_Open_SFT - Open the Device for an SFT
 30763                                  ;
 30764                                  ;	Dev_Open_SFT issues an open call to the device associated with
 30765                                  ;	the SFT.
 30766                                  ;
 30767                                  ;	ENTRY	(ES:DI) = SFT
 30768                                  ;	EXIT	none
 30769                                  ;	USES	all
 30770                                  ;----------------------------------------------------------------------------
 30771                                  
 30772                                  DEV_OPEN_SFT:
 30773 00005236 06                      	push	es ; * (MSDOS 6.21)
 30774 00005237 E81EB2                  	call	save_world
 30775                                  	;mov	al,0Dh	
 30776 0000523A B00D                    	MOV	AL,DEVOPN
 30777 0000523C EB06                    	JMP	SHORT DO_OPCLS
 30778                                  
 30779                                  ;----------------------------------------------------------------------------
 30780                                  ; Procedure Name : DEV_CLOSE_SFT
 30781                                  ;
 30782                                  ; Inputs:
 30783                                  ;	ES:DI Points to SFT
 30784                                  ; Function:
 30785                                  ;	Issue a CLOSE call to the correct device
 30786                                  ; Outputs:
 30787                                  ;	None
 30788                                  ; ALL preserved
 30789                                  ;----------------------------------------------------------------------------
 30790                                  
 30791                                  DEV_CLOSE_SFT:
 30792 0000523E 06                      	push	es ; * (MSDOS 6.21)
 30793 0000523F E816B2                  	call	save_world
 30794                                  	;mov	al,0Eh	
 30795 00005242 B00E                    	MOV	AL,DEVCLS
 30796                                  
 30797                                  	; Main entry for device open and close. AL contains the function 
 30798                                  	; requested. Subtlety: if Sharing is NOT loaded then we do NOT issue 
 30799                                  	; open/close to block devices. This allows networks to function but 
 30800                                  	; does NOT hang up with bogus change-line code.
 30801                                  
 30802                                  	;entry	DO_OPCLS
 30803                                  DO_OPCLS:
 30804                                  	; Is the SFT for the net? If so, no action necessary.
 30805                                  
 30806                                  	; MSDOS 6.0
 30807                                  	;test	word [es:di+5],8000h
 30808                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 30809 00005244 26F6450680              	test	byte [es:di+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 30810 00005249 7564                    	jnz	short OPCLS_DONE	; NOP on net SFTs
 30811 0000524B 30E4                    	XOR	AH,AH			; Unit
 30812                                  	;test	byte [es:di+5],80h
 30813 0000524D 26F6450580              	TEST	byte [ES:DI+SF_ENTRY.sf_flags],devid_device
 30814                                  	;les	di,[es:di+7]
 30815 00005252 26C47D07                	LES	DI,[ES:DI+SF_ENTRY.sf_devptr] ; Get DPB or device
 30816 00005256 7511                    	JNZ	short GOT_DEV_ADDR
 30817                                  
 30818                                  	; We are about to call device open/close on a block driver. If no 
 30819                                  	; sharing then just short circuit to done.
 30820                                  	
 30821                                  	; MSDOS 6.0
 30822                                  					; SS override
 30823 00005258 36803E[0303]01          	CMP	byte [ss:fShare],1	;AN010; /NC or no SHARE
 30824 0000525E 764F                    	JBE	short OPCLS_DONE	;AN010; yes
 30825                                  
 30826                                  ; 22/02/2024
 30827                                  %if 0
 30828                                  	; MSDOS 3.3 (& MSDOS 6.0)
 30829                                  	;mov	ah,[es:di+1]
 30830                                  	MOV	AH,[ES:DI+DPB.UNIT]	; (ah) = unit
 30831                                  	mov	cl,[es:di]
 30832                                  	;MOV	CL,[ES:DI+DPB.DRIVE]	; (cl) = drive
 30833                                  %else
 30834                                  	; 22/02/2024 - Retro DOS v5.0
 30835                                  	;mov	cx,[es:di+DPB.DRIVE]
 30836 00005260 268B0D                  	mov	cx,[es:di]
 30837 00005263 88EC                    	mov	ah,ch			; AH = unit
 30838                                  					; CL = drive
 30839                                  %endif
 30840                                  
 30841                                  	;;les	di,[es:di+12h] ; MSDOS 3.3
 30842                                  	;les	di,[es:di+13h] ; MSDOS 6.0
 30843 00005265 26C47D13                	LES	DI,[ES:DI+DPB.DRIVER_ADDR] ; Get device
 30844                                  GOT_DEV_ADDR:				; ES:DI -> device
 30845                                  	;test	word [es:di+4],800h
 30846                                  	;TEST	word [ES:DI+SYSDEV.ATT],DEVOPCL
 30847 00005269 26F6450508              	test	byte [ES:DI+SYSDEV.ATT+1],(DEVOPCL>>8)
 30848 0000526E 743F                    	JZ	short OPCLS_DONE	; Device can't
 30849 00005270 06                      	PUSH	ES
 30850 00005271 1F                      	POP	DS
 30851 00005272 89FE                    	MOV	SI,DI			; DS:SI -> device
 30852                                  
 30853                                  OPCLS_RETRY:
 30854                                  	;Context ES
 30855 00005274 16                      	push	ss
 30856 00005275 07                      	pop	es
 30857                                  					; DEVCALL is in DOSDATA
 30858 00005276 BF[5A03]                	MOV	DI,DEVCALL
 30859                                  
 30860 00005279 89FB                    	MOV	BX,DI
 30861 0000527B 50                      	PUSH	AX
 30862                                  	;mov	al,13
 30863 0000527C B00D                    	MOV	AL,DOPCLHL
 30864 0000527E AA                      	STOSB				; Length
 30865 0000527F 58                      	POP	AX
 30866                                  
 30867 00005280 86E0                    	XCHG	AH,AL
 30868                                  	;STOSB				; Unit
 30869                                  	; 22/02/2024 (PCDOS 7.1 IBMDOS.COM)
 30870 00005282 AB                      	stosw				; Unit, Command
 30871 00005283 86E0                    	XCHG	AH,AL
 30872                                  	;STOSB				; Command
 30873                                  
 30874 00005285 26C7050000              	MOV	WORD [ES:DI],0		; Status
 30875 0000528A 50                      	PUSH	AX			; Save Unit,Command
 30876                                  	;invoke	DEVIOCALL2
 30877 0000528B E82900                  	call	DEVIOCALL2
 30878                                  
 30879                                  	;mov	di,[es:bx+3]
 30880 0000528E 268B7F03                	MOV	DI,[ES:BX+SRHEAD.REQSTAT]
 30881                                  	;test	di,8000h
 30882                                  	;jz	short OPCLS_DONEP	
 30883 00005292 21FF                    	and	di,di
 30884 00005294 7918                    	jns	short OPCLS_DONEP	; No error
 30885                                  	; 21/11/2022
 30886                                  	;test	word [si+4],8000h
 30887                                  	;TEST	word [SI+SYSDEV.ATT],DEVTYP
 30888                                  	;test	word [si+5],80h
 30889 00005296 F6440580                	test	byte [SI+SYSDEV.ATT+1],(DEVTYP>>8)
 30890 0000529A 7404                    	JZ	short BLKDEV
 30891 0000529C B486                    	MOV	AH,86H			; Read error in data, Char dev
 30892 0000529E EB04                    	JMP	SHORT HRDERR
 30893                                  BLKDEV:
 30894 000052A0 88C8                    	MOV	AL,CL			; Drive # in AL
 30895 000052A2 B406                    	MOV	AH,6			; Read error in data, Blk dev
 30896                                  HRDERR:
 30897                                  	;invoke	CHARHARD
 30898 000052A4 E8A90D                  	call	CHARHARD
 30899 000052A7 3C01                    	cmp	al,1
 30900 000052A9 7503                    	jne	short OPCLS_DONEP	; IGNORE or FAIL
 30901                                  					;  Note that FAIL is essentually IGNORED
 30902 000052AB 58                      	POP	AX			; Get back Unit, Command
 30903 000052AC EBC6                    	JMP	short OPCLS_RETRY
 30904                                  OPCLS_DONEP:
 30905 000052AE 58                      	POP	AX			; Clean stack
 30906                                  OPCLS_DONE:
 30907 000052AF E88FB1                  	call	restore_world
 30908 000052B2 07                      	pop	es ; * (MSDOS 6.21)
 30909 000052B3 C3                      	retn
 30910                                  
 30911                                  ; 30/04/2019 - Retro DOS v4.0
 30912                                  ; DOSCODE:85EAh (MSDOS 6.21, MSDOS.SYS)
 30913                                  
 30914                                  ; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 30915                                  ; DOSCODE:85AFh (MSDOS 5.0, MSDOS.SYS)
 30916                                  
 30917                                  ; 22/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 30918                                  ; DOSCODE:9348h (PCDOS 7.1, IBMDOS.COM)
 30919                                  
 30920                                  ;Break	<DEVIOCALL, DEVIOCALL2 - CALL A DEVICE>
 30921                                  ;----------------------------------------------------------------------------
 30922                                  ;**	DevIoCall  - Call Device
 30923                                  ;
 30924                                  ;	ENTRY	DS:SI Points to device SFT
 30925                                  ;		ES:BX Points to request data
 30926                                  ;	EXIT	DS:SI -> Device driver
 30927                                  ;	USES	DS:SI,AX
 30928                                  ;----------------------------------------------------------------------------
 30929                                  ;**	DevIoCall2 - Call Device
 30930                                  ;
 30931                                  ;	ENTRY	DS:SI Points to DPB
 30932                                  ;		ES:BX Points to request data
 30933                                  ;	EXIT	DS:SI -> Device driver
 30934                                  ;	USES	DS:SI,AX
 30935                                  ;----------------------------------------------------------------------------
 30936                                  
 30937                                  DEVIOCALL:
 30938                                  					; SS override for CALLSSEC, 
 30939                                  	;lds	si,[si+7]		; CALLNEWSC, HIGH_SECTOR & CALLDEVAD
 30940 000052B4 C57407                  	LDS	SI,[SI+SF_ENTRY.sf_devptr]
 30941                                  
 30942                                  	;entry	DEVIOCALL2
 30943                                  DEVIOCALL2:
 30944                                  	;EnterCrit critDevice
 30945 000052B7 E867C6                  	call	ECritDevice
 30946                                  
 30947                                  	; MSDOS 6.0
 30948                                  	;TEST	word [SI+SYSDEV.ATT],DEVTYP ;AN000; >32mb block device ?
 30949                                  	;test	byte [si+5],80h
 30950 000052BA F6440580                	test	byte [si+SYSDEV.ATT+1],(DEVTYP>>8)
 30951 000052BE 7540                    	jnz	short chardev2		;AN000; >32mb no
 30952                                  
 30953                                  	; 16/12/2022
 30954                                  	; 22/11/2022
 30955 000052C0 268A4702                	mov	al,[ES:BX+SRHEAD.REQFUNC] ; [es:bx+2]
 30956 000052C4 3C04                    	cmp	al,DEVRD	; 4
 30957 000052C6 7408                    	je	short chkext	
 30958 000052C8 3C08                    	cmp	al,DEVWRT	; 8
 30959 000052CA 7404                    	je	short chkext
 30960 000052CC 3C09                    	cmp	al,DEVWRTV	; 9
 30961 000052CE 7530                    	jne	short chardev2
 30962                                  
 30963                                  	; 16/12/2022
 30964                                  	; 22/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 30965                                  	;;cmp	byte [es:bx+2],4
 30966                                  	;CMP	byte [ES:BX+SRHEAD.REQFUNC],DEVRD  ;AN000; >32mb read ?
 30967                                  	;JZ	short chkext		;AN000; >32mb   yes
 30968                                  	;;cmp	byte [es:bx+2],8
 30969                                  	;CMP	byte [ES:BX+SRHEAD.REQFUNC],DEVWRT ;AN000; >32mb write ?
 30970                                  	;JZ	short chkext		;AN000; >32mb   yes
 30971                                  	;;cmp	byte [es:bx+2],9
 30972                                  	;CMP	byte [ES:BX+SRHEAD.REQFUNC],DEVWRTV
 30973                                  	;				;AN000; >32mb write/verify ?
 30974                                  	;JNZ	short chardev2		;AN000; >32mb no
 30975                                  
 30976                                  chkext:
 30977                                  
 30978                                  ; 22/02/2024 - Retro DOS v5.0 (PCDOS 7.1)
 30979                                  %if 0
 30980                                  	CALL	RW_SC			;AN000;LB. use secondary cache if there
 30981                                  	JC	short dev_exit		;AN000;LB. done
 30982                                  %endif
 30983                                  
 30984                                  	;test	byte [si+4],2
 30985 000052D0 F6440402                	TEST	byte [SI+SYSDEV.ATT],EXTDRVR ;AN000;>32mb extended driver?
 30986 000052D4 741A                    	JZ	short chksector		;AN000;>32mb   no
 30987 000052D6 26800708                	ADD	BYTE [ES:BX],8		;AN000;>32mb   make length to 30
 30988                                  
 30989                                  	;MOV	AX,[SS:CALLSSEC]	;AN000;>32mb
 30990                                  	;MOV	word [SS:CALLSSEC],-1	;AN000;>32mb   old sector  =-1
 30991                                  	; 22/02/2024
 30992 000052DA B8FFFF                  	mov	ax,-1 ; 0FFFFh
 30993 000052DD 368706[6E03]            	xchg    ax,[ss:CALLSSEC]
 30994                                  	
 30995 000052E2 36A3[7403]              	MOV	[SS:CALLNEWSC],AX	;AN000;>32mb   new sector  =
 30996 000052E6 36A1[0706]              	MOV	AX,[SS:HIGH_SECTOR]	;AN000; >32mb  low sector,high sector
 30997 000052EA 36A3[7603]              	MOV	[SS:CALLNEWSC+2],AX	;AN000; >32mb
 30998 000052EE EB10                    	JMP	short chardev2		;AN000; >32mb
 30999                                  
 31000                                  chksector:				;AN000; >32mb
 31001 000052F0 36833E[0706]00          	CMP	word [SS:HIGH_SECTOR],0	;AN000; >32mb   if >32mb
 31002 000052F6 7408                    	JZ	short chardev2		;AN000; >32mb   then fake error
 31003                                  	;mov	word [es:bx+3],8107h
 31004 000052F8 26C747030781            	MOV	word [ES:BX+SRHEAD.REQSTAT],STERR+STDON+error_I24_not_DOS_disk 
 31005                                  					;AN000; >32mb
 31006 000052FE EB27                    	JMP	SHORT dev_exit		;AN000; >32mb
 31007                                  
 31008                                  chardev2:				;AN000;
 31009                                  	; As above only DS:SI points to device header on entry, and DS:SI is 
 31010                                  	; preserved
 31011                                  
 31012                                  	;;;
 31013                                  	; 22/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 31014 00005300 36FE06[B912]            	inc	byte [ss:DEVIO_IN_PROGRESS] ; lock (deviocall in progress)
 31015                                  	;;;	
 31016                                  
 31017                                  	;mov	ax,[si+6]
 31018 00005305 8B4406                  	MOV	AX,[SI+SYSDEV.STRAT]
 31019 00005308 36A3[7803]              	MOV	[SS:CALLDEVAD],AX
 31020 0000530C 368C1E[7A03]            	MOV	[SS:CALLDEVAD+2],DS
 31021 00005311 36FF1E[7803]            	CALL	far [SS:CALLDEVAD]
 31022                                  
 31023                                  	;mov	ax,[si+8]
 31024 00005316 8B4408                  	MOV	AX,[SI+SYSDEV.INT]
 31025 00005319 36A3[7803]              	MOV	[SS:CALLDEVAD],AX
 31026 0000531D 36FF1E[7803]            	CALL	far [SS:CALLDEVAD]
 31027                                  
 31028                                  	;;;
 31029                                  	; 22/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 31030 00005322 36FE0E[B912]            	dec	byte [ss:DEVIO_IN_PROGRESS] ; unlock (deviocall completed)
 31031                                  	;;;
 31032                                  
 31033                                  ; 22/02/2024 - Retro DOS v5.0 (PCDOS 7.1)
 31034                                  %if 0
 31035                                  	; MSDOS 6.0
 31036                                  	CALL	VIRREAD 		;AN000;LB. move data from SC to buffer
 31037                                  	JC	short chardev2		;AN000;LB. bad sector or exceeds max sec
 31038                                  %endif
 31039                                  
 31040                                  dev_exit:
 31041                                  	;LeaveCrit critDevice
 31042                                  	;call	LCritDevice
 31043                                  	;retn
 31044                                  	; 18/12/2022
 31045 00005327 E908C6                  	jmp	LCritDevice
 31046                                  
 31047                                  ; DOSCODE:8669h (MSDOS 6.21, MSDOS.SYS)
 31048                                  ; 22/11/2022
 31049                                  ; DOSCODE:862Eh (MSDOS 5.0, MSDOS.SYS)
 31050                                  
 31051                                  ;Break	<SETREAD, SETWRITE -- SET UP HEADER BLOCK>
 31052                                  ;---------------------------------------------------------------------------
 31053                                  ;
 31054                                  ; Procedure Name : SETREAD, SETWRITE
 31055                                  ;
 31056                                  ; Inputs:
 31057                                  ;	DS:BX = Transfer Address
 31058                                  ;	CX = Record Count
 31059                                  ;	DX = Starting Record
 31060                                  ;	AH = Media Byte
 31061                                  ;	AL = Unit Code
 31062                                  ; Function:
 31063                                  ;	Set up the device call header at DEVCALL
 31064                                  ; Output:
 31065                                  ;	ES:BX Points to DEVCALL
 31066                                  ; No other registers effected
 31067                                  ;
 31068                                  ;---------------------------------------------------------------------------
 31069                                  
 31070                                  SETREAD_XJ:
 31071                                  	;;;
 31072                                  	; 07/02/2024 - Retro DOS v5.0
 31073 0000532A 89FB                    	mov	bx,di
 31074 0000532C EB07                    	jmp	short SETREAD_X
 31075                                  	;;;
 31076                                  
 31077                                  SETREAD_XT:
 31078                                  	;;;
 31079                                  	; 07/02/2024 - Retro DOS v5.0
 31080 0000532E BB[B603]                	mov	bx,TIMEBUF
 31081 00005331 53                      	push	bx
 31082                                  SETREAD_XTC:
 31083 00005332 B90600                  	mov	cx,6
 31084                                  	;;;
 31085                                  SETREAD_X:
 31086                                  	;;;
 31087                                  	; 06/02/2024 - Retro DOS v5.0
 31088 00005335 31C0                    	xor	ax,ax
 31089                                  	;mov	dx,ax ; 0
 31090 00005337 99                      	cwd
 31091                                  	;;;
 31092                                  
 31093                                  ; ------------------------------------
 31094                                  
 31095                                  SETREAD:
 31096 00005338 57                      	PUSH	DI
 31097 00005339 51                      	PUSH	CX
 31098 0000533A 50                      	PUSH	AX
 31099 0000533B B104                    	MOV	CL,DEVRD ; mov cl,4
 31100                                  SETCALLHEAD:
 31101 0000533D B016                    	MOV	AL,DRDWRHL ; mov al,16h
 31102 0000533F 16                      	PUSH	SS
 31103 00005340 07                      	POP	ES
 31104                                  					; DEVCALL is in DOSDATA
 31105 00005341 BF[5A03]                	MOV	DI,DEVCALL
 31106                                  
 31107 00005344 AA                      	STOSB				; length
 31108 00005345 58                      	POP	AX			; 
 31109 00005346 AA                      	STOSB				; Unit
 31110 00005347 50                      	PUSH	AX
 31111 00005348 88C8                    	MOV	AL,CL
 31112 0000534A AA                      	STOSB				; Command code
 31113 0000534B 31C0                    	XOR	AX,AX
 31114 0000534D AB                      	STOSW				; Status
 31115 0000534E 83C708                  	ADD	DI,8			; Skip link fields
 31116 00005351 58                      	POP	AX
 31117 00005352 86E0                    	XCHG	AH,AL
 31118 00005354 AA                      	STOSB				; Media byte
 31119 00005355 86C4                    	XCHG	AL,AH
 31120 00005357 50                      	PUSH	AX
 31121 00005358 89D8                    	MOV	AX,BX
 31122 0000535A AB                      	STOSW
 31123                                  
 31124 0000535B 8CD8                    	MOV	AX,DS
 31125 0000535D AB                      	STOSW				; Transfer addr
 31126                                  
 31127 0000535E 59                      	POP	CX			; Real AX
 31128 0000535F 58                      	POP	AX			; Real CX
 31129 00005360 AB                      	STOSW				; Count
 31130                                  
 31131 00005361 92                      	XCHG	AX,DX			; AX=Real DX, DX=real CX, CX=real AX
 31132 00005362 AB                      	STOSW				; Start
 31133 00005363 91                      	XCHG	AX,CX
 31134 00005364 87D1                    	XCHG	DX,CX
 31135 00005366 5F                      	POP	DI
 31136                                  					; DEVCALL is in DOSDATA
 31137 00005367 BB[5A03]                	MOV	BX,DEVCALL
 31138 0000536A C3                      	retn
 31139                                  
 31140                                  	;entry	SETWRITE
 31141                                  SETWRITE:
 31142                                  
 31143                                  ; Inputs:
 31144                                  ;	DS:BX = Transfer Address
 31145                                  ;	CX = Record Count
 31146                                  ;	DX = Starting Record
 31147                                  ;	AH = Media Byte
 31148                                  ;	AL = Unit Code
 31149                                  ; Function:
 31150                                  ;	Set up the device call header at DEVCALL
 31151                                  ; Output:
 31152                                  ;	ES:BX Points to DEVCALL
 31153                                  ; No other registers effected
 31154                                  
 31155 0000536B 57                      	PUSH	DI
 31156 0000536C 51                      	PUSH	CX
 31157 0000536D 50                      	PUSH	AX
 31158 0000536E B108                    	MOV	CL,DEVWRT ; mov cl,8
 31159 00005370 36020E[FF02]            	ADD	CL,[SS:VERFLG]		; SS override
 31160 00005375 EBC6                    	JMP	SHORT SETCALLHEAD
 31161                                  
 31162                                  ; 22/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 31163                                  %if 0	; SC
 31164                                  
 31165                                  ; 30/04/2019 - Retro DOS v4.0
 31166                                  ; DOSCODE:86A8h (MSDOS 6.21, MSDOS.SYS)
 31167                                  ; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 31168                                  ; DOSCODE:866Dh (MSDOS 5.0, MSDOS.SYS)
 31169                                  
 31170                                  ;Break	<RW_SC -- Read Write Secondary Cache>
 31171                                  ;---------------------------------------------------------------------------
 31172                                  ;
 31173                                  ; Procedure Name : RW_SC
 31174                                  ;
 31175                                  ; Inputs:
 31176                                  ;	 [SC_CACHE_COUNT]= secondary cache count
 31177                                  ;	 [SC_STATUS]= SC validity status
 31178                                  ;	 [SEQ_SECTOR]= last sector read
 31179                                  ; Function:
 31180                                  ;	Read from or write through secondary cache
 31181                                  ; Output:
 31182                                  ;	ES:BX Points to DEVCALL
 31183                                  ;	carry clear, I/O is not done
 31184                                  ;		     [SC_FLAG]=1 if continuos sectors will be read
 31185                                  ;	carry set, I/O is done
 31186                                  ;
 31187                                  ;----------------------------------------------------------------------------
 31188                                  
 31189                                  RW_SC:
 31190                                  	; SS override for all variables used.
 31191                                  	
 31192                                  	CMP	word [ss:SC_CACHE_COUNT],0  ;AN000;LB. secondary cache exists?
 31193                                  	JZ	short scexit4		    ;AN000;LB. no, do nothing
 31194                                  	CMP	word [ss:CALLSCNT],1	    ;AN000;LB. sector count = 1 (buffer I/O)
 31195                                  	JNZ	short scexit4 		    ;AN000;LB. no, do nothing
 31196                                  	PUSH	CX			    ;AN000;LB.
 31197                                  	PUSH	DX			    ;AN000;LB. yes
 31198                                  	PUSH	DS			    ;AN000;LB. save registers
 31199                                  	PUSH	SI			    ;AN000;LB.
 31200                                  	PUSH	ES			    ;AN000;LB.
 31201                                  	PUSH	DI			    ;AN000;LB.
 31202                                  
 31203                                  	MOV	DX,[ss:CALLSSEC]	    ;AN000;LB. starting sector
 31204                                  	CMP	BYTE [ss:DEVCALL_REQFUNC],DEVRD ;AN000;LB. read ?
 31205                                  	JZ	short doread		    ;AN000;LB. yes
 31206                                  	CALL	INVALIDATE_SC		    ;AN000;LB. invalidate SC
 31207                                  	JMP	scexit2 		    ;AN000;LB. back to normal
 31208                                  scexit4:				    ;AN000;
 31209                                  	CLC				    ;AN000;LB. I/O not done yet
 31210                                  	retn				    ;AN000;LB.
 31211                                  doread: 				    ;AN000;
 31212                                  	CALL	SC2BUF			    ;AN000;LB. check if in SC
 31213                                  	JC	short readSC		    ;AN000;LB.
 31214                                  	MOV	word [ss:DEVCALL_REQSTAT],STDON ;AN000;LB. fake done and ok
 31215                                  	STC				    ;AN000;LB. set carry
 31216                                  	JMP	short saveseq 		    ;AN000;LB. save seq. sector #
 31217                                  readSC: 				    ;AN000;
 31218                                  	MOV	AX,[ss:HIGH_SECTOR]   	    ;AN000;LB. subtract sector num from
 31219                                  	MOV	CX,[ss:CALLSSEC]	    ;AN000;LB. saved sequential sector
 31220                                  	SUB	CX,[ss:SEQ_SECTOR]    	    ;AN000;LB. number
 31221                                  	SBB	AX,[ss:SEQ_SECTOR+2]  	    ;AN000;LB.
 31222                                  	; 24/09/2023
 31223                                  	;CMP	AX,0			    ;AN000;LB. greater than 64K
 31224                                  	JNZ	short saveseq2		    ;AN000;LB. yes,save seq. sector #
 31225                                  chklow: 						
 31226                                  	CMP	CX,1			    ;AN000;LB. <= 1
 31227                                  	JA	short saveseq2		    ;AN000;LB. no, not sequential
 31228                                  	MOV	word [ss:SC_STATUS],-1	    ;AN000;LB. presume all SC valid
 31229                                  	MOV	AX,[ss:SC_CACHE_COUNT]	    ;AN000;LB. yes, sequential
 31230                                  	MOV	[ss:CALLSCNT],AX	    ;AN000;LB. read continuous sectors
 31231                                  readsr:
 31232                                  	MOV	AX,[ss:CALLXAD+2]	    ;AN000;LB. save buffer addr
 31233                                  	MOV	[ss:TEMP_VAR2],AX	    ;AN000;LB. in temp vars
 31234                                  	MOV	AX,[ss:CALLXAD]	    	    ;AN000;LB.
 31235                                  	MOV	[ss:TEMP_VAR],AX	    ;AN000;LB.
 31236                                  
 31237                                  	MOV	AX,[ss:SC_CACHE_PTR]	    ;AN000;LB. use SC cache addr as
 31238                                  	MOV	[ss:CALLXAD],AX		    ;AN000;LB. transfer addr
 31239                                  	MOV	AX,[ss:SC_CACHE_PTR+2]	    ;AN000;LB.
 31240                                  	MOV	[ss:CALLXAD+2],AX	    ;AN000;LB.
 31241                                  	MOV	byte [ss:SC_FLAG],1	    ;AN000;LB. flag it for later;
 31242                                  	MOV	AL,[ss:SC_DRIVE]	    ;AN000;LB. current drive
 31243                                  	MOV	[ss:CurSC_DRIVE],AL	    ;AN000;LB. set current drive
 31244                                  	MOV	AX,[ss:CALLSSEC]	    ;AN000;LB. current sector
 31245                                  	MOV	[ss:CurSC_SECTOR],AX	    ;AN000;LB. set current sector
 31246                                  	MOV	AX,[ss:HIGH_SECTOR]	    ;AN000;LB.
 31247                                  	MOV	[ss:CurSC_SECTOR+2],AX	    ;AN000;LB.
 31248                                  saveseq2:				    ;AN000;
 31249                                  	CLC				    ;AN000;LB. clear carry
 31250                                  saveseq:				    ;AN000;	
 31251                                  	MOV	AX,[ss:HIGH_SECTOR]	    ;AN000;LB. save current sector #
 31252                                  	MOV	[ss:SEQ_SECTOR+2],AX	    ;AN000;LB. for access mode ref.
 31253                                  	MOV	AX,[ss:CALLSSEC]	    ;AN000;LB.	
 31254                                  	MOV	[ss:SEQ_SECTOR],AX 	    ;AN000;LB.	
 31255                                  	JMP	short scexit 		    ;AN000;LB.	
 31256                                  scexit2:				    ;AN000;LB.
 31257                                  	CLC				    ;AN000;LB.	clear carry
 31258                                  scexit: 				    ;AN000;		
 31259                                  	POP	DI			    ;AN000;LB.
 31260                                  	POP	ES			    ;AN000;LB. restore registers
 31261                                  	POP	SI			    ;AN000;LB.
 31262                                  	POP	DS			    ;AN000;LB.
 31263                                  	POP	DX			    ;AN000;LB.
 31264                                  	POP	CX			    ;AN000;LB.
 31265                                  	retn				    ;AN000;LB.
 31266                                  
 31267                                  ;Break	<IN_SC -- check if in secondary cache>
 31268                                  ;--------------------------------------------------------------------------
 31269                                  ;
 31270                                  ; Procedure Name : IN_SC
 31271                                  ;
 31272                                  ; Inputs:  [SC_DRIVE]= requesting drive
 31273                                  ;	   [CURSC_DRIVE]= current SC drive
 31274                                  ;	   [CURSC_SECTOR]= starting scetor # of SC
 31275                                  ;	   [SC_CACHE_COUNT]= SC count
 31276                                  ;	   [HIGH_SECTOR]:DX= sector number
 31277                                  ; Function:
 31278                                  ;	Check if the sector is in secondary cache
 31279                                  ; Output:
 31280                                  ;	carry clear, in SC
 31281                                  ;	   CX= the index in the secondary cache
 31282                                  ;	carry set, not in SC
 31283                                  ;
 31284                                  ;---------------------------------------------------------------------------
 31285                                  
 31286                                  	; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 31287                                  IN_SC:
 31288                                  	; SS override for all variables used
 31289                                  	MOV	AL,[ss:SC_DRIVE]	    ;AN000;;LB. current drive
 31290                                  	CMP	AL,[ss:CurSC_DRIVE]	    ;AN000;;LB. same as SC drive
 31291                                  	JNZ	short outrange2		    ;AN000;;LB. no
 31292                                  	MOV	AX,[ss:HIGH_SECTOR]	    ;AN000;;LB. subtract sector num from
 31293                                  	MOV	CX,DX			    ;AN000;;LB. secondary starting sector
 31294                                  	SUB	CX,[ss:CurSC_SECTOR]        ;AN000;;LB. number
 31295                                  	SBB	AX,[ss:CurSC_SECTOR+2]      ;AN000;;LB.
 31296                                  	; 24/09/2023
 31297                                  	;CMP	AX,0			    ;AN000;;LB. greater than 64K
 31298                                  	JNZ	short outrange2		    ;AN000;;LB. yes
 31299                                  	CMP	CX,[ss:SC_CACHE_COUNT]	    ;AN000;;LB. greater than SC count
 31300                                  	JAE	short outrange2		    ;AN000;;LB. yes
 31301                                  	CLC				    ;AN000;;LB. clear carry
 31302                                  	;JMP	short inexit		    ;AN000;;LB. in SC
 31303                                  	; 16/12/2022
 31304                                  	retn	; 30/04/2019
 31305                                  	; 22/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 31306                                  	;jmp	short inexit
 31307                                  
 31308                                  outrange2:				    ;AN000;;LB. set carry
 31309                                  	STC				    ;AN000;;LB.
 31310                                  inexit: 				    ;AN000;;LB.
 31311                                  	retn				    ;AN000;;LB.
 31312                                  
 31313                                  ;Break	<INVALIDATE_SC - invalide secondary cache>
 31314                                  ;---------------------------------------------------------------------------
 31315                                  ;
 31316                                  ; Procedure Name : Invalidate_Sc
 31317                                  ;
 31318                                  ; Inputs:  [SC_DRIVE]= requesting drive
 31319                                  ;	   [CURSC_DRIVE]= current SC drive
 31320                                  ;	   [CURSC_SECTOR]= starting scetor # of SC
 31321                                  ;	   [SC_CACHE_COUNT]= SC count
 31322                                  ;	   [SC_STATUS]= SC status word
 31323                                  ;	   [HIGH_SECTOR]:DX= sector number
 31324                                  ;
 31325                                  ; Function:
 31326                                  ;	invalidate secondary cache if in there
 31327                                  ; Output:
 31328                                  ;	[SC_STATUS] is updated
 31329                                  ;---------------------------------------------------------------------------
 31330                                  
 31331                                  INVALIDATE_SC:
 31332                                  	; SS override for all variables used
 31333                                  
 31334                                  	CALL	IN_SC			    ;AN000;;LB. in secondary cache
 31335                                  	JC	short outrange		    ;AN000;;LB. no
 31336                                  	MOV	AX,1			    ;AN000;;LB. invalidate the sector
 31337                                  	SHL	AX,CL			    ;AN000;;LB. in the secondary cache
 31338                                  	NOT	AX			    ;AN000;;LB.
 31339                                  	AND	[ss:SC_STATUS],AX	    ;AN000;;LB. save the status
 31340                                  outrange:				    ;AN000;;LB.
 31341                                  	retn				    ;AN000;;LB.
 31342                                  
 31343                                  ; DOSCODE:87A5h (MSDOS 6.21, MSDOS.SYS)
 31344                                  ; 22/11/2022
 31345                                  ; DOSCODE:876Ah (MSDOS 5.0, MSDOS.SYS)
 31346                                  
 31347                                  ;Break	<VIRREAD- virtually read data into buffer>
 31348                                  ;--------------------------------------------------------------------------
 31349                                  ;
 31350                                  ; Procedure Name : SC_FLAG
 31351                                  ;
 31352                                  ; Inputs:  SC_FLAG = 0, no sectors were read into SC
 31353                                  ;		     1, continuous sectors were read into SC
 31354                                  ; Function:
 31355                                  ;	   Move data from SC to buffer
 31356                                  ; Output:
 31357                                  ;	 carry clear, data is moved to buffer
 31358                                  ;	 carry set, bad sector or exceeds maximum sector
 31359                                  ;	   SC_FLAG =0
 31360                                  ;	   CALLSCNT=1
 31361                                  ;	   SC_STATUS= -1 if succeeded
 31362                                  ;     
 31363                                  ;		       0 if failed
 31364                                  ;--------------------------------------------------------------------------
 31365                                  
 31366                                  VIRREAD:
 31367                                  	; SS override for all variables used
 31368                                  
 31369                                  	CMP	byte [ss:SC_FLAG],0	    ;AN000;;LB. from SC fill
 31370                                  	JZ	short sc2end		    ;AN000;;LB. no
 31371                                  	MOV	AX,[ss:TEMP_VAR2]	    ;AN000;;LB. restore buffer addr
 31372                                  	MOV	[ss:CALLXAD+2],AX	    ;AN000;;LB.
 31373                                  	MOV	AX,[ss:TEMP_VAR]	    ;AN000;;LB.
 31374                                  	MOV	[ss:CALLXAD],AX		    ;AN000;;LB.
 31375                                  	MOV	byte [ss:SC_FLAG],0	    ;AN000;;LB. reset sc_flag
 31376                                  	MOV	word [ss:CALLSCNT],1	    ;AN000;;LB. one sector transferred
 31377                                  
 31378                                  	;TEST	word [SS:DEVCALL_REQSTAT],STERR ;AN000;;LB. error?
 31379                                  	test	byte [ss:DEVCALL_REQSTAT+1],(STERR>>8) ; 80h
 31380                                  	JNZ	short scerror 		    ;AN000;;LB. yes
 31381                                  	PUSH	DS			    ;AN000;;LB.
 31382                                  	PUSH	SI			    ;AN000;;LB.
 31383                                  	PUSH	ES			    ;AN000;;LB.
 31384                                  	PUSH	DI			    ;AN000;;LB.
 31385                                  	PUSH	DX			    ;AN000;;LB.
 31386                                  	PUSH	CX			    ;AN000;;LB.
 31387                                  	XOR	CX,CX			    ;AN000;;LB. we want first sector in SC
 31388                                  	CALL	SC2BUF2 		    ;AN000;;LB. move data from SC to buf
 31389                                  	POP	CX
 31390                                  	POP	DX			    ;AN000;;LB.
 31391                                  	POP	DI			    ;AN000;;LB.
 31392                                  	POP	ES			    ;AN000;;LB.
 31393                                  	POP	SI			    ;AN000;;LB.
 31394                                  	POP	DS			    ;AN000;;LB.
 31395                                  	JMP	SHORT sc2end		    ;AN000;;LB. return
 31396                                  scerror:				    ;AN000;
 31397                                  	MOV	word [ss:CALLSCNT],1	    ;AN000;;LB. reset sector count to 1
 31398                                  	MOV	word [ss:SC_STATUS],0	    ;AN000;;LB. invalidate all SC sectors
 31399                                  	MOV	byte [ss:CurSC_DRIVE],-1    ;AN000;;LB. invalidate drive
 31400                                  	STC				    ;AN000;;LB. carry set
 31401                                  	retn				    ;AN000;;LB.
 31402                                  sc2end: 				    ;AN000;
 31403                                  	CLC				    ;AN000;;LB. carry clear
 31404                                  	retn				    ;AN000;;LB.
 31405                                  
 31406                                  ; 30/04/2019 - Retro  DOS v4.0
 31407                                  ; DOSCODE:87FDh (MSDOS 6.21, MSDOS.SYS)
 31408                                  ; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 31409                                  ; DOSCODE:87C2h (MSDOS 5.0, MSDOS.SYS)
 31410                                  
 31411                                  ;Break	<SC2BUF- move data from SC to buffer>
 31412                                  ;----------------------------------------------------------------------------
 31413                                  ;
 31414                                  ; Procedure Name : SC2BUF
 31415                                  ;
 31416                                  ; Inputs:  [SC_STATUS] = SC validity status
 31417                                  ;	   [SC_SECTOR_SIZE] = request sector size
 31418                                  ;	   [SC_CACHE_PTR] = pointer to SC
 31419                                  ; Function:
 31420                                  ;	   Move data from SC to buffer
 31421                                  ; Output:
 31422                                  ;	   carry clear, in SC  and data is moved
 31423                                  ;	   carry set, not in SC and data is not moved
 31424                                  ;---------------------------------------------------------------------------
 31425                                  
 31426                                  SC2BUF:
 31427                                  	; SS override for all variables used
 31428                                  	CALL	IN_SC			    ;AN000;LB. in secondary cache
 31429                                  	;JC	short noSC		    ;AN000;LB. no
 31430                                  	; 24/09/2023
 31431                                  	jc	short sexit
 31432                                  	MOV	AX,1			    ;AN000;LB. check if valid sector
 31433                                  	SHL	AX,CL			    ;AN000;LB. in the secondary cache
 31434                                  	TEST	[ss:SC_STATUS],AX	    ;AN000;LB.
 31435                                  	JZ	short noSC		    ;AN000;LB. invalid
 31436                                  ;entry SC2BUF2
 31437                                  SC2BUF2:				    ;AN000;
 31438                                  	;MOV	AX,CX			    ;AN000;LB. times index with
 31439                                  	;MUL	word [ss:SC_SECTOR_SIZE]    ;AN000;LB. sector size
 31440                                  	; 24/09/2023
 31441                                  	mov	ax,[ss:SC_SECTOR_SIZE]
 31442                                  	xchg	ax,cx ; cx = [ss:SC_SECTOR_SIZE]
 31443                                  	mul	cx
 31444                                  	ADD	AX,[ss:SC_CACHE_PTR]	    ;AN000;LB. add SC starting addr
 31445                                  	ADC	DX,[ss:SC_CACHE_PTR+2]	    ;AN000;LB.
 31446                                  	MOV	DS,DX			    ;AN000;LB. DS:SI-> SC sector addr
 31447                                  	MOV	SI,AX			    ;AN000;LB.
 31448                                  	MOV	ES,[ss:CALLXAD+2]		    ;AN000;LB. ES:DI-> buffer addr
 31449                                  	MOV	DI,[ss:CALLXAD]		    ;AN000;LB.
 31450                                  	; 24/09/2023
 31451                                  	;MOV	CX,[ss:SC_SECTOR_SIZE]	    ;AN000;LB. count= sector size
 31452                                  	SHR	CX,1			    ;AN000;LB. may use DWORD move for 386
 31453                                  ;entry MOVWORDS
 31454                                  MOVWORDS:				    ;AN000;
 31455                                  	CMP	byte [ss:DDMOVE],0	    ;AN000;LB. 386 ?
 31456                                  	JZ	short nodd		    ;AN000;LB. no
 31457                                  	SHR	CX,1			    ;AN000;LB. words/2
 31458                                  	DB	66H			    ;AN000;LB. use double word move
 31459                                  nodd:
 31460                                  	REP	MOVSW			    ;AN000;LB. move to buffer
 31461                                  	CLC				    ;AN000;LB. clear carry
 31462                                  	retn				    ;AN000;LB. exit
 31463                                  noSC:					    ;AN000;
 31464                                  	STC				    ;AN000;LB. set carry
 31465                                  sexit:					    ;AN000;
 31466                                  	retn				    ;AN000;LB.
 31467                                  
 31468                                  %endif	; SC
 31469                                  
 31470                                  ;============================================================================
 31471                                  ; MKNODE.ASM, MSDOS 6.0, 1991
 31472                                  ;============================================================================
 31473                                  ; 29/07/2018 - Retro DOS v3.0
 31474                                  ; 19/05/2019 - Retro DOS v4.0
 31475                                  ; 22/02/2024 - Retro DOS v5.0
 31476                                  
 31477                                  ;	TITLE	MKNODE - Node maker
 31478                                  ;	NAME	MKNODE
 31479                                  
 31480                                  ;**	MKNODE.ASM
 31481                                  ;----------------------------------------------------------------------------
 31482                                  ;	Low level routines for making a new local file system node
 31483                                  ;	and filling in an SFT from a directory entry
 31484                                  ;
 31485                                  ;	BUILDDIR
 31486                                  ;	SETDOTENT
 31487                                  ;	MakeNode
 31488                                  ;	NEWENTRY
 31489                                  ;	FREEENT
 31490                                  ;	NEWDIR
 31491                                  ;	DOOPEN
 31492                                  ;	RENAME_MAKE
 31493                                  ;	CHECK_VIRT_OPEN
 31494                                  ;
 31495                                  ;	Revision history:
 31496                                  ;
 31497                                  ;	 AN000	version 4.0  Jan. 1988
 31498                                  ;	 A004	PTM 3680  --- Make SFT NAME field offset same as 3.30
 31499                                  
 31500                                  ;Break   <BUILDDIR,NEWDIR -- ALLOCATE DIRECTORIES>
 31501                                  ;----------------------------------------------------------------------------
 31502                                  ;
 31503                                  ; Procedure Name : BUILDDIR,NEWDIR
 31504                                  ;
 31505                                  ; Inputs:
 31506                                  ;       ES:BP Points to DPB
 31507                                  ;       [THISSFT] Set if using NEWDIR entry point
 31508                                  ;               (used by ALLOCATE)
 31509                                  ;       [LASTENT] current last valid entry number in directory if no free
 31510                                  ;               entries
 31511                                  ;       [DIRSTART] Points to first cluster of dir (0 means root)
 31512                                  ; Function:
 31513                                  ;       Grow directory if no free entries and not root
 31514                                  ; Outputs:
 31515                                  ;       CARRY SET IF FAILURE
 31516                                  ;       ELSE
 31517                                  ;          AX entry number of new entry
 31518                                  ;          If a new dir [DIRSTART],[CLUSFAC],[CLUSNUM],[DIRSEC] set
 31519                                  ;               AX = first entry of new dir
 31520                                  ;       GETENT should be called to set [LASTENT]
 31521                                  ;
 31522                                  ;----------------------------------------------------------------------------
 31523                                  
 31524                                  ; 19/05/2019 - Retro DOS v4.0
 31525                                  ; DOSCODE:8845h (MSDOS 6.21, MSDOS.SYS)
 31526                                  ; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 31527                                  ; DOSCODE:880Ah (MSDOS 6.21, MSDOS.SYS)
 31528                                  
 31529                                  ; 24/09/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 MSDOS.SYS)
 31530                                  ; DOSCODE:8845h (MSDOS 6.22, MSDOS.SYS)
 31531                                  
 31532                                  ; 23/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 31533                                  ; DOSCODE:940Ah (PCDOS 7.1, IBMDOS.COM)
 31534                                  
 31535                                  ; (Windows ME IO.SYS - BIOSCODE:890Ch)
 31536                                  
 31537                                  BUILDDIR:
 31538                                  	; 29/07/2018 - Retro DOS v3.0
 31539                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 4E66h
 31540                                  
 31541 00005377 A1[D805]                	MOV	AX,[ENTFREE]
 31542 0000537A 83F8FF                  	CMP	AX,-1 ; 0FFFFh
 31543                                  	;JZ	short CHECK_IF_ROOT
 31544                                  	;CLC
 31545                                  	;retn
 31546                                  	; 24/09/2023
 31547 0000537D 750E                    	jne	short builddir_cmc_retn  ; cf=1 (will be 0)
 31548                                  
 31549                                  CHECK_IF_ROOT:
 31550                                  	; 23/02/2024 (PCDOS 7.1 IBMDOS.COM)
 31551                                  	;;;
 31552 0000537F 833E[DC0A]00            	cmp	word [DIRSTART_HW],0
 31553 00005384 7509                    	jnz	short NEWDIR 
 31554                                  	;;;
 31555 00005386 833E[C205]00            	CMP	word [DIRSTART],0
 31556 0000538B 7502                    	JNZ	short NEWDIR
 31557                                  	;STC				; Can't grow root
 31558                                  	; 24/09/2023
 31559                                  	; [DIRSTART]=0, cf=0, zf=1 (cf will be 1 after cmc instruction)
 31560                                  builddir_cmc_retn:
 31561                                  	; 24/09/2023
 31562 0000538D F5                      	cmc	; cf=1 <-> cf=0
 31563                                  builddir_retn:
 31564 0000538E C3                      	retn
 31565                                  
 31566                                  	;entry   NEWDIR
 31567                                  NEWDIR: 
 31568                                  	; 23/02/2024
 31569                                  	;;;
 31570 0000538F 8B1E[DC0A]              	mov	bx,[DIRSTART_HW]
 31571 00005393 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 31572 00005397 09DB                    	or	bx,bx
 31573                                  	;;;
 31574 00005399 8B1E[C205]              	MOV	BX,[DIRSTART]
 31575                                  	;;;
 31576 0000539D 7504                    	jnz	short NEWDIR2 ; 23/02/2024
 31577                                  	;;;
 31578 0000539F 09DB                    	OR	BX,BX
 31579 000053A1 7405                    	JZ	short NULLDIR
 31580                                  NEWDIR2:
 31581 000053A3 E8C208                  	call	GETEOF
 31582 000053A6 72E6                    	jc	short builddir_retn	; Screw up
 31583                                  NULLDIR:
 31584                                  	;MOV	CX,1
 31585                                  	; 23/02/2024
 31586                                  	;;;
 31587 000053A8 31C9                    	xor	cx,cx
 31588 000053AA 890E[F00A]              	mov	[CCOUNT_HW],cx ; 0
 31589 000053AE 41                      	inc	cx ; 1
 31590                                  	;;;
 31591 000053AF E84806                  	call	ALLOCATE
 31592 000053B2 72DA                    	jc	short builddir_retn
 31593 000053B4 8B16[C205]              	MOV	DX,[DIRSTART]
 31594                                  	; 23/02/2024
 31595                                  	;;;
 31596 000053B8 3B16[DC0A]              	cmp	dx,[DIRSTART_HW]
 31597 000053BC 7519                    	jnz	short ADDINGDIR
 31598                                  	;;;
 31599 000053BE 09D2                    	OR	DX,DX
 31600 000053C0 7515                    	JNZ	short ADDINGDIR
 31601                                  	; 23/02/2024
 31602                                  	;;;
 31603 000053C2 FF36[E80A]              	push	word [CLUSTNUM_HW]
 31604 000053C6 8F06[EE0A]              	pop	word [ROOTCLUST_HW]
 31605                                  	;;;
 31606 000053CA E89EF5                  	call	SETDIRSRCH
 31607 000053CD 72BF                    	jc	short builddir_retn
 31608 000053CF C706[4803]FFFF          	MOV	word [LASTENT],-1
 31609 000053D5 EB3F                    	JMP	SHORT GOTDIRREC
 31610                                  ADDINGDIR:
 31611 000053D7 53                      	PUSH    BX
 31612                                  	; 23/02/2024
 31613                                  	;;;
 31614 000053D8 FF36[E80A]              	push	word [CLUSTNUM_HW]
 31615                                  	;
 31616 000053DC 8B1E[DE0A]              	mov	bx,[CLUSNUM_HW]
 31617 000053E0 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 31618                                  	;;;
 31619 000053E4 8B1E[BC05]              	MOV	BX,[CLUSNUM]
 31620 000053E8 E8FC0E                  	call	IsEOF
 31621                                  	;;;
 31622 000053EB 8F06[E80A]              	pop	word [CLUSTNUM_HW] ; 23/02/2024
 31623                                  	;;;
 31624 000053EF 5B                      	POP	BX
 31625 000053F0 721D                    	JB	short NOTFIRSTGROW
 31626                                  ;;;; 10/17/86 update CLUSNUM in the fastopen cache
 31627 000053F2 891E[BC05]              	MOV	[CLUSNUM],BX
 31628                                  	; 24/09/2023
 31629                                  	;PUSH	CX ; (not necessary)
 31630 000053F6 50                      	PUSH	AX
 31631 000053F7 55                      	PUSH	BP
 31632                                  	; 23/02/2024
 31633                                  	;;;
 31634 000053F8 A1[E80A]                	mov	ax,[CLUSTNUM_HW]
 31635 000053FB A3[DE0A]                	mov	[CLUSNUM_HW],ax
 31636                                  	;;;
 31637 000053FE B401                    	MOV	AH,1			; CLUSNUM update
 31638                                  	; 15/12/2022
 31639 00005400 268A5600                	mov	dl,[ES:BP] ; 09/09/2018
 31640                                  	; 22/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 31641                                  	;;mov	dl,[es:bp+0]
 31642                                  	;MOV	DL,[ES:BP+DPB.DRIVE]	; drive #
 31643 00005404 8B0E[C205]              	MOV	CX,[DIRSTART]		; first cluster #
 31644 00005408 89DD                    	MOV	BP,BX 			; CLUSNUM
 31645 0000540A E85BD9                  	call	FastOpen_Update
 31646 0000540D 5D                      	POP	BP
 31647 0000540E 58                      	POP	AX
 31648                                  	; 24/09/2023
 31649                                  	;POP	CX
 31650                                  
 31651                                  ;;;; 10/17/86 update CLUSNUM in the fastopen cache
 31652                                  NOTFIRSTGROW:
 31653 0000540F 89DA                    	MOV	DX,BX
 31654 00005411 30DB                    	XOR	BL,BL
 31655 00005413 E8A205                  	call	FIGREC
 31656                                  GOTDIRREC:
 31657                                  	;mov	cl,[es:bp+4]
 31658 00005416 268A4E04                	MOV	CL,[ES:BP+DPB.CLUSTER_MASK]
 31659 0000541A FEC1                    	INC	CL
 31660 0000541C 30ED                    	XOR	CH,CH
 31661                                  ZERODIR:
 31662 0000541E 51                      	PUSH    CX
 31663                                  	; 22/09/2023
 31664                                  	;;mov	byte [ALLOWED],18h
 31665                                  	;MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY ; *
 31666 0000541F B0FF                    	MOV	AL,0FFH
 31667                                  	;call	GETBUFFR
 31668 00005421 E83715                  	call	GETBUFFRD ; *
 31669 00005424 7302                    	JNC	short GET_SSIZE
 31670 00005426 59                      	POP	CX
 31671 00005427 C3                      	retn
 31672                                  
 31673                                  GET_SSIZE:
 31674                                  	;mov	cx,[es:bp+2]
 31675 00005428 268B4E02                	MOV	CX,[ES:BP+DPB.SECTOR_SIZE]
 31676 0000542C 06                      	PUSH    ES
 31677 0000542D C43E[E205]              	LES	DI,[CURBUF]
 31678                                  	;or	byte [es:di+5],4
 31679 00005431 26804D0504              	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_isDIR
 31680 00005436 57                      	PUSH    DI
 31681                                  	;;;add	di,16	; MSDOS 3.3
 31682                                  	;;add	di,20	; MSDOS 6.0	
 31683                                  	;add	di,24	; PCDOS 7.1 ; 23/02/2024
 31684 00005437 83C718                  	ADD	DI,BUFINSIZ
 31685 0000543A 31C0                    	XOR	AX,AX
 31686 0000543C D1E9                    	SHR	CX,1
 31687 0000543E F3AB                    	REP	STOSW
 31688 00005440 7301                    	JNC	short EVENZ
 31689 00005442 AA                      	STOSB
 31690                                  EVENZ:
 31691 00005443 5F                      	POP	DI
 31692                                  
 31693                                  ; 23/02/2024
 31694                                  %if 0
 31695                                  	; MSDOS 6.0
 31696                                  	TEST	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 31697                                  					;LB. if already dirty		  ;AN000;
 31698                                  	JNZ	short yesdirty7		;LB.  don't increment dirty count ;AN000;
 31699                                  	call	INC_DIRTY_COUNT		;LB. 				  ;AN000;
 31700                                  	
 31701                                  	;or	byte [es:di+5],40h
 31702                                  	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 31703                                  %else
 31704                                  	; 23/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 31705 00005444 E8A417                  	call    SET_BUF_DIRTY
 31706                                  %endif
 31707                                  
 31708                                  yesdirty7:
 31709 00005447 07                      	POP	ES
 31710 00005448 59                      	POP	CX
 31711                                  
 31712                                  	; 19/05/2019 - Retro DOS v4.0
 31713                                  
 31714                                  	; MSDOS 3.3
 31715                                  	;INC	DX
 31716                                  
 31717                                  	; MSDOS 6.0
 31718                                  	; 24/09/2023
 31719                                  	;add	dx,1
 31720                                  	;;adc	word [HIGH_SECTOR],0
 31721                                  	;; 24/09/2023
 31722                                  	;; ax=0
 31723                                  	;adc	[HIGH_SECTOR],ax ; 0
 31724                                  	; 24/09/2023
 31725 00005449 42                      	inc	dx
 31726 0000544A 7504                    	jnz	short loop_zerodir
 31727 0000544C FF06[0706]              	inc	word [HIGH_SECTOR]
 31728                                  loop_zerodir:
 31729 00005450 E2CC                    	LOOP	ZERODIR
 31730                                  
 31731 00005452 A1[4803]                	MOV	AX,[LASTENT]
 31732 00005455 40                      	INC	AX
 31733                                  	; 24/09/2023
 31734                                  	; cf=0
 31735                                  	;CLC
 31736 00005456 C3                      	retn
 31737                                  
 31738                                  ;--------------------------------------------------------------------------
 31739                                  ;
 31740                                  ; Procedure Name : SETDOTENT
 31741                                  ;
 31742                                  ; set up a . or .. directory entry for a directory.
 31743                                  ;
 31744                                  ;   Inputs:     ES:DI point to the beginning of a directory entry.
 31745                                  ;               AX contains ". " or ".."
 31746                                  ;               DX contains first cluster of entry
 31747                                  ;
 31748                                  ;----------------------------------------------------------------------------
 31749                                  
 31750                                  	; 23/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 31751                                  
 31752                                  SETDOTENT:
 31753                                  ;	Fill in name field
 31754 00005457 AB                      	STOSW
 31755 00005458 B90400                  	MOV	CX,4
 31756 0000545B B82020                  	MOV	AX,"  " ; 2020h
 31757 0000545E F3AB                    	REP	STOSW
 31758 00005460 AA                      	STOSB
 31759                                  
 31760                                  ;	Set up attribute
 31761                                  	;mov	al, 10h
 31762 00005461 B010                    	MOV	AL,attr_directory
 31763 00005463 AA                      	STOSB
 31764                                  
 31765                                  ;	Initialize time and date of creation
 31766                                  	;ADD	DI,10
 31767                                  	; 23/04/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 31768                                  	;;;
 31769 00005464 83C708                  	add	di,8
 31770 00005467 A1[F20A]                	mov	ax,[CLUSTERS_HW]
 31771 0000546A AB                      	stosw		; Set up first cluster field (hw)
 31772                                  	;;;	
 31773 0000546B 8B36[9E05]              	MOV	SI,[THISSFT]
 31774                                  	;mov	ax,[si+0Dh]
 31775 0000546F 8B440D                  	MOV	AX,[SI+SF_ENTRY.sf_time]
 31776 00005472 AB                      	STOSW
 31777                                  	;mov	ax,[si+0Fh]
 31778 00005473 8B440F                  	MOV	AX,[SI+SF_ENTRY.sf_date]
 31779 00005476 AB                      	STOSW
 31780                                  
 31781                                  ;	Set up first cluster field (lw)
 31782 00005477 89D0                    	MOV	AX,DX
 31783 00005479 AB                      	STOSW
 31784                                  
 31785                                  ;	0 file size
 31786                                  	;XOR	AX,AX
 31787 0000547A 91                      	xchg	ax,cx ; 23/02/2024
 31788 0000547B AB                      	STOSW
 31789 0000547C AB                      	STOSW
 31790 0000547D C3                      	retn
 31791                                  
 31792                                  ;Break   <MAKENODE -- CREATE A NEW NODE>
 31793                                  ;---------------------------------------------------------------------------
 31794                                  ;
 31795                                  ; Procedure Name : MakeNode
 31796                                  ;
 31797                                  ; Inputs:
 31798                                  ;       AL - attribute to create
 31799                                  ;       AH = 0 if it is ok to truncate a file already by this name
 31800                                  ;	AH != 0 if truncation not allowed (prexisting file is an error)
 31801                                  ;               (AH ignored on dirs and devices)
 31802                                  ;
 31803                                  ;        NOTE: When making a DIR or volume ID, AH need not be set since
 31804                                  ;               a name already existant is ALWAYS an error in these cases.
 31805                                  ;
 31806                                  ;       [WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 31807                                  ;               terminated)
 31808                                  ;       [CURR_DIR_END] Points to end of Current dir part of string
 31809                                  ;               ( = -1 if current dir not involved, else
 31810                                  ;                Points to first char after last "/" of current dir part)
 31811                                  ;       [THISCDS] Points to CDS being used
 31812                                  ;       [THISSFT] Points to an empty SFT. EXCEPT sf_mode filled in.
 31813                                  ; Function:
 31814                                  ;       Make a new node
 31815                                  ; Outputs:
 31816                                  ;       Sets EXTERR_LOCUS = errLOC_Disk or errLOC_Unk via GetPathNoset
 31817                                  ;       CARRY SET IF ERROR
 31818                                  ;          AX = 1 A node by this name exists and is a directory
 31819                                  ;          AX = 2 A new node could not be created
 31820                                  ;          AX = 3 A node by this name exists and is a disk file
 31821                                  ;               (AH was NZ on input)
 31822                                  ;          AX = 4 Bad Path
 31823                                  ;               SI return from GetPath maintained
 31824                                  ;          AX = 5 Attribute mismatch
 31825                                  ;          AX = 6 Sharing Violation
 31826                                  ;               (INT 24 generated ALWAYS since create is always compat mode
 31827                                  ;          AX = 7 file not found for Extended Open (not exists and fails)
 31828                                  ;       ELSE
 31829                                  ;          AX = 0 Disk Node
 31830                                  ;          AX = 3 Device Node (error in some cases)
 31831                                  ;          [DIRSTART],[DIRSEC],[CLUSFAC],[CLUSNUM] set to directory
 31832                                  ;               containing new node.
 31833                                  ;          [CURBUF+2]:BX Points to entry
 31834                                  ;          [CURBUF+2]:SI Points to entry.dir_first
 31835                                  ;          [THISSFT] is filled in
 31836                                  ;               sf_mode = unchanged.
 31837                                  ;          Attribute byte in entry is input AL
 31838                                  ; DS preserved, others destroyed
 31839                                  ;
 31840                                  ;-------------------------------------------------------------------------
 31841                                  
 31842                                  ; 19/05/2019 - Retro DOS v4.0
 31843                                  ; DOSCODE:8925h (MSDOS 6.21, MSDOS.SYS)
 31844                                  
 31845                                  ; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 31846                                  ; DOSCODE:88EAh (MSDOS 5.0, MSDOS.SYS)
 31847                                  
 31848                                  ; 23/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 31849                                  ; DOSCODE:951Ah (PCDOS 7.1, IBMDOS.COM)
 31850                                  
 31851                                  MakeNode:
 31852                                  	;mov	word [CREATING],0E5FFh
 31853 0000547E C706[7E05]FFE5          	MOV	WORD [CREATING],DIRFREE*256 + 0FFh ; Creating, not DEL *.*
 31854 00005484 50                      	PUSH	AX 		; Save AH value
 31855 00005485 C606[4C03]00            	MOV	byte [NoSetDir],0
 31856 0000548A A2[6D05]                	MOV	[SATTRIB],AL
 31857 0000548D E899F6                  	call	GetPathNoSet
 31858 00005490 88CA                    	MOV	DL,CL		; Save CL info
 31859                                  	;MOV	CX,AX		; Device ID to CH
 31860                                  	; 23/02/2024
 31861 00005492 91                      	xchg	ax,cx
 31862 00005493 58                      	POP	AX		; Get back AH
 31863 00005494 732D                    	JNC	short make_exists ; File existed
 31864 00005496 7505                    	JNZ	short make_err_4 ; Path bad
 31865 00005498 80FA80                  	CMP	DL,80h		; Check "CL" return from GETPATH
 31866 0000549B 7405                    	JZ	short make_type	; Name simply not found, and no metas
 31867                                  make_err_4:
 31868 0000549D B004                    	MOV	AL,4		; case 1 bad path
 31869                                  make_err_ret:
 31870                                  	;XOR	AH,AH
 31871                                  	; 23/02/2024
 31872 0000549F 98                      	cbw
 31873 000054A0 F9                      	STC
 31874                                  ;make_retn:	; 22/11/2022
 31875 000054A1 C3                      	retn
 31876                                  
 31877                                  	;entry	RENAME_MAKE	; Used by DOS_RENAME to "copy" a node
 31878                                  RENAME_MAKE:
 31879                                  make_type:
 31880                                  ;Extended Open hooks
 31881                                  	; MSDOS 6.0
 31882                                  	;TESTB	EXTOPEN_ON,EXT_OPEN_ON	;FT. from extended open		;AN000;
 31883 000054A2 F606[F605]01            	test	byte [EXTOPEN_ON],EXT_OPEN_ON ; 1
 31884 000054A7 7411                    	JZ	short make_type2	;FT. no				;AN000;
 31885 000054A9 800E[F605]04            	OR	byte [EXTOPEN_ON],EXT_FILE_NOT_EXISTS ; 4
 31886                                  					;FT. set for extended open ;AN000;
 31887                                  	;TESTB	EXTOPEN_FLAG,0F0H	;FT. not exists and fails	;AN000;
 31888 000054AE F606[F405]F0            	test	byte [EXTOPEN_FLAG],0F0h
 31889 000054B3 7505                    	JNZ	short make_type2	;FT. no				;AN000;
 31890 000054B5 F9                      	STC				;FT. set carry			;AN000;
 31891 000054B6 B80700                  	MOV    AX,7			;FT. file not found		;AN000;
 31892                                  	; 22/11/2022
 31893                                  make_retn:
 31894                                  	;return
 31895 000054B9 C3                      	retn				;FT.				;AN000;
 31896                                  
 31897                                  ;	Extended Open hooks
 31898                                  
 31899                                  make_type2:
 31900 000054BA C43E[9E05]              	LES	DI,[THISSFT]
 31901 000054BE 31C0                    	XOR	AX,AX		; nothing exists Disk Node
 31902 000054C0 F9                      	STC			; Not found
 31903 000054C1 EB59                    	JMP	short make_new
 31904                                  
 31905                                  ; The node exists. It may be either a device, directory or file:
 31906                                  ;   Zero set => directory
 31907                                  ;   High bit of CH on => device
 31908                                  ;   else => file
 31909                                  
 31910                                  make_exists:
 31911 000054C3 7447                    	JZ	short make_exists_dir
 31912 000054C5 B003                    	MOV	AL,3		; file exists type 3  (error or device node)
 31913                                  	;test	byte [ATTRIB],18h
 31914 000054C7 F606[6B05]18            	TEST	byte [ATTRIB],attr_volume_id+attr_directory
 31915 000054CC 753A                    	JNZ	short make_err_ret_5
 31916                                  				; Cannot already exist as Disk or Device Node
 31917                                  				;  if making DIR or Volume ID
 31918 000054CE 08ED                    	OR	CH,CH
 31919 000054D0 781A                    	JS	short make_share ; No further checks on attributes if device
 31920 000054D2 08E4                    	OR	AH,AH
 31921 000054D4 75C9                    	JNZ	short make_err_ret ; truncating NOT OK (AL = 3)
 31922 000054D6 51                      	PUSH	CX		; Save device ID
 31923 000054D7 8E06[E405]              	MOV	ES,[CURBUF+2]
 31924                                  	;mov	ch,[es:bx+0Bh]
 31925 000054DB 268A6F0B                	MOV	CH,[ES:BX+dir_entry.dir_attr] ; Get file attributes
 31926                                  	;test	ch,1
 31927 000054DF F6C501                  	test	CH,attr_read_only
 31928 000054E2 7523                    	JNZ	short make_err_ret_5P ; Cannot create on read only files
 31929 000054E4 E8FBF8                  	call	MatchAttributes
 31930 000054E7 59                      	POP	CX		; Devid back in CH
 31931 000054E8 751E                    	JNZ	short make_err_ret_5 ; Attributes not ok
 31932 000054EA 30C0                    	XOR	AL,AL		; AL = 0, Disk Node
 31933                                  
 31934                                  make_share:
 31935                                  	;XOR	AH,AH
 31936                                  	; 23/02/2024
 31937 000054EC 98                      	cbw
 31938 000054ED 50                      	PUSH	AX		; Save Disk or Device node
 31939 000054EE 51                      	PUSH	CX		; Save Device ID
 31940 000054EF 88EC                    	MOV	AH,CH		; Device ID to AH
 31941 000054F1 E83201                  	CALL	DOOPEN		; Fill in SFT for share check
 31942 000054F4 C43E[9E05]              	LES	DI,[THISSFT]
 31943 000054F8 56                      	push	si
 31944 000054F9 53                      	push	bx		; Save CURBUF pointers
 31945 000054FA E8C02F                  	call	ShareEnter
 31946 000054FD 734E                    	jnc	short MakeEndShare
 31947                                  
 31948                                  ; User failed request.
 31949 000054FF 5B                      	pop	bx
 31950 00005500 5E                      	pop	si
 31951 00005501 59                      	pop	cx
 31952 00005502 58                      	pop	ax
 31953                                  
 31954                                  Make_Share_ret:
 31955 00005503 B006                    	MOV	AL,6
 31956 00005505 EB98                    	JMP	short make_err_ret
 31957                                  
 31958                                  make_err_ret_5P:
 31959 00005507 59                      	POP	CX		; Get back device ID
 31960                                  make_err_ret_5:
 31961 00005508 B005                    	MOV     AL,5		; Attribute mismatch
 31962                                          ; 22/11/2022
 31963 0000550A EB93                    	JMP	short make_err_ret
 31964                                  
 31965                                  make_exists_dir:
 31966 0000550C B001                    	MOV	AL,1		; exists as directory, always an error
 31967                                  	; 22/11/2022
 31968 0000550E EB8F                    	JMP	short make_err_ret
 31969                                  
 31970                                  make_save:
 31971 00005510 50                      	PUSH	AX		; Save whether Disk or File
 31972 00005511 89C8                    	MOV	AX,CX		; Device ID to AH
 31973 00005513 E86800                  	CALL	NEWENTRY
 31974 00005516 58                      	POP	AX		; 0 if Disk, 3 if File
 31975 00005517 73A0                    	jnc	short make_retn
 31976 00005519 B002                    	MOV	AL,2		; create failed case 2
 31977                                  make_save_retn:
 31978 0000551B C3                      	retn
 31979                                  
 31980                                  make_new:
 31981 0000551C E8F1FF                  	call	make_save
 31982 0000551F 72FA                    	jc	short make_save_retn	; case 2 fail
 31983                                  	;test	byte [ATTRIB],10h
 31984 00005521 F606[6B05]10            	test	BYTE [ATTRIB],attr_directory
 31985 00005526 75F3                    	jnz	short make_save_retn	; Don't "open" directories,
 31986                                  					; so don't tell the sharer about them
 31987 00005528 50                      	push	ax
 31988 00005529 53                      	push	bx
 31989 0000552A 56                      	push	si
 31990 0000552B E88F2F                  	call	ShareEnter
 31991 0000552E 5E                      	pop	si
 31992 0000552F 5B                      	pop	bx
 31993 00005530 58                      	pop	ax
 31994 00005531 73E8                    	jnc	short make_save_retn
 31995                                  
 31996                                  ; We get here by having the user FAIL a share problem. Typically a failure of
 31997                                  ; this nature is an out-of-space or an internal error. We clean up as best as
 31998                                  ; possible: delete the newly created directory entry and return share_error.
 31999                                  
 32000 00005533 50                      	PUSH	AX
 32001 00005534 C43E[E205]              	LES	DI,[CURBUF]
 32002                                  	;mov	byte [es:bx],0E5h
 32003 00005538 26C607E5                	MOV	BYTE [ES:BX],DIRFREE	; nuke newly created entry.
 32004                                  
 32005                                  ; 23/02/2024
 32006                                  %if 0	
 32007                                  	; MSDOS 6.0
 32008                                  	;test	byte [es:di+5],40h
 32009                                  	TEST	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty  
 32010                                  					;LB. if already dirty		  ;AN000;
 32011                                  	JNZ	short yesdirty8		;LB.  don't increment dirty count ;AN000;
 32012                                  	; 22/11/2022
 32013                                  	call	INC_DIRTY_COUNT		;LB.				  ;AN000;
 32014                                  	;or	byte [es:di+5],40h
 32015                                  	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty ; flag buffer as dirty
 32016                                  yesdirty8:
 32017                                  %else
 32018                                  	; 23/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 32019 0000553C E8AC16                  	call    SET_BUF_DIRTY	
 32020                                  %endif
 32021 0000553F C42E[8A05]              	LES	BP,[THISDPB]
 32022                                  	; 15/12/2022
 32023 00005543 268A4600                	mov	al,[ES:BP]
 32024                                  	; 22/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 32025                                  	;;mov	al,[es:bp+0]
 32026                                  	;MOV	AL,[ES:BP+DPB.DRIVE]	; get drive for flush
 32027 00005547 E87B15                  	call	FLUSHBUF		; write out buffer.
 32028 0000554A 58                      	POP	AX
 32029 0000554B EBB6                    	jmp	short Make_Share_ret
 32030                                  
 32031                                  ; We have found an existing file. We have also entered it into the share set.
 32032                                  ; At this point we need to call newentry to correctly address the problem of
 32033                                  ; getting rid of old data (create an existing file) or creating a new
 32034                                  ; directory entry (create a new file). Unfortunately, this operation may
 32035                                  ; result in an INT 24 that the user doesn't return from, thus locking the file
 32036                                  ; irretrievably into the share set. The correct solution is for us to LEAVE
 32037                                  ; the share set now, do the operation and then reassert the share access.
 32038                                  ;
 32039                                  ; We are allowed to do this! There is no window! After all, we are in
 32040                                  ; critDisk here and for someone else to get in, they must enter critDisk also.
 32041                                  
 32042                                  	; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 32043                                  	; DOSCODE:89C8h (MSDOS 5.0, MSDOS.SYS)
 32044                                  
 32045                                  MakeEndShare:
 32046 0000554D C43E[9E05]              	LES	DI,[THISSFT]		; grab SFT
 32047 00005551 31C0                    	XOR	AX,AX
 32048 00005553 E88DC3                  	call	ECritSFT
 32049 00005556 268705                  	xchg	AX,[ES:DI]
 32050                                  	;XCHG	AX,[ES:DI+SF_ENTRY.sf_ref_count]
 32051 00005559 50                      	push	ax
 32052 0000555A 57                      	push	di
 32053 0000555B 06                      	push	es
 32054 0000555C 9C                      	PUSHF
 32055 0000555D E8582F                  	call	ShareEnd		; remove sharing
 32056 00005560 9D                      	POPF
 32057 00005561 07                      	pop	es
 32058 00005562 5F                      	pop	di
 32059 00005563 268F05                  	pop	word [ES:DI]
 32060                                  	;pop	word [ES:DI+SF_ENTRY.sf_ref_count]
 32061 00005566 E8A7C3                  	call	LCritSFT
 32062                                  	; 22/11/2022
 32063                                  	; DOSCODE:89E4h (MSDOS 5.0, MSDOS.SYS)
 32064 00005569 5B                      	pop	bx
 32065 0000556A 5E                      	pop	si
 32066 0000556B 59                      	pop	cx
 32067 0000556C 58                      	pop	ax
 32068 0000556D E8A0FF                  	CALL	make_save
 32069                                  
 32070                                  ; If the user failed, we do not reenter into the sharing set.
 32071                                  
 32072 00005570 72A9                    	jc	short make_save_retn	; bye if error
 32073 00005572 50                      	push	ax
 32074 00005573 53                      	push	bx
 32075 00005574 56                      	push	si
 32076 00005575 9C                      	PUSHF
 32077 00005576 E8442F                  	call	ShareEnter
 32078 00005579 9D                      	POPF
 32079 0000557A 5E                      	pop	si
 32080 0000557B 5B                      	pop	bx
 32081 0000557C 58                      	pop	ax
 32082                                  
 32083                                  ; If Share_check fails, then we have an internal ERROR!!!!!
 32084                                  
 32085                                  makeendshare_retn:
 32086 0000557D C3                      	retn
 32087                                  
 32088                                  ;---------------------------------------------------------------------------
 32089                                  ;
 32090                                  ; Procedure Name : NEWENTRY
 32091                                  ;
 32092                                  ; Inputs:
 32093                                  ;	  [THISSFT] set
 32094                                  ;	  [THISDPB] set
 32095                                  ;	  [LASTENT] current last valid entry number in directory if no free
 32096                                  ;		  entries
 32097                                  ;	  [VOLID] set if a volume ID was found during search
 32098                                  ;	Attrib Contains attributes for new file
 32099                                  ;	  [DIRSTART] Points to first cluster of dir (0 means root)
 32100                                  ;	  CARRY FLAG INDICATES STATUS OF SEARCH FOR FILE
 32101                                  ;		  NC means file existed (device)
 32102                                  ;		  C  means file did not exist
 32103                                  ;	  AH = Device ID byte
 32104                                  ;	  If FILE
 32105                                  ;	  [CURBUF+2]:BX points to start of directory entry
 32106                                  ;	  [CURBUF+2]:SI points to dir_first of directory entry
 32107                                  ;	  If device
 32108                                  ;	  DS:BX points to start of "fake" directory entry
 32109                                  ;	  DS:SI points to dir_first of "fake" directory entry
 32110                                  ;		  (has DWORD pointer to device header)
 32111                                  ; Function:
 32112                                  ;	  Make a new directory entry
 32113                                  ;	  If an old one existed it is truncated first
 32114                                  ; Outputs:
 32115                                  ;	  Carry set if error
 32116                                  ;		  Can't grow dir, atts didn't match, attempt to make 2nd
 32117                                  ;		  vol ID, user FAILed to I 24
 32118                                  ;	  else
 32119                                  ;		  outputs of DOOPEN
 32120                                  ; DS, BX, SI preserved (meaning on SI BX, not value), others destroyed
 32121                                  ;
 32122                                  ;----------------------------------------------------------------------------
 32123                                  
 32124                                  	; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 32125                                  	; DOSCODE:89F9h (MSDOS 5.0, MSDOS.SYS)
 32126                                  
 32127                                  	; 23/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32128                                  	; DOSCODE:961Ah (PCDOS 7.1, IBMDOS.COM)
 32129                                  
 32130                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8A34h)
 32131                                  	; (Windows ME IO.SYS - BIOSCODE:8B7Dh)
 32132                                  
 32133                                  NEWENTRY:
 32134 0000557E C42E[8A05]              	LES	BP,[THISDPB]
 32135 00005582 7315                    	JNC	short EXISTENT	
 32136 00005584 803E[4A03]00            	CMP	byte [FAILERR],0
 32137                                  	;STC
 32138                                  	;jnz	short makeendshare_retn	; User FAILed, node might exist
 32139                                  	; 24/09/2023
 32140 00005589 750C                    	jnz	short ERRRET3
 32141 0000558B E8E9FD                  	CALL	BUILDDIR	; Try to build dir
 32142 0000558E 72ED                    	jc	short makeendshare_retn	; Failed
 32143 00005590 E81BF3                  	call	GETENT		; Point at that free entry
 32144 00005593 72E8                    	jc	short makeendshare_retn	; Failed
 32145 00005595 EB0E                    	JMP	SHORT FREESPOT
 32146                                  
 32147                                  ERRRET3:
 32148 00005597 F9                      	STC
 32149                                  newentry_retn:
 32150 00005598 C3                      	retn
 32151                                  
 32152                                  EXISTENT:
 32153 00005599 08E4                    	OR	AH,AH		; Check if file is I/O device
 32154 0000559B 7903                    	JNS	short NOT_DEV1
 32155 0000559D E98600                  	JMP	DOOPEN		; If so, proceed with open
 32156                                  
 32157                                  NOT_DEV1:
 32158 000055A0 E84D01                  	call	FREEENT	; Free cluster chain
 32159 000055A3 72F3                    	jc	short newentry_retn ; Failed
 32160                                  FREESPOT:
 32161                                  	;test	byte [ATTRIB],8
 32162 000055A5 F606[6B05]08            	test	BYTE [ATTRIB],attr_volume_id
 32163 000055AA 7407                    	JZ	short NOTVOLID
 32164 000055AC 803E[7B05]00            	CMP	BYTE [VOLID],0
 32165 000055B1 75E4                    	JNZ	short ERRRET3	; Can't create a second volume ID
 32166                                  NOTVOLID:
 32167 000055B3 8E06[E405]              	MOV	ES,[CURBUF+2]
 32168 000055B7 89DF                    	MOV	DI,BX
 32169                                  
 32170 000055B9 BE[4B05]                	MOV	SI,NAME1
 32171                                  
 32172 000055BC B90500                  	MOV	CX,5
 32173 000055BF F3A5                    	REP	MOVSW
 32174 000055C1 A4                      	MOVSB			; Move name into dir entry
 32175 000055C2 A0[6B05]                	MOV	AL,[ATTRIB]
 32176 000055C5 AA                      	STOSB			; Attributes
 32177                                  
 32178                                  ;; File Tagging for Create DOS 4.00
 32179 000055C6 B105                    	MOV	CL,5		;FT. assume normal FBUGBUG	;AN000;
 32180                                  ;; File Tagging for Create DOS 4.00
 32181                                  
 32182 000055C8 31C0                    	XOR	AX,AX
 32183 000055CA F3AB                    	REP	STOSW		; Zero pad
 32184 000055CC E88DB5                  	call	DATE16
 32185 000055CF 92                      	XCHG	AX,DX
 32186 000055D0 AB                      	STOSW			; dir_time
 32187 000055D1 92                      	XCHG	AX,DX
 32188                                  	; 23/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32189                                  	;;;
 32190 000055D2 268945FA                	mov	[es:di-6],ax	; last access date
 32191                                  	;;;
 32192 000055D6 AB                      	STOSW			; dir_date
 32193 000055D7 31C0                    	XOR	AX,AX
 32194 000055D9 57                      	PUSH	DI		; Correct SI input value
 32195                                  				; (recomputed for new buffer)
 32196 000055DA AB                      	STOSW			; Zero dir_first and size
 32197 000055DB AB                      	STOSW
 32198 000055DC AB                      	STOSW
 32199                                  updnxt:
 32200 000055DD 8B36[E205]              	MOV	SI,[CURBUF]
 32201                                  
 32202                                  	; 19/05/2019 - Retro DOS v4.0
 32203                                  
 32204                                  	; MSDOS 6.0
 32205 000055E1 26F6440540              	TEST	byte [ES:SI+BUFFINFO.buf_flags],buf_dirty
 32206                                  				;LB. if already dirty		  ;AN000;
 32207 000055E6 7508                    	JNZ	short yesdirty9	;LB.  don't increment dirty count ;AN000;
 32208 000055E8 E80C16                  	call	INC_DIRTY_COUNT	;LB.				  ;AN000;
 32209                                  	
 32210                                  	;or	byte [es:si+5],40h
 32211 000055EB 26804C0540              	OR	byte [ES:SI+BUFFINFO.buf_flags],buf_dirty
 32212                                  yesdirty9:
 32213 000055F0 C42E[8A05]              	LES	BP,[THISDPB]
 32214                                  	; 15/12/2022
 32215 000055F4 268A4600                	MOV	AL,[ES:BP]
 32216                                  	; 22/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 32217                                  	;;mov	al,[es:bp+0]
 32218                                  	;MOV	AL,[ES:BP+DPB.DRIVE] ; Sets AH value again (in AL)
 32219 000055F8 50                      	PUSH	AX
 32220 000055F9 53                      	PUSH	BX
 32221                                  
 32222                                  ; If we have a file, we need to increment the open ref. count so that
 32223                                  ; we have some protection against invalid media changes if an Int 24
 32224                                  ; error occurs.
 32225                                  ; Do nothing for a device.
 32226                                  
 32227 000055FA 06                      	push	es
 32228 000055FB 57                      	push	di
 32229 000055FC C43E[9E05]              	LES	DI,[THISSFT]
 32230                                  	;test	word [es:di+5],80h
 32231                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device
 32232 00005600 26F6450580              	test	byte [ES:DI+SF_ENTRY.sf_flags],devid_device
 32233 00005605 7512                    	jnz	short GotADevice
 32234 00005607 1E                      	push	ds
 32235 00005608 53                      	push	bx
 32236 00005609 C51E[8A05]              	LDS	BX,[THISDPB]
 32237                                  	;mov	[es:di+7],bx
 32238 0000560D 26895D07                	MOV	[ES:DI+SF_ENTRY.sf_devptr],BX
 32239 00005611 8CDB                    	MOV	BX,DS
 32240                                  	;mov	[es:di+9],bx
 32241 00005613 26895D09                	MOV	[ES:DI+SF_ENTRY.sf_devptr+2],BX
 32242 00005617 5B                      	pop	bx
 32243 00005618 1F                      	pop	ds ; need to use DS for segment later on
 32244                                  
 32245                                  ; 23/02/2024 Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 32246                                  %if 0
 32247                                  	call	DEV_OPEN_SFT	; increment ref. count
 32248                                  	mov	byte [VIRTUAL_OPEN],1; set flag
 32249                                  %endif
 32250                                  
 32251                                  GotADevice:
 32252 00005619 5F                      	pop	di
 32253 0000561A 07                      	pop	es
 32254                                  
 32255 0000561B E8A714                  	call	FLUSHBUF
 32256                                  
 32257                                  ; 23/02/2024 Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 32258                                  %if 0
 32259                                  	Call	CHECK_VIRT_OPEN	; decrement ref. count	;AN000;
 32260                                  %endif
 32261 0000561E 5B                      	POP	BX
 32262 0000561F 58                      	POP	AX
 32263 00005620 5E                      	POP	SI		; Get SI input back
 32264 00005621 88C4                    	MOV	AH,AL		; Get I/O driver number back
 32265 00005623 7301                    	jnc	short DOOPEN	
 32266 00005625 C3                      	retn			; Failed
 32267                                  	
 32268                                  ;NOTE FALL THROUGH
 32269                                  
 32270                                  ; DOSCODE:8AE4h (MSDOS 6.21, MSDOS.SYS)
 32271                                  
 32272                                  ; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 32273                                  ; DOSCODE:8AA9h (MSDOS 5.0, MSDOS.SYS)
 32274                                  
 32275                                  ; DOOPEN
 32276                                  ;----------------------------------------------------------------------------
 32277                                  ;
 32278                                  ; Inputs:
 32279                                  ;	  [THISDPB] points to DPB if file
 32280                                  ;	  [THISSFT] points to SFT being used
 32281                                  ;	  AH = Device ID byte
 32282                                  ;	  If FILE
 32283                                  ;	  [CURBUF+2]:BX points to start of directory entry
 32284                                  ;	  [CURBUF+2]:SI points to dir_first of directory entry
 32285                                  ;	  If device
 32286                                  ;	  DS:BX points to start of "fake" directory entry
 32287                                  ;	  DS:SI points to dir_first of "fake" directory entry
 32288                                  ;		  (has DWORD pointer to device header)
 32289                                  ; Function:
 32290                                  ;	  Fill in SFT from dir entry
 32291                                  ; Outputs:
 32292                                  ;	  CARRY CLEAR
 32293                                  ;	  sf_ref_count and sf_mode fields not altered
 32294                                  ;	  sf_flags high byte = 0
 32295                                  ;	  sf_flags low byte = AH except
 32296                                  ;	  sf_flags Bit 6 set (not dirty or not EOF)
 32297                                  ;	  sf_attr sf_date sf_time sf_name set from entry
 32298                                  ;	  sf_position = 0
 32299                                  ;	  If device
 32300                                  ;	  sf_devptr = dword at dir_first (pointer to device header)
 32301                                  ;	  sf_size = 0
 32302                                  ;	  If file
 32303                                  ;	  sf_firclus sf_size set from entry
 32304                                  ;	  sf_devptr = [THISDPB]
 32305                                  ;	  sf_cluspos = 0
 32306                                  ;	  sf_lstclus = sf_firclus
 32307                                  ;	  sf_dirsec sf_dirpos set
 32308                                  ; DS,SI,BX preserved, others destroyed
 32309                                  ;
 32310                                  ;----------------------------------------------------------------------------
 32311                                  
 32312                                  	; 23/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32313                                  	; DOSCODE:96C3h (PCDOS 7.1, IBMDOS.COM)
 32314                                  
 32315                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8AE4h)
 32316                                  	; (Windows ME IO.SYS - BIOSCODE:8C4Ch)
 32317                                  
 32318                                  	;entry	DOOPEN
 32319                                  DOOPEN:
 32320                                  ;	Generate and store attribute
 32321                                  
 32322 00005626 88E6                    	MOV	DH,AH	  	; AH to different place
 32323                                  	; 23/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32324                                  	;;;
 32325 00005628 30D2                    	xor	dl,dl ; 0
 32326 0000562A 08E4                    	or	ah,ah
 32327 0000562C 780D                    	js	short DEV_SFT0
 32328 0000562E C43E[8A05]              	les	di,[THISDPB]
 32329                                  	;cmp	word [es:di+0Fh],0
 32330 00005632 26837D0F00              	cmp	word [es:di+DPB.FAT_SIZE],0
 32331 00005637 7402                    	jz	short DEV_SFT0 ; FAT32
 32332 00005639 FEC2                    	inc	dl ; 1	
 32333                                  DEV_SFT0:
 32334                                  	;;;
 32335 0000563B C43E[9E05]              	LES	DI,[THISSFT]
 32336                                  	;add	di,4
 32337 0000563F 83C704                  	ADD	DI,SF_ENTRY.sf_attr ; Skip ref_count and mode fields
 32338                                  	; 24/09/2023
 32339 00005642 31C0                    	xor	ax,ax
 32340                                  	;XOR	AL,AL		; Assume it's a device, devices have an
 32341                                  				;  attribute of 0 (for R/O testing etc).
 32342 00005644 08F6                    	OR	DH,DH		; See if our assumption good.
 32343 00005646 7807                    	JS	short DEV_SFT1	; If device DS=DOSGROUP
 32344 00005648 8E1E[E405]              	MOV	DS,[CURBUF+2]
 32345                                  	;mov	al,[BX+0Bh]
 32346 0000564C 8A470B                  	MOV	AL,[BX+dir_entry.dir_attr]
 32347                                  				; If file, get attrib from dir entry
 32348                                  DEV_SFT1:
 32349 0000564F AA                      	STOSB			; sf_attr, ES:DI -> sf_flags
 32350                                  
 32351                                  ;	Generate and store flags word
 32352                                  
 32353                                  	; 24/09/2023
 32354                                  	;XOR	AX,AX
 32355                                  	; ah=0
 32356 00005650 88F0                    	MOV	AL,DH
 32357                                  	;or	al,40h
 32358 00005652 0C40                    	OR	AL,devid_file_clean
 32359 00005654 AB                      	STOSW			; sf_flags, ES:DI -> sf_devptr
 32360                                  
 32361                                  ;	Generate and store device pointer
 32362                                  
 32363 00005655 1E                      	PUSH	DS
 32364                                  	;lds	ax,[bx+1Ah]
 32365 00005656 C5471A                  	LDS	AX,[BX+dir_entry.dir_first] ; Assume device
 32366 00005659 08F6                    	OR	DH,DH
 32367 0000565B 7805                    	JS	short DEV_SFT2
 32368                                  
 32369                                  ;hkn; SS override
 32370 0000565D 36C506[8A05]            	LDS	AX,[SS:THISDPB]	; Was file
 32371                                  DEV_SFT2:
 32372 00005662 AB                      	STOSW			; store offset
 32373 00005663 8CD8                    	MOV	AX,DS
 32374 00005665 1F                      	POP	DS
 32375 00005666 AB                      	STOSW			; store segment
 32376                                  				; ES:DI -> sf_firclus
 32377                                  
 32378                                  ;	Generate pointer to, generate and store first cluster
 32379                                  ;	(irrelevant for devices)
 32380                                  
 32381 00005667 56                      	PUSH	SI		; Save pointer to dir_first
 32382                                  
 32383                                  ; 23/02/2024
 32384                                  %if 0
 32385                                  
 32386                                  	MOVSW			; dir_first -> sf_firclus
 32387                                  				; DS:SI -> dir_size_l, ES:DI -> sf_time
 32388                                  
 32389                                  ;	Copy time/date of last modification
 32390                                  
 32391                                  	;sub	si,6
 32392                                  	SUB	SI,dir_entry.dir_size_l - dir_entry.dir_time
 32393                                  %else
 32394                                  	; 23/02/2024 - Retro DOS v5.0
 32395                                  	; (PCDOS 7.1 IBMDOS.COM)
 32396                                  	;;;
 32397 00005668 83C720                  	add	di,32		; SF_ENTRY.sf_chain ; first cluster (32 bit) !?
 32398 0000566B A5                      	movsw			; first cluster, lw
 32399                                  	;add	si,0FFF8h
 32400 0000566C 83C6F8                  	add	si,-8
 32401 0000566F A5                      	movsw			; first cluster, hw
 32402                                  	;
 32403 00005670 08D2                    	or	dl,dl
 32404 00005672 7402                    	jz	short FILE_SFT0 ; FAT32
 32405 00005674 31C0                    	xor	ax,ax ; 0	; clear hw of first cluster (invalid)
 32406                                  FILE_SFT0:
 32407 00005676 AB                      	stosw
 32408                                  	;add	di,0FFDEh
 32409 00005677 83C7DE                  	add	di,-34		; SF_ENTRY.sf_time		
 32410                                  	;;;	
 32411                                  %endif
 32412                                  				; DS:SI->dir_time
 32413 0000567A A5                      	MOVSW			; dir_time -> sf_time
 32414                                  				; DS:SI -> dir_date, ES:DI -> sf_date
 32415 0000567B A5                      	MOVSW			; dir_date -> sf_date
 32416                                  				; DS:SI -> dir_first, ES:DI -> sf_size
 32417                                  
 32418                                  ;	Generate and store file size (0 for devices)
 32419                                  
 32420 0000567C AD                      	LODSW			; skip dir_first, DS:SI -> dir_size_l
 32421 0000567D AD                      	LODSW			; dir_size_l in AX, DS:SI -> dir_size_h
 32422                                  	;MOV	CX,AX		; dir_size_l in CX
 32423                                  	; 23/02/2024
 32424 0000567E 91                      	xchg	ax,cx
 32425 0000567F AD                      	LODSW			; dir_size_h (size AX:CX), DS:SI -> ????
 32426 00005680 08F6                    	OR	DH,DH
 32427 00005682 7904                    	JNS	short FILE_SFT1
 32428 00005684 31C0                    	XOR	AX,AX
 32429 00005686 89C1                    	MOV	CX,AX		; Devices are open ended
 32430                                  FILE_SFT1:
 32431 00005688 91                      	XCHG	AX,CX
 32432 00005689 AB                      	STOSW			; Low word of sf_size
 32433 0000568A 91                      	XCHG	AX,CX
 32434 0000568B AB                      	STOSW			; High word of sf_size
 32435                                  				; ES:DI -> sf_position
 32436                                  ; Initialize position to 0
 32437                                  
 32438 0000568C 31C0                    	XOR	AX,AX
 32439 0000568E AB                      	STOSW
 32440 0000568F AB                      	STOSW			; sf_position
 32441                                  				; ES:DI -> sf_cluspos
 32442                                  
 32443                                  ; Generate cluster optimizations for files
 32444                                  
 32445 00005690 08F6                    	OR	DH,DH
 32446 00005692 784E                    	JS	short DEV_SFT3
 32447 00005694 AB                      	STOSW			; sf_cluspos ; 19h
 32448                                  
 32449                                  ; 23/02/2024
 32450                                  %if 0
 32451                                  	;mov	ax,[bx+1Ah]
 32452                                  	MOV	AX,[BX+dir_entry.dir_first]
 32453                                  	; 19/05/2019
 32454                                  	; MSDOS 3.3
 32455                                  	;STOSW			; sf_lstclus ; 1Bh
 32456                                  	; MSDOS 6.0
 32457                                  	PUSH	DI		;AN004; save dirsec offset
 32458                                  	;sub	di,1Bh
 32459                                  	SUB	DI,SF_ENTRY.sf_dirsec	;AN004; es:di -> SFT
 32460                                  	;mov	[es:di+35h],ax
 32461                                  	MOV	[ES:DI+SF_ENTRY.sf_lstclus],AX	;AN004; save it
 32462                                  	POP	DI		;AN004; restore dirsec offset
 32463                                  %else
 32464                                  	; 23/02/2024 - Retro DOS v5.0
 32465                                  	; (PCDOS 7.1 IBMDOS.COM)
 32466                                  	;;;
 32467                                  	;add	di,0FFF0h
 32468 00005695 83C7F0                  	add	di,-16
 32469 00005698 AB                      	stosw			; sf_cluspos_h (sf_firclus in MSDOS 5.0-6.22)
 32470                                  	;add	di,SF_ENTRY.sf_dirsec
 32471 00005699 83C70E                  	add	di,14		; sf_dirsec ; 27
 32472 0000569C 268B4510                	mov	ax,[es:di+10h]	; [ES:DI+SF_ENTRY.sf_chain] ; 43
 32473                                  				; first cluster (32 bit)
 32474 000056A0 2689451A                	mov	[es:di+1Ah],ax
 32475                                  	;mov	[es:di+SF_ENTRY.sf_lstclus-SF_ENTRY.sf_dirsec],ax ; 53
 32476 000056A4 268B4512                	mov	ax,[es:di+12h]	; [ES:DI+SF_ENTRY.sf_chain+2] ; 45
 32477 000056A8 2689451C                	mov	[es:di+1Ch],ax
 32478                                  	;mov	[es:di+SF_ENTRY.sf_lstclus+2-SF_ENTRY.sf_dirsec],ax ; 55
 32479                                  	;;;
 32480                                  %endif
 32481                                  
 32482                                  ; DOS 3.3  FastOpen  6/13/86
 32483                                  
 32484 000056AC 1E                      	PUSH	DS
 32485                                  
 32486                                  ;hkn; SS is DOSDATA
 32487 000056AD 16                      	push	ss
 32488 000056AE 1F                      	pop	ds
 32489                                  	;test	byte [FastOpenFlg],4
 32490 000056AF F606[4611]04            	TEST	byte [FastOpenFlg],Special_Fill_Set
 32491 000056B4 7411                    	JZ	short Not_FastOpen
 32492                                  
 32493                                  ;hkn; FastOpen_Ext_Info is in DOSDATA
 32494 000056B6 BE[4711]                	MOV	SI,FastOpen_Ext_Info
 32495                                  
 32496                                  	;mov	ax,[si+1]
 32497 000056B9 8B4401                  	MOV	AX,[SI+FEI.dirsec]
 32498 000056BC AB                      	STOSW		  	; sf_dirsec
 32499                                  	; MSDOS 6.0
 32500                                  	;mov	ax,[si+3]
 32501 000056BD 8B4403                  	MOV	AX,[SI+FEI.dirsec+2]
 32502                                  		;;; changed for >32mb
 32503 000056C0 AB                      	STOSW		  	; sf_dirsec
 32504                                  	; 19/08//2018
 32505 000056C1 8A04                    	mov	al,[SI]
 32506                                  	;MOV	AL,[SI+FEI.dirpos] ; mov al,[SI+0]
 32507 000056C3 AA                      	STOSB		  	; sf_dirpos
 32508 000056C4 1F                      	POP	DS
 32509                                  	;JMP	short Next_Name
 32510                                  	; 24/09/2023
 32511 000056C5 EB1E                    	jmp	short FILE_SFT2	; cf=0 (after 'test' instruction)
 32512                                  
 32513                                  ; DOS 3.3  FastOpen  6/13/86
 32514                                  
 32515                                  Not_FastOpen:
 32516                                  	;POP	DS		; normal path
 32517                                  
 32518                                  ;hkn; SS override
 32519                                  	;MOV	SI,[SS:CURBUF]	; DS:SI->buffer header
 32520                                  	; 16/12/2022
 32521                                  	; 28/07/2019
 32522 000056C7 8B36[E205]              	mov	si,[CURBUF]
 32523 000056CB 1F                      	pop	ds
 32524                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 32525                                  	;pop	ds
 32526                                  	;mov	si,[ss:CURBUF]
 32527                                  	
 32528                                  	;mov	ax,[si+6]
 32529 000056CC 8B4406                  	MOV	AX,[SI+BUFFINFO.buf_sector]	;F.C. >32mb ;AN000;
 32530 000056CF AB                      	STOSW		  	; sf_dirsec	;F.C. >32mb ;AN000;
 32531                                  	; 19/05/2019	
 32532                                  	; MSDOS 6.0
 32533                                  	;mov	ax,[si+8]
 32534 000056D0 8B4408                  	MOV	AX,[SI+BUFFINFO.buf_sector+2]	;F.C. >32mb ;AN000;
 32535 000056D3 AB                      	STOSW		  	; sf_dirsec	;F.C. >32mb ;AN000;
 32536                                  	
 32537 000056D4 89D8                    	MOV	AX,BX
 32538                                  	;;;add	si,16	; MSDOS 3.3
 32539                                  	;;add	si,20	; MSDOS 6.0
 32540                                  	;add	si,24	; PCDOS 7.1 ; 23/02/2024
 32541 000056D6 83C618                  	ADD	SI,BUFINSIZ	; DS:SI-> start of data in buffer
 32542 000056D9 29F0                    	SUB	AX,SI		; AX = BX relative to start of sector
 32543                                  	;mov	cl,32
 32544 000056DB B120                    	MOV	CL,dir_entry.size
 32545 000056DD F6F1                    	DIV	CL
 32546 000056DF AA                      	STOSB		  	; sf_dirpos
 32547                                  Next_Name:
 32548 000056E0 EB03                    	JMP	SHORT FILE_SFT2
 32549                                  
 32550                                  	; 24/09/2023
 32551                                  	; cf=0 (after 'or' instruction)
 32552                                  DEV_SFT3:
 32553                                  	;add	di,7
 32554 000056E2 83C707                  	ADD	DI,SF_ENTRY.sf_name-SF_ENTRY.sf_cluspos
 32555                                  FILE_SFT2:
 32556                                  
 32557                                  ; Copy in the object's name
 32558                                  
 32559 000056E5 89DE                    	MOV	SI,BX		; DS:SI points to dir_name
 32560 000056E7 B90B00                  	MOV	CX,11
 32561 000056EA F3A4                    	REP	MOVSB		; sf_name
 32562 000056EC 5E                      	POP	SI		; recover DS:SI -> dir_first
 32563                                  
 32564                                  ;hkn; SS is DOSDATA
 32565 000056ED 16                      	push	ss
 32566 000056EE 1F                      	pop	ds
 32567                                  	; 24/09/2023
 32568                                  	; cf=0
 32569                                  	;CLC
 32570 000056EF C3                      	retn
 32571                                  
 32572                                  ;---------------------------------------------------------------------------
 32573                                  ;
 32574                                  ; Procedure Name : FREEENT
 32575                                  ;
 32576                                  ; Inputs:
 32577                                  ;	  ES:BP -> DPB
 32578                                  ;	  [CURBUF] Set
 32579                                  ;	  [CURBUF+2]:BX points to directory entry
 32580                                  ;	  [CURBUF+2]:SI points to above dir_first
 32581                                  ; Function:
 32582                                  ;	  Free the cluster chain for the entry if present
 32583                                  ; Outputs:
 32584                                  ;	  Carry set if error (currently user FAILed to I 24)
 32585                                  ;	  (NOTE dir_firclus and dir_size_l/h are wrong)
 32586                                  ; DS BX SI ES BP preserved (BX,SI in meaning, not value) others destroyed
 32587                                  ;---------------------------------------------------------------------------
 32588                                  
 32589                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 32590                                  	; 24/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32591                                  
 32592                                  FREEENT:
 32593 000056F0 1E                      	PUSH	DS
 32594 000056F1 C53E[E205]              	LDS	DI,[CURBUF]
 32595 000056F5 8B0C                    	MOV	CX,[SI]		; Get pointer to clusters
 32596                                  	; 24/02/2023 (PCDOS 7.1 IBMDOS.COM)
 32597                                  	;;;
 32598 000056F7 8B44FA                  	mov	ax,[si-6]	; hw of first cluster (dir_first)
 32599                                  	;;;
 32600                                  	; 19/05/2019 - Retro DOS v4.0
 32601                                  	; MSDOS 6.0
 32602                                  	;mov	dx,[di+8] ; 24/02/2024
 32603 000056FA 8B5508                  	MOV	DX,[DI+BUFFINFO.buf_sector+2] ;F.C. >32mb  ;AN000;
 32604                                  ;hkn; SS override
 32605 000056FD 368916[0706]            	MOV	[SS:HIGH_SECTOR],DX	      ;F.C. >32mb  ;AN000;
 32606                                  	;mov	dx,[di+6] ; 24/02/2024
 32607 00005702 8B5506                  	MOV	DX,[DI+BUFFINFO.buf_sector]
 32608 00005705 1F                      	POP	DS
 32609                                  
 32610                                  	; 24/02/2023 (PCDOS 7.1 IBMDOS.COM)
 32611                                  	;;;
 32612                                  	;cmp	word [bp+0Fh],0
 32613 00005706 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 32614 0000570B 7515                    	jnz	short freeent2	; not FAT32
 32615                                  	;cmp	ax,0
 32616 0000570D 09C0                    	or	ax,ax
 32617 0000570F 7505                    	jnz	short freeent1
 32618                                  	;
 32619 00005711 83F902                  	cmp	cx,2
 32620 00005714 7242                    	jb	short RET1	; Was 0 length file (or mucked Firclus if AX:CX=1)
 32621                                  freeent1:
 32622                                  	;cmp	ax,[es:bp+2Fh]
 32623 00005716 263B462F                	cmp	ax,[es:bp+DPB.LAST_CLUSTER+2]
 32624 0000571A 7511                    	jne	short freeent3
 32625                                  	;cmp	cx,[es:bp+2Dh]
 32626 0000571C 263B4E2D                	cmp	cx,[es:bp+DPB.LAST_CLUSTER]
 32627 00005720 EB0B                    	jmp	short freeent3
 32628                                  freeent2:
 32629 00005722 31C0                    	xor	ax,ax
 32630                                  	;;;
 32631                                  
 32632 00005724 83F902                  	CMP	CX,2
 32633 00005727 722F                    	JB	short RET1	; Was 0 length file (or mucked Firclus if CX=1)
 32634                                  
 32635                                  	;cmp	cx,[es:bp+0Dh]
 32636 00005729 263B4E0D                	CMP	CX,[ES:BP+DPB.MAX_CLUSTER]
 32637                                  freeent3:	; 24/02/2024
 32638                                  	;JA	short RET1	; Treat like zero length file (firclus mucked)
 32639 0000572D 7718                    	ja	short freeent_retn ; 24/02/2024
 32640 0000572F 29FB                    	SUB	BX,DI
 32641 00005731 53                      	PUSH	BX		; Save offset
 32642 00005732 FF36[0706]              	PUSH	word [HIGH_SECTOR] ;F.C. >32mb	;AN000;
 32643 00005736 52                      	PUSH	DX		; Save sector number
 32644 00005737 89CB                    	MOV	BX,CX
 32645                                  	; 24/02/2023 (PCDOS 7.1 IBMDOS.COM)
 32646                                  	;;;
 32647 00005739 A3[E80A]                	mov	[CLUSTNUM_HW],ax
 32648                                  	;;;
 32649 0000573C E8BE04                  	call	RELEASE		; Free any data allocated
 32650 0000573F 5A                      	POP	DX
 32651 00005740 8F06[0706]              	POP	word [HIGH_SECTOR] ;F.C. >32mb	;AN000;
 32652 00005744 7302                    	JNC	short GET_BUF_BACK
 32653 00005746 5B                      	POP	BX
 32654                                  freeent_retn:
 32655 00005747 C3                      	retn			; Screw up
 32656                                  
 32657                                  GET_BUF_BACK:
 32658                                  	; 22/09/2023
 32659                                  	;;mov	byte [ALLOWED],18h
 32660                                  	;MOV	byte [ALLOWED],Allowed_RETRY+Allowed_FAIL ; *
 32661                                  	;XOR	AL,AL ; *
 32662                                  	;call	GETBUFFR	; Get sector back
 32663 00005748 E80E12                  	call	GETBUFFER ; *	; pre read
 32664                                  
 32665 0000574B 5B                      	POP	BX		; Get offset back
 32666 0000574C 72F9                    	jc	short freeent_retn
 32667 0000574E E832E8                  	call	SET_BUF_AS_DIR
 32668 00005751 031E[E205]              	ADD	BX,[CURBUF]	; Correct it for new buffer
 32669                                  
 32670                                  	;MOV	SI,BX
 32671                                  	;;add	si,1Ah
 32672                                  	;ADD	SI,dir_entry.dir_first	; Get corrected SI
 32673                                  	; 24/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32674                                  	;lea	si,[bx+1Ah]
 32675 00005755 8D771A                  	lea	si,[bx+dir_entry.dir_first]
 32676                                  RET1:
 32677 00005758 F8                      	CLC
 32678 00005759 C3                      	retn
 32679                                  
 32680                                  ; 23/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32681                                  %if 0
 32682                                  
 32683                                  ;---------------------------------------------------------------------------
 32684                                  ;
 32685                                  ; Procedure Name : CHECK_VIRT_OPEN
 32686                                  ;
 32687                                  ; CHECK_VIRT_OPEN checks to see if we had performed a "virtual open" (by
 32688                                  ; examining the flag [VIRTUAL_OPEN] to see if it is 1). If we did, then
 32689                                  ; it calls Dev_Close_SFT to decrement the ref. count. It also resets the
 32690                                  ; flag [VIRTUAL_OPEN].
 32691                                  ; No registers affected (including flags).
 32692                                  ; On input, [THISSFT] points to current SFT.
 32693                                  ;
 32694                                  ;---------------------------------------------------------------------------
 32695                                  
 32696                                  CHECK_VIRT_OPEN:
 32697                                  	PUSH	AX
 32698                                  	lahf			; preserve flags
 32699                                  	CMP	byte [VIRTUAL_OPEN],0
 32700                                  	JZ	short ALL_CLOSED
 32701                                  	mov	byte [VIRTUAL_OPEN],0 ; reset flag
 32702                                  	push	es
 32703                                  	push	di
 32704                                  	LES	DI,[THISSFT]
 32705                                  	call	DEV_CLOSE_SFT
 32706                                  	pop	di
 32707                                  	pop	es
 32708                                  
 32709                                  ALL_CLOSED:
 32710                                  	sahf			; restore flags
 32711                                  	POP	AX
 32712                                  	retn
 32713                                  
 32714                                  %endif
 32715                                  
 32716                                  ;============================================================================
 32717                                  ; ROM.ASM, MSDOS 6.0, 1991
 32718                                  ;============================================================================
 32719                                  ; 29/07/2018 - Retro DOS v3.0
 32720                                  ; 20/05/2019 - Retro DOS v4.0
 32721                                  ; 10/02/2024 - Retro DOS v5.0
 32722                                  
 32723                                  ;	TITLE	ROM - Miscellaneous routines
 32724                                  ;	NAME	ROM
 32725                                  
 32726                                  ;**	Misc Low level routines for doing simple FCB computations, Cache
 32727                                  ;       reads and writes, I/O optimization, and FAT allocation/deallocation
 32728                                  ;
 32729                                  ;	SKPCLP
 32730                                  ;	FNDCLUS
 32731                                  ;	BUFSEC
 32732                                  ;	BUFRD
 32733                                  ;	BUFWRT
 32734                                  ;	NEXTSEC
 32735                                  ;	OPTIMIZE
 32736                                  ;	FIGREC
 32737                                  ;	ALLOCATE
 32738                                  ;	RESTFATBYT
 32739                                  ;	RELEASE
 32740                                  ;	RELBLKS
 32741                                  ;	GETEOF
 32742                                  ;
 32743                                  ;	Modification history:
 32744                                  ;
 32745                                  ;		Created: ARR 30 March 1983
 32746                                  ;               M039: DB 10/25/90 - Disk read/write optimization.
 32747                                  
 32748                                  ;Break   <FNDCLUS -- Skip over allocation units>
 32749                                  ;--------------------------------------------------------------------------
 32750                                  ;
 32751                                  ; Procedure Name : FNDCLUS
 32752                                  ;
 32753                                  ; Inputs:
 32754                                  ;       CX = No. of clusters to skip
 32755                                  ;       ES:BP = Base of drive parameters
 32756                                  ;       [THISSFT] point to SFT
 32757                                  ; Outputs:
 32758                                  ;       BX = Last cluster skipped to
 32759                                  ;       CX = No. of clusters remaining (0 unless EOF)
 32760                                  ;       DX = Position of last cluster
 32761                                  ;       Carry set if error (currently user FAILed to I 24)
 32762                                  ; DI destroyed. No other registers affected.
 32763                                  ;--------------------------------------------------------------------------
 32764                                  
 32765                                  	;;;
 32766                                  	; 10/02/2024 - Retro DOS v5.0
 32767                                  	; (PCDOS 7.1 IBMDOS.COM)
 32768                                  FNDCLUS_X:
 32769 0000575A 8B0E[BC05]              	mov	cx,[CLUSNUM]
 32770 0000575E 8B16[DE0A]              	mov	dx,[CLUSNUM_HW]
 32771                                  	;;;
 32772                                  
 32773                                  ; 20/05/2019 - Retro DOS v4.0
 32774                                  ; DOSCODE:8BF2h (MSDOS 6.21, MSDOS.SYS)
 32775                                  ; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 32776                                  ; DOSCODE:8BB7h (MSDOS 5.0, MSDOS.SYS)
 32777                                  
 32778                                  ; 25/02/2024
 32779                                  ; 10/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32780                                  ; DOSCODE:9801h (PCDOS 7.1 IBMDOS.COM)
 32781                                  
 32782                                  FNDCLUS:
 32783 00005762 06                      	PUSH	ES
 32784 00005763 C43E[9E05]                      LES     DI,[THISSFT]		; setup addressability to SFT
 32785                                  
 32786                                  	;;;
 32787                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32788 00005767 8916[F80A]              	mov	[CLSKIP_HW],dx
 32789                                  	;mov	bx,[es:di+37h]
 32790 0000576B 268B5D37                	mov	bx,[es:di+SF_ENTRY.sf_lstclus+2] ; 24/02/2024
 32791 0000576F 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 32792 00005773 09DB                    	or	bx,bx ; *
 32793 00005775 268B550B                	mov	dx,[es:di+0Bh] ; [ES:DI+SF_ENTRY.sf_firclus] ; MSDOS 5.0-6.22
 32794                                          ;mov	dx,[es:di+SF_ENTRY.sf_cluspos_hw] ; PCDOS 7.1
 32795 00005779 8916[E20A]              	mov	[LASTPOS_HW],dx
 32796                                  	;;;
 32797                                  	
 32798                                  	;;mov	bx,[es:di+1Bh] ; MSDOS 3.3
 32799                                  	;mov	bx,[es:di+35h] ; MSDOS 6.0
 32800 0000577D 268B5D35                	MOV	BX,[ES:DI+SF_ENTRY.sf_lstclus]
 32801                                  	;mov	dx,[es:di+19h]
 32802 00005781 268B5519                        MOV     DX,[ES:DI+SF_ENTRY.sf_cluspos]
 32803                                  	; 10/02/2024
 32804                                  	;OR	BX,BX
 32805                                  	;JZ	short NOCLUS
 32806                                  	;;;
 32807                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32808 00005785 7506                    	jnz	short fndclus_1 ; *
 32809 00005787 09DB                    	or	bx,bx
 32810 00005789 7502                    	jnz	short fndclus_1
 32811 0000578B EB6A                    	jmp	NOCLUS
 32812                                  
 32813                                  fndclus_1:
 32814                                  	;;;
 32815                                  
 32816                                  ; 10/02/2024
 32817                                  %if 0	
 32818                                          SUB	CX,DX
 32819                                          JNB	short FINDIT
 32820                                  	ADD	CX,DX
 32821                                  	XOR	DX,DX
 32822                                  	;mov	bx,[es:di+0Bh]
 32823                                  	MOV	BX,[ES:DI+SF_ENTRY.sf_firclus]
 32824                                  FINDIT:
 32825                                          POP	ES
 32826                                  	JCXZ	RET9
 32827                                  %else
 32828                                  	;;;
 32829                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32830 0000578D 29D1                    	sub	cx,dx
 32831 0000578F 50                      	push	ax
 32832 00005790 A1[E20A]                	mov	ax,[LASTPOS_HW]
 32833 00005793 1906[F80A]              	sbb	[CLSKIP_HW],ax
 32834 00005797 58                      	pop	ax
 32835 00005798 731C                    	jnb	short FINDIT
 32836 0000579A 8B1E[E20A]              	mov	bx,[LASTPOS_HW]
 32837 0000579E 01D1                    	add	cx,dx
 32838 000057A0 111E[F80A]              	adc	[CLSKIP_HW],bx
 32839 000057A4 31D2                    	xor	dx,dx
 32840 000057A6 8916[E20A]              	mov	[LASTPOS_HW],dx ; 0
 32841 000057AA 268B5D2D                	mov	bx,[es:di+2Dh]	; [ES:DI+SF_ENTRY.sf_chain+2] ; MSDOS 5.0-6.22
 32842                                  				; [ES:DI+SF_ENTRY.sf_fcluster+2] ; PCDOS 7.1
 32843 000057AE 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 32844 000057B2 268B5D2B                	mov	bx,[es:di+2Bh]	; [ES:DI+SF_ENTRY.sf_chain] ; MSDOS 5.0-6.22
 32845                                  				; [ES:DI+SF_ENTRY.sf_fcluster] ; PCDOS 7.1
 32846                                  FINDIT:
 32847 000057B6 07                      	pop	es
 32848 000057B7 3B0E[F80A]              	cmp	cx,[CLSKIP_HW]
 32849 000057BB 7502                    	jnz	short SKPCLP
 32850 000057BD E337                    	jcxz	RET9	 ; cf=0
 32851                                  	;;;
 32852                                  %endif
 32853                                  
 32854                                  	;entry	SKPCLP
 32855                                  SKPCLP:
 32856                                  
 32857                                  ; 10/02/2024
 32858                                  %if 0
 32859                                  	call	UNPACK
 32860                                          jc	short fndclus_retn	; retc
 32861                                  
 32862                                  	; 09/09/2018
 32863                                  
 32864                                  	; MSDOS 3.3
 32865                                  	;push	bx
 32866                                  	;mov	bx,di
 32867                                  	;call	IsEOF
 32868                                  	;pop	bx	
 32869                                  	;jae	short RET9
 32870                                  
 32871                                  	; 20/05/2019 - Retro DOS v4.0
 32872                                  
 32873                                  	; MSDOS 6.0
 32874                                  	xchg	bx,di
 32875                                  	call	IsEOF
 32876                                  	xchg	bx,di
 32877                                  	jae	short RET9
 32878                                  
 32879                                          XCHG    BX,DI
 32880                                          INC     DX
 32881                                  
 32882                                  	LOOP	SKPCLP			; RMFS
 32883                                  %else
 32884                                  	;;;
 32885                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32886                                  
 32887                                  	;push	word [LASTPOS_HW]
 32888                                  	;push	dx
 32889                                  	;push	word [CLSKIP_HW]
 32890                                  	;push	cx
 32891                                  
 32892 000057BF E84E0B                  	call	UNPACK
 32893                                  
 32894                                  	;pop	cx
 32895                                  	;pop	word [CLSKIP_HW]
 32896                                  	;pop	dx
 32897                                  	;pop	word [LASTPOS_HW]
 32898                                  	
 32899 000057C2 7242                    	jc	short fndclus_retn
 32900                                  
 32901 000057C4 FF36[E80A]              	push	word [CLUSTNUM_HW]
 32902 000057C8 53                      	push	bx
 32903 000057C9 89FB                    	mov	bx,di
 32904 000057CB 8B3E[EC0A]              	mov	di,[CCONTENT_HW]
 32905 000057CF 893E[E80A]              	mov	[CLUSTNUM_HW],di
 32906 000057D3 E8110B                  	call	IsEOF
 32907 000057D6 7206                    	jc	short SKPCLP2
 32908 000057D8 5B                      	pop	bx
 32909 000057D9 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 32910                                  	;jmp	short RET9
 32911                                  	; 25/02/2024
 32912 000057DD C3                      	retn
 32913                                  
 32914                                  SKPCLP2:
 32915 000057DE 83C404                  	add	sp,4
 32916 000057E1 42                      	inc	dx
 32917 000057E2 7504                    	jnz	short SKPCLP3
 32918 000057E4 FF06[E20A]              	inc	word [LASTPOS_HW]
 32919                                  SKPCLP3:
 32920 000057E8 83E901                  	sub	cx,1
 32921 000057EB 831E[F80A]00            	sbb	word [CLSKIP_HW],0
 32922 000057F0 75CD                    	jnz	short SKPCLP		; loop
 32923 000057F2 09C9                    	or	cx,cx
 32924 000057F4 75C9                    	jnz	short SKPCLP		; loop
 32925                                  	;;;
 32926                                  %endif
 32927                                  
 32928                                  RET9:	
 32929                                  	;CLC
 32930                                  	; 25/02/2024
 32931                                  	; cf=0
 32932 000057F6 C3                      	retn
 32933                                  
 32934                                  NOCLUS:
 32935 000057F7 07                              POP	ES
 32936                                  
 32937                                  ; 10/02/2024
 32938                                  %if 0
 32939                                          INC	CX
 32940                                          DEC	DX
 32941                                  %else
 32942                                  	;;;
 32943                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32944                                  	;push	di
 32945                                  	;xor	di,di ; 0
 32946                                  	;add	cx,1
 32947                                  	;adc	[CLSKIP_HW],di	; CLSKIP_HW:BX = Last cluster skipped to
 32948                                  	;sub	dx,1
 32949                                  	;sbb	[LASTPOS_HW],di	; LASTPOS_HW:DX = Position of last cluster
 32950                                  	;pop	di
 32951                                  	;;;
 32952                                  	; 25/02/2024 - Retro DOS v5.0
 32953 000057F8 4A                      	dec	dx
 32954 000057F9 7904                    	jns	short noclus1
 32955 000057FB FF0E[E20A]              	dec	word [LASTPOS_HW]
 32956                                  noclus1:
 32957 000057FF 41                      	inc	cx
 32958 00005800 7504                    	jnz	short fndclus_retn
 32959 00005802 FF06[F80A]              	inc	word [CLSKIP_HW]
 32960                                  %endif
 32961                                  	; 25/02/2024
 32962                                  	; cf=0
 32963                                          ;CLC
 32964                                  
 32965                                  fndclus_retn:
 32966 00005806 C3                              retn
 32967                                  
 32968                                  ;Break  <BUFSEC -- BUFFER A SECTOR AND SET UP A TRANSFER>
 32969                                  ;--------------------------------------------------------------------------
 32970                                  ;
 32971                                  ; Procedure Name : BUFSEC
 32972                                  ;
 32973                                  ; Inputs:
 32974                                  ;       AH = priority of buffer
 32975                                  ;       AL = 0 if buffer must be read, 1 if no pre-read needed
 32976                                  ;       ES:BP = Base of drive parameters
 32977                                  ;       [CLUSNUM] = Physical cluster number
 32978                                  ;       [SECCLUSPOS] = Sector position of transfer within cluster
 32979                                  ;       [BYTCNT1] = Size of transfer
 32980                                  ; Function:
 32981                                  ;       Insure specified sector is in buffer, flushing buffer before
 32982                                  ;       read if necessary.
 32983                                  ; Outputs:
 32984                                  ;       ES:DI = Pointer to buffer
 32985                                  ;       SI = Pointer to transfer address
 32986                                  ;       CX = Number of bytes
 32987                                  ;       [NEXTADD] updated
 32988                                  ;       [TRANS] set to indicate a transfer will occur
 32989                                  ;       Carry set if error (user FAILed to I 24)
 32990                                  ;--------------------------------------------------------------------------
 32991                                  
 32992                                  	; 25/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32993                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:98C2h
 32994                                  
 32995                                  	; (MSDOS 5.0 MSDOS.SYS - DOSCODE:8BF1h) - Retro DOS v4.0 (& v4.1)
 32996                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8C2Ch) - Retro DOS v4.2
 32997                                  	; (Windows ME IO.SYS - BIOSCODE:0BE33h)
 32998                                  
 32999                                  BUFSEC:
 33000                                  	; 25/02/2024
 33001                                  	;;;
 33002                                  	;push	word [CLUSTNUM_HW]
 33003 00005807 8B16[DE0A]              	mov	dx,[CLUSNUM_HW]
 33004                                  	;mov	[CLUSTNUM_HW],dx
 33005 0000580B 8716[E80A]              	xchg	dx,[CLUSTNUM_HW]
 33006 0000580F 52                      	push	dx	; [CLUSTNUM_HW]
 33007                                  	;;;
 33008 00005810 8B16[BC05]                      MOV     DX,[CLUSNUM]
 33009 00005814 8A1E[7305]                      MOV     BL,[SECCLUSPOS]
 33010                                  	;mov	byte [ALLOWED],38h
 33011 00005818 C606[4B03]38                    MOV     byte [ALLOWED],Allowed_FAIL+Allowed_RETRY+Allowed_IGNORE
 33012 0000581D E89801                          CALL    FIGREC
 33013 00005820 E83D11                  	call	GETBUFFR
 33014                                  	; 25/02/2024
 33015                                  	;;;
 33016 00005823 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 33017                                  	;;;
 33018 00005827 72DD                            jc	short fndclus_retn
 33019                                  
 33020 00005829 C606[7405]01                    MOV     BYTE [TRANS],1	; A transfer is taking place
 33021 0000582E 8B36[B805]                      MOV     SI,[NEXTADD]
 33022 00005832 89F7                            MOV     DI,SI
 33023 00005834 8B0E[D205]                      MOV     CX,[BYTCNT1]
 33024 00005838 01CF                            ADD     DI,CX
 33025 0000583A 893E[B805]                      MOV     [NEXTADD],DI
 33026 0000583E C43E[E205]                      LES     DI,[CURBUF]
 33027                                  	;or	byte [es:di+5],8
 33028 00005842 26804D0508                      OR      byte [ES:DI+BUFFINFO.buf_flags],buf_isDATA
 33029                                  	;;;lea	di,[di+16] ; MSDOS 3.3 
 33030                                  	;;lea	di,[di+20] ; MSDOS 6.0
 33031                                          ;lea	di,[di+24] ; PCDOS 7.1  ; 25/02/2024
 33032 00005847 8D7D18                  	LEA     DI,[DI+BUFINSIZ]        ; Point to buffer
 33033 0000584A 033E[CC05]                      ADD     DI,[BYTSECPOS]
 33034 0000584E F8                              CLC	; (not necessary!?) ; 25/02/2024
 33035 0000584F C3                              retn
 33036                                  
 33037                                  ;Break   <BUFRD, BUFWRT -- PERFORM BUFFERED READ AND WRITE>
 33038                                  
 33039                                  ;---------------------------------------------------------------------------
 33040                                  ;
 33041                                  ; Procedure Name : BUFRD
 33042                                  ;
 33043                                  ; Do a partial sector read via one of the system buffers
 33044                                  ; ES:BP Points to DPB
 33045                                  ; Carry set if error (currently user FAILed to I 24)
 33046                                  ;
 33047                                  ; DS - set to DOSDATA
 33048                                  ;
 33049                                  ;----------------------------------------------------------------------------
 33050                                  
 33051                                  	; 25/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 33052                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 33053                                  	; 20/05/2019 - Retro DOS v4.0
 33054                                  BUFRD:
 33055 00005850 06                              PUSH	ES
 33056 00005851 31C0                            xor	ax,ax			; pre-read sector
 33057 00005853 E8B1FF                          CALL    BUFSEC
 33058 00005856 7303                            JNC	short BUF_OK ; ds=ss
 33059                                  
 33060                                  BUF_IO_FAIL:				; this label used by BUFWRT also
 33061 00005858 07                              POP	ES
 33062 00005859 EB2D                            JMP     SHORT RBUFPLACED ; ds=ss
 33063                                  
 33064                                  BUF_OK:
 33065 0000585B 8CC3                            MOV     BX,ES
 33066 0000585D 8E06[2E03]                      MOV     ES,[DMAADD+2]
 33067 00005861 8EDB                            MOV     DS,BX
 33068 00005863 87FE                    	XCHG    DI,SI
 33069 00005865 D1E9                            SHR     CX,1
 33070                                  ;M039
 33071                                  	; MSDOS 3.3
 33072                                  	;JNC	short EVENRD
 33073                                  	;MOVSB
 33074                                  ;EVENRD:
 33075                                  	;REP     MOVSW
 33076                                  
 33077                                  ;	CX = # of whole WORDs ; CF=1 if odd # of bytes.
 33078                                  ;       DS:SI-> Source within Buffer.
 33079                                  ;       ES:DI-> Destination within Transfer memory block.
 33080                                  
 33081                                  	; MSDOS 6.0
 33082 00005867 F3A5                    	rep	movsw			;Copy Buffer to Transfer memory.
 33083                                  	;adc	cx,0                    ;CX=1 if odd # of bytes, else CX=0.
 33084                                  	;rep	movsb                   ;Copy last byte.
 33085                                  	; 16/12/2022
 33086 00005869 7301                    	jnc	short EVENRD ; **** 20/05/2019
 33087 0000586B A4                      	movsb ; ****
 33088                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 33089                                  	;adc	cx,0
 33090                                  	;rep	movsb
 33091                                  ;M039
 33092                                  EVENRD: ; ****
 33093 0000586C 07                              POP	ES
 33094                                  ;hkn; SS override
 33095 0000586D 36C53E[E205]                    LDS     DI,[SS:CURBUF]
 33096                                  	;;;lea	bx,[di+16]
 33097                                  	;;lea	bx,[di+20] ; MSDOS 6.0
 33098                                  	;lea	bx,[di+24] ; PCDOS 7.1	; 25/02/2024
 33099 00005872 8D5D18                  	LEA     BX,[DI+BUFINSIZ]
 33100 00005875 29DE                            SUB     SI,BX                   ; Position in buffer
 33101 00005877 E88810                          call	PLACEBUF
 33102                                  	;cmp	si,[es:bp+2]
 33103 0000587A 263B7602                	CMP	SI,[ES:BP+DPB.SECTOR_SIZE] ; Read Last byte?
 33104 0000587E 7205                            JB	short RBUFPLACEDC ; ds<>ss ; No, leave buf where it is
 33105                                  ;M039
 33106                                  	; MSDOS 3.3
 33107                                  	;call	PLACEHEAD               ; Make it prime candidate for chucking
 33108                                                                          ;  even though it is MRU.
 33109                                          ; MSDOS 6.0
 33110 00005880 36893E[6D00]            	MOV	[ss:BufferQueue],DI	; Make it prime candidate for
 33111                                  ;M039					; chucking even though it is MRU.
 33112                                  
 33113                                  RBUFPLACEDC:
 33114 00005885 F8                              CLC
 33115                                  ;RBUFPLACED:
 33116 00005886 16                      	push	ss
 33117 00005887 1F                      	pop	ds
 33118                                  RBUFPLACED:	; 25/02/2024 (ds=ss)
 33119 00005888 C3                              retn
 33120                                  
 33121                                  ;----------------------------------------------------------------------------
 33122                                  ;
 33123                                  ; Procedure : BUFWRT
 33124                                  ;
 33125                                  ; Do a partial sector write via one of the system buffers
 33126                                  ; ES:BP Points to DPB
 33127                                  ; Carry set if error (currently user FAILed to I 24)
 33128                                  ;
 33129                                  ; DS - set to DOSDATA
 33130                                  ;
 33131                                  ;----------------------------------------------------------------------------
 33132                                  
 33133                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 33134                                  	; 20/05/2019 - Retro DOS v4.0
 33135                                  BUFWRT:
 33136                                  	;MOV	AX,[SECPOS]
 33137                                  	; MSDOS 6.0
 33138                                  	;ADD	AX,1			; Set for next sector
 33139                                  	;MOV	[SECPOS],AX 		;F.C. >32mb	;AN000;
 33140                                  	;ADC	word [SECPOS+2],0	;F.C. >32mb	;AN000;
 33141                                  	; 24/09/2023
 33142 00005889 FF06[C405]              	inc	word [SECPOS]
 33143 0000588D 7504                    	jnz	short bufw_secpos
 33144 0000588F FF06[C605]              	inc	word [SECPOS+2]
 33145                                  bufw_secpos:
 33146 00005893 A1[C605]                	MOV	AX,[SECPOS+2]		;F.C. >32mb	;AN000;
 33147 00005896 3B06[CA05]              	CMP	AX,[VALSEC+2]		;F.C. >32mb	;AN000;
 33148 0000589A B001                    	MOV	AL,1			;F.C. >32mb	;AN000;
 33149 0000589C 770F                    	JA	short NOREAD		;F.C. >32mb	;AN000;
 33150 0000589E 720B                    	JB	short _doread		;F.C. >32mb	;AN000;
 33151 000058A0 A1[C405]                	MOV	AX,[SECPOS]		;F.C. >32mb	;AN000;
 33152                                  
 33153                                  	; MSDOS 3.3
 33154                                  	;INC	AX
 33155                                  	;MOV	[SECPOS],AX ; 09/09/2018
 33156                                  
 33157                                  	; 20/05/2019
 33158                                  	; MSDOS 3.3 & MSDOS 6.0
 33159 000058A3 3B06[C805]              	CMP	AX,[VALSEC]		; Has sector been written before?
 33160 000058A7 B001                    	MOV	AL,1
 33161 000058A9 7702                    	JA	short NOREAD		; Skip preread if SECPOS>VALSEC
 33162                                  _doread:
 33163 000058AB 30C0                    	XOR	AL,AL
 33164                                  NOREAD:
 33165 000058AD 06                      	PUSH	ES
 33166 000058AE E856FF                  	CALL	BUFSEC
 33167 000058B1 72A5                    	JC	short BUF_IO_FAIL
 33168 000058B3 8E1E[2E03]              	MOV	DS,[DMAADD+2]
 33169 000058B7 D1E9                    	SHR	CX,1
 33170                                  ;M039
 33171                                  	; MSDOS 3.3
 33172                                  	;JNC	short EVENWRT ; 09/09/2018
 33173                                  	;MOVSB
 33174                                  ;EVENWRT:
 33175                                  	;REP	MOVSW
 33176                                  
 33177                                  ;	CX = # of whole WORDs; CF=1 if odd # of bytes.
 33178                                  ;	DS:SI-> Source within Transfer memory block.
 33179                                  ;	ES:DI-> Destination within Buffer.
 33180                                  
 33181                                  	; MSDOS 6.0
 33182 000058B9 F3A5                    	rep	movsw			;Copy Transfer memory to Buffer.
 33183                                  	;adc	cx,0			;CX=1 if odd # of bytes, else CX=0.
 33184                                  	;rep	movsb		  	;Copy last byte.
 33185                                  	; 16/12/2022
 33186 000058BB 7301                    	jnc	short EVENWRT ; **** 20/05/2019
 33187 000058BD A4                      	movsb ; ****
 33188                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 33189                                  	;adc	cx,0
 33190                                  	;rep	movsb
 33191                                  ;M039
 33192                                  EVENWRT: ; ****
 33193 000058BE 07                      	POP	ES
 33194                                  
 33195                                  ;hkn; SS override
 33196 000058BF 36C51E[E205]            	LDS	BX,[SS:CURBUF]
 33197                                  
 33198                                  	; MSDOS 6.0
 33199 000058C4 F6470540                	TEST	byte [BX+BUFFINFO.buf_flags],buf_dirty
 33200                                  					;LB. if already dirty		 ;AN000;
 33201 000058C8 7507                    	JNZ	short yesdirty10	;LB. don't increment dirty count ;AN000;
 33202 000058CA E82A13                  	call	INC_DIRTY_COUNT		;LB.				 ;AN000;
 33203                                  	
 33204                                  	;or	byte [bx+5],40h
 33205 000058CD 804F0540                	OR	byte [BX+BUFFINFO.buf_flags],buf_dirty
 33206                                  yesdirty10:
 33207                                  	;;;lea	si,[bx+16]
 33208                                  	;;lea	si,[bx+20] ; MSDOS 6.0
 33209                                  	;lea	si,[bx+24] ; PCDOS 7.1	; 25/02/2024
 33210 000058D1 8D7718                  	LEA	SI,[BX+BUFINSIZ]
 33211 000058D4 29F7                    	SUB	DI,SI		  	; Position in buffer
 33212                                  ;M039
 33213                                  	; MSDOS 3.3
 33214                                  	;MOV	SI,DI
 33215                                  	;MOV	DI,BX
 33216                                  	;call	PLACEBUF
 33217                                  	;;cmp	si,[es:bp+2]
 33218                                  	;CMP	SI,[ES:BP+DPB.SECTOR_SIZE] ; Written last byte?
 33219                                  	;JB	short WBUFPLACED	; No, leave buf where it is
 33220                                  	;call	PLACEHEAD		; Make it prime candidate for chucking
 33221                                  					;  even though it is MRU.
 33222                                  	; 10/02/2024
 33223 000058D6 16                      	push	ss
 33224 000058D7 1F                      	pop	ds
 33225                                  
 33226                                  	; MSDOS 6.0
 33227                                  	;cmp	di,[es:bp+2]
 33228 000058D8 263B7E02                	CMP	di,[ES:BP+DPB.SECTOR_SIZE] ; Written last byte?
 33229 000058DC 7204                    	JB	short WBUFPLACED	; No, leave buf where it is
 33230                                  
 33231                                  	; 10/02/2024
 33232                                  	;MOV	[ss:BufferQueue],BX	; Make it prime candidate for
 33233                                  					; chucking even though it is MRU.
 33234 000058DE 891E[6D00]              	mov	[BufferQueue],bx
 33235                                  ;M039
 33236                                  
 33237                                  WBUFPLACED:
 33238 000058E2 F8                      	CLC
 33239                                  	; 10/02/2024
 33240                                  	;push	ss
 33241                                  	;pop	ds
 33242 000058E3 C3                      	retn
 33243                                  
 33244                                  ;Break   <NEXTSEC -- Compute next sector to read or write>
 33245                                  ;---------------------------------------------------------------------------
 33246                                  ;
 33247                                  ; Procedure Name : NEXTSEC
 33248                                  ;
 33249                                  ; Compute the next sector to read or write
 33250                                  ; ES:BP Points to DPB
 33251                                  ;
 33252                                  ;---------------------------------------------------------------------------
 33253                                  
 33254                                  	; 29/02/2024
 33255                                  	; 26/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 33256                                  
 33257                                  NEXTSEC:
 33258 000058E4 F606[7405]FF            	test	byte [TRANS],0FFh ; -1 
 33259                                  	;JZ	short CLRET
 33260                                  	; 29/02/2024
 33261 000058E9 743D                    	jz	short CLRET2
 33262                                  
 33263 000058EB A0[7305]                	MOV	AL,[SECCLUSPOS]
 33264 000058EE FEC0                    	INC	AL
 33265                                  	;cmp	al,[es:bp+4]
 33266 000058F0 263A4604                	CMP	AL,[ES:BP+DPB.CLUSTER_MASK]
 33267 000058F4 762E                    	JBE	short SAVPOS
 33268                                  	
 33269                                  	; 26/02/2024 (PCDOS 7.1 IBMDOS.COM)
 33270                                  	;;;
 33271 000058F6 8B1E[DE0A]              	mov     bx,[CLUSNUM_HW]
 33272 000058FA 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 33273                                  	;;;
 33274                                  
 33275 000058FE 8B1E[BC05]              	MOV	BX,[CLUSNUM]
 33276 00005902 E8E209                  	call	IsEOF
 33277 00005905 7322                    	JAE	short NONEXT
 33278                                  
 33279 00005907 E8060A                  	call	UNPACK
 33280                                  	;JC	short NONEXT
 33281                                  	; 26/02/2024
 33282 0000590A 721E                    	jc	short NONEXT2
 33283                                  clusgot:
 33284                                  	; 26/02/2024 - Retro DOS v5.0
 33285                                  	;;;
 33286                                  	;push	di
 33287                                  	;mov	di,[CCONTENT_HW]
 33288                                  	;mov	[CLUSNUM_HW],di
 33289                                  	;pop	di
 33290 0000590C FF36[EC0A]              	push	word [CCONTENT_HW]
 33291 00005910 8F06[DE0A]              	pop	word [CLUSNUM_HW]
 33292                                  	;;;
 33293 00005914 893E[BC05]              	MOV	[CLUSNUM],DI
 33294 00005918 FF06[BA05]              	INC	word [LASTPOS]
 33295                                  	; 26/02/2024 - Retro DOS v5.0
 33296                                  	;;;
 33297 0000591C 7504                    	jnz	short clusgot1
 33298 0000591E FF06[E20A]              	inc	word [LASTPOS_HW]
 33299                                  clusgot1:		
 33300                                  	;;;
 33301 00005922 B000                    	MOV	AL,0
 33302                                  SAVPOS:
 33303 00005924 A2[7305]                	MOV	[SECCLUSPOS],AL
 33304                                  CLRET:
 33305 00005927 F8                      	CLC
 33306                                  CLRET2:		; 29/02/2024
 33307 00005928 C3                      	retn
 33308                                  NONEXT:
 33309 00005929 F9                      	STC
 33310                                  NONEXT2:	; 26/02/2024
 33311 0000592A C3                      	retn
 33312                                  
 33313                                  ;Break	<OPTIMIZE -- DO A USER DISK REQUEST WELL>
 33314                                  ;----------------------------------------------------------------------------
 33315                                  ;
 33316                                  ; Procedure Name : OPTIMIZE
 33317                                  ;
 33318                                  ; Inputs:
 33319                                  ;	  BX = Physical cluster
 33320                                  ;	  CX = No. of records
 33321                                  ;	  DL = sector within cluster
 33322                                  ;	  ES:BP = Base of drive parameters
 33323                                  ;	  [NEXTADD] = transfer address
 33324                                  ; Outputs:
 33325                                  ;	  AX = No. of records remaining
 33326                                  ;	  BX = Transfer address
 33327                                  ;	  CX = No. or records to be transferred
 33328                                  ;	  DX = Physical sector address (LOW)
 33329                                  ;	  [HIGH_SECTOR] = Physical sector address (HIGH)
 33330                                  ;	  DI = Next cluster
 33331                                  ;	  [CLUSNUM] = Last cluster accessed
 33332                                  ;	  [NEXTADD] updated
 33333                                  ;	  Carry set if error (currently user FAILed to I 24)
 33334                                  ; ES:BP unchanged. Note that segment of transfer not set.
 33335                                  ;
 33336                                  ;---------------------------------------------------------------------------
 33337                                  
 33338                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 33339                                  	; 27/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 33340                                  
 33341                                  OPTIMIZE:
 33342 0000592B 52                      	PUSH	DX
 33343                                  	; 27/02/2024 (PCDOS 7.1 IBMDOS.COM)
 33344                                  	;;;
 33345 0000592C FF36[E80A]              	push	word [CLUSTNUM_HW]
 33346                                  	;;;
 33347 00005930 53                      	PUSH	BX
 33348                                  	;mov	al,[es:bp+4]
 33349 00005931 268A4604                	MOV	AL,[ES:BP+DPB.CLUSTER_MASK]
 33350 00005935 FEC0                    	INC	AL		; Number of sectors per cluster
 33351 00005937 88C4                    	MOV	AH,AL
 33352 00005939 28D0                    	SUB	AL,DL		; AL = Num of sectors left in first cluster
 33353 0000593B 89CA                    	MOV	DX,CX
 33354                                  	;MOV	CX,0
 33355                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 33356                                  	; 16/12/2022
 33357 0000593D 31C9                    	xor	cx,cx	; sub cx,cx
 33358                                  OPTCLUS:
 33359                                  ; AL has number of sectors available in current cluster
 33360                                  ; AH has number of sectors available in next cluster
 33361                                  ; BX has current physical cluster
 33362                                  ; CX has number of sequential sectors found so far
 33363                                  ; DX has number of sectors left to transfer
 33364                                  ; ES:BP Points to DPB
 33365                                  ; ES:SI has FAT pointer
 33366                                  
 33367                                  do_norm3:
 33368 0000593F E8CE09                  	call	UNPACK
 33369 00005942 7261                    	JC	short OP_ERR	; ds=ss ; 27/02/2024
 33370                                  ;clusgot2:
 33371 00005944 00C1                    	ADD	CL,AL
 33372 00005946 80D500                  	ADC	CH,0
 33373 00005949 39D1                    	CMP	CX,DX
 33374 0000594B 735D                    	JAE	short BLKDON
 33375 0000594D 88E0                    	MOV	AL,AH
 33376                                  	;INC	BX
 33377                                  	; 27/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 33378                                  	;;;
 33379                                  	;push	di
 33380                                  	;xor	di,di
 33381                                  	;add	bx,1
 33382                                  	;adc	[CLUSTNUM_HW],di
 33383                                  	;
 33384 0000594F 43                      	inc	bx
 33385 00005950 7504                    	jnz	short clusgot2
 33386 00005952 FF06[E80A]              	inc	word [CLUSTNUM_HW]
 33387                                  clusgot2:
 33388 00005956 8B3E[EC0A]              	mov	di,[CCONTENT_HW]
 33389 0000595A 3B3E[E80A]              	cmp	di,[CLUSTNUM_HW]
 33390                                  	;pop	di
 33391 0000595E 7504                    	jne	short clusgot3
 33392 00005960 39DF                    	cmp	di,bx
 33393 00005962 74DB                    	je	short OPTCLUS
 33394                                  clusgot3:
 33395                                  	;;;	
 33396                                  	;CMP	DI,BX
 33397                                  	;JZ	short OPTCLUS
 33398                                  	;DEC	BX
 33399                                  	; 27/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 33400                                  	;;;
 33401                                  	;sub	bx,1
 33402                                  	;sbb	word [CLUSTNUM_HW],0
 33403                                  	;
 33404 00005964 4B                      	dec	bx
 33405 00005965 7904                    	jns	short FINCLUS
 33406 00005967 FF0E[E80A]              	dec	word [CLUSTNUM_HW]
 33407                                  	;;;
 33408                                  FINCLUS:
 33409                                  	;MOV	[CLUSNUM],BX	; Last cluster accessed
 33410                                  	; 27/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 33411                                  	;;;
 33412                                  	;push	bx
 33413                                  	;add	[LASTPOS],bx
 33414                                  	;mov	bx,[CLUSTNUM_HW]
 33415                                  	;adc	[LASTPOS_HW],bx
 33416                                  	;mov	[CLUSNUM_HW],bx
 33417                                  	;pop	word [CLUSNUM]
 33418                                  	;
 33419 0000596B 891E[BC05]              	mov	[CLUSNUM],bx
 33420 0000596F 011E[BA05]              	add	[LASTPOS],bx
 33421 00005973 A1[E80A]                	mov	ax,[CLUSTNUM_HW]
 33422 00005976 1106[E20A]              	adc	[LASTPOS_HW],ax
 33423 0000597A A3[DE0A]                	mov	[CLUSNUM_HW],ax
 33424                                  	;;;
 33425 0000597D 29CA                    	SUB	DX,CX		; Number of sectors still needed
 33426 0000597F 52                      	PUSH	DX
 33427 00005980 89C8                    	MOV	AX,CX
 33428                                  	;mul	word[ES:BP+2]
 33429 00005982 26F76602                	MUL	word [ES:BP+DPB.SECTOR_SIZE] 
 33430                                  				; Number of sectors times sector size
 33431 00005986 8B36[B805]              	MOV	SI,[NEXTADD]
 33432 0000598A 01F0                    	ADD	AX,SI		; Adjust by size of transfer
 33433 0000598C A3[B805]                	MOV	[NEXTADD],AX
 33434 0000598F 58                      	POP	AX		; Number of sectors still needed
 33435 00005990 5A                      	POP	DX		; Starting cluster
 33436                                  	; 27/02/2024 (PCDOS 7.1 IBMDOS.COM)
 33437                                  	;SUB	BX,DX		; Number of new clusters accessed
 33438                                  	;ADD	[LASTPOS],BX
 33439                                  	;;;
 33440 00005991 5B                      	pop	bx		; Starting cluster, hw
 33441 00005992 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 33442 00005996 2916[BA05]              	sub	[LASTPOS],dx
 33443 0000599A 191E[E20A]              	sbb	[LASTPOS_HW],bx
 33444                                  	;;;
 33445 0000599E 5B                      	POP	BX		; BL = sector position within cluster
 33446 0000599F E81600                  	call	FIGREC
 33447 000059A2 89F3                    	MOV	BX,SI
 33448                                  	; 24/09/2023
 33449                                  	; cf=0 (at the return of FIGREC)
 33450                                  	;CLC
 33451 000059A4 C3                      	retn
 33452                                  OP_ERR:
 33453                                  	;ADD	SP,4
 33454                                  	; 27/02/2024 (PCDOS 7.1 IBMDOS.COM)
 33455                                  	;;;
 33456 000059A5 83C406                  	add	sp,6
 33457                                  	;;;
 33458 000059A8 F9                      	STC
 33459 000059A9 C3                      	retn
 33460                                  BLKDON:
 33461 000059AA 29D1                    	SUB	CX,DX	  	; Number of sectors in cluster we don't want
 33462 000059AC 28CC                    	SUB	AH,CL	  	; Number of sectors in cluster we accepted
 33463 000059AE FECC                    	DEC	AH		; Adjust to mean position within cluster
 33464 000059B0 8826[7305]              	MOV	[SECCLUSPOS],AH
 33465 000059B4 89D1                    	MOV	CX,DX		; Anyway, make the total equal to the request
 33466 000059B6 EBB3                    	JMP	SHORT FINCLUS
 33467                                  
 33468                                  ;Break	<FIGREC -- Figure sector in allocation unit>
 33469                                  ;---------------------------------------------------------------------------
 33470                                  ;
 33471                                  ; Procedure Name : FIGREC
 33472                                  ;
 33473                                  ; Inputs:
 33474                                  ;	  DX = Physical cluster number
 33475                                  ;	  BL = Sector position within cluster
 33476                                  ;	  ES:BP = Base of drive parameters
 33477                                  ; Outputs:
 33478                                  ;	  DX = physical sector number (LOW)
 33479                                  ;	  [HIGH_SECTOR] Physical sector address (HIGH)
 33480                                  ; No other registers affected.
 33481                                  ;
 33482                                  ;---------------------------------------------------------------------------
 33483                                  
 33484                                  	; 10/06/2019
 33485                                  	; 20/05/2019 - Retro DOS v4.0
 33486                                  	; DOSCODE:8D96h (MSDOS 6.21, MSDOS.SYS)
 33487                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 33488                                  	; DOSCODE:8D5Bh (MSDOS 5.0, MSDOS.SYS)
 33489                                  
 33490                                  	; 27/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 33491                                  	; DOSCODE:9A89h (PCDOS 7.1, IBMDOS.COM)	
 33492                                  FIGREC:
 33493 000059B8 51                      	PUSH	CX
 33494                                  	; 27/02/2024
 33495                                  	;;;
 33496 000059B9 50                      	push	ax
 33497 000059BA 31C9                    	xor	cx,cx
 33498                                  	;;;
 33499                                  	;mov	cl,[es:bp+5]
 33500 000059BC 268A4E05                	MOV	CL,[ES:BP+DPB.CLUSTER_SHIFT]
 33501                                  	;DEC	DX
 33502                                  	;DEC	DX
 33503                                  	; 27/02/2024
 33504                                  	;;;
 33505                                  	;mov	ax,[ss:CLUSTNUM_HW]
 33506                                  	; ds = ss ; Retro DOS v5.0	
 33507 000059C0 A1[E80A]                	mov	ax,[CLUSTNUM_HW]
 33508 000059C3 83EA02                  	sub	dx,2
 33509 000059C6 83D800                  	sbb	ax,0
 33510 000059C9 E307                    	jcxz	noshift
 33511                                  	;;;
 33512                                  
 33513                                  ; 27/02/2024
 33514                                  %if 0
 33515                                  	; MSDOS 3.3
 33516                                  	;SHL	DX,CL
 33517                                  
 33518                                  ;hkn; SS override HIGH_SECTOR
 33519                                  	; MSDOS 6.0
 33520                                  	MOV	word [SS:HIGH_SECTOR],0		;F.C. >32mb
 33521                                  	; 24/09/2023
 33522                                  	xor	ch,ch				;F.C. >32mb
 33523                                  	OR	CL,CL				;F.C. >32mb
 33524                                  	JZ	short noshift			;F.C. >32mb
 33525                                  	; 27/02/2024
 33526                                  	;XOR	CH,CH				;F.C. >32mb
 33527                                  rotleft:					;F.C. >32mb
 33528                                  	CLC					;F.C. >32mb
 33529                                  	RCL	DX,1				;F.C. >32mb
 33530                                  	; 10/06/2019
 33531                                  	RCL	word [ss:HIGH_SECTOR],1		;F.C. >32mb
 33532                                  	LOOP	rotleft				;F.C. >32mb
 33533                                  %else
 33534                                  	; 27/02/2024 - Retro DOS v5.0
 33535                                  	; (PCDOS 7.1 IBMDOS.COM)
 33536                                  rotleft:
 33537 000059CB F8                      	clc
 33538 000059CC D1D2                    	rcl	dx,1
 33539 000059CE D1D0                    	rcl	ax,1
 33540 000059D0 E2F9                    	loop	rotleft	
 33541                                  %endif
 33542                                  
 33543                                  noshift:
 33544                                  	; MSDOS 3.3 & MSDOS 6.0
 33545 000059D2 08DA                    	OR	DL,BL
 33546                                  	
 33547                                  	; 27/02/2024 - Retro DOS v5.0
 33548                                  	;;;
 33549                                  	;cmp	word [es:bp+0Fh],0
 33550 000059D4 26394E0F                	cmp	word [es:bp+DPB.FAT_SIZE],cx ; 0
 33551 000059D8 750A                    	jnz	short noshift1  ; not FAT32
 33552                                  	;add	dx,[es:bp+29h]
 33553 000059DA 26035629                	add	dx,[es:bp+DPB.FCLUS_FSECTOR]
 33554                                  	;adc	ax,[es:bp+2Bh]
 33555 000059DE 2613462B                	adc	ax,[es:bp+DPB.FCLUS_FSECTOR+2]
 33556 000059E2 EB06                    	jmp	short noshift2
 33557                                  noshift1:
 33558                                  	;;;
 33559                                  
 33560                                  	;add	dx,[es:bp+0Bh]
 33561 000059E4 2603560B                	ADD	DX,[ES:BP+DPB.FIRST_SECTOR]
 33562                                  	; MSDOS 6.0
 33563                                  	; 10/06/2019
 33564                                  	;ADC	word [ss:HIGH_SECTOR],0		;F.C. >32mb
 33565                                  	; 24/09/2023
 33566                                  	; cx=0
 33567                                  	;ADC	word [ss:HIGH_SECTOR],cx ; 0
 33568                                  	; 27/02/2024 - Retro DOS v5.0
 33569                                  	;;;
 33570 000059E8 11C8                    	adc	ax,cx ; adc ax,0
 33571                                  noshift2:	
 33572                                  	;mov	[ss:HIGH_SECTOR],ax
 33573 000059EA A3[0706]                	mov	[HIGH_SECTOR],ax
 33574                                  	;
 33575 000059ED 58                      	pop	ax
 33576                                  	;;;
 33577                                  
 33578                                  	; MSDOS 3.3 & MSDOS 6.0
 33579 000059EE 59                      	POP	CX
 33580                                  figrec_retn:
 33581 000059EF C3                      	retn
 33582                                  
 33583                                  ; 20/05/2019 - Retro DOS v4.0
 33584                                  ; DOSCODE:8DC2h (MSDOS 6.21, MSDOS.SYS)
 33585                                  
 33586                                  ; 30/07/2018 - Retro DOS v3.0
 33587                                  ; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 
 33588                                  
 33589                                  ;Break   <ALLOCATE -- Assign disk space>
 33590                                  ;---------------------------------------------------------------------------
 33591                                  ;
 33592                                  ; Procedure Name : ALLOCATE - Allocate Disk Space
 33593                                  ;
 33594                                  ;   ALLOCATE is called to allocate disk clusters. The new clusters are
 33595                                  ;   FAT-chained onto the end of the existing file.
 33596                                  ;
 33597                                  ;   The DPB contains the cluster # of the last free cluster allocated
 33598                                  ;   (dpb_next_free). We start at this cluster and scan towards higher
 33599                                  ;   numbered clusters, looking for the necessary free blocks.
 33600                                  ;
 33601                                  ;   Once again, fancy terminology gets in the way of correct coding. When
 33602                                  ;   using next_free, start scanning AT THAT POINT and not the one following it.
 33603                                  ;   This fixes the boundary condition bug when only free = next_free = 2.
 33604                                  ;
 33605                                  ;       If we get to the end of the disk without satisfaction:
 33606                                  ;
 33607                                  ;           if (dpb_next_free == 2) then we've scanned the whole disk.
 33608                                  ;               return (insufficient_disk_space)
 33609                                  ;           ELSE
 33610                                  ;               dpb_next_free = 2; start scan over from the beginning.
 33611                                  ;
 33612                                  ;   Note that there is no multitasking interlock. There is no race when
 33613                                  ;   examining the entrys in an in-core FAT block since there will be no
 33614                                  ;   context switch. When UNPACK context switches while waiting for a FAT read
 33615                                  ;   we are done with any in-core FAT blocks, so again there is no race. The
 33616                                  ;   only special concern is that V2 and V3 MSDOS left the last allocated
 33617                                  ;   cluster as "00"; marking it EOF only when the entire alloc request was
 33618                                  ;   satisfied. We can't allow another activation to think this cluster is
 33619                                  ;   free, so we give it a special temporary mark to show that it is, indeed,
 33620                                  ;   allocated.
 33621                                  ;
 33622                                  ;   Note that when we run out of space this algorithem will scan from
 33623                                  ;   dpb_next_free to the end, then scan from cluster 2 through the end,
 33624                                  ;   redundantly scanning the later part of the disk. This only happens when
 33625                                  ;   we run out of space, so sue me.
 33626                                  ;
 33627                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
 33628                                  ;            C  A  V  E  A  T     P  A  T  T  E  R  S  O  N                ;
 33629                                  ;                                                                          ;
 33630                                  ;   The use of FATBYT and RESTFATBYT is somewhat mysterious. Here is the
 33631                                  ;   explanation:
 33632                                  ;
 33633                                  ;   In the NUL file case (sf_firclus currently 0) ALLOCATE is called with
 33634                                  ;   entry BX = 0. What needs to be done in this case is to stuff the cluster
 33635                                  ;   number of the first cluster allocated in sf_firclus when the ALLOCATE is
 33636                                  ;   complete. THIS VALUE IS SAVED TEMPORARILY IN CLUSTER 0, HENCE THE CURRENT
 33637                                  ;   VALUE IN CLUSTER 0 MUST BE SAVED AND RESTORED. This is a side effect of
 33638                                  ;   the fact that PACK and UNPACK don't treat requests for clusters 0 and 1 as
 33639                                  ;   errors. This "stuff" is done by the call to PACK which is right before
 33640                                  ;   the
 33641                                  ;           LOOP   findfre         ; alloc more if needed
 33642                                  ;   instruction when the first cluster is allocated to the nul file. The
 33643                                  ;   value is recalled from cluster 0 and stored at sf_firclus at ads4:
 33644                                  ;
 33645                                  ;   This method is obviously useless (because it is non-reentrant) for
 33646                                  ;   multitasking, and will have to be changed. Storing the required value on
 33647                                  ;   the stack is recommended. Setting sf_firclus at the PACK of cluster 0
 33648                                  ;   (instead of actually doing the PACK) is BAD because it doesn't handle
 33649                                  ;   problems with INT 24 well.
 33650                                  ;
 33651                                  ;            C  A  V  E  A  T     P  A  T  T  E  R  S  O  N                ;
 33652                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
 33653                                  ;                                                                          ;
 33654                                  ;       ENTRY   BX = Last cluster of file (0 if null file)
 33655                                  ;               CX = No. of clusters to allocate
 33656                                  ;               ES:BP = Base of drive parameters
 33657                                  ;               [THISSFT] = Points to SFT
 33658                                  ;
 33659                                  ;       EXIT   'C' set if insufficient space
 33660                                  ;                [FAILERR] can be tested to see the reason for failure
 33661                                  ;                CX = max. no. of clusters that could be added to file
 33662                                  ;              'C' clear if space allocated
 33663                                  ;                BX = First cluster allocated
 33664                                  ;                FAT is fully updated
 33665                                  ;                sf_FIRCLUS field of SFT set if file was null
 33666                                  ;
 33667                                  ;       USES    ALL but SI, BP
 33668                                  
 33669                                  ;callmagic  proc near
 33670                                  ;       push    ds                             ;push segment of routine 
 33671                                  ;       push    Offset MagicPatch              ;push offset for routine
 33672                                  ;       retf                                   ;simulate jmp far
 33673                                  ;                                              ;far return address is on
 33674                                  ;                                              ;stack, so far return from
 33675                                  ;                                              ;call will return this routine
 33676                                  ;callmagic  endp
 33677                                  
 33678                                  ; 27/02/2024 - Retro DOS v5.0
 33679                                  ;PCDOS 7.1 IBMDOS.COM - DOSCODE:9AC5h
 33680                                  
 33681                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8DC2h)
 33682                                  ; (Windows ME IO.SYS - BIOSCODE:0C078h)
 33683                                  
 33684                                  ; 25/09/2023
 33685                                  %if 1	; 27/02/2024
 33686                                  callmagic:
 33687 000059F0 1E                      	push	ds
 33688 000059F1 36FF36[0906]            	push	word [ss:OffsetMagicPatch]
 33689 000059F6 CB                      	retf	
 33690                                  %endif
 33691                                  
 33692                                  ; 10/02/2024 - Retro DOS v5.0
 33693                                  %if 1
 33694                                  ALLOCATE_X:
 33695 000059F7 A3[F00A]                	mov	[CCOUNT_HW],ax
 33696                                  	;jmp	short ALLOCATE
 33697                                  %endif
 33698                                  
 33699                                  	; 27/02/2024 - Retro DOS v5.0
 33700                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9ACFh
 33701                                  
 33702                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8DC9h)
 33703                                  	; (Windows ME IO.SYS - BIOSCODE:0C07Fh)
 33704                                  
 33705                                  ALLOCATE:
 33706                                  	; 10/09/2018
 33707                                  ;BEGIN MAGICDRV MODIFICATIONS
 33708                                  ;
 33709                                  ;7/5/92 scottq
 33710                                  ;
 33711                                  ;This is the disk compression patch location which allows
 33712                                  ;the disk compression software to fail allocations if the
 33713                                  ;FAT would allows allocation, but the free space for compressed
 33714                                  ;data would not.
 33715                                  ;        
 33716                                  ;;;	call    far ptr MAGICPATCH
 33717                                  ;;; We cannot do a far call since we cannot have fix-ups[romdos,hidos],
 33718                                  ;;; but we do know the segment and offset of the routine
 33719                                  ;;; so simulate a far call to dosdata:magicpatch
 33720                                  ;;; note dosassume above, so DS -> dosdata
 33721                                  
 33722                                  	; MSDOS 6.0
 33723                                          ;clc				;clear carry so we fall through
 33724                                  	;				;if no patch is present
 33725                                  	;push	cs			;push segment for far return
 33726                                          ;call	callmagic		;this is a near call
 33727                                          ;jnc	short Regular_Allocate_Path
 33728                                  	;jmp	Disk_Full_Return
 33729                                  
 33730                                  ; 27/02/2024 - Retro DOS v5.0
 33731                                  ; DOSCODE:9ACFh (PCDOS 7.1, IBMDOS.COM)
 33732                                  
 33733                                  ; 25/09/2023
 33734                                  %if 1	; 27/02/2024 - Retro DOS v5.0
 33735 000059FA F8                      	clc		; COUNT_HW:CX = Number of clusters to allocate
 33736 000059FB 0E                      	push	cs
 33737 000059FC E8F1FF                  	call	callmagic
 33738 000059FF 7303                    	jnc	short Regular_Allocate_Path
 33739 00005A01 E9CA01                  	jmp	Disk_Full_Return
 33740                                  Regular_Allocate_Path:
 33741                                  %endif
 33742                                  
 33743                                  	; 20/05/2019 - Retro DOS v4.0
 33744                                  ;END MAGICDRV MODIFICATIONS
 33745                                  
 33746                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 33747                                  	; DOSCODE:8D87h (MSDOS 5.0, MSDOS.SYS)
 33748                                  
 33749                                  	; 27/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 33750                                  	; DOSCODE:9AD6h (PCDOS 7.1, IBMDOS.COM)
 33751                                  
 33752 00005A04 53                              PUSH    BX                      ; save (bx)
 33753 00005A05 31DB                            XOR     BX,BX
 33754                                  
 33755                                  	; 27/02/2024
 33756                                  	;;;
 33757 00005A07 FF36[E80A]              	push	word [CLUSTNUM_HW]
 33758 00005A0B 891E[E80A]              	mov	[CLUSTNUM_HW],bx ; cluster 0
 33759                                  	;;;
 33760                                  
 33761 00005A0F E8FE08                  	call	UNPACK
 33762 00005A12 893E[9605]                      MOV     [FATBYT],DI             ; save correct cluster 0 value
 33763                                  
 33764                                  	; 27/02/2024
 33765                                  	;;;		; CCONTENT_HW:DI = content of FAT (for cluster 0)
 33766 00005A16 8B1E[EC0A]              	mov	bx,[CCONTENT_HW]
 33767 00005A1A 891E[E40A]              	mov	[FATBYT_HW],bx
 33768 00005A1E 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 33769                                  	;;;
 33770                                  
 33771 00005A22 5B                              POP     BX
 33772 00005A23 72CA                            jc	short figrec_retn	; abort if error [INTERR?]
 33773                                  
 33774                                  ; 27/02/2024
 33775                                  %if 0
 33776                                          PUSH    CX
 33777                                          PUSH    BX
 33778                                  
 33779                                          MOV     DX,BX
 33780                                  	;;mov	bx,[es:bp+1Ch]  ; MSDOS 3.3
 33781                                  	;mov	bx,[es:bp+1Dh]	; MSDOS 6.0
 33782                                          mov     bx,[ES:BP+DPB.NEXT_FREE]
 33783                                          cmp     bx,2
 33784                                          ja	short FINDFRE
 33785                                  
 33786                                  ;   couldn't find enough free space beyond dpb_next_free, or dpb_next_free is
 33787                                  ;   <2 or >dpb_max_clus. Reset it and restart the scan
 33788                                  
 33789                                  ads1:
 33790                                  	;;mov	word [es:bp+1Ch],2 ; MSDOS 3.3
 33791                                  	;mov	word [es:bp+1Dh],2 ; MSDOS 6.0
 33792                                          mov     word [ES:BP+DPB.NEXT_FREE],2
 33793                                          mov     bx,1                    ; Counter next instruction so first
 33794                                                                          ;       cluster examined is 2
 33795                                  %else
 33796                                  	; 27/02/2024 - Retro DOS v5.0
 33797                                  	; (PCDOS 7.1 IBMDOS.COM)
 33798                                  	;;;
 33799 00005A25 FF36[F00A]              	push	word [CCOUNT_HW]
 33800 00005A29 51                      	push	cx
 33801 00005A2A FF36[E80A]              	push	word [CLUSTNUM_HW]
 33802 00005A2E 53                      	push	bx
 33803                                  
 33804 00005A2F 89DA                    	mov	dx,bx
 33805                                  
 33806 00005A31 31DB                    	xor	bx,bx ; 0
 33807                                  	;cmp	[es:bp+0Fh],bx ; 0
 33808 00005A33 26395E0F                	cmp	[es:bp+DPB.FAT_SIZE],bx ; 0
 33809 00005A37 871E[E80A]              	xchg	bx,[CLUSTNUM_HW]
 33810 00005A3B 891E[EA0A]              	mov	[CLUSDATA_HW],bx
 33811                                  	;mov	bx,[es:bp+1Dh]
 33812 00005A3F 268B5E1D                	mov	bx,[es:bp+DPB.NEXT_FREE]
 33813 00005A43 7510                    	jnz	short ads1		; not FAT32
 33814                                  
 33815                                  	;mov	bx,[es:bp+3Bh]
 33816 00005A45 268B5E3B                	mov	bx,[es:bp+DPB.FAT32_NXTFREE+2]
 33817 00005A49 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 33818                                  	;cmp	bx,0
 33819 00005A4D 09DB                    	or	bx,bx
 33820                                  	;mov	bx,[es:bp+39h]
 33821 00005A4F 268B5E39                	mov	bx,[es:bp+DPB.FAT32_NXTFREE]
 33822 00005A53 7526                    	jnz	short FINDFRE
 33823                                  ads1:
 33824 00005A55 83FB02                  	cmp	bx,2
 33825 00005A58 7721                    	ja	short FINDFRE
 33826                                  ads2:
 33827 00005A5A 31DB                    	xor	bx,bx ; 0
 33828                                  	;cmp	[es:bp+0Fh],bx
 33829 00005A5C 26395E0F                	cmp	[es:bp+DPB.FAT_SIZE],bx ; 0
 33830 00005A60 750A                    	jnz	short ads3		; not FAT32
 33831                                  
 33832                                  	;mov	word [es:bp+39h],2
 33833 00005A62 26C746390200            	mov	word [es:bp+DPB.FAT32_NXTFREE],2
 33834                                  	;mov	[es:bp+3Bh],bx
 33835 00005A68 26895E3B                	mov	[es:bp+DPB.FAT32_NXTFREE+2],bx ; 0
 33836                                  ads3:
 33837 00005A6C 891E[E80A]              	mov	[CLUSTNUM_HW],bx ; 0
 33838                                  	;mov	word [es:bp+1Dh],2	
 33839 00005A70 26C7461D0200            	mov	word [es:bp+DPB.NEXT_FREE],2
 33840 00005A76 43                      	inc	bx ; 1
 33841                                  	;or	[es:bp+18h],bl
 33842 00005A77 26085E18                	or	[es:bp+DPB.FIRST_ACCESS],bl ; 1	
 33843                                  	;;;
 33844                                  %endif
 33845                                  
 33846                                  ;   Scanning both forwards and backwards for a free cluster
 33847                                  ;
 33848                                  ;       (BX) = forwards scan pointer
 33849                                  ;       (CX) = clusters remaining to be allocated
 33850                                  ;       (DX) = current last cluster in file
 33851                                  ;       (TOS) = last cluster of file
 33852                                  
 33853                                  FINDFRE:
 33854                                  %if 0
 33855                                          INC     BX
 33856                                  	;cmp	bx,[es:bp+0Dh]
 33857                                          CMP	BX,[ES:BP+DPB.MAX_CLUSTER]
 33858                                  	ja	short ads7	; at end of disk
 33859                                          call	UNPACK          ; check out this cluster
 33860                                          jc	short ads4	; FAT error             [INTERR?]
 33861                                          jnz	short FINDFRE	; not free, keep on truckin
 33862                                  
 33863                                  ;   Have found a free cluster. Chain it to the file
 33864                                  ;
 33865                                  ;       (BX) = found free cluster #
 33866                                  ;       (DX) = current last cluster in file
 33867                                  
 33868                                  	;;mov	[es:bp+1Ch],bx
 33869                                  	;mov	[es:bp+1Dh],bx ; MSDOS 6.0
 33870                                          mov	[ES:BP+DPB.NEXT_FREE],bx ; next time start search here
 33871                                          xchg    ax,dx           ; save (dx) in ax
 33872                                          mov     dx,1            ; mark this free guy as "1"
 33873                                  	call	PACK            ; set special "temporary" mark
 33874                                          jc	short ads4	; FAT error             [INTERR?]
 33875                                  	;;cmp	word [es:bp+1Eh],-1
 33876                                          ;cmp	word [es:bp+1Fh],-1 ; MSDOS 6.0
 33877                                  	CMP	word [ES:BP+DPB.FREE_CNT],-1 ; Free count valid?
 33878                                          JZ	short NO_ALLOC	; No
 33879                                  	;;dec	word [es:bp+1Eh]
 33880                                          ;dec	word [es:bp+1Fh] ; MSDOS 6.0
 33881                                          DEC     word [ES:BP+DPB.FREE_CNT] ; Reduce free count by 1
 33882                                  NO_ALLOC:
 33883                                          xchg    ax,dx           ; (dx) = current last cluster in file
 33884                                          XCHG    BX,DX
 33885                                          MOV     AX,DX
 33886                                  	call	PACK            ; link free cluster onto file
 33887                                                                  ;  CAVEAT.. On Nul file, first pass stuffs
 33888                                                                  ;    cluster 0 with FIRCLUS value.
 33889                                          jc	short ads4	; FAT error [INTERR?]
 33890                                          xchg    BX,AX           ; (BX) = last one we looked at
 33891                                          mov     dx,bx           ; (dx) = current end of file
 33892                                          LOOP    FINDFRE         ; alloc more if needed
 33893                                  %else
 33894                                  	; 27/02/2024 - Retro DOS v5.0
 33895                                  	; (PCDOS 7.1 IBMDOS.COM)
 33896                                  	;;;
 33897                                  	;add	bx,1
 33898                                  	;adc	word [CLUSTNUM_HW],0
 33899 00005A7B 43                      	inc	bx
 33900 00005A7C 7504                    	jnz	short FINDFRE2
 33901 00005A7E FF06[E80A]              	inc	word [CLUSTNUM_HW]
 33902                                  FINDFRE2:
 33903                                  	;cmp	word [es:bp+0Fh],0
 33904 00005A82 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 33905 00005A87 7512                    	jnz	short ads4 ; not FAT32
 33906                                  	; FAT32
 33907 00005A89 53                      	push	bx
 33908 00005A8A 8B1E[E80A]              	mov	bx,[CLUSTNUM_HW]
 33909                                  	;cmp	bx,[es:bp+2Fh]
 33910 00005A8E 263B5E2F                	cmp	bx,[es:bp+DPB.LAST_CLUSTER+2]
 33911 00005A92 5B                      	pop	bx
 33912 00005A93 750A                    	jne	short ads5
 33913                                  	;cmp	bx,[es:bp+2Dh]
 33914 00005A95 263B5E2D                	cmp	bx,[es:bp+DPB.LAST_CLUSTER]
 33915 00005A99 EB04                    	jmp	short ads5
 33916                                  ads4:
 33917                                  	;cmp	bx,[es:bp+0Dh]
 33918 00005A9B 263B5E0D                	cmp	bx,[es:bp+DPB.MAX_CLUSTER]
 33919                                  ads5:
 33920 00005A9F 7603                    	jbe	short ads6 ; jna short ads6
 33921 00005AA1 E9ED00                  	jmp	ads15
 33922                                  ads6:
 33923                                  	; 27/02/2024 - Retro DOS v5.0
 33924                                  	;push	cx
 33925                                  	;push	word [CCOUNT_HW]
 33926                                  	;push	bx
 33927                                  	;push	word [CLUSTNUM_HW]
 33928                                  	;push	dx
 33929                                  	;push	word [CLUSDATA_HW]
 33930                                  
 33931 00005AA4 E86908                  	call	UNPACK
 33932                                  
 33933                                  	; 27/02/2024 - Retro DOS v5.0
 33934                                  	;pop	word [CLUSDATA_HW]
 33935                                  	;pop	dx
 33936                                  	;pop	word [CLUSTNUM_HW]
 33937                                  	;pop	bx
 33938                                  	;pop	word [CCOUNT_HW]
 33939                                  	;pop	cx
 33940                                  	
 33941 00005AA7 7303                    	jnc	short ads7
 33942                                  	
 33943 00005AA9 E9A200                  	jmp	ads13
 33944                                  ads7:
 33945 00005AAC 75CD                    	jnz	short FINDFRE
 33946                                  
 33947                                  	;mov	[es:bp+1Dh],bx
 33948 00005AAE 26895E1D                	mov	[es:bp+DPB.NEXT_FREE],bx
 33949                                  
 33950                                  	;cmp	word [es:bp+0Fh],0
 33951 00005AB2 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 33952 00005AB7 750E                    	jnz	short ads8 ; not FAT32
 33953                                  	; FAT32
 33954 00005AB9 53                      	push	bx
 33955 00005ABA 8B1E[E80A]              	mov	bx,[CLUSTNUM_HW]
 33956                                  	;mov	[es:bp+3Bh],bx
 33957 00005ABE 26895E3B                	mov	[es:bp+DPB.FAT32_NXTFREE+2],bx
 33958 00005AC2 5B                      	pop	bx
 33959                                  	;mov	[es:bp+39h],bx
 33960 00005AC3 26895E39                	mov	[es:bp+DPB.FAT32_NXTFREE],bx
 33961                                  ads8:
 33962                                  	;or	byte [es:bp+18h],1
 33963 00005AC7 26804E1801              	or	byte [es:bp+DPB.FIRST_ACCESS],1
 33964                                  
 33965                                  	; 27/02/2024 - Retro DOS v5.0
 33966                                  	;push	cx
 33967                                  	;push	word [CCOUNT_HW]
 33968                                  	
 33969 00005ACC 53                      	push	bx
 33970 00005ACD FF36[E80A]              	push	word [CLUSTNUM_HW]
 33971 00005AD1 52                      	push	dx
 33972 00005AD2 FF36[EA0A]              	push	word [CLUSDATA_HW]
 33973                                  
 33974 00005AD6 31D2                    	xor	dx,dx	; 0
 33975 00005AD8 8916[EA0A]              	mov	[CLUSDATA_HW],dx ; 0
 33976 00005ADC 42                      	inc	dx	; 1	; mark this free guy as "1"
 33977 00005ADD E8DE08                  	call	PACK		; set special "temporary" mark
 33978                                  
 33979 00005AE0 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 33980 00005AE4 5B                      	pop	bx
 33981 00005AE5 8F06[EA0A]              	pop	word [CLUSDATA_HW]
 33982 00005AE9 5A                      	pop	dx
 33983                                  
 33984                                  	; 27/02/2024 - Retro DOS v5.0
 33985                                  	;pop	word [CCOUNT_HW]
 33986                                  	;pop	cx
 33987                                  
 33988 00005AEA 7262                    	jc	short ads13
 33989                                  
 33990 00005AEC 50                      	push	ax
 33991 00005AED 31C0                    	xor	ax,ax ; 0
 33992                                  	;cmp	[es:bp+0Fh],ax ; 0
 33993 00005AEF 2639460F                	cmp	[es:bp+DPB.FAT_SIZE],ax ; 0
 33994 00005AF3 7517                    	jnz	short ads10 ; not FAT32
 33995                                  	; FAT32
 33996 00005AF5 48                      	dec	ax ; 0FFFFh ; -1
 33997                                  	;cmp	[es:bp+21h],ax
 33998 00005AF6 26394621                	cmp	[es:bp+DPB.FREE_CNT+2],ax ; 0FFFFh
 33999 00005AFA 7506                    	jnz	short ads9
 34000                                  	;cmp	[es:bp+1Fh],ax
 34001 00005AFC 2639461F                	cmp	[es:bp+DPB.FREE_CNT],ax ; 0FFFFh
 34002                                  ;ads9:
 34003 00005B00 7415                    	jz	short NO_ALLOC	; Free count not valid
 34004                                  ads9:	
 34005                                  	; Reduce free count by 1
 34006                                  	;add	[es:bp+1Fh],ax
 34007 00005B02 2601461F                	add	[es:bp+DPB.FREE_CNT],ax ; -1
 34008                                  	;adc	[es:bp+21h],ax
 34009 00005B06 26114621                	adc	[es:bp+DPB.FREE_CNT+2],ax ; -1
 34010 00005B0A EB0B                    	jmp	short NO_ALLOC
 34011                                  ads10:
 34012 00005B0C 48                      	dec	ax ; 0FFFFh ; -1
 34013                                  	;cmp	[es:bp+1Fh],ax
 34014 00005B0D 2639461F                	cmp	[es:bp+DPB.FREE_CNT],ax ; 0FFFFh
 34015 00005B11 7404                    	jz	short NO_ALLOC	; Free count not valid
 34016                                  	;dec	word [es:bp+1Fh]
 34017 00005B13 26FF4E1F                	dec	word [es:bp+DPB.FREE_CNT] ; Reduce free count by 1
 34018                                  NO_ALLOC:
 34019 00005B17 58                      	pop	ax
 34020                                  
 34021                                  	; 27/02/2024 - Retro DOS v5.0
 34022                                  	;push	cx
 34023                                  	;push	word [CCOUNT_HW]
 34024                                  
 34025 00005B18 52                      	push	dx
 34026 00005B19 FF36[EA0A]              	push	word [CLUSDATA_HW]
 34027                                  
 34028 00005B1D E89E08                  	call	PACK
 34029                                  
 34030 00005B20 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 34031 00005B24 5B                      	pop	bx
 34032                                  
 34033                                  	; 27/02/2024 - Retro DOS v5.0
 34034                                  	;pop	word [CCOUNT_HW]
 34035                                  	;pop	cx
 34036                                  	
 34037 00005B25 7227                    	jc	short ads13
 34038                                  	
 34039 00005B27 8B16[E80A]              	mov	dx,[CLUSTNUM_HW]
 34040 00005B2B 8916[EA0A]              	mov	[CLUSDATA_HW],dx
 34041 00005B2F 89DA                    	mov	dx,bx
 34042                                  
 34043 00005B31 83E901                  	sub	cx,1
 34044 00005B34 831E[F00A]00            	sbb	word [CCOUNT_HW],0
 34045                                  
 34046 00005B39 3B0E[F00A]              	cmp	cx,[CCOUNT_HW]
 34047 00005B3D 7502                    	jne	short ads11
 34048 00005B3F E303                    	jcxz	ads12
 34049                                  ads11:
 34050 00005B41 E937FF                  	jmp	FINDFRE
 34051                                  	;;;
 34052                                  %endif
 34053                                  
 34054                                  
 34055                                  ;   We've successfully extended the file. Clean up and exit
 34056                                  ;
 34057                                  ;       (BX) = last cluster in file
 34058                                  
 34059                                  ads12:		; 27/02/2024
 34060 00005B44 BAFFFF                          MOV     DX,0FFFFH
 34061                                  	;;;
 34062 00005B47 8916[EA0A]              	mov	[CLUSDATA_HW],dx
 34063                                  	;;;
 34064 00005B4B E87008                  	call	PACK            ; mark last cluster EOF
 34065                                  
 34066                                  ;   Note that FAT errors jump here to clean the stack and exit. This saves us
 34067                                  ;   2 whole bytes. Hope its worth it...
 34068                                  ;
 34069                                  ;       'C' set if error
 34070                                  ;       calling (BX) and (CX) pushed on stack
 34071                                  
 34072                                  ; 27/02/2024
 34073                                  %if 0
 34074                                  
 34075                                  ads4:   
 34076                                  	POP     BX
 34077                                          POP     CX              ; Don't need this stuff since we're successful
 34078                                          jc	short figrec_retn
 34079                                          call	UNPACK          ; Get first cluster allocated for return
 34080                                                                  ; CAVEAT... In nul file case, UNPACKs cluster 0.
 34081                                          jc	short figrec_retn
 34082                                  	call	RESTFATBYT      ; Restore correct cluster 0 value
 34083                                          jc	short figrec_retn
 34084                                          XCHG    BX,DI           ; (DI) = last cluster in file upon our entry
 34085                                          OR      DI,DI           ; clear 'C'
 34086                                  	jnz	short figrec_retn ; we were extending an existing file
 34087                                  %else
 34088                                  	; 27/02/2024 - Retro DOS v5.0
 34089                                  	; (PCDOS 7.1 IBMDOS.COM)
 34090                                  	;;;
 34091                                  ads13:
 34092 00005B4E 5B                      	pop	bx
 34093 00005B4F 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 34094 00005B53 59                      	pop	cx
 34095 00005B54 8F06[F00A]              	pop	word [CCOUNT_HW]
 34096 00005B58 7301                    	jnc	short ads14
 34097                                  ads_ret:
 34098 00005B5A C3                      	retn
 34099                                  ads14:
 34100 00005B5B E8B207                  	call	UNPACK		; Get first cluster allocated for return
 34101 00005B5E 72FA                    	jc	short ads_ret
 34102 00005B60 E87200                  	call    RESTFATBYT      ; Restore correct cluster 0 value
 34103 00005B63 72F5                    	jc	short ads_ret
 34104 00005B65 50                      	push	ax
 34105 00005B66 A1[EC0A]                	mov	ax,[CCONTENT_HW]
 34106 00005B69 8706[E80A]              	xchg	ax,[CLUSTNUM_HW]
 34107 00005B6D 87DF                    	xchg	bx,di		; CLUSTNUM_HW:DI = last cluster in file upon our entry
 34108 00005B6F 09F8                    	or	ax,di
 34109 00005B71 58                      	pop	ax
 34110 00005B72 75E6                    	jnz	short ads_ret	; we were extending an existing file
 34111                                  	;;;
 34112                                  %endif
 34113                                  
 34114                                  ;   We were doing the first allocation for a new file. Update the SFT cluster
 34115                                  ;   info
 34116                                  dofastk:
 34117                                  ; 27/02/2024
 34118                                  %if 0
 34119                                  	; 20/05/2019
 34120                                  	; MSDOS 6.0
 34121                                  	;push	dx ; * MSDOS 6.0
 34122                                  	;;mov	dl,[es:bp+0]
 34123                                  	;;MOV	DL,[ES:BP+DPB.DRIVE]	; get drive #
 34124                                  	;mov	dl,[es:bp]
 34125                                  
 34126                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 34127                                  	; DOSCODE:8DF9h (MSDOS 5.0, MSDOS.SYS)
 34128                                  	
 34129                                  	; 16/12/2022
 34130                                  	;push	dx ; *
 34131                                  	;mov	dl,[ES:BP+DPB.DRIVE] 
 34132                                  	; 15/12/2022
 34133                                  	;mov	dl,[es:bp]
 34134                                  
 34135                                  	; MSDOS 3.3 & MSDOS 6.0
 34136                                  	PUSH	ES
 34137                                  	LES     DI,[THISSFT]
 34138                                  	;mov	[es:di+0Bh],bx
 34139                                  	MOV     [ES:DI+SF_ENTRY.sf_firclus],BX
 34140                                  	;;mov	[es:di+1Bh],bx ; MSDOS 3.3
 34141                                  	;mov	[es:di+35h],bx ; MSDOS 6.0
 34142                                  	MOV     [ES:DI+SF_ENTRY.sf_lstclus],BX
 34143                                  	POP	ES
 34144                                  	;retn
 34145                                  
 34146                                  	;pop	dx ; * MSDOS 6.0
 34147                                  
 34148                                  	; 16/12/2022
 34149                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 34150                                  	;pop	dx ; *
 34151                                  %else
 34152                                  	; 27/02/2024 - Retro DOS v5.0
 34153                                  	; (PCDOS 7.1 IBMDOS.COM)
 34154                                  	;;;
 34155 00005B74 52                      	push	dx
 34156 00005B75 06                      	push	es
 34157 00005B76 C43E[9E05]              	les	di,[THISSFT]
 34158 00005B7A 8B16[E80A]              	mov	dx,[CLUSTNUM_HW]
 34159 00005B7E 26895D2B                	mov	[es:di+2Bh],bx	; [es:di+SF_ENTRYT.sf_chain]
 34160                                  				; 32 bit first cluster, lw
 34161 00005B82 2689552D                	mov	[es:di+2Dh],dx	; [es:di+SF_ENTRYT.sf_chain+2]
 34162                                  				; 32 bit first cluster, hw
 34163 00005B86 26895D35                	mov	[es:di+35h],bx	; [es:di+SF_ENTRYT.sf_lstclus]
 34164                                  				; 32 bit last cluster, lw
 34165 00005B8A 26895537                	mov	[es:di+37h],dx	; [es:di+SF_ENTRYT.sf_lstclus+2]
 34166                                  				; 32 bit last cluster, hw
 34167 00005B8E 07                      	pop	es
 34168 00005B8F 5A                      	pop	dx
 34169                                  	;;;
 34170                                  %endif	
 34171                                  
 34172 00005B90 C3                      	retn
 34173                                  
 34174                                  ;** we're at the end of the disk, and not satisfied. See if we've scanned ALL
 34175                                  ;   of the disk...
 34176                                  
 34177                                  ; 27/02/2024
 34178                                  %if 0
 34179                                  ads7:
 34180                                  	;cmp	word [es:bp+1Dh],2   
 34181                                  	cmp	word [ES:BP+DPB.NEXT_FREE],2
 34182                                  	jnz	short ads1	; start scan from front of disk
 34183                                  %else	
 34184                                  	; 27/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 34185                                  	;;;
 34186                                  ads15:
 34187                                  	;cmp	word [es:bp+0Fh],0
 34188 00005B91 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 34189 00005B96 7407                    	jz	short ads16 ; FAT32
 34190                                  	; FAT
 34191                                  	;cmp	word [es:bp+1Dh],2
 34192 00005B98 26837E1D02              	cmp	word [es:bp+DPB.NEXT_FREE],2
 34193 00005B9D EB0C                    	jmp	short ads17
 34194                                  ads16:
 34195                                  	;cmp	word [es:bp+3Bh],0
 34196 00005B9F 26837E3B00              	cmp	word [es:bp+DPB.FAT32_NXTFREE+2],0
 34197                                  	;jnz	short ads17
 34198 00005BA4 7507                    	jnz	short ads19 ; 27/02/2024
 34199                                  	;cmp	word [es:bp+39h],2
 34200 00005BA6 26837E3902              	cmp	word [es:bp+DPB.FAT32_NXTFREE],2
 34201                                  ads17:
 34202 00005BAB 7403                    	jz	short ads18
 34203                                  ads19:
 34204 00005BAD E9AAFE                  	jmp	ads2		; start scan from front of disk
 34205                                  	;;;
 34206                                  %endif
 34207                                  
 34208                                  ;   Sorry, we've gone over the whole disk, with insufficient luck. Lets give
 34209                                  ;   the space back to the free list and tell the caller how much he could have
 34210                                  ;   had.  We have to make sure we remove the "special mark" we put on the last
 34211                                  ;   cluster we were able to allocate, so it doesn't become orphaned.
 34212                                  ;
 34213                                  ;       (CX) = clusters remaining to be allocated
 34214                                  ;       (TOS) = last cluster of file (before call to ALLOCATE)
 34215                                  ;       (TOS+1) = # of clusters wanted to allocate
 34216                                  
 34217                                  ads18:		; 27/02/2024
 34218 00005BB0 5B                              POP     BX              ; (BX) = last cluster of file
 34219 00005BB1 BAFFFF                          MOV     DX,0FFFFH
 34220                                  
 34221                                  	; 27/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 34222                                  	;;;
 34223 00005BB4 8916[EA0A]              	mov	[CLUSDATA_HW],dx
 34224 00005BB8 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 34225                                  	;;;
 34226                                  
 34227 00005BBC E84400                  	call	RELBLKS         ; give back any clusters just alloced
 34228 00005BBF 58                              POP     AX              ; No. of clusters requested
 34229                                                                  ; Don't "retc". We are setting Carry anyway,
 34230                                                                  ;   Alloc failed, so proceed with return CX
 34231                                                                  ;   setup.
 34232                                  	;;;	; 27/02/2024
 34233 00005BC0 8F06[F20A]              	pop	word [CLUSTERS_HW]
 34234                                  	;;;
 34235                                  
 34236 00005BC4 29C8                            SUB     AX,CX           ; AX=No. of clusters allocated
 34237                                  
 34238                                  	;;;	; 27/02/2024
 34239 00005BC6 831E[F20A]00            	sbb	word [CLUSTERS_HW],0
 34240                                  	;;;
 34241                                  
 34242 00005BCB E80700                  	call	RESTFATBYT      ; Don't "retc". We are setting Carry anyway,
 34243                                                                  ;   Alloc failed.
 34244                                  Disk_Full_Return:               ;label added for magic patch 8-6-92 scottq
 34245                                          ; MSDOS 6.0
 34246 00005BCE C606[0B06]01            	MOV	byte [DISK_FULL],1 ;MS. indicating disk full
 34247 00005BD3 F9                              STC
 34248 00005BD4 C3                              retn
 34249                                  
 34250                                  ;-----------------------------------------------------------------------
 34251                                  ;
 34252                                  ; Procedure Name : RESTFATBYT
 34253                                  ;
 34254                                  ; SEE ALLOCATE CAVEAT
 34255                                  ;       Carry set if error (currently user FAILed to I 24)
 34256                                  ;-----------------------------------------------------------------------
 34257                                  
 34258                                  	; 27/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 34259                                  
 34260                                  RESTFATBYT:
 34261 00005BD5 53                              PUSH    BX
 34262 00005BD6 52                              PUSH    DX
 34263 00005BD7 57                              PUSH    DI
 34264                                  
 34265 00005BD8 31DB                            XOR     BX,BX
 34266                                  
 34267                                  	; 27/02/2024 - Retro DOS v5.0
 34268                                  	; (PCDOS 7.1 IBMDOS.COM)
 34269                                  	;;;
 34270                                  	;push	word [CLUSTNUM_HW]
 34271                                  	;push	word [CLUSDATA_HW]
 34272                                  	;push	word [CCONTENT_HW]  ; (not necessary ?)
 34273 00005BDA 891E[E80A]              	mov	[CLUSTNUM_HW],bx ; 0
 34274 00005BDE 8B16[E40A]              	mov	dx,[FATBYT_HW]
 34275 00005BE2 8916[EA0A]              	mov	[CLUSDATA_HW],dx
 34276                                  	;;;
 34277                                  
 34278 00005BE6 8B16[9605]                      MOV     DX,[FATBYT]
 34279                                  
 34280 00005BEA E8D107                  	call	PACK
 34281                                  
 34282                                  	; 27/02/2024 - Retro DOS v5.0
 34283                                  	; (PCDOS 7.1 IBMDOS.COM)
 34284                                  	;;;
 34285 00005BED 8F06[EC0A]              	pop	word [CCONTENT_HW]
 34286 00005BF1 8F06[EA0A]              	pop	word [CLUSDATA_HW]
 34287 00005BF5 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 34288                                  	;;;
 34289                                  
 34290 00005BF9 5F                              POP     DI
 34291 00005BFA 5A                              POP     DX
 34292 00005BFB 5B                              POP     BX
 34293                                  
 34294                                  ; 16/12/2022
 34295                                  ; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 34296                                  ;RELEASE_flush:
 34297 00005BFC C3                      	retn
 34298                                  
 34299                                  ;Break	<RELEASE -- DEASSIGN DISK SPACE>
 34300                                  ;---------------------------------------------------------------------------
 34301                                  ;
 34302                                  ; Procedure Name : RELEASE
 34303                                  ;
 34304                                  ; Inputs:
 34305                                  ;       BX = Cluster in file
 34306                                  ;       ES:BP = Base of drive parameters
 34307                                  ; Function:
 34308                                  ;       Frees cluster chain starting with [BX]
 34309                                  ;       Carry set if error (currently user FAILed to I 24)
 34310                                  ; AX,BX,DX,DI all destroyed. Other registers unchanged.
 34311                                  ;
 34312                                  ;-----------------------------------------------------------------------------
 34313                                  
 34314                                  	; 28/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 34315                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9D13h
 34316                                  
 34317                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8E86h)
 34318                                  	; (Windows ME IO.SYS - BIOSCODE:0C27Fh)
 34319                                  
 34320                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 34321                                  	; 20/05/2019 - Retro DOS v4.0
 34322                                  RELEASE:
 34323 00005BFD 31D2                            XOR     DX,DX
 34324                                  	
 34325                                  	; 28/02/2024 - Retro DOS v5.0
 34326                                  	; (PCDOS 7.1 IBMDOS.COM)
 34327                                  	;;;
 34328 00005BFF 8916[EA0A]              	mov	[CLUSDATA_HW],dx ; (dx = 0, release)
 34329                                  	;;;
 34330                                  
 34331                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9D19h
 34332                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8E88h)
 34333                                  	; (Windows ME IO.SYS - BIOSCODE:0C285h)
 34334                                  
 34335                                  	;entry	RELBLKS
 34336                                  RELBLKS:
 34337                                  
 34338                                  ;   Enter here with DX=0FFFFH to put an end-of-file mark in the first cluster
 34339                                  ;   and free the rest in the chain.
 34340                                  
 34341 00005C03 E80A07                  	call	UNPACK
 34342                                  	;jc	short RELEASE_flush
 34343                                  	;jz	short RELEASE_flush
 34344                                  	; 28/12/2024 (PCDOS 7.1 IBMDOS.COM)
 34345 00005C06 7652                            jbe	short RET12 ; jna short RET12
 34346                                  				; CCONTENT_HW:DI= Content of FAT
 34347                                   				; for given cluster (next cluster)
 34348 00005C08 89F8                    	MOV     AX,DI
 34349 00005C0A 52                              PUSH    DX
 34350                                  
 34351                                  	;;; 28/12/2024 - Retro DOS v5.0
 34352                                  	;push	ax
 34353                                  	;;;
 34354                                  
 34355 00005C0B E8B007                  	call	PACK
 34356                                  
 34357                                  	;;; 28/12/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 34358                                  	;pop	ax
 34359 00005C0E 8B16[EC0A]              	mov	dx,[CCONTENT_HW]
 34360 00005C12 8916[E80A]              	mov	[CLUSTNUM_HW],dx ; next cluster (hw) to be released
 34361 00005C16 89C3                    	mov	bx,ax		 ; next cluster (lw) to be released
 34362                                  	;;;
 34363                                          
 34364 00005C18 5A                      	POP     DX
 34365                                  	;jc	short RELEASE_flush
 34366                                  	; 28/12/2024 (PCDOS 7.1 IBMDOS.COM)
 34367 00005C19 723F                    	jc	short RET12
 34368                                          
 34369 00005C1B 09D2                    	OR      DX,DX
 34370 00005C1D 751F                            JNZ	short NO_DEALLOC	; Was putting EOF mark
 34371                                  
 34372                                  ; 28/02/2024
 34373                                  %if 0
 34374                                  	;;cmp	word [es:bp+1Eh],-1 ; MSDOS 3.3
 34375                                  	;cmp	word [es:bp+1Fh],-1 ; MSDOS 6.0
 34376                                  	CMP     word [ES:BP+DPB.FREE_CNT],-1 ; Free count valid?
 34377                                          JZ	short NO_DEALLOC	; No
 34378                                          INC	word [ES:BP+DPB.FREE_CNT] ; Increase free count by 1
 34379                                  NO_DEALLOC:
 34380                                          MOV     BX,AX
 34381                                          dec     ax              ; check for "1"
 34382                                  	jz	short RELEASE_flush	; is last cluster of incomplete chain
 34383                                  %else
 34384                                  	; 28/02/2024 - Retro DOS v5.0
 34385                                  	; (PCDOS 7.1 IBMDOS.COM)
 34386                                  	;;;
 34387 00005C1F 3B16[EA0A]              	cmp	dx,[CLUSDATA_HW]	; > 0 ? (delete, release)
 34388 00005C23 7519                    	jnz	short NO_DEALLOC	; no, EOF (allocate, -1), (dx = 0)
 34389                                  	;cmp	word [es:bp+1Fh],0FFFFh
 34390 00005C25 26837E1FFF              	cmp	word [es:bp+DPB.FREE_CNT],0FFFFh ; -1
 34391                                  					; Free count valid?
 34392 00005C2A 7412                    	jz	short NO_DEALLOC	; No (dx = 0)
 34393                                  relblks_ifc:
 34394                                  	;inc	word ptr es:[bp+1Fh]
 34395 00005C2C 26FF461F                	inc	word [ES:BP+DPB.FREE_CNT] ; Increase free count by 1
 34396 00005C30 7519                    	jnz	short NO_DEALLOC2
 34397                                  
 34398                                  	;cmp	[es:bp+0Fh],dx
 34399 00005C32 2639560F                	cmp	[es:bp+DPB.FAT_SIZE],dx
 34400 00005C36 7513                    	jnz	short NO_DEALLOC2	; not FAT32
 34401                                  
 34402                                  	;inc	word [es:bp+21h]
 34403 00005C38 26FF4621                	inc	word [es:bp+DPB.FREE_CNT+2]
 34404 00005C3C EB0D                    	jmp	short NO_DEALLOC2
 34405                                  NO_DEALLOC:
 34406                                  	;cmp	[es:bp+0Fh],dx
 34407 00005C3E 2639560F                	cmp	[es:bp+DPB.FAT_SIZE],dx	; dx is -1 or 0
 34408                                  					; (valid 16 bit fat size is another number)
 34409 00005C42 7507                    	jnz	short NO_DEALLOC2 ; FAT (FAT16 or FAT12)
 34410                                  					; dx = 0, FAT32
 34411                                  	;cmp	word [es:bp+21h],0FFFFh
 34412 00005C44 26837E21FF              	cmp	word [es:bp+DPB.FREE_CNT+2],0FFFFh
 34413 00005C49 75E1                    	jnz	short relblks_ifc
 34414                                  NO_DEALLOC2:
 34415 00005C4B 833E[E80A]00            	cmp	word [CLUSTNUM_HW],0
 34416 00005C50 7503                    	jnz	short NO_DEALLOC3
 34417 00005C52 48                      	dec	ax			; check for "1"	
 34418 00005C53 7405                    	jz	short RET12		; is last cluster of incomplete chain
 34419                                  NO_DEALLOC3:
 34420                                  	;;;
 34421                                  %endif
 34422                                  
 34423 00005C55 E88F06                  	call	IsEOF
 34424 00005C58 72A3                            JB	short RELEASE	; Carry clear if JMP not taken
 34425                                  
 34426                                  	; 16/12/2022
 34427                                  ; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 34428                                  ; 28/02/2024 (PCDOS 7.1 IBMDOS.COM)
 34429                                  %if 0
 34430                                  RELEASE_flush:
 34431                                  	; MSDOS 6.0
 34432                                  	mov	al,[es:bp]
 34433                                  	;MOV	AL,[ES:BP+DPB.DRIVE]
 34434                                  	push	si		; FLUSHBUF may trash these and we guarantee
 34435                                  	push	cx		;  them to be preserved.
 34436                                  	push	es
 34437                                  	push	bp
 34438                                  	call	FLUSHBUF	; commit buffers for this drive
 34439                                  	pop	bp
 34440                                  	pop	es
 34441                                  	pop	cx
 34442                                  	pop	si
 34443                                  %endif		; 28/02/2024
 34444                                  
 34445                                  RET12:
 34446 00005C5A C3                      	retn
 34447                                  
 34448                                  ;Break	<GETEOF -- Find the end of a file>
 34449                                  ;------------------------------------------------------------------------
 34450                                  ;
 34451                                  ; Procedure Name : GETEOF
 34452                                  ;
 34453                                  ; Inputs:
 34454                                  ;       ES:BP Points to DPB
 34455                                  ;       BX = Cluster in a file
 34456                                  ;       DS = CS
 34457                                  ; Outputs:
 34458                                  ;       BX = Last cluster in the file
 34459                                  ;       Carry set if error (currently user FAILed to I 24)
 34460                                  ; DI destroyed. No other registers affected.
 34461                                  ;
 34462                                  ;--------------------------------------------------------------------------
 34463                                  
 34464                                  	; 28/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 34465                                  %if 0
 34466                                  GETEOF:
 34467                                  	call	UNPACK
 34468                                          jc	short RET12
 34469                                          PUSH    BX
 34470                                          MOV     BX,DI
 34471                                  	call	IsEOF
 34472                                          POP     BX
 34473                                          JAE     short RET12
 34474                                          MOV     BX,DI
 34475                                          JMP     short GETEOF
 34476                                  %else
 34477                                  	; 28/02/2024 - Retro DOS v5.0
 34478                                  	;;;
 34479                                  GETEOF4:	; **
 34480 00005C5B 8F06[E80A]              	pop	word [CLUSTNUM_HW] ; * ; 28/02/2024
 34481                                  GETEOF1:
 34482 00005C5F 89C7                    	mov	di,ax
 34483 00005C61 8916[F20A]              	mov	[CLUSTERS_HW],dx ; CLUSTERS_HW:DI = Cluster Count
 34484 00005C65 58                      	pop	ax
 34485 00005C66 5A                      	pop	dx
 34486 00005C67 C3                      	retn
 34487                                  
 34488                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9D7Ch
 34489                                  GETEOF:
 34490 00005C68 52                      	push	dx
 34491 00005C69 50                      	push	ax
 34492 00005C6A 31D2                    	xor	dx,dx ; 0	; cluster count = 0
 34493 00005C6C 31C0                    	xor	ax,ax ; 0
 34494                                  GETEOF2:
 34495 00005C6E E89F06                  	call	UNPACK
 34496 00005C71 72EC                    	jc	short GETEOF1
 34497                                  		; CCONTENT_HW:DI = next cluster (cluster content)
 34498 00005C73 40                      	inc	ax
 34499 00005C74 7501                    	jnz	short GETEOF3
 34500 00005C76 42                      	inc	dx
 34501                                  GETEOF3:
 34502 00005C77 FF36[E80A]              	push	word [CLUSTNUM_HW] ; * ; 28/02/2024
 34503 00005C7B 53                      	push    bx
 34504                                  	;push	word [CLUSTNUM_HW]
 34505 00005C7C 8B1E[EC0A]              	mov	bx,[CCONTENT_HW]
 34506 00005C80 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 34507 00005C84 89FB                    	mov	bx,di
 34508 00005C86 E85E06                  	call	IsEOF
 34509                                  	;pop	word [CLUSTNUM_HW] ; * ; 28/02/2024
 34510 00005C89 5B                      	pop	bx
 34511                                  	;jae	short GETEOF1   ; EOF
 34512 00005C8A 73CF                    	jae	short GETEOF4 ; ** ; 28/02/2024
 34513                                  	;mov	bx,[CCONTENT_HW] ; not EOF
 34514                                  	;mov	[CLUSTNUM_HW],bx
 34515 00005C8C 5B                      	pop	bx	; * ; 28/02/2024
 34516 00005C8D 89FB                    	mov	bx,di
 34517 00005C8F EBDD                    	jmp	short GETEOF2   ; get next cluster
 34518                                  	;;;
 34519                                  %endif
 34520                                  
 34521                                  ;============================================================================
 34522                                  ; FCB.ASM, MSDOS 6.0, 1991
 34523                                  ;============================================================================
 34524                                  ; 30/07/2018 - Retro DOS v3.0
 34525                                  ; 20/05/2019 - Retro DOS v4.0
 34526                                  ; 29/02/2024 - Retro DOS v5.0
 34527                                  
 34528                                  ;	TITLE	FCB - FCB parse calls for MSDOS
 34529                                  ;	NAME	FCB
 34530                                  
 34531                                  ;**	FCB.ASM - Low level routines for parsing names into FCBs and analyzing
 34532                                  ;		  filename characters
 34533                                  ;
 34534                                  ;	MakeFcb
 34535                                  ;	NameTrans
 34536                                  ;	PATHCHRCMP
 34537                                  ;	GetLet
 34538                                  ;	UCase
 34539                                  ;	GetLet3
 34540                                  ;	GetCharType
 34541                                  ;	TESTKANJ
 34542                                  ;	NORMSCAN
 34543                                  ;	DELIM
 34544                                  ;
 34545                                  ;	Revision history:
 34546                                  ;
 34547                                  ;		A000  version 4.00  Jan. 1988
 34548                                  ;	
 34549                                  ;	M048 - access FILE_UCASE_TAB using DS rather than SS.
 34550                                  
 34551                                  TableLook	EQU	-1
 34552                                  
 34553                                  SCANSEPARATOR	EQU	1
 34554                                  DRVBIT		EQU	2
 34555                                  NAMBIT		EQU	4
 34556                                  EXTBIT		EQU	8
 34557                                  
 34558                                  ;----------------------------------------------------------------------------
 34559                                  ;
 34560                                  ; Procedure : MakeFcb
 34561                                  ;
 34562                                  ;----------------------------------------------------------------------------
 34563                                  
 34564                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 34565                                  	; DOSCODE:8E77h (MSDOS 5.0, MSDOS.SYS)
 34566                                  
 34567                                  	; 29/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 34568                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9DB0h
 34569                                  
 34570                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8ED3h)
 34571                                  	; (Windows ME IO.SYS - BIOSCODE:8D92h)
 34572                                  
 34573                                  MAKEFCB:
 34574                                  ;hkn; SS override
 34575                                  	;MOV	BYTE [SS:SpaceFlag],0
 34576 00005C91 30D2                    	XOR	DL,DL		; Flag--not ambiguous file name
 34577                                  	; 29/02/2024
 34578 00005C93 368816[4E03]            	mov	[ss:SpaceFlag],dl ; 0
 34579                                  	;test	al,2
 34580 00005C98 A802                    	test	AL,DRVBIT	; Use current drive field if default?
 34581 00005C9A 7503                    	JNZ	short DEFDRV
 34582                                  	;MOV	BYTE [ES:DI],0	; No - use default drive
 34583                                  	; 29/02/2024
 34584 00005C9C 268815                  	mov	[es:di],dl ; 0
 34585                                  DEFDRV:
 34586 00005C9F 47                      	INC	DI
 34587 00005CA0 B90800                  	MOV	CX,8
 34588                                  	;test	al,4
 34589 00005CA3 A804                    	test	AL,NAMBIT	; Use current name fields as default?
 34590 00005CA5 93                      	XCHG	AX,BX		; Save bits in BX
 34591 00005CA6 B020                    	MOV	AL," "
 34592 00005CA8 7404                    	JZ	short FILLB	; If not, go fill with blanks
 34593 00005CAA 01CF                    	ADD	DI,CX
 34594 00005CAC 31C9                    	XOR	CX,CX		; Don't fill any
 34595                                  FILLB:
 34596 00005CAE F3AA                    	REP	STOSB
 34597 00005CB0 B103                    	MOV	CL,3
 34598 00005CB2 F6C308                  	test	BL,EXTBIT	; Use current extension as default
 34599 00005CB5 7404                    	JZ	short FILLB2
 34600 00005CB7 01CF                    	ADD	DI,CX
 34601 00005CB9 31C9                    	XOR	CX,CX
 34602                                  FILLB2:
 34603 00005CBB F3AA                    	REP	STOSB
 34604 00005CBD 91                      	XCHG	AX,CX		; Put zero in AX
 34605 00005CBE AB                      	STOSW
 34606 00005CBF AB                      	STOSW			; Initialize two words after to zero
 34607 00005CC0 83EF10                  	SUB	DI,16		; Point back at start
 34608                                  	;test	bl,1
 34609 00005CC3 F6C301                  	test	BL,SCANSEPARATOR; Scan off separators if not zero
 34610 00005CC6 7409                    	JZ	short SKPSPC
 34611 00005CC8 E88800                  	CALL	SCANB		; Peel off blanks and tabs
 34612 00005CCB E81E01                  	CALL	DELIM		; Is it a one-time-only delimiter?
 34613 00005CCE 7504                    	JNZ	short NOSCAN
 34614 00005CD0 46                      	INC	SI		; Skip over the delimiter
 34615                                  SKPSPC:
 34616 00005CD1 E87F00                  	CALL	SCANB		; Always kill preceding blanks and tabs
 34617                                  NOSCAN:
 34618 00005CD4 E8EC00                  	CALL	GETLET
 34619 00005CD7 761E                    	JBE	short NODRV	; Quit if termination character
 34620 00005CD9 803C3A                  	CMP	BYTE [SI],":"	; Check for potential drive specifier
 34621 00005CDC 7519                    	JNZ	short NODRV
 34622 00005CDE 46                      	INC	SI		; Skip over colon
 34623 00005CDF 2C40                    	SUB	AL,"@"          ; Convert drive letter to drive number (A=1)
 34624 00005CE1 760F                    	JBE	short BADDRV	; Drive letter out of range
 34625                                  
 34626 00005CE3 50                      	PUSH	AX
 34627 00005CE4 E8BA1E                  	call	GetVisDrv
 34628 00005CE7 58                      	POP	AX
 34629 00005CE8 730A                    	JNC	short HAVDRV
 34630                                  
 34631                                  	; 20/05/2019 - Retro DOS v4.0
 34632                                  	; MSDOS 6.0
 34633                                  ;hkn; SS override
 34634 00005CEA 36803E[1006]1A          	CMP	byte [SS:DrvErr],error_not_DOS_disk ; 1Ah
 34635                                  					; if not FAT drive ;AN000;
 34636 00005CF0 7402                    	JZ	short HAVDRV		; assume ok	   ;AN000;
 34637                                  BADDRV:
 34638 00005CF2 B2FF                    	MOV	DL,-1
 34639                                  HAVDRV:
 34640 00005CF4 AA                      	STOSB			; Put drive specifier in first byte
 34641 00005CF5 46                      	INC	SI
 34642 00005CF6 4F                      	DEC	DI		; Counteract next two instructions
 34643                                  NODRV:
 34644 00005CF7 4E                      	DEC	SI		; Back up
 34645 00005CF8 47                      	INC	DI		; Skip drive byte
 34646                                  
 34647                                  	;entry	NORMSCAN
 34648                                  NORMSCAN:
 34649 00005CF9 B90800                  	MOV	CX,8
 34650 00005CFC E82200                  	CALL	GETWORD 	; Get 8-letter file name
 34651 00005CFF 803C2E                  	CMP	BYTE [SI],"."
 34652 00005D02 7510                    	JNZ	short NODOT
 34653 00005D04 46                      	INC	SI		; Skip over dot if present
 34654                                  
 34655                                  	; 24/09/2023
 34656                                  	;mov	cx,3
 34657 00005D05 B103                    	mov	cl,3	; ch=0
 34658                                  
 34659                                  	; MSDOS 6.0
 34660                                  ;hkn; SS override
 34661                                  	;TEST	word [SS:DOS34_FLAG],DBCS_VOLID2 ; 100h ;AN000;
 34662                                  	; 10/06/2019
 34663 00005D07 36F606[1206]01          	test	byte [SS:DOS34_FLAG+1],(DBCS_VOLID2>>8) ; 1
 34664 00005D0D 7402                    	JZ	short VOLOK				;AN000;
 34665 00005D0F A4                      	MOVSB			; 2nd byte of DBCS	;AN000;
 34666                                  	; 24/09/2023
 34667                                  	;MOV	CX,2					;AN000;
 34668 00005D10 49                      	dec	cx  ; cx=2
 34669                                  	;JMP	SHORT contvol				;AN000;
 34670                                  VOLOK:
 34671                                  	;MOV	CX,3		; Get 3-letter extension
 34672                                  contvol:
 34673 00005D11 E81300                  	CALL	MUSTGETWORD
 34674                                  NODOT:
 34675 00005D14 88D0                    	MOV	AL,DL
 34676                                  
 34677                                  	; MSDOS 6.0
 34678                                  	;and	word [ss:DOS34_FLAG],0FEFFh
 34679                                  	; 18/12/2022
 34680 00005D16 368026[1206]FE          	and	byte [ss:DOS34_FLAG+1],0FEh ; (~DBCS_VOLID2)>>8
 34681                                  	;and	word [ss:DOS34_FLAG],~DBCS_VOLID2 ; ### BUG FIX ###
 34682                                  
 34683 00005D1C C3                      	retn
 34684                                  
 34685                                  NONAM:
 34686 00005D1D 01CF                    	ADD	DI,CX
 34687 00005D1F 4E                      	DEC	SI
 34688 00005D20 C3                      	retn
 34689                                  
 34690                                  GETWORD:
 34691 00005D21 E89F00                  	CALL	GETLET		
 34692 00005D24 76F7                    	JBE	short NONAM	; Exit if invalid character
 34693 00005D26 4E                      	DEC	SI
 34694                                  
 34695                                  ;	UGH!!! Horrible bug here that should be fixed at some point:
 34696                                  ;	If the name we are scanning is longer than CX, we keep on reading!
 34697                                  
 34698                                  MUSTGETWORD:
 34699 00005D27 E89900                  	CALL	GETLET
 34700                                  
 34701                                  ;	If spaceFlag is set then we allow spaces in a pathname
 34702                                  
 34703                                  ;IF NOT TABLELOOK
 34704                                  ;	JB	short FILLNAM  ; MSDOS 3.3
 34705                                  ;ENDIF
 34706 00005D2A 750C                    	JNZ	short MustCheckCX
 34707                                  
 34708                                  ;hkn; SS override
 34709 00005D2C 36F606[4E03]FF          	test	BYTE [SS:SpaceFlag],0FFh
 34710 00005D32 7419                    	JZ	short FILLNAM
 34711 00005D34 3C20                    	CMP	AL," "
 34712 00005D36 7515                    	JNZ	short FILLNAM
 34713                                  
 34714                                  MustCheckCX:
 34715 00005D38 E3ED                    	JCXZ	MUSTGETWORD
 34716 00005D3A 49                      	DEC	CX
 34717 00005D3B 3C2A                    	CMP	AL,"*"          ; Check for ambiguous file specifier
 34718 00005D3D 7504                    	JNZ	short NOSTAR
 34719 00005D3F B03F                    	MOV	AL,"?"
 34720 00005D41 F3AA                    	REP	STOSB
 34721                                  NOSTAR:
 34722 00005D43 AA                      	STOSB
 34723 00005D44 3C3F                    	CMP	AL,"?"
 34724 00005D46 75DF                    	JNZ	short MUSTGETWORD
 34725 00005D48 80CA01                  	OR	DL,1		; Flag ambiguous file name
 34726 00005D4B EBDA                    	JMP	short MUSTGETWORD
 34727                                  FILLNAM:
 34728 00005D4D B020                    	MOV	AL," "
 34729 00005D4F F3AA                    	REP	STOSB
 34730 00005D51 4E                      	DEC	SI
 34731 00005D52 C3                      	retn
 34732                                  
 34733                                  SCANB:
 34734 00005D53 AC                      	LODSB
 34735 00005D54 E89D00                  	CALL	SPCHK
 34736 00005D57 74FA                    	JZ	short SCANB
 34737 00005D59 4E                      	DEC	SI
 34738                                  scanb_retn:
 34739 00005D5A C3                      	retn
 34740                                  
 34741                                  ;----------------------------------------------------------------------------
 34742                                  ;
 34743                                  ; Procedure Name : NameTrans
 34744                                  ;
 34745                                  ; NameTrans is used by FindPath to scan off an element of a path. We must
 34746                                  ; allow spaces in pathnames
 34747                                  ;
 34748                                  ;   Inputs:	DS:SI points to start of path element
 34749                                  ;   Outputs:	Name1 has unpacked name, uppercased
 34750                                  ;		ES = DOSGroup
 34751                                  ;		DS:SI advanced after name
 34752                                  ;   Registers modified: DI,AX,DX,CX
 34753                                  ;
 34754                                  ;----------------------------------------------------------------------------
 34755                                  
 34756                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 34757                                  	; 20/05/2019 - Retro DOS v4.0
 34758                                  
 34759                                  	; 29/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 34760                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9E7Ch
 34761                                  
 34762                                  NameTrans:
 34763                                  ;hkn; SS override
 34764 00005D5B 36C606[4E03]01          	MOV	BYTE [SS:SpaceFlag],1
 34765 00005D61 16                      	push	ss
 34766 00005D62 07                      	pop	es
 34767                                  
 34768                                  ;hkn; NAME1 is in DOSDATA
 34769 00005D63 BF[4B05]                	MOV	DI,NAME1
 34770 00005D66 57                      	PUSH	DI
 34771                                  
 34772                                  ; 29/02/2024
 34773                                  %if 0
 34774                                  	MOV	AX,'  '	; 2020h
 34775                                  	MOV	CX,5
 34776                                  	STOSB
 34777                                  	REP	STOSW		; Fill "FCB" at NAME1 with spaces
 34778                                  	XOR	AL,AL		; Set stuff for NORMSCAN
 34779                                  	MOV	DL,AL
 34780                                  %else
 34781                                  	; 29/02/2024
 34782                                  	; (PCDOS 7.1 IBMDOS.COM)
 34783                                  	;;;
 34784 00005D67 B020                    	mov     al, 20h ; ' '
 34785 00005D69 B90B00                  	mov     cx, 11
 34786 00005D6C F3AA                    	rep stosb               ; Fill "FCB" at NAME1 with spaces
 34787 00005D6E 91                      	xchg    ax, cx
 34788 00005D6F 99                      	cwd
 34789                                  	;;;
 34790                                  %endif
 34791                                  
 34792 00005D70 AA                      	STOSB
 34793 00005D71 5F                      	POP	DI
 34794                                  
 34795 00005D72 E884FF                  	CALL	NORMSCAN
 34796                                  
 34797                                  ;hkn; SS override for NAME1
 34798 00005D75 36803E[4B05]E5          	CMP	byte [SS:NAME1],0E5H
 34799 00005D7B 75DD                    	jnz	short scanb_retn
 34800 00005D7D 36C606[4B05]05          	MOV	byte [SS:NAME1],5 ; Magic name translation
 34801 00005D83 C3                      	retn
 34802                                  
 34803                                  ;Break	<GETLET, DELIM -- CHECK CHARACTERS AND CONVERT>
 34804                                  ;============================================================================
 34805                                  
 34806                                  ; 20/05/2019 - Retro DOS v4.0
 34807                                  ; DOSCODE:8FD2h (MSDOS 6.21, MSDOS.SYS)
 34808                                  
 34809                                  ;If TableLook
 34810                                  
 34811                                  ;hkn; Table	SEGMENT
 34812                                  ;	PUBLIC	CharType
 34813                                  ;----------------------------------------------------------------------------
 34814                                  
 34815                                  ; Character type table for file name scanning
 34816                                  ; Table provides a mapping of characters to validity bits.
 34817                                  ; Four bits are provided for each character. Values 7Dh and above
 34818                                  ; have all bits set, so that part of the table is chopped off, and
 34819                                  ; the translation routine is responsible for screening these values.
 34820                                  ; The bit values are defined in DOSSYM.INC
 34821                                  
 34822                                  ;	      ; ^A and NUL
 34823                                  ;CharType:
 34824                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34825                                  ;	      ; ^C and ^B
 34826                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34827                                  ;	      ; ^E and ^D
 34828                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34829                                  ;	      ; ^G and ^F
 34830                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34831                                  ;	      ; TAB and BS
 34832                                  ;	 db   LOW ((NOT FFCB+FCHK+FDELIM+FSPCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34833                                  ;	      ; ^K and ^J
 34834                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34835                                  ;	      ; ^M and ^L
 34836                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34837                                  ;	      ; ^O and ^N
 34838                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34839                                  ;	      ; ^Q and ^P
 34840                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34841                                  ;	      ; ^S and ^R
 34842                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34843                                  ;	      ; ^U and ^T
 34844                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34845                                  ;	      ; ^W and ^V
 34846                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34847                                  ;	      ; ^Y and ^X
 34848                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34849                                  ;	      ; ESC and ^Z
 34850                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34851                                  ;	      ; ^] and ^;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34853                                  ;	      ; ^_ and ^^
 34854                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34855                                  ;	      ; ! and SPACE
 34856                                  ;	 db   LOW (NOT FCHK+FDELIM+FSPCHK)
 34857                                  ;	      ; # and "
 34858                                  ;	 db   LOW (NOT FFCB+FCHK)
 34859                                  ;	      ; $ - )
 34860                                  ;	 db   3 dup (0FFh)
 34861                                  ;	      ; + and *
 34862                                  ;	 db   LOW ((NOT FFCB+FCHK+FDELIM) SHL 4) OR 0Fh
 34863                                  ;	      ; - and '
 34864                                  ;	 db   NOT (FFCB+FCHK+FDELIM)
 34865                                  ;	      ; / and .
 34866                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FCHK) AND 0Fh
 34867                                  ;	      ; 0 - 9
 34868                                  ;	 db   5 dup (0FFh)
 34869                                  ;	      ; ; and :
 34870                                  ;	 db   LOW ((NOT FFCB+FCHK+FDELIM) SHL 4) OR LOW (NOT FFCB+FCHK+FDELIM) AND 0Fh
 34871                                  ;	      ; = and <
 34872                                  ;	 db   LOW ((NOT FFCB+FCHK+FDELIM) SHL 4) OR LOW (NOT FFCB+FCHK+FDELIM) AND 0Fh
 34873                                  ;	      ; ? and >
 34874                                  ;	 db   NOT FFCB+FCHK+FDELIM
 34875                                  ;	      ; A - Z
 34876                                  ;	 db   13 dup (0FFh)
 34877                                  ;	      ; \ and [
 34878                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR 0Fh
 34879                                  ;	      ; ^ and ]
 34880                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34881                                  ;	      ; _ - {
 34882                                  ;	 db   15 dup (0FFh)
 34883                                  ;	      ; } and |
 34884                                  ;	 db   NOT FFCB+FCHK+FDELIM
 34885                                  
 34886                                  ;CharType_last equ ($ - CharType) * 2	; This is the value of the last
 34887                                  ;					; character in the table
 34888                                  
 34889                                  ;FCHK	equ 1		; normal name char, no chks needed
 34890                                  ;FDELIM	equ 2		; is a delimiter
 34891                                  ;FSPCHK	equ 4		; set if character is not a space or equivalent
 34892                                  ;FFCB	equ 8		; is valid in an FCB
 34893                                  
 34894                                  ; DOSCODE:8FD2h (MSDOS 6.21, MSDOS.SYS)
 34895                                  ;----------------------------------------------------------------------------
 34896                                  ; DOSCODE:8F76h (MSDOS 5.0, MSDOS.SYS)
 34897                                  
 34898                                  CharType: ; 63 bytes
 34899 00005D84 6666666606666666                db  66h, 66h, 66h, 66h, 06h, 66h, 66h, 66h ; 0-7
 34900 00005D8C 6666666666666666        	db  66h, 66h, 66h, 66h, 66h, 66h, 66h, 66h ; 8-15
 34901 00005D94 F8F6FFFFFF4FF46E        	db 0F8h,0F6h,0FFh,0FFh,0FFh, 4Fh,0F4h, 6Eh ; 16-23
 34902 00005D9C FFFFFFFFFF4444F4        	db 0FFh,0FFh,0FFh,0FFh,0FFh, 44h, 44h,0F4h ; 24-31
 34903 00005DA4 FFFFFFFFFFFFFFFF        	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh ; 32-39
 34904 00005DAC FFFFFFFFFF6F66FF        	db 0FFh,0FFh,0FFh,0FFh,0FFh, 6Fh, 66h,0FFh ; 40-47
 34905 00005DB4 FFFFFFFFFFFFFFFF        	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh ; 48-55
 34906 00005DBC FFFFFFFFFFFFF4          	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0F4h	   ; 56-62
 34907                                  
 34908                                  CharType_last equ ($ - CharType) * 2
 34909                                  
 34910                                  ; Offset 12CAh of IBMDOS.COM (MSDOS 3.3), 1987
 34911                                  ;----------------------------------------------------------------------------
 34912                                  ;CharType:
 34913                                  ;       db 0F6h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h
 34914                                  ;	db 0F6h,0F0h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h
 34915                                  ;	db 0F6h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h
 34916                                  ;	db 0F6h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h
 34917                                  ;	db 0F8h,0FFh,0F6h,0FFh,0FFh,0FFh,0FFh,0FFh
 34918                                  ;	db 0FFh,0FFh,0FFh,0F4h,0F4h,0FFh,0FEh,0F6h
 34919                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34920                                  ;	db 0FFh,0FFh,0F4h,0F4h,0F4h,0F4h,0F4h,0FFh
 34921                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34922                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34923                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34924                                  ;	db 0FFh,0FFh,0FFh,0F6h,0F6h,0F6h,0FFh,0FFh
 34925                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34926                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34927                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34928                                  ;	db 0FFh,0FFh,0FFh,0FFh,0F4h,0FFh,0FFh,0FFh
 34929                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34930                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34931                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34932                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34933                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34934                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34935                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34936                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34937                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34938                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34939                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34940                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34941                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34942                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34943                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34944                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34945                                  
 34946                                  ;hkn; Table	ENDS
 34947                                  
 34948                                  ;ENDIF
 34949                                  
 34950                                  ; 20/05/2019 - Retro DOS v4.0
 34951                                  ; DOSCODE:9011h (MSDOS 6.21, MSDOS.SYS)
 34952                                  
 34953                                  ; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 34954                                  ; DOSCODE:8FB5h (MSDOS 5.0, MSDOS.SYS)
 34955                                  
 34956                                  ;----------------------------------------------------------------------------
 34957                                  ;
 34958                                  ; Procedure Names : GetLet, UCase, GetLet3
 34959                                  ;
 34960                                  ; These routines take a character, convert it to upper case, and check
 34961                                  ; for delimiters.  Three different entry points:
 34962                                  ;	GetLet -  DS:[SI] = character to convert
 34963                                  ;	UCase  -  AL = character to convert
 34964                                  ;	GetLet3 - AL = character
 34965                                  ;		  [BX] = translation table to use
 34966                                  ;
 34967                                  ;	Exit (in all cases) : AL = upper case character
 34968                                  ;			      CY set if char is control char other than TAB
 34969                                  ;			      ZF set if char is a delimiter
 34970                                  ;	Uses : AX, flags
 34971                                  ;
 34972                                  ; NOTE: This routine exists in a fast table lookup version, and a slow
 34973                                  ; inline version.  Return with carry set is only possible in the inline
 34974                                  ; version. The table lookup version is the one in use.
 34975                                  ;
 34976                                  ;----------------------------------------------------------------------------
 34977                                  
 34978                                  ; This entry point has character at [SI]
 34979                                  
 34980                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5517h
 34981                                  GETLET:	
 34982 00005DC3 AC                      	LODSB
 34983                                  
 34984                                  ; This entry point has character in AL
 34985                                  
 34986                                  	;entry	UCase
 34987                                  UCase:	
 34988                                  	; 09/08/2018
 34989                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5518h
 34990                                  _UCase:
 34991 00005DC4 53                      	PUSH	BX
 34992 00005DC5 BB[7E0B]                	MOV	BX,FILE_UCASE_TAB+2
 34993                                  
 34994                                  ; Convert the character in AL to upper case
 34995                                  
 34996                                  gl_0:
 34997 00005DC8 3C61                    	CMP	AL,"a"
 34998 00005DCA 7214                    	JB	short gl_2	; Already upper case, go check type
 34999 00005DCC 3C7A                    	CMP	AL,"z"
 35000 00005DCE 7702                    	JA	short gl_1
 35001 00005DD0 2C20                    	SUB	AL,20H		; Convert to upper case
 35002                                  
 35003                                  ; Map European character to upper case
 35004                                  
 35005                                  gl_1:
 35006 00005DD2 3C80                    	CMP	AL,80H
 35007 00005DD4 720A                    	JB	short gl_2	; Not EuroChar, go check type
 35008 00005DD6 2C80                    	SUB	AL,80H		; translate to upper case with this index
 35009                                  
 35010                                  	; M048 - Start 
 35011                                  	; Lantastic call Ucase thru int 2f without setting SS to DOSDATA.
 35012                                  	; So we shall set up DS and to access FILE_UCASE_TAB in BX and also 
 35013                                  	; preserve it.
 35014                                  
 35015                                  	; 09/08/2018 - Retro DOS v3.0
 35016                                  	; MSDOS 3.3
 35017                                  	;;XLAT	BYTE [CS:BX]	; ds as file_ucase_tab is in DOSDATA
 35018                                  	;CS	XLAT
 35019                                  
 35020                                  	; 20/05/2019 - Retro DOS v4.0
 35021                                  
 35022                                  	; MSDOS 6.0
 35023 00005DD8 1E                      	push	ds
 35024                                  	;getdseg <ds>
 35025 00005DD9 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 35026 00005DDE D7                      	XLAT			; ds as file_ucase_tab is in DOSDATA
 35027 00005DDF 1F                      	pop	ds
 35028                                  
 35029                                  	; M048 - End
 35030                                  
 35031                                  ; Now check the type
 35032                                  
 35033                                  ;If TableLook
 35034                                  gl_2:
 35035                                  	; 20/05/2019 - Retro DOS v4.0
 35036 00005DE0 50                      	PUSH	AX
 35037                                  
 35038                                  	; MSDOS 3.3
 35039                                  	;mov	bx,CharType
 35040                                  	;; 09/08/2018
 35041                                  	;;xlat	byte [cs:bx]
 35042                                  	;cs	xlat	
 35043                                  	
 35044                                  	; MSDOS 6.0
 35045 00005DE1 E81800                  	CALL	GetCharType	; returns type flags in AL
 35046                                  	
 35047                                  	;test	al,1	
 35048 00005DE4 A801                    	TEST	AL,FCHK 	; test for normal character
 35049 00005DE6 58                      	POP	AX
 35050                                  
 35051 00005DE7 5B                      	POP	BX
 35052 00005DE8 C3                      	RETN
 35053                                  
 35054                                  ; This entry has character in AL and lookup table in BX
 35055                                  
 35056                                  	; MSDOS 6.0
 35057                                  ;	;entry GetLet3
 35058                                  GETLET3: ; 10/08/2018
 35059 00005DE9 53                      	PUSH	BX
 35060 00005DEA EBDC                    	JMP	short gl_0
 35061                                  ;ELSE
 35062                                  ;
 35063                                  ;gl_2:
 35064                                  ;	POP	BX
 35065                                  ;	CMP	AL,"."
 35066                                  ;	retz
 35067                                  ;	CMP	AL,'"'
 35068                                  ;	retz
 35069                                  ;	CALL	PATHCHRCMP
 35070                                  ;	retz
 35071                                  ;	CMP	AL,"["
 35072                                  ;	retz
 35073                                  ;	CMP	AL,"]"
 35074                                  ;	retz
 35075                                  ;ENDIF
 35076                                  
 35077                                  ;---------------------------------------------------------------------
 35078                                  ;
 35079                                  ; DELIM - check if character is a delimiter
 35080                                  ;	Entry : AX = character to check
 35081                                  ;	Exit  : ZF set if character is not a delimiter
 35082                                  ;	Uses  : Flags
 35083                                  ;
 35084                                  ;--------------------------------------------------------------------
 35085                                  
 35086                                  	;entry	DELIM
 35087                                  DELIM:
 35088                                  ;IF TableLook
 35089                                  	; 20/05/2019 - Retro DOS v4.0
 35090 00005DEC 50                      	PUSH	AX
 35091                                  
 35092                                  	; MSDOS 3.3
 35093                                  	;push	bx
 35094                                  	;mov	bx,CharType
 35095                                  	;;09/08/2018
 35096                                  	;;xlat	byte [cs:bx]
 35097                                  	;cs	xlat
 35098                                  	;pop	bx
 35099                                  
 35100                                  	; MSDOS 6.0
 35101 00005DED E80C00                  	CALL	GetCharType
 35102                                  	
 35103                                  	;test	al,2
 35104 00005DF0 A802                    	TEST	AL,FDELIM
 35105 00005DF2 58                      	POP	AX
 35106 00005DF3 C3                      	RETN
 35107                                  ;ELSE
 35108                                  ;	CMP	AL,":"
 35109                                  ;	retz
 35110                                  ;
 35111                                  ;	CMP	AL,"<"
 35112                                  ;	retz
 35113                                  ;	CMP	AL,"|"
 35114                                  ;	retz
 35115                                  ;	CMP	AL,">"
 35116                                  ;	retz
 35117                                  ;
 35118                                  ;	CMP	AL,"+"
 35119                                  ;	retz
 35120                                  ;	CMP	AL,"="
 35121                                  ;	retz
 35122                                  ;	CMP	AL,";"
 35123                                  ;	retz
 35124                                  ;	CMP	AL,","
 35125                                  ;	retz
 35126                                  ;ENDIF
 35127                                  
 35128                                  ;-------------------------------------------------------------------------
 35129                                  ;
 35130                                  ;  SPCHK - checks to see if a character is a space or equivalent
 35131                                  ;	Entry : AL = character to check
 35132                                  ;	Exit  : ZF set if character is a space
 35133                                  ;	Uses  : flags
 35134                                  ;
 35135                                  ;-------------------------------------------------------------------------
 35136                                  
 35137                                  	;entry SPCHK
 35138                                  SPCHK:
 35139                                  ;IF TableLook
 35140                                  	; 20/05/2019 - Retro DOS v4.0
 35141 00005DF4 50                      	PUSH	AX
 35142                                  
 35143                                  	; MSDOS 3.3
 35144                                  	;push	bx
 35145                                  	;mov	bx,CharType
 35146                                  	;; 09/08/2018
 35147                                  	;;xlat	byte [cs:bx]
 35148                                  	;cs	xlat
 35149                                  	;pop	bx
 35150                                  
 35151                                  	; MSDOS 6.0
 35152 00005DF5 E80400                  	CALL	GetCharType
 35153                                  	
 35154                                  	;test	al,4
 35155 00005DF8 A804                    	TEST	AL,FSPCHK
 35156 00005DFA 58                      	POP	AX
 35157 00005DFB C3                      	RETN
 35158                                  ;ELSE
 35159                                  ;	CMP	AL,9		; Filter out tabs too
 35160                                  ;	retz
 35161                                  ;; WARNING! " " MUST be the last compare
 35162                                  ;	CMP	AL," "
 35163                                  ;	return
 35164                                  ;ENDIF
 35165                                  
 35166                                  ;-------------------------------------------------------------------------
 35167                                  ;
 35168                                  ;  GetCharType - return flag bits indicating character type
 35169                                  ;	Bits are defined in DOSSYM.INC. Uses lookup table
 35170                                  ;	defined above at label CharType.
 35171                                  ;
 35172                                  ;	Entry : AL = character to return type flags for
 35173                                  ;	Exit  : AL = type flags
 35174                                  ;	Uses  : AL, flags
 35175                                  ;
 35176                                  ;-------------------------------------------------------------------------
 35177                                  
 35178                                  	; 29/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 35179                                  
 35180                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 35181                                  
 35182                                  	; 20/05/2019 - Retro DOS v4.0
 35183                                  	; MSDOS 6.0
 35184                                  
 35185                                  GetCharType:
 35186                                  	;cmp	al,7Eh
 35187 00005DFC 3C7E                    	cmp	al,CharType_last 	; beyond end of table?
 35188 00005DFE 7314                    	jae	short gct_90		; return standard value
 35189                                  
 35190 00005E00 53                      	push	bx
 35191 00005E01 BB[845D]                	mov	bx,CharType		; load lookup table
 35192 00005E04 D0E8                    	shr	al,1			; adjust for half-byte table entry size
 35193                                  	;xlat	cs:[bx] 		; get flags
 35194 00005E06 2ED7                    	cs	xlat	
 35195 00005E08 5B                      	pop	bx
 35196                                  
 35197                                  ; carry clear from previous shift means we want the low nibble.  Otherwise
 35198                                  ; we have to shift the flags down to the low nibble
 35199                                  
 35200 00005E09 7306                    	jnc	short gct_80		; carry clear, no shift needed
 35201                                  
 35202                                  ; 29/02/2024
 35203                                  %if 0
 35204                                  	shr	al,1			; we want high nibble, shift it down
 35205                                  	shr	al,1
 35206                                  	shr	al,1
 35207                                  	shr	al,1
 35208                                  %else
 35209                                  	; 29/02/2024 (PCDOS 7.1 IBMDOS.COM)
 35210                                  	;;;
 35211 00005E0B 51                      	push	cx
 35212 00005E0C B104                    	mov	cl,4			; we want high nibble, shift it down
 35213 00005E0E D2E8                    	shr	al,cl
 35214 00005E10 59                      	pop	cx
 35215                                  	;;;
 35216                                  %endif
 35217                                  
 35218                                  gct_80:
 35219 00005E11 240F                    	and	al,0Fh			; clear the unused nibble
 35220 00005E13 C3                      	retn
 35221                                  gct_90:
 35222 00005E14 B00F                    	mov	al,0Fh			; set all flags
 35223 00005E16 C3                      	retn
 35224                                  
 35225                                  ;----------------------------------------------------------------------------
 35226                                  ;
 35227                                  ; Procedure : PATHCHRCMP
 35228                                  ;
 35229                                  ;----------------------------------------------------------------------------
 35230                                  
 35231                                  PATHCHRCMP:
 35232 00005E17 3C2F                    	CMP	AL,'/'
 35233 00005E19 7606                    	JBE	short PathRet
 35234 00005E1B 3C5C                    	CMP	AL,'\'
 35235 00005E1D C3                      	retn
 35236                                  GotFor:
 35237 00005E1E B05C                    	MOV	AL,'\'
 35238 00005E20 C3                      	retn
 35239                                  PathRet:
 35240 00005E21 74FB                    	JZ	short GotFor
 35241 00005E23 C3                      	retn
 35242                                  
 35243                                  ;============================================================================
 35244                                  ; MSCRTLC.ASM, MSDOS 6.0, 1991
 35245                                  ;============================================================================
 35246                                  ; 30/07/2018 - Retro DOS v3.0
 35247                                  ; 29/04/2019 - Retro DOS v4.0
 35248                                  ; 29/02/2024 - Retro DOS v5.0
 35249                                  
 35250                                  ; 15/03/2018 - Retro DOS v2.0 (MSDOS 2.11, CTRLC.ASM, 1983)
 35251                                  
 35252                                  ;**	MSCTRLC.ASM - ^C and error handler for MSDOS
 35253                                  
 35254                                  ;	TITLE	Control C detection, Hard error and EXIT routines
 35255                                  ;	NAME	IBMCTRLC
 35256                                  
 35257                                  ;**	Low level routines for detecting special characters on CON input,
 35258                                  ;	the ^C exit/int code, the Hard error INT 24 code, the
 35259                                  ;	process termination code, and the INT 0 divide overflow handler.
 35260                                  ;
 35261                                  ;	FATAL
 35262                                  ;	FATAL1
 35263                                  ;	reset_environment
 35264                                  ;	DSKSTATCHK
 35265                                  ;	SPOOLINT
 35266                                  ;	STATCHK
 35267                                  ;	CNTCHAND
 35268                                  ;	DIVOV
 35269                                  ;	CHARHARD
 35270                                  ;	HardErr
 35271                                  ;
 35272                                  ;	Revision history:
 35273                                  ;
 35274                                  ;	    AN000	version 4.0   Jan 1988
 35275                                  ;	    A002	PTM    -- dir >lpt3 hangs
 35276                                  ;	    A003	PTM 3957- fake version for IBMCAHE.COM
 35277                                  ;
 35278                                  ; 	M011: NEC's 8086 clone chip uses Intel's undocumented bit number in
 35279                                  ;	      flags register. In order to return to user normally DOS used to
 35280                                  ;	      move F202 into flags, which sets bit number 1 in flags uncondit-
 35281                                  ;	      ionally. Now it is modified to maintain the state of bit 1.
 35282                                  ;
 35283                                  ; 	M024: suppressed fail and ignore options if not in the middle of int 
 35284                                  ;	      24 and if Ctrl P or ctrl printscrn is pressed in routine 
 35285                                  ;	      charhard.
 35286                                  
 35287                                  ; 29/04/2019 - Retro DOS v4.0
 35288                                  	; MSDOS 6.0
 35289                                  ;		public	LowInt23Addr		
 35290                                  LowInt23Addr: ;	LABEL	DWORD
 35291 00005E24 [F60F]0000              	DW	LowInt23, 0
 35292                                  
 35293                                  ;		public	LowInt24Addr
 35294                                  LowInt24Addr: ;	LABEL	DWORD
 35295 00005E28 [0A10]0000              	DW	LowInt24, 0
 35296                                  
 35297                                  ;		public	LowInt28Addr
 35298                                  LowInt28Addr: ;	LABEL	DWORD
 35299 00005E2C [1E10]0000              	DW	LowInt28, 0
 35300                                  
 35301                                  ;Break	<Checks for ^C in CON I/O>
 35302                                  
 35303                                  ; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 35304                                  ; 05/05/2019 - Retro DOS v4.0
 35305                                  
 35306                                  ;---------------------------------------------------------------------------
 35307                                  ;
 35308                                  ; Procedure Name : DSKSTATCHK
 35309                                  ;
 35310                                  ; Check for ^C if only one level in
 35311                                  ;
 35312                                  ;---------------------------------------------------------------------------
 35313                                  
 35314                                          ;procedure DSKSTATCHK,NEAR ; Check for ^C if only one level in
 35315                                  
 35316                                  	; 29/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 35317                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9F51h
 35318                                  
 35319                                  DSKSTATCHK:        
 35320                                  	;CMP	BYTE [INDOS],1
 35321 00005E30 36803E[2103]01          	CMP	BYTE [SS:INDOS],1 ; 15/03/2018
 35322                                  	;retnz			; Do NOTHING
 35323                                  	; 16/12/2022
 35324 00005E36 7537                    	JNZ	SHORT _RET37 ; Retro DOS v2.0 - 04/03/2018
 35325                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 35326                                  	;jz	short _RET37 ; dskstatchk1
 35327                                  	;retn
 35328                                  ;_RET37:
 35329                                  ;dskstatchk1:
 35330 00005E38 51                      	PUSH    CX
 35331 00005E39 06                      	PUSH    ES
 35332 00005E3A 53                      	PUSH    BX
 35333 00005E3B 1E                      	PUSH    DS
 35334 00005E3C 56                      	PUSH    SI
 35335                                          
 35336                                  	;PUSH	CS
 35337                                  	;POP	ES
 35338                                  	;PUSH	CS
 35339                                  	;POP	DS
 35340                                  
 35341 00005E3D 8CD3                    	MOV	BX,SS		; SS is DOSDATA. ES:BX must be set up
 35342 00005E3F 8EC3                    	MOV	ES,BX		; for deviocall2
 35343 00005E41 8EDB                    	MOV	DS,BX
 35344                                  
 35345                                  	; 16/12/2022
 35346                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 35347                                  
 35348                                  	; 05/05/2019
 35349                                  	;MOV	BYTE [ss:DSKSTCOM],DEVRDND
 35350                                          ;MOV	BYTE [ss:DSKSTCALL],DRDNDHL
 35351                                  	;mov	word [ss:DSKSTST],0
 35352                                  
 35353                                  	; 16/12/2022
 35354                                  	; 25/06/2019
 35355 00005E43 C606[9403]05            	MOV	BYTE [DSKSTCOM],DEVRDND	 ; 5
 35356 00005E48 C606[9203]0E                    MOV	BYTE [DSKSTCALL],DRDNDHL ; 14
 35357 00005E4D C706[9503]0000          	mov	word [DSKSTST],0
 35358                                  
 35359 00005E53 BB[9203]                        MOV     BX,DSKSTCALL
 35360                                  
 35361                                  	;LDS	SI,[ss:BCON]
 35362                                          ; 25/062019
 35363 00005E56 C536[3200]              	lds	si,[BCON]
 35364                                  
 35365                                  ; 16/12/2022
 35366                                  ;	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 35367                                  ;	mov	byte [ss:DSKSTCOM],DEVRDND  ; 5
 35368                                  ;       mov	byte [ss:DSKSTCALL],DRDNDHL ; 14
 35369                                  ;	mov	word [ss:DSKSTST],0
 35370                                  ;	mov	bx,DSKSTCALL
 35371                                  ;	lds	si,[ss:BCON]
 35372                                  
 35373 00005E5A E85AF4                  	CALL	DEVIOCALL2
 35374                                  
 35375                                  	; 29/02/2024
 35376 00005E5D 1E                      	push	ds ; *
 35377 00005E5E 16                      	push	ss
 35378 00005E5F 1F                      	pop	ds
 35379                                  
 35380                                   	; 15/03/2018
 35381                                  	;;test	word [ss:DSKSTST],200h
 35382                                          ;TEST	WORD [SS:DSKSTST],STBUI
 35383                                  	; 05/05/2019
 35384                                  	;test	byte [ss:DSKSTST+1],(STBUI>>8) ; 2
 35385                                  	; 29/02/2024
 35386 00005E60 F606[9603]02            	test	byte [DSKSTST+1],(STBUI>>8) ; 2
 35387 00005E65 7409                    	jz	short _GotCh		; No characters available
 35388                                  
 35389 00005E67 30C0                    	XOR	AL,AL			; Set zero
 35390                                  RET36:
 35391                                  	; 29/02/2024
 35392 00005E69 5E                      	pop	si ; *
 35393                                  	;
 35394 00005E6A 5E                      	POP	SI
 35395 00005E6B 1F                      	POP	DS
 35396 00005E6C 5B                      	POP	BX
 35397 00005E6D 07                      	POP	ES
 35398 00005E6E 59                      	POP	CX
 35399                                  	; 16/12/2022
 35400                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 35401                                  _RET37:
 35402 00005E6F C3                      	RETN
 35403                                  
 35404                                  _GotCh:
 35405                                  
 35406                                  ; 29/02/2024
 35407                                  %if 0
 35408                                  	MOV	AL,[SS:DSKCHRET]	; SS override
 35409                                  
 35410                                  	CMP	AL,"C"-"@" ; cmp al,3
 35411                                  	JNZ	SHORT RET36
 35412                                  	MOV	BYTE [SS:DSKSTCOM],DEVRD
 35413                                  	MOV	BYTE [SS:DSKSTCALL],DRDWRHL
 35414                                  	MOV	[SS:DSKCHRET],CL
 35415                                  	; 09/09/2018
 35416                                  	MOV	word [SS:DSKSTST],0
 35417                                  	MOV	word [SS:DSKSTCNT],1
 35418                                  %else
 35419                                  	; 29/02/2024
 35420 00005E70 A0[9F03]                	mov	al,[DSKCHRET]
 35421                                  
 35422 00005E73 3C03                    	cmp	al,"C"-"@" ; cmp al,3
 35423 00005E75 75F2                    	jnz	short RET36
 35424                                  
 35425 00005E77 C606[9403]04            	mov	byte [DSKSTCOM],DEVRD
 35426 00005E7C C606[9203]16            	mov	byte [DSKSTCALL],DRDWRHL
 35427 00005E81 880E[9F03]              	mov	[DSKCHRET],cl
 35428 00005E85 C706[9503]0000          	mov	word [DSKSTST],0
 35429 00005E8B C706[A403]0100          	mov	word [DSKSTCNT],1
 35430 00005E91 1F                      	pop	ds ; *
 35431                                  %endif
 35432                                  	
 35433 00005E92 E822F4                  	CALL	DEVIOCALL2              ; Eat the ^C
 35434                                  
 35435 00005E95 5E                              POP     SI
 35436 00005E96 1F                              POP     DS
 35437 00005E97 5B                              POP     BX                      ; Clean stack
 35438 00005E98 07                              POP     ES
 35439 00005E99 59                              POP     CX
 35440 00005E9A E9CF00                          JMP	CNTCHAND ; 10/08/2018
 35441                                  
 35442                                  	; 05/05/2019
 35443                                  NOSTOP:
 35444                                  	; MSDOS 6.0
 35445 00005E9D 3C10                    	CMP	AL,"P"-"@"
 35446 00005E9F 7509                    	JNZ	short check_next
 35447                                  				    	; SS override
 35448 00005EA1 36803E[BC0D]00          	CMP	BYTE [SS:SCAN_FLAG],0	; ALT_Q ?
 35449 00005EA7 7405                    	JZ	short INCHKJ		; no
 35450                                  check_end:	; 24/09/2023
 35451 00005EA9 C3                      	retn
 35452                                  check_next:
 35453                                  	;IF	NOT TOGLPRN
 35454                                  	;CMP	AL,"N"-"@"
 35455                                  	;JZ	short INCHKJ
 35456                                  	;ENDIF
 35457                                  
 35458 00005EAA 3C03                    	CMP	AL,"C"-"@"
 35459                                  	; 24/09/2023
 35460                                  	;JZ	short INCHKJ
 35461                                  ;check_end:
 35462                                  	;retn
 35463 00005EAC 75FB                    	jnz	short check_end
 35464                                  
 35465                                  	; 24/09/2023
 35466                                  	; 08/09/2018
 35467                                  INCHKJ:	; 10/08/2018
 35468 00005EAE E9A500                  	jmp	INCHK
 35469                                  
 35470                                  	; MSDOS 3.3
 35471                                          ;CMP	AL,"P"-"@"  ; cmp al,16
 35472                                          ;JZ	short INCHKJ
 35473                                  
 35474                                  	; 15/04/2018
 35475                                          ;;IF	NOT TOGLPRN
 35476                                          ;CMP	AL,"N"-"@"
 35477                                          ;JZ	SHORT INCHKJ
 35478                                          ;;ENDIF
 35479                                  	
 35480                                  	;CMP	AL,"C"-"@"  ; cmp al,3
 35481                                          ;JZ	short INCHKJ
 35482                                  	;RETN
 35483                                  
 35484                                  ;	; 08/09/2018
 35485                                  ;INCHKJ:; 10/08/2018
 35486                                  ;	JMP	INCHK
 35487                                  
 35488                                  ;----------------------------------------------------------------------------
 35489                                  ;
 35490                                  ; Procedure Name : SpoolInt
 35491                                  ;
 35492                                  ; SpoolInt - signal processes that the DOS is truly idle. We are allowed to
 35493                                  ; do this ONLY if we are working on a 1-12 system call AND if we are not in
 35494                                  ; the middle of an INT 24.
 35495                                  ;
 35496                                  ;----------------------------------------------------------------------------
 35497                                  
 35498                                  SPOOLINT:
 35499 00005EB1 9C                      	PUSHF
 35500                                  	; 15/03/2018
 35501 00005EB2 36803E[5803]00          	CMP	BYTE [SS:IDLEINT],0	; SS override
 35502 00005EB8 7423                    	JZ	SHORT POPFRET
 35503 00005EBA 36803E[2003]00          	CMP	BYTE [SS:ERRORMODE],0
 35504 00005EC0 751B                    	JNZ	SHORT POPFRET		; No spool ints in error mode
 35505                                  
 35506                                  	; 30/07/2018
 35507                                  
 35508                                  	; Note that we are going to allow an external program to issue system 
 35509                                  	; calls at this time. We MUST preserve IdleInt across this.
 35510                                  
 35511 00005EC2 36FF36[5803]            	PUSH	WORD [SS:IDLEINT]
 35512                                  
 35513                                  	; 05/05/2019 - Retro DOS v4.0
 35514                                   
 35515                                  	; MSDOS 6.0
 35516 00005EC7 36803E[660D]00          	cmp	byte [SS:DosHasHMA],0	; Q: is dos running in HMA (M021)
 35517 00005ECD 7504                    	jne	short do_low_int28	; Y: the int must be done from low mem
 35518 00005ECF CD28                    	INT	int_spooler  ; int 28h	; N: Execute user int 28 handler
 35519 00005ED1 EB05                    	jmp	short spool_ret_addr
 35520                                  
 35521                                  do_low_int28:
 35522                                  	;call	far [ss:LowInt28Addr]
 35523 00005ED3 2EFF1E[2C5E]            	call	far [cs:LowInt28Addr]	; 05/05/2019
 35524                                  
 35525                                  spool_ret_addr:
 35526                                  	;INT	int_spooler		; INT 28h
 35527                                  
 35528 00005ED8 368F06[5803]            	POP	WORD [SS:IDLEINT]
 35529                                  POPFRET:
 35530 00005EDD 9D                      	POPF
 35531                                  _RET18:  
 35532 00005EDE C3                      	RETN
 35533                                  
 35534                                  ; 05/05/2019 - Retro DOS v4.0
 35535                                  ; DOSCODE:9137h (MSDOS 6.21, MSDOS.SYS)
 35536                                  ; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 35537                                  ; DOSCODE:90DBh (MSDOS 5.0, MSDOS.SYS)
 35538                                  
 35539                                  ;----------------------------------------------------------------------------
 35540                                  ;
 35541                                  ; Procedure Name : STATCHK
 35542                                  ;
 35543                                  ;----------------------------------------------------------------------------
 35544                                  
 35545                                  STATCHK:
 35546 00005EDF E84EFF                          CALL	DSKSTATCHK              ; Allows ^C to be detected under
 35547                                                                          ; input redirection
 35548 00005EE2 53                              PUSH    BX
 35549 00005EE3 31DB                            XOR     BX,BX
 35550 00005EE5 E8E6DF                          CALL	GET_IO_SFT
 35551 00005EE8 5B                              POP     BX
 35552 00005EE9 72F3                            JC      SHORT _RET18
 35553                                  
 35554 00005EEB B401                            MOV     AH,1
 35555 00005EED E8F8F1                          CALL	IOFUNC
 35556 00005EF0 74BF                            JZ      SHORT SPOOLINT
 35557 00005EF2 3C13                            CMP     AL,'S'-'@'
 35558 00005EF4 75A7                            JNZ     SHORT NOSTOP
 35559                                  
 35560                                  	; 05/05/2019
 35561                                  	; MSDOS 6.0			; SS override
 35562 00005EF6 36803E[BC0D]00          	CMP	BYTE [SS:SCAN_FLAG],0	; AN000; ALT_R ?
 35563 00005EFC 75AB                    	JNZ	short check_end		; AN000; yes
 35564                                  
 35565 00005EFE 30E4                            XOR     AH,AH
 35566 00005F00 E8E5F1                          CALL	IOFUNC                  ; Eat Cntrl-S
 35567 00005F03 EB4A                            JMP     SHORT PAUSOSTRT
 35568                                  PRINTOFF:
 35569                                  PRINTON:
 35570 00005F05 36F616[FE02]            	NOT	BYTE [SS:PFLAG] ; 14/03/2018
 35571                                  
 35572                                  	; 30/07/2018 - Retro DOS v3.0
 35573 00005F0A 53                      	PUSH	BX
 35574 00005F0B BB0400                  	MOV	BX,4
 35575 00005F0E E8BDDF                  	call	GET_IO_SFT
 35576 00005F11 5B                      	POP	BX
 35577 00005F12 72CA                    	jc	short _RET18
 35578 00005F14 06                      	PUSH	ES
 35579 00005F15 57                      	PUSH	DI
 35580 00005F16 1E                      	PUSH	DS
 35581 00005F17 07                      	POP	ES
 35582 00005F18 89F7                    	MOV	DI,SI			; ES:DI -> SFT
 35583                                  	;test	word [es:di+5],800h
 35584                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_net_spool
 35585                                  	; 05/05/2019
 35586 00005F1A 26F6450608              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_net_spool>>8)
 35587 00005F1F 7418                    	JZ	short NORM_PR 		; Not redirected, echo is OK
 35588                                  
 35589                                  	;Callinstall NetSpoolEchoCheck,MultNet,38,<AX>,<AX> 
 35590                                  					; See if allowed
 35591 00005F21 50                      	push	ax
 35592 00005F22 B82611                  	mov	ax,1126h
 35593 00005F25 CD2F                    	int	2Fh	; Multiplex - NETWORK REDIRECTOR - ???
 35594                                  			; Return: CF set on error, AX = error code
 35595                                  			; STACK unchanged
 35596 00005F27 58                      	pop	ax
 35597                                  
 35598 00005F28 730F                    	JNC	short NORM_PR 		; Echo is OK
 35599                                  
 35600                                  					; SS override
 35601 00005F2A 36C606[FE02]00          	MOV	BYTE [SS:PFLAG],0	; If not allowed, disable echo
 35602                                  
 35603                                  	;Callinstall NetSpoolClose,MultNet,36,<AX>,<AX> ; and close
 35604                                  
 35605 00005F30 50                      	push    ax
 35606 00005F31 B82411                  	mov     ax,1124h
 35607 00005F34 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - ???
 35608                                  			; ES:DI -> SFT, SS = DOS CS
 35609 00005F36 58                      	pop     ax
 35610                                  
 35611 00005F37 EB10                    	JMP	SHORT RETP6
 35612                                  NORM_PR:
 35613 00005F39 36803E[FE02]00          	CMP	BYTE [SS:PFLAG],0	; SS override
 35614 00005F3F 7505                    	JNZ	short PRNOPN
 35615 00005F41 E8FAF2                  	call	DEV_CLOSE_SFT
 35616 00005F44 EB03                    	JMP	SHORT RETP6
 35617                                  PRNOPN:
 35618 00005F46 E8EDF2                  	call	DEV_OPEN_SFT
 35619                                  RETP6:
 35620 00005F49 5F                      	POP	DI
 35621 00005F4A 07                      	POP	ES
 35622                                  STATCHK_RETN:
 35623 00005F4B C3                              RETN
 35624                                  PAUSOLP:
 35625 00005F4C E862FF                          CALL    SPOOLINT
 35626                                  PAUSOSTRT:
 35627 00005F4F B401                            MOV     AH,1
 35628 00005F51 E894F1                          CALL	IOFUNC
 35629 00005F54 74F6                            JZ      SHORT PAUSOLP
 35630                                  INCHK:
 35631 00005F56 53                              PUSH    BX
 35632 00005F57 31DB                            XOR     BX,BX
 35633 00005F59 E872DF                          CALL	GET_IO_SFT
 35634 00005F5C 5B                              POP     BX
 35635 00005F5D 72EC                            JC      SHORT STATCHK_RETN ; 30/07/2018
 35636 00005F5F 30E4                            XOR     AH,AH
 35637 00005F61 E884F1                          CALL	IOFUNC
 35638                                  	; 30/07/2018
 35639                                  	; MSDOS 3.3
 35640                                          ;CMP	AL,'P'-'@' ;cmp al,16
 35641                                          ;JNZ	SHORT NOPRINT
 35642                                  
 35643                                  	;cmp	byte [SS:SCAN_FLAG],0
 35644                                  	;JZ	SHORT PRINTON	
 35645                                  	;mov	byte [ss:SCAN_FLAG],0
 35646                                  
 35647                                  	; 05/05/2019
 35648                                  	; MSDOS 6.0
 35649 00005F64 3C10                    	CMP	AL,"P"-"@"
 35650                                  	;;;;  7/14/86	ALT_Q key fix
 35651 00005F66 749D                    	JZ	short PRINTON		; no! must be CTRL_P
 35652                                  ;NOPRINT:	
 35653                                  	;IF	NOT TOGLPRN
 35654                                  	;CMP	AL,"N"-"@"
 35655                                  	;JZ	short PRINTOFF
 35656                                  	;ENDIF
 35657 00005F68 3C03                    	CMP	AL,"C"-"@" ; cmp al,3 
 35658                                  	;retnz
 35659 00005F6A 75DF                    	jnz	short STATCHK_RETN
 35660                                  
 35661                                  	; !! NOTE: FALL THROUGH !!
 35662                                  
 35663                                  ;---------------------------------------------------------------------------
 35664                                  ;
 35665                                  ; Procedure Name : CNTHAND ( CTRLC_C HANDLER )
 35666                                  ;
 35667                                  ; "^C" and CR/LF is printed. Then the user registers are restored and the
 35668                                  ; user CTRL-C handler is executed. At this point the top of the stack has 1)
 35669                                  ; the interrupt return address should the user CTRL-C handler wish to allow
 35670                                  ; processing to continue; 2) the original interrupt return address to the code
 35671                                  ; that performed the function call in the first place. If the user CTRL-C
 35672                                  ; handler wishes to continue, it must leave all registers unchanged and RET
 35673                                  ; (not IRET) with carry CLEAR. If carry is SET then an terminate system call
 35674                                  ; is simulated.
 35675                                  ;
 35676                                  ;---------------------------------------------------------------------------
 35677                                  
 35678                                  	; 29/02/2024 - Retro DOS v5.0
 35679                                  
 35680                                  CNTCHAND:
 35681                                  	; MSDOS 6.0			; SS override
 35682                                  					; AN002; from RAWOUT
 35683                                  	;TEST	word [SS:DOS34_FLAG],CTRL_BREAK_FLAG  
 35684                                  	;JNZ	short around_deadlock 	; AN002;
 35685                                  
 35686                                  	; 05/05/2019 - Retro DOS v4.0
 35687                                  	; (MSDOS 6.21 MSDOS.SYS DOSCODE:91C4h, 29/12/2022)
 35688 00005F6C 36F606[1206]02          	TEST	byte [SS:DOS34_FLAG+1],(CTRL_BREAK_FLAG>>8)  ; 2 
 35689 00005F72 7508                    	JNZ	short around_deadlock 	; AN002;
 35690                                  
 35691 00005F74 B003                            MOV     AL,3			; Display "^C"
 35692 00005F76 E848BD                          CALL	BUFOUT
 35693 00005F79 E8E3BB                          CALL	CRLF
 35694                                  around_deadlock:
 35695 00005F7C 16                              PUSH    SS
 35696 00005F7D 1F                              POP     DS
 35697 00005F7E 803E[5703]00                    CMP     BYTE [CONSWAP],0
 35698 00005F83 7403                            JZ      SHORT NOSWAP
 35699 00005F85 E8D9DB                          CALL	SWAPBACK
 35700                                  NOSWAP:
 35701 00005F88 FA                      	CLI				; Prepare to play with stack
 35702 00005F89 8E16[8605]              	MOV	SS,[USER_SS]		; User stack now restored
 35703 00005F8D 8B26[8405]              	MOV	SP,[USER_SP]
 35704 00005F91 E8ADA4                          CALL	restore_world       ; User registers now restored
 35705                                  
 35706                                  	; 30/07/2018 - Retro DOS v3.0 
 35707                                  	; MSDOS 3.3 (IBMDOS.COM - Offset 56ACh)
 35708                                          ; 14/03/2018 - Retro DOS v2.0
 35709                                  	;MOV	BYTE [CS:INDOS],0	
 35710                                          ;MOV	BYTE [CS:ERRORMODE],0
 35711                                          ;MOV	[CS:ConC_Spsave],SP
 35712                                  	;clc	;30/07/2018
 35713                                          ;INT	int_ctrl_c ; 23h    ; Execute user Ctrl-C handler
 35714                                  	;;int	23h	; DOS - CONTROL "C" EXIT ADDRESS
 35715                                  			; Return: return via RETF 2 with CF set
 35716                                  			; DOS will abort program with errorlevel 0
 35717                                  			; else
 35718                                  			; interrupted DOS call continues
 35719                                  
 35720                                  	; 05/05/2019 - Retro DOS v4.0
 35721                                  	; MSDOS 6.0 (MSDOS 6.21, MSDOS.SYS,91ECh) 
 35722                                  
 35723                                  	; CS was used to address these variables. We have to use DOSDATA
 35724                                  	
 35725 00005F94 07                      	pop	es ; *	; MSDOS 6.21 (MSDOS.SYS, DOSCODE:91ECh)
 35726                                  			; (pop es, after 'call restore_world')	
 35727 00005F95 1E                      	push	ds
 35728                                  	;getdseg <ds>			; ds -> dosdata
 35729 00005F96 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 35730 00005F9B C606[2103]00            	mov	byte [INDOS],0		; Go to known state
 35731                                  	; 29/02/2024 (PCDOS 7.1 IBMDOS.COM)
 35732                                  	;;;
 35733 00005FA0 C606[B812]00            	mov	byte [INDOS_FLAG],0	; 2nd 'in dos' flag (what for?)
 35734                                  	;;;
 35735 00005FA5 C606[2003]00            	mov	byte [ERRORMODE],0
 35736 00005FAA 8926[3203]              	mov	[ConC_Spsave],SP	; save his SP
 35737                                  	; User SP has changed because of push. Adjust for it
 35738 00005FAE 8306[3203]02            	add	word [ConC_Spsave],2
 35739                                  
 35740 00005FB3 803E[660D]00            	cmp	byte [DosHasHMA],0	; Q: is dos running in HMA (M021)
 35741 00005FB8 1F                       	pop	ds	; restore ds
 35742 00005FB9 7505                    	jne	short do_low_int23	; Y: the int must be done from low mem
 35743 00005FBB F8                      	CLC				
 35744 00005FBC CD23                    	INT	int_ctrl_c  ; int 23h	; N: Execute user Ctrl-C handler
 35745 00005FBE EB06                    	jmp	short ctrlc_ret_addr
 35746                                  
 35747                                  	; 05/05/2019
 35748                                  do_low_int23:
 35749 00005FC0 F8                      	clc
 35750 00005FC1 2EFF1E[245E]            	call	far [cs:LowInt23Addr]
 35751                                  
 35752                                  	; 30/07/2018 
 35753                                  
 35754                                  	; MSDOS 3.3 (IBMDOS.COM - Offset 56C0h)
 35755                                  
 35756                                  ; The user has returned to us. The circumstances we allow are:
 35757                                  ;
 35758                                  ;   IRET	We retry the operation by redispatching the system call
 35759                                  ;   CLC/RETF	POP the stack and retry
 35760                                  ;   ... 	Exit the current process with ^C exit
 35761                                  ;
 35762                                  ; User's may RETURN to us and leave interrupts on. 
 35763                                  ; Turn 'em off just to be sure
 35764                                  
 35765                                  ctrlc_ret_addr: ; 05/05/2019
 35766                                  
 35767 00005FC6 FA                      	CLI
 35768                                  
 35769                                  	; MSDOS 3.3 
 35770                                  	;MOV	[CS:USER_IN_AX],ax	; save the AX
 35771                                  	;PUSHF				; and the flags (maybe new call)
 35772                                  	;POP	AX
 35773                                  
 35774                                  	; 05/05/2019
 35775                                  	; MSDOS 6.0
 35776                                  
 35777                                  	; We have to use DOSDATA for these variables. Previously CS was used 
 35778                                  
 35779 00005FC7 50                      	push	ax
 35780 00005FC8 8CD8                    	mov	ax,ds
 35781                                  	;getdseg <ds>			; ds -> dosdata
 35782 00005FCA 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 35783 00005FCF A3[630D]                	mov	[TEMPSEG],ax
 35784 00005FD2 58                      	pop	ax
 35785 00005FD3 A3[3A03]                	MOV	[USER_IN_AX],ax		; save the AX
 35786 00005FD6 9C                      	pushf				; and the flags (maybe new call)
 35787 00005FD7 58                      	pop	ax
 35788                                  
 35789                                  ; See if the input stack is identical to the output stack
 35790                                  
 35791                                  	; MSDOS 3.3
 35792                                  	;CMP	SP,[CS:ConC_Spsave]
 35793                                  	;JNZ	SHORT ctrlc_try_new	; current SP not the same as saved SP
 35794                                  
 35795                                  	; MSDOS 6.0
 35796 00005FD8 3B26[3203]              	CMP	SP,[ConC_Spsave]
 35797 00005FDC 750A                    	JNZ	SHORT ctrlc_try_new	; current SP not the same as saved SP
 35798                                  
 35799                                  ; Repeat the operation by redispatching the system call.
 35800                                  
 35801                                  ctrlc_repeat:
 35802                                  	; MSDOS 3.3
 35803                                  	;MOV	AX,[CS:USER_IN_AX]
 35804                                  	; 05/05/2019
 35805                                  	; MSDOS 6.0
 35806 00005FDE A1[3A03]                	mov	ax,[USER_IN_AX]
 35807 00005FE1 8E1E[630D]              	mov	ds,[TEMPSEG]		; restore ds and original sp
 35808                                  	; MSDOS 3.3 & MSDOS 6.0 
 35809                                  	;transfer COMMAND
 35810                                  COMMANDJ:
 35811 00005FE5 E909A3                  	JMP	COMMAND
 35812                                  
 35813                                  ; The current SP is NOT the same as the input SP. Presume that he 
 35814                                  ; RETF'd leaving some flags on the stack and examine the input
 35815                                  
 35816                                  ctrlc_try_new:
 35817                                  	; 29/02/2024
 35818                                  	;ADD	SP,2			; pop those flags
 35819                                  	;
 35820                                  	;;test	ax,1
 35821                                  	;TEST	AX,f_Carry		; did he return with carry?
 35822 00005FE8 A801                    	test	al,f_Carry ; test al,1
 35823                                  	;
 35824                                  	; 29/02/2024
 35825 00005FEA 58                      	pop	ax  ;  (PCDOS 7.1 IBMDOS.COM)
 35826                                  	;
 35827 00005FEB 74F1                    	JZ	short ctrlc_repeat	; no carry set, just retry
 35828                                  
 35829                                  	; MSDOS 6.0
 35830 00005FED 8E1E[630D]              	mov	ds,[TEMPSEG]		; restore ds
 35831                                  
 35832                                  	; Well...  time to abort the user.  
 35833                                  	; Signal a ^C exit and use the EXIT system call..
 35834                                  
 35835                                  ctrlc_abort:
 35836                                  	; MSDOS 3.3
 35837                                          ;;MOV	AX,(EXIT SHL 8) + 0
 35838                                          ;MOV	AX,(EXIT*256) + 0  ; 4C00h
 35839                                  	;mov	byte [CS:DidCTRLC],0FFh ; 14/03/2018
 35840                                          ;transfer COMMAND	    ; give up by faking $EXIT
 35841                                  	;;JMP	SHORT COMMANDJ
 35842                                  	;JMP	COMMAND
 35843                                  
 35844                                  	; 05/05/2019 - Retro DOS v4.0
 35845                                  	; MSDOS 6.0
 35846 00005FF1 B8004C                  	MOV	AX,(EXIT<<8)+0 ; 4C00h
 35847 00005FF4 1E                      	push	ds
 35848                                  	;getdseg <ds>			; ds -> dosdata
 35849 00005FF5 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]	
 35850 00005FFA C606[4D03]FF            	MOV	byte [DidCTRLC],-1 ; 0FFh
 35851 00005FFF 1F                      	pop	ds
 35852                                  	;transfer COMMAND		; give up by faking $EXIT
 35853 00006000 EBE3                    	JMP	SHORT COMMANDJ
 35854                                  	;JMP	COMMAND
 35855                                  
 35856                                  ;Break	<DIVISION OVERFLOW INTERRUPT>
 35857                                  ;----------------------------------------------------------------------------
 35858                                  ;
 35859                                  ; Procedure Name : DIVOV
 35860                                  ;
 35861                                  ; Default handler for division overflow trap
 35862                                  ;
 35863                                  ;----------------------------------------------------------------------------
 35864                                  
 35865                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 35866                                  DIVOV: 
 35867                                  	; 05/05/2019 - Retro DOS v4.0
 35868                                  	; 30/07/2018
 35869                                  	; 07/07/2018 - Retro DOS v3.0
 35870 00006002 BE[170A]                	mov	si,DIVMES
 35871 00006005 2E8B1E[2A0A]            	mov	bx,[cs:DivMesLen]
 35872                                  	;mov	ax,cs
 35873                                  	;mov	ss,ax
 35874                                  	; 05/05/2019
 35875                                  	;getdseg <ss>		; we are in an ISR, flag is CLI
 35876 0000600A 2E8E16[0700]            	mov	ss,[cs:DosDSeg]
 35877 0000600F BC[A007]                	mov     sp,AUXSTACK
 35878                                  	;call	RealDivOv ; MSDOS 3.3
 35879 00006012 E80200                  	call	_OUTMES ; MSDOS 6.0
 35880 00006015 EBDA                    	jmp	short ctrlc_abort  ; Use Ctrl-C abort on divide overflow
 35881                                  
 35882                                  ; 30/07/2018
 35883                                  
 35884                                  ; MSDOS 6.0
 35885                                  ;---------------------------------------------------------------------------
 35886                                  ;
 35887                                  ; Procedure Name : OutMes
 35888                                  ;
 35889                                  ;
 35890                                  ; OutMes: perform message output
 35891                                  ; Inputs:   SS:SI points to message
 35892                                  ;	    BX has message length
 35893                                  ; Outputs:  message to BCON
 35894                                  ;
 35895                                  ;Actually, cs:si points to the message now. The segment address is filled in
 35896                                  ;at init. time ([dskchret+2]). This will be temporarily changed to DOSCODE. 
 35897                                  ;NB. This procedure is called only from DIVOV. -SR
 35898                                  ;
 35899                                  ;---------------------------------------------------------------------------
 35900                                  
 35901                                  ;MSDOS 3.3
 35902                                  ;---------------------------------------------------------------------------
 35903                                  ; RealDivOv: perform actual divide overflow stuff.
 35904                                  ; Inputs:   none
 35905                                  ; Outputs:  message to BCON
 35906                                  ;---------------------------------------------------------------------------
 35907                                  
 35908                                  	; 05/05/2019 - Retro DOS v4.0
 35909                                  	; DOSCODE:926Ch (MSDOS 6.21, MSDOS.SYS)
 35910                                  
 35911                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 35912                                  	; DOSCODE:9210h (MSDOS 5.0, MSDOS.SYS)
 35913                                  
 35914                                  ;---------------------------------------------------------------------------
 35915                                  ;
 35916                                  ; Procedure Name : OutMes
 35917                                  ;
 35918                                  ; OutMes: perform message output
 35919                                  ; Inputs:   SS:SI points to message
 35920                                  ;	    BX has message length
 35921                                  ; Outputs:  message to BCON
 35922                                  ;
 35923                                  ;Actually, cs:si points to the message now. The segment address is filled in
 35924                                  ;at init. time ([dskchret+2]). This will be temporarily changed to DOSCODE. 
 35925                                  ;NB. This procedure is called only from DIVOV. -SR
 35926                                  ;
 35927                                  ;---------------------------------------------------------------------------
 35928                                  
 35929                                  	; 30/07/2018
 35930                                  	; MSDOS 6.0
 35931                                  _OUTMES:
 35932                                  	; MSDOS 3.3
 35933                                  ;RealDivOv:
 35934                                  	; 07/07/2018 - Retro DOS v3.0
 35935                                          ;Context ES
 35936 00006017 16                      	push	ss ; 05/05/2019
 35937                                  	;PUSH	CS ; 30/07/2018		; get ES addressability
 35938 00006018 07                      	POP	ES
 35939                                          ;Context DS
 35940 00006019 16                      	push	ss ; 05/05/2019	
 35941                                  	;PUSH	CS ; 30/07/2018		; get DS addressability
 35942 0000601A 1F                      	POP	DS
 35943 0000601B C606[9403]08                    MOV     BYTE [DSKSTCOM],DEVWRT
 35944 00006020 C606[9203]16                    MOV     BYTE [DSKSTCALL],DRDWRHL
 35945 00006025 C706[9503]0000                  MOV     WORD [DSKSTST],0
 35946                                  	; BX = [DivMesLen] = 19
 35947 0000602B 891E[A403]                      MOV     [DSKSTCNT],BX
 35948 0000602F BB[9203]                        MOV     BX,DSKSTCALL
 35949 00006032 8936[A003]                      MOV     [DSKCHRET+1],SI		; transfer address (need an EQU)
 35950                                  	; 08/09/2018
 35951                                  	;mov	[DEVIOBUF_PTR],si
 35952                                  	; MSDOS 6.0
 35953                                  					; CS is used for string, fill in 
 35954                                  					; segment address
 35955                                  	;mov	[DOSSEG_INIT],cs ; 29/02/2024 
 35956 00006036 8C0E[A203]              	MOV	[DSKCHRET+3],CS
 35957                                  
 35958 0000603A C536[3200]                      LDS     SI,[BCON]
 35959 0000603E E876F2                          CALL	DEVIOCALL2
 35960                                  
 35961                                  	;; 14/03/2018
 35962                                          ;;MOV	WORD [CS:DSKCHRET+1],DEVIOBUF
 35963                                  	;; 08/09/2018
 35964                                  	;mov	word [CS:DEVIOBUF_PTR],DEVIOBUF
 35965                                          ;MOV	WORD [CS:DSKSTCNT],1
 35966                                          
 35967                                  	; 05/05/2019 - Retro DOS v4.0 (MSDOS 6.0, MSDOS 6.21)
 35968                                  
 35969                                  	; ES still points to DOSDATA. ES is
 35970                                  					; not destroyed by deviocall2. So use
 35971                                  					; ES override.
 35972                                  
 35973 00006041 26C706[A003][BC03]      	MOV	WORD [ES:DSKCHRET+1],DEVIOBUF
 35974 00006048 26C706[A403]0100        	MOV	WORD [ES:DSKSTCNT],1
 35975                                  
 35976 0000604F C3                      	RETN
 35977                                  
 35978                                  ;Break	<CHARHRD,HARDERR,ERROR -- HANDLE DISK ERRORS AND RETURN TO USER>
 35979                                  ;---------------------------------------------------------------------------
 35980                                  ;
 35981                                  ; Procedure Name : CHARHARD
 35982                                  ;
 35983                                  ;
 35984                                  ; Character device error handler
 35985                                  ; Same function as HARDERR
 35986                                  ;
 35987                                  ;---------------------------------------------------------------------------
 35988                                  
 35989                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 35990                                  CHARHARD:
 35991                                  	; 05/05/2019 - Retro DOS v4.0
 35992                                  	; 30/07/2018
 35993                                  	; 08/07/2018 - Retro DOS v3.0
 35994                                  
 35995                                  	; MSDOS 6.0
 35996                                  		   			; M024 - start
 35997 00006050 36803E[2003]00          	cmp	byte [SS:ERRORMODE], 0	; Q: are we in the middle of int 24
 35998                                  	;jne	short @f		; Y: allow fail
 35999 00006056 750B                    	jne	short chard1
 36000                                  
 36001 00006058 80CC10                  	OR	AH,Allowed_RETRY ; 10h	; assume ctrl p
 36002                                  
 36003 0000605B 36F606[FE02]FF          	test	byte [ss:PFLAG],-1	; Q: has ctrl p been pressed
 36004 00006061 7503                    	jnz	short ctrlp		; Y: 
 36005                                  ;@@:
 36006                                  chard1:					; M024 - end
 36007                                  	; MSDOS 6.0 & MSDOS 3.3
 36008                                  
 36009                                  ; Character device error handler
 36010                                  ; Same function as HARDERR
 36011                                  
 36012                                  	;or	ah,38h
 36013 00006063 80CC38                  	or	ah,Allowed_IGNORE+Allowed_RETRY+Allowed_FAIL
 36014                                  ctrlp:			; SS override for Allowed and EXITHOLD
 36015 00006066 368826[4B03]            	mov	[SS:ALLOWED],ah
 36016                                  
 36017                                  	; 15/03/2018
 36018 0000606B 368C06[8205]                    MOV     [SS:EXITHOLD+2],ES
 36019 00006070 36892E[8005]                    MOV     [SS:EXITHOLD],BP
 36020 00006075 56                              PUSH    SI
 36021                                  	;and	di,0FFh
 36022 00006076 81E7FF00                        AND     DI,STECODE
 36023 0000607A 8CDD                            MOV     BP,DS                   ;Device pointer is BP:SI
 36024 0000607C E89D00                          CALL    FATALC
 36025 0000607F 5E                              POP     SI
 36026                                  	;return
 36027 00006080 C3                              RETN
 36028                                  
 36029                                  ;---------------------------------------------------------------------------
 36030                                  ;
 36031                                  ; Procedure Name : HardErr
 36032                                  ;
 36033                                  ; Hard disk error handler. Entry conditions:
 36034                                  ;	DS:BX = Original disk transfer address
 36035                                  ;	DX = Original logical sector number
 36036                                  ;	CX = Number of sectors to go (first one gave the error)
 36037                                  ;	AX = Hardware error code
 36038                                  ;	DI = Original sector transfer count	
 36039                                  ;	ES:BP = Base of drive parameters
 36040                                  ;	[READOP] = 0 for read, 1 for write
 36041                                  ;	Allowed Set with allowed responses to this error (other bits MUST BE 0)
 36042                                  ; Output:
 36043                                  ;	[FAILERR] will be set if user responded FAIL
 36044                                  ;
 36045                                  ;--------------------------------------------------------------------------
 36046                                  
 36047                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 36048                                  	; 29/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 36049                                  HARDERR:
 36050                                  	; 05/05/2019 - Retro DOS v4.0
 36051                                  	; 30/07/2018
 36052                                  	; 08/07/2018 - Retro DOS v3.0
 36053 00006081 97                      	XCHG	AX,DI		  	; Error code in DI, count in AX
 36054                                  	;and	di,0FFh
 36055 00006082 81E7FF00                	AND	DI,STECODE		; And off status bits
 36056                                  	;CMP	DI,WRECODE		; Write Protect Error?
 36057                                  	;cmp	di,0
 36058 00006086 83FF00                  	cmp	DI,error_I24_write_protect ; Write Protect Error?
 36059 00006089 750A                    	JNZ	short NOSETWRPERR
 36060 0000608B 50                      	PUSH	AX
 36061                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 36062                                  	;MOV	AL,[ES:BP+DPB.DRIVE]
 36063                                  	;;MOV	AL,[ES:BP+0]
 36064                                  	; 15/12/2022
 36065 0000608C 268A4600                	mov	al,[ES:BP]
 36066                                  		; 15/03/2018
 36067 00006090 36A2[2203]              	MOV	[SS:WPERR],AL		; Flag drive with WP error
 36068 00006094 58                      	POP	AX
 36069                                  NOSETWRPERR:
 36070 00006095 29C8                    	SUB	AX,CX		  ; Number of sectors successfully transferred
 36071 00006097 01C2                    	ADD	DX,AX		  ; First sector number to retry
 36072                                  	; 29/02/2024 (PCDOS 7.1 IBMDOS.COM)
 36073                                  	;;;
 36074 00006099 368316[0706]00          	adc	word [ss:HIGH_SECTOR],0
 36075                                  	;;;
 36076 0000609F 52                      	PUSH	DX
 36077                                  	; 08/07/2018
 36078                                  	;MUL	word [ES:BP+2] 		; Number of bytes transferred
 36079 000060A0 26F76602                	MUL	word [ES:BP+DPB.SECTOR_SIZE]
 36080 000060A4 5A                      	POP	DX
 36081 000060A5 01C3                    	ADD	BX,AX		  	; First address for retry
 36082                                  	;XOR	AH,AH ; *	  	; Flag disk section in error
 36083                                  	; 29/02/2024 (PCDOS 7.1 IBMDOS.COM)
 36084                                  	;;;
 36085 000060A7 31C0                    	xor	ax,ax ; * ; 29/02/2024 - Retro DOS v5.0
 36086                                  	;cmp	word [ss:HIGH_SECTOR],0
 36087 000060A9 363906[0706]            	cmp	[ss:HIGH_SECTOR],ax ; 0 ; *
 36088 000060AE 7506                    	jnz	short TESTDIR
 36089                                  	;;;
 36090                                  	;CMP	DX,[ES:BP+6] 		; In reserved area?
 36091 000060B0 263B5606                	CMP	DX,[ES:BP+DPB.FIRST_FAT]
 36092 000060B4 7246                    	JB	SHORT ERRINT
 36093                                  
 36094                                  TESTDIR:	; 29/02/2024	
 36095 000060B6 FEC4                    	INC	AH			; Flag for FAT
 36096                                  
 36097                                  	; 29/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 36098                                  	;;;
 36099                                  	;cmp	word [es:bp+0Fh],0
 36100 000060B8 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 36101 000060BD 7525                    	jnz	short TESTDIR3 ; not FAT32
 36102 000060BF 52                      	push	dx
 36103 000060C0 368B16[0706]            	mov	dx,[ss:HIGH_SECTOR]
 36104                                  	;cmp	dx,[es:bp+2Bh]
 36105 000060C5 263B562B                	cmp	dx,[es:bp+DPB.FCLUS_FSECTOR+2]
 36106 000060C9 5A                      	pop	dx
 36107 000060CA 7504                    	jnz	short TESTDIR1	; Err in FAT must force recomp of freespace
 36108                                  	;cmp	dx,[es:bp+29h]
 36109 000060CC 263B5629                	cmp	dx,[es:bp+DPB.FCLUS_FSECTOR]
 36110                                  TESTDIR1:
 36111 000060D0 730E                    	jnb	short TESTDIR2
 36112                                  	;mov	word [es:bp+1Fh],0FFFFh ; -1
 36113 000060D2 26C7461FFFFF            	mov	word [es:bp+DPB.FREE_CNT],0FFFFh
 36114                                  	;mov	word [es:bp+21h],0FFFFh ; -1
 36115 000060D8 26C74621FFFF            	mov	word [es:bp+DPB.FREE_CNT+2],0FFFFh
 36116 000060DE EB1C                    	jmp	short ERRINT
 36117                                  TESTDIR2:  
 36118 000060E0 FEC4                    	inc	ah
 36119                                  	;inc	ah
 36120                                  	;jmp	short ERRINT
 36121                                  	; 29/02/2024 - Retro DOS v5.0
 36122 000060E2 EB16                    	jmp	short ERRINT2
 36123                                  TESTDIR3:
 36124                                  	;;;
 36125                                  
 36126                                  	;CMP	DX,[ES:BP+10H] ; MSDOS 3.3
 36127                                  	;cmp	dx,[ES:BP+11h] ; MSDOS 6.0 - 05/05/2019
 36128 000060E4 263B5611                	CMP	DX,[ES:BP+DPB.DIR_SECTOR] ; In FAT?  
 36129                                  	;JAE	short TESTDIR 		; No
 36130 000060E8 7308                    	jae	short TESTDIR4 ; 29/02/2024
 36131                                  
 36132                                  		; Err in FAT must force recomp of freespace
 36133                                  	;mov	word [ES:BP+1Eh],-1 ; MSDOS 3.3
 36134                                  	;mov	word [ES:BP+1Fh],-1 ; MSDOS 6.0 - 05/05/2019 
 36135 000060EA 26C7461FFFFF            	MOV	word [ES:BP+DPB.FREE_CNT],-1
 36136                                  
 36137 000060F0 EB0A                    	JMP	SHORT ERRINT
 36138                                  ;TESTDIR:
 36139                                  TESTDIR4:	; 29/02/2024
 36140 000060F2 FEC4                    	INC	AH
 36141                                  	;CMP	DX,[ES:BP+0BH]		; In directory?
 36142 000060F4 263B560B                	CMP	DX,[ES:BP+DPB.FIRST_SECTOR]
 36143 000060F8 7202                    	JB	SHORT ERRINT
 36144                                  ERRINT2:	; 29/02/2024
 36145 000060FA FEC4                    	INC	AH			; Must be in data area
 36146                                  ERRINT:
 36147 000060FC D0E4                    	SHL	AH,1			; Make room for read/write bit
 36148 000060FE 360A26[7505]            	OR	AH,[SS:READOP] ; 15/03/2018
 36149                                  
 36150                                  	; 15/08/2018
 36151                                  					; SS override for allowed and EXITHOLD
 36152 00006103 360A26[4B03]            	OR	AH,[SS:ALLOWED]		; Set the allowed_ bits
 36153                                  
 36154                                  	;entry   FATAL
 36155                                  FATAL:
 36156                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 36157                                  	;MOV	AL,[ES:BP+DPB.DRIVE]
 36158                                  	;;MOV	AL,[ES:BP+0]		; Get drive number
 36159                                  	; 15/12/2022
 36160 00006108 268A4600                	MOV	AL,[ES:BP]	
 36161                                  
 36162                                  	;entry   FATAL1
 36163                                  FATAL1:  
 36164                                  	; 15/03/2018	
 36165 0000610C 368C06[8205]            	MOV	[SS:EXITHOLD+2],ES
 36166 00006111 36892E[8005]            	MOV	[SS:EXITHOLD],BP	; The only things we preserve
 36167                                  	;LES	SI,[ES:BP+12H] ; MSDOS 3.3
 36168                                  	;LES	SI,[ES:BP+13H] ; MSDOS 6.0 - 05/05/2019
 36169 00006116 26C47613                	LES	SI,[ES:BP+DPB.DRIVER_ADDR]
 36170 0000611A 8CC5                    	MOV	BP,ES			; BP:SI points to the device involved
 36171                                  
 36172                                  	; DI has the INT-24-style extended error. We now map the error code
 36173                                  	; for this into the normalized get extended error set by using the
 36174                                  	; ErrMap24 table as a translate table. Note that we translate ONLY
 36175                                  	; the device returned codes and leave all others beyond the look up
 36176                                  	; table alone.
 36177                                  
 36178                                  	; 08/07/2018 - Retro DOS v3.0
 36179                                  FATALC:
 36180 0000611C E8A101                  	call	SET_I24_EXTENDED_ERROR
 36181                                  	;cmp	di,0Ch
 36182 0000611F 83FF0C                  	CMP	DI,error_I24_gen_failure
 36183 00006122 7603                    	JBE	short GOT_RIGHT_CODE	; Error codes above gen_failure get
 36184 00006124 BF0C00                  	MOV	DI,error_I24_gen_failure; mapped to gen_failure. Real codes
 36185                                  					;  Only come via GetExtendedError
 36186                                  
 36187                                  ;** ----------------------------------------------------------------
 36188                                  ;
 36189                                  ; Entry point used by REDIRector on Network I 24 errors.
 36190                                  ;
 36191                                  ;	ASSUME	DS:NOTHING,ES:NOTHING,SS:DOSDATA
 36192                                  ;
 36193                                  ; ALL I 24 regs set up. ALL Extended error info SET. ALLOWED Set.
 36194                                  ;	EXITHOLD set for restore of ES:BP.
 36195                                  ; ------------------------------------------------------------------
 36196                                  	;entry	NET_I24_ENTRY
 36197                                  NET_I24_ENTRY:
 36198                                  GOT_RIGHT_CODE:
 36199 00006127 36803E[2003]00          	CMP	BYTE [SS:ERRORMODE],0	; No INT 24s if already INT 24
 36200 0000612D 7404                    	JZ	SHORT NoSetFail
 36201 0000612F B003                    	MOV	AL,3
 36202 00006131 EB76                    	JMP	short FailRet
 36203                                  NoSetFail:
 36204 00006133 368926[8805]            	MOV	[SS:CONTSTK],SP		; SS override
 36205 00006138 16                      	PUSH	SS
 36206 00006139 07                      	POP	ES
 36207                                      
 36208                                  	; Wango!!! We may need to free some user state info... In 
 36209                                  	; particular, we may have locked down a JFN for a user and he may
 36210                                  	; NEVER return to us. Thus,we need to free it here and then
 36211                                  	; reallocate it when we come back.
 36212                                  
 36213 0000613A 36833E[AA05]FF          	CMP	word [SS:SFN],-1 ; 0FFFFh
 36214 00006140 740C                    	JZ	short _NoFree
 36215 00006142 1E                      	push	ds
 36216 00006143 56                      	push	si
 36217 00006144 36C536[AE05]            	LDS	SI,[SS:PJFN]
 36218 00006149 C604FF                  	MOV	BYTE [SI],0FFH
 36219 0000614C 5E                      	pop	si
 36220 0000614D 1F                      	pop	ds
 36221                                  
 36222                                  _NoFree:
 36223 0000614E FA                      	CLI
 36224                                  					; Prepare to play with stack
 36225 0000614F 36FE06[2003]            	INC	BYTE [SS:ERRORMODE]	; Flag INT 24 in progress
 36226 00006154 36FE0E[2103]            	DEC	BYTE [SS:INDOS]		; INT 24 handler might not return
 36227                                  
 36228                                  	; 29/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 36229                                  	;;;
 36230 00006159 36FE0E[B812]            	dec	byte [ss:INDOS_FLAG]	; 2nd 'in dos' flag (what for?)
 36231                                  	;;;
 36232                                  
 36233                                  	; 05/05/2019 - Retro DOS v4.0 (MSDOS 6.0, MSDOS 6.21)
 36234                                  
 36235                                  	;; Extended Open hooks
 36236                                  					; AN000;IFS.I24 error disabled
 36237                                  	;test	byte [ss:EXTOPEN_ON],2
 36238 0000615E 36F606[F605]02          	TEST	byte [ss:EXTOPEN_ON],EXT_OPEN_I24_OFF
 36239 00006164 7404                    	JZ	short i24yes		; AN000;IFS.no
 36240                                  faili24:				; AN000;
 36241 00006166 B003                    	MOV	AL,3			; AN000;IFS.fake fail
 36242 00006168 EB29                    	JMP	short passi24 		; AN000;IFS.exit
 36243                                  i24yes: 				; AN000;
 36244                                  	;; Extended Open hooks
 36245                                  
 36246 0000616A 368E16[8605]            	MOV	SS,[SS:USER_SS]
 36247 0000616F 268B26[8405]            	MOV	SP,[ES:USER_SP]	; User stack pointer restored
 36248                                  
 36249                                  	;;int	24h	
 36250                                  	;IN	int_fatal_abort		; Fatal error interrupt vector,
 36251                                  					; must preserve ES
 36252                                  	; 05/05/2019
 36253 00006174 26803E[660D]00          	cmp	byte [es:DosHasHMA],0	; Q: is dos running in HMA (M021)
 36254 0000617A 7504                    	jne	short do_low_int24	; Y: the int must be done from low mem
 36255 0000617C CD24                    	INT	int_fatal_abort 	; Fatal error interrupt vector,
 36256                                  					; must preserve ES
 36257 0000617E EB05                    	jmp	short criterr_ret_addr
 36258                                  
 36259                                  do_low_int24:
 36260                                  	; 05/05/2019
 36261                                  	; MSDOS 6.0
 36262 00006180 2EFF1E[285E]            	call    far [cs:LowInt24Addr]
 36263                                  criterr_ret_addr:
 36264 00006185 268926[8405]            	MOV	[ES:USER_SP],SP	; restore our stack
 36265 0000618A 268C16[8605]            	MOV	[ES:USER_SS],SS
 36266 0000618F 8CC5                    	MOV	BP,ES
 36267 00006191 8ED5                    	MOV	SS,BP
 36268                                  passi24:
 36269 00006193 368B26[8805]            	MOV	SP,[SS:CONTSTK]
 36270 00006198 36FE06[2103]            	INC	BYTE [SS:INDOS]		; Back in the DOS
 36271                                  
 36272                                  	; 29/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 36273                                  	;;;
 36274 0000619D 36FE06[B812]            	inc	byte [ss:INDOS_FLAG]
 36275                                  	;;;
 36276                                  
 36277 000061A2 36C606[2003]00          	MOV	BYTE [SS:ERRORMODE],0	; Back from INT 24
 36278 000061A8 FB                      	STI
 36279                                  FailRet:
 36280 000061A9 36C42E[8005]            	LES	BP,[SS:EXITHOLD]
 36281                                  	
 36282                                  	; 08/07/2018
 36283                                  
 36284                                  	; Triage the user's reply.
 36285                                  
 36286 000061AE 3C01                    	CMP	AL,1
 36287 000061B0 723D                    	JB	short CheckIgnore	; 0 => ignore
 36288 000061B2 7445                    	JZ	short CheckRetry	; 1 => retry
 36289 000061B4 3C03                    	CMP	AL,3			; 3 => fail
 36290 000061B6 7549                    	JNZ	short DoAbort 		; 2, invalid => abort
 36291                                  
 36292                                  	; The reply was fail. See if we are allowed to fail.
 36293                                  
 36294                                  					; SS override for ALLOWED, EXTOPEN_ON,
 36295                                  					; ALLOWED, FAILERR, WPERR, SFN, pJFN
 36296                                  	;test	byte [ss:ALLOWED],8
 36297 000061B8 36F606[4B03]08          	test	byte [ss:ALLOWED],Allowed_FAIL ; Can we?
 36298 000061BE 7441                    	jz	short DoAbort		; No, do abort
 36299                                  DoFail:
 36300 000061C0 B003                    	MOV	AL,3			; just in case...
 36301                                  					; AN000;EO. I24 error disabled
 36302                                  	; 05/05/2019
 36303                                  	;(MSDOS 6.0, MSCTRLC.ASM, 1991)
 36304 000061C2 36F606[F605]02          	test	byte [ss:EXTOPEN_ON],EXT_OPEN_I24_OFF ; 2
 36305 000061C8 7505                    	jnz	short CleanUp 		; AN000;EO. no
 36306                                  	
 36307 000061CA 36FE06[4A03]            	inc	byte [SS:FAILERR]	; Tell everybody
 36308                                  CleanUp:
 36309 000061CF 36C606[2203]FF          	MOV	byte [SS:WPERR],-1
 36310 000061D5 36833E[AA05]FF          	CMP	word [SS:SFN],-1
 36311                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 36312                                  	;jnz	short CleanUp2
 36313                                  	;retn
 36314                                  	; 17/12/2022
 36315 000061DB 7411                    	jz	short Cleanup_retn ; 08/07/2018 - Retro DOS v3.0
 36316                                  CleanUp2:
 36317 000061DD 1E                      	push	ds
 36318 000061DE 56                      	push	si
 36319 000061DF 50                      	push	ax
 36320 000061E0 36A1[AA05]              	MOV	AX,[ss:SFN]
 36321 000061E4 36C536[AE05]            	LDS	SI,[ss:PJFN]
 36322 000061E9 8804                    	MOV	[SI],AL
 36323 000061EB 58                      	pop	ax
 36324 000061EC 5E                      	pop	si
 36325 000061ED 1F                      	pop	ds
 36326                                  Cleanup_retn:
 36327 000061EE C3                      	retn
 36328                                  
 36329                                  	; The reply was IGNORE. See if we are allowed to ignore.
 36330                                  
 36331                                  CheckIgnore:
 36332                                  	;test	byte [ss:ALLOWED],20h
 36333 000061EF 36F606[4B03]20          	test	byte [ss:ALLOWED],Allowed_IGNORE ; Can we?
 36334                                  CheckRI:	; 29/02/2024
 36335 000061F5 74C9                    	jz	short DoFail			; No, do fail
 36336 000061F7 EBD6                    	jmp	short CleanUp
 36337                                  
 36338                                  	; The reply was RETRY. See if we are allowed to retry.
 36339                                  
 36340                                  CheckRetry:
 36341                                  	;test	byte [ss:ALLOWED],10h
 36342 000061F9 36F606[4B03]10          	test	byte [ss:ALLOWED],Allowed_RETRY	; Can we?
 36343                                  	;jz	short DoFail			; No, do fail
 36344                                  	;JMP	short CleanUp
 36345                                  	; 29/02/2024 (PCDOS 7.1 IBMDOS.COM)
 36346 000061FF EBF4                    	jmp	short CheckRI
 36347                                  	
 36348                                  	; The reply was ABORT.
 36349                                  DoAbort:
 36350 00006201 16                      	push	ss
 36351 00006202 1F                      	pop	ds
 36352                                  
 36353 00006203 803E[5703]00            	CMP	byte [CONSWAP],0
 36354 00006208 7403                    	JZ	short NOSWAP2
 36355 0000620A E854D9                  	call	SWAPBACK
 36356                                  NOSWAP2:
 36357                                  	; See if we are to truly abort. If we are in the process of aborting, 
 36358                                  	; turn this abort into a fail.
 36359                                  
 36360                                  	;test	[fAborting],0FFh
 36361                                  	;jnz	short DoFail
 36362                                  
 36363 0000620D 803E[5903]00            	cmp	byte [fAborting],0
 36364 00006212 75AC                    	JNZ	short DoFail
 36365                                  
 36366                                  	; Set return code
 36367                                  
 36368 00006214 C606[7C05]02            	MOV	BYTE [EXIT_TYPE],EXIT_HARD_ERROR ; 2
 36369 00006219 30C0                    	XOR	AL,AL
 36370                                  
 36371                                  	; we are truly aborting the process. Go restore information from 
 36372                                  	; the PDB as necessary.
 36373                                  
 36374 0000621B E97010                  	jmp	exit_inner
 36375                                  
 36376                                  ;** --------------------------------------------------------------------------
 36377                                  ;
 36378                                  ; reset_environment checks the DS value against the CurrentPDB. If they are
 36379                                  ; different, then an old-style return is performed. If they are the same,
 36380                                  ; then we release jfns and restore to parent. We still use the PDB at DS:0 as
 36381                                  ; the source of the terminate addresses.
 36382                                  ;
 36383                                  ; Some subtlety: We are about to issue a bunch of calls that *may* generate
 36384                                  ; INT 24s. We *cannot* allow the user to restart the abort process; we may
 36385                                  ; end up aborting the wrong process or turn a terminate/stay/resident into a
 36386                                  ; normal abort and leave interrupt handlers around. What we do is to set a
 36387                                  ; flag that will indicate that if any abort code is seen, we just continue the
 36388                                  ; operation. In essence, we dis-allow the abort response.
 36389                                  ;
 36390                                  ; output:   none.
 36391                                  ; ----------------------------------------------------------------------------
 36392                                  
 36393                                  	;entry	reset_environment
 36394                                  	
 36395                                  reset_environment:
 36396                                  	; 30/07/2018 - Retro DOS v3.0
 36397                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 588Ah 
 36398                                  
 36399                                  ;***	invoke	Reset_Version		; AN007 ;MS. reset version number
 36400                                  
 36401 0000621E 1E                      	PUSH	DS			; save PDB of process
 36402                                  
 36403                                  	; There are no critical sections in force. Although we may enter
 36404                                  	; here with critical sections locked down, they are no longer 
 36405                                  	; relevant. We may safely free all allocated resources.
 36406                                  
 36407 0000621F B482                    	MOV	AH,82h
 36408                                  		; Microsoft Networks - END DOS CRITICAL SECTIONS 0 THROUGH 7
 36409                                  	;int	2Ah 	
 36410 00006221 CD2A                    	INT	int_IBM
 36411                                  
 36412                                  					; SS override
 36413 00006223 36C606[5903]FF          	MOV	byte [SS:fAborting],-1	; signal abort in progress
 36414                                  
 36415                                  					; DOS 4.00 doesn't need it
 36416                                  	;CallInstall NetResetEnvironment, MultNET, 34  
 36417                                  					; Allow REDIR to clear some stuff
 36418                                  					; On process exit.
 36419 00006229 B82211                  	mov	ax, 1122h
 36420 0000622C CD2F                    	int	2Fh	; Multiplex - NETWORK REDIRECTOR - PROCESS TERMINATION HOOK
 36421                                  			; SS = DOS CS
 36422                                  	;mov	al,22h	
 36423 0000622E B022                    	MOV	AL,int_terminate
 36424 00006230 E82EAD                  	call	_$GET_INTERRUPT_VECTOR	; and who to go to
 36425                                  
 36426 00006233 59                      	POP	CX			; get ThisPDB
 36427 00006234 06                      	push	es
 36428 00006235 53                      	push	bx			; save return address
 36429                                  
 36430 00006236 368B1E[3003]            	MOV	BX,[SS:CurrentPDB] 	; get currentPDB
 36431 0000623B 8EDB                    	MOV	DS,BX
 36432 0000623D A11600                  	MOV	AX,[PDB.PARENT_PID]	; get parentPDB
 36433                                  
 36434                                  	; AX = parentPDB, BX = CurrentPDB, CX = ThisPDB
 36435                                  	; Only free handles if AX <> BX and BX = CX and [exit_code].upper
 36436                                  	; is not Exit_keep_process
 36437                                  	
 36438 00006240 39D8                    	CMP	AX,BX
 36439 00006242 7418                    	JZ	short reset_return	; parentPDB = CurrentPDB
 36440 00006244 39CB                    	CMP	BX,CX
 36441 00006246 7514                    	JNZ	short reset_return	; CurrentPDB <> ThisPDB
 36442 00006248 50                      	PUSH	AX			; save parent
 36443                                  
 36444                                  					; SS override
 36445                                  	;cmp	byte [SS:EXIT_TYPE],3
 36446 00006249 36803E[7C05]03          	CMP	BYTE [SS:EXIT_TYPE],EXIT_KEEP_PROCESS ; 15/08/2018
 36447 0000624F 7406                    	JZ	short reset_to_parent 	; keeping this process
 36448                                  
 36449                                  	; We are truly removing a process. Free all allocation blocks
 36450                                  	; belonging to this PDB
 36451                                  
 36452                                  	;invoke	arena_free_process
 36453 00006251 E87910                  	call	arena_free_process
 36454                                  
 36455                                  	; Kill off remainder of this process. Close file handles and signal
 36456                                  	; to relevant network folks that this process is dead. Remember that
 36457                                  	; CurrentPDB is STILL the current process!
 36458                                  
 36459                                  	;invoke	DOS_ABORT
 36460 00006254 E85BD4                  	call	DOS_ABORT
 36461                                  
 36462                                  reset_to_parent:
 36463                                  					; SS override
 36464 00006257 368F06[3003]            	POP	word [SS:CurrentPDB]	; set up process as parent
 36465                                  
 36466                                  reset_return:				; come here for normal return
 36467                                  	;Context DS			; DS is used to refer to DOSDATA
 36468 0000625C 16                      	push	ss
 36469 0000625D 1F                      	pop	ds	
 36470                                  
 36471 0000625E B0FF                    	MOV	AL,-1
 36472                                  
 36473                                  	; make sure that everything is clean In this case ignore any errors,
 36474                                  	; we cannot "FAIL" the abort, the program being aborted is dead.
 36475                                  
 36476                                  	;EnterCrit critDisk
 36477 00006260 E880B6                  	call	ECritDisk
 36478                                  	;invoke	FLUSHBUF
 36479 00006263 E85F08                  	call	FLUSHBUF
 36480                                  	;LeaveCrit critDisk
 36481 00006266 E8A7B6                  	call	LCritDisk
 36482                                  
 36483                                  ; 29/02/2024 - Retrto DOS v5.0
 36484                                  ; PCDOS 7.1 IBMDOS.COM
 36485                                  %if 0
 36486                                  	; Decrement open ref. count if we had done a virtual open earlier.
 36487                                  
 36488                                  	call	CHECK_VIRT_OPEN
 36489                                  %endif
 36490                                  
 36491 00006269 FA                      	CLI
 36492 0000626A C606[2103]00            	MOV	BYTE [INDOS],0		; Go to known state
 36493                                  
 36494                                  	; 29/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 36495                                  	;;;
 36496 0000626F C606[B812]00            	mov	byte [INDOS_FLAG],0
 36497                                  	;;;
 36498                                  
 36499 00006274 C606[2203]FF            	MOV	BYTE [WPERR],-1		; Forget about WP error
 36500 00006279 C606[5903]00            	MOV	byte [fAborting],0	; let aborts occur
 36501 0000627E 8F06[8005]              	POP	WORD [EXITHOLD]
 36502 00006282 8F06[8205]              	POP	WORD [EXITHOLD+2]
 36503                                  
 36504                                  	; Snake into multitasking... Get stack from CurrentPDB person
 36505                                  
 36506 00006286 8E1E[3003]              	MOV	DS,[CurrentPDB]
 36507 0000628A 8E163000                	MOV	SS,[PDB.USER_STACK+2]
 36508 0000628E 8B262E00                	MOV	SP,[PDB.USER_STACK]
 36509                                  
 36510 00006292 E8ACA1                  	call	restore_world
 36511                                  
 36512                                  	; 05/05/2019
 36513 00006295 07                      	pop	es ; * ; MSDOS 6.21 (DOSCODE:94A8h, MSDOS.SYS)
 36514                                  
 36515                                  	; MSDOS 6.0
 36516 00006296 50                      	push	ax			; set up ds, but save ds in TEMPSEG
 36517 00006297 8CD8                    	mov	ax,ds			; and not on stack.
 36518                                  	;getdseg <ds>			; ds -> dosdata
 36519 00006299 2E8E1E[0700]            	mov	ds,[cs:DosDSeg] 
 36520 0000629E A3[630D]                	mov	[TEMPSEG],ax
 36521 000062A1 58                      	pop	ax
 36522                                  					; set up ds to DOSDATA
 36523                                  	;MOV	[CS:USER_SP],AX ; MSDOS 3.3
 36524 000062A2 A3[8405]                	mov	[USER_SP],ax
 36525                                  
 36526 000062A5 58                      	POP	AX			; suck off CS:IP of interrupt...
 36527 000062A6 58                      	POP	AX
 36528 000062A7 58                      	POP	AX
 36529                                  
 36530                                  ; M011 : BEGIN
 36531                                  
 36532                                  	; MSDOS 3.3
 36533                                  ;	MOV	AX,0F202h	; STI
 36534                                  
 36535                                  	; MSDOS 6.0
 36536 000062A8 9F                      	LAHF
 36537 000062A9 86E0                    	XCHG	AH,AL
 36538 000062AB 2402                    	AND	AL,2
 36539 000062AD B4F2                    	MOV	AH,0F2h
 36540                                  
 36541                                  ; M011 : END
 36542                                  
 36543                                  	; MSDOS 3.3 (& MSDOS 6.0)
 36544 000062AF 50                      	PUSH	AX
 36545                                   
 36546                                  	;PUSH	word [CS:EXITHOLD+2]
 36547                                  	;PUSH	word [CS:EXITHOLD]
 36548                                  	
 36549                                  	; MSDOS 6.0
 36550 000062B0 FF36[8205]              	PUSH	word [EXITHOLD+2]
 36551 000062B4 FF36[8005]              	PUSH	word [EXITHOLD]
 36552                                  
 36553                                  	;MOV	AX,[CS:USER_SP]
 36554                                  
 36555                                  	; MSDOS 6.0
 36556 000062B8 A1[8405]                	MOV	AX,[USER_SP]
 36557 000062BB 8E1E[630D]              	mov	ds,[TEMPSEG]	; restore ds
 36558                                  
 36559 000062BF CF                      	IRET			; Long return back to user terminate address
 36560                                  
 36561                                  ;---------------------------------------------------------------------------
 36562                                  ;
 36563                                  ; Procedure Name : SET_I24_EXTENDED_ERROR
 36564                                  ;
 36565                                  ; This routine handles extended error codes.
 36566                                  ; Input : DI = error code from device
 36567                                  ; Output: All EXTERR fields are set
 36568                                  ;
 36569                                  ;--------------------------------------------------------------------------
 36570                                  
 36571                                  SET_I24_EXTENDED_ERROR:
 36572 000062C0 50                      	PUSH	AX
 36573                                  					; ErrMap24End is in DOSDATA
 36574 000062C1 B8[BB0E]                	MOV	AX,ErrMap24End
 36575 000062C4 2D[AB0E]                	SUB	AX,ErrMap24
 36576                                  					; Change to dosdata to access
 36577                                  					; ErrMap24 and EXTERR -SR
 36578                                  	; 05/05/2019 - Retro DOS v4.0
 36579                                  	
 36580                                  	; MSDOS 6.0
 36581 000062C7 1E                      	push	ds
 36582                                  	;getdseg <ds>			; ds ->dosdata
 36583 000062C8 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 36584                                  
 36585                                  	; AX is the index of the first unavailable error. Do not translate
 36586                                  	; if greater or equal to AX.
 36587                                  
 36588 000062CD 39C7                    	CMP	DI,AX
 36589 000062CF 89F8                    	MOV	AX,DI
 36590 000062D1 7306                    	JAE	short NoTrans
 36591                                  
 36592                                  	;MOV	AL,[CS:DI+ErrMap24]  ; MSDOS 3.3
 36593 000062D3 8A85[AB0E]              	mov	al,[ErrMap24+di] ; MSDOS 6.0
 36594 000062D7 30E4                    	XOR	AH,AH
 36595                                  NoTrans:
 36596                                  	;MOV	[CS:EXTERR],AX
 36597 000062D9 A3[2403]                	mov	[EXTERR],AX
 36598 000062DC 1F                      	pop	ds
 36599                                  	;assume	ds:nothing
 36600 000062DD 58                      	POP	AX
 36601                                  
 36602                                  	; Now Extended error is set correctly. Translate it to get correct
 36603                                  	; error locus class and recommended action.
 36604                                  
 36605 000062DE 56                      	PUSH	SI
 36606                                  					; ERR_TABLE_24 is in DOSCODE 
 36607 000062DF BE[5B0E]                	MOV	SI,ERR_TABLE_24
 36608 000062E2 E8C8A3                  	call	CAL_LK			; Set other extended error fields
 36609 000062E5 5E                      	POP	SI
 36610 000062E6 C3                      	retn
 36611                                  
 36612                                  ;============================================================================
 36613                                  ; FAT.ASM, MSDOS 6.0, 1991
 36614                                  ;============================================================================
 36615                                  ; 30/07/2018 - Retro DOS v3.0
 36616                                  ; 20/05/2019 - Retro DOS v4.0
 36617                                  ; 02/03/2024 - Retro DOS v5.0
 36618                                  
 36619                                  ;	TITLE	FAT - FAT maintenance routines
 36620                                  ;	NAME	FAT
 36621                                  
 36622                                  ;**	FAT.ASM
 36623                                  ;----------------------------------------------------------------------------
 36624                                  ;	Low level local device routines for performing disk change sequence,
 36625                                  ;	setting cluster validity, and manipulating the FAT
 36626                                  ;
 36627                                  ;	IsEof
 36628                                  ;	UNPACK
 36629                                  ;	PACK
 36630                                  ;	MAPCLUSTER
 36631                                  ;	FATREAD_SFT
 36632                                  ;	FATREAD_CDS
 36633                                  ;	FAT_operation
 36634                                  ;
 36635                                  ;	Revision history:
 36636                                  ;
 36637                                  ;	  AN000  version Jan. 1988
 36638                                  ;	   A001  PTM	      -- disk changed for look ahead buffers
 36639                                  ;
 36640                                  ;	M014 - if a request for pack\unpack cluster 0 is made we write\read
 36641                                  ;	       from CL0FATENTRY rather than disk.
 36642                                  
 36643                                  ; DOSCODE:94FAh (MSDOS 6.21, MSDOS.SYS)
 36644                                  
 36645                                  ; 02/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 36646                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:A40Ch
 36647                                  
 36648                                  ;Break <IsEOF - check the quantity in BX for EOF>
 36649                                  ;----------------------------------------------------------------------------
 36650                                  ;
 36651                                  ; Procedure Name : IsEOF
 36652                                  ;
 36653                                  ; IsEOF - check the fat value in BX for eof.
 36654                                  ;
 36655                                  ;   Inputs:	ES:BP point to DPB
 36656                                  ;		BX has fat value
 36657                                  ;   Outputs:	JAE eof
 36658                                  ;   Registers modified: none
 36659                                  ;
 36660                                  ;---------------------------------------------------------------------------
 36661                                  
 36662                                  IsEOF:
 36663                                  	; 02/03/2024 - Retro DOS v5.0
 36664                                  	; PCDOS 7.1 IBMDOS.COM
 36665                                  	;;;
 36666 000062E7 E89901                  	call	IsFAT32			; is it FAT32 drive ?
 36667 000062EA 730D                    	jnc	short IsEOF_FAT		; no, it has 12 or 16 bit FAT
 36668                                  
 36669                                  	; FAT32 fs
 36670 000062EC 36813E[E80A]FF0F        	cmp	word [ss:CLUSTNUM_HW],0FFFh
 36671 000062F3 7503                    	jnz     short IsEOF_other1	; not EOF
 36672 000062F5 83FBF8                  	cmp     bx,0FFF8h		; 32 bit compare
 36673                                  IsEOF_other1:
 36674 000062F8 C3                      	retn 				; cf=0 -> EOF, cf=1 -> not EOF
 36675                                  
 36676                                  IsEOF_FAT:
 36677                                  	;;;
 36678                                  
 36679                                  	;cmp	word [es:bp+0Dh],0FF6h
 36680 000062F9 26817E0DF60F            	CMP	word [ES:BP+DPB.MAX_CLUSTER],4096-10 ; is this 16 bit fat?
 36681 000062FF 730B                    	JAE	short EOF16			; yes, check for eof there
 36682                                  
 36683                                  ;J.K. 8/27/86
 36684                                  ;Modified to accept 0FF0h as an eof. This is to handle the diskfull case
 36685                                  ;of any media that has "F0"(Other) as a MediaByte.
 36686                                  ;Hopely, this does not create any side effect for those who may use any value
 36687                                  ;other than "FF8-FFF" as an EOF for their own file.
 36688                                  
 36689 00006301 81FBF00F                	cmp	bx,0FF0h
 36690 00006305 7404                    	je	short IsEOF_other
 36691                                  
 36692 00006307 81FBF80F                	CMP	BX,0FF8h		; do the 12 bit compare
 36693                                  IsEOF_other:
 36694 0000630B C3                      	retn
 36695                                  EOF16:
 36696 0000630C 83FBF8                  	CMP	BX,0FFF8h		; 16 bit compare
 36697 0000630F C3                      	retn				; cf=0 -> EOF, cf=1 -> not EOF
 36698                                  
 36699                                  ; DOSCODE:9511h (MSDOS 6.21, MSDOS.SYS)
 36700                                  
 36701                                  ;Break	<UNPACK -- UNPACK FAT ENTRIES>
 36702                                  ;---------------------------------------------------------------------------
 36703                                  ;
 36704                                  ; Procedure Name : UNPACK
 36705                                  ;
 36706                                  ; Inputs:
 36707                                  ;	BX = Cluster number (may be full 16-bit quantity)
 36708                                  ;	ES:BP = Base of drive parameters
 36709                                  ; Outputs:
 36710                                  ;	DI = Contents of FAT for given cluster (may be full 16-bit quantity)
 36711                                  ;	Zero set means DI=0 (free cluster)
 36712                                  ;	Carry set means error (currently user FAILed to I 24)
 36713                                  ; SI Destroyed, No other registers affected. Fatal error if cluster too big.
 36714                                  ;
 36715                                  ; NOTE: if BX = 0 then DI = contents of CL0FATENTRY
 36716                                  ;
 36717                                  ;----------------------------------------------------------------------------
 36718                                  
 36719                                  	; 02/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 36720                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A44Eh
 36721                                  	;
 36722                                  	; (MSDOS 6.22 MSDOS .SYS - DOSCODE:9511h)
 36723                                  	; (Windows ME IO.SYS - BIOSCODE:0C368h)
 36724                                  
 36725                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 36726                                  	; DOSCODE:94B5h (MSDOS 5.0, MSDOS.SYS)
 36727                                  
 36728                                  	; 20/05/2019 - Retro DOS v4.0
 36729                                  UNPACK:
 36730                                  	; MSDOS 6.0			; M014 - Start
 36731 00006310 09DB                    	or	bx,bx			; Q: are we unpacking cluster 0
 36732 00006312 7519                    	jnz	short up_cont		; N: proceed with normal unpack
 36733                                  
 36734                                  ; 02/03/2024
 36735                                  %if 0
 36736                                  	mov	di,[CL0FATENTRY]	; Y: return value in CL0FATENTRY
 36737                                  	or	di,di 			; return z if di=0
 36738                                  	retn				; done
 36739                                  %else
 36740                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:A435h
 36741                                  	;;;
 36742                                  up_1:
 36743 00006314 391E[E80A]              	cmp	[CLUSTNUM_HW],bx ; 0
 36744 00006318 7513                    	jne	short up_cont
 36745 0000631A 8B3E[3B0F]              	mov	di,[CL0FATENTRY_HW]
 36746 0000631E 09FF                    	or	di,di
 36747 00006320 893E[EC0A]              	mov	[CCONTENT_HW],di
 36748 00006324 8B3E[8100]              	mov	di,[CL0FATENTRY]
 36749 00006328 7502                    	jnz	short unpack_retn
 36750 0000632A 09FF                    	or	di,di
 36751                                  unpack_retn:
 36752 0000632C C3                      	retn	; [CCONTENT_HW]:DI = contents of CL0FATENTRY
 36753                                  	;;;	
 36754                                  
 36755                                  %endif
 36756                                  
 36757                                  up_cont:				; M014 - End
 36758                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36759                                  	;;;
 36760                                  	;cmp	word [es:bp+0Fh],0
 36761 0000632D 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 36762 00006332 7510                    	jnz	short up_fat		; not FAT32
 36763                                  	; FAT32
 36764                                  	;mov	si,[es:bp+2Fh]
 36765 00006334 268B762F                	mov	si,[es:bp+DPB.LAST_CLUSTER+2]
 36766 00006338 3936[E80A]              	cmp	[CLUSTNUM_HW],si
 36767 0000633C 750A                    	jne	short up_2
 36768                                  	;cmp	bx,[es:bp+2Dh]
 36769 0000633E 263B5E2D                	cmp	bx,[es:bp+DPB.LAST_CLUSTER]
 36770 00006342 EB04                    	jmp	short up_2
 36771                                  up_fat:
 36772                                  	;;;
 36773                                  
 36774                                  	; MSDOS 3.3 & MSDOS 6.0
 36775                                  	;cmp	bx,[es:bp+0Dh]
 36776 00006344 263B5E0D                	CMP	BX,[es:bp+DPB.MAX_CLUSTER]
 36777                                  up_2:		; 02/03/2024
 36778 00006348 7748                    	JA	short HURTFAT
 36779 0000634A E84B01                  	CALL	MAPCLUSTER
 36780 0000634D 7240                    	jc	short _DoContext
 36781                                  
 36782                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36783                                  	;;;
 36784 0000634F FF7502                  	push	word [di+2]		; offset CLUSSAVE+2
 36785 00006352 368F06[EC0A]            	pop	word [ss:CCONTENT_HW]	; high word of cluster number
 36786                                  	;;;
 36787                                  
 36788 00006357 8B3D                    	MOV	DI,[DI]
 36789 00006359 7521                    	JNZ	short High12		; MZ if high 12 bits, go get 'em
 36790                                  
 36791                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36792                                  	;;;
 36793 0000635B E82501                  	call	IsFAT32
 36794 0000635E 7211                    	jc	short up_fat32		; FAT32 volume (drive)
 36795 00006360 36C706[EC0A]0000        	mov	word [ss:CCONTENT_HW],0
 36796                                  	;;;
 36797                                  
 36798 00006367 268B760D                	MOV	SI,[ES:BP+DPB.MAX_CLUSTER] ; MZ is this 16-bit fat?
 36799 0000636B 81FEF60F                	CMP	SI,4096-10 ; 0FF6h
 36800 0000636F 721A                    	JB	short Unpack12		; MZ No, go 'AND' off bits
 36801                                  
 36802                                  ; 02/03/2024
 36803                                  %if 0
 36804                                  	OR	DI,DI			; MZ set zero condition code, clears carry
 36805                                  	JMP	SHORT _DoContext 	; MZ go do context
 36806                                  High12:
 36807                                  	SHR	DI,1
 36808                                  	SHR	DI,1
 36809                                  	SHR	DI,1
 36810                                  	SHR	DI,1
 36811                                  %else
 36812                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36813                                  	;;;
 36814                                  up_fat32:
 36815 00006371 09FF                    	or	di,di			; set zero condition code, clears carry
 36816                                  	;mov	si,ss
 36817                                  	;mov	ds,si
 36818 00006373 16                      	push	ss
 36819 00006374 1F                      	pop	ds
 36820 00006375 7504                    	jnz	short up_retn
 36821 00006377 093E[EC0A]              	or	[CCONTENT_HW],di	; [CCONTENT_HW]:DI = 0 -> zf = 1
 36822                                  up_retn:
 36823 0000637B C3                      	retn
 36824                                  
 36825                                  High12:
 36826 0000637C 36C706[EC0A]0000        	mov	word [ss:CCONTENT_HW],0
 36827 00006383 D1EF                    	shr     di,1
 36828 00006385 D1EF                    	shr     di,1
 36829 00006387 D1EF                    	shr     di,1
 36830 00006389 D1EF                    	shr     di,1
 36831                                  	;;;
 36832                                  %endif
 36833                                  
 36834                                  Unpack12:
 36835 0000638B 81E7FF0F                	AND	DI,0FFFh		; Clears carry
 36836                                  _DoContext:
 36837 0000638F 16                      	PUSH	SS
 36838 00006390 1F                      	POP	DS
 36839 00006391 C3                      	retn
 36840                                  
 36841                                  HURTFAT:
 36842                                  
 36843                                  ; 02/03/2024
 36844                                  %if 0
 36845                                  	;;mov	word [es:bp+1Eh],0FFFFh
 36846                                  	;mov	word [es:bp+1Fh],0FFFFh  ; MSDOS 6.0
 36847                                  	MOV	word [ES:BP+DPB.FREE_CNT],-1 ; Err in FAT must force recomp of freespace
 36848                                  %else
 36849                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36850                                  	;;;
 36851 00006392 E84D02                  	call	chk_set_first_access
 36852                                  	;;;
 36853                                  %endif
 36854                                  
 36855 00006395 50                      	PUSH	AX
 36856 00006396 B488                    	MOV	AH,Allowed_FAIL+80h ; 88h
 36857                                  
 36858                                  ; 02/03/2024
 36859                                  %if 0
 36860                                  
 36861                                  ;hkn; SS override
 36862                                  	MOV	byte [SS:ALLOWED],Allowed_FAIL ; 8
 36863                                  ;
 36864                                  ; Signal Bad FAT to INT int_fatal_abort handler. We have an invalid cluster.
 36865                                  ;
 36866                                  	MOV	DI,0FFFh		; In case INT int_fatal_abort returns (it shouldn't)
 36867                                  	call	FATAL
 36868                                  %else
 36869                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36870                                  	;;;
 36871                                  	;mov	byte [ss:ALLOWED],8
 36872 00006398 36C606[4B03]08          	mov	byte [ss:ALLOWED],Allowed_FAIL
 36873                                  	;
 36874                                  	; 02/03/2024 - Retro DOS v5.0
 36875 0000639E 31FF                    	xor	di,di
 36876 000063A0 4F                      	dec	di	; 0FFFFh
 36877 000063A1 57                      	push	di
 36878                                  	;
 36879 000063A2 36FF36[E80A]            	push	word [ss:CLUSTNUM_HW] ; (necessary!?)
 36880 000063A7 53                      	push	bx	; (necessary!?)
 36881 000063A8 E85DFD                  	call	FATAL
 36882 000063AB 5B                      	pop	bx
 36883 000063AC 368F06[E80A]            	pop	word [ss:CLUSTNUM_HW]
 36884                                  	;xor	di,di
 36885                                  	;dec	di	; 0FFFFh
 36886                                  	;mov	word [ss:CCONTENT_HW],di
 36887                                  	; 02/03/2024 - Retro DOS v5.0
 36888 000063B1 368F06[EC0A]            	pop	word [ss:CCONTENT_HW]
 36889                                  	;;;
 36890                                  %endif
 36891                                  
 36892 000063B6 3C03                    	CMP	AL,3
 36893 000063B8 F8                      	CLC
 36894 000063B9 7501                    	JNZ	short OKU_RET 		; Try to ignore bad FAT
 36895 000063BB F9                      	STC				; User said FAIL
 36896                                  OKU_RET:
 36897 000063BC 58                      	POP	AX
 36898                                  hurtfat_retn:
 36899 000063BD C3                      	retn
 36900                                  
 36901                                  ; DOSCODE:9565h (MSDOS 6.21, MSDOS.SYS)
 36902                                  
 36903                                  ;Break	<PACK -- PACK FAT ENTRIES>
 36904                                  ;----------------------------------------------------------------------------
 36905                                  ;
 36906                                  ; Procedure Name : PACK
 36907                                  ;
 36908                                  ; Inputs:
 36909                                  ;	BX = Cluster number
 36910                                  ;	DX = Data
 36911                                  ;	ES:BP = Pointer to drive DPB
 36912                                  ; Outputs:
 36913                                  ;	The data is stored in the FAT at the given cluster.
 36914                                  ;	SI,DX,DI all destroyed
 36915                                  ;	Carry set means error (currently user FAILed to I 24)
 36916                                  ;	No other registers affected
 36917                                  ;
 36918                                  ; NOTE: if BX = 0 then data in DX is stored in CL0FATENTRY.
 36919                                  ;
 36920                                  ;---------------------------------------------------------------------------
 36921                                  
 36922                                  	; 02/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 36923                                  
 36924                                  	; INPUT:
 36925                                  	;  [CLUSDATA_HW]:DX = cluster data/content
 36926                                  	;  [CLUSTNUM_HW]:BX = cluster number (to be updated)
 36927                                  	;  ES:BP = pointer to DPB
 36928                                  
 36929                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 36930                                  	; 20/05/2019 - Retro DOS v4.0
 36931                                  PACK:
 36932                                  	; MSDOS 6.0			; M014 - start
 36933 000063BE 09DB                    	or	bx,bx			; Q: are we packing cluster 0
 36934 000063C0 7513                    	jnz	short p_cont		; N: proceed with normal pack
 36935                                  
 36936                                  ; 02/03/2024
 36937                                  %if 0
 36938                                  	mov	[CL0FATENTRY],dx	; Y: place value in CL0FATENTRY
 36939                                  	retn				; done
 36940                                  %else
 36941                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36942                                  	;;;
 36943 000063C2 391E[E80A]              	cmp	[CLUSTNUM_HW],bx ; 0
 36944 000063C6 750D                    	jnz	short p_cont
 36945                                  
 36946                                  	;push	ax
 36947                                  	;mov	ax,[CLUSDATA_HW]	; Cluster Data/Content (High Word)
 36948                                  	;mov	[CL0FATENTRY_HW],ax
 36949                                  	;pop	ax
 36950 000063C8 FF36[EA0A]              	push	word [CLUSDATA_HW]
 36951 000063CC 8F06[3B0F]              	pop	word [CL0FATENTRY_HW]
 36952                                  
 36953 000063D0 8916[8100]              	mov	[CL0FATENTRY],dx
 36954 000063D4 C3                      	retn
 36955                                  	;;;
 36956                                  %endif
 36957                                  
 36958                                  p_cont:					; M014 - end
 36959                                  	; MSDOS 3.3 & MSDOS 6.0
 36960 000063D5 E8C000                  	CALL	MAPCLUSTER
 36961 000063D8 72B5                    	JC	short _DoContext
 36962 000063DA 8B35                    	MOV	SI,[DI]
 36963 000063DC 740B                    	JZ	short ALIGNED 		; byte (not nibble) aligned
 36964 000063DE 51                      	PUSH	CX			; move data to upper 12 bits
 36965 000063DF B104                    	MOV	CL,4
 36966 000063E1 D3E2                    	SHL	DX,CL
 36967 000063E3 59                      	POP	CX
 36968 000063E4 83E60F                  	AND	SI,0FH			; leave in original low 4 bits
 36969 000063E7 EB2C                    	JMP	SHORT PACKIN
 36970                                  
 36971                                  ALIGNED:
 36972                                  
 36973                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36974                                  	;;;
 36975 000063E9 E89700                  	call	IsFAT32
 36976 000063EC 7313                    	jnb	short p_fat
 36977                                  
 36978 000063EE 368B36[EA0A]            	mov	si,[ss:CLUSDATA_HW]
 36979 000063F3 337502                  	xor	si,[di+2]		; hw of cluster number
 36980                                  					; offset CLUSSAVE+2
 36981 000063F6 81E6FF0F                	and	si,0FFFh
 36982 000063FA 317502                  	xor	[di+2],si
 36983 000063FD 8915                    	mov	[di],dx
 36984 000063FF EB18                    	jmp	short PACKIN2
 36985                                  p_fat:
 36986                                  	;;;
 36987                                  
 36988                                  	;cmp	word [es:bp+0Dh],0FF6h
 36989 00006401 26817E0DF60F            	CMP	word [ES:BP+DPB.MAX_CLUSTER],4096-10 ; MZ 16 bit fats?
 36990 00006407 730A                    	JAE	short Pack16		; MZ yes, go clobber original data
 36991 00006409 81E600F0                	AND	SI,0F000h		; MZ leave in upper 4 bits of original
 36992 0000640D 81E2FF0F                	AND	DX,0FFFh		; MZ store only 12 bits
 36993 00006411 EB02                    	JMP	SHORT PACKIN		; MZ go store
 36994                                  Pack16:
 36995 00006413 31F6                    	XOR	SI,SI			; MZ no original data
 36996                                  PACKIN:
 36997 00006415 09D6                    	OR	SI,DX
 36998 00006417 8935                    	MOV	[DI],SI
 36999                                  
 37000                                  PACKIN2:	; 02/03/2024
 37001                                  
 37002                                  ;hkn; SS override
 37003 00006419 36C536[E205]            	LDS	SI,[SS:CURBUF]
 37004                                  	; MSDOS 6.0
 37005 0000641E F6440540                	TEST	byte [SI+BUFFINFO.buf_flags],buf_dirty
 37006                                  					;LB. if already dirty		  ;AN000;
 37007 00006422 7507                    	JNZ	short yesdirty11	;LB.  don't increment dirty count ;AN000;
 37008                                  	; 10/06/2019
 37009 00006424 E8D007                  	call	INC_DIRTY_COUNT		;LB.				  ;AN000;
 37010                                  	
 37011                                  	;or	byte [si+5],40h
 37012 00006427 804C0540                	OR	byte [SI+BUFFINFO.buf_flags],buf_dirty
 37013                                  yesdirty11:				;LB.				;AN000;
 37014                                  ;hkn; SS override
 37015 0000642B 36803E[7805]00          	CMP	BYTE [SS:CLUSSPLIT],0	; 15/08/2018
 37016                                  ;hkn; SS is DOSDATA
 37017 00006431 16                      	push	ss
 37018 00006432 1F                      	pop	ds
 37019 00006433 7488                    	jz	short hurtfat_retn	; Carry clear
 37020 00006435 50                      	PUSH	AX
 37021                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37022                                  	;;;
 37023 00006436 FF36[E80A]              	push	word [CLUSTNUM_HW]
 37024                                  	;;;
 37025 0000643A 53                      	PUSH	BX
 37026 0000643B 51                      	PUSH	CX
 37027 0000643C A1[8E05]                	MOV	AX,[CLUSSAVE]
 37028 0000643F 8E1E[E405]              	MOV	DS,[CURBUF+2]
 37029                                  	;;;add	si,16 ; MSDOS 3.3
 37030                                  	;;add	si,20 ; MSDOS 6.0
 37031                                  	; 02/01/2024
 37032                                  	;add	si,24 ; PCDOS 7.1 
 37033 00006443 83C618                  	ADD	SI,BUFINSIZ
 37034 00006446 8824                    	MOV	[SI],AH
 37035                                  ;hkn; SS is DOSDATA
 37036                                  	;Context DS
 37037 00006448 16                      	push	ss
 37038 00006449 1F                      	pop	ds
 37039                                  	
 37040 0000644A 50                      	PUSH	AX
 37041                                  	
 37042                                  	; MSDOS 6.0
 37043 0000644B 8B16[9205]              	MOV	DX,[CLUSSEC+2]		;F.C. >32mb			;AN000;
 37044 0000644F 8916[0706]              	MOV	[HIGH_SECTOR],DX	;F.C. >32mb			;AN000;
 37045                                  
 37046                                  	; MSDOS 3.3 & MSDOS 6.0
 37047 00006453 8B16[9005]              	MOV	DX,[CLUSSEC]
 37048                                  
 37049                                  	;MOV	SI,1	  ; *
 37050                                  	;XOR	AL,AL     ; *
 37051                                  	;call	GETBUFFRB ; *
 37052                                  	; 22/09/2023
 37053 00006457 E8F804                  	call	GETBUFFRA ; *
 37054                                  
 37055 0000645A 58                      	POP	AX
 37056 0000645B 721B                    	JC	short POPP_RET
 37057 0000645D C53E[E205]              	LDS	DI,[CURBUF]
 37058                                  	
 37059                                  	; MSDOS 6.0
 37060 00006461 F6450540                	TEST	byte [DI+BUFFINFO.buf_flags],buf_dirty  
 37061                                  					;LB. if already dirty		  ;AN000;
 37062 00006465 7507                    	JNZ	short yesdirty12	;LB.  don't increment dirty count ;AN000;
 37063 00006467 E88D07                  	call	INC_DIRTY_COUNT 	;LB.				  ;AN000;
 37064                                  	
 37065                                  	;or	byte [di+5],40h
 37066 0000646A 804D0540                	OR	byte [DI+BUFFINFO.buf_flags],buf_dirty 
 37067                                  yesdirty12:
 37068                                  	;;;add	di,16
 37069                                  	;;add	di,20 ; MSDOS 6.0
 37070                                  	;ADD	DI,BUFINSIZ
 37071                                  	;DEC	DI
 37072                                  	; 02/01/2024 - Retro DOS v5.0
 37073                                  	;add	di,23 ; PCDOS 7.1
 37074 0000646E 83C717                  	add	di,BUFINSIZ-1 ; 23 ; PCDOS 7.1 IBMDOS.COM
 37075                                  	
 37076                                  	;add	di,[es:bp+2]
 37077 00006471 26037E02                	ADD	DI,[ES:BP+DPB.SECTOR_SIZE]
 37078 00006475 8805                    	MOV	[DI],AL
 37079 00006477 F8                      	CLC
 37080                                  POPP_RET:
 37081                                  	; 02/03/2024
 37082 00006478 16                      	PUSH	SS
 37083 00006479 1F                      	POP	DS
 37084 0000647A 59                      	POP	CX
 37085 0000647B 5B                      	POP	BX
 37086                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37087                                  	;;;
 37088 0000647C 368F06[E80A]            	pop	word [ss:CLUSTNUM_HW]
 37089                                  	;;;
 37090 00006481 58                      	POP	AX
 37091 00006482 C3                      	retn
 37092                                  
 37093                                  ; =============== S U B R O U T I N E =======================================
 37094                                  	
 37095                                  	; 02/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 37096                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A5B9h
 37097                                  IsFAT32:
 37098                                  	;cmp	word [es:bp+0Fh],1
 37099 00006483 26837E0F01              	cmp	word [es:bp+DPB.FAT_SIZE],1
 37100 00006488 730D                    	jnb	short isfat32eof_2	; not FAT32
 37101                                  
 37102                                  	;cmp	word [es:bp+2Fh],0
 37103 0000648A 26837E2F00              	cmp	word [es:bp+DPB.LAST_CLUSTER+2],0
 37104 0000648F 7505                    	jnz	short isfat32eof_1	; FAT32
 37105                                  
 37106                                  	;cmp	word [es:bp+2Dh],0FFF6h
 37107 00006491 26837E2DF6              	cmp	word [es:bp+DPB.LAST_CLUSTER],0FFF6h
 37108                                  isfat32eof_1:
 37109 00006496 F5                      	cmc	; cf=1 -> FAT32
 37110                                  isfat32eof_2:
 37111 00006497 C3                      	retn
 37112                                  
 37113                                  ;----------------------------------------------------------------------------
 37114                                  
 37115                                  ; 31/07/2018 - Retro DOS v3.0
 37116                                  
 37117                                  ;Break	<MAPCLUSTER - BUFFER A FAT SECTOR>
 37118                                  ;---------------------------------------------------------------------------
 37119                                  ;
 37120                                  ; Procedure Name : MAPCLUSTER
 37121                                  ;
 37122                                  ; Inputs:
 37123                                  ;	ES:BP Points to DPB
 37124                                  ;	BX Is cluster number
 37125                                  ; Function:
 37126                                  ;	Get a pointer to the cluster
 37127                                  ; Outputs:
 37128                                  ;	DS:DI Points to contents of FAT for given cluster
 37129                                  ;	DS:SI Points to start of buffer
 37130                                  ;	Zero Not set if cluster data is in high 12 bits of word
 37131                                  ;	Zero set if cluster data is in low 12 or 16 bits
 37132                                  ;	Carry set if failed.
 37133                                  ; SI is destroyed.
 37134                                  ;
 37135                                  ;---------------------------------------------------------------------------
 37136                                  
 37137                                  	; 20/05/2019 - Retro DOS v4.0
 37138                                  	; DOSCODE:9601h (MSDOS 6.21, MSDOS.SYS)
 37139                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 37140                                  	; DOSCODE:95A5h (MSDOS 5.0, MSDOS.SYS)
 37141                                  
 37142                                  	; 02/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 37143                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A5D7h
 37144                                  
 37145                                  MAPCLUSTER:
 37146                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5A15h
 37147 00006498 C606[7805]00            	MOV	BYTE [CLUSSPLIT],0
 37148                                  	;SAVE	<AX,BX,CX,DX>
 37149 0000649D 50                      	push	ax
 37150 0000649E 53                      	push	bx
 37151 0000649F 51                      	push	cx
 37152 000064A0 52                      	push	dx
 37153                                  	; 02/03/2024
 37154                                  	;MOV	AX,BX			; AX = BX
 37155                                  
 37156                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37157                                  	;;;
 37158                                  	;push	word [CLUSTNUM_HW]
 37159 000064A1 89D8                    	mov	ax,bx
 37160 000064A3 8B16[E80A]              	mov	dx,[CLUSTNUM_HW]
 37161                                  	;
 37162 000064A7 52                      	push	dx ; 02/03/2024 - Retro DOS v5.0
 37163                                  	;
 37164 000064A8 31FF                    	xor	di,di
 37165 000064AA E8D6FF                  	call	IsFAT32
 37166 000064AD 730E                    	jnc	short mapcl1 ; not FAT32
 37167                                  	; FAT32
 37168 000064AF D1E0                    	shl	ax,1
 37169 000064B1 D1D2                    	rcl	dx,1
 37170 000064B3 D1D7                    	rcl	di,1
 37171 000064B5 D1E0                    	shl	ax,1
 37172 000064B7 D1D2                    	rcl	dx,1
 37173 000064B9 D1D7                    	rcl	di,1
 37174                                  	; DI:DX:AX = 4*(DX:AX)
 37175 000064BB EB14                    	jmp	short Map16		; 32 bit FAT	
 37176                                  mapcl1:
 37177                                  	;;;
 37178                                  
 37179 000064BD 26817E0DF60F            	CMP	word [ES:BP+DPB.MAX_CLUSTER],4096-10  ; MZ 16 bit fat?
 37180                                  	; 02/03/2024 - Retro DOS v5.0
 37181                                  	;JAE	short Map16		; MZ yes, do 16 bit algorithm
 37182                                  	;SHR	AX,1			; AX = BX/2
 37183                                  	;
 37184                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37185                                  	;;;
 37186 000064C3 7304                    	jae	short mapcl2		; 16 bit FAT
 37187                                  	; 12 bit FAT
 37188 000064C5 D1EA                    	shr	dx,1
 37189 000064C7 D1D8                    	rcr     ax,1
 37190                                  mapcl2:
 37191 000064C9 01D8                    	add     ax,bx
 37192 000064CB 1316[E80A]              	adc     dx,[CLUSTNUM_HW]
 37193 000064CF 11FF                    	adc	di,di
 37194                                  	;;;
 37195                                  Map16:	
 37196                                  
 37197                                  ; 02/04/2024 - Retro DOS v5.0
 37198                                  ; (PCDOS 7.1 IBMDOS.COM)
 37199                                  %if 0
 37200                                  	; MSDOS 6.0			; MZ skip prev => AX=2*BX
 37201                                  	XOR	DI,DI ; *		; >32mb fat ;AN000;
 37202                                  	
 37203                                  	; MSDOS 3.3 (& MSDOS 6.0)
 37204                                  	ADD	AX,BX			; AX = 1.5*fat = byte offset in fat
 37205                                  	ADC	DI,DI ; * MSDOS 6.0	; >32mb fat ;DI is zero before op;AN000;
 37206                                  %endif
 37207                                  
 37208 000064D1 268B4E02                	MOV	CX,[ES:BP+DPB.SECTOR_SIZE]
 37209                                  
 37210                                  ;IF FastDiv
 37211                                  ;
 37212                                  ; Gross hack: 99% of all disks have 512 bytes per sector. We test for this
 37213                                  ; case and apply a really fast algorithm to get the desired results
 37214                                  ;
 37215                                  ; Divide method takes 157+4*4=173 (MOV and DIV)
 37216                                  ; Fast method takes 39+20*4=119
 37217                                  ;
 37218                                  ; This saves a bunch.
 37219                                  
 37220 000064D5 81F90002                	CMP	CX,512			; 4  Is this 512 byte sector?
 37221 000064D9 751C                    	jne	short _DoDiv		; 4  for no jump
 37222                                  
 37223                                  ; 02/04/2024
 37224                                  %if 0
 37225                                  	MOV	DX,AX			; 2  get set for remainder
 37226                                  	AND	DX,512-1		; 4  Form remainder
 37227                                  	MOV	AL,AH			; 2  Quotient in formation in AL
 37228                                  	; MDOS 3.3
 37229                                  	;shr	al,1	
 37230                                  	; MDOS 6.0
 37231                                  	shr	di,1			; 2
 37232                                  	rcr	al,1			; 2
 37233                                  	; MDOS 3.3 (& MSDOS 6.0)
 37234                                  	xor	ah,ah			; 3
 37235                                  %else
 37236                                  	; 02/04/2024 - Retro DOS v5.0
 37237                                  	; (PCDOS 7.1 IBMDOS.COM)
 37238                                  	;;;
 37239 000064DB 50                      	push	ax
 37240 000064DC D1EF                    	shr	di,1
 37241 000064DE D1DA                    	rcr	dx,1
 37242 000064E0 D1D8                    	rcr	ax,1
 37243 000064E2 88E0                    	mov	al,ah			; 9 bit shift to right
 37244 000064E4 88D4                    	mov	ah,dl
 37245 000064E6 88F2                    	mov	dl,dh
 37246 000064E8 30F6                    	xor	dh,dh
 37247 000064EA D1EF                    	shr	di,1
 37248 000064EC 10F6                    	adc	dh,dh
 37249 000064EE 87D7                    	xchg	dx,di		; DI:AX = sector contains requested cluster data
 37250 000064F0 5A                      	pop	dx
 37251 000064F1 81E2FF01                	and	dx,1FFh			; offset in sector
 37252                                  	;;;
 37253                                  %endif
 37254 000064F5 EB07                    	jmp	short DivDone		; 16
 37255                                  
 37256                                  _DoDiv:
 37257                                  ;ENDIF
 37258                                  
 37259                                  ; 02/04/2024
 37260                                  %if 0
 37261                                  	; MSDOS 3.3
 37262                                  	;xor	dx,dx
 37263                                  	; MSDOS 6.0
 37264                                  	mov	dx,di			; 2
 37265                                  	; MSDOS 3.3 (& MSDOS 6.0)	
 37266                                  	DIV	CX			; 155 AX is FAT sector # DX is sector index
 37267                                  %else
 37268                                  	; 02/04/2024 - Retro DOS v5.0
 37269                                  	; (PCDOS 7.1 IBMDOS.COM)
 37270                                  	;;;
 37271 000064F7 97                      	xchg	ax,di
 37272 000064F8 92                      	xchg	ax,dx
 37273 000064F9 F7F1                    	div	cx
 37274 000064FB 97                      	xchg	ax,di
 37275 000064FC F7F1                    	div	cx
 37276                                  	;jmp	short DivDone
 37277                                  	;;;
 37278                                  %endif
 37279                                  
 37280                                  ;IF FastDiv
 37281                                  DivDone:
 37282                                  ;ENDIF
 37283                                  	;add	ax,[es:bp+6]
 37284 000064FE 26034606                	ADD	AX,[ES:BP+DPB.FIRST_FAT]
 37285                                  	
 37286                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37287                                  	;;;
 37288 00006502 83D700                  	adc	di,0
 37289                                  	;;;
 37290                                  
 37291 00006505 49                      	DEC	CX			; CX is sector size - 1
 37292                                  
 37293                                  	;SAVE	<AX,DX,CX>
 37294                                  
 37295                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37296                                  	;;;
 37297 00006506 57                      	push	di ; 4*
 37298                                  	;;;
 37299 00006507 50                      	push	ax ; 3*
 37300 00006508 52                      	push	dx ; 2*
 37301 00006509 51                      	push	cx ; 1*
 37302                                  
 37303 0000650A 89C2                    	MOV	DX,AX
 37304                                  
 37305                                  	; 02/03/2024 - Retro DOS v5.0
 37306                                  	; mov [HIGH_SECTOR],di ; *!* ; PCDOS 7.1 IBMDOS.COM
 37307 0000650C 89FB                    	mov	bx,di
 37308                                  	;
 37309                                  
 37310                                  	; MSDOS 6.0
 37311                                  	; 22/09/2023
 37312                                  	;MOV	word [HIGH_SECTOR],0 ; *! ;F.C. >32mb  low sector #
 37313                                  	;
 37314                                  	; MDOS 3.3 (& MSDOS 6.0)
 37315                                  	;XOR	AL,AL	   ; *
 37316                                  	;MOV	SI,1	   ; *
 37317                                  	;;invoke GETBUFFRB ; *
 37318                                  	;call	GETBUFFRB  ; *
 37319                                  	; 22/09/2023
 37320 0000650E E83D04                  	call	GETBUFFRC  ; *! ; *!* ; 02/03/2024 - Retro DOS v5.0
 37321                                  
 37322                                  	;RESTORE <CX,AX,DX>		; CX is sec siz-1, AX is offset in sec
 37323 00006511 59                      	pop	cx ; 1*
 37324 00006512 58                      	pop	ax ; 2*
 37325 00006513 5A                      	pop	dx ; 3*
 37326                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37327                                  	;;;
 37328 00006514 5B                      	pop	bx ; 4*
 37329                                  	;;;
 37330                                  
 37331 00006515 725A                    	JC	short MAP_POP
 37332                                  
 37333 00006517 C536[E205]              	LDS	SI,[CURBUF]
 37334                                  	;;;lea	di,[si+16]
 37335                                  	;;lea	di,[si+20] ; MSDOS 6.0
 37336                                  	;lea	di,[si+24] ; PCDOS 7.1	; 02/03/2024
 37337 0000651B 8D7C18                  	LEA	DI,[SI+BUFINSIZ]
 37338 0000651E 01C7                    	ADD	DI,AX
 37339 00006520 39C8                    	CMP	AX,CX
 37340 00006522 7530                    	JNZ	short MAPRET	; ds<>ss
 37341 00006524 8A05                    	MOV	AL,[DI]
 37342                                  	;Context DS		 	;hkn; SS is DOSDATA
 37343 00006526 16                      	push	ss
 37344 00006527 1F                      	pop	ds	
 37345 00006528 FE06[7805]              	INC	BYTE [CLUSSPLIT]
 37346 0000652C A2[8E05]                	MOV	[CLUSSAVE],AL
 37347 0000652F 8916[9005]              	MOV	[CLUSSEC],DX
 37348                                  	
 37349                                  	; MSDOS 6.0
 37350                                  	;MOV	WORD [CLUSSEC+2],0      ;F.C. >32mb	;AN000;
 37351                                  	;INC	DX
 37352                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37353                                  	;;;
 37354 00006533 31C0                    	xor     ax,ax ; 0
 37355 00006535 83C201                  	add     dx,1
 37356 00006538 891E[9205]              	mov	word [CLUSSEC+2],bx
 37357 0000653C 11C3                    	adc	bx,ax
 37358                                  	;mov	[HIGH_SECTOR],bx ; *!*
 37359                                  	;;;
 37360                                  
 37361                                  	; 22/09/2023
 37362                                  	;MOV	word [HIGH_SECTOR],0 ; *! ;F.C. >32mb FAT sector <32mb ;AN000;
 37363                                  	;
 37364                                  	; MDOS 3.3 (& MSDOS 6.0)
 37365                                  	;XOR	AL,AL	   ; *
 37366                                  	;MOV	SI,1	   ; *
 37367                                  	;;invoke GETBUFFRB ; *
 37368                                  	;call	GETBUFFRB  ; *
 37369                                  	; 22/09/2023
 37370 0000653E E80D04                  	call	GETBUFFRC  ; *! ; *!* ; 02/03/2024 - Retro DOS v5.0
 37371 00006541 722E                    	JC	short MAP_POP
 37372                                  
 37373 00006543 C536[E205]              	LDS	SI,[CURBUF]
 37374 00006547 8D7C18                  	LEA	DI,[SI+BUFINSIZ]
 37375 0000654A 8A05                    	MOV	AL,[DI]
 37376                                  	;Context DS			;hkn; SS is DOSDATA
 37377 0000654C 16                      	push	ss
 37378 0000654D 1F                      	pop	ds
 37379 0000654E A2[8F05]                	MOV	[CLUSSAVE+1],AL
 37380                                  
 37381                                  ;hkn; CLUSSAVE is in DOSDATA
 37382 00006551 BF[8E05]                	MOV	DI,CLUSSAVE
 37383                                  MAPRET:
 37384                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37385                                  	;;;
 37386 00006554 368F06[E80A]            	pop	word [ss:CLUSTNUM_HW]	; (ds<>ss)
 37387                                  	;;;
 37388                                  	;RESTORE <DX,CX,BX>
 37389 00006559 5A                      	pop	dx
 37390 0000655A 59                      	pop	cx
 37391 0000655B 5B                      	pop	bx
 37392                                  
 37393 0000655C 31C0                    	XOR	AX,AX			; MZ allow shift to clear carry
 37394                                  
 37395                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37396                                  	;;;
 37397 0000655E E822FF                  	call	IsFAT32
 37398 00006561 720A                    	jc	short MapSet	; FAT32 fs
 37399                                  	;;;
 37400                                  
 37401 00006563 26817E0DF60F            	CMP	word [ES:BP+DPB.MAX_CLUSTER],4096-10 ; MZ is this 16-bit fat?
 37402 00006569 7302                    	JAE	short MapSet		; MZ no, set flags
 37403 0000656B 89D8                    	MOV	AX,BX
 37404                                  MapSet:
 37405 0000656D A801                    	TEST	AL,1			; set zero flag if not on boundary
 37406                                  	;RESTORE <AX>
 37407 0000656F 58                      	pop	ax
 37408 00006570 C3                      	retn
 37409                                  
 37410                                  MAP_POP:
 37411                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37412                                  	;;;
 37413                                  	;pop	word [ss:CLUSTNUM_HW]
 37414                                  	; 02/03/2024 - Retro DOS v5.0
 37415 00006571 8F06[E80A]              	pop	word [CLUSTNUM_HW] ; (ds=ss)
 37416                                  	;;;
 37417                                  	;RESTORE <DX,CX,BX,AX>
 37418 00006575 5A                      	pop	dx
 37419 00006576 59                      	pop	cx
 37420 00006577 5B                      	pop	bx
 37421 00006578 58                      	pop	ax
 37422                                  fatread_sft_retn: ; 17/12/2022
 37423 00006579 C3                      	retn
 37424                                  
 37425                                  ; 20/05/2019 - Retro DOS v4.0
 37426                                  ; DOSCODE:96B3h (MSDOS 6.21, MSDOS.SYS)
 37427                                  ; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 37428                                  ; DOSCODE:9657h (MSDOS 5.0, MSDOS.SYS)
 37429                                  
 37430                                  ; 03/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 37431                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A6C6h
 37432                                  
 37433                                  ;Break	<FATREAD_SFT/FATREAD_CDS -- CHECK DRIVE GET FAT>
 37434                                  ;----------------------------------------------------------------------------
 37435                                  ;
 37436                                  ; Procedure Name : FATREAD_SFT
 37437                                  ;
 37438                                  ; Inputs:
 37439                                  ;	ES:DI points to an SFT for the drive of interest (local only,
 37440                                  ;		giving a NET SFT will produce system crashing results).
 37441                                  ;	DS DOSDATA
 37442                                  ; Function:
 37443                                  ;	Can be used by an SFT routine (like CLOSE) to invalidate buffers
 37444                                  ;	if disk changed.
 37445                                  ;	In other respects, same as FATREAD_CDS.
 37446                                  ;	(note ES:DI destroyed!)
 37447                                  ; Outputs:
 37448                                  ;	Carry set if error (currently user FAILed to I 24)
 37449                                  ; NOTE: This routine may cause FATREAD_CDS to "miss" a disk change
 37450                                  ;	as far as invalidating curdir_ID is concerned.
 37451                                  ;	Since getting a true disk changed on this call is a screw up
 37452                                  ;	anyway, that's the way it goes.
 37453                                  ;
 37454                                  ;---------------------------------------------------------------------------
 37455                                  
 37456                                  FATREAD_SFT:
 37457 0000657A 26C46D07                	LES	BP,[ES:DI+SF_ENTRY.sf_devptr]
 37458                                  
 37459                                  fatread_gotdpb:	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37460                                  	; 27/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 37461                                  	;MOV	AL,[ES:BP+DPB.DRIVE] ; [es:bp+0]
 37462                                  	; 15/12/2022
 37463 0000657E 268A4600                	mov	AL,[ES:BP]
 37464 00006582 A2[7605]                	MOV	[THISDRV],AL
 37465 00006585 E8D9A0                  	call	GOTDPB			; Set THISDPB
 37466                                  	;CALL	FAT_GOT_DPB
 37467                                  	; 17/12/2022
 37468 00006588 E99C00                  	jmp	FAT_GOT_DPB
 37469                                  ;fatread_sft_retn:
 37470                                  	;retn
 37471                                  
 37472                                  ;----------------------------------------------------------------------------
 37473                                  ;
 37474                                  ; Procedure Name : FATREAD_CDS
 37475                                  ;
 37476                                  ; Inputs:
 37477                                  ;	DS:DOSDATA
 37478                                  ;	ES:DI points to an CDS for the drive of interest (local only,
 37479                                  ;		giving a NET or NUL CDS will produce system crashing results).
 37480                                  ; Function:
 37481                                  ;	If disk may have been changed, media is determined and buffers are
 37482                                  ;	flagged invalid. If not, no action is taken.
 37483                                  ; Outputs:
 37484                                  ;	ES:BP = Drive parameter block
 37485                                  ;	THISDPB = ES:BP
 37486                                  ;	THISDRV set
 37487                                  ;	Carry set if error (currently user FAILed to I 24)
 37488                                  ; DS preserved , all other registers destroyed
 37489                                  ;
 37490                                  ;---------------------------------------------------------------------------
 37491                                  
 37492                                  	; 20/05/2019 - Retro DOS v4.0
 37493                                  	; DOSCODE:96C5h (MSDOS 6.21, MSDOS.SYS)
 37494                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 37495                                  	; DOSCODE:9669h (MSDOS 5.0, MSDOS.SYS)
 37496                                  
 37497                                  	; 03/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 37498                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A6D8h
 37499                                  	; (Windows ME IO.SYS - BIOSCODE:0C644h)
 37500                                  
 37501                                  FATREAD_CDS:
 37502 0000658B 06                      	PUSH	ES
 37503 0000658C 57                      	PUSH	DI
 37504                                  
 37505                                  	;les	bp,[es:di+45h]
 37506 0000658D 26C46D45                	LES	BP,[ES:DI+curdir.devptr]
 37507                                  
 37508                                  ; 03/03/2024
 37509                                  %if 0
 37510                                  	; 27/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 37511                                  	;MOV	AL,[ES:BP+DPB.DRIVE] ; [es:bp+0]
 37512                                  	; 15/12/2022
 37513                                  	mov	AL,[ES:BP]
 37514                                  	MOV	[THISDRV],AL
 37515                                  	call	GOTDPB			;Set THISDPB
 37516                                  	CALL	FAT_GOT_DPB
 37517                                  %else
 37518                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37519                                  	;;;
 37520 00006591 E8EAFF                  	call	fatread_gotdpb
 37521                                  	;;;
 37522                                  %endif
 37523 00006594 5F                      	POP	DI			;Get back CDS pointer
 37524 00006595 07                      	POP	ES
 37525 00006596 72E1                    	jc	short fatread_sft_retn
 37526 00006598 7542                    	JNZ	short NO_CHANGE		;Media NOT changed
 37527                                  
 37528                                  ;	Media changed. We now need to find all CDS structures which use this
 37529                                  ;	DPB and invalidate their ID pointers.
 37530                                  
 37531                                  MED_CHANGE:
 37532                                  	;XOR	AX,AX
 37533                                  	;DEC	AX			; AX = -1
 37534                                  	; 03/03/2024
 37535 0000659A B8FFFF                  	mov	ax,0FFFFh ; -1
 37536                                  	
 37537 0000659D 1E                      	PUSH	DS
 37538 0000659E 8A0E[4700]              	MOV	CL,[CDSCOUNT]
 37539 000065A2 30ED                    	XOR	CH,CH			; CX is number of structures
 37540                                  	;lds	si,[es:di+45h]
 37541 000065A4 26C57545                	LDS	SI,[ES:DI+curdir.devptr] ; Find all CDS with this devptr
 37542                                  
 37543                                  ;hkn; SS override
 37544                                  
 37545                                  ;	Find all CDSs with this DevPtr
 37546                                  ;
 37547                                  ;	(ax) = -1
 37548                                  ;	(ds:si) = DevPtr
 37549                                  
 37550 000065A8 36C43E[3C00]            	LES	DI,[SS:CDSADDR]		; (es:di) = CDS pointer
 37551                                  frcd20: 
 37552                                  	;;test	word [es:di+43h],8000h
 37553                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
 37554 000065AD 26F6454480              	TEST	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8)
 37555 000065B2 7522                    	JNZ	short frcd25		; Leave NET guys alone!!
 37556                                  
 37557                                  	; MSDOS 3.3
 37558                                  	;push	es
 37559                                  	;push	di
 37560                                  	;les	di,[es:di+45h]
 37561                                  	;;les	di,[ES:DI+curdir.devptr]
 37562                                  	;call	POINTCOMP
 37563                                  	;pop	di
 37564                                  	;pop	es
 37565                                  	;jnz	short frcd25
 37566                                  
 37567                                  	; MSDOS 6.0
 37568 000065B4 263B7545                	cmp	si,[ES:DI+curdir.devptr]
 37569 000065B8 751C                    	jne	short frcd25		; no match
 37570 000065BA 8CDB                    	mov	bx,ds
 37571 000065BC 263B5D47                	cmp	bx,[ES:DI+curdir.devptr+2]
 37572 000065C0 7514                    	jne	short frcd25		; CDS not for this drive
 37573                                  
 37574                                  	; MSDOS 3.3 (& MSDOS 6.0)
 37575                                  	;test	[es:di+49h],ax	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A70Fh
 37576 000065C2 26854549                	test	[ES:DI+curdir.ID],AX
 37577                                  	;JZ	short frcd25 ; = 0	; If root (0), leave root
 37578                                  		; !!! test es:[di+49h],ax
 37579                                  		; !!! jz short frcd25	
 37580                                  		; PCDOS 7.1 IBMDOS.COM bug (!?) ; Erdogan Tan - 03/03/2024
 37581                                  		; test dword ptr es:[di+49h],-1 ; Win ME - BIOSCODE:0C694h
 37582                                  		; jz short frcd25
 37583                                  		;
 37584                                  	; 03/03/2024 - Retro DOS v5.0
 37585 000065C6 7506                    	jnz	short frcd24
 37586                                  
 37587                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37588                                  	;;;
 37589                                  	;test	[es:di+4Bh],ax
 37590 000065C8 2685454B                	test	[es:di+curdir.ID+2],AX
 37591 000065CC 7408                    	jz	short frcd25 ; = 0
 37592                                  frcd24:		; 03/03/2024
 37593                                  	;;;
 37594                                  	;mov	[es:di+49h],ax
 37595 000065CE 26894549                	MOV	[ES:DI+curdir.ID],AX	; else invalid
 37596                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37597                                  	;;;
 37598                                  	;mov	[es:di+4Bh],ax
 37599 000065D2 2689454B                	mov	[es:di+curdir.ID+2],ax ; -1
 37600                                  	;;;
 37601                                  frcd25:	
 37602                                  	;;add	di,81  ; MSDOS 3.3
 37603                                  	;add	di,88  ; MSDOS 6.0	 
 37604 000065D6 83C758                  	ADD	DI,curdir.size		; Point to next CDS
 37605 000065D9 E2D2                    	LOOP	frcd20
 37606 000065DB 1F                      	POP	DS
 37607                                  NO_CHANGE:
 37608 000065DC C42E[8A05]              	LES	BP,[THISDPB]
 37609 000065E0 F8                      	CLC
 37610 000065E1 C3                      	retn
 37611                                  
 37612                                  ; =============== S U B R O U T I N E =======================================
 37613                                  ; 05/01/2024 - Retro DOS 5.0
 37614                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A7Fh
 37615                                  ;;;
 37616                                  chk_set_first_access:
 37617                                  	;cmp	word [es:bp+0Fh],0
 37618 000065E2 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 37619 000065E7 750D                    	jnz	short chk_set_fa_1	; FAT (FAT12 or FAT16)
 37620                                  	; FAT32
 37621                                  	;cmp	word [es:bp+21h],0FFFFh
 37622 000065E9 26837E21FF              	cmp	word [es:bp+DPB.FREE_CNT_HW],0FFFFh ; -1
 37623                                  	;mov	word [es:bp+21h],0FFFFh	; High word of free cluster count
 37624 000065EE 26C74621FFFF            	mov	word [es:bp+DPB.FREE_CNT_HW],0FFFFh ; -1
 37625 000065F4 7505                    	jne	short chk_set_fa_2
 37626                                  chk_set_fa_1:
 37627                                  	;cmp	word [es:bp+1Fh],0FFFFh
 37628 000065F6 26837E1FFF              	cmp	word [es:bp+DPB.FREE_CNT],0FFFFh ; -1
 37629                                  chk_set_fa_2:
 37630                                  	;mov	word [es:bp+1Fh],0FFFFh	; Count of free clusters, -1 if unknown
 37631 000065FB 26C7461FFFFF            	mov	word [es:bp+DPB.FREE_CNT],0FFFFh ; -1
 37632 00006601 7405                    	je	short chk_set_fa_3
 37633                                  	;or	byte [es:bp+18h],1
 37634 00006603 26804E1801              	or	byte [es:bp+DPB.FIRST_ACCESS],1
 37635                                  chk_set_fa_3:
 37636 00006608 C3                      	retn
 37637                                  ;;;
 37638                                  ;----------------------------------------------------------------------------
 37639                                  
 37640                                  
 37641                                  ;Break	<Fat_Operation - miscellaneous fat stuff>
 37642                                  ;----------------------------------------------------------------------------
 37643                                  ;
 37644                                  ; Procedure Name : FAT_operation
 37645                                  ;
 37646                                  ;----------------------------------------------------------------------------
 37647                                  
 37648                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 37649                                  
 37650                                  	; 04/03/2024
 37651                                  	; 03/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 37652                                  
 37653                                  FAT_operation:
 37654                                  	; 31/07/2018 - Retro DOS v3.0
 37655                                  FATERR:
 37656                                  
 37657                                  ; 03/03/2024
 37658                                  %if 0
 37659                                  	;mov	word [es:bp+1Eh],-1
 37660                                  	;mov	word [es:bp+1Fh],-1 ; MSDOS 6.0
 37661                                  	MOV	word [ES:BP+DPB.FREE_CNT],-1 
 37662                                  					; Err in FAT must force recomp of freespace
 37663                                  %else
 37664                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37665                                  	;;;
 37666 00006609 E8D6FF                  	call    chk_set_first_access
 37667                                  	;;;
 37668                                  %endif
 37669                                  	;and	di,0FFh
 37670 0000660C 81E7FF00                	AND	DI,STECODE		; Put error code in DI
 37671                                  	;mov	byte [ALLOWED],18h
 37672 00006610 C606[4B03]18            	MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY
 37673                                  	;mov	ah,1Ah
 37674 00006615 B41A                    	MOV	AH,2+Allowed_FAIL+Allowed_RETRY ; While trying to read FAT
 37675 00006617 A0[7605]                	MOV	AL,[THISDRV]		; Tell which drive
 37676 0000661A E8EFFA                  	call	FATAL1
 37677 0000661D C42E[8A05]              	LES	BP,[THISDPB]
 37678 00006621 3C03                    	CMP	AL,3
 37679 00006623 7502                    	JNZ	short FAT_GOT_DPB	; User said retry
 37680                                  
 37681                                  FATERR_fail:	; 03/03/2024
 37682 00006625 F9                      	STC				; User said FAIL
 37683 00006626 C3                      	retn
 37684                                  
 37685                                  FAT_GOT_DPB:
 37686                                  	;Context DS			;hkn; SS is DOSDATA
 37687 00006627 16                      	push	ss
 37688 00006628 1F                      	pop	ds
 37689                                  
 37690                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37691                                  	;;;
 37692 00006629 8CC0                    	mov	ax,es
 37693 0000662B 09E8                    	or	ax,bp
 37694 0000662D 74F6                    	jz	short FATERR_fail
 37695                                  	;;;
 37696                                  
 37697                                  	;;mov	al,0Fh
 37698                                  	;MOV	AL,DMEDHL
 37699                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37700                                  	;;;
 37701 0000662F B013                    	mov	al,19
 37702                                  	;;;
 37703                                  
 37704                                  	;mov	ah,[es:bp+1]
 37705 00006631 268A6601                	MOV	AH,[ES:BP+DPB.UNIT]
 37706 00006635 A3[5A03]                	MOV	[DEVCALL_REQLEN],AX ; 09/09/2018 
 37707 00006638 C606[5C03]01            	MOV	BYTE [DEVCALL_REQFUNC],DEVMDCH
 37708 0000663D C706[5D03]0000          	MOV	word [DEVCALL_REQSTAT],0
 37709                                  	;;mov	al,[es:bp+16h]
 37710                                  	;mov	al,[es:bp+17h] ; MSDOS 6.0
 37711 00006643 268A4617                	MOV	AL,[ES:BP+DPB.MEDIA]
 37712 00006647 A2[6703]                	MOV	[CALLMED],AL
 37713 0000664A 06                      	PUSH	ES
 37714 0000664B 1E                      	PUSH	DS
 37715                                  
 37716                                  ;hkn; DEVCALL is in DOSDATA
 37717 0000664C BB[5A03]                	MOV	BX,DEVCALL
 37718                                  	;;lds	si,[es:bp+12h]
 37719                                  	;lds	si,[es:bp+13h] ; MSDOS 6.0
 37720 0000664F 26C57613                	LDS	SI,[ES:BP+DPB.DRIVER_ADDR] ; DS:SI Points to device header
 37721 00006653 07                      	POP	ES			; ES:BX Points to call header
 37722 00006654 E860EC                  	call	DEVIOCALL2
 37723                                  	;Context DS		 	;hkn; SS is DOSDATA
 37724 00006657 16                      	push	ss
 37725 00006658 1F                      	pop	ds
 37726 00006659 07                      	POP	ES			; Restore ES:BP
 37727 0000665A 8B3E[5D03]              	MOV	DI,[DEVCALL_REQSTAT]
 37728                                  	;test	di,8000h
 37729                                  	;jnz	short FATERR
 37730 0000665E 09FF                    	or	di,di
 37731 00006660 78A7                    	js	short FATERR		; have error
 37732                                  
 37733                                  ; 03/03/2024
 37734                                  %if 0
 37735                                  	XOR	AH,AH
 37736                                  	;xchg	ah,[es:bp+17h] ; MSDOS 3.3
 37737                                  	;xchg	ah,[es:bp+18h] ; MSDOS 6.0
 37738                                  	XCHG	AH,[ES:BP+DPB.FIRST_ACCESS] ; Reset dpb_first_access
 37739                                  %else
 37740                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37741                                  	;;;
 37742                                  	;mov	ah,[es:bp+18h]
 37743 00006662 268A6618                	mov	ah,[es:bp+DPB.FIRST_ACCESS]
 37744 00006666 80E480                  	and	ah,80h		; izolate (FAT) first access bit
 37745                                  	;and	byte [es:bp+18h],7Fh
 37746 00006669 268066187F              	and	byte [es:bp+DPB.FIRST_ACCESS],7Fh
 37747                                  				; clear first access (FAT) bit 7
 37748                                  	;;; 
 37749                                  %endif
 37750                                  
 37751 0000666E A0[7605]                	MOV	AL,[THISDRV]		; Use physical unit number
 37752                                  ; See if we had changed volume id by creating one on the diskette
 37753 00006671 3806[A10A]              	cmp	[VOLCHNG_FLAG],AL
 37754 00006675 7508                    	jnz	short CHECK_BYT
 37755 00006677 C606[A10A]FF            	mov	byte [VOLCHNG_FLAG],-1 ; 0FFh
 37756 0000667C E9B000                  	jmp	GOGETBPB		; Need to get device driver to read in
 37757                                  					; new volume label.
 37758                                  CHECK_BYT:
 37759 0000667F 0A26[6803]              	OR	AH,[CALLRBYT]
 37760                                  	;JNS	short CHECK_ZR		; ns = 0 or 1
 37761                                  	;JMP	short NEWDSK
 37762                                  	; 17/12/2022
 37763 00006683 785E                    	js	short NEWDSK
 37764                                  	; 27/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 37765                                  	;JNS	short CHECK_ZR		; ns = 0 or 1
 37766                                  	;JMP	short NEWDSK
 37767                                  
 37768                                  CHECK_ZR:
 37769 00006685 743B                    	JZ	short CHKBUFFDIRT	; jump if I don't know
 37770                                  	; 24/09/2023
 37771                                  	; cf=0 (after 'or' instruction)
 37772                                  	;CLC
 37773 00006687 C3                      	retn				; If Media not changed (NZ)
 37774                                  
 37775                                  DISK_CHNG_ERR:
 37776 00006688 06                      	PUSH	ES
 37777 00006689 55                      	PUSH	BP
 37778                                  	;;les	bp,[es:bp+12h]
 37779                                  	;les	bp,[es:bp+13h] ; MSDOS 6.0
 37780 0000668A 26C46E13                	LES	BP,[ES:BP+DPB.DRIVER_ADDR] ; Get device pointer
 37781                                  	;;test	word [es:bp+4],800h
 37782                                  	;TEST	word [ES:BP+SYSDEV.ATT],DEVOPCL ; Did it set vol id?
 37783 0000668E 26F6460508              	test	byte [es:bp+SYSDEV.ATT+1],(DEVOPCL>>8)
 37784 00006693 5D                      	POP	BP
 37785 00006694 07                      	POP	ES
 37786                                  	;JZ	short FAIL_OPJ2		; Nope, FAIL
 37787                                  	; 03/03/2024
 37788 00006695 7477                    	jz	short FAIL_OP
 37789 00006697 1E                      	PUSH	DS			; Save buffer pointer for ignore
 37790 00006698 57                      	PUSH	DI
 37791 00006699 16                      	push	ss			;hkn; SS is DOSDATA
 37792 0000669A 1F                      	pop	ds
 37793                                  	;mov	byte [ALLOWED],18h
 37794 0000669B C606[4B03]18            	MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY
 37795 000066A0 06                      	PUSH	ES
 37796 000066A1 C43E[6903]              	LES	DI,[CALLVIDM]		; Get volume ID pointer
 37797 000066A5 8C06[2A03]              	MOV	[EXTERRPT+2],ES
 37798 000066A9 07                      	POP	ES
 37799 000066AA 893E[2803]              	MOV	[EXTERRPT],DI
 37800                                  	;mov	ax,0Fh
 37801 000066AE B80F00                  	MOV	AX,error_I24_wrong_disk
 37802 000066B1 C606[7505]01            	MOV	byte [READOP],1		; Write
 37803                                  	;invoke	HARDERR
 37804 000066B6 E8C8F9                  	call	HARDERR
 37805 000066B9 5F                      	POP	DI			; Get back buffer for ignore
 37806 000066BA 1F                      	POP	DS
 37807 000066BB 3C03                    	CMP	AL,3
 37808                                  FAIL_OPJ2:
 37809 000066BD 744F                    	JZ	short FAIL_OP
 37810 000066BF E965FF                  	JMP	FAT_GOT_DPB		; Retry
 37811                                  
 37812                                  CHKBUFFDIRT:
 37813                                  	; 20/05/2019 - Retro DOS v4.0
 37814                                  
 37815                                  	; MSDOS 3.3
 37816                                  	;lds	di,[BUFFHEAD]
 37817                                  
 37818                                  	; MSDOS 6.0
 37819                                  	;cmp	word [ss:DirtyBufferCount],0	; any dirty buffers ? ;hkn;
 37820                                  	; 03/03/2024 - Retro DOS v5.0
 37821                                  	; ds=ss
 37822                                  	;;;
 37823 000066C2 833E[7100]00            	cmp	word [DirtyBufferCount],0 ; (Win ME IO.SYS - BIOSCODE:0C7A7h)
 37824                                  	;;;
 37825 000066C7 741A                    	je	short NEWDSK			; no, skip the check
 37826 000066C9 E81D02                  	call	GETCURHEAD			; get pointer to first buffer
 37827                                  nbuffer:
 37828                                  	;cmp	al,[di+4]
 37829 000066CC 384504                  	cmp	[di+BUFFINFO.buf_ID],al	; Unit OK ?
 37830 000066CF 7509                    	jne	short lfnxt			; no, go for next buffer
 37831                                  	;test   byte [di+5],40h
 37832 000066D1 F6450540                	TEST	byte [di+BUFFINFO.buf_flags],buf_dirty	; is the buffer dirty ?
 37833 000066D5 7403                    	jz	short lfnxt			; no, go for next buffer
 37834                                  
 37835                                  FAIL_OP2:	; 03/03/2024
 37836                                  	;Context DS
 37837 000066D7 16                      	push	ss
 37838 000066D8 1F                      	pop	ds
 37839                                  	; 24/09/2023
 37840                                  	; cf=0 (after 'test' instruction)
 37841                                  	;clc
 37842 000066D9 C3                      	retn
 37843                                  
 37844                                  lfnxt:
 37845                                  	; 15/08/2018 - Retro DOS v3.0
 37846                                  	; MSDOS 3.3
 37847                                  	;lds	di,[di]
 37848                                  
 37849                                  	; 20/05/2019 - Retro DOS v4.0
 37850 000066DA 8B3D                    	mov	di,[di]
 37851                                  	;;mov	di,[di+BUFFINFO.buf_next]	; get next buffer
 37852                                  	
 37853                                  	; MSDOS 3.3
 37854                                  	;cmp	di,-1
 37855                                  	;jne	short nbuffer
 37856                                  	
 37857                                  	; MSDOS 6.0
 37858 000066DC 36393E[7E11]            	cmp	[ss:FIRST_BUFF_ADDR],di		; is this where we started ?;hkn;
 37859 000066E1 75E9                    	jne	short nbuffer			; no, check this guy also
 37860                                  
 37861                                  ; If no dirty buffers, assume Media changed
 37862                                  NEWDSK:
 37863                                  	;;mov	word [es:bp+1Eh],0FFFFh  ; MSDOS 3.3
 37864                                  	;mov	word [es:bp+1Fh],0FFFFh  ; MSDOS 6.0
 37865 000066E3 26C7461FFFFF            	mov	word [ES:BP+DPB.FREE_CNT],-1	; Media changed, must
 37866                                  						;  recompute
 37867                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37868                                  	;;;
 37869                                  	;cmp	word [es:bp+0Fh],0
 37870 000066E9 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0 ; = 0 for FAT32 fs
 37871 000066EE 7506                    	jnz	short newdsk2	 ; not FAT32
 37872                                  	;mov	word [es:bp+21h],0FFFFh
 37873 000066F0 26C74621FFFF            	mov	word [ES:BP+DPB.FREE_CNT_HW],0FFFFh ; -1
 37874                                  newdsk2:
 37875                                  	;;;
 37876                                  
 37877                                  	; MSDOS 3.3
 37878                                  	;call	SETVISIT
 37879                                  	; MSDOS 6.0
 37880 000066F6 E8F001                  	call	 GETCURHEAD
 37881                                  nxbuffer:
 37882                                  	; MSDOS 3.3
 37883                                  	;or 	byte [di+5],20h
 37884                                  	; MSDOS 3.3 & MSDOS 6.0
 37885                                  	;cmp	[di+4],al
 37886 000066F9 384504                  	cmp	[DI+BUFFINFO.buf_ID],al		; This drive ?
 37887 000066FC 7513                    	jne	short lfnxt2
 37888                                  	;test	byte [di+5],40h
 37889 000066FE F6450540                	TEST	byte [DI+BUFFINFO.buf_flags],buf_dirty
 37890 00006702 7584                    	jnz	short DISK_CHNG_ERR
 37891                                  	;mov	word [di+4],20FFh
 37892 00006704 C74504FF20              	mov	word [DI+BUFFINFO.buf_ID],(buf_visit*256)+0FFh ; free up
 37893 00006709 E8EF01                  	call	SCANPLACE
 37894                                  	; MSDOS 6.0
 37895 0000670C EB05                    	jmp	short skpbuff
 37896                                  
 37897                                  	; 03/03/2024 - Retro DOS v5.0
 37898                                  FAIL_OP:					; This label & code is here
 37899                                  	;Context DS				;  for reachability
 37900                                  	;push	ss
 37901                                  	;pop	ds
 37902 0000670E F9                      	STC
 37903                                  	; 03/03/2024
 37904                                  	;retn
 37905                                  FAIL_OP2J:	; 03/03/2024
 37906 0000670F EBC6                    	jmp	short FAIL_OP2 ; cf=1
 37907                                  
 37908                                  lfnxt2:
 37909 00006711 8B3D                    	mov	di,[di]
 37910                                  	;mov	di,[di+BUFFINFO.buf_next]
 37911                                  skpbuff:
 37912                                  	; MSDOS 6.0
 37913 00006713 363B3E[7E11]            	cmp	di,[ss:FIRST_BUFF_ADDR]					;hkn;
 37914 00006718 75DF                    	jne	short nxbuffer
 37915                                  
 37916 0000671A 36833E[7700]00          	CMP	word [ss:SC_CACHE_COUNT],0 ;LB.  look ahead buffers ?	;AN001;
 37917 00006720 740D                    	JZ	short GOGETBPB		;LB.  no			;AN001;
 37918 00006722 363A06[7511]            	CMP	AL,[ss:CurSC_DRIVE]	;LB.  same as changed drive	;AN001;
 37919 00006727 7506                    	JNZ	short GOGETBPB		;LB.  no			;AN001;
 37920 00006729 36C606[7511]FF          	MOV	byte [ss:CurSC_DRIVE],-1 ;LB.  invalidate look ahead buffers ;AN000;
 37921                                  ;lfnxt2:
 37922                                  	; MSDOS 3.3
 37923                                  	;call	SKIPVISIT
 37924                                  	;jnz	short nxbuffer
 37925                                  GOGETBPB:
 37926                                  	; MSDOS 3.3 & MSDOS 6.0
 37927                                  	;;lds	di,[es:bp+12h]
 37928                                  	;lds	di,[es:bp+13h] ; MSDOS 6.0	
 37929 0000672F 26C57E13                	LDS	DI,[ES:BP+DPB.DRIVER_ADDR]
 37930                                  	; 20/05/2019
 37931                                  	;test	word [di+4],2000h
 37932                                  	;TEST	word [DI+SYSDEV.ATT],ISFATBYDEV
 37933 00006733 F6450520                	TEST	byte [DI+SYSDEV.ATT+1],(ISFATBYDEV>>8)
 37934 00006737 7533                    	JNZ	short GETFREEBUF
 37935                                  	;context DS	    		;hkn; SS is DOSDATA
 37936 00006739 16                      	push	ss
 37937 0000673A 1F                      	pop	ds
 37938                                  
 37939                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37940                                  	;;;
 37941                                   	;mov	word [es:bp+2],200h
 37942 0000673B 26C746020002            	mov	word [es:bp+DPB.SECTOR_SIZE],512 ; bytes per sector
 37943                                  	;mov	word [es:bp+6],1
 37944 00006741 26C746060100            	mov	word [es:bp+DPB.FIRST_FAT],1	; starting sector of FATs
 37945                                  	;mov	byte [es:bp+8],1
 37946 00006747 26C6460801              	mov	byte [es:bp+DPB.FAT_COUNT],1	; number of FATs
 37947                                  	;mov	word [es:bp+0Dh],3
 37948 0000674C 26C7460D0300            	mov	word [es:bp+DPB.MAX_CLUSTER],3	; cluster count + 1
 37949                                  	;mov	word [es:bp+0Fh],1
 37950 00006752 26C7460F0100            	mov	word [es:bp+DPB.FAT_SIZE],1	; FAT sectors (16 bit)
 37951 00006758 C706[E80A]0000          	mov     word [CLUSTNUM_HW],0	; high word of cluster number (for UNPACK)
 37952                                  	;;;
 37953                                  
 37954 0000675E BB0200                  	MOV	BX,2
 37955 00006761 E8ACFB                  	CALL	UNPACK			; Read the first FAT sector into CURBUF
 37956                                  FAIL_OPJ:
 37957                                  	;JC	short FAIL_OP
 37958                                  	; 03/03/2024
 37959 00006764 72A9                    	jc	short FAIL_OP2J ; cf=1
 37960 00006766 C53E[E205]              	LDS	DI,[CURBUF]
 37961 0000676A EB22                    	JMP	SHORT GOTGETBUF
 37962                                  
 37963                                  GETFREEBUF:
 37964                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37965                                  	;;;
 37966 0000676C 31D2                    	xor	dx,dx ; 0 ; *
 37967 0000676E 36C53E[7A00]            	lds	di,[ss:LoMemBuff]
 37968                                  	;sub	di,24
 37969 00006773 83EF18                  	sub	di,BUFINSIZ
 37970 00006776 363816[7900]            	cmp	[ss:BuffInHMA],dl ; 0
 37971 0000677B 7511                    	jnz	short GOTGETBUF		; buffer is in HMA
 37972                                  					; use [LowMemBuff] to transfer at first
 37973                                  	;;;
 37974                                  
 37975 0000677D 06                      	PUSH	ES			; Get a free buffer for BIOS to use
 37976 0000677E 55                      	PUSH	BP
 37977                                  	; MSDOS 3.3
 37978                                  	;LDS	DI,[SS:BUFFHEAD] ; 15/08/2018
 37979                                  	; 03/03/2024  ; *
 37980                                  	; MSDOS 6.0
 37981                                  	;XOR	DX,DX ; *		;LB.  fake to get 1st	  ;AN000;
 37982                                  ;hkn; SS override
 37983 0000677F 368916[0706]            	MOV	[SS:HIGH_SECTOR],DX ; 0	;LB.  buffer addr	  ;AN000;
 37984 00006784 E86201                  	call	GETCURHEAD		;LB.			  ;AN000;
 37985                                  	; MSDOS 3.3 & MSDOS 6.0
 37986 00006787 E8BF03                  	call	BUFWRITE
 37987 0000678A 5D                      	POP	BP
 37988 0000678B 07                      	POP	ES
 37989                                  	;;JC	short FAIL_OPJ
 37990                                  	;jc	short FAIL_OP
 37991                                  	; 03/03/2024 - Retro DOS v5.0
 37992 0000678C 7281                    	jc	short FAIL_OP2J ; cf=1
 37993                                  
 37994                                  GOTGETBUF:
 37995                                  	;;;add	di,16
 37996                                  	;;add	di,20 ; MSDOS 6.0
 37997                                  	;add	di,24 ; PCDOS 7.1 ; 03/03/2024  
 37998 0000678E 83C718                  	ADD	DI,BUFINSIZ
 37999                                  
 38000                                  ;hkn; SS override
 38001 00006791 368C1E[6A03]            	MOV	[SS:CALLXAD+2],DS
 38002                                  	;Context DS			;hkn; SS is DOSDATA
 38003 00006796 16                      	push	ss
 38004 00006797 1F                      	pop	ds
 38005 00006798 893E[6803]              	MOV	[CALLXAD],DI
 38006                                  	;mov	al,16h
 38007 0000679C B016                    	MOV	AL,DBPBHL ; 22
 38008                                  	;mov	ah,[es:bp+1]
 38009 0000679E 268A6601                	MOV	AH,[ES:BP+DPB.UNIT]
 38010 000067A2 A3[5A03]                	MOV	[DEVCALL_REQLEN],AX ; 09/09/2018
 38011 000067A5 C606[5C03]02            	MOV	BYTE [DEVCALL_REQFUNC],DEVBPB ; 2
 38012 000067AA C706[5D03]0000          	MOV	word [DEVCALL_REQSTAT],0
 38013                                  	;;mov	al,[es:bp+16h]
 38014                                  	;mov	al,[es:bp+17h]
 38015 000067B0 268A4617                	MOV	AL,[ES:BP+DPB.MEDIA]
 38016 000067B4 A2[6703]                	MOV	[CALLMED],AL
 38017 000067B7 06                      	PUSH	ES
 38018 000067B8 1E                      	PUSH	DS
 38019                                  
 38020                                  ; 04/03/2024
 38021                                  %if 0
 38022                                  	;;push	word [es:bp+14h]
 38023                                  	;push	word [es:bp+15h] ; MSDOS 6.0
 38024                                  	PUSH	WORD [ES:BP+DPB.DRIVER_ADDR+2]
 38025                                  	;;push	word [es:bp+12h]
 38026                                  	;push	word [es:bp+13h] ; MSDOS 6.0
 38027                                  	PUSH	WORD [ES:BP+DPB.DRIVER_ADDR]
 38028                                  
 38029                                  ;hkn; DEVCALL is in DOSDATA
 38030                                  	MOV	BX,DEVCALL
 38031                                  	POP	SI
 38032                                  	POP	DS			; DS:SI Points to device header
 38033                                  %else
 38034                                  	; 04/03/2024 - Retro DOS v5.0
 38035                                  	; PCDOS 7.1 IBMDOS.COM
 38036 000067B9 BB[5A03]                	mov	bx,DEVCALL
 38037                                  	;lds	si,[es:bp+13h]
 38038 000067BC 26C57613                	lds	si,[es:bp+DPB.DRIVER_ADDR] ; DS:SI Points to device header
 38039                                  %endif
 38040                                  
 38041 000067C0 07                      	POP	ES			; ES:BX Points to call header
 38042                                  	;invoke	DEVIOCALL2
 38043 000067C1 E8F3EA                  	call	DEVIOCALL2
 38044 000067C4 07                      	POP	ES			; Restore ES:BP
 38045                                  	;Context DS
 38046 000067C5 16                      	push	ss		 	;hkn; SS is DOSDATA
 38047 000067C6 1F                      	pop	ds
 38048 000067C7 8B3E[5D03]              	MOV	DI,[DEVCALL_REQSTAT]
 38049                                  
 38050                                  ; 04/03/2024
 38051                                  %if 0
 38052                                  	; MSDOS 3.3
 38053                                  	;test	di,8000h
 38054                                  	;jnz	short FATERRJ
 38055                                  	; MSDOS 6.0
 38056                                  	or	di,di
 38057                                  	js	short FATERRJ 		; have error
 38058                                  
 38059                                  	; 04/03/2024
 38060                                  	;;;mov	al,[es:bp+16h]
 38061                                  	;;mov	al,[es:bp+17h]  ; MSDOS 6.0
 38062                                  	;MOV	AL,[ES:BP+DPB.MEDIA]
 38063                                  
 38064                                  	LDS	SI,[CALLBPB]
 38065                                  	;;mov	word [es:bp+1Ch],0
 38066                                  	;mov	word [es:bp+1Dh],0 ; MSDOS 6.0
 38067                                  	MOV	word [ES:BP+DPB.NEXT_FREE],0 ; recycle scanning pointer
 38068                                  
 38069                                  	;invoke	$SETDPB
 38070                                  	call	_$SETDPB
 38071                                  
 38072                                  ;hkn; SS override
 38073                                  	LDS	DI,[SS:CALLXAD]		; Get back buffer pointer
 38074                                  	
 38075                                  	;mov	al,[es:bp+8]
 38076                                  	MOV	AL,[ES:BP+DPB.FAT_COUNT]
 38077                                  
 38078                                  	; MSDOS 3.3
 38079                                  	;;mov	ah,[es:bp+0Fh]
 38080                                  	;MOV	AH,[ES:BP+DPB.FAT_SIZE]
 38081                                  	;;mov	[DI-8],ax
 38082                                  	;MOV	[DI+BUFFINFO.buf_wrtcnt-BUFINSIZ],AX
 38083                                  
 38084                                  	; MSDOS 6.0
 38085                                  	;mov	[di-0Ah],al
 38086                                  	MOV	[DI+BUFFINFO.buf_wrtcnt-BUFINSIZ],AL 
 38087                                  						;>32mb		;AN000;
 38088                                  	;mov	ax,[es:bp+0Fh]
 38089                                  	MOV	AX,[ES:BP+DPB.FAT_SIZE]		;>32mb
 38090                                  	;mov	[di-09h],ax					;AC000;
 38091                                  	MOV	[DI+BUFFINFO.buf_wrtcntinc-BUFINSIZ],AX 
 38092                                  					;>32mb Correct buffer info ;AC000;
 38093                                  	;Context DS			;hkn; SS is DOSDATA
 38094                                  	push	ss
 38095                                  	pop	ds
 38096                                  	XOR	AL,AL			;Media changed (Z), Carry clear
 38097                                  	retn
 38098                                  
 38099                                  FATERRJ: 
 38100                                  	JMP	FATERR
 38101                                  
 38102                                  %else
 38103                                  	; 04/03/2024 - Retro DOS v5.0
 38104                                  	; PCDOS 7.1 IBMDOS.COM
 38105                                  	;;;
 38106 000067CB 09FF                    	or	di,di
 38107 000067CD 790C                    	jns	short gotgetbuf2
 38108                                  	; error
 38109 000067CF C53E[6803]              	lds     di,[CALLXAD] ; Buffer (data) address
 38110                                  	;mov	word [di-20],0FFh 
 38111 000067D3 C745ECFF00              	mov	word [di+BUFFINFO.buf_ID-BUFINSIZ],0FFh
 38112                                  				; byte BUFFINFO.buf_ID = 0FFh ; FREE
 38113                                  				; byte BUFFINFO.buf_flags = 0
 38114 000067D8 E92EFE                  	jmp	FATERR
 38115                                  	
 38116                                  gotgetbuf2:
 38117 000067DB C536[6C03]              	lds	si,[CALLBPB]	; Address of the BPB (DEVCALL offset 18)
 38118                                  
 38119 000067DF 31C9                    	xor	cx,cx	; 0
 38120 000067E1 26894E1D                	mov	[es:bp+1Dh],cx	; [ES:BP+DPB.NEXT_FREE] = 0
 38121                                  				; recycle scanning pointer
 38122                                  
 38123 000067E5 BA5241                  	mov	dx,4152h	; 'RA' ; FAT32 extended BPB/DPB signature
 38124                                  
 38125                                  	;cmp	[si+0Bh],cx	; BPB.fatsecs ; 16 bit FAT size = 0 for FAT32 fs
 38126 000067E8 394C0B                  	cmp	[si+A_BPB.SECTORSPERFAT],cx ; 0
 38127 000067EB 7514                    	jnz	short gotgetbuf3 ; not FAT32
 38128                                  
 38129                                  	;mov	[es:bp+39h],cx
 38130 000067ED 26894E39                	mov	[es:bp+DPB.FAT32_NXTFREE],cx ; 0
 38131                                  	;mov	[es:bp+3Bh],cx
 38132 000067F1 26894E3B                	mov	[es:bp+DPB.FAT32_NXTFREE+2],cx ; 0
 38133 000067F5 49                      	dec	cx	; -1
 38134                                  	;mov	[es:bp+1Fh],cx	; (DPB.FREE_CNT) set free count to -1 (unknown)
 38135 000067F6 26894E1F                	mov	[es:bp+DPB.FREE_CNT],cx ; 0FFFFh
 38136                                  	;mov	[es:bp+21h],cx
 38137 000067FA 26894E21                	mov	[es:bp+DPB.FREE_CNT_HW],cx ; 0FFFFh
 38138                                  	;
 38139 000067FE B95845                  	mov	cx,4558h	; 'XE' ; FAT32 extended BPB/DPB signature
 38140                                  gotgetbuf3:
 38141                                  
 38142                                  	;invoke	$SETDPB
 38143 00006801 E857AC                  	call	_$SETDPB
 38144                                  
 38145                                  ;hkn; SS override
 38146 00006804 36C53E[6803]            	LDS	DI,[SS:CALLXAD]		; Get back buffer pointer
 38147                                  	
 38148                                  	;mov	dx,[es:bp+25h]
 38149 00006809 268B5625                	mov	dx,[es:bp+DPB.FSINFO_SECTOR]
 38150 0000680D 31C9                    	xor	cx,cx	; 0
 38151                                  	;cmp	[es:bp+0Fh],cx
 38152 0000680F 26394E0F                	cmp	[es:bp+DPB.FAT_SIZE],cx	; 16 bit FAT size field
 38153 00006813 7403                    	jz	short gotgetbuf4 ; FAT32 fs
 38154 00006815 E99400                  	jmp	gotgetbuf12	; FAT fs
 38155                                  
 38156                                  gotgetbuf4:
 38157 00006818 83FAFF                  	cmp	dx,0FFFFh		; invalid ?
 38158 0000681B 7503                    	jnz	short gotgetbuf5	; no
 38159 0000681D E98C00                  	jmp	gotgetbuf12		; skip reading FSINFO sector
 38160                                  
 38161                                  gotgetbuf5:
 38162 00006820 36890E[0706]            	mov	[ss:HIGH_SECTOR],cx ; 0
 38163 00006825 89FB                    	mov	bx,di
 38164                                  
 38165                                  	;cmp	byte [ss:BuffInHMA],0
 38166 00006827 36380E[7900]            	cmp	[ss:BuffInHMA],cl ; 0
 38167 0000682C 7405                    	jz	short gotgetbuf6	; buffer is in conventional (<=640KB) memory
 38168 0000682E 36C51E[7A00]            	lds	bx,[ss:LoMemBuff]	; use a buffer in conventional memory
 38169                                  	;mov	di,bx
 38170                                  gotgetbuf6:
 38171 00006833 36C606[4B03]18          	mov	byte [ss:ALLOWED],Allowed_FAIL+Allowed_RETRY ; 18h
 38172 00006839 41                      	inc	cx
 38173                                  	;push	di
 38174 0000683A 53                      	push	bx
 38175 0000683B E8B5D7                  	call	DREAD
 38176 0000683E 5B                      	pop	bx
 38177                                  	;pop	di
 38178 0000683F 89DF                    	mov	di,bx ; Retro DOS v5.0
 38179 00006841 725F                    	jc	short gotgetbuf11	; ds:di = (FSINFO sector) buffer
 38180                                  
 38181                                  	; FSI_HeadSig = 41615252h
 38182                                  
 38183 00006843 813D5252                	cmp	word [di],5252h		; 'RR' ; check if it is a valid FSINFO sector
 38184                                  	;cmp	word [di+FSINFO.LeadSig],5252
 38185 00006847 7559                    	jnz	short gotgetbuf11	; not valid
 38186                                  	;cmp	word [di+2],4161h	; 'aA' ; (NASM syntax)
 38187 00006849 817D026141              	cmp	word [di+FSINFO.LeadSig+2],4161h
 38188 0000684E 7552                    	jnz	short gotgetbuf11
 38189                                  	;cmp	word [di+484],7272h	; 'rr' ; FSI_StrucSig = 61417272h
 38190 00006850 81BDE4017272            	cmp	word [di+FSINFO.StrucSig],7272h
 38191 00006856 754A                    	jnz	short gotgetbuf11
 38192                                  	;cmp	word [di+486],6141h	; 'Aa'
 38193 00006858 81BDE6014161            	cmp	word [di+FSINFO.StrucSig+2],6141h
 38194 0000685E 7542                    	jnz	short gotgetbuf11	; not valid
 38195                                  
 38196                                  	; valid
 38197 00006860 52                      	push	dx
 38198 00006861 53                      	push	bx
 38199 00006862 51                      	push	cx
 38200                                  
 38201                                  	;mov	bx,[es:bp+2Fh]
 38202 00006863 268B5E2F                	mov	bx,[es:bp+DPB.LAST_CLUSTER+2]
 38203                                  	;mov	cx,[es:bp+2Dh]
 38204 00006867 268B4E2D                	mov	cx,[es:bp+DPB.LAST_CLUSTER]
 38205                                  
 38206                                  	;mov	ax,[di+488]		; FSI_FreeCount ; bx:cx = number of clusters + 1
 38207 0000686B 8B85E801                	mov	ax,[di+FSINFO.Free_Count]
 38208                                  	;mov	dx,[di+490]		; FSI_FreeCount+2
 38209 0000686F 8B95EA01                	mov	dx,[di+FSINFO.Free_Count+2]
 38210                                  
 38211 00006873 39DA                    	cmp	dx,bx			; is Free Count >= (Number of Clusters + 1) ?
 38212 00006875 7502                    	jne	short gotgetbuf7	; if yes, it is invalid value (must be 0FFFFFFFFh)
 38213 00006877 39C8                    	cmp	ax,cx
 38214                                  gotgetbuf7:
 38215 00006879 7308                    	jnb	short gotgetbuf8	; yes, invalid value (must be 0FFFFFFFFh)
 38216                                  	
 38217                                  	;mov	[es:bp+1Fh],ax		; no,valid free count
 38218 0000687B 2689461F                	mov	[es:bp+DPB.FREE_CNT],ax ; save free count into [es:bp+DPB.FREE_CNT]
 38219                                  	;mov	[es:bp+21h],dx
 38220 0000687F 26895621                	mov	[es:bp+DPB.FREE_CNT+2],dx
 38221                                  
 38222                                  gotgetbuf8:
 38223                                  	;mov	ax,[di+492]		; FSI_Nxt_Free
 38224 00006883 8B85EC01                	mov	ax,[di+FSINFO.Nxt_Free]
 38225                                  	;mov	dx,[di+494]
 38226 00006887 8B95EE01                	mov	dx,[di+FSINFO.Nxt_Free+2]
 38227                                  
 38228 0000688B 39DA                    	cmp	dx,bx			; is the next free clust num >= (num of clusters + 1) ?
 38229 0000688D 7502                    	jne	short gotgetbuf9	; invalid (if dx > bx)
 38230 0000688F 39C8                    	cmp	ax,cx
 38231                                  gotgetbuf9:
 38232 00006891 730C                    	jnb	short gotgetbuf10 ; invalid
 38233                                  
 38234                                  	;mov	[es:bp+39h],ax		; save next free (search) cluster number
 38235 00006893 26894639                	mov	[es:bp+DPB.FAT32_NXTFREE],ax ; into [es:bp+DPB.FAT32_NXTFREE]
 38236                                  	;mov	[es:bp+3Bh],dx
 38237 00006897 2689563B                	mov	[es:bp+DPB.FAT32_NXTFREE+2],dx
 38238                                  	;mov	[es:bp+1Dh],ax		; and into [es:bp+DPB.NEXT_FREE] ; low word
 38239 0000689B 2689461D                	mov	[es:bp+DPB.NEXT_FREE],ax
 38240                                  
 38241                                  gotgetbuf10:
 38242 0000689F 59                      	pop	cx
 38243 000068A0 5B                      	pop	bx
 38244 000068A1 5A                      	pop	dx
 38245                                  
 38246                                  gotgetbuf11:
 38247 000068A2 36803E[7900]00          	cmp	byte [ss:BuffInHMA],0	; is buffer in HMA ?
 38248                                  	;jnz	short gotgetbuf12	; yes
 38249 000068A8 753A                    	jnz	short gotgetbuf16 ; 04/03/2024
 38250                                  
 38251                                  	;mov	word [di-20],0FFh	; invalidate buffer (set it as free buffer)
 38252                                  	; 04/03/2024 - Retro DOS v5.0
 38253 000068AA EB0F                    	jmp	short gotgetbuf17
 38254                                  
 38255                                  gotgetbuf12:
 38256 000068AC 36803E[7900]00          	cmp	byte [ss:BuffInHMA],0
 38257 000068B2 7530                    	jnz	short gotgetbuf16
 38258                                  
 38259                                  	;cmp	word [es:bp+6],1
 38260 000068B4 26837E0601              	cmp	word [es:bp+DPB.FIRST_FAT],1 ; 1st FAT start sector
 38261 000068B9 7405                    	jz	short gotgetbuf13
 38262                                  
 38263                                  gotgetbuf17:	; 04/03/2024
 38264                                  	;mov	word [di-20],0FFh	; invalidate buffer (set it as free buffer)
 38265                                  			  		; di = buffer header + 4 (BUFINFO.buf_ID)
 38266 000068BB C745ECFF00              	mov	word [di+BUFFINFO.buf_ID-BUFINSIZ],0FFh
 38267                                  
 38268                                  gotgetbuf13:
 38269                                  	;mov	al,[es:bp+8]
 38270 000068C0 268A4608                	mov	al,[es:bp+DPB.FAT_COUNT]
 38271                                  	;mov	[di-14],al		; buffer header address + 10
 38272 000068C4 8845F2                  	mov	[di+BUFFINFO.buf_wrtcnt-BUFINSIZ],al
 38273                                  
 38274                                  	;mov	ax,[es:bp+0Fh]
 38275 000068C7 268B460F                	mov	ax,[es:bp+DPB.FAT_SIZE]	; 16 bit FAT size field
 38276 000068CB 09C0                    	or	ax,ax
 38277 000068CD 750D                    	jnz	short gotgetbuf14 ; FAT (FAT12 or FAT16) fs
 38278                                  	
 38279                                  	; FAT32 fs
 38280                                  	;mov	ax,[es:bp+31h]		; FAT sectors (per one FAT)
 38281 000068CF 268B4631                	mov	ax,[es:bp+DPB.FAT32_SIZE] 
 38282                                  	;mov	[di-13],ax 	; BUFFINFO.buf_wrtcntinc ; # sectors between each write
 38283 000068D3 8945F3                  	mov	[di+BUFFINFO.buf_wrtcntinc-BUFINSIZ],ax
 38284                                  	;mov	ax,[es:bp+33h]
 38285 000068D6 268B4633                	mov	ax,[es:bp+DPB.FAT32_SIZE+2]
 38286 000068DA EB05                    	jmp	short gotgetbuf15
 38287                                  
 38288                                  gotgetbuf14:
 38289                                  	;mov	[di-13],ax		; BUFFINFO.buf_wrtcntinc
 38290 000068DC 8945F3                  	mov	[di+BUFFINFO.buf_wrtcntinc-BUFINSIZ],ax
 38291                                  
 38292                                  	;xor	ax,ax			; 0
 38293 000068DF 29C0                    	sub	ax,ax ; 0
 38294                                  
 38295                                  gotgetbuf15:
 38296                                  	;;mov	[di-15],ax		; BUFFINFO.buf_wrtcntinc+2 ; hw of sectors per FAT
 38297                                  					; PCDOS 7.1 BUG !? This would be 'mov [di-11],ax'
 38298                                  					; Erdogan Tan - 03/03/2024
 38299                                  	;mov	[di-11],ax
 38300 000068E1 8945F5                  	mov	[di+BUFFINFO.buf_wrtcntinc+2-BUFINSIZ],ax
 38301                                  
 38302                                  gotgetbuf16:
 38303                                  	;mov	ax,ss			; SS is DOSDATA
 38304                                  	;mov	ds,ax
 38305 000068E4 16                      	push	ss
 38306 000068E5 1F                      	pop	ds
 38307                                  	;xor	al,al			; Media changed (Z),Carry clear
 38308 000068E6 31C0                    	xor	ax,ax
 38309 000068E8 C3                      	retn
 38310                                  
 38311                                  	;;;
 38312                                  %endif
 38313                                  
 38314                                  ;============================================================================
 38315                                  ; STDBUF.ASM
 38316                                  ;============================================================================
 38317                                  ; Retro DOS v2.0 - 12/03/2018
 38318                                  
 38319                                  ;
 38320                                  ; Standard buffer management for MSDOS
 38321                                  ;
 38322                                  
 38323                                  ;.xlist
 38324                                  ;.xcref
 38325                                  ;INCLUDE STDSW.ASM
 38326                                  ;.cref
 38327                                  ;.list
 38328                                  
 38329                                  ;TITLE	STDBUF - MSDOS buffer management
 38330                                  ;NAME	STDBUF
 38331                                  
 38332                                  ;INCLUDE BUF.ASM
 38333                                  
 38334                                  ;============================================================================
 38335                                  ; BUF.ASM
 38336                                  ;============================================================================
 38337                                  ; 31/07/2018 - Retro DOS v3.0
 38338                                  ; Retro DOS v2.0 - 12/03/2018
 38339                                  ;
 38340                                  ; buffer management for MSDOS
 38341                                  ;
 38342                                  ;CODE	SEGMENT BYTE PUBLIC  'CODE'
 38343                                  ;       ASSUME  SS:DOSGROUP,CS:DOSGROUP
 38344                                  ;
 38345                                  ;SUBTTL SETVISIT,SKIPVISIT -- MANAGE BUFFER SCANS
 38346                                  ;
 38347                                  ;SETVISIT:
 38348                                  ;	; 31/07/2018 - Retro DOS v3.0
 38349                                  ;	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5CAFh
 38350                                  ;; Inputs:
 38351                                  ;;      None
 38352                                  ;; Function:
 38353                                  ;;      Set up a scan of I/O buffers
 38354                                  ;; Outputs:
 38355                                  ;;      All visit flags = 0
 38356                                  ;;              NOTE: This pre-scan is needed because a hard disk error
 38357                                  ;;                    may cause a scan to stop in the middle leaving some
 38358                                  ;;                    visit flags set, and some not set.
 38359                                  ;;      DS:DI Points to [BUFFHEAD]
 38360                                  ;; No other registers altered
 38361                                  ;
 38362                                  ;       LDS     DI,[SS:BUFFHEAD] ; 15/03/2018
 38363                                  ;	PUSH    AX
 38364                                  ;       ;;XOR	AX,AX	  ;; MSDOS 2.11
 38365                                  ;	;mov	al,0DFh
 38366                                  ;	mov	al,~buf_visit
 38367                                  ;SETLOOP:
 38368                                  ;       ;;MOV	[DI+7],AL ;; MSDOS 2.11
 38369                                  ;	;and	[DI+5],al
 38370                                  ;	AND	[DI+BUFFINFO.buf_flags],AL
 38371                                  ;       LDS     DI,[DI]
 38372                                  ;       CMP     DI,-1
 38373                                  ;       JNZ     SHORT SETLOOP
 38374                                  ;       POP     AX ; 09/09/2018
 38375                                  ;	LDS     DI,[SS:BUFFHEAD] ; 15/03/2018
 38376                                  ;SVISIT_RETN:
 38377                                  ;       RETN
 38378                                  ;
 38379                                  ;SKIPVISIT:
 38380                                  ;	; 31/07/2018 - Retro DOS v3.0
 38381                                  ;	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5CC8h
 38382                                  ;
 38383                                  ;; Inputs:
 38384                                  ;;      DS:DI Points to a buffer
 38385                                  ;; Function:
 38386                                  ;;      Skip visited buffers
 38387                                  ;; Outputs:
 38388                                  ;;      DS:DI Points to next unvisited buffer
 38389                                  ;;      Zero is set if skip to LAST buffer
 38390                                  ;; No other registers altered
 38391                                  ;
 38392                                  ;       CMP     DI,-1
 38393                                  ;       ;retz
 38394                                  ;       JZ	SHORT SVISIT_RETN
 38395                                  ;
 38396                                  ;	;;CMP	BYTE [DI+7],1 ;; MSDOS 2.11
 38397                                  ;       ;;;retnz
 38398                                  ;       ;;JNZ	SHORT SVISIT_RETN
 38399                                  ;
 38400                                  ;	;test	byte [di+5],20h
 38401                                  ;	TEST	byte [DI+BUFFINFO.buf_flags],buf_visit	
 38402                                  ;	JNZ	short SKIPLOOP
 38403                                  ;	
 38404                                  ;	push	ax
 38405                                  ;	or	al,1
 38406                                  ;	pop	ax
 38407                                  ;	retn	
 38408                                  ;
 38409                                  ;SKIPLOOP:
 38410                                  ;	LDS     DI,[DI]
 38411                                  ;       JMP     SHORT SKIPVISIT
 38412                                  
 38413                                  ;============================================================================
 38414                                  ; BUF.ASM, MSDOS 6.0, 1991
 38415                                  ;============================================================================
 38416                                  ; 31/07/2018 - Retro DOS v3.0
 38417                                  ; 04/05/2019 - Retro DOS v4.0
 38418                                  ; 06/03/2024 - Retro DOS v5.0
 38419                                  
 38420                                  ;	TITLE	BUF - MSDOS buffer management
 38421                                  ;	NAME	BUF
 38422                                  
 38423                                  ;**	BUF.ASM - Low level routines for buffer cache management
 38424                                  ;
 38425                                  ;	GETCURHEAD
 38426                                  ;	ScanPlace
 38427                                  ;	PLACEBUF
 38428                                  ;	PLACEHEAD
 38429                                  ;	PointComp
 38430                                  ;	GETBUFFR
 38431                                  ;	GETBUFFRB
 38432                                  ;	FlushBuf
 38433                                  ;	BufWrite
 38434                                  ;	SET_RQ_SC_PARMS
 38435                                  ;
 38436                                  ;	Revision history:
 38437                                  ;
 38438                                  ;		AN000  version 4.00  Jan. 1988
 38439                                  ;		A004   PTM 3765 -- Disk reset failed
 38440                                  ;		M039 DB 10/17/90 - Disk write optimization
 38441                                  ;		I001   5.0 PTR 722211 - Preserve CY when in buffer in HMA
 38442                                  
 38443                                  ;Break	<GETCURHEAD -- Get current buffer header>
 38444                                  ;----------------------------------------------------------------------------
 38445                                  ; Procedure Name : GetCurHead
 38446                                  ; Inputs:
 38447                                  ;	 No Inputs
 38448                                  ; Function:
 38449                                  ;	Returns the pointer to the first buffer in Queue
 38450                                  ;	and updates FIRST_BUFF_ADDR
 38451                                  ;       and invalidates LASTBUFFER (recency pointer)
 38452                                  ; Outputs:
 38453                                  ;	DS:DI = pointer to the first buffer in Queue
 38454                                  ;	FIRST_BUFF_ADDR = offset ( DI ) of First buffer in Queue
 38455                                  ;       LASTBUFFER = -1
 38456                                  ; No other registers altered
 38457                                  ;----------------------------------------------------------------------------
 38458                                  
 38459                                  ; 04/05/2019 - Retro DOS v4.0
 38460                                  ; DOSCODE:98D2h (MSDOS 6.21, MSDOS.SYS)
 38461                                  ; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 38462                                  ; DOSCODE:9876h (MSDOS 5.0, MSDOS.SYS)
 38463                                  
 38464                                  ; 06/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 38465                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0AA4Bh
 38466                                  
 38467                                  GETCURHEAD:
 38468 000068E9 36C53E[6D00]            	lds	di,[ss:BufferQueue]	; Pointer to the first buffer
 38469 000068EE 36C706[1E00]FFFF        	mov	word [ss:LastBuffer],-1	; invalidate last buffer
 38470 000068F5 36893E[7E11]            	mov	[ss:FIRST_BUFF_ADDR],di	; save first buffer address
 38471 000068FA C3                      	retn
 38472                                  
 38473                                  ;Break	<SCANPLACE, PLACEBUF -- PUT A BUFFER BACK IN THE POOL>
 38474                                  ;----------------------------------------------------------------------------
 38475                                  ; Procedure Name : ScanPlace
 38476                                  ; Inputs:
 38477                                  ;	Same as PLACEBUF
 38478                                  ; Function:
 38479                                  ;	Save scan location and call PLACEBUF
 38480                                  ; Outputs:
 38481                                  ;	DS:DI Points to saved scan location
 38482                                  ; All registers, except DS:DI, preserved.
 38483                                  ;----------------------------------------------------------------------------
 38484                                  ;M039: Rewritten to preserve registers.
 38485                                  
 38486                                  ;SCANPLACE:
 38487                                  ;	; 31/07/2018 - Retro DOS v3.0
 38488                                  ;	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5DDCh
 38489                                  ;	push	es
 38490                                  ;	les	si,[di]
 38491                                  ;	;les	si,[DI+BUFFINFO.buf_link]
 38492                                  ;	call	PLACEBUF
 38493                                  ;	push	es
 38494                                  ;	pop	ds
 38495                                  ;	mov	di,si
 38496                                  ;	pop	es
 38497                                  ;scanplace_retn:
 38498                                  ;	retn	
 38499                                  	
 38500                                  	; MSDOS 6.0
 38501                                  SCANPLACE:
 38502 000068FB FF35                    	push	word [di]
 38503                                  	;push	word [di+BUFFINFO.buf_next] ;Save scan location
 38504 000068FD E80200                  	call	PLACEBUF
 38505 00006900 5F                      	pop	di
 38506 00006901 C3                      	retn
 38507                                  
 38508                                  ;----------------------------------------------------------------------------
 38509                                  ; Procedure Name : PlaceBuf
 38510                                  ; Input:
 38511                                  ;	DS:DI points to buffer (DS->BUFFINFO array, DI=offset in array)
 38512                                  ; Function:
 38513                                  ;	Remove buffer from queue and re-insert it in proper place.
 38514                                  ; NO registers altered
 38515                                  ;----------------------------------------------------------------------------
 38516                                  
 38517                                  ;procedure PLACEBUF,NEAR
 38518                                  
 38519                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 38520                                  	; 20/05/2019 - Retro DOS v4.0
 38521                                  PLACEBUF:
 38522                                  	; 31/07/2018 - Retro DOS v3.0
 38523                                  
 38524                                  	; MSDOS 6.0
 38525 00006902 50                      	push	AX			;Save only regs we modify	;AN000;
 38526 00006903 53                      	push	BX							;AN000;
 38527                                  	; 23/09/2023
 38528                                  	;push	SI							;AN000;
 38529                                  	
 38530 00006904 8B05                    	mov	ax,[di]
 38531                                  	;mov	ax,[di+BUFFINFO.buf_next]
 38532 00006906 368B1E[6D00]            	mov	bx,[ss:BufferQueue]	; bx = offset of head of list;smr;SS Override
 38533                                  	
 38534 0000690B 39D8                    	cmp	ax,bx				;Buf = last?		;AN000;
 38535 0000690D 7422                    	je	short nret			;Yes, special case	;AN000;
 38536 0000690F 39DF                    	cmp	di,bx				;Buf = first?		;AN000;
 38537 00006911 7506                    	jne	short not_first 		;Yes, special case	;AN000;
 38538 00006913 36A3[6D00]              	mov	[ss:BufferQueue],ax		;smr;SS Override
 38539 00006917 EB18                    	jmp	short nret 			;Continue with repositioning;AN000;
 38540                                  not_first:
 38541                                  	; 23/09/2023
 38542 00006919 56                      	push	si
 38543                                  	;mov	si,[di+2]
 38544 0000691A 8B7502                  	mov	SI,[DI+BUFFINFO.buf_prev]	;No, SI = prior Buf	;AN000;
 38545 0000691D 8904                    	mov	[si],ax
 38546                                  	;mov	[SI+BUFFINFO.buf_next],AX	; ax has di->buf_next	;AN000;
 38547 0000691F 96                      	xchg	si,ax
 38548                                  	;mov	[si+2],ax
 38549 00006920 894402                  	mov	[SI+BUFFINFO.buf_prev],AX	;			;AN000;
 38550                                  	
 38551 00006923 8B7702                  	mov	SI,[BX+BUFFINFO.buf_prev]	;SI-> last buffer	;AN000;
 38552 00006926 893C                    	mov	[si],di
 38553                                  	;mov	[SI+BUFFINFO.buf_next],DI	;Add Buf to end of list ;AN000;
 38554 00006928 897F02                  	mov	[BX+BUFFINFO.buf_prev],DI				;AN000;
 38555 0000692B 897502                  	mov	[DI+BUFFINFO.buf_prev],SI	;Update link in Buf too	;AN000;
 38556 0000692E 891D                    	mov	[di],bx
 38557                                  	;mov	[DI+BUFFINFO.buf_next],BX				;AN000;
 38558                                  	; 23/09/2023
 38559 00006930 5E                      	pop	si
 38560                                  nret:	
 38561                                  	; 23/09/2023							;AN000;
 38562                                  	;pop	SI							;AN000;
 38563 00006931 5B                      	pop	BX							;AN000;
 38564 00006932 58                      	pop	AX							;AN000;
 38565                                  									;AN000;
 38566                                  	;cmp	byte [di+4],0FFh
 38567 00006933 807D04FF                	cmp	byte [di+BUFFINFO.buf_ID],-1	; Buffer FREE?		;AN000;
 38568 00006937 7505                            jne	short pbx			; M039: -no, jump.
 38569 00006939 36893E[6D00]            	mov	[ss:BufferQueue],di		; M039: -yes, make it LRU.
 38570                                  pbx:	
 38571 0000693E C3                      	retn								;AN000;
 38572                                  
 38573                                  	; 31/07/2018 - Retro DOS v3.0
 38574                                  
 38575                                  	; MSDOS 3.3
 38576                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5DDCh
 38577                                  
 38578                                  ;PLACEBUF:
 38579                                  ;	; 15/03/2018 - Retro DOS v2.0 (MSDOS 2.11)
 38580                                  ;	
 38581                                  ;       CALL	save_world
 38582                                  ;       LES     CX,[DI]
 38583                                  ;       CMP     CX,-1           	; Buf is LAST?
 38584                                  ;       JZ      SHORT NRET		; Buffer already last
 38585                                  ;       MOV     BP,ES           	; Pointsave = Buf.nextbuf
 38586                                  ;       PUSH    DS
 38587                                  ;       POP     ES              	; Buf is ES:DI
 38588                                  ;	; 15/03/2018
 38589                                  ;       LDS     SI,[SS:BUFFHEAD] 	; Curbuf = HEAD
 38590                                  ;       CALL    POINTCOMP       	; Buf == HEAD?
 38591                                  ;       JNZ     SHORT BUFLOOP
 38592                                  ;       MOV     [SS:BUFFHEAD],CX
 38593                                  ;       MOV     [SS:BUFFHEAD+2],BP	; HEAD = Pointsave
 38594                                  ;       JMP     SHORT LOOKEND
 38595                                  ;BUFLOOP:
 38596                                  ;	; 31/07/2018
 38597                                  ;	mov	ax,ds
 38598                                  ;	mov	bx,si
 38599                                  ;	;lds	si,[SI+BUFFINFO.buf_link]
 38600                                  ;       LDS     SI,[SI]
 38601                                  ;       CALL    POINTCOMP
 38602                                  ;       jnz	short BUFLOOP
 38603                                  ;	;
 38604                                  ;	mov	ds,ax
 38605                                  ;	mov	si,bx
 38606                                  ;	mov	[SI],cx
 38607                                  ;	;mov	[SI+BUFFINFO.buf_link],cx   ; If Curbuf.nextbuf == buf
 38608                                  ;	mov	[SI+2],bp
 38609                                  ;	;mov	[BX+BUFFINFO.buf_link+2],bp ; Curbuf.nextbuf = Pointsave
 38610                                  ;LOOKEND:
 38611                                  ;	mov	ax,ds
 38612                                  ;	mov	bx,si
 38613                                  ;       LDS     SI,[SI]
 38614                                  ;       CMP     SI,-1
 38615                                  ;       jnz     short LOOKEND
 38616                                  ;GOTHEEND:
 38617                                  ;       mov	ds,ax
 38618                                  ;	mov	[BX],di
 38619                                  ;	MOV     [BX+2],ES 		; Curbuf.nextbuf = Buf
 38620                                  ;       MOV     WORD [ES:DI],-1
 38621                                  ;	;mov	word [ES:DI+BUFFINFO.buf_link],-1
 38622                                  ;       MOV     WORD [ES:DI+2],-1 	; Buf is LAST
 38623                                  ;	;mov	word [ES:DI+BUFFINFO.buf_link+2],-1
 38624                                  ;NRET:
 38625                                  ;       CALL	restore_world
 38626                                  ;	
 38627                                  ;	;cmp	byte [di+4],-1
 38628                                  ;	cmp	byte [DI+BUFFINFO.buf_ID],-1  ; Free buffer ?
 38629                                  ;	jnz     short scanplace_retn
 38630                                  ;	call    PLACEHEAD
 38631                                  ;	retn
 38632                                  
 38633                                  ;EndProc PLACEBUF
 38634                                  
 38635                                  ;M039 - Removed PLACEHEAD.
 38636                                  ;----------------------------------------------------------------------------
 38637                                  ; places buffer at head
 38638                                  ;  NOTE:::::: ASSUMES THAT BUFFER IS CURRENTLY THE LAST
 38639                                  ;	ONE IN THE LIST!!!!!!!
 38640                                  ; BUGBUG ---- this routine can be removed because it has only
 38641                                  ; BUGBUG ---- one instruction. This routine is called from
 38642                                  ; BUGBUG ---- 3 places. ( Size = 3*3+6 = 15 bytes )
 38643                                  ; BUGBUG ---- if coded in line = 3 * 5 = 15 bytes
 38644                                  ; BUGBUG ---- But kept as it is for modularity
 38645                                  ;----------------------------------------------------------------------------
 38646                                  ;procedure   PLACEHEAD,NEAR
 38647                                  ;	mov	word ptr [BufferQueue], di
 38648                                  ;	ret
 38649                                  ;EndProc PLACEHEAD
 38650                                  ;M039
 38651                                  
 38652                                  ;----------------------------------------------------------------------------
 38653                                  ; Procedure Name : PLACEHEAD
 38654                                  ;
 38655                                  ; SAME AS PLACEBUF except places buffer at head
 38656                                  ;----------------------------------------------------------------------------
 38657                                  
 38658                                  	; MSDOS 3.3 (Retro DOS v3.0)
 38659                                  	; 05/09/2018
 38660                                  	; MSDOS 2.11 (Retro DOS v2.0)
 38661                                  ;PLACEHEAD:
 38662                                  ;	; 31/07/2018 - Retro DOS v3.0
 38663                                  ;	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5D4Ah
 38664                                  ;
 38665                                  ;       CALL	save_world
 38666                                  ;       PUSH	DS
 38667                                  ;       POP	ES
 38668                                  ;	; 15/03/2018 - Retro DOS v2.0 (MSDOS 2.11)
 38669                                  ;       LDS     SI,[SS:BUFFHEAD]
 38670                                  ;	; 31/07/2018 - Retro DOS v3.0 (MSDOS 3.3)
 38671                                  ;	CALL    POINTCOMP
 38672                                  ;       JZ      SHORT GOTHEEND2
 38673                                  ;	MOV	[ES:DI],SI
 38674                                  ;	;mov	[ES:DI+BUFFINFO.buf_link],si
 38675                                  ;       MOV	[ES:DI+2],DS
 38676                                  ;	;mov	[ES:DI+BUFFINFO.buf_link+2],ds
 38677                                  ;       MOV	[SS:BUFFHEAD],DI
 38678                                  ;       MOV	[SS:BUFFHEAD+2],ES
 38679                                  ;LOOKEND2:
 38680                                  ;       mov	ax,ds
 38681                                  ;	mov	bx,si
 38682                                  ;	;lds	si,[SI+BUFFINFO.buf_link]
 38683                                  ;       LDS     SI,[SI]
 38684                                  ;       CALL    POINTCOMP
 38685                                  ;       JNZ	SHORT LOOKEND2 ; 05/09/2018
 38686                                  ;       mov	ds,ax
 38687                                  ;	mov	word [bx],-1
 38688                                  ;	;mov	word [BX+BUFFINFO.buf_link],-1
 38689                                  ;	mov	word [bx+2],-1
 38690                                  ;	;mov	word [BX+BUFFINFO.buf_link+2],-1
 38691                                  ;GOTHEEND2:
 38692                                  ;      	call	restore_world
 38693                                  ;placehead_retn:
 38694                                  ;	retn
 38695                                  
 38696                                  ; 20/05/2019 - Retro DOS v4.0
 38697                                  ; DOSCODE:9928h (MSDOS 6.21, MSDOS.SYS)
 38698                                  
 38699                                  ;Break	<POINTCOMP -- 20 BIT POINTER COMPARE>
 38700                                  ;----------------------------------------------------------------------------
 38701                                  ;
 38702                                  ; Procedure Name : PointComp
 38703                                  ; Inputs:
 38704                                  ;         DS:SI & ES:DI
 38705                                  ; Function:
 38706                                  ;          Checks for ((SI==DI) && (ES==DS))
 38707                                  ;	   Assumes that pointers are normalized for the
 38708                                  ;	   same segment
 38709                                  ;
 38710                                  ; Compare DS:SI to ES:DI (or DS:DI to ES:SI) for equality
 38711                                  ; DO NOT USE FOR < or >
 38712                                  ; No Registers altered
 38713                                  ;
 38714                                  ;----------------------------------------------------------------------------
 38715                                  
 38716                                  POINTCOMP:
 38717                                  	; 31/07/2018 - Retro DOS v3.0
 38718                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5D84h
 38719 0000693F 39FE                    	CMP	SI,DI
 38720 00006941 750A                    	jnz	short _ret_label	; return if nz
 38721                                  	;jnz	short placehead_retn 
 38722 00006943 51                      	PUSH	CX
 38723 00006944 52                      	PUSH	DX
 38724 00006945 8CD9                    	MOV	CX,DS
 38725 00006947 8CC2                    	MOV	DX,ES
 38726 00006949 39D1                    	CMP	CX,DX
 38727 0000694B 5A                      	POP	DX
 38728 0000694C 59                      	POP	CX
 38729                                  _ret_label:
 38730 0000694D C3                      	retn
 38731                                  
 38732                                  ; 01/08/2018 - Retro DOS v3.0
 38733                                  ; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5D93h 
 38734                                  
 38735                                  ;Break	<GETBUFFR, GETBUFFRB -- GET A SECTOR INTO A BUFFER>
 38736                                  
 38737                                  ;**	GetBuffr - Get a non-FAT Sector into a Buffer
 38738                                  ;----------------------------------------------------------------------------
 38739                                  ;	GetBuffr does normal ( non-FAT ) sector buffering
 38740                                  ;	It gets the specified local sector into one of the I/O buffers
 38741                                  ;	and shuffles the queue
 38742                                  ; 
 38743                                  ;	ENTRY	(AL) = 0 means sector must be pre-read
 38744                                  ;		       ELSE no pre-read
 38745                                  ;		(DX) = Desired physical sector number	      (LOW)
 38746                                  ;		HIGH_SECTOR = Desired physical sector number (HIGH)
 38747                                  ;		(ES:BP) = Pointer to drive parameters
 38748                                  ;		ALLOWED set in case of INT 24
 38749                                  ;	EXIT	'C' set if error (user FAIL response to INT24)
 38750                                  ;		'C' clear if OK
 38751                                  ;		CURBUF Points to the Buffer for the sector
 38752                                  ;		    the buffer type bits OF buf_flags = 0, caller must set it
 38753                                  ;	USES	AX, BX, CX, SI, DI, Flags
 38754                                  ;----------------------------------------------------------------------------
 38755                                  
 38756                                  ;**	GetBuffrb - Get a FAT Sector into a Buffer
 38757                                  ;----------------------------------------------------------------------------
 38758                                  ;	GetBuffrb reads a sector from the FAT file system's FAT table.
 38759                                  ;	It gets the specified sector into one of the I/O buffers
 38760                                  ;	and shuffles the queue. We need a special entry point so that
 38761                                  ;	we can read the alternate FAT sector if the first read fails, also
 38762                                  ;	so we can mark the buffer as a FAT sector.
 38763                                  ; 
 38764                                  ;	ENTRY	(AL) = 0 means sector must be pre-read
 38765                                  ;		       ELSE no pre-read
 38766                                  ;		(DX) = Desired physical sector number	     (LOW)
 38767                                  ;		(SI) != 0
 38768                                  ;		HIGH_SECTOR = Desired physical sector number (HIGH)
 38769                                  ;		(ES:BP) = Pointer to drive parameters
 38770                                  ;		ALLOWED set in case of INT 24
 38771                                  ;	EXIT	'C' set if error (user FAIL response to INT24)
 38772                                  ;		'C' clear if OK
 38773                                  ;		CUR ddBUF Points to the Buffer for the sector
 38774                                  ;		    the buffer type bits OF buf_flags = 0, caller must set it
 38775                                  ;	USES	AX, BX, CX, SI, DI, Flags
 38776                                  ;----------------------------------------------------------------------------
 38777                                  
 38778                                  	; 22/09/2023 - RetroDOS v4.2 MSDOS.SYS (optimization)
 38779                                  GETBUFFRC:
 38780                                  	;mov	word [HIGH_SECTOR],0
 38781                                  	; 02/03/2024 - Retro DOS v5.0
 38782 0000694E 891E[0706]              	mov	[HIGH_SECTOR],bx
 38783                                  GETBUFFRA:
 38784 00006952 30C0                    	xor	al,al
 38785 00006954 BE0100                  	mov	si,1
 38786 00006957 EB09                    	jmp	short GETBUFFRB
 38787                                  
 38788                                  	; 22/09/2023
 38789                                  GETBUFFER:
 38790 00006959 30C0                    	xor	al,al
 38791                                  GETBUFFRD:
 38792                                  	;mov	byte [ALLOWED],18h
 38793 0000695B C606[4B03]18            	mov	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY
 38794                                  
 38795                                  	; 20/05/2019 - Retro DOS v4.0
 38796                                  	; DOSCODE:9937h (MSDOS 6.21, MSDOS.SYS)
 38797                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 38798                                  	; DOSCODE:98DBh (MSDOS 5.0, MSDOS.SYS)
 38799                                  
 38800                                  	; 06/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 38801                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0AAB0h
 38802                                  
 38803                                  	; (Windows Me IO.SYS - BIOSCODE:0CA3Dh)
 38804                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:9937h)
 38805                                  
 38806                                  GETBUFFR:
 38807 00006960 31F6                    	XOR	SI,SI
 38808                                  
 38809                                  ;	This entry point is called for FAT buffering with SI != 0
 38810                                  
 38811                                  GETBUFFRB:
 38812 00006962 A3[9405]                	MOV	[PREREAD],AX			; save pre-read flag
 38813                                  
 38814                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38815                                  	;;;
 38816 00006965 09F6                    	or	si,si
 38817 00006967 7429                    	jz      short getb1
 38818                                  
 38819                                  	;cmp	word [es:bp+0Fh],0
 38820 00006969 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 38821 0000696E 7522                    	jnz	short getb1	; not FAT32
 38822                                  
 38823                                  	;mov	ax,[es:bp+23h]
 38824 00006970 268B4623                	mov	ax,[es:bp+DPB.EXT_FLAGS]
 38825 00006974 A880                    	test	al,80h		; bit 7 -- 1 means only one FAT is active
 38826 00006976 741A                    	jz	short getb1
 38827 00006978 83E00F                  	and	ax,0Fh		; Active FAT is the one referenced in bits 0-3
 38828 0000697B 7415                    	jz	short getb1
 38829                                  
 38830 0000697D 52                      	push	dx
 38831 0000697E 89C1                    	mov	cx,ax			; Zero based number of active FAT.
 38832                                  					; (Only valid if mirroring is disabled.)	
 38833                                  	;mul	word [es:bp+33h]
 38834 00006980 26F76633                	mul	word [es:bp+DPB.FAT32_SIZE+2]
 38835 00006984 91                      	xchg	ax,cx
 38836                                  	;mul	word [es:bp+31h]
 38837 00006985 26F76631                	mul	word [es:bp+DPB.FAT32_SIZE]
 38838 00006989 01D1                    	add	cx,dx
 38839 0000698B 5A                      	pop	dx
 38840 0000698C 01C2                    	add	dx,ax
 38841 0000698E 110E[0706]              	adc	[HIGH_SECTOR],cx
 38842                                  getb1:
 38843                                  	;;;
 38844                                  
 38845                                  	; 15/12/2022
 38846 00006992 268A4600                	mov	al,[ES:BP]
 38847                                  	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 38848                                  	;MOV	AL,[ES:BP+DPB.DRIVE] ; mov al,[es:bp+0]
 38849 00006996 C53E[1E00]              	LDS	DI,[LastBuffer]			; Get the recency pointer
 38850                                  
 38851                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38852                                  	;;;
 38853 0000699A BBFFFF                  	mov	bx,-1 ; 0FFFFh
 38854                                  	;;;
 38855                                  
 38856                                  	; MSDOS 6.0
 38857                                  ;hkn; SS override
 38858 0000699D 368B0E[0706]            	MOV	CX,[SS:HIGH_SECTOR]		; F.C. >32mb	;AN000;
 38859                                  
 38860                                  ;	See if this is the buffer that was most recently returned.
 38861                                  ;	A big performance win if it is.
 38862                                  
 38863                                  	;CMP	DI,-1				; Recency pointer valid?
 38864                                  	; 06/03/2024 - Retro DOS v5.0	
 38865 000069A2 39DF                    	cmp	di,bx ; -1
 38866 000069A4 7412                    	je	short getb5			; No
 38867                                  
 38868                                  	;cmp	dx,[di+6]
 38869 000069A6 3B5506                  	CMP	DX,[DI+BUFFINFO.buf_sector]
 38870 000069A9 750D                    	JNZ	short getb5			; Wrong sector
 38871                                  	
 38872                                  	; MSDOS 6.0
 38873                                  	;cmp	cx,[di+8]
 38874 000069AB 3B4D08                  	CMP	CX,[DI+BUFFINFO.buf_sector+2]	; F.C. >32mb	;AN000;
 38875 000069AE 7508                    	JNZ	short getb5			; F.C. >32mb	;AN000;
 38876                                  	
 38877                                  	;cmp	al,[di+4]
 38878 000069B0 3A4504                  	CMP	AL,[DI+BUFFINFO.buf_ID]
 38879                                  	;JZ	getb35				; Just asked for same buffer
 38880 000069B3 7503                    	jnz	short getb5
 38881                                  	;jmp	getb35
 38882                                  	; 17/12/2022
 38883                                  	; 28/07/2019
 38884 000069B5 E90001                  	jmp	getb35x
 38885                                  	; 07/12/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 38886                                  	;jmp	getb35
 38887                                  
 38888                                  ;	It's not the buffer most recently returned. See if it's in the
 38889                                  ;	cache.
 38890                                  ;
 38891                                  ;	(cx:dx) = sector #
 38892                                  ;	(al) = drive #
 38893                                  ;	(si) = 0 iff non fat sector, != 0 if FAT sector read
 38894                                  ;	??? list may be incomplete ???
 38895                                  
 38896                                  getb5:	
 38897                                  	; MSDOS 3.3
 38898                                  	;lds	di,[SS:BUFFHEAD]
 38899                                  	; MSDOS 6.0
 38900 000069B8 E82EFF                  	CALL	GETCURHEAD			; get Q Head
 38901                                  getb10:	
 38902                                  	;cmp	dx,[di+6]
 38903 000069BB 3B5506                  	CMP	DX,[DI+BUFFINFO.buf_sector]
 38904                                  	;jne	short getb12			; wrong sector lo
 38905                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38906                                  	;;;
 38907 000069BE 750D                    	jne	short getb11
 38908                                  	;;;
 38909                                  
 38910                                  	; MSDOS 6.0
 38911                                  	;cmp	cx,[di+8]
 38912 000069C0 3B4D08                  	CMP	CX,[DI+BUFFINFO.buf_sector+2]
 38913                                  	;jne	short getb12			; wrong sector hi
 38914                                  	; 06/03/2024
 38915                                  	;;;
 38916 000069C3 7508                    	jne	short getb11
 38917                                  	;;;
 38918                                  	
 38919                                  	;cmp	al,[di+4]
 38920 000069C5 3A4504                  	CMP	AL,[DI+BUFFINFO.buf_ID]
 38921                                  	;;je	short getb25 ; 05/09/2018	; Found the requested sector
 38922                                  	;jne	short getb12
 38923                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38924                                  	;;;
 38925 000069C8 7503                    	jne	short getb11
 38926                                  	;;;
 38927 000069CA E9A400                  	jmp	getb25
 38928                                  
 38929                                  getb11:
 38930                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38931                                  	;;;
 38932                                  	;cmp	byte [di+4],0FFh
 38933 000069CD 807D04FF                	cmp	byte [di+BUFFINFO.buf_ID],0FFh	; Free buffer ?
 38934 000069D1 7502                    	jne	short getb12			; no
 38935 000069D3 89FB                    	mov	bx,di				; save buffer (offset) addr
 38936                                  	;;;
 38937                                  
 38938                                  getb12:	
 38939                                  	; MSDOS 3.3
 38940                                  	;;mov	di,[DI]
 38941                                  	;;;mov	di,[DI+BUFFINFO.buf_link]
 38942                                  	;
 38943                                  	; 15/08/2018
 38944                                  	;lds	di,[di]
 38945                                  
 38946                                  	;cmp	di,-1 ; 0FFFFh
 38947                                  	;jne	short getb10
 38948                                  	;lds	di,[SS:BUFFHEAD]
 38949                                  
 38950                                  	; MSDOS 6.0
 38951 000069D5 8B3D                    	mov	di,[di]
 38952                                  	;mov	DI,[DI+BUFFINFO.BUF_NEXT]
 38953 000069D7 363B3E[7E11]            	cmp	DI,[SS:FIRST_BUFF_ADDR]		; back at the front again?
 38954 000069DC 75DD                    	jne	short getb10			; no, continue looking
 38955                                  
 38956                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38957                                  	;;;
 38958 000069DE 83FBFF                  	cmp	bx,0FFFFh	; -1 ; invalid (not a free buffer address)
 38959 000069E1 7404                    	je	short getb12x
 38960 000069E3 89DF                    	mov	di,bx		; restore free buffer (header offset) address
 38961 000069E5 EB16                    	jmp	short getb13
 38962                                  getb12x:
 38963                                  	;;;
 38964                                  
 38965                                  ;	The requested sector is not available in the buffers. DS:DI now points
 38966                                  ;	to the first buffer in the Queue. Flush the first buffer & read in the
 38967                                  ;	new sector into it.
 38968                                  ;
 38969                                  ;	BUGBUG - what goes on here? Isn't the first guy the most recently
 38970                                  ;	used guy? Shuld be for fast lookup. If he is, we shouldn't take
 38971                                  ;	him, we should take LRU. And the above lookup shouldn't be
 38972                                  ;	down a chain, but should be hashed.
 38973                                  ;
 38974                                  ;	(DS:DI) = first buffer in the queue
 38975                                  ;	(CX:DX) = sector # we want
 38976                                  ;	(si) = 0 iff non fat sector, != 0 if FAT sector read
 38977                                  
 38978                                  	; MSDOS 3.3 & MSDOS 6.0
 38979                                  ;hkn; SS override
 38980 000069E7 51                      	PUSH	CX  ; MSDOS 6.0
 38981 000069E8 56                      	push	si
 38982 000069E9 52                      	push	dx
 38983 000069EA 55                      	push	bp
 38984 000069EB 06                      	push	es
 38985 000069EC E85A01                  	CALL	BUFWRITE			; Write out the dirty buffer
 38986 000069EF 07                      	pop	es
 38987 000069F0 5D                      	pop	bp
 38988 000069F1 5A                      	pop	dx
 38989 000069F2 5E                      	pop	si
 38990 000069F3 368F06[0706]            	POP	word [SS:HIGH_SECTOR]  ; MSDOS 6.0
 38991                                  	;jc	short getbx			; if got hard error
 38992 000069F8 7303                    	jnc	short getb13
 38993 000069FA E9C500                  	jmp	getbx
 38994                                  
 38995                                  getb13:
 38996                                  
 38997                                  ; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38998                                  %if 0
 38999                                  	; MSDOS 6.0
 39000                                  	CALL	SET_RQ_SC_PARMS 		; set parms for secondary cache
 39001                                  %endif
 39002                                  
 39003                                  ;	We're ready to read in the buffer, if need be. If the caller
 39004                                  ;	wanted to just *write* the buffer then we'll skip reading it in.
 39005                                  
 39006 000069FD 30E4                    	XOR	AH,AH				; initial flags
 39007                                  ;hkn; SS override
 39008                                  	;test	byte [ss:PREREAD],0FFh
 39009                                  	;jnz	short getb20
 39010 000069FF 363826[9405]            	CMP	[SS:PREREAD],ah ; 0		; am to Read in the new sector?
 39011 00006A04 7553                    	JNZ	short getb20			; no, we're done
 39012                                  	;;;lea	bx,[di+16] ; MSDOS 3.3
 39013                                  	;;lea	bx,[di+20] ; MSDOS 6.0
 39014                                  	;lea	bx,[di+24] ; PCDOS 7.1	; 06/03/2024
 39015 00006A06 8D5D18                  	LEA	BX,[DI+BUFINSIZ] 		; (ds:bx) = data address
 39016                                  	;MOV	CX,1
 39017                                  	; 22/09/2023
 39018 00006A09 29C9                    	sub	cx,cx ; 0
 39019 00006A0B 56                      	push	si
 39020 00006A0C 57                      	push	di
 39021 00006A0D 52                      	push	dx
 39022                                  	; MSDOS 6.0
 39023 00006A0E 06                      	push	es ; ***
 39024                                  
 39025                                  ; Note: As far as I can tell, all disk reads into buffers go through
 39026                                  ;	this point. -mrw 10/88
 39027                                  	
 39028                                  	;cmp	byte [ss:BuffInHMA],0	; is buffers in HMA?
 39029                                  	; 22/09/2023
 39030 00006A0F 36380E[7900]            	cmp	[ss:BuffInHMA],cl ; 0
 39031 00006A14 7407                    	jz	short getb14
 39032 00006A16 1E                      	push	ds ; **
 39033 00006A17 53                      	push	bx ; *
 39034 00006A18 36C51E[7A00]            	lds	bx,[ss:LoMemBuff]	; Then let's read it into scratch buff
 39035                                  getb14:
 39036                                  ;M039: Eliminated redundant HMA code.
 39037                                  
 39038                                  	; 22/09/2023
 39039 00006A1D 41                      	inc	cx ; cx = 1
 39040                                  
 39041                                  	; MSDOS 3.3 (& MSDOS 6.0)
 39042 00006A1E 09F6                    	OR	SI,SI			; FAT sector ?
 39043 00006A20 7407                    	JZ	short getb15		; no
 39044                                  
 39045 00006A22 E86BD5                  	call	FATSECRD
 39046                                  	;mov	ah,2
 39047 00006A25 B402                    	MOV	AH,buf_isFAT		; Set buf_flags
 39048                                  
 39049 00006A27 EB05                    	JMP	SHORT getb17		; Buffer is marked free if read barfs
 39050                                  
 39051                                  getb15:
 39052 00006A29 E8C7D5                  	call	DREAD			; Buffer is marked free if read barfs
 39053 00006A2C B400                    	MOV	AH,0			; Set buf_flags to no type, DO NOT XOR!
 39054                                  getb17:
 39055                                  
 39056                                  ; 06/03/2024 - Retro DOS v5.0
 39057                                  %if 0
 39058                                  	; 17/12/2022	
 39059                                  ; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 39060                                  ;;if 0
 39061                                  	; MSDOS 6.0							  ;I001
 39062                                  	pushf								  ;I001
 39063                                  	cmp	byte [SS:BuffInHMA],0	; did we read into scratch buff ? ;I001
 39064                                  	jz	short not_in_hma	; no				  ;I001
 39065                                  	;mov	cx,[es:bp+2]
 39066                                  	mov	cx,[ES:BP+DPB.SECTOR_SIZE]				  ;I001
 39067                                  	shr	cx,1							  ;I001
 39068                                  	popf				; Retrieve possible CY from DREAD ;I001
 39069                                  	mov	si,bx							  ;I001
 39070                                  	pop	di ; *							  ;I001
 39071                                  	pop	es ; **							  ;I001
 39072                                  	cld								  ;I001
 39073                                  	pushf				; Preserve possible CY from DREAD ;I001
 39074                                  	rep	movsw			; move the contents of scratch buf;I001
 39075                                  	push	es							  ;I001
 39076                                  	pop	ds							  ;I001
 39077                                  ;;endif							 
 39078                                  
 39079                                  ;; 17/12/2022
 39080                                  ;%if 0
 39081                                  ;	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 39082                                  ;	; MSDOS 5.0
 39083                                  ;	pushf
 39084                                  ;	cmp	byte [SS:BuffInHMA],0	; did we read into scratch buff ?
 39085                                  ;	jz	short not_in_hma	; no
 39086                                  ;	popf
 39087                                  ;	mov	cx,[ES:BP+DPB.SECTOR_SIZE]
 39088                                  ;	shr	cx,1
 39089                                  ;	mov	si,bx
 39090                                  ;	pop	di ; *
 39091                                  ;	pop	es ; **
 39092                                  ;	cld
 39093                                  ;	rep	movsw
 39094                                  ;	push	es
 39095                                  ;	pop	ds
 39096                                  ;	jmp	short getb19 ; 27/11/2022
 39097                                  ;%endif
 39098                                  
 39099                                  not_in_hma:								  ;I001
 39100                                  	popf							 	  ;I001
 39101                                  
 39102                                  %else
 39103                                  	; 06/03/2024
 39104                                  	; PCDOS 7.1 IBMDOS.COM
 39105                                  	;;;
 39106 00006A2E B500                    	mov	ch,0
 39107 00006A30 368A0E[7900]            	mov	cl,[ss:BuffInHMA] ; did we read into scratch buff ?
 39108 00006A35 E31C                    	jcxz	getb19		  ; no
 39109                                  	;mov	cx,[es:bp+2]
 39110 00006A37 268B4E02                	mov	cx,[es:bp+DPB.SECTOR_SIZE]
 39111 00006A3B 89DE                    	mov	si,bx
 39112 00006A3D 5F                      	pop	di
 39113 00006A3E 07                      	pop	es
 39114 00006A3F 9C                      	pushf
 39115 00006A40 D1E9                    	shr	cx,1
 39116 00006A42 FC                      	cld
 39117 00006A43 36803E[6A00]00          	cmp	byte [ss:DDMOVE],0
 39118                                  	;jz	short getb18+1	; rep movsw (skip 32bit prefix)
 39119 00006A49 7403                    	jz	short getb18
 39120 00006A4B D1E9                    	shr	cx,1
 39121                                  ;getb18:
 39122                                  	;rep	movsd		; move the contents of scratch buffer
 39123 00006A4D 66                      	db	66h	; 32bit prefix
 39124                                  getb18:
 39125 00006A4E F3A5                    	rep	movsw
 39126                                  
 39127                                  	;mov	dx,es
 39128                                  	;mov	ds,dx
 39129 00006A50 06                      	push	es
 39130 00006A51 1F                      	pop	ds
 39131 00006A52 9D                      	popf			; Retrieve possible CY from DREAD
 39132                                  	;;;
 39133                                  %endif
 39134                                  
 39135                                  getb19:
 39136 00006A53 07                      	pop	es ; ***
 39137 00006A54 5A                      	pop	dx
 39138 00006A55 5F                      	pop	di
 39139 00006A56 5E                      	pop	si
 39140 00006A57 7269                    	JC	short getbx
 39141                                  
 39142                                  ;	The buffer has the data setup in it (if we were to read)
 39143                                  ;	Setup the various buffer fields
 39144                                  ;
 39145                                  ;	(ds:di) = buffer address
 39146                                  ;	(es:bp) = DPB address
 39147                                  ;	(HIGH_SECTOR:DX) = sector #
 39148                                  ;	(ah) = BUF_FLAGS value
 39149                                  ;	(si) = 0 if non fat sector, != 0 if FAT sector read
 39150                                  
 39151                                  ;hkn; SS override
 39152                                  getb20:	; MSDOS 6.0
 39153 00006A59 368B0E[0706]            	MOV	CX,[SS:HIGH_SECTOR]
 39154                                  	;mov	[di+8],cx
 39155 00006A5E 894D08                  	MOV	[DI+BUFFINFO.buf_sector+2],CX
 39156                                  	; MSDOS 3.3 (& MSDOS 6.0)	
 39157                                   	;mov	[di+6],dx
 39158 00006A61 895506                  	MOV	[DI+BUFFINFO.buf_sector],DX
 39159                                  	;;;mov	[di+0Ah],bp  ; MSDOS 3.3
 39160                                  	;;mov	[di+0Dh],bp  ; MSDOS 6.0
 39161                                  	;mov	[di+0Fh],bp  ; PCDOS 7.1 ; 06/03/2024	
 39162 00006A64 896D0F                  	MOV	[DI+BUFFINFO.buf_DPB],BP
 39163                                  	;;;mov	[di+0Ch],es
 39164                                  	;;mov	[di+0Fh],es  ; MSDOS 6.0
 39165                                  	;mov	[di+11h],es  ; PCDOS 7.1 ; 06/03/2024
 39166 00006A67 8C4511                  	MOV	[DI+BUFFINFO.buf_DPB+2],ES
 39167                                  	; 15/12/2022
 39168 00006A6A 268A4600                	mov	al,[es:bp]
 39169                                  	;mov	al,[es:bp+0]
 39170                                  	; 27/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 39171                                  	;MOV	AL,[ES:BP+DPB.DRIVE]
 39172                                  	;mov	[di+4],ax
 39173 00006A6E 894504                  	MOV	[DI+BUFFINFO.buf_ID],AX		; Set ID and Flags
 39174                                  getb25:	
 39175                                  	; MSDOS 3.3
 39176                                  	;mov     ax,1
 39177                                  
 39178                                  	; MSDOS 6.0
 39179                                  	;mov	byte [di+0Ah],1
 39180 00006A71 C6450A01                	MOV	byte [DI+BUFFINFO.buf_wrtcnt],1	; Default to not a FAT sector ;AC000;
 39181 00006A75 31C0                    	XOR	AX,AX
 39182                                  
 39183                                  	; MSDOS 3.3 (& MSDOS 6.0)
 39184 00006A77 09F6                    	OR	SI,SI				; FAT sector ?
 39185 00006A79 742C                    	JZ	short getb30			; no
 39186                                  
 39187                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39188                                  	;;;
 39189                                  	;;cmp	word [es:bp+0Fh],0
 39190                                  	;cmp	word [es:bp+DPB.FAT_SIZE],0
 39191 00006A7B 2639460F                	cmp	[es:bp+DPB.FAT_SIZE],ax ; 0
 39192 00006A7F 751B                    	jnz	short getb27	; not FAT32
 39193                                  
 39194                                  	; FAT32
 39195                                  	;;test	word [es:bp+23h],80h
 39196                                  	;test	byte [es:bp+23h],80h
 39197 00006A81 26F6462380              	test	byte [es:bp+DPB.EXT_FLAGS],80h
 39198 00006A86 7507                    	jnz	short getb26		; bit 7 -- 1 means only one FAT is active
 39199                                  	;mov	al,[es:bp+8]
 39200 00006A88 268A4608                	mov	al,[es:bp+DPB.FAT_COUNT]
 39201                                  	;mov	[di+0Ah],al
 39202 00006A8C 88450A                  	mov	[di+BUFFINFO.buf_wrtcnt],al
 39203                                  getb26:
 39204                                  	;mov	ax,[es:bp+33h]
 39205 00006A8F 268B4633                	mov	ax,[es:bp+DPB.FAT32_SIZE+2]
 39206                                  	;mov	[di+0Dh],ax
 39207 00006A93 89450D                  	mov	[di+BUFFINFO.buf_wrtcntinc+2],ax
 39208                                  	;mov	ax,[es:bp+31h]
 39209 00006A96 268B4631                	mov	ax,[es:bp+DPB.FAT32_SIZE]
 39210 00006A9A EB0B                    	jmp	short getb30
 39211                                  getb27: 
 39212                                  	;;;
 39213                                  
 39214                                  	;mov	al,[es:bp+8]
 39215 00006A9C 268A4608                	MOV	AL,[ES:BP+DPB.FAT_COUNT]	; update number of copies of
 39216                                  	
 39217                                  	; MSDOS 6.0
 39218 00006AA0 88450A                  	MOV	[DI+BUFFINFO.buf_wrtcnt],AL	;  this sector present on disk
 39219                                  	;mov	ax,[es:bp+0Fh]
 39220 00006AA3 268B460F                	MOV	AX,[ES:BP+DPB.FAT_SIZE]		; offset of identical FAT
 39221                                  						;  sectors
 39222                                  	; MSDOS 3.3
 39223                                  	;;mov	ah,[es:bp+0Fh]
 39224                                  	;MOV	AH,[ES:BP+DPB.FAT_SIZE]
 39225                                  
 39226                                  ;	BUGBUG - dos 6 can clean this up by not setting wrtcntinc unless wrtcnt
 39227                                  ;		is set
 39228                                  
 39229                                  getb30:	
 39230                                  	; MSDOS 6.0
 39231                                  	;mov	[di+0Bh],ax
 39232 00006AA7 89450B                  	MOV	[DI+BUFFINFO.buf_wrtcntinc],AX
 39233                                  
 39234                                  	; MSDOS 3.3
 39235                                  	;;mov	[di+8],ax ; 15/08/2018	
 39236                                  	;MOV	[DI+BUFFINFO.buf_wrtcnt],AX
 39237                                  
 39238 00006AAA E855FE                  	CALL	PLACEBUF
 39239                                  
 39240                                  ;hkn; SS override for next 4
 39241                                  getb35: 
 39242                                  	; 17/12/2022
 39243                                  	; 07/12/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 39244                                  	; MSDOS 3.3 & MSDOS 5.0 & MSDOS 6.0
 39245                                  	;MOV	[SS:CURBUF+2],DS
 39246                                  	;MOV	[SS:LastBuffer+2],DS
 39247                                  	;MOV	[SS:CURBUF],DI
 39248                                  	;MOV	[SS:LastBuffer],DI
 39249                                  	;CLC
 39250                                  
 39251                                  	; 17/12/2022
 39252                                  	; 07/12/2022
 39253                                  	; Retro DOS v4.0
 39254 00006AAD 368C1E[2000]            	mov	[ss:LastBuffer+2],ds
 39255 00006AB2 36893E[1E00]            	mov	[ss:LastBuffer],di
 39256 00006AB7 F8                      	clc
 39257                                  getb35x: ; 28/07/2019
 39258 00006AB8 368C1E[E405]            	MOV	[ss:CURBUF+2],ds
 39259 00006ABD 36893E[E205]            	MOV	[ss:CURBUF],di
 39260                                  
 39261                                  ;	Return with 'C' set appropriately
 39262                                  ;	(dx) = caller's original value
 39263                                  
 39264                                  getbx:	
 39265 00006AC2 16                      	push	ss
 39266 00006AC3 1F                      	pop	ds
 39267                                  	;retn
 39268                                  	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 39269                                  getbuffrb_retn:
 39270                                  ;flushbuf_retn:	; 17/12/2022
 39271 00006AC4 C3                      	retn
 39272                                  
 39273                                  ;Break	<FLUSHBUF -- WRITE OUT DIRTY BUFFERS>
 39274                                  ;----------------------------------------------------------------------------
 39275                                  ; Input:
 39276                                  ;	DS = DOSGROUP
 39277                                  ;	AL = Physical unit number local buffers only
 39278                                  ;	   = -1 for all units and all remote buffers
 39279                                  ; Function:
 39280                                  ;	Write out all dirty buffers for unit, and flag them as clean
 39281                                  ;	Carry set if error (user FAILed to I 24)
 39282                                  ;	    Flush operation completed.
 39283                                  ; DS Preserved, all others destroyed (ES too)
 39284                                  ;----------------------------------------------------------------------------
 39285                                  
 39286                                  	; 20/05/2019 - Retro DOS v4.0
 39287                                  	; DOSCODE:9A35h (MSDOS 6.21, MSDOS.SYS)
 39288                                  
 39289                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 39290                                  	; DOSCODE:99DAh (MSDOS 5.0, MSDOS.SYS)
 39291                                  
 39292                                  	; 06/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 39293                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0AC2Bh
 39294                                  
 39295                                  FLUSHBUF:
 39296                                  	; MSDOS 3.3
 39297                                  	;;mov	ah,-1 ; 01/08/2018 - Retro DOS v3.0
 39298                                  	;lds	di,[BUFFHEAD]
 39299                                  
 39300                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39301                                  	;;;
 39302 00006AC5 3CFF                    	cmp     al,0FFh        ; -1
 39303 00006AC7 750C                    	jne     short flshbuf_2
 39304 00006AC9 BB1A00                  	mov     bx,26
 39305                                  flshbuf_1:
 39306                                  	;and	ss:drv_flags_1[bx],0F7h
 39307 00006ACC 3680A7[0713]F7          	and	byte [ss:bx+drive_flags-1],0F7h ; clear bit 3
 39308 00006AD2 4B                      	dec     bx              ; backward
 39309 00006AD3 75F7                    	jnz     short flshbuf_1
 39310                                  flshbuf_2:
 39311                                  	;;;
 39312                                  
 39313                                  	; MSDOS 6.0
 39314 00006AD5 E811FE                  	call	GETCURHEAD
 39315                                  	;TEST	word [ss:DOS34_FLAG],FROM_DISK_RESET ; from disk reset ? ;hkn;
 39316 00006AD8 36F606[1106]04          	TEST	byte [ss:DOS34_FLAG],FROM_DISK_RESET ; 4
 39317 00006ADE 7508                    	jnz	short scan_buf_queue
 39318 00006AE0 36833E[7100]00          	cmp	word [ss:DirtyBufferCount],0			;hkn;
 39319 00006AE6 7423                    	je	short end_scan
 39320                                  	
 39321                                  scan_buf_queue:
 39322 00006AE8 E82900                  	call	CHECKFLUSH
 39323                                  	;push	ax  ; MSDOS 3.3
 39324                                  	; MSDOS 6.0
 39325                                  	;mov	ah,[di+4]
 39326 00006AEB 8A6504                  	mov	ah,[DI+BUFFINFO.buf_ID]
 39327 00006AEE 363826[2203]            	cmp	[SS:WPERR],ah					;hkn;
 39328 00006AF3 7408                    	je	short free_the_buf
 39329                                  	;TEST	word [ss:DOS34_FLAG],FROM_DISK_RESET ; from disk reset ? ;hkn;
 39330 00006AF5 36F606[1106]04          	TEST	byte [ss:DOS34_FLAG],FROM_DISK_RESET ; 4
 39331 00006AFB 7405                    	jz	short dont_free_the_buf
 39332                                  	; MSDOS 3.3
 39333                                  	;;mov	al,[di+4]
 39334                                  	;mov	al,[DI+BUFFINFO.buf_ID]
 39335                                  	;cmp	[SS:WPERR],al					;hkn;
 39336                                  	; 15/08/2018
 39337                                  	;jne	short dont_free_the_buf	
 39338                                  free_the_buf:
 39339                                  	; MSDOS 6.0 (& MSDOS 3.3)
 39340 00006AFD C74504FF00              	mov	word [DI+BUFFINFO.buf_ID],00FFh
 39341                                  dont_free_the_buf:
 39342                                  	;pop	ax  ; MSDOS 3.3 	   	
 39343                                  
 39344                                  	; MSDOS 3.3
 39345                                  	;mov	di,[DI]
 39346                                  	;;mov	di,[DI+BUFFINFO.buf_link] ; .buf_next
 39347                                  	;
 39348                                  	; 15/08/2018
 39349                                  	;lds	di,[di]
 39350                                  	;
 39351                                  	;cmp	di,-1 ; 0FFFFh
 39352                                  	;jnz	short scan_buf_queue 
 39353                                  	
 39354                                  	; MSDOS 6.0
 39355 00006B02 8B3D                    	mov	di,[di]
 39356                                  	;mov	di,[DI+BUFFINFO.buf_next] ; .buf_link
 39357 00006B04 363B3E[7E11]            	cmp	di,[SS:FIRST_BUFF_ADDR]				;hkn;
 39358 00006B09 75DD                    	jne	short scan_buf_queue
 39359                                  
 39360                                  end_scan:
 39361 00006B0B 16                      	push	ss
 39362 00006B0C 1F                      	pop	ds
 39363                                  	; 01/08/2018 - Retro DOS v3.0
 39364                                  	;cmp	byte [FAILERR],0
 39365                                  	;jne	short bad_flush
 39366                                  	;retn
 39367                                  ;bad_flush:
 39368                                  	;stc
 39369                                  	;retn
 39370                                  
 39371                                  	; 17/12/2022
 39372                                  	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 39373                                  	; 01/08/2018 - Retro DOS v3.0
 39374 00006B0D 803E[4A03]01            	cmp	byte [FAILERR],1
 39375 00006B12 F5                      	cmc
 39376                                  flushbuf_retn:
 39377 00006B13 C3                      	retn
 39378                                  	
 39379                                  	; 17/12/2022
 39380                                  	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 39381                                  	;cmp	byte [FAILERR],0
 39382                                  	;jne	short bad_flush
 39383                                  	;retn
 39384                                  ;bad_flush:
 39385                                  	;stc
 39386                                  	;retn
 39387                                  
 39388                                  ;----------------------------------------------------------------------------
 39389                                  ;
 39390                                  ; Procedure Name : CHECKFLUSH
 39391                                  ;
 39392                                  ; Inputs : AL - Drive number, -1 means do not check for drive
 39393                                  ;	   DS:DI - pointer to buffer
 39394                                  ;
 39395                                  ; Function : Write out a buffer if it is dirty
 39396                                  ;
 39397                                  ; Carry set if problem (currently user FAILed to I 24)
 39398                                  ;
 39399                                  ;----------------------------------------------------------------------------
 39400                                  
 39401                                  	; 07/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 39402                                  
 39403                                  CHECKFLUSH:
 39404                                  	; MSDOS 6.0
 39405 00006B14 B4FF                    	mov	ah,-1	; 01/08/2018 Retro DOS v3.0
 39406                                  	;cmp	[di+4],ah
 39407 00006B16 386504                  	CMP	[DI+BUFFINFO.buf_ID],AH
 39408 00006B19 74F8                    	jz	short flushbuf_retn	; Skip free buffer, carry clear
 39409 00006B1B 38C4                    	CMP	AH,AL			; 
 39410 00006B1D 7412                    	JZ	short DOBUFFER		; do this buffer
 39411                                  	;cmp	al,[di+4]
 39412 00006B1F 3A4504                  	CMP	AL,[DI+BUFFINFO.buf_ID]
 39413 00006B22 F8                      	CLC
 39414 00006B23 75EE                    	jnz	short flushbuf_retn	; Buffer not for this unit or SFT
 39415                                  
 39416                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39417                                  	;;;
 39418 00006B25 31DB                    	xor	bx,bx
 39419 00006B27 88C3                    	mov	bl,al
 39420                                  	;test	ss:drive_flags[bx],8 
 39421 00006B29 36F687[0813]08          	test	byte [ss:bx+drive_flags],8 ; bit 3
 39422 00006B2F 75E2                    	jnz	short flushbuf_retn
 39423                                  	;;;
 39424                                  
 39425                                  DOBUFFER:
 39426                                  	;test	byte [di+5],40h
 39427 00006B31 F6450540                	TEST	byte [DI+BUFFINFO.buf_flags],buf_dirty
 39428 00006B35 74DC                    	jz	short flushbuf_retn	; Buffer not dirty, carry clear by TEST
 39429 00006B37 50                      	PUSH	AX
 39430                                  	;push	word [di+4]
 39431 00006B38 FF7504                  	PUSH	WORD [DI+BUFFINFO.buf_ID]
 39432 00006B3B E80B00                  	CALL	BUFWRITE
 39433 00006B3E 58                      	POP	AX
 39434 00006B3F 7206                    	JC	short LEAVE_BUF		; Leave buffer marked free (lost).
 39435                                  	;and	ah,0BFh
 39436 00006B41 80E4BF                  	AND	AH,~buf_dirty		; Buffer is clean, clears carry
 39437                                  	;mov	[di+4],ax
 39438 00006B44 894504                  	MOV	[DI+BUFFINFO.buf_ID],AX
 39439                                  LEAVE_BUF:
 39440 00006B47 58                      	POP	AX			; Search info
 39441                                  checkflush_retn:
 39442 00006B48 C3                      	retn
 39443                                  
 39444                                  ;Break	<BUFWRITE -- WRITE OUT A BUFFER IF DIRTY>
 39445                                  ;----------------------------------------------------------------------------
 39446                                  ;
 39447                                  ;	BufWrite writes a buffer to the disk, if it's dirty.
 39448                                  ;
 39449                                  ;	ENTRY	DS:DI Points to the buffer
 39450                                  ;
 39451                                  ;	EXIT	Buffer marked free
 39452                                  ;		Carry set if error (currently user FAILed to I 24)
 39453                                  ;
 39454                                  ;	USES	All buf DS:DI
 39455                                  ;		HIGH_SECTOR
 39456                                  ;----------------------------------------------------------------------------
 39457                                  
 39458                                  	; 20/05/2019 - Retro DOS v4.0
 39459                                  	; DOSCODE:9AA0h (MSDOS 6.21, MSDOS.SYS)
 39460                                  
 39461                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 39462                                  	; DOSCODE:9A45h (MSDOS 5.0, MSDOS.SYS)
 39463                                  
 39464                                  	; 07/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 39465                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0ACB1h
 39466                                  
 39467                                  BUFWRITE:
 39468                                  	; 10/09/2018
 39469                                  	; 01/08/2018 - Retro DOS v3.0
 39470                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5E94h
 39471 00006B49 B8FF00                  	MOV	AX,00FFH
 39472                                  	;xchg	ax,[di+4]
 39473 00006B4C 874504                  	XCHG	AX,[DI+BUFFINFO.buf_ID]	; Free, in case write barfs
 39474 00006B4F 3CFF                    	CMP	AL,0FFH
 39475 00006B51 74F5                    	jz      short checkflush_retn	; Buffer is free, carry clear.
 39476                                  	;test	ah,40h
 39477 00006B53 F6C440                  	test	AH,buf_dirty
 39478 00006B56 74F0                    	jz      short checkflush_retn	; Buffer is clean, carry clear.
 39479                                  	; MSDOS 6.0
 39480 00006B58 E8A200                  	call	DEC_DIRTY_COUNT 	; LB. decrement dirty count
 39481                                  
 39482                                  ;hkn; SS override
 39483 00006B5B 363A06[2203]            	CMP	AL,[SS:WPERR]
 39484 00006B60 74E6                    	jz      short checkflush_retn	; If in WP error zap buffer
 39485                                  
 39486                                  ; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39487                                  %if 0
 39488                                  ;hkn; SS override
 39489                                  	; MSDOS 6.0
 39490                                  	MOV	[SS:SC_DRIVE],AL	;LB. set it for invalidation ;AN000;
 39491                                  %endif
 39492                                  	; 07/03/2024
 39493                                  	;;;;les	bp,[di+10] ; MSDOS 3.3
 39494                                  	;;;les	bp,[di+13] ; MSDOS 6.0
 39495                                  	;;les	bp,[di+15] ; PCDOS 7.1 ; 07/03/2024
 39496                                  	;LES	BP,[DI+BUFFINFO.buf_DPB]
 39497                                  
 39498                                  	;;;lea	bx,[di+16]
 39499                                  	;;lea	bx,[di+20] ; MSDOS 6.0
 39500                                  	;lea	bx,[di+24] ; PCDOS 7.1 ; 07/03/2024
 39501 00006B62 8D5D18                  	LEA	BX,[DI+BUFINSIZ]	; Point at buffer
 39502                                  
 39503                                  ; 07/03/2024
 39504                                  %if 0
 39505                                  	;mov	dx,[di+6]
 39506                                  	MOV	DX,[DI+BUFFINFO.buf_sector] ;F.C. >32mb		;AN000;
 39507                                  	
 39508                                  	; MSDOS 6.0
 39509                                  	;mov	cx,[di+8]
 39510                                  	MOV	CX,[DI+BUFFINFO.buf_sector+2] ;F.C. >32mb	;AN000;
 39511                                  
 39512                                  ;hkn; SS override
 39513                                  	MOV	[SS:HIGH_SECTOR],CX	;F.C. >32mb		;AN000;
 39514                                  %else
 39515                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39516                                  	;;;
 39517                                  	;les	dx,[di+6]
 39518 00006B65 C45506                  	les	dx,[di+BUFFINFO.buf_sector]
 39519 00006B68 368C06[0706]            	mov	[ss:HIGH_SECTOR],es
 39520                                  
 39521                                  	;;;les	bp,[di+10] ; MSDOS 3.3
 39522                                  	;;les	bp,[di+13] ; MSDOS 6.0
 39523                                  	;les	bp,[di+15] ; PCDOS 7.1 ; 07/03/2024
 39524 00006B6D C46D0F                  	les	bp,[di+BUFFINFO.buf_DPB]
 39525                                  	;;;
 39526                                  %endif
 39527                                  	;mov	cl,[di+10] ; MSDOS 6.0 & PCDOS 7.1
 39528 00006B70 8A4D0A                  	MOV	CL,[DI+BUFFINFO.buf_wrtcnt] ;>32mb		;AC000;
 39529                                  	; MSDOS 3.3
 39530                                  	;; mov	cx,[DI+8]
 39531                                  	;mov	cx,[DI+BUFFINFO.buf_wrtcnt]
 39532                                  	;MOV	AL,CH			; [DI+BUFFINFO.buf_wrtcntinc]
 39533 00006B73 30ED                    	XOR	CH,CH
 39534                                  	;;mov	ah,ch ; MSDOS 3.3
 39535                                  
 39536                                  ;hkn; SS override for ALLOWED
 39537                                  	;mov	byte [SS:ALLOWED],18h
 39538 00006B75 36C606[4B03]18          	MOV	byte [SS:ALLOWED],Allowed_RETRY+Allowed_FAIL
 39539                                  	;test	byte [di+5],8
 39540                                  	; MSDOS 6.0 (& Retro DOS 3.0)
 39541                                  	;test	ah,8
 39542 00006B7B F6C408                  	test	AH,buf_isDATA
 39543 00006B7E 7406                    	JZ	short NO_IGNORE
 39544                                  	;or	byte [SS:ALLOWED],20h
 39545 00006B80 36800E[4B03]20          	OR	byte [SS:ALLOWED],Allowed_IGNORE
 39546                                  NO_IGNORE:
 39547                                  	;xor	ah,ah ; 10/09/2018 (MSDOS 3.3, Retro DOS v3.0)
 39548                                  	; MSDOS 6.0
 39549                                  	;mov	ax,[di+11]
 39550 00006B86 8B450B                  	MOV	AX,[DI+BUFFINFO.buf_wrtcntinc]	;>32mb		;AC000;
 39551                                  
 39552                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39553                                  	;;;
 39554                                  	;mov	si,[di+13]
 39555 00006B89 8B750D                  	mov	si,[di+BUFFINFO.buf_wrtcntinc+2]
 39556                                  	;;;
 39557                                  	
 39558 00006B8C 57                      	PUSH	DI		; Save buffer pointer
 39559 00006B8D 31FF                    	XOR	DI,DI		; Indicate failure
 39560                                  
 39561 00006B8F 1E                      	push	ds ; *
 39562 00006B90 53                      	push	bx ; **
 39563                                  WRTAGAIN:
 39564                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39565                                  	;;;
 39566 00006B91 56                      	push	si		; SI:AX = FAT size (in sectors)
 39567 00006B92 36FF36[0706]            	push	word [ss:HIGH_SECTOR]
 39568                                  	;;;
 39569 00006B97 57                      	push	di ; ***
 39570 00006B98 51                      	push	cx ; ****
 39571 00006B99 50                      	push	ax ; *****
 39572                                  	;MOV	CX,1
 39573                                  	; 17/12/2022
 39574                                  	; ch = 0
 39575 00006B9A B101                    	mov	cl,1 ; 24/07/2019
 39576                                  	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 39577                                  	;mov	cx,1
 39578 00006B9C 53                      	push	bx ; ******
 39579 00006B9D 52                      	push	dx ; *******
 39580 00006B9E 1E                      	push	ds ; ********
 39581                                  
 39582                                  ; Note: As far as I can tell, all disk reads into buffers go through this point. -mrw 10/88
 39583                                  
 39584                                  	; MSDOS 6.0
 39585                                  	;cmp	byte [ss:BuffInHMA],0 ; 10/06/2019
 39586                                  	; 22/09/2023
 39587 00006B9F 36382E[7900]            	cmp	[ss:BuffInHMA],ch ; 0
 39588 00006BA4 7423                    	jz	short NBUFFINHMA
 39589 00006BA6 51                      	push	cx
 39590 00006BA7 06                      	push	es
 39591 00006BA8 89DE                    	mov	si,bx
 39592 00006BAA 268B4E02                	mov	cx,[es:bp+DPB.SECTOR_SIZE]
 39593 00006BAE D1E9                    	shr	cx,1
 39594 00006BB0 36C43E[7A00]            	les	di,[ss:LoMemBuff] ; 10/06/2019
 39595 00006BB5 89FB                    	mov	bx,di
 39596 00006BB7 FC                      	cld
 39597                                  	;rep	movsw
 39598                                  	; 07/03/2024 - Retro DOS v5.0
 39599                                  	; (PCDOS 7.1 IBMDOS.COM)
 39600                                  	;;;
 39601 00006BB8 36803E[6A00]00          	cmp	byte [ss:DDMOVE],0
 39602 00006BBE 7403                    	jz      short bufwr_movsw ; skip 32bit prefix
 39603 00006BC0 D1E9                    	shr     cx,1
 39604 00006BC2 66                      	db	66h	; 32bit op prefix (rep movsd)
 39605                                  bufwr_movsw:	
 39606 00006BC3 F3A5                    	rep	movsw	
 39607                                  	;;;
 39608 00006BC5 06                      	push	es
 39609 00006BC6 1F                      	pop	ds
 39610 00006BC7 07                      	pop	es
 39611 00006BC8 59                      	pop	cx
 39612                                  NBUFFINHMA:
 39613 00006BC9 E88CD4                  	call	DWRITE		; Write out the dirty buffer
 39614 00006BCC 1F                      	pop	ds ; ********
 39615 00006BCD 5A                      	pop	dx ; *******
 39616 00006BCE 5B                      	pop	bx ; ******
 39617 00006BCF 58                      	pop	ax ; *****
 39618 00006BD0 59                      	pop	cx ; ****
 39619 00006BD1 5F                      	pop	di ; ***
 39620                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39621                                  	;;;
 39622 00006BD2 368F06[0706]            	pop	word [ss:HIGH_SECTOR]
 39623 00006BD7 5E                      	pop	si
 39624                                  	;;;
 39625 00006BD8 7201                    	JC	short NOSET
 39626 00006BDA 47                      	INC	DI		; If at least ONE write succeedes,
 39627                                  NOSET:				;    the operation succeedes.
 39628 00006BDB 01C2                    	ADD	DX,AX
 39629                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39630                                  	;;;
 39631 00006BDD 361136[0706]            	adc	[ss:HIGH_SECTOR],si
 39632                                  	;;;
 39633 00006BE2 E2AD                    	LOOP	WRTAGAIN
 39634 00006BE4 5B                      	pop	bx ; **
 39635 00006BE5 1F                      	pop	ds ; *
 39636                                  	;OR	DI,DI		; Clears carry
 39637                                  	;JNZ	short BWROK	; At least one write worked
 39638                                  	;STC			; DI never got INCed, all writes failed.
 39639                                  	; 22/09/2023
 39640 00006BE6 83FF01                  	cmp	di,1
 39641                                  BWROK:	
 39642 00006BE9 5F                      	POP	DI
 39643 00006BEA C3                      	retn
 39644                                  
 39645                                  ; 07/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 39646                                  %if 0
 39647                                  ; NOTE: Secondary Buffer Cache is not used in PCDOS 7.1 IBMDOS.COM.
 39648                                  
 39649                                  ;**	Set_RQ_SC_Parms - Set Secondary Cache Parameters
 39650                                  ;----------------------------------------------------------------------------
 39651                                  ;	Set_RQ_SC_Parms sets the sector size and drive number value
 39652                                  ;	for the secondary cache. This updates SC_SECTOR_SIZE &
 39653                                  ;	SC_DRIVE even if SC is disabled to save the testing
 39654                                  ;	code and time
 39655                                  ;
 39656                                  ;	ENTRY	ES:BP = drive parameter block
 39657                                  ;
 39658                                  ;	EXIT	[SC_SECTOR_SIZE]= drive sector size
 39659                                  ;		[SC_DRIVE]= drive #
 39660                                  ;
 39661                                  ;	USES	Flags
 39662                                  ;----------------------------------------------------------------------------
 39663                                  
 39664                                  ; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 39665                                  ; 04/05/2019 - Retro DOS v4.0
 39666                                  
 39667                                  SET_RQ_SC_PARMS:
 39668                                  ;hkn; SS override for all variables used in this procedure.
 39669                                  	push	ax
 39670                                  	;mov	ax,[es:bp+2]
 39671                                  	MOV	ax,[ES:BP+DPB.SECTOR_SIZE]	; save sector size
 39672                                  	MOV	[ss:SC_SECTOR_SIZE],ax
 39673                                  	;;mov	al,[es:bp+0]
 39674                                  	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 39675                                  	;MOV	al,[ES:BP+DPB.DRIVE]		; save drive #
 39676                                  	; 15/12/2022
 39677                                  	mov	al,[ES:BP]
 39678                                  	MOV	[ss:SC_DRIVE],al
 39679                                  	pop	ax
 39680                                  srspx:	
 39681                                  	retn					;LB. return
 39682                                  
 39683                                  %endif
 39684                                  
 39685                                  ; 07/03/2024 -Retro DOS v5.0
 39686                                  ; (PCDOS 7.1 IBMDOS.COM - DOSCODE:0AD57h)
 39687                                  %if 0
 39688                                  null_sub:
 39689                                  SET_RQ_SC_PARMS:
 39690                                  	retn
 39691                                  %endif
 39692                                  
 39693                                  ; 01/02/2024 - Retro DOS v5.0
 39694                                  ;----------------------------------------------------------------------------
 39695                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:AD58h
 39696                                  
 39697                                  SET_BUF_DIRTY:                          ; ...
 39698                                  	;test	byte [es:di+5],40h
 39699 00006BEB 26F6450540              	test	byte [es:di+BUFFINFO.buf_flags],buf_dirty
 39700 00006BF0 750A                    	jnz	short yesdirty2
 39701                                  	;or	byte [es:di+5],40h
 39702 00006BF2 26804D0540              	or	byte [es:di+BUFFINFO.buf_flags],buf_dirty
 39703                                  
 39704                                  ;INC_DIRTY_COUNT:
 39705                                  ;	inc     word [ss:DirtyBufferCount]
 39706                                  ;yesdirty2:
 39707                                  ;	retn
 39708                                  
 39709                                  ;Break	<INC_DIRTY_COUNT-increment dirty count>
 39710                                  ;----------------------------------------------------------------------------
 39711                                  ; Input:
 39712                                  ;	none
 39713                                  ; Function:
 39714                                  ;	increment dirty buffers count
 39715                                  ; Output:
 39716                                  ;	dirty buffers count is incremented
 39717                                  ;
 39718                                  ; All registers preserved
 39719                                  ;----------------------------------------------------------------------------
 39720                                  
 39721                                  INC_DIRTY_COUNT:
 39722                                  ;; BUGBUG  ---- remove this routine
 39723                                  ;; BUGBUG ---- only one instruction is needed (speed win, space loose)
 39724 00006BF7 36FF06[7100]            	inc	word [ss:DirtyBufferCount]	;hkn;
 39725                                  yesdirty2:	; 01/02/2024
 39726 00006BFC C3                      	retn
 39727                                  
 39728                                  ;Break	<DEC_DIRTY_COUNT-decrement dirty count>
 39729                                  ;----------------------------------------------------------------------------
 39730                                  ; Input:
 39731                                  ;	none
 39732                                  ; Function:
 39733                                  ;	decrement dirty buffers count
 39734                                  ; Output:
 39735                                  ;	dirty buffers count is decremented
 39736                                  ;
 39737                                  ; All registers preserved
 39738                                  ;----------------------------------------------------------------------------
 39739                                  
 39740                                  DEC_DIRTY_COUNT:
 39741 00006BFD 36833E[7100]00          	cmp	word [ss:DirtyBufferCount],0 ;hkn;
 39742 00006C03 7405                    	jz	short ddcx		; BUGBUG - shouldn't it be an
 39743 00006C05 36FF0E[7100]            	dec	word [ss:DirtyBufferCount] 
 39744                                  					; error condition to underflow here? ;hkn;
 39745                                  ddcx:	
 39746 00006C0A C3                      	retn
 39747                                  
 39748                                  ;============================================================================
 39749                                  ; MSPROC.ASM, MSDOS 6.0, 1992
 39750                                  ;============================================================================
 39751                                  ; 02/08/2018 - Retro DOS v3.0
 39752                                  ; 29/04/2019 - Retro DOS v4.0
 39753                                  ; 07/03/2024 - Retro DOS v5.0
 39754                                  
 39755                                  ; (15/04/2018 - RetrO DOS v2.0, MSDOS 2.11 - PROC.ASM - 1983)
 39756                                  
 39757                                  ; Pseudo EXEC system call for DOS
 39758                                  
 39759                                  ;	TITLE	MSPROC - process maintenance
 39760                                  ;	NAME	MSPROC
 39761                                  
 39762                                  ; =========================================================================
 39763                                  ;**	Process related system calls and low level routines for DOS 2.X.
 39764                                  ;	I/O specs are defined in DISPATCH.
 39765                                  ;
 39766                                  ;	$WAIT
 39767                                  ;	$EXEC
 39768                                  ;	$Keep_process
 39769                                  ;	Stay_resident
 39770                                  ;	$EXIT
 39771                                  ;	$ABORT
 39772                                  ;	abort_inner
 39773                                  ;
 39774                                  ;	Modification history:
 39775                                  ;
 39776                                  ;		Created: ARR 30 March 1983
 39777                                  ;		AN000	version 4.0 jan. 1988
 39778                                  ;		A007	PTM 3957 - fake vesrion for IBMCACHE.COM
 39779                                  ;		A008	PTM 4070 - fake version for MS WINDOWS
 39780                                  ;
 39781                                  ;		M000	added support for loading programs into UMBs 7/9/90
 39782                                  ;
 39783                                  ;		M004 - MS PASCAL 3.2 support. Please see under tag M003 in 
 39784                                  ;		       dossym.inc. 7/30/90
 39785                                  ;		M005 - Support for EXE programs with out STACK segment and 
 39786                                  ;		       with resident size < 64K - 256 bytes. A 256 byte 
 39787                                  ;		       stack is provided at the end of the program. Note that
 39788                                  ;		       only SP is changed.
 39789                                  ;		M020 - Fix for Rational bug for details see exepatch.asm
 39790                                  ;
 39791                                  ;		M028 - 4b04 implementation
 39792                                  ;
 39793                                  ;		M029 - Support for EXEs without stack rewritten. If EXE is
 39794                                  ;			in memory block >= 64K, sp = 0. If memory block
 39795                                  ;			obtained is <64K, point sp at the end of the memory
 39796                                  ;			block. For EXEs smaller than 64K, 256 bytes are still
 39797                                  ;			added for a stack segment which may be needed if it
 39798                                  ;			is loaded in low memory situations.
 39799                                  ;
 39800                                  ;		M030 - Fixing bug in EXEPACPATCH & changing 4b04 to 4b05
 39801                                  ;
 39802                                  ;		M040 - Bug #3052. The environment sizing code would flag a
 39803                                  ;			a bad environment if it reached 32767 bytes. Changed
 39804                                  ;			to allow 32768 bytes of environment.
 39805                                  ;
 39806                                  ;		M047 - Release the allocated UMB when we failed to load a 
 39807                                  ;		       COM file high. Also ensure that if the biggest block
 39808                                  ;		       into which we load the com file is less than 64K then
 39809                                  ;		       we provide atleast 256 bytes of stack to the user.
 39810                                  ;
 39811                                  ;		M050 - Made Lie table search CASE insensitive
 39812                                  ;
 39813                                  ;		M060 - Removed special version table from the kernal and
 39814                                  ;                      put it in a device drive which puts the address
 39815                                  ;                      in the DOS DATA area location UU_IFS_DOS_CALL
 39816                                  ;		       as a DWORD.
 39817                                  ;
 39818                                  ;		M063 - Modified UMB support. If the HIGH_ONLY bit is set on
 39819                                  ;		       entry do not try to load low if there is no space in
 39820                                  ;		       UMBs.
 39821                                  ;
 39822                                  ;		M068 - Support for copy protect apps. Call ChkCopyProt to 
 39823                                  ;		       set a20off_count. Set bit EXECA20BIT in DOS_FLAG. Also
 39824                                  ;		       change return address to LeaveDos if AL=5.
 39825                                  ;
 39826                                  ;               20-Jul-1992 bens  Added ifdef RESTRICTED_BUILD code that
 39827                                  ;                      controls building a version of MSDOS.SYS that only
 39828                                  ;                      runs programs from a fixed list (defined in the
 39829                                  ;                      file RESTRICT.INC).  Search for "RESTRICTED_BUILD"
 39830                                  ;                      for details.  This feature is used to build a
 39831                                  ;                      "special" version of DOS that can be handed out to
 39832                                  ;                      OEM/ISV customers as part of a "service" disk.
 39833                                  ;
 39834                                  ; =========================================================================
 39835                                  
 39836                                  ;SAVEXIT  EQU  10
 39837                                  
 39838                                  ;BREAK	<$WAIT - return previous process error code>
 39839                                  ; =========================================================================
 39840                                  ;	$WAIT - Return previous process error code.
 39841                                  ;
 39842                                  ;	Assembler usage:
 39843                                  ;
 39844                                  ;	    MOV     AH, WaitProcess
 39845                                  ;	    INT     int_command
 39846                                  ;
 39847                                  ;	ENTRY	none
 39848                                  ;	EXIT	(ax) = exit code
 39849                                  ;	USES	all
 39850                                  ; =========================================================================
 39851                                  
 39852                                  	; 20/05/2019 - Retro DOS v4.0
 39853                                  	; DOSCODE:9B55h (MSDOS 6.21, MSDOS.SYS)
 39854                                  
 39855                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 39856                                  	; DOSCODE:9A5Ah (MSDOS 5.0, MSDOS.SYS)
 39857                                  
 39858                                  	; 07/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 39859                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0AD78h	
 39860                                  
 39861                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:9B55h)
 39862                                  	; (Windows ME IO.SYS - BIOSCODE:944Ch)
 39863                                  
 39864                                  _$WAIT:
 39865                                  	; 02/08/2018 - Retro DOS v3.0
 39866                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5E1h
 39867                                  
 39868 00006C0B 31C0                    	xor	AX,AX
 39869 00006C0D 368706[3403]            	xchg	AX,[ss:exit_code]
 39870 00006C12 E9559A                  	jmp	SYS_RET_OK
 39871                                  
 39872                                  ; =========================================================================
 39873                                  ;BREAK <$exec - load/go a program>
 39874                                  ;	EXEC.ASM - EXEC System Call
 39875                                  ;
 39876                                  ;
 39877                                  ; Assembler usage:
 39878                                  ;	    lds     DX, Name
 39879                                  ;	    les     BX, Blk
 39880                                  ;	    mov     AH, Exec
 39881                                  ;	    mov     AL, FUNC
 39882                                  ;	    int     INT_COMMAND
 39883                                  ;
 39884                                  ;	AL  Function
 39885                                  ;	--  --------
 39886                                  ;	 0  Load and execute the program.
 39887                                  ;	 1  Load, create the program header but do not
 39888                                  ;	    begin execution.
 39889                                  ;	 3  Load overlay. No header created.
 39890                                  ;
 39891                                  ;	    AL = 0 -> load/execute program
 39892                                  ;
 39893                                  ;	    +---------------------------+
 39894                                  ;	    | WORD segment address of	|
 39895                                  ;	    | environment.		|
 39896                                  ;	    +---------------------------+
 39897                                  ;	    | DWORD pointer to ASCIZ	|
 39898                                  ;	    | command line at 80h	|
 39899                                  ;	    +---------------------------+
 39900                                  ;	    | DWORD pointer to default	|
 39901                                  ;	    | FCB to be passed at 5Ch	|
 39902                                  ;	    +---------------------------+
 39903                                  ;	    | DWORD pointer to default	|
 39904                                  ;	    | FCB to be passed at 6Ch	|
 39905                                  ;	    +---------------------------+
 39906                                  ;
 39907                                  ;	    AL = 1 -> load program
 39908                                  ;
 39909                                  ;	    +---------------------------+
 39910                                  ;	    | WORD segment address of	|
 39911                                  ;	    | environment.		|
 39912                                  ;	    +---------------------------+
 39913                                  ;	    | DWORD pointer to ASCIZ	|
 39914                                  ;	    | command line at 80h	|
 39915                                  ;	    +---------------------------+
 39916                                  ;	    | DWORD pointer to default	|
 39917                                  ;	    | FCB to be passed at 5Ch	|
 39918                                  ;	    +---------------------------+
 39919                                  ;	    | DWORD pointer to default	|
 39920                                  ;	    | FCB to be passed at 6Ch	|
 39921                                  ;	    +---------------------------+
 39922                                  ;	    | DWORD returned value of	|
 39923                                  ;	    | CS:IP			|
 39924                                  ;	    +---------------------------+
 39925                                  ;	    | DWORD returned value of	|
 39926                                  ;	    | SS:IP			|
 39927                                  ;	    +---------------------------+
 39928                                  ;
 39929                                  ;	    AL = 3 -> load overlay
 39930                                  ;
 39931                                  ;	    +---------------------------+
 39932                                  ;	    | WORD segment address where|
 39933                                  ;	    | file will be loaded.	|
 39934                                  ;	    +---------------------------+
 39935                                  ;	    | WORD relocation factor to |
 39936                                  ;	    | be applied to the image.	|
 39937                                  ;	    +---------------------------+
 39938                                  ;
 39939                                  ; Returns:
 39940                                  ;	    AX = error_invalid_function
 39941                                  ;	       = error_bad_format
 39942                                  ;	       = error_bad_environment
 39943                                  ;	       = error_not_enough_memory
 39944                                  ;	       = error_file_not_found
 39945                                  ; =========================================================================
 39946                                  ;
 39947                                  ;   Revision history:
 39948                                  ;
 39949                                  ;	 A000	version 4.00  Jan. 1988
 39950                                  ;
 39951                                  ; =========================================================================
 39952                                  
 39953                                  Exec_Internal_Buffer		EQU	OPENBUF
 39954                                  Exec_Internal_Buffer_Size	EQU	(128+128+53+curdirLen)
 39955                                  
 39956                                  ; =========================================================================
 39957                                  
 39958                                  ;IF1		; warning message on buffers
 39959                                  ;%out	Please make sure that the following are contiguous and of the
 39960                                  ;%out	following sizes:
 39961                                  ;%out
 39962                                  ;%out	OpenBuf     128
 39963                                  ;%out	RenBuf	    128
 39964                                  ;%out	SearchBuf    53
 39965                                  ;%out	DummyCDS    curdirLen
 39966                                  ;ENDIF
 39967                                  
 39968                                  ; =========================================================================
 39969                                  
 39970                                  ; =========================================================================
 39971                                  ;
 39972                                  ; =========================================================================
 39973                                  
 39974                                  	; 20/05/2019 - Retro DOS v4.0
 39975                                  	; DOSCODE:9B5Fh (MSDOS 6.21, MSDOS.SYS)
 39976                                  
 39977                                  	; 30/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 39978                                  	; DOSCODE:9B04h (MSDOS 5.0, MSDOS.SYS)
 39979                                  
 39980                                  	; 08/03/2024
 39981                                  	; 07/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 39982                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0AD82h
 39983                                  
 39984                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:9B5Fh)
 39985                                  	; (Windows ME IO.SYS - BIOSCODE:946Fh)
 39986                                  	
 39987                                  _$EXEC:
 39988                                  	; 02/08/2018 - Retro DOS v3.0
 39989                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5EF1h
 39990                                  
 39991                                  EXEC001S:
 39992                                  	;LocalVar    Exec_Blk		,DWORD
 39993                                  	;LocalVar    Exec_Func		,BYTE
 39994                                  	;LocalVar    Exec_Load_High	,BYTE
 39995                                  	;LocalVar    Exec_FH		,WORD
 39996                                  	;LocalVar    Exec_Rel_Fac	,WORD
 39997                                  	;LocalVar    Exec_Res_Len_Para	,WORD
 39998                                  	;LocalVar    Exec_Environ	,WORD
 39999                                  	;LocalVar    Exec_Size		,WORD
 40000                                  	;LocalVar    Exec_Load_Block	,WORD
 40001                                  	;LocalVar    Exec_DMA		,WORD
 40002                                  	;LocalVar    ExecNameLen 	,WORD
 40003                                  	;LocalVar    ExecName		,DWORD
 40004                                  	;
 40005                                  	;LocalVar    Exec_DMA_Save	,WORD
 40006                                  	;LocalVar    Exec_NoStack	,BYTE
 40007                                  
 40008                                  	; MSDOS 3.3 (& MSDOS 6.0)
 40009                                  	;%define	Exec_Blk	dword [bp-4]
 40010                                  	%define		Exec_Blk	[bp-4] ; 09/08/2018
 40011                                  	%define		Exec_BlkL	word [bp-4]	
 40012                                  	%define		Exec_BlkH	word [bp-2]
 40013                                  	%define		Exec_Func	byte [bp-5]
 40014                                  	%define		Exec_Load_High	byte [bp-6]
 40015                                  	%define		Exec_FH		word [bp-8]
 40016                                  	%define		Exec_Rel_Fac	word [bp-10]
 40017                                  	%define		Exec_Res_Len_Para word [bp-12]
 40018                                  	%define		Exec_Environ	word [bp-14]
 40019                                  	%define		Exec_Size	word [bp-16]
 40020                                  	%define		Exec_Load_Block	word [bp-18]
 40021                                  	%define		Exec_DMA	word [bp-20]
 40022                                  	%define		ExecNameLen	word [bp-22]
 40023                                  	;%define	ExecName	dword [bp-26]
 40024                                  	%define		ExecName	[bp-26] ; 09/08/2018
 40025                                  	%define		ExecNameL	word [bp-26]	
 40026                                  	%define		ExecNameH	word [bp-24]
 40027                                  	; MSDOS 6.0
 40028                                  	%define		Exec_DMA_Save	word [bp-28]
 40029                                  	%define		Exec_NoStack	byte [bp-29]
 40030                                  	
 40031                                  	; ==================================================================
 40032                                  	; validate function
 40033                                  	; ==================================================================
 40034                                  		      	
 40035                                  	; M068 - Start
 40036                                  	;
 40037                                  	; Reset the A20OFF_COUNT to 0. This is done as there is a 
 40038                                  	; possibility that the count may not be decremented all the way to
 40039                                  	; 0. A typical case is if the program for which we intended to keep 
 40040                                  	; the A20 off for a sufficiently long time (A20OFF_COUNT int 21 
 40041                                  	; calls), exits pre-maturely due to error conditions.
 40042                                  
 40043                                  	; MSDOS 6.0
 40044 00006C15 36C606[8500]00          	mov	byte [SS:A20OFF_COUNT], 0
 40045                                  
 40046                                  	; If al=5 (ExecReady) we'll change the return address on the stack	
 40047                                  	; to be LeaveDos in msdisp.asm. This ensures that the EXECA20OFF
 40048                                  	; bit set in DOS_FLAG by ExecReady is not cleared in msdisp.asm
 40049                                  
 40050 00006C1B 3C05                    	cmp	al,5			; Q: is this ExecReady call
 40051                                  	;jne	short @f
 40052 00006C1D 7505                    	jne	short Exec_@f		; N: continue
 40053                                  					; Y: change ret addr. to LeaveDos.
 40054 00006C1F 59                      	pop	cx			; Note CX is not input to ExecReady
 40055 00006C20 B9[F603]                	mov	cx,LeaveDOS
 40056 00006C23 51                      	push	cx
 40057                                  ;@@:
 40058                                  Exec_@f:
 40059                                  	; M068 - End
 40060                                  	
 40061                                  	;Enter
 40062                                  
 40063 00006C24 55                      	push	bp
 40064 00006C25 89E5                    	mov	bp,sp
 40065                                  	;;sub	sp,26	; MSDOS 3.3
 40066                                  	; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)	
 40067                                  	;sub	sp,29	; MSDOS 6.0 & MSDOS 6.22 & PCDOS 7.1 ; 07/03/2024
 40068                                  	; 17/12/2022
 40069                                  	; 20/05/2019
 40070 00006C27 83EC1E                  	sub	sp,30	; Retro DOS v4.0	
 40071                                  
 40072                                  	; MSDOS 6.0
 40073 00006C2A 3C05                    	cmp	AL,5			; only 0, 1, 3 or 5 are allowed ;M028
 40074                                  					; M030
 40075 00006C2C 7614                    	jna	short Exec_Check_2
 40076                                  
 40077                                  	; MSDOS 3.3
 40078                                  	;cmp	AL,3
 40079                                  	;jna	short Exec_Check_2
 40080                                  
 40081                                  Exec_Bad_Fun:
 40082 00006C2E 36C606[2303]01          	mov	byte [ss:EXTERR_LOCUS],errLOC_Unk ; 1
 40083                                  					; Extended Error Locus	;smr;SS Override
 40084                                  	;mov	al,1
 40085 00006C34 B001                    	mov	al,error_invalid_function
 40086                                  
 40087                                  Exec_Ret_Err:
 40088                                  	;Leave
 40089 00006C36 89EC                    	mov	sp,bp
 40090 00006C38 5D                      	pop	bp
 40091                                  	;transfer SYS_RET_ERR
 40092 00006C39 E9389A                  	jmp	SYS_RET_ERR
 40093                                  
 40094                                  	; MSDOS 6.0
 40095                                  ExecReadyJ:
 40096 00006C3C E8A018                  	call	ExecReady		; M028
 40097 00006C3F E91204                  	jmp	norm_ovl		; do a Leave & xfer sysret_OK ; M028
 40098                                  
 40099                                  Exec_Check_2:
 40100 00006C42 3C02                    	cmp	AL,2			
 40101 00006C44 74E8                    	je	short Exec_Bad_Fun
 40102                                  
 40103                                  	; MSDOS 6.0
 40104 00006C46 3C04                    	cmp	al,4			; 2 & 4 are not allowed
 40105 00006C48 74E4                    	je	short Exec_Bad_Fun
 40106                                  	
 40107 00006C4A 3C05                    	cmp	al,5			; M028 ; M030
 40108 00006C4C 74EE                    	je	short ExecReadyJ	; M028
 40109                                  
 40110                                  	;mov	[bp-4],bx
 40111 00006C4E 895EFC                  	mov	Exec_BlkL,BX		; stash args
 40112                                  	;mov	[bp-2],es
 40113 00006C51 8C46FE                  	mov	Exec_BlkH,ES
 40114                                  	;mov	[bp-5],al
 40115 00006C54 8846FB                  	mov	Exec_Func,AL
 40116                                  	;mov	byte [bp-6],0
 40117 00006C57 C646FA00                	mov	Exec_Load_High,0
 40118                                  
 40119                                  	;mov	[bp-26],dx
 40120 00006C5B 8956E6                  	mov	ExecNameL,DX		; set up length of exec name
 40121                                  	;mov	[bp-24],ds
 40122 00006C5E 8C5EE8                  	mov	ExecNameH,DS
 40123 00006C61 89D6                    	mov	SI,DX			; move pointer to convenient place
 40124                                  	;invoke	DStrLen
 40125 00006C63 E869AB                  	call	DStrLen
 40126                                  	;mov	[bp-22],cx
 40127 00006C66 894EEA                  	mov	ExecNameLen,CX		; save length
 40128                                  
 40129                                  	; MSDOS 6.0
 40130 00006C69 36A0[0203]              	mov	al,[ss:AllocMethod]	; M063: save alloc method in 
 40131 00006C6D 36A2[8400]              	mov	[ss:ALLOCMSAVE],al	; M063: AllocMsave
 40132                                  
 40133                                  	;xor	AL,AL			; open for reading
 40134                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 40135                                  	;;;
 40136 00006C71 B0A0                    	mov	al,0A0h			; Access mode bits: (0 to 2)
 40137                                  					; 000  read access
 40138                                  
 40139                                  					; Sharing mode bits: (4 to 6)
 40140                                  					; 010  deny others write access
 40141                                  
 40142                                  					; bit 7 - private
 40143                                  	;;;
 40144                                  
 40145 00006C73 55                      	push	BP
 40146                                  
 40147                                  	; MSDOS 6.0
 40148                                  	;or	byte [ss:DOS_FLAG],1
 40149 00006C74 36800E[8600]01          	or	byte [ss:DOS_FLAG],EXECOPEN ; this flag is set to indicate to 
 40150                                  					; the redir that this open call is
 40151                                  					; due to an exec.
 40152                                  	
 40153                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 40154                                  	;;;
 40155 00006C7A 1E                      	push	ds
 40156 00006C7B 52                      	push	dx
 40157                                  	;;;
 40158                                  
 40159                                  	;invoke	$OPEN			; is the file there?
 40160 00006C7C E87E13                  	call	_$OPEN
 40161                                  
 40162                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 40163                                  	;;;
 40164 00006C7F 5A                      	pop	dx
 40165 00006C80 1F                      	pop	ds
 40166 00006C81 7305                    	jnc	short Exec_Open_Ok
 40167                                  
 40168 00006C83 30C0                    	xor	al,al			; open for reading
 40169 00006C85 E87513                  	call	_$OPEN
 40170                                  
 40171                                  Exec_Open_Ok:
 40172                                  	;;;	
 40173                                  
 40174                                  	; MSDOS 6.0
 40175 00006C88 9C                      	pushf
 40176                                  	; 02/06/2019
 40177                                  	;and	byte [ss:DOS_FLAG],0FEh
 40178 00006C89 368026[8600]FE          	and	byte [ss:DOS_FLAG],~EXECOPEN ; reset flag
 40179 00006C8F 9D                      	popf
 40180                                  
 40181 00006C90 5D                      	pop	BP
 40182                                  
 40183                                  	; MSDOS 3.3 & MSDOS 6.0
 40184 00006C91 72A3                    	jc	short Exec_Ret_Err
 40185                                  
 40186                                  	;mov	[bp-8],ax
 40187 00006C93 8946F8                  	mov	Exec_FH,AX
 40188 00006C96 89C3                    	mov	BX,AX
 40189 00006C98 30C0                    	xor	AL,AL
 40190                                  	;invoke	$Ioctl
 40191 00006C9A E8EDBB                  	call	_$IOCTL
 40192 00006C9D 7207                    	jc	short Exec_BombJ
 40193                                  
 40194                                  	;test	dl,80h
 40195 00006C9F F6C280                  	test	DL,devid_ISDEV
 40196 00006CA2 740A                    	jz	short Exec_Check_Environ
 40197                                  
 40198                                  	;mov	al,2
 40199 00006CA4 B002                    	mov	AL,error_file_not_found
 40200                                  Exec_BombJ:
 40201 00006CA6 E9C800                  	jmp	Exec_Bomb
 40202                                  
 40203                                  BadEnv:
 40204                                  	;mov	al,0Ah
 40205 00006CA9 B00A                    	mov	AL,error_bad_environment
 40206 00006CAB E9C300                  	jmp	Exec_Bomb
 40207                                  
 40208                                  Exec_Check_Environ:
 40209                                  	;mov	word [bp-18],0
 40210 00006CAE C746EE0000              	mov	Exec_Load_Block,0
 40211                                  	;mov	word [bp-14],0
 40212 00006CB3 C746F20000              	mov	Exec_Environ,0
 40213                                  					; overlays... no environment
 40214                                  	;test	byte [bp-5],2
 40215 00006CB8 F646FB02                	test	Exec_Func,exec_func_overlay
 40216 00006CBC 7552                    	jnz	short Exec_Read_Header
 40217                                  
 40218                                  	;lds	si,[bp-4]
 40219 00006CBE C576FC                  	lds	SI,Exec_Blk		; get block
 40220 00006CC1 8B04                    	mov	ax,[SI]
 40221                                  	;mov	AX,[SI+EXEC1.ENVIRON]	; address of environ
 40222 00006CC3 09C0                    	or	AX,AX
 40223 00006CC5 750C                    	jnz	short Exec_Scan_Env
 40224                                  
 40225 00006CC7 368E1E[3003]            	mov	DS,[SS:CurrentPDB]	;smr;SS Override
 40226                                  	;mov	ax,[44]
 40227 00006CCC A12C00                  	mov	AX,[PDB.ENVIRON]
 40228                                  
 40229                                  ; MSDOS 6.0
 40230                                  ;---------------------------------------------BUG 92 4/30/90-----------------
 40231                                  ;
 40232                                  ; Exec_environ is being correctly initialized after the environment has been
 40233                                  ; allocated and copied form the parent's env. It must not be initialized here.
 40234                                  ; Because if the call to $alloc below fails Exec_dealloc will deallocate the
 40235                                  ; parent's environment.
 40236                                  ;	mov	Exec_Environ,AX
 40237                                  ;
 40238                                  ;----------------------------------------------------------------------------
 40239                                  
 40240                                  	;mov	[bp-14],ax
 40241                                  	;mov	Exec_Environ,ax
 40242                                  
 40243 00006CCF 09C0                    	or	AX,AX
 40244 00006CD1 743D                    	jz	short Exec_Read_Header
 40245                                  
 40246                                  Exec_Scan_Env:
 40247 00006CD3 8EC0                    	mov	ES,AX
 40248 00006CD5 31FF                    	xor	DI,DI
 40249                                  	;mov	cx,7FFFh ; MSDOS 3.3
 40250 00006CD7 B90080                  	mov	CX,8000h ; MSDOS 6.0	; at most 32k of environment ;M040
 40251 00006CDA 30C0                    	xor	AL,AL
 40252                                  
 40253                                  Exec_Get_Environ_Len:
 40254 00006CDC F2AE                    	repnz	scasb			; find that nul byte
 40255 00006CDE 75C9                    	jnz	short BadEnv
 40256                                  
 40257 00006CE0 49                      	dec	CX			; Dec CX for the next nul byte test
 40258 00006CE1 78C6                    	js	short BadEnv		; gone beyond the end of the environment
 40259                                  
 40260 00006CE3 AE                      	scasb				; is there another nul byte?
 40261 00006CE4 75F6                    	jnz	short Exec_Get_Environ_Len ; no, scan some more
 40262                                  
 40263 00006CE6 57                      	push	DI
 40264                                  	;lea	bx,[DI+11h]
 40265 00006CE7 8D5D11                  	lea	BX,[DI+0Fh+2]
 40266                                  	;add	bx,[bp-22]
 40267 00006CEA 035EEA                  	add	BX,ExecNameLen		; BX <- length of environment
 40268                                  					; remember argv[0] length
 40269                                  					; round up and remember argc
 40270 00006CED B104                    	mov	CL,4
 40271 00006CEF D3EB                    	shr	BX,CL			; number of paragraphs needed
 40272 00006CF1 06                      	push	ES
 40273                                  	;invoke	$Alloc			; can we get the space?
 40274 00006CF2 E84306                  	call	_$ALLOC
 40275 00006CF5 1F                      	pop	DS
 40276 00006CF6 59                      	pop	CX
 40277                                  
 40278                                  	;jnc	short Exec_Save_Environ
 40279                                  	;jmp	SHORT Exec_No_Mem	; nope... cry and sob
 40280                                  	; 17/12/2022
 40281 00006CF7 7272                    	jc	short Exec_No_Mem ; 02/06/2019
 40282                                  	; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)
 40283                                  	;jnc	short Exec_Save_Environ
 40284                                  	;jmp	SHORT Exec_No_Mem
 40285                                  
 40286                                  Exec_Save_Environ:
 40287 00006CF9 8EC0                    	mov	ES,AX
 40288                                  	;mov	[bp-14],ax
 40289 00006CFB 8946F2                  	mov	Exec_Environ,AX 	; save him for a rainy day
 40290 00006CFE 31F6                    	xor	SI,SI
 40291 00006D00 89F7                    	mov	DI,SI
 40292 00006D02 F3A4                    	rep	movsb			; copy the environment
 40293 00006D04 B80100                  	mov	AX,1
 40294 00006D07 AB                      	stosw
 40295                                  	;lds	si,[bp-26]
 40296 00006D08 C576E6                  	lds	SI,ExecName
 40297                                  	;mov	cx,[bp-22]
 40298 00006D0B 8B4EEA                  	mov	CX,ExecNameLen
 40299 00006D0E F3A4                    	rep	movsb
 40300                                  
 40301                                  Exec_Read_Header:
 40302                                  	; We read in the program header into the above data area and
 40303                                  	; determine where in this memory the image will be located.
 40304                                  
 40305                                  	;Context DS
 40306 00006D10 16                      	push	ss
 40307 00006D11 1F                      	pop	ds
 40308                                  	;mov	cx,26
 40309 00006D12 B91A00                  	mov	CX,exec_header_len	; header size
 40310 00006D15 BA[C70E]                	mov	DX,exec_signature
 40311 00006D18 06                      	push	ES
 40312 00006D19 1E                      	push	DS
 40313 00006D1A E87C04                  	call	ExecRead
 40314 00006D1D 1F                      	pop	DS
 40315 00006D1E 07                      	pop	ES
 40316 00006D1F 724E                    	jc	short Exec_Bad_File
 40317                                  
 40318 00006D21 09C0                    	or	AX,AX
 40319 00006D23 744A                    	jz	short Exec_Bad_File
 40320                                  	;cmp	ax,26
 40321 00006D25 83F81A                  	cmp	AX,exec_header_len	; did we read the right number?
 40322 00006D28 7519                    	jnz	short Exec_Com_Filej	; yep... continue
 40323                                  
 40324 00006D2A F706[D30E]FFFF          	test	word [exec_max_BSS],-1 	; indicate load high?
 40325 00006D30 7504                    	jnz	short Exec_Check_Sig
 40326                                  
 40327                                  	;mov	byte [bp-6],0FFh
 40328 00006D32 C646FAFF                	mov	Exec_Load_High,-1
 40329                                  
 40330                                  Exec_Check_Sig:
 40331 00006D36 A1[C70E]                	mov	AX,[exec_signature]	; rms;NSS
 40332                                  	;cmp	ax,5A4Dh ; 'MZ'
 40333 00006D39 3D4D5A                  	cmp	AX,exe_valid_signature	; zibo arises!
 40334 00006D3C 7408                    	jz	short Exec_Save_Start 	; assume com file if no signature
 40335                                  
 40336                                  	;cmp	ax,4D5Ah ; 'ZM'
 40337 00006D3E 3D5A4D                  	cmp	AX,exe_valid_old_signature ; zibo arises!
 40338 00006D41 7403                    	jz	short Exec_Save_Start 	; assume com file if no signature
 40339                                  
 40340                                  Exec_Com_Filej:
 40341 00006D43 E9EC01                  	jmp	Exec_Com_File
 40342                                  
 40343                                  	; We have the program header... determine memory requirements
 40344                                  
 40345                                  Exec_Save_Start:
 40346 00006D46 A1[CB0E]                	mov	AX,[exec_pages]		; get 512-byte pages	;rms;NSS
 40347 00006D49 B105                    	mov	CL,5			; convert to paragraphs
 40348 00006D4B D3E0                    	shl	AX,CL
 40349 00006D4D 2B06[CF0E]              	sub	AX,[exec_par_dir] 	; AX = size in paragraphs ;rms;NSS
 40350                                  	;mov	[bp-12],ax
 40351 00006D51 8946F4                  	mov	Exec_Res_Len_Para,AX
 40352                                  
 40353                                  		; Do we need to allocate memory?
 40354                                  		; Yes if function is not load-overlay
 40355                                  
 40356                                  	;test	byte [bp-5],2
 40357 00006D54 F646FB02                	test	Exec_Func,exec_func_overlay
 40358 00006D58 7443                    	jz	short Exec_Allocate	; allocation of space
 40359                                  
 40360                                  		; get load address from block
 40361                                  
 40362                                  	;les	di,[bp-4]
 40363 00006D5A C47EFC                  	les	DI,Exec_Blk
 40364                                  
 40365                                  ; 07/03/2024
 40366                                  %if 0
 40367                                  	mov	ax,[es:di]
 40368                                  	;mov	AX,[ES:DI+EXEC3.load_addr]
 40369                                  	;mov	[bp-20],ax
 40370                                  	mov	Exec_DMA,AX
 40371                                  
 40372                                  	; 17/12/2022
 40373                                  	;;mov	ax,[es:di+2]
 40374                                  	;mov	AX,[ES:DI+EXEC3.reloc_fac]
 40375                                  	;;mov	[bp-10],ax
 40376                                  	;mov	Exec_Rel_Fac,AX
 40377                                  
 40378                                  	; 17/12/2022
 40379                                  	; 30/11/2022 (!most proper code!)
 40380                                  	;mov	dx,[es:di+2]
 40381                                  	mov	dx,[ES:DI+EXEC3.reloc_fac]
 40382                                  	;mov	[bp-10],dx
 40383                                  	mov	Exec_Rel_Fac,dx
 40384                                  %else
 40385                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 40386                                  	;;;
 40387 00006D5D 06                      	push	es
 40388 00006D5E 26C405                  	les	ax,[es:di]
 40389                                  	;les	ax,[ES:DI+EXEC3.load_addr]
 40390                                  	;mov	[bp-20],ax
 40391 00006D61 8946EC                  	mov	Exec_DMA,ax
 40392                                  	;mov	[bp-10],es
 40393 00006D64 8C46F6                  	mov	Exec_Rel_Fac,es
 40394 00006D67 07                      	pop	es
 40395                                  	;;;
 40396                                  %endif
 40397                                  	; ax = Exec_DMA
 40398 00006D68 E9DE00                  	jmp	Exec_Find_Res
 40399                                  
 40400                                  ; 17/12/2022
 40401                                  ; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)
 40402                                  ; 27/09/2023
 40403                                  %if 0
 40404                                  	; 02/06/2019 - Retro DOS v4.0
 40405                                  	;mov	ax,[bp-20]  ; *+*
 40406                                  	mov	AX,Exec_DMA ; *+*
 40407                                  	; 10/08/2018
 40408                                  	jmp	Exec_Find_Res		; M000
 40409                                  %endif
 40410                                  
 40411                                  Exec_No_Mem:
 40412                                  	;mov	al,8
 40413 00006D6B B008                    	mov	AL,error_not_enough_memory
 40414 00006D6D EB02                    	jmp	short Exec_Bomb
 40415                                  
 40416                                  Exec_Bad_File:
 40417                                  	;mov	al,0Bh
 40418 00006D6F B00B                    	mov	AL,error_bad_format
 40419                                  
 40420                                  Exec_Bomb:
 40421                                  	;mov	bx,[bp-8]
 40422 00006D71 8B5EF8                  	mov	BX,Exec_FH
 40423 00006D74 E83B04                  	call	Exec_Dealloc
 40424                                  	;LeaveCrit CritMem
 40425 00006D77 E896AB                  	call	LCritMEM
 40426                                  	;save	<AX,BP>
 40427 00006D7A 50                      	push	ax
 40428 00006D7B 55                      	push	bp
 40429                                  	;invoke	$CLOSE
 40430 00006D7C E81B0A                  	call	_$CLOSE
 40431                                  	;restore <BP,AX>
 40432 00006D7F 5D                      	pop	bp
 40433 00006D80 58                      	pop	ax
 40434 00006D81 E9B2FE                  	jmp	Exec_Ret_Err
 40435                                  
 40436                                  Exec_Chk_Mem: 
 40437                                  
 40438                                  	; 24/09/2023
 40439                                  	; ds = DOSDATA
 40440                                  ; 17/12/2022
 40441                                  ; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)
 40442                                  ;%if 0
 40443                                  	; MSDOS 6.0    			; M063 - Start
 40444                                  	;mov	al,[ss:AllocMethod]	; save current alloc method in ax
 40445                                  	; 10/06/2019
 40446 00006D84 A0[0203]                	mov	al,[AllocMethod]
 40447                                  	;mov	bl,[ss:ALLOCMSAVE]
 40448 00006D87 8A1E[8400]              	mov	bl,[ALLOCMSAVE]
 40449                                  	;mov	[ss:AllocMethod],bl	; restore original allocmethod
 40450 00006D8B 881E[0203]              	mov	[AllocMethod],bl
 40451                                  	
 40452 00006D8F F6C340                  	test	bl,HIGH_ONLY ; 40h	; Q: was the HIGH_ONLY bit already set
 40453 00006D92 75D7                    	jnz	short Exec_No_Mem	; Y: no space in UMBs. Quit
 40454                                  	;				; N: continue
 40455                                  	;
 40456 00006D94 A840                    	test	al,HIGH_ONLY		; Q: did we set the HIGH_ONLY bit
 40457 00006D96 74D3                    	jz	short Exec_No_Mem	; N: no memory
 40458                                  	; 02/06/2019
 40459                                  	;mov	ax,[ss:SAVE_AX]		; Y: restore ax and
 40460 00006D98 A1[8A00]                	mov	ax,[SAVE_AX]
 40461                                  	;jmp	short Exec_Norm_Alloc	;    Try again
 40462                                  					; M063 - End
 40463 00006D9B EB2B                    	jmp	short Exec_Norm_Alloc1
 40464                                  ;%endif
 40465                                  
 40466                                  ; 17/12/2022
 40467                                  %if 0
 40468                                  	; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)
 40469                                  	; MSDOS 6.0    			; M063 - Start
 40470                                  	mov	al,[ss:AllocMethod]	; save current alloc method in ax
 40471                                  	mov	bl,[ss:ALLOCMSAVE]
 40472                                  	mov	[ss:AllocMethod],bl	; restore original allocmethod
 40473                                  
 40474                                  	test	bl,HIGH_ONLY ; 40h	; Q: was the HIGH_ONLY bit already set
 40475                                  	jnz	short Exec_No_Mem	; Y: no space in UMBs. Quit
 40476                                  	;				; N: continue
 40477                                  	;
 40478                                  	test	al,HIGH_ONLY		; Q: did we set the HIGH_ONLY bit
 40479                                  	jz	short Exec_No_Mem	; N: no memory
 40480                                  
 40481                                  	mov	ax,[ss:SAVE_AX]		; Y: restore ax and
 40482                                  	jmp	short Exec_Norm_Alloc	;    Try again
 40483                                  					; M063 - End
 40484                                  %endif
 40485                                  
 40486                                  Exec_Allocate:
 40487                                  	; 09/09/2018
 40488                                  
 40489                                  	; M005 - START
 40490                                  	; If there is no STACK segment for this exe file and if this
 40491                                  	; not an overlay and the resident size is less than 64K - 
 40492                                  	; 256 bytes we shall add 256 bytes to the programs 
 40493                                  	; resident memory requirement and set Exec_SP to this value.
 40494                                  	
 40495                                  	; 17/12/2022
 40496 00006D9D 29DB                    	sub	bx,bx ; 0	
 40497                                  
 40498                                  	; MSDOS 6.0
 40499                                  	;;mov	byte [bp-29],0
 40500                                  	;mov	Exec_NoStack,0
 40501                                  	; 17/12/2022
 40502 00006D9F 885EE3                  	mov	Exec_NoStack,bl ; 0
 40503 00006DA2 391E[D50E]              	cmp	[exec_SS],bx ; 0
 40504                                  	;cmp	word [exec_SS],0	; Q: is there a stack seg
 40505 00006DA6 7511                    	jne	short ea1		; Y: continue normal processing
 40506 00006DA8 391E[D70E]              	cmp	[exec_SP],bx ; 0
 40507                                  	;cmp	word [exec_SP],0	; Q: is there a stack ptr
 40508 00006DAC 750B                    	jne	short ea1		; Y: continue normal processing
 40509                                  
 40510                                  	;inc	byte [bp-29]
 40511 00006DAE FE46E3                  	inc	Exec_NoStack
 40512 00006DB1 3DF00F                  	cmp	ax,1000h-10h ; 0FF0h	; Q: is this >= 64K-256 bytes
 40513 00006DB4 7303                    	jae	short ea1		; Y: don't set Exec_SP
 40514                                  
 40515 00006DB6 83C010                  	add	ax,10h			; add 10h paras to mem requirement
 40516                                  ea1:
 40517                                  	; M005 - END
 40518                                  
 40519                                  	; MSDOS 6.0			; M000 - start
 40520                                  	; 20/05/2019
 40521                                  	; (ds = ss = DOSDATA)
 40522 00006DB9 F606[0203]80            	test	byte [AllocMethod],HIGH_FIRST ; 80h
 40523                                  					; Q: is the alloc strat high_first
 40524 00006DBE 7405                    	jz	short Exec_Norm_Alloc	; N: normal allocate
 40525                                  					; Y: set high_only bit
 40526 00006DC0 800E[0203]40            	or	byte [AllocMethod],HIGH_ONLY ; 40h
 40527                                  					; M000 - end
 40528                                  Exec_Norm_Alloc:
 40529 00006DC5 A3[8A00]                	mov	[SAVE_AX],ax		; M000: save ax for possible 2nd
 40530                                  Exec_Norm_Alloc1:	; 02/06/2019
 40531                                  					; M000: attempt at allocating memory
 40532                                  	; MSDOS 3.3
 40533                                  	;push	ax			; M000
 40534                                  
 40535 00006DC8 BBFFFF                  	mov	BX,0FFFFh		; see how much room in arena
 40536 00006DCB 1E                      	push	DS
 40537                                  	;invoke	$Alloc			; should have carry set and BX has max
 40538 00006DCC E86905                  	call	_$ALLOC
 40539 00006DCF 1F                      	pop	DS
 40540                                  
 40541                                  	; MSDOS 6.0
 40542 00006DD0 A1[8A00]                	mov	AX,[SAVE_AX]		; M000
 40543                                  	; MSDOS 3.3
 40544                                  	;pop	ax			; M000
 40545                                  
 40546 00006DD3 83C010                  	add	AX,10h			; room for header
 40547 00006DD6 83FB11                  	cmp	BX,11h			; enough room for a header
 40548                                  	; MSDOS 6.0
 40549 00006DD9 72A9                    	jb	short Exec_Chk_Mem	; M000
 40550                                  	; MSDOS 3.3	
 40551                                  	;jb	short Exec_No_Mem
 40552                                  
 40553 00006DDB 39D8                    	cmp	AX,BX			; is there enough for bare image?
 40554                                  	; MSDOS 6.0
 40555 00006DDD 77A5                    	ja	short Exec_Chk_Mem	; M000
 40556                                  	; MSDOS 3.3
 40557                                  	;ja	short Exec_No_Mem
 40558                                  
 40559                                  	;test	byte [bp-6],0FFh
 40560 00006DDF F646FAFF                	test	Exec_Load_High,-1	; if load high, use max
 40561 00006DE3 7518                    	jnz	short Exec_BX_Max	; use max
 40562                                  
 40563                                  	; 09/09/2018
 40564                                  
 40565 00006DE5 0306[D10E]              	add	AX,[exec_min_BSS] 	; go for min allocation;rms;NSS
 40566                                  	; MSDOS 6.0
 40567 00006DE9 7299                    	jc	short Exec_Chk_Mem	; M000
 40568                                  	; MSDOS 3.3
 40569                                  	;jc	short Exec_No_Mem
 40570                                  
 40571 00006DEB 39D8                    	cmp	AX,BX			; enough space?
 40572                                  	; MSDOS 6.0
 40573 00006DED 7795                    	ja	short Exec_Chk_Mem	; M000: nope...
 40574                                  	; MSDOS 3.3
 40575                                  	;ja	short Exec_No_Mem
 40576                                  
 40577 00006DEF 2B06[D10E]              	sub	AX,[exec_min_BSS] 	; rms;NSS
 40578 00006DF3 0306[D30E]              	add	AX,[exec_max_BSS] 	; go for the MAX
 40579 00006DF7 7204                    	jc	short Exec_BX_Max
 40580                                  
 40581 00006DF9 39D8                    	cmp	AX,BX
 40582 00006DFB 7602                    	jbe	short Exec_Got_Block
 40583                                  
 40584                                  Exec_BX_Max:
 40585 00006DFD 89D8                    	mov	AX,BX
 40586                                  
 40587                                  Exec_Got_Block:
 40588                                  	; 03/08/2018 - Retro DOS v3.0
 40589                                  
 40590 00006DFF 1E                      	push	DS
 40591 00006E00 89C3                    	mov	BX,AX
 40592                                  	;mov	[bp-16],bx
 40593 00006E02 895EF0                  	mov	Exec_Size,BX
 40594                                  	;invoke	$Alloc			; get the space
 40595 00006E05 E83005                  	call	_$ALLOC
 40596 00006E08 1F                      	pop	DS
 40597                                  	; MSDOS 6.0
 40598                                  	;jc	short Exec_Chk_Mem	; M000
 40599                                  	; MSDOS 3.3
 40600                                  	;;jc	short Exec_No_Mem
 40601                                  	; 20/05/2019
 40602 00006E09 7303                    	jnc	short ea0
 40603 00006E0B E976FF                  	jmp	Exec_Chk_Mem
 40604                                  ea0:
 40605                                  	; MSDOS 6.0
 40606 00006E0E 8A0E[8400]              	mov	cl,[ALLOCMSAVE]		; M063: 
 40607 00006E12 880E[0203]              	mov	[AllocMethod],cl	; M063: restore allocmethod
 40608                                  
 40609                                  ;M029; Begin changes
 40610                                  ; This code does special handling for programs with no stack segment. If so,
 40611                                  ;check if the current block is larger than 64K. If so, we do not modify
 40612                                  ;Exec_SP. If smaller than 64K, we make Exec_SP = top of block. In either
 40613                                  ;case Exec_SS is not changed.
 40614                                  
 40615                                  	; MSDOS 6.0
 40616                                  	;cmp	byte [bp-29],0
 40617 00006E16 807EE300                	cmp	Exec_NoStack,0
 40618                                  	;je	@f
 40619 00006E1A 7412                    	je	short ea2
 40620                                  
 40621 00006E1C 81FB0010                	cmp	bx,1000h		; Q: >= 64K memory block
 40622                                  	;jae	@f			; Y: Exec_SP = 0
 40623 00006E20 730C                    	jae	short ea2
 40624                                  
 40625                                  ;Make Exec_SP point at the top of the memory block
 40626                                  
 40627 00006E22 B104                    	mov	cl,4
 40628 00006E24 D3E3                    	shl	bx,cl			; get byte offset
 40629 00006E26 81EB0001                	sub	bx,100h			; take care of PSP
 40630 00006E2A 891E[D70E]              	mov	[exec_SP],bx		; Exec_SP = top of block
 40631                                  ea2:
 40632                                  ;@@:
 40633                                  ;M029; end changes
 40634                                  
 40635                                  	;mov	[bp-18],ax
 40636 00006E2E 8946EE                  	mov	Exec_Load_Block,AX
 40637 00006E31 83C010                  	add	AX,10h
 40638                                  	;test	byte [bp-6],0FFh
 40639 00006E34 F646FAFF                	test	Exec_Load_High,-1
 40640 00006E38 7409                    	jz	short Exec_Use_AX	; use ax for load info
 40641                                  
 40642                                  	;add	ax,[bp-16]
 40643 00006E3A 0346F0                  	add	AX,Exec_Size		; go to end
 40644                                  	;sub	ax,[bp-12]
 40645 00006E3D 2B46F4                  	sub	AX,Exec_Res_Len_Para	; drop off header
 40646 00006E40 83E810                  	sub	AX,10h			; drop off pdb
 40647                                  
 40648                                  Exec_Use_AX:
 40649                                  	;mov	[bp-10],ax
 40650 00006E43 8946F6                  	mov	Exec_Rel_Fac,AX 	; new segment
 40651                                  	;mov	[bp-20],ax
 40652 00006E46 8946EC                  	mov	Exec_DMA,AX ; *+*	; beginning of dma
 40653                                  
 40654                                  	; Determine the location in the file of the beginning of
 40655                                  	; the resident
 40656                                  
 40657                                  ; 17/12/2022
 40658                                  ; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)
 40659                                  ;%if 0
 40660                                  
 40661                                  Exec_Find_Res:
 40662                                  	; MSDOS 6.0
 40663                                  	;;mov	dx,[bp-20]
 40664                                  	;mov	DX,Exec_DMA ; *+*
 40665                                  	;;mov	[bp-28],dx
 40666                                  	;mov	Exec_DMA_Save,DX
 40667                                  
 40668                                  	; 17/12/2022
 40669                                  	; AX = Exec_DMA
 40670                                  
 40671                                  	; 02/06/2019 - Retro DOS v4.0
 40672                                  	;mov	[bp-28],ax ; *+*
 40673 00006E49 8946E4                  	mov	Exec_DMA_Save,AX ; *+*
 40674                                  
 40675                                  ;%endif
 40676                                  
 40677                                  ; 17/12/2022
 40678                                  %if 0
 40679                                  	; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)
 40680                                  Exec_Find_Res:
 40681                                  	;mov	dx,[bp-20]
 40682                                  	mov	DX,Exec_DMA ; *+*
 40683                                  	;mov	[bp-28],dx
 40684                                  	mov	Exec_DMA_Save,DX
 40685                                  %endif
 40686                                  
 40687                                  	; MSDOS 3.3 (& MSDOS 6.0)
 40688 00006E4C 8B16[CF0E]              	mov	DX,[exec_par_dir]
 40689 00006E50 52                      	push	DX
 40690 00006E51 B104                    	mov	CL,4
 40691 00006E53 D3E2                    	shl	DX,CL			; low word of location
 40692 00006E55 58                      	pop	AX
 40693 00006E56 B10C                    	mov	CL,12
 40694 00006E58 D3E8                    	shr	AX,CL			; high word of location
 40695 00006E5A 89C1                    	mov	CX,AX			; CX <- high
 40696                                  
 40697                                  		; Read in the resident image (first, seek to it)
 40698                                  	;mov	bx,[bp-8]
 40699 00006E5C 8B5EF8                  	mov	BX,Exec_FH
 40700 00006E5F 1E                      	push	DS
 40701 00006E60 30C0                    	xor	AL,AL
 40702                                  	;invoke	$Lseek			; Seek to resident
 40703 00006E62 E89F0A                  	call	_$LSEEK
 40704 00006E65 1F                      	pop	DS
 40705 00006E66 7303                    	jnc	short Exec_Big_Read
 40706                                  
 40707 00006E68 E906FF                  	jmp	Exec_Bomb
 40708                                  
 40709                                  Exec_Big_Read:				; Read resident into memory
 40710                                  	;mov	bx,[bp-12]
 40711 00006E6B 8B5EF4                  	mov	BX,Exec_Res_Len_Para
 40712 00006E6E 81FB0010                	cmp	BX,1000h		; Too many bytes to read?
 40713 00006E72 7203                    	jb	short Exec_Read_OK
 40714                                  
 40715 00006E74 BBE00F                  	mov	BX,0FE0h		; Max in one chunk FE00 bytes
 40716                                  
 40717                                  Exec_Read_OK:
 40718                                  	;sub	[bp-12],bx
 40719 00006E77 295EF4                  	sub	Exec_Res_Len_Para,BX	; We read (soon) this many
 40720 00006E7A 53                      	push	BX
 40721 00006E7B B104                    	mov	CL,4
 40722 00006E7D D3E3                    	shl	BX,CL			; Get count in bytes from paras
 40723 00006E7F 89D9                    	mov	CX,BX			; Count in correct register
 40724 00006E81 1E                      	push	DS
 40725                                  	;mov	ds,[bp-20]
 40726 00006E82 8E5EEC                  	mov	DS,Exec_DMA		; Set up read buffer
 40727                                  
 40728 00006E85 31D2                    	xor	DX,DX
 40729 00006E87 51                      	push	CX			; Save our count
 40730 00006E88 E80E03                  	call	ExecRead
 40731 00006E8B 59                      	pop	CX			; Get old count to verify
 40732 00006E8C 1F                      	pop	DS
 40733 00006E8D 7248                    	jc	short Exec_Bad_FileJ
 40734                                  
 40735 00006E8F 39C1                    	cmp	CX,AX			; Did we read enough?
 40736 00006E91 5B                      	pop	BX			; Get paragraph count back
 40737 00006E92 7408                    	jz	short ExecCheckEnd	; and do reloc if no more to read
 40738                                  
 40739                                  	; The read did not match the request. If we are off by 512
 40740                                  	; bytes or more then the header lied and we have an error.
 40741                                  
 40742 00006E94 29C1                    	sub	CX,AX
 40743 00006E96 81F90002                	cmp	CX,512
 40744 00006E9A 733B                    	jae	short Exec_Bad_FileJ
 40745                                  
 40746                                  	; We've read in CX bytes... bump DTA location
 40747                                  
 40748                                  ExecCheckEnd:
 40749                                  	;add	[bp-20],bx
 40750 00006E9C 015EEC                  	add	Exec_DMA,BX		; Bump dma address
 40751                                  	;test	word [bp-12],0FFFFh
 40752 00006E9F F746F4FFFF              	test	Exec_Res_Len_Para,-1
 40753 00006EA4 75C5                    	jnz	short Exec_Big_Read
 40754                                  
 40755                                  	; The image has now been read in. We must perform relocation
 40756                                  	; to the current location.
 40757                                  
 40758                                  exec_do_reloc:
 40759                                  	;mov	cx,[bp-10]
 40760 00006EA6 8B4EF6                  	mov	CX,Exec_Rel_Fac
 40761 00006EA9 A1[D50E]                	mov	AX,[exec_SS]		; get initial SS ;rms;NSS
 40762 00006EAC 01C8                    	add	AX,CX			; and relocate him
 40763 00006EAE A3[C10E]                	mov	[exec_init_SS],AX 	; rms;NSS
 40764                                  
 40765 00006EB1 A1[D70E]                	mov	AX,[exec_SP]		; initial SP ;rms;NSS
 40766 00006EB4 A3[BF0E]                	mov	[exec_init_SP],AX 	; rms;NSS
 40767                                  
 40768 00006EB7 C406[DB0E]              	les	AX,[exec_IP]		; rms;NSS
 40769 00006EBB A3[C30E]                	mov	[exec_init_IP],AX 	; rms;NSS
 40770 00006EBE 8CC0                    	mov	AX,ES			; rms;NSS
 40771 00006EC0 01C8                    	add	AX,CX			; relocated...
 40772 00006EC2 A3[C50E]                	mov	[exec_init_CS],AX 	; rms;NSS
 40773                                  
 40774 00006EC5 31C9                    	xor	CX,CX
 40775 00006EC7 8B16[DF0E]              	mov	DX,[exec_rle_table]	; rms;NSS
 40776                                  	;mov	bx,[bp-8]
 40777 00006ECB 8B5EF8                  	mov	BX,Exec_FH
 40778 00006ECE 1E                      	push	DS
 40779 00006ECF 31C0                    	xor	AX,AX
 40780                                  	;invoke	$Lseek
 40781 00006ED1 E8300A                  	call	_$LSEEK
 40782 00006ED4 1F                      	pop	DS
 40783 00006ED5 7303                    	jnc	short exec_get_entries
 40784                                  
 40785                                  Exec_Bad_FileJ:
 40786 00006ED7 E995FE                  	jmp	Exec_Bad_File
 40787                                  
 40788                                  exec_get_entries:
 40789 00006EDA 8B16[CD0E]              	mov	DX,[exec_rle_count]	; Number of entries left ;rms;NSS
 40790                                  
 40791                                  exec_read_reloc:
 40792 00006EDE 52                      	push	DX
 40793                                  	;mov	dx,OPENBUF
 40794 00006EDF BA[BE03]                	mov	DX,Exec_Internal_Buffer
 40795                                  	;;mov	cx,388 ; MSDOS 3.3 ; (390>>2)<<2
 40796                                  	;mov	cx,396 ; MSDOS 6.0	; PCDOS 7.1 (08/03/2024)
 40797 00006EE2 B98C01                  	mov	CX,((Exec_Internal_Buffer_Size)/4)*4 ; (397>>2)<<2
 40798 00006EE5 1E                      	push	DS
 40799 00006EE6 E8B002                  	call	ExecRead
 40800 00006EE9 07                      	pop	ES
 40801 00006EEA 5A                      	pop	DX
 40802 00006EEB 72EA                    	jc	short Exec_Bad_FileJ
 40803                                  
 40804                                  	;;mov	cx,97 ;  MSDOS 3.3 ; (390>>2)
 40805                                  	;mov	cx,99 ; MSDOS 6.0	; PCDOS 7.1 (08/03/2024)
 40806 00006EED B96300                  	mov	CX,(Exec_Internal_Buffer_Size)/4 ; (397>>2)
 40807                                  					; Pointer to byte location in header
 40808                                  	;mov	di,OPENBUF
 40809 00006EF0 BF[BE03]                	mov	DI,Exec_Internal_Buffer
 40810                                  	;mov	si,[bp-10]
 40811 00006EF3 8B76F6                  	mov	SI,Exec_Rel_Fac 	; Relocate a single address
 40812                                  
 40813                                  exec_reloc_one:
 40814 00006EF6 09D2                    	or	DX,DX			; Any more entries?
 40815 00006EF8 7416                    	jz	short Exec_Set_PDBJ
 40816                                  
 40817                                  exec_get_addr:
 40818 00006EFA 26C51D                  	lds	BX,[ES:DI]		; Get ra/sa of entry
 40819 00006EFD 8CD8                    	mov	AX,DS			; Relocate address of item
 40820                                  
 40821                                  	; MSDOS 6.0
 40822                                  ;;;;;;	add	AX,SI  ; MSDOS 3.3
 40823                                  	;add	ax,[bp-28]
 40824 00006EFF 0346E4                  	add	AX,Exec_DMA_Save
 40825                                  
 40826 00006F02 8ED8                    	mov	DS,AX
 40827 00006F04 0137                    	add	[BX],SI
 40828 00006F06 83C704                  	add	DI,4
 40829 00006F09 4A                      	dec	DX
 40830 00006F0A E2EA                    	loop	exec_reloc_one		; End of internal buffer?
 40831                                  
 40832                                  	; We've exhausted a single buffer's worth. Read in the next
 40833                                  	; piece of the relocation table.
 40834                                  
 40835 00006F0C 06                      	push	ES
 40836 00006F0D 1F                      	pop	DS
 40837 00006F0E EBCE                    	jmp	short exec_read_reloc
 40838                                  
 40839                                  Exec_Set_PDBJ:
 40840                                  	; MSDOS 6.0
 40841                                  	
 40842                                  	; We now determine if this is a buggy exe packed file and if
 40843                                  	; so we patch in the right code. Note that fixexepatch will
 40844                                  	; point to a ret if dos loads low. The load segment as
 40845                                  	; determined above will be in exec_dma_save
 40846                                  	
 40847 00006F10 06                      	push	es
 40848 00006F11 50                      	push	ax			; M030
 40849 00006F12 51                      	push	cx			; M030
 40850                                  	;mov	es,[bp-28]
 40851 00006F13 8E46E4                  	mov	es,Exec_DMA_Save
 40852 00006F16 36A1[C50E]              	mov	ax,[ss:exec_init_CS]	; M030
 40853 00006F1A 368B0E[C30E]            	mov	cx,[ss:exec_init_IP]	; M030
 40854 00006F1F 36FF16[670D]            	call	word [ss:FixExePatch]
 40855                                  	
 40856                                  	; 30/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 40857                                  	; (MSDOS 5.0 MSDOS.SYS does not contain 'Rational386Patch')
 40858                                  	;call	word [ss:Rational386PatchPtr]
 40859                                  	
 40860                                  	; 08/03/2024 - Retro DOS v5.0
 40861                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:9E6Fh)
 40862                                  	; (PCDOS 7.1 IBMDOS.COM - DOSCODE:0B096h) 
 40863 00006F24 36FF16[3E13]            	call	word [ss:Rational386PatchPtr]
 40864                                  
 40865                                  	; 08/03/2024
 40866                                  	; (Windows ME IO.SYS - BIOSCODE:976Fh)
 40867                                  	;call	Rational386Patch
 40868                                  
 40869 00006F29 59                      	pop	cx			; M030
 40870 00006F2A 58                      	pop	ax			; M030
 40871 00006F2B 07                      	pop	es
 40872                                  
 40873 00006F2C E9DD00                  	jmp	Exec_Set_PDB
 40874                                  
 40875                                  Exec_No_Memj:
 40876 00006F2F E939FE                  	jmp	Exec_No_Mem
 40877                                  
 40878                                  	; we have a .COM file. First, determine if we are merely
 40879                                  	; loading an overlay.
 40880                                  
 40881                                  Exec_Com_File:
 40882                                  	;test	byte [bp-5],2
 40883 00006F32 F646FB02                	test	Exec_Func,exec_func_overlay
 40884 00006F36 742D                    	jz	short Exec_Alloc_Com_File
 40885                                  	;lds	si,[bp-4]
 40886 00006F38 C576FC                  	lds	SI,Exec_Blk		; get arg block
 40887 00006F3B AD                      	lodsw				; get load address
 40888                                  	;mov	[bp-20],ax
 40889 00006F3C 8946EC                  	mov	Exec_DMA,AX
 40890 00006F3F B8FFFF                  	mov	AX,0FFFFh
 40891 00006F42 EB63                    	jmp	short Exec_Read_Block	; read it all!
 40892                                  
 40893                                  Exec_Chk_Com_Mem:			
 40894                                  	; MSDOS 6.0	     		; M063 - Start
 40895 00006F44 36A0[0203]              	mov	al,[ss:AllocMethod]	; save current alloc method in ax
 40896 00006F48 368A1E[8400]            	mov	bl,[ss:ALLOCMSAVE]
 40897 00006F4D 36881E[0203]            	mov	[ss:AllocMethod],bl	; restore original allocmethod
 40898 00006F52 F6C340                  	test	bl,HIGH_ONLY ; 40h	; Q: was the HIGH_ONLY bit already set
 40899 00006F55 75D8                    	jnz	short Exec_No_Memj	; Y: no space in UMBs. Quit
 40900                                  					; N: continue
 40901                                  	
 40902 00006F57 A840                    	test	al,HIGH_ONLY		; Q: did we set the HIGH_ONLY bit
 40903 00006F59 74D4                    	jz	short Exec_No_Memj	; N: no memory
 40904                                  	
 40905                                  	;mov	ax,[bp-18]
 40906 00006F5B 8B46EE                  	mov	ax,Exec_Load_Block	; M047: ax = block we just allocated
 40907 00006F5E 31DB                    	xor	bx,bx			; M047: bx => free arena
 40908 00006F60 E86B02                  	call	ChangeOwner		; M047: free this block
 40909                                  	
 40910 00006F63 EB0E                    	jmp	short Exec_Norm_Com_Alloc
 40911                                  					; M063 - End
 40912                                  	
 40913                                  	; We must allocate the max possible size block (ick!)
 40914                                  	; and set up CS=DS=ES=SS=PDB pointer, IP=100, SP=max
 40915                                  	; size of block.
 40916                                  
 40917                                  Exec_Alloc_Com_File:
 40918                                  	; MSDOS 6.0			; M000 -start
 40919 00006F65 36F606[0203]80          	test	byte [ss:AllocMethod],HIGH_FIRST ; 80h
 40920                                  					; Q: is the alloc strat high_first
 40921 00006F6B 7406                    	jz	short Exec_Norm_Com_Alloc ; N: normal allocate
 40922                                  					; Y: set high_only bit
 40923 00006F6D 36800E[0203]40          	or	byte [ss:AllocMethod],HIGH_ONLY ; 40h
 40924                                  					; M000 - end
 40925                                  Exec_Norm_Com_Alloc:			; M000
 40926                                  	; MSDOS 3.3 (& MSDOS 6.0)
 40927 00006F73 BBFFFF                  	mov	BX,0FFFFh
 40928                                  	;invoke	$Alloc			; largest piece available as error
 40929 00006F76 E8BF03                  	call	_$ALLOC
 40930 00006F79 09DB                    	or	BX,BX
 40931                                  	; MSDOS 6.0
 40932 00006F7B 74C7                    	jz	short Exec_Chk_Com_Mem	; M000
 40933                                  	; MSDOS 3.3
 40934                                  	;jz	short Exec_No_Memj
 40935                                  
 40936                                  	;mov	[bp-16],bx
 40937 00006F7D 895EF0                  	mov	Exec_Size,BX		; save size of allocation block
 40938 00006F80 53                      	push	BX
 40939                                  	;invoke	$ALLOC			; largest piece available
 40940 00006F81 E8B403                  	call	_$ALLOC
 40941 00006F84 5B                      	pop	BX			; get size of block...
 40942                                  	;mov	[bp-18],ax
 40943 00006F85 8946EE                  	mov	Exec_Load_Block,AX
 40944                                  
 40945 00006F88 83C010                  	add	AX,10h			; increment for header
 40946                                  	;mov	[bp-20],ax
 40947 00006F8B 8946EC                  	mov	Exec_DMA,AX
 40948                                  
 40949 00006F8E 31C0                    	xor	AX,AX			; presume 64K read...
 40950 00006F90 81FB0010                	cmp	BX,1000h		; 64k or more in block?
 40951 00006F94 730E                    	jae	short Exec_Read_Com	; yes, read only 64k
 40952                                  
 40953 00006F96 89D8                    	mov	AX,BX			; convert size to bytes
 40954 00006F98 B104                    	mov	CL,4
 40955 00006F9A D3E0                    	shl	AX,CL
 40956                                  	; 17/12/2022
 40957                                  	; 30/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 40958                                  	;			(MSDOS 5.0, MSDOS.SYS compatibility)
 40959                                  	; MSDOS 5.0
 40960                                  	;cmp	AX,100h   
 40961                                  	; 02/06/2019 - Retro DOS v4.0
 40962                                  	; MSDOS 6.0
 40963                                          ; 17/12/2022
 40964 00006F9C 3D0002                  	cmp	AX,200h                 ; enough memory for PSP and stack?
 40965 00006F9F 76A3                    	jbe	short Exec_Chk_Com_Mem	; M000: jump if not
 40966                                  	;;jbe	short Exec_No_Memj	; M000: jump if not
 40967                                  	;; Retro DOS v3.0 modification (on MSDOS 6.0 code) -03/08/2018-
 40968                                  	;;jbe	short Exec_Chk_Com_Mem	; M000: jump if not
 40969                                  	;jbe	short Exec_No_Memj	; M000: jump if not
 40970                                  
 40971                                  					; M047: size of the block is < 64K
 40972 00006FA1 2D0001                  	sub	ax,100h			; M047: reserve 256 bytes for stack
 40973                                  
 40974                                  Exec_Read_Com:
 40975                                  	; MSDOS 3.3 (& MSDOS 6.0)
 40976 00006FA4 2D0001                  	sub	AX,100h 		; remember size of psp
 40977                                  Exec_Read_Block:
 40978 00006FA7 50                      	push	AX			; save number to read
 40979                                  	;mov	bx,[bp-8]
 40980 00006FA8 8B5EF8                  	mov	BX,Exec_FH		; of com file
 40981 00006FAB 31C9                    	xor	CX,CX			; but seek to 0:0
 40982 00006FAD 31C0                    	xor	AX,AX			; seek relative to beginning
 40983                                  	;mov	DX,CX
 40984                                  	; 08/03/2024
 40985 00006FAF 99                      	cwd
 40986                                  	;invoke	$Lseek			; back to beginning of file
 40987 00006FB0 E85109                  	call	_$LSEEK
 40988 00006FB3 59                      	pop	CX			; number to read
 40989                                  	;mov	ds,[bp-20]
 40990 00006FB4 8E5EEC                  	mov	DS,Exec_DMA
 40991 00006FB7 31D2                    	xor	DX,DX
 40992 00006FB9 51                      	push	CX
 40993 00006FBA E8DC01                  	call	ExecRead
 40994 00006FBD 5E                      	pop	SI			; get number of bytes to read
 40995 00006FBE 7303                    	jnc	short OkRead
 40996 00006FC0 E9ACFD                  	jmp	Exec_Bad_File
 40997                                  
 40998                                  	; 10/09/2018
 40999                                  OkRead:
 41000 00006FC3 39F0                    	cmp	AX,SI			; did we read them all?
 41001                                  	; MSDOS 6.0
 41002                                  	;jz	short Exec_Chk_Com_Mem	; M00: exactly the wrong number...no
 41003                                  	; MSDOS 3.3
 41004                                  	;;jz	short Exec_No_Memj	; M00: exactly the wrong number...
 41005 00006FC5 7503                    	jne	short OkRead2
 41006 00006FC7 E97AFF                  	jmp	Exec_Chk_Com_Mem
 41007                                  
 41008                                  OkRead2:
 41009                                  	; MSDOS 6.0
 41010 00006FCA 368A1E[8400]            	mov	bl,[ss:ALLOCMSAVE]	; M063
 41011 00006FCF 36881E[0203]            	mov	[ss:AllocMethod],bl	; M063: restore alloc method
 41012                                  
 41013                                  	; MSDOS 3.3 (& MSDOS 6.0)
 41014                                  	;test	byte [bp-5],2
 41015 00006FD4 F646FB02                	test	Exec_Func,exec_func_overlay
 41016 00006FD8 7532                    	jnz	short Exec_Set_PDB	; no starto, chumo!
 41017                                  
 41018                                  	;mov	ax,[bp-20]
 41019 00006FDA 8B46EC                  	mov	AX,Exec_DMA
 41020 00006FDD 83E810                  	sub	AX,10h
 41021 00006FE0 36A3[C50E]              	mov	[SS:exec_init_CS],AX
 41022 00006FE4 36C706[C30E]0001        	mov	word [SS:exec_init_IP],100h ; initial IP is 100h
 41023                                  
 41024                                  	; SI is AT MOST FF00h. Add FE to account for PSP - word
 41025                                  	; of 0 on stack.
 41026                                  
 41027 00006FEB 81C6FE00                	add	SI,0FEh 		; make room for stack
 41028                                  
 41029                                  	; MSDOS 6.0
 41030 00006FEF 83FEFE                  	cmp	si,0FFFEh		; M047: Q: was there >= 64K available
 41031 00006FF2 7404                    	je	short Exec_St_Ok	; M047: Y: stack is fine
 41032 00006FF4 81C60001                	add	si,100h			; M047: N: add the xtra 100h for stack
 41033                                  
 41034                                  Exec_St_Ok:
 41035                                  	; MSDOS 3.3 (& MSDOS 6.0)
 41036 00006FF8 368936[BF0E]            	mov	[SS:exec_init_SP],SI 	; max value for read is also SP!;smr;SS Override
 41037 00006FFD 36A3[C10E]              	mov	[SS:exec_init_SS],AX 					;smr;SS Override
 41038 00007001 8ED8                    	mov	DS,AX
 41039 00007003 C7040000                	mov	WORD [SI],0		; 0 for return
 41040                                  
 41041                                  	; MSDOS 6.0
 41042                                  
 41043                                  	; M068
 41044                                  	;
 41045                                  	; We now determine if this is a Copy Protected App. If so the
 41046                                  	; A20OFF_COUNT is set to 6. Note that ChkCopyProt will point to
 41047                                  	; a ret if DOS is loaded low. Also DS contains the load segment.
 41048                                  
 41049 00007007 36FF16[6100]            	call	word [ss:ChkCopyProt]
 41050                                  
 41051                                  Exec_Set_PDB:
 41052                                  	; MSDOS 3.3 (& MSDOS 6.0)
 41053                                  	;mov	bx,[bp-8]
 41054 0000700C 8B5EF8                  	mov	BX,Exec_FH		; we are finished with the file.
 41055 0000700F E8A001                  	call	Exec_Dealloc
 41056 00007012 55                      	push	BP
 41057                                  	;invoke	$Close			; release the jfn
 41058 00007013 E88407                  	call	_$CLOSE
 41059 00007016 5D                      	pop	BP
 41060 00007017 E88A01                  	call	Exec_Alloc
 41061                                  	;test	byte [bp-5],2
 41062 0000701A F646FB02                	test	Exec_Func,exec_func_overlay
 41063 0000701E 743A                    	jz	short Exec_Build_Header
 41064                                  
 41065                                  	; MSDOS 6.0
 41066 00007020 E8B901                  	call	Scan_Execname
 41067 00007023 E8CD01                  	call	Scan_Special_Entries
 41068                                  ;SR;
 41069                                  ;The current lie strategy uses the PSP to store the lie version. However,
 41070                                  ;device drivers are loaded as overlays and have no PSP. To handle them, we
 41071                                  ;use the Sysinit flag provided by the BIOS as part of a structure pointed at
 41072                                  ;by BiosDataPtr. If this flag is set, the overlay call has been issued from
 41073                                  ;Sysinit and therefore must be a device driver load. We then get the lie 
 41074                                  ;version for this driver and put it into the Sysinit PSP. When the driver
 41075                                  ;issues the version check, it gets the lie version until the next overlay
 41076                                  ;call is issued.
 41077                                  
 41078 00007026 36803E[2213]00          	cmp	byte [ss:DriverLoad],0	;was Sysinit processing done?
 41079 0000702C 7426                    	je	short norm_ovl		;yes, no special handling
 41080 0000702E 56                      	push	si
 41081 0000702F 06                      	push	es
 41082 00007030 36C436[2313]            	les	si,[ss:BiosDataPtr]	;get ptr to BIOS data block
 41083                                  	 
 41084                                  	; (es:si points to 'SysinitPresent' address/flag in retrodos4.s)
 41085 00007035 26803C00                	cmp	byte [es:si],0		;in Sysinit?
 41086 00007039 7411                    	je	short sysinit_done	;no, Sysinit is finished
 41087                                  	
 41088 0000703B 368E06[3003]            	mov	es,[ss:CurrentPDB]	;es = current PSP (Sysinit PSP)
 41089 00007040 36FF36[BB0E]            	push	word [ss:SPECIAL_VERSION]
 41090                                  	;pop	word [es:40h]	; 08/03/2024
 41091 00007045 268F064000              	pop	word [es:PDB.Version]	;store lie version in Sysinit PSP
 41092                                  		;;; PDB.VERSION
 41093 0000704A EB06                    	jmp	short setver_done
 41094                                  sysinit_done:
 41095 0000704C 36C606[2213]00          	mov	byte [ss:DriverLoad],0	;Sysinit done,special handling off
 41096                                  setver_done:
 41097 00007052 07                      	pop	es
 41098 00007053 5E                      	pop	si
 41099                                  norm_ovl:
 41100                                  	;leave
 41101 00007054 89EC                    	mov	sp,bp		
 41102 00007056 5D                      	pop	bp
 41103                                  
 41104                                  	;transfer SYS_RET_OK		; overlay load -> done
 41105 00007057 E91096                  	jmp	SYS_RET_OK
 41106                                  
 41107                                  Exec_Build_Header:
 41108                                  	;mov	dx,[bp-18]
 41109 0000705A 8B56EE                  	mov	DX,Exec_Load_Block
 41110                                  					; assign the space to the process
 41111                                  	;mov	si,1
 41112 0000705D BE0100                  	mov	SI,ARENA.OWNER		; pointer to owner field
 41113                                  	;mov	ax,[bp-14]
 41114 00007060 8B46F2                  	mov	AX,Exec_Environ 	; get environ pointer
 41115 00007063 09C0                    	or	AX,AX
 41116 00007065 7405                    	jz	short No_Owner		; no environment
 41117                                  
 41118 00007067 48                      	dec	AX			; point to header
 41119 00007068 8ED8                    	mov	DS,AX
 41120 0000706A 8914                    	mov	[SI],DX 		; assign ownership
 41121                                  No_Owner:
 41122                                  	;mov	ax,[bp-18]
 41123                                  	;mov	AX,Exec_Load_Block	; get load block pointer
 41124                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 41125                                  	; 17/12/2022
 41126 0000706C 89D0                    	mov	ax,dx ; 06/06/2019
 41127                                  	;mov	ax,Exec_Load_Block	; get load block pointer
 41128                                  	
 41129 0000706E 48                      	dec	AX
 41130 0000706F 8ED8                    	mov	DS,AX			; point to header
 41131 00007071 8914                    	mov	[SI],DX 		; assign ownership
 41132                                  
 41133                                  	; MSDOS 6.0
 41134 00007073 1E                      	push	DS			;AN000;MS. make ES=DS
 41135 00007074 07                      	pop	ES			;AN000;MS.
 41136                                  	;mov	di,8
 41137 00007075 BF0800                  	mov	DI,ARENA.NAME		;AN000;MS. ES:DI points to destination
 41138 00007078 E86101                  	call	Scan_Execname		;AN007;MS. parse execname
 41139                                  					;	   ds:si->name, cx=name length
 41140 0000707B 51                      	push	CX			;AN007;;MS. save for fake version
 41141 0000707C 56                      	push	SI			;AN007;;MS. save for fake version
 41142                                  
 41143                                  MoveName:				;AN000;
 41144 0000707D AC                      	lodsb				;AN000;;MS. get char
 41145 0000707E 3C2E                    	cmp	AL,'.'			;AN000;;MS. is '.', may be name.exe
 41146 00007080 7408                    	jz	short Mem_Done		;AN000;;MS. no, move to header
 41147                                  					;AN000;
 41148 00007082 AA                      	stosb				;AN000;;MS. move char
 41149                                  					; MSKK bug fix - limit length copied
 41150 00007083 83FF10                  	cmp	di,16 ; ARENAHEADERSIZE	; end of memory arena block?
 41151 00007086 7302                    	jae	short Mem_Done		; jump if so
 41152                                  	;
 41153 00007088 E2F3                    	loop	MoveName		;AN000;;MS. continue
 41154                                  Mem_Done:				;AN000;
 41155 0000708A 30C0                    	xor	AL,AL			;AN000;;MS. make ASCIIZ
 41156                                  	;cmp	di,16
 41157 0000708C 83FF10                  	cmp	DI,ARENAHEADERSIZE ; 16 ;AN000;MS. if not all filled
 41158 0000708F 7301                    	jae	short Fill8		;AN000;MS.
 41159                                  	
 41160 00007091 AA                      	stosb				;AN000;MS.
 41161                                  	
 41162                                  Fill8:					;AN000;
 41163 00007092 5E                      	pop	SI			;AN007;MS. ds:si -> file name
 41164 00007093 59                      	pop	CX			;AN007;MS.
 41165                                  	
 41166 00007094 E85C01                  	call	Scan_Special_Entries	;AN007;MS.
 41167                                  
 41168                                  	; MSDOS 3.3 (& MSDOS 6.0)
 41169 00007097 52                      	push	DX
 41170                                  	;mov	si,[bp-16]
 41171 00007098 8B76F0                  	mov	SI,Exec_Size
 41172 0000709B 01D6                    	add	SI,DX
 41173                                  	;Invoke	$Dup_PDB		; ES is now PDB
 41174 0000709D E896A5                  	call	_$DUP_PDB
 41175 000070A0 5A                      	pop	DX
 41176                                  
 41177                                  	;push	word [bp-14]
 41178 000070A1 FF76F2                  	push	Exec_Environ
 41179                                  	;pop	WORD [ES:2Ch]
 41180 000070A4 268F062C00              	pop	word [ES:PDB.ENVIRON]
 41181                                  
 41182                                  	; MSDOS 6.0			; *** Added for DOS 5.00
 41183                                  					; version number in PSP
 41184 000070A9 36FF36[BB0E]             	push	word [ss:SPECIAL_VERSION] ; Set the DOS version number to
 41185 000070AE 268F064000              	pop	word [ES:PDB.Version]	; to be used for this application
 41186                                  		; PDB.VERSION
 41187                                  
 41188                                  	; MSDOS 3.3 (& MSDOS 6.0)	; set up proper command line stuff
 41189                                  	;lds	si,[bp-4]
 41190 000070B3 C576FC                  	lds	SI,Exec_Blk		; get the block
 41191 000070B6 1E                      	push	DS			; save its location
 41192 000070B7 56                      	push	SI
 41193                                  	;lds	si,[si+6]
 41194 000070B8 C57406                  	lds	SI,[SI+EXEC0.5C_FCB]	; get the 5c fcb
 41195                                  
 41196                                  	; DS points to user space 5C FCB
 41197                                  
 41198 000070BB B90C00                  	mov	CX,12			; copy drive, name and ext
 41199 000070BE 51                      	push	CX
 41200 000070BF BF5C00                  	mov	DI,5Ch
 41201 000070C2 8A1C                    	mov	BL,[SI]
 41202 000070C4 F3A4                    	rep	movsb
 41203                                  
 41204                                  	; DI = 5Ch + 12 = 5Ch + 0Ch = 68h
 41205                                  
 41206                                  	;xor	AX,AX			; zero extent, etc for CPM
 41207 000070C6 91                      	xchg	ax,cx	; 08/03/2024	
 41208 000070C7 AB                      	stosw
 41209 000070C8 AB                      	stosw
 41210                                  
 41211                                  	; DI = 5Ch + 12 + 4 = 5Ch + 10h = 6Ch
 41212                                  
 41213 000070C9 59                      	pop	CX
 41214 000070CA 5E                      	pop	SI			; get block
 41215 000070CB 1F                      	pop	DS
 41216 000070CC 1E                      	push	DS			; save (again)
 41217 000070CD 56                      	push	SI
 41218                                  	;lds	si,[si+0Ah]
 41219 000070CE C5740A                  	lds	SI,[SI+EXEC0.6C_FCB]	; get 6C FCB
 41220                                  
 41221                                  	; DS points to user space 6C FCB
 41222                                  
 41223 000070D1 8A3C                    	mov	BH,[SI] 		; do same as above
 41224 000070D3 F3A4                    	rep	movsb
 41225 000070D5 AB                      	stosw
 41226 000070D6 AB                      	stosw
 41227 000070D7 5E                      	pop	SI			; get block (last time)
 41228 000070D8 1F                      	pop	DS
 41229                                  	;ld	si,[si+2]
 41230 000070D9 C57402                  	lds	SI,[SI+EXEC0.COM_LINE]	; command line
 41231                                  
 41232                                  	; DS points to user space 80 command line
 41233                                  
 41234 000070DC 80C980                  	or	CL,80h
 41235 000070DF 89CF                    	mov	DI,CX
 41236 000070E1 F3A4                    	rep	movsb			; Wham!
 41237                                  
 41238                                  	; Process BX into default AX (validity of drive specs on args).
 41239                                  	; We no longer care about DS:SI.
 41240                                  
 41241 000070E3 FEC9                    	dec	CL			; get 0FFh in CL
 41242 000070E5 88F8                    	mov	AL,BH
 41243 000070E7 30FF                    	xor	BH,BH
 41244                                  	;invoke	GetVisDrv
 41245 000070E9 E8B50A                  	call	GetVisDrv
 41246 000070EC 7302                    	jnc	short Exec_BL
 41247                                  
 41248 000070EE 88CF                    	mov	BH,CL
 41249                                  
 41250                                  Exec_BL:
 41251 000070F0 88D8                    	mov	AL,BL
 41252 000070F2 30DB                    	xor	BL,BL
 41253                                  	;invoke	GetVisDrv
 41254 000070F4 E8AA0A                  	call	GetVisDrv
 41255 000070F7 7302                    	jnc	short Exec_Set_Return
 41256                                  
 41257 000070F9 88CB                    	mov	BL,CL
 41258                                  
 41259                                  Exec_Set_Return:
 41260                                  	;invoke	Get_User_Stack			; get his return address
 41261 000070FB E87993                  	call	Get_User_Stack
 41262                                  
 41263                                  ; 08/03/2024
 41264                                  %if 0
 41265                                  	;push	word [si+14h]
 41266                                  	push	word [SI+user_env.user_CS]	; suck out the CS and IP
 41267                                  	;push	word [si+12h]
 41268                                  	push	word [SI+user_env.user_IP]
 41269                                  	;push	word [si+14h]
 41270                                  	push	word [SI+user_env.user_CS]	; suck out the CS and IP
 41271                                  	;push	word [si+12h]
 41272                                  	push	word [SI+user_env.user_IP]
 41273                                  	;pop	word [ES:0Ah]
 41274                                  	pop	WORD [ES:PDB.EXIT]
 41275                                  	;pop	word [ES:0Ch]
 41276                                  	pop	WORD [ES:PDB.EXIT+2]
 41277                                  %else
 41278                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 41279                                  	;;;
 41280                                  	;lds	ax,[si+12h]
 41281 000070FE C54412                  	lds	ax,[SI+user_env.user_IP] ; suck out the CS and IP
 41282 00007101 1E                      	push	ds              
 41283 00007102 50                      	push	ax
 41284                                  	;mov	[es:0Ah],ax
 41285 00007103 26A30A00                	mov	[ES:PDB.EXIT],ax
 41286                                  	;mov	[es:0Ch],ds
 41287 00007107 268C1E0C00              	mov	[ES:PDB.EXIT+2],ds
 41288                                  	;;;
 41289                                  %endif
 41290                                  	
 41291 0000710C 31C0                    	xor	AX,AX
 41292 0000710E 8ED8                    	mov	DS,AX
 41293                                  					; save them where we can get them
 41294                                  					; later when the child exits.
 41295                                  	;pop	word [88h]
 41296 00007110 8F068800                	pop	word [addr_int_terminate] ; 22h*4
 41297                                  	;pop	word [90h]
 41298 00007114 8F068A00                	pop	word [addr_int_terminate+2] ; (22h*4)+2
 41299                                  
 41300 00007118 36C706[2C03]8000        	mov	WORD [SS:DMAADD],80h	; SS Override
 41301 0000711F 368E1E[3003]            	mov	DS,[SS:CurrentPDB]	; SS Override
 41302 00007124 368C1E[2E03]            	mov	[SS:DMAADD+2],DS	; SS Override
 41303                                  
 41304                                  	;test	byte [bp-5],1
 41305 00007129 F646FB01                	test	Exec_Func,exec_func_no_execute
 41306 0000712D 7427                    	jz	short exec_go
 41307                                  
 41308 0000712F 36C536[BF0E]            	lds	SI,[SS:exec_init_SP]	; get stack SS Override
 41309                                  	;les	di,[bp-4]
 41310 00007134 C47EFC                  	les	DI,Exec_Blk		; and block for return
 41311                                  	;mov	[es:di+10h],ds
 41312 00007137 268C5D10                	mov	[ES:DI+EXEC1.SS],DS	; return SS
 41313                                  
 41314 0000713B 4E                      	dec	SI			; 'push' default AX
 41315 0000713C 4E                      	dec	SI
 41316 0000713D 891C                    	mov	[SI],BX 		; save default AX reg
 41317                                  	;mov	[es:di+0Eh], si
 41318 0000713F 2689750E                	mov	[ES:DI+EXEC1.SP],SI	; return 'SP'
 41319                                  
 41320 00007143 36C506[C30E]            	lds	AX,[SS:exec_init_IP]	; SS Override
 41321                                  	;mov	[es:di+14h],ds
 41322 00007148 268C5D14                	mov	[ES:DI+EXEC1.CS],DS	; initial entry stuff
 41323                                  	;mov	[es:di+12h],ax
 41324 0000714C 26894512                	mov	[ES:DI+EXEC1.IP],AX
 41325                                  	
 41326                                  	;leave
 41327 00007150 89EC                    	mov	sp,bp
 41328 00007152 5D                      	pop	bp	
 41329                                  
 41330                                  	;transfer SYS_RET_OK
 41331 00007153 E91495                  	jmp	SYS_RET_OK
 41332                                  
 41333                                  exec_go:
 41334 00007156 36C536[C30E]            	lds	SI,[SS:exec_init_IP]	; get entry point SS Override
 41335 0000715B 36C43E[BF0E]            	les	DI,[SS:exec_init_SP]	; new stack SS Override
 41336 00007160 8CC0                    	mov	AX,ES
 41337                                  
 41338                                  	; MSDOS 6.0
 41339 00007162 36803E[660D]00          	cmp	byte [SS:DosHasHMA],0	; Q: is dos in HMA (M021)
 41340 00007168 741A                    	je	short Xfer_To_User	; N: transfer control to user
 41341                                  
 41342 0000716A 1E                      	push	ds			; Y: control must go to low mem stub
 41343                                  		
 41344 0000716B 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]		;  where we disable a20 and Xfer 
 41345                                  					;  control to user 
 41346 00007170 800E[8600]04            	or	byte [DOS_FLAG],EXECA20OFF ; M068:
 41347                                  					; M004: Set bit to signal int 21
 41348                                  					; ah = 25 & ah= 49. See dossym.inc 
 41349                                  					; under TAG M003 & M009 for 
 41350                                  					; explanation
 41351 00007175 8916[6300]              	mov	[A20OFF_PSP],dx		; M068: set the PSP for which A20 is
 41352                                  					; M068: going to be turned OFF.
 41353                                  	
 41354 00007179 8CD8                    	mov	ax,ds			; ax = segment of low mem stub
 41355 0000717B 1F                      	pop	ds
 41356                                  	
 41357 0000717C 50                      	push	ax			; ret far into the low mem stub
 41358 0000717D B8[2410]                	mov	ax,disa20_xfer
 41359 00007180 50                      	push	ax
 41360 00007181 8CC0                    	mov	AX,ES			; restore ax
 41361 00007183 CB                      	retf
 41362                                  
 41363                                  Xfer_To_User:
 41364                                  	; DS:SI points to entry point
 41365                                  	; AX:DI points to initial stack
 41366                                  	; DX has PDB pointer
 41367                                  	; BX has initial AX value
 41368                                  
 41369 00007184 FA                      	cli
 41370                                  	; 15/08/2018
 41371 00007185 36C606[2103]00          	mov	BYTE [SS:INDOS],0	; SS Override
 41372                                  
 41373 0000718B 8ED0                    	mov	SS,AX			; set up user's stack
 41374 0000718D 89FC                    	mov	SP,DI			; and SP
 41375 0000718F FB                      	sti
 41376                                  
 41377 00007190 1E                      	push	DS			; fake long call to entry
 41378 00007191 56                      	push	SI
 41379 00007192 8EC2                    	mov	ES,DX			; set up proper seg registers
 41380 00007194 8EDA                    	mov	DS,DX
 41381 00007196 89D8                    	mov	AX,BX			; set up proper AX
 41382                                  
 41383 00007198 CB                      	retf
 41384                                  
 41385                                  ; 04/08/2018 - Retro DOS v3.0
 41386                                  
 41387                                  ;----------------------------------------------------------------------------
 41388                                  ;
 41389                                  ;----------------------------------------------------------------------------
 41390                                  
 41391                                  ExecRead:
 41392 00007199 E81600                  	CALL	Exec_Dealloc
 41393                                  	;mov	bx,[bp-8]
 41394 0000719C 8B5EF8                  	MOV	bx,Exec_FH
 41395                                  
 41396 0000719F 55                      	PUSH	BP
 41397 000071A0 E8FF06                  	call	_$READ
 41398 000071A3 5D                      	POP	BP
 41399                                  
 41400                                  	;CALL	Exec_Alloc
 41401                                  	;retn
 41402                                  	; 18/12/2022
 41403                                  	;jmp	short Exec_Alloc
 41404                                  
 41405                                  ; 18/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS) 
 41406                                  
 41407                                  ;----------------------------------------------------------------------------
 41408                                  ;
 41409                                  ;----------------------------------------------------------------------------
 41410                                  
 41411                                  Exec_Alloc:
 41412 000071A4 53                      	push	BX
 41413                                  	;mov	BX,[CS:CurrentPDB]  ; MSDOS 3.3
 41414                                  	; 20/05/2019 - Retro DOS v4.0
 41415                                  	; MSDOS 6.0
 41416 000071A5 368B1E[3003]            	mov	bx,[SS:CurrentPDB]  ; SS Override
 41417 000071AA E81000                  	call	ChangeOwners
 41418 000071AD E860A7                  	call	LCritMEM
 41419 000071B0 5B                      	pop	BX
 41420 000071B1 C3                      	retn
 41421                                  
 41422                                  ;----------------------------------------------------------------------------
 41423                                  ;
 41424                                  ;----------------------------------------------------------------------------
 41425                                  
 41426                                  Exec_Dealloc:
 41427 000071B2 53                      	push	BX
 41428                                  	;mov	bx,0
 41429 000071B3 29DB                    	sub	BX,BX		; (bx) = ARENA_OWNER_SYSTEM
 41430 000071B5 E82BA7                  	call	ECritMEM
 41431 000071B8 E80200                  	call	ChangeOwners
 41432 000071BB 5B                      	pop	BX
 41433 000071BC C3                      	retn
 41434                                  
 41435                                  ; 18/12/2022
 41436                                  %if 0
 41437                                  ;----------------------------------------------------------------------------
 41438                                  ;
 41439                                  ;----------------------------------------------------------------------------
 41440                                  
 41441                                  Exec_Alloc:
 41442                                  	push	BX
 41443                                  	;mov	BX,[CS:CurrentPDB]  ; MSDOS 3.3
 41444                                  	; 20/05/2019 - Retro DOS v4.0
 41445                                  	; MSDOS 6.0
 41446                                  	mov	bx,[SS:CurrentPDB]  ; SS Override
 41447                                  	call	ChangeOwners
 41448                                  	call	LCritMEM
 41449                                  	pop	BX
 41450                                  	retn
 41451                                  
 41452                                  %endif
 41453                                  
 41454                                  ;----------------------------------------------------------------------------
 41455                                  ;
 41456                                  ;----------------------------------------------------------------------------
 41457                                  
 41458                                  ChangeOwners:
 41459 000071BD 9C                      	pushf
 41460 000071BE 50                      	push	AX
 41461                                  	;mov	ax,[bp-14]
 41462 000071BF 8B46F2                  	mov	AX,Exec_Environ
 41463 000071C2 E80900                  	call	ChangeOwner
 41464                                  	;mov	ax,[bp-18]
 41465 000071C5 8B46EE                  	mov	AX,Exec_Load_Block
 41466 000071C8 E80300                  	call	ChangeOwner
 41467 000071CB 58                      	pop	AX
 41468 000071CC 9D                      	popf
 41469                                  chgown_retn:
 41470 000071CD C3                      	retn
 41471                                  
 41472                                  ;----------------------------------------------------------------------------
 41473                                  ;
 41474                                  ;----------------------------------------------------------------------------
 41475                                  
 41476                                  ChangeOwner:
 41477 000071CE 09C0                    	or	AX,AX			; is area allocated?
 41478 000071D0 74FB                    	jz	short chgown_retn	; no, do nothing
 41479 000071D2 48                      	dec	AX
 41480 000071D3 1E                      	push	DS
 41481 000071D4 8ED8                    	mov	DS,AX
 41482 000071D6 891E0100                	mov	[ARENA.OWNER],BX
 41483 000071DA 1F                      	pop	DS
 41484 000071DB C3                      	retn
 41485                                  
 41486                                  ;----------------------------------------------------------------------------
 41487                                  ;
 41488                                  ;----------------------------------------------------------------------------
 41489                                  
 41490                                  ; 20/05/2019 - Retro DOS v4.0
 41491                                  
 41492                                  	; MSDOS 6.0
 41493                                  Scan_Execname:
 41494                                  	;lds	si,[bp-26] ; 08/03/2024
 41495 000071DC C576E6                  	lds	SI,ExecName		; DS:SI points to name
 41496                                  Scan_Execname1:				; M028
 41497                                  Save_Begin:				;
 41498 000071DF 89F1                    	mov	CX,SI			; CX= starting addr
 41499                                  Scan0:					;
 41500 000071E1 AC                      	lodsb				; get char
 41501                                  
 41502 000071E2 3C3A                    	cmp	AL,':'			; is ':' , may be A:name
 41503 000071E4 74F9                    	jz	short Save_Begin	; yes, save si
 41504 000071E6 3C5C                    	cmp	AL,'\'                  ; is '\', may be A:\name
 41505 000071E8 74F5                    	jz	short Save_Begin	; yes, save si
 41506 000071EA 3C00                    	cmp	AL,0			; is end of name
 41507 000071EC 75F3                    	jnz	short Scan0		; no, continue scanning
 41508 000071EE 29CE                    	sub	SI,CX			; get name's length
 41509 000071F0 87F1                    	xchg	SI,CX			; cx= length, si= starting addr
 41510                                  
 41511 000071F2 C3                      	retn
 41512                                  
 41513                                  ;----------------------------------------------------------------------------
 41514                                  ;
 41515                                  ;----------------------------------------------------------------------------
 41516                                  
 41517                                  ; 20/05/2019 - Retro DOS v4.0
 41518                                  
 41519                                  ; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 41520                                  ; DOSCODE:A0EDh (MSDOS 5.0, MSDOS.SYS)
 41521                                  
 41522                                  ; 09/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 41523                                  ; DOSCODE:B370h (PCDOS 7.1, IBMDOS.COM)
 41524                                  
 41525                                  	; MSDOS 6.0
 41526                                  
 41527                                  Scan_Special_Entries:
 41528                                  
 41529 000071F3 49                      	dec	CX			; cx= name length
 41530                                  ;M060	mov	DI,[Special_Entries]	; es:di -> addr of special entries
 41531                                  					;reset to current version
 41532                                  	;mov	word [ss:SPECIAL_VERSION],1406h 
 41533                                  				; (MSDOS 6.21, MSDOS.SYS, DOSCODE:A14Eh)
 41534                                  	;mov	word [ss:SPECIAL_VERSION],5
 41535                                  				; (MSDOS 5.0, MSDOS.SYS, DOSCODE:A0EEh)
 41536                                  
 41537                                  				; 5 for Retro DOS 4.0 (01/12/2022, MSDOS 5.0)
 41538 000071F4 36C706[BB0E]070A        	mov	word [ss:SPECIAL_VERSION],(MINOR_VERSION<<8)+MAJOR_VERSION
 41539                                  				; 0005h for Retro DOS v4.1 (MSDOS 5.0)
 41540                                  				; 24/09/2023
 41541                                  				; 1606h for Retro DOS v4.2 (MSDOS 6.22)
 41542                                  
 41543                                  				; 09/03/2024
 41544                                  				; 0A07h	for Retro DOS v5.0 (PCDOS 7.1)
 41545                                  				; (0008h for Windows ME)
 41546                                  				
 41547                                  ;***	call	Reset_Version
 41548                                  
 41549                                  ;M060	push	SS
 41550                                  ;M060	pop	ES
 41551                                  
 41552 000071FB 36C43E[5D00]            	les	DI,[SS:UU_IFS_DOS_CALL]	;M060; ES:DI --> Table in SETVER.SYS
 41553 00007200 8CC0                    	mov	AX,ES			;M060; First do a NULL ptr check to
 41554 00007202 09F8                    	or	AX,DI			;M060; be sure the table exists
 41555 00007204 7427                    	jz	short End_List		;M060; If ZR then no table
 41556                                  
 41557                                  GetEntries:
 41558 00007206 268A05                  	mov	AL,[ES:DI]		; end of list
 41559 00007209 08C0                    	or	AL,AL
 41560 0000720B 7420                    	jz	short End_List		; yes
 41561                                  
 41562 0000720D 36893E[0E06]            	mov	[ss:TEMP_VAR2],DI	; save di
 41563 00007212 38C8                    	cmp	AL,CL			; same length ?
 41564 00007214 751B                    	jnz	short SkipOne 		; no
 41565                                  
 41566 00007216 47                      	inc	DI			; es:di -> special name
 41567 00007217 51                      	push	CX			; save length and name addr
 41568 00007218 56                      	push	SI
 41569                                  
 41570                                  ; M050 - BEGIN
 41571                                  
 41572 00007219 50                      	push	ax			; save len
 41573                                  sse_next_char:
 41574 0000721A AC                      	lodsb
 41575 0000721B E8A6EB                  	call	UCase
 41576 0000721E AE                      	scasb
 41577 0000721F 750D                    	jne	short Not_Matched
 41578 00007221 E2F7                    	loop	sse_next_char
 41579                                  	
 41580                                  ;	repz	cmpsb			; same name ?
 41581                                  ;	jnz	short Not_Matched	; no
 41582                                  
 41583                                  	; 09/03/2024 - PCDOS 7.1 IBMDOS.COM
 41584                                  	;pop	ax			; take len off the stack
 41585                                  
 41586                                  ; M050 - END
 41587                                  
 41588 00007223 268B05                  	mov	AX,[ES:DI]		; get special version
 41589 00007226 36A3[BB0E]              	mov	[ss:SPECIAL_VERSION],AX	; save it
 41590                                  
 41591                                  ;***	mov	AL,[ES:DI+2]		; get fake count
 41592                                  ;***	mov	[ss:FAKE_COUNT],AL 	; save it
 41593                                  
 41594                                  	; 09/03/2024 - PCDOS 7.1 IBMDOS.COM
 41595 0000722A 58                      	pop	ax			; take len off the stack
 41596                                  
 41597 0000722B 5E                      	pop	SI
 41598 0000722C 59                      	pop	CX
 41599                                  	; 18/12/2022
 41600                                  	;jmp	SHORT End_List
 41601                                  
 41602                                  	; 18/12/2022
 41603                                  End_List:
 41604 0000722D C3                      	retn
 41605                                  
 41606                                  Not_Matched:
 41607 0000722E 58                      	pop	ax			; get len from stack ; M050
 41608 0000722F 5E                      	pop	SI			; restore si,cx
 41609 00007230 59                      	pop	CX
 41610                                  
 41611                                  SkipOne:
 41612 00007231 368B3E[0E06]            	mov	DI,[ss:TEMP_VAR2]	; restore old di use SS Override
 41613 00007236 30E4                    	xor	AH,AH			; position to next entry
 41614 00007238 01C7                    	add	DI,AX
 41615                                  
 41616 0000723A 83C703                  	add	DI,3			; DI -> next entry length
 41617                                  ;***	add	DI,4			; DI -> next entry length
 41618                                  
 41619 0000723D EBC7                    	jmp	short GetEntries
 41620                                  
 41621                                  	; 18/12/2022
 41622                                  ;End_List:
 41623                                  	;retn
 41624                                  
 41625                                  ; 04/08/2018 - Retro DOS v3.0
 41626                                  ; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 633Dh
 41627                                  
 41628                                  ;----------------------------------------------------------------------------
 41629                                  ;SUBTTL Terminate and stay resident handler
 41630                                  ;
 41631                                  ; Input:    DX is an offset from CurrentPDB at which to
 41632                                  ;	    truncate the current block.
 41633                                  ;
 41634                                  ; output:   The current block is truncated (expanded) to be [DX+15]/16
 41635                                  ;	    paragraphs long. An exit is simulated via resetting CurrentPDB
 41636                                  ;	    and restoring the vectors.
 41637                                  ;
 41638                                  ;----------------------------------------------------------------------------
 41639                                  
 41640                                  	; 20/05/2019 - Retro DOS v4.0
 41641                                  	; DOSCODE:A19Bh (MSDOS 6.21, MSDOS.SYS)
 41642                                  
 41643                                  	; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS5.0 MSDOS.SYS)
 41644                                  	; DOSCODE:A13Bh (MSDOS 5.0, MSDOS.SYS)
 41645                                  
 41646                                  	; 09/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 41647                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B3BCh
 41648                                  
 41649                                  _$KEEP_PROCESS:
 41650 0000723F 50                      	push	AX			; keep exit code around
 41651                                  	;mov	byte [SS:EXIT_TYPE],3
 41652 00007240 36C606[7C05]03          	mov	BYTE [SS:EXIT_TYPE],EXIT_KEEP_PROCESS
 41653 00007246 368E06[3003]            	mov	ES,[SS:CurrentPDB]
 41654 0000724B 83FA06                  	cmp	DX,6h			; keep enough space around for system
 41655 0000724E 7303                    	jae	short Keep_Shrink	; info
 41656                                  
 41657 00007250 BA0600                  	mov	DX,6h
 41658                                  
 41659                                  Keep_Shrink:
 41660 00007253 89D3                    	mov	BX,DX
 41661 00007255 53                      	push	BX
 41662 00007256 06                      	push	ES
 41663 00007257 E82F02                  	call	_$SETBLOCK		; ignore return codes.
 41664 0000725A 1F                      	pop	DS
 41665 0000725B 5B                      	pop	BX
 41666 0000725C 7207                    	jc	short Keep_Done		; failed on modification
 41667                                  
 41668 0000725E 8CD8                    	mov	AX,DS
 41669 00007260 01D8                    	add	AX,BX
 41670                                  	;mov	[2],ax
 41671 00007262 A30200                  	mov	[PDB.BLOCK_LEN],AX	;PBUGBUG
 41672                                  
 41673                                  Keep_Done:
 41674 00007265 58                      	pop	AX
 41675 00007266 EB26                    	jmp	SHORT exit_inner	; and let abort take care of the rest
 41676                                  
 41677                                  ;----------------------------------------------------------------------------
 41678                                  ;
 41679                                  ;----------------------------------------------------------------------------
 41680                                  
 41681                                  STAY_RESIDENT:
 41682                                  	;mov	ax,3100h
 41683 00007268 B80031                  	mov	AX,(KEEP_PROCESS<<8)+0 ; Lower part is return code;PBUGBUG
 41684 0000726B 83C20F                  	add	DX,15
 41685 0000726E D1DA                    	rcr	DX,1
 41686 00007270 B103                    	mov	CL,3
 41687 00007272 D3EA                    	shr	DX,CL
 41688                                  
 41689 00007274 E97A90                  	jmp	COMMAND
 41690                                  
 41691                                  ;----------------------------------------------------------------------------
 41692                                  ;SUBTTL $EXIT - return to parent process
 41693                                  ;   Assembler usage:
 41694                                  ;	    MOV     AL, code
 41695                                  ;	    MOV     AH, Exit
 41696                                  ;	    INT     int_command
 41697                                  ;   Error return:
 41698                                  ;	    None.
 41699                                  ;
 41700                                  ;----------------------------------------------------------------------------
 41701                                  
 41702                                  	; 20/05/2019 - Retro DOS v4.0
 41703                                  	; DOSCODE:A1D3h (MSDOS 6.21, MSDOS.SYS)
 41704                                  
 41705                                  	; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS5.0 MSDOS.SYS)
 41706                                  	; DOSCODE:A173h (MSDOS 5.0, MSDOS.SYS)
 41707                                  
 41708                                  	; 09/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 41709                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B3F4h
 41710                                  _$EXIT:
 41711                                  	; 04/08/2018 - Retro DOS v3.0
 41712                                  	; IBMDOSDOS.COM (MSDOS 3.3, 1987) - Offset 6375h
 41713 00007277 30E4                    	xor	AH,AH
 41714 00007279 368626[4D03]            	xchg	AH,[SS:DidCTRLC]
 41715 0000727E 08E4                    	or	AH,AH
 41716                                  	;mov	BYTE [SS:EXIT_TYPE],0
 41717 00007280 36C606[7C05]00          	mov	BYTE [SS:EXIT_TYPE],EXIT_TERMINATE
 41718 00007286 7406                    	jz	short exit_inner
 41719                                  	;mov	BYTE [SS:EXIT_TYPE],1
 41720 00007288 36C606[7C05]01          	mov	BYTE [SS:EXIT_TYPE],EXIT_CTRL_C
 41721                                  
 41722                                  	;entry	Exit_inner
 41723                                  exit_inner:
 41724 0000728E E8E691                  	call	Get_User_Stack		;PBUGBUG
 41725                                  
 41726 00007291 36FF36[3003]            	push	word [ss:CurrentPDB]
 41727                                  	;pop	word [si+14h]
 41728 00007296 8F4414                  	pop	word [SI+user_env.user_CS] ;PBUGBUG
 41729 00007299 EB08                    	jmp	short abort_inner
 41730                                  
 41731                                  ;BREAK <$ABORT -- Terminate a process>
 41732                                  ;----------------------------------------------------------------------------
 41733                                  ; Inputs:
 41734                                  ;	user_CS:00 must point to valid program header block
 41735                                  ; Function:
 41736                                  ;	Restore terminate and Cntrl-C addresses, flush buffers and transfer
 41737                                  ;	to the terminate address
 41738                                  ; Returns:
 41739                                  ;	TO THE TERMINATE ADDRESS
 41740                                  ;----------------------------------------------------------------------------
 41741                                  
 41742                                  _$ABORT:
 41743 0000729B 30C0                    	xor	AL,AL
 41744                                  	;mov	byte [SS:EXIT_TYPE],0
 41745                                  	;mov	byte [SS:EXIT_TYPE],AL ; = 0
 41746 0000729D 36C606[7C05]00          	mov	byte [SS:EXIT_TYPE],EXIT_ABORT
 41747                                  
 41748                                  	; abort_inner must have AL set as the exit code! The exit type
 41749                                  	; is retrieved from exit_type. Also, the PDB at user_CS needs
 41750                                  	; to be correct as the one that is terminating.
 41751                                  
 41752                                  abort_inner:
 41753 000072A3 368A26[7C05]            	mov	AH,[SS:EXIT_TYPE]
 41754 000072A8 36A3[3403]              	mov	[SS:exit_code],AX
 41755 000072AC E8C891                  	call	Get_User_Stack
 41756                                  
 41757                                  	;mov	ds,[si+14h]
 41758 000072AF 8E5C14                  	mov	DS,[SI+user_env.user_CS] ; set up old interrupts ;PBUGBUG
 41759 000072B2 31C0                    	xor	AX,AX
 41760 000072B4 8EC0                    	mov	ES,AX
 41761                                  	;mov	si,10
 41762 000072B6 BE0A00                  	mov	SI,SAVEXIT
 41763                                  	;mov	di,88h
 41764 000072B9 BF8800                  	mov	DI,addr_int_terminate
 41765 000072BC A5                      	movsw
 41766 000072BD A5                      	movsw
 41767 000072BE A5                      	movsw
 41768 000072BF A5                      	movsw
 41769 000072C0 A5                      	movsw
 41770 000072C1 A5                      	movsw
 41771 000072C2 E959EF                  	jmp	reset_environment
 41772                                  
 41773                                  ;----------------------------------------------------------------------------
 41774                                  ;
 41775                                  ; fixexepatch will point to this is DOS loads low. 
 41776                                  ;
 41777                                  ;----------------------------------------------------------------------------
 41778                                  ; MSDOS 6.0
 41779                                  
 41780                                  ; 29/04/2019 - Retro DOS v4.0
 41781                                  ; DOSCODE:A221h (MSDOS 6.21, MSDOS.SYS)
 41782                                  
 41783                                  ; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS5.0 MSDOS.SYS)
 41784                                  ; DOSCODE:A1C1h (MSDOS 5.0, MSDOS.SYS)
 41785                                  
 41786                                  	; 09/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 41787                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B442h
 41788                                  
 41789                                  RetExePatch: ; proc near
 41790                                  	
 41791 000072C5 C3                      	retn
 41792                                  
 41793                                  ;============================================================================
 41794                                  ; ALLOC.ASM, MSDOS 6.0, 1991
 41795                                  ;============================================================================
 41796                                  ; 04/08/2018 - Retro DOS v3.0
 41797                                  ; 14/05/2019 - Retro DOS v4.0
 41798                                  ; 10/03/2024 - Retro DOS v5.0
 41799                                  
 41800                                  ;	TITLE ALLOC.ASM - memory arena manager	NAME Alloc
 41801                                  
 41802                                  ;**
 41803                                  ;	Microsoft Confidential
 41804                                  ;	Copyright (C) Microsoft Corporation 1991
 41805                                  ;	All Rights Reserved.
 41806                                  ;
 41807                                  ;	Memory related system calls and low level routines for MSDOS 2.X.
 41808                                  ;	I/O specs are defined in DISPATCH.
 41809                                  ;
 41810                                  ;	$ALLOC
 41811                                  ;	$SETBLOCK
 41812                                  ;	$DEALLOC
 41813                                  ;	$AllocOper
 41814                                  ;	arena_free_process
 41815                                  ;	arena_next
 41816                                  ;	check_signature
 41817                                  ;	Coalesce
 41818                                  ;
 41819                                  ;	Modification history:
 41820                                  ;
 41821                                  ;	    Created: ARR 30 March 1983
 41822                                  ;
 41823                                  ;	    Revision: M000 - added support for allocing UMBs. 7/9/90
 41824                                  ;		      M003 - added support for link/unlink UMBs from
 41825                                  ;			     DOS arena chain. 7/18/90
 41826                                  ;		      M009 - Added error returns invalid function and 
 41827                                  ;			     arena trashed in set link state call.
 41828                                  ;		      M010 - Release UMB arenas allocated to current PDB
 41829                                  ;			     if UMB_HEAD is initialized.
 41830                                  ;
 41831                                  ;		      M016 - MACE utilities mkeyrate.com version 1.0 
 41832                                  ;			     support. Please see under M009 in 
 41833                                  ;			     ..\inc\dossym.inc. 8/31/90.
 41834                                  ;
 41835                                  ;		      M061 - In GetLastArena, if linking in UMBs check to make
 41836                                  ;			     sure that umb_head arena is valid and also make
 41837                                  ;			     sure that the previous arena is pointing to 
 41838                                  ;			     umb_head.
 41839                                  ;
 41840                                  ;		      M064 - allow HIGH_ONLY bit to be set by a call to 
 41841                                  ;			     set allloc strategy.
 41842                                  ;			     use STRAT_MASK to mask out bits 6 & 7 of 
 41843                                  ;			     bx in AllocSetStrat.
 41844                                  ;
 41845                                  ;		      M068 - use a count value (A20OFF_COUNT) rather than
 41846                                  ;			     a bit to indicate to dos dispatcher to turn
 41847                                  ;			     a20 off before iret. See M016.
 41848                                  ;
 41849                                  
 41850                                  ;	BREAK	<memory allocation utility routines>
 41851                                  
 41852                                  
 41853                                  ; 15/04/2018 - Retro DOS v2.0
 41854                                  ;----------------------------------------------------------------------------
 41855                                  ; xenix memory calls for MSDOS
 41856                                  ;
 41857                                  ; CAUTION: The following routines rely on the fact that arena_signature and
 41858                                  ; arena_owner_system are all equal to zero and are contained in DI.
 41859                                  ;
 41860                                  ;INCLUDE DOSSEG.ASM
 41861                                  
 41862                                  ;CODE	SEGMENT BYTE PUBLIC  'CODE'
 41863                                  ;       ASSUME  SS:DOSGROUP,CS:DOSGROUP
 41864                                  
 41865                                  ;.xlist
 41866                                  ;.xcref
 41867                                  ;INCLUDE DOSSYM.ASM
 41868                                  ;INCLUDE DEVSYM.ASM
 41869                                  ;.cref
 41870                                  ;.list
 41871                                  
 41872                                  ;TITLE ALLOC.ASM - memory arena manager
 41873                                  ;NAME Alloc
 41874                                  
 41875                                  ;SUBTTL memory allocation utility routines
 41876                                  ;PAGE
 41877                                  ;
 41878                                  ; arena data
 41879                                  ;
 41880                                  ;       i_need  arena_head,WORD         ; seg address of start of arena
 41881                                  ;       i_need  CurrentPDB,WORD         ; current process data block addr
 41882                                  ;       i_need  FirstArena,WORD         ; first free block found
 41883                                  ;       i_need  BestArena,WORD          ; best free block found
 41884                                  ;       i_need  LastArena,WORD          ; last free block found
 41885                                  ;       i_need  AllocMethod,BYTE        ; how to alloc first(best)last
 41886                                  
 41887                                  ;----------------------------------------------------------------------------
 41888                                  
 41889                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 41890                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B443h
 41891                                  	;;;
 41892                                  test_umb_flag:
 41893 000072C6 36F606[8900]01          	test	byte [ss:UMBFLAG],LINKSTATE ; 1 ; Q: are umb's linked
 41894 000072CC C3                      	retn                    ; ZF=1 -> N: scan from arena_head
 41895                                  				; ZF=0 -> Y: start_arena = umb_head
 41896                                  	;;;
 41897                                  
 41898                                  ;**	Arena_Free_Process
 41899                                  ;----------------------------------------------------------------------------
 41900                                  ;	Free all arena blocks allocated to a prOcess
 41901                                  ;
 41902                                  ;	ENTRY	(bx) = PID of process
 41903                                  ;	EXIT	none
 41904                                  ;	USES	????? BUGBUG
 41905                                  ;----------------------------------------------------------------------------
 41906                                  
 41907                                  	; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS5.0 MSDOS.SYS)
 41908                                  	; DOSCODE:A1C2h (MSDOS 5.0, MSDOS.SYS)
 41909                                  
 41910                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 41911                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B44Ah
 41912                                  
 41913                                  arena_free_process:
 41914                                  	; 14/05/2019 - Retro DOS v4.0
 41915                                  	; 04/08/2018 - Retro DOS v3.0
 41916 000072CD 36A1[2400]                      MOV	AX,[SS:arena_head]
 41917                                  arena_free_process_start:
 41918 000072D1 BF0000                  	MOV     DI,ARENA.SIGNATURE ; 0
 41919                                  	;MOV	AX,[SS:arena_head] ; 15/04/2018  
 41920 000072D4 E82F00                          CALL	check_signature         ; ES <- AX, check for valid block
 41921                                  
 41922                                  arena_free_process_loop:
 41923                                          ;retc
 41924 000072D7 7225                            JC	SHORT AFP_RETN	; Retro DOS v2.0 - 05/03/2018
 41925 000072D9 06                      	PUSH    ES
 41926 000072DA 1F                              POP     DS
 41927                                  	;cmp	[1],bx 
 41928 000072DB 391E0100                        CMP     [ARENA.OWNER],BX	; is block owned by pid?
 41929 000072DF 7504                            JNZ     SHORT arena_free_next	; no, skip to next
 41930                                  	;mov	[1],di
 41931 000072E1 893E0100                        MOV     [ARENA.OWNER],DI	; yes... free him
 41932                                  
 41933                                  arena_free_next:
 41934                                  	;cmp	byte [di],5Ah ;'Z'
 41935 000072E5 803D5A                          CMP     BYTE [DI],arena_signature_end
 41936                                                                          ; end of road, Jack?
 41937                                          ;retz				; never come back no more
 41938                                  	;JZ	SHORT AFP_RETN  ; MSDOS 3.3 (& MSDOS 2.11)
 41939                                  	; 14/05/2019
 41940                                  	; MSDOS 6.0
 41941 000072E8 7405                    	jz	short arena_chk_umbs
 41942                                          
 41943 000072EA E81200                  	CALL    arena_next              ; next item in ES/AX carry set if trash
 41944 000072ED EBE8                            JMP     SHORT arena_free_process_loop
 41945                                  
 41946                                  	; MSDOS 6.0
 41947                                  arena_chk_umbs:				; M010 - Start
 41948                                  	; 20/05/2019
 41949 000072EF 36A1[8C00]              	mov	ax,[ss:UMB_HEAD]	; ax = umb_head
 41950 000072F3 83F8FF                  	cmp	ax,0FFFFh		; Q: is umb_head initialized
 41951 000072F6 741D                    	je	short ret_label		; N: we're done
 41952                                  	
 41953 000072F8 8CDF                    	mov	di,ds			; di = last arena
 41954 000072FA 39C7                    	cmp	di,ax			; Q: is last arena above umb_head
 41955                                  	;jae	short ret_label		; Y: we've scanned umbs also. done.
 41956                                  	;jmp	short arena_free_process_start
 41957                                  					; M010 - End
 41958                                  	; 10/03/2024 (PCDOS 7.1 IBMDOS.COM)
 41959 000072FC 72D3                    	jb	short arena_free_process_start
 41960                                  
 41961                                  	; 10/03/2024
 41962                                  AFP_RETN:
 41963 000072FE C3                      	RETN
 41964                                  
 41965                                  ;	BREAK	<Arena Helper Routines>
 41966                                  
 41967                                  ;**	Arena_Next - Find Next item in Arena
 41968                                  ;----------------------------------------------------------------------------
 41969                                  ;	ENTRY	DS - pointer to block head
 41970                                  ;		(di) = 0
 41971                                  ;	EXIT	AX,ES - pointers to next head
 41972                                  ;		'C' set iff arena damaged
 41973                                  ;----------------------------------------------------------------------------
 41974                                  
 41975                                  arena_next:
 41976 000072FF 8CD8                            MOV     AX,DS                   ; AX <- current block
 41977 00007301 03060300                        ADD     AX,[ARENA.SIZE]		; AX <- AX + current block length
 41978 00007305 40                              INC     AX                      ; remember that header!
 41979                                  
 41980                                  ;       fall into check_signature and return
 41981                                  ;
 41982                                  ;       CALL    check_signature         ; ES <- AX, carry set if error
 41983                                  ;       RETN
 41984                                  
 41985                                  ;**	Check_Signature - Check Memory Block Signature
 41986                                  ;----------------------------------------------------------------------------
 41987                                  ;	ENTRY	(AX) = address of block header
 41988                                  ;		(di) = 0
 41989                                  ;	EXIT	 ES = AX
 41990                                  ;		'C' clear if signature good
 41991                                  ;		'C' set if signature bad
 41992                                  ;	USES	ES, Flags
 41993                                  ;----------------------------------------------------------------------------
 41994                                  
 41995                                  check_signature:        
 41996                                  
 41997 00007306 8EC0                    	MOV     ES,AX                   ; ES <- AX
 41998                                  	;cmp	byte [es:di],4Dh ; 'M'
 41999 00007308 26803D4D                        CMP     BYTE [ES:DI],arena_signature_normal
 42000                                                                          ; IF next signature = not_end THEN
 42001 0000730C 7407                            JZ      SHORT check_signature_ok ;   GOTO ok
 42002                                  	;cmp 	byte [es:di],5Ah ; 'Z'
 42003 0000730E 26803D5A                        CMP     BYTE [ES:DI],arena_signature_end
 42004                                                                          ; IF next signature = end then
 42005 00007312 7401                            JZ      SHORT check_signature_ok ;   GOTO ok
 42006 00007314 F9                              STC                             ; set error
 42007                                  ret_label: ; MSDOS 6.0
 42008                                  ;AFP_RETN:	; 10/03/2024
 42009                                   	; Retro DOS v2.0 - 05/03/2018
 42010                                  check_signature_ok:
 42011                                  COALESCE_RETN:
 42012 00007315 C3                      	RETN
 42013                                  
 42014                                  ;**	Coalesce - Combine free blocks ahead with current block
 42015                                  ;----------------------------------------------------------------------------
 42016                                  ;	Coalesce adds the block following the argument to the argument block,
 42017                                  ;	iff it's free.  Coalesce is usually used to join free blocks, but
 42018                                  ;	some callers (such as $setblock) use it to join a free block to it's
 42019                                  ;	preceeding allocated block.
 42020                                  ;
 42021                                  ;	ENTRY	(ds) = pointer to the head of a free block
 42022                                  ;		(di) = 0
 42023                                  ;	EXIT	'C' clear if OK
 42024                                  ;		  (ds) unchanged, this block updated
 42025                                  ;		  (ax) = address of next block, IFF not at end
 42026                                  ;		'C' set if arena trashed
 42027                                  ;	USES	(cx)
 42028                                  ;----------------------------------------------------------------------------
 42029                                          
 42030                                  Coalesce:
 42031                                  	;cmp	byte [di],5Ah ; 'Z'
 42032 00007316 803D5A                  	CMP     BYTE [DI],arena_signature_end
 42033                                                                          ; IF current signature = END THEN
 42034                                          ;retz				;   GOTO ok
 42035 00007319 74FA                            jz	short COALESCE_RETN
 42036 0000731B E8E1FF                  	CALL    arena_next              ; ES, AX <- next block, Carry set if error
 42037                                          ;retc				; IF no error THEN GOTO check
 42038 0000731E 72F5                    	jc	short COALESCE_RETN
 42039                                  
 42040                                  coalesce_check:
 42041                                  	;cmp	[es:1],di
 42042 00007320 26393E0100                      CMP     [ES:ARENA.OWNER],DI
 42043                                          ;retnz				; IF next block isnt free THEN return
 42044 00007325 75EE                            JNZ	SHORT COALESCE_RETN
 42045                                  	;mov	cx,[ES:3]
 42046 00007327 268B0E0300              	MOV     CX,[ES:ARENA.SIZE]	; CX <- next block size
 42047 0000732C 41                              INC     CX                      ; CX <- CX + 1 (for header size)
 42048                                          ;ADD	[3],CX
 42049 0000732D 010E0300                	ADD     [ARENA.SIZE],CX		; current size <- current size + CX
 42050 00007331 268A0D                          MOV     CL,[ES:DI]              ; move up signature
 42051 00007334 880D                            MOV     [DI],CL
 42052 00007336 EBDE                            JMP     SHORT Coalesce		; try again
 42053                                  
 42054                                  ; 04/08/2018 - Retro DOS v3.0
 42055                                  ; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 641Fh
 42056                                  
 42057                                  ;	BREAK  <$Alloc - allocate space in memory>
 42058                                  
 42059                                  ; MSDOS 6.0
 42060                                  ;----------------------------------------------------------------------------
 42061                                  ;**	$Alloc - Allocate Memory Space
 42062                                  ;
 42063                                  ;	$Alloc services the INT21 that allocates memory space to a program.
 42064                                  ;	Alloc returns a pointer to a free block of memory that
 42065                                  ;	has the requested size in paragraphs.
 42066                                  ;
 42067                                  ;	If the allocation strategy is HIGH_FIRST or HIGH_ONLY memory is 
 42068                                  ;	scanned from umb_head if not from arena_head. If the strategy is
 42069                                  ; 	HIGH_FIRST the scan is continued from arena_head if a block of 
 42070                                  ;	appropriate size is not found in the UMBs. If the strategy is 
 42071                                  ;	HIGH_FIRST+HIGH_ONLY only the UMBs are scanned for memory.
 42072                                  ;
 42073                                  ;	In either case if bit 0 of UmbFlag is not initialized then the scan
 42074                                  ;	starts from arena_head.
 42075                                  ;
 42076                                  ;	Assembler usage:
 42077                                  ;           MOV     BX,size
 42078                                  ;           MOV     AH,Alloc
 42079                                  ;           INT     21h
 42080                                  ;
 42081                                  ;	BUGBUG - a lot can be done to improve performance. We can set marks
 42082                                  ;	so that we start searching the arena at it's first non-trivial free
 42083                                  ;	block, we can peephole the code, etc. (We can move some subr calls
 42084                                  ;	inline, etc.) I assume that this is called rarely and that the arena
 42085                                  ;	doesn't have too many memory objects in it beyond the first free one.
 42086                                  ;	verify that this is true; if so, this can stay as is
 42087                                  ;
 42088                                  ;	ENTRY	(bx) = requested size, in bytes
 42089                                  ;		(DS) = (ES) = DOSGROUP
 42090                                  ;	EXIT	'C' clear if memory allocated
 42091                                  ;		  (ax:0) = address of requested memory
 42092                                  ;		'C' set if request failed
 42093                                  ;		  (AX) = error_not_enough_memory
 42094                                  ;		    (bx) = max size we could have allocated
 42095                                  ;		  (ax) = error_arena_trashed
 42096                                  ;	USES	All
 42097                                  ;----------------------------------------------------------------------------
 42098                                  
 42099                                  ; MSDOS 2.11 (& MSDOS 3.3)
 42100                                  ;----------------------------------------------------------------------------
 42101                                  ;SUBTTL $Alloc - allocate space in memory
 42102                                  ;
 42103                                  ;   Assembler usage:
 42104                                  ;           MOV     BX,size
 42105                                  ;           MOV     AH,Alloc
 42106                                  ;           INT     21h
 42107                                  ;         AX:0 is pointer to allocated memory
 42108                                  ;         BX is max size if not enough memory
 42109                                  ;
 42110                                  ;   Description:
 42111                                  ;           Alloc returns  a  pointer  to  a  free  block of
 42112                                  ;       memory that has the requested  size  in  paragraphs.
 42113                                  ;
 42114                                  ;   Error return:
 42115                                  ;           AX = error_not_enough_memory
 42116                                  ;              = error_arena_trashed
 42117                                  ;----------------------------------------------------------------------------
 42118                                  
 42119                                  ; DOSCODE:A28Eh (MSDOS 6.21, MSDOS.SYS)
 42120                                  
 42121                                  ; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS5.0 MSDOS.SYS)
 42122                                  ; DOSCODE:A22Eh (MSDOS 5.0, MSDOS.SYS)
 42123                                  
 42124                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 42125                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B4B5h
 42126                                  
 42127                                  _$ALLOC:
 42128                                  	; 25/05/2019 (Procedure has been checked and confirmed)
 42129                                  	; 14/05/2019 - Retro DOS v4.0
 42130                                  	; 04/08/2018 - Retro DOS v3.0
 42131                                  	;EnterCrit critMem
 42132 00007338 E8A8A5                  	call	ECritMEM ; MSDOS 3.3 & MSDOS 6.0
 42133                                  
 42134                                  ; 17/12/2022
 42135                                  ; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42136                                  ;%if 0
 42137                                  	; 14/05/2019
 42138 0000733B 16                      	push	ss
 42139 0000733C 1F                      	pop	ds
 42140                                  
 42141                                  	; MSDOS 6.0
 42142                                  	;mov	ax,[ss:arena_head]
 42143                                  	;mov	[ss:START_ARENA],ax	; assume LOW_FIRST
 42144                                  
 42145 0000733D A1[2400]                	mov	ax,[arena_head]
 42146 00007340 A3[8E00]                	mov	[START_ARENA],ax
 42147                                  	
 42148                                  	;test	byte [ss:AllocMethod],HIGH_FIRST+HIGH_ONLY
 42149 00007343 F606[0203]C0            	test	byte [AllocMethod],HIGH_FIRST+HIGH_ONLY
 42150                                  					; Q: should we start scanning from
 42151                                  					;    UMB's
 42152 00007348 740B                    	jz	short norm_alloc	; N: scan from arena_head
 42153                                  
 42154                                  ; 10/03/2024
 42155                                  %if 0		
 42156                                  	;;cmp	word [ss:UMB_HEAD],-1	; Q: Has umb_head been initialized
 42157                                  	;cmp	word [UMB_HEAD],-1
 42158                                  	;je	short norm_alloc	; N: scan from arena_head
 42159                                  
 42160                                  	;test	byte [ss:UMBFLAG],LINKSTATE ; Q: are umb's linked
 42161                                  	test	byte [UMBFLAG],LINKSTATE ; 1
 42162                                  	jz	short norm_alloc	; N: scan from arena_head
 42163                                  %else
 42164                                  	; 10/03/2024 (PCDOS 7.1 IBMDOS.COM)
 42165                                  	;;;
 42166 0000734A E879FF                  	call	test_umb_flag
 42167 0000734D 7406                    	jz      short norm_alloc
 42168                                  	;;;
 42169                                  %endif	
 42170                                  	
 42171                                  	;mov	ax,[ss:UMB_HEAD]
 42172                                  	;mov	[ss:START_ARENA],ax	; start_arena = umb_head
 42173 0000734F A1[8C00]                	mov	ax,[UMB_HEAD]
 42174 00007352 A3[8E00]                	mov	[START_ARENA],ax
 42175                                  					; M000 - end
 42176                                  norm_alloc:
 42177 00007355 31C0                            XOR     AX,AX
 42178 00007357 89C7                            MOV     DI,AX
 42179                                  	; 15/03/2018
 42180                                          ;MOV	[SS:FirstArena],AX	; init the options
 42181                                          ;MOV	[SS:BestArena],AX
 42182                                          ;MOV	[SS:LastArena],AX
 42183                                  	; 14/05/2019
 42184 00007359 A3[4003]                	MOV	[FirstArena],AX		; init the options
 42185 0000735C A3[4203]                        MOV	[BestArena],AX
 42186 0000735F A3[4403]                        MOV	[LastArena],AX
 42187 00007362 50                              PUSH    AX                      ; alloc_max <- 0
 42188                                  	; 04/08/2018
 42189                                  start_scan:
 42190                                  	;MOV	AX,[SS:arena_head]	; AX <- beginning of arena
 42191                                  	;MOV	AX,[arena_head]
 42192                                  
 42193                                  	; 14/05/2019	
 42194                                  	; MSDOS 6.0
 42195                                  	;mov	ax,[SS:START_ARENA]	; M000: AX <- beginning of arena
 42196 00007363 A1[8E00]                	mov	ax,[START_ARENA]
 42197                                  
 42198                                  	; 27/09/2023 (BugFix) (*)
 42199                                  	; ( jump from 'alloc_chk' (ds<>ss, ax = [SS:START_ARENA]))
 42200                                  start_scan_x:
 42201                                  
 42202 00007366 E89DFF                  	CALL    check_signature         ; ES <- AX, carry set if error
 42203 00007369 7233                            JC      SHORT alloc_err		; IF error THEN GOTO err
 42204                                  
 42205                                  ;%endif
 42206                                  
 42207                                  ; 17/12/2022
 42208                                  %if 0
 42209                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42210                                  
 42211                                  	; MSDOS 6.0
 42212                                  	mov	ax,[ss:arena_head]
 42213                                  	mov	[ss:START_ARENA],ax	; assume LOW_FIRST
 42214                                  
 42215                                  	test	byte [ss:AllocMethod],HIGH_FIRST+HIGH_ONLY
 42216                                  					; Q: should we start scanning from
 42217                                  					;    UMB's
 42218                                  	jz	short norm_alloc	; N: scan from arena_head
 42219                                  		
 42220                                  	;cmp	word [ss:UMB_HEAD],-1	; Q: Has umb_head been initialized
 42221                                  	;je	short norm_alloc	; N: scan from arena_head
 42222                                  
 42223                                  	test	byte [ss:UMBFLAG],LINKSTATE ; Q: are umb's linked
 42224                                  	jz	short norm_alloc	; N: scan from arena_head
 42225                                  	
 42226                                  	mov	ax,[ss:UMB_HEAD]
 42227                                  	mov	[ss:START_ARENA],ax	; start_arena = umb_head
 42228                                  					; M000 - end
 42229                                  norm_alloc:
 42230                                          XOR     AX,AX
 42231                                          MOV     DI,AX
 42232                                  	; 15/03/2018
 42233                                  	MOV	[SS:FirstArena],AX	; init the options
 42234                                  	MOV	[SS:BestArena],AX
 42235                                  	MOV	[SS:LastArena],AX
 42236                                          PUSH    AX                      ; alloc_max <- 0
 42237                                  	; 04/08/2018
 42238                                  start_scan:
 42239                                  	;MOV	AX,[SS:arena_head]	; AX <- beginning of arena
 42240                                  	; 14/05/2019	
 42241                                  	; MSDOS 6.0
 42242                                  	mov	ax,[SS:START_ARENA]	; M000: AX <- beginning of arena
 42243                                  	CALL    check_signature         ; ES <- AX, carry set if error
 42244                                          JC      SHORT alloc_err		; IF error THEN GOTO err
 42245                                  %endif
 42246                                  
 42247                                  alloc_scan:
 42248 0000736B 06                              PUSH    ES
 42249 0000736C 1F                              POP     DS                      ; DS <- ES
 42250 0000736D 393E0100                        CMP     [ARENA.OWNER],DI ; 0
 42251 00007371 7466                            JZ      SHORT alloc_free	; IF current block is free THEN examine
 42252                                  
 42253                                  alloc_next:
 42254                                  
 42255                                  ; 10/03/2024
 42256                                  %if 0		
 42257                                  	; MSDOS 6.0			; M000 - start 
 42258                                  	test	byte [ss:UMBFLAG],LINKSTATE ; Q: are umb's linked
 42259                                  	jz	short norm_strat	; N: see if we reached last arena
 42260                                  %else
 42261                                  	; 10/03/2024 (PCDOS 7.1 IBMDOS.COM)
 42262                                  	;;;
 42263 00007373 E850FF                  	call	test_umb_flag
 42264 00007376 741C                    	jz      short norm_strat
 42265                                  	;;;
 42266                                  %endif	
 42267 00007378 36F606[0203]80          	test	byte [ss:AllocMethod],HIGH_FIRST
 42268                                  					; Q: is alloc strategy high_first
 42269 0000737E 7414                    	jz	short norm_strat	; N: see if we reached last arena
 42270 00007380 36A1[8E00]              	mov	ax,[ss:START_ARENA]
 42271 00007384 363B06[2400]            	cmp	ax,[ss:arena_head]	; Q: did we start scan from 
 42272                                  					;    arena_head
 42273 00007389 7509                    	jne	short norm_strat	; N: see if we reached last arena
 42274 0000738B 8CD8                    	mov	ax,ds			; ax = current block
 42275 0000738D 363B06[8C00]            	cmp	ax,[ss:UMB_HEAD]	; Q: check against umb_head 
 42276 00007392 EB03                    	jmp	short alloc_chk_end
 42277                                  
 42278                                  norm_strat:
 42279                                  	;cmp	byte [di],5Ah ; 'Z'
 42280 00007394 803D5A                          CMP     BYTE [DI],arena_signature_end
 42281                                                                          ; IF current block is last THEN
 42282                                  alloc_chk_end:
 42283 00007397 740E                            JZ      SHORT alloc_end		;   GOTO end
 42284 00007399 E863FF                          CALL    arena_next              ; AX, ES <- next block, Carry set if error
 42285 0000739C 73CD                            JNC     SHORT alloc_scan	; IF no error THEN GOTO scan
 42286                                  
 42287                                  alloc_err:
 42288 0000739E 58                              POP     AX
 42289                                  
 42290                                  alloc_trashed:
 42291                                  	;LeaveCrit critMem
 42292 0000739F E86EA5                  	call    LCritMEM ; MSDOS 3.3 & MSDOS 6.0
 42293                                  
 42294                                  alloc_trashed2:	; 10/03/2024 - Retro DOS v5.0 (PCDOS 7.1) -jmp from GetLastArena-
 42295                                  	;error	error_arena_trashed
 42296                                  	;mov	al,7
 42297 000073A2 B007                    	MOV	AL,error_arena_trashed
 42298                                  alloc_errj:
 42299 000073A4 E9CD92                  	JMP	SYS_RET_ERR
 42300                                  
 42301                                  alloc_end:
 42302                                  	; 18/05/2019
 42303 000073A7 36833E[4003]00                  CMP	WORD [SS:FirstArena],0
 42304 000073AD 7403                    	jz	short alloc_chk 
 42305 000073AF E98400                  	jmp	alloc_do_split
 42306                                  
 42307                                  alloc_chk:
 42308                                  	; MSDOS 6.0
 42309 000073B2 36A1[2400]              	mov	ax,[ss:arena_head]
 42310 000073B6 363B06[8E00]            	cmp	ax,[ss:START_ARENA]	; Q: started scanning from arena_head
 42311 000073BB 740E                    	je	short alloc_fail	; Y: not enough memory
 42312                                  					; N:
 42313                                  					; Q: is the alloc strat HIGH_ONLY
 42314 000073BD 36F606[0203]40          	test 	byte [ss:AllocMethod],HIGH_ONLY
 42315 000073C3 7506                    	jnz	short alloc_fail	; Y: return size of largest UMB
 42316                                  	
 42317 000073C5 36A3[8E00]              	mov	[ss:START_ARENA],ax	; N: start scanning from arena_head
 42318                                  	; 27/09/2023 (*)
 42319 000073C9 EB9B                    	jmp	short start_scan_x ; (*) ; (BugFix)
 42320                                  	;jmp	short start_scan
 42321                                  					; M000 - end
 42322                                  
 42323                                  alloc_fail:
 42324                                          ;invoke Get_User_Stack
 42325 000073CB E8A990                          CALL	Get_User_Stack
 42326 000073CE 5B                      	POP     BX
 42327                                          ;MOV	[SI].user_BX,BX
 42328                                  	;MOV	[SI+2],BX
 42329 000073CF 895C02                  	mov	[SI+user_env.user_BX],bx
 42330                                  	;LeaveCrit critMem
 42331 000073D2 E83BA5                  	call    LCritMEM ; MSDOS 3.3 & MSDOS 6.0
 42332                                  	;error	error_not_enough_memory
 42333                                  	;mov	al,8
 42334 000073D5 B008                    	MOV	AL,error_not_enough_memory
 42335                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42336 000073D7 EBCB                    	jmp	short alloc_errj
 42337                                  	;JMP	SYS_RET_ERR
 42338                                  
 42339                                  alloc_free:
 42340 000073D9 E83AFF                          CALL    Coalesce		; add following free block to current
 42341 000073DC 72C0                            JC	SHORT alloc_err		; IF error THEN GOTO err
 42342 000073DE 8B0E0300                        MOV     CX,[ARENA.SIZE]
 42343 000073E2 5A                              POP     DX                      ; check for max found size
 42344 000073E3 39D1                            CMP     CX,DX
 42345 000073E5 7602                            JNA     SHORT alloc_test
 42346 000073E7 89CA                            MOV     DX,CX
 42347                                  
 42348                                  alloc_test:
 42349 000073E9 52                              PUSH    DX
 42350 000073EA 39CB                            CMP     BX,CX                   ; IF BX > size of current block THEN
 42351 000073EC 7785                    	JA      SHORT alloc_next	;   GOTO next
 42352                                  
 42353                                  	; 15/03/2018
 42354 000073EE 36833E[4003]00                  CMP     WORD [SS:FirstArena],0
 42355 000073F4 7505                    	JNZ	SHORT alloc_best
 42356 000073F6 368C1E[4003]                    MOV     [SS:FirstArena],DS	; save first one found
 42357                                  alloc_best:
 42358 000073FB 36833E[4203]00                  CMP     WORD [SS:BestArena],0
 42359 00007401 740E                            JZ      SHORT alloc_make_best	; initial best
 42360 00007403 06                              PUSH	ES
 42361 00007404 368E06[4203]                    MOV     ES,[SS:BestArena]
 42362 00007409 26390E0300                      CMP     [ES:ARENA.SIZE],CX	; is size of best larger than found?
 42363 0000740E 07                              POP	ES
 42364 0000740F 7605                            JBE     SHORT alloc_last
 42365                                  alloc_make_best:
 42366 00007411 368C1E[4203]                    MOV     [SS:BestArena],DS	; assign best
 42367                                  alloc_last:
 42368 00007416 368C1E[4403]                    MOV     [SS:LastArena],DS 	; assign last
 42369 0000741B E955FF                          JMP     alloc_next
 42370                                  ;
 42371                                  ; split the block high
 42372                                  ;
 42373                                  alloc_do_split_high:
 42374 0000741E 368E1E[4403]                    MOV     DS,[SS:LastArena]
 42375 00007423 8B0E0300                        MOV     CX,[ARENA.SIZE]
 42376 00007427 29D9                            SUB     CX,BX
 42377 00007429 8CDA                            MOV     DX,DS
 42378 0000742B 7449                            JE      SHORT alloc_set_owner	; sizes are equal, no split
 42379 0000742D 01CA                            ADD     DX,CX                   ; point to next block
 42380 0000742F 8EC2                            MOV     ES,DX                   ; no decrement!
 42381 00007431 49                              DEC     CX
 42382 00007432 87D9                            XCHG    BX,CX                   ; bx has size of lower block
 42383 00007434 EB2B                            JMP     SHORT alloc_set_sizes	; cx has upper (requested) size
 42384                                  ;
 42385                                  ; we have scanned memory and have found all appropriate blocks
 42386                                  ; check for the type of allocation desired; first and best are identical
 42387                                  ; last must be split high
 42388                                  ;
 42389                                  alloc_do_split:
 42390                                  
 42391                                  ; 17/12/2022
 42392                                  ; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42393                                  ;%if 0
 42394                                  	; 14/05/2019
 42395                                  	; MSDOS 6.0			; M000 - start
 42396                                  	;xor	cx,cx
 42397 00007436 368A0E[0203]            	mov	cl,[ss:AllocMethod]
 42398                                  	;and	cx,STRAT_MASK ; 0FF3Fh	; mask off bit 7
 42399 0000743B 80E13F                  	and	cl,3Fh
 42400                                  	;cmp	cx,BEST_FIT ; 1		; Q; is the alloc strategy best_fit
 42401 0000743E 80F901                  	cmp	cl,BEST_FIT
 42402 00007441 77DB                    	ja	short alloc_do_split_high
 42403                                  ;%endif
 42404                                  
 42405                                  	; 17/12/2022
 42406                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42407                                  	; MSDOS 6.0 & MSDOS 5.0
 42408                                  	;xor	cx,cx
 42409                                  	;mov	cl,[ss:AllocMethod]
 42410                                  	;and	cx,STRAT_MASK ; 0FF3Fh	; mask off bit 7
 42411                                  	;cmp	cx,BEST_FIT ; 1		; Q; is the alloc strategy best_fit
 42412                                  	;ja	short alloc_do_split_high
 42413                                  
 42414                                  	; 15/03/2018
 42415                                          ;;CMP	BYTE [SS:AllocMethod], 1
 42416                                  	; 04/08/2018
 42417                                  	;CMP	BYTE [SS:AllocMethod],BEST_FIT
 42418                                          ;JA	SHORT alloc_do_split_high
 42419                                          
 42420 00007443 368E1E[4003]            	MOV     DS,[SS:FirstArena]
 42421 00007448 7205                    	JB      SHORT alloc_get_size
 42422 0000744A 368E1E[4203]            	MOV     DS,[SS:BestArena]
 42423                                  
 42424                                  alloc_get_size:
 42425 0000744F 8B0E0300                        MOV     CX,[ARENA.SIZE]
 42426 00007453 29D9                            SUB     CX,BX                   ; get room left over
 42427 00007455 8CD8                            MOV     AX,DS
 42428 00007457 89C2                            MOV     DX,AX                   ; save for owner setting
 42429 00007459 741B                            JE      SHORT alloc_set_owner	; IF BX = size THEN (don't split)
 42430 0000745B 01D8                            ADD     AX,BX
 42431 0000745D 40                              INC     AX                      ; remember the header
 42432 0000745E 8EC0                            MOV     ES,AX                   ; ES <- DS + BX (new header location)
 42433 00007460 49                              DEC     CX                      ; CX <- size of split block
 42434                                  alloc_set_sizes:
 42435 00007461 891E0300                        MOV     [ARENA.SIZE],BX		; current size <- BX
 42436 00007465 26890E0300                      MOV     [ES:ARENA.SIZE],CX      ; split size <- CX
 42437                                  	;mov	bl,4Dh ; 'M'
 42438 0000746A B34D                            MOV     BL,arena_signature_normal
 42439 0000746C 861D                            XCHG    BL,[DI]			; current signature <- 4D
 42440 0000746E 26881D                          MOV     [ES:DI],BL		; new block sig <- old block sig
 42441 00007471 26893E0100                      MOV     [ES:ARENA.OWNER],DI
 42442                                  
 42443                                  alloc_set_owner:
 42444 00007476 8EDA                            MOV     DS,DX
 42445 00007478 36A1[3003]                      MOV     AX,[SS:CurrentPDB] ; 15/03/2018
 42446 0000747C A30100                          MOV     [ARENA.OWNER],AX
 42447 0000747F 8CD8                            MOV     AX,DS
 42448 00007481 40                              INC     AX
 42449 00007482 5B                              POP     BX
 42450                                  	;LeaveCrit critMem
 42451 00007483 E88AA4                  	call    LCritMEM ; MSDOS 3.3 & MSDOS 6.0
 42452                                  	
 42453                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42454                                  alloc_ok:
 42455                                          ;transfer SYS_RET_OK
 42456 00007486 E9E191                  	JMP	SYS_RET_OK
 42457                                  
 42458                                  ;	BREAK $SETBLOCK - change size of an allocated block (if possible)
 42459                                  
 42460                                  ; MSDOS 6.0
 42461                                  ;----------------------------------------------------------------------------
 42462                                  ;**	$SETBLOCK - Change size of an Allocated Block
 42463                                  ;
 42464                                  ;	Setblock changes the size of an allocated block. First, we coalesce
 42465                                  ;	any following free space onto this block; then we try to trim the
 42466                                  ;	block down to the size requested.
 42467                                  ;
 42468                                  ;	Note that if the guy wants to grow the block but that growth fails,
 42469                                  ;	we still go ahead and coalesce any trailing free blocks onto it.
 42470                                  ;	Thus the maximum-size-possible value that we return has already
 42471                                  ;	been allocated! This is a bug, dare we fix it? BUGBUG
 42472                                  ;
 42473                                  ;	NOTE - $SETBLOCK is in bed with $ALLOC and jumps into $ALLOC to
 42474                                  ;		finish it's work. For this reason we build the allocsf
 42475                                  ;		structure on the frame, to make us compatible with $ALLOCs
 42476                                  ;		code.
 42477                                  ;
 42478                                  ;	ENTRY	(es) = segment of old block
 42479                                  ;		(bx) = newsize
 42480                                  ;		(ah) = SETBLOCK
 42481                                  ;
 42482                                  ;	EXIT	'C' clear if OK
 42483                                  ;		'C' set if error
 42484                                  ;		  (ax) = error_invalid_block
 42485                                  ;		       = error_arena_trashed
 42486                                  ;		       = error_not_enough_memory
 42487                                  ;		       = error_invalid_function
 42488                                  ;		  (bx) = maximum size possible, iff (ax) = error_not_enough_memory
 42489                                  ;	USES	???? BUGBUG
 42490                                  ;----------------------------------------------------------------------------
 42491                                  
 42492                                  ; MSDOS 2.11 (& MSDOS 3.3)
 42493                                  ;----------------------------------------------------------------------------
 42494                                  ;SUBTTL $SETBLOCK - change size of an allocated block (if possible)
 42495                                  ;
 42496                                  ;   Assembler usage:
 42497                                  ;           MOV     ES,block
 42498                                  ;           MOV     BX,newsize
 42499                                  ;           MOV     AH,setblock
 42500                                  ;           INT     21h
 42501                                  ;         if setblock fails for growing, BX will have the maximum
 42502                                  ;         size possible
 42503                                  ;   Error return:
 42504                                  ;           AX = error_invalid_block
 42505                                  ;              = error_arena_trashed
 42506                                  ;              = error_not_enough_memory
 42507                                  ;              = error_invalid_function
 42508                                  ;----------------------------------------------------------------------------
 42509                                  
 42510                                  _$SETBLOCK:        
 42511                                  	; 04/08/2018 - Retro DOS v3.0
 42512                                  	;EnterCrit   critMem
 42513 00007489 E857A4                  	call	ECritMEM ; MSDOS 3.3 & MSDOS 6.0
 42514                                  
 42515 0000748C BF0000                  	MOV     DI,ARENA.SIGNATURE
 42516 0000748F 8CC0                            MOV     AX,ES
 42517 00007491 48                              DEC     AX
 42518 00007492 E871FE                          CALL    check_signature
 42519 00007495 7303                            JNC     SHORT setblock_grab
 42520                                  
 42521                                  setblock_bad:
 42522 00007497 E905FF                          JMP     alloc_trashed
 42523                                  
 42524                                  setblock_grab:
 42525 0000749A 8ED8                            MOV     DS,AX
 42526 0000749C E877FE                          CALL    Coalesce
 42527 0000749F 72F6                            JC      SHORT setblock_bad
 42528 000074A1 8B0E0300                        MOV     CX,[ARENA.SIZE]
 42529 000074A5 51                              PUSH    CX
 42530 000074A6 39CB                            CMP     BX,CX
 42531 000074A8 76A5                            JBE     SHORT alloc_get_size
 42532 000074AA E91EFF                          JMP     alloc_fail
 42533                                  
 42534                                  ;	BREAK $DEALLOC - free previously allocated piece of memory
 42535                                  
 42536                                  ; MSDOS 6.0
 42537                                  ;----------------------------------------------------------------------------
 42538                                  ;**	$DEALLOC - Free Heap Memory
 42539                                  ;
 42540                                  ;	ENTRY	(es) = address of item
 42541                                  ;
 42542                                  ;	EXIT	'C' clear of OK
 42543                                  ;		'C' set if error
 42544                                  ;		  (AX) = error_invalid_block
 42545                                  ;	USES	???? BUGBUG
 42546                                  
 42547                                  ; MSDOS 2.11 (& MSDOS 3.3)
 42548                                  ;----------------------------------------------------------------------------
 42549                                  ;SUBTTL $DEALLOC - free previously allocated piece of memory
 42550                                  ;
 42551                                  ;   Assembler usage:
 42552                                  ;           MOV     ES,block
 42553                                  ;           MOV     AH,dealloc
 42554                                  ;           INT     21h
 42555                                  ;
 42556                                  ;   Error return:
 42557                                  ;           AX = error_invalid_block
 42558                                  ;              = error_arena_trashed
 42559                                  ;---------------------------------------------------------------------------- 
 42560                                  
 42561                                  	; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 42562                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 42563                                  _$DEALLOC:
 42564                                  	; 14/05/2019 - Retro DOS v4.0    
 42565                                  	; 04/08/2018 - Retro DOS v3.0
 42566                                  	;EnterCrit   critMem
 42567 000074AD E833A4                  	call	ECritMEM ; MSDOS 3.3 & MSDOS 6.0
 42568                                  
 42569                                  	; MSDOS 6.0			; M016, M068 - Start
 42570 000074B0 36F606[8600]04          	test	byte [ss:DOS_FLAG],EXECA20OFF
 42571                                  					; Q: was the previous call an int 21
 42572                                  					;    exec call
 42573 000074B6 740D                    	jz	short deallocate	; N: continue
 42574 000074B8 36803E[8500]00          	cmp	byte [ss:A20OFF_COUNT], 0 ; Q: is count 0
 42575 000074BE 7505                    	jne	short deallocate	; N: continue
 42576                                  	;mov	byte [ss:A20OFF_COUNT], 1 ; Y: set count to 1
 42577                                  	; 25/09/2023
 42578 000074C0 36FE06[8500]            	inc	byte [ss:A20OFF_COUNT]
 42579                                  deallocate:				; M016, M068 - End
 42580 000074C5 BF0000                  	MOV     DI,ARENA.SIGNATURE ; = 0
 42581 000074C8 8CC0                            MOV     AX,ES
 42582 000074CA 48                              DEC     AX
 42583 000074CB E838FE                          CALL    check_signature
 42584 000074CE 720A                            JC      SHORT dealloc_err
 42585 000074D0 26893E0100                      MOV     [ES:ARENA.OWNER],DI
 42586                                  	;LeaveCrit critMem
 42587 000074D5 E838A4                  	call    LCritMEM ; MSDOS 3.3 & MSDOS 6.0
 42588                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42589                                          ;transfer SYS_RET_OK
 42590                                  dealloc_ok:
 42591 000074D8 EBAC                    	jmp	short alloc_ok
 42592                                  	;JMP	SYS_RET_OK
 42593                                  
 42594                                  dealloc_err:
 42595                                  	;LeaveCrit critMem
 42596 000074DA E833A4                  	call    LCritMEM ; MSDOS 3.3 & MSDOS 6.0
 42597                                          ;error	error_invalid_block
 42598                                  	;mov	al,9
 42599 000074DD B009                    	MOV	AL,error_invalid_block
 42600                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42601                                  dealloc_errj:
 42602                                  AllocOperErrj:	; 17/12/2022
 42603 000074DF E99291                  	JMP	SYS_RET_ERR
 42604                                  
 42605                                  ;	BREAK $AllocOper - get/set allocation mechanism
 42606                                  
 42607                                  ; MSDOS 6.0
 42608                                  ;----------------------------------------------------------------------------
 42609                                  ;**	$AllocOper - Get/Set Allocation Mechanism
 42610                                  ;
 42611                                  ;	Assembler usage:
 42612                                  ;           MOV     AH,AllocOper
 42613                                  ;           MOV     BX,method
 42614                                  ;           MOV     AL,func
 42615                                  ;           INT     21h
 42616                                  ;
 42617                                  ;	ENTRY	
 42618                                  ;		(al) = 0
 42619                                  ;		  Get allocation Strategy in (ax)
 42620                                  ;
 42621                                  ;		(al) = 1, (bx) = method = zw0000xy
 42622                                  ;		  Set allocation strategy.
 42623                                  ;		   w  = 1  => HIGH_ONLY
 42624                                  ;		   z  = 1  => HIGH_FIRST
 42625                                  ;		   xy = 00 => FIRST_FIT
 42626                                  ;		      = 01 => BEST_FIT
 42627                                  ;		      = 10 => LAST_FIT
 42628                                  ;
 42629                                  ;		(al) = 2
 42630                                  ;		  Get UMB link state in (al)
 42631                                  ;
 42632                                  ;		(al) = 3
 42633                                  ;		  Set UMB link state
 42634                                  ;		   (bx) = 0 => Unlink UMBs
 42635                                  ;		   (bx) = 1 => Link UMBs
 42636                                  ;
 42637                                  ;
 42638                                  ;	EXIT	'C' clear if OK
 42639                                  ;
 42640                                  ;		 if (al) = 0
 42641                                  ;		  (ax) = existing method
 42642                                  ;		 if (al) = 1
 42643                                  ;		  Sets allocation strategy
 42644                                  ;		 if (al) = 2
 42645                                  ;		  (al) = 0 => UMBs not linked
 42646                                  ;		  (al) = 1 => UMBs linked in
 42647                                  ;		 if (al) = 3
 42648                                  ;		  Links/Unlinks the UMBs into DOS chain
 42649                                  ;
 42650                                  ;		'C' set if error
 42651                                  ;		  AX = error_invalid_function
 42652                                  ;
 42653                                  ;	Rev. M000 - added support for HIGH_FIRST in (al) = 1. 7/9/90
 42654                                  ; 	Rev. M003 - added functions (al) = 2 and (al) = 3. 7/18/90
 42655                                  ;	Rev. M009 - (al) = 3 will return 'invalid function' in ax if
 42656                                  ;		    umbhead has'nt been initialized by sysinit and 'trashed
 42657                                  ;		    arena' if an arena sig is damaged.
 42658                                  ;----------------------------------------------------------------------------
 42659                                  
 42660                                  ; MSDOS 2.11 (& MSDOS 3.3)
 42661                                  ;----------------------------------------------------------------------------
 42662                                  ;SUBTTL $AllocOper - get/set allocation mechanism
 42663                                  ;
 42664                                  ;   Assembler usage:
 42665                                  ;           MOV     AH,AllocOper
 42666                                  ;           MOV     BX,method
 42667                                  ;           MOV     AL,func
 42668                                  ;           INT     21h
 42669                                  ;
 42670                                  ;   Error return:
 42671                                  ;           AX = error_invalid_function
 42672                                  ;----------------------------------------------------------------------------
 42673                                  
 42674                                  	; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 42675                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 42676                                  _$ALLOCOPER:
 42677                                  	; 14/05/2019 - Retro DOS v4.0
 42678                                  	; MSDOS 6.0
 42679 000074E2 08C0                    	or	al,al ; 0
 42680 000074E4 7411                    	jz	short AllocGetStrat
 42681                                  	; 17/12/2022
 42682                                  	;cmp	al,1
 42683                                  	;jz	short AllocSetStrat
 42684                                  
 42685                                  	; 01/12/2022
 42686                                  	;cmp	al, 2
 42687                                  	;jb	short AllocSetStrat
 42688                                  	;ja	short AllocSetLink
 42689                                  	;;jmp	short AllocGetLink
 42690                                  ;AllocGetLink:
 42691                                  	; MSDOS 6.0
 42692                                  	;mov	al,[ss:UMBFLAG]		; return link state in al
 42693                                  	;and 	al,LINKSTATE
 42694                                  	;;transfer SYS_RET_OK
 42695                                  	;jmp	SYS_RET_OK
 42696                                  
 42697 000074E6 3C02                    	cmp	al,2
 42698                                  	; 17/12/2022
 42699 000074E8 7216                    	jb	short AllocSetStrat ; al = 1
 42700 000074EA 7425                    	je	short AllocGetLink
 42701                                  
 42702                                  	;cmp	al,2
 42703                                  	;jz	short AllocGetLink
 42704 000074EC 3C03                    	cmp	al,3
 42705 000074EE 7429                    	jz	short AllocSetLink
 42706                                  
 42707                                  	; 15/04/2018
 42708                                  	;CMP	AL,1
 42709                                          ;JB	SHORT AllocOperGet
 42710                                          ;JZ	SHORT AllocOperSet
 42711                                  
 42712                                  AllocOperError:
 42713                                  
 42714                                  ; 10/03/2024
 42715                                  %if 0
 42716                                  	; 04/08/2018 - Retro DOS v3.0
 42717                                  	; MSDOS 3.3 (& MSDOS 6.0)	; Extended Error Locus
 42718                                  	;mov	byte [ss:EXTERR_LOCUS],5
 42719                                          MOV     byte [SS:EXTERR_LOCUS],errLOC_Mem
 42720                                  	;error	error_invalid_function
 42721                                  %else
 42722                                  	; 10/03/2024 - Retro DOS v5.0 
 42723                                  	; (PCDOS 7.1 IBMDOS.COM)
 42724                                  	;;;
 42725 000074F0 E8F59D                  	call	set_exerr_locus_mem
 42726                                  	;;;
 42727                                  %endif
 42728                                  	;mov	al,1
 42729 000074F3 B001                    	MOV	AL,error_invalid_function
 42730                                  	; 17/12/2022
 42731                                  ;AllocOperErrj:
 42732                                  	;JMP	SYS_RET_ERR
 42733                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42734                                  	;jmp	short dealloc_errj
 42735                                  	; 17/12/2022
 42736 000074F5 EBE8                    	jmp	short AllocOperErrj
 42737                                  
 42738                                  ; 10/03/2024 - Retro DOS v5.0 
 42739                                  ; (PCDOS 7.1 IBMDOS.COM)
 42740                                  %if 0
 42741                                  AllocArenaError:
 42742                                  	; MSDOS 6.0
 42743                                  	MOV     byte [SS:EXTERR_LOCUS],errLOC_Mem
 42744                                  					; M009: Extended Error Locus
 42745                                  	;error	error_arena_trashed	; M009:
 42746                                  	;mov	al,7
 42747                                  	MOV	AL,error_arena_trashed
 42748                                  	;JMP	SYS_RET_ERR
 42749                                  	jmp	short AllocOperErrj ; 17/12/2022
 42750                                  %endif
 42751                                  
 42752                                  AllocGetStrat: 
 42753                                  	; MSDOS 6.0
 42754                                  AllocOperGet:
 42755 000074F7 36A0[0203]                      MOV     AL,[SS:AllocMethod]
 42756 000074FB 30E4                            XOR     AH,AH
 42757                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42758                                  	;transfer SYS_RET_OK
 42759                                  AllocOperOk:
 42760                                  	; 17/12/2022
 42761                                  	;jmp	short dealloc_ok
 42762 000074FD E96A91                  	JMP	SYS_RET_OK
 42763                                  
 42764                                  AllocSetStrat: 
 42765                                  	; 14/05/2019
 42766                                  	; MSDOS 6.0
 42767 00007500 53                      	push	bx			; M000 - start
 42768                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42769                                  	;and	bx,STRAT_MASK ; 0FF3Fh	; M064: mask off bit 6 & 7
 42770                                  	; 17/12/2022
 42771 00007501 80E33F                  	and	bl,3Fh
 42772 00007504 83FB02                  	cmp	bx,2			; BX must be 0-2
 42773                                  	;cmp	bl,2
 42774 00007507 5B                      	pop	bx			; M000 - end
 42775 00007508 77E6                    	ja	short AllocOperError
 42776                                  
 42777                                  AllocOperSet:
 42778 0000750A 36881E[0203]                    MOV     [SS:AllocMethod],BL
 42779                                    	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42780                                  	;transfer SYS_RET_OK
 42781                                  AllocOperOkj:
 42782 0000750F EBEC                    	jmp	short AllocOperOk
 42783                                  	;JMP	SYS_RET_OK
 42784                                  
 42785                                  AllocGetLink:
 42786                                  	; MSDOS 6.0
 42787 00007511 36A0[8900]              	mov	al,[ss:UMBFLAG]		; return link state in al
 42788                                  	;and	al,1
 42789 00007515 2401                    	and 	al,LINKSTATE
 42790                                   	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42791                                  	;transfer SYS_RET_OK
 42792                                  AllocOperOkj2:
 42793                                  	; 17/12/2022
 42794 00007517 EBE4                    	jmp	short AllocOperOk
 42795                                  	;jmp	short AllocOperOkj
 42796                                  	;;JMP	SYS_RET_OK
 42797                                  
 42798                                  AllocSetLink:
 42799                                  	; MSDOS 6.0			; M009 - start
 42800 00007519 368B0E[8C00]            	mov	cx,[ss:UMB_HEAD]	; cx = umb_head
 42801                                  
 42802                                  ; 10/03/2024
 42803                                  %if 0
 42804                                  	cmp	cx,0FFFFh		; Q: has umb_head been initialized
 42805                                  	je	short AllocOperError	; N: error
 42806                                  					; Y: continue
 42807                                  					; M009 - end
 42808                                  	cmp	bx,1
 42809                                  	jb	short UnlinkUmbs ; 0
 42810                                  	jz	short LinkUmbs   ; 1
 42811                                  %else
 42812                                  	; 10/03/2024 - Retro DOS v5.0
 42813                                  	; (PCDOS 7.1 IBMDOS.COM)
 42814                                  	;;;
 42815 0000751E 41                      	inc	cx 			; Q: has umb_head been initialized
 42816 0000751F 74CF                    	jz	short AllocOperError	; -1 ; N: error
 42817 00007521 49                      	dec	cx
 42818 00007522 4B                      	dec	bx
 42819 00007523 7418                    	jz	short LinkUmbs ; 1
 42820 00007525 43                      	inc	bx
 42821                                  	;jz	short UnlinkUmbs ; 0
 42822                                  	;;;
 42823                                  %endif
 42824                                  	;jmp	short AllocOperError
 42825                                  	; 10/03/2024
 42826 00007526 75C8                    	jnz	short AllocOperError ; > 1
 42827                                  	
 42828                                  UnlinkUmbs:
 42829                                  
 42830                                  ; 10/03/2024
 42831                                  %if 0
 42832                                  	;test	byte [ss:UMBFLAG],1
 42833                                  	test	byte [ss:UMBFLAG],LINKSTATE ; Q: umbs unlinked?
 42834                                  	jz	short unlinked		; Y: return 
 42835                                  	
 42836                                  	call	GetLastArena		; get arena before umb_head in DS
 42837                                  	jc	short AllocArenaError	; M009: arena trashed
 42838                                  %else
 42839                                  	; 10/03/2024 - Retro DOS v5.0
 42840                                  	; (PCDOS 7.1 IBMDOS.COM)
 42841                                  	;;;
 42842 00007528 E89BFD                  	call	test_umb_flag	; test byte [ss:UMBFLAG],LINKSTATE
 42843                                  				; Q: umbs unlinked?
 42844 0000752B 740E                    	jz	short unlinked	; Y: return
 42845 0000752D E82200                  	call	GetLastArena	; get arena before umb_head in DS
 42846                                  	;;;	
 42847                                  %endif
 42848                                  					; make it last
 42849 00007530 C60600005A              	mov	byte [0],arena_signature_end
 42850                                  	
 42851                                  	;and	byte [ss:UMBFLAG],0FEh
 42852 00007535 368026[8900]FE          	and	byte [ss:UMBFLAG],~LINKSTATE ; indicate unlink'd state in umbflag
 42853                                  	
 42854                                  unlinked:
 42855                                   	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42856                                  	;transfer SYS_RET_OK
 42857                                  	; 17/12/2022
 42858 0000753B EBC0                    	jmp	short AllocOperOk
 42859                                  	;jmp	short AllocOperOkj2
 42860                                  	;;JMP	SYS_RET_OK
 42861                                  
 42862                                  LinkUmbs:
 42863                                  
 42864                                  ; 10/03/2024
 42865                                  %if 0
 42866                                  	test	byte [ss:UMBFLAG],LINKSTATE ; Q: umbs linked?
 42867                                  	jnz	short linked		; Y: return
 42868                                  	
 42869                                  	call	GetLastArena		; get arena before umb_head
 42870                                  	jc	short AllocArenaError	; M009: arena trashed
 42871                                  	
 42872                                  					; make it normal. M061: ds points to
 42873                                  %else					; arena before umb_head
 42874                                  	; 10/03/2024 - Retro DOS v5.0
 42875                                  	; (PCDOS 7.1 IBMDOS.COM)
 42876                                  	;;;
 42877 0000753D E886FD                  	call	test_umb_flag	; Q: umbs linked?
 42878 00007540 750E                    	jnz	short linked	; Y: return
 42879 00007542 E80D00                  	call	GetLastArena	; get arena before umb_head
 42880                                  	;;;
 42881                                  %endif
 42882 00007545 C60600004D              	mov	byte [0],arena_signature_normal
 42883                                  	
 42884 0000754A 36800E[8900]01          	or	byte [ss:UMBFLAG],LINKSTATE ; indicate link'd state in umbflag
 42885                                  linked:
 42886                                   	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42887                                  	;transfer SYS_RET_OK
 42888                                  	; 17/12/2022
 42889 00007550 EBAB                    	jmp	short AllocOperOk
 42890                                  	;jmp	short unlinked
 42891                                  	;;JMP	SYS_RET_OK
 42892                                  
 42893                                  ; MSDOS 6.0
 42894                                  ;--------------------------------------------------------------------------
 42895                                  ; Procedure Name : GetLastArena		-  M003
 42896                                  ;
 42897                                  ; Inputs	 : cx = umb_head
 42898                                  ;
 42899                                  ;
 42900                                  ; Outputs	 : If UMBs are linked
 42901                                  ;			ES = umb_head
 42902                                  ;			DS = arena before umb_head
 42903                                  ;		   else
 42904                                  ;			DS = last arena
 42905                                  ;			ES = next arena. will be umb_head if NC.
 42906                                  ;
 42907                                  ;		   CY if error
 42908                                  ;
 42909                                  ; Uses		 : DS, ES, DI, BX
 42910                                  ;--------------------------------------------------------------------------
 42911                                  
 42912                                  ; 14/05/2019 - Retro DOS v4.0
 42913                                  ; DOSCODE:A4D6h (MSDOS 6.21, MSDOS.SYS)
 42914                                  
 42915                                  ; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 42916                                  ; DOSCODE:A476h (MSDOS 5.0, MSDOS.SYS)
 42917                                  
 42918                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 42919                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B6D9h
 42920                                  
 42921                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0A4D6h)
 42922                                  	; (Windows ME IO.SYS - BIOSCODE:9F25h)
 42923                                  
 42924                                  GetLastArena:
 42925 00007552 50                      	push	ax			; save ax
 42926                                  
 42927 00007553 36A1[2400]              	mov	ax,[ss:arena_head]
 42928 00007557 8EC0                    	mov	es,ax			; es = arena_head
 42929 00007559 31FF                    	xor	di,di
 42930                                  
 42931 0000755B 26803D5A                	cmp     byte [es:di],arena_signature_end
 42932                                  					; Q: is this the last arena
 42933 0000755F 7416                    	je	short GLA_done		; Y: return last arena in ES
 42934                                  
 42935                                  GLA_next:
 42936 00007561 8ED8                    	mov	ds,ax
 42937 00007563 E899FD                  	call	arena_next		; ax, es -> next arena
 42938                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42939                                  	;jc	short GLA_err
 42940                                  	; 17/12/2022
 42941 00007566 7222                    	jc	short GLA_err2
 42942                                  
 42943                                  ; 10/03/2024
 42944                                  %if 0
 42945                                  	test	byte [ss:UMBFLAG],LINKSTATE ; Q: are UMBs linked
 42946                                  	jnz	short GLA_chkumb	; Y: terminating condition is
 42947                                  					;    umb_head
 42948                                  					; N: terminating condition is 05Ah
 42949                                  %else
 42950                                  	; 10/03/2024 (PCDOS 7.1 IBMDOS.COM)
 42951                                  	;;;
 42952 00007568 E85BFD                  	call	test_umb_flag
 42953 0000756B 7506                    	jnz	short GLA_chkumb
 42954                                  	;;;
 42955                                  %endif
 42956 0000756D 26803D5A                	cmp     byte [es:di],arena_signature_end
 42957                                  					; Q: is this the last arena
 42958 00007571 EB02                    	jmp	short GLA_@f
 42959                                  GLA_chkumb:
 42960 00007573 39C8                    	cmp	ax,cx			; Q: is this umb_head
 42961                                  GLA_@f:
 42962 00007575 75EA                    	jne	short GLA_next		; N: get next arena
 42963                                  
 42964                                  GLA_done:
 42965                                  
 42966                                  ; 10/03/2024
 42967                                  %if 0
 42968                                  					; M061 - Start
 42969                                  	test	byte [ss:UMBFLAG],LINKSTATE ; Q: are UMBs linked
 42970                                  	jnz	short GLA_ret		; Y: we're done
 42971                                  					; N: let us confirm that the next
 42972                                  					;    arena is umb_head
 42973                                  %else
 42974                                  	; 10/03/2024 (PCDOS 7.1 IBMDOS.COM)
 42975                                  	;;;
 42976 00007577 E84CFD                  	call	test_umb_flag
 42977 0000757A 750B                    	jnz	short GLA_ret ; cf=0
 42978                                  	;;;
 42979                                  %endif
 42980 0000757C 8ED8                    	mov	ds,ax
 42981 0000757E E87EFD                  	call	arena_next		; ax, es -> next arena
 42982                                  	;jc	short GLA_err
 42983 00007581 7207                    	jc	short GLA_err2
 42984 00007583 39C8                    	cmp	ax,cx			; Q: is this umb_head
 42985 00007585 7502                    	jne	short GLA_err		; N: error
 42986                                  					; M061 - End
 42987                                  GLA_ret:
 42988                                  	; 17/12/2022
 42989                                  	;clc
 42990                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42991                                  	;clc
 42992 00007587 58                      	pop	ax			; M061
 42993 00007588 C3                      	retn				; M061
 42994                                  
 42995                                  GLA_err:
 42996 00007589 F9                      	stc				; M061
 42997                                  GLA_err2:
 42998 0000758A 58                      	pop	ax
 42999                                  
 43000                                  	; 10/03/2024 - Retro DOS v5.0 
 43001                                  	; (PCDOS 7.1 IBMDOS.COM)
 43002                                  	;;;
 43003 0000758B 58                      	pop	ax	; return address to _$ALLOCOPER (the caller)
 43004 0000758C E8599D                  	call	set_exerr_locus_mem
 43005 0000758F E910FE                  	jmp	alloc_trashed2	; (error return from _$ALLOCOPER)
 43006                                  	;;;
 43007                                  
 43008                                  	; 10/03/2024
 43009                                  	;retn
 43010                                  
 43011                                  ;============================================================================
 43012                                  ; SRVCALL.ASM, MSDOS 6.0, 1991
 43013                                  ;============================================================================
 43014                                  ; 04/08/2018 - Retro DOS v3.0
 43015                                  
 43016                                  ;	TITLE SRVCALL - Server DOS call
 43017                                  ;	NAME  SRVCALL
 43018                                  
 43019                                  ;**	SRVCALL.ASM - Server DOS call functions
 43020                                  ;
 43021                                  ;
 43022                                  ;	$ServerCall
 43023                                  ;
 43024                                  ;	Modification history:
 43025                                  ;
 43026                                  ;	    Created: ARR 08 August 1983
 43027                                  
 43028                                  ;AsmVars <Installed>
 43029                                  
 43030                                  ;include dpl.asm
 43031                                  
 43032                                  ;Installed = TRUE
 43033                                  
 43034                                  ; 29/04/2019 - Retro DOS v4.0 (MSDOS 6.0, MSDOS 6.21)
 43035                                  ; ---------------------------------------------------------------------------
 43036                                  ; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43037                                  
 43038                                  ;BREAK <ServerCall -- Server DOS call>
 43039                                  
 43040                                  ; DOSCODE:A517h (MSDOS 6.21, MSDOS.SYS)
 43041                                  ; DOSCODE:A4B7h (MSDOS 5.0, MSDOS.SYS)
 43042                                  
 43043                                  ; 10/03/2024
 43044                                  ; DOSCODE:B71Ah (PCDOS 7.1, IBMDOS.COM) ; Retro DOS v5.0
 43045                                  ; DOSCODE:A517h (MSDOS 6.22, MSDOS.SYS) ; Retro DOS v4.2
 43046                                  ; BIOSCODE:9F66h (Windows ME, IO.SYS)
 43047                                  
 43048                                  ;hkn; TABLE	SEGMENT
 43049                                  ;Public SRVC001S,SRVC001E
 43050                                  ;SRVC001S label byte
 43051                                  
 43052                                  SRVC001S:
 43053                                  
 43054 00007592 [9675]                  SERVERTAB:	dw	SERVER_DISP
 43055 00007594 [E875]                  SERVERLEAVE:	dw	SERVERRETURN
 43056 00007596 0B                      SERVER_DISP:	db	(SERVER_DISP_END-SERVER_DISP-1)/2 ; = 11
 43057 00007597 [4E76]                  		dw	SRV_CALL	; 0
 43058 00007599 [E975]                  		dw	COMMIT_ALL	; 1
 43059 0000759B [1F76]                  		dw	CLOSE_NAME	; 2
 43060 0000759D [2876]                  		dw	CLOSE_UID	; 3
 43061 0000759F [2F76]                  		dw	CLOSE_UID_PID	; 4
 43062 000075A1 [3676]                  		dw	GET_LIST	; 5
 43063 000075A3 [8F76]                  		dw	GET_DOS_DATA	; 6
 43064 000075A5 [B376]                  		dw	SPOOL_OPER	; 7
 43065 000075A7 [B376]                  		dw	SPOOL_OPER	; 8
 43066 000075A9 [B376]                  		dw	SPOOL_OPER	; 9
 43067 000075AB [BF76]                  		dw	_$SetExtendedError  ; 10
 43068                                  
 43069                                  SERVER_DISP_END:  ;  LABEL BYTE
 43070                                  
 43071                                  ;SRVC001E label byte
 43072                                  
 43073                                  SRVC001E:
 43074                                  
 43075                                  ;hkn; TABLE	ENDS
 43076                                  
 43077                                  ;----------------------------------------------------------------------------
 43078                                  ;
 43079                                  ; Procedure Name : $ServerCall
 43080                                  ;
 43081                                  ; Inputs:
 43082                                  ;	DS:DX -> DPL  (except calls 7,8,9)
 43083                                  ; Function:
 43084                                  ;	AL=0	Server DOS call
 43085                                  ;	AL=1	Commit All files
 43086                                  ;	AL=2	Close file by name (SHARING LOADED ONLY) DS:DX in DPL -> name
 43087                                  ;	AL=3	Close all files for DPL_UID
 43088                                  ;	AL=4	Close all files for DPL_UID/PID_PID
 43089                                  ;	AL=5	Get open file list entry
 43090                                  ;		    IN: BX File Index
 43091                                  ;			CX User Index
 43092                                  ;		    OUT:ES:DI -> Name
 43093                                  ;			BX = UID
 43094                                  ;		    CX = # locked blocks held by this UID
 43095                                  ;	AL=6	Get DOS data area
 43096                                  ;		    OUT: DS:SI -> Start
 43097                                  ;			CX size in bytes of swap if indos
 43098                                  ;			DX size in bytes of swap always
 43099                                  ;	AL=7	Get truncate flag
 43100                                  ;	AL=8	Set truncate flag
 43101                                  ;	AL=9	Close all spool files
 43102                                  ;	AL=10	SetExtendedError
 43103                                  ;
 43104                                  ;----------------------------------------------------------------------------
 43105                                  
 43106                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43107                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B735h
 43108                                  
 43109                                  _$ServerCall:
 43110                                  	; 13/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43111                                  	; DOSCODE:A4D2h (MSDOS 5.0 MSDOS.SYS)		
 43112                                  	; 10/06/2019
 43113                                  	; 29/04/2019 - Retro DOS v4.0
 43114                                  	; DOSCODE:A532h (MSDOS 6.21 MSDOS.SYS)
 43115                                  
 43116                                  	; 05/08/2018 - Retro DOS v3.0
 43117                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 657Bh
 43118 000075AD 3C07                    	CMP	AL,7
 43119 000075AF 7204                    	JB	short SET_STUFF
 43120 000075B1 3C09                    	CMP	AL,9
 43121 000075B3 761A                    	JBE	short NO_SET_ID		; No DPL on calls 7,8,9
 43122                                  SET_STUFF:
 43123 000075B5 89D6                    	MOV	SI,DX			; Point to DPL with DS:SI
 43124                                  	;mov	bx,[si+12h]
 43125 000075B7 8B5C12                  	MOV	BX,[SI+DPL.UID]
 43126                                  
 43127                                  	; MSDOS 6.0
 43128                                  ;SR;
 43129                                  ; WIN386 updates the USER_ID itself. If WIN386 is present we skip the updating
 43130                                  ; of USER_ID
 43131                                  
 43132 000075BA 36F606[5B0F]01          	test	byte [SS:IsWin386],1
 43133 000075C0 7505                    	jnz	short skip_win386
 43134                                  
 43135                                  ;hkn; SS override for user_id and proc_id
 43136                                  	; 15/08/2018
 43137 000075C2 36891E[3E03]            	MOV	[SS:USER_ID],BX		; Set UID
 43138                                  
 43139                                  skip_win386:
 43140 000075C7 8B5C14                  	MOV	BX,[SI+DPL.PID]
 43141 000075CA 36891E[3C03]            	MOV	[SS:PROC_ID],BX		; Set process ID
 43142                                  NO_SET_ID:
 43143                                  	; 10/06/2019 - Retro DOS v4.0
 43144 000075CF 2EFF36[9475]            	PUSH	word [cs:SERVERLEAVE]	; push return address
 43145 000075D4 2EFF36[9275]            	PUSH	word [cS:SERVERTAB]	; push table address
 43146 000075D9 50                      	PUSH	AX
 43147 000075DA E819A2                  	call	TableDispatch
 43148                                  
 43149                                  ;hkn; SS override
 43150                                  	;mov 	byte [SS:EXETERR_LOCUS],1
 43151 000075DD 36C606[2303]01          	MOV	byte [SS:EXTERR_LOCUS],errLOC_Unk ; Extended Error Locus
 43152                                  	;error	error_invalid_function
 43153                                  	;mov	al,1
 43154 000075E3 B001                    	MOV	AL,error_invalid_function
 43155                                  servercall_error:
 43156 000075E5 E98C90                  	JMP	SYS_RET_ERR
 43157                                  
 43158                                  SERVERRETURN:
 43159 000075E8 C3                      	retn
 43160                                  
 43161                                  ; Commit - iterate through the open file list and make sure that the
 43162                                  ; directory entries are correctly updated.
 43163                                  
 43164                                  	; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43165                                  COMMIT_ALL:
 43166 000075E9 31DB                    	XOR	BX,BX			;   for (i=0; ThisSFT=getSFT(i); i++)
 43167 000075EB 16                      	push	ss
 43168 000075EC 1F                      	pop	ds
 43169 000075ED E8F3A2                  	call	ECritSFT		; Gonna scan SFT cache, lock it down
 43170                                  CommitLoop:
 43171 000075F0 53                      	push	bx
 43172 000075F1 E82201                  	call	SFFromSFN
 43173 000075F4 7222                    	JC	short CommitDone
 43174 000075F6 26833D00                	cmp	word [es:di],0
 43175                                  	;CMP	word [ES:DI+SF_ENTRY.sf_Ref_Count],0
 43176                                  					; if (ThisSFT->refcount != 0)
 43177 000075FA 7418                    	JZ	short CommitNext
 43178                                  	;cmp	word [es:di],0FFFFh ; -1
 43179 000075FC 26833DFF                	cmp	word [ES:DI],sf_busy
 43180                                  	;CMP	word [ES:DI+SF_ENTRY.sf_Ref_Count],sf_busy  
 43181                                  					; BUSY SFTs have god knows what
 43182 00007600 7412                    	JZ	short CommitNext	;   in them.
 43183                                  	; 17/12/2022
 43184 00007602 26F6450680              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_isnet>>8) ; 80h
 43185                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet ; 8000h
 43186 00007607 750B                    	JNZ	short CommitNext	;  Skip Network SFTs so the SERVER
 43187                                  					;	doesn't deadlock
 43188 00007609 893E[9E05]              	MOV	[THISSFT],DI
 43189 0000760D 8C06[A005]              	MOV	[THISSFT+2],ES
 43190 00007611 E8C0C2                  	call	DOS_COMMIT		;	DOSCommit ();
 43191                                  CommitNext:
 43192 00007614 5B                      	pop	bx
 43193 00007615 43                      	INC	BX
 43194 00007616 EBD8                    	JMP	short CommitLoop
 43195                                  CommitDone:
 43196 00007618 E8F5A2                  	call	LCritSFT
 43197 0000761B 5B                      	pop	bx
 43198                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43199                                  Commit_Ok:
 43200 0000761C E94B90                  	jmp	SYS_RET_OK
 43201                                  	
 43202                                  CLOSE_NAME:
 43203                                  
 43204                                  ;if installed
 43205                                  
 43206                                  ;hkn; SS override
 43207                                  	;call	far [ss:MFTcloN]
 43208 0000761F 36FF1E[A400]            	Call	far [SS:JShare+(5*4)] ; 5 = MFTcloN
 43209                                  ;else
 43210                                  ;	Call	MFTcloN
 43211                                  ;endif
 43212                                  
 43213                                  CheckReturns:
 43214                                  
 43215                                  ; 10/03/2024
 43216                                  %if 0
 43217                                  	JC	short func_err
 43218                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43219                                  	;transfer SYS_RET_OK
 43220                                  Commit_Okj:
 43221                                  	jmp	short Commit_Ok
 43222                                  	;jmp	SYS_RET_OK
 43223                                  %else
 43224 00007624 73F6                    	jnc	short Commit_Ok
 43225                                  %endif
 43226                                  
 43227                                  func_err:
 43228                                  	;transfer SYS_RET_ERR
 43229                                  	;jmp	SYS_RET_ERR
 43230 00007626 EBBD                    	jmp	short servercall_error
 43231                                  
 43232                                  CLOSE_UID:
 43233                                  
 43234                                  ;if installed
 43235                                  ;hkn; SS override
 43236                                  	;call	far [ss:MFTclU]
 43237 00007628 36FF1E[9C00]            	Call	far [SS:JShare+(3*4)] ; 3 = MTFTclu
 43238                                  ;else
 43239                                  ;	Call	MFTclU
 43240                                  ;endif
 43241 0000762D EBF5                    	JMP	short CheckReturns
 43242                                  
 43243                                  CLOSE_UID_PID:
 43244                                  
 43245                                  ;if installed
 43246                                  ;hkn; SS override
 43247                                  	;call	far [ss:MFTCloseP]
 43248 0000762F 36FF1E[A000]            	Call	far [SS:JShare+(4*4)] ; 4 = MFTCloseP
 43249                                  ;else
 43250                                  ;	Call	MFTCloseP
 43251                                  ;endif
 43252 00007634 EBEE                    	JMP	short CheckReturns
 43253                                  
 43254                                  GET_LIST:
 43255                                  
 43256                                  ;if installed
 43257                                  ;hkn; SS override
 43258                                  	;call	far [ss:MFT_get]
 43259 00007636 36FF1E[B400]            	Call	far [SS:JShare+(9*4)] ; 9 = MFT_get
 43260                                  ;else
 43261                                  ;	Call	MFT_get
 43262                                  ;endif
 43263 0000763B 72E9                    	JC	short func_err
 43264 0000763D E8378E                  	call	Get_User_Stack
 43265                                  	;mov	[si+2],bx
 43266 00007640 895C02                  	MOV	[SI+user_env.user_BX],BX
 43267                                  	;mov	[si+10],di
 43268 00007643 897C0A                  	MOV	[SI+user_env.user_DI],DI
 43269                                  	;mov	[si+16],es
 43270 00007646 8C4410                  	MOV	[SI+user_env.user_ES],ES
 43271                                  SetCXOK:
 43272                                  	;mov	[si+4],cx
 43273 00007649 894C04                  	MOV	[SI+user_env.user_CX],CX
 43274                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43275                                  	;transfer SYS_RET_OK
 43276                                  Commit_Okj2:
 43277                                  	; 17/12/2022
 43278 0000764C EBCE                    	jmp	short Commit_Ok
 43279                                  	;jmp	short Commit_Okj
 43280                                  	;;jmp	SYS_RET_OK
 43281                                  
 43282                                  SRV_CALL:
 43283 0000764E 58                      	POP	AX			; get rid of call to $srvcall
 43284 0000764F 1E                      	push	ds
 43285 00007650 56                      	push	si
 43286 00007651 E8238E                  	call	Get_User_Stack
 43287 00007654 5F                      	pop	di
 43288 00007655 07                      	pop	es
 43289                                  
 43290                                  ; DS:SI point to stack
 43291                                  ; ES:DI point to DPL
 43292                                  
 43293 00007656 E87CA1                  	call	XCHGP
 43294                                  
 43295                                  ; DS:SI point to DPL
 43296                                  ; ES:DI point to stack
 43297                                  ;
 43298                                  ; We now copy the registers from DPL to save stack
 43299                                  
 43300 00007659 56                      	push	si
 43301 0000765A B90600                  	MOV	CX,6
 43302 0000765D F3A5                    	REP	MOVSW			; Put in AX,BX,CX,DX,SI,DI
 43303 0000765F 47                      	INC	DI
 43304 00007660 47                      	INC	DI			; Skip user_BP
 43305 00007661 A5                      	MOVSW				; DS
 43306 00007662 A5                      	MOVSW				; ES
 43307 00007663 5E                      	pop	si			; DS:SI -> DPL
 43308 00007664 8B04                    	mov	ax,[SI]
 43309                                  	;MOV	AX,[SI+DPL.AX]
 43310                                  	;mov	bx,[si+2]
 43311 00007666 8B5C02                  	MOV	BX,[SI+DPL.BX]
 43312                                  	;mov	cx,[si+4]
 43313 00007669 8B4C04                  	MOV	CX,[SI+DPL.CX]
 43314                                  	;mov	dx,[si+6]
 43315 0000766C 8B5406                  	MOV	DX,[SI+DPL.DX]
 43316                                  	;mov	di,[si+10]
 43317 0000766F 8B7C0A                  	MOV	DI,[SI+DPL.DI]
 43318                                  	;mov	es,[si+14]
 43319 00007672 8E440E                  	MOV	ES,[SI+DPL.ES]
 43320                                  	;push	word [si+8]
 43321 00007675 FF7408                  	PUSH	word [SI+DPL.SI]
 43322                                  	;mov	ds,[si+12]
 43323 00007678 8E5C0C                  	MOV	DS,[SI+DPL.DS]
 43324 0000767B 5E                      	POP	SI
 43325                                  
 43326                                  ;hkn; SS override for next 3
 43327 0000767C 368C1E[EC05]            	MOV	[SS:SAVEDS],DS
 43328 00007681 36891E[EA05]            	MOV	[SS:SAVEBX],BX
 43329 00007686 36C606[7205]FF          	MOV	byte [SS:FSHARING],-1	; set no redirect flag
 43330 0000768C E9E68C                  	jmp	REDISP
 43331                                  
 43332                                  GET_DOS_DATA:
 43333 0000768F 16                      	push	ss
 43334 00007690 07                      	pop	es
 43335 00007691 BF[2003]                	MOV     DI,SWAP_START
 43336 00007694 B9[FA0A]                	MOV     CX,SWAP_END
 43337 00007697 BA[3A03]                	MOV     DX,SWAP_ALWAYS
 43338 0000769A 29F9                    	SUB     CX,DI
 43339 0000769C 29FA                    	SUB     DX,DI
 43340 0000769E D1E9                    	SHR     CX,1                    ; div by 2, remainder in carry
 43341 000076A0 83D100                  	ADC     CX,0                    ; div by 2 + round up
 43342 000076A3 D1E1                    	SHL     CX,1                    ; round up to 2 boundary.
 43343 000076A5 E8CF8D                  	call	Get_User_Stack
 43344                                  	;mov	[si+14],es
 43345 000076A8 8C440E                  	MOV     [SI+user_env.user_DS],ES
 43346                                  	;mov	[si+8],di
 43347 000076AB 897C08                  	MOV     [SI+user_env.user_SI],DI
 43348                                  	;mov	[si+6],dx
 43349 000076AE 895406                  	MOV     [SI+user_env.user_DX],DX
 43350 000076B1 EB96                    	JMP	short SetCXOK
 43351                                  
 43352                                  SPOOL_OPER:
 43353                                  	;CallInstall NETSpoolOper,MultNET,37,AX,BX
 43354                                  
 43355 000076B3 50                      	push    ax
 43356 000076B4 B82511                  	mov     ax,1125h
 43357 000076B7 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - REDIRECTED PRINTER MODE
 43358                                  			; STACK: WORD subfunction
 43359                                  			; Return: CF set on error, AX = error code
 43360                                  			; STACK unchanged
 43361 000076B9 5B                      	pop	bx
 43362                                  	; 17/12/2022
 43363                                  	;JC	short func_err2
 43364 000076BA 7390                    	jnc	short Commit_Okj2
 43365                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43366                                  	;;jmp	SYS_RET_OK
 43367                                  	;jmp	short Commit_Okj2
 43368                                  	
 43369                                  func_err2:
 43370 000076BC E9B58F                  	jmp	SYS_RET_ERR
 43371                                  
 43372                                  ;Break	<$SetExtendedError - set extended error for later retrieval>
 43373                                  ;--------------------------------------------------------------------------
 43374                                  ;
 43375                                  ; Procedure Name : $SetExtendedError
 43376                                  ;
 43377                                  ; $SetExtendedError takes extended error information and loads it up for the
 43378                                  ; next extended error call. This is used by interrupt-level proccessors to
 43379                                  ; mask their actions.
 43380                                  ;
 43381                                  ;   Inputs: DS:SI points to DPL which contains all registers
 43382                                  ;   Outputs: none
 43383                                  ;
 43384                                  ;---------------------------------------------------------------------------
 43385                                  
 43386                                  _$SetExtendedError:
 43387                                  
 43388                                  ;hkn; SS override for all variables used
 43389                                  
 43390 000076BF 8B04                    	mov	ax,[si]
 43391                                  	;MOV	AX,[SI+DPL.AX]
 43392 000076C1 36A3[2403]              	MOV	[SS:EXTERR],AX
 43393                                  	;mov	ax,[si+10]
 43394 000076C5 8B440A                  	MOV	AX,[SI+DPL.DI]
 43395 000076C8 36A3[2803]              	MOV	[SS:EXTERRPT],AX
 43396                                  	;mov	ax,[si+14]
 43397 000076CC 8B440E                  	MOV	AX,[SI+DPL.ES]
 43398 000076CF 36A3[2A03]              	MOV	[SS:EXTERRPT+2],AX
 43399                                  	;mov	ax,[si+2]
 43400 000076D3 8B4402                  	MOV	AX,[SI+DPL.BX]
 43401 000076D6 36A3[2603]              	MOV	[SS:EXTERR_ACTION],AX
 43402                                  	;mov	ax,[si+4]
 43403 000076DA 8B4404                  	MOV	AX,[SI+DPL.CX]
 43404 000076DD 368826[2303]            	MOV	[SS:EXTERR_LOCUS],AH
 43405 000076E2 C3                      	retn
 43406                                  
 43407                                  ;============================================================================
 43408                                  ; UTIL.ASM, MSDOS 6.0, 1991
 43409                                  ;============================================================================
 43410                                  ; 05/08/2018 - Retro DOS v3.0
 43411                                  ; 05/05/2019 - Retro DOS v4.0
 43412                                  ; 11/03/2024 - Retro DOS v5.0
 43413                                  
 43414                                  ;**	Handle related utilities for MSDOS 2.X.
 43415                                  ;----------------------------------------------------------------------------
 43416                                  ;	pJFNFromHandle	written
 43417                                  ;	SFFromHandle	written
 43418                                  ;	SFFromSFN	written
 43419                                  ;	JFNFree 	written
 43420                                  ;	SFNFree 	written
 43421                                  ;
 43422                                  ;	Modification history:
 43423                                  ;
 43424                                  ;	    Created: MZ 1 April 1983
 43425                                  ;----------------------------------------------------------------------------
 43426                                  
 43427                                  ;	BREAK	<pJFNFromHandle - return pointer to JFN table entry>
 43428                                  
 43429                                  ;**	pJFNFromHandle - Translate Handle to Pointer to JFN
 43430                                  ;----------------------------------------------------------------------------
 43431                                  ;	pJFNFromHandle takes a file handle and turns that into a pointer to
 43432                                  ;	the JFN entry (i.e., to a byte holding the internal file handle #)
 43433                                  ;
 43434                                  ;	NOTE:
 43435                                  ;	  This routine is called from $CREATE_PROCESS_DATA_BLOCK which is called
 43436                                  ;	  at DOSINIT time with SS NOT DOSGROUP
 43437                                  ;
 43438                                  ;	ENTRY	(bx) = handle
 43439                                  ;	EXIT	'C' clear if ok
 43440                                  ;		  (es:di) = address of JFN value
 43441                                  ;		'C' set if error
 43442                                  ;		  (ax) = error code
 43443                                  ;	USES	AX, DI, ES, Flags
 43444                                  ;----------------------------------------------------------------------------
 43445                                  
 43446                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43447                                  	; 11/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43448                                  
 43449                                  pJFNFromHandle:
 43450                                  	; 05/05/2019 - Retro DOS v4.0
 43451                                  	;getdseg <es>			; es -> dosdata
 43452 000076E3 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 43453                                  	
 43454                                  	;MOV	ES,[cs:CurrentPDB]	; get user process data block
 43455 000076E8 268E06[3003]            	mov	es,[es:CurrentPDB]
 43456                                  
 43457                                  	;cmp	bx,[ES:32h]
 43458 000076ED 263B1E3200              	CMP	BX,[ES:PDB.JFN_Length]	; is handle greater than allocated
 43459 000076F2 7204                    	JB	short pjfn10		; no, get offset
 43460                                  ReturnCarry_inv_hndl: ; 05/08/2018 - Retro DOS v3.0
 43461                                  	;mov	al,6
 43462 000076F4 B006                    	MOV     AL,error_invalid_handle ; appropriate error
 43463                                  ReturnCarry:
 43464 000076F6 F9                      	STC                             ; signal error
 43465 000076F7 C3                      	retn				; go back
 43466                                  pjfn10: 
 43467                                  	;les	di,[es:34h]
 43468 000076F8 26C43E3400              	LES	DI,[ES:PDB.JFN_Pointer]	; get pointer to beginning of table
 43469 000076FD 01DF                    	ADD	DI,BX			; add in offset, clear 'C'
 43470                                  	;clc
 43471                                  pJFNFromHandle_error:
 43472 000076FF C3                      	retn
 43473                                  
 43474                                  ;BREAK <SFFromHandle - return pointer (or error) to SF entry from handle>
 43475                                  ;----------------------------------------------------------------------------
 43476                                  ;
 43477                                  ; Procedure Name : SFFromHandle
 43478                                  ;
 43479                                  ; SFFromHandle - Given a handle, get JFN and then index into SF table
 43480                                  ;
 43481                                  ;   Input:      BX has handle
 43482                                  ;   Output:     Carry Set
 43483                                  ;                   AX has error code
 43484                                  ;               Carry Reset
 43485                                  ;                   ES:DI has pointer to SF entry
 43486                                  ;   Registers modified: If error, AX,ES, else ES:DI
 43487                                  ; NOTE:
 43488                                  ;   This routine is called from $CREATE_PROCESS_DATA_BLOCK which is called
 43489                                  ;       at DOSINIT time with SS NOT DOSGROUP
 43490                                  ;
 43491                                  ;----------------------------------------------------------------------------
 43492                                  
 43493                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43494                                  	; 11/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43495                                  
 43496                                  SFFromHandle:
 43497 00007700 E8E0FF                  	CALL	pJFNFromHandle		; get jfn pointer
 43498                                  	;retc				; return if error
 43499 00007703 72FA                    	jc	short pJFNFromHandle_error
 43500 00007705 26803DFF                	CMP     BYTE [ES:DI],-1		; unused handle
 43501                                  	;JNZ	short GetSF		; nope, suck out SF
 43502                                  	;;mov	al,6
 43503                                  	;MOV	AL,error_invalid_handle ; appropriate error
 43504                                  	;jmp	short ReturnCarry	; signal it
 43505                                  	; 17/12/2022
 43506                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43507 00007709 74E9                    	jz	short ReturnCarry_inv_hndl ; Retro DOS v3.0 modification
 43508                                  	;JNZ	short GetSF		; nope, suck out SF
 43509                                  	;;mov	al,6
 43510                                  	;MOV	AL,error_invalid_handle ; appropriate error
 43511                                  	;jmp	short ReturnCarry	; signal it
 43512                                  GetSF:
 43513 0000770B 53                      	push	bx			; save handle
 43514 0000770C 268A1D                  	MOV     BL,[ES:DI]		; get SFN
 43515 0000770F 30FF                    	XOR     BH,BH                   ; ignore upper half
 43516 00007711 E80200                  	CALL    SFFromSFN               ; get real sf spot
 43517 00007714 5B                      	pop	bx			; restore
 43518 00007715 C3                      	retn                        	; say goodbye
 43519                                  
 43520                                  ;BREAK <SFFromSFN - index into SF table for SFN>
 43521                                  
 43522                                  ;**	SFFromSFN - Get an SF Table entry from an SFN
 43523                                  ;----------------------------------------------------------------------------
 43524                                  ;	SFFromSfn uses an SFN to index an entry into the SF table. This
 43525                                  ;	is more than just a simple index instruction because the SF table
 43526                                  ;	can be made up of multiple pieces chained together. We follow the
 43527                                  ;	chain to the right piece and then do the index operation.
 43528                                  ;
 43529                                  ;   NOTE:
 43530                                  ;	This routine is called from SFFromHandle which is called
 43531                                  ;       at DOSINIT time with SS NOT DOSGROUP
 43532                                  ;
 43533                                  ;	ENTRY	BX has SF index
 43534                                  ;	EXIT	'C' clear if OK
 43535                                  ;		  ES:DI points to SF entry
 43536                                  ;		'C' set if index too large
 43537                                  ;	USES	BX, DI, ES
 43538                                  ;----------------------------------------------------------------------------
 43539                                  
 43540                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43541                                  	; 11/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43542                                  
 43543                                  SFFromSFN:
 43544                                  	; 05/05/2019 - Retro DOS v4.0
 43545                                  	;getdseg <es>			; es -> dosdata
 43546 00007716 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 43547                                  
 43548                                  	;LES	DI,[CS:SFT_ADDR]	; (es:di) = start of SFT table
 43549 0000771B 26C43E[2A00]            	les	di,[es:SFT_ADDR]
 43550                                  sfsfn5:	
 43551                                  	;cmp	bx,[es:di+4]
 43552 00007720 263B5D04                	CMP	BX,[ES:DI+SFT.SFCount]	; is handle in this table?
 43553 00007724 720E                    	JB	short sfsfn7		; yes, go grab it
 43554                                  	;sub	bx,[es:di+4]
 43555 00007726 262B5D04                	SUB     BX,[ES:DI+SFT.SFCount]
 43556 0000772A 26C43D                  	les	di,[es:di] ; 14/08/2018
 43557                                  	;LES	DI,[ES:DI+SFT.SFLink]	; get next table segment
 43558 0000772D 83FFFF                  	CMP     DI,-1                   ; end of tables?
 43559 00007730 75EE                    	JNZ	short sfsfn5		; no, try again
 43560 00007732 F9                      	STC
 43561 00007733 C3                      	retn				; return with error, not found
 43562                                  sfsfn7:
 43563 00007734 50                      	push	ax
 43564                                  	;;mov	ax,53 ; MSDOS 3.3
 43565                                  	;mov	ax,59 ; MSDOS 5.0 to PCDOS 7.1 (to Win ME) ; 11/03/2024
 43566                                  	;MOV	AX,SF_ENTRY.size	; put it in a nice place
 43567                                  	
 43568                                  	; 17/12/2022
 43569 00007735 B03B                    	mov	al,SF_ENTRY.size ; 28/05/2019
 43570                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43571                                  	;mov	ax,SF_ENTRY.size ; 59
 43572                                  	
 43573 00007737 F6E3                    	MUL	BL			; (ax) = offset into this SF block
 43574 00007739 01C7                    	ADD	DI,AX			; add base of SF block
 43575 0000773B 58                      	pop	ax
 43576                                  	;add	di,6
 43577 0000773C 83C706                  	ADD	DI,SFT.SFTable		; offset into structure, 'C' cleared
 43578 0000773F C3                      	retn				; return with 'C' clear
 43579                                  
 43580                                  ;	BREAK <JFNFree - return a jfn pointer if one is free>
 43581                                  
 43582                                  ;**	JFNFree - Find a Free JFN Slot
 43583                                  ;----------------------------------------------------------------------------
 43584                                  ;	JFNFree scansthrough the JFN table and returnsa pointer to a free slot
 43585                                  ;
 43586                                  ;	ENTRY	(ss) = DOSDATA
 43587                                  ;	EXIT	'C' clear if OK
 43588                                  ;		  (bx) = new handle
 43589                                  ;		  (es:di) = pointer to JFN slot
 43590                                  ;		'C' set if error
 43591                                  ;		  (al) = error code
 43592                                  ;	USES	bx, di, es, flags
 43593                                  ;----------------------------------------------------------------------------
 43594                                  
 43595                                  JFNFree:
 43596 00007740 31DB                    	XOR	BX,BX			; (bx) = initial JFN to try
 43597                                  jfnf1:	
 43598 00007742 E89EFF                  	CALL	pJFNFromHandle		; get the appropriate handle
 43599 00007745 7209                    	JC	short jfnf5		; no more handles
 43600 00007747 26803DFF                	CMP     BYTE [ES:DI],-1		; free?
 43601 0000774B 7405                    	je	short jfnfx		; yes, carry is clear
 43602 0000774D 43                      	INC     BX                      ; no, next handle
 43603 0000774E EBF2                    	JMP	short jfnf1		; and try again
 43604                                  
 43605                                  	; Error. 'C' set
 43606                                  jfnf5:	
 43607                                  	;mov	al,4
 43608 00007750 B004                    	MOV	AL,error_too_many_open_files
 43609                                  jfnfx:	
 43610 00007752 C3                      	retn				; bye
 43611                                  
 43612                                  ;	BREAK <SFNFree - Allocate a free SFN>
 43613                                  
 43614                                  ;**	SFNFree - Allocate a Free SFN/SFT
 43615                                  ;----------------------------------------------------------------------------
 43616                                  ;	SFNFree scans through the sf table looking for a free entry
 43617                                  ;	If it finds one it partially allocates it by setting SFT_REF_COUNT = -1
 43618                                  ;
 43619                                  ;	The problem is that we want to mark the SFT busy so that other threads
 43620                                  ;	can't allocate the SFT before we're finished marking it up.  However,
 43621                                  ;	we can't just mark it busy because we may get blown out of our open
 43622                                  ;	by INT24 and leave the thing orphaned.	To solve this we mark it
 43623                                  ;	"allocation in progress" by setting SFT_REF_COUNT = -1.  If we see
 43624                                  ;	an SFT with this value we look to see if it belongs to this user
 43625                                  ;	and process.  If it does belong to us then it must be an orphan
 43626                                  ;	and we reclaim it.
 43627                                  ;
 43628                                  ;	BUGBUG - improve the performance. I guess it's smaller to call SFFromSFN
 43629                                  ;		over and over, but we could at least set a high water mark...
 43630                                  ;		cause an N^2 loop calling slow SFFromSFN is real slow, too slow
 43631                                  ;		even though this is not a frequently called routine - jgl
 43632                                  ;
 43633                                  ;	ENTRY	(ss) = DOSDATA
 43634                                  ;	EXIT	'C' clear if no error
 43635                                  ;		  (bx) = SFN
 43636                                  ;		  (es:di) = pointer to SFT
 43637                                  ;		  es:[di].SFT_REF_COUNT = -1
 43638                                  ;		'C' set if error
 43639                                  ;		  (al) = error code
 43640                                  ;	USES	bx, di, es, Flags
 43641                                  ;----------------------------------------------------------------------------
 43642                                  
 43643                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43644                                  	; DOSCODE:A682h (MSDOS 5.0 MSDOS.SYS)
 43645                                  
 43646                                  	; 11/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43647                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B8DEh
 43648                                  
 43649                                  SFNFree:
 43650                                  	; 12/08/2018
 43651                                  	; 05/08/2018 - Retro DOS v3.0
 43652                                  	;
 43653                                  	; MSDOS 6.0
 43654 00007753 50                      	push	ax
 43655 00007754 31DB                    	xor	bx,bx			; (bx) = SFN to consider
 43656                                  sfnf5:	
 43657 00007756 53                      	push	bx
 43658 00007757 E8BCFF                  	call	SFFromSFN		; get the potential handle
 43659 0000775A 5B                      	pop	bx
 43660 0000775B 723A                    	jc	short sfnf95		; no more free SFNs
 43661 0000775D 26833D00                	cmp	word [ES:DI],0
 43662                                  	;cmp	word [ES:DI+SF_ENTRY.sf_Ref_Count],0 ; free?
 43663 00007761 741D                    	je	short sfnf20			; yep, got one
 43664                                  	
 43665                                  	;cmp	word [es:di],0FFFFh ; -1
 43666 00007763 26833DFF                	cmp	word [ES:DI],sf_busy
 43667                                  	;cmp	word [ES:DI+SF_ENTRY.sf_ref_count],sf_busy
 43668 00007767 7403                    	je	short sfnf10		; special busy mark
 43669                                  sfnf7:	
 43670 00007769 43                      	inc	bx			; try the next one
 43671 0000776A EBEA                    	jmp	short sfnf5
 43672                                  
 43673                                  ;	The SFT has the special "busy" mark; if it belongs to us then
 43674                                  ;	it was abandoned during a earlier call and we can use it.
 43675                                  ;
 43676                                  ;	(bx)	= SFN
 43677                                  ;	(es:di) = pointer to SFT
 43678                                  ;	(TOS)	= caller's (ax)
 43679                                  
 43680                                  sfnf10:	
 43681 0000776C 36A1[3E03]              	mov	ax,[SS:USER_ID]
 43682                                  	;cmp	[es:di+2Fh],ax
 43683 00007770 2639452F                	cmp	[ES:DI+SF_ENTRY.sf_UID],ax
 43684 00007774 75F3                    	jnz	short sfnf7		; not ours
 43685 00007776 36A1[3C03]              	mov	ax,[SS:PROC_ID]
 43686                                  	;cmp	[es:di+31h],ax
 43687 0000777A 26394531                	cmp	[ES:DI+SF_ENTRY.sf_PID],ax
 43688 0000777E 75E9                    	jnz	short sfnf7		; can't use this one, try the next
 43689                                  
 43690                                  ;	We have an SFT to allocate
 43691                                  ;
 43692                                  ;	(bx)	= SFN
 43693                                  ;	(es:di) = pointer to SFT
 43694                                  ;	(TOS)	= caller's (ax)
 43695                                  
 43696                                  sfnf20:
 43697                                  	; cf = 0 ;; Retro DOS v3.0
 43698                                  
 43699                                  	;mov	word [es:di],0FFFFh
 43700 00007780 26C705FFFF              	mov	word [ES:DI],sf_busy
 43701                                  					; make sure that this is allocated
 43702                                  	;mov	word [ES:DI+SF_ENTRY.sf_ref_count],sf_busy
 43703                                  
 43704 00007785 36A1[3E03]              	mov	ax,[SS:USER_ID]
 43705                                  	;mov	[es:di+2Fh],ax
 43706 00007789 2689452F                	mov	[ES:DI+SF_ENTRY.sf_UID],ax
 43707 0000778D 36A1[3C03]              	mov	ax,[SS:PROC_ID]
 43708                                  	;mov	[es:di+31h],ax
 43709 00007791 26894531                	mov	[ES:DI+SF_ENTRY.sf_PID],ax
 43710                                  sfnf21: ;; Retro DOS v3.0
 43711                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43712                                  	;pop	ax
 43713                                  	;;clc
 43714                                  	;retn				; return with no error
 43715                                  	; 17/12/2022
 43716 00007795 58                      	pop	ax
 43717                                  	;clc
 43718 00007796 C3                      	retn
 43719                                  
 43720                                  ;**	Error - no more free SFNs
 43721                                  ;
 43722                                  ;	'C' set
 43723                                  ;	(TOS) = saved ax
 43724                                  
 43725                                  sfnf95: 
 43726 00007797 58                      	pop	ax
 43727                                  
 43728                                  ; 11/03/2024
 43729                                  %if 0
 43730                                  	;mov	al,4
 43731                                  	mov	al,error_too_many_open_files
 43732                                  	retn				; return with 'C' and error
 43733                                  %else
 43734                                  	; 11/03/2024 (PCDOS 7.1 IBMDOS.COM)
 43735                                  	;;;
 43736 00007798 EBB6                    	jmp	short jfnf5
 43737                                  	;;;
 43738                                  %endif
 43739                                  
 43740                                  ;============================================================================
 43741                                  ; HANDLE.ASM, MSDOS 6.0, 1991
 43742                                  ;============================================================================
 43743                                  ; 13/07/2018 - Retro DOS v3.0
 43744                                  ; 20/05/2019 - Retro DOS v4.0
 43745                                  ; 11/03/2024 - Retro DOS v5.0
 43746                                  
 43747                                  ; DOSCODE:A72Bh (MSDOS 6.21, MSDOS.SYS)
 43748                                  
 43749                                  ;	BREAK <$Close - return a handle to the system>
 43750                                  ;----------------------------------------------------------------------------
 43751                                  ;
 43752                                  ;**	$Close - Close a file Handle
 43753                                  ;
 43754                                  ;	BUGBUG - close gets called a LOT with invalid handles - sizzle that
 43755                                  ;		path
 43756                                  ;
 43757                                  ;	Assembler usage:
 43758                                  ;	    MOV     BX, handle
 43759                                  ;	    MOV     AH, Close
 43760                                  ;	    INT     int_command
 43761                                  ;
 43762                                  ;	ENTRY	(bx) = handle
 43763                                  ;	EXIT	<normal INT21 return convention>
 43764                                  ;	USES	all
 43765                                  ;
 43766                                  ;----------------------------------------------------------------------------
 43767                                  
 43768                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43769                                  ; DOSCODE:A6CBh (MSDOS 5.0 MSDOS.SYS)
 43770                                  
 43771                                  ; 11/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43772                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B926h
 43773                                  
 43774                                  ; (Windows ME IO.SYS - BIOSCODE:0A145h)
 43775                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0A72Bh)
 43776                                  
 43777                                  _$CLOSE:
 43778                                  ;	Grab the SFT pointer from the JFN.
 43779                                  
 43780 0000779A E8F702                  	call	CheckOwner		; get system file entry
 43781 0000779D 722B                    	jc	short CloseError	; error return
 43782 0000779F 16                      	push	ss
 43783 000077A0 1F                      	pop	ds			; For DOS_CLOSE
 43784 000077A1 893E[9E05]              	MOV	[THISSFT],DI		; save offset of pointer
 43785 000077A5 8C06[A005]              	MOV	[THISSFT+2],ES		; save segment value
 43786                                  
 43787                                  ; DS:SI point to JFN table entry.
 43788                                  ; ES:DI point to SFT
 43789                                  ;
 43790                                  ; We now examine the user's JFN entry; If the file was a 70-mode file (network
 43791                                  ; FCB, we examine the ref count on the SFT; if it was 1, we free the JFN.
 43792                                  ; If the file was not a net FCB, we free the JFN too.
 43793                                  
 43794                                  	;CMP	word [ES:DI+SF_ENTRY.sf_ref_count],1
 43795 000077A9 26833D01                	cmp	word [ES:DI],1		; will the SFT become free?
 43796 000077AD 740A                    	jz	short FreeJFN 		; yes, free JFN anyway.
 43797                                  	;mov	al,[ES:DI+2]
 43798 000077AF 268A4502                	MOV	AL,[ES:DI+SF_ENTRY.sf_mode]
 43799                                  	;and	al,0F0h
 43800 000077B3 24F0                    	AND	AL,SHARING_MASK
 43801                                  	;cmp	al,70h
 43802 000077B5 3C70                    	CMP	AL,SHARING_NET_FCB
 43803 000077B7 7407                    	JZ	short PostFree		; 70-mode and big ref count => free it
 43804                                  
 43805                                  ; The JFN must be freed. Get the pointer to it and replace the contents with
 43806                                  ; -1.
 43807                                  
 43808                                  FreeJFN:
 43809 000077B9 E827FF                  	call	pJFNFromHandle		; d = pJFN (handle);
 43810 000077BC 26C605FF                	MOV	BYTE [ES:DI],0FFh	; release the JFN
 43811                                  PostFree:
 43812                                  
 43813                                  ; ThisSFT is correctly set, we have DS = DOSDATA. Looks OK for a DOS_CLOSE!
 43814                                  
 43815 000077C0 E85EBF                  	call	DOS_CLOSE
 43816                                  
 43817                                  ; DOS_Close may return an error. If we see such an error, we report it but
 43818                                  ; the JFN stays closed because DOS_Close always frees the SFT!
 43819                                  
 43820 000077C3 7205                    	JC	short CloseError
 43821                                  	;mov	ah,3Eh
 43822 000077C5 B43E                    	MOV	AH,CLOSE		; MZ Bogus multiplan fix
 43823                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43824                                  CloseOk:
 43825 000077C7 E9A08E                  	jmp	SYS_RET_OK
 43826                                  CloseError:
 43827                                  CommitError:	; 11/03/2024
 43828 000077CA E9A78E                  	jmp	SYS_RET_ERR
 43829                                  
 43830                                  ;	BREAK <$Commit - commit the file>
 43831                                  ;----------------------------------------------------------------------------
 43832                                  ;
 43833                                  ;**	$Commit - Commit a File
 43834                                  ;
 43835                                  ;	$Commit "commits" a file to disk - all of it's buffers are
 43836                                  ;	flushed out. BUGBUG - I'm pretty sure that $Commit doesn't update
 43837                                  ;	the directory entry, etc., so this commit is pretty useless. check
 43838                                  ;	and fix this!! jgl
 43839                                  ;
 43840                                  ;	Assembler usage:
 43841                                  ;	    MOV     BX, handle
 43842                                  ;	    MOV     AH, Commit
 43843                                  ;	    INT     int_command
 43844                                  ;
 43845                                  ;	ENTRY	(bx) = handle
 43846                                  ;	EXIT	none
 43847                                  ;	USES	all
 43848                                  ;;----------------------------------------------------------------------------
 43849                                  
 43850                                  _$COMMIT:
 43851                                  ;	Grab the SFT pointer from the JFN.
 43852                                  
 43853 000077CD E8C402                  	call	CheckOwner		; get system file entry
 43854                                  	;JC	short CommitError	; error return
 43855                                  	; 11/03/2024
 43856 000077D0 72F8                    	jc	short CommitError
 43857                                  
 43858 000077D2 16                      	push	ss
 43859 000077D3 1F                      	pop	ds			; For DOS_COMMIT
 43860 000077D4 893E[9E05]              	MOV	[THISSFT],DI		; save offset of pointer
 43861 000077D8 8C06[A005]              	MOV	[THISSFT+2],ES		; save segment value
 43862                                  
 43863                                  ;	ThisSFT is correctly set, we have DS = DOSDATA. Looks OK for a DOS_COMMIT
 43864                                  ;
 43865                                  ;	ES:DI point to SFT
 43866                                  
 43867 000077DC E8F5C0                  	call	DOS_COMMIT
 43868 000077DF 72E9                    	JC	short CommitError
 43869                                  	; 07/12/2022
 43870                                  	;jc	short CloseError
 43871                                  	;mov	ah,68h
 43872 000077E1 B468                    	MOV	AH,COMMIT
 43873                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43874                                  	;jmp	SYS_RET_OK
 43875                                  CommitOk:
 43876 000077E3 EBE2                    	jmp	short CloseOk
 43877                                  
 43878                                  ; 11/03/2024
 43879                                  ;CommitError:
 43880                                  ;	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43881                                  ;	;jmp	SYS_RET_ERR
 43882                                  ;	jmp	short CloseError
 43883                                  
 43884                                  ;	BREAK <$ExtHandle - extend handle count>
 43885                                  
 43886                                  ;**	$ExtHandle - Extend Handle Count
 43887                                  ;----------------------------------------------------------------------------
 43888                                  ;	Assembler usage:
 43889                                  ;	    MOV     BX, Number of Opens Allowed (MAX=65534;66535 is
 43890                                  ;	    MOV     AX, 6700H			 reserved to mark SFT
 43891                                  ;	    INT     int_command 		 busy )
 43892                                  ;
 43893                                  ;	ENTRY	(bx) = new number of handles
 43894                                  ;	EXIT	'C' clear if OK
 43895                                  ;		'C' set iff err
 43896                                  ;		  (ax) = error code
 43897                                  ;			 AX = error_not_enough_memory
 43898                                  ;			      error_too_many_open_files
 43899                                  ;	USES	all
 43900                                  ;----------------------------------------------------------------------------
 43901                                  
 43902                                  	; 11/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43903                                  
 43904                                  _$ExtHandle:
 43905 000077E5 31ED                    	XOR	BP,BP			; 0: enlarge  1: shrink  2:psp
 43906                                  	;cmp	bx,20
 43907 000077E7 83FB14                  	CMP	BX,FILPERPROC
 43908 000077EA 7303                    	JAE	short exth2		; Don't set less than FilPerProc no
 43909 000077EC BB1400                  	MOV	BX,FILPERPROC
 43910                                  exth2:	
 43911 000077EF 368E06[3003]            	MOV	ES,[ss:CurrentPDB]	; get user process data block;smr;SS Override
 43912                                  	;mov	cx,[ES:32h]
 43913 000077F4 268B0E3200              	MOV	CX,[ES:PDB.JFN_Length]	; get number of handle allowed
 43914 000077F9 39CB                    	CMP	BX,CX			; the requested == current
 43915                                  	;JE	short ok_done 		; yes and exit
 43916                                  	; 11/03/2024
 43917 000077FB 74CA                    	je	short CloseOk
 43918 000077FD 771E                    	JA	short larger		; go allocate new table
 43919                                  
 43920                                  ;	We're going to shrink the # of handles available
 43921                                  
 43922                                  	;MOV	BP,1			; shrink
 43923                                  	; 11/03/2024
 43924 000077FF 45                      	inc	bp
 43925                                  
 43926                                  	;mov	ds,[ES:36h]
 43927 00007800 268E1E3600              	MOV	DS,[ES:PDB.JFN_Pointer+2] ;
 43928 00007805 89DE                    	MOV	SI,BX			;
 43929 00007807 29D9                    	SUB	CX,BX			; get difference
 43930                                  
 43931                                  ;	BUGBUG - code a SCASB here, should be a bit smaller
 43932                                  chck_handles:
 43933 00007809 803CFF                  	CMP	BYTE [SI],-1		; scan through handles to ensure close
 43934 0000780C 753A                    	JNZ	short too_many_files	; status
 43935 0000780E 46                      	INC	SI
 43936 0000780F E2F8                    	LOOP	chck_handles
 43937                                  
 43938 00007811 83FB14                  	CMP	BX,FILPERPROC		; = 20
 43939 00007814 7707                    	JA	short larger		; no
 43940                                  
 43941                                  	;MOV	BP,2			; psp
 43942                                  	; 11/03/2024
 43943 00007816 45                      	inc	bp	
 43944                                  	;mov	di,24
 43945 00007817 BF1800                  	MOV	DI,PDB.JFN_TABLE	; es:di -> jfn table in psp
 43946 0000781A 53                      	PUSH	BX
 43947 0000781B EB1C                    	JMP	short movhandl
 43948                                  
 43949                                  larger:
 43950                                  	;CMP	BX,-1			; 65535 is not allowed
 43951                                  	;JZ	short invalid_func	; 10/08/2018
 43952                                  	; 11/03/2024 (PCDOS 7.1 IBMDOS.COM)
 43953                                  	;;;
 43954 0000781D 43                      	inc	bx
 43955 0000781E 747E                    	jz	short invalid_func
 43956 00007820 4B                      	dec	bx
 43957                                  	;;;
 43958 00007821 F8                      	CLC
 43959 00007822 53                      	PUSH	BX			; save requested number
 43960 00007823 83C30F                  	ADD	BX,0FH			; adjust to paragraph boundary
 43961 00007826 B104                    	MOV	CL,4
 43962                                  	;ror	bx,cl			; MSDOS 3.3
 43963 00007828 D3DB                    	RCR	BX,CL			; DOS 4.00 fix		;AC000;
 43964 0000782A 81E3FF1F                	AND	BX,1FFFH		; clear most 3 bits
 43965                                  
 43966 0000782E 55                      	PUSH	BP
 43967 0000782F E806FB                  	call	_$ALLOC			; allocate memory
 43968 00007832 5D                      	POP	BP
 43969 00007833 7264                    	JC	short no_memory		; not enough memory
 43970                                  
 43971 00007835 8EC0                    	MOV	ES,AX			; es:di points to new table memory
 43972 00007837 31FF                    	XOR	DI,DI
 43973                                  movhandl:
 43974 00007839 368E1E[3003]            	MOV	DS,[ss:CurrentPDB] 	; get user PDB address	;smr;SS Override
 43975                                  
 43976 0000783E F7C50300                	test	BP,3			; enlarge ?
 43977 00007842 7409                    	JZ	short enlarge 		; yes
 43978 00007844 59                      	POP	CX			; cx = the amount you shrink
 43979 00007845 51                      	PUSH	CX
 43980 00007846 EB09                    	JMP	short copy_hand
 43981                                  
 43982                                  ;	Done.  'C' clear
 43983                                  
 43984                                  ; 17/12/2022
 43985                                  ;ok_done:
 43986                                  ;	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43987                                  ;	;jmp	short CommitOk
 43988                                  ;	; 17/12/2022
 43989                                  ;	jmp	SYS_RET_OK
 43990                                  
 43991                                  too_many_files:
 43992                                  	;mov	al,4
 43993 00007848 B004                    	MOV	AL,error_too_many_open_files
 43994                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43995                                  	;jmp	SYS_RET_ERR
 43996                                  CommitErrorj:
 43997                                  	;jmp	short CommitError
 43998                                  	; 17/12/2022
 43999 0000784A E9278E                  	jmp	SYS_RET_ERR
 44000                                  
 44001                                  ; 11/03/2024
 44002                                  ; 17/12/2022
 44003                                  ;ok_done:
 44004                                  ;	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44005                                  ;	;jmp	short CommitOk
 44006                                  ;	; 17/12/2022
 44007                                  ;	jmp	SYS_RET_OK
 44008                                  
 44009                                  enlarge:
 44010                                  	;mov	cx,[32h]
 44011 0000784D 8B0E3200                	MOV	CX,[PDB.JFN_Length]	; get number of old handles
 44012                                  copy_hand:
 44013 00007851 89CA                    	MOV	DX,CX
 44014                                  	;lds	si,[34h]
 44015 00007853 C5363400                	LDS	SI,[PDB.JFN_Pointer]	; get old table pointer
 44016 00007857 F3A4                    	REP	MOVSB			; copy information to new table
 44017 00007859 59                      	POP	CX			; get new number of handles
 44018 0000785A 51                      	PUSH	CX			; save it again
 44019 0000785B 29D1                    	SUB	CX,DX			; get the difference
 44020 0000785D B0FF                    	MOV	AL,-1			; set availability to handles
 44021 0000785F F3AA                    	REP	STOSB
 44022 00007861 368E1E[3003]            	MOV	DS,[ss:CurrentPDB] 	; get user process data block;smr;SS Override
 44023                                  	;cmp	word [34h],0
 44024 00007866 833E340000              	CMP	WORD [PDB.JFN_Pointer],0 ; check if original table pointer
 44025 0000786B 750D                    	JNZ	short update_info	; yes, go update PDB entries
 44026 0000786D 55                      	PUSH	BP
 44027 0000786E 1E                      	PUSH	DS			; save old table segment
 44028 0000786F 06                      	PUSH	ES			; save new table segment
 44029 00007870 8E063600                	MOV	ES,[PDB.JFN_Pointer+2]	; get old table segment
 44030 00007874 E836FC                  	call	_$DEALLOC		; deallocate old table memory
 44031 00007877 07                      	POP	ES			; restore new table segment
 44032 00007878 1F                      	POP	DS			; restore old table segment
 44033 00007879 5D                      	POP	BP
 44034                                  
 44035                                  update_info:
 44036 0000787A F7C50200                	test	BP,2			; psp?
 44037 0000787E 7408                    	JZ	short non_psp 		; no
 44038                                  	;mov	word [34h],18h ; 24
 44039 00007880 C70634001800            	MOV	WORD [PDB.JFN_Pointer],PDB.JFN_TABLE ; restore
 44040 00007886 EB06                    	JMP	short final
 44041                                  non_psp:
 44042                                  	;mov	word [34h],0
 44043 00007888 C70634000000            	MOV	WORD [PDB.JFN_Pointer],0 ; new table pointer offset always 0
 44044                                  final:
 44045                                  	;mov	[36h],es	
 44046 0000788E 8C063600                	MOV	[PDB.JFN_Pointer+2],ES	; update table pointer segment
 44047                                  	;pop	word [32h]
 44048 00007892 8F063200                	POP	word [PDB.JFN_Length]	; restore new number of handles
 44049                                  	; 11/03/2024
 44050                                  ok_done:
 44051                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44052 00007896 E9D18D                  	jmp	SYS_RET_OK
 44053                                  ;ok_done_j:
 44054                                  ;	jmp	short ok_done
 44055                                  
 44056                                  no_memory:
 44057 00007899 5B                      	POP	BX			; clean stack
 44058                                  	;mov	al,8
 44059 0000789A B008                    	MOV	AL,error_not_enough_memory
 44060                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44061                                  	;jmp	SYS_RET_ERR
 44062                                  CommitErrorj2:
 44063 0000789C EBAC                    	jmp	short CommitErrorj
 44064                                  
 44065                                  invalid_func:
 44066                                  	;mov	al,1
 44067 0000789E B001                    	MOV	AL,error_invalid_function
 44068                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44069                                  	;jmp	SYS_RET_ERR
 44070                                  CommitErrorj3:
 44071                                  	;jmp	short CommitErrorj2
 44072                                  	; 17/12/2022
 44073 000078A0 EBA8                    	jmp	short CommitErrorj
 44074                                  
 44075                                  ; 20/05/2019 - Retro DOS v4.0
 44076                                  ; DOSCODE:A83Ah (MSDOS 6.21, MSDOS.SYS)
 44077                                  
 44078                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 44079                                  ; DOSCODE:A7DAh (MSDOS 5.0 MSDOS.SYS)
 44080                                  
 44081                                  ;	BREAK <$READ - Read from a file handle>
 44082                                  ;----------------------------------------------------------------------------
 44083                                  ;
 44084                                  ;**	$Read - Read from a File Handle
 44085                                  ;
 44086                                  ;   Assembler usage:
 44087                                  ;
 44088                                  ;	LDS	DX, buf
 44089                                  ;	MOV	CX, count
 44090                                  ;	MOV	BX, handle
 44091                                  ;	MOV	AH, Read
 44092                                  ;	INT	int_command
 44093                                  ;	  AX has number of bytes read
 44094                                  ;
 44095                                  ;	ENTRY	(bx) = file handle
 44096                                  ;		(cx) = byte count
 44097                                  ;		(ds:dx) = buffer address
 44098                                  ;	EXIT	Through system call return so that to user:
 44099                                  ;		  'C' clear if OK
 44100                                  ;		    (ax) = bytes read
 44101                                  ;		  'C' set if error
 44102                                  ;		    (ax) = error code
 44103                                  ;
 44104                                  ;----------------------------------------------------------------------------
 44105                                  
 44106                                  	; 12/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 44107                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BA2Eh
 44108                                  
 44109                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0A83Ah)
 44110                                  	; (Windows ME IO.SYS - BIOSCODE:0A256h)
 44111                                  
 44112                                  _$READ:
 44113 000078A2 BE[7B3B]                	MOV	SI,DOS_READ
 44114                                  ReadDo:
 44115 000078A5 E83BFE                  	call	pJFNFromHandle
 44116 000078A8 7208                    	JC	short ReadError
 44117                                  
 44118 000078AA 268A05                  	MOV	AL,[ES:DI]
 44119 000078AD E8E401                  	call	CheckOwner		; get the handle
 44120 000078B0 7303                    	JNC	short ReadSetup		; no errors do the operation
 44121                                  
 44122                                  ;	Have an error. 'C' set
 44123                                  
 44124                                  ReadError:
 44125                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44126                                  	;;jmp	SYS_RET_ERR		; go to error traps
 44127                                  	;jmp	short CommitErrorj3
 44128                                  	; 17/12/2022
 44129 000078B2 E9BF8D                  	jmp	SYS_RET_ERR
 44130                                  
 44131                                  ReadSetup:
 44132 000078B5 36893E[9E05]            	MOV	[ss:THISSFT],DI		; save offset of pointer;smr;SS Override
 44133 000078BA 368C06[A005]            	MOV	[ss:THISSFT+2],ES	; save segment value	;smr;SS Override
 44134                                  	; 20/05/2019 - Retro DOS v4.0
 44135                                  	; MSDOS 6.0 
 44136                                  ;; Extended Open
 44137                                  	;test	byte [es:di+3],20h
 44138 000078BF 26F6450320              	test	byte [ES:DI+SF_ENTRY.sf_mode+1],(INT_24_ERROR>>8)
 44139                                  						 ;AN000;;EO. need i24
 44140 000078C4 7406                    	JZ	short needi24 		     	 ;AN000;;EO. yes
 44141 000078C6 36800E[F605]02          	OR	byte [ss:EXTOPEN_ON],EXT_OPEN_I24_OFF ; 2
 44142                                  					;AN000;;EO. set it off;smr;SS Override
 44143                                  needi24:				;AN000;
 44144                                  
 44145                                  ; 12/03/2024
 44146                                  %if 0
 44147                                  
 44148                                  ;; Extended Open
 44149                                  	push	word [SS:DMAADD]
 44150                                  	push	word [SS:DMAADD+2]	;smr;SS Override
 44151                                  
 44152                                  ;;;;;	BAD SPOT FOR 286!!! SEGMENT ARITHMETIC!!!
 44153                                  
 44154                                  	; 26/07/2019
 44155                                  
 44156                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44157                                  	;
 44158                                  	; (It is not necessary to call 'Align_Buffer' proc here/below because
 44159                                  	; there is not another caller; it is better to put the code in this proc
 44160                                   	; here instead of calling it as a subroutine; but I have modified code
 44161                                  	; here for MSDOS 5.0 MSDOS.SYS address compatibility)
 44162                                  
 44163                                  	; MSDOS 6.0
 44164                                  	CALL	Align_Buffer		;AN000;MS. align user's buffer
 44165                                  	
 44166                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44167                                  	; MSDOS 3.3
 44168                                  	;MOV	BX,DX			; copy offset
 44169                                  	;push	cx			; don't stomp on count
 44170                                  	;MOV	CL,4			; bits to shift bytes->para
 44171                                  	;SHR	BX,CL			; get number of paragraphs
 44172                                  	;pop	cx			; get count back
 44173                                  	;MOV	AX,DS			; get original segment
 44174                                  	;ADD	AX,BX			; get new segment
 44175                                  	;MOV	DS,AX			; in seg register
 44176                                  	;AND	DX,0Fh			; normalize offset
 44177                                  	;MOV	[ss:DMAADD],DX		; use user DX as offset	;smr;SS Override
 44178                                  	;MOV	[ss:DMAADD+2],DS 	; use user DS as segment for DMA
 44179                                  						;smr;SS Override
 44180                                  %else
 44181                                  	; 12/03/2024 (PCDOS 7.1 IBMDOS.COM)
 44182                                  	;;;
 44183 000078CC 8CD8                    	mov	ax,ds			; original segment
 44184 000078CE 36C51E[2C03]            	lds	bx,[ss:DMAADD]
 44185 000078D3 53                      	push	bx
 44186 000078D4 1E                      	push	ds
 44187 000078D5 89D3                    	mov	bx,dx
 44188 000078D7 D1EB                    	shr	bx,1
 44189 000078D9 D1EB                    	shr 	bx,1
 44190 000078DB D1EB                    	shr	bx,1
 44191 000078DD D1EB                    	shr	bx,1
 44192 000078DF 01D8                    	add	ax,bx			; new segment
 44193 000078E1 83E20F                  	and	dx,0Fh			; normalize offset
 44194                                  	;mov	[ss:DMAADD],dx		; use user DX as offset
 44195                                  	; 23/03/2024
 44196 000078E4 36A3[2E03]              	mov	[ss:DMAADD+2],ax 	; use user DS as segment for DMA
 44197                                  	;;;
 44198                                  
 44199                                  %endif
 44200                                  
 44201                                  ;;;;;	END BAD SPOT FOR 286!!! SEGMENT ARITHMETIC!!!
 44202                                  	
 44203 000078E8 16                      	push	ss			; go for DOS addressability
 44204 000078E9 1F                      	pop	ds
 44205                                  
 44206                                  	; 12/03/2024 - Retro DOS v5.0
 44207                                  	;;;
 44208 000078EA 8916[2C03]              	mov	[DMAADD],dx	
 44209                                  	;;;
 44210                                  
 44211 000078EE FFD6                    	CALL	SI ; DOS_READ		; indirect call to operation
 44212                                  
 44213 000078F0 8F06[2E03]              	pop	word [DMAADD+2]
 44214 000078F4 8F06[2C03]              	pop	word [DMAADD]
 44215                                  	;JNC	short READ_OK		;AN002;
 44216                                  	;JMP	short ReadError		;AN002; if error, say bye bye
 44217                                  	; 17/12/2022
 44218 000078F8 72B8                    	jc	short ReadError
 44219                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44220                                  	;jnc	short READ_OK		;AN002;
 44221                                  	;jmp	short ReadError
 44222                                  
 44223                                  READ_OK:
 44224 000078FA 89C8                    	MOV	AX,CX			; get correct return in correct reg
 44225                                  Read_Okj:
 44226                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44227                                  	;;jmp	SYS_RET_OK		; successful return
 44228                                  	;jmp	short ok_done_j
 44229                                  	; 17/12/2022
 44230 000078FC E96B8D                  	jmp	SYS_RET_OK
 44231                                  
 44232                                  ; 13/07/2018 - Retro DOS v3.0
 44233                                  
 44234                                  ;----------------------------------------------------------------------------
 44235                                  
 44236                                  ;   Input: DS:DX points to user's buffer addr
 44237                                  ;   Function: rearrange segment and offset for READ/WRITE buffer
 44238                                  ;   Output: [DMAADD] set
 44239                                  
 44240                                  
 44241                                  ; 12/03/2024
 44242                                  %if 0
 44243                                  
 44244                                  ; 20/05/2019 - Retro DOS v4.0
 44245                                  ; 26/07/2019
 44246                                  ;	; MSDOS 6.0
 44247                                  ;Align_Buffer:
 44248                                  ;	MOV	BX,DX			; copy offset
 44249                                  ;	push	cx			; don't stomp on count
 44250                                  ;	MOV	CL,4			; bits to shift bytes->para
 44251                                  ;	SHR	BX,CL			; get number of paragraphs
 44252                                  ;	pop	cx			; get count back
 44253                                  ;	MOV	AX,DS			; get original segment
 44254                                  ;	ADD	AX,BX			; get new segment
 44255                                  ;	MOV	DS,AX			; in seg register
 44256                                  ;	AND	DX,0Fh			; normalize offset
 44257                                  ;	MOV	[ss:DMAADD],DX		; use user DX as offset	;smr;SS Override
 44258                                  ;	MOV	[ss:DMAADD+2],DS 	; use user DS as segment for DMA
 44259                                  ;						;smr;SS Override
 44260                                  ;	retn
 44261                                  
 44262                                  ; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44263                                  Align_Buffer:
 44264                                  	MOV	BX,DX			; copy offset
 44265                                  	push	cx			; don't stomp on count
 44266                                  	MOV	CL,4			; bits to shift bytes->para
 44267                                  	SHR	BX,CL			; get number of paragraphs
 44268                                  	pop	cx			; get count back
 44269                                  	MOV	AX,DS			; get original segment
 44270                                  	ADD	AX,BX			; get new segment
 44271                                  	MOV	DS,AX			; in seg register
 44272                                  	AND	DX,0Fh			; normalize offset
 44273                                  	MOV	[ss:DMAADD],DX		; use user DX as offset	;smr;SS Override
 44274                                  	MOV	[ss:DMAADD+2],DS 	; use user DS as segment for DMA
 44275                                  						;smr;SS Override
 44276                                  	retn
 44277                                  
 44278                                  %endif
 44279                                  
 44280                                  ; 20/05/2019 - Retro DOS v4.0
 44281                                  ; DOSCODE:A8A0h (MSDOS 6.21, MSDOS.SYS)
 44282                                  
 44283                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 44284                                  ; DOSCODE:A840h (MSDOS 5.0 MSDOS.SYS)
 44285                                  
 44286                                  ; 12/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 44287                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BA8Ch)
 44288                                  
 44289                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0A8A0h)
 44290                                  ; (Windows ME IO.SYS - BIOSCODE:0A2B9h)
 44291                                  
 44292                                  ;BREAK <$WRITE - write to a file handle>
 44293                                  ;----------------------------------------------------------------------------
 44294                                  ;
 44295                                  ;   Assembler usage:
 44296                                  ;	    LDS     DX, buf
 44297                                  ;	    MOV     CX, count
 44298                                  ;	    MOV     BX, handle
 44299                                  ;	    MOV     AH, Write
 44300                                  ;	    INT     int_command
 44301                                  ;	  AX has number of bytes written
 44302                                  ;   Errors:
 44303                                  ;	    AX = write_invalid_handle
 44304                                  ;	       = write_access_denied
 44305                                  ;
 44306                                  ;   Returns in register AX
 44307                                  ;
 44308                                  ;----------------------------------------------------------------------------
 44309                                  
 44310                                  _$WRITE:
 44311 000078FF BE[7C3D]                	MOV	SI,DOS_WRITE
 44312 00007902 EBA1                    	JMP	short ReadDo
 44313                                  
 44314                                  ;BREAK <$LSEEK - move r/w pointer>
 44315                                  ;----------------------------------------------------------------------------
 44316                                  ;
 44317                                  ;   Assembler usage:
 44318                                  ;	    MOV     DX, offsetlow
 44319                                  ;	    MOV     CX, offsethigh
 44320                                  ;	    MOV     BX, handle
 44321                                  ;	    MOV     AL, method
 44322                                  ;	    MOV     AH, LSeek
 44323                                  ;	    INT     int_command
 44324                                  ;	  DX:AX has the new location of the pointer
 44325                                  ;   Error returns:
 44326                                  ;	    AX = error_invalid_handle
 44327                                  ;	       = error_invalid_function
 44328                                  ;   Returns in registers DX:AX
 44329                                  ;
 44330                                  ;----------------------------------------------------------------------------
 44331                                  
 44332                                  ; 21/05/2019 - Retro DOS v4.0
 44333                                  ; DOSCODE:A8A5h (MSDOS 6.21, MSDOS.SYS)
 44334                                  
 44335                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 44336                                  ; DOSCODE:A845h (MSDOS 5.0 MSDOS.SYS)
 44337                                  
 44338                                  	; 12/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 44339                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BA91h
 44340                                  
 44341                                  _$LSEEK:
 44342 00007904 E88D01                  	call	CheckOwner		; get system file entry
 44343                                  
 44344                                  	; 17/12/2022
 44345                                  ;LSeekError:
 44346                                  	;JNC	short CHKOWN_OK		;AN002;
 44347                                  	;JMP	short ReadError		;AN002; error return
 44348                                  	; 17/12/2022
 44349                                  	; 02/06/2019
 44350 00007907 72A9                    	jc	short ReadError
 44351                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44352                                  	;JNC	short CHKOWN_OK		;AN002;
 44353                                  	;JMP	short ReadError		;AN002; error return
 44354                                  
 44355                                  CHKOWN_OK:
 44356                                  					;AN002;
 44357 00007909 3C02                    	CMP	AL,2			; is the seek value correct?
 44358 0000790B 7607                    	JBE	short LSeekDisp		; yes, go dispatch
 44359                                  
 44360                                  ; 12/03/2024
 44361                                  %if 0
 44362                                  	;mov	byte [ss:EXTERR_LOCUS],1 
 44363                                  	MOV	byte [ss:EXTERR_LOCUS],errLOC_Unk ; Extended Error Locus
 44364                                  					;smr;SS Override
 44365                                  %else
 44366                                  	; 12/03/2024 (PCDOS 7.1 IBMDOS.COM)
 44367                                  	;;;
 44368 0000790D E8C599                  	call	set_exerr_locus_unk	; Extended Error Locus
 44369                                  	;;;
 44370                                  %endif
 44371                                  	;mov	al,1
 44372 00007910 B001                    	mov	al,error_invalid_function ; invalid method
 44373                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44374                                  LSeekError2:
 44375 00007912 EB9E                    	jmp	short ReadError
 44376                                  
 44377                                  LSeekDisp:
 44378 00007914 3C01                    	CMP	AL,1			; best way to dispatch; check middle
 44379 00007916 720A                    	JB	short LSeekStore	; just store CX:DX
 44380 00007918 771B                    	JA	short LSeekEOF		; seek from end of file
 44381                                  	;add	dx,[es:di+21]
 44382 0000791A 26035515                	ADD	DX,[ES:DI+SF_ENTRY.sf_position]
 44383                                  	;adc	cx,[es:di+23]
 44384 0000791E 26134D17                	ADC	CX,[ES:DI+SF_ENTRY.sf_position+2]
 44385                                  LSeekStore:
 44386 00007922 89C8                    	MOV	AX,CX			; AX:DX
 44387 00007924 92                      	XCHG	AX,DX			; DX:AX is the correct value
 44388                                  LSeekSetpos:
 44389                                  	;mov	[es:di+21],ax
 44390 00007925 26894515                	MOV	[ES:DI+SF_ENTRY.sf_position],AX
 44391                                  	;mov	[es:di+23],dx
 44392 00007929 26895517                	MOV	[ES:DI+SF_ENTRY.sf_position+2],DX
 44393 0000792D E8478B                  	call	Get_User_Stack
 44394                                  	;mov	[si+6],dx
 44395 00007930 895406                  	MOV	[SI+user_env.user_DX],DX ; return DX:AX
 44396                                  	;jmp	SYS_RET_OK		; successful return
 44397                                  	; 25/06/2019
 44398                                  	;jmp	SYS_RET_OK_clc
 44399                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44400                                  	;jmp	SYS_RET_OK_clc
 44401                                  LSeekOk:
 44402 00007933 EBC7                    	jmp     short Read_Okj
 44403                                  
 44404                                  LSeekEOF:
 44405                                  	;;test	word [es:di+5],8000h
 44406                                  	;test	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 44407                                  	; 21/05/2019 - Retro DOS v4.0
 44408 00007935 26F6450680              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 44409 0000793A 750A                    	JNZ	short Check_LSeek_Mode	; Is Net
 44410                                  LOCAL_LSeek:
 44411                                  	;add	dx,[es:di+17]
 44412 0000793C 26035511                	ADD	DX,[ES:DI+SF_ENTRY.sf_size]
 44413                                  	;adc	cx,[es:di+19]
 44414 00007940 26134D13                	ADC	CX,[ES:DI+SF_ENTRY.sf_size+2]
 44415 00007944 EBDC                    	JMP	short LSeekStore	; go and set the position
 44416                                  
 44417                                  Check_LSeek_Mode:
 44418                                  	;;test	word [es:di+2],8000h
 44419                                  	;test	word [ES:DI+SF_ENTRY.sf_mode],sf_isFCB
 44420                                  	; 21/05/2019
 44421 00007946 26F6450380              	test	byte [ES:DI+SF_ENTRY.sf_mode+1],(sf_isFCB>>8)
 44422 0000794B 75EF                    	JNZ	short LOCAL_LSeek	; FCB treated like local file
 44423                                  	;mov	ax,[es:di+2]
 44424 0000794D 268B4502                	MOV	AX,[ES:DI+SF_ENTRY.sf_mode]
 44425                                  	;and	ax,0F0h
 44426 00007951 25F000                  	AND	AX,SHARING_MASK
 44427                                  	;cmp	ax,40h
 44428 00007954 83F840                  	CMP	AX,SHARING_DENY_NONE
 44429 00007957 7405                    	JZ	short NET_LSEEK		; LSEEK exported in this mode
 44430                                  	;cmp	ax,30h
 44431 00007959 83F830                  	CMP	AX,SHARING_DENY_READ
 44432 0000795C 75DE                    	JNZ	short LOCAL_LSeek	; Treated like local Lseek
 44433                                  NET_LSEEK:
 44434                                  ;	JMP	short LOCAL_LSeek
 44435                                  ; REMOVE ABOVE INSTRUCTION TO ENABLE DCR 142
 44436                                  	;CallInstall Net_Lseek,MultNET,33
 44437                                  	;JNC	short LSeekSetPos
 44438                                  
 44439 0000795E B82111                  	mov     ax,1121h
 44440 00007961 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - SEEK FROM END OF REMOTE FILE
 44441                                  			; CX:DX = offset (in bytes) from end
 44442                                  			; ES:DI -> SFT, SFT DPB field -> DPB of drive with file
 44443                                  			; SS = DOS CS
 44444                                  			; Return: CF set on error
 44445                                  			; CF clear if successful, DX:AX = new file position
 44446 00007963 73C0                    	jnb     short LSeekSetpos
 44447                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44448                                  	;jmp	SYS_RET_ERR
 44449                                  ;LSeekError3:
 44450                                  	; 17/12/2022
 44451                                  LSeekError:
 44452                                  	;jmp	short LSeekError2
 44453                                  DupErr: ; 17/12/2022
 44454 00007965 E90C8D                  	jmp	SYS_RET_ERR
 44455                                  
 44456                                  ; 21/05/2019 - Retro DOS v4.0
 44457                                  ; DOSCODE:A95Bh (MSDOS 6.21, MSDOS.SYS)
 44458                                  
 44459                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 44460                                  ; DOSCODE:A8FBh (MSDOS 5.0 MSDOS.SYS)
 44461                                  
 44462                                  ;BREAK <$DUP - duplicate a jfn>
 44463                                  ;----------------------------------------------------------------------------
 44464                                  ;
 44465                                  ;   Assembler usage:
 44466                                  ;	    MOV     BX, fh
 44467                                  ;	    MOV     AH, Dup
 44468                                  ;	    INT     int_command
 44469                                  ;	  AX has the returned handle
 44470                                  ;   Errors:
 44471                                  ;	    AX = dup_invalid_handle
 44472                                  ;	       = dup_too_many_open_files
 44473                                  ;
 44474                                  ;----------------------------------------------------------------------------
 44475                                  
 44476                                  	; 12/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 44477                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BBEBh
 44478                                  
 44479                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0A95Bh)
 44480                                  	; (Windows ME IO.SYS - BIOSCODE:0A3EFh)
 44481                                  
 44482                                  _$DUP:
 44483 00007968 89D8                    	MOV	AX,BX			; save away old handle in AX
 44484 0000796A E8D3FD                  	call	JFNFree 		; free handle? into ES:DI, new in BX
 44485                                  DupErrorCheck:
 44486 0000796D 72F6                    	JC	short DupErr		; nope, bye
 44487 0000796F 06                      	push	es
 44488 00007970 57                      	push	di			; save away SFT
 44489 00007971 5E                      	pop	si			; into convenient place DS:SI
 44490 00007972 1F                      	pop	ds
 44491 00007973 93                      	XCHG	AX,BX			; get back old handle
 44492 00007974 E81D01                  	call	CheckOwner		; get sft in ES:DI
 44493 00007977 72EC                    	JC	short DupErr		; errors go home
 44494 00007979 E843B7                  	call	DOS_Dup_Direct
 44495 0000797C E864FD                  	call	pJFNFromHandle		; get pointer
 44496 0000797F 268A1D                  	MOV	BL,[ES:DI]		; get SFT number
 44497 00007982 881C                    	MOV	[SI],BL			; stuff in new SFT
 44498                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44499                                  	;jmp	SYS_RET_OK		; and go home
 44500 00007984 EB5A                    	jmp	short ok_ret
 44501                                  
 44502                                  	; 17/12/2022
 44503                                  ;DupErr:
 44504                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44505                                  	;;jmp	SYS_RET_ERR
 44506                                  	;jmp	short ft_error
 44507                                  
 44508                                  ;BREAK <$DUP2 - force a dup on a particular jfn>
 44509                                  ;----------------------------------------------------------------------------
 44510                                  ;
 44511                                  ;   Assembler usage:
 44512                                  ;	    MOV     BX, fh
 44513                                  ;	    MOV     CX, newfh
 44514                                  ;	    MOV     AH, Dup2
 44515                                  ;	    INT     int_command
 44516                                  ;   Error returns:
 44517                                  ;	    AX = error_invalid_handle
 44518                                  ;
 44519                                  ;----------------------------------------------------------------------------
 44520                                  
 44521                                  _$DUP2:
 44522 00007986 53                      	push	bx
 44523 00007987 51                      	push	cx			; save source
 44524 00007988 89CB                    	MOV	BX,CX			; get one to close
 44525 0000798A E80DFE                  	call	_$CLOSE			; close destination handle
 44526 0000798D 5B                      	pop	bx
 44527 0000798E 58                      	pop	ax			; old in AX, new in BX
 44528 0000798F E851FD                  	call	pJFNFromHandle		; get pointer
 44529 00007992 EBD9                    	JMP	short DupErrorCheck	; check error and do dup
 44530                                  
 44531                                  ;BREAK <FileTimes - modify write times on a handle>
 44532                                  ;----------------------------------------------------------------------------
 44533                                  ;
 44534                                  ;   Assembler usage:
 44535                                  ;	    MOV AH, FileTimes (57H)
 44536                                  ;	    MOV AL, func
 44537                                  ;	    MOV BX, handle
 44538                                  ;	; if AL = 1 then then next two are mandatory
 44539                                  ;	    MOV CX, time
 44540                                  ;	    MOV DX, date
 44541                                  ;	    INT 21h
 44542                                  ;	; if AL = 0 then CX/DX has the last write time/date
 44543                                  ;	; for the handle.
 44544                                  ;
 44545                                  ;	AL=02		 get extended attributes
 44546                                  ;	   BX=handle
 44547                                  ;	   CX=size of buffer (0, return max size )
 44548                                  ;	   DS:SI query list (si=-1, selects all EA)
 44549                                  ;	   ES:DI buffer to hold EA list
 44550                                  ;
 44551                                  ;	AL=03		 get EA name list
 44552                                  ;	   BX=handle
 44553                                  ;	   CX=size of buffer (0, return max size )
 44554                                  ;	   ES:DI buffer to hold name list
 44555                                  ;
 44556                                  ;	AL=04		 set extended attributes
 44557                                  ;	   BX=handle
 44558                                  ;	   ES:DI buffer of EA list
 44559                                  ;
 44560                                  ;
 44561                                  ;   Error returns:
 44562                                  ;	    AX = error_invalid_function
 44563                                  ;	       = error_invalid_handle
 44564                                  ;
 44565                                  ;----------------------------------------------------------------------------
 44566                                  
 44567                                  ; 21/05/2019 - Retro DOS v4.0
 44568                                  ; DOSCODE:A90Dh (MSDOS 6.21, MSDOS.SYS)
 44569                                  
 44570                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 44571                                  ; DOSCODE:A8ADh (MSDOS 5.0 MSDOS.SYS)
 44572                                  
 44573                                  	; 12/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 44574                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BAF5h
 44575                                  
 44576                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0A90Dh)
 44577                                  	; (Windows ME IO.SYS - BIOSCODE:0A327h)
 44578                                  
 44579                                  _$FILE_TIMES:
 44580                                  
 44581                                  ; 12/03/2024
 44582                                  %if 0
 44583                                  	; 13/07/2018 - Retro DOS v3.0
 44584                                  
 44585                                  	; MSDOS 3.3
 44586                                  	;cmp	al,2			; correct subfunction ?
 44587                                  	;jb	short ft1
 44588                                  
 44589                                  	;;mov	byte [ss:EXTERR_LOCUS], 1
 44590                                  	;mov	byte [ss:EXTERR_LOCUS],errLOC_Unk ; Extended Error Locus
 44591                                  						;SS Overr
 44592                                  	;;mov	al,1
 44593                                  	;mov	al,error_invalid_function ; give bad return
 44594                                  	;jmp	SYS_RET_ERR
 44595                                  
 44596                                  	; MSDOS 6.0
 44597                                  	cmp	al,2			; correct subfunction ?
 44598                                  	jae	short inval_func
 44599                                  ;ft1:
 44600                                  	call	CheckOwner		; get sft
 44601                                  	; 17/12/2022
 44602                                  	jc	short LSeekError	; bad handle
 44603                                  
 44604                                  	or	al,al			; get time/date ?
 44605                                  	jnz	short ft_set_time
 44606                                  
 44607                                  ;------ here we get the time & date from the sft for the user
 44608                                  
 44609                                  	cli				; is this cli/sti reqd ? BUGBUG
 44610                                  	;mov	cx,[es:di+13]
 44611                                  	mov	cx,[es:di+SF_ENTRY.sf_time] ; get the time
 44612                                  	;mov	dx,[es:di+15]
 44613                                  	mov	dx,[es:di+SF_ENTRY.sf_date] ;  & date
 44614                                  	sti
 44615                                  	call	Get_User_Stack
 44616                                  	;mov	[si+4],cx
 44617                                  	mov	[si+user_env.user_CX],cx
 44618                                  	;mov	[si+6],dx
 44619                                  	mov	[si+user_env.user_DX],dx
 44620                                  	jmp	short ok_ret
 44621                                  
 44622                                  ;------ here we set the time in sft
 44623                                  
 44624                                  ft_set_time:
 44625                                  	call    ECritSFT
 44626                                  	;mov	[es:di+13],cx
 44627                                  	mov	[es:di+SF_ENTRY.sf_time],cx ; drop in new time
 44628                                  	;mov	[es:di+15],dx
 44629                                  	mov	[es:di+SF_ENTRY.sf_date],dx ;  and date	
 44630                                  
 44631                                  	xor	ax, ax
 44632                                  	call	far [ss:JShare+(14*4)] ; 14 = ShSU	; SS Override
 44633                                  
 44634                                  ;------ set the flags in SFT entry
 44635                                  	;and	word [es:di+5],0FFBFh
 44636                                  	; 18/12/2022
 44637                                  	;and	byte [es:di+5],0BFh
 44638                                  	and	byte [es:di+SF_ENTRY.sf_flags],~devid_file_clean
 44639                                  	;and	word [es:di+SF_ENTRY.sf_flags],~devid_file_clean 
 44640                                  							; mark file as dirty
 44641                                  	;or	word [es:di+5],4000h
 44642                                  	; 17/12/2022
 44643                                  	;or	byte [es:di+6],40h
 44644                                  	or	byte [es:di+SF_ENTRY.sf_flags+1],(sf_close_nodate>>8)
 44645                                  	;or	word [es:di+SF_ENTRY.sf_flags],sf_close_nodate
 44646                                  							; ask close not to
 44647                                  							;   bother about date
 44648                                  							;   and time
 44649                                  	call	LCritSFT
 44650                                  
 44651                                  ok_ret:
 44652                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44653                                  	; 17/12/2022
 44654                                  	jmp	SYS_RET_OK
 44655                                  	;jmp	short LSeekOk
 44656                                  
 44657                                  inval_func:
 44658                                  	;mov	byte [ss:EXTERR_LOCUS],1
 44659                                  	mov	byte [ss:EXTERR_LOCUS],errLOC_Unk ; Extended Error Locus
 44660                                  						;SS Overr
 44661                                  	;mov	al,1
 44662                                  	mov	al,error_invalid_function ; give bad return
 44663                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44664                                  ft_error:
 44665                                  	;;jmp	SYS_RET_ERR
 44666                                  	;jmp	short LSeekError3
 44667                                  	; 17/12/2022
 44668                                  	jmp	short LSeekError
 44669                                  
 44670                                  %else
 44671                                  	; 12/03/2024 - Retro DOS v5.0
 44672                                  	; PCDOS 7.1 IBMDOS.COM
 44673                                  	;;;			; ((Ref: Ralf Brown's Intterupt List))
 44674 00007994 3C07                    	cmp	al,7		; SET CREATION DATE AND TIME
 44675                                  			 	; 6 = GET CREATION DATE AND TIME
 44676                                  			 	; 5 = SET LAST ACCESS DATE AND TIME
 44677                                  	;jnb	short LSeekError1
 44678                                  	; 12/03/2024
 44679 00007996 737B                    	jnb	short inval_func
 44680 00007998 3C04                    	cmp	al,4		; GET LAST ACCESS DATE AND TIME
 44681 0000799A 7304                    	jnb	short ft1
 44682 0000799C 3C02                    	cmp	al,2		; 0 = GET FILE'S LAST-WRITTEN DATE AND TIME
 44683                                  			 	; 1 = SET FILE'S LAST-WRITTEN DATE AND TIME
 44684                                  	;jnb	short LSeekError1 ; 2,3 -> invalid
 44685                                  	; 12/03/2024
 44686 0000799E 7373                    	jnb	short inval_func
 44687                                  ft1:
 44688 000079A0 E8F100                  	call	CheckOwner	; get sft
 44689 000079A3 72C0                    	jc	short LSeekError ; bad handle
 44690                                  
 44691 000079A5 3C01                    	cmp	al,1
 44692 000079A7 773A                    	ja	short ft2	; PCDOS 7.1 (MSDOS 7) sub function
 44693                                  
 44694 000079A9 08C0                    	or	al,al		; get time/date ?
 44695 000079AB 7514                    	jnz	short ft_set_time ; no,set
 44696                                  
 44697                                  	;lds	cx,[es:di+0Dh]
 44698 000079AD 26C54D0D                	lds	cx,[es:di+SF_ENTRY.sf_time] 
 44699                                  				; get the time
 44700 000079B1 8CDA                    	mov	dx,ds		; & date ; [es:di+SF_ENTRY.sf_date]
 44701 000079B3 E8C18A                  	call	Get_User_Stack
 44702                                  	;mov	[si+4],cx
 44703 000079B6 894C04                  	mov	[si+user_env.user_CX],cx
 44704 000079B9 895406                  	mov	[si+6],dx
 44705 000079BC 895406                  	mov	[si+user_env.user_DX],dx
 44706                                  
 44707 000079BF EB1F                    	jmp	short ft_ok
 44708                                  
 44709                                  ft_set_time:
 44710 000079C1 E81F9F                  	call	ECritSFT
 44711                                  	
 44712                                  	;mov	[es:di+0Dh],cx
 44713 000079C4 26894D0D                	mov	[es:di+SF_ENTRY.sf_time],cx ; drop in new time
 44714                                  	;mov	[es:di+0Fh],dx
 44715 000079C8 2689550F                	mov	[es:di+SF_ENTRY.sf_date],dx ; and date
 44716                                  	
 44717 000079CC 31C0                    	xor	ax,ax ; 0
 44718                                  	;call	ss:ShSU
 44719 000079CE 36FF1E[C800]            	call	far [ss:JShare+(14*4)] ; 14 = ShSU
 44720                                  	
 44721                                  	;;and	word [es:di+5],0FFBFh
 44722                                  	;and	word [es:di+SF_ENTRY.sf_flags],~devid_file_clean
 44723 000079D3 26806505BF              	and	byte [es:di+SF_ENTRY.sf_flags],~devid_file_clean ; 0BFh	
 44724                                  
 44725                                  	;;or	word [es:di+5],4000h
 44726                                  	;or	word [es:di+SF_ENTRY.sf_flags],sf_close_nodate
 44727 000079D8 26804D0640              	or	byte [es:di+SF_ENTRY.sf_flags+1],(sf_close_nodate>>8) ; 40h	
 44728                                  
 44729 000079DD E8309F                  	call	LCritSFT
 44730                                  ft_ok:
 44731                                  ok_ret:		; 12/03/2024
 44732 000079E0 E9878C                  	jmp	SYS_RET_OK
 44733                                  
 44734                                  ft2:
 44735                                  	;test	byte [es:di+5],80h
 44736 000079E3 26F6450580              	test	byte [es:di+SF_ENTRY.sf_flags],devid_device
 44737 000079E8 7505                    	jnz	short ft3	; device
 44738                                  
 44739 000079EA E84D9E                  	call	IsSFTNet
 44740                                  ;ft3:
 44741 000079ED 7415                    	jz	short ft5	; local file
 44742                                  ft3:		; 12/03/2024
 44743 000079EF A801                    	test	al,1		; 0 = GET, 1 = SET
 44744 000079F1 750F                    	jnz	short ft_okj	; SET
 44745                                  
 44746                                  	;mov	dx,[es:di+0Fh]
 44747 000079F3 268B550F                	mov	dx,[es:di+SF_ENTRY.sf_date]
 44748                                  	;;;;
 44749                                  ft7:
 44750                                  	; 12/03/2024
 44751 000079F7 29C9                    	sub	cx,cx ; 0 ; Retro DOS v5.0
 44752                                  				; (Windows ME IO.SYS BIOSCODE:A348h)
 44753                                  	;;;;
 44754                                  ft4:
 44755 000079F9 E87B8A                  	call	Get_User_Stack
 44756                                  	;mov	[si+4],cx
 44757 000079FC 894C04                  	mov	[si+user_env.user_CX],cx ; time
 44758                                  	;mov	[si+6],dx
 44759 000079FF 895406                  	mov	[si+user_env.user_DX],dx ; date
 44760                                  ft_okj:
 44761 00007A02 EBDC                    	jmp	short ft_ok
 44762                                  
 44763                                  ft5:
 44764 00007A04 16                      	push	ss		; Retrieve the directory entry for the file
 44765 00007A05 1F                      	pop	ds
 44766 00007A06 50                      	push	ax
 44767 00007A07 52                      	push	dx
 44768 00007A08 51                      	push	cx		; ES:DI point to SFT
 44769 00007A09 E88ABE                  	call	DirFromSFT	; locate a directory entry given an SFT
 44770 00007A0C 59                      	pop	cx
 44771 00007A0D 5A                      	pop	dx
 44772 00007A0E 730B                    	jnc	short ft6	; ES:DI point to entry
 44773                                  			 	; (DS:SI point to SFT)
 44774                                  			 	; (ES:BX point to buffer header)
 44775 00007A10 59                      	pop	cx
 44776                                  ;ft_error:
 44777                                  	;jmp	short LSeekError2
 44778                                  	; 12/03/2024
 44779                                  	;jmp	short LseekError
 44780 00007A11 EB05                    	jmp	short ft_error
 44781                                  
 44782                                  	;;;;
 44783                                  	; 12/03/2024 - Retro DOS v5.0
 44784                                  inval_func:
 44785 00007A13 E8BF98                  	call    set_exerr_locus_unk ; Extended Error Locus
 44786                                  
 44787                                  	;mov	al,1
 44788 00007A16 B001                    	mov	al,error_invalid_function ; give bad return
 44789                                  ft_error:
 44790                                  	;jmp	short LSeekError
 44791                                  	; 12/03/2024
 44792 00007A18 E9598C                  	jmp	SYS_RET_ERR
 44793                                  	;;;;
 44794                                  ft6:
 44795 00007A1B 58                      	pop	ax
 44796 00007A1C A801                    	test	al,1		; SET ?
 44797 00007A1E 7512                    	jnz	short ft8	; yes
 44798                                  
 44799                                  	; 12/03/2024 (ft7:, cx=0)
 44800                                  	;xor	cx,cx	; 0	; (always) last access time = 0
 44801                                  	
 44802                                  	;mov	dx,[es:di+12h]
 44803 00007A20 268B5512                	mov	dx,[es:di+dir_entry.dir_lstaccdate]
 44804                                  
 44805 00007A24 3C06                    	cmp	al,6		; GET CREATION DATE AND TIME ?
 44806 00007A26 75CF                    	jne	short ft7	; no,GET LAST ACCESS DATE AND TIME
 44807                                  
 44808                                  	;mov	cx,[es:di+0Eh]
 44809 00007A28 268B4D0E                	mov	cx,[es:di+dir_entry.dir_crttime]
 44810                                  	;mov	dx,[es:di+10h]
 44811 00007A2C 268B5510                	mov	dx,[es:di+dir_entry.dir_crtdate]
 44812                                  ;ft7:
 44813 00007A30 EBC7                    	jmp	short ft4
 44814                                  
 44815                                  ft8:		; check date (set) values
 44816 00007A32 F6C21F                  	test	dl,1Fh	  	; DAY (1 to 31) > 0 ?
 44817 00007A35 7504                    	jnz	short ft9	; yes,valid
 44818                                  
 44819                                  ft_err_invd:
 44820                                  	;mov	al,0Dh
 44821 00007A37 B00D                    	mov	al,error_invalid_data
 44822                                  ft_errj:
 44823 00007A39 EBDD                    	jmp	short ft_error
 44824                                  
 44825                                  ft9:
 44826 00007A3B F7C2E001                	test	dx,1E0h		; MONTH (1 to 12) > 0 ?
 44827 00007A3F 74F6                    	jz	short ft_err_invd ; no,invalid
 44828 00007A41 52                      	push	dx
 44829 00007A42 81E2E001                	and	dx,1E0h		; isolate MONTH
 44830 00007A46 81FA8001                	cmp	dx,180h		; > 12 ?
 44831 00007A4A 5A                      	pop	dx
 44832 00007A4B 77EA                    	ja	short ft_err_invd ; yes,invalid
 44833 00007A4D 3C05                    	cmp	al,5		; SET LAST ACCESS DATE AND TIME ?
 44834 00007A4F 7506                    	jnz	short ft10	; no,SET CREATION DATE AND TIME
 44835                                  
 44836                                  	;mov	[es:di+12h],dx
 44837 00007A51 26895512                	mov	[es:di+dir_entry.dir_lstaccdate],dx
 44838 00007A55 EB20                    	jmp	short ft11
 44839                                  
 44840                                  ft10:		; check time (set) values
 44841 00007A57 89C8                    	mov	ax,cx
 44842 00007A59 251FF8                  	and	ax,0F81Fh	; isolate seconds/2 and hour
 44843 00007A5C 80FCB8                  	cmp	ah,0B8h		; HOUR > 23 ?
 44844 00007A5F 77D6                    	ja	short ft_err_invd ; yes,invalid
 44845 00007A61 3C1D                    	cmp	al,1Dh		; SECONDS/2 > 29 (count of 2 seconds)
 44846 00007A63 77D2                    	ja	short ft_err_invd ; yes,invalid
 44847 00007A65 89C8                    	mov	ax,cx
 44848 00007A67 25E007                  	and	ax,7E0h		; isolate MINUTE
 44849 00007A6A 3D6007                  	cmp	ax,760h		; MINUTE > 59 ?
 44850 00007A6D 77C8                    	ja	short ft_err_invd ; yes,invalid
 44851                                  
 44852                                  	;mov	[es:di+10h],dx
 44853 00007A6F 26895510                	mov	[es:di+dir_entry.dir_crtdate],dx
 44854                                  	;mov	[es:di+0Eh],cx
 44855 00007A73 26894D0E                	mov	[es:di+dir_entry.dir_crttime],cx
 44856                                  ft11:
 44857                                  	;test	byte [es:bx+5],40h
 44858 00007A77 26F6470540              	test	byte [es:bx+BUFFINFO.buf_flags],buf_dirty
 44859 00007A7C 7508                    	jnz	short ft12
 44860                                  
 44861 00007A7E E876F1                  	call	INC_DIRTY_COUNT
 44862                                  
 44863                                  	;or	byte [es:bx+5],40h 
 44864 00007A81 26804F0540              	or	byte [es:bx+BUFFINFO.buf_flags],buf_dirty
 44865                                  ft12:
 44866 00007A86 06                      	push	es
 44867 00007A87 1F                      	pop	ds
 44868 00007A88 89DF                    	mov	di,bx		; DS:DI - pointer to buffer
 44869 00007A8A B0FF                    	mov	al,0FFh		; Drive number
 44870                                  				; -1 means do not check for drive
 44871 00007A8C E885F0                  	call	CHECKFLUSH
 44872 00007A8F 7287                    	jc	short ft_error
 44873                                  ;ok_ret:	; 12/03/2024
 44874 00007A91 E9D68B                  	jmp	SYS_RET_OK
 44875                                  	;;;
 44876                                  %endif
 44877                                  
 44878                                  ;Break	<CheckOwner - verify ownership of handles from server>
 44879                                  ;----------------------------------------------------------------------------
 44880                                  ;   CheckOwner - Due to the ability of the server to close file handles for a
 44881                                  ;   process without the process knowing it (delete/rename of open files, for
 44882                                  ;   example), it is possible for the redirector to issue a call to a handle
 44883                                  ;   that it soes not rightfully own. We check here to make sure that the
 44884                                  ;   issuing process is the owner of the SFT. At the same time, we do a
 44885                                  ;   SFFromHandle to really make sure that the SFT is good.
 44886                                  ;
 44887                                  ;	ENTRY	BX has the handle
 44888                                  ;		User_ID is the current user
 44889                                  ;	EXIT	Carry Clear => ES:DI points to SFT
 44890                                  ;		Carry Set => AX has error code
 44891                                  ;	USES	none
 44892                                  ;----------------------------------------------------------------------------
 44893                                  
 44894                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 44895                                  	; 21/05/2019 - Retro DOS v4.0
 44896                                  CheckOwner:
 44897                                  	; 13/07/2018 - Retro DOS v3.0
 44898                                  
 44899 00007A94 E869FC                  	call	SFFromHandle
 44900 00007A97 721B                    	jc	short co_ret_label	; retc
 44901                                  
 44902 00007A99 50                      	push	ax
 44903                                  
 44904                                  	; MSDOS 6.0
 44905                                  
 44906                                  ;SR; WIN386 patch - Do not check for USER_ID for using handles since these 
 44907                                  ;SR; are shared across multiple VMs in win386.
 44908                                  
 44909 00007A9A 36F606[5B0F]01          	test	byte [ss:IsWin386],1 ; 02/06/2019
 44910 00007AA0 7404                    	jz	short no_win386		;win386 is not present
 44911 00007AA2 31C0                    	xor	ax,ax			;set the zero flag
 44912 00007AA4 EB08                    	jmp	short _skip_win386	
 44913                                  
 44914                                  no_win386:
 44915 00007AA6 36A1[3E03]              	mov	ax,[SS:USER_ID]		;smr;SS Override
 44916                                  	;cmp	ax,[es:di+47]
 44917 00007AAA 263B452F                	cmp	ax,[es:di+SF_ENTRY.sf_UID]
 44918                                  
 44919                                  _skip_win386:
 44920 00007AAE 58                      	pop	ax
 44921                                  	
 44922                                  	; 17/12/2022
 44923 00007AAF 7403                    	jz	short co_ret_label
 44924                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44925                                  	;jnz	short CheckOwner_err
 44926                                  	;retn
 44927                                  	
 44928                                  CheckOwner_err:
 44929                                  	;mov	al,6
 44930 00007AB1 B006                    	mov	al,error_invalid_handle
 44931 00007AB3 F9                      	stc
 44932                                  
 44933                                  co_ret_label:
 44934 00007AB4 C3                      	retn
 44935                                  
 44936                                  ;============================================================================
 44937                                  ; MACRO.ASM, MSDOS 6.0, 1991
 44938                                  ;============================================================================
 44939                                  ; Retro	DOS v3.0 - 11/07/2018
 44940                                  ; 21/05/2019 - Retro DOS v4.0
 44941                                  ; 13/03/2024 - Retro DOS v5.0
 44942                                  
 44943                                  ;	TITLE	MACRO - Pathname and macro related internal routines
 44944                                  ;	NAME	MACRO
 44945                                  
 44946                                  ;	Microsoft Confidential
 44947                                  ;	Copyright (C) Microsoft Corporation 1991
 44948                                  ;	All Rights Reserved.
 44949                                  
 44950                                  ;**	MACRO.ASM
 44951                                  ;
 44952                                  ;	$AssignOper
 44953                                  ;	FIND_DPB
 44954                                  ;	InitCDS
 44955                                  ;	$UserOper
 44956                                  ;	GetVisDrv
 44957                                  ;	GetThisDrv
 44958                                  ;	GetCDSFromDrv
 44959                                  ;
 44960                                  ;   Revision history:
 44961                                  ;
 44962                                  ;	Created: MZ 4 April 1983
 44963                                  ;		 MZ 18 April 1983   Make TransFCB handle extended FCBs
 44964                                  ;		 AR 2 June 1983     Define/Delete macro for NET redir.
 44965                                  ;		 MZ 3 Nov 83	    Fix InitCDS to reset length to 2
 44966                                  ;		 MZ 4 Nov 83	    Fix NetAssign to use STRLEN only
 44967                                  ;		 MZ 18 Nov 83	    Rewrite string processing for subtree
 44968                                  ;				    aliasing.
 44969                                  ;
 44970                                  ;   MSDOS performs several types of name translation. First, we maintain for
 44971                                  ;   each valid drive letter the text of the current directory on that drive.
 44972                                  ;   For invalid drive letters, there is no current directory so we pretend to
 44973                                  ;   be at the root. A current directory is either the raw local directory
 44974                                  ;   (consisting of drive:\path) or a local network directory (consisting of
 44975                                  ;   \\machine\path. There is a limit on the point to which a .. is allowed.
 44976                                  ;
 44977                                  ;   Given a path, MSDOS will transform this into a real from-the-root path
 44978                                  ;   without . or .. entries. Any component that is > 8.3 is truncated to
 44979                                  ;   this and all * are expanded into ?'s.
 44980                                  ;
 44981                                  ;   The second part of name translation involves subtree aliasing. A list of
 44982                                  ;   subtree pairs is maintained by the external utility SUBST. The results of
 44983                                  ;   the previous 'canonicalization' are then examined to see if any of the
 44984                                  ;   subtree pairs is a prefix of the user path. If so, then this prefix is
 44985                                  ;   replaced with the other subtree in the pair.
 44986                                  ;
 44987                                  ;   A third part involves mapping this "real" path into a "physical" path.  A
 44988                                  ;   list of drive/subtree pairs are maintained by the external utility JOIN.
 44989                                  ;   The output of the previous translation is examined to see if any of the
 44990                                  ;   subtrees in this list are a prefix of the string. If so, then the prefix
 44991                                  ;   is replaced by the appropriate drive letter. In this manner, we can
 44992                                  ;   'mount' one device under another.
 44993                                  ;
 44994                                  ;   The final form of name translation involves the mapping of a user's
 44995                                  ;   logical drive number into the internal physical drive. This is
 44996                                  ;   accomplished by converting the drive number into letter:CON, performing
 44997                                  ;   the above translation and then converting the character back into a drive
 44998                                  ;   number.
 44999                                  ;
 45000                                  ;   There are two main entry points: TransPath and TransFCB. TransPath will
 45001                                  ;   take a path and form the real text of the pathname with all . and ..
 45002                                  ;   removed. TransFCB will translate an FCB into a path and then invoke
 45003                                  ;   TransPath.
 45004                                  ;
 45005                                  ;	A000	version 4.00  Jan. 1988
 45006                                  
 45007                                  ;Installed = TRUE
 45008                                  
 45009                                  ;	I_need	ThisCDS,DWORD		; pointer to CDS used
 45010                                  ;	I_need	CDSAddr,DWORD		; pointer to CDS table
 45011                                  ;	I_need	CDSCount,BYTE		; number of CDS entries
 45012                                  ;	I_need	CurDrv,BYTE		; current macro assignment (old
 45013                                  ;					; current drive)
 45014                                  ;	I_need	NUMIO,BYTE		; Number of physical drives
 45015                                  ;	I_need	fSharing,BYTE		; TRUE => no redirection allowed
 45016                                  ;	I_need	DummyCDS,80h		; buffer for dummy cds
 45017                                  ;	I_need	DIFFNAM,BYTE		; flag for MyName being set
 45018                                  ;	I_need	MYNAME,16		; machine name
 45019                                  ;	I_need	MYNUM,WORD		; machine number
 45020                                  ;	I_need	DPBHEAD,DWORD		; beginning of DPB chain
 45021                                  ;	I_need	EXTERR_LOCUS,BYTE	; Extended Error Locus
 45022                                  ;	I_need	DrvErr,BYTE		; drive error
 45023                                  
 45024                                  ;BREAK <$AssignOper -- Set up a Macro>
 45025                                  ;----------------------------------------------------------------------------
 45026                                  ; Inputs:
 45027                                  ;	AL = 00 get assign mode 		    (ReturnMode)
 45028                                  ;	AL = 01 set assign mode 		    (SetMode)
 45029                                  ;	AL = 02 get attach list entry		    (GetAsgList)
 45030                                  ;	AL = 03 Define Macro (attch start)
 45031                                  ;	    BL = Macro type
 45032                                  ;	       = 0 alias
 45033                                  ;	       = 1 file/device
 45034                                  ;	       = 2 drive
 45035                                  ;	       = 3 Char device -> network
 45036                                  ;	       = 4 File device -> network
 45037                                  ;	    DS:SI -> ASCIZ source name
 45038                                  ;	    ES:DI -> ASCIZ destination name
 45039                                  ;	AL = 04 Cancel Macro
 45040                                  ;	    DS:SI -> ASCIZ source name
 45041                                  ;	AL = 05 Modified get attach list entry
 45042                                  ;	AL = 06 Get ifsfunc item
 45043                                  ;	AL = 07 set in_use of a drive's CDS
 45044                                  ;	     DL = drive number, 0=default  0=A,,
 45045                                  ;	AL = 08 reset in_use of a drive's CDS
 45046                                  ;	     DL = drive number, 0=A, 1=B,,,
 45047                                  ; Function:
 45048                                  ;	Do macro stuff
 45049                                  ; Returns:
 45050                                  ;	Std Xenix style error return
 45051                                  ;----------------------------------------------------------------------------
 45052                                  
 45053                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 45054                                  	; 21/05/2019 - Retro DOS v4.0
 45055                                  _$AssignOper:
 45056                                  	; MSDOS 6.0
 45057 00007AB5 3C07                    	CMP	AL,7			      ; set in_use ?		;AN000;
 45058 00007AB7 7525                    	JNZ	short chk08		      ; no			;AN000;
 45059                                  srinuse:								;AN000;
 45060 00007AB9 50                      	PUSH	AX			      ; save al 		;AN000;
 45061 00007ABA 88D0                    	MOV	AL,DL			      ; AL= drive id		;AN000;
 45062 00007ABC E84D01                  	CALL	GetCDSFromDrv		      ; ds:si -> cds		;AN000;
 45063 00007ABF 58                      	POP	AX			      ; 			;AN000;
 45064 00007AC0 7216                    	JC	short baddrv		      ; bad drive		;AN000;
 45065                                  	;cmp	word [si+45h],0
 45066 00007AC2 837C4500                	CMP	WORD [SI+curdir.devptr],0     ; dpb ptr =0 ?		;AN000;
 45067 00007AC6 7410                    	JZ	short baddrv		      ;     no			;AN000;
 45068 00007AC8 3C07                    	CMP	AL,7			      ; set ?			;AN000;
 45069 00007ACA 7506                    	JNZ	short resetdrv		      ; no			;AN000;
 45070                                  	;or	word [si+43h],4000h
 45071                                  	; 17/12/2022
 45072                                  	;or	byte [si+44h],40h
 45073 00007ACC 804C4440                	or	byte [SI+curdir.flags+1],(curdir_inuse>>8)
 45074                                  	;OR	word [SI+curdir.flags],curdir_inuse ; set in_use	;AN000;
 45075 00007AD0 EB19                    	JMP	SHORT okdone		      ; 			;AN000;
 45076                                  resetdrv:
 45077                                  	;and	word [si+43h],0BFFFh					;AN000;
 45078                                  	; 18/12/2022
 45079 00007AD2 806444BF                	and	byte [SI+curdir.flags+1],0BFh ; (~curdir_inuse)>>8
 45080                                  	;AND	word [SI+curdir.flags],~curdir_inuse ; reset in_use	;AN000;
 45081 00007AD6 EB13                    	JMP	SHORT okdone		      ; 			;AN000;
 45082                                  
 45083                                  	; 17/12/2022
 45084                                  baddrv: 								;AN000;
 45085 00007AD8 B80F00                  	MOV	AX,error_invalid_drive	      ; error			;AN000;
 45086                                  
 45087                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 45088                                  	;JMP	SHORT ASS_ERR		      ; 			;AN000;
 45089                                  	; 17/12/2022
 45090                                  	; 21/05/2019
 45091                                  ASS_ERR:
 45092 00007ADB E9968B                  	jmp	SYS_RET_ERR
 45093                                  
 45094                                  chk08:									;AN000;
 45095 00007ADE 3C08                    	CMP	AL,8			      ; reset inuse ?		;AN000;
 45096 00007AE0 74D7                    	JZ	short srinuse 		      ; yes			;AN000;
 45097                                  
 45098                                    ;IF	NOT INSTALLED
 45099                                  	;transfer NET_ASSOPER
 45100                                    ;ELSE
 45101                                  	; MSDOS 3.3 (& MSDOS 6.0)
 45102 00007AE2 50                      	PUSH	AX
 45103                                  	;mov	ax,111Eh
 45104                                  	;MOV	AX,(MultNET SHL 8) OR 30
 45105 00007AE3 B81E11                  	mov	ax,(MultNET*256)+30
 45106 00007AE6 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - DO REDIRECTION
 45107                                  			; SS = DOS CS
 45108                                  			; STACK: WORD function to execute
 45109                                  			; Return: CF set on error, AX = error code
 45110                                  			; STACK unchanged
 45111 00007AE8 5B                      	POP	BX			; Don't zap error code in AX
 45112 00007AE9 72F0                    	JC	short ASS_ERR
 45113                                  okdone:
 45114 00007AEB E97C8B                  	jmp	SYS_RET_OK
 45115                                  
 45116                                  	; 17/12/2022
 45117                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 45118                                  ;ASS_ERR:
 45119                                  	;jmp	SYS_RET_ERR
 45120                                  
 45121                                    ;ENDIF
 45122                                  
 45123                                  ;Break <FIND_DPB - Find a DPB from a drive number>
 45124                                  ;----------------------------------------------------------------------------
 45125                                  ;**	FIND_DPB - Find a DPB from a Drive #
 45126                                  ;
 45127                                  ;	ENTRY	AL has drive number A = 0
 45128                                  ;	EXIT	'C' set
 45129                                  ;		    No DPB for this drive number
 45130                                  ;		'C' clear
 45131                                  ;		    DS:SI points to DPB for drive
 45132                                  ;	USES	SI, DS, Flags
 45133                                  ;----------------------------------------------------------------------------
 45134                                  
 45135                                  	; 21/05/2019 - Retro DOS v4.0
 45136                                  FIND_DPB:
 45137 00007AEE 36C536[2600]            	LDS	SI,[SS:DPBHEAD]		;smr;SS Override
 45138                                  fdpb5:	
 45139 00007AF3 83FEFF                  	CMP	SI,-1
 45140 00007AF6 7409                    	JZ	short fdpb10
 45141 00007AF8 3A04                    	cmp	al,[si]
 45142                                  	;CMP	AL,[SI+DPB.DRIVE]
 45143 00007AFA 7406                    	jz	short ret_label15	; Carry clear (retz)
 45144                                  	;;lds	si,[si+18h] ; MSDOS 3.3
 45145                                  	;lds	si,[si+19h] ; MSDOS 6.0
 45146 00007AFC C57419                  	LDS	SI,[SI+DPB.NEXT_DPB]
 45147 00007AFF EBF2                    	JMP	short fdpb5
 45148                                  fdpb10:	
 45149 00007B01 F9                      	STC
 45150                                  ret_label15:
 45151 00007B02 C3                      	retn
 45152                                  
 45153                                  ;	Break <InitCDS - set up an empty CDS>
 45154                                  ;----------------------------------------------------------------------------
 45155                                  ;**	InitCDS - Setup an Empty CDS
 45156                                  ;
 45157                                  ;	ENTRY	ThisCDS points to CDS
 45158                                  ;		AL has uppercase drive letter
 45159                                  ;	EXIT	ThisCDS is now empty
 45160                                  ;		(ES:DI) = CDS
 45161                                  ;		'C' set if no DPB associated with drive
 45162                                  ;	USES	AH,ES,DI, Flags
 45163                                  ;----------------------------------------------------------------------------
 45164                                  
 45165                                  ; 21/05/2019 - Retro DOS v4.0
 45166                                  ; DOSCODE:A9FDh (MSDOS 6.21, MSDOS.SYS)
 45167                                  
 45168                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 45169                                  ; DOSCODE:A99Dh (MSDOS 5.0, MSDOS.SYS)
 45170                                  
 45171                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 45172                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BC91h
 45173                                  
 45174                                  InitCDS:
 45175                                  	; 19/08/2018
 45176                                  	; 05/08/2018 - Retro DOS v3.0
 45177                                  	; MSDOS 6.0
 45178 00007B03 50                      	push	ax			; save (AL) for caller
 45179 00007B04 36C43E[A205]            	LES	DI,[SS:THISCDS]		; (es:di) = CDS address
 45180                                  	;mov	word [es:di+67],0
 45181 00007B09 26C745430000            	MOV	word [ES:DI+curdir.flags],0 ; "free" CDS
 45182 00007B0F 2C40                    	SUB	AL,"A"-1                ; A = 1
 45183 00007B11 363806[4600]            	CMP	[SS:NUMIO],AL		;smr;SS Override
 45184 00007B16 7236                    	JC	short icdsx		; Drive does not map a physical drive
 45185 00007B18 48                      	dec	ax			; (AL) = 0 if A, 1 if B, etc.
 45186 00007B19 50                      	PUSH	AX			; save drive number for later
 45187 00007B1A 0441                    	add	al,"A"
 45188 00007B1C B43A                    	MOV	AH,':'
 45189 00007B1E 268905                  	mov	[ES:DI],ax
 45190                                  	;MOV	[ES:DI+curdir.text],AX 	; set "x:"
 45191                                  	;mov	ax,"\"
 45192                                  	;mov	[es:di+2],ax
 45193                                  	;MOV	word [ES:DI+curdir.text+2],"\"	; NUL terminate
 45194 00007B21 26C745025C00            	mov	word [ES:DI+curdir.text+2],005Ch ; 19/08/2018
 45195                                  	;or	word [es:di+67],4000h
 45196                                  	;or	byte [es:di+68],40h
 45197 00007B27 26804D4440              	OR	byte [ES:DI+curdir.flags+1],(curdir_inuse>>8)
 45198 00007B2C 29C0                    	sub	ax,ax
 45199                                  	;MOV	[es:di+73],ax ; 0
 45200 00007B2E 26894549                	MOV	[ES:DI+curdir.ID],ax
 45201                                  	;mov	[es:di+75],ax ; 0
 45202 00007B32 2689454B                	MOV	[ES:DI+curdir.ID+2],ax
 45203 00007B36 B002                    	mov	al,2
 45204                                  	;mov	[es:di+79],aX ; 2
 45205 00007B38 2689454F                	MOV	[ES:DI+curdir.end],ax
 45206 00007B3C 58                      	POP	AX			; (al) = drive number
 45207 00007B3D 1E                      	push	ds
 45208 00007B3E 56                      	push	si
 45209 00007B3F E8ACFF                  	call	FIND_DPB
 45210 00007B42 7208                    	JC	short icds5		; OOOOPPPPPSSSS!!!!
 45211                                  	;mov	[es:di+69],si
 45212 00007B44 26897545                	MOV	[ES:DI+curdir.devptr],SI
 45213                                  	;mov	[es:di+71],ds
 45214 00007B48 268C5D47                	MOV	[ES:DI+curdir.devptr+2],DS
 45215                                  icds5:	
 45216 00007B4C 5E                      	pop	si
 45217 00007B4D 1F                      	pop	ds
 45218                                  icdsx:	
 45219 00007B4E 58                      	pop	ax
 45220                                  RET45:
 45221 00007B4F C3                      	retn
 45222                                  
 45223                                  ;Break <$UserOper - get/set current user ID (for net)>
 45224                                  ;----------------------------------------------------------------------------
 45225                                  ;   $UserOper - retrieve or initiate a user id string.	MSDOS will only
 45226                                  ;	maintain this string and do no verifications.
 45227                                  ;
 45228                                  ;   Inputs:	AL has function type (0-get 1-set 2-printer-set 3-printer-get
 45229                                  ;				      4-printer-set-flags,5-printer-get-flags)
 45230                                  ;		DS:DX is user string pointer (calls 1,2)
 45231                                  ;		ES:DI is user buffer (call 3)
 45232                                  ;		BX is assign index (calls 2,3,4,5)
 45233                                  ;		CX is user number (call 1)
 45234                                  ;		DX is flag word (call 4)
 45235                                  ;   Outputs:	If AL = 0 then the current user string is written to DS:DX
 45236                                  ;			and user CX is set to the user number
 45237                                  ;		If AL = 3 then CX bytes have been put at input ES:DI
 45238                                  ;		If AL = 5 then DX is flag word
 45239                                  ;----------------------------------------------------------------------------
 45240                                  
 45241                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 45242                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 45243                                  	; 21/05/2019 - Retro DOS v4.0
 45244                                  _$UserOper:
 45245                                  	; 05/08/2018 - Retro DOS v3.0
 45246                                  	; MSDOS 6.0 (& MSDOS 3.3)
 45247 00007B50 50                      	PUSH	AX
 45248 00007B51 2C01                    	SUB	AL,1			; quick dispatch on 0,1
 45249 00007B53 58                      	POP	AX
 45250 00007B54 720E                    	JB	short UserGet 		; return to user the string
 45251 00007B56 742B                    	JZ	short UserSet 		; set the current user
 45252 00007B58 3C05                    	CMP	AL,5			; test for 2,3,4 or 5
 45253 00007B5A 763A                    	JBE	short UserPrint		; yep
 45254                                  
 45255                                  ; 13/03/2024
 45256                                  %if 0
 45257                                  	;mov	byte [ss:EXTERR_LOCUS],1
 45258                                  	MOV	byte [SS:EXTERR_LOCUS],errLOC_Unk ;smr;SS Override 
 45259                                  					; Extended Error Locus
 45260                                  %else
 45261                                  	; 13/03/2024 (PCDOS 7.1 IBMDOS.COM)
 45262                                  	;;;
 45263 00007B5C E87697                  	call	set_exerr_locus_unk	; Extended Error Locus
 45264                                  	;;;
 45265                                  %endif					
 45266                                  	;error	error_invalid_function	; not 0,1,2,3
 45267                                  	;mov	al,1
 45268 00007B5F B001                    	MOV	AL,error_invalid_function
 45269                                  useroper_error:
 45270                                  	; 17/12/2022
 45271                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 45272 00007B61 E9108B                  	JMP	SYS_RET_ERR
 45273                                  	;jmp	short ASS_ERR
 45274                                  
 45275                                  UserGet:
 45276                                  ; Transfer MYNAME to DS:DX
 45277                                  ; Set Return CX to MYNUM
 45278 00007B64 1E                      	PUSH	DS			; switch registers
 45279 00007B65 07                      	POP	ES
 45280 00007B66 89D7                    	MOV	DI,DX			; destination
 45281 00007B68 368B0E[0E00]            	MOV	CX,[SS:MYNUM]		; Get number	;smr;SS Override
 45282 00007B6D E80789                  	call	Get_User_Stack
 45283                                  	;mov	[si+4],cx
 45284 00007B70 894C04                  	MOV	[SI+user_env.user_CX],CX ; Set number return
 45285 00007B73 16                      	push	ss			; point to DOSDATA
 45286 00007B74 1F                      	pop	ds
 45287 00007B75 BE[0503]                	MOV	SI,MYNAME		; point source to user string
 45288                                  UserMove:
 45289 00007B78 B90F00                  	MOV	CX,15
 45290 00007B7B F3A4                    	REP	MOVSB			; blam.
 45291 00007B7D 31C0                    	XOR	AX,AX			; 16th byte is 0
 45292 00007B7F AA                      	STOSB
 45293                                  UserBye:
 45294 00007B80 E9E78A                  	jmp	SYS_RET_OK		; no errors here
 45295                                  
 45296                                  UserSet:
 45297                                  ; Transfer DS:DX to MYNAME
 45298                                  ; CX to MYNUM
 45299 00007B83 36890E[0E00]            	MOV	[SS:MYNUM],CX				;smr;SS Override
 45300 00007B88 89D6                    	MOV	SI,DX			; user space has source
 45301 00007B8A 16                      	push	ss
 45302 00007B8B 07                      	pop	es
 45303 00007B8C BF[0503]                	MOV	DI,MYNAME		; point dest to user string
 45304 00007B8F 36FE06[0403]            	INC	byte [SS:DIFFNAM]	; signal change ;smr;SS Override
 45305 00007B94 EBE2                    	JMP	short UserMove
 45306                                  
 45307                                  UserPrint:
 45308                                  
 45309                                    ;IF NOT Installed
 45310                                    ;	transfer PRINTER_GETSET_STRING
 45311                                    ;ELSE
 45312 00007B96 50                      	PUSH	AX
 45313                                  	;mov	ax,111Fh
 45314                                  	;MOV	AX,(MultNET SHL 8) OR 31
 45315 00007B97 B81F11                  	mov	ax,(MultNET<<8)|31
 45316 00007B9A CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - PRINTER SETUP
 45317                                  			; STACK: WORD function
 45318                                  			; Return: CF set on error, AX = error code
 45319                                  			; STACK unchanged
 45320 00007B9C 5A                      	POP	DX			; Clean stack
 45321                                  	;JNC	short OKPA
 45322 00007B9D 73E1                    	jnc	short UserBye ; 21/05/2019
 45323                                  	; 17/12/2022
 45324 00007B9F EBC0                    	jmp	short useroper_error
 45325                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 45326                                  	;jnb     short OKPA
 45327                                  	;jmp     short useroper_error
 45328                                  
 45329                                  	; 17/12/2022
 45330                                  ;OKPA:
 45331                                  ;	jmp	short UserBye
 45332                                  
 45333                                    ;ENDIF
 45334                                  
 45335                                  ;Break	<GetVisDrv - return visible drive>
 45336                                  ;----------------------------------------------------------------------------
 45337                                  ;   GetVisDrv - correctly map non-spliced inuse drives
 45338                                  ;
 45339                                  ;   Inputs:	AL has drive identifier (0=default)
 45340                                  ;   Outputs:	Carry Set - invalid drive/macro
 45341                                  ;		Carry Clear - AL has physical drive (0=A)
 45342                                  ;		    ThisCDS points to CDS
 45343                                  ;   Registers modified: AL
 45344                                  ;----------------------------------------------------------------------------
 45345                                  
 45346                                  	; 21/05/2019 - Retro DOS v4.0
 45347                                  	; DOSCODE:AA9Fh (MSDOS 6.21, MSDOS.SYS)
 45348                                  
 45349                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 45350                                  	; DOSCODE:AA3Fh (MSDOS 5.0, MSDOS.SYS)
 45351                                  
 45352                                  GetVisDrv:
 45353                                  	; 05/08/2018 - Retro DOS v3.0
 45354                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 6839h
 45355 00007BA1 E81900                  	CALL	GETTHISDRV		; get inuse drive
 45356 00007BA4 72A9                    	jc	short RET45
 45357 00007BA6 1E                      	push	ds
 45358 00007BA7 56                      	push	si
 45359 00007BA8 36C536[A205]            	LDS	SI,[SS:THISCDS]		;smr;SS Override
 45360                                  	;test	word [si+67],2000h
 45361                                  	; 17/12/2022
 45362                                  	;test	byte [si+68],20h
 45363 00007BAD F6444420                	test	byte [SI+curdir.flags+1],(curdir_splice>>8)
 45364                                  	;TEST	word [SI+curdir.flags],curdir_splice
 45365 00007BB1 5E                      	pop	si
 45366 00007BB2 1F                      	pop	ds
 45367 00007BB3 749A                    	jz	short RET45		; if not spliced, return OK
 45368                                  	; MSDOS 6.0
 45369                                  	;mov	byte [ss:DrvErr],0Fh
 45370 00007BB5 36C606[1006]0F          	MOV	byte [SS:DrvErr],error_invalid_drive ;IFS. ;AN000;smr;SS Override
 45371 00007BBB F9                      	STC				; signal error
 45372 00007BBC C3                      	retn
 45373                                  
 45374                                  ;Break <Getthisdrv - map a drive designator (0=def, 1=A...)>
 45375                                  ;----------------------------------------------------------------------------
 45376                                  ;   GetThisDrv - look through a set of macros and return the current drive and
 45377                                  ;	macro pointer
 45378                                  ;
 45379                                  ;   Inputs:	AL has drive identifier (1=A, 0=default)
 45380                                  ;   Outputs:
 45381                                  ;		Carry Set - invalid drive/macro
 45382                                  ;		Carry Clear - AL has physical drive (0=A)
 45383                                  ;		   ThisCDS points to macro
 45384                                  ;   Registers modified: AL
 45385                                  ;----------------------------------------------------------------------------
 45386                                  
 45387                                  	; 21/05/2019 - Retro DOS v4.0
 45388                                  	; DOSCODE:AABCh (MSDOS 6.21, MSDOS.SYS)
 45389                                  
 45390                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 45391                                  	; DOSCODE:AA5Ch (MSDOS 5.0, MSDOS.SYS)
 45392                                  
 45393                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 45394                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BD48h
 45395                                  
 45396                                  GETTHISDRV:
 45397                                  	; 05/08/2018
 45398                                  	; 12/07/2018 - Retro DOS v3.0
 45399                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 6850h
 45400                                  	; MSDOS 3.3 (& MSDOS 6.0)
 45401 00007BBD 08C0                    	OR	AL,AL			; are we using default drive?
 45402 00007BBF 7505                    	JNZ	SHORT GTD10		; no, go get the CDS pointers
 45403 00007BC1 36A0[3603]              	MOV	AL,[SS:CURDRV]		; get the current drive
 45404                                  	;INC	ax			; Counteract next instruction
 45405                                  	; 04/09/2018
 45406                                  	;inc	al
 45407                                  	; 07/12/2022
 45408 00007BC5 40                      	inc	ax
 45409                                  GTD10:	
 45410                                  	;DEC	AX
 45411                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 45412 00007BC6 48                      	dec	ax			; 0 = A
 45413                                  	;dec	al
 45414 00007BC7 1E                      	PUSH	DS			; save world
 45415 00007BC8 56                      	PUSH	SI
 45416                                  
 45417                                  ; 13/03/2024
 45418                                  %if 0
 45419                                  	;mov	byte [ss:EXTERR_LOCUS],2
 45420                                  	MOV	BYTE [SS:EXTERR_LOCUS],errLOC_Disk		;smr;SS Override
 45421                                  	TEST	BYTE [SS:FSHARING],-1	; Logical or Physical?	;smr;SS Override
 45422                                  	JZ	SHORT GTD20		; Logical
 45423                                  %else
 45424                                  	; 13/03/2024 (PCDOS 7.1 IBMDOS.COM)
 45425                                  	;;;
 45426 00007BC9 E81297                  	call	set_exerr_locus_disk
 45427 00007BCC 36803E[7205]00          	cmp	byte [ss:FSHARING],0	; Logical or Physical?
 45428 00007BD2 7420                    	jz	short GTD20		; Logical
 45429                                  	;;;	
 45430                                  %endif
 45431 00007BD4 50                      	PUSH	AX
 45432 00007BD5 06                      	PUSH	ES
 45433 00007BD6 57                      	PUSH	DI
 45434 00007BD7 36C706[A205][F304]      	MOV	WORD [SS:THISCDS],DUMMYCDS ;smr;SS Override
 45435                                  	;mov	[SS:THISCDS+2],CS ; MSDOS 3.3
 45436 00007BDE 368C16[A405]            	MOV	[SS:THISCDS+2],SS ; MSDOS 6.0 ;ThisCDS = &DummyCDS;smr;
 45437 00007BE3 0441                    	ADD	AL,'A'
 45438 00007BE5 E81BFF                  	CALL	InitCDS			; InitCDS(c);
 45439                                  	;test	word [es:di+67],4000h
 45440                                  	; 17/12/2022
 45441                                  	;test	byte [es:di+68],40h
 45442 00007BE8 26F6454440              	test	byte [ES:DI+curdir.flags+1],(curdir_inuse>>8)
 45443                                  	;TEST	WORD [ES:DI+curdir.flags],curdir_inuse	; Clears carry
 45444 00007BED 5F                      	POP	DI
 45445 00007BEE 07                      	POP	ES
 45446 00007BEF 58                      	POP	AX
 45447 00007BF0 740D                    	JZ	SHORT GTD30		; Not a physical drive.
 45448 00007BF2 EB15                    	JMP	SHORT GTDX		; carry clear
 45449                                  GTD20:
 45450 00007BF4 E81500                  	CALL	GetCDSFromDrv
 45451 00007BF7 7206                    	JC	SHORT GTD30	; Unassigned CDS -> return error already set
 45452                                  	;test	word [si+43h],4000h
 45453                                  	; 17/12/2022
 45454                                  	;test	byte [si+44h],40h
 45455 00007BF9 F6444440                	test	byte [SI+curdir.flags+1],(curdir_inuse>>8)
 45456                                  	;TEST	WORD [SI+curdir.flags],curdir_inuse ; Clears Carry
 45457 00007BFD 750A                    	JNZ	SHORT GTDX		; carry clear
 45458                                  GTD30:	
 45459                                  	; 21/05/2019
 45460                                  	; MSDOS 6.0
 45461 00007BFF B00F                    	MOV	AL,error_invalid_drive	; invalid FAT drive
 45462 00007C01 36A2[1006]              	MOV	BYTE [ss:DrvErr],AL	; save this for IOCTL
 45463                                  
 45464                                  ; 13/03/2024
 45465                                  %if 0
 45466                                  	; MSDOS 3.3 (.& MSDOS 6.0)
 45467                                  	MOV	BYTE [ss:EXTERR_LOCUS],errLOC_Unk
 45468                                  %else
 45469                                  	; 13/03/2024 (PCDOS 7.1 IBMDOS.COM)
 45470                                  	;;;
 45471 00007C05 E8CD96                  	call	set_exerr_locus_unk
 45472                                  	;;;
 45473                                  %endif
 45474 00007C08 F9                      	STC
 45475                                  GTDX:	
 45476 00007C09 5E                      	POP	SI			; restore world
 45477 00007C0A 1F                      	POP	DS
 45478 00007C0B C3                      	RETN
 45479                                  
 45480                                  ;Break <GetCDSFromDrv - convert a drive number to a CDS pointer>
 45481                                  ;----------------------------------------------------------------------------
 45482                                  ;   GetCDSFromDrv - given a physical drive number, convert it to a CDS
 45483                                  ;	pointer, returning an error if the drive number is greater than the
 45484                                  ;	number of CDS's
 45485                                  ;
 45486                                  ;   Inputs:	AL is physical unit # A=0...
 45487                                  ;   Outputs:	Carry Set if Bad Drive
 45488                                  ;		Carry Clear
 45489                                  ;		    DS:SI -> CDS
 45490                                  ;		    [THISCDS] = DS:SI
 45491                                  ;   Registers modified: DS,SI
 45492                                  ;----------------------------------------------------------------------------
 45493                                  
 45494                                  	; 21/05/2019 - Retro DOS v4.0
 45495                                  GetCDSFromDrv:
 45496 00007C0C 363A06[4700]            	CMP	AL,[SS:CDSCOUNT]	; is this a valid designator;smr;SS Override
 45497                                  	;JB	SHORT GetCDS	; cf=1	; yes, go get the macro
 45498                                  	;STC				; signal error
 45499                                  	;RETN				; bye
 45500                                  	; 23/09/2023
 45501 00007C11 F5                      	cmc	; cf=1 <-> cf=0
 45502 00007C12 7217                    	jc	short GetCDS_retn
 45503                                  GetCDS:
 45504                                  	; 23/09/2023
 45505                                  	;PUSH	BX
 45506 00007C14 50                      	PUSH	AX
 45507 00007C15 36C536[3C00]            	LDS	SI,[SS:CDSADDR]		; get pointer to table	;smr;SS Override
 45508                                  	;mov	bl,81 ; MSDOS 3.3
 45509                                  	;mov	bl,88 ; MSDOS 6.0 
 45510                                  	; 23/09/2023
 45511                                  	;MOV	BL,curdir.size		; size in convenient spot
 45512                                  	;MUL	BL			; get net offset
 45513 00007C1A B458                    	mov	ah,curdir.size
 45514 00007C1C F6E4                    	mul	ah
 45515 00007C1E 01C6                    	ADD	SI,AX ; *		; convert to true pointer
 45516 00007C20 368936[A205]            	MOV	[SS:THISCDS],SI		; store convenient offset;smr;SS Override
 45517 00007C25 368C1E[A405]            	MOV	[SS:THISCDS+2],DS	; store convenient segment;smr;SS Override
 45518 00007C2A 58                      	POP	AX
 45519                                  	; 23/09/2023
 45520                                  	;POP	BX
 45521                                  	; (cf must be 0 here) ; *
 45522                                  	;CLC				; no error
 45523                                  GetCDS_retn:
 45524 00007C2B C3                      	RETN				; bye!
 45525                                  
 45526                                  ;============================================================================
 45527                                  ; MACRO2.ASM, MSDOS 6.0, 1991
 45528                                  ;============================================================================
 45529                                  ; Retro	DOS v3.0 - 12/07/2018
 45530                                  ; 22/05/2019 - Retro DOS v4.0
 45531                                  ; 13/03/2024 - Retro DOS v5.0
 45532                                  
 45533                                  ;BREAK <TransFCB - convert an FCB into a path, doing substitution>
 45534                                  ;----------------------------------------------------------------------------
 45535                                  ;   TransFCB - Copy an FCB from DS:DX into a reserved area doing all of the
 45536                                  ;       gritty substitution.
 45537                                  ;
 45538                                  ;   Inputs:     DS:DX - pointer to FCB
 45539                                  ;               ES:DI - point to destination
 45540                                  ;   Outputs:    Carry Set - invalid path in final map
 45541                                  ;               Carry Clear - FCB has been mapped into ES:DI
 45542                                  ;                   Sattrib is set from possibly extended FCB
 45543                                  ;                   ExtFCB set if extended FCB found
 45544                                  ;   Registers modified: most
 45545                                  ;----------------------------------------------------------------------------
 45546                                  
 45547                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 45548                                  TransFCB:
 45549                                  	; 22/05/2019 - Retro DOS v4.0
 45550                                  	; 12/07/2018 - Retro DOS v3.0
 45551                                  	;LocalVar FCBTmp,16
 45552                                  	;ENTER
 45553 00007C2C 55                      	push	bp
 45554 00007C2D 89E5                    	mov	bp,sp
 45555                                  	;sub	sp,15	; MSDOS 3.3
 45556 00007C2F 83EC10                  	sub	sp,16	; MSDOS 6.0
 45557 00007C32 16                      	push	ss
 45558 00007C33 07                      	pop	es
 45559 00007C34 06                      	push	es
 45560 00007C35 57                      	push	di
 45561                                  	;lea	di,[bp-15] ; MSDOS 3.3
 45562                                  	;LEA	DI,FCBTmp 
 45563 00007C36 8D7EF0                  	lea	di,[bp-16]		; point to FCB temp area
 45564 00007C39 36C606[6C05]00          	mov	byte [SS:EXTFCB],0	; no extended FCB found ;smr;SS Override
 45565 00007C3F 36C606[6D05]00          	mov	byte [SS:SATTRIB],0	; default search attributes;smr;SS Override
 45566 00007C45 E809A6                  	call	GetExtended             ; get FCB, extended or not
 45567                                  	; 06/12/2022
 45568 00007C48 740D                    	jz	short GetDrive		; not an extended FCB, get drive
 45569 00007C4A 8A44FF                  	mov	AL,[SI-1]               ; get attributes
 45570 00007C4D 36A2[6D05]              	mov	[SS:SATTRIB],AL		; store search attributes;smr;SS Override
 45571 00007C51 36C606[6C05]FF          	mov	byte [SS:EXTFCB],-1	; signal extended FCB  ;smr;SS Override
 45572                                  GetDrive:
 45573 00007C57 AC                      	lodsb				; get drive byte
 45574 00007C58 E862FF                  	call	GETTHISDRV
 45575 00007C5B 722A                    	jc	short BadPack
 45576 00007C5D E87303                  	call	TextFromDrive           ; convert 0-based drive to text
 45577                                  
 45578                                  ; Scan the source to see if there are any illegal chars
 45579                                  
 45580                                  	;mov	bx,CharType		; load lookup table
 45581 00007C60 B90B00                  	mov	cx,11
 45582 00007C63 56                      	push	si			; back over name, ext
 45583                                  FCBScan:
 45584 00007C64 AC                      	lodsb				; get a byte
 45585                                  	
 45586                                  	; 09/08/2018
 45587                                  	;;xlat	byte [es:bx]
 45588                                  	;es	xlat
 45589                                  
 45590                                  	; 22/05/2019 - Retro DOS v4.0	
 45591 00007C65 E894E1                  	call	GetCharType		; get flags
 45592                                  
 45593                                  	;test	al,8	
 45594 00007C68 A808                    	test	al,FFCB
 45595 00007C6A 741B                    	jz	short BadPack
 45596                                  NextCh: 
 45597 00007C6C E2F6                    	loop	FCBScan
 45598 00007C6E 5E                      	pop	si
 45599 00007C6F 89FB                    	mov	bx,di
 45600 00007C71 E83BAA                  	call	PackName                ; crunch the path
 45601 00007C74 5F                      	pop	di			; get original destination
 45602 00007C75 07                      	pop	es
 45603 00007C76 16                      	push	ss			; get DS addressability
 45604 00007C77 1F                      	pop	ds
 45605                                  	;lea	si,[bp-15] ; MSDOS 3.3
 45606                                  	;LEA	SI,FCBTmp		; point at new pathname
 45607 00007C78 8D76F0                  	lea	si,[bp-16]
 45608 00007C7B 803F00                  	cmp	byte [bx],0
 45609 00007C7E 7407                    	jz	short BadPack
 45610 00007C80 55                      	push	bp
 45611 00007C81 E80E00                  	call	TransPathSet            ; convert the path
 45612 00007C84 5D                      	pop	bp
 45613 00007C85 7303                    	jnc	short FCBRet		; bye with transPath error code
 45614                                  BadPack:
 45615 00007C87 F9                      	STC
 45616                                  	;mov	al,3
 45617 00007C88 B003                    	MOV     AL,error_path_not_found
 45618                                  FCBRet: 
 45619                                  	;LEAVE
 45620 00007C8A 89EC                    	mov	sp,bp
 45621 00007C8C 5D                      	pop	bp
 45622                                  TransPath_retn:
 45623 00007C8D C3                      	retn
 45624                                  
 45625                                  ; 12/07/2018 - Retro DOS v3.0
 45626                                  
 45627                                  ;BREAK <TransPath - copy a path, do string sub and put in current dir>
 45628                                  ;----------------------------------------------------------------------------
 45629                                  ;
 45630                                  ;   TransPath - copy a path from DS:SI to ES:DI, performing component string
 45631                                  ;       substitution, insertion of current directory and fixing . and ..
 45632                                  ;       entries. Perform splicing. Allow input string to match splice
 45633                                  ;       exactly.
 45634                                  ;
 45635                                  ;   TransPathSet - Same as above except No splicing is performed if input path
 45636                                  ;       matches splice.
 45637                                  ;
 45638                                  ;   TransPathNoSet - No splicing/local using is performed at all.
 45639                                  ;
 45640                                  ;   The following anomalous behaviour is required:
 45641                                  ;
 45642                                  ;       Drive letters on devices are ignored. (set up DummyCDS)
 45643                                  ;       Paths on devices are ignored. (truncate to 0-length)
 45644                                  ;       Raw net I/O sets ThisCDS => NULL.
 45645                                  ;       fSharing => dummyCDS and no subst/splice. Only canonicalize.
 45646                                  ;
 45647                                  ;   Other behaviour:
 45648                                  ;
 45649                                  ;       ThisCDS set up.
 45650                                  ;       FatRead done on local CDS.
 45651                                  ;       ValidateCDS done on local CDS.
 45652                                  ;
 45653                                  ;   Brief flowchart:
 45654                                  ;
 45655                                  ;       if fSharing then
 45656                                  ;           set up DummyCDS (ThisCDS)
 45657                                  ;           canonicalize (sets cMeta)
 45658                                  ;           splice
 45659                                  ;           fatRead
 45660                                  ;           return
 45661                                  ;       if \\ or d:\\ lead then
 45662                                  ;           set up null CDS (ThisCDS)
 45663                                  ;           canonicalize (sets cMeta)
 45664                                  ;           return
 45665                                  ;       if device then
 45666                                  ;           set up dummyCDS (ThisCDS)
 45667                                  ;           canonicalize (sets cMeta)
 45668                                  ;           return
 45669                                  ;       if file then
 45670                                  ;           getCDS (sets (ThisCDS) from name)
 45671                                  ;           validateCDS (may reset current dir)
 45672                                  ;           Copy current dir
 45673                                  ;           canonicalize (set cMeta)
 45674                                  ;           splice
 45675                                  ;           generate correct CDS (ThisCDS)
 45676                                  ;           if local then
 45677                                  ;               fatread
 45678                                  ;           return
 45679                                  ;
 45680                                  ;   Inputs:     DS:SI - point to ASCIZ string path
 45681                                  ;               DI - point to buffer in DOSDATA
 45682                                  ;   Outputs:    Carry Set - invalid path specification: too many .., bad
 45683                                  ;                   syntax, etc. or user FAILed to I 24.
 45684                                  ;               WFP_Start - points to beginning of buffer
 45685                                  ;               Curr_Dir_End - points to end of current dir in path
 45686                                  ;               DS - DOSDATA
 45687                                  ;   Registers modified: most
 45688                                  ;
 45689                                  ;----------------------------------------------------------------------------
 45690                                  
 45691                                  ; 22/05/2019
 45692                                  ; 13/05/2019 - Retro DOS v4.0
 45693                                  ; DOSCODE:AB99h (MSDOS 6.21, MSDOS.SYS)
 45694                                  
 45695                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 45696                                  ; DOSCODE:AB39h (MSDOS 5.0, MSDOS.SYS)
 45697                                  
 45698                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 45699                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BE1Dh
 45700                                  
 45701                                  TransPath:
 45702 00007C8E 30C0                    	XOR     AL,AL
 45703 00007C90 EB02                    	JMP     SHORT SetSplice
 45704                                  TransPathSet:
 45705 00007C92 B0FF                    	MOV     AL,-1
 45706                                  SetSplice:
 45707 00007C94 36A2[4C03]              	MOV	[SS:NoSetDir],AL	; NoSetDir = !fExact;	;smr;SS Override
 45708 00007C98 B0FF                    	MOV     AL,-1
 45709                                  TransPathNoSet:
 45710 00007C9A 36A2[7105]              	MOV	[SS:FSPLICE],AL		; fSplice = TRUE;	;smr;SS Override
 45711 00007C9E 36C606[7A05]FF          	MOV	byte [ss:CMETA],-1      			;smr;SS Override
 45712 00007CA4 36893E[B205]            	MOV     [SS:WFP_START],DI 				;smr;SS Override
 45713 00007CA9 36C706[B605]FFFF        	MOV	word [SS:CURR_DIR_END],-1 ; crack from start	;smr;SS Override
 45714 00007CB0 16                      	push	ss
 45715 00007CB1 07                      	pop	es
 45716                                  	;lea	bp,[di+134]
 45717 00007CB2 8DAD8600                	LEA     BP,[DI+TEMPLEN]         ; end of buffer
 45718                                  ;
 45719                                  ; if this is through the server dos call, fsharing is set. We set up a
 45720                                  ; dummy cds and let the operation go.
 45721                                  ;
 45722                                  	;TEST	byte [SS:FSHARING],-1	; if no sharing		;smr;SS Override
 45723                                  	;JZ	short CheckUNC		; skip to UNC check
 45724                                  	; 13/03/2024 (PCDOS 7.1 IBMDOS.COM)
 45725                                  	;;;
 45726 00007CB6 36803E[7205]00          	cmp	byte [ss:FSHARING],0
 45727 00007CBC 7435                    	jz	short CheckUNC
 45728                                  	;;;
 45729                                  ;
 45730                                  ; ES:DI point to buffer
 45731                                  ;
 45732 00007CBE E8FC02                  	CALL	DriveFromText           ; get drive and advance DS:SI
 45733 00007CC1 E8F9FE                  	call	GETTHISDRV              ; Set ThisCDS and convert to 0-based
 45734 00007CC4 722A                    	jc	short NoPath
 45735 00007CC6 E80A03                  	CALL	TextFromDrive		; drop in new
 45736 00007CC9 8D5D01                  	LEA	BX,[DI+1]               ; backup limit
 45737 00007CCC E83401                  	CALL	Canonicalize            ; copy and canonicalize
 45738 00007CCF 72BC                    	jc	short TransPath_retn	; errors
 45739                                  ;
 45740                                  ; Perform splices for net guys.
 45741                                  ;
 45742 00007CD1 16                      	push	ss
 45743 00007CD2 1F                      	pop	ds
 45744 00007CD3 8B36[B205]              	MOV     SI,[WFP_START] 		; point to name
 45745 00007CD7 F606[7105]FF            	TEST	byte [FSPLICE],-1
 45746 00007CDC 7403                    	JZ	short NoServerSplice
 45747 00007CDE E83102                  	CALL    Splice
 45748                                  NoServerSplice:
 45749 00007CE1 16                      	push	ss
 45750 00007CE2 1F                      	pop	ds                      ; for FATREAD
 45751 00007CE3 C43E[A205]              	LES     DI,[THISCDS]		; for fatread
 45752 00007CE7 E8F99B                  	call	ECritDisk
 45753 00007CEA E89EE8                  	call	FATREAD_CDS
 45754 00007CED E8209C                  	call	LCritDisk
 45755                                  NoPath:
 45756                                  	;mov	al,3
 45757 00007CF0 B003                    	MOV     AL,error_path_not_found ; Set up for possible bad path error
 45758 00007CF2 C3                      	retn				; any errors are in Carry flag
 45759                                  
 45760                                  ; Let the network decide if the name is for a spooled device. It will map
 45761                                  ; the name if so.
 45762                                  
 45763                                  CheckUNC:
 45764 00007CF3 36C706[A205]FFFF        	MOV     WORD [SS:THISCDS],-1	; NULL thisCDS		;smr;SS Override
 45765                                  	;CallInstall NetSpoolCheck,MultNET,35
 45766 00007CFA B82311                  	mov	ax,1123h
 45767 00007CFD CD2F                    	int	2Fh	; Multiplex - NETWORK REDIRECTOR - QUALIFY REMOTE FILENAME
 45768                                  			; DS:SI -> ASCIZ filename to canonicalize
 45769                                  			; ES:DI -> 128-byte buffer for qualified name
 45770                                  			; Return: CF set if not resolved
 45771 00007CFF 7329                    	JNC	short UNCDone
 45772                                  
 45773                                  ; At this point the name is either a UNC-style name (prefixed with two leading
 45774                                  ; \\s) or is a local file/device. Remember that if a net-spooled device was
 45775                                  ; input, then the name has been changed to the remote spooler by the above net
 45776                                  ; call. Also, there may be a drive in front of the \\.
 45777                                  
 45778                                  NO_CHECK:
 45779 00007D01 E8B902                  	CALL    DriveFromText		; eat drive letter
 45780 00007D04 50                      	PUSH    AX                      ; save it
 45781 00007D05 8B04                    	MOV     AX,[SI]			; get first two bytes of path
 45782 00007D07 E80DE1                  	call    PATHCHRCMP              ; convert to normal form
 45783 00007D0A 86E0                    	XCHG    AH,AL                   ; swap for second byte
 45784 00007D0C E808E1                  	call    PATHCHRCMP              ; convert to normal form
 45785 00007D0F 751F                    	JNZ	short CheckDevice	; not a path char
 45786 00007D11 38C4                    	CMP     AH,AL                   ; are they same?
 45787 00007D13 751B                    	JNZ	short CheckDevice	; nope
 45788                                  
 45789                                  ; We have a UNC request. We must copy the string up to the beginning of the
 45790                                  ; local machine root path
 45791                                  
 45792 00007D15 58                      	POP     AX
 45793 00007D16 A5                      	MOVSW                           ; get the lead \\.
 45794                                  UNCCpy:
 45795 00007D17 AC                      	LODSB                           ; get a byte
 45796 00007D18 E8A9E0                   	call	UCase                   ;AN000;; convert the char
 45797 00007D1B 08C0                    	OR      AL,AL
 45798 00007D1D 740E                    	JZ	short UNCTerm		; end of string. All done.
 45799 00007D1F E8F5E0                  	call    PATHCHRCMP              ; is it a path char?
 45800 00007D22 89FB                    	MOV     BX,DI                   ; backup position
 45801 00007D24 AA                      	STOSB
 45802 00007D25 75F0                    	JNZ	short UNCCpy		; no, go copy
 45803 00007D27 E8D900                  	CALL    Canonicalize            ; wham (and set cMeta)
 45804                                  UNCDone:
 45805 00007D2A 16                      	push	ss
 45806 00007D2B 1F                      	pop	ds
 45807 00007D2C C3                       	retn				; return error code
 45808                                  UNCTerm:
 45809 00007D2D AA                      	STOSB                           ;AN000;
 45810 00007D2E EBFA                    	JMP	short UNCDone		;AN000;
 45811                                  
 45812                                  CheckDevice:
 45813                                  
 45814                                  ; Check DS:SI for device. First eat any path stuff
 45815                                  
 45816 00007D30 58                      	POP     AX                      ; retrieve drive info
 45817 00007D31 803C00                  	CMP     BYTE [SI],0		; check for null file
 45818 00007D34 7504                    	JNZ	short CheckPath
 45819                                  	;mov	al,2 
 45820 00007D36 B002                    	MOV     AL,error_file_not_found ; bad file error
 45821 00007D38 F9                      	STC                             ; signal error on null input
 45822 00007D39 C3                      	RETN				; bye!
 45823                                  CheckPath:
 45824 00007D3A 50                      	push	ax
 45825 00007D3B 55                      	push	bp			; save drive number
 45826                                  
 45827                                  ; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 45828                                  %if 0
 45829                                  	; MSDOS 6.0
 45830                                  ;;;BUGBUG BUG 10-26-1992 scottq
 45831                                  ;;;This is a hack for the CDROM extensions (2.1) who scan looking
 45832                                  ;;;for the following POP BP == 5Dh (restore <bp,ax>).
 45833                                  ;;;The problem is that a direct call to CheckThisDevice can (and did)
 45834                                  ;;;end up having a 5D in the opcode's displacement field. The
 45835                                  ;;;scanning code would choke on this thinking it was a POP BP instruction.
 45836                                  ;;;
 45837                                  ;;;What we do here is do a call to a function that is less than 5Dh
 45838                                  ;;;bytes away (and assert its not exactly 5D away) that jmps (transfers)
 45839                                  ;;;to the correct function. This cannot accidently insert a 5Dh.
 45840                                  ;;;
 45841                                  ;;;More info:
 45842                                  ;;;  This particular scan is begun at the UNCdone label for 32 bytes
 45843                                  ;;;looking for pop BP, so you cannot put a 5D between here and there.
 45844                                  ;;;
 45845                                  	call	no5Dshere
 45846                                  start5Dhack:
 45847                                  ;following is replaced with 5Dhack code--Invoke CheckThisDevice
 45848                                  backfrom5Dhack:
 45849                                  
 45850                                  %endif
 45851                                  
 45852                                  ; 13/03/2024
 45853                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:BECBh
 45854                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:AC47h)
 45855                                  ; ((Windows ME IO.SYS - BIOSCODE:A6C2h))
 45856                                  %if 0
 45857                                  	call	no5Dshere
 45858                                  %else
 45859                                  ; 13/03/2024 - Retro DOS v5.0
 45860                                  
 45861                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 45862                                  	; Note: 'call no5Dshere' is not required for MSDOS 5.0 MSDOS.SYS
 45863 00007D3C E80AD2                  	call    CheckThisDevice	; E8h,6Fh,0D6h
 45864                                  %endif
 45865 00007D3F 5D                      	pop	bp
 45866 00007D40 58                      	pop	ax			; get drive letter back
 45867 00007D41 731C                    	JNC	short DoFile		; yes we have a file.
 45868                                  
 45869                                  ; We have a device. AX has drive letter. At this point we may fake a CDS ala
 45870                                  ; sharing DOS call. We know by getting here that we are NOT in a sharing DOS
 45871                                  ; call.
 45872                                  
 45873 00007D43 36C606[7205]FF          	MOV	byte [SS:FSHARING],-1	; simulate sharing dos call;smr;SS Override
 45874 00007D49 E871FE                  	call	GETTHISDRV              ; set ThisCDS and init DUMMYCDS
 45875 00007D4C 36C606[7205]00          	MOV     byte [SS:FSHARING],0	;                       ;smr;SS Override
 45876                                  
 45877                                  ; Now that we have noted that we have a device, we put it into a form that
 45878                                  ; getpath can understand. Normally getpath requires d:\ to begin the input
 45879                                  ; string. We relax this to state that if the d:\ is present then the path
 45880                                  ; may be a file. If D:/ (note the forward slash) is present then we have
 45881                                  ; a device.
 45882                                  
 45883 00007D52 E87E02                  	CALL    TextFromDrive
 45884 00007D55 B02F                    	MOV     AL,'/'                  ; path sep.
 45885 00007D57 AA                      	STOSB
 45886 00007D58 E84E9A                  	call	StrCpy			; move remainder of string
 45887                                  
 45888 00007D5B F8                      	CLC                             ; everything OK.
 45889 00007D5C 16                      	push	ss
 45890 00007D5D 1F                      	pop	ds                      ; remainder of OK stuff
 45891                                  DoFile_retn:
 45892 00007D5E C3                      	retn
 45893                                  
 45894                                  ; 13/03/2024 - Retro DOS v5.0
 45895                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:BEEEh
 45896                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:AC6Ah)
 45897                                  ; ((Windows ME IO.SYS - BIOSCODE:A6F2h))
 45898                                  ;%if 1
 45899                                  
 45900                                  ; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 45901                                  %if 0
 45902                                  
 45903                                  no5Dshere:
 45904                                  	; 10/08/2018
 45905                                  	jmp	CheckThisDevice		; snoop for device
 45906                                  %endif
 45907                                  
 45908                                  ;.erre (no5Dshere - start5Dhack - 5D)
 45909                                  
 45910                                  ; We have a file. Get the raw CDS.
 45911                                  
 45912                                  DoFile:
 45913                                  	; MSDOS 3.3 (& MSDOS 6.0)
 45914                                  
 45915 00007D5F E83FFE                  	call	GetVisDrv               ; get proper CDS
 45916                                  	;mov	al,3 
 45917 00007D62 B003                    	MOV     AL,error_path_not_found ; Set up for possible bad file error
 45918 00007D64 72F8                    	jc	short DoFile_retn  ; CARRY set -> bogus drive/spliced
 45919                                  
 45920                                  ; ThisCDS has correct CDS. DS:SI advanced to point to beginning of path/file.
 45921                                  ; Make sure that CDS has valid directory; ValidateCDS requires a temp buffer
 45922                                  ; Use the one that we are going to use (ES:DI).
 45923                                  
 45924                                  	;SAVE    <DS,SI,ES,DI>		; save all string pointers.
 45925 00007D66 1E                      	push	ds
 45926 00007D67 56                      	push	si
 45927 00007D68 06                      	push	es
 45928 00007D69 57                      	push	di
 45929 00007D6A E80FD1                  	call	ValidateCDS             ; poke CDS and make everything OK
 45930                                  	;RESTORE <DI,ES,SI,DS>		; get back pointers
 45931 00007D6D 5F                      	pop	di
 45932 00007D6E 07                      	pop	es
 45933 00007D6F 5E                      	pop	si
 45934 00007D70 1F                      	pop	ds
 45935                                  	;mov	al,3
 45936 00007D71 B003                    	MOV     AL,error_path_not_found ; Set up for possible bad path error
 45937                                  	;retc				; someone failed an operation
 45938 00007D73 72E9                    	jc	short DoFile_retn
 45939                                  
 45940                                  ; ThisCDS points to correct CDS. It contains the correct text of the
 45941                                  ; current directory. Copy it in.
 45942                                  
 45943 00007D75 1E                      	push	ds
 45944 00007D76 56                      	push	si
 45945 00007D77 36C536[A205]            	LDS     SI,[SS:THISCDS]		; point to CDS	;smr;SS Override
 45946 00007D7C 89FB                    	MOV     BX,DI                   ; point to destination
 45947                                  	;add	bx,[si+79] ; MSDOS 6.0
 45948 00007D7E 035C4F                  	ADD     BX,[SI+curdir.end]	; point to backup limit
 45949                                  	;lea	bp,[di+134]
 45950 00007D81 8DAD8600                	LEA     BP,[DI+TEMPLEN]         ; regenerate end of buffer
 45951                                  					;AN000;
 45952 00007D85 E8309A                  	call	FStrCpy                 ; copy string. ES:DI point to end
 45953 00007D88 4F                      	DEC     DI                      ; point to NUL byte
 45954                                  
 45955                                  ; Make sure that there is a path char at end.
 45956                                  
 45957 00007D89 B05C                    	MOV     AL,'\'
 45958 00007D8B 263845FF                	CMP     [ES:DI-1],AL
 45959 00007D8F 7401                    	JZ	short GetOrig
 45960 00007D91 AA                      	STOSB
 45961                                  
 45962                                  ; Now get original string.
 45963                                  
 45964                                  GetOrig:
 45965 00007D92 4F                      	DEC     DI                      ; point to path char
 45966 00007D93 5E                      	pop	si
 45967 00007D94 1F                      	pop	ds
 45968                                  
 45969                                  ; BX points to the end of the root part of the CDS (at where a path char
 45970                                  ; should be). Now, we decide whether we use this root or extend it with the
 45971                                  ; current directory. See if the input string begins with a leading 
 45973 00007D95 E8D000                  	CALL    PathSep                 ; is DS:SI a path sep?
 45974 00007D98 7511                    	JNZ	short PathAssure	; no, DI is correct. Assure a path char
 45975 00007D9A 08C0                    	OR      AL,AL                   ; end of string?
 45976 00007D9C 7410                    	JZ	short DoCanon		; yes, skip.
 45977                                  ;
 45978                                  ; The string does begin with a \. Reset the beginning of the canonicalization
 45979                                  ; to this root. Make sure that there is a path char there and advance the
 45980                                  ; source string over all leading \'s.
 45981                                  ;
 45982 00007D9E 89DF                    	MOV     DI,BX                   ; back up to root point.
 45983                                  SkipPath:
 45984 00007DA0 AC                      	LODSB
 45985 00007DA1 E873E0                  	call    PATHCHRCMP
 45986 00007DA4 74FA                    	JZ	short SkipPath
 45987 00007DA6 4E                      	DEC     SI
 45988 00007DA7 08C0                    	OR      AL,AL
 45989 00007DA9 7403                    	JZ	short DoCanon
 45990                                  
 45991                                  ; DS:SI start at some file name. ES:DI points at some path char. Drop one in
 45992                                  ; for yucks.
 45993                                  
 45994                                  PathAssure:
 45995 00007DAB B05C                    	MOV     AL,'\'	; 5Ch
 45996 00007DAD AA                      	STOSB
 45997                                  
 45998                                  ; ES:DI point to the correct spot for canonicalization to begin.
 45999                                  ; BP is the max extent to advance DI
 46000                                  ; BX is the backup limit for ..
 46001                                  
 46002                                  DoCanon:
 46003 00007DAE E85200                  	CALL    Canonicalize            ; wham.
 46004                                  	;retc				; badly formatted path.
 46005 00007DB1 72AB                    	jc	short DoFile_retn
 46006                                  
 46007                                  ; The string has been moved to ES:DI. Reset world to DOS context, pointers
 46008                                  ; to wfp_start and do string substitution. BP is still the max position in
 46009                                  ; buffer.
 46010                                  
 46011 00007DB3 16                      	push	ss
 46012 00007DB4 1F                      	pop	ds
 46013 00007DB5 8B3E[B205]              	MOV     DI,[WFP_START]		; DS:SI point to string
 46014 00007DB9 C536[A205]              	LDS     SI,[THISCDS]		; point to CDS
 46015 00007DBD E81B02                  	CALL    PathPref                ; is there a prefix?
 46016 00007DC0 7514                    	JNZ	short DoSplice		; no, do splice
 46017                                  
 46018                                  ; We have a match. Check to see if we ended in a path char.
 46019                                  
 46020 00007DC2 8A44FF                  	MOV     AL,[SI-1]		; last char to match
 46021 00007DC5 E84FE0                  	call    PATHCHRCMP              ; did we end on a path char? (root)
 46022 00007DC8 740C                    	JZ	short DoSplice		; yes, no current dir here.
 46023                                  Pathline:                               ; 2/13/KK
 46024 00007DCA 26803D00                	CMP     BYTE [ES:DI],0		; end at NUL?
 46025 00007DCE 7406                    	JZ	short DoSplice
 46026 00007DD0 47                      	INC     DI                      ; point to after current path char
 46027 00007DD1 36893E[B605]            	MOV     [SS:CURR_DIR_END],DI	; point to correct spot ;smr;SS Override
 46028                                  
 46029                                  ; Splice the result.
 46030                                  
 46031                                  DoSplice:
 46032 00007DD6 16                      	push	ss
 46033 00007DD7 1F                      	pop	ds			; back to DOSDATA
 46034 00007DD8 8B36[B205]              	MOV     SI,[WFP_START]		; point to beginning of string
 46035 00007DDC 31C9                    	XOR     CX,CX
 46036 00007DDE F606[7105]FF            	TEST	byte [FSPLICE],-1
 46037 00007DE3 7403                    	JZ	short SkipSplice
 46038 00007DE5 E82A01                  	CALL    Splice                  ; replaces in place.
 46039                                  SkipSplice:
 46040                                  
 46041                                  ; The final thing is to assure ourselves that a FATREAD is done on the local
 46042                                  ; device.
 46043                                  
 46044 00007DE8 16                      	push	ss
 46045 00007DE9 1F                      	pop	ds
 46046 00007DEA C43E[A205]              	LES     DI,[THISCDS]		; point to correct drive
 46047                                  	;test	word [es:di+67],8000h
 46048                                  	; 17/12/2022
 46049                                  	;test	byte [es:di+68],80h
 46050 00007DEE 26F6454480              	test	byte [ES:DI+curdir.flags+1],curdir_isnet>>8 ; 04/12/2022
 46051                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet ; 8000h
 46052 00007DF3 750D                    	JNZ	short Done		; net, no fatread necessary (retnz)
 46053 00007DF5 E30B                    	JCXZ    Done
 46054 00007DF7 E8E99A                  	call	ECritDisk
 46055 00007DFA E88EE7                  	call	FATREAD_CDS
 46056 00007DFD E8109B                  	call	LCritDisk
 46057                                  	;mov	al, 3
 46058 00007E00 B003                    	MOV     AL,error_path_not_found ; Set up for possible bad path error
 46059                                  Done:   
 46060 00007E02 C3                      	retn                         ; any errors in carry flag.
 46061                                  
 46062                                  ; 13/07/2018
 46063                                  
 46064                                  ;BREAK <Canonicalize - copy a path and remove . and .. entries>
 46065                                  ;----------------------------------------------------------------------------
 46066                                  ;   Canonicalize - copy path removing . and .. entries.
 46067                                  ;
 46068                                  ;   Inputs:     DS:SI - point to ASCIZ string path
 46069                                  ;               ES:DI - point to buffer
 46070                                  ;               BX - backup limit (offset from ES) points to slash
 46071                                  ;               BP - end of buffer
 46072                                  ;   Outputs:    Carry Set - invalid path specification: too many .., bad
 46073                                  ;                   syntax, etc.
 46074                                  ;               Carry Clear -
 46075                                  ;                   DS:DI - advanced to end of string
 46076                                  ;                   ES:DI - advanced to end of canonicalized form after nul
 46077                                  ;   Registers modified: AX CX DX (in addition to those above)
 46078                                  ;----------------------------------------------------------------------------
 46079                                  
 46080                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46081                                  
 46082                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 46083                                  
 46084                                  Canonicalize:
 46085                                  
 46086                                  ; We copy all leading path separators.
 46087                                  
 46088 00007E03 AC                      	LODSB                           ;   while (PathChr (*s))
 46089 00007E04 E810E0                  	call    PATHCHRCMP
 46090 00007E07 7507                    	JNZ	short CanonDec
 46091 00007E09 39EF                    	CMP     DI,BP                   ;       if (d > dlim)
 46092 00007E0B 7319                    	JAE	short CanonBad		;           goto error;
 46093 00007E0D AA                      	STOSB
 46094 00007E0E EBF3                    	JMP	short Canonicalize	;           *d++ = *s++;
 46095                                  CanonDec:
 46096 00007E10 4E                      	DEC     SI
 46097                                  
 46098                                  ; Main canonicalization loop. We come here with DS:SI pointing to a textual
 46099                                  ; component (no leading path separators) and ES:DI being the destination
 46100                                  ; buffer.
 46101                                  
 46102                                  CanonLoop:
 46103                                  
 46104                                  ; If we are at the end of the source string, then we need to check to see that
 46105                                  ; a potential drive specifier is correctly terminated with a path sep char.
 46106                                  ; Otherwise, do nothing
 46107                                  
 46108 00007E11 31C0                    	XOR     AX,AX
 46109 00007E13 3804                    	CMP     [SI],AL                 ;       if (*s == 0) {
 46110 00007E15 751A                    	JNZ	short DoComponent
 46111 00007E17 26807DFF3A              	CMP     BYTE [ES:DI-1],':'	;           if (d[-1] == ':')
 46112 00007E1C 7505                    	JNZ	short DoTerminate
 46113 00007E1E B05C                    	MOV     AL,'\'                  ;               *d++ = '\';
 46114 00007E20 AA                      	STOSB
 46115 00007E21 88E0                    	MOV     AL,AH
 46116                                  DoTerminate:
 46117 00007E23 AA                      	STOSB                           ;           *d++ = 0;
 46118 00007E24 F8                      	CLC                             ;           return (0);
 46119 00007E25 C3                      	retn
 46120                                  
 46121                                  CanonBad:
 46122 00007E26 E8CB01                  	CALL	ScanPathChar            ; check for path chars in rest of string
 46123                                  	;mov	al,3
 46124 00007E29 B003                    	MOV     AL,error_path_not_found ; Set up for bad path error
 46125 00007E2B 7402                    	JZ	short PathEnc		; path character encountered in string
 46126                                  	;mov	al,2
 46127 00007E2D B002                    	MOV     AL,error_file_not_found ; Set bad file error
 46128                                  PathEnc:
 46129 00007E2F F9                      	STC
 46130                                  CanonBad_retn:
 46131 00007E30 C3                      	retn
 46132                                  
 46133                                  ; We have a textual component that we must copy. We uppercase it and truncate
 46134                                  ; it to 8.3
 46135                                  
 46136                                  DoComponent:                            ;           }
 46137 00007E31 E85000                  	CALL    CopyComponent		;       if (!CopyComponent (s, d))
 46138 00007E34 72FA                    	jc	short CanonBad_retn	;           return (-1);
 46139                                  
 46140                                  ; We special case the . and .. cases. These will be backed up.
 46141                                  
 46142                                  	;CMP	WORD PTR ES:[DI],'.' + (0 SHL 8)
 46143 00007E36 26833D2E                	CMP	WORD [ES:DI],002Eh
 46144 00007E3A 7408                    	JZ	short Skip1
 46145                                  	;CMP	WORD PTR ES:[DI],'..'
 46146 00007E3C 26813D2E2E              	CMP     WORD [ES:DI],2E2Eh
 46147 00007E41 750A                    	JNZ	short CanonNormal
 46148 00007E43 4F                      	DEC     DI                      ;           d--;
 46149                                  Skip1:  
 46150 00007E44 E82A00                  	CALL    SkipBack                ;           SkipBack ();
 46151                                  	;mov	al,3
 46152 00007E47 B003                    	MOV     AL,error_path_not_found ; Set up for possible bad path error
 46153 00007E49 72E5                    	jc	short CanonBad_retn
 46154 00007E4B EB02                    	JMP     short CanonPath         ;           }
 46155                                  
 46156                                  ; We have a normal path. Advance destination pointer over it.
 46157                                  
 46158                                  CanonNormal:                            ;       else
 46159 00007E4D 01CF                    	ADD     DI,CX                   ;           d += ct;
 46160                                  
 46161                                  ; We have successfully copied a component. We are now pointing at a path
 46162                                  ; sep char or are pointing at a nul or are pointing at something else.
 46163                                  ; If we point at something else, then we have an error.
 46164                                  
 46165                                  CanonPath:
 46166 00007E4F E81600                  	CALL    PathSep
 46167 00007E52 75D2                    	JNZ	short CanonBad		; something else...
 46168                                  
 46169                                  ; Copy the first path char we see.
 46170                                  
 46171 00007E54 AC                      	LODSB                           ; get the char
 46172 00007E55 E8BFDF                  	call    PATHCHRCMP              ; is it path char?
 46173 00007E58 75B6                    	JNZ	short CanonDec		; no, go test for nul
 46174 00007E5A 39EF                    	CMP     DI,BP                   ; beyond buffer end?
 46175 00007E5C 73C8                    	JAE	short CanonBad		; yep, error.
 46176 00007E5E AA                      	STOSB                           ; copy the one byte
 46177                                  
 46178                                  ; Skip all remaining path chars
 46179                                  
 46180                                  CanonPathLoop:
 46181 00007E5F AC                      	LODSB                           ; get next byte
 46182 00007E60 E8B4DF                  	call    PATHCHRCMP              ; path char again?
 46183 00007E63 74FA                    	JZ	short CanonPathLoop	; yep, grab another
 46184 00007E65 4E                      	DEC     SI                      ; back up
 46185 00007E66 EBA9                    	JMP	short  CanonLoop	; go copy component
 46186                                  
 46187                                  ;BREAK <PathSep - determine if char is a path separator>
 46188                                  ;----------------------------------------------------------------------------
 46189                                  ;   PathSep - look at DS:SI and see if char is / \ or NUL
 46190                                  ;   Inputs:     DS:SI - point to a char
 46191                                  ;   Outputs:    AL has char from DS:SI (/ => \)
 46192                                  ;               Zero set if AL is / \ or NUL
 46193                                  ;               Zero reset otherwise
 46194                                  ;   Registers modified: AL
 46195                                  ;----------------------------------------------------------------------------
 46196                                  
 46197                                  PathSep:
 46198 00007E68 8A04                    	MOV     AL,[SI]                 ; get the character
 46199                                  PathSepGotCh:				; already have character
 46200 00007E6A 08C0                    	OR      AL,AL                   ; test for zero
 46201 00007E6C 74C2                    	jz	short CanonBad_retn	; return if equal to zero (NUL)
 46202                                  	;call	PATHCHRCMP              ; check for path character
 46203                                  	;retn				; and return HIS determination
 46204                                  	; 18/12/2022
 46205 00007E6E E9A6DF                  	jmp	PATHCHRCMP
 46206                                  
 46207                                  
 46208                                  ;BREAK <SkipBack - move backwards to a path separator>
 46209                                  ;----------------------------------------------------------------------------
 46210                                  ;   SkipBack - look at ES:DI and backup until it points to a / ;   Inputs:     ES:DI - point to a char
 46212                                  ;               BX has current directory back up limit (point to a / \)
 46213                                  ;   Outputs:    ES:DI backed up to point to a path char
 46214                                  ;               AL has char from output ES:DI (path sep if carry clear)
 46215                                  ;               Carry set if illegal backup
 46216                                  ;               Carry Clear if ok
 46217                                  ;   Registers modified: DI,AL
 46218                                  ;----------------------------------------------------------------------------
 46219                                  
 46220                                  SkipBack:
 46221 00007E71 39DF                    	CMP     DI,BX                   ;   while (TRUE) {
 46222 00007E73 720B                    	JB	short SkipBad		;       if (d < dlim)
 46223 00007E75 4F                      	DEC     DI                      ;           goto err;
 46224 00007E76 268A05                  	MOV     AL,[ES:DI]		;       if (pathchr (*--d))
 46225 00007E79 E89BDF                  	call    PATHCHRCMP              ;           break;
 46226 00007E7C 75F3                    	JNZ	short SkipBack		;       }
 46227 00007E7E F8                      	CLC                             ;   return (0);
 46228 00007E7F C3                      	retn				;
 46229                                  SkipBad:                                ;err:
 46230                                  	;mov	al,3
 46231 00007E80 B003                    	MOV     AL,error_path_not_found ; bad path error
 46232 00007E82 F9                      	STC                             ;   return (-1);
 46233 00007E83 C3                      	retn				;
 46234                                  
 46235                                  ;Break <CopyComponent - copy out a file path component>
 46236                                  ;----------------------------------------------------------------------------
 46237                                  ;   CopyComponent - copy a file component from a path string (DS:SI) into ES:DI
 46238                                  ;
 46239                                  ;   Inputs:     DS:SI - source path
 46240                                  ;               ES:DI - destination
 46241                                  ;               ES:BP - end of buffer
 46242                                  ;   Outputs:    Carry Set - too long
 46243                                  ;               Carry Clear - DS:SI moved past component
 46244                                  ;                   CX has length of destination
 46245                                  ;   Registers modified: AX,CX,DX
 46246                                  ;----------------------------------------------------------------------------
 46247                                  
 46248                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46249                                  
 46250                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 46251                                  
 46252                                  CopyComponent:
 46253                                  
 46254                                  %define CopyBP	 [BP]		; word
 46255                                  %define CopyD	 [BP+2]		; dword
 46256                                  %define CopyDoff [BP+2]		; word
 46257                                  %define CopyS	 [BP+6]		; dword
 46258                                  %define CopySoff [BP+6]		; word
 46259                                  %define CopyTemp [BP+10]	; byte
 46260                                  
 46261 00007E84 83EC0E                  	SUB     SP,14                   ; room for temp buffer
 46262 00007E87 1E                      	push	ds
 46263 00007E88 56                      	push	si
 46264 00007E89 06                      	push	es
 46265 00007E8A 57                      	push	di
 46266 00007E8B 55                      	push	bp
 46267 00007E8C 89E5                    	MOV     BP,SP
 46268 00007E8E B42E                    	MOV     AH,'.'
 46269 00007E90 AC                      	LODSB
 46270 00007E91 AA                      	STOSB
 46271 00007E92 38E0                    	CMP     AL,AH                   ;   if ((*d++=*s++) == '.') {
 46272 00007E94 7518                    	JNZ	short NormalComp
 46273 00007E96 E8CFFF                  	CALL    PathSep                 ;       if (!pathsep(*s))
 46274 00007E99 740B                    	JZ	short NulTerm
 46275                                  TryTwoDot:
 46276 00007E9B AC                      	LODSB                           ;           if ((*d++=*s++) != '.'
 46277 00007E9C AA                      	STOSB
 46278 00007E9D 38E0                    	CMP     AL,AH
 46279 00007E9F 7557                    	JNZ	short CopyBad
 46280 00007EA1 E8C4FF                  	CALL    PathSep
 46281 00007EA4 7552                    	JNZ	short CopyBad		;               || !pathsep (*s))
 46282                                  NulTerm:                                ;               return -1;
 46283 00007EA6 30C0                    	XOR     AL,AL                   ;       *d++ = 0;
 46284 00007EA8 AA                      	STOSB
 46285 00007EA9 897606                  	MOV     CopySoff,SI
 46286 00007EAC EB47                    	JMP     SHORT _GoodRet		;       }
 46287                                  NormalComp:                             ;   else {
 46288 00007EAE 8B7606                  	MOV     SI,CopySoff ; [bp+6]
 46289 00007EB1 E8A7DE                  	call	NameTrans               ;       s = NameTrans (s, Name1);
 46290 00007EB4 3B7606                  	CMP     SI,CopySoff             ;       if (s == CopySOff)
 46291 00007EB7 743F                    	JZ	short CopyBad		;           return (-1);
 46292 00007EB9 36F606[7205]FF          	TEST	byte [SS:FSHARING],-1	;       if (!fSharing) {;smr;SS Override
 46293 00007EBF 7510                    	JNZ	short DoPack
 46294 00007EC1 80E201                  	AND     DL,1                    ;           cMeta += fMeta;
 46295 00007EC4 360016[7A05]            	ADD	[ss:CMETA],DL		;           if (cMeta > 0);smr;SS Override
 46296 00007EC9 7F2D                    	JG	short CopyBad		;               return (-1);
 46297 00007ECB 7504                    	JNZ	short DoPack		;           else
 46298 00007ECD 08D2                    	OR      DL,DL                   ;           if (cMeta == 0 && fMeta == 0)
 46299 00007ECF 742F                    	JZ	short CopyBadPath	;               return (-1);
 46300                                  DoPack:                                 ;           }
 46301 00007ED1 897606                  	MOV     CopySoff,SI ; [bp+6]
 46302 00007ED4 16                      	push	ss
 46303 00007ED5 1F                      	pop	ds
 46304 00007ED6 BE[4B05]                	MOV     SI,NAME1
 46305 00007ED9 8D7E0A                  	LEA     DI,CopyTemp ; [bp+10]
 46306 00007EDC 57                      	push	di
 46307 00007EDD E8CFA7                  	call	PackName                ;       PackName (Name1, temp);
 46308 00007EE0 5F                      	pop	di
 46309 00007EE1 E8DD98                  	call	StrLen                  ;       if (strlen(temp)+d > bp)
 46310 00007EE4 49                      	DEC     CX
 46311 00007EE5 034E02                  	ADD     CX,CopyDoff ; [bp+2]
 46312                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 46313                                  	;cmp	cx,[bp+0]
 46314                                  	; 15/12/2022
 46315                                  	;cmp	cx,[bp]
 46316 00007EE8 3B4E00                  	CMP	CX,CopyBP   ; [bp+0]
 46317 00007EEB 730B                    	JAE	short CopyBad		;           return (-1);
 46318 00007EED 89FE                    	MOV     SI,DI                   ;       strcpy (d, temp);
 46319 00007EEF C47E02                  	LES     DI,CopyD    ; [bp+2]	
 46320 00007EF2 E8C398                  	call	FStrCpy
 46321                                  _GoodRet:				;       }
 46322 00007EF5 F8                      	CLC
 46323 00007EF6 EB0B                    	JMP     SHORT CopyEnd           ;   return 0;
 46324                                  CopyBad:
 46325 00007EF8 F9                      	STC
 46326 00007EF9 E8F800                  	CALL    ScanPathChar            ; check for path chars in rest of string
 46327                                  	;mov	al,2
 46328 00007EFC B002                    	MOV     AL,error_file_not_found ; Set up for bad file error
 46329 00007EFE 7503                    	JNZ	short CopyEnd
 46330                                  CopyBadPath:
 46331 00007F00 F9                      	STC
 46332                                  	;mov	al,3
 46333 00007F01 B003                    	MOV     AL,error_path_not_found ; Set bad path error
 46334                                  CopyEnd:
 46335 00007F03 5D                      	pop	bp
 46336 00007F04 5F                      	pop	di
 46337 00007F05 07                      	pop	es
 46338 00007F06 5E                      	pop	si
 46339 00007F07 1F                      	pop	ds
 46340 00007F08 9F                      	LAHF
 46341 00007F09 83C40E                  	ADD     SP,14                   ; reclaim temp buffer
 46342 00007F0C E8B298                  	call	StrLen
 46343 00007F0F 49                      	DEC     CX
 46344 00007F10 9E                      	SAHF
 46345 00007F11 C3                      	retn
 46346                                  
 46347                                  ; 14/05/2019 - Retro DOS v4.0
 46348                                  ; DOSCODE:AE22h (MSDOS 6.21, MSDOS.SYS)
 46349                                  
 46350                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46351                                  ; DOSCODE:ADBFh (MSDOS 5.0, MSDOS.SYS)
 46352                                  
 46353                                  ;Break <Splice - pseudo mount by string substitution>
 46354                                  ;----------------------------------------------------------------------------
 46355                                  ;   Splice - take a string and substitute a prefix if one exists. Change
 46356                                  ;       ThisCDS to point to physical drive CDS.
 46357                                  ;   Inputs:     DS:SI point to string
 46358                                  ;               NoSetDir = TRUE => exact matches with splice fail
 46359                                  ;   Outputs:    DS:SI points to thisCDS
 46360                                  ;               ES:DI points to DPB
 46361                                  ;               String at DS:SI may be reduced in length by removing prefix
 46362                                  ;               and substituting drive letter.
 46363                                  ;               CX = 0 If no splice done
 46364                                  ;               CX <> 0 otherwise
 46365                                  ;               ThisCDS points to proper CDS if spliced, otherwise it is
 46366                                  ;                   left alone
 46367                                  ;               ThisDPB points to proper DPB
 46368                                  ;   Registers modified: DS:SI, ES:DI, BX,AX,CX
 46369                                  ;----------------------------------------------------------------------------
 46370                                  
 46371                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 46372                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0C0A6h
 46373                                  
 46374                                  Splice:
 46375 00007F12 36F606[5A00]FF          	TEST	byte [SS:SPLICES],-1	;smr;SS Override
 46376 00007F18 7469                    	JZ	short AllDone
 46377 00007F1A 36FF36[A205]            	push	word [SS:THISCDS]
 46378 00007F1F 36FF36[A405]            	push	word [SS:THISCDS+2]	; TmpCDS = ThisCDS;smr;SS Override
 46379 00007F24 1E                      	push	ds
 46380 00007F25 56                      	push	si
 46381 00007F26 5F                      	pop	di
 46382 00007F27 07                      	pop	es
 46383 00007F28 31C0                    	XOR     AX,AX                   ;   for (i=1; s = GetCDSFromDrv (i); i++)
 46384                                  SpliceScan:
 46385 00007F2A E8DFFC                  	call	GetCDSFromDrv
 46386 00007F2D 724A                    	JC	short SpliceDone
 46387 00007F2F FEC0                    	INC     AL
 46388                                  	; 17/12/2022
 46389                                  	;test	byte [si+68],20h
 46390 00007F31 F6444420                	test	byte [si+curdir.flags+1],curdir_splice>>8 ; 04/12/2022
 46391                                  	;;test	word [si+67],2000h
 46392                                  	;TEST	word [SI+curdir.flags],curdir_splice
 46393 00007F35 74F3                    	JZ	short SpliceScan 	;       if ( Spliced (i) ) {
 46394 00007F37 57                      	push	di
 46395 00007F38 E8A000                  	CALL    PathPref                ;           if (!PathPref (s, d))
 46396 00007F3B 7403                    	JZ	short SpliceFound	;
 46397                                  SpliceSkip:
 46398 00007F3D 5F                      	pop	di
 46399 00007F3E EBEA                    	JMP	short SpliceScan	;               continue;
 46400                                  SpliceFound:
 46401 00007F40 26803D00                	CMP     BYTE [ES:DI],0		;           if (*s || NoSetDir) {
 46402 00007F44 7508                    	JNZ	short SpliceDo
 46403 00007F46 36F606[4C03]FF          	TEST	byte [ss:NoSetDir],-1			;smr;SS Override
 46404 00007F4C 75EF                    	JNZ	short SpliceSkip
 46405                                  SpliceDo:
 46406 00007F4E 89FE                    	MOV     SI,DI                   ;               p = src + strlen (p);
 46407 00007F50 06                      	push	es
 46408 00007F51 1F                      	pop	ds
 46409 00007F52 5F                      	pop	di
 46410 00007F53 E87F00                  	CALL	TextFromDrive1          ;               src = TextFromDrive1(src,i);
 46411 00007F56 36A1[B605]              	MOV     AX,[SS:CURR_DIR_END]			;smr;SS Override
 46412 00007F5A 09C0                    	OR      AX,AX
 46413 00007F5C 7808                    	JS	short NoPoke
 46414 00007F5E 01F8                    	ADD     AX,DI                   ;               curdirend += src-p;
 46415 00007F60 29F0                    	SUB     AX,SI
 46416 00007F62 36A3[B605]              	MOV     [SS:CURR_DIR_END],AX			;smr;SS Override
 46417                                  NoPoke:
 46418 00007F66 803C00                  	CMP     BYTE [SI],0		;               if (*p)
 46419 00007F69 7503                    	JNZ	short SpliceCopy	;                   *src++ = '\\';
 46420 00007F6B B05C                    	MOV     AL,"\"
 46421 00007F6D AA                      	STOSB
 46422                                  SpliceCopy:                             ;               strcpy (src, p);
 46423 00007F6E E84798                  	call	FStrCpy
 46424 00007F71 83C404                  	ADD     SP,4                    ; throw away saved stuff
 46425 00007F74 80C901                  	OR      CL,1                    ; signal splice done.
 46426 00007F77 EB0C                    	JMP     SHORT DoSet             ;               return;
 46427                                  SpliceDone:                             ;               }
 46428 00007F79 368F06[A405]            	pop	word [SS:THISCDS+2]     ;   ThisCDS = TmpCDS;
 46429 00007F7E 368F06[A205]            	pop	word [SS:THISCDS]			;smr;SS Override
 46430                                  AllDone:
 46431 00007F83 31C9                    	XOR     CX,CX
 46432                                  DoSet:
 46433 00007F85 36C536[A205]            	LDS     SI,[SS:THISCDS]		;   ThisDPB = ThisCDS->devptr;;smr;SS Override
 46434                                  	;les	di,[si+69]
 46435 00007F8A C47C45                  	LES     DI,[SI+curdir.devptr]	
 46436 00007F8D 36893E[8A05]            	MOV	[SS:THISDPB],DI				;smr;SS Override
 46437 00007F92 368C06[8C05]            	MOV	[SS:THISDPB+2],ES			;smr;SS Override
 46438                                  Splice_retn:
 46439 00007F97 C3                      	retn
 46440                                  
 46441                                  ; 15/05/2019 - Retro DOS v4.0
 46442                                  ; DOSCODE:AEA9h (MSDOS 6.21, MSDOS.SYS)
 46443                                  
 46444                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46445                                  ; DOSCODE:AE46h (MSDOS 5.0, MSDOS.SYS)
 46446                                  
 46447                                  ; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 46448                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0C12Dh
 46449                                  
 46450                                  ;Break <$NameTrans - partially process a name>
 46451                                  ;----------------------------------------------------------------------------
 46452                                  ;   $NameTrans - allow users to see what names get mapped to. This call
 46453                                  ;   performs only string substitution and canonicalization, not splicing.  Due
 46454                                  ;   to Transpath playing games with devices, we need to insure that the output
 46455                                  ;   has drive letter and : in it.
 46456                                  ;
 46457                                  ;   Inputs:     DS:SI - source string for translation
 46458                                  ;               ES:DI - pointer to buffer
 46459                                  ;   Outputs:
 46460                                  ;       Carry Clear
 46461                                  ;               Buffer at ES:DI is filled in with data
 46462                                  ;               ES:DI point byte after nul byte at end of dest string in buffer
 46463                                  ;       Carry Set
 46464                                  ;               AX = error_path_not_found
 46465                                  ;   Registers modified: all
 46466                                  ;----------------------------------------------------------------------------
 46467                                  
 46468                                  _$NameTrans:
 46469 00007F98 1E                      	push	ds
 46470 00007F99 56                      	push	si
 46471 00007F9A 06                      	push	es
 46472 00007F9B 57                      	push	di
 46473 00007F9C 51                      	push	cx ; MSDOS 6.0
 46474                                  	
 46475                                  	; MSDOS 6.0	
 46476                                  ; M027 - Start
 46477                                  ;
 46478                                  ; Sattrib must be set up with default values here. Otherwise, the value from
 46479                                  ; a previous DOS call is used for attrib and DevName thinks it is not a 
 46480                                  ; device if the old call set the volume attribute bit. Note that devname in
 46481                                  ; dir2.asm gets ultimately called by Transpath. See also M026. Also save
 46482                                  ; and restore CX.
 46483                                  
 46484                                  	;mov	ch,16h
 46485 00007F9D B516                    	mov     ch,attr_hidden+attr_system+attr_directory
 46486 00007F9F E8E702                  	call	SetAttrib
 46487                                  
 46488                                  ; M027 - End
 46489                                  
 46490                                  	; MSDOS 3.3 (& MSDOS 6.0)
 46491 00007FA2 BF[BE03]                	MOV     DI,OPENBUF
 46492 00007FA5 E8E6FC                  	CALL    TransPath               ; to translation (everything)
 46493 00007FA8 59                      	pop	cx ; MSDOS 6.0
 46494 00007FA9 5F                      	pop     di
 46495 00007FAA 07                      	pop	es
 46496 00007FAB 5E                      	pop     si
 46497 00007FAC 1F                      	pop     ds
 46498 00007FAD 7303                    	JNC	short TransOK
 46499 00007FAF E9C286                  	jmp	SYS_RET_ERR
 46500                                  TransOK:
 46501 00007FB2 BE[BE03]                	MOV     SI,OPENBUF
 46502 00007FB5 16                      	push	ss
 46503 00007FB6 1F                      	pop	ds
 46504                                  ;GotText:
 46505 00007FB7 E8FE97                  	call	FStrCpy
 46506 00007FBA E9AD86                  	jmp	SYS_RET_OK
 46507                                  
 46508                                  ;Break   <DriveFromText - return drive number from a text string>
 46509                                  ;----------------------------------------------------------------------------
 46510                                  ;   DriveFromText - examine DS:SI and remove a drive letter, advancing the
 46511                                  ;   pointer.
 46512                                  ;
 46513                                  ;   Inputs:     DS:SI point to a text string
 46514                                  ;   Outputs:    AL has drive number
 46515                                  ;               DS:SI advanced
 46516                                  ;   Registers modified: AX,SI.
 46517                                  ;----------------------------------------------------------------------------
 46518                                  
 46519                                  DriveFromText:
 46520 00007FBD 30C0                    	XOR     AL,AL                   ;       drive = 0;
 46521                                  	;CMP	BYTE [SI],0		;       if (*s &&
 46522                                  	; 23/09/2023
 46523 00007FBF 3804                    	cmp	[si],al ; 0
 46524 00007FC1 74D4                    	jz	short Splice_retn
 46525 00007FC3 807C013A                	CMP     BYTE [SI+1],':'		;           s[1] == ':') {
 46526 00007FC7 75CE                    	jnz	short Splice_retn
 46527 00007FC9 AD                      	LODSW                           ;           drive = (*s | 020) - 'a'+1;
 46528 00007FCA 0C20                    	OR      AL,20h	; (convert to lowercase)
 46529                                  	;sub	al,60h
 46530 00007FCC 2C60                    	SUB     AL,'a'-1                ;           s += 2;
 46531 00007FCE 75C7                    	jnz	short Splice_retn
 46532 00007FD0 B0FF                    	MOV	AL,-1                   ; nuke AL...
 46533                                  	; 23/09/2023
 46534                                  	;dec	al ; -1
 46535 00007FD2 C3                      	retn				;           }
 46536                                  
 46537                                  ;Break   <TextFromDrive - convert a drive number to a text string>
 46538                                  ;----------------------------------------------------------------------------
 46539                                  ;   TextFromDrive - turn AL into a drive letter: and put it at es:di with
 46540                                  ;   trailing :. TextFromDrive1 takes a 1-based number.
 46541                                  ;
 46542                                  ;   Inputs:     AL has 0-based drive number
 46543                                  ;   Outputs:    ES:DI advanced
 46544                                  ;   Registers modified: AX
 46545                                  ;----------------------------------------------------------------------------
 46546                                  
 46547                                  TextFromDrive:
 46548 00007FD3 FEC0                    	INC     AL
 46549                                  TextFromDrive1:
 46550                                  	;add	al,40h
 46551 00007FD5 0440                    	ADD     AL,'A'-1                ;   *d++ = drive-1+'A';
 46552 00007FD7 B43A                    	MOV     AH,":"	; 3Ah           ;   strcat (d, ":");
 46553 00007FD9 AB                      	STOSW
 46554                                  PathPref_retn:
 46555 00007FDA C3                      	retn
 46556                                  
 46557                                  ;Break   <PathPref - see if one path is a prefix of another>
 46558                                  ;----------------------------------------------------------------------------
 46559                                  ;   PathPref - compare DS:SI with ES:DI to see if one is the prefix of the
 46560                                  ;   other.  Remember that only at a pathchar break are we allowed to have a
 46561                                  ;   prefix: A:\ and A:\FOO
 46562                                  ;
 46563                                  ;   Inputs:     DS:SI potential prefix
 46564                                  ;               ES:DI string
 46565                                  ;   Outputs:    Zero set => prefix found
 46566                                  ;                   DI/SI advanced past matching part
 46567                                  ;               Zero reset => no prefix, DS/SI garbage
 46568                                  ;   Registers modified: CX
 46569                                  ;----------------------------------------------------------------------------
 46570                                  
 46571                                  PathPref:
 46572 00007FDB E8F197                  	call	DStrLen                 ; get length
 46573 00007FDE 49                      	DEC     CX                      ; do not include nul byte
 46574 00007FDF F3A6                    	REPZ    CMPSB                   ; compare
 46575 00007FE1 75F7                    	jnz	short PathPref_retn	; if NZ then return NZ
 46576 00007FE3 50                      	push	ax			; save char register
 46577 00007FE4 8A44FF                  	MOV     AL,[SI-1]               ; get last byte to match
 46578 00007FE7 E82DDE                  	call    PATHCHRCMP              ; is it a path char (Root!)
 46579 00007FEA 7406                    	JZ	short Prefix		; yes, match root (I hope)
 46580                                  NotSep:                                 ; 2/13/KK
 46581 00007FEC 268A05                  	MOV     AL,[ES:DI]		; get next char to match
 46582 00007FEF E878FE                  	CALL    PathSepGotCh            ; was it a pathchar?
 46583                                  Prefix:
 46584 00007FF2 58                      	pop	ax			; get back original
 46585 00007FF3 C3                      	retn
 46586                                  
 46587                                  ;Break   <ScanPathChar - see if there is a path character in a string>
 46588                                  ;----------------------------------------------------------------------------
 46589                                  ;     ScanPathChar - search through the string (pointed to by DS:SI) for
 46590                                  ;     a path separator.
 46591                                  ;
 46592                                  ;     Input:    DS:SI target string (null terminated)
 46593                                  ;     Output:   Zero set => path separator encountered in string
 46594                                  ;               Zero clear => null encountered
 46595                                  ;     Registers modified: SI
 46596                                  ;----------------------------------------------------------------------------
 46597                                  
 46598                                  ScanPathChar:
 46599 00007FF4 AC                      	LODSB                           ; fetch a character
 46600 00007FF5 E872FE                  	call    PathSepGotCh
 46601 00007FF8 75FA                    	JNZ	short ScanPathChar	; not \, / or NUL => go back for more
 46602                                  	;call	PATHCHRCMP              ; path separator?
 46603                                  	;retn
 46604                                  	; 18/12/2022
 46605 00007FFA E91ADE                  	jmp	PATHCHRCMP
 46606                                  
 46607                                  ;============================================================================
 46608                                  ; FILE.ASM, MSDOS 6.0, 1991
 46609                                  ;============================================================================
 46610                                  ; 14/07/2018 - Retro DOS v3.0
 46611                                  
 46612                                  ; 13/05/2019 - Retro DOS v4.0
 46613                                  ; DOSCODE:AF10h (MSDOS 6.21, MSDOS.SYS)
 46614                                  
 46615                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46616                                  ; DOSCODE:AEADh (MSDOS 5.0, MSDOS.SYS)
 46617                                  
 46618                                  ; 14/03/2024 - Retro DOS v5.0
 46619                                  
 46620                                  ; MSDOS 2.11
 46621                                  ;BREAK <$Open - open a file handle>
 46622                                  ;----------------------------------------------------------------------------
 46623                                  ;   Assembler usage:
 46624                                  ;           LDS     DX, Name
 46625                                  ;           MOV     AH, Open
 46626                                  ;           MOV     AL, access
 46627                                  ;           INT     int_command
 46628                                  ;
 46629                                  ;       ACCESS          Function
 46630                                  ;       ------          --------
 46631                                  ;       open_for_read   file is opened for reading
 46632                                  ;       open_for_write  file is opened for writing
 46633                                  ;       open_for_both   file is opened for both reading and writing.
 46634                                  ;
 46635                                  ;   Error returns:
 46636                                  ;           AX = error_invalid_access
 46637                                  ;              = error_file_not_found
 46638                                  ;              = error_access_denied
 46639                                  ;              = error_too_many_open_files
 46640                                  ;----------------------------------------------------------------------------
 46641                                  
 46642                                  ; MSDOS 6.0
 46643                                  ;	BREAK <$Open - open a file from a path string>
 46644                                  ;----------------------------------------------------------------------------
 46645                                  ;
 46646                                  ;**	$OPen - Open a File
 46647                                  ;
 46648                                  ;	given a path name in DS:DX and an open mode in AL, $Open opens the
 46649                                  ;	file and and returns a handle
 46650                                  ;
 46651                                  ;	ENTRY	(DS:DX) = pointer to asciz name
 46652                                  ;		(AL) = open mode
 46653                                  ;	EXIT	'C' clear if OK
 46654                                  ;		  (ax) = file handle
 46655                                  ;		'C' set if error
 46656                                  ;		  (ax) = error code
 46657                                  ;	USES	all
 46658                                  ;
 46659                                  ;----------------------------------------------------------------------------
 46660                                  
 46661                                  ; 13/05/2019 - Retro DOS v4.0
 46662                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46663                                  
 46664                                  ; 14/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 46665                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0C194h
 46666                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0AF10h)
 46667                                  ; (Windows ME IO.SYS - BIOSCODE:0A9A7h)
 46668                                  
 46669                                  _$OPEN:       
 46670 00007FFD 30E4                    	xor	ah,ah  ; MSDOS 6.0	
 46671                                  _$Open2:
 46672                                  	;mov	ch,16h
 46673 00007FFF B516                    	mov	ch,attr_hidden+attr_system+attr_directory
 46674 00008001 E88502                  	call	SetAttrib
 46675 00008004 B9[FC31]                	mov	cx,DOS_OPEN
 46676                                  
 46677                                  	;xor	ah,ah  ; MSDOS 3.3
 46678                                  
 46679 00008007 50                      	push	ax
 46680                                  
 46681                                  ;*	General file open/create code. The $CREATE call and the various
 46682                                  ;	$OPEN calls all come here.
 46683                                  ;
 46684                                  ;	We'll share a lot of the standard stuff of allocating SFTs, cracking
 46685                                  ;	path names, etc., and then dispatch to our individual handlers.
 46686                                  ;	WARNING - this info and list is just a guess, not definitive - jgl
 46687                                  ;
 46688                                  ;	(TOS) = create mode
 46689                                  ;	(CX) = address of routine to call to do actual function
 46690                                  ;	(DS:DX) = ASCIZ name
 46691                                  ;	SAttrib = Attribute mask
 46692                                  
 46693                                  ;	Get a free SFT and mark it "being allocated"
 46694                                  
 46695                                  AccessFile:
 46696 00008008 E8D898                  	call	ECritSFT
 46697 0000800B E845F7                  	call	SFNFree			; get a free sfn
 46698 0000800E E8FF98                  	call	LCritSFT
 46699                                  	;jc	short OpenFailJ		; oops, no free sft's
 46700                                  	; 14/03/2024
 46701 00008011 7248                    	jc	short OpenFail
 46702                                  
 46703 00008013 36891E[AA05]            	MOV	[SS:SFN],BX		; save the SFN for later;smr;SS Override
 46704 00008018 36893E[9E05]            	MOV	[SS:THISSFT],DI		; save the SF offset	;smr;SS Override
 46705 0000801D 368C06[A005]            	MOV	[SS:THISSFT+2],ES	; save the SF segment	;smr;SS Override
 46706                                  
 46707                                  ;	Find a free area in the user's JFN table.
 46708                                  
 46709 00008022 E81BF7                  	call	JFNFree			; get a free jfn
 46710                                  	;jnc	short SaveJFN
 46711                                  	; 14/03/2024
 46712 00008025 7234                    	jc	short OpenFail
 46713                                  	;
 46714                                  ;OpenFailJ:
 46715                                  	;JMP	OpenFail		; there were free JFNs... try SFN
 46716                                  
 46717                                  SaveJFN:
 46718 00008027 36893E[AE05]            	mov	[ss:PJFN],DI		; save the jfn offset	;smr;SS Override
 46719 0000802C 368C06[B005]            	MOV	[ss:PJFN+2],ES		; save the jfn segment	;smr;SS Override
 46720 00008031 36891E[AC05]            	MOV	[ss:JFN],BX		; save the jfn itself	;smr;SS Override
 46721                                  
 46722                                  ;	We have been given an JFN. We lock it down to prevent other tasks from
 46723                                  ;	reusing the same JFN.
 46724                                  
 46725 00008036 368B1E[AA05]            	MOV	BX,[ss:SFN]					;smr;SS Override
 46726 0000803B 26881D                  	MOV	[ES:DI],BL		; assign the JFN
 46727 0000803E 89D6                    	MOV	SI,DX			; get name in appropriate place
 46728 00008040 BF[BE03]                	MOV	DI,OPENBUF		; appropriate buffer
 46729 00008043 51                      	push	cx			; save routine to call
 46730 00008044 E847FC                  	call	TransPath		; convert the path
 46731 00008047 5B                      	pop	bx			; (bx) = routine to call
 46732                                  
 46733 00008048 36C536[9E05]            	LDS	SI,[SS:THISSFT]					;smr;SS Override
 46734                                  	;JC	short OpenCleanJ	; no error, go and open file
 46735                                  	; 14/03/2024
 46736 0000804D 7259                    	jc	short OpenClean
 46737                                  
 46738 0000804F 36803E[7A05]FF          	CMP	byte [ss:CMETA],-1				;smr;SS Override
 46739 00008055 7408                    	JZ	short SetSearch
 46740                                  	;mov	al,2
 46741 00008057 B002                    	MOV	AL,error_file_not_found ; no meta chars allowed
 46742                                  OpenCleanJ:
 46743 00008059 EB4D                    	JMP	short OpenClean
 46744                                  
 46745                                  	; 14/03/2024 (PCDOS 7.1 IBMDOS.COM)
 46746                                  	;;;
 46747                                  OpenFail:
 46748 0000805B FB                      	STI
 46749 0000805C 59                      	pop	cx			; Clean stack
 46750                                  	;
 46751 0000805D EB56                    	jmp	short OpenCritLeave
 46752                                  	;;;
 46753                                  
 46754                                  SetSearch:
 46755 0000805F 58                      	pop	ax			; Mode (Open), Attributes (Create)
 46756                                  
 46757                                  ;	We need to get the new inheritance bits.
 46758                                  
 46759 00008060 31C9                    	xor	cx,cx
 46760                                  	; MSDOS 6.0
 46761                                  	;mov	[si+2],cx ; 0
 46762 00008062 894C02                  	MOV	[SI+SF_ENTRY.sf_mode],cx ; initialize mode field to 0
 46763                                  	;mov    [si+51],cx ; 0
 46764 00008065 894C33                  	MOV	[SI+SF_ENTRY.sf_MFT],cx	 ; clean out sharing info
 46765                                  	;
 46766 00008068 81FB[FC31]              	CMP	BX,DOS_OPEN
 46767 0000806C 7509                    	JNZ	short _DoOper
 46768                                  	;test   al,80h
 46769 0000806E A880                    	test	AL,SHARING_NO_INHERIT	; look for no inher
 46770 00008070 7405                    	JZ	short _DoOper ; 10/08/2018
 46771 00008072 247F                    	AND	AL,7Fh			; mask off inherit bit
 46772                                  	;mov	cx,1000h
 46773 00008074 B90010                  	MOV	CX,sf_no_inherit
 46774                                  _DoOper:
 46775                                  	;; MSDOS 3.3
 46776                                  	;;mov	word [si+2], 0
 46777                                  	;;mov	word [si+33h], 0
 46778                                  	;MOV	word [SI+SF_ENTRY.sf_mode],0
 46779                                  	;MOV	word [SI+SF_ENTRY.sf_MFT],0
 46780                                  
 46781                                  	; MSDOS 6.0
 46782                                  ;**	Check if this is an extended open. If so you must set the
 46783                                  ;	modes in sf_mode. Call Set_EXT_mode to do all this. See
 46784                                  ;	Set_EXT_mode in creat.asm
 46785                                  
 46786                                  	; MSDOS 6.0
 46787                                  	;SAVE	<di, es>                ;M022 conditional removed here
 46788 00008077 57                      	push	di
 46789 00008078 06                      	push	es
 46790 00008079 1E                      	push	ds
 46791 0000807A 07                      	pop	es
 46792 0000807B 56                      	push	si
 46793 0000807C 5F                      	pop	di			; (es:di) = SFT address
 46794 0000807D E868B1                  	call	Set_EXT_mode
 46795                                  	;RESTORE <es, di>
 46796 00008080 07                      	pop	es
 46797 00008081 5F                      	pop	di
 46798                                  
 46799                                  	;Context DS
 46800 00008082 16                      	push	ss
 46801 00008083 1F                      	pop	ds	
 46802                                  
 46803 00008084 51                      	push	cx
 46804 00008085 FFD3                    	CALL	BX			; blam!
 46805 00008087 59                      	pop	cx
 46806 00008088 C536[9E05]              	LDS	SI,[THISSFT]
 46807 0000808C 7239                    	JC	short OpenE2		;AN000;FT. chek extended open hooks first
 46808                                  	;jc	short OpenE ; MSDOS 3.3
 46809                                  
 46810                                  ;	The SFT was successfully opened. Remove busy mark.
 46811                                  
 46812                                  OpenOK:
 46813                                  	;MOV	word [SI+SF_ENTRY.sf_ref_count],1
 46814 0000808E C7040100                	mov	word [SI],1
 46815                                  	;or	[SI+5],cx
 46816 00008092 094C05                  	OR	[SI+SF_ENTRY.sf_flags],CX ; set no inherit bit if necessary
 46817                                  
 46818                                  ; If the open mode is 70, we scan the system for other SFT's with the same
 46819                                  ; contents. If we find one, then we can 'collapse' thissft onto the already
 46820                                  ; opened one. Otherwise we use this new one. We compare uid/pid/mode/mft
 46821                                  ;
 46822                                  ; Since this is only relevant on sharer systems, we stick this code into the
 46823                                  ; sharer.
 46824                                  
 46825 00008095 36A1[AC05]              	MOV	AX,[ss:JFN]				;smr;SS Override
 46826 00008099 36FF1E[C000]            	Call	far [ss:JShare+(12*4)]	; 12 = ShCol	;smr;SS Override
 46827                                  
 46828 0000809E 36C706[AA05]FFFF        	MOV	word [ss:SFN],-1	; clear out sfn pointer	;smr;SS Override
 46829                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 46830                                  OpenOkj:
 46831 000080A5 E9C285                  	jmp	SYS_RET_OK		; bye with no errors
 46832                                  
 46833                                  ;	Extended Open hooks check
 46834                                  ;
 46835                                  ;	AL has error code. Stack has argument to dos_open/dos_create.
 46836                                  
 46837                                  OpenClean:
 46838 000080A8 5B                      	pop	bx			; clean off stack
 46839                                  OpenE:
 46840                                  	;MOV	word [SI+SF_ENTRY.sf_ref_count],0 ; release SFT
 46841 000080A9 C7040000                	mov	word [SI],0
 46842 000080AD 36C536[AE05]            	LDS	SI,[ss:PJFN]		;smr;SS Override
 46843 000080B2 C604FF                  	MOV	BYTE [SI],0FFh		; free the SFN...
 46844                                  
 46845                                  	; 14/03/2024
 46846                                  	;JMP	SHORT OpenCritLeave
 46847                                  	;
 46848                                  ;OpenFail:
 46849                                  	;STI
 46850                                  	;pop	cx			; Clean stack
 46851                                  
 46852                                  OpenCritLeave:
 46853 000080B5 36C706[AA05]FFFF        	MOV	word [SS:SFN],-1	; remove mark.
 46854                                  
 46855                                  	; MSDOS 6.0
 46856                                  ; File Tagging DOS 4.00
 46857 000080BC 36833E[2403]25          	CMP	word [SS:EXTERR],error_Code_Page_Mismatched
 46858                                  					;AN000;;FT. code page mismatch
 46859 000080C2 7538                    	JNZ	short NORERR	  	;AN000;;FT. no
 46860 000080C4 E9B585                  	jmp	From_GetSet		;AN000;;FT. yes
 46861                                  
 46862                                  ; 14/03/2024
 46863                                  	; MSDOS 6.0
 46864                                  ;Extended Open hooks check
 46865                                  OpenE2:					;AN000;;EO.
 46866 000080C7 83F857                  	CMP	AX,error_invalid_parameter ;AN000;;EO. IFS extended open ?
 46867 000080CA 75DD                    	JNZ	short OpenE		;AN000;;EO. no.
 46868 000080CC EBE7                    	JMP	short OpenCritLeave	;AN000;;EO. keep handle
 46869                                  
 46870                                  ; 15/03/2024
 46871                                  %if 0
 46872                                  NORERR: 				;AN000;
 46873                                  ; File Tagging DOS 4.00
 46874                                  
 46875                                  	jmp	SYS_RET_ERR		; no free, return error
 46876                                  %endif
 46877                                  
 46878                                  ; MSDOS 2.11
 46879                                  ;BREAK <$CREAT - create a new file and open him for input>
 46880                                  ;----------------------------------------------------------------------------
 46881                                  ;   Assembler usage:
 46882                                  ;           LDS     DX, name
 46883                                  ;           MOV     AH, Creat
 46884                                  ;           MOV     CX, access
 46885                                  ;           INT     21h
 46886                                  ;       ; AX now has the handle
 46887                                  ;
 46888                                  ;   Error returns:
 46889                                  ;           AX = error_access_denied
 46890                                  ;              = error_path_not_found
 46891                                  ;              = error_too_many_open_files
 46892                                  ;----------------------------------------------------------------------------
 46893                                  
 46894                                  ; MSDOS 6.0
 46895                                  ;	BREAK <$Creat - create a brand-new file>
 46896                                  ;----------------------------------------------------------------------------
 46897                                  ;
 46898                                  ;**	$Creat - Create a File
 46899                                  ;
 46900                                  ;	$Creat creates the directory entry specified in DS:DX and gives it the
 46901                                  ;	initial attributes contained in CX
 46902                                  ;
 46903                                  ;	ENTRY	(DS:DX) = ASCIZ path name
 46904                                  ;		(CX) = initial attributes
 46905                                  ;	EXIT	'C' set if error
 46906                                  ;		  (ax) = error code
 46907                                  ;		'C' clear if OK
 46908                                  ;		  (ax) = file handle
 46909                                  ;	USES	all
 46910                                  ;
 46911                                  ;----------------------------------------------------------------------------
 46912                                  
 46913                                  _$CREAT:
 46914 000080CE 51                      	push	cx			; Save attributes on stack
 46915 000080CF B9[CB30]                	mov	CX,DOS_CREATE		; routine to call
 46916                                  AccessSet:
 46917                                  	;mov	byte [ss:SATTRIB],6
 46918 000080D2 36C606[6D05]06          	mov	byte [ss:SATTRIB],attr_hidden+attr_system ;smr;SS Override
 46919                                  	; 10/08/2018
 46920 000080D8 E92DFF                  	JMP	AccessFile		; use good ol' open
 46921                                  
 46922                                  
 46923                                  ; MSDOS 6.0 (MSDOS 3.3)
 46924                                  ;	BREAK <$CHMOD - change file attributes>
 46925                                  ;----------------------------------------------------------------------------
 46926                                  ;
 46927                                  ;**	$CHMOD - Change File Attributes
 46928                                  ;
 46929                                  ;   Assembler usage:
 46930                                  ;	    LDS     DX, name
 46931                                  ;	    MOV     CX, attributes
 46932                                  ;	    MOV     AL,func (0=get, 1=set)
 46933                                  ;	    INT     21h
 46934                                  ;   Error returns:
 46935                                  ;	    AX = error_path_not_found
 46936                                  ;	    AX = error_access_denied
 46937                                  ;
 46938                                  ;----------------------------------------------------------------------------
 46939                                  
 46940                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46941                                  
 46942                                  	; 14/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 46943                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0C27Ch
 46944                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0AFF4h)
 46945                                  	; (Windows ME IO.SYS - BIOSCODE:0AAB2h)
 46946                                  
 46947                                  _$CHMOD:
 46948                                  	; 14/03/2024 (PCDOS 7.1 IBMDOS.COM)
 46949                                  	;;;
 46950 000080DB 3CFF                    	cmp	al,0FFh		; MS-DOS 7.20 (Win98) - EXTENDED-LENGTH FILENAME OPERATIONS
 46951                                  				; AX = 43FFh
 46952                                  				; BP = 5053h ('PS')
 46953                                  				; CL = function
 46954                                  				; 39h "mkdir" create directory
 46955                                  				; DS:DX -> ASCIZ pathname
 46956                                  				; 56h rename file
 46957                                  				; DS:DX -> ASCIZ filename of existing file (no wildcards)
 46958                                  				; ES:DI -> ASCIZ new filename (no wildcards)
 46959                                  				;
 46960                                  				; ref: Ralf Brown's Interrupt List
 46961 000080DD 7520                    	jnz	short std_chmod
 46962 000080DF 81FD5350                	cmp	bp,5053h
 46963 000080E3 7515                    	jnz	short chmod_x_2
 46964 000080E5 88CC                    	mov	ah,cl
 46965                                  	;mov	word [ss:PATHNAMELEN],128
 46966 000080E7 36C606[5411]80          	mov	byte [ss:PATHNAMELEN],128 ; Retro DOS v5.0
 46967 000080ED 80F939                  	cmp	cl,39h
 46968 000080F0 7503                    	jne	short chmod_x_1
 46969 000080F2 E933A7                  	jmp	mkdir_x
 46970                                  chmod_x_1:
 46971 000080F5 80F956                  	cmp	cl,56h
 46972 000080F8 7472                    	je	short rename_x
 46973                                  chmod_x_2:
 46974 000080FA B001                    	mov	al,1
 46975                                  	;jmp	short NORERR
 46976                                  	; 15/03/2024
 46977                                  NORERR: 
 46978 000080FC E97585                  	jmp	SYS_RET_ERR
 46979                                  
 46980                                  std_chmod:
 46981                                  	;;;
 46982                                  
 46983                                  	; 05/08/2018 - Retro DOS v3.0
 46984                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 6FCCh
 46985 000080FF BF[BE03]                	MOV	DI,OPENBUF		; appropriate buffer
 46986 00008102 50                      	push	ax
 46987 00008103 51                      	push	cx			; save function and attributes
 46988 00008104 89D6                    	MOV	SI,DX			; get things in appropriate places
 46989 00008106 E889FB                  	call	TransPathSet		; get correct path
 46990 00008109 59                      	pop	cx
 46991 0000810A 58                      	pop	ax			; and get function and attrs back
 46992 0000810B 7255                    	JC	short ChModErr		; errors get mapped to path not found
 46993 0000810D 16                      	push	ss			; set up for later possible calls
 46994 0000810E 1F                      	pop	ds
 46995 0000810F 803E[7A05]FF            	CMP	byte [CMETA],-1
 46996 00008114 754C                    	JNZ	short ChModErr
 46997                                  	;mov	byte [SATTRIB],16h
 46998 00008116 C606[6D05]16            	MOV	byte [SATTRIB],attr_hidden+attr_system+attr_directory
 46999 0000811B 2C01                    	SUB	AL,1			; fast way to discriminate
 47000 0000811D 7209                    	JB	short ChModGet		; 0 -> go get value
 47001 0000811F 7415                    	JZ	short ChModSet		; 1 -> go set value
 47002                                  
 47003                                  ; 14/04/2024
 47004                                  %if 0
 47005                                  	;mov	byte [EXTERR_LOCUS],1
 47006                                  	MOV	byte [EXTERR_LOCUS],errLOC_Unk ; Extended Error Locus
 47007                                  %else
 47008                                  	; 14/03/2024 (PCDOS 7.1 IBMDOS.COM)
 47009                                  	;;;
 47010 00008121 E8B191                  	call	set_exerr_locus_unk	; Extended Error Locus
 47011                                  	;;;
 47012                                  %endif
 47013                                  	;mov	al,1
 47014 00008124 B001                    	mov	al,error_invalid_function ; bad value
 47015                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47016                                  chmod_errj:	
 47017                                  	;;jmp	SYS_RET_ERR
 47018                                  	;jmp	short ChModE	
 47019 00008126 EBD4                    	jmp	short NORERR	; 06/12/2022
 47020                                  ChModGet:
 47021 00008128 E899AE                  	call	GET_FILE_INFO		; suck out the ol' info
 47022 0000812B 7237                    	JC	short ChModE		; error codes are already set for ret
 47023 0000812D E84783                  	call	Get_User_Stack		; point to user saved vaiables
 47024                                  	;mov	[SI+4],ax
 47025 00008130 894404                  	MOV	[SI+user_env.user_CX],AX ; return the attributes
 47026                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility
 47027                                  OpenOkj2:
 47028                                  	; 17/12/2022
 47029                                  	;;jmp	SYS_RET_OK		; say sayonara
 47030                                  	;jmp	short OpenOkj
 47031                                  	; 25/06/2019
 47032 00008133 E93785                  	jmp	SYS_RET_OK_clc
 47033                                  
 47034                                  ChModSet:
 47035 00008136 89C8                    	MOV	AX,CX			; get attrs in position
 47036 00008138 E8E7AE                  	call	SET_FILE_ATTRIBUTE	; go set
 47037 0000813B 7227                    	JC	short ChModE		; errors are set
 47038                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility
 47039                                  	;jmp	SYS_RET_OK
 47040                                  OpenOkj3:
 47041                                  	;jmp	short OpenOkj2
 47042                                  	; 17/12/2022
 47043 0000813D E92A85                  	jmp	SYS_RET_OK
 47044                                  
 47045                                  ; 17/12/2022
 47046                                  %if 0
 47047                                  ChModErr:
 47048                                  NotFound:	; 17/12/2022
 47049                                  	;mov	al,3
 47050                                  	mov	al,error_path_not_found
 47051                                  ChModE:
 47052                                  UnlinkE:	; 17/12/2022
 47053                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47054                                  	;;jmp	SYS_RET_ERR
 47055                                  	;jmp	short chmod_errj
 47056                                  	; 17/12/2022
 47057                                  	jmp	short NORERR
 47058                                  %endif
 47059                                  
 47060                                  ; 22/05/2019 - Retro DOS v4.0
 47061                                  ; DOSCODE:B039h (MSDOS 6.21, MSDOS.SYS)
 47062                                  
 47063                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 47064                                  ; DOSCODE:AFD6h (MSDOS 5.0, MSDOS.SYS)
 47065                                  
 47066                                  ;	BREAK <$UNLINK - delete a file entry>
 47067                                  ;----------------------------------------------------------------------------
 47068                                  ;
 47069                                  ;**	$UNLINK - Delete a File
 47070                                  ;
 47071                                  ;
 47072                                  ;	Assembler usage:
 47073                                  ;	    LDS     DX, name
 47074                                  ;	    IF VIA SERVER DOS CALL
 47075                                  ;	     MOV     CX,SEARCH_ATTRIB
 47076                                  ;	    MOV     AH, Unlink
 47077                                  ;	    INT     21h
 47078                                  ;
 47079                                  ;	ENTRY	(ds:dx) = path name
 47080                                  ;		(cx) = search_attribute, if via server_dos
 47081                                  ;	EXIT	'C' clear if no error
 47082                                  ;		'C' set if error
 47083                                  ;		  (ax) = error code
 47084                                  ;			= error_file_not_found
 47085                                  ;			= error_access_denied
 47086                                  ;
 47087                                  ;----------------------------------------------------------------------------
 47088                                  
 47089                                  	; 15/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 47090                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0C2E4h
 47091                                  
 47092                                  _$UNLINK:
 47093 00008140 51                      	push	cx			; Save possible CX input parm
 47094 00008141 89D6                    	MOV	SI,DX			; Point at input string
 47095 00008143 BF[BE03]                	MOV	DI,OPENBUF		; temp spot for path
 47096 00008146 E849FB                  	call	TransPathSet		; go get normalized path
 47097 00008149 59                      	pop	cx
 47098 0000814A 7216                    	JC	short ChModErr		; badly formed path
 47099 0000814C 36803E[7A05]FF          	CMP	byte [ss:CMETA],-1	; meta chars?	;smr;SS Override
 47100 00008152 750E                    	JNZ	short NotFound
 47101 00008154 16                      	push	ss
 47102 00008155 1F                      	pop	ds
 47103                                  	;mov	ch,6
 47104 00008156 B506                    	mov	ch,attr_hidden+attr_system ; unlink appropriate files
 47105 00008158 E82E01                  	call	SetAttrib
 47106 0000815B E807AA                  	call	DOS_DELETE		; remove that file
 47107                                  	;JC	short UnlinkE 		; error is there
 47108                                  	; 17/12/2022
 47109 0000815E 729C                    	jc	short NORERR
 47110                                  
 47111                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47112                                  UnlinkOk:
 47113                                  	;jmp	SYS_RET_OK		; okey doksy
 47114 00008160 EBDB                    	jmp	short OpenOkj3
 47115                                  
 47116                                  	; 17/12/2022
 47117                                  ChModErr:	; 17/12/2022
 47118                                  NotFound:
 47119                                  	;mov	al,3
 47120 00008162 B003                    	MOV	AL,error_path_not_found
 47121                                  ChModE:		; 17/12/2022
 47122                                  UnlinkE:
 47123                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47124                                  	;;jmp	SYS_RET_ERR		; bye
 47125                                  	;jmp	short ChModE
 47126                                  	; 17/12/2022
 47127 00008164 EB96                    	jmp	short NORERR
 47128                                  
 47129                                  ;BREAK <$RENAME - move directory entries around>
 47130                                  ;----------------------------------------------------------------------------
 47131                                  ;
 47132                                  ;   Assembler usage:
 47133                                  ;	    LDS     DX, source
 47134                                  ;	    LES     DI, dest
 47135                                  ;	    IF VIA SERVER DOS CALL
 47136                                  ;	      MOV   CX,SEARCH_ATTRIB
 47137                                  ;	    MOV     AH, Rename
 47138                                  ;	    INT     21h
 47139                                  ;
 47140                                  ;   Error returns:
 47141                                  ;	    AX = error_file_not_found
 47142                                  ;	       = error_not_same_device
 47143                                  ;	       = error_access_denied
 47144                                  ;
 47145                                  ;----------------------------------------------------------------------------
 47146                                  
 47147                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 47148                                  	; 15/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 47149                                  
 47150                                  _$RENAME:
 47151                                  	; 15/03/2024 (PCDOS 7.1 IBMDOS.COM)
 47152                                  	;;;
 47153                                  	;mov	word [ss:PATHNAMELEN],67
 47154                                  	; 15/03/2024 - Retro DOS v5.0
 47155 00008166 36C606[5411]43          	mov	byte [ss:PATHNAMELEN],67 ; DIRSTRLEN = 67
 47156                                  rename_x:
 47157                                  	;;;
 47158                                  
 47159                                  	; MSDOS 3.3 (& MSDOS 6.0)
 47160 0000816C 51                      	push	cx
 47161 0000816D 1E                      	push	ds
 47162 0000816E 52                      	push	dx			; save source and possible CX arg
 47163 0000816F 06                      	PUSH	ES
 47164 00008170 1F                      	POP	DS			; move dest to source
 47165 00008171 89FE                    	MOV	SI,DI			; save for offsets
 47166 00008173 BF[3E04]                	MOV	DI,RENBUF
 47167 00008176 E819FB                  	call	TransPathSet		; munge the paths
 47168 00008179 36FF36[B205]            	PUSH	word [ss:WFP_START]	; get pointer	;smr;SS Override
 47169 0000817E 368F06[B405]            	POP	word [ss:REN_WFP]	; stash it	;smr;SS Override
 47170 00008183 5E                      	pop	si
 47171 00008184 1F                      	pop	ds
 47172 00008185 59                      	pop	cx			; get back source and possible CX arg
 47173                                  epjc2:	
 47174 00008186 72DA                    	JC	short ChModErr		; get old error
 47175 00008188 36803E[7A05]FF          	CMP	byte [ss:CMETA],-1			;smr;SS Override
 47176 0000818E 75D2                    	JNZ	short NotFound
 47177 00008190 51                      	push	cx			; Save possible CX arg
 47178 00008191 BF[BE03]                	MOV	DI,OPENBUF		; appropriate buffer
 47179 00008194 E8FBFA                  	call	TransPathSet		; wham
 47180 00008197 59                      	pop	cx
 47181                                  	;JC	short epjc2
 47182                                  	; 15/03/2024
 47183 00008198 72C8                    	jc	short ChModErr
 47184                                  
 47185 0000819A 16                      	push	ss
 47186 0000819B 1F                      	pop	ds
 47187 0000819C 803E[7A05]FF            	CMP	byte [CMETA],-1
 47188 000081A1 72BF                    	JB	short NotFound
 47189                                  
 47190                                  	; MSDOS 6.0
 47191                                  	;PUSH	WORD [THISCDS]		   ;AN000;;MS.save thiscds
 47192                                  	;PUSH	WORD [THISCDS+2]	   ;AN000;;MS.
 47193                                  	; 15/03/2024 (PCDOS 7.1 IBMDOS.COM)
 47194                                  	;;;
 47195 000081A3 C43E[A205]              	les	di,[THISCDS]
 47196 000081A7 57                      	push	di
 47197 000081A8 06                      	push	es
 47198                                  	;;;
 47199                                  
 47200 000081A9 BF[BE03]                	MOV	DI,OPENBUF		   ;AN000;;MS.
 47201 000081AC 16                      	PUSH	SS			   ;AN000;;MS.
 47202 000081AD 07                      	POP	ES			   ;AN000;;MS.es:di-> source
 47203 000081AE 30C0                    	XOR	AL,AL			   ;AN000;;MS.scan all CDS
 47204                                  rnloop: 				   ;AN000;
 47205 000081B0 E859FA                  	call	GetCDSFromDrv		   ;AN000;;MS.
 47206 000081B3 720F                    	JC	short dorn		   ;AN000;;MS.	end of CDS
 47207 000081B5 E8CF95                  	call	StrCmp			   ;AN000;;MS.	current dir ?
 47208 000081B8 7404                    	JZ	short rnerr		   ;AN000;;MS.	yes
 47209 000081BA FEC0                    	INC	AL			   ;AN000;;MS.	next
 47210 000081BC EBF2                    	JMP	short rnloop		   ;AN000;;MS.
 47211                                  rnerr:					   ;AN000;
 47212                                  	;ADD	SP,4			   ;AN000;;MS. pop thiscds
 47213                                  	; 15/03/2024 (PCDOS 7.1 IBMDOS.COM)
 47214 000081BE 58                      	pop	ax
 47215 000081BF 58                      	pop	ax
 47216                                  
 47217                                  	;error	error_current_directory    ;AN000;;MS.
 47218 000081C0 B010                    	mov	al,error_current_directory
 47219                                  	;jmp	SYS_RET_ERR
 47220                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47221 000081C2 EBA0                    	jmp	short UnlinkE
 47222                                  dorn:
 47223                                  
 47224                                  ; 15/03/2024
 47225                                  %if 0					   ;AN000;
 47226                                  	POP	WORD [SS:THISCDS+2]	   ;AN000;;MS.;PBUGBUG;SS REQD??
 47227                                  	POP	WORD [SS:THISCDS]	   ;AN000;;MS.;PBUGBUG;SS REQD??
 47228                                  %endif
 47229 000081C4 16                      	push	ss
 47230 000081C5 1F                      	pop	ds
 47231                                  
 47232                                  ; 15/03/2024
 47233                                  %if 1
 47234 000081C6 8F06[A405]              	pop	word [THISCDS+2]
 47235 000081CA 8F06[A205]              	pop	word [THISCDS]
 47236                                  %endif
 47237                                  	; MSDOS 3.3 (& MSDOS 6.0)
 47238                                  	;mov	ch,16h
 47239 000081CE B516                    	mov	ch,attr_directory+attr_hidden+attr_system
 47240                                  					; rename appropriate files
 47241 000081D0 E8B600                  	call	SetAttrib
 47242 000081D3 E8A2AB                  	call	DOS_RENAME		; do the deed
 47243 000081D6 728C                    	JC	short UnlinkE 		; errors
 47244                                  
 47245                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47246                                  	;jmp	SYS_RET_OK
 47247 000081D8 EB86                    	jmp	short UnlinkOk
 47248                                  
 47249                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 47250                                  
 47251                                  ; 14/07/2018 - Retro DOS v3.0
 47252                                  ; MSDOS 3.3 (& MSDOS 6.0)
 47253                                  
 47254                                  ;Break <$CreateNewFile - Create a new directory entry>
 47255                                  ;----------------------------------------------------------------------------
 47256                                  ;   CreateNew - Create a new directory entry. Return a file handle if there
 47257                                  ;	was no previous directory entry, and fail if a directory entry with
 47258                                  ;	the same name existed previously.
 47259                                  ;
 47260                                  ;   Inputs:	DS:DX point to an ASCIZ file name
 47261                                  ;		CX contains default file attributes
 47262                                  ;   Outputs:	Carry Clear:
 47263                                  ;		    AX has file handle opened for read/write
 47264                                  ;		Carry Set:
 47265                                  ;		    AX has error code
 47266                                  ;   Registers modified: All
 47267                                  ;----------------------------------------------------------------------------
 47268                                  
 47269                                  _$CreateNewFile:
 47270 000081DA 51                      	push	cx			; Save attributes on stack
 47271 000081DB B9[9231]                	MOV	CX,DOS_Create_New	; routine to call
 47272 000081DE E9F1FE                  	JMP	AccessSet		; use good ol' open
 47273                                  
 47274                                  ;**	BinToAscii - convert a number to a string.
 47275                                  ;----------------------------------------------------------------------------
 47276                                  ;	BinToAscii converts a 16 bit number into a 4 ascii characters.
 47277                                  ;	This routine is used to generate temp file names so we don't spend
 47278                                  ;	the time and code needed for a true hex number, we just use
 47279                                  ;	A thorugh O.
 47280                                  ;
 47281                                  ;	ENTRY	(ax) = value
 47282                                  ;		(es:di) = destination
 47283                                  ;	EXIT	(es:di) updated by 4
 47284                                  ;	USES	cx, di, flags
 47285                                  ;----------------------------------------------------------------------------
 47286                                  
 47287                                  ; MSDOS 3.3
 47288                                  ;BinToAscii:
 47289                                  ;	mov     cx,4
 47290                                  ;bta5:
 47291                                  ;	push    cx
 47292                                  ;	mov     cl,4
 47293                                  ;	rol     ax,cl
 47294                                  ;	push    ax
 47295                                  ;	and     al,0Fh
 47296                                  ;	add     al,'0'
 47297                                  ;	cmp     al,'9'
 47298                                  ;	jbe     short bta6
 47299                                  ;	add     al,7
 47300                                  ;bta6: 
 47301                                  ;	stosb
 47302                                  ;	pop     ax
 47303                                  ;	pop     cx
 47304                                  ;	loop    bta5
 47305                                  ;	retn
 47306                                  
 47307                                  ; 15/03/2024
 47308                                  ; MSDOS 5.0-6.22 & Windows ME
 47309                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0B0D9h)
 47310                                  ; (Windows ME IO.SYS - BIOSCODE:0ABA4h)
 47311                                  %if 0
 47312                                  
 47313                                  ; MSDOS 6.0
 47314                                  BinToAscii:
 47315                                  	mov	cx,404h			; (ch) = digit counter, (cl) = shift cnt
 47316                                  bta5:	
 47317                                  	ROL	AX,CL			; move leftmost nibble into rightmost
 47318                                  	push	ax			; preserve remainder of digits
 47319                                  	AND	AL,0Fh			; grab low nibble
 47320                                  	ADD	AL,'A'			; turn into ascii
 47321                                  	STOSB				; drop in the character
 47322                                  	pop	ax			; (ax) = shifted number
 47323                                  	dec	ch
 47324                                  	jnz	short bta5		; process 4 digits
 47325                                  	retn
 47326                                  %else
 47327                                  ; 15/03/2024
 47328                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0C385h
 47329                                  
 47330                                  BinToAscii:
 47331 000081E1 50                      	push	ax		; convert a number to a string ; ax = value
 47332 000081E2 86E0                    	xchg	ah,al
 47333                                  	;db	0D4h,10h
 47334 000081E4 D410                    	aam	10h		; AH = AL / 16 and AL = remainder
 47335 000081E6 054141                  	add	ax,4141h	; 'AA'
 47336 000081E9 AB                      	stosw
 47337 000081EA 58                      	pop	ax
 47338                                  	;db	0D4h,10h
 47339 000081EB D410                    	aam	10h
 47340 000081ED 054141                  	add	ax,4141h	; add ax,'AA'
 47341 000081F0 AB                      	stosw
 47342 000081F1 C3                      	retn	
 47343                                  %endif
 47344                                  
 47345                                  ;Break	<$CreateTempFile - create a unique name>
 47346                                  ;----------------------------------------------------------------------------
 47347                                  ;   $CreateTemp - given a directory, create a unique name in that directory.
 47348                                  ;	Method used is to get the current time, convert to a name and attempt
 47349                                  ;	a create new. Repeat until create new succeeds.
 47350                                  ;
 47351                                  ;   Inputs:	DS:DX point to a null terminated directory name.
 47352                                  ;		CX  contains default attributes
 47353                                  ;   Outputs:	Unique name is appended to DS:DX directory.
 47354                                  ;		AX has handle
 47355                                  ;   Registers modified: all
 47356                                  ;----------------------------------------------------------------------------
 47357                                  
 47358                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 47359                                  	; 15/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 47360                                  
 47361                                  _$CreateTempFile:
 47362                                  	;Enter
 47363 000081F2 55                      	push	bp
 47364 000081F3 89E5                    	mov	bp,sp
 47365                                  
 47366                                  	;LocalVar  EndPtr,DWORD
 47367                                  	;LocalVar  FilPtr,DWORD
 47368                                  	;LocalVar  Attr,WORD
 47369                                  
 47370 000081F5 83EC0A                  	sub	sp,10
 47371                                  
 47372                                  	;test	cx,0FFD8h
 47373 000081F8 F7C1D8FF                	test	CX,~attr_changeable
 47374 000081FC 7405                    	JZ	short OKatts		; Ok if no non-changeable bits set
 47375                                  
 47376                                  ; We need this "hook" here to detect these cases (like user sets one both of
 47377                                  ; vol_id and dir bits) because of the structure of the or $CreateNewFile loop
 47378                                  ; below. The code loops on error_access_denied, but if one of the non
 47379                                  ; changeable attributes is specified, the loop COULD be infinite or WILL be
 47380                                  ; infinite because CreateNewFile will fail with access_denied always. Thus we
 47381                                  ; need to detect these cases before getting to the loop.
 47382                                  
 47383                                  	;mov	ax, 5
 47384 000081FE B80500                  	MOV	AX,error_access_denied
 47385 00008201 EB7A                    	JMP	SHORT SETTMPERR
 47386                                  
 47387                                  OKatts:
 47388                                  	;MOV	attr,CX 		; save attribute
 47389 00008203 894EF6                  	mov     [bp-10],cx
 47390                                  	;MOV	FilPtrL,DX		; pointer to file
 47391 00008206 8956F8                  	mov	[bp-8],dx
 47392                                  	;MOV	FilPtrH,DS
 47393 00008209 8C5EFA                  	mov	[bp-6],ds
 47394                                  	;MOV	EndPtrH,DS		; seg pointer to end of dir
 47395 0000820C 8C5EFE                  	mov	[bp-2],ds
 47396 0000820F 1E                      	PUSH	DS
 47397 00008210 07                      	POP	ES			; destination for nul search
 47398 00008211 89D7                    	MOV	DI,DX
 47399 00008213 89F9                    	MOV	CX,DI
 47400 00008215 F7D9                    	NEG	CX			; number of bytes remaining in segment
 47401                                  	; MSDOS 6.0
 47402 00008217 09C9                    	OR	CX,CX			;AN000;MS. cx=0 ? ds:dx on segment boundary
 47403 00008219 7501                    	JNZ	short okok		;AN000;MS. no
 47404                                  	;MOV	CX,-1			;AN000;MS.
 47405                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47406                                  	; 17/12/2022
 47407 0000821B 49                      	dec	cx  ; mov cx,-1
 47408                                  	;mov	cx,-1 ; 0FFFh
 47409                                  okok:					;AN000;
 47410 0000821C 31C0                    	XOR	AX,AX			;AN000;
 47411 0000821E F2AE                    	REPNZ	SCASB			;AN000;
 47412                                  					;AN000;
 47413 00008220 4F                      	DEC	DI			; point back to the null
 47414 00008221 268A45FF                	MOV	AL,[ES:DI-1]		; Get char before the NUL
 47415 00008225 E8EFDB                  	call	PATHCHRCMP		; Is it a path separator?
 47416 00008228 7403                    	JZ	short SETENDPTR		; Yes
 47417                                  STOREPTH:
 47418 0000822A B05C                    	MOV	AL,'\'
 47419 0000822C AA                      	STOSB				; Add a path separator (and INC DI)
 47420                                  SETENDPTR:
 47421                                  	;MOV	EndPtrL,DI		; pointer to the tail
 47422 0000822D 8856FC                  	mov	[bp-4],dl
 47423                                  CreateLoop:
 47424 00008230 16                      	push	ss			; let ReadTime see variables
 47425 00008231 1F                      	pop	ds
 47426 00008232 55                      	push	bp
 47427 00008233 E85089                  	call	READTIME		; go get time
 47428 00008236 5D                      	pop	bp
 47429                                  ;
 47430                                  ; Time is in CX:DX. Go drop it into the string.
 47431                                  ;
 47432                                  	;les	di,EndPtr		; point to the string
 47433 00008237 C47EFC                  	les	di,[BP-4]
 47434 0000823A 89C8                    	mov	ax,cx
 47435 0000823C E8A2FF                  	call	BinToAscii		; store upper word
 47436 0000823F 89D0                    	mov	ax,dx
 47437 00008241 E89DFF                  	call	BinToAscii		; store lower word
 47438 00008244 30C0                    	xor	al,al
 47439 00008246 AA                      	STOSB				; nul terminate
 47440                                  	;LDS	DX,FilPtr		; get name
 47441 00008247 C556F8                  	lds	dx,[bp-8]
 47442                                  	;MOV	CX,Attr 		; get attr
 47443 0000824A 8B4EF6                  	mov	cx,[bp-10]
 47444 0000824D 55                      	push	bp
 47445 0000824E E889FF                  	CALL	_$CreateNewFile		; try to create a new file
 47446 00008251 5D                      	pop	bp
 47447 00008252 732A                    	JNC	short CreateDone	; failed, go try again
 47448                                  
 47449                                  ; The operation failed and the error has been mapped in AX. Grab the extended
 47450                                  ; error and figure out what to do.
 47451                                  
 47452                                  	;; MSDOS 3.3			; M049 - start
 47453                                  ;;	mov	ax,[ss:EXTERR]				;smr;SS Override
 47454                                  ;;	cmp	al,error_file_exists
 47455                                  ;;	jz	short CreateLoop	; file existed => try with new name
 47456                                  ;;	cmp	al,error_access_denied
 47457                                  ;;	jz	short CreateLoop	; access denied (attr mismatch)
 47458                                  
 47459                                  	; MSDOS 6.0
 47460                                  	;cmp	al,50h
 47461 00008254 3C50                    	CMP	AL,error_file_exists	; Q: did file already exist
 47462 00008256 74D8                    	JZ	short CreateLoop	; Y: try again
 47463                                  	;cmp	al,5
 47464 00008258 3C05                    	CMP	AL,error_access_denied	; Q: was it access denied
 47465 0000825A 7521                    	JNZ	short SETTMPERR		; N: Error out
 47466                                  					; Y: Check to see if we got this due
 47467                                  					;    to the network drive. Note that
 47468                                  					;    the redir will set the exterr
 47469                                  					;    to error_cannot_make if this is 
 47470                                  					;    so.
 47471                                  ; 15/03/2024
 47472                                  %if 0
 47473                                  	CMP	byte [SS:EXTERR],error_net_access_denied ; M069
 47474                                  					; See if it's REALLY an att mismatch
 47475                                  	je	short SETTMPERR		; no, network error, stop
 47476                                  ;M070
 47477                                  ; If the user failed on an I24, we do not want to try again
 47478                                  ;
 47479                                  	cmp	byte [SS:EXTERR],error_FAIL_I24 ;User failed on I24? ;M070
 47480                                  	;je	short SETTMPERR		;yes, do not try again ;M070
 47481                                  
 47482                                  	;jmp	short CreateLoop	;attr mismatch, try again ;M070
 47483                                  	; 17/12/2022
 47484                                  	jne	short CreateLoop ; 10/06/2019 
 47485                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47486                                  	;jz	short SETTMPERR
 47487                                  	;jmp	short CreateLoop
 47488                                  %else
 47489                                  	; 15/03/2024 (PCDOS 7.1 IBMDOS.COM)
 47490                                  	;;;
 47491 0000825C 36A0[2403]              	mov	al,[ss:EXTERR]
 47492 00008260 3C41                    	cmp	al,41h			; error_net_access_denied
 47493 00008262 7419                    	je	short SETTMPERR
 47494 00008264 3C53                    	cmp	al,53h			; error_FAIL_I24
 47495 00008266 7415                    	je	short SETTMPERR
 47496 00008268 3C50                    	cmp	al,50h			; error_file_exists
 47497 0000826A 74C4                    	je	short CreateLoop
 47498 0000826C 36C43E[A205]            	les	di,[ss:THISCDS]
 47499 00008271 83FFFF                  	cmp	di,0FFFFh ; -1
 47500 00008274 74BA                    	je	short CreateLoop	; No CDS
 47501                                  	;;test	word [es:di+43h],8000h
 47502                                  	;test	word [es:di+curdir.flags],curdir_isnet
 47503 00008276 26F6454480              	test	byte [es:di+curdir.flags+1],(curdir_isnet>>8)
 47504 0000827B 75B3                    	jnz	short CreateLoop
 47505                                  	;;;
 47506                                  %endif
 47507                                  
 47508                                  ;;	MOV	AL,error_access_denied	; Return this "extended" error
 47509                                  					; M049 - end
 47510                                  SETTMPERR:
 47511 0000827D F9                      	STC
 47512                                  CreateDone:
 47513                                  	;Leave
 47514 0000827E 89EC                    	mov	sp,bp
 47515 00008280 5D                      	pop	bp
 47516 00008281 7203                    	JC	short CreateFail
 47517 00008283 E9E483                  	jmp	SYS_RET_OK		; success!
 47518                                  CreateFail:
 47519 00008286 E9EB83                  	jmp	SYS_RET_ERR
 47520                                  
 47521                                  ;   SetAttrib will set the search attribute (SAttrib) either to the normal
 47522                                  ;   (CH) or to the value in CL if the current system call is through
 47523                                  ;   serverdoscall.
 47524                                  ;
 47525                                  ;   Inputs:	fSharing == FALSE => set sattrib to CH
 47526                                  ;		fSharing == TRUE => set sattrib to CL
 47527                                  ;   Outputs:	none
 47528                                  ;   Registers changed:	CX
 47529                                  
 47530                                  SetAttrib:
 47531                                  	;test	byte [SS:FSHARING],-1		;smr;SS Override
 47532                                  	;jnz	short Set
 47533                                  	; 15/03/2024
 47534 00008289 36803E[7205]00          	cmp	byte [ss:FSHARING],0
 47535 0000828F 7502                    	jnz	short Set
 47536                                  
 47537 00008291 88E9                    	mov	cl,ch
 47538                                  Set:
 47539 00008293 36880E[6D05]            	mov	byte [ss:SATTRIB],cl		;smr;SS Override
 47540 00008298 C3                      	retn
 47541                                  
 47542                                  ;----------------------------------------------------------------------------
 47543                                  	; 16/03/2024 - Retro DOS v5.0
 47544                                  ext_inval2:
 47545                                  	;mov	al,1
 47546 00008299 B001                    	mov	al,error_invalid_function
 47547                                  eo_err:
 47548                                  	;jmp	SYS_RET_ERR
 47549 0000829B EBE9                    	jmp	short CreateFail
 47550                                  
 47551                                  ; 14/07/2018 - Retro DOS v3.0
 47552                                  ; MSDOS 6.0
 47553                                  
 47554                                  ; 29/04/2019 - Retro DOS v4.0
 47555                                  
 47556                                  ;Break	<Extended_Open- Extended open the file>
 47557                                  ;----------------------------------------------------------------------------
 47558                                  ; Input: AL= 0 reserved  AH=6CH
 47559                                  ;	 BX= mode
 47560                                  ;	 CL= create attribute  CH=search attribute (from server)
 47561                                  ;	 DX= flag
 47562                                  ;	 DS:SI = file name
 47563                                  ;	 ES:DI = parm list
 47564                                  ;			   DD  SET EA list (-1) null
 47565                                  ;			   DW  n  parameters
 47566                                  ;			   DB  type (TTTTTTLL)
 47567                                  ;			   DW  IOMODE
 47568                                  ; Function: Extended Open
 47569                                  ; Output: carry clear
 47570                                  ;		     AX= handle
 47571                                  ;		     CX=1 file opened
 47572                                  ;			2 file created/opened
 47573                                  ;			3 file replaced/opened
 47574                                  ;	  carry set: AX has error code
 47575                                  ;----------------------------------------------------------------------------
 47576                                  
 47577                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 47578                                  	; 16/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 47579                                  
 47580                                  _$Extended_Open:			  ;AN000;
 47581                                  	;ASSUME	CS:DOSCODE,SS:DOSDATA	  ;AN000;
 47582 0000829D 368916[F405]            	MOV	[SS:EXTOPEN_FLAG],DX	  ;AN000;EO. save ext. open flag;smr;SS Override
 47583 000082A2 36C706[F705]0000        	MOV	word [SS:EXTOPEN_IO_MODE],0 ;AN000;EO. initialize IO mode;smr;SS Override
 47584                                  	; 17/12/2022
 47585 000082A9 F6C6FE                  	test	dh,0FEh ; 04/12/2022 
 47586                                  	;;test	dx,0FE00h
 47587                                  	;TEST	DX,RESERVED_BITS_MASK	  ;AN000;EO. reserved bits 0 ?
 47588 000082AC 75EB                    	JNZ	short ext_inval2	  ;AN000;EO. no
 47589 000082AE 88D4                    	MOV	AH,DL			  ;AN000;EO. make sure flag is right
 47590 000082B0 80FA00                  	CMP	DL,0			  ;AN000;EO. all fail ?
 47591 000082B3 74E4                    	JZ	short ext_inval2	  ;AN000;EO. yes, error
 47592                                  	;and	dl,0Fh
 47593 000082B5 80E20F                  	AND	DL,EXISTS_MASK		  ;AN000;EO. get exists action byte
 47594 000082B8 80FA02                  	CMP	DL,2			  ;AN000;EO, > 2
 47595 000082BB 77DC                    	JA	short ext_inval2	  ;AN000;EO. yes, error
 47596                                  	;and	ah,0F0h
 47597 000082BD 80E4F0                  	AND	AH,NOT_EXISTS_MASK	  ;AN000;EO. get no exists action byte
 47598 000082C0 80FC10                  	CMP	AH,10H			  ;AN000;EO. > 10
 47599 000082C3 77D4                    	JA	short ext_inval2	  ;AN000;EO. yes, error
 47600                                  
 47601 000082C5 368C06[FB05]            	MOV	[SS:SAVE_ES],ES		  ;AN000;EO. save API parms;smr;SS Override
 47602 000082CA 36893E[F905]            	MOV	[SS:SAVE_DI],DI		  ;AN000;EO.;smr;SS Override
 47603 000082CF 36FF36[F405]            	PUSH	word [SS:EXTOPEN_FLAG]	  ;AN000;EO.;smr;SS Override
 47604 000082D4 368F06[FD05]            	POP	word [SS:SAVE_DX]	  ;AN000;EO.;smr;SS Override
 47605 000082D9 36890E[FF05]            	MOV	[SS:SAVE_CX],CX		  ;AN000;EO.;smr;SS Override
 47606 000082DE 36891E[0106]            	MOV	[SS:SAVE_BX],BX		  ;AN000;EO.;smr;SS Override
 47607 000082E3 368C1E[0506]            	MOV	[SS:SAVE_DS],DS		  ;AN000;EO.;smr;SS Override
 47608 000082E8 368936[0306]            	MOV	[SS:SAVE_SI],SI		  ;AN000;EO.;smr;SS Override
 47609 000082ED 89F2                    	MOV	DX,SI			  ;AN000;EO. ds:dx points to file name
 47610 000082EF 89D8                    	MOV	AX,BX			  ;AN000;EO. ax= mode
 47611                                  ; 16/03/2024
 47612                                  %if 0
 47613                                  	JMP	SHORT goopen2		  ;AN000;;EO. do normal
 47614                                  ext_inval2:				  ;AN000;;EO.
 47615                                  	;mov	al,1
 47616                                  	mov	al,error_invalid_function ;AN000;EO.. invalid function
 47617                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47618                                  eo_err:
 47619                                  	;jmp	SYS_RET_ERR
 47620                                  	jmp	short CreateFail
 47621                                  %endif
 47622                                  
 47623                                  ; 16/03/2024
 47624                                  %if 0
 47625                                  ext_inval_parm:				  ;AN000;EO..
 47626                                  	POP	CX			  ;AN000;EO..  pop up satck
 47627                                  	POP	SI			  ;AN000;EO..
 47628                                  	;error	error_invalid_data	  ;AN000;EO..  invalid parms
 47629                                  	;mov	al,13
 47630                                  	mov	al,error_invalid_data
 47631                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47632                                  	;;jmp	SYS_RET_ERR
 47633                                  	;jmp	short eo_err
 47634                                  	; 17/12/2022
 47635                                  	jmp	short CreateFail
 47636                                  %endif
 47637                                  
 47638                                  	; 17/12/2022	
 47639                                  ;error_return:				  ;AN000;EO.
 47640                                  ;	retn				  ;AN000;EO.. return with error
 47641                                  
 47642                                  goopen2:				  ;AN000;
 47643                                  	; 17/12/2022
 47644                                  	;test	bh,20h				 
 47645 000082F1 F6C720                  	test	bh,INT_24_ERROR>>8 ; 04/12/2022
 47646                                  	;;test	bx,2000h
 47647                                  	;TEST	BX,INT_24_ERROR		  ;AN000;EO.. disable INT 24 error ?
 47648 000082F4 7406                    	JZ	short goopen		  ;AN000;EO.. no
 47649                                  	;or	byte [SS:EXTOPEN_ON],2
 47650 000082F6 36800E[F605]02          	OR	byte [SS:EXTOPEN_ON],EXT_OPEN_I24_OFF ;AN000;EO.. set bit to disable;smr;SS Override
 47651                                  goopen:					  ;AN000;
 47652                                  	;or	byte [SS:EXTOPEN_ON],1 
 47653 000082FC 36800E[F605]01          	OR	byte [SS:EXTOPEN_ON],EXT_OPEN_ON  ;AN000;EO.. set Extended Open active;smr;SS Override
 47654                                  	;AND	word [SS:EXTOPEN_FLAG],0FFh  ;AN000;EO.create new ?;smr;SS Override
 47655                                  	; 18/12/2022
 47656 00008302 36C606[F505]00          	mov	byte [SS:EXTOPEN_FLAG+1],0 ; AND word [SS:EXTOPEN_FLAG],0FFh
 47657                                  	;cmp	word [SS:EXTOPEN_FLAG],10h
 47658 00008308 36833E[F405]10          	CMP	word [SS:EXTOPEN_FLAG],EXT_EXISTS_FAIL+EXT_NEXISTS_CREATE ;AN000;FT.;smr;SS Override
 47659 0000830E 7516                    	JNZ	short chknext 		  ;AN000;;EO. no
 47660 00008310 E8C7FE                  	call	_$CreateNewFile		  ;AN000;;EO. yes
 47661 00008313 723F                    	JC	short error_return	  ;AN000;;EO. error
 47662                                  
 47663 00008315 36803E[F605]00          	CMP	byte [SS:EXTOPEN_ON],0	  ;AN000;;EO. IFS does it;smr;SS Override
 47664 0000831B 7438                    	JZ	short ok_return2	  ;AN000;;EO. yes
 47665                                  	;mov	word [SS:EXTOPEN_FLAG],2
 47666 0000831D 36C706[F405]0200        	MOV	word [SS:EXTOPEN_FLAG],ACTION_CREATED_OPENED ;AN000;EO. created/opened;smr;SS Override
 47667 00008324 EB7F                    	JMP	short setXAttr ; 16/03/2024 ;AN000;;EO. set XAs
 47668                                  
 47669                                  	; 17/12/2022
 47670                                  ;ok_return2:
 47671                                  ;	jmp	SYS_RET_OK		  ;AN000;;EO.
 47672                                  
 47673                                  chknext:
 47674                                  	; 17/12/2022
 47675 00008326 36F606[F405]01          	test	byte [SS:EXTOPEN_FLAG],EXT_EXISTS_OPEN ; 1
 47676                                  	;;test	word [SS:EXTOPEN_FLAG],1
 47677                                  	;TEST	word [SS:EXTOPEN_FLAG],EXT_EXISTS_OPEN ;AN000;;EO. exists open;smr;SS Override
 47678 0000832C 752A                    	JNZ	short exist_open	  ;AN000;;EO. yes
 47679 0000832E E89DFD                  	call	_$CREAT			  ;AN000;;EO. must be replace open
 47680 00008331 7221                    	JC	short error_return	  ;AN000;;EO. return with error
 47681 00008333 36803E[F605]00          	CMP	byte [SS:EXTOPEN_ON],0	  ;AN000;;EO. IFS does it;smr;SS Override
 47682 00008339 741A                    	JZ	short ok_return2	  ;AN000;;EO. yes
 47683 0000833B 36C706[F405]0200        	MOV	word [SS:EXTOPEN_FLAG],ACTION_CREATED_OPENED ;AN000;EO. presume create/open;smr;SS Override
 47684 00008342 36F606[F605]04          	TEST	byte [SS:EXTOPEN_ON],EXT_FILE_NOT_EXISTS ;AN000;;EO. file not exists ?;smr;SS Override
 47685 00008348 755B                    	JNZ	short setXAttr		  ;AN000;;EO. no
 47686 0000834A 36C706[F405]0300        	MOV	word [SS:EXTOPEN_FLAG],ACTION_REPLACED_OPENED ;AN000;;EO. replaced/opened;smr;SS Override
 47687 00008351 EB52                    	JMP	SHORT setXAttr		  ;AN000;;EO. set XAs
 47688                                  error_return2:
 47689 00008353 F9                      	STC 				  ; Set Carry again to flag error ;AN001;
 47690                                  error_return:	 ; 17/12/2022
 47691 00008354 C3                      	retn				  ;AN000;;EO. return with error
 47692                                  
 47693                                  	; 17/12/2022
 47694                                  ok_return:
 47695                                  ok_return2:
 47696 00008355 E91283                  	jmp	SYS_RET_OK
 47697                                  
 47698                                  exist_open:				  ;AN000;
 47699                                  	;test	byte [SS:FSHARING],-1	  ;AN000;;EO. server doscall?;smr;SS Override
 47700                                  	;jz	short noserver		  ;AN000;;EO. no
 47701                                  	; 16/03/2024
 47702                                  	;;;
 47703 00008358 36803E[7205]00          	cmp	byte [ss:FSHARING],0	; server doscall?
 47704 0000835E 7402                    	jz	short noserver		; no
 47705                                  	;;;
 47706 00008360 88E9                    	MOV	CL,CH			  ;AN000;;EO. cl=search attribute
 47707                                  noserver:
 47708 00008362 E89AFC                  	call	_$Open2			  ;AN000;;EO. do open
 47709 00008365 732F                    	JNC	short ext_ok		  ;AN000;;EO.
 47710 00008367 36803E[F605]00          	CMP	byte [SS:EXTOPEN_ON],0	  ;AN000;;EO. error and IFS call;smr;SS Override
 47711 0000836D 74E4                    	JZ	short error_return2	  ;AN000;;EO. return with error
 47712                                  local_extopen:
 47713                                  	;cmp	ax,2
 47714 0000836F 83F802                  	CMP	AX,error_file_not_found   ;AN000;;EO. file not found error
 47715 00008372 75DF                    	JNZ	short error_return2	  ;AN000;;EO. no,
 47716                                  	;;test	word [SS:EXTOPEN_FLAG],10h
 47717                                  	; 17/12/2022
 47718 00008374 36F606[F405]10          	test	byte [SS:EXTOPEN_FLAG],EXT_NEXISTS_CREATE ; 10h
 47719                                  	;TEST	word [SS:EXTOPEN_FLAG],EXT_NEXISTS_CREATE ;AN000;;EO. want to fail;smr;SS Override
 47720                                  	;JNZ	short do_creat		  ;AN000;;EO. yes
 47721                                  	;JMP	short extexit 		  ;AN000;;EO. yes
 47722                                  	; 17/12/2022
 47723 0000837A 7446                    	jz	short extexit ; 10/06/2019
 47724                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47725                                  	;jnz	short do_creat
 47726                                  	;jmp	short extexit
 47727                                  do_creat:
 47728 0000837C 368B0E[FF05]            	MOV	CX,[SS:SAVE_CX]		  ;AN000;;EO. get ds:dx for file name;smr;SS Override
 47729 00008381 36C536[0306]            	LDS	SI,[SS:SAVE_SI]		  ;AN000;;EO. cx = attribute;smr;SS Override
 47730 00008386 89F2                    	MOV	DX,SI			  ;AN000;;EO.
 47731 00008388 E843FD                  	call	_$CREAT			  ;AN000;;EO. do create
 47732 0000838B 7235                    	JC	short extexit 		  ;AN000;;EO. error
 47733                                  	;mov	word [SS:EXTOPEN_FLAG],2
 47734 0000838D 36C706[F405]0200        	MOV	word [SS:EXTOPEN_FLAG],ACTION_CREATED_OPENED
 47735                                  					  ;AN000;;EO. is created/opened;smr;SS Override
 47736 00008394 EB0F                    	JMP	SHORT setXAttr		  ;AN000;;EO. set XAs
 47737                                  
 47738                                  ext_ok:
 47739 00008396 36803E[F605]00          	CMP	byte [SS:EXTOPEN_ON],0	  ;AN000;;EO. IFS call ?;smr;SS Override
 47740 0000839C 74B7                    	JZ	short ok_return		  ;AN000;;EO. yes
 47741                                  	;mov	word [SS:EXTOPEN_FLAG],1
 47742 0000839E 36C706[F405]0100        	MOV	word [SS:EXTOPEN_FLAG],ACTION_OPENED ;AN000;;EO. opened;smr;SS Override
 47743                                  setXAttr:
 47744                                  	; 29/04/2019
 47745 000083A5 50                      	push	ax
 47746 000083A6 E8CE80                  	call	Get_User_Stack		  ;AN000;;EO.
 47747 000083A9 36A1[F405]              	MOV	AX,[SS:EXTOPEN_FLAG]	  ;AN000;;EO.;smr;SS Override
 47748                                  	;mov	[si+4],ax
 47749 000083AD 894404                  	MOV	[SI+user_env.user_CX],AX  ;AN000;;EO. set action code for cx
 47750 000083B0 58                      	pop	ax			  ;AN000;;EO.
 47751 000083B1 8904                    	mov	[si],ax
 47752                                  	;MOV	[SI+user_env.user_AX],AX  ;AN000;;EO. set handle for ax
 47753                                  	; 17/12/2022
 47754 000083B3 EBA0                    	jmp	short ok_return
 47755                                  ;ok_return:				  ;AN000;
 47756                                  	;jmp	SYS_RET_OK		  ;AN000;;EO.
 47757                                  
 47758                                  ; 16/03/2024
 47759                                  %if 0
 47760                                  extexit2:				  ;AN000; ERROR RECOVERY
 47761                                  	POP	BX			  ;AN000;EO. close the handle
 47762                                  	PUSH	AX			  ;AN000;EO. save error code from set XA
 47763                                  	;cmp	word [SS:EXTOPEN_FLAG],2
 47764                                  	CMP	word [SS:EXTOPEN_FLAG],ACTION_CREATED_OPENED
 47765                                  					  ;AN000;EO. from create;smr;SS Override
 47766                                  	JNZ	short justopen		  ;AN000;EO.
 47767                                  	LDS	SI,[SS:SAVE_SI]		  ;AN000;EO. cx = attribute;smr;SS Override
 47768                                  	LDS	DX,[SI]			  ;AN000;EO.
 47769                                  	call	_$UNLINK 		  ;AN000;EO. delete the file
 47770                                  	JMP	SHORT reserror		  ;AN000;EO.
 47771                                  
 47772                                  justopen:				  ;AN000;
 47773                                  	call	_$CLOSE			  ;AN000;EO. pretend never happend
 47774                                  reserror:				  ;AN000;
 47775                                  	POP	AX			  ;AN000;EO. restore error code from set XA
 47776                                  
 47777                                  	JMP	SHORT extexit		  ;AN000;EO.
 47778                                  
 47779                                  ext_file_unfound:			  ;AN000;
 47780                                  	;mov	ax,2
 47781                                  	MOV	AX,error_file_not_found   ;AN000;EO.
 47782                                  	JMP	SHORT extexit		  ;AN000;EO.
 47783                                  ext_inval:				  ;AN000;
 47784                                  	;mov	ax,1
 47785                                  	MOV	AX,error_invalid_function ;AN000;EO.
 47786                                  
 47787                                  lockoperr:	; 17/12/2022
 47788                                  extexit:
 47789                                  	jmp	SYS_RET_ERR		  ;AN000;EO.
 47790                                  
 47791                                  %endif
 47792                                  
 47793                                  ;============================================================================
 47794                                  ; LOCK.ASM, MSDOS 6.0, 1991
 47795                                  ;============================================================================
 47796                                  ; 14/07/2018 - Retro DOS v3.0
 47797                                  ; 22/05/2019 - Retro DOS v4.0
 47798                                  
 47799                                  ;BREAK <$LockOper - Lock Calls>
 47800                                  ;----------------------------------------------------------------------------
 47801                                  ;
 47802                                  ;   Assembler usage:
 47803                                  ;	    MOV     BX, Handle	       (DOS 3.3)
 47804                                  ;	    MOV     CX, OffsetHigh
 47805                                  ;	    MOV     DX, OffsetLow
 47806                                  ;	    MOV     SI, LengthHigh
 47807                                  ;	    MOV     DI, LengthLow
 47808                                  ;	    MOV     AH, LockOper
 47809                                  ;	    MOV     AL, Request
 47810                                  ;	    INT     21h
 47811                                  ;
 47812                                  ;   Error returns:
 47813                                  ;	    AX = error_invalid_handle
 47814                                  ;	       = error_invalid_function
 47815                                  ;	       = error_lock_violation
 47816                                  ;
 47817                                  ;   Assembler usage:
 47818                                  ;	    MOV     AX, 5C??	       (DOS 4.00)
 47819                                  ;
 47820                                  ;				    0? lock all
 47821                                  ;				    8? lock write
 47822                                  ;				    ?2 lock multiple
 47823                                  ;				    ?3 unlock multiple
 47824                                  ;				    ?4 lock/read
 47825                                  ;				    ?5 write/unlock
 47826                                  ;				    ?6 add (lseek EOF/lock/write/unlock)
 47827                                  ;	    MOV     BX, Handle
 47828                                  ;	    MOV     CX, count or size
 47829                                  ;	    LDS     DX, buffer
 47830                                  ;	    INT     21h
 47831                                  ;
 47832                                  ;   Error returns:
 47833                                  ;	    AX = error_invalid_handle
 47834                                  ;	       = error_invalid_function
 47835                                  ;	       = error_lock_violation
 47836                                  ;
 47837                                  ;----------------------------------------------------------------------------
 47838                                  
 47839                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 47840                                  
 47841                                  	; 17/03/2024
 47842                                  	; 16/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 47843                                  
 47844                                  _$LockOper:
 47845 000083B5 3C01                    	CMP	AL,1
 47846 000083B7 770C                    	JA	short lock_bad_func
 47847                                  
 47848 000083B9 57                      	PUSH	DI			       ; Save LengthLow
 47849 000083BA E843F3                  	call	SFFromHandle		       ; ES:DI -> SFT
 47850 000083BD 731B                    	JNC	short lock_do 		       ; have valid handle
 47851 000083BF 5F                      	POP	DI			       ; Clean stack
 47852                                  	;mov	al,6
 47853 000083C0 B006                    	mov	al,error_invalid_handle
 47854                                  
 47855                                  	; 16/03/2024
 47856                                  extexit:
 47857                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47858                                  lockoperr:
 47859 000083C2 E9AF82                  	jmp	SYS_RET_ERR
 47860                                  	; 17/12/2022
 47861                                  	;jmp	short lockoperr ; jmp SYS_RET_ERR
 47862                                  
 47863                                  lock_bad_func:
 47864                                  
 47865                                  ; 16/03/2024
 47866                                  %if 0
 47867                                  	;mov	byte [ss:EXTERR_LOCUS],1
 47868                                  	MOV	byte [SS:EXTERR_LOCUS],errLOC_Unk ; Extended Error Locus;smr;SS Override
 47869                                  %else
 47870                                  	; 16/03/2024 (PCDOS 7.1 IBMDOS.COM)
 47871                                  	;;;
 47872 000083C5 E80D8F                  	call	set_exerr_locus_unk	 ; Extended Error Locus
 47873                                  	;;;
 47874                                  %endif
 47875                                  	;mov	al,1
 47876 000083C8 B001                    	mov	al,error_invalid_function
 47877                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47878                                  lockoperrj:
 47879                                  	;jmp	SYS_RET_ERR
 47880 000083CA EBF6                    	jmp	short lockoperr
 47881                                  
 47882                                  	; 22/05/2019 - Retro DOS v4.0
 47883                                  
 47884                                  	; MSDOS 6.0 
 47885                                  ; Align_buffer call has been deleted, since it corrupts the DTA (6/5/88) P5013
 47886                                  ; Dead code deleted, MD, 23 Mar 90
 47887                                  
 47888                                  ;lock_do:
 47889                                  ;	; MSDOS 3.3
 47890                                  ;	or	al,al
 47891                                  ;	pop	ax
 47892                                  ;	jz	short DOS_Lock
 47893                                  ;DOS_Unlock:
 47894                                  ;	;test	word [es:di+5],8000h
 47895                                  ;	test	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 47896                                  ;	JZ	short LOCAL_UNLOCK
 47897                                  ;	push    ax
 47898                                  ;	mov     ax,110Bh
 47899                                  ;	int     2Fh	; Multiplex - NETWORK REDIRECTOR - UNLOCK REGION OF FILE
 47900                                  ;			; BX = file handle, CX:DX = starting offset, SI = high word of size
 47901                                  ;			; STACK: WORD low word of size, ES:DI -> SFT for file
 47902                                  ;			; SFT DPB field -> DPB of drive containing file
 47903                                  ;			; Return: CF set error
 47904                                  ;	pop     bx
 47905                                  ;	jmp     short ValChk
 47906                                  ;
 47907                                  ;LOCAL_UNLOCK:
 47908                                  ;	Call	far [ss:JShare+(7*4)]	; 7 = clr_block ;smr;SS Override
 47909                                  ;ValChk:
 47910                                  ;	JNC	short Lock_OK
 47911                                  ;lockerror:
 47912                                  ;	jmp	SYS_RET_ERR
 47913                                  ;Lock_OK:
 47914                                  ;	;MOV	AX,[SS:Temp_VAR] ;AN000;;MS. AX= number of bytes ;smr;SS Override
 47915                                  ;	jmp	SYS_RET_OK
 47916                                  ;DOS_Lock:
 47917                                  ;	;test	word [es:di+5],8000h
 47918                                  ;	test	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 47919                                  ;	JZ	short LOCAL_LOCK
 47920                                  ;	;CallInstall NET_XLock,MultNET,10
 47921                                  ;	mov     ax, 110Ah
 47922                                  ;	int     2Fh	; Multiplex - NETWORK REDIRECTOR - LOCK REGION OF FILE
 47923                                  ;			; BX = file handle, CX:DX = starting offset, SI = high word of size
 47924                                  ;			; STACK: WORD low word of size, ES:DI -> SFT
 47925                                  ;			; SFT DPB field -> DPB of drive containing file, SS = DOS CS
 47926                                  ;			; Return: CF set error
 47927                                  ;	JMP	short ValChk
 47928                                  ;
 47929                                  ;LOCAL_LOCK:
 47930                                  ;	Call	far [ss:JShare+(6*4)]	; 6 = Set_Block ;smr;SS Override
 47931                                  ;	JMP	short ValChk
 47932                                  
 47933                                  ; 17/12/2022
 47934                                  LOCAL_UNLOCK:
 47935                                  	; MSDOS 3.3
 47936                                  	;Call	far [ss:JShare+(7*4)]	; 7 = clr_block ;smr;SS Override
 47937                                  	; MSDOS 6.0
 47938 000083CC FF1E[AC00]              	Call	far [JShare+(7*4)]	; 7 = clr_block ;smr;SS Override
 47939                                  ValChk:
 47940 000083D0 7302                    	JNC	short Lock_OK
 47941                                  lockerror:
 47942                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47943                                  	;;jmp	SYS_RET_ERR
 47944                                  	;jmp	short lockoperrj
 47945                                  	; 17/12/2022
 47946 000083D2 EBEE                    	jmp	short lockoperr	; jmp SYS_RET_ERR
 47947                                  Lock_OK:
 47948                                  	;MOV	AX,[SS:TEMP_VAR] ;AN000;;MS. AX= number of bytes ;smr;SS Override
 47949                                  	; 10/06/2019
 47950 000083D4 A1[0C06]                	mov	ax,[TEMP_VAR]
 47951 000083D7 E99082                  	jmp	SYS_RET_OK
 47952                                  
 47953                                  	; 22/05/2019
 47954                                  lock_do:
 47955                                  	; MSDOS 6.0
 47956 000083DA 89C3                    	MOV	BX,AX				; save AX
 47957 000083DC BD[A903]                	MOV	BP,Lock_Buffer			; get DOS LOCK buffer
 47958                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47959                                  	;;mov	[bp+0],dx
 47960                                  	;MOV	[BP+LockBuf.Lock_position],DX	; set low offset
 47961                                  	; 15/12/2022
 47962 000083DF 895600                  	mov	[bp],dx
 47963                                  	;mov	[bp+2],cx
 47964 000083E2 894E02                  	MOV	[BP+LockBuf.Lock_position+2],CX; set high offset
 47965                                  	
 47966                                  	; 16/03/2024
 47967                                  	;POP	CX				; get low length
 47968                                  	;;mov	[bp+4],cx
 47969                                  	;MOV	[BP+LockBuf.Lock_length],CX	; set low length
 47970 000083E5 8F4604                  	pop	word [bp+LockBuf.Lock_length]
 47971                                  
 47972                                  	;mov	[bp+6],si
 47973 000083E8 897606                  	MOV	[BP+LockBuf.Lock_length+2],SI	; set high length
 47974 000083EB B90100                  	MOV	CX,1				; one range
 47975                                  
 47976                                  ;	PUSH	CS				;
 47977                                  ;	POP	DS				; DS:DX points to
 47978                                  
 47979 000083EE 16                      	push	ss
 47980 000083EF 1F                      	pop	ds
 47981                                  
 47982 000083F0 89EA                    	MOV	DX,BP				; Lock_Buffer
 47983                                  	;test	al,1
 47984 000083F2 A801                    	TEST	AL,UNLOCK_ALL			; function 1
 47985                                  	;JNZ	short DOS_Unlock		; yes
 47986                                  	;JMP	short DOS_Lock			; function 0
 47987                                  	; 17/12/2022
 47988                                  	; 10/06/2019
 47989 000083F4 740E                    	jz	short DOS_Lock
 47990                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47991                                  	;JNZ	short DOS_Unlock
 47992                                  	;JMP	short DOS_Lock
 47993                                  
 47994                                  DOS_Unlock:
 47995                                  	;;test	word [es:di+5],8000h
 47996                                  	;test	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 47997 000083F6 26F6450680              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 47998 000083FB 74CF                    	JZ	short LOCAL_UNLOCK
 47999                                  
 48000                                  ; 17/03/2024
 48001                                  ;lock_unlock: ; 22/05/2019
 48002                                  
 48003                                  	;CallInstall Net_Xlock,MultNET,10
 48004                                  ;	
 48005                                  ;	; MSDOS 3.3
 48006                                  ;	;mov     ax,110Bh
 48007                                  ;	;int     2Fh	; Multiplex - NETWORK REDIRECTOR - UNLOCK REGION OF FILE
 48008                                  ;			; BX = file handle, CX:DX = starting offset, SI = high word of size
 48009                                  ;			; STACK: WORD low word of size, ES:DI -> SFT for file
 48010                                  ;			; SFT DPB field -> DPB of drive containing file
 48011                                  ;			; Return: CF set error
 48012                                  
 48013                                  ; 17/03/2024 - Retro DOS v5.0
 48014                                  lock_unlock:
 48015                                  
 48016                                  	; MSDOS 6.0
 48017 000083FD B80A11                  	mov     ax,110Ah
 48018 00008400 CD2F                    	int     2Fh 	; Multiplex - NETWORK REDIRECTOR - LOCK REGION OF FILE
 48019                                  			; BX = file handle, CX:DX = starting offset, SI = high word of size
 48020                                  			; STACK: WORD low word of size, ES:DI -> SFT
 48021                                  			; SFT DPB field -> DPB of drive containing file, SS = DOS CS
 48022                                  			; Return: CF set error
 48023                                  
 48024 00008402 EBCC                    	JMP	SHORT ValChk
 48025                                  
 48026                                  ; 17/12/2022
 48027                                  %if 0
 48028                                  LOCAL_UNLOCK:
 48029                                  	; MSDOS 3.3
 48030                                  	;Call	far [ss:JShare+(7*4)]	; 7 = clr_block ;smr;SS Override
 48031                                  	; MSDOS 6.0
 48032                                  	Call	far [JShare+(7*4)]	; 7 = clr_block ;smr;SS Override
 48033                                  ValChk:
 48034                                  	JNC	short Lock_OK
 48035                                  lockerror:
 48036                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48037                                  	;jmp	SYS_RET_ERR
 48038                                  	jmp	short lockoperrj
 48039                                  Lock_OK:
 48040                                  	;MOV	AX,[SS:TEMP_VAR] ;AN000;;MS. AX= number of bytes ;smr;SS Override
 48041                                  	; 10/06/2019
 48042                                  	mov	ax,[TEMP_VAR]
 48043                                  	jmp	SYS_RET_OK
 48044                                  %endif
 48045                                  
 48046                                  DOS_Lock:
 48047                                  	;;test	word [es:di+5],8000h
 48048                                  	;test	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 48049 00008404 26F6450680              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 48050                                  	;JZ	short LOCAL_LOCK
 48051                                  	; 17/03/2024
 48052 00008409 75F2                    	jnz	short lock_unlock
 48053                                  
 48054                                  ; 17/03/2024
 48055                                  %if 0
 48056                                  	;CallInstall NET_XLock,MultNET,10
 48057                                  
 48058                                  	mov     ax,110Ah
 48059                                  	int     2Fh	; Multiplex - NETWORK REDIRECTOR - LOCK REGION OF FILE
 48060                                  			; BX = file handle, CX:DX = starting offset, SI = high word of size
 48061                                  			; STACK: WORD low word of size, ES:DI -> SFT
 48062                                  			; SFT DPB field -> DPB of drive containing file, SS = DOS CS
 48063                                  			; Return: CF set error
 48064                                  
 48065                                  	JMP	short ValChk
 48066                                  %endif
 48067                                  
 48068                                  LOCAL_LOCK:
 48069                                  	; MSDOS 3.3
 48070                                  	;Call	far [ss:JShare+(6*4)]	; 6 = Set_Block ;smr;SS Override
 48071                                  	; MSDOS 6.0
 48072 0000840B FF1E[A800]              	Call	far [JShare+(6*4)]	; 6 = Set_Block ;smr;SS Override
 48073                                  
 48074 0000840F EBBF                    	JMP	short ValChk
 48075                                  
 48076                                  ; 14/07/2018 - Retro DOS v3.0
 48077                                  ; LOCK_CHECK
 48078                                  ;MSDOS 6.0 (& MSDOS 3.3)
 48079                                  
 48080                                  ;----------------------------------------------------------------------------
 48081                                  ; Inputs:
 48082                                  ;	Outputs of SETUP
 48083                                  ;	[USER_ID] Set
 48084                                  ;	[PROC_ID] Set
 48085                                  ; Function:
 48086                                  ;	Check for lock violations on local I/O
 48087                                  ;	Retries are attempted with sleeps in between
 48088                                  ; Outputs:
 48089                                  ;    Carry clear
 48090                                  ;	Operation is OK
 48091                                  ;    Carry set
 48092                                  ;	A lock violation detected
 48093                                  ; Outputs of SETUP preserved
 48094                                  ;----------------------------------------------------------------------------
 48095                                  
 48096                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 48097                                  	; 22/05/2019 - Retro DOS v4.0
 48098                                  LOCK_CHECK:
 48099 00008411 8B1E[1A00]              	MOV	BX,[RetryCount]	; Number retries
 48100                                  LockRetry:
 48101 00008415 53                      	push	bx		; save regs
 48102 00008416 50                      	push	ax ; MSDOS 6.0
 48103                                  
 48104                                  	;MSDOS 3.3
 48105                                  	;Call	far [ss:JShare+(8*4)]	; 8 = chk_block
 48106                                  	;MSDOS 6.0
 48107 00008417 FF1E[B000]              	Call	far [JShare+(8*4)]	; 8 = chk_block
 48108                                  
 48109 0000841B 58                      	pop	ax ; MSDOS 6.0
 48110 0000841C 5B                      	pop	bx		; restrore regs
 48111 0000841D 7307                    	jnc	short lc_ret_label ; There are no locks (retnc)
 48112                                  LockN:
 48113 0000841F E8BA93                  	call	Idle		; wait a while
 48114 00008422 4B                      	DEC	BX		; remember a retry
 48115 00008423 75F0                    	JNZ	short LockRetry	; more retries left...
 48116 00008425 F9                      	STC
 48117                                  lc_ret_label:
 48118 00008426 C3                      	retn
 48119                                  
 48120                                  ; 14/07/2018 - Retro DOS v3.0
 48121                                  ; LOCK_VIOLATION
 48122                                  ;MSDOS 6.0 (& MSDOS 3.3)
 48123                                  
 48124                                  ;----------------------------------------------------------------------------
 48125                                  ; Inputs:
 48126                                  ;	[THISDPB] set
 48127                                  ;	[READOP] indicates whether error on read or write
 48128                                  ; Function:
 48129                                  ;	Handle Lock violation on compatibility (FCB) mode SFTs
 48130                                  ; Outputs:
 48131                                  ;	Carry set if user says FAIL, causes error_lock_violation
 48132                                  ;	Carry clear if user wants a retry
 48133                                  ;
 48134                                  ; DS, ES, DI, CX preserved, others destroyed
 48135                                  ;----------------------------------------------------------------------------
 48136                                  
 48137                                  	; 19/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 48138                                  
 48139                                  LOCK_VIOLATION:
 48140 00008427 1E                      	PUSH	DS
 48141 00008428 06                      	PUSH	ES
 48142 00008429 57                      	PUSH	DI
 48143 0000842A 51                      	PUSH	CX
 48144                                  	;mov	ax,21h
 48145 0000842B B82100                  	MOV	AX,error_lock_violation
 48146                                  	;mov	byte [ALLOWED],18h
 48147 0000842E C606[4B03]18            	MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY
 48148 00008433 C42E[8A05]              	LES	BP,[THISDPB]
 48149 00008437 BF0100                  	MOV	DI,1		; Fake some registers
 48150 0000843A 89F9                    	MOV	CX,DI
 48151                                  
 48152                                  	; 19/03/2024 (PCDOS 7.1 IBMDOS.COM)
 48153                                  	;;;
 48154 0000843C 31D2                    	xor	dx,dx	; 0
 48155                                  	;cmp	[es:bp+0Fh],dx
 48156 0000843E 2639560F                	cmp	[es:bp+DPB.FAT_SIZE],dx ; 0 ?
 48157 00008442 750E                    	jnz	short lockv_1	; not FAT32
 48158                                  	; FAT32
 48159                                  	;mov	dx,[es:bp+2Bh]
 48160 00008444 268B562B                	mov	dx,[es:bp+DPB.FCLUS_FSECTOR+2]
 48161 00008448 8916[0706]              	mov	[HIGH_SECTOR],dx
 48162                                  	;mov	dx,[es:bp+29h]
 48163 0000844C 268B5629                	mov	dx,[es:bp+DPB.FCLUS_FSECTOR]
 48164 00008450 EB08                    	jmp	short lockv_2
 48165                                  lockv_1:
 48166 00008452 8916[0706]              	mov     [HIGH_SECTOR],dx ; 0
 48167                                  	;;;
 48168                                  
 48169                                  	;mov	dx,[es:bp+11]
 48170 00008456 268B560B                	MOV	DX,[ES:BP+DPB.FIRST_SECTOR]
 48171                                  lockv_2:	; 19/03/2024
 48172 0000845A E824DC                  	call	HARDERR
 48173 0000845D 59                      	POP	CX
 48174 0000845E 5F                      	POP	DI
 48175 0000845F 07                      	POP	ES
 48176 00008460 1F                      	POP	DS
 48177 00008461 3C01                    	CMP	AL,1
 48178 00008463 74C1                    	jz	short lc_ret_label ; 1 = retry, carry clear
 48179 00008465 F9                      	STC
 48180 00008466 C3                      	retn
 48181                                  
 48182                                  ; 14/07/2018 - Retro DOS v3.0
 48183                                  
 48184                                  ;----------------------------------------------------------------------------
 48185                                  
 48186                                  ;	do a retz to return error
 48187                                  
 48188                                  	; 22/05/2019 - Retro DOS v4.0
 48189                                  CheckShare:
 48190                                  	; MSDOS 3.3
 48191                                  	;cmp	byte [cs:fShare],0
 48192                                  	;retn
 48193                                  
 48194                                  	; MSDOS 6.0
 48195 00008467 1E                      	push	ds			;smr;
 48196                                  	;getdseg <ds>			; ds -> dosdata
 48197 00008468 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 48198 0000846D 803E[0303]00            	cmp	byte [fShare],0
 48199 00008472 1F                      	pop	ds			;smr;
 48200 00008473 C3                      	retn
 48201                                  	
 48202                                  ;============================================================================
 48203                                  ; SHARE.ASM, MSDOS 6.0, 1991
 48204                                  ;============================================================================
 48205                                  ; 14/07/2018 - Retro DOS v3.0
 48206                                  ; 22/05/2019 - Retro DOS v4.0
 48207                                  ; 19/03/2024 - Retro DOS v5.0
 48208                                  
 48209                                  ; SHARE_CHECK
 48210                                  ;----------------------------------------------------------------------------
 48211                                  ; Inputs:
 48212                                  ;       [THISSFT] Points to filled in local file/device SFT for new
 48213                                  ;               instance of file sf_mode ALWAYS has mode (even on FCB SFTs)
 48214                                  ;       [WFP_START] has full path of name
 48215                                  ;       [USER_ID] Set
 48216                                  ;       [PROC_ID] Set
 48217                                  ; Function:
 48218                                  ;       Check for sharing violations on local file/device access
 48219                                  ; Outputs:
 48220                                  ;    Carry clear
 48221                                  ;       Sharing approved
 48222                                  ;    Carry set
 48223                                  ;       A sharing violation detected
 48224                                  ;           AX is error code
 48225                                  ; USES    ALL but DS
 48226                                  ;----------------------------------------------------------------------------
 48227                                  
 48228                                  	; 22/05/2019 - Retro DOS v4.0
 48229                                  SHARE_CHECK:
 48230                                  	; 26/07/2019
 48231 00008474 FF1E[9400]              	call	far [JShare+(1*4)] 	; 1 = MFT_Enter
 48232                                  shchk_retn:
 48233 00008478 C3                      	retn
 48234                                  
 48235                                  ; SHARE_VIOLATION
 48236                                  ;----------------------------------------------------------------------------
 48237                                  ; Inputs:
 48238                                  ;       [THISDPB] Set
 48239                                  ;       AX has error code
 48240                                  ; Function:
 48241                                  ;       Handle Sharing errors
 48242                                  ; Outputs:
 48243                                  ;       Carry set if user says FAIL, causes error_sharing_violation
 48244                                  ;       Carry clear if user wants a retry
 48245                                  ;
 48246                                  ; DS, ES, DI preserved, others destroyed
 48247                                  ;----------------------------------------------------------------------------
 48248                                  
 48249                                  	; 19/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 48250                                  
 48251                                  SHARE_VIOLATION:
 48252 00008479 1E                      	PUSH	DS
 48253 0000847A 06                      	PUSH	ES
 48254 0000847B 57                      	PUSH	DI
 48255                                  	; 19/03/2024
 48256 0000847C 31D2                    	xor	dx,dx	; Retro DOS v5.0
 48257                                  	;
 48258                                  	;MOV	byte [READOP],0	; All share errors are reading
 48259 0000847E 8816[7505]              	mov	[READOP],dl ; 0
 48260                                  	;		
 48261                                  	;mov	byte [ALLOWED],18h
 48262 00008482 C606[4B03]18            	MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY
 48263 00008487 C42E[8A05]              	LES	BP,[THISDPB]
 48264 0000848B BF0100                  	MOV	DI,1			; Fake some registers
 48265 0000848E 89F9                    	MOV	CX,DI
 48266                                  	
 48267                                  	; 19/03/2024
 48268                                  	;;mov	dx,[es:bp+17]
 48269                                  	;MOV	DX,[ES:BP+DPB.DIR_SECTOR]
 48270                                  
 48271                                  	; 19/03/2024 - Retro DOS v5.0
 48272                                  	; PCDOS 7.1 IBMDOS.COM
 48273                                  	;;;
 48274                                   	;cmp	word [es:bp+0Fh],0
 48275 00008490 2639560F                	cmp	word [es:bp+DPB.FAT_SIZE],dx ; 0
 48276 00008494 740A                    	jz	short sharev_1 ; FAT32
 48277                                  	; FAT16 or FAT12
 48278                                  	;mov	word [HIGH_SECTOR],0
 48279 00008496 8916[0706]              	mov	[HIGH_SECTOR],dx ; 0
 48280                                  	;mov	dx,[es:bp+11h]
 48281 0000849A 268B5611                	mov	dx,[es:bp+DPB.DIR_SECTOR]
 48282 0000849E EB0C                    	jmp     short sharev_2
 48283                                  sharev_1:
 48284                                  	;mov	dx,[es:bp+2Bh]
 48285 000084A0 268B562B                	mov	dx,[es:bp+DPB.FCLUS_FSECTOR+2]
 48286 000084A4 8916[0706]              	mov	[HIGH_SECTOR],dx
 48287                                  	;mov	dx,[es:bp+29h]
 48288 000084A8 268B5629                	mov	dx,[es:bp+DPB.FCLUS_FSECTOR]
 48289                                  sharev_2: 
 48290                                  	;;;
 48291 000084AC E8D2DB                  	call	HARDERR
 48292 000084AF 5F                      	POP	DI
 48293 000084B0 07                      	POP	ES
 48294 000084B1 1F                      	POP	DS
 48295 000084B2 3C01                    	CMP	AL,1
 48296 000084B4 74C2                    	jz	short shchk_retn	; 1 = retry, carry clear
 48297 000084B6 F9                      	STC
 48298 000084B7 C3                      	retn
 48299                                  
 48300                                  ;----------------------------------------------------------------------------
 48301                                  ;   ShareEnd - terminate sharing info on a particular SFT/UID/PID. This does
 48302                                  ;       NOT perform a close, it merely asserts that the sharing information
 48303                                  ;       for the SFT/UID/PID may be safely released.
 48304                                  ;
 48305                                  ;   Inputs:     ES:DI points to an SFT
 48306                                  ;   Outputs:    None
 48307                                  ;   Registers modified: all except DS,ES,DI
 48308                                  ;----------------------------------------------------------------------------
 48309                                  
 48310                                  ShareEnd:
 48311                                  	; 26/07/2019
 48312 000084B8 FF1E[9800]              	call	far [JShare+(2*4)]	; 2 = MFTClose
 48313 000084BC C3                      	retn
 48314                                  
 48315                                  ;Break <ShareEnter - attempt to enter a node into the sharing set>
 48316                                  ;----------------------------------------------------------------------------
 48317                                  ;   ShareEnter - perform a retried entry of a nodde into the sharing set. If
 48318                                  ;   the max number of retries is exceeded, we notify the user via int 24.
 48319                                  ;
 48320                                  ;   Inputs:     ThisSFT points to the SFT
 48321                                  ;               WFP_Start points to the WFP
 48322                                  ;   Outputs:    Carry clear => successful entry
 48323                                  ;               Carry set => failed system call
 48324                                  ;   Registers modified: all
 48325                                  ;----------------------------------------------------------------------------
 48326                                  
 48327                                  ShareEnter:
 48328 000084BD 51                      	push	cx
 48329                                  retry:
 48330 000084BE 8B0E[1A00]              	mov     cx,[RetryCount]
 48331                                  attempt:
 48332 000084C2 C43E[9E05]              	les     di,[THISSFT]		; grab sft
 48333 000084C6 31C0                    	XOR     AX,AX
 48334                                   	;mov	[es:di+51],ax
 48335 000084C8 26894533                	MOV     [ES:DI+SF_ENTRY.sf_MFT],AX ; indicate free SFT
 48336 000084CC 51                      	push	cx
 48337 000084CD E8A4FF                  	call    SHARE_CHECK             ; attempt to enter into the sharing set
 48338 000084D0 59                      	pop	cx
 48339 000084D1 730A                    	jnc	short done		; success, let the user see this
 48340 000084D3 E80693                  	call	Idle                    ; wait a while
 48341 000084D6 E2EA                    	loop    attempt                 ; go back for another attempt
 48342 000084D8 E89EFF                  	call    SHARE_VIOLATION         ; signal the problem to the user
 48343 000084DB 73E1                    	jnc	short retry		; user said to retry, go do it
 48344                                  done:
 48345 000084DD 59                      	pop	cx
 48346 000084DE C3                      	retn
 48347                                  
 48348                                  ;============================================================================
 48349                                  ; EXEPATCH.ASM (MSDOS 6.0, 1991)
 48350                                  ;============================================================================
 48351                                  ; 29/04/2019 - Retro DOS 4.0
 48352                                  ; 20/03/2024 - Retro DOS 5.0
 48353                                  
 48354                                  ;** EXEPATCH.ASM 
 48355                                  ;----------------------------------------------------------------------------
 48356                                  ;	Contains the foll:
 48357                                  ;
 48358                                  ;		- code to find and overlay buggy unpack code
 48359                                  ;		- new code to be overlayed on buggy unpack code 
 48360                                  ;		- old code sequence to identify buggy unpack code
 48361                                  ;
 48362                                  ;	Revision history:
 48363                                  ;
 48364                                  ;		Created: 5/14/90
 48365                                  ;----------------------------------------------------------------------------
 48366                                  
 48367                                  ;----------------------------------------------------------------------------
 48368                                  ;
 48369                                  ; M020 : Fix for rational bug - for details see routine header
 48370                                  ; M028 : 4b04 implementation
 48371                                  ; M030 : Fixing bug in EXEPACKPATCH (EXEC_CS is an un-relocated value)
 48372                                  ; M032 : set turnoff bit only if DOS in HMA.
 48373                                  ; M033 : if IP < 2 then not exepacked.
 48374                                  ; M046 : support for a 4th version of exepacked files.
 48375                                  ; M068 : support for copy protected apps.
 48376                                  ; M071 : use A20OFF_COUNT of 10.
 48377                                  ;
 48378                                  ;----------------------------------------------------------------------------
 48379                                  
 48380                                  PATCH1_COM_OFFSET	EQU	06CH
 48381                                  PATCH1_OFFSET		EQU	028H
 48382                                  PATCH1_CHKSUM		EQU	0EF4EH
 48383                                  CHKSUM1_LEN		EQU	11CH/2 ; 142
 48384                                  
 48385                                  PATCH2_COM_OFFSET	EQU	076H
 48386                                  PATCH2_OFFSET		EQU	032H
 48387                                  
 48388                                  	; The strings that start at offset 076h have two possible 
 48389                                  	; check sums that are defined as PATCH2_CHKSUM PATCH2A_CHKSUM
 48390                                  
 48391                                  PATCH2_CHKSUM		EQU	78B2H
 48392                                  CHKSUM2_LEN		EQU	119H/2
 48393                                  PATCH2A_CHKSUM		EQU	1C47H		; M046
 48394                                  CHKSUM2A_LEN		EQU	103H/2		; M046
 48395                                  
 48396                                  PATCH3_COM_OFFSET	EQU	074H
 48397                                  PATCH3_OFFSET		EQU	032H
 48398                                  PATCH3_CHKSUM		EQU	4EDEH
 48399                                  CHKSUM3_LEN		EQU	117H/2
 48400                                  
 48401                                  ;**	Data structure passed for ExecReady call
 48402                                  ;
 48403                                  ;struc ERStruc
 48404                                  ; .ER_Reserved:	resw	1	; reserved, should be zero
 48405                                  ; .ER_Flags:	resw	1
 48406                                  ; .ER_ProgName:	resd	1	; ptr to ASCIIZ str of prog name
 48407                                  ; .ER_PSP:	resw	1	; PSP of the program
 48408                                  ; .ER_StartAddr: resd	1	; Start CS:IP of the program
 48409                                  ; .ER_ProgSize:	resd	1	; Program size including PSP
 48410                                  ; .size:
 48411                                  ;endstruc
 48412                                  
 48413                                  ;DOSCODE SEGMENT
 48414                                  
 48415                                  	; 22/05/2019 - Retro DOS v4.0
 48416                                  	; DOSCODE:B3DDh (MSDOS 6.21, MSDOS.SYS)
 48417                                  
 48418                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 48419                                  	; DOSCODE:B37Ah (MSDOS 5.0, MSDOS.SYS)
 48420                                  
 48421                                  	; 20/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 48422                                  	; DOSCODE:C697h (PCDOS 7.1, IBMDOS.COM)
 48423                                  
 48424                                  ; M028 - BEGIN
 48425                                  
 48426                                  ;--------------------------------------------------------------------------
 48427                                  ;
 48428                                  ;	Procedure Name		: ExecReady
 48429                                  ;
 48430                                  ;	Input			: DS:DX -> ERStruc (see exe.inc)
 48431                                  ;
 48432                                  ;--------------------------------------------------------------------------
 48433                                  
 48434                                  ExecReady:
 48435 000084DF 89D6                    	mov	si,dx			; move the pointer into a friendly one
 48436                                  	;;test	word [si+2],1
 48437                                  	; 17/12/2022
 48438 000084E1 F6440201                	test	byte [si+ERStruc.ER_Flags],ER_EXE ; 1
 48439                                  	;test	word [si+ERStruc.ER_Flags],ER_EXE ; COM or EXE ?
 48440 000084E5 7418                    	jz	short er_setver		; only setver for .COM files
 48441                                  
 48442                                  	;mov	ax,[si+8]
 48443 000084E7 8B4408                  	mov	ax,[si+ERStruc.ER_PSP]
 48444 000084EA 83C010                  	add	ax,10h
 48445 000084ED 8EC0                    	mov	es,ax
 48446                                  
 48447                                  	;mov	cx,[si+10]
 48448 000084EF 8B4C0A                  	mov	cx,[si+ERStruc.ER_StartAddr]   ; M030
 48449                                  	;mov	cx,[si+12]
 48450 000084F2 8B440C                  	mov	ax,[si+ERStruc.ER_StartAddr+2] ; M030
 48451                                  
 48452                                  	;call	[ss:FixExePatch]
 48453 000084F5 36FF16[670D]            	call	word [ss:FixExePatch] ; 28/12/2022
 48454                                  	
 48455                                  	; 20/03/2024
 48456                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48457 000084FA 36FF16[3E13]            	call	word [ss:Rational386PatchPtr]
 48458                                  
 48459                                  er_setver:
 48460                                  	;;test	word [si+2],2		; Q: is this an overlay
 48461                                  	; 17/12/2022
 48462 000084FF F6440202                	test	byte [si+ERStruc.ER_Flags],ER_OVERLAY ; 2
 48463                                  	;test	word [si+ERStruc.ER_Flags],ER_OVERLAY
 48464 00008503 7518                    	jnz	short er_chkdoshi	; Y: set A20OFF_COUNT if DOS high
 48465                                  					; N: set up lie version first
 48466 00008505 1E                      	push	ds
 48467 00008506 56                      	push	si
 48468                                  	;lds	si,[si+4]
 48469 00008507 C57404                  	lds	si,[si+ERStruc.ER_ProgName]
 48470 0000850A E8D2EC                  	call	Scan_Execname1
 48471 0000850D E8E3EC                  	call	Scan_Special_Entries
 48472 00008510 5E                      	pop	si
 48473 00008511 1F                      	pop	ds
 48474                                  	;mov	es,[si+8]
 48475 00008512 8E4408                  	mov	es,[si+ERStruc.ER_PSP]
 48476 00008515 36A1[BB0E]              	mov	ax,[ss:SPECIAL_VERSION]
 48477 00008519 26A34000                	mov	[es:PDB.Version],ax
 48478                                  
 48479                                  er_chkdoshi:
 48480 0000851D 36803E[660D]00          	cmp	byte [ss:DosHasHMA],0	; M032: Q: is dos in HMA (M021)
 48481 00008523 741F                    	je	short er_done		; M032: N: done
 48482                                  
 48483                                  					; M068 - Start
 48484                                  	;mov	ax,[si+8]
 48485 00008525 8B4408                  	mov	ax,[si+ERStruc.ER_PSP]	; ax = PSP
 48486                                  
 48487                                  	;or	byte [ss:DOS_FLAG],4
 48488 00008528 36800E[8600]04          	or	byte [ss:DOS_FLAG],EXECA20OFF ; Set bit to signal int 21
 48489                                  					; ah = 25 & ah= 49. See dossym.inc 
 48490                                  					; under TAG M003 & M009 for 
 48491                                  					; explanation
 48492                                  	;;test	word [si+2],1
 48493                                  	; 17/12/2022
 48494 0000852E F6440201                	test	byte [si+ERStruc.ER_Flags],ER_EXE ; 1
 48495                                  	;test	word [si+ERStruc.ER_Flags],ER_EXE ; Q: COM file
 48496 00008532 7507                    	jnz	short er_setA20		; N: inc a20off_count, set 
 48497                                  					;    a20off_psp and ret
 48498 00008534 1E                         	push	ds
 48499 00008535 8ED8                    	mov	ds,ax			; DS = load segment of com file.
 48500 00008537 E8AD05                  	call	IsCopyProt		; check if copy protected
 48501 0000853A 1F                      	pop	ds
 48502                                  
 48503                                  er_setA20:
 48504                                  	; We need to inc the A20OFF_COUNT here. Note that if the count
 48505                                  	; is non-zero at this point it indicates that the A20 is to be 
 48506                                  	; turned off for that many int 21 calls made by the app. In 
 48507                                  	; addition the A20 has to be turned off when we exit from this 
 48508                                  	; call. Hence the inc.
 48509                                  
 48510 0000853B 36FE06[8500]            	inc	byte [ss:A20OFF_COUNT]		
 48511 00008540 36A3[6300]              	mov	[ss:A20OFF_PSP],ax	; set the PSP for which A20 is to be
 48512                                  					; turned OFF.
 48513                                  er_done:				; M068 - End
 48514 00008544 31C0                    	xor	ax,ax
 48515 00008546 C3                      	retn
 48516                                  
 48517                                  ; M028 - END
 48518                                  
 48519                                  ; 20/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 48520                                  ;%if 1
 48521                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 48522                                  ;%if 0
 48523                                  
 48524                                  ;----------------------------------------------------------------------------
 48525                                  ;
 48526                                  ; procedure : Rational386Patch
 48527                                  ;
 48528                                  ; Older versions of the Rational DOS Extender have several bugs which trash
 48529                                  ; 386 registers (usually just the high word of 32 bit registers) during
 48530                                  ; interrupt processing. Lotus 123 3.1+ is a popular application that uses a
 48531                                  ; version of the Rational extender with the 32 bit register trashing bugs.
 48532                                  ;
 48533                                  ; This routine applies patches to the Rational DOS Extender to work around
 48534                                  ; most of the register trashing bugs.
 48535                                  ;
 48536                                  ; Note that there are additional register trashing bugs not fixed by these
 48537                                  ; patches. In particular, the high word of ESP and the FS and GS registers
 48538                                  ; may be modified on interrupts.
 48539                                  ;
 48540                                  ; There are two different Rational DOS Extender patchs in this module.
 48541                                  ; Rational386Patch is to correct 386 register trashing bugs on 386 or later
 48542                                  ; processors. This patch code is executed when MS-DOS is running on a 386
 48543                                  ; or later processor, regardless of whether MS-DOS is running in the HMA
 48544                                  ; or not.
 48545                                  ;
 48546                                  ; The other Rational patch routine (RationalPatch, below) fixes a register
 48547                                  ; trashing problem on 286 processors, and is only executed if MS-DOS is
 48548                                  ; running in the HMA.
 48549                                  ;
 48550                                  ; This patch detection and replacement is based on an example supplied by
 48551                                  ; Ben Williams at Rational.
 48552                                  ;
 48553                                  ;----------------------------------------------------------------------------
 48554                                  
 48555                                  ; 22/05/2019 - Retro DOS v4.0
 48556                                  ; DOSCODE:B448h (MSDOS 6.21, MSDOS.SYS)
 48557                                  
 48558                                  ;----------------------------------------------------------------------------
 48559                                  ;
 48560                                  ; INPUT : ES = segment where program got loaded
 48561                                  ;
 48562                                  ;----------------------------------------------------------------------------
 48563                                  
 48564                                  rpFind1:
 48565 00008547 FAE4216033C0E6438B-     	db	0FAh, 0E4h, 21h, 60h, 33h, 0C0h, 0E6h, 43h, 8Bh, 16h
 48565 00008550 16                 
 48566                                  
 48567                                  rpFind1Len equ	$ - rpFind1
 48568                                  
 48569                                  ;	cli
 48570                                  ;	in	al, 21h
 48571                                  ;	pusha
 48572                                  ;	xor	ax, ax
 48573                                  ;	out	43h, al
 48574                                  ;	mov	dx, ...
 48575                                  
 48576                                  rpFind1a:
 48577 00008551 B00EE63733C0E6F2        	db	0B0h, 0Eh, 0E6h, 37h, 33h, 0C0h, 0E6h, 0F2h
 48578                                  
 48579                                  rpFind1aLen equ	$ - rpFind1a
 48580                                  
 48581                                  ;	mov	al, 0Eh
 48582                                  ;	out	37h, al
 48583                                  ;	xor	ax, ax
 48584                                  ;	out	0F2h, al
 48585                                  
 48586                                  ; bug # 1 -- loss of high EAX on 386+ if not VCPI or DPMI
 48587                                  
 48588                                  rpFind2:
 48589 00008559 0F20C0                  	db	0Fh, 20h, 0C0h
 48590                                  
 48591                                  rpFind2Len equ	$ - rpFind2
 48592                                  
 48593                                  ;	mov	eax, cr0	;may be preceeded by PUSH CX (51h)
 48594                                  
 48595                                  rpFind3:
 48596 0000855C 0F22C0EA                	db	0Fh, 22h, 0C0h, 0EAh
 48597                                  
 48598                                  rpFind3Len equ	$ - rpFind3
 48599                                  
 48600                                  ;	mov	cr0, eax	;may be preceeded by POP CX (59h)
 48601                                  ;	jmp	far ptr xxx	;change far ptr to go to replace3
 48602                                  ;	mov	ss, bx		;8E D3 ... and come back at or after this
 48603                                  
 48604                                  ; note, there is no rpRepl1 string
 48605                                  
 48606                                  rpRepl2:
 48607 00008560 6650510F20C0             	db	66h, 50h, 51h, 0Fh, 20h, 0C0h
 48608                                  
 48609                                  rpRepl2Len equ	$ - rpRepl2
 48610                                  
 48611                                  ;	push	eax
 48612                                  ;	push	cx
 48613                                  ;	mov	eax, cr0
 48614                                  
 48615                                  rpRepl3:
 48616 00008566 8ED3596658              	db	8Eh, 0D3h, 59h, 66h, 58h
 48617                                  
 48618                                  rpRepl3Len equ	$ - rpRepl3
 48619                                  
 48620                                  ;	mov	ss, bx
 48621                                  ;	pop	cx
 48622                                  ;	pop	eax
 48623                                  
 48624                                  ; bug # 2 -- loss of high EAX and ESI on 386+ only if VCPI
 48625                                  
 48626                                  rpFind4:
 48627 0000856B 93588BCC                	db	93h, 58h, 8Bh, 0CCh
 48628                                  
 48629                                  rpFind4Len equ	$ - rpFind4
 48630                                  
 48631                                  ;	xchg	bx, ax
 48632                                  ;	pop	ax
 48633                                  ;	mov	cx, sp
 48634                                  
 48635                                  rpFind5:
 48636 0000856F B80CDECD678BE1FFE3      	db	0B8h, 0Ch, 0DEh, 0CDh, 67h, 8Bh, 0E1h, 0FFh, 0E3h
 48637                                  
 48638                                  rpFind5Len equ	$ - rpFind5
 48639                                  
 48640                                  ;	mov	ax, DE0Ch
 48641                                  ;	int	67h
 48642                                  ;	mov	sp, cx
 48643                                  ;	jmp	bx
 48644                                  
 48645                                  rpRepl4:
 48646 00008578 93588BCC                	db	93h, 58h, 8Bh, 0CCh
 48647 0000857C 2E66A3                  	db	02Eh, 066h, 0A3h
 48648                                  
 48649                                  rpRepl4o1Len equ $ - rpRepl4
 48650                                  
 48651 0000857F 0000                    	db	00h, 00h
 48652 00008581 2E668936                	db	02Eh, 066h, 89h, 36h
 48653                                  
 48654                                  rpRepl4o2Len equ $ - rpRepl4
 48655                                  
 48656 00008585 0000                    	db	00h, 00h
 48657                                  
 48658                                  rpRepl4Len equ	$ - rpRepl4
 48659                                  
 48660                                  ;	xchg	bx, ax
 48661                                  ;	pop	ax
 48662                                  ;	mov	cx, sp
 48663                                  ;	mov	dword ptr cs:[xxxx], eax
 48664                                  ;	mov	dword ptr cs:[xxxx], esi
 48665                                  
 48666                                  rpRepl5:
 48667 00008587 8BE1                    	db	8Bh, 0E1h
 48668 00008589 2E66A1                  	db	2Eh, 66h, 0A1h
 48669                                  
 48670                                  rpRepl5o1Len equ $ - rpRepl5
 48671                                  
 48672 0000858C 0000                    	db	00h, 00h
 48673 0000858E 2E668B36                	db	2Eh, 66h, 8Bh, 36h
 48674                                  
 48675                                  rpRepl5o2Len equ $ - rpRepl5
 48676                                  
 48677 00008592 0000                    	db	00h, 00h
 48678 00008594 FFE3                    	db	0FFh, 0E3h
 48679                                  
 48680                                  rpRepl5Len equ	$ - rpRepl5
 48681                                  
 48682                                  ;	mov	sp, cx
 48683                                  ;	mov	eax, dword ptr cs:[xxxx]
 48684                                  ;	mov	esi, dword ptr cs:[xxxx]
 48685                                  ;	jmp	bx
 48686                                  
 48687                                  ; bug # 3 -- loss of high EAX, EBX, ECX, EDX on 386+ only if VCPI
 48688                                  
 48689                                  rpFind6:
 48690 00008596 FA5251                  	db	0FAh, 52h, 51h
 48691                                  
 48692                                  rpFind6Len equ	$ - rpFind6
 48693                                  
 48694                                  ;	cli
 48695                                  ;	push	dx
 48696                                  ;	push	cx
 48697                                  
 48698                                  rpFind7a:
 48699 00008599 B80CDE6626FF1E          	db	0B8h, 0Ch, 0DEh, 66h, 26h, 0FFh, 1Eh
 48700                                  
 48701                                  rpFind7aLen equ	$ - rpFind7a
 48702                                  
 48703                                  ;	mov	ax, 0DE0Ch
 48704                                  ;	call	fword ptr es:[xxxx]
 48705                                  
 48706                                  rpFind7b:
 48707 000085A0 595A5B                  	db	59h, 5Ah, 5Bh
 48708                                  
 48709                                  rpFind7bLen equ	$ - rpFind7b
 48710                                  
 48711                                  ;	pop	cx
 48712                                  ;	pop	dx
 48713                                  ;	pop	bx
 48714                                  
 48715                                  rpRepl6:
 48716 000085A3 FA6650665366516652      	db	0FAh, 66h, 50h, 66h, 53h, 66h, 51h, 66h, 52h
 48717                                  
 48718                                  rpRepl6Len equ	$ - rpRepl6
 48719                                  
 48720                                  ;	cli
 48721                                  ;	push	eax
 48722                                  ;	push	ebx
 48723                                  ;	push	ecx
 48724                                  ;	push	edx
 48725                                  
 48726                                  rpRepl7:
 48727 000085AC 665A6659665B66585B      	db	66h, 5Ah, 66h, 59h, 66h, 5Bh, 66h, 58h, 5Bh
 48728                                  
 48729                                  rpRepl7Len equ	$ - rpRepl7
 48730                                  
 48731                                  ;	pop	edx
 48732                                  ;	pop	ecx
 48733                                  ;	pop	ebx
 48734                                  ;	pop	eax
 48735                                  ;	pop	bx
 48736                                  
 48737                                  ; bug # 4 -- loss of high EAX and EBX on 386+ only if VCPI
 48738                                  
 48739                                  rpFind8:
 48740 000085B5 60061EB800008ED8         	db	60h, 06h, 1Eh, 0B8h, 00h, 00h, 8Eh, 0D8h
 48741                                  
 48742                                  rpFind8Len equ	$ - rpFind8
 48743                                  
 48744                                  ;	pusha
 48745                                  ;	push	es
 48746                                  ;	push	ds
 48747                                  ;	mov	ax, dgroup	;jump back to here from replace8
 48748                                  ;	mov	ds, ax
 48749                                  
 48750                                  rpFind9 :
 48751 000085BD 1F0761                  	db	1Fh, 07h, 61h
 48752                                  
 48753                                  rpFind9Len equ	$ - rpFind9
 48754                                  
 48755                                  ;	pop	ds
 48756                                  ;	pop	es
 48757                                  ;	popa
 48758                                  
 48759                                  rpRepl8:
 48760 000085C0 6660061E                 	db	66h, 60h, 06h, 1Eh
 48761                                  
 48762                                  rpRepl8Len equ	$ - rpRepl8
 48763                                  
 48764                                  ;	pushad
 48765                                  ;	push	es
 48766                                  ;	push	ds
 48767                                  
 48768                                  rpRepl9:
 48769 000085C4 1F076661C3              	db	1Fh, 07h, 66h, 61h, 0C3h
 48770                                  
 48771                                  rpRepl9Len equ	$ - rpRepl9
 48772                                  
 48773                                  ;	pop	ds
 48774                                  ;	pop	es
 48775                                  ;	popad
 48776                                  ;	retn			;no need to jmp back to main-line
 48777                                  
 48778                                  ;----------------------------------------------------------------------------
 48779                                  
 48780                                  struc SearchPair
 48781 00000000 ????                     .sp_off1: resw 1	; offset of 1st search string
 48782 00000002 ????                     .sp_len1: resw 1	; length of 1st search string
 48783 00000004 ????                     .sp_off2: resw 1	; 2nd string
 48784 00000006 ????                     .sp_len2: resw 1	; 2nd string
 48785 00000008 ????                     .sp_diff: resw 1	; max difference between offsets
 48786                                   .size:
 48787                                  endstruc
 48788                                  
 48789                                  ;rpBug1Strs SearchPair	<offset rpFind2, rpFind2Len, offset rpFind3, rpFind3Len, 20h>
 48790                                  
 48791                                  rpBug1Strs:
 48792 000085C9 [5985]                  	dw	rpFind2
 48793 000085CB 0300                    	dw	rpFind2Len ; 3
 48794 000085CD [5C85]                  	dw	rpFind3
 48795 000085CF 0400                    	dw	rpFind3Len ; 4
 48796 000085D1 2000                    	dw	20h
 48797                                  
 48798                                  ;rpBug2Strs SearchPair	<offset rpFind4, rpFind4Len, offset rpFind5, rpFind5Len, 80h>
 48799                                  
 48800                                  rpBug2Strs:
 48801 000085D3 [6B85]                  	dw	rpFind4
 48802 000085D5 0400                    	dw	rpFind4Len ; 4
 48803 000085D7 [6F85]                  	dw	rpFind5
 48804 000085D9 0900                    	dw	rpFind5Len ; 9
 48805 000085DB 8000                    	dw	80h
 48806                                  
 48807                                  ;rpBug3Strs SearchPair	<offset rpFind6, rpFind6Len, offset rpFind7a, rpFind7aLen, 80h>
 48808                                  
 48809                                  rpBug3Strs:
 48810 000085DD [9685]                  	dw	rpFind6
 48811 000085DF 0300                    	dw	rpFind6Len ; 3
 48812 000085E1 [9985]                  	dw	rpFind7a
 48813 000085E3 0700                    	dw	rpFind7aLen ; 7
 48814 000085E5 8000                    	dw	80h
 48815                                  
 48816                                  ;rpBug4Strs SearchPair	<offset rpFind8, 4, offset rpFind9, rpFind9Len, 80h>
 48817                                  
 48818                                  rpBug4Strs:
 48819 000085E7 [B585]                  	dw	rpFind8
 48820 000085E9 0400                    	dw	rpRepl8Len ; 4	; 20/03/2024
 48821 000085EB [BD85]                  	dw	rpFind9
 48822 000085ED 0300                    	dw	rpFind9Len ; 3
 48823 000085EF 8000                    	dw	80h
 48824                                  
 48825                                  ;----------------------------------------------------------------------------
 48826                                  
 48827                                  struc StackVars
 48828 00000000 ????                     .sv_wVersion:	resw 1		; Rational extender version #
 48829 00000002 ????                     .sv_cbCodeSeg: resw 1		; code seg size to scan
 48830 00000004 ????                     .sv_pPatch:	resw 1		; offset of next avail patch byte
 48831                                   .size:
 48832                                  endstruc
 48833                                  
 48834                                  ;----------------------------------------------------------------------------
 48835                                  
 48836                                  ; 22/05/2019 - Retro DOS v4.0
 48837                                  
 48838                                  Rational386Patch:
 48839                                  	; Do a few quick checks to see if this looks like a Rational
 48840                                  	; Extended application. Hopefully this will quickly weed out
 48841                                  	; most non Rational apps.
 48842                                  
 48843 000085F1 26813E00008B01          	cmp	word [es:0],395		; version number goes here - versions
 48844 000085F8 7322                    	jae	short rp3QuickOut	;   3.95+ don't need patching
 48845                                  
 48846 000085FA 26833E0C0020            	cmp	word [es:0Ch],20h	; always has this value here
 48847 00008600 751A                    	jne	short rp3QuickOut
 48848                                  
 48849 00008602 50                      	push	ax ; *
 48850                                  
 48851 00008603 B81800                  	mov	ax,18h 			; extender has 18h at
 48852 00008606 2639061800              	cmp	[es:24],ax		;   offsets 24, 28, & 36
 48853 0000860B 750E                    	jne	short rp3QO_ax
 48854 0000860D 2639061C00              	cmp	[es:28],ax
 48855 00008612 7507                    	jne	short rp3QO_ax
 48856 00008614 2639062400              	cmp	[es:36],ax
 48857 00008619 7402                    	je	short rp3Maybe
 48858                                  rp3QO_ax:
 48859 0000861B 58                      	pop	ax
 48860                                  rp3QuickOut:
 48861 0000861C C3                      	retn
 48862                                  
 48863                                  ; It might be the rational extender, do more extensive checking
 48864                                  
 48865                                  rp3Maybe:
 48866 0000861D FC                      	cld
 48867                                  
 48868                                  ; 20/03/2024
 48869                                  %if 0
 48870                                  	push	bx			; note ax pushed above
 48871                                  	push	cx
 48872                                  	push	dx
 48873                                  	push	si
 48874                                  	push	di
 48875                                  	push	es
 48876                                  	push	ds			; we use all of them
 48877                                  	push	bp
 48878                                  %else
 48879                                  	; 20/03/2024 (PCDOS 7.1 IBMDOS.COM)
 48880                                  	;;;
 48881 0000861E 60                      	pusha
 48882 0000861F 06                      	push	es
 48883 00008620 1E                      	push	ds
 48884                                  	;;;	
 48885                                  %endif
 48886 00008621 83EC06                  	sub	sp,StackVars.size  ; 6	; make space for stack variables
 48887 00008624 89E5                    	mov	bp,sp
 48888                                  
 48889 00008626 0E                      	push	cs
 48890 00008627 1F                      	pop	ds
 48891                                  
 48892 00008628 26A10000                	mov	ax,[es:0]		; save version #
 48893                                  	;mov	[bp+StackVars.sv_wVersion],ax
 48894 0000862C 894600                  	mov	[bp],ax	
 48895                                  					; check that binary version # matches
 48896 0000862F E89901                  	call	VerifyVersion		;   ascii string
 48897 00008632 7521                    	jne	short rp3Exit_j
 48898                                  
 48899                                  ; Looks like this is it, find where to put the patch code.  The
 48900                                  ; patch will be located on top of Rational code specific to 80286
 48901                                  ; processors, so these patchs MUST NOT be applied if running on
 48902                                  ; an 80286 system.
 48903                                  
 48904                                  	; Rational says the code to patch will never be beyond offset 46xxh
 48905                                  
 48906 00008634 B90045                  	mov	cx,4500h		; force search len to 4700h (searches
 48907                                  	;mov	[bp+2],cx
 48908 00008637 894E02                  	mov	[bp+StackVars.sv_cbCodeSeg],cx	; start at offset 200h)
 48909                                  
 48910 0000863A 268E062000              	mov	es,[es:20h]		; es=code segment
 48911                                  
 48912 0000863F BE[4785]                	mov	si,rpFind1		; string to find
 48913 00008642 BA0A00                  	mov	dx,rpFind1Len ; 10	; length to match
 48914 00008645 E86B01                  	call	ScanCodeSeq		; look for code seq
 48915 00008648 740E                    	jz	short rpGotPatch
 48916                                  
 48917                                  ; According to Rational, some very old versions of the extender may not
 48918                                  ; have the find1 code sequence. If the find1 code wasn't found above,
 48919                                  ; try an alternative patch area which is on top of NEC 98xx switching code.
 48920                                  
 48921 0000864A BE[5185]                	mov	si,rpFind1a
 48922 0000864D BA0800                  	mov	dx,rpFind1aLen  ;8
 48923 00008650 E86001                  	call	ScanCodeSeq
 48924 00008653 7403                    	jz	short rpGotPatch
 48925                                  
 48926                                  rp3Exit_j:
 48927 00008655 E9FE00                  	jmp	rp3Exit
 48928                                  
 48929                                  ; Found the location to write patch code! DI = offset in code seg.
 48930                                  
 48931                                  rpGotPatch:
 48932                                  	;mov	[bp+4],di
 48933 00008658 897EFC                  	mov	[bp-StackVars.sv_pPatch],di	; save patch pointer
 48934                                  
 48935                                  ;----------------------------------------------------------------------------
 48936                                  ; Bug # 1 -- loss of high EAX on 386+ if not VCPI or DPMI
 48937                                  
 48938                                  	;cmp	word [bp+0],381
 48939                                  	;cmp	word [bp+StackVars.sv_wVersion],381 ; only need bug 1 if version
 48940 0000865B 817E007D01              	cmp	word [bp],381
 48941 00008660 7348                    	jae	short rpBug2			;   < 3.81
 48942                                  
 48943 00008662 BB[C985]                	mov	bx,rpBug1Strs			; locate find2 & find3 code
 48944 00008665 E8F600                  	call	FindBadCode
 48945 00008668 7240                    	jc	short rpBug2
 48946                                  
 48947                                  ; si = rpFind2 offset, di = rpFind3 offset
 48948                                  
 48949 0000866A 57                      	push	di
 48950 0000866B 89F7                    	mov	di,si				; rpFind2 offset
 48951 0000866D BA0300                  	mov	dx,rpFind2Len ; 3
 48952                                  
 48953 00008670 26807DFF51              	cmp	byte [es:di-1],51h	 	; find2 preceeded by push cx?
 48954 00008675 7502                    	jne	short rp_no_cx
 48955                                  
 48956 00008677 4F                      	dec	di				;   yes, gobble up push cx too
 48957 00008678 42                      	inc	dx
 48958                                  rp_no_cx:
 48959 00008679 BE[6085]                	mov	si,rpRepl2			; patch out find2 sequence
 48960 0000867C B90600                  	mov	cx,rpRepl2Len  ; 6
 48961 0000867F E80501                  	call	GenPatch
 48962                                  
 48963 00008682 5F                      	pop	di				; rpFind3 offset
 48964 00008683 26807DFF59              	cmp	byte [es:di-1],59h 		; find3 preceeded by pop cx?
 48965 00008688 7505                    	jne	short rp_no_cx2
 48966                                  
 48967 0000868A 26C645FF90              	mov	byte [es:di-1],90h		;   yes, no-op it
 48968                                  rp_no_cx2:
 48969                                  	;mov	ax,[bp+4]
 48970 0000868F 8B4604                  	mov	ax,[bp+StackVars.sv_pPatch]	; change offset of far jmp
 48971                                  	;mov	[es:di+4],ax
 48972 00008692 26894504                	mov	[es:di+rpFind3Len],ax		;   to go to patch code
 48973                                  
 48974 00008696 57                      	push	di				; save find3 offset
 48975 00008697 BE[6685]                	mov	si,rpRepl3			; copy repl3 to patch area
 48976 0000869A B90500                  	mov	cx,rpRepl3Len ; 5
 48977 0000869D E8FB00                  	call	CopyPatch
 48978                                  
 48979 000086A0 5B                      	pop	bx				; find3 offset
 48980 000086A1 83C308                  	add	bx,rpFind3Len+4	 ; 8		; skip over find3 and far jmp
 48981 000086A4 E80001                  	call	GenJump 			; jmp back from patch area
 48982                                  	;mov	[bp+4],di
 48983 000086A7 897E04                  	mov	[bp+StackVars.sv_pPatch], di	;   to main-line, update patch
 48984                                  						;   area pointer
 48985                                  
 48986                                  ;----------------------------------------------------------------------------
 48987                                  ; Bug # 2 -- loss of high regs on 386+ under VCPI only
 48988                                  
 48989                                  rpBug2:
 48990 000086AA BB[D385]                	mov	bx,rpBug2Strs			; locate find4 & find5 code
 48991 000086AD E8AE00                  	call	FindBadCode
 48992 000086B0 7242                    	jc	short rpBug3
 48993                                  
 48994                                  ; si = rpFind4 offset, di = rpFind5 offset
 48995                                  
 48996                                  	;push	word [bp+4]
 48997 000086B2 FF7604                  	push	word [bp+StackVars.sv_pPatch]	; save current patch pointer
 48998                                  						;   (where repl4 goes)
 48999 000086B5 57                      	push	di				; save find5 offset
 49000                                  
 49001 000086B6 89F7                    	mov	di,si
 49002 000086B8 BA0400                  	mov	dx,rpFind4Len ; 4
 49003 000086BB BE[7885]                	mov	si,rpRepl4
 49004 000086BE B90F00                  	mov	cx,rpRepl4Len ; 15
 49005 000086C1 E8C300                  	call	GenPatch			; patch out find4 code
 49006                                  
 49007 000086C4 5F                      	pop	di				; find5 offset
 49008 000086C5 83C705                  	add	di,5				; keep 5 bytes of find5 code
 49009                                  	;mov	bx,[bp+4]
 49010 000086C8 8B5E04                  	mov	bx,[bp+StackVars.sv_pPatch]	; jump to patch area
 49011 000086CB 53                      	push	bx				; save repl5 location
 49012 000086CC E8D800                  	call	GenJump
 49013                                  
 49014 000086CF BE[8785]                	mov	si,rpRepl5			; copy repl5 code to patch
 49015 000086D2 B90F00                  	mov	cx,rpRepl5Len  ; 15		;   area -- it has a jmp bx
 49016 000086D5 E8C300                  	call	CopyPatch			;   so no need to jmp back to
 49017                                  						;   main-line code
 49018                                  
 49019                                  ; patches have been made, now update the patch code to store/load dwords just
 49020                                  ; after the code in the patch area
 49021                                  
 49022 000086D8 5F                      	pop	di				; repl5 location
 49023 000086D9 5E                      	pop	si				; repl4 location
 49024                                  
 49025                                  	;mov	ax,[bp+4]
 49026 000086DA 8B4604                  	mov	ax,[bp+StackVars.sv_pPatch]	; (where dwords go)
 49027                                  
 49028                                  	;mov	[es:si+7],ax
 49029 000086DD 26894407                	mov	[es:si+rpRepl4o1Len],ax		; offset for EAX
 49030                                  	;mov	[es:di+5],ax
 49031 000086E1 26894505                	mov	[es:di+rpRepl5o1Len],ax
 49032 000086E5 83C004                  	add	ax,4
 49033                                  	;mov	[es:si+0Dh],ax
 49034 000086E8 2689440D                	mov	[es:si+rpRepl4o2Len],ax		; offset for ESI
 49035                                  	;mov	[es:di+0Bh],ax
 49036 000086EC 2689450B                	mov	[es:di+rpRepl5o2Len],ax
 49037                                  
 49038                                  	;add	word [bp+4],8
 49039 000086F0 83460408                	add	word [bp+StackVars.sv_pPatch],8	; reserve space for 2 dwords in
 49040                                  						; patch area
 49041                                  
 49042                                  ;----------------------------------------------------------------------------
 49043                                  ; Bug # 3 -- loss of high regs on 386+ under VCPI only
 49044                                  
 49045                                  rpBug3:
 49046 000086F4 BB[DD85]                	mov	bx,rpBug3Strs			; locate find6 & find7a code
 49047 000086F7 E86400                  	call	FindBadCode
 49048 000086FA 722C                    	jc	short rpBug4
 49049                                  
 49050                                  	;add	di,9
 49051 000086FC 83C709                  	add	di,rpFind7aLen + 2		; skip over offset in find7a
 49052 000086FF 56                      	push	si				;   code and locate find7b
 49053 00008700 BE[A085]                	mov	si,rpFind7b			;   sequence
 49054 00008703 BA0300                  	mov	dx,rpFind7bLen ; 3
 49055 00008706 E8AD00                  	call	ScanCodeSeq_di
 49056 00008709 5E                      	pop	si
 49057 0000870A 751C                    	jnz	short rpBug4
 49058                                  
 49059 0000870C 57                      	push	di				; save find7b code offset
 49060                                  
 49061 0000870D 89F7                    	mov	di,si
 49062 0000870F BA0300                  	mov	dx,rpFind6Len ; 3
 49063 00008712 BE[A385]                	mov	si,rpRepl6
 49064 00008715 B90900                  	mov	cx,rpRepl6Len ; 9
 49065 00008718 E86C00                  	call	GenPatch			; patch out find6 code
 49066                                  
 49067 0000871B 5F                      	pop	di
 49068 0000871C BA0300                  	mov	dx,rpFind7bLen ; 3
 49069 0000871F BE[AC85]                	mov	si,rpRepl7
 49070 00008722 B90900                  	mov	cx,rpRepl7Len ; 9
 49071 00008725 E85F00                  	call	GenPatch			; patch out find7b code
 49072                                  
 49073                                  ;----------------------------------------------------------------------------
 49074                                  ; Bug # 4 -- loss of high regs on 386+ under VCPI only
 49075                                  
 49076                                  rpBug4:
 49077                                  	;cmp	word [bp+0],360
 49078                                  	;cmp	word [bp+StackVars.sv_wVersion],360 ; only applies if 
 49079 00008728 817E006801              	cmp	word [bp],360
 49080 0000872D 7627                    	jbe	short rp3Exit 			; version > 3.60 and < 3.95
 49081                                  
 49082 0000872F BB[E785]                	mov	bx,rpBug4Strs			; locate find8 & find9 code
 49083 00008732 E82900                  	call	FindBadCode
 49084 00008735 721F                    	jc	short rp3Exit
 49085                                  
 49086 00008737 57                      	push	di				; save find9 code offset
 49087                                  
 49088 00008738 89F7                    	mov	di,si
 49089 0000873A BA0300                  	mov	dx,3
 49090 0000873D BE[C085]                	mov	si,rpRepl8
 49091 00008740 B90400                  	mov	cx,rpRepl8Len ; 4
 49092 00008743 E84100                  	call	GenPatch			; patch out find8 code
 49093                                  
 49094 00008746 5F                      	pop	di				; find9 offset
 49095                                  	;mov	bx,[bp+4]
 49096 00008747 8B5E04                  	mov	bx,[bp+StackVars.sv_pPatch]	; patch find9 to jmp to
 49097 0000874A E85A00                  	call	GenJump 			;   patch area
 49098                                  
 49099 0000874D BE[C485]                	mov	si,rpRepl9			; copy replacement code to
 49100 00008750 B90500                  	mov	cx,rpRepl9Len ; 5		;   patch area--it does a RET
 49101 00008753 E84500                  	call	CopyPatch			;   so no jmp back to main-line
 49102                                  
 49103                                  rp3Exit:
 49104 00008756 83C406                  	add	sp,StackVars.size
 49105                                  
 49106                                  ; 20/03/2024
 49107                                  %if 0
 49108                                  	pop	bp
 49109                                  	pop	ds
 49110                                  	pop	es
 49111                                  	pop	di
 49112                                  	pop	si
 49113                                  	pop	dx
 49114                                  	pop	cx
 49115                                  	pop	bx
 49116                                  %else
 49117                                  	; 20/03/2024 (PCDOS 7.1 IBMDOS.COM)
 49118                                  	;;;
 49119 00008759 1F                      	pop	ds
 49120 0000875A 07                      	pop	es
 49121 0000875B 61                      	popa
 49122                                  	;;;
 49123                                  %endif
 49124 0000875C 58                      	pop	ax ; *
 49125 0000875D C3                      	retn
 49126                                  
 49127                                  ;----------------------------------------------------------------------------
 49128                                  ;
 49129                                  ; FindBadCode
 49130                                  ;
 49131                                  ; Searches Rational code segment looking for a pair of find strings (all
 49132                                  ; patches have at least two find strings).
 49133                                  ;
 49134                                  ; Entry:
 49135                                  ;	ES    = code segment to search
 49136                                  ;	DS:BX = search pair structure for this search
 49137                                  ;	[bp].sv_cbCodeSeg = length of code seg to search
 49138                                  ;
 49139                                  ; Exit:
 49140                                  ;	CY flag clear if both strings found, and
 49141                                  ;	SI    = offset in ES of 1st string
 49142                                  ;	DI    = offset in ES of 2nd string
 49143                                  ;	CY set if either string not found, or strings too far apart
 49144                                  ;
 49145                                  ; Used:
 49146                                  ;	CX
 49147                                  ;
 49148                                  ;----------------------------------------------------------------------------
 49149                                  
 49150                                  ;struc SearchPair
 49151                                  ; .sp_off1: resw 1	; offset of 1st search string
 49152                                  ; .sp_len1: resw 1	; length of 1st search string
 49153                                  ; .sp_off2: resw 1	; 2nd string
 49154                                  ; .sp_len2: resw 1	; 2nd string
 49155                                  ; .sp_diff: resw 1	; max difference between offsets
 49156                                  ; .size:
 49157                                  ;endstruc
 49158                                  
 49159                                  FindBadCode:
 49160                                  	;mov	cx,[bp+2]
 49161 0000875E 8B4E02                  	mov	cx,[bp+StackVars.sv_cbCodeSeg]	; search length
 49162                                  
 49163 00008761 8B37                    	mov	si,[bx]	; mov si,[bx+0]
 49164                                  	;mov	si,[bx+Searchpair.sp_off1] ; ds:si -> search string
 49165                                  	
 49166                                  	;mov	dx,[bx+2]
 49167 00008763 8B5702                  	mov	dx,[bx+SearchPair.sp_len1] ; dx = search len
 49168 00008766 E84A00                  	call	ScanCodeSeq
 49169 00008769 751A                    	jnz	short fbc_error		; done if 1st not found
 49170                                  
 49171 0000876B 57                      	push	di			; save 1st string offset
 49172                                  
 49173                                  	;mov	si,[bx+4]
 49174 0000876C 8B7704                  	mov	si,[bx+SearchPair.sp_off2]
 49175                                  	;mov	dx,[bx+6]
 49176 0000876F 8B5706                  	mov	dx,[bx+SearchPair.sp_len2]
 49177 00008772 E84100                  	call	ScanCodeSeq_di		; don't change flags after this!
 49178                                  
 49179 00008775 5E                      	pop	si			; restore 1st string offset
 49180 00008776 750D                    	jnz	short fbc_error
 49181                                  
 49182 00008778 89F8                    	mov	ax,di			; sanity check that
 49183 0000877A 29F0                    	sub	ax,si			;   si < di && di - si <= allowed diff
 49184 0000877C 7207                    	jc	short fbc_error
 49185                                  	;cmp	ax,[bx+8]
 49186 0000877E 3B4708                  	cmp	ax,[bx+SearchPair.sp_diff]
 49187 00008781 7702                    	ja	short fbc_error
 49188                                  
 49189 00008783 F8                      	clc
 49190 00008784 C3                      	retn
 49191                                  
 49192                                  fbc_error:
 49193 00008785 F9                      	stc
 49194 00008786 C3                      	retn
 49195                                  
 49196                                  ;----------------------------------------------------------------------------
 49197                                  ;
 49198                                  ; GenPatch
 49199                                  ;
 49200                                  ; Generate a patch sequence. 1) insert a jump at the buggy code location
 49201                                  ; (jumps to the patch code area), 2) copy the selected patch code to the
 49202                                  ; patch area, 3) insert a jump from the patch area back to the main-line
 49203                                  ; code.
 49204                                  ;
 49205                                  ; Entry:
 49206                                  ;	ES:DI = start of buggy code to be patched
 49207                                  ;	DX    = length of buggy code to be patched
 49208                                  ;	DS:SI = replacement patch code
 49209                                  ;	CX    = length of replacement patch code
 49210                                  ;	[bp].sv_pPatch = offset in ES of where to copy patch code
 49211                                  ;
 49212                                  ; Exit:
 49213                                  ;	DI, [bp].sv_pPatch = byte after generated patch code
 49214                                  ;
 49215                                  ; Used:
 49216                                  ;	AX, BX, SI, Flags
 49217                                  ;
 49218                                  ;----------------------------------------------------------------------------
 49219                                  
 49220                                  GenPatch:
 49221 00008787 57                      	push	di			;save offset of buggy code
 49222                                  
 49223                                  	;mov	bx,[bp+4]
 49224 00008788 8B5E04                  	mov	bx,[bp+StackVars.sv_pPatch]
 49225                                  					;jump from buggy code to patch area
 49226 0000878B E81900                  	call	GenJump
 49227                                  
 49228 0000878E E80A00                  	call	CopyPatch		;copy replacement code to patch area
 49229                                  
 49230 00008791 5B                      	pop	bx			;offset of buggy code + buggy code
 49231 00008792 01D3                    	add	bx,dx			;  length = return from patch offset
 49232                                  
 49233 00008794 E81000                  	call	GenJump 		;jump from patch area back to main-
 49234                                  	;mov	[bp+4],di
 49235 00008797 897E04                  	mov	[bp+StackVars.sv_pPatch],di
 49236                                  					;  line code, update patch pointer
 49237 0000879A C3                      	retn
 49238                                  
 49239                                  ;----------------------------------------------------------------------------
 49240                                  ;
 49241                                  ; CopyPatch
 49242                                  ;
 49243                                  ; Copies patch code to patch location.
 49244                                  ;
 49245                                  ; Entry:
 49246                                  ;	DS:SI = patch code to be copied
 49247                                  ;	ES    = segment of code to patch
 49248                                  ;	CX    = length of code to copy
 49249                                  ;	[bp].sv_pPatch = offset in ES of where to copy patch code
 49250                                  ;
 49251                                  ; Exit:
 49252                                  ;	DI, [bp].sv_pPatch = byte after copied patch code
 49253                                  ;
 49254                                  ; Used:
 49255                                  ;	SI, Flags
 49256                                  ;
 49257                                  ;----------------------------------------------------------------------------
 49258                                  
 49259                                  CopyPatch:
 49260 0000879B 51                      	push	cx
 49261                                  	;mov	di,[bp+4]
 49262 0000879C 8B7E04                  	mov	di,[bp+StackVars.sv_pPatch] ;patch pointer is the dest offset
 49263 0000879F FC                      	cld
 49264 000087A0 F3A4                    	rep movsb
 49265 000087A2 59                      	pop	cx
 49266                                  	;mov	[bp+4],di
 49267 000087A3 897E04                  	mov	[bp+StackVars.sv_pPatch],di ;update net pointer location
 49268 000087A6 C3                      	retn
 49269                                  
 49270                                  ;----------------------------------------------------------------------------
 49271                                  ;
 49272                                  ; GenJump
 49273                                  ;
 49274                                  ; Generates a rel16 JMP instruction at location 'from' to location 'to'.
 49275                                  ;
 49276                                  ; Entry:
 49277                                  ;	ES:DI = from location (where to put jmp instruction)
 49278                                  ;	BX    = to location (where to jump to)
 49279                                  ;
 49280                                  ; Exit:
 49281                                  ;	DI = byte after generated jump
 49282                                  ;
 49283                                  ; Used:
 49284                                  ;	AX
 49285                                  ;
 49286                                  ;----------------------------------------------------------------------------
 49287                                  
 49288                                  GenJump:
 49289 000087A7 B0E9                    	mov	al,0E9h		; jmp rel16 opcode
 49290 000087A9 AA                      	stosb
 49291                                  
 49292 000087AA 89D8                    	mov	ax,bx		; calc offset to 'to' location
 49293 000087AC 29F8                    	sub	ax,di
 49294 000087AE 83E802                  	sub	ax,2
 49295                                  
 49296 000087B1 AB                      	stosw			; output offset
 49297                                  
 49298 000087B2 C3                      	retn
 49299                                  
 49300                                  ;----------------------------------------------------------------------------
 49301                                  ;
 49302                                  ; ScanCodeSeq
 49303                                  ;
 49304                                  ; Looks for a pattern pointed to by DS:SI & len DX in ES:200 to ES:200+CX-1
 49305                                  ;
 49306                                  ; returns in ES:DI the start of the pattern if Zero flag is set
 49307                                  ;
 49308                                  ;----------------------------------------------------------------------------
 49309                                  
 49310                                  ScanCodeSeq:
 49311 000087B3 BF0002                  	mov	di,200h
 49312                                  ScanCodeSeq_di:
 49313 000087B6 51                      	push	cx
 49314 000087B7 29D1                    	sub	cx,dx
 49315 000087B9 41                      	inc	cx
 49316                                  scsagain:
 49317 000087BA 56                      	push	si
 49318 000087BB 57                      	push	di
 49319 000087BC 51                      	push	cx
 49320 000087BD 89D1                    	mov	cx,dx
 49321 000087BF F3A6                    	rep	cmpsb
 49322 000087C1 59                      	pop	cx
 49323 000087C2 5F                      	pop	di
 49324 000087C3 5E                      	pop	si
 49325 000087C4 7403                    	je	short scsfound
 49326 000087C6 47                      	inc	di
 49327 000087C7 E2F1                    	loop	scsagain
 49328                                  scsfound:
 49329 000087C9 59                      	pop	cx
 49330                                  vvexit:		; 18/12/2022
 49331 000087CA C3                      	retn
 49332                                  	
 49333                                  ;----------------------------------------------------------------------------
 49334                                  ;
 49335                                  ; VerifyVersion
 49336                                  ;
 49337                                  ; Checks whether the binary version from ES:0 matches the ASCII version
 49338                                  ; from ES:2A.
 49339                                  ;
 49340                                  ;       Entry: AX = binary version number 
 49341                                  ;       Exit : Z flag set if version numbers match
 49342                                  ;
 49343                                  ;----------------------------------------------------------------------------
 49344                                  
 49345                                  VerifyVersion:
 49346 000087CB 268B362A00              	mov	si,[es:2Ah]		; offset of version number
 49347                                  					;  in ascii
 49348 000087D0 B30A                    	mov	bl,10
 49349 000087D2 83C603                  	add	si,3			; point to last digit
 49350                                  
 49351 000087D5 E80E00                  	call	VVDigit
 49352 000087D8 75F0                    	jne	short vvexit
 49353 000087DA E80900                  	call	VVDigit
 49354 000087DD 75EB                    	jne	short vvexit
 49355 000087DF 26803C2E                	cmp	byte [es:si],'.'
 49356 000087E3 75E5                    	jne	short vvexit
 49357 000087E5 4E                      	dec	si
 49358                                  	;call	VVDigit
 49359                                  	; 18/12/2022
 49360                                  	;jmp	short VVDigit
 49361                                  ;vvexit:
 49362                                  	;retn
 49363                                  VVDigit:
 49364 000087E6 F6F3                    	div	bl
 49365 000087E8 80C430                  	add	ah,'0'
 49366 000087EB 4E                      	dec	si
 49367 000087EC 26386401                	cmp	[es:si+1],ah
 49368 000087F0 B400                    	mov	ah,0			; do not xor or sub we need Z
 49369 000087F2 C3                      	retn
 49370                                  
 49371                                  ; 20/03/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 49372                                  ;%endif
 49373                                  
 49374                                  ;-----------------------------------------------------------------------
 49375                                  
 49376                                  ; 23/05/2019 - Retro DOS v4.0
 49377                                  ; DOSCODE:B702h (MSDOS 6.21, MSDOS.SYS)
 49378                                  
 49379                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 49380                                  ; DOSCODE:B3E0h (MSDOS 5.0, MSDOS.SYS)
 49381                                  
 49382                                  exepatch_start:	 ; label byte
 49383                                  
 49384                                  	; The following is the code that'll be layed over the buggy unpack
 49385                                  	; code.
 49386                                  str1:
 49387 000087F3 06                      	db  06h	  		;push	es
 49388 000087F4 8CD8                    	db  8Ch,0D8h		;mov	ax,ds
 49389                                  
 49390                                  first_stop equ	$-str1
 49391                                  			
 49392 000087F6 2BC2                    	db  2Bh, 0C2h		;sub	ax,dx
 49393                                  
 49394                                  first:  ; label	byte
 49395                                  
 49396 000087F8 8ED8                    	db  8Eh,0D8h		;mov	ds,ax
 49397 000087FA 8EC0                    	db  8Eh,0C0h		;mov	es,ax
 49398 000087FC BF0F00                  	db  0BFh,0Fh,00h	;mov	di,000FH
 49399 000087FF 57                      	db  57h	    		;push	di
 49400 00008800 B91000                  	db  0B9h,10h,00h	;mov	cx,0010H
 49401 00008803 B0FF                    	db  0B0h,0FFh 		;mov	al,0FFH
 49402 00008805 F3AE                    	db  0F3h,0AEh 		;repz	scasb
 49403 00008807 47                      	db  47h	    		;inc	di
 49404 00008808 8BF7                    	db  8Bh,0F7h  		;mov	si,di
 49405 0000880A 5F                      	db  5Fh	    		;pop	di
 49406 0000880B 58                      	db  58h	    		;pop	ax
 49407                                  
 49408                                  second_stop equ	$-first
 49409                                  
 49410 0000880C 2BC2                    	db  2Bh,0C2h  		;sub	ax,dx
 49411                                  
 49412                                  second: ; label	byte
 49413                                  
 49414 0000880E 8EC0                    	db  8Eh,0C0h  		;mov	es,ax
 49415                                  		    		;NextRec:
 49416 00008810 B90402                  	db  0B9h,04h,02h	;mov	cx,0204h
 49417                                  		    		;norm_agn:
 49418 00008813 8BC6                    	db  8Bh,0C6h		;mov	ax,si
 49419 00008815 F7D0                    	db  0F7h,0D0h		;not	ax
 49420 00008817 D3E8                    	db  0D3h,0E8h		;shr	ax,cl
 49421 00008819 7413                    	db  74h,13h		;jz	short SI_ok
 49422 0000881B 8CDA                    	db  8Ch,0DAh		;mov	dx,ds
 49423 0000881D 83CEF0                  	db  83h,0CEh,0F0h	;or	si,0FFF0H
 49424 00008820 2BD0                    	db  2Bh,0D0h		;sub	dx,ax
 49425 00008822 7308                    	db  73h,08h		;jnc	short SItoDS
 49426 00008824 F7DA                    	db  0F7h,0DAh		;neg	dx
 49427 00008826 D3E2                    	db  0D3h,0E2h		;shl	dx,cl
 49428 00008828 2BF2                    	db  2Bh,0F2h		;sub	si,dx
 49429 0000882A 33D2                    	db  33h,0D2h		;xor	dx,dx
 49430                                  				;SItoDS:
 49431 0000882C 8EDA                    	db  8Eh,0DAh		;mov	ds,dx
 49432                                  				;SI_ok:
 49433 0000882E 87F7                    	db  87h,0F7h		;xchg	si,di
 49434 00008830 1E                      	db  1Eh			;push	ds
 49435 00008831 06                      	db  06h			;push	es
 49436 00008832 1F                      	db  1Fh			;pop	ds
 49437 00008833 07                      	db  07h			;pop	es
 49438 00008834 FECD                    	db  0FEh,0CDh		;dec	ch
 49439 00008836 75DB                    	db  75h,0DBh		;jnz	short norm_agn
 49440 00008838 AC                      	db  0ACh		;lodsb
 49441 00008839 92                      	db  92h			;xchg	dx,ax
 49442 0000883A 4E                      	db  4Eh			;dec	si
 49443 0000883B AD                      	db  0ADh		;lodsw
 49444 0000883C 8BC8                    	db  8Bh,0C8h		;mov	cx,ax
 49445 0000883E 46                      	db  46h			;inc	si
 49446 0000883F 8AC2                    	db  8Ah,0C2h		;mov	al,dl
 49447 00008841 24FE                    	db  24h,0FEh		;and	al,0FEH
 49448 00008843 3CB0                    	db  3Ch,0B0h		;cmp	al,RPTREC
 49449 00008845 7505                    	db  75h,05h		;jne	short TryEnum
 49450 00008847 AC                      	db  0ACh		;lodsb
 49451 00008848 F3AA                    	db  0F3h,0AAh		;rep stosb
 49452                                  
 49453                                  ;	db  0EBh,07h,90h	;jmp	short TryNext
 49454 0000884A EB06                    	db  0EBh,06h		;jmp	short TryNext
 49455                                  
 49456                                  				;TryEnum:
 49457 0000884C 3CB2                    	db  3Ch,0B2h		;cmp	al,ENMREC
 49458 0000884E 756C                    	db  75h,6Ch		;jne	short CorruptExe
 49459 00008850 F3A4                    	db  0F3h,0A4h		;rep movsb
 49460                                  				;TryNext:
 49461                                  
 49462 00008852 92                      	db  92h			;xchg	dx,ax
 49463                                  ;	db  8Ah,0C2h		;mov	al,dl
 49464                                  
 49465 00008853 A801                    	db  0A8h,01h		;test	al,1
 49466 00008855 74B9                    	db  74h,0B9h		;jz	short NextRec
 49467 00008857 9090                    	db  90h,90h		;nop,nop
 49468                                  	
 49469                                  last_stop equ $-second
 49470                                  size_str1 equ $-str1
 49471                                  
 49472                                  	; The following is the code that we need to look for in the exe
 49473                                  	; file.
 49474                                  
 49475                                  scan_patch1: ; label byte
 49476                                  
 49477 00008859 8CC3                    	db  8Ch,0C3h		;mov	bx,es
 49478 0000885B 8CD8                    	db  8Ch,0D8h		;mov	ax,ds
 49479 0000885D 2BC2                    	db  2Bh,0C2h		;sub	ax,dx
 49480 0000885F 8ED8                    	db  8Eh,0D8h		;mov	ds,ax
 49481 00008861 8EC0                    	db  8Eh,0C0h		;mov	es,ax
 49482 00008863 BF0F00                  	db  0BFh,0Fh,00h	;mov	di,000FH
 49483 00008866 B91000                  	db  0B9h,10h,00h	;mov	cx,0010H
 49484 00008869 B0FF                    	db  0B0h,0FFh		;mov	al,0FFH
 49485 0000886B F3AE                    	db  0F3h,0AEh		;repz	scasb
 49486 0000886D 47                      	db  47h			;inc	di
 49487 0000886E 8BF7                    	db  8Bh,0F7h		;mov	si,di
 49488 00008870 8BC3                    	db  8Bh,0C3h		;mov	ax,bx
 49489 00008872 2BC2                    	db  2Bh,0C2h		;sub	ax,dx
 49490 00008874 8EC0                    	db  8Eh,0C0h		;mov	es,ax
 49491 00008876 BF0F00                  	db  0BFh,0Fh,00h	;mov	di,000FH
 49492                                  				;NextRec:
 49493 00008879 B104                    	db  0B1h,04h		;mov	cl,4
 49494 0000887B 8BC6                    	db  8Bh,0C6h		;mov	ax,si
 49495 0000887D F7D0                    	db  0F7h,0D0h		;not	ax
 49496 0000887F D3E8                    	db  0D3h,0E8h		;shr	ax,cl
 49497 00008881 7409                    	db  74h,09h		;jz	short SI_ok
 49498 00008883 8CDA                    	db  8Ch,0DAh		;mov	dx,ds
 49499 00008885 2BD0                    	db  2Bh,0D0h		;sub	dx,ax
 49500 00008887 8EDA                    	db  8Eh,0DAh		;mov	ds,dx
 49501 00008889 83CEF0                  	db  83h,0CEh,0F0h	;or	si,0FFF0H
 49502                                  	       			;SI_ok:
 49503 0000888C 8BC7                    	db  8Bh,0C7h		;mov	ax,di
 49504 0000888E F7D0                    	db  0F7h,0D0h		;not	ax
 49505 00008890 D3E8                    	db  0D3h,0E8h		;shr	ax,cl
 49506 00008892 7409                    	db  74h,09h		;jz	short DI_ok
 49507 00008894 8CC2                    	db  8Ch,0C2h		;mov	dx,es
 49508 00008896 2BD0                    	db  2Bh,0D0h		;sub	dx,ax
 49509 00008898 8EC2                    	db  8Eh,0C2h		;mov	es,dx
 49510 0000889A 83CFF0                  	db  83h,0CFh,0F0h	;or	di,0FFF0H
 49511                                  				;DI_ok:
 49512                                  
 49513                                  size_scan_patch1 equ $-scan_patch1
 49514                                  
 49515                                  scan_patch2: ; label byte
 49516                                  			
 49517 0000889D 8CC3                    	db  8Ch,0C3h		;mov	bx,es
 49518 0000889F 8CD8                    	db  8Ch,0D8h		;mov	ax,ds
 49519 000088A1 48                      	db  48h			;dec	ax
 49520 000088A2 8ED8                    	db  8Eh,0D8h		;mov	ds,ax
 49521 000088A4 8EC0                    	db  8Eh,0C0h		;mov	es,ax
 49522 000088A6 BF0F00                  	db  0BFh,0Fh,00h	;mov	di,000FH
 49523 000088A9 B91000                  	db  0B9h,10h,00h	;mov	cx,0010H
 49524 000088AC B0FF                    	db  0B0h,0FFh		;mov	al,0FFH
 49525 000088AE F3AE                    	db  0F3h,0AEh		;repz	scasb
 49526 000088B0 47                      	db  47h			;inc	di
 49527 000088B1 8BF7                    	db  8Bh,0F7h		;mov	si,di
 49528 000088B3 8BC3                    	db  8Bh,0C3h		;mov	ax,bx
 49529 000088B5 48                      	db  48h			;dec	ax
 49530 000088B6 8EC0                    	db  8Eh,0C0h		;mov	es,ax
 49531 000088B8 BF0F00                  	db  0BFh,0Fh,00h	;mov	di,000FH
 49532                                  				;NextRec:
 49533 000088BB B104                    	db  0B1h,04h		;mov	cl,4
 49534 000088BD 8BC6                    	db  8Bh,0C6h		;mov	ax,si
 49535 000088BF F7D0                    	db  0F7h,0D0h		;not	ax
 49536 000088C1 D3E8                    	db  0D3h,0E8h		;shr	ax,cl
 49537 000088C3 740A                    	db  74h,0Ah		;jz	short SI_ok
 49538 000088C5 8CDA                    	db  8Ch,0DAh		;mov	dx,ds
 49539 000088C7 2BD0                    	db  2Bh,0D0h		;sub	dx,ax
 49540 000088C9 8EDA                    	db  8Eh,0DAh		;mov	ds,dx
 49541 000088CB 81CEF0FF                	db  81h,0CEh,0F0h,0FFh
 49542                                  				;or	si,0FFF0H
 49543                                  				;SI_ok:
 49544 000088CF 8BC7                    	db  8Bh,0C7h		;mov	ax,di
 49545 000088D1 F7D0                    	db  0F7h,0D0h		;not	ax
 49546 000088D3 D3E8                    	db  0D3h,0E8h		;shr	ax,cl
 49547 000088D5 740A                    	db  74h,0Ah		;jz	short DI_ok
 49548 000088D7 8CC2                    	db  8Ch,0C2h		;mov	dx,es
 49549 000088D9 2BD0                    	db  2Bh,0D0h		;sub	dx,ax
 49550 000088DB 8EC2                    	db  8Eh,0C2h		;mov	es,dx
 49551 000088DD 81CFF0FF                	db  81h,0CFh,0F0h,0FFh
 49552                                  				;or	di,0FFF0H
 49553                                  				;DI_ok:
 49554                                  
 49555                                  size_scan_patch2 equ $-scan_patch2
 49556                                  
 49557                                  scan_patch3: ; label byte
 49558                                  
 49559 000088E1 8CC3                    	db  8Ch,0C3h		;mov	bx,es
 49560 000088E3 8CD8                    	db  8Ch,0D8h		;mov	ax,ds
 49561 000088E5 48                      	db  48h			;dec	ax
 49562 000088E6 8ED8                    	db  8Eh,0D8h		;mov	ds,ax
 49563 000088E8 8EC0                    	db  8Eh,0C0h		;mov	es,ax
 49564 000088EA BF0F00                  	db  0BFh,0Fh,00h	;mov	di,000FH
 49565 000088ED B91000                  	db  0B9h,10h,00h	;mov	cx,0010H
 49566 000088F0 B0FF                    	db  0B0h,0FFh		;mov	al,0FFH
 49567 000088F2 F3AE                    	db  0F3h,0AEh		;repz	scasb
 49568 000088F4 47                      	db  47h			;inc	di
 49569 000088F5 8BF7                    	db  8Bh,0F7h		;mov	si,di
 49570 000088F7 8BC3                    	db  8Bh,0C3h		;mov	ax,bx
 49571 000088F9 48                      	db  48h			;dec	ax
 49572 000088FA 8EC0                    	db  8Eh,0C0h		;mov	es,ax
 49573 000088FC BF0F00                  	db  0BFh,0Fh,00h	;mov	di,000FH
 49574                                  				;NextRec:
 49575 000088FF B104                    	db  0B1h,04h		;mov	cl,4
 49576 00008901 8BC6                    	db  8Bh,0C6h		;mov	ax,si
 49577 00008903 F7D0                    	db  0F7h,0D0h		;not	ax
 49578 00008905 D3E8                    	db  0D3h,0E8h		;shr	ax,cl
 49579 00008907 7409                    	db  74h,09h		;jz	short SI_ok
 49580 00008909 8CDA                    	db  8Ch,0DAh		;mov	dx,ds
 49581 0000890B 2BD0                    	db  2Bh,0D0h		;sub	dx,ax
 49582 0000890D 8EDA                    	db  8Eh,0DAh		;mov	ds,dx
 49583 0000890F 83CEF0                  	db  83h,0CEh,0F0h	;or	si,0FFF0H
 49584                                  				;SI_ok:
 49585 00008912 8BC7                    	db  8Bh,0C7h		;mov	ax,di
 49586 00008914 F7D0                    	db  0F7h,0D0h		;not	ax
 49587 00008916 D3E8                    	db  0D3h,0E8h		;shr	ax,cl
 49588 00008918 7409                    	db  74h,09h		;jz	short DI_ok
 49589 0000891A 8CC2                    	db  8Ch,0C2h		;mov	dx,es
 49590 0000891C 2BD0                    	db  2Bh,0D0h		;sub	dx,ax
 49591 0000891E 8EC2                    	db  8Eh,0C2h		;mov	es,dx
 49592 00008920 83CFF0                  	db  83h,0CFh,0F0h	;or	di,0FFF0H
 49593                                  				;DI_ok:
 49594                                  
 49595                                  size_scan_patch3 equ $-scan_patch3
 49596                                  
 49597                                  scan_com: ; label byte
 49598                                  
 49599 00008923 AC                      	db  0ACh		;lodsb
 49600 00008924 8AD0                    	db  8Ah,0D0h		;mov	dl,al
 49601 00008926 4E                      	db  4Eh			;dec	si
 49602 00008927 AD                      	db  0ADh		;lodsw
 49603 00008928 8BC8                    	db  8Bh,0C8h		;mov	cx,ax
 49604 0000892A 46                      	db  46h			;inc	si
 49605 0000892B 8AC2                    	db  8Ah,0C2h		;mov	al,dl
 49606 0000892D 24FE                    	db  24h,0FEh		;and	al,0FEH
 49607 0000892F 3CB0                    	db  3Ch,0B0h		;cmp	al,RPTREC
 49608 00008931 7506                    	db  75h,06h		;jne	short TryEnum
 49609 00008933 AC                      	db  0ACh		;lodsb
 49610 00008934 F3AA                    	db  0F3h,0AAh		;rep stosb
 49611 00008936 EB0790                  	db  0EBh,07h,90h	;jmp	short TryNext
 49612                                  				;TryEnum:
 49613 00008939 3CB2                    	db  3Ch,0B2h		;cmp	al,ENMREC
 49614 0000893B 756B                    	db  75h,6Bh		;jne	short CorruptExe
 49615 0000893D F3A4                    	db  0F3h,0A4h		;rep movsb
 49616                                  				;TryNext:
 49617 0000893F 8AC2                    	db  8Ah,0C2h		;mov	al,dl
 49618 00008941 A801                    	db  0A8h,01h		;test	al,1
 49619                                  ;	db  74h,0BAh		;jz	short NextRec
 49620                                  
 49621                                  size_scan_com	equ	$-scan_com
 49622                                  
 49623                                  ;-----------------------------------------------------------------------
 49624                                  
 49625                                  ; 23/05/2019 - Retro DOS v4.0
 49626                                  ; DOSCODE:B852h (MSDOS 6.21, MSDOS.SYS)
 49627                                  
 49628                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 49629                                  ; DOSCODE:B530h (MSDOS 5.0, MSDOS.SYS)
 49630                                  
 49631                                  ; 21/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 49632                                  ; DOSCODE:CB02h (PCDOS 7.1 IBMDOS.COM)
 49633                                  
 49634                                  ExePatch:
 49635                                  	; 21/03/2024 - Retro DOS v5.0
 49636                                  	;;28/12/2022 - Retro DOS v4.1
 49637 00008943 E80600                  	call	ExePackPatch
 49638 00008946 36FF16[690D]            	call	word [ss:RationalPatchPtr]
 49639 0000894B C3                      	retn
 49640                                  	; 28/12/2022
 49641                                  	;jmp	short ExePackPatch
 49642                                  
 49643                                  ;-----------------------------------------------------------------------
 49644                                  ;
 49645                                  ; Procedure Name 	: ExePackPatch
 49646                                  ;
 49647                                  ; Inputs	 	: DS 			-> DOSDATA
 49648                                  ;			  ES:0 			-> read in image
 49649                                  ;			  ax:cx = start cs:ip of program
 49650                                  ; Output		:		
 49651                                  ;
 49652                                  ;	1. If ES <= 0fffh
 49653                                  ;	   2. if exepack signature ('RB') found
 49654                                  ;	      3. if common code to patch compares (for 3 diff. versions)
 49655                                  ;	       	 4. if rest of the code & checksum compares
 49656                                  ;	  	    5. overlay buggy code with code in 
 49657                                  ;		       doscode:str1.
 49658                                  ;		 6. endif
 49659                                  ;	      7. endif
 49660                                  ;	   8. endif
 49661                                  ;	9. endif
 49662                                  ;
 49663                                  ;
 49664                                  ; Uses			: NONE
 49665                                  ;
 49666                                  ;-----------------------------------------------------------------------
 49667                                  	
 49668                                  	; 21/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 49669                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 49670                                  	; 23/05/2019 - Retro DOS v4.0	
 49671                                  ExePackPatch:
 49672 0000894C 53                      	push	bx
 49673 0000894D 8CC3                    	mov	bx,es			; bx has load segment
 49674 0000894F 81FBFF0F                	cmp	bx,0FFFh		; Q: is the load segment > 64K
 49675 00008953 7602                    	jbe	short ep_cont		; N: 
 49676 00008955 5B                      	pop	bx			; Y: no need to patch
 49677 00008956 C3                      	retn
 49678                                  ep_cont:
 49679 00008957 1E                      	push	ds
 49680 00008958 06                      	push	es
 49681 00008959 50                      	push	ax
 49682 0000895A 51                      	push	cx
 49683 0000895B 56                      	push	si
 49684 0000895C 57                      	push	di
 49685                                  	
 49686                                  		; M033 - start
 49687                                  		; exepacked programs have an IP of 12h (>=2)
 49688                                  
 49689 0000895D 83E902                  	sub	cx,2			; Q: is IP >=2
 49690 00008960 7303                    	jnb	short epp_1		; N: exit
 49691 00008962 E9B500                  	jmp	ep_notpacked
 49692                                  					; ax:cx now points to location of
 49693                                  					; 'RB' if this is an exepacked file.
 49694                                  		; M033 - end
 49695                                  epp_1:
 49696 00008965 89CF                    	mov	di,cx
 49697 00008967 8EC0                    	mov	es,ax
 49698 00008969 36893E[8700]            	mov	[ss:UNPACK_OFFSET],di	; save pointer to 'RB' in
 49699                                  					; unpack_offset
 49700                                  
 49701 0000896E 26813D5242              	cmp	word [es:di],'RB' ; 4252h
 49702                                  	;ljne	ep_notpacked
 49703 00008973 7403                    	je	short epp_2
 49704 00008975 E9A200                  	jmp	ep_notpacked
 49705                                  epp_2:
 49706 00008978 0E                      	push	cs
 49707 00008979 1F                      	pop	ds			; set ds to cs
 49708                                  
 49709                                  	;add	di,6Ch
 49710 0000897A 83C76C                  	add	di,PATCH1_COM_OFFSET	; es:di -> points to place in packed
 49711                                  					;          file where we hope to find
 49712                                  					;	   scan string. 
 49713                                  
 49714 0000897D E8A200                  	call	chk_common_str		; check for match
 49715                                  
 49716 00008980 7521                    	jnz	short ep_chkpatch2	; Q: does the patch match
 49717                                  					; N: check at patch2_offset
 49718                                  					; Y: check for rest of patch string
 49719 00008982 BE[5988]                	mov	si,scan_patch1
 49720                                  					; ds:si -> scan string 
 49721 00008985 368B3E[8700]            	mov	di,[ss:UNPACK_OFFSET]	; restore di to point to 'RB'
 49722                                  
 49723                                  	;add	di,28h
 49724                                  	; 07/12/2022
 49725 0000898A 83C728                  	add	di,PATCH1_OFFSET	; es:di -> points to place in packed
 49726                                  					;          file where we hope to find
 49727                                  					;	   scan string. 
 49728                                  	;;mov	cx,68
 49729                                  	;mov	cx,size_scan_patch1
 49730                                  	; 21/03/2024
 49731 0000898D B144                    	mov	cl,size_scan_patch1 ; 68
 49732                                  
 49733                                  	;mov	bx,142
 49734 0000898F BB8E00                  	mov	bx,CHKSUM1_LEN
 49735                                  	;mov	ax,0EF4Eh
 49736 00008992 B84EEF                  	mov	ax,PATCH1_CHKSUM
 49737 00008995 E89E00                  	call	chk_patchsum		; check if patch and chk sum compare
 49738 00008998 7207                    	jc	short ep_done1		; Q: did we pass the test
 49739                                  					; N: exit
 49740                                  					; Y: overlay code with new 
 49741 0000899A BE[F387]                	mov	si,str1
 49742                                  	;;mov	cx,102
 49743                                  	;mov	cx,size_str1
 49744                                  	; 21/03/2024
 49745 0000899D B166                    	mov	cl,size_str1 ; 102
 49746                                  
 49747 0000899F F3A4                    	rep	movsb
 49748                                  ep_done1:
 49749 000089A1 EB77                    	jmp	short ep_done ; 21/03/2024
 49750                                  
 49751                                  ep_chkpatch2:
 49752                                  	;mov	di,76h
 49753 000089A3 BF7600                  	mov	di,PATCH2_COM_OFFSET	; es:di -> possible location of patch
 49754                                  					; in another version of unpack
 49755 000089A6 E87900                  	call	chk_common_str		; check for match
 49756                                  
 49757 000089A9 753D                    	jnz	short ep_chkpatch3	; Q: does the patch match
 49758                                  					; N: check for patch3_offset
 49759                                  					; Y: check for rest of patch string
 49760                                  
 49761 000089AB BE[9D88]                	mov	si,scan_patch2
 49762                                  					; ds:si -> scan string
 49763                                  	;mov	di,32h
 49764 000089AE BF3200                  	mov	di,PATCH2_OFFSET	; es:di -> points to place in packed
 49765                                  					;          file where we hope to find
 49766                                  	;;mov	cx,68			;	   scan string.
 49767                                  	;mov	cx,size_scan_patch2
 49768                                  	; 21/03/2024
 49769 000089B1 B144                    	mov	cl,size_scan_patch2 ; 68
 49770                                  	;mov	bx,140
 49771 000089B3 BB8C00                  	mov	bx,CHKSUM2_LEN
 49772                                  	;mov	ax,78B2h
 49773 000089B6 B8B278                  	mov	ax,PATCH2_CHKSUM
 49774 000089B9 E87A00                  	call	chk_patchsum		; check if patch and chk sum compare
 49775                                  
 49776                                  					; M046 - Start
 49777                                  					; Q: did we pass the test
 49778 000089BC 7310                    	jnc	short ep_patchcode2	; Y: overlay code with new
 49779                                  					; N: try with a different chksum
 49780                                  
 49781 000089BE BE[9D88]                	mov	si,scan_patch2
 49782                                  					; ds:si -> scan string
 49783                                  	;;mov	cx,68
 49784                                  	;mov	cx,size_scan_patch2
 49785                                  	; 21/03/2024
 49786 000089C1 B144                    	mov	cl,size_scan_patch2 ; 68
 49787                                  	;mov	bx,129
 49788 000089C3 BB8100                  	mov	bx,CHKSUM2A_LEN
 49789                                  	;mov	ax,1C47h
 49790 000089C6 B8471C                  	mov	ax,PATCH2A_CHKSUM
 49791 000089C9 E86A00                  	call	chk_patchsum		; check if patch and chk sum compare
 49792                                  					; Q: did we pass the test
 49793 000089CC 724C                    	jc	short ep_notpacked	; N: try with a different chksum
 49794                                  					; Y: overlay code with new
 49795                                  						
 49796                                  ep_patchcode2:			       	; M046 - End
 49797 000089CE BE[F387]                	mov	si,str1
 49798                                  	;;mov	cx,3
 49799                                  	;mov	cx,first_stop
 49800                                  	; 21/03/2024
 49801 000089D1 B103                    	mov	cl,first_stop ; 3
 49802 000089D3 F3A4                    	rep	movsb
 49803 000089D5 B89048                  	mov	ax,4890h		; ax = opcodes for dec ax, nop
 49804 000089D8 AB                      	stosw
 49805                                  	;add	si,2
 49806                                  	; 21/03/2024
 49807 000089D9 46                      	inc	si
 49808 000089DA 46                      	inc	si	
 49809                                  	;;mov	cx,20
 49810                                  	;mov	cx,second_stop
 49811                                  	; 21/03/2024
 49812 000089DB B114                    	mov	cl,second_stop ; 20
 49813 000089DD F3A4                    	rep	movsb
 49814 000089DF AB                      	stosw				; put in dec ax and nop
 49815                                  	;add	si,2
 49816                                  	; 21/03/2024
 49817 000089E0 46                      	inc	si
 49818 000089E1 46                      	inc	si
 49819                                  	;;mov	cx,75
 49820                                  	;mov	cx,last_stop
 49821                                  	; 21/03/2024
 49822 000089E2 B14B                    	mov	cl,last_stop ; 75
 49823 000089E4 F3A4                    	rep	movsb
 49824 000089E6 EB32                    	jmp	short ep_done
 49825                                  
 49826                                  ep_chkpatch3:
 49827                                  	;mov	di,74h
 49828 000089E8 BF7400                  	mov	di,PATCH3_COM_OFFSET	; es:di -> possible location of patch
 49829                                  					; in another version of unpack
 49830 000089EB E83400                  	call	chk_common_str		; check for match
 49831                                  
 49832 000089EE 752A                    	jnz	short ep_notpacked	; Q: does the patch match
 49833                                  					; N: exit
 49834                                  					; Y: check for rest of patch string
 49835 000089F0 BE[E188]                	mov	si,scan_patch3
 49836                                  					; ds:si -> scan string
 49837                                  	;mov	di,32h
 49838 000089F3 BF3200                  	mov	di,PATCH3_OFFSET	; es:di -> points to place in packed
 49839                                  					;          file where we hope to find
 49840                                  					;	   scan string. 
 49841                                  	;;mov	cx,66
 49842                                  	;mov	cx,size_scan_patch3
 49843                                  	; 21/03/2024
 49844 000089F6 B142                    	mov	cl,size_scan_patch3 ; 66
 49845                                  	;mov	bx,139
 49846 000089F8 BB8B00                  	mov	bx,CHKSUM3_LEN
 49847                                  	;mov	ax,4EDEh
 49848 000089FB B8DE4E                  	mov	ax,PATCH3_CHKSUM
 49849 000089FE E83500                  	call	chk_patchsum		; check if patch and chk sum compare
 49850 00008A01 7217                    	jc	short ep_notpacked	; Q: did we pass the test
 49851                                  					; N: exit
 49852                                  					; Y: overlay code with new
 49853 00008A03 BE[F387]                	mov	si,str1
 49854                                  	;;mov	cx,3
 49855                                  	;mov	cx,first_stop
 49856                                  	; 21/03/2024
 49857 00008A06 B103                    	mov	cl,first_stop ; 3
 49858 00008A08 F3A4                    	rep	movsb
 49859 00008A0A B048                    	mov	al,48h			; al = opcode for dec ax
 49860 00008A0C AA                      	stosb
 49861                                  	;add	si,2
 49862                                  	; 21/03/2024
 49863 00008A0D 46                      	inc	si
 49864 00008A0E 46                      	inc	si
 49865                                  	;;mov	cx,20
 49866                                  	;mov	cx,second_stop
 49867                                  	; 21/03/2024
 49868 00008A0F B114                    	mov	cl,second_stop ; 20
 49869 00008A11 F3A4                    	rep	movsb
 49870 00008A13 AA                      	stosb				; put in dec ax
 49871                                  	;add	si,2
 49872                                  	; 21/03/2024
 49873 00008A14 46                      	inc	si
 49874 00008A15 46                      	inc	si
 49875                                  	;;mov	cx,75
 49876                                  	;mov	cx,last_stop
 49877                                  	; 21/03/2024
 49878 00008A16 B14B                    	mov	cl,last_stop ; 75
 49879 00008A18 F3A4                    	rep	movsb
 49880                                  
 49881                                  ep_notpacked:
 49882                                  	;stc
 49883                                  ep_done:
 49884 00008A1A 5F                      	pop	di
 49885 00008A1B 5E                      	pop	si
 49886 00008A1C 59                      	pop	cx
 49887 00008A1D 58                      	pop	ax
 49888 00008A1E 07                      	pop	es
 49889 00008A1F 1F                      	pop	ds
 49890 00008A20 5B                      	pop	bx
 49891 00008A21 C3                      	retn
 49892                                  
 49893                                  ;-------------------------------------------------------------------------
 49894                                  ;
 49895                                  ; 	Procedure Name	: chk_common_str
 49896                                  ;
 49897                                  ;	Input		: DS = DOSCODE
 49898                                  ;			; ES:DI points to string in packed file
 49899                                  ;
 49900                                  ;	Output		; Z if match else NZ
 49901                                  ;
 49902                                  ;-------------------------------------------------------------------------
 49903                                  
 49904                                  	; 23/05/2019 - Retro DOS v4.0
 49905                                  chk_common_str:
 49906 00008A22 BE[2389]                	mov	si,scan_com
 49907                                  					; ds:si -> scan string 
 49908                                  	;mov	cx,32
 49909 00008A25 B92000                  	mov	cx,size_scan_com
 49910                                  
 49911 00008A28 F3A6                    	repe	cmpsb
 49912                                  
 49913                                  					; M046 - start
 49914                                  	; a fourth possible version of these exepacked programs have a
 49915                                  	; 056h instead of 06Bh. See scan_com above
 49916                                  	;
 49917                                  	; 	db  75h, 6Bh		;jne CorruptExe
 49918                                  	;
 49919                                  	; If the mismatch at this point is due to a 56h instead of 6Bh
 49920                                  	; we shall try to match the rest of the string
 49921                                  	;
 49922                                  
 49923 00008A2A 7409                    	jz	short ccs_done
 49924 00008A2C 26807DFF56              	cmp	byte [es:di-1],56h
 49925 00008A31 7502                    	jnz	short ccs_done
 49926                                  
 49927 00008A33 F3A6                    	repe	cmpsb
 49928                                  ccs_done:				; M046 - end
 49929 00008A35 C3                      	retn
 49930                                  
 49931                                  ;-------------------------------------------------------------------------
 49932                                  ;
 49933                                  ;	Procedure Name	: chk_patchsum
 49934                                  ;
 49935                                  ;	Input		: DS:SI -> string we're looking for
 49936                                  ;			: ES:DI -> offset in packed file
 49937                                  ;			: CX 	= scan length
 49938                                  ;			: BX	= length of check sum
 49939                                  ;			: AX 	= value of check sum
 49940                                  ;
 49941                                  ;	Output		: if patch & check sum compare
 49942                                  ;				NC
 49943                                  ;			  else
 49944                                  ;				CY
 49945                                  ;
 49946                                  ;	Uses		: AX, BX, CX, SI
 49947                                  ;
 49948                                  ;-------------------------------------------------------------------------
 49949                                  
 49950                                  	; 23/05/2019 - Retro DOS v4.0
 49951                                  chk_patchsum:
 49952 00008A36 57                      	push	di
 49953                                  
 49954 00008A37 F3A6                    	repe	cmpsb
 49955                                  
 49956 00008A39 7518                    	jnz	short cp_fail		; Q: does the patch match
 49957                                  					; N: exit
 49958                                  					; Y:
 49959                                  
 49960                                  		; we do a check sum starting from the location of the
 49961                                  		; exepack signature 'RB' up to 11c/2 bytes, the end of the
 49962                                  		; unpacking code.
 49963                                  
 49964 00008A3B 368B3E[8700]            	mov	di,[ss:UNPACK_OFFSET]	; di -> start of unpack code
 49965 00008A40 89D9                    	mov	cx,bx			; cx = length of check sum
 49966                                  
 49967 00008A42 89C3                    	mov	bx,ax			; save check sum passed to us in bx
 49968 00008A44 31C0                    	xor	ax,ax
 49969                                  ep_chksum:
 49970 00008A46 260305                  	add	ax,[es:di]
 49971 00008A49 83C702                  	add	di,2
 49972 00008A4C E2F8                    	loop	ep_chksum
 49973                                  
 49974 00008A4E 5F                      	pop	di			; restore di
 49975                                  
 49976 00008A4F 39D8                    	cmp	ax,bx		 	; Q: does the check sum match
 49977                                  	;jne	short cp_fail		; N: exit
 49978                                  					; Y:
 49979                                  	; 25/09/2023
 49980                                  	;clc	
 49981                                  	;retn
 49982 00008A51 74E2                    	je	short ccs_done ; cf=0
 49983                                  	
 49984                                  cp_fail:
 49985 00008A53 F9                      	stc
 49986 00008A54 C3                      	retn
 49987                                  
 49988                                  ; 21/03/2024 - Retro DOS v5.0
 49989                                  ;%if 1
 49990                                  ; 28/12/2022 - Retro DOS v4.1
 49991                                  ;%if 0
 49992                                  ;--------------------------------------------------------------------------- 
 49993                                  
 49994                                  
 49995                                  ; M020 : BEGIN
 49996                                  ;
 49997                                  ;---------------------------------------------------------------------------
 49998                                  ;
 49999                                  ; procedure : RationalPatch
 50000                                  ;
 50001                                  ; A routine (in Ration DOS extender) which is invoked at hardware interrupts
 50002                                  ; clobbers CX register on 286 machines. (123 release 3 uses Rational DOS
 50003                                  ; extender). This routine identifies Buggy Rational EXEs and fixes the bug.
 50004                                  ;
 50005                                  ; THE BUG is in the following code sequence:
 50006                                  ;
 50007                                  ;8b 0e 10 00	mov	cx, ds:[10h]		; delay count
 50008                                  ;90		even				; word align
 50009                                  ;e2 fe		loop	$			; wait		CLOBBERS CX
 50010                                  ;e8 xx xx	call	set_A20			; enable A20
 50011                                  ;
 50012                                  ; This patch routine replaces the mov & the loop with a far call into a
 50013                                  ; routine in DOS data segment which is in low memory (because A20 line
 50014                                  ; is off). The routine (RatBugCode) in DOS data saves & restores CX around
 50015                                  ; a mov & loop.
 50016                                  ;
 50017                                  ; Identification of Buggy Rational EXE
 50018                                  ; ====================================
 50019                                  ;
 50020                                  ; (ALL OFFSETS ARE IN THE PROGRAM SECTION - EXCLUDING THE EXE HEADER)
 50021                                  ;
 50022                                  ; OFFSET				Contains
 50023                                  ; ------				--------
 50024                                  ; 0000h			100 times Version number in binary
 50025                                  ;			bug exists in version 3.48 thru 3.83 (both inclusive)
 50026                                  ;
 50027                                  ; 000ah			the WORDS : 0000h, 0020h, 0000h, 0040h, 0001h
 50028                                  ;
 50029                                  ; 002ah			offset where version number is stored in ASCII
 50030                                  ;				e.g. '3.48A'
 50031                                  ;
 50032                                  ; 0030h			offset of copyright string. Copyright strings either
 50033                                  ;			start with "DOS/16M Copyright...." or
 50034                                  ;			"Copyright.....". The string contains
 50035                                  ;			"Rational Systems, Inc."
 50036                                  ;
 50037                                  ; 0020h			word : Paragraph offset of the buggy code segment
 50038                                  ;				from the program image
 50039                                  ; 0016h			word : size of buggy code segment
 50040                                  ;
 50041                                  ;	Buggy code is definite to start after offset 200h in its segment
 50042                                  ;
 50043                                  ;----------------------------------------------------------------------------
 50044                                  
 50045                                  ; 23/05/2019 - Retro DOS v4.0
 50046                                  ; DOSCODE:B976h (MSDOS 6.21, MSDOS.SYS)
 50047                                  
 50048                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 50049                                  ; DOSCODE:B654h (MSDOS 5.0, MSDOS.SYS)
 50050                                  
 50051                                  RScanPattern1:
 50052 00008A55 000020000000400001-     	db	0, 0, 20h, 0, 0, 0, 40h, 0, 1, 0
 50052 00008A5E 00                 
 50053                                  
 50054                                  RLen1 equ $ - RScanPattern1
 50055                                  
 50056                                  RScanPattern2:
 50057 00008A5F 8B0E100090E2FEE8        	db	8Bh, 0Eh, 10h, 00h, 90h, 0E2h, 0FEh, 0E8h
 50058                                  
 50059                                  RLen2 equ $ - RScanPattern2
 50060                                  
 50061                                  RScanPattern3:
 50062 00008A67 8B0E1000E2FEE8          	db	8Bh, 0Eh, 10h, 00h, 0E2h, 0FEh, 0E8h
 50063                                  
 50064                                  RLen3 equ $ - RScanPattern2
 50065                                  
 50066                                  ; DOSCODE:B98Fh (MSDOS 6.21, MSDOS.SYS)
 50067                                  ; DOSCODE:B66Dh (MSDOS 5.0, MSDOS.SYS)
 50068                                  
 50069                                  ;----------------------------------------------------------------------------
 50070                                  ;
 50071                                  ; INPUT : ES = segment where program got loaded
 50072                                  ;
 50073                                  ;----------------------------------------------------------------------------
 50074                                  
 50075                                  	; 21/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 50076                                  	; DOSCODE:CC2Fh (PCDOS 7.1 IBMDOS.COM)
 50077                                  
 50078                                  RationalPatch:
 50079 00008A6E FC                      	cld
 50080                                  
 50081                                  ; 21/03/2024
 50082                                  %if 0
 50083                                  	push	ax
 50084                                  	push	bx
 50085                                  	push	cx
 50086                                  	push	dx
 50087                                  	push	si
 50088                                  	push	di
 50089                                  %else
 50090                                  	; 21/03/2024 (PCDOS 7.1 IBMDOS.COM)
 50091                                  	;;;
 50092 00008A6F 60                      	pusha
 50093                                  	;;;
 50094                                  %endif
 50095 00008A70 06                      	push	es
 50096 00008A71 1E                      	push	ds			; we use all of them
 50097 00008A72 BF0A00                  	mov	di,0Ah			; look for pat1 at offset 0Ah
 50098 00008A75 0E                      	push	cs
 50099 00008A76 1F                      	pop	ds
 50100                                  	
 50101 00008A77 BE[558A]                	mov	si,RScanPattern1
 50102                                  	;mov	cx,10
 50103 00008A7A B90A00                  	mov	cx,RLen1
 50104 00008A7D F3A6                    	rep	cmpsb			; do we have the pattern ?
 50105 00008A7F 754A                    	jne	short rpexit
 50106 00008A81 26A10000                	mov	ax,[es:0]
 50107 00008A85 3D5C01                  	cmp	ax,348			; is it a buggy version ?
 50108 00008A88 7241                    	jb	short rpexit
 50109 00008A8A 3D7F01                  	cmp	ax,383			; is it a buggy version ?
 50110 00008A8D 773C                    	ja	short rpexit
 50111                                  
 50112 00008A8F E839FD                  	call	VerifyVersion
 50113 00008A92 7537                    	jne	short rpexit
 50114                                  
 50115 00008A94 268B0E1600              	mov	cx,[es:16h]		; Length of buggy code seg
 50116 00008A99 81E90002                	sub	cx,200h			; Length we search (we start
 50117                                  					;  at offset 200h)
 50118 00008A9D 268E062000              	mov	es,[es:20h]		; es=buggy code segment
 50119 00008AA2 BE[5F8A]                	mov	si,RScanPattern2
 50120                                  	;mov	dx,8	
 50121 00008AA5 BA0800                  	mov	dx,RLen2
 50122 00008AA8 E808FD                  	call	ScanCodeSeq		; look for code seq with nop
 50123 00008AAB 740B                    	jz	short rpfound
 50124                                  
 50125 00008AAD BE[678A]                	mov	si,RScanPattern3
 50126                                  	;mov	dx,15
 50127 00008AB0 BA0F00                  	mov	dx,RLen3
 50128 00008AB3 E8FDFC                  	call	ScanCodeSeq		; look for code seq w/o nop
 50129 00008AB6 7513                    	jnz	short rpexit
 50130                                  
 50131                                  rpfound:
 50132                                  	
 50133                                  ;	we set up a far call into DOS data
 50134                                  ;	dx has the length of the code seq we were searching for
 50135                                  
 50136 00008AB8 B09A                    	mov	al,9Ah			; far call opcode
 50137 00008ABA AA                      	stosb
 50138 00008ABB B8[2611]                	mov	ax,RatBugCode
 50139 00008ABE AB                      	stosw
 50140 00008ABF 8CD0                    	mov	ax,ss
 50141 00008AC1 AB                      	stosw
 50142 00008AC2 89D1                    	mov	cx,dx
 50143 00008AC4 83E906                  	sub	cx,6			; filler (with NOPs)
 50144 00008AC7 B090                    	mov	al,90h
 50145 00008AC9 F3AA                    	rep	stosb
 50146                                  rpexit:
 50147 00008ACB 1F                      	pop	ds
 50148 00008ACC 07                      	pop	es
 50149                                  
 50150                                  ; 21/03/2024
 50151                                  %if 0
 50152                                  	pop	di
 50153                                  	pop	si
 50154                                  	pop	dx
 50155                                  	pop	cx
 50156                                  	pop	bx
 50157                                  	pop	ax
 50158                                  %else
 50159                                  	; 21/03/2024 (PCDOS 7.1 IBMDOS.COM)
 50160                                  	;;;
 50161 00008ACD 61                      	popa
 50162                                  	;;;
 50163                                  %endif
 50164 00008ACE C3                      	retn
 50165                                  
 50166                                  ; M020 END
 50167                                  
 50168                                  ;--------------------------------------------------------------------------- 
 50169                                  ; 21/03/2024
 50170                                  ;%endif	; 28/12/2022
 50171                                  
 50172                                  ;---------------------------------------------------------------------------
 50173                                  ;
 50174                                  ;	M068
 50175                                  ;
 50176                                  ; 	Procedure Name	: IsCopyProt
 50177                                  ;
 50178                                  ;	Inputs		: DS:100 -> start of com file just read in
 50179                                  ;
 50180                                  ;	Outputs		: sets the A20OFF_COUNT variable to 10 if 
 50181                                  ;			  the program loaded in DS:100 uses a MICROSOFT
 50182                                  ;			  copy protect scheme that relies on the A20 line
 50183                                  ;			  being turned off for it's scheme to work.
 50184                                  ;
 50185                                  ;			  Note: The int 21 function dispatcher will turn 
 50186                                  ;				a20 off, if the A20OFF_COUNT is non-zero 
 50187                                  ;				and dec the A20OFF_COUNT before	iretting 
 50188                                  ;				to the user. 
 50189                                  ;
 50190                                  ;	Uses		: ES, DI, SI, CX
 50191                                  ;
 50192                                  ;---------------------------------------------------------------------------
 50193                                  
 50194                                  ; 23/05/2019 - Retro DOS v4.0
 50195                                  
 50196                                  CPStartOffset	EQU	0175h
 50197                                  CPID1Offset	EQU	011Bh
 50198                                  CPID2Offset	EQU	0173h
 50199                                  CPID3Offset	EQU	0146h
 50200                                  CPID4Offset	EQU	0124h
 50201                                  ID1		EQU	05343h
 50202                                  ID2		EQU	05044h
 50203                                  ID3		EQU	0F413h
 50204                                  ID4		EQU	08000h
 50205                                  
 50206                                  ; DOSCODE:B9FAh (MSDOS 6.21, MSDOS.SYS)
 50207                                  
 50208                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 50209                                  ; DOSCODE:B71Ch (MSDOS 5.0, MSDOS.SYS)
 50210                                  
 50211                                  ; 21/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 50212                                  ; DOSCODE:CC90h (PCDOS 7.1 IBMDOS.COM)
 50213                                  
 50214                                  CPScanPattern:
 50215 00008ACF 89264801                	db	89h,26h,48h,01h		 ; mov [148],sp
 50216 00008AD3 8C0E4C01                	db	8Ch,0Eh,4Ch,01h		 ; mov [14C],cs
 50217 00008AD7 C7064A010001            	db	0C7h,06h,4Ah,01h,00h,01h ; mov [14A],100h 
 50218 00008ADD 8C0E1301                	db 	8Ch,0Eh,13h,01h		 ; mov [113],cs
 50219 00008AE1 B82001                  	db	0B8h,20h,01h		 ; mov ax,120h
 50220 00008AE4 BE0001                  	db	0BEh,00h,01h		 ; mov si,100h
 50221                                  
 50222                                  CPSPlen	EQU $ - CPScanPattern
 50223                                  
 50224                                  ; DOSCODE:BA12h (MSDOS 6.21, MSDOS.SYS)
 50225                                  ; DOSCODE:B734h (MSDOS 5.0, MSDOS.SYS)
 50226                                  ; 21/03/2024
 50227                                  ; DOSCODE:CCA8h (PCDOS 7.1 IBMDOS.COM)
 50228                                  
 50229                                  IsCopyProt:
 50230 00008AE7 813E1B014353            	cmp	word [CPID1Offset],ID1
 50231 00008AED 752D                    	jne	short CP_done
 50232                                  
 50233 00008AEF 813E73014450            	cmp	word [CPID2Offset],ID2
 50234 00008AF5 7525                    	jne	short CP_done
 50235                                  
 50236 00008AF7 813E460113F4            	cmp	word [CPID3Offset],ID3
 50237 00008AFD 751D                    	jne	short CP_done
 50238                                  
 50239 00008AFF 813E24010080            	cmp	word [CPID4Offset],ID4
 50240 00008B05 7515                    	jne	short CP_done
 50241                                  
 50242 00008B07 0E                      	push	cs
 50243 00008B08 07                      	pop	es
 50244 00008B09 BF[CF8A]                	mov	di,CPScanPattern	; es:di -> Pattern to find
 50245                                  
 50246 00008B0C BE7501                  	mov	si,CPStartOffset	; ds:si -> possible location 
 50247                                  					; of pattern
 50248                                  
 50249 00008B0F B91800                  	mov	cx,CPSPlen ; 24		; cx = length of pattern
 50250 00008B12 F3A6                    	repe	cmpsb
 50251 00008B14 7506                    	jnz	short CP_done
 50252                                  
 50253 00008B16 36C606[8500]0A          	mov	byte [ss:A20OFF_COUNT],0Ah ; M071
 50254                                  CP_done:
 50255 00008B1C C3                      	retn
 50256                                  	
 50257                                  ;DOSCODE ENDS
 50258                                  
 50259                                  	;END
 50260                                  
 50261                                  ;----------------------------------------------------------------------------
 50262                                  
 50263                                  ;align 2 ; 05/09/2018 (Error!)
 50264                                  
 50265                                  ; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 50266                                  ;align 16 ; 08/09/2018 (OK.)
 50267 00008B1D 90                      align 2
 50268                                  
 50269                                  ; 06/08/2018 - Retro DOS v3.0
 50270                                  ;============================================================================
 50271                                  ; MSINIT.ASM
 50272                                  ;============================================================================
 50273                                  ; 22/04/2019 - Retro DOS v4.0 (MSINIT.ASM, MSDOS 6.0, 1991)
 50274                                  ;
 50275                                  ; MAIN ENTRY FOR DOS INITIALIZATION
 50276                                  ;
 50277                                  	; 15/07/2018 - Retro DOS v3.0
 50278                                  	; (MSDOS 3.3, IBMDOS.COM, 1987)
 50279                                  
 50280                                  ; temp iret instruction
 50281                                  
 50282                                  ; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 50283                                  ; DOSCODE:B76Ah (MSDOS 5.0, MSDOS.SYS)
 50284                                  
 50285                                  initiret: ; MSDOS 6.0
 50286                                  SYSBUF:
 50287                                  ;IRETT: ; 06/05/2019
 50288 00008B1E CF                      	iret
 50289                                  
 50290                                  ; 22/04/2019 - Retro DOS v4.0
 50291                                  
 50292                                  ; pointer to the BIOS data segment that will be available just to the
 50293                                  ; initialization code
 50294                                  
 50295 00008B1F 7000                    InitBioDataSeg:	dw 70h ; KERNEL_SEGMENT = 0070h
 50296                                  
 50297                                  ; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 50298                                  ; DOSCODE:B76Dh (MSDOS 5.0, MSDOS.SYS)
 50299                                  
 50300                                  ; 22/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 50301                                  ; DOSCODE:CCE1h (PCDOS 7.1 IBMDOS.COM)
 50302                                  
 50303                                  ; Convert AX from a number of bytes to a number of paragraphs (round up).
 50304                                  
 50305                                  ParaRound:
 50306 00008B21 83C00F                  	add	ax, 15
 50307 00008B24 D1D8                    	rcr	ax, 1
 50308 00008B26 D1E8                    	shr	ax, 1
 50309 00008B28 D1E8                    	shr	ax, 1
 50310 00008B2A D1E8                    	shr	ax, 1
 50311 00008B2C C3                      	retn
 50312                                  
 50313                                  ; ---------------------------------------------------------------------------
 50314                                  
 50315                                  ; 22/03/2024 - Retro DOS v5.0
 50316                                  %if 1
 50317                                  ; 28/12/2022 - Retro DOS v4.1
 50318                                  ;%if 0
 50319                                  
 50320                                  ;----------------------------------------------------------------------------
 50321                                  ;
 50322                                  ; Procedure Name : WhatCPUType
 50323                                  ;
 50324                                  ; Inputs	 : none
 50325                                  ;
 50326                                  ; Outputs	 : AL = 0 if CPU <  286
 50327                                  ;		      = 1 if CPU == 286
 50328                                  ;		      = 2 if CPU >= 386
 50329                                  ;
 50330                                  ; Regs. Mod.	 : AX
 50331                                  ;
 50332                                  ;----------------------------------------------------------------------------
 50333                                  
 50334                                  WhatCPUType:
 50335                                  	; 25/04/2019 - Retro DOS v4.0
 50336                                  	;get_cpu_type	; done with a MACRO which can't be generated > once
 50337                                  
 50338                                  	;CPUTYPE.INC (MSDOS 6.0, 1991)
 50339                                  
 50340                                  ; Note: this must be a macro, and not a subroutine in the BIOS since
 50341                                  ; 	it is called from both CODE and SYSINITSEG.
 50342                                  ;
 50343                                  ;------GET_CPU_TYPE-----------------------------------May, 88 by M.Williamson
 50344                                  ;  Returns: AX = 0 if 8086 or 8088
 50345                                  ;              = 1 if 80286
 50346                                  ;              = 2 if 80386
 50347                                  
 50348                                  	; 04/11/2022
 50349                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:0BB03h
 50350                                  
 50351                                  	; 22/03/2024
 50352                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0CCEDh
 50353                                  
 50354                                  Get_CPU_Type:	;macro
 50355 00008B2D 9C                      	pushf
 50356 00008B2E 53                      	push	bx			; preserve bx
 50357 00008B2F 31DB                    	xor	bx,bx			; init bx to zero
 50358                                  
 50359 00008B31 31C0                    	xor	ax,ax			; 0000 into AX
 50360 00008B33 50                      	push	ax			; put it on the stack...
 50361 00008B34 9D                      	popf				; ...then shove it into the flags
 50362 00008B35 9C                      	pushf				; get it back out of the flags...
 50363 00008B36 58                      	pop	ax			; ...and into ax
 50364 00008B37 2500F0                  	and	ax,0F000h		; mask off high four bits
 50365 00008B3A 3D00F0                  	cmp	ax,0F000h		; was it all 1's?
 50366 00008B3D 740E                    	je	short cpu_8086		; aye; it's an 8086 or 8088
 50367                                  
 50368 00008B3F B800F0                  	mov	ax,0F000h		; now try to set the high four bits..
 50369 00008B42 50                      	push	ax
 50370 00008B43 9D                      	popf
 50371 00008B44 9C                      	pushf
 50372 00008B45 58                      	pop	ax			; ...and see what happens
 50373 00008B46 2500F0                  	and	ax,0F000h		; any high bits set ?
 50374 00008B49 7401                    	jz	short cpu_286		; nay; it's an 80286
 50375                                  
 50376                                  cpu_386:				; bx starts as zero
 50377 00008B4B 43                      	inc	bx			; inc twice if 386
 50378                                  cpu_286:				; just inc once if 286
 50379 00008B4C 43                      	inc	bx
 50380                                  cpu_8086:				; don't inc at all if 086
 50381 00008B4D 89D8                    	mov	ax,bx			; put CPU type value in ax
 50382 00008B4F 5B                      	pop	bx			; restore original bx
 50383 00008B50 9D                      	popf
 50384                                  	
 50385                                  	;endm
 50386                                  
 50387                                  	; 04/11/2022 (MSDOS 5.0 MSDOS.SYS)
 50388 00008B51 C3                      	retn	; 19/09/2023
 50389                                  
 50390                                  ; ---------------------------------------------------------------------------
 50391                                  %endif	; 28/12/2022
 50392                                  
 50393                                  ;============================================================================
 50394                                  
 50395                                  ; MAIN ENTRY FOR DOS INITIALIZATION
 50396                                  
 50397                                  	; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 50398                                  	; DOSCODE:B779h (MSDOS 5.0 MSDOS.SYS)
 50399                                  
 50400                                  	; 23/03/2024
 50401                                  	; 22/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 50402                                  	; DOSCODE:CCEDh (PCDOS 7.1 IBMDOS.COM)
 50403                                  
 50404                                  	; DOSCODE:BA57h (MSDOS 6.22 MSDOS.SYS)
 50405                                  	; BIOSCODE:CF81h (Windows ME IO.SYS)
 50406                                  	
 50407                                  	; 30/05/2019
 50408                                  	; 22/04/2019 - Retro DOS v4.0
 50409                                  	; 07/07/2018 - Retro DOS v3.0
 50410                                  	; Retro DOS v2.0 - 03/03/2018
 50411                                  	; 03/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 50412                                  	; MSDOS 5.0 - MSDOS.SYS, offset 79A9h
 50413                                  DOSINIT:
 50414                                  	; MSDOS 6.21 - MSDOS.SYS, offset 7C77h
 50415                                  	;
 50416                                  	; Far call from SYSINIT
 50417                                  	; DX = Memory size in paragraphs
 50418                                  	; DS:SI = [DEVICE_LIST] (SYSINIT.S) 
 50419                                  	;	  (Retro DOS v2.0, 16/03/2018)
 50420                                  	;
 50421                                  	; ES:DI = ptr to BIOS communication block (sysinit3.s)
 50422                                  	;	  (Retro DOS v4.0, 20/04/2019)
 50423                                  
 50424 00008B52 FA                              CLI
 50425 00008B53 FC                              CLD
 50426                                  
 50427                                  	; 03/11/2022
 50428                                  	;push	dx ; 30/05/2019		; save parameters from BIOS
 50429                                  	
 50430                                  	; 17/12/2022
 50431                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 50432                                  	;push	dx ; =*=		; save parameters from BIOS
 50433                                  	
 50434 00008B54 56                      	push	si
 50435 00008B55 1E                      	push	ds
 50436 00008B56 57                      	push	di			;save di (ptr to BiosComBlock)
 50437                                  
 50438 00008B57 8CC3                    	mov	bx,es			;bx:di = ptr to BiosComBlock
 50439                                  
 50440                                  ; First, move the DOS data segment to its final location in low memory
 50441                                  
 50442                                  	;;;mov	ax,0BF69h ; MSDOS 6.21 MSDOS.SYS, file offset 7C7Fh
 50443                                  	;;mov	ax,0BC77h ; MSDOS 5.0 MSDOS.SYS, file offset 79B1h
 50444                                  	; 22/03/2024
 50445                                  	;mov	ax,0D20Fh ; PCDOS 7.1 IBMDOS.COM, file offset 92FFh
 50446 00008B59 B8[2390]                	mov	ax,MEMSTRT		; get offset of end of init code
 50447                                  
 50448                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 50449 00008B5C 83C00F                  	add	ax,15			; round to nearest paragraph
 50450 00008B5F 83E0F0                  	and	ax,~15	; 0FFF0h	; boundary
 50451                                  
 50452 00008B62 89C6                    	mov	si,ax			; si = offset of DOSDATA in current
 50453                                  					; code segment
 50454                                  	; 05/12/2022
 50455                                  	; 30/04/2019 - Retro DOS v4.0
 50456                                  	;xor	si,si
 50457                                  	
 50458                                  	;mov	ax,cs
 50459                                  	;mov	ds,ax			; ds = current code segment
 50460                                  					; DS:SI now points to dosdata
 50461                                  	; 22/03/2024
 50462 00008B64 0E                      	push	cs
 50463 00008B65 1F                      	pop	ds
 50464                                  
 50465                                  	;mov	es,[cs:0BA49h] ; MSDOS 6.21 IO.SYS, offset 7C8Eh 
 50466                                  	;mov	es,[cs:InitBioDataSeg]	; First access to DosDataSg in
 50467                                  					;  BData segment. Cannot use
 50468                                  					;  getdseg macro here!!!
 50469                                  	; 17/12/2022
 50470 00008B66 8E06[1F8B]              	mov	es,[InitBioDataSeg]
 50471                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 50472                                  	;mov	es,[cs:InitBioDataSeg]  ; ds = cs !
 50473                                  
 50474                                  	;mov	es,[es:3]
 50475 00008B6A 268E060300              	mov	es,[es:DosDataSg]	; Get free location in low memory
 50476                                  
 50477 00008B6F 31FF                    	xor	di,di			; ES:DI now points to RAM data
 50478                                  
 50479                                  	;mov	cx,4970  ; Offset 0BA78h in MSDOS 6.21 MSDOS.SYS)
 50480                                  	;mov	cx,4976  ; 25/05/2019
 50481                                  	; 22/03/2024
 50482                                  	;mov	cx,4934	 ; PCDOS 7.1 IBMDOS.COM
 50483                                  	; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 50484                                  	;mov	cx,4962
 50485                                  	;mov	cx,MSDAT001E		; get end of dosdata = size of dosdata
 50486 00008B71 B94613                  	mov	cx,DOSDATASIZE ; = 4962 for MSDOS 5.0 MSDOS.SYS
 50487 00008B74 F3A4                    	rep	movsb			; move data to final location
 50488                                  	
 50489 00008B76 5F                      	pop	di			; restore ptr to BiosComBlock
 50490 00008B77 1F                      	pop	ds			; restore parms from BIOS
 50491 00008B78 5E                      	pop	si
 50492                                  	; 17/12/2022
 50493                                  	;pop	dx ; 30/05/2019	
 50494                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 50495                                  	;pop	dx ; =*=
 50496                                  
 50497 00008B79 06                      	push	es
 50498 00008B7A 1E                      	push	ds
 50499 00008B7B 07                      	pop	es			; es:si -> device chain
 50500 00008B7C 1F                      	pop	ds			; ds points to dosdata
 50501                                  
 50502                                  ;SR;
 50503                                  ;We get a ptr to the BIOS exchange data block. This has been setup right 
 50504                                  ;now so that the EXEC call knows when SysInit is present to do the special
 50505                                  ;lie table handling for device drivers. This can be expanded later on to
 50506                                  ;establish a communication block from the BIOS to the DOS.
 50507                                  
 50508                                  	;mov	[1040h],di	; Offset 0BA87h in MSDOS 6.21 MSDOS.SYS)
 50509                                  	;mov	[1042h],bx
 50510 00008B7D 893E[2313]              	mov	[BiosDataPtr],di
 50511 00008B81 891E[2513]              	mov	[BiosDataPtr+2],bx	; save ptr to BiosComBlock
 50512                                  
 50513 00008B85 2E8C1E[0700]            	mov	[cs:DosDSeg],ds		; set pointer to dosdata in code seg
 50514                                  
 50515                                  	; Set the segment of Lowint23/24/28Addr in msctrlc.asm to dosdata
 50516                                  
 50517 00008B8A 2E8C1E[265E]            	mov	[cs:LowInt23Addr+2],ds	; set pointers in code seg
 50518 00008B8F 2E8C1E[2A5E]            	mov	[cs:LowInt24Addr+2],ds
 50519 00008B94 2E8C1E[2E5E]            	mov	[cs:LowInt28Addr+2],ds
 50520                                  
 50521                                  	;mov	[346h],dx	; MSDOS 6.21 DOSDATA addresses
 50522                                  	;mov	[584h],sp
 50523                                  	;mov	[586h],ss
 50524 00008B99 8916[4603]                  	mov	[ENDMEM],dx	; =*=
 50525 00008B9D 8926[8405]              	mov	[USER_SP],sp
 50526 00008BA1 8C16[8605]              	mov	[USER_SS],ss
 50527                                  
 50528 00008BA5 8CD8                    	mov	ax,ds		; set up ss:sp to dosdata:dskstack
 50529 00008BA7 8ED0                    	mov	ss,ax
 50530                                  
 50531                                  	;mov	sp,920h		; MSDOS 6.21 DOSDATA address
 50532                                  	;mov	sp,offset dosdata:dskstack
 50533 00008BA9 BC[2009]                	mov	sp,DSKSTACK	; 920h ; PCDOS 7.1 IBMDOS.COM ; 22/03/2024
 50534                                  
 50535                                  ;M023
 50536                                  ; Init patch ptrs to default values
 50537                                  
 50538                                  ; 22/03/2024
 50539                                  %if 0
 50540                                  	;mov	word [1212h],RetExePatch
 50541                                  	;mov	word [1214h],RetExePatch
 50542                                  	;mov	word [61h],RetExePatch
 50543                                  	mov	word [FixExePatch],RetExePatch	; M023
 50544                                  	; 28/12/2022 - Retro DOS v4.1
 50545                                  	;mov	word [RationalPatchPtr],RetExePatch ; M023
 50546                                  	mov	word [ChkCopyProt],RetExePatch	; M068
 50547                                  %else
 50548                                  	; 22/03/2024 (PCDOS 7.1 IBMDOS.COM)
 50549                                  	;;;	
 50550 00008BAC B8[C572]                	mov	ax,RetExePatch
 50551 00008BAF A3[670D]                	mov	[FixExePatch],ax
 50552 00008BB2 A3[690D]                	mov	[RationalPatchPtr],ax ; 25/03/2024
 50553 00008BB5 A3[6100]                	mov	[ChkCopyProt],ax
 50554                                  	;;;
 50555                                  %endif
 50556                                  
 50557                                  ; 22/03/2024
 50558                                  %if 1
 50559                                  ; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 50560                                  ;%if 0	; 19/09/2023
 50561                                  
 50562                                  ; Setup to call 386 Rational DOS Extender patch routine if running on
 50563                                  ; a 386 or later. Unlike other patches, this is not dependent on MS-DOS
 50564                                  ; running in the HMA.
 50565                                  
 50566 00008BB8 E872FF                  	call	WhatCPUType	; get cpu type (0 < 286,1==286,2 >= 386)
 50567 00008BBB 3C02                    	cmp	al,2		;   386 or later?
 50568 00008BBD B8[F185]                	mov	ax,Rational386Patch
 50569 00008BC0 7303                    	jae	short di_set_patch
 50570 00008BC2 B8[C572]                	mov	ax,RetExePatch	; < 386, don't need this patch
 50571                                  di_set_patch:
 50572 00008BC5 A3[3E13]                	mov	[Rational386PatchPtr],ax ; patch routine or RET instr.
 50573                                  
 50574                                  %endif
 50575                                  	; Set up the variable temp_dosloc to point to the dos code segment
 50576                                  
 50577 00008BC8 8CC8                    	mov	ax,cs		; ax = current segment of DOS code
 50578                                  
 50579                                  	; ax now holds segment of DOS code
 50580 00008BCA A3[A30A]                	mov	[TEMP_DOSLOC],ax   ; store temp location of DOS
 50581                                  
 50582 00008BCD 8C06[4A00]              	mov	word [NULDEV+2],es ; nuldev -> points to device chain
 50583 00008BD1 8936[4800]              	mov	word [NULDEV],si
 50584                                  ;SR;
 50585                                  ; There are some locations in the Win386 instance data structures
 50586                                  ; which need to be set up with the DOS data segment. First, initialize
 50587                                  ; the segment part of the instance table pointer in the SIS.
 50588                                  
 50589                                  	;;mov	[0FF2h],ds ; [Win386_Info+14+2]
 50590                                  	;mov	[0EF1h],ds ; PCDOS 7.1 IBMDOS.COM ; 22/03/2024
 50591 00008BD5 8C1E[F10E]              	mov	[Win386_Info+Win386_SIS.Instance_Data_Ptr+2],ds
 50592                                  
 50593                                  ; Now initialize the segment part of the pointer to the data in each
 50594                                  ; instance table entry.
 50595                                  
 50596 00008BD9 56                      	push	si		; preserve pointer to device chain
 50597                                  	; 18/12/2022
 50598                                  	; cx = 0
 50599 00008BDA B107                    	mov	cl,7
 50600                                  	;mov	cx,7		; There are 7 entries in the instance table
 50601                                  				; M019
 50602                                  	;;mov	si,0FF6h ; offset (dosdata:Instance_Table+2)
 50603                                  	;mov	si,0EF9h ; PCDOS 7.1 IBMDOS.COM ; 22/03/2024
 50604 00008BDC BE[F90E]                	mov	si,Instance_Table+2 ; point si to segment field
 50605                                  Instance_init_loop:
 50606 00008BDF 8C1C                    	mov	[si],ds		; set offset in instance entry
 50607                                  	;add	si,6
 50608 00008BE1 83C606                  	add	si,size_of_Win386_IIS ; move on to next entry
 50609 00008BE4 E2F9                    	loop	Instance_init_loop
 50610                                  
 50611                                  ;Initialize the WIN386 2.xx instance table with the DOS data segment value
 50612                                  
 50613                                  	; 18/12/2022
 50614 00008BE6 B105                    	mov	cl,5
 50615                                  	;mov	cx,5		; There are five entries in the instance table
 50616                                  
 50617                                  	;mov	si,(offset dosdata:OldInstanceJunk) + 6
 50618                                  	;;mov	si,11EDh	; point si to segment field
 50619                                  	;mov	si,1102h ; PCDOS 7.1 IBMDOS.COM ; 22/03/2024
 50620 00008BE8 BE[0211]                	mov	si,OldInstanceJunk+6
 50621                                  OldInstance_init_loop:
 50622 00008BEB 8C1C                    	mov	[si],ds		; set offset in instance entry
 50623 00008BED 83C606                  	add	si,6		; move on to next entry
 50624 00008BF0 E2F9                    	loop	OldInstance_init_loop
 50625 00008BF2 5E                      	pop	si		; restore pointer to device chain
 50626                                  
 50627                                  ; End of WIN386 2.xx compatibility bullshit
 50628                                  
 50629                                  ; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 50630                                  %if 0	
 50631                                     	; 30/04/2019
 50632                                  	;push	es
 50633                                  	;pop	ds
 50634                                  			; ds:si points to console device
 50635                                  
 50636                                  	; 24/04/2019 - Retro DOS v4.0
 50637                                  
 50638                                  	; 15/07/2018
 50639                                  	; MSDOS 3.3 (IBMDOS.COM, 1987)
 50640                                  	; (Set INT 2Ah handler address to an 'IRET')
 50641                                  
 50642                                  	; need crit vector inited to use deviocall
 50643                                  	;push	ds			; preserve segment of device chain
 50644                                  	push	es ; 30/04/2019
 50645                                  
 50646                                  %endif
 50647                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 50648 00008BF3 06                      	push	es
 50649                                  	; 17/12/2022
 50650                                  	;pop	ds
 50651                                  	;push	ds
 50652                                  
 50653 00008BF4 31C0                    	xor	ax,ax
 50654 00008BF6 8ED8                    	mov	ds,ax			; point DS to int vector table
 50655 00008BF8 B8[1E8B]                	mov	ax,initiret
 50656                                  	;mov	[0A8h],ax  ; [2Ah*4]
 50657 00008BFB A3A800                  	mov	[addr_int_ibm],ax
 50658 00008BFE 8CC8                    	mov	ax,cs
 50659                                  	;mov	[0AAh],ax  ; [(2Ah*4)+2]
 50660 00008C00 A3AA00                  	mov	[addr_int_ibm+2],ax
 50661 00008C03 1F                      	pop	ds			; restore segment of device chain
 50662                                  
 50663 00008C04 E84702                  	call	CHARINIT  		; initialize console driver
 50664 00008C07 56                      	push	si			; save pointer to header
 50665                                  
 50666 00008C08 16                      	push	ss			; move pointer to dos data...
 50667 00008C09 07                      	pop	es			; ...into ES
 50668                                  
 50669                                  	;initialize sft for file 0 (CON)
 50670                                  
 50671                                          ; 07/07/2018 - Retro DOS v3.0
 50672                                  	; 24/04/2019 - Retro DOS v4.0
 50673                                  	;mov	di,SFTABL+6 		; SFT0_SFTable ; 22/03/2024
 50674 00008C0A BF[D200]                	MOV	DI,SFTABL+SFT.SFTable	; Point to sft 0
 50675 00008C0D B80300                  	MOV	AX,3
 50676 00008C10 AB                      	STOSW           	; Refcount
 50677                                          ;DEC	AL
 50678                                  	; 22/03/2024 - Retro DOS v5.0
 50679 00008C11 48                      	dec	ax
 50680 00008C12 AB                      	STOSW			; Access rd/wr, compatibility
 50681 00008C13 30C0                    	XOR	AL,AL
 50682 00008C15 AA                      	STOSB           	; attribute
 50683                                  	;mov	al,0C3h
 50684 00008C16 B0C3                    	mov	al,devid_device_EOF|devid_device|ISCIN|ISCOUT
 50685 00008C18 AB                      	STOSW			; flags
 50686 00008C19 89F0                    	mov	ax,si
 50687 00008C1B AB                      	stosw			; device pointer in devptr
 50688 00008C1C 8CD8                    	mov	ax,ds
 50689 00008C1E AB                      	stosw
 50690 00008C1F 31C0                    	xor	ax,ax	; 0
 50691                                  
 50692                                  ; 22/03/2024
 50693                                  %if 0
 50694                                  	stosw			; firclus
 50695                                  	stosw			; time
 50696                                  	stosw			; date
 50697                                  	dec	ax	; -1
 50698                                  	stosw			; size
 50699                                  	stosw
 50700                                  	inc	ax	; 0
 50701                                  	stosw			; position
 50702                                  	stosw
 50703                                  %else
 50704                                  	; 22/03/2024 (PCDOS 7.1 IBMDOS.COM)
 50705                                  	;;;
 50706 00008C21 83C720                  	add	di,32		; SFTABL+SFT.SFTable + 43
 50707 00008C24 AB                      	stosw			; SFT0_SFTable + 43 ; .sf_fclus32
 50708 00008C25 AB                      	stosw			; SF_ENTRY.sf_fclus32+2
 50709 00008C26 83C7DE                  	add	di,-34		; 0FFDEh ; SFTABL+SFT.SFTable + 13
 50710 00008C29 AB                      	stosw			; SFT0_SFTable + 13 ; .sf_time
 50711 00008C2A AB                      	stosw			; SF_ENTRY.sf_date
 50712 00008C2B 48                      	dec	ax              ; -1
 50713 00008C2C AB                      	stosw			; SFT0_SFTable + 17 ; .sf_size
 50714 00008C2D AB                      	stosw			; SF_ENTRY.sf_size + 2
 50715 00008C2E 40                      	inc	ax		; 0
 50716 00008C2F AB                      	stosw			; SFT0_SFTable + 21 ; .sf_position
 50717 00008C30 AB                      	stosw			; SF_ENTRY.sf_position + 2
 50718                                  	;;;
 50719                                  %endif
 50720                                  
 50721                                  	;add	di,7		; SFT0_SFTable + 32 ; 22/03/2024
 50722 00008C31 83C707                  	add	di,SF_ENTRY.sf_name-SF_ENTRY.sf_cluspos
 50723                                  				; point at name
 50724                                  	;add	si,10
 50725 00008C34 83C60A                  	add	si,SYSDEV.NAME	; sdevname
 50726                                  				; point to name
 50727 00008C37 B90400                  	mov	cx,4
 50728 00008C3A F3A5                    	rep	movsw		; name
 50729 00008C3C B103                    	mov	cl,3
 50730 00008C3E B020                    	mov	al," "
 50731 00008C40 F3AA                    	rep	stosb		; extension
 50732                                  
 50733 00008C42 5E                      	pop	si		; get back pointer to header
 50734                                  
 50735                                  				; mark device as CON I/O
 50736                                  	; 15/07/2018
 50737                                          ;OR	BYTE [SI+4],ISCIN|ISCOUT ; or byte [si+4],3
 50738 00008C43 804C0403                	OR	BYTE [SI+SYSDEV.ATT],ISCIN|ISCOUT
 50739                                  	; 12/03/2018
 50740                                  	;mov	[ss:32h],si
 50741 00008C47 368936[3200]            	MOV     [SS:BCON],SI
 50742                                  	;mov	[ss:34h],ds
 50743 00008C4C 368C1E[3400]                    MOV     [SS:BCON+2],DS
 50744                                  
 50745                                  	; initialize each device until the clock device is found
 50746                                  
 50747                                  CHAR_INIT_LOOP:
 50748 00008C51 C534                            LDS     SI,[SI]			; AUX device
 50749 00008C53 E8F801                  	call	CHARINIT
 50750                                         	;15/07/2018
 50751                                  	;test	byte [SI+4],8
 50752 00008C56 F6440408                	TEST    BYTE [SI+SYSDEV.ATT],ISCLOCK
 50753 00008C5A 74F5                            JZ      SHORT CHAR_INIT_LOOP
 50754                                  	; 12/03/2018
 50755                                  	;mov	[ss:2Eh],si
 50756 00008C5C 368936[2E00]                    MOV     [SS:BCLOCK],SI
 50757                                  	;mov	[ss:30h],ds
 50758 00008C61 368C1E[3000]                    MOV     [SS:BCLOCK+2],DS
 50759                                          ;MOV	BP,MEMSTRT ; Retro DOS 3.0 ; ES:BP points to DPB
 50760                                  
 50761                                  	;mov	bp,4970			; bp = pointer to free mem
 50762                                  	;mov	bp,4976  ; 25/05/2019 - Retro DOS v4.0
 50763                                  	; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0, MSDOS.SYS)
 50764                                  	;mov	bp,4962 ; (MSDOS 5.0 MSDOS.SYS)
 50765                                  	; 22/03/2024 - Retro DOS v5.0
 50766                                  	;mov	bp,4934	; (PCDOS 7.1 IBMDOS.COM)
 50767 00008C66 BD4613                  	mov	bp,MSDAT001E		; es:bp points to dpb area
 50768                                  
 50769 00008C69 36892E[2600]            	mov	[ss:DPBHEAD],bp		; set offset of pointer to DPB's
 50770 00008C6E 368C06[2800]            	mov	[ss:DPBHEAD+2],es	; set segment of pointer to DPB's
 50771                                  
 50772                                  PERDRV:
 50773                                  	;lds	si,[SI+SYSDEV.NEXT] ; 15/07/2018
 50774 00008C73 C534                            LDS	SI,[SI]			; Next device
 50775 00008C75 83FEFF                          CMP	SI,-1	; 0FFFFh
 50776                                  	;JZ	SHORT CONTINIT
 50777                                  	; 23/03/2024
 50778                                  	;;;
 50779 00008C78 7503                    	jnz	short PERDRV2
 50780 00008C7A E99C00                  	jmp     CONTINIT
 50781                                  PERDRV2:
 50782                                  	;;;
 50783                                  
 50784 00008C7D E8CE01                          call	CHARINIT
 50785                                  
 50786                                  	; Retro DOS v2.0 - 16/03/2018 (NOTE for 'CHARINIT' return):
 50787                                  	; [CALLUNIT] = Number of drives for (Disk) Block Dev Driver ([DRVMAX])
 50788                                  	;           (..When the command is 'DSK$INIT', as in 'CHARINIT')
 50789                                  	; [CALLBPB] = [DEVCALL.COUNT] = Address of the BPB (DEVCALL offset 18)
 50790                                  	; (REF: MSDOS 3.3 MSBIO2.ASM, MSDATA.INC, MSDISK.ASM, MSBIO1.ASM)
 50791                                  	; (.. !DSK$IN' in MSBIO1.ASM)
 50792                                  	; DEVCALL.MEDIA = CALLUNIT (DEVCALL offset 13)
 50793                                  
 50794                                          ; 15/07/2018
 50795                                  	;test	word [SI+4],8000h		; DEVTYP
 50796                                          ; 17/12/2022
 50797                                  	;test	byte [SI+5],80h
 50798 00008C80 F6440580                	test	byte [SI+SYSDEV.ATT+1],(DEVTYP>>8) ; 80h
 50799                                  	;TEST	word [SI+SYSDEV.ATT],DEVTYP ; 8000h
 50800 00008C84 75ED                    	JNZ     SHORT PERDRV			; Skip any other character devs
 50801                                  
 50802 00008C86 368A0E[6703]                    MOV	CL,[SS:CALLUNIT] ; 12/03/2018
 50803 00008C8B 30ED                    	XOR     CH,CH
 50804                                          ; 07/07/2018
 50805                                  	;MOV	[SI+10],CL		; Number of units in name field
 50806 00008C8D 884C0A                  	mov	[si+SYSDEV.NAME],cl	; sdevname
 50807 00008C90 368A16[4600]            	MOV     DL,[SS:NUMIO]	; 15/03/2018
 50808 00008C95 30F6                    	XOR     DH,DH
 50809 00008C97 36000E[4600]            	ADD	[SS:NUMIO],CL	; 12/03/2018
 50810 00008C9C 1E                      	PUSH    DS
 50811 00008C9D 56                              PUSH    SI
 50812 00008C9E 36C51E[6C03]            	LDS	BX,[SS:CALLBPB]	; 12/03/2018
 50813                                  
 50814                                  PERUNIT:
 50815 00008CA3 8B37                            MOV     SI,[BX]                 ; DS:SI Points to BPB
 50816 00008CA5 43                              INC     BX
 50817 00008CA6 43                              INC     BX                      ; On to next BPB
 50818                                  	; 15/12/2022
 50819                                  	; 07/07/2018
 50820                                          ;mov	[ES:BP+DPB.DRIVE],DL
 50821 00008CA7 26885600                	MOV     [ES:BP],DL
 50822                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 50823                                  	;;mov	[ES:BP+0],DL
 50824                                  	;mov	[ES:BP+DPB.DRIVE],DL
 50825                                  
 50826                                  	;MOV	[ES:BP+1],DH
 50827 00008CAB 26887601                	MOV	[ES:BP+DPB.UNIT],DH
 50828 00008CAF 53                              PUSH    BX
 50829 00008CB0 51                              PUSH    CX
 50830 00008CB1 52                              PUSH    DX
 50831                                  
 50832                                  	; 23/03/2024 (PCDOS 7.1 IBMDOS.COM)
 50833                                  	;;;
 50834 00008CB2 BA5241                  	mov	dx,4152h ; 'RA'	; signature ('AR') for FAT32 extended BPB/DPB
 50835 00008CB5 31C9                    	xor	cx,cx  ; 0
 50836                                  	;mov	[es:bp+29],cx
 50837 00008CB7 26894E1D                	mov	[es:bp+DPB.NEXT_FREE],cx
 50838 00008CBB 394C0B                  	cmp	[si+A_BPB.SECTORSPERFAT],cx ; 16 bit FAT size = 0 ?
 50839                                  	;cmp	[si+11],cx	; BPB_FATSz16 
 50840 00008CBE 7514                    	jnz	short PERUNIT2	; FAT (FAT12 or FAT16) -old DPB-
 50841                                  	;mov	[es:bp+57],cx	; FAT32 -new- DPB
 50842 00008CC0 26894E39                	mov	[es:bp+DPB.FAT32_NXTFREE],cx
 50843                                  	;mov	[es:bp+59],cx
 50844 00008CC4 26894E3B                	mov	[es:bp+DPB.FAT32_NXTFREE+2],cx
 50845 00008CC8 49                      	dec	cx  ; 0FFFFh	; -1
 50846                                  	;mov	[es:bp+31],cx
 50847 00008CC9 26894E1F                	mov	[es:bp+DPB.FREE_CNT],cx
 50848                                  	;mov	[es:bp+33],cx
 50849 00008CCD 26894E21                	mov	[es:bp+DPB.FREE_CNT_HW],cx
 50850 00008CD1 B95845                  	mov	cx,4558h ; 'XE'	; signature ('EX') for FAT32 extended BPB/DPB
 50851                                  PERUNIT2: 
 50852                                  	;;;
 50853                                  
 50854                                          ;invoke	$SETDPB
 50855 00008CD4 E88487                          CALL	_$SETDPB		; build DPB!
 50856                                  
 50857                                  	; 07/07/2018
 50858                                  	;MOV	AX,[ES:BP+2]
 50859 00008CD7 268B4602                	mov	ax,[ES:BP+DPB.SECTOR_SIZE]
 50860                                          ; 12/03/2018
 50861 00008CDB 363B06[3600]            	CMP	AX,[SS:MAXSEC]		; Q:is this the largest sector so far
 50862 00008CE0 7604                    	JBE     SHORT NOTMAX		; N:
 50863 00008CE2 36A3[3600]              	MOV	[SS:MAXSEC],AX		; Y: save it in maxsec
 50864                                  NOTMAX:					
 50865                                  	; set the next dpb field in the currently built bpb
 50866                                  	; and mark as never accessed
 50867                                          
 50868                                  	; 24/04/2019
 50869 00008CE6 89E8                    	mov	ax,bp			; get pointer to DPB
 50870                                  	;;add	ax,33
 50871                                  	;add	ax,61  ; next DPB (PCDOS 7.1 DPB size = 61) ; 23/03/2024
 50872 00008CE8 83C03D                  	add	ax,DPBSIZ		; advance pointer to next DPB
 50873                                  					; set seg & offset of next DPB
 50874                                  	;mov	[es:bp+25],ax
 50875 00008CEB 26894619                	mov	[es:bp+DPB.NEXT_DPB],ax
 50876                                  	;mov	[es:bp+27],es
 50877 00008CEF 268C461B                	mov	[es:bp+DPB.NEXT_DPB+2],es
 50878                                  					; mark as never accessed
 50879                                  	;mov	byte [es:bp+24],0FFh
 50880 00008CF3 26C64618FF              	mov	byte [es:bp+DPB.FIRST_ACCESS],-1
 50881                                  
 50882 00008CF8 5A                      	POP     DX
 50883 00008CF9 59                              POP     CX
 50884 00008CFA 5B                              POP     BX
 50885 00008CFB 8CD8                            MOV     AX,DS                   ; save segment of bpb array
 50886 00008CFD 5E                              POP     SI
 50887 00008CFE 1F                              POP     DS
 50888                                  					; ds:si -> device header
 50889                                  					; store it in the corresponding dpb
 50890                                  	; 07/07/2018
 50891                                  	;MOV	[ES:BP+19],SI ; 24/04/2019
 50892 00008CFF 26897613                	mov	[ES:BP+DPB.DRIVER_ADDR],si
 50893                                  	;MOV	[ES:BP+21],DS ; 24/04/2019
 50894 00008D03 268C5E15                	mov	[ES:BP+DPB.DRIVER_ADDR+2],ds
 50895                                  
 50896 00008D07 1E                      	PUSH	DS			; save pointer to device header
 50897 00008D08 56                      	PUSH	SI
 50898 00008D09 FEC6                    	INC	DH			; inc unit #
 50899 00008D0B FEC2                    	INC	DL			; inc drive #
 50900 00008D0D 8ED8                    	MOV	DS,AX			; restore segment of BPB array
 50901                                  	;;add	bp,33 ; 24/04/2019
 50902                                  	;add	bp,61 ; 23/03/2024 (PCDOS 7.1)
 50903 00008D0F 83C53D                  	ADD	BP,DPBSIZ		; advance pointer to next dpb
 50904 00008D12 E28F                    	LOOP	PERUNIT			; process all units in each driver
 50905                                  
 50906 00008D14 5E                      	POP     SI			; restore pointer to device header
 50907 00008D15 1F                      	POP     DS
 50908 00008D16 E95AFF                  	JMP	PERDRV			; process all drivers in chain
 50909                                  
 50910                                  CONTINIT:
 50911                                  	; 24/04/2019
 50912                                  	;;sub	bp,33			; set link in last DPB to -1
 50913                                  	;sub	bp,61 ; 23/03/2024 (PCDOS 7.1)
 50914 00008D19 83ED3D                  	sub	bp,DPBSIZ		; back up to last dpb
 50915                                  					; set last link offset & segment
 50916                                  ; 23/03/2024 - Retro DOS v5.0
 50917                                  %if 0
 50918                                  	;mov	word [bp+25],0FFFFh
 50919                                  	mov	word [bp+DPB.NEXT_DPB],-1
 50920                                  	;mov	word [bp+27],0FFFFh
 50921                                  	mov	word [bp+DPB.NEXT_DPB+2],-1
 50922                                  %else
 50923                                  	; 23/03/2024 (PCDOS 7.1 IBMDOS.COM)
 50924                                  	;;;
 50925 00008D1C B8FFFF                  	mov	ax,0FFFFh ; -1
 50926                                  	;mov	word [bp+25],ax
 50927 00008D1F 894619                  	mov	word [bp+DPB.NEXT_DPB],ax ; -1
 50928                                  	;mov	word [bp+27],ax
 50929 00008D22 89461B                  	mov	word [bp+DPB.NEXT_DPB+2],ax ; -1
 50930                                  	;;;
 50931                                  %endif
 50932                                  	;;add	bp,33
 50933                                  	;add	bp,61 ; 23/03/2024 (PCDOS 7.1)
 50934 00008D25 83C53D                  	add	BP,DPBSIZ		; advance to free memory again
 50935                                  					; the DPB chain is done.
 50936 00008D28 16                      	push	ss
 50937 00008D29 1F                      	pop	ds
 50938                                  
 50939 00008D2A 89E8                    	mov	ax,bp
 50940 00008D2C E8F2FD                  	call	ParaRound		; round up to segment
 50941                                  
 50942 00008D2F 8CDA                    	mov	dx,ds			; dx = dosdata segment
 50943 00008D31 01C2                    	add	dx,ax			; dx = ds+ax first free segment
 50944                                  
 50945 00008D33 BB0F00                  	mov	bx,0Fh
 50946                                  	
 50947                                  	; 24/05/2019
 50948                                  	;mov	cx,[ENDMEM]
 50949                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 50950                                  	; 17/12/2022
 50951                                  	;mov	cx,[ENDMEM]
 50952                                  					; set seg inpacketto dosdata
 50953 00008D36 8C1E[A203]              	mov	[DSKCHRET+3],ds ; mov [DOSSEG_INIT],ds 
 50954                                  
 50955                                  ; Patch in the segments of the interrupt vectors with current code segment.
 50956                                  ; Also patch in the segment of the pointers in the dosdata area.
 50957                                  ;
 50958                                  ; Note: Formerly, temp_dosloc was initialized to -1 until after these
 50959                                  ; calls were done. The procedure patch_misc_segments is called multiple
 50960                                  ; times, and relies on temp_dosloc being initialized to -1 as a flag
 50961                                  ; for the first invocation. Thus, we must set it to -1 for this call.
 50962                                  
 50963 00008D3A 52                      	push	dx			; preserve first free segment
 50964                                  
 50965 00008D3B A1[A30A]                	mov	ax,[TEMP_DOSLOC]	; ax = segment to patch in 
 50966 00008D3E 8EC0                    	mov	es,ax			; es = segment of DOS
 50967 00008D40 C706[A30A]FFFF          	mov	word [TEMP_DOSLOC],-1	; -1 means first call to patch_misc_segments
 50968                                  
 50969 00008D46 E8BC01                  	call	patch_vec_segments	; uses AX as doscode segment
 50970 00008D49 E8F101                  	call	patch_misc_segments	; patch in segments for sharer and
 50971                                  					; other tables with seg in ES.
 50972                                  	; 17/12/2022
 50973                                  	; cx = 0
 50974 00008D4C 8C06[A30A]              	mov	[TEMP_DOSLOC],es	; put back segment of dos code
 50975                                  
 50976 00008D50 5A                      	pop	dx			; restore first free segment
 50977                                  
 50978                                  ; We shall now proceed to set the offsets of the interrupt vectors handled
 50979                                  ; by DOS to their appropriate values in DOSCODE. In case the DOS loads in
 50980                                  ; HIMEM the offsets also will be patched to their appropriate values in the
 50981                                  ; low_mem_stub by seg_reinit.
 50982                                  
 50983                                  	;xor	ax,ax ; 0
 50984                                  	;mov	ds,ax
 50985                                  	;mov	es,ax
 50986                                  	; 17/12/2022
 50987                                  	; cx = 0
 50988                                  	;xor	cx,cx ; 0
 50989 00008D51 8ED9                    	mov	ds,cx
 50990 00008D53 8EC1                    	mov	es,cx
 50991                                  
 50992                                  	; set the segment of int 24 vector that was
 50993                                  	; left out by patch_vec_segments above.
 50994                                  
 50995                                  	; 17/12/2022
 50996                                  ; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 50997                                  ;%if 0
 50998                                  	; 24/05/2019
 50999                                  	;;mov	di,90h
 51000                                  	;;mov	di,4*int_fatal_abort
 51001                                  	;mov	di,addr_int_fatal_abort
 51002 00008D55 BF9200                  	mov	di,addr_int_fatal_abort+2 ; 24/05/2019
 51003                                  
 51004 00008D58 36A1[A30A]              	mov	ax,[ss:TEMP_DOSLOC]
 51005                                  	;mov	[di+2],ax  ; int 24h segment
 51006 00008D5C 8905                    	mov	[di],ax ; 24/05/2019
 51007                                  
 51008                                  	;;mov	di,82h
 51009                                  	;mov	di,INTBASE+2
 51010                                  
 51011                                  ;%endif
 51012                                  	; 17/12/2022
 51013                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 51014                                  	;;mov	di,90h
 51015                                  	;;mov	di,4*int_fatal_abort
 51016                                  	;mov	di,addr_int_fatal_abort
 51017                                  	;mov	ax,[ss:TEMP_DOSLOC]
 51018                                  	;mov	[di+2],ax  ; int 24h segment
 51019                                  	;;mov	di,82h
 51020                                  	;mov	di,INTBASE+2
 51021                                  
 51022                                  	; set default divide trap offset
 51023                                  
 51024                                  	;mov	word ptr ds:[0],offset doscode:divov
 51025 00008D5E C7060000[0260]          	mov	word [0],DIVOV	
 51026                                  
 51027                                  	; set vectors 20-28 and 2a-3f to point to iret.
 51028                                  
 51029                                  	;mov	di,80h
 51030 00008D64 BF8000                  	mov	di,INTBASE
 51031                                  	;mov	ax,offset doscode:irett
 51032 00008D67 B8[CB02]                	mov	ax,IRETT
 51033                                  
 51034                                  	; 17/12/2022
 51035                                  	; cx = 0
 51036 00008D6A B109                    	mov	cl,9
 51037                                  	;mov	cx,9			; set 9 offsets (skip 2 between each)
 51038                                  					;   sets offsets for ints 20h-28h
 51039                                  iset1:
 51040 00008D6C AB                      	stosw
 51041                                  	;add	di,2
 51042                                  	; 20/09/2023
 51043 00008D6D 47                      	inc	di
 51044 00008D6E 47                      	inc	di
 51045 00008D6F E2FB                    	loop	iset1
 51046                                  
 51047 00008D71 83C704                  	add	di,4			; skip vector 29h
 51048                                  
 51049                                  ;	mov	cx,6			; set 6 offsets (skip 2 between each)
 51050                                  ;					;   sets offsets for ints 2Ah-2Fh
 51051                                  ;iset2:
 51052                                  ;	stosw
 51053                                  ;	add	di,2
 51054                                  ;	loop	iset2
 51055                                  
 51056                                  ; 30h & 31H is the CPM call entry point whose segment address is set up by
 51057                                  ; patch_vec_segments above. So skip it.
 51058                                  
 51059                                  ;	add	di,8			; skip vector 30h & 31h
 51060                                  
 51061                                  	;;;
 51062                                  	; 06/05/2019 - Retro DOS v4.0
 51063                                  	;mov	cx,5			; set offsets for int 2Ah-2Eh
 51064                                  	; 17/12/2022
 51065 00008D74 B105                    	mov	cl,5 ; 28/06/2019
 51066                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 51067                                  	;mov	cx,6
 51068                                  iset2:
 51069 00008D76 AB                      	stosw
 51070                                  	;add	di,2
 51071                                  	; 20/09/2023
 51072 00008D77 47                      	inc	di
 51073 00008D78 47                      	inc	di
 51074 00008D79 E2FB                    	loop	iset2
 51075                                  
 51076                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 51077                                  	; 17/12/2022
 51078 00008D7B 83C70C                  	add	di,12			; skip vectors 2Fh, 30h & 31h
 51079                                  	;add	di,8
 51080                                  	;;;
 51081                                  
 51082                                  	; 17/12/2022
 51083 00008D7E B10E                    	mov	cl,14
 51084                                  	;mov	cx,14			; set 14 offsets (skip 2 between each)
 51085                                  					;   sets offsets for ints 32h-3Fh
 51086                                  iset3:
 51087 00008D80 AB                      	stosw
 51088                                  	;add	di,2
 51089                                  	; 20/09/2023
 51090 00008D81 47                      	inc	di
 51091 00008D82 47                      	inc	di
 51092 00008D83 E2FB                    	loop	iset3
 51093                                  
 51094                                  ;if installed
 51095                                  	; set the offset of int2f handler
 51096                                  	;mov	word [0BCh],INT2F
 51097 00008D85 C706BC00[3607]          	mov	word [02Fh*4],INT2F
 51098                                  	; set segment to doscode as we have to do int 2f to check for XMS
 51099 00008D8B 36A1[A30A]              	mov	ax,[ss:TEMP_DOSLOC]	; get segment of doscode
 51100                                  	;mov	[0BEh],ax
 51101 00008D8F A3BE00                  	mov	[(02Fh*4)+2],ax
 51102                                  ;endif
 51103                                  	; set up entry point call at vectors 30-31h. Note the segment of the
 51104                                  	; long jump will be patched in by seg_reinit
 51105                                  
 51106                                  	;mov	byte [C0h],0EAh
 51107 00008D92 C606C000EA              	mov	byte [ENTRYPOINT],mi_long_jmp
 51108                                  	;mov	byte [C1h],CALL_ENTRY
 51109 00008D97 C706C100[CC02]          	mov	word [ENTRYPOINT+1],CALL_ENTRY
 51110                                  
 51111 00008D9D C7068000[C502]          	mov	word [addr_int_abort],QUIT	; INT 20h
 51112 00008DA3 C7068400[F102]          	mov	word [addr_int_command],COMMAND ; INT 21h
 51113 00008DA9 C70688000001            	mov	word [addr_int_terminate],100h	; INT 22h
 51114 00008DAF 89168A00                	mov	word [addr_int_terminate+2],dx	
 51115 00008DB3 C7069400[2D05]          	mov	word [addr_int_disk_read],ABSDRD   ; INT 25h
 51116 00008DB9 C7069800[DC05]          	mov	word [addr_int_disk_write],ABSDWRT ; INT 26h 
 51117 00008DBF C7069C00[6872]          	mov	word [addr_int_keep_process],STAY_RESIDENT ; INT 27h
 51118                                  
 51119 00008DC5 16                      	push	ss
 51120 00008DC6 1F                      	pop	ds
 51121                                  	
 51122                                  	; 24/05/2019
 51123                                  	;push	ss
 51124                                  	;pop	es
 51125                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 51126                                  	; 17/12/2022
 51127                                  	;push	ss
 51128                                  	;pop	es
 51129                                  
 51130 00008DC7 52                      	push	dx			; remember address of arena
 51131                                  
 51132 00008DC8 42                      	inc	dx			; leave room for arena header
 51133                                  	;mov	[330h],dx
 51134 00008DC9 8916[3003]              	mov     [CurrentPDB],dx		; set current pdb
 51135                                  
 51136 00008DCD 31FF                    	xor	di,di			; point es:di at end of memory
 51137 00008DCF 8EC2                    	mov	es,dx			; ...where psp will be
 51138 00008DD1 31C0                    	xor	ax,ax
 51139                                  	;mov	cx,80h			; psp is 128 words
 51140                                  	; 17/12/2022
 51141 00008DD3 B180                    	mov	cl,128 ; 28/06/2019
 51142                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 51143                                  	;mov	cx,128
 51144                                  
 51145 00008DD5 F3AB                    	rep	stosw			; zero out psp area
 51146 00008DD7 A1[4603]                        mov     ax,[ENDMEM]
 51147                                  	
 51148                                  	; 17/12/2022
 51149                                  	; cx = 0
 51150 00008DDA E8E088                  	call	SETMEM         	 	; build psp at dx; ax is memory size
 51151                                  
 51152                                  	; ds, es now point to PSP
 51153                                  
 51154 00008DDD 16                      	push	ss
 51155 00008DDE 1F                      	pop	ds
 51156                                  
 51157                                  	;mov	di,24
 51158 00008DDF BF1800                  	mov	di,PDB.JFN_TABLE	; es:di -> pdb_jfn_table in psp
 51159 00008DE2 31C0                    	xor	ax,ax
 51160 00008DE4 AB                      	stosw
 51161 00008DE5 AA                      	stosb				; 0,1 and 2 are con device
 51162 00008DE6 B0FF                    	mov	al,0FFh
 51163                                  	;mov	cx,FILPERPROC-3 ; 17
 51164                                  	; 17/12/2022
 51165                                  	; cx = 4
 51166 00008DE8 B111                    	mov	cl,FILPERPROC-3 ; 17
 51167 00008DEA F3AA                    	rep	stosb			; rest are unused
 51168                                  
 51169 00008DEC 16                      	push	ss
 51170 00008DED 07                      	pop	es
 51171                                  					; must be set to print messages
 51172 00008DEE 8C1E[2C00]              	mov	[SFT_ADDR+2],ds
 51173                                  
 51174                                  ; after this point the char device functions for con will work for
 51175                                  ; printing messages
 51176                                  
 51177                                  	; 24/04/2019 - Retro DOS v4.0
 51178                                  
 51179                                  ; 12/05/2019
 51180                                  ;
 51181                                  ;write_version_msg:
 51182                                  ;
 51183                                  ;	;if	(not ibm)
 51184                                  ;	;mov	si,offset doscode:header
 51185                                  ;	mov	si,HEADER
 51186                                  ;outmes:
 51187                                  ;	;lods	cs:byte ptr [si]
 51188                                  ;	cs
 51189                                  ;	lodsb
 51190                                  ;	cmp	al,"$"
 51191                                  ;	je	short outdone
 51192                                  ;	call	OUTT
 51193                                  ;	jmp	short outmes
 51194                                  ;outdone:
 51195                                  ;	push	ss			; out stomps on segments
 51196                                  ;	pop	ds
 51197                                  ;	push	ss
 51198                                  ;	pop	es
 51199                                  ;	;endif
 51200                                  
 51201                                  	; at this point es is dosdata
 51202                                  
 51203                                  	; Fill in the segment addresses of sysinitvar and country_cdpg
 51204                                  	; in sysinittable (ms_data.asm)
 51205                                  
 51206                                  	;mov	si,0D28h
 51207 00008DF2 BE[580D]                	mov	si,SysInitTable
 51208                                  
 51209                                  	; 17/12/2022
 51210                                  	; ds = es = ss
 51211                                  
 51212                                  	; 23/03/2024
 51213                                  	;;;
 51214                                  	; 17/12/2022
 51215                                  	;; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 51216                                  
 51217                                  	;;mov	[es:si+6],es
 51218                                  	;mov	[es:si+SYSI_EXT.Country_Tab+2],es
 51219                                  	;;mov	[es:si+2],es
 51220                                  	;mov	[es:si+SYSI_EXT.SysInitVars+2],es
 51221                                  	
 51222 00008DF5 8C4406                  	mov	[si+SYSI_EXT.Country_Tab+2],es
 51223 00008DF8 8C4402                  	mov	[si+SYSI_EXT.SysInitVars+2],es
 51224                                  
 51225                                  	; buffhead -> dosdata:hashinitvar
 51226                                  
 51227                                  	;mov	[es:BUFFHEAD+2],es	; BUGBUG - unused, remove this
 51228 00008DFB 8C06[3A00]              	mov	[BUFFHEAD+2],es
 51229                                  	;mov	si,offset dosdata:hashinitvar ; and all other references
 51230                                  	;mov	si,6Dh
 51231 00008DFF BE[6D00]                	mov	si,HASHINITVAR
 51232                                  	;mov	[es:BUFFHEAD],si
 51233 00008E02 8936[3800]              	mov	[BUFFHEAD],si
 51234                                  
 51235 00008E06 5A                              pop     dx                      ; restore address of arena
 51236                                  
 51237                                  	;mov	[032Ch+2],dx
 51238 00008E07 8916[2E03]                      mov     [DMAADD+2],dx
 51239                                  
 51240                                  	;mov	[es:arena_head],dx
 51241 00008E0B 8916[2400]              	mov	[arena_head],dx
 51242                                  	;;;
 51243                                  
 51244 00008E0F 8EDA                            mov     ds,dx
 51245                                  
 51246                                  	;mov	byte [0],'Z'
 51247 00008E11 C60600005A              	mov     byte [ARENA.SIGNATURE],arena_signature_end
 51248                                          ;mov	word [1],0
 51249 00008E16 C70601000000            	mov     word [ARENA.OWNER],arena_owner_system
 51250                                  
 51251 00008E1C 36A1[4603]                      mov     ax,[ss:ENDMEM]
 51252 00008E20 29D0                    	sub	ax,dx
 51253 00008E22 48                              dec     ax
 51254                                  	;mov	[3],ax	; 23/03/2024
 51255 00008E23 A30300                          mov     [ARENA.SIZE],ax
 51256                                  
 51257                                  	; point to sft 0
 51258                                  
 51259                                  	;mov	di,offset dosdata:sftabl + sftable
 51260                                  	;mov	di,SFTABL+6
 51261 00008E26 BF[D200]                	mov	di,SFTABL+SFT.SFTable
 51262 00008E29 B80300                          mov     ax,3
 51263 00008E2C AB                              stosw           		; adjust refcount
 51264                                  
 51265                                  	; es:di is shared data area i.e., es:di -> dosdata:sysinttable
 51266                                  
 51267                                  	;mov	di,offset dosdata:sysinittable
 51268                                  	;;mov	di,0D28h
 51269                                  	;mov	di,0D58h	; 23/03/2024 (PCDOS 7.1)
 51270 00008E2D BF[580D]                	mov	di,SysInitTable	
 51271                                  
 51272 00008E30 42                      	inc	dx			; advance dx from arena to psp
 51273 00008E31 8EDA                    	mov	ds,dx			; point ds to psp
 51274                                  
 51275                                  					; pass the address os seg_reinit 
 51276                                  					; in dx
 51277 00008E33 BA[A18E]                	mov	dx,seg_reinit
 51278 00008E36 B9[F387]                	mov	cx,exepatch_start
 51279 00008E39 81E9[0000]              	sub	cx,_$STARTCODE		; cx = (doscode - exepatch) - dosinit
 51280                                  
 51281 00008E3D B8[1E8B]                	mov	ax,SYSBUF
 51282 00008E40 2D[0000]                	sub	ax,_$STARTCODE		; ax = size of doscode - dosinit
 51283                                  	
 51284 00008E43 368B26[8405]                    mov     sp,[ss:USER_SP]		; use ss override for next 2
 51285 00008E48 368E16[8605]                    mov     ss,[ss:USER_SS]
 51286                                  
 51287 00008E4D CB                              retf
 51288                                  
 51289                                  ;
 51290                                  ; END OF DOSINIT
 51291                                  ;
 51292                                  ;--------------------------------------------------------------------------
 51293                                  
 51294                                  CHARINIT:
 51295                                  	; 23/03/2024 - Retro DOS v5.0
 51296                                  	; 24/04/2019 - Retro DOS v4.0
 51297                                  	; 07/07/2018 - Retro DOS v3.0
 51298                                  	;mov	byte [ss:035Ah],26 ; 1Ah
 51299 00008E4E 36C606[5A03]1A                  MOV	BYTE [SS:DEVCALL_REQLEN],DINITHL
 51300                                  	;mov	byte [ss:035Bh],0
 51301 00008E54 36C606[5B03]00                  MOV	BYTE [SS:DEVCALL_REQUNIT],0
 51302                                  	;mov	byte [ss:035Ch],0
 51303 00008E5A 36C606[5C03]00                  MOV	BYTE [SS:DEVCALL_REQFUNC],DEVINIT
 51304                                  	;mov	word [ss:035BD],0
 51305 00008E60 36C706[5D03]0000                MOV	WORD [SS:DEVCALL_REQSTAT],0
 51306 00008E67 06                              PUSH	ES
 51307 00008E68 53                              PUSH	BX
 51308 00008E69 50                              PUSH	AX
 51309 00008E6A BB[5A03]                        MOV	BX,DEVCALL
 51310                                          ;PUSH	CS
 51311 00008E6D 16                      	PUSH	SS ; 30/04/2019
 51312 00008E6E 07                              POP	ES
 51313 00008E6F E845C4                          CALL	DEVIOCALL2
 51314 00008E72 58                      	POP	AX
 51315 00008E73 5B                              POP	BX
 51316 00008E74 07                              POP	ES
 51317 00008E75 C3                              RETN
 51318                                  
 51319                                  ; 25/04/2019 - Retro DOS v4.0
 51320                                  
 51321                                  ;-----------------------------------------------------------------------------
 51322                                  ;
 51323                                  ;	check_XMM: routine to check presence of XMM driver
 51324                                  ;
 51325                                  ;	Exit:   Sets up the XMM entry point in XMMcontrol in DOSDATA
 51326                                  ;
 51327                                  ;	USED:	none
 51328                                  ;
 51329                                  ;-----------------------------------------------------------------------------
 51330                                  
 51331                                  check_XMM: ; proc near
 51332                                  ;
 51333                                  ; determine whether or not an XMM driver is installed
 51334                                  ;
 51335 00008E76 50                      	push	ax
 51336                                  	;mov	ax,(XMM_MULTIPLEX<<8)+XMM_INSTALL_CHECK
 51337 00008E77 B80043                  	mov	ax,4300h
 51338 00008E7A CD2F                    	int	2Fh
 51339                                  		; - Multiplex - XMS - INSTALLATION CHECK
 51340                                  		; Return: AL = 80h XMS driver installed
 51341                                  		; AL <> 80h no driver
 51342 00008E7C 3C80                    	cmp	al,80h			; Q: installed
 51343 00008E7E 751D                    	jne	short cXMM_no_driver	; N: set error, quit
 51344                                  ;
 51345                                  ; get the XMM control functions entry point, save it, we
 51346                                  ; need to call it later.
 51347                                  ;
 51348 00008E80 53                      	push	bx
 51349 00008E81 52                      	push	dx
 51350 00008E82 1E                      	push	ds
 51351 00008E83 06                      	push	es
 51352                                  	;mov	ax,(XMM_MULTIPLEX<<8)+XMM_FUNCTION_ADDR
 51353 00008E84 B81043                  	mov	ax,4310h
 51354 00008E87 CD2F                    	int	2Fh
 51355                                  		; - Multiplex - XMS - GET DRIVER ADDRESS
 51356                                  		; Return: ES:BX -> driver entry point
 51357                                  
 51358 00008E89 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 51359                                  
 51360 00008E8E 891E[7B10]              	mov	[XMMcontrol],bx
 51361 00008E92 8C06[7D10]              	mov	[XMMcontrol+2],es
 51362                                  cXMMexit:
 51363 00008E96 F8                      	clc
 51364 00008E97 07                      	pop	es
 51365 00008E98 1F                      	pop	ds
 51366 00008E99 5A                      	pop	dx
 51367 00008E9A 5B                      	pop	bx
 51368 00008E9B 58                      	pop	ax
 51369 00008E9C C3                      	retn				; done
 51370                                  ;
 51371                                  ; set carry if XMM driver not present
 51372                                  ;
 51373                                  cXMM_no_driver:
 51374 00008E9D F9                      	stc
 51375 00008E9E 58                      	pop	ax
 51376 00008E9F C3                      	retn
 51377                                  
 51378                                  ;-----------------------------------------------------------------------------
 51379                                  ;
 51380                                  ; Procedure Name : seg_reinit
 51381                                  ;
 51382                                  ; Inputs	 : ES has final dos code location
 51383                                  ;		   AX = 0 / 1
 51384                                  ;
 51385                                  ; Outputs	 : Patch in the sharer and other tables with seg in ES
 51386                                  ;		   if AX =0
 51387                                  ;		      if first entry
 51388                                  ;			 patch segment & offset of vectors with stub
 51389                                  ;			 and stub with segment in ES
 51390                                  ;		      else
 51391                                  ;			 patch stub with segment in ES
 51392                                  ;
 51393                                  ;		   else if AX = 1
 51394                                  ;			patch segment of vectors with segment in ES
 51395                                  ;
 51396                                  ; NOTE		 : This routine can be called at most twice!
 51397                                  ;
 51398                                  ; Regs Mod.	 : es, ax, di, cx, bx
 51399                                  ;-----------------------------------------------------------------------------
 51400                                  
 51401 00008EA0 00                      num_entry: db	0		; keeps track of the # of times this routine
 51402                                  				; has been called. (0 or 1)
 51403                                  
 51404                                  	; 04/11/2022 - Retro DOS v4.0 (ref: MSDOS 5.0)
 51405                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:0BAB7h
 51406                                  	; 25/05/2019 - Retro DOS v4.0 (ref: MSDOS 6.21)
 51407                                  	; MSDOS 6.21 MSDOS.SYS - DOSCODE:0BDA5h
 51408                                  
 51409                                  	; 23/03/2024 - Retro DOS v5.0 (ref: PCDOS 7.1)
 51410                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0D07Eh
 51411                                  
 51412                                  seg_reinit:	; proc	far
 51413 00008EA1 1E                      	push	ds
 51414                                  
 51415 00008EA2 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 51416                                  
 51417 00008EA7 E89300                  	call	patch_misc_segments	; patch in segments for sharer and 
 51418                                  					; other tables with seg in ES.
 51419                                  	
 51420                                  	; 17/12/2022
 51421                                  	; cx = 0
 51422 00008EAA 39C8                    	cmp	ax,cx ; 0
 51423                                  	;cmp	ax,0
 51424 00008EAC 754A                    	jne	short patch_vec_seg	; patch vectors with segment in es
 51425                                  	; 23/03/2024
 51426                                  	;or	ax, ax
 51427                                  	;jnz	short patch_vec_seg
 51428                                  
 51429                                  	; 23/03/2024
 51430                                  	;cmp	[cs:num_entry],al ; 0
 51431                                  	; 17/12/2022
 51432 00008EAE 2E380E[A08E]            	cmp	[cs:num_entry],cl ; 0
 51433                                  	;cmp	byte [cs:num_entry],0	; Q: is it the first call to this
 51434 00008EB3 7508                    	jne	short second_entry	; N: just patch the stub with 
 51435                                  					;    segment in ES
 51436                                  					; Y: patch the vectors with stub
 51437 00008EB5 8CD8                    	mov	ax,ds
 51438 00008EB7 E84B00                  	call	patch_vec_segments	; patch the segment of vectors
 51439 00008EBA E8CA00                  	call	patch_offset		; patch the offsets of vectors
 51440                                  					; with those in the stub.
 51441                                  	; 17/12/2022
 51442                                  	; cx = 0
 51443                                  second_entry:
 51444 00008EBD 8CC0                    	mov	ax,es			; patch the stub with segment in es
 51445                                  
 51446                                  	;mov	di,OFFSET DOSDATA:DOSINTTABLE
 51447                                  	;;mov	di,1062h	; (same table addr for MSDOS 5.0 and MSDOS 6.21)
 51448                                  	;mov	di,0F7Ah ; 23/03/2024 ; PCDOS 7.1
 51449 00008EBF BF[7A0F]                	mov	di,DOSINTTABLE
 51450                                  	
 51451                                  	; 17/12/2022
 51452                                  	; cx = 0
 51453                                  	;;mov	cx,9
 51454                                  	;mov	cl,9
 51455                                  	; 23/03/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 51456                                  	;;;
 51457                                  	;mov	cx,8
 51458 00008EC2 B108                    	mov	cl,8
 51459                                  	;;;
 51460 00008EC4 1E                      	push	ds			
 51461 00008EC5 07                      	pop	es			; es:di -> DOSINTTABLE
 51462                                  
 51463                                  dosinttabloop:
 51464                                  	;add	di,2
 51465                                  	; 19/06/2023
 51466 00008EC6 47                      	inc	di
 51467 00008EC7 47                      	inc	di
 51468 00008EC8 AB                      	stosw
 51469 00008EC9 E2FB                    	loop	dosinttabloop	
 51470                                  
 51471                                  ; For ROMDOS, this routine will only be called when the DOS wants to
 51472                                  ; use the HMA, so we don't want to check CS
 51473                                  
 51474                                  ;ifndef ROMDOS
 51475 00008ECB 3D00F0                  	cmp	ax,0F000h		; Q: is the DOS running in the HMA
 51476 00008ECE 722D                    	jb	short sr_done		; N: done
 51477                                  ;endif
 51478 00008ED0 E8A3FF                  	call	check_XMM		; Y: set up the XMS entry point
 51479 00008ED3 7228                    	jc	short sr_done		; failed to set up XMS do not do
 51480                                  					; A20 toggling in the stub.
 51481                                  	; 17/12/2022
 51482                                  	; cx = 0
 51483 00008ED5 E82A01                  	call	patch_in_nops		; enable the stub to check A20 state
 51484                                  ; M021-
 51485                                  	;;mov	byte [1211h],1
 51486                                  	;mov	byte [0D66h],1 1 ; 23/03/2024 ; PCDOS 7.1
 51487 00008ED8 C606[660D]01            	mov	byte [DosHasHMA],1	; set flag telling DOS control of HMA
 51488                                  				
 51489                                  					; set pointer to the routine that 
 51490                                  					; patches buggy exepacked code.
 51491                                  	;mov	[FixExePatch],offset DOSCODE:ExePatch
 51492 00008EDD C706[670D][4389]        	mov	word [FixExePatch],ExePatch
 51493                                  					; M068: set pointer to the routine 
 51494                                  					; M068: that detects copy protected
 51495                                  					; M068: apps
 51496                                  	;mov	[ChkCopyProt],offset DOSCODE:IsCopyProt
 51497 00008EE3 C706[6100][E78A]        	mov	word [ChkCopyProt],IsCopyProt
 51498                                  
 51499                                  	; 23/03/2024 - PCDOS 7.1 IBMDOS.COM - DOSCODE:0D0C7h
 51500                                  	;	      (MSDOS 6.22 MSDOS.SYS - DOSCODE:0BDF1h)
 51501 00008EE9 E841FC                  	call	WhatCPUType
 51502 00008EEC 3C01                    	cmp	al,1
 51503 00008EEE 750D                    	jne	short sr_done	; we need Rational Patch only on 286 systems
 51504 00008EF0 C706[690D][6E8A]        	mov	word [RationalPatchPtr],RationalPatch
 51505                                  
 51506                                  	; 19/09/2023
 51507 00008EF6 EB05                    	jmp	short sr_done
 51508                                  
 51509                                  	; 23/03/2024
 51510                                  patch_vec_seg:				; patch vectors with segment in es
 51511 00008EF8 8CC0                    	mov	ax,es
 51512 00008EFA E80800                  	call	patch_vec_segments	; patch in DOSCODE for the segments
 51513                                  					; NOTE we don't have to patch the 
 51514                                  					; offsets as they have been already
 51515                                  					; set to the doscode offsets at
 51516                                  					; DOSINIT.
 51517                                  sr_done:
 51518 00008EFD 2EC606[A08E]01          	mov	byte [cs:num_entry],1
 51519 00008F03 1F                      	pop	ds
 51520 00008F04 CB                      	retf	; ! far return !
 51521                                  
 51522                                  ;----------------------------------------------------------------------------
 51523                                  ;
 51524                                  ; Procedure Name : patch_vec_segments
 51525                                  ;
 51526                                  ; Inputs	 : ax -> has segment address to patch in
 51527                                  ;		   ds -> DOSDATA
 51528                                  ;
 51529                                  ; Outputs	 : Patches in AX as the segment for the following vectors:
 51530                                  ;			
 51531                                  ;			0,20-28,3a-3f
 51532                                  ;
 51533                                  ; Regs. Mod.	 : DI,CX,DX,AX
 51534                                  ;
 51535                                  ;----------------------------------------------------------------------------
 51536                                  
 51537                                  patch_vec_segments:
 51538                                  
 51539 00008F05 06                      	push	es
 51540                                  
 51541 00008F06 31C9                    	xor	cx,cx ; 0
 51542 00008F08 8EC1                    	mov	es,cx
 51543                                  
 51544                                  	;mov	di,82h
 51545 00008F0A BF8200                  	mov	di,INTBASE+2		; di -> segment of int 20h vector
 51546                                  
 51547 00008F0D 26A30200                	mov	[es:2],ax		; segment of default divide trap handler
 51548                                  
 51549                                  					; set vectors 20h & 21h
 51550                                  	; 04/11/2022
 51551                                  	;mov	cx,2
 51552                                  	; 17/12/2022
 51553                                  	;mov	cl,2
 51554                                  ps_set1:
 51555 00008F11 AB                      	stosw	; int 20h segment
 51556                                  	;add	di,2
 51557                                  	; 17/12/2022
 51558 00008F12 47                      	inc	di
 51559 00008F13 47                      	inc	di
 51560                                  	;loop	ps_set1
 51561                                  
 51562                                  	; 17/12/2022
 51563 00008F14 AB                      	stosw	; int 21h segment
 51564                                  	;inc	di
 51565                                  	;inc	di
 51566                                  
 51567                                  	;add	di,4			; skip int 22h vector
 51568 00008F15 83C706                  	add	di,6 ; *
 51569                                  
 51570 00008F18 AB                      	stosw				; set int 23h
 51571 00008F19 83C706                  	add	di,6			; skip int 24h
 51572                                  
 51573                                  					; set vectors 25h-28h and 2Ah-3Fh
 51574                                  	; 04/11/2022
 51575                                  	;mov	cx,4			; set 4 segments
 51576                                  	; 17/12/2022
 51577 00008F1C B104                    	mov	cl,4
 51578                                  ps_set2:
 51579 00008F1E AB                      	stosw
 51580                                  	;add	di,2
 51581                                  	; 17/12/2022
 51582 00008F1F 47                      	inc	di
 51583 00008F20 47                      	inc	di
 51584 00008F21 E2FB                    	loop	ps_set2
 51585                                  
 51586 00008F23 83C704                  	add	di,4			; skip int 29h vector (fast con) as it may
 51587                                  					;   already be set.
 51588                                  	; 04/11/2022
 51589                                  	;mov	cx,6			; set 6 segs (skip 2 between each)
 51590                                  	; 17/12/2022
 51591 00008F26 B106                    	mov	cl,6			;  set segs for ints 2Ah-2Fh
 51592                                  ps_set3:
 51593 00008F28 AB                      	stosw
 51594                                  	;add	di,2
 51595                                  	; 17/12/2022
 51596 00008F29 47                      	inc	di
 51597 00008F2A 47                      	inc	di
 51598 00008F2B E2FB                    	loop	ps_set3
 51599                                  
 51600                                  ; 30h & 31H is the CPM call entry point whose segment address is set up by
 51601                                  ; below. So skip it.
 51602                                  
 51603 00008F2D 83C708                  	add	di,8			; skip vector 30h & 31h 
 51604                                  	
 51605                                  	; 04/11/2022
 51606                                  	;mov	cx,14			; set 14 segs (skip 2 between each)
 51607                                  	; 17/12/2022
 51608 00008F30 B10E                    	mov	cl,14			;  sets segs for ints 32h-3Fh
 51609                                  ps_set4:
 51610 00008F32 AB                      	stosw
 51611                                  	;add	di,2
 51612                                  	; 17/12/2022
 51613 00008F33 47                      	inc	di
 51614 00008F34 47                      	inc	di
 51615 00008F35 E2FB                    	loop	ps_set4
 51616                                  
 51617                                  ; set offset of int2f
 51618                                  
 51619                                  ;if installed
 51620                                  ;	mov	word ptr es:[02fh * 4],offset doscode:int2f
 51621                                  ;endif
 51622                                  	;mov	[es:0C3h],ax
 51623 00008F37 26A3C300                	mov	[es:ENTRYPOINT+3],ax
 51624                                  	; 17/12/2022
 51625                                  	; cx = 0
 51626 00008F3B 07                      	pop	es
 51627 00008F3C C3                      	retn
 51628                                  
 51629                                  ;---------------------------------------------------------------------------
 51630                                  ;
 51631                                  ; Procedure Name : patch_misc_segments
 51632                                  ;
 51633                                  ; Inputs	 : es = segment to patch in
 51634                                  ;		   ds = dosdata
 51635                                  ;
 51636                                  ; outputs	 : patches in the sharer and other tables in the dos
 51637                                  ;		   with right dos code segment in es
 51638                                  ;
 51639                                  ; Regs Mod	 : DI,SI,CX
 51640                                  ;
 51641                                  ;---------------------------------------------------------------------------
 51642                                  
 51643                                  patch_misc_segments:
 51644                                  
 51645 00008F3D 53                      	push	bx
 51646 00008F3E 06                      	push	es
 51647 00008F3F 50                      	push	ax
 51648                                  
 51649 00008F40 8CC0                    	mov	ax,es			; ax - > DOS segment
 51650                                  	
 51651 00008F42 1E                      	push	ds
 51652 00008F43 07                      	pop	es			; es -> DOSDATA
 51653                                  	
 51654                                  ; initialize the jump table for the sharer...
 51655                                  
 51656                                  	;mov	di,offset dosdata:jshare
 51657                                  	;mov	di,90h
 51658 00008F44 BF[9000]                	mov	di,JShare
 51659                                  	;;mov	bx,[0AAAh]
 51660                                  	;mov	bx,[0AA3h] ; 23/03/2024 ; PCDOS 7.1 
 51661 00008F47 8B1E[A30A]              	mov	bx,[TEMP_DOSLOC]	; bx = location to which the share
 51662                                  					; table was patched during the first
 51663                                  					; call to this routine
 51664 00008F4B B90F00                  	mov	cx,15
 51665                                  jumptabloop:
 51666                                  	;add	di,2			; skip offset
 51667                                  	; 17/12/2022
 51668 00008F4E 47                      	inc	di
 51669 00008F4F 47                      	inc	di
 51670 00008F50 83FBFF                  	cmp	bx,-1 ; 0FFFFh		; Q: is this called for the 1st time
 51671 00008F53 7405                    	je	short share_patch	; Y: patch in sharer table
 51672                                  					; N: 
 51673 00008F55 263B1D                  	cmp	bx,[es:di]		; Q: has share been installed
 51674 00008F58 7501                    	jne	short no_share_patch	; Y: don't patch in sharer table
 51675                                  share_patch:
 51676 00008F5A AB                      	stosw				; drop in segment
 51677                                  no_share_patch:
 51678 00008F5B E2F1                    	loop	jumptabloop
 51679                                  					; BUGBUG patching the country info 
 51680                                  					; with dosdata can be done inline
 51681                                  					; in dosinit.
 51682                                  					; for dos 3.3 country info
 51683                                  					; table address
 51684                                  
 51685                                  	;mov	si,offset dosdata:country_cdpg
 51686                                  	;mov	si,122Ah   
 51687 00008F5D BE[2A12]                	mov	si,COUNTRY_CDPG
 51688                                  					; initialize double word
 51689                                  					; pointers with dosdata in ds
 51690                                  	;mov	[si+4Fh],ds
 51691                                  	;mov	[si+54h],ds
 51692                                  	;mov	[si+59h],ds
 51693                                  	;mov	[si+5Eh],ds
 51694                                  	;mov	[si+80h],ds
 51695                                  	;mov	[si+63h],ds
 51696 00008F60 8C5C4F                  	mov	[si+DOS_CCDPG.ccUcase_ptr+2],ds    
 51697 00008F63 8C5C54                  	mov	[si+DOS_CCDPG.ccFileUcase_ptr+2],ds 
 51698 00008F66 8C5C59                  	mov	[si+DOS_CCDPG.ccFileChar_ptr+2],ds
 51699 00008F69 8C5C5E                  	mov	[si+DOS_CCDPG.ccCollate_ptr+2],ds
 51700 00008F6C 8C9C8000                	mov	[si+DOS_CCDPG.ccMono_ptr+2],ds
 51701 00008F70 8C5C63                  	mov	[si+DOS_CCDPG.ccDBCS_ptr+2],ds	
 51702                                  
 51703                                  					; fastopen routines are in doscode
 51704                                  					; so patch with doscode seg in ax
 51705                                  
 51706                                  	;mov	si,offset dosdata:fastopentable
 51707                                  	;mov	si,0D30h
 51708 00008F73 BE[3C11]                	mov	si,FastOpenTable
 51709                                  
 51710                                  	; 17/12/2022
 51711                                  	; bx = [TEMP_DOSLOC]
 51712 00008F76 83FBFF                  	cmp	bx,-1
 51713                                  	;cmp	word [TEMP_DOSLOC],-1	; Q: first time 
 51714 00008F79 7405                    	je	short fast_patch	; Y: patch segment
 51715                                  	;mov	cx,[TEMP_DOSLOC]
 51716                                  					; Q: has fastopen patched in it's
 51717                                  					;    segment
 51718                                  	; 17/12/2022
 51719 00008F7B 3B5C04                  	cmp	bx,[si+fastopen_entry.name_caching+2]
 51720                                  	;;cmp	cx,[si+4]
 51721                                  	;cmp	cx,[si+fastopen_entry.name_caching+2]
 51722 00008F7E 7503                    	jne	short no_fast_patch	; Y: don't patch in doscode seg
 51723                                  
 51724                                  fast_patch:
 51725                                  	;mov	[si+4],ax
 51726 00008F80 894404                  	mov	[si+fastopen_entry.name_caching+2],ax
 51727                                  no_fast_patch:
 51728                                  	; 17/12/2022
 51729                                  	; cx = 0
 51730 00008F83 58                      	pop	ax
 51731 00008F84 07                      	pop	es
 51732 00008F85 5B                      	pop	bx
 51733                                  
 51734 00008F86 C3                      	retn
 51735                                  
 51736                                  ;--------------------------------------------------------------------------
 51737                                  ;
 51738                                  ; Procedure Name : patch_offset
 51739                                  ; 
 51740                                  ; Inputs	 : NONE
 51741                                  ;
 51742                                  ; Outputs	 : Patches in the offsets in the low_mem_stub for vectors
 51743                                  ;		   0,20-28,3a-3f, and 30,31
 51744                                  ;
 51745                                  ;
 51746                                  ; Regs. Mod	 : AX,DI,CX
 51747                                  ;--------------------------------------------------------------------------
 51748                                  
 51749                                  patch_offset:
 51750 00008F87 06                      	push	es		; preserve es
 51751                                  
 51752 00008F88 31C0                    	xor	ax,ax
 51753 00008F8A 8EC0                    	mov	es,ax
 51754                                  				; set default divide trap address
 51755                                  	;mov	word ptr es:[0],offset dosdata:ldivov
 51756                                  	;;mov	word [es:0],108Ah
 51757                                  	;mov	word [es:0],0F9Eh ; 23/03/2024 ; PCDOS 7.1
 51758 00008F8C 26C7060000[9E0F]        	mov	word [es:0],ldivov
 51759                                  
 51760                                  	;mov	di,80h
 51761 00008F93 BF8000                  	mov	di,INTBASE	; di-> offset of int 20 handler
 51762                                  	;mov	ax,offset dosdata:lirett
 51763                                  	;mov	ax,10DAh
 51764 00008F96 B8[6E10]                	mov	ax,lirett
 51765                                  				; set vectors 20h & 21h to point to iret.
 51766                                  	; 17/12/2022
 51767                                  	; cx = 0
 51768                                  
 51769                                  	;mov	cx,2		; set 2 offsets (skip 2 between each)
 51770                                  po_iset1:
 51771 00008F99 AB                      	stosw	; int 20h offset
 51772                                  	;add	di,2 ; *
 51773                                  	;loop	po_iset1
 51774                                  	; 17/12/2022
 51775 00008F9A 47                      	inc	di
 51776 00008F9B 47                      	inc	di
 51777 00008F9C AB                      	stosw	; int 21h offset
 51778                                  
 51779                                  	;add	di,4		; skip vector 22h
 51780                                  	; 17/12/2022
 51781 00008F9D 83C706                  	add	di,6 ; *
 51782                                  
 51783 00008FA0 AB                      	stosw			; set offset of 23h
 51784                                  	;add	di,6		; skip 24h
 51785                                  	; 19/09/2023
 51786 00008FA1 83C712                  	add	di,18		; skip 23h segment and int 24-25-26-27h
 51787                                  
 51788                                  				; set vectors 25-28 and 2a-3f to iret.
 51789                                  	; 04/11/2022
 51790                                  	;mov	cx,4		; set 4 offsets (skip 2 between each)
 51791                                  	; 19/09/2023
 51792                                  	; 17/12/2022
 51793                                  	;mov	cl,4		; sets offsets for ints 25h-28h
 51794                                  po_iset2:
 51795 00008FA4 AB                      	stosw		; set offset for int 28h ; 19/09/2023
 51796                                  	;add	di,2
 51797                                  	; 19/09/2023
 51798                                  	; 17/12/2022
 51799                                  	;inc	di
 51800                                  	;inc	di
 51801                                  	; 19/09/2023
 51802                                  	;loop	po_iset2
 51803                                  
 51804                                  	;add	di,4		; skip vector 29h
 51805                                  	; 19/09/2023
 51806 00008FA5 83C706                  	add	di,6	; skip int 28h segment and int 29h ; 19/09/2023
 51807                                  
 51808                                  	; 04/11/2022
 51809                                  	;mov	cx,6		; set 6 offsets (skip 2 between each)
 51810                                  	; 17/12/2022
 51811                                  	;mov	cl,6		; sets offsets for ints 2Ah-2Fh
 51812 00008FA8 B105                    	mov	cl,5		; sets offsets for ints 2Ah-2Eh
 51813                                  po_iset3:
 51814 00008FAA AB                      	stosw
 51815                                  	;add	di,2
 51816                                  	; 17/12/2022
 51817 00008FAB 47                      	inc	di
 51818 00008FAC 47                      	inc	di
 51819 00008FAD E2FB                    	loop	po_iset3
 51820                                  
 51821                                  ; 30h & 31H is the CPM call entry point whose offset address is set up by
 51822                                  ; below. So skip it.
 51823                                  
 51824                                  	;add	di,8		; skip vector 30h & 31h
 51825                                  	; 17/12/2022
 51826 00008FAF 83C70C                  	add	di,12		; skip vector 2Fh, 30h & 31h
 51827                                  
 51828                                  	; 04/11/2022
 51829                                  	;mov	cx,14		; set 14 offsets (skip 2 between each)
 51830                                  				;  sets offsets for ints 32h-3Fh
 51831                                  	; 17/12/2022
 51832 00008FB2 B10E                    	mov	cl,14 ; 26/06/2019
 51833                                  po_iset4:
 51834 00008FB4 AB                      	stosw
 51835                                  	;add	di,2
 51836                                  	; 17/12/2022
 51837 00008FB5 47                      	inc	di
 51838 00008FB6 47                      	inc	di
 51839 00008FB7 E2FB                    	loop	po_iset4
 51840                                  
 51841                                  ;if installed
 51842                                  	;mov	word ptr es:[02fh * 4],offset dosdata:lint2f
 51843                                  	;;mov	word [es:0BCh],10C6h ; (MSDOS 5.0 & 6.21)
 51844                                  	;mov	word [es:0BCh],0FDAh ; PCDOS 7.1 ; 23/03/2024
 51845 00008FB9 26C706BC00[DA0F]        	mov	word [es:(2Fh*4)],lint2f
 51846                                  ;endif
 51847                                  
 51848                                  ; set up entry point call at vectors 30-31h
 51849                                  	;mov	byte [es:0C0h],0EAh
 51850 00008FC0 26C606C000EA            	mov	byte [es:ENTRYPOINT],mi_long_jmp
 51851                                  	;mov	word [es:0C1h],10D0h ;; 0FE4h ; 23/03/2024 (PCDOS 7.1)
 51852                                  
 51853 00008FC6 26C706C100[E40F]        	mov	word [es:ENTRYPOINT+1],lcall_entry
 51854                                  
 51855                                  							; 19/09/2023
 51856                                  	;mov	word [es:80h],1094h ;; 0FA8h ; 23/03/2024
 51857 00008FCD 26C7068000[A80F]        	mov	word [es:addr_int_abort],lquit		; int 20h
 51858                                  	;mov	word [es:84h],109Eh ;; 0FB2h
 51859 00008FD4 26C7068400[B20F]        	mov	word [es:addr_int_command],lcommand	; int 21h
 51860                                  	;mov	word [es:94h],10A8h ;; 0FBCh
 51861 00008FDB 26C7069400[BC0F]        	mov	word [es:addr_int_disk_read],labsdrd	; int 25h
 51862                                  	;mov	word [es:98h],10B2h ;; 0FC6h
 51863 00008FE2 26C7069800[C60F]        	mov	word [es:addr_int_disk_write],labsdwrt	; int 26h
 51864                                  	;mov	word [es:9Ch],10BCh ;; 0FD0h
 51865 00008FE9 26C7069C00[D00F]        	mov	word [es:addr_int_keep_process],lstay_resident	; int 27h
 51866                                  
 51867                                  	; 17/12/2022
 51868                                  	; CX = 0
 51869 00008FF0 07                      	pop	es		; restore es
 51870 00008FF1 C3                      	retn
 51871                                  
 51872                                  ;--------------------------------------------------------------------------
 51873                                  ;
 51874                                  ; 	Procedure Name	:	patch_in_nops
 51875                                  ;
 51876                                  ; 	Entry		: 	ES -> DOSDATA
 51877                                  ;
 51878                                  ;	Regs Mod	: 	cx, di
 51879                                  ;
 51880                                  ;	Description:
 51881                                  ;		This routine patches in 2 nops at the offsets specified in 
 51882                                  ;	patch_table. This basically enables the low mem stub to start 
 51883                                  ;	making XMS calls.
 51884                                  ;
 51885                                  ;--------------------------------------------------------------------------
 51886                                  
 51887                                  	; 04/11/2022
 51888                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:0BC50h
 51889                                  
 51890                                  	; 23/03/2024
 51891                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:0BF42h
 51892                                  	; 23/03/2024 - Retro DOS v5.0
 51893                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0D1E9h
 51894                                  
 51895                                  patch_table:	; label	byte
 51896                                  	;dw	offset dosdata:i0patch
 51897                                  	;dw	offset dosdata:i20patch
 51898                                  	;dw	offset dosdata:i21patch
 51899                                  	;dw	offset dosdata:i25patch
 51900                                  	;dw	offset dosdata:i26patch
 51901                                  	;dw	offset dosdata:i27patch
 51902                                  	;dw	offset dosdata:i2fpatch
 51903                                  	;dw	offset dosdata:cpmpatch
 51904 00008FF2 [9E0F]                  	dw	i0patch
 51905 00008FF4 [A80F]                  	dw	i20patch
 51906 00008FF6 [B20F]                  	dw	i21patch
 51907 00008FF8 [BC0F]                  	dw	i25patch
 51908 00008FFA [C60F]                  	dw	i26patch
 51909 00008FFC [D00F]                  	dw	i27patch
 51910 00008FFE [DA0F]                  	dw	i2fpatch
 51911 00009000 [E40F]                  	dw	cpmpatch
 51912                                  
 51913                                  patch_table_size equ ($-patch_table)/2
 51914                                  
 51915                                  patch_in_nops:
 51916 00009002 50                      	push	ax
 51917 00009003 56                      	push	si
 51918 00009004 BE[F28F]                	mov	si,patch_table
 51919 00009007 B89090                  	mov	ax,9090h ; nop, nop
 51920                                  	; 17/12/2022
 51921                                  	; cx = 0
 51922                                  	;mov	cx,8
 51923                                  	;mov	cx,patch_table_size ; 8
 51924 0000900A B108                    	mov	cl,patch_table_size ; 8
 51925                                  pin_loop:
 51926 0000900C 2E8B3C                  	mov	di,[cs:si]
 51927 0000900F AB                      	stosw
 51928                                  	;add	si,2
 51929                                  	; 17/12/2022
 51930 00009010 46                      	inc	si
 51931 00009011 46                      	inc	si
 51932 00009012 E2F8                    	loop	pin_loop
 51933 00009014 5E                      	pop	si
 51934 00009015 58                      	pop	ax
 51935 00009016 C3                      	retn
 51936                                  
 51937                                  ; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 51938                                  ; ---------------------------------------------------------------------------
 51939                                  ; MSDOS 5.0 - MSDOS.SYS offset BC77h, file offset 7EA7h
 51940                                  ; ---------------------------------------------------------------------------
 51941                                  ; 23/03/2024
 51942                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0BF69h)
 51943                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0D20Fh
 51944                                  
 51945                                  	; 05/12/2022 - temporary ; (paragraph alinment)
 51946                                  DOSCODE_END:
 51947                                  
 51948                                  	; 23/03/2024
 51949                                  	;;times	9 db 0	; db 9 dup(0)
 51950                                  	;; 18/12/2022
 51951                                  	;dw	0	; times 2 db 0
 51952                                  	
 51953                                  	; 23/03/2024
 51954                                  	;times	7 db 0	; MSDOS 6.22 MSDOS.SYS
 51955                                  	
 51956                                  	; 23/03/2024 - Retro DOS v5.0
 51957                                  	;db	0	; PCDOS 7.1 IBMDOS.COM
 51958 00009017 00<rep Ch>              	times	12 db 0
 51959                                  
 51960                                  ;align 16
 51961                                  	; DOSCODE:BC80h	(MSDOS 5.0 MSDOS.SYS file offset 7EB0h)
 51962                                  	; MSDOS.SYS file offset: 32432 (start of DOSDATA)
 51963                                  
 51964                                  	; 23/03/2024 
 51965                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0D210h
 51966                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0BF70h)
 51967                                  
 51968                                  ; ---------------------------------------------------------------------------
 51969                                  
 51970                                  ;memstrt label word
 51971                                  ; ---------------------------------------------------------------------------
 51972                                  ; MSDOS 6.21 - MSDOS.SYS offset BF69h, file offset 8189h
 51973                                  ; ---------------------------------------------------------------------------
 51974                                  
 51975                                  MEMSTRT: ; 25/04/2019 - Retro DOS v4.0
 51976                                  
 51977                                  ; if not ROMDOS, then we close the dos code segment, otherwise we close
 51978                                  ; the dos initialization segment
 51979                                  
 51980                                  ;ifndef ROMDOS
 51981                                  
 51982                                  ;doscode ends
 51983                                  
 51984                                  ;else
 51985                                  
 51986                                  ;;dosinitseg ends
 51987                                  
 51988                                  ;endif ; ROMDOS
 51989                                  
 51990                                  ;============================================================================
 51991                                  
 51992                                  ; DPUBLIC <ParaRound, cXMM_no_driver, cXMMexit, char_init_loop, charinit>
 51993                                  ; DPUBLIC <check_XMM, continit, dosinttabloop, endlist>
 51994                                  ; DPUBLIC <initiret, iset1, iset2, jumptabloop, nxtentry>
 51995                                  ; DPUBLIC <notmax,  patch_offset, perdrv>
 51996                                  ; DPUBLIC <perunit, po_iset1, po_iset2, po_iset3>
 51997                                  ; DPUBLIC <ps_set1, ps_set2, ps_set3, seg_reinit>
 51998                                  ; DPUBLIC <sr_done, version_fake_table, xxx>
 51999                                  
 52000                                  ;; burasý doscode sonu
 52001                                  
 52002                                  ;============================================================================
 52003                                  ; DOSDATA
 52004                                  ;============================================================================
 52005                                  ; 29/04/2019 - Retro DOS 4.0
 52006                                  ; 24/03/2024 - Retro DOS 5.0
 52007                                  
 52008                                  ;[BITS 16]
 52009                                  
 52010                                  ;[ORG 0]
 52011                                  
 52012                                  ; 25/04/2019 - Retro DOS v4.0
 52013                                  
 52014                                  ;============================================================================
 52015                                  ; DOSDATA - MSDOS 6.21 - MSDOS.SYS Offset 0BF70h, file offset 8190h
 52016                                  ;============================================================================
 52017                                  
 52018                                  ;align 16
 52019                                  	; DOSDATA (MSDOS.SYS kernel DATA) segment starts here...
 52020                                  	; (4970 bytes for MSDOS 6.21)
 52021                                  	; (4976 bytes for Retro DOS v4.0, 25/05/2019 modification.)
 52022                                  
 52023                                  ;============================================================================
 52024                                  ; MSCONST.ASM (MSDOS 6.0, 1991)
 52025                                  ;============================================================================
 52026                                  ; 03/11/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 52027                                  ; 25/04/2019 - Retro DOS 4.0 (MSDOS 6.21)
 52028                                  ; 16/07/2018 - Retro DOS 3.0	
 52029                                  
 52030                                  ;Break <Initialized data and data used at DOS initialization>
 52031                                  ;----------------------------------------------------------------------------
 52032                                  
 52033                                  ; We need to identify the parts of the data area that are relevant to tasks
 52034                                  ; and those that are relevant to the system as a whole. Under 3.0, the system
 52035                                  ; data will be gathered with the system code. The process data under 2.x will
 52036                                  ; be available for swapping and under 3.0 it will be allocated per-process.
 52037                                  ;
 52038                                  ; The data that is system data will be identified by [SYSTEM] in the comments
 52039                                  ; describing that data item.
 52040                                  
 52041                                  ;DOSDATA SEGMENT
 52042                                  
 52043                                  ; 04/11/2022
 52044                                  ;[ORG 0]
 52045                                  
 52046                                  ; ----------------------------------------------------------------------------
 52047                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 52048                                  ; ----------------------------------------------------------------------------
 52049                                  ; DOSDATA segment start offset from beginning of MSDOS.SYS file: 32432 (7EB0h)
 52050                                  ; (3DD0h+7EB0h = 0BC80h) - for MSDOS 5.0 kernel file -
 52051                                  ; ----------------------------------------------------------------------------
 52052                                  
 52053                                  ; 04/11/2022
 52054                                  
 52055                                  ;DOSDATA:0000h
 52056                                  
 52057 00009023 90<rep Dh>              align 16
 52058                                  
 52059                                  ; ----------------------------------------------------------------------------
 52060                                  ; 06/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 52061                                  ; ----------------------------------------------------------------------------
 52062                                  
 52063                                  segment .data  vstart=0 ; 06/12/2022
 52064                                  
 52065                                  ; ============================================================================
 52066                                  
 52067                                  ; 06/12/2022
 52068                                  ;DOSDATASTART equ $
 52069                                  DOSDATASTART:
 52070                                  
 52071                                  ;hkn; add 4 bytes to get correct offsets since jmp has been removed in START
 52072                                  
 52073                                  	;; 03/11/2022
 52074                                  	;jmp	DOSINIT		; MSDOS 5.0 - MSDOS.SYS (DOSDATA:0000h)
 52075                                  
 52076                                  	; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 52077                                  	;db	4 dup (?)	
 52078 00000000 00<rep 4h>              	times	4 db 0
 52079                                  
 52080                                  	; 29/04/2019 - Retro DOS v4.0 modification
 52081                                  	;dw 	_$STARTCODE ; DOSCODE offset and/or size of DOSDATA
 52082                                  	;dw	0
 52083                                  
 52084                                  	;EVEN
 52085                                  
 52086                                  ;align 2
 52087                                  
 52088                                  ; WANGO!!! The following word is used by SHARE and REDIR to determin data
 52089                                  ; area compatability. This location must be incremented EACH TIME the data
 52090                                  ; area here gets mucked with.
 52091                                  ;
 52092                                  ; Also, do NOT change this position relative to DOSDATA:0.
 52093                                  
 52094                                  MSCT001S:	; LABEL BYTE
 52095                                  	
 52096                                  DataVersion:	
 52097 00000004 0100                    	dw	1	;AC000; [SYSTEM] version number for DOS DATA
 52098                                  
 52099                                  ;hkn; add 8 bytes to get correct offsets since BugTyp, BugLev and "BUG " has 
 52100                                  ;hkn; been removed to DOSCODE above
 52101                                  
 52102                                  ;M044
 52103                                  ; First part of save area for saving last para of Window memory
 52104                                  
 52105                                  WinoldPatch1:	; db 8 dup (?)	;M044
 52106 00000006 00<rep 8h>              	times	8 db 0
 52107                                  
 52108                                  	; MSDOS 6.21 DOSDATA:000Eh
 52109                                  MYNUM:			; Offset 000Eh
 52110 0000000E 0000                    	dw	0	; [SYSTEM] A number that goes with MYNAME
 52111                                  FCBLRU: 		; [SYSTEM] LRU count for FCB cache
 52112 00000010 0000                    	dw	0
 52113                                  OpenLRU:
 52114 00000012 0000                    	dw	0	; [SYSTEM] LRU count for FCB cache opens
 52115                                  OEM_HANDLER: 		
 52116 00000014 FFFFFFFF                	dd	-1	; [SYSTEM] Pointer to OEM handler code
 52117                                  
 52118                                  ;	BUGBUG - who uses LeaveAddr?  What if we want to rework the
 52119                                  ;;			way that we leave DOS???? - jgl
 52120                                  
 52121                                  LeaveAddr:
 52122 00000018 [F603]                  	dw	LeaveDOS  ; <<OFFSET DOSCODE:LeaveDOS>> ; [SYSTEM]
 52123                                  RetryCount:		
 52124 0000001A 0300                    	dw	3	; [SYSTEM] Share retries
 52125                                  RetryLoop:
 52126 0000001C 0100                    	dw	1	; [SYSTEM] Share retries
 52127                                  LastBuffer:
 52128 0000001E FFFFFFFF                	dd	-1	; [SYSTEM] Buffer queue recency pointer
 52129                                  CONTPOS:
 52130 00000022 0000                    	dw	0	; [SYSTEM] location in buffer of next read
 52131                                  arena_head:
 52132 00000024 0000                    	dw	0	; [SYSTEM] Segment # of first arena in memory
 52133                                  
 52134                                  ;; 16/07/2018
 52135                                  ;;***************************************************************************
 52136                                  ;; NOTE: INT 21H AH=52H !  (http://stanislavs.org/helppc/int_21-52.html)
 52137                                  ;;***************************************************************************
 52138                                  ;; INT 21,52 - Get Pointer to DOS "INVARS" (Undocumented)
 52139                                  ;;
 52140                                  ;;	AH = 52h
 52141                                  ;;
 52142                                  ;;	on return:
 52143                                  ;;	ES:BX = pointer to DOS "invars", a table of pointers used by DOS.
 52144                                  ;;		Known "invars" fields follow (varies with DOS version):
 52145                                  ;;
 52146                                  ;;	Offset Size		 Description
 52147                                  ;;
 52148                                  ;;	 -12   word   sharing retry count (DOS 3.1-3.3)
 52149                                  ;;	 -10   word   sharing retry delay  (DOS 3.1-3.3)
 52150                                  ;;	  -8   dword  pointer to current disk buffer (DOS 3.x)
 52151                                  ;;	  -4   word   pointer in DOS code segment of unread CON input;
 52152                                  ;;		      0 indicates no unread input (DOS 3.x)
 52153                                  ;;	  -2   word   segment of first Memory Control Block (MCB)
 52154                                  ;;	  00   dword  pointer to first DRIVE PARAMETER TABLE (A:) in chain
 52155                                  ;;	  04   dword  pointer to DOS System File Table (SFT)
 52156                                  ;;	  08   dword  pointer to $CLOCK device driver
 52157                                  ;;	  0C   dword  pointer to CON device driver
 52158                                  ;;	  10   byte   number of logical drives in system
 52159                                  ;;	  11   word   maximum bytes/block of any block device
 52160                                  ;;	  13   dword  pointer to DOS cache buffer header
 52161                                  ;;	  17 18bytes  NUL device header, first 4 bytes of device header
 52162                                  ;;		      point to the next device in device chain
 52163                                  ;;
 52164                                  ;;***************************************************************************
 52165                                  
 52166                                  ; The following block of data is used by SYSINIT. 
 52167                                  ; Do not change the order or size of this block
 52168                                  
 52169                                  ;SYSINITVAR:
 52170                                  ;----------------------------------------------------------------------------
 52171                                  SYSINITVARS:
 52172                                  DPBHEAD:
 52173 00000026 00000000                	dd	0	; [SYSTEM] Pointer to head of DPB-FAT list
 52174                                  SFT_ADDR:
 52175 0000002A [CC000000]              	dd	SFTABL	; [SYSTEM] Pointer to first SFT table
 52176                                  BCLOCK:
 52177 0000002E 00000000                	dd	0	; [SYSTEM] The CLOCK device
 52178                                  BCON:
 52179 00000032 00000000                	dd	0	; [SYSTEM] Console device entry points
 52180                                  MAXSEC:
 52181 00000036 8000                    	dw	128	; [SYSTEM] Maximum allowed sector size
 52182                                  BUFFHEAD:
 52183 00000038 00000000                	dd	0	; [SYSTEM] Pointer to head of buffer queue
 52184                                  CDSADDR:
 52185 0000003C 00000000                	dd	0	; [SYSTEM] Pointer to curdir structure table
 52186                                  SFTFCB:
 52187 00000040 00000000                	dd	0	; [SYSTEM] pointer to FCB cache table
 52188                                  KEEPCOUNT:
 52189 00000044 0000                    	dw	0	; [SYSTEM] count of FCB opens to keep
 52190                                  NUMIO:
 52191 00000046 00                      	db	0	; [SYSTEM] Number of disk tables
 52192                                  CDSCOUNT:
 52193 00000047 00                      	db	0	; [SYSTEM] Number of CDS structures in above
 52194                                  
 52195                                  ; A fake header for the NUL device
 52196                                  NULDEV:
 52197 00000048 00000000                	dd	0	; [SYSTEM] Link to rest of device list
 52198                                  	;dw	8004h
 52199 0000004C 0480                    	dw	DEVTYP|ISNULL ; [SYSTEM] Null device attributes
 52200 0000004E [CD0D]                  	dw	SNULDEV	; [SYSTEM] Strategy entry point
 52201 00000050 [D30D]                  	dw	INULDEV	; [SYSTEM] Interrupt entry point
 52202 00000052 4E554C2020202020        	db	"NUL     " ; [SYSTEM] Name of null device
 52203                                  SPLICES:
 52204 0000005A 00                      	db	0	; [SYSTEM] TRUE => splices being done
 52205                                  
 52206                                  Special_Entries:
 52207 0000005B 0000                    	dw	0	; [SYSTEM] address of special entries ;AN000;
 52208                                  UU_IFS_DOS_CALL:
 52209 0000005D 00000000                	dd	0	; [SYSTEM] entry for IFS DOS service ;AN000;
 52210                                  ; 
 52211                                  ; UU_IFS_HEADER:
 52212                                  ; 	dd	0	; [SYSTEM] IFS header chain ;AN000;
 52213                                  
 52214                                  ChkCopyProt:
 52215 00000061 0000                    	dw	0	; M068
 52216                                  A20OFF_PSP:
 52217 00000063 0000                    	dw	0	; M068
 52218                                  BUFFERS_PARM1:
 52219 00000065 0000                    	dw	0	; [SYSTEM] value of BUFFERS= ,m	;AN000;
 52220                                  BUFFERS_PARM2:
 52221 00000067 0000                    	dw	0	; [SYSTEM] value of BUFFERS= ,n ;AN000;
 52222                                  BOOTDRIVE:
 52223 00000069 00                      	db	0	; [SYSTEM] the boot drive ;AN000;
 52224                                  DDMOVE:
 52225 0000006A 00                      	db	0 	; [SYSTEM] 1 if we need DWORD move ;AN000;
 52226                                  EXT_MEM_SIZE:
 52227 0000006B 0000                    	dw	0	; [SYSTEM] extended memory size	;AN000;
 52228                                  
 52229                                  HASHINITVAR: ; LABEL   WORD	; AN000;
 52230                                  ;
 52231                                  ; Replaced by next two declarations
 52232                                  ;
 52233                                  ;UU_BUF_HASH_PTR:
 52234                                  ;	dd	0	; [SYSTEM] buffer Hash table addr
 52235                                  ;UU_BUF_HASH_COUNT:
 52236                                  ;	dw	1	; [SYSTEM] number of Hash entries
 52237                                  
 52238                                  BufferQueue:
 52239 0000006D 00000000                	dd	0	; [SYSTEM] Head of the buffer Queue
 52240                                  DirtyBufferCount:
 52241 00000071 0000                    	dw	0	; [SYSTEM] Count of Dirty buffers in the Que
 52242                                  			; BUGBUG ---- change to byte
 52243                                  SC_CACHE_PTR:
 52244 00000073 00000000                	dd	0	; [SYSTEM] secondary cache pointer
 52245                                  SC_CACHE_COUNT:
 52246 00000077 0000                    	dw	0 	; [SYSTEM] secondary cache count
 52247                                  BuffInHMA:
 52248 00000079 00                      	db	0	; Flag to indicate that buffs are in HMA
 52249                                  LoMemBuff:
 52250 0000007A 00000000                	dd	0	; Ptr to intermediate buffer
 52251                                  			;  in Low mem when buffs are in HMA
 52252                                  ;
 52253                                  ; All variables which have UU_ as prefix can be reused for other
 52254                                  ; purposes and can be renamed. All these variables were used for
 52255                                  ; EMS support of Buffer Manager. Now they are useless for Buffer
 52256                                  ; manager ---- MOHANS
 52257                                  ;
 52258                                  	;I_am	UU_BUF_EMS_FIRST_PAGE,3,<0,0,0>  
 52259                                  UU_BUF_EMS_FIRST_PAGE:	
 52260 0000007E 000000                  	db	0,0,0	; holds the first page above 640K
 52261                                  
 52262                                  	;;I_am	UU_BUF_EMS_NPA640,WORD,<0> ; holds the number of pages 
 52263                                  ;UU_BUF_EMS_NPA640:			   ; above 640K	
 52264                                  ;	dw	0			
 52265                                  
 52266                                  CL0FATENTRY:
 52267 00000081 FFFF                    	dw	-1	; M014:	Holds the data that
 52268                                  			; is used in pack/unpack rts.
 52269                                  			; in fat.asm if cluster 0 is specified.
 52270                                  			; SR;
 52271                                  IoStatFail:
 52272 00000083 00                      	db	0	; IoStatFail has been added to 
 52273                                  			; record a fail on an I24 
 52274                                  			; issued from IOFUNC on a status call. 
 52275                                  
 52276                                  ;***	I_am	UU_BUF_EMS_MODE,BYTE,<-1>	; EMS mode 	;AN000;
 52277                                  ;***	I_am	UU_BUF_EMS_HANDLE,BYTE		; buffer EMS handle ;AN000;
 52278                                  ;***	I_am	UU_BUF_EMS_PAGE_FRAME,WORD ,<-1>; EMS page frame # ;AN000;
 52279                                  ;***	I_am	UU_BUF_EMS_SEG_CNT,WORD,<1>	; EMS seg count	;AN000;
 52280                                  ;***	I_am	UU_BUF_EMS_PFRAME,WORD		; EMS page frame seg address ;AN000;
 52281                                  ;***	I_am	UU_BUF_EMS_RESERV,WORD,<0> 	; reserved	;AN000;
 52282                                  ;
 52283                                  ;***	I_am	UU_BUF_EMS_MAP_BUFF,1,<0>	; this is not used to save the
 52284                                  						; state of the 	buffers page.
 52285                                  						; This one byte is retained to
 52286                                  						; keep the size of this data 
 52287                                  						; block the same.;
 52288                                  ALLOCMSAVE:
 52289 00000084 00                      	db	0	; M063: temp var. used to 
 52290                                  			; M063: save alloc method in
 52291                                  			; M063: msproc.asm
 52292                                  A20OFF_COUNT:
 52293 00000085 00                      	db	0	; M068: indiactes the # of 
 52294                                  			; M068: int 21 calls for 
 52295                                  			; M068: which A20 is off
 52296                                  DOS_FLAG:
 52297 00000086 00                      	db	0	; see DOSSYM.INC for Bit 
 52298                                  			; definitions
 52299                                  UNPACK_OFFSET:
 52300 00000087 0000                    	dw	0	; saves pointer to the start
 52301                                  			; of unpack code in exepatch.
 52302                                  			; asm.
 52303                                  UMBFLAG:
 52304 00000089 00                      	db	0 	; M003: bit 0 indicates the 
 52305                                  			; M003: link state of the UMBs
 52306                                  			; M003: whether linked or not 
 52307                                  			; M003: to the DOS arena chain
 52308                                  SAVE_AX:
 52309 0000008A 0000                    	dw	0	; M000: temp varibale to store ax
 52310                                  			; M000: in msproc.asm
 52311                                  UMB_HEAD:
 52312 0000008C FFFF                    	dw	-1	; M000: this is initialized to  
 52313                                  			; M000: the first umb arena by 
 52314                                  			; M000: BIOS sysinit.
 52315                                  START_ARENA:
 52316 0000008E 0100                    	dw	1	; M000: this is the first arena 
 52317                                  			; M000: from which DOS will 
 52318                                  			; M000: start its scan for alloc.
 52319                                  
 52320                                  ; End of SYSINITVar block
 52321                                  ;----------------------------------------------------------------------------
 52322                                  
 52323                                  ; 25/04/2019 - Retro DOS v4.0
 52324                                  
 52325                                  ; 16/07/2018
 52326                                  ; MSDOS 3.3 (& MDOS 6.0)
 52327                                  
 52328                                  ;
 52329                                  ; Sharer jump table
 52330                                  ;
 52331                                  
 52332                                  ;PUBLIC	JShare
 52333                                  	;EVEN
 52334                                  
 52335                                  ;JShare	LABEL	DWORD
 52336                                  ;	DW	OFFSET DOSCODE:BadCall, 0
 52337                                  ;	DW	OFFSET DOSCODE:OKCall,  0  ;	1   MFT_enter
 52338                                  ;	DW	OFFSET DOSCODE:OKCall,  0  ;	2   MFTClose
 52339                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	3   MFTclU
 52340                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	4   MFTCloseP
 52341                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	5   MFTCloN
 52342                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	6   set_block
 52343                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	7   clr_block
 52344                                  ;	DW	OFFSET DOSCODE:OKCall,  0  ;	8   chk_block
 52345                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	9   MFT_get
 52346                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	10  ShSave
 52347                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	11  ShChk
 52348                                  ;	DW	OFFSET DOSCODE:OKCall , 0  ;	12  ShCol
 52349                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	13  ShCloseFile
 52350                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	14  ShSU
 52351                                  
 52352                                  align 2
 52353                                  
 52354                                  JShare:
 52355 00000090 [3007]0000              		DW	BadCall,0
 52356 00000094 [3407]0000              MFT_enter:	DW	OKCall, 0  ; 1   MFT_enter
 52357 00000098 [3407]0000              MFTClose:	DW	OKCall, 0  ; 2   MFTClose
 52358 0000009C [3007]0000              MFTclU:		DW	BadCall,0  ; 3   MFTclU
 52359 000000A0 [3007]0000              MFTCloseP:	DW	BadCall,0  ; 4   MFTCloseP
 52360 000000A4 [3007]0000              MFTCloN:	DW	BadCall,0  ; 5   MFTCloN
 52361 000000A8 [3007]0000              set_block:	DW	BadCall,0  ; 6   set_block
 52362 000000AC [3007]0000              clr_block:	DW	BadCall,0  ; 7   clr_block
 52363 000000B0 [3407]0000              chk_block:	DW	OKCall, 0  ; 8   chk_block
 52364 000000B4 [3007]0000              MFT_get:	DW	BadCall,0  ; 9   MFT_get
 52365 000000B8 [3007]0000              ShSave:		DW	BadCall,0  ; 10  ShSave
 52366 000000BC [3007]0000              ShChk:		DW	BadCall,0  ; 11  ShChk
 52367 000000C0 [3407]0000              ShCol:		DW	OKCall, 0  ; 12  ShCol
 52368 000000C4 [3007]0000              ShCloseFile:	DW	BadCall,0  ; 13  ShCloseFile
 52369 000000C8 [3007]0000              ShSU:		DW	BadCall,0  ; 14  ShSU
 52370                                  
 52371                                  
 52372                                  ;============================================================================
 52373                                  ; CONST2.ASM (MSDOS 6.0, 1991)
 52374                                  ;============================================================================
 52375                                  ; 25/04/2019 - Retro DOS 4.0 
 52376                                  ; 16/07/2018 - Retro DOS 3.0	
 52377                                  
 52378                                  ;Break <Initialized data and data used at DOS initialization>
 52379                                  ;----------------------------------------------------------------------------
 52380                                  
 52381                                  ; We need to identify the parts of the data area that are relevant to tasks
 52382                                  ; and those that are relevant to the system as a whole.  Under 3.0, the system
 52383                                  ; data will be gathered with the system code.  The process data under 2.x will
 52384                                  ; be available for swapping and under 3.0 it will be allocated per-process.
 52385                                  ;
 52386                                  ; The data that is system data will be identified by [SYSTEM] in the comments
 52387                                  ; describing that data item.
 52388                                  
 52389                                  ;DOSDATA SEGMENT WORD PUBLIC 'DATA'
 52390                                  
 52391                                  ;
 52392                                  ; Table of routines for assignable devices
 52393                                  ;
 52394                                  ; MSDOS allows assignment if the following standard devices:
 52395                                  ;   stdin  (usually CON input)
 52396                                  ;   stdout (usually CON output)
 52397                                  ;   auxin  (usually AUX input)
 52398                                  ;   auxout (usually AUX output)
 52399                                  ;   stdlpt (usually PRN output)
 52400                                  ;
 52401                                  ; SPECIAL NOTE:
 52402                                  ;   Status of a file is a strange idea. We choose to handle it in this manner:
 52403                                  ;   If we're not at end-of-file, then we always say that we have a character.
 52404                                  ;   Otherwise, we return ^Z as the character and set the ZERO flag. In this
 52405                                  ;   manner we can support program written under the old DOS (they use ^Z as EOF
 52406                                  ;   on devices) and programs written under the new DOS (they use the ZERO flag
 52407                                  ;   as EOF).
 52408                                  
 52409                                  ; Default SFTs for boot up
 52410                                  
 52411                                  		;PUBLIC	SFTABL
 52412                                  
 52413                                  SFTABL:	   ; LABEL   DWORD		; [SYSTEM] file table
 52414 000000CC FFFF                    		DW -1			; [SYSTEM] link to next table
 52415 000000CE FFFF                    		DW -1			; [SYSTEM] link seg to next table
 52416                                  		;dw 5 ; 24/03/2024
 52417 000000D0 0500                    		DW sf_default_number	; [SYSTEM] Number of entries in table
 52418                                  		;times 295 db 0 ; MSDOS 6.0 ; PCDOS 7.1  ; 24/03/2024
 52419 000000D2 00<rep 127h>            		times (sf_default_number*sf_entry_size) db 0
 52420                                  
 52421                                  ; the next two variables relate to the position of the logical stdout/stdin
 52422                                  ; cursor. They are only meaningful when stdin/stdout are assigned to the
 52423                                  ; console.
 52424                                  		; DOSDATA:01F9h (MSDOS 6.21) ; PCDOS 7.1 ; 24/03/2024
 52425 000001F9 00                      CARPOS:		db 0			; [SYSTEM] cursor position in stdin
 52426 000001FA 00                      STARTPOS:	db 0			; [SYSTEM] position of cursor at beginning
 52427                                  					;	   of buffered input call
 52428 000001FB 00<rep 80h>             INBUF:		times 128 db 0		; [SYSTEM] general device input buffer
 52429 0000027B 00<rep 83h>             CONBUF:		times 131 db 0		; [SYSTEM] The rest of INBUF and console buffer
 52430                                  		; DOSDATA:02FEh (MSDOS 6.21) ; PCDOS 7.1
 52431 000002FE 00                      PFLAG:		db 0			; [SYSTEM] printer echoing flag
 52432 000002FF 00                      VERFLG:		db 0			; [SYSTEM] Initialize with verify off
 52433 00000300 03                      CHARCO:		db 00000011b ; 3	; [SYSTEM] Allows statchks every 4 chars...
 52434                                  switch_character:
 52435 00000301 2F                      chSwitch:	db '/'			; UNUSED - obsolete datum, can be reused
 52436 00000302 00                      AllocMethod:	db 0			; [SYSTEM] how to alloc first(best)last
 52437 00000303 00                      fShare:		db 0			; [SYSTEM] TRUE => sharing installed
 52438 00000304 01                      DIFFNAM:	db 1			; [SYSTEM] Indicates when MYNAME has changed
 52439 00000305 20<rep 10h>             MYNAME:		times 16 db 20h		; [SYSTEM] My network name
 52440                                  
 52441                                  ; The following table is a list of addresses that the sharer patches to be
 52442                                  ; PUSH AX to enable the critical sections
 52443                                  
 52444                                  		; DOSDATA:0315h (MSDOS 6.21) ; PCDOS 7.1 ; 24/03/2024
 52445                                  
 52446                                  ;PUBLIC	CritPatch
 52447                                  
 52448                                  CritPatch:	; LABEL WORD
 52449                                  
 52450                                  ;IRP sect,<critDisk,critDevice>
 52451                                  
 52452                                  ;IF (NOT REDIRECTOR) AND (NOT SHAREF)
 52453                                  ;
 52454                                  ;SR; Change code patch address to a variable in data segment
 52455                                  ;
 52456                                  ;       dw OFFSET DOSDATA: redir_patch
 52457                                  ;       dw OFFSET DOSDATA: redir_patch
 52458                                  ;
 52459                                  ;;hkn	Short_Addr  E&sect
 52460                                  ;;hkn	Short_Addr  L&sect
 52461                                  ;
 52462                                  ;ELSE
 52463                                  ;	DW	0
 52464                                  ;	DW	0
 52465                                  ;ENDIF
 52466                                  ;ENDM
 52467                                  ;	DW	0
 52468                                  
 52469                                  	; 25/07/2019 - Retro DOS v4.0 (MSDOS 6.21)
 52470                                   
 52471 00000315 [650D]                  	dw 	redir_patch
 52472 00000317 [650D]                  	dw 	redir_patch			
 52473 00000319 [650D]                  	dw	redir_patch
 52474 0000031B [650D]                  	dw 	redir_patch
 52475                                  
 52476 0000031D 0000                    	dw	0
 52477                                  
 52478                                  ; WARNING!!! PRINT and PSPRINT *REQUIRE* ErrorMode to precede INDOS.
 52479                                  ; Also, IBM server 1.0 requires this also.
 52480                                  
 52481                                  	;db	90h ; 24/03/2024
 52482                                  
 52483                                  	;EVEN			; Force swap area to start on word boundry
 52484                                  
 52485 0000031F 90                      align 2
 52486                                  	;PUBLIC	SWAP_START
 52487                                  
 52488                                  ; 10/03/2024 - Retro DOS v5.0
 52489                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0320h
 52490                                  SWAP_START:	; LABEL BYTE
 52491 00000320 00                      ERRORMODE:	db 0		; Flag for INT 24 processing
 52492 00000321 00                      INDOS:		db 0		; DOS status for interrupt processing
 52493 00000322 FF                      WPERR:		db -1		; Write protect error flag
 52494 00000323 00                      EXTERR_LOCUS:	db 0		; Extended Error Locus
 52495 00000324 0000                    EXTERR:		dw 0		; Extended Error code
 52496                                  
 52497                                  ;WARNING Following two bytes Accessed as word in $GetExtendedError
 52498 00000326 00                      EXTERR_ACTION:	db 0		; Extended Error Action
 52499 00000327 00                      EXTERR_CLASS:	db 0		; Extended Error Class
 52500                                  ; end warning
 52501                                   
 52502 00000328 00000000                EXTERRPT:	dd 0		; Extended Error pointer
 52503                                  
 52504 0000032C 80000000                DMAADD:		dd 80h		; User's disk transfer address (disp/seg)
 52505 00000330 0000                    CurrentPDB:	dw 0		; Current process identifier
 52506 00000332 0000                    ConC_Spsave:	dw 0		; saved SP before ^C
 52507 00000334 0000                    exit_code:	dw 0		; exit code of last proc.
 52508 00000336 00                      CURDRV:		db 0		; Default drive (init A)
 52509 00000337 00                      CNTCFLAG:	db 0		; ^C check in dispatch disabled
 52510                                  ;				; F.C. 2/17/86
 52511 00000338 00                      CPSWFLAG:	db 0		; Code Page Switching Flag  DOS 4.00
 52512 00000339 00                      CPSWSAVE:	db 0		; copy of above in case of ABORT
 52513                                  ;align 2
 52514                                  ; 10/03/2024 - Retro DOS v5.0
 52515                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:033Ah
 52516                                  SWAP_ALWAYS:	; 05/08/2018
 52517 0000033A 0000                    USER_IN_AX:	dw 0		; User INPUT AX value (used for
 52518                                  				;   extended error type stuff.
 52519                                  				;   NOTE: does not have Correct value on
 52520                                  				;   1-12, OEM, Get/Set CurrentPDB,
 52521                                  				;   GetExtendedError system calls)
 52522 0000033C 0000                    PROC_ID:	dw 0		; PID for sharing (0 = local)
 52523 0000033E 0000                    USER_ID:	dw 0		; Machine for sharing (0 = local)
 52524 00000340 0000                    FirstArena:	dw 0		; first free block found
 52525 00000342 0000                    BestArena:	dw 0		; best free block found
 52526 00000344 0000                    LastArena:	dw 0		; last free block found
 52527 00000346 0000                    ENDMEM:		dw 0		; End of memory used in DOSINIT
 52528 00000348 0000                    LASTENT:	dw 0		; Last entry for directory search
 52529 0000034A 00                      FAILERR:	db 0		; NZ if user did FAIL on I 24
 52530 0000034B 00                      ALLOWED:	db 0		; Allowed I 24 answers (see allowed_)
 52531 0000034C 00                      NoSetDir:	db 0		; true -> do not set directory
 52532 0000034D 00                      DidCTRLC:	db 0		; true -> we did a ^C exit
 52533 0000034E 00                      SpaceFlag:	db 0		; true -> embedded spaces are allowed in FC
 52534                                  
 52535                                  ; Warning!  The following items are accessed as a WORD in TIME.ASM
 52536                                  	;EVEN
 52537 0000034F 90                      align 2
 52538                                  		; DOSDATA:0350h (MSDOS 6.21)
 52539 00000350 00                      DAY:		db 0		; Day of month
 52540 00000351 00                      MONTH:		db 0		; Month of year
 52541 00000352 0000                    YEAR:		dw 0		; Year (with century)
 52542 00000354 FFFF                    DAYCNT:		dw -1		; Day count from beginning of year
 52543 00000356 00                      WEEKDAY:	db 0		; Day of week
 52544                                  ; end warning
 52545                                  
 52546 00000357 00                      CONSWAP:	db 0		; TRUE => console was swapped during device read
 52547 00000358 01                      IDLEINT:	db 1		; TRUE => idle int is allowed
 52548 00000359 00                      fAborting:	db 0		; TRUE => abort in progress
 52549                                  
 52550                                  ; Combination of all device call parameters
 52551                                  	;PUBLIC	DEVCALL 	;
 52552                                  ;DEVCALL SRHEAD	<>		; basic header for disk packet
 52553                                  DEVCALL: ; 08/08/2018
 52554 0000035A 00                      DEVCALL_REQLEN:  db 0 		;Length in bytes of request block
 52555 0000035B 00                      DEVCALL_REQUNIT: db 0		;Device unit number
 52556 0000035C 00                      DEVCALL_REQFUNC: db 0		;Type of request
 52557 0000035D 0000                    DEVCALL_REQSTAT: dw 0		;Status Word
 52558 0000035F 00<rep 8h>                       times 8 db 0		;Reserved for queue links
 52559                                  
 52560                                  	;PUBLIC	CALLUNIT
 52561                                  CALLUNIT: ; LABEL   BYTE	; unit number for disk
 52562                                  CALLFLSH: ; LABEL   WORD	;
 52563 00000367 00                      CALLMED:	db 0		; media byte
 52564                                  CALLBR:	  ; LABEL   DWORD	;
 52565                                  	;PUBLIC	CALLXAD 	;
 52566                                  CALLXAD:  ; LABEL   DWORD	;
 52567 00000368 00                      CALLRBYT:	db 0		;
 52568                                  	;PUBLIC	CALLVIDM	;
 52569                                  CALLVIDM: ; LABEL   DWORD	;
 52570 00000369 00<rep 3h>              	times 3 db 0	;
 52571                                  	;PUBLIC CallBPB		;
 52572                                  CALLBPB:  ; LABEL   DWORD	;
 52573                                  CALLSCNT:			;
 52574 0000036C 0000                    		dw 0		;
 52575                                  	;PUBLIC	CALLSSEC	;
 52576                                  CALLSSEC: ; LABEL   WORD	;
 52577 0000036E 0000                    		dw 0		;
 52578 00000370 00000000                CALLVIDRW:	dd 0		;
 52579                                  ;MSDOS 6.0
 52580 00000374 00000000                CALLNEWSC:	dd 0		; starting sector for >32mb
 52581 00000378 00000000                CALLDEVAD:	dd 0		; stash for device entry point
 52582                                  
 52583                                  ; Same as above for I/O calls	;
 52584                                  				;
 52585                                  	;PUBLIC	IOCall		;
 52586                                  ;IOCALL	SRHEAD	<>		;
 52587                                  IOCALL:	; 07/08/2018
 52588 0000037C 00                      IOCALL_REQLEN:	db 0		;Length in bytes of request block
 52589 0000037D 00                      IOCALL_REQUNIT:	db 0		;Device unit number
 52590 0000037E 00                      IOCALL_REQFUNC: db 0		;Type of request
 52591 0000037F 0000                    IOCALL_REQSTAT: dw 0		;Status Word
 52592 00000381 00<rep 8h>              	times 8	db 0		;Reserved for queue links
 52593                                  IOFLSH:	  ; LABEL   WORD	;
 52594                                          ;PUBLIC  IORCHR		;
 52595                                  IORCHR:	  ; LABEL   BYTE	;
 52596 00000389 00                      IOMED:		db 0		;
 52597 0000038A 00000000                IOXAD:		dd 0		;
 52598 0000038E 0000                    IOSCNT:		dw 0		;
 52599 00000390 0000                    IOSSEC:		dw 0		;
 52600                                  
 52601                                  ; Call struct for DSKSTATCHK	;
 52602 00000392 0E                      DSKSTCALL:	db DRDNDHL 	; = 14
 52603 00000393 00                      		db 0
 52604 00000394 05                      DSKSTCOM:	db DEVRDND	; = 5
 52605 00000395 0000                    DSKSTST:	dw 0		;
 52606 00000397 00<rep 8h>              	times 8	db 0		;
 52607 0000039F 00                      DSKCHRET:	db 0		;
 52608                                  
 52609                                  ;hkn; short_addr has been changed to provide offset in DOSCODE.
 52610                                  ;hkn; deviobuf is in DATA seg (DOSDATA)
 52611                                  ;hkn   short_addr  DEVIOBUF	;
 52612                                  	
 52613 000003A0 [BC03]                  DEVIOBUF_PTR	dw DEVIOBUF
 52614 000003A2 0000                    DOSSEG_INIT	dw 0		; DOS segment set at Init
 52615 000003A4 0100                    DSKSTCNT:	dw 1		;
 52616 000003A6 0000                    		dw 0		;
 52617                                  
 52618 000003A8 00                      CreatePDB:	db 0		; flag for creating a process
 52619                                  
 52620                                  ;MSDOS 6.0
 52621                                  Lock_Buffer:	; LABEL  DWORD	;MS. DOS Lock Buffer for Ext Lock
 52622 000003A9 00000000                		dd 0		;MS. position
 52623 000003AD 00000000                		dd 0		;MS. length
 52624                                  
 52625                                  ;hkn; the foll. was moved from dosmes.asm.
 52626                                  
 52627                                  ; 29/01/2024 - Retro DOS v5.0 (PCDOS v7.1 IBMDOS.COM)
 52628                                  ; DOSDATA:03B1h
 52629 000003B1 90                      IOCTL_drvnum:	db 90h ; nop
 52630                                  
 52631                                  	;EVEN
 52632                                  align 2				; needed to maintain offsets
 52633                                  
 52634                                  		; DOSDATA:03B2h (MSDOS 6.21)
 52635                                  USERNUM:
 52636 000003B2 0000                     		dw 0		; 24 bit user number
 52637 000003B4 00                      		db 0
 52638                                  ;IF IBM
 52639                                  ;IF IBMCOPYRIGHT
 52640                                  ; 24/03/2024 (PCDOS v7.1 IBMDOS.COM)	
 52641 000003B5 00                      OEMNUM:		DB 0		; 8 bit OEM number
 52642                                  ;ELSE
 52643                                  ;OEMNUM:	DB 0FFh		; 8 bit OEM number
 52644                                  ;ENDIF
 52645                                  ;ELSE
 52646                                  ;OEMNUM:	DB 0FFh		; (MSDOS 6.22) ; 24/03/2024
 52647                                  ;ENDIF
 52648                                  
 52649                                  ;============================================================================
 52650                                  ; MS_DATA.ASM (MSDOS 6.0, 1991)
 52651                                  ;============================================================================
 52652                                  ; 25/04/2019 - Retro DOS 4.0
 52653                                  
 52654                                  ; Retro DOS v4.0 NOTE: (by Erdogan Tan, 25/04/2019)
 52655                                  ; ----------------------------------------------------------
 52656                                  ; This data section which was named as uninitialized data
 52657                                  ; (as overlayed by initialization code) but follows 
 52658                                  ; initialized data section from DOSDATA:03B6h address
 52659                                  ; (in otherwords, the method is different than MSDOS 3.3,
 52660                                  ; and there is not overlaying..)
 52661                                  ; **********************************************************
 52662                                  ; Reference: MSDOS 6.21 kernel DOSDATA section (4970 bytes)
 52663                                  ; follows DOSCODE section in the kernel file (MSDOS.SYS) 
 52664                                  ; (it is located at offset 0BF70h, file offset 0BF70h-3DE0h) 
 52665                                  ; but starts from offset 0 (ORG 0) and ends at offset 1370h.
 52666                                  ; TIMEBUF is at offset 03B6h.
 52667                                  ; **********************************************************	
 52668                                  
 52669                                  ;Break <Uninitialized data overlayed by initialization code>
 52670                                  ;----------------------------------------------------------------------------
 52671                                  ;DOSDATA    SEGMENT WORD PUBLIC 'DATA'
 52672                                  ; Init code overlaps with data area below
 52673                                  
 52674                                  ; 	ORG     0
 52675                                  
 52676                                  MSDAT001S:	; label byte
 52677                                  
 52678                                  ; DOSDATA:03B6h	; MSDOS 6.21 (MSDOS.SYS, file offset 0BF70h-3DE0h+3B6h)
 52679                                  TIMEBUF: ;	times 6 db 0
 52680 000003B6 0000<rep 3h>            	times 3 dw	0		; Time read from clock device
 52681 000003BC 0000                    DEVIOBUF:	dw	0		; Buffer for I/O under file assignment
 52682                                  
 52683                                  ; The following areas are used as temp buffer in EXEC system call
 52684                                  
 52685                                  ; DOSDATA:03BEh
 52686                                  OPENBUF: ;times 64  dw	0
 52687 000003BE 00<rep 80h>             	times	128 db	0		; buffer for name operations
 52688                                  RENBUF:	
 52689 0000043E 00<rep 80h>             	times	128 db	0		; buffer for rename destination
 52690                                  
 52691                                  ; Buffer for search calls
 52692                                  SEARCHBUF:	
 52693 000004BE 00<rep 35h>             	times	53  db	0		; internal search buffer
 52694                                  DUMMYCDS:  ;times 88 db 0
 52695 000004F3 00<rep 58h>             	times	curdirLen db 0
 52696                                  
 52697                                  ; End of contiguous buffer
 52698                                   
 52699                                  ; Temporary directory entry for use by many routines. Device directory
 52700                                  ; entries (bogus) are built here.
 52701                                  
 52702                                  ; DOSDATA:054Bh
 52703                                  
 52704                                  DEVFCB:	; LABEL   BYTE			; Uses NAME1, NAME2, combined
 52705                                  
 52706                                  ; WARNING..  do not alter position of NAME1 relative to DEVFCB
 52707                                  ; without first examining BUILD_DEVICE_ENT. Look carefully at DOS_RENAME
 52708                                  ; as well as it is the only guy who uses NAME2 and DESTSTART.
 52709                                  
 52710                                  NAME1:	
 52711 0000054B 00<rep Ch>                      times 	12 db	0		; File name buffer
 52712                                  NAME2:
 52713 00000557 00<rep Dh>              	times	13 db	0 		;
 52714                                  DESTSTART:
 52715 00000564 0000                    	dw	0			;
 52716                                          ;DB	((SIZE DIR_ENTRY) - ($ - DEVFCB)) DUP (?)
 52717                                  	;times	5  db	0
 52718 00000566 00<rep 5h>              	times	((dir_entry.size)-($-DEVFCB)) db 0
 52719                                  
 52720                                  ; End Temporary directory entry.
 52721                                  
 52722 0000056B 00                      ATTRIB:	db	0		; storage for file attributes
 52723                                  EXTFCB:	
 52724 0000056C 00                      	db	0		; TRUE => extended FCB in use
 52725                                  SATTRIB:
 52726 0000056D 00                      	db	0		; Storage for search attributes
 52727                                  OPEN_ACCESS:
 52728 0000056E 00                      	db	0		; access of open system call
 52729                                  FOUNDDEL:
 52730 0000056F 00                      	db	0		; true => file was deleted
 52731                                  FOUND_DEV:
 52732 00000570 00                      	db	0		; true => search found a device
 52733                                  FSPLICE:
 52734 00000571 00                      	db	0		; true => do a splice in transpath
 52735                                  FSHARING:
 52736 00000572 00                      	db	0		; TRUE => no redirection
 52737                                  SECCLUSPOS:
 52738 00000573 00                      	db	0		; Position of first sector within cluster
 52739 00000574 00                      TRANS:	db	0		;
 52740 00000575 00                      READOP:	db	0		;
 52741                                  THISDRV:
 52742 00000576 00                      	db	0		;
 52743                                  CLUSFAC:
 52744 00000577 00                      	db	0		;
 52745                                  CLUSSPLIT:
 52746 00000578 00                      	db	0		;
 52747                                  INSMODE:
 52748 00000579 00                      	db	0		; true => insert mode in buffered read
 52749 0000057A 00                      CMETA:	db	0		; count of meta'ed components found
 52750 0000057B 00                      VOLID:	db	0		;
 52751                                  EXIT_TYPE:
 52752 0000057C 00                      	db	0		; type of exit...
 52753                                  	; 24/03/2024	 
 52754 0000057D 00                      	db	0   ; PCDOS 7.1 - DOSDATA:057Dh
 52755                                  	;db	90h ; MSDOS 6.22 - DOSDATA:057Dh
 52756                                  
 52757                                  	;EVEN
 52758                                  
 52759                                  align 2
 52760                                  
 52761                                  ; DOSDATA:057Eh
 52762                                  
 52763                                  ; WARNING - the following two items are accessed as a word
 52764                                  
 52765                                  CREATING:
 52766 0000057E 00                      	db	0		; true => creating a file
 52767 0000057F 00                      DELALL:	db	0		; = 0 iff BUGBUG
 52768                                  				; = DIRFREE iff BUGBUG
 52769                                  EXITHOLD:
 52770 00000580 00000000                	dd	0		; Temp location for proc terminate
 52771                                  USER_SP:
 52772 00000584 0000                    	dw	0		; User SP for system call
 52773                                  USER_SS:
 52774 00000586 0000                    	dw	0		; User SS for system call
 52775                                  CONTSTK:
 52776 00000588 0000                    	dw	0		;
 52777                                  THISDPB:
 52778 0000058A 00000000                	dd	0		;
 52779                                  CLUSSAVE:
 52780 0000058E 0000                    	dw	0		;
 52781                                  CLUSSEC:
 52782 00000590 00000000                	dd	0		;>32mb			AC0000
 52783                                  PREREAD:
 52784 00000594 0000                    	dw	0		; 0 means preread; 1 means optional
 52785 00000596 0000                    FATBYT:	dw	0		; Used by ALLOCATE
 52786                                  FATBYTE:
 52787 00000598 0000                    	dw	0		; Used by $SLEAZEFUNC
 52788                                  ; DOSDATA:059Ah
 52789 0000059A 00000000                DEVPT:	dd	0		;
 52790                                  THISSFT:
 52791 0000059E 00000000                	dd	0		; Address of user SFT
 52792                                  THISCDS:
 52793 000005A2 00000000                	dd	0		; Address of current CDS
 52794                                  THISFCB:
 52795 000005A6 00000000                	dd	0		; Address of user FCB
 52796 000005AA FFFF                    SFN:	dw	-1		; SystemFileNumber found for accessfile
 52797 000005AC 0000                    JFN:	dw	0		; JobFileNumber found for accessfile
 52798 000005AE 00000000                PJFN:	dd	0		; PointerJobFileNumber found for accessfile
 52799                                  WFP_START:
 52800 000005B2 0000                    	dw	0		;
 52801                                  REN_WFP:
 52802 000005B4 0000                    	dw	0		;
 52803                                  CURR_DIR_END:
 52804 000005B6 0000                    	dw	0		;
 52805                                  NEXTADD:
 52806 000005B8 0000                    	dw	0		;
 52807                                  LASTPOS:
 52808 000005BA 0000                    	dw	0		;
 52809                                  CLUSNUM:
 52810 000005BC 0000                    	dw	0		;
 52811 000005BE 00000000                DIRSEC:	dd	0		;>32mb			AC0000
 52812                                  DIRSTART:
 52813 000005C2 0000                    	dw	0		;
 52814 000005C4 00000000                SECPOS:	dd	0		;>32mb Position of first sector accessed
 52815 000005C8 00000000                VALSEC:	dd	0		;>32mb Number of valid (previously written)
 52816                                                                  ; sectors
 52817                                  BYTSECPOS:
 52818 000005CC 0000                    	dw	0		; Position of first byte within sector
 52819                                  BYTPOS: ;times	4 db 0		; Byte position in file of access
 52820 000005CE 0000<rep 2h>                    times	2 dw 0
 52821                                  BYTCNT1:
 52822 000005D2 0000                    	dw	0		; No. of bytes in first sector
 52823                                  BYTCNT2:
 52824 000005D4 0000                    	dw	0		; No. of bytes in last sector
 52825 000005D6 0000                    SECCNT:	dw	0		; No. of whole sectors
 52826                                  ; DOSDATA:05D8h
 52827                                  ENTFREE:
 52828 000005D8 0000                    	dw	0		;
 52829                                  ENTLAST:
 52830 000005DA 0000                    	dw	0		;
 52831                                  NXTCLUSNUM:
 52832 000005DC 0000                    	dw	0		;
 52833                                  GROWCNT:
 52834 000005DE 00000000                	dd	0		;
 52835 000005E2 00000000                CURBUF:	dd	0		;
 52836 000005E6 00000000                CONSFT:	dd	0		; SFT of console swapped guy.
 52837 000005EA 0000                    SAVEBX:	dw	0		;
 52838 000005EC 0000                    SAVEDS:	dw	0		;
 52839                                  RESTORE_TMP:
 52840 000005EE 0000                    	dw	0		; return address for restore world
 52841 000005F0 0000                    NSS:	dw	0
 52842 000005F2 0000                    NSP:	dw	0
 52843                                  ; DOSDATA:05F4h
 52844                                  EXTOPEN_FLAG:
 52845 000005F4 0000                    	dw	0		;FT. extended open input flag	;AN000;
 52846                                  EXTOPEN_ON:
 52847 000005F6 00                      	db	0		;FT. extended open conditional flag ;AN000;
 52848                                  EXTOPEN_IO_MODE:
 52849 000005F7 0000                    	dw	0		;FT. extended open io mode	;AN000;
 52850                                  SAVE_DI:
 52851 000005F9 0000                    	dw	0		;FT. extended open saved DI	;AN000;
 52852                                  SAVE_ES:
 52853 000005FB 0000                    	dw	0		;FT. extended open saved ES	;AN000;
 52854                                  SAVE_DX:
 52855 000005FD 0000                    	dw	0		;FT. extended open saved DX	;AN000;
 52856                                  SAVE_CX:
 52857 000005FF 0000                    	dw	0		;FT. extended open saved CX	;AN000;
 52858                                  SAVE_BX:
 52859 00000601 0000                    	dw	0		;FT. extended open saved BX	;AN000;
 52860                                  SAVE_SI:
 52861 00000603 0000                    	dw	0		;FT. extended open saved SI	;AN000;
 52862                                  SAVE_DS:
 52863 00000605 0000                    	dw	0		;FT. extended open saved DS	;AN000;
 52864                                  
 52865                                  ; DOSDATA:0607h
 52866                                  
 52867                                  ; HIGH_SECTOR is a hack to allow passing 32-bit sector numbers where
 52868                                  ; we used to just pass 16 bits in a register. Now High_SECTOR holds
 52869                                  ; the high 16, the low 16 are still in the register.
 52870                                  
 52871                                  HIGH_SECTOR:	
 52872 00000607 0000                    	dw	0		;>32mb higher sector #		;AN000;
 52873                                  	; 25/09/2023
 52874                                  OffsetMagicPatch:
 52875                                  	; 24/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 52876 00000609 [4013]                  	dw	MagicPatch	;scottq 8/6/92
 52877                                  	; 06/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 52878                                  	;dw	0
 52879                                  				;see dos\mpatch.asm
 52880                                  DISK_FULL:
 52881 0000060B 00                      	db	0		;>32mb indicating disk full when 1 ;AN000;
 52882                                  TEMP_VAR:
 52883 0000060C 0000                    	dw	0		; temporary variable for everyone ;AN000;
 52884                                  TEMP_VAR2:
 52885 0000060E 0000                    	dw	0		; temporary variable 2 for everyone ;AN000;
 52886 00000610 00                      DrvErr:	db	0		; used to save drive error	;AN000;
 52887                                  DOS34_FLAG:
 52888 00000611 0000                    	dw	0		; common flag for DOS 3.4	;AN000;
 52889                                  NO_FILTER_PATH:
 52890 00000613 00000000                	dd	0		; pointer to original path	;AN000;
 52891                                  NO_FILTER_DPATH:
 52892 00000617 00000000                	dd	0		; pointer to original path of destination ;AN000;
 52893                                  ; M008
 52894                                  AbsRdWr_SS:
 52895 0000061B 0000                    	dw	0		; INT 25/26 user stack segment
 52896                                  AbsRdWr_SP:
 52897 0000061D 0000                    	dw	0		; INT 25/26 user stack offset
 52898                                  
 52899                                  	; I_am  UU_Callback_flag,BYTE,<0>  ; Unused
 52900                                  ; M008
 52901                                  	; 24/03/2024
 52902                                  	; MSDOS 5.0 MSDOS.SYS - DOSDATA:061Fh
 52903                                  	; MSDOS 6.22 MSDOS.SYS - DOSDATA:061Fh
 52904                                  	; 01/01/2024 
 52905                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:061Fh
 52906 0000061F 00                      	db 	0
 52907                                   
 52908                                  ; make those pushes fast!!!
 52909                                  ;EVEN
 52910                                  
 52911                                  align 2
 52912                                  
 52913                                  StackSize   equ 180h  ; 384	; gross but effective
 52914                                  
 52915                                  ;StackSize  equ 300h  ;	768	; This is a "trial" change IBM hasn't
 52916                                  ;				; made up their minds about
 52917                                   
 52918                                  ; WARNING!!!! DskStack may grow into AUXSTACK due to interrupt service.
 52919                                  ; This is NO problem as long as AUXSTACK comes immediately before DSKSTACK
 52920                                  
 52921                                  RENAMEDMA:	; LABEL   BYTE	; See DOS_RENAME
 52922                                   
 52923 00000620 00<rep 180h>                    times	StackSize db	0	; db 384 dup(0) ;  PCDOS 7.1
 52924                                  AUXSTACK:			; LABEL   BYTE
 52925                                   
 52926 000007A0 00<rep 180h>                    times	StackSize db 	0	; db 384 dup(0) ;  PCDOS 7.1
 52927                                  DSKSTACK:			; LABEL   BYTE
 52928                                  	; 24/03/2024
 52929                                  	; 01/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 52930                                  	; (PCDOS 7.1 IBMDOS.COM - DOSDATA:0920h)
 52931 00000920 402349424D3A31322E-     	db '@#IBM:12.01.2003.build_1.32#@ IBMDOS.COM(USA)',0 
 52931 00000929 30312E323030332E62-
 52931 00000932 75696C645F312E3332-
 52931 0000093B 23402049424D444F53-
 52931 00000944 2E434F4D2855534129-
 52931 0000094D 00                 
 52932 0000094E 00<rep 152h>            	times	StackSize-($-DSKSTACK) db 0  ; db 338 dup(0) ; PCDOS 7.1
 52933                                  	;times	StackSize db 	0	;
 52934                                  IOSTACK:			; LABEL   BYTE
 52935                                  
 52936                                  ; DOSDATA:0AA0h 
 52937                                   
 52938                                  ; patch space for Boca folks.
 52939                                  ; Say What????!!! This does NOT go into the swappable area!
 52940                                  ; NOTE: We include the decl of ibmpatch in ms-dos even though it is not needed.
 52941                                  ;       This allows the REDIRector to work on either IBM or MS-DOS.
 52942                                   
 52943                                  IBMPATCH: ; label byte
 52944                                  PRINTER_FLAG:
 52945 00000AA0 00                      	db	0		; [SYSTEM] status of PRINT utility
 52946                                  VOLCHNG_FLAG:
 52947                                  	;db	0		; [SYSTEM] true if volume label created
 52948                                  	; 24/03/2024 (PCDOS 7.1 IBMDOS.COM)
 52949 00000AA1 FF                      	db	0FFh  ; -1
 52950                                  VIRTUAL_OPEN:
 52951 00000AA2 00                      	db	0		; [SYSTEM] non-zero if we opened a virtual file
 52952                                   
 52953                                  ; 24/03/2024 - Retro DOS v5.0
 52954                                  ; PCDOS 7.1 IBMDOS.COM
 52955                                  %if 0
 52956                                  
 52957                                  ; Following 4 variables moved to MSDATA.asm from MSTABLE.asm (P4986)
 52958                                  
 52959                                  	; DOSDATA:0AA3h ; MSDOS 6.22 ; MSDOS 5.0
 52960                                  FSeek_drive:
 52961                                  	db	0		;AN000; fastseek drive #
 52962                                  FSeek_firclus:
 52963                                  	dw	0		;AN000; fastseek first cluster #
 52964                                  FSeek_logclus:
 52965                                  	dw	0		;AN000; fastseek logical cluster #
 52966                                  FSeek_logsave:
 52967                                  	dw	0		;AN000; fastseek returned log clus #
 52968                                  
 52969                                  %endif
 52970                                  
 52971                                  ; DOSDATA:0AAAh ; MSDOS 6.22 ; MSDOS 5.0
 52972                                  ; DOSDATA:0AA3h	; PCDOS 7.1 ; 24/03/2024
 52973                                  
 52974                                  TEMP_DOSLOC:
 52975 00000AA3 FFFF                    	dw	-1		;stores the temporary location of dos
 52976                                  				;at SYSINIT time.
 52977                                  ; 10/03/2024
 52978                                  ;SWAP_END:  ; LABEL   BYTE
 52979                                   
 52980                                  ; THE FOLLOWING BYTE MUST BE HERE, IMMEDIATELY FOLLOWING SWAP_END. IT CANNOT
 52981                                  ; BE USED. If the size of the swap data area is ODD, it will be rounded up
 52982                                  ; to include this byte.
 52983                                   
 52984                                  	; 24/03/2024
 52985                                  	; 05/01/2024 (PCDOS 7.1 IBMDOS.COM)
 52986                                  	;db	0	 ; DOSDATA:0AACh (MSDOS 5.0-6.22 MSDOS.SYS)
 52987                                  
 52988                                  ; DOSDATA:0AADh
 52989                                   
 52990                                  ;hkn;	DB	(512+80+32-(SWAP_END-ibmpatch)) DUP (?)
 52991                                  
 52992                                  ; ---------------------------------------------------------------------------
 52993                                  ; 05/01/2024 - Retro DOS v5.0 
 52994                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0AA5h
 52995                                  
 52996                                  	; 24/01/2024
 52997                                  LNE_COUNT:
 52998 00000AA5 0000                    	dw	0	; long name entry count (for file)
 52999                                  
 53000 00000AA7 00<rep Eh>              	times 14 db 0
 53001                                  
 53002                                  ENTLAST_PREV:
 53003 00000AB5 0000                    	dw	0	; previous ENTLAST (for long name search !?)
 53004                                  
 53005 00000AB7 00<rep 24h>             	times 36 db 0
 53006                                  
 53007                                  absdrw_extd:
 53008 00000ADB 00                      	db	0
 53009                                  DIRSTART_HW:
 53010 00000ADC 0000                    	dw	0
 53011                                  CLUSNUM_HW:
 53012 00000ADE 0000                    	dw	0
 53013                                  NXTCLUSNUM_HW:
 53014 00000AE0 0000                    	dw	0
 53015                                  LASTPOS_HW:
 53016 00000AE2 0000                    	dw	0
 53017                                  FATBYT_HW:
 53018 00000AE4 0000                    	dw	0
 53019                                  DESTSTART_HW:
 53020 00000AE6 0000                    	dw	0
 53021                                  CLUSTNUM_HW:
 53022 00000AE8 0000                    	dw	0
 53023                                  CLUSDATA_HW:	; cluster data (0 = release, -1 = allocate) ; 30/01/2024
 53024 00000AEA 0000                    	dw	0
 53025                                  CCONTENT_HW:	; UNPACK output
 53026 00000AEC 0000                    	dw	0
 53027                                  ROOTCLUST_HW:
 53028 00000AEE 0000                    	dw	0
 53029                                  CCOUNT_HW:	; 09/02/2024 ; for ALLOCATE
 53030 00000AF0 0000                    	dw	0	
 53031                                  CLUSTERS_HW:
 53032 00000AF2 0000                    	dw	0
 53033 00000AF4 0000                    	dw	0
 53034 00000AF6 0000                    	dw	0
 53035                                  CLSKIP_HW:
 53036 00000AF8 0000                    	dw	0
 53037                                  
 53038                                  ; 10/03/2024 - Retro DOS v5.0
 53039                                  ; (PCDOS 7.1 IBMDOS.COM)
 53040                                  SWAP_END:  ; LABEL   BYTE
 53041                                  
 53042                                  ;DOSDATA    ENDS
 53043                                  
 53044                                  ;============================================================================
 53045                                  ; DOSTAB.ASM (MSDOS 6.0, 1991)
 53046                                  ;============================================================================
 53047                                  ; 27/04/2019 - Retro DOS 4.0
 53048                                  ; 16/07/2018 - Retro DOS 3.0
 53049                                  
 53050                                  ;DOSDATA Segment
 53051                                  
 53052                                  ; DOSDATA:0AADh (MSDOS 6.21, MSDOS.SYS)
 53053                                  
 53054                                  ; DOSDATA:0AFAh (PCDOS 7.1, IBMDOS.COM) ; 05/01/2024
 53055                                  
 53056                                  ;
 53057                                  ; upper case table
 53058                                  ; ---------------------------------------------------------------------------
 53059                                  UCASE_TAB:	; label   byte
 53060 00000AFA 8000                    	dw	128
 53061 00000AFC 809A45418E418F80        	db	128,154,069,065,142,065,143,128 
 53062 00000B04 4545454949498E8F        	db	069,069,069,073,073,073,142,143
 53063 00000B0C 9092924F994F5555        	db	144,146,146,079,153,079,085,085
 53064 00000B14 59999A9B9C9D9E9F        	db	089,153,154,155,156,157,158,159
 53065 00000B1C 41494F55A5A5A6A7        	db	065,073,079,085,165,165,166,167
 53066 00000B24 A8A9AAABACADAEAF        	db	168,169,170,171,172,173,174,175
 53067 00000B2C B0B1B2B3B4B5B6B7        	db	176,177,178,179,180,181,182,183
 53068 00000B34 B8B9BABBBCBDBEBF        	db	184,185,186,187,188,189,190,191
 53069 00000B3C C0C1C2C3C4C5C6C7        	db	192,193,194,195,196,197,198,199
 53070 00000B44 C8C9CACBCCCDCECF        	db	200,201,202,203,204,205,206,207
 53071 00000B4C D0D1D2D3D4D5D6D7        	db	208,209,210,211,212,213,214,215
 53072 00000B54 D8D9DADBDCDDDEDF        	db	216,217,218,219,220,221,222,223
 53073 00000B5C E0E1E2E3E4E5E6E7        	db	224,225,226,227,228,229,230,231
 53074 00000B64 E8E9EAEBECEDEEEF        	db	232,233,234,235,236,237,238,239
 53075 00000B6C F0F1F2F3F4F5F6F7        	db	240,241,242,243,244,245,246,247
 53076 00000B74 F8F9FAFBFCFDFEFF        	db	248,249,250,251,252,253,254,255
 53077                                  ;
 53078                                  ; file upper case table
 53079                                  ; ---------------------------------------------------------------------------
 53080                                  FILE_UCASE_TAB:	; label  byte
 53081 00000B7C 8000                    	dw	128
 53082 00000B7E 809A45418E418F80        	db	128,154,069,065,142,065,143,128
 53083 00000B86 4545454949498E8F        	db	069,069,069,073,073,073,142,143
 53084 00000B8E 9092924F994F5555        	db	144,146,146,079,153,079,085,085
 53085 00000B96 59999A9B9C9D9E9F        	db	089,153,154,155,156,157,158,159
 53086 00000B9E 41494F55A5A5A6A7        	db	065,073,079,085,165,165,166,167
 53087 00000BA6 A8A9AAABACADAEAF        	db	168,169,170,171,172,173,174,175
 53088 00000BAE B0B1B2B3B4B5B6B7        	db	176,177,178,179,180,181,182,183
 53089 00000BB6 B8B9BABBBCBDBEBF        	db	184,185,186,187,188,189,190,191
 53090 00000BBE C0C1C2C3C4C5C6C7        	db	192,193,194,195,196,197,198,199
 53091 00000BC6 C8C9CACBCCCDCECF        	db	200,201,202,203,204,205,206,207
 53092 00000BCE D0D1D2D3D4D5D6D7        	db	208,209,210,211,212,213,214,215
 53093 00000BD6 D8D9DADBDCDDDEDF        	db	216,217,218,219,220,221,222,223
 53094 00000BDE E0E1E2E3E4E5E6E7        	db	224,225,226,227,228,229,230,231
 53095 00000BE6 E8E9EAEBECEDEEEF        	db	232,233,234,235,236,237,238,239
 53096 00000BEE F0F1F2F3F4F5F6F7        	db	240,241,242,243,244,245,246,247
 53097 00000BF6 F8F9FAFBFCFDFEFF        	db	248,249,250,251,252,253,254,255
 53098                                  
 53099                                  ; 24/03/2024 - Retro DOS v5.0
 53100                                  ; PCDOS 7.1 IBMDOS.COM
 53101                                  %if 0
 53102                                  	; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0BB1h
 53103                                  ;
 53104                                  ; file char list
 53105                                  ; ---------------------------------------------------------------------------
 53106                                  FILE_CHAR_TAB:	; label  byte
 53107                                  	dw	22				; length
 53108                                  	db	1,0,255 			; include all
 53109                                  	db	0,0,20h 			; exclude 0 - 20h
 53110                                  	db	2,14,'."/\[]:|<>+=;,'           ; exclude 14 special
 53111                                  	;db	24 dup (?)			; reserved
 53112                                  	times	24 db 0
 53113                                  %endif
 53114                                  
 53115                                  	; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0BE1h
 53116                                  
 53117                                  	; 24/03/2024
 53118                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:0BFEh
 53119                                  ;
 53120                                  ; collate table
 53121                                  ; ---------------------------------------------------------------------------
 53122                                  COLLATE_TAB:	; label   byte
 53123 00000BFE 0001                    	dw	256
 53124 00000C00 0001020304050607        	db	0,1,2,3,4,5,6,7
 53125 00000C08 08090A0B0C0D0E0F        	db	8,9,10,11,12,13,14,15
 53126 00000C10 1011121314151617        	db	16,17,18,19,20,21,22,23
 53127 00000C18 18191A1B1C1D1E1F        	db	24,25,26,27,28,29,30,31
 53128 00000C20 2021222324252627        	db	" ","!",'"',"#","$","%","&","'"
 53129 00000C28 28292A2B2C2D2E2F        	db	"(",")","*","+",",","-",".","/"
 53130 00000C30 3031323334353637        	db	"0","1","2","3","4","5","6","7"
 53131 00000C38 38393A3B3C3D3E3F        	db	"8","9",":",";","<","=",">","?"
 53132 00000C40 4041424344454647        	db	"@","A","B","C","D","E","F","G"
 53133 00000C48 48494A4B4C4D4E4F        	db	"H","I","J","K","L","M","N","O"
 53134 00000C50 5051525354555657        	db	"P","Q","R","S","T","U","V","W"
 53135 00000C58 58595A5B5C5D5E5F        	db	"X","Y","Z","[","\","]","^","_"
 53136 00000C60 6041424344454647        	db	"`","A","B","C","D","E","F","G"
 53137 00000C68 48494A4B4C4D4E4F        	db	"H","I","J","K","L","M","N","O"
 53138 00000C70 5051525354555657        	db	"P","Q","R","S","T","U","V","W"
 53139 00000C78 58595A7B7C7D7E7F        	db	"X","Y","Z","{","|","}","~",127
 53140 00000C80 4355454141414143        	db	"C","U","E","A","A","A","A","C"
 53141 00000C88 4545454949494141        	db	"E","E","E","I","I","I","A","A"
 53142 00000C90 4541414F4F4F5555        	db	"E","A","A","O","O","O","U","U"
 53143 00000C98 594F552424242424        	db	"Y","O","U","$","$","$","$","$"
 53144 00000CA0 41494F554E4EA6A7        	db	"A","I","O","U","N","N",166,167
 53145 00000CA8 3FA9AAABAC212222        	db	"?",169,170,171,172,"!",'"','"'
 53146 00000CB0 B0B1B2B3B4B5B6B7        	db	176,177,178,179,180,181,182,183
 53147 00000CB8 B8B9BABBBCBDBEBF        	db	184,185,186,187,188,189,190,191
 53148 00000CC0 C0C1C2C3C4C5C6C7        	db	192,193,194,195,196,197,198,199
 53149 00000CC8 C8C9CACBCCCDCECF        	db	200,201,202,203,204,205,206,207
 53150 00000CD0 D0D1D2D3D4D5D6D7        	db	208,209,210,211,212,213,214,215
 53151 00000CD8 D8D9DADBDCDDDEDF        	db	216,217,218,219,220,221,222,223
 53152 00000CE0 E053                    	db	224,"S"
 53153 00000CE2 E2E3E4E5E6E7            	db	226,227,228,229,230,231
 53154 00000CE8 E8E9EAEBECEDEEEF        	db	232,233,234,235,236,237,238,239
 53155 00000CF0 F0F1F2F3F4F5F6F7        	db	240,241,242,243,244,245,246,247
 53156 00000CF8 F8F9FAFBFCFDFEFF        	db	248,249,250,251,252,253,254,255
 53157                                  
 53158                                  ; ------------------------------------------------<MSKK01>----------------------
 53159                                  
 53160                                  ; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0CE3h
 53161                                  ; 24/03/2024
 53162                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D00h
 53163                                  
 53164                                  ; 29/04/2019
 53165                                  
 53166                                  ; dbcs is not supported in DOS 3.3
 53167                                  ;		   DBCS_TAB	    CC_DBCS <>
 53168                                  ;
 53169                                  ; DBCS for DOS 4.00			   2/12/KK
 53170                                  
 53171                                  DBCS_TAB:	; label byte		;AN000;  2/12/KK
 53172                                  ; ------------------------------------------------<MSKK01>----------------------
 53173                                  ;ifdef	DBCS
 53174                                  ; ifdef	  JAPAN
 53175                                  ;		dw	6		; <MSKK01>
 53176                                  ;		db	081h,09fh	; <MSKK01>
 53177                                  ;		db	0e0h,0fch	; <MSKK01>
 53178                                  ;		db	0,0		; <MSKK01>
 53179                                  ;
 53180                                  ;		db	0,0,0,0,0,0,0,0,0,0	; <MSKK01>
 53181                                  ; endif
 53182                                  ; ifdef	  TAIWAN
 53183                                  ;		dw	4		; <TAIWAN>
 53184                                  ;		db	081h,0FEh	; <TAIWAN>
 53185                                  ;		db	0,0		; <TAIWAN>
 53186                                  ;
 53187                                  ;		db	0,0,0,0,0,0,0,0,0,0,0,0
 53188                                  ; endif
 53189                                  ; ifdef   KOREA                         ; Keyl
 53190                                  ;               dw      4               ; <KOREA>
 53191                                  ;               db      0A1h,0FEh       ; <KOREA>
 53192                                  ;               db      0,0             ; <KOREA>
 53193                                  ;
 53194                                  ;		db	0,0,0,0,0,0,0,0,0,0,0,0
 53195                                  ;  endif
 53196                                  ;else
 53197 00000D00 0000                    		dw	0		;AN000;  2/12/KK   max number
 53198                                  		;db	16 dup(0)	;AN000;  2/12/KK
 53199 00000D02 00<rep 10h>             		times	16 db 0
 53200                                  
 53201                                  ;		dw	6		;  2/12/KK
 53202                                  ;		db	081h,09Fh	;  2/12/KK
 53203                                  ;		db	0E0h,0FCh	;  2/12/KK
 53204                                  ;		db	0,0		;  2/12/KK
 53205                                  ;
 53206                                  ;endif
 53207                                  ; ------------------------------------------------<MSKK01>----------------------
 53208                                  
 53209                                  ; 24/03/2024 - Retro DOS v5.0
 53210                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D12h
 53211                                  %if 1
 53212                                  IBMDOSVERSION:	
 53213                                  	;db 7
 53214                                  	;db 10			; MSVERSION
 53215 00000D12 07                      	db MAJOR_VERSION
 53216 00000D13 0A                      	db MINOR_VERSION
 53217                                  
 53218 00000D14 C8A6                    YRTAB:	db 200,166	; Leap Year
 53219 00000D16 C8A5C8A5C8A5            	db 200,165,200,165,200,165
 53220                                  
 53221 00000D1C 1F                      MONTAB:	db 31
 53222                                  february:
 53223 00000D1D 1C1F1E1F1E1F1F1E1F-     	db 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31
 53223 00000D26 1E1F               
 53224                                  %endif
 53225                                  
 53226                                  ; 24/03/2024 - Retro DOS v5.0
 53227                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D28h
 53228                                  %if 1
 53229                                  ;
 53230                                  ; file char list
 53231                                  ; ---------------------------------------------------------------------------
 53232                                  FILE_CHAR_TAB:	; label  byte
 53233 00000D28 1600                    	dw	22				; length
 53234 00000D2A 0100FF                  	db	1,0,255 			; include all
 53235 00000D2D 000020                  	db	0,0,20h 			; exclude 0 - 20h
 53236 00000D30 020E2E222F5C5B5D3A-     	db	2,14,'."/\[]:|<>+=;,'           ; exclude 14 special
 53236 00000D39 7C3C3E2B3D3B2C     
 53237                                  	;db	24 dup (?)			; reserved
 53238 00000D40 00<rep 18h>             	times	24 db 0
 53239                                  %endif
 53240                                  
 53241                                  ; 24/03/2024 - Retro DOS v5.0
 53242                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D58h
 53243                                  %if 1
 53244                                  SysInitTable:
 53245 00000D58 [2600]                  	dw	DPBHEAD		; SYSINITVARS
 53246 00000D5A 0000                    	dw	0
 53247 00000D5C [2A12]                  	dw	COUNTRY_CDPG
 53248 00000D5E 0000                    	dw	0
 53249 00000D60 000000                  	db	0,0,0
 53250                                  TEMPSEG:
 53251 00000D63 0000                    	dw	0
 53252                                  redir_patch:
 53253 00000D65 00                      	db	0
 53254                                  DosHasHMA:
 53255 00000D66 00                      	db	0
 53256                                  FixExePatch:
 53257 00000D67 0000                    	dw	0
 53258                                  RationalPatchPtr:
 53259 00000D69 0000                    	dw	0
 53260                                  %endif
 53261                                  
 53262                                  ; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0CF5h
 53263                                  ; 24/03/2024
 53264                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D6Bh
 53265                                  
 53266                                  ; ---------------------------------------------------------------------------
 53267                                  ;
 53268                                  ;CASE MAPPER ROUTINE FOR 80H-FFH character range, DOS 3.3
 53269                                  ;     ENTRY: AL = Character to map
 53270                                  ;     EXIT:  AL = The converted character
 53271                                  ; Alters no registers except AL and flags.
 53272                                  ; The routine should do nothing to chars below 80H.
 53273                                  ; ---------------------------------------------------------------------------
 53274                                  ; Example:
 53275                                  
 53276                                  MAP_CASE:
 53277                                  ;Procedure MAP_CASE,FAR
 53278                                  
 53279 00000D6B 3C80                    	CMP	AL,80h
 53280                                  	;JAE	short Map1	;Map no chars below 80H ever
 53281                                  	;RETF
 53282                                  	; 24/03/2024 (PCDOS 7.1 IBMDOS.COM)
 53283                                  	;;;
 53284 00000D6D 720C                    	jb	short L_RET     ;Map no chars below 80H ever
 53285                                  	;;;
 53286                                  Map1:
 53287 00000D6F 2C80                    	SUB	AL,80h		;Turn into index value
 53288 00000D71 1E                      	PUSH	DS
 53289 00000D72 53                      	PUSH	BX
 53290 00000D73 BB[FC0A]                	MOV	BX,UCASE_TAB+2
 53291                                  FINISH:
 53292 00000D76 0E                      	PUSH	CS		;Move to DS
 53293 00000D77 1F                      	POP	DS
 53294 00000D78 D7                      	XLAT			;Get upper case character
 53295 00000D79 5B                      	POP	BX
 53296 00000D7A 1F                      	POP	DS
 53297                                  L_RET:	
 53298 00000D7B CB                      	RETF
 53299                                  
 53300                                  ;EndProc MAP_CASE
 53301                                  
 53302                                  ; ---------------------------------------------------------------------------
 53303                                  
 53304                                  ; 24/03/2024 - Retro DOS v5.0
 53305                                  ; PCDOS 7.1 IBMDOS.COM
 53306                                  %if 0
 53307                                  
 53308                                  ; The variables for ECS version are moved here for the same data alignments
 53309                                  ; as IBM-DOS and MS-DOS.
 53310                                  
 53311                                  InterChar:
 53312                                  	db	0	; Interim character flag ( 1= interim)  ;AN000;
 53313                                  ;------- NOTE: NEXT TWO BYTES SOMETIMES USED AS A WORD !! -------------------
 53314                                  DUMMY:	; LABEL   WORD
 53315                                  InterCon:  
 53316                                  	db	0	; Console in Interim mode ( 1= interim) ;AN000;
 53317                                  SaveCurFlg:
 53318                                  	db	0	; Print, do not advance cursor flag     ;AN000;
 53319                                  
 53320                                  ; ---------------------------------------------------------------------------
 53321                                  
 53322                                  ; 17/01/2024 - Retro DOS v5.0
 53323                                  ;TEMPSEG:  dw	0	;hkn; used to store ds.
 53324                                  ;redir_patch:
 53325                                  ;	  db	0
 53326                                  
 53327                                  ; DOSDATA:0D0Dh
 53328                                  
 53329                                  Mark1:	; label byte
 53330                                  
 53331                                  ;IF2
 53332                                  ;	IF ((OFFSET MARK1) GT (OFFSET MSVERSION) )
 53333                                  ;		%OUT !DATA CORRUPTION!MARK1 OFFSET TOO BIG. RE-ORGANIZE DATA.
 53334                                  ;	ENDIF
 53335                                  ;ENDIF
 53336                                  
 53337                                  	  times 5 db 0
 53338                                  
 53339                                  ;############################################################################
 53340                                  ;
 53341                                  ; ** HACK FOR DOS 4.0 REDIR **
 53342                                  ; 
 53343                                  ; The redir requires the following:
 53344                                  ;
 53345                                  ;	MSVERS	offset D12H
 53346                                  ;	YRTAB	offset D14H
 53347                                  ; 	MONTAB	offset D1CH
 53348                                  ;
 53349                                  ; WARNING! WARNING!
 53350                                  ; 
 53351                                  ; MARK1 SHOULD NOT BE >= 0D12H. IF SOME VARIABLE IS TO BE ADDED ABOVE DO SO
 53352                                  ; WITHOUT VIOLATING THIS AND UPDATE THE FOLL. LINE
 53353                                  ;
 53354                                  ; CURRENTLY MARK1 = 0D0DH
 53355                                  ;
 53356                                  ;############################################################################
 53357                                  
 53358                                  	;ORG	0D12h
 53359                                  
 53360                                  ; DOSDATA:0D12h (MSDOS 6.21, MSDOS.SYS)
 53361                                  
 53362                                  	;db	6
 53363                                  	;db	20
 53364                                  
 53365                                  	; Offset 0C78h in IBMDOS.COM (MSDOS 3.3, 1987)
 53366                                  MSVERSION:				; MS-DOS version in hex for $GET_VERSION
 53367                                  MSMAJORV: DB	MAJOR_VERSION	; DOS_MAJOR_VERSION
 53368                                  MSMINORV: DB	MINOR_VERSION	; DOS_MINOR_VERSION  
 53369                                  
 53370                                  ; YRTAB & MONTAB moved from TABLE segment in ms_table.asm
 53371                                  ;
 53372                                  ;	I_am    YRTAB,8,<200,166,200,165,200,165,200,165>
 53373                                  ;	I_am    MONTAB,12,<31,28,31,30,31,30,31,31,30,31,30,31> 
 53374                                  
 53375                                  ; Days in year
 53376                                  
 53377                                  YRTAB:   
 53378                                  	DB	200,166			; Leap year
 53379                                  	DB	200,165
 53380                                  	DB	200,165
 53381                                  	DB	200,165
 53382                                  
 53383                                  ; Days of each month
 53384                                  
 53385                                  MONTAB:        
 53386                                  	DB      31                      ; January
 53387                                  february:
 53388                                  	DB	28 			; February--reset each 
 53389                                  					; time year changes
 53390                                          DB      31                      ; March
 53391                                          DB      30                      ; April
 53392                                          DB      31                      ; May
 53393                                          DB      30                      ; June
 53394                                          DB      31                      ; July
 53395                                          DB      31                      ; August
 53396                                          DB      30                      ; September
 53397                                          DB      31                      ; October
 53398                                          DB      30                      ; November
 53399                                          DB      31                      ; December
 53400                                  
 53401                                  ;----------------THE FOLL. BLOCK MOVED FROM TABLE SEG IN MS_TABLE.ASM-------
 53402                                  
 53403                                  ; SYS init extended table,   DOS 3.3   F.C. 5/29/86
 53404                                  
 53405                                  SysInitTable:
 53406                                  	;dw	SYSINITVAR
 53407                                  	dw	SYSINITVARS	; pointer to sysinit var
 53408                                          dw      0		; segment
 53409                                          dw	COUNTRY_CDPG	; pointer to country tabl
 53410                                          dw      0		; segment of pointer
 53411                                  
 53412                                  	;;;
 53413                                  	; 17/01/2024 - Retro DOS v5.0
 53414                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D60h
 53415                                  	;
 53416                                  	times	3 db 0
 53417                                  TEMPSEG:
 53418                                  	dw	0
 53419                                  redir_patch:
 53420                                  	db	0
 53421                                  
 53422                                  ;%endif
 53423                                  
 53424                                  ; 17/01/2024
 53425                                  ;%if 1
 53426                                  
 53427                                  ; M021-
 53428                                  ;
 53429                                  ; DosHasHMA - This flag is set by seg_reinit when the DOS actually
 53430                                  ; 	takes control of the HMA. When running, this word is a reliable
 53431                                  ;	indicator that the DOS is actually using HMA. You can't just use
 53432                                  ;	CS, because ROMDOS uses HMA with CS < F000.
 53433                                  
 53434                                  DosHasHMA:
 53435                                  	db	0
 53436                                  FixExePatch:
 53437                                  	dw	0		; M012
 53438                                  
 53439                                  ;%endif
 53440                                  
 53441                                  UnknownPatch:
 53442                                  	dw	0
 53443                                  	;;;
 53444                                  
 53445                                  ; 17/01/2024
 53446                                  ;%if 0
 53447                                  
 53448                                  ; DOS 3.3 F.C. 6/12/86
 53449                                  ; FASTOPEN communications area DOS 3.3   F.C. 5/29/86
 53450                                  
 53451                                  FastTable:				; a better name
 53452                                  FastOpenTable:
 53453                                  	dw      2                       ; number of entries
 53454                                  	dw      FastRet			; pointer to ret instr.
 53455                                  	dw      0                       ; and will be modified by
 53456                                  	dw      FastRet			; FASTxxx when loaded in
 53457                                  	dw      0
 53458                                  
 53459                                  ; DOS 3.3 F.C. 6/12/86
 53460                                  
 53461                                  FastFlg:				; flags
 53462                                  FastOpenFlg:
 53463                                  	db	0			; don't change the foll: order
 53464                                  
 53465                                  ;%endif
 53466                                  
 53467                                  ; FastOpen_Ext_Info is used as a temporary storage for saving dirpos,dirsec
 53468                                  ; and clusnum which are filled by DOS 3.nc when calling FastOpen Insert
 53469                                  ; or filled by FastOPen when calling FastOpen Lookup
 53470                                  
 53471                                  FastOpen_Ext_Info: ; label  byte	;dirpos
 53472                                  	;db	SIZE FASTOPEN_EXTENDED_INFO dup(0)
 53473                                  	;times	11 db 0
 53474                                  	times	FEI.size db 0
 53475                                  
 53476                                  %endif	; 24/03/2024	
 53477                                  
 53478                                  ; Dir_Info_Buff is a dir entry buffer which is filled by FastOPen
 53479                                  ; when calling FastOpen Lookup
 53480                                  
 53481                                  Dir_Info_Buff:	; label  byte
 53482                                  	;db	SIZE dir_entry dup (0)
 53483                                  	;times	32 db 0
 53484 00000D7C 00<rep 20h>             	times	dir_entry.size db 0
 53485                                  
 53486                                  Next_Element_Start:
 53487 00000D9C 0000                    	dw	0			; save next element start offset
 53488                                  
 53489                                  ; 24/03/2024
 53490                                  %if 0
 53491                                  	; MSDOS 6.22 MSDOS.SYS - DOSDATA:0D68h
 53492                                  
 53493                                  Del_ExtCluster:
 53494                                  	dw	0			; for dos_delete
 53495                                  %endif
 53496                                  
 53497                                  ; The following is a stack and its pointer for interrupt 2F which is used
 53498                                  ; by NLSFUNC. There is no significant use of this stack, we are just trying
 53499                                  ; not to destroy the INT 21 stack saved for the user.
 53500                                  
 53501                                  	; MSDOS 6.22 MSDOS.SYS - DOSDATA:0D6Ah
 53502                                  	; 24/03/2024
 53503                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D9Eh
 53504                                  
 53505                                  USER_SP_2F:	; LABEL  WORD
 53506 00000D9E [A00D]                  	dw	FAKE_STACK_2F
 53507                                  
 53508                                  Packet_Temp:	; label  word		; temporary packet used by readtime
 53509                                  DOS_TEMP:	; label  word		; temporary word
 53510                                  
 53511                                  FAKE_STACK_2F:  
 53512                                  	; dw	14 dup (0)		; 12 register temporary storage
 53513 00000DA0 0000<rep Eh>            	times	14 dw 0
 53514                                  
 53515                                  ; 24/03/2024 - Retro DOS v5.0
 53516                                  ; PCDOS 7.1 IBMDOS.COM
 53517                                  %if 0
 53518                                  Hash_Temp:	;label  word		; temporary word
 53519                                  	;dw	4 dup (0)		; temporary hash table during config.sys
 53520                                  	times	4 dw 0
 53521                                  %endif
 53522                                  
 53523                                  SCAN_FLAG:
 53524 00000DBC 00                      	db     0			; flag to indicate key ALT_Q
 53525                                  DATE_FLAG:
 53526 00000DBD 0000                    	dw     0                	; flag to update the date
 53527                                  
 53528                                  ; 24/03/2024
 53529                                  %if 0
 53530                                  	; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0D93h
 53531                                  
 53532                                  FETCHI_TAG:	; label  word		; OBSOLETE - no longer used
 53533                                  	dw     0			; formerly part of IBM's piracy protection
 53534                                  
 53535                                  MSG_EXTERROR:	; label  DWORD 		; for system message addr
 53536                                  	dd     0               		; for extended error
 53537                                  	dd     0			; for parser
 53538                                  	dd     0			; for critical errror
 53539                                  	dd     0			; for IFS
 53540                                  	dd     0			; for code reduction
 53541                                  
 53542                                  SEQ_SECTOR:	; label  DWORD 		; last sector read
 53543                                  	dd     -1
 53544                                  SC_SECTOR_SIZE:
 53545                                  	dw	0			; sector size for SC
 53546                                  SC_DRIVE:
 53547                                  	db	0			; drive # for secondary cache
 53548                                  
 53549                                  ; 17/01/2024
 53550                                  ;CurSC_DRIVE:
 53551                                  ;	db	-1			; current SC drive
 53552                                  
 53553                                  CurSC_SECTOR:
 53554                                  	dd	0			; current SC starting sector
 53555                                  SC_STATUS:
 53556                                  	dw	0			; SC status word
 53557                                  SC_FLAG:
 53558                                  	db	0			; SC flag
 53559                                  
 53560                                  %endif
 53561                                  	; 24/03/2024
 53562                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:0DBFh
 53563                                  	; (MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0DB8h)
 53564                                  AbsDskErr:
 53565 00000DBF 0000                    	dw	0			; Storage for Abs dsk read/write err
 53566                                  
 53567                                  NO_NAME_ID:	; label byte
 53568 00000DC1 4E4F204E414D452020-     	db	'NO NAME    '		; null media id
 53568 00000DCA 2020               
 53569                                  
 53570                                  ;hkn; moved from TABLE segment in kstrin.asm
 53571                                  
 53572                                  KISTR001S:	; label	byte		; 2/17/KK
 53573 00000DCC 00                      LOOKSIZ: DB	0			; 0 if byte, NZ if word	2/17/KK
 53574                                  KISTR001E:	; label	byte		; 2/17/KK
 53575                                  
 53576                                  ; the nul device driver used to be part of the code. However, since the
 53577                                  ; header is in the data, and the entry points are only given as an offset,
 53578                                  ; the strategy and interrupt entry points must also be in the data now.
 53579                                  
 53580                                  ; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0DC6h
 53581                                  ; 24/03/2024
 53582                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0DCDh
 53583                                  
 53584                                  SNULDEV:
 53585                                  ;procedure snuldev,far
 53586                                  	;or	word [es:bx+3],100h
 53587                                  	; 17/12/2022
 53588                                  	;or	byte [es:bx+4],01h
 53589                                  	; 05/01/2024 - Retro DOS v4.2 (*)
 53590                                  	; (Original MSDOS and RetroDOS DATA address compatibility) (*)
 53591                                  	;or	byte [es:bx+SRHEAD.REQSTAT+1],(STDON>>8)
 53592                                  	; 24/03/2024 (PCDOS 7.1 IBMDOS.COM)
 53593 00000DCD 26814F030001            	or	word [es:bx+SRHEAD.REQSTAT],STDON ; set done bit
 53594                                  	; 05/01/2024 - Retro DOS v5.0
 53595                                  	;or	byte [es:bx+SRHEAD.REQSTAT+1],(STDON>>8)
 53596                                  INULDEV:
 53597 00000DD3 CB                      	retf				; must not be a return!
 53598                                  ;endproc snuldev
 53599                                  
 53600                                  ;M044
 53601                                  ; Second part of save area for saving last para of Windows memory
 53602                                  
 53603                                  ; 17/01/2024
 53604                                  ;WinoldPatch2:
 53605                                  ;	;db	8 dup (?)	; M044
 53606                                  ;	times	8 db 0	
 53607                                  
 53608                                  	; 24/03/2024 (PCDOS 7.1 IBMDOS.COM)
 53609 00000DD4 00                      	db	0
 53610                                  
 53611                                  UmbSave2:
 53612                                  	;db	5 dup (?)	; M062
 53613 00000DD5 00<rep 5h>              	times	5 db 0
 53614                                  UmbSaveFlag:
 53615 00000DDA 00                      	db	0		; M062
 53616                                  
 53617                                  ; DOSDATA:0DDBh
 53618                                  
 53619                                  Mark2:	; label byte
 53620                                  
 53621                                  ;IF2
 53622                                  ;	IF ((OFFSET MARK2) GT (OFFSET ERR_TABLE_21) )
 53623                                  ;		%OUT !DATA CORRUPTION!MARK2 OFFSET TOO BIG. RE-ORGANIZE DATA.
 53624                                  ;	ENDIF
 53625                                  ;ENDIF
 53626                                  
 53627                                  ;############################################################################
 53628                                  ;
 53629                                  ; ** HACK FOR DOS 4.0 REDIR **
 53630                                  ; 
 53631                                  ; The redir requires the following:
 53632                                  ;
 53633                                  ;	ERR_TABLE_21	offset DDBH
 53634                                  ;	ERR_TABLE_24	offset E5BH
 53635                                  ; 	ErrMap24	offset EABH
 53636                                  ;
 53637                                  ; WARNING! WARNING!
 53638                                  ;
 53639                                  ; MARK2 SHOULD NOT BE >= 0DDBH. IF SOME VARIABLE IS TO BE ADDED ABOVE DO SO
 53640                                  ; WITHOUT VIOLATING THIS AND UPDATE THE FOLL. LINE
 53641                                  ;
 53642                                  ; CURRENTLY MARK2 = 0DD0H
 53643                                  ;
 53644                                  ;############################################################################
 53645                                  
 53646                                  	;ORG	0DDBh
 53647                                  
 53648                                  ; DOSDATA:0DDBh (MSDOS 6.21, MSDOS.SYS)
 53649                                  ; 24/03/2024
 53650                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0DDBh
 53651                                  
 53652                                  ; ---------------------------------------------------------------------------
 53653                                  ;
 53654                                  ; The following table defines CLASS ACTION and LOCUS info for the INT 21H
 53655                                  ; errors. Each entry is 4 bytes long:
 53656                                  ;
 53657                                  ;       Err#,Class,Action,Locus
 53658                                  ;
 53659                                  ; A value of 0FFh indicates a call specific value (ie. should already
 53660                                  ; be set). AN ERROR CODE NOT IN THE TABLE FALLS THROUGH TO THE CATCH ALL AT
 53661                                  ; THE END, IT IS ASSUMES THAT CLASS, ACTION, LOCUS IS ALREADY SET.
 53662                                  ;
 53663                                  ; ---------------------------------------------------------------------------
 53664                                  
 53665                                  ;ErrTab  Macro   err,class,action,locus
 53666                                  ;ifidn <locus>,<0FFh>
 53667                                  ;    DB  error_&err,errCLASS_&class,errACT_&action,0FFh
 53668                                  ;ELSE
 53669                                  ;    DB  error_&err,errCLASS_&class,errACT_&action,errLOC_&locus
 53670                                  ;ENDIF
 53671                                  ;ENDM
 53672                                  
 53673                                  ERR_TABLE_21: ; LABEL   BYTE
 53674 00000DDB 010704FF                    DB  error_invalid_function,       errCLASS_Apperr,    errACT_Abort,    0FFh
 53675 00000DDF 02080302                    DB  error_file_not_found,         errCLASS_NotFnd,    errACT_User,     errLOC_Disk
 53676 00000DE3 03080302                    DB  error_path_not_found,         errCLASS_NotFnd,    errACT_User,     errLOC_Disk
 53677 00000DE7 04010401                    DB  error_too_many_open_files,    errCLASS_OutRes,    errACT_Abort,    errLOC_Unk
 53678 00000DEB 050303FF                    DB  error_access_denied,          errCLASS_Auth,      errACT_User,     0FFh
 53679 00000DEF 06070401                    DB  error_invalid_handle,         errCLASS_Apperr,    errACT_Abort,    errLOC_Unk
 53680 00000DF3 07070505                    DB  error_arena_trashed,          errCLASS_Apperr,    errACT_Panic,    errLOC_Mem
 53681 00000DF7 08010405                    DB  error_not_enough_memory,      errCLASS_OutRes,    errACT_Abort,    errLOC_Mem
 53682 00000DFB 09070405                    DB  error_invalid_block,          errCLASS_Apperr,    errACT_Abort,    errLOC_Mem
 53683 00000DFF 0A070405                    DB  error_bad_environment,        errCLASS_Apperr,    errACT_Abort,    errLOC_Mem
 53684 00000E03 0B090301                    DB  error_bad_format,             errCLASS_BadFmt,    errACT_User,     errLOC_Unk
 53685 00000E07 0C070401                    DB  error_invalid_access,         errCLASS_Apperr,    errACT_Abort,    errLOC_Unk
 53686 00000E0B 0D090401                    DB  error_invalid_data,           errCLASS_BadFmt,    errACT_Abort,    errLOC_Unk
 53687 00000E0F 0F080302                    DB  error_invalid_drive,          errCLASS_NotFnd,    errACT_User,     errLOC_Disk
 53688 00000E13 10030302                    DB  error_current_directory,      errCLASS_Auth,      errACT_User,     errLOC_Disk
 53689 00000E17 110D0302                    DB  error_not_same_device,        errCLASS_Unk,       errACT_User,     errLOC_Disk
 53690 00000E1B 12080302                    DB  error_no_more_files,          errCLASS_NotFnd,    errACT_User,     errLOC_Disk
 53691 00000E1F 500C0302                    DB  error_file_exists,            errCLASS_Already,   errACT_User,     errLOC_Disk
 53692 00000E23 200A0202                    DB  error_sharing_violation,      errCLASS_Locked,    errACT_DlyRet,   errLOC_Disk
 53693 00000E27 210A0202                    DB  error_lock_violation,         errCLASS_Locked,    errACT_DlyRet,   errLOC_Disk
 53694 00000E2B 540104FF                    DB  error_out_of_structures,      errCLASS_OutRes,    errACT_Abort,    0FFh
 53695 00000E2F 56030301                    DB  error_invalid_password,       errCLASS_Auth,      errACT_User,     errLOC_Unk
 53696 00000E33 52010402                    DB  error_cannot_make,            errCLASS_OutRes,    errACT_Abort,    errLOC_Disk
 53697 00000E37 32090303                    DB  error_not_supported,          errCLASS_BadFmt,    errACT_User,     errLOC_Net
 53698 00000E3B 550C0303                    DB  error_already_assigned,       errCLASS_Already,   errACT_User,     errLOC_Net
 53699 00000E3F 57090301                    DB  error_invalid_parameter,      errCLASS_BadFmt,    errACT_User,     errLOC_Unk
 53700 00000E43 530D0401                    DB  error_FAIL_I24,               errCLASS_Unk,       errACT_Abort,    errLOC_Unk
 53701 00000E47 24010405                    DB  error_sharing_buffer_exceeded,errCLASS_OutRes,    errACT_Abort,    errLOC_Mem
 53702                                      ; MSDOS 6.0
 53703 00000E4B 26010401                    DB  error_handle_EOF,             errCLASS_OutRes,    errACT_Abort,    errLOC_Unk ;AN000;
 53704 00000E4F 27010401                    DB  error_handle_Disk_Full,       errCLASS_OutRes,    errACT_Abort,    errLOC_Unk ;AN000;
 53705 00000E53 5A0D0402                    DB  error_sys_comp_not_loaded,    errCLASS_Unk,       errACT_Abort,    errLOC_Disk ;AN001;
 53706 00000E57 FFFFFFFF                    DB  0FFh,                         0FFH,       	  0FFH,       	   0FFh
 53707                                  
 53708                                  ; MSDOS 3.3 (IBMDOS.COM, 1987) - Offset 0D2Ah
 53709                                  ;ERR_TABLE_21:	db 1,7,4,0FFh
 53710                                  ;		db 2,8,3,2
 53711                                  ;		db 3,8,3,2
 53712                                  ;		db 4,1,4,1
 53713                                  ;		db 5,3,3,0FFh
 53714                                  ;		db 6,7,4,1
 53715                                  ;		db 7,7,5,5
 53716                                  ;		db 8,1,4,5
 53717                                  ;		db 9,7,4,5
 53718                                  ;		db 0Ah,7,4,5
 53719                                  ;		db 0Bh,9,3,1
 53720                                  ;		db 0Ch,7,4,1
 53721                                  ;		db 0Dh,9,4,1
 53722                                  ;		db 0Fh,8,3,2
 53723                                  ;		db 10h,3,3,2
 53724                                  ;		db 11h,0Dh,3,2
 53725                                  ;		db 12h,8,3,2
 53726                                  ;		db 50h,0Ch,3,2
 53727                                  ;		db 20h,0Ah,2,2
 53728                                  ;		db 21h,0Ah,2,2
 53729                                  ;		db 54h,1,4,0FFh
 53730                                  ;		db 56h,3,3,1
 53731                                  ;		db 52h,1,4,2
 53732                                  ;		db 32h,9,3,3
 53733                                  ;		db 55h,0Ch,3,3
 53734                                  ;		db 57h,9,3,1
 53735                                  ;		db 53h,0Dh,4,1
 53736                                  ;		db 24h,1,4,5
 53737                                  ; MSDOS 6.0 (MSDOS 6.21)
 53738                                  ;		db 26h,1,4,1
 53739                                  ;		db 27h,1,4,1
 53740                                  ;		db 5Ah,0Dh,4,2
 53741                                  ; MSDOS 6.0 & MSDOS 3.3
 53742                                  ;		db 0FFh,0FFh,0FFh,0FFh
 53743                                  
 53744                                  ; DOSDATA:0E5Bh (MSDOS 6.21, MSDOS.SYS)
 53745                                  
 53746                                  ; ---------------------------------------------------------------------------
 53747                                  ;
 53748                                  ; The following table defines CLASS ACTION and LOCUS info for the INT 24H
 53749                                  ; errors. Each entry is 4 bytes long:
 53750                                  ;
 53751                                  ;       Err#,Class,Action,Locus
 53752                                  ;
 53753                                  ; A Locus value of 0FFh indicates a call specific value (ie. should already
 53754                                  ; be set). AN ERROR CODE NOT IN THE TABLE FALLS THROUGH TO THE CATCH ALL AT
 53755                                  ; THE END.
 53756                                  ;
 53757                                  ; ---------------------------------------------------------------------------
 53758                                  
 53759                                  ERR_TABLE_24: ; LABEL   BYTE
 53760 00000E5B 130B0702                    DB  error_write_protect,          errCLASS_Media,     errACT_IntRet,   errLOC_Disk
 53761 00000E5F 14040501                    DB  error_bad_unit,               errCLASS_Intrn,     errACT_Panic,    errLOC_Unk
 53762 00000E63 150507FF                    DB  error_not_ready,              errCLASS_HrdFail,   errACT_IntRet,   0FFh
 53763 00000E67 16040501                    DB  error_bad_command,            errCLASS_Intrn,     errACT_Panic,    errLOC_Unk
 53764 00000E6B 170B0402                    DB  error_CRC,                    errCLASS_Media,     errACT_Abort,    errLOC_Disk
 53765 00000E6F 18040501                    DB  error_bad_length,             errCLASS_Intrn,     errACT_Panic,    errLOC_Unk
 53766 00000E73 19050102                    DB  error_seek,                   errCLASS_HrdFail,   errACT_Retry,    errLOC_Disk
 53767 00000E77 1A0B0702                    DB  error_not_DOS_disk,           errCLASS_Media,     errACT_IntRet,   errLOC_Disk
 53768 00000E7B 1B0B0402                    DB  error_sector_not_found,       errCLASS_Media,     errACT_Abort,    errLOC_Disk
 53769 00000E7F 1C020704                    DB  error_out_of_paper,           errCLASS_TempSit,   errACT_IntRet,   errLOC_SerDev
 53770 00000E83 1D0504FF                    DB  error_write_fault,            errCLASS_HrdFail,   errACT_Abort,    0FFh
 53771 00000E87 1E0504FF                    DB  error_read_fault,             errCLASS_HrdFail,   errACT_Abort,    0FFh
 53772 00000E8B 1F0D04FF                    DB  error_gen_failure,            errCLASS_Unk,       errACT_Abort,    0FFh
 53773 00000E8F 200A0202                    DB  error_sharing_violation,      errCLASS_Locked,    errACT_DlyRet,   errLOC_Disk
 53774 00000E93 210A0202                    DB  error_lock_violation,         errCLASS_Locked,    errACT_DlyRet,   errLOC_Disk
 53775 00000E97 220B0702                    DB  error_wrong_disk,             errCLASS_Media,     errACT_IntRet,   errLOC_Disk
 53776 00000E9B 32090303                    DB  error_not_supported,          errCLASS_BadFmt,    errACT_User,     errLOC_Net
 53777 00000E9F 23070401                    DB  error_FCB_unavailable,        errCLASS_Apperr,    errACT_Abort,    errLOC_Unk
 53778 00000EA3 24010405                    DB  error_sharing_buffer_exceeded,errCLASS_OutRes,    errACT_Abort,    errLOC_Mem
 53779 00000EA7 FF0D05FF                    DB	0FFh,                         errCLASS_Unk,       errACT_Panic,    0FFh
 53780                                  
 53781                                  ; MSDOS 3.3 (IBMDOS.COM, 1987) - Offset 0D9Eh
 53782                                  ;ERR_TABLE_24:	db 13h,0Bh,7,2
 53783                                  ;		db 14h,4,5,1
 53784                                  ;		db 15h,5,7,0FFh
 53785                                  ;		db 16h,4,5,1
 53786                                  ;		db 17h,0Bh,4,2
 53787                                  ;		db 18h,4,5,1
 53788                                  ;		db 19h,5,1,2
 53789                                  ;		db 1Ah,0Bh,7,2
 53790                                  ;		db 1Bh,0Bh,4,2
 53791                                  ;		db 1Ch,2,7,4
 53792                                  ;		db 1Dh,5,4,0FFh
 53793                                  ;		db 1Eh,5,4,0FFh
 53794                                  ;		db 1Fh,0Dh,4,0FFh
 53795                                  ;		db 20h,0Ah,2,2
 53796                                  ;		db 21h,0Ah,2,2
 53797                                  ;		db 22h,0Bh,7,2
 53798                                  ;		db 32h,9,3,3
 53799                                  ;		db 23h,7,4,1
 53800                                  ;		db 24h,1,4,5
 53801                                  ;		db 0FFh,0Dh,5,0FFh
 53802                                  
 53803                                  ; DOSDATA:0EABh (MSDOS 6.21, MSDOS.SYS)
 53804                                  
 53805                                  ; ---------------------------------------------------------------------------
 53806                                  ;
 53807                                  ; We need to map old int 24 errors and device driver errors into the new set
 53808                                  ; of errors. The following table is indexed by the new errors
 53809                                  ;
 53810                                  ; ---------------------------------------------------------------------------
 53811                                  
 53812                                  ;Public  ErrMap24
 53813                                  ErrMap24: ; Label   BYTE
 53814 00000EAB 13                          DB  error_write_protect	; 0
 53815 00000EAC 14                          DB  error_bad_unit		; 1
 53816 00000EAD 15                          DB  error_not_ready		; 2
 53817 00000EAE 16                          DB  error_bad_command	; 3
 53818 00000EAF 17                          DB  error_CRC		; 4
 53819 00000EB0 18                          DB  error_bad_length	; 5
 53820 00000EB1 19                          DB  error_seek		; 6
 53821 00000EB2 1A                          DB  error_not_DOS_disk	; 7
 53822 00000EB3 1B                          DB  error_sector_not_found	; 8
 53823 00000EB4 1C                          DB  error_out_of_paper	; 9
 53824 00000EB5 1D                          DB  error_write_fault	; A
 53825 00000EB6 1E                          DB  error_read_fault	; B
 53826 00000EB7 1F                          DB  error_gen_failure	; C
 53827 00000EB8 1F                          DB  error_gen_failure	; D  RESERVED
 53828 00000EB9 1F                          DB  error_gen_failure	; E  RESERVED
 53829 00000EBA 22                          DB  error_wrong_disk	; F
 53830                                  
 53831                                  ;ErrMap24: db 13h, 14h, 15h, 16h, 17h, 18h, 19h, 1Ah
 53832                                  ;	   db 1Bh, 1Ch, 1Dh, 1Eh, 1Fh, 1Fh, 1Fh, 22h
 53833                                  	
 53834                                  ErrMap24End: ; LABEL   BYTE
 53835                                  
 53836                                  ; DOSDATA:0EBBh (MSDOS 6.21, MSDOS.SYS)
 53837                                  
 53838                                  ; 09/03/2024 - Retro DOS v5.0
 53839                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0EBBh (SPECIAL_VERSION)
 53840                                  
 53841                                  ; MSDOS 5.0  MSDOS.SYS - DOSDATA:0EBBh (FIRST_BUFF_ADDR)
 53842                                  ; MSDOS 6.22 MSDOS.SYS - DOSDATA:0EBBh (FIRST_BUFF_ADDR)
 53843                                  ; Windows ME    IO.SYS - DOSDATA:0EBBh (SPECIAL_VERSION)
 53844                                  
 53845                                  ; ---------------------------------------------------------------------------
 53846                                  
 53847                                  ; 27/04/2019 - Retro DOS v4.0
 53848                                  
 53849                                  ; 17/01/2024
 53850                                  ;FIRST_BUFF_ADDR:
 53851                                  ;	dw	0			; first buffer address
 53852                                  
 53853                                  SPECIAL_VERSION:
 53854 00000EBB 0000                    	dw	0			;AN006; used by INT 2F 47H
 53855                                  
 53856                                  ; 25/03/2024 - Retro DOS v5.0
 53857                                  ; PCDOS 7.1 IBMDOS.COM
 53858                                  %if 0
 53859                                  FAKE_COUNT:
 53860                                  	times 255 db 0			;AN008; fake version count
 53861                                  %endif
 53862                                  
 53863                                  OLD_FIRSTCLUS:
 53864 00000EBD 0000                    	dw	0			;AN011; save old first cluster for fastopen
 53865                                  
 53866                                  ; ---------------------------------------------------------------------------
 53867                                  
 53868                                  ;smr; moved from TABLE segment in exec.asm
 53869                                  
 53870 00000EBF 0000                    exec_init_SP: dw 0
 53871 00000EC1 0000                    exec_init_SS: dw 0
 53872 00000EC3 0000                    exec_init_IP: dw 0
 53873 00000EC5 0000                    exec_init_CS: dw 0
 53874                                  
 53875                                  exec_signature:
 53876 00000EC7 0000                    	dw	0	; must contain 4D5A (yay zibo!)
 53877                                  exec_len_mod_512:
 53878 00000EC9 0000                    	dw	0	; low 9 bits of length
 53879                                  exec_pages:
 53880 00000ECB 0000                    	dw	0	; number of 512b pages in file
 53881                                  exec_rle_count:
 53882 00000ECD 0000                    	dw	0	; count of reloc entries
 53883                                  exec_par_dir:
 53884 00000ECF 0000                    	dw	0	; number of paragraphs before image
 53885                                  exec_min_BSS:
 53886 00000ED1 0000                    	dw	0	; minimum number of para of BSS
 53887                                  exec_max_BSS:
 53888 00000ED3 0000                    	dw	0	; max number of para of BSS
 53889                                  exec_SS:
 53890 00000ED5 0000                    	dw	0	; stack of image
 53891                                  exec_SP:
 53892 00000ED7 0000                    	dw	0	; SP of image
 53893                                  exec_chksum:
 53894 00000ED9 0000                    	dw	0	; checksum of file (ignored)
 53895                                  exec_IP:
 53896 00000EDB 0000                    	dw	0	; IP of entry
 53897                                  exec_CS:
 53898 00000EDD 0000                    	dw	0	; CS of entry
 53899                                  exec_rle_table:
 53900 00000EDF 0000                    	dw	0	; byte offset of reloc table
 53901                                  
 53902                                  exec_header_len	equ $-exec_signature			;PBUGBUG
 53903                                  
 53904                                  ;smr; eom
 53905                                  
 53906                                  ; ---------------------------------------------------------------------------
 53907                                  
 53908                                  ;SR;
 53909                                  ; WIN386 instance table for DOS
 53910                                  
 53911                                  Win386_Info:
 53912                                  	;db	3,0
 53913                                  	; 17/01/2024 - PCDOS 7.1 IBMDOS.COM - DOSDATA:0EE1h
 53914 00000EE1 0400                    	db	4,0	; WIN386_SIS version
 53915 00000EE3 00000000                	dd	0	; .Next_Dev_Ptr
 53916                                  Win386_Inf_Virt_Dev_Ptr:
 53917 00000EE7 00000000                	dd	0	; .Virt_Dev_File_Ptr
 53918 00000EEB 00000000                	dd	0	; .Reference_Data
 53919                                  Instance_Data_Ptr:
 53920 00000EEF [F70E]0000              	dw	Instance_Table, 0
 53921                                  	; 17/01/2024 - PCDOS 7.1 IBMDOS.COM
 53922                                  	;;
 53923 00000EF3 [3D0F]0000              	dw	Unknown_Table, 0  ; (what is this and what for ?)
 53924                                  				  ; (Win386_IIS.size)
 53925                                  	;;
 53926                                  
 53927                                  Instance_Table:
 53928 00000EF7 [2200]00000200          	dw	CONTPOS,0,2
 53929 00000EFD [3200]00000400          	dw	BCON,0,4
 53930 00000F03 [F901]00000601          	dw	CARPOS,0,106h
 53931 00000F09 [0003]00000100          	dw	CHARCO,0,1
 53932 00000F0F [BF0E]00002200          	dw	exec_init_SP,0,34	; M074
 53933 00000F15 [8900]00000100          	dw	UMBFLAG,0,1		; M019
 53934 00000F1B [8C00]00000200          	dw	UMB_HEAD,0,2		; M019
 53935                                  	;;;
 53936                                  	; 17/01/2024 - PCDOS 7.1 IBMDOS.COM
 53937 00000F21 [8600]C9000100          	dw	DOS_FLAG,0C9h,1
 53938 00000F27 [B812]C9000100          	dw	INDOS_FLAG,0C9h,1 ; (what for a 2nd INDOS flag, windows?)
 53939 00000F2D [B912]C9000100          	dw	DEVIO_IN_PROGRESS,0C9h,1
 53940                                  				; "devio call in progress" status flag ptr
 53941                                  	;;;
 53942 00000F33 00000000                	dw	0, 0
 53943                                  
 53944                                  	;;;
 53945                                  	; 17/01/2024 - PCDOS 7.1 IBMDOS.COM
 53946 00000F37 FFFF                    	dw	0FFFFh
 53947 00000F39 FFFF                    	dw	0FFFFh
 53948                                  CL0FATENTRY_HW:
 53949 00000F3B FFFF                    	dw	0FFFFh
 53950                                  Unknown_Table:
 53951 00000F3D 0000                    	dw	0
 53952 00000F3F C900                    	dw	0C9h
 53953 00000F41 [CC00]                  	dw	SFTABL		; DOSDATA:00CCh
 53954 00000F43 [F901]                  	dw	CARPOS
 53955 00000F45 C900                    	dw	0C9h
 53956 00000F47 [4D11]                  	dw	UNKNOWN1	; ? (points to DOSDATA:114Dh)
 53957 00000F49 0000                    	dw	0
 53958 00000F4B 0000                    	dw	0
 53959                                  	;;;
 53960                                  
 53961                                  ; M001; SR;
 53962                                  ; M001; On DOSMGR call ( cx == 0 ), we need to return a table of offsets of
 53963                                  ; M001; some DOS variables. Note that the only really important variable in
 53964                                  ; M001; this is User_Id. The other variables are needed only to patch stuff
 53965                                  ; M001; which does not need to be done in DOS 5.0. 
 53966                                  
 53967                                  ; 29/12/2022
 53968                                  ; (MSDOS 6.21 MSDOS.SYS - DOSDATA:1022h)
 53969                                  ; 25/03/2024
 53970                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0F4Dh
 53971                                  
 53972                                  Win386_DOSVars:
 53973 00000F4D 05                      	db	5	;Major version 5 ; M001
 53974 00000F4E 00                      	db	0	;Minor version 0 ; M001
 53975 00000F4F [EC05]                  	dw	SAVEDS	; M001
 53976 00000F51 [EA05]                  	dw	SAVEBX	; M001
 53977 00000F53 [2103]                  	dw	INDOS	; M001
 53978 00000F55 [3E03]                  	dw	USER_ID	; M001
 53979 00000F57 [1503]                  	dw	CritPatch ; M001
 53980 00000F59 [8C00]                  	dw	UMB_HEAD ; M012
 53981                                  
 53982                                  ;SR;
 53983                                  ; Flag to indicate whether WIN386 is running or not
 53984                                  
 53985                                  IsWin386:
 53986 00000F5B 00                      	db	0
 53987                                  
 53988                                  ; 09/03/2024 (PCDOS 7.1 IBMDOS.COM)
 53989                                  
 53990 00000F5C 00                      	db	0
 53991                                  
 53992                                  ; 09/03/2024 (PCDOS 7.1 IBMDOS.COM)
 53993                                  %if 0		
 53994                                  
 53995                                  ;M018
 53996                                  ; This variable contains the path to the VxD device needed for Win386
 53997                                  
 53998                                  ; 09/01/2024
 53999                                  ;VxDpath: db	'c:\wina20.386',0	;M018
 54000                                  
 54001                                  ;End WIN386 support
 54002                                  
 54003                                  ; ---------------------------------------------------------------------------
 54004                                  
 54005                                  ;SR;
 54006                                  ; These variables have been added for the special lie support for device
 54007                                  ;drivers.
 54008                                  ;
 54009                                  
 54010                                  DriverLoad:	
 54011                                  	db	1	;initialized to do special handling
 54012                                  BiosDataPtr:
 54013                                  	dd	0
 54014                                  
 54015                                  %endif
 54016                                  
 54017                                  ; 25/03/2024
 54018                                  %if 1
 54019                                  ; 29/12/2022 - Retro DOS v4.1
 54020                                  ;%if 0
 54021                                  
 54022                                  ; 27/04/2019 - Retro DOS v4.0
 54023                                  ; 04/11/2022
 54024                                  ; DOSDATA:1044h (MSDOS 6.21 & MSDOS 5.0, MSDOS.SYS)
 54025                                  
 54026                                  ;------------------------------------------------------------------------
 54027                                  ; Patch for Sidekick
 54028                                  ;
 54029                                  ; A documented method for finding the offset of the Errormode flag in the
 54030                                  ; dos swappable data area if for the app to scan in the dos segment (data)
 54031                                  ; for the following sequence of instructions.
 54032                                  ;
 54033                                  ; Ref: Part C, Article 11, pg 356 of MSDOS Encyclopedia
 54034                                  ;
 54035                                  ; The Offset of Errormode flag is 0320h
 54036                                  ;
 54037                                  ;------------------------------------------------------------------------
 54038                                  
 54039 00000F5D 36F6062003FF            	db	036h, 0F6h, 06h, 020h, 03h, 0FFh ; test ss:[errormode], -1
 54040 00000F63 750C                    	db	075h, 0Ch			 ; jnz  NearLabel
 54041 00000F65 36FF365803              	db	036h, 0FFh, 036h, 058h, 03h	 ; push ss:[NearWord]
 54042 00000F6A CD28                    	db	0CDh, 028h			 ; int  28h
 54043                                  
 54044                                  ;--------------------------------------------------------------------------
 54045                                  ; Patch for PortOfEntry - M036
 54046                                  ;
 54047                                  ; PortOfEntry by Sector Technology uses an un documented way of determining
 54048                                  ; the offset of Errormode flag. The following patch is to support them in
 54049                                  ; DOS 5.0. The corresponding code is actually in msdisp.asm
 54050                                  ;
 54051                                  ;---------------------------------------------------------------------------
 54052                                  
 54053 00000F6C 803E200300              	db 	080h, 03Eh, 020h, 03h, 00h 	 ; cmp 	[errormode], 0
 54054 00000F71 7537                    	db	075h, 037h			 ; jnz	NearLabel
 54055 00000F73 BCA00A                  	db 	0BCh, 0A0h, 0Ah		  	 ; mov	sp, dosdata:iostack
 54056                                  
 54057                                  %endif ; 29/12/2022
 54058                                  
 54059                                  ; DOSDATA:105Dh (MSDOS 6.21, MSDOS.SYS)
 54060                                  ; 25/03/2024
 54061                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0F76h
 54062                                  
 54063                                  ;--------------------------------------------------------------------------
 54064                                  
 54065                                  ;*** New FCB Implementation
 54066                                  ; This variable is used as a cache in the new FCB implementation to remember
 54067                                  ;the address of a local SFT that can be recycled for a regenerate operation
 54068                                  
 54069 00000F76 00000000                LocalSFT: dd	0		; 0 to indicate invalid pointer
 54070                                  
 54071                                  ;DOSDATA ENDS
 54072                                  
 54073                                  ;============================================================================
 54074                                  ; LMSTUB.ASM (MSDOS 6.0, 1991)
 54075                                  ;============================================================================
 54076                                  ; 27/04/2019 - Retro DOS 4.0
 54077                                  ; 25/03/2024 - Retro DOS 5.0
 54078                                  
 54079                                  ;DOSDATA  SEGMENT WORD PUBLIC 'DATA'
 54080                                  
 54081                                  ;---------------------------------------------------------------------------
 54082                                  ;	Low Memory Stub for DOS when DOS runs in HMA
 54083                                  ;----------------------------------------------------------------------------
 54084                                  	
 54085                                  	;db	90h
 54086                                  
 54087                                  	;EVEN
 54088                                  align 2
 54089                                  
 54090                                  ; DOSDATA:1062h (MSDOS 5.0-6.22, MSDOS.SYS)
 54091                                  ; 25/03/2024
 54092                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0F7Ah
 54093                                  
 54094                                  DOSINTTABLE:	; LABEL	DWORD
 54095                                  
 54096                                  	;DW	OFFSET DOSCODE:DIVOV 		, 0
 54097                                  	;DW	OFFSET DOSCODE:QUIT 		, 0
 54098                                  	;DW	OFFSET DOSCODE:COMMAND		, 0
 54099                                  	;DW	OFFSET DOSCODE:ABSDRD		, 0
 54100                                  	;DW	OFFSET DOSCODE:ABSDWRT		, 0
 54101                                  	;DW	OFFSET DOSCODE:Stay_resident	, 0
 54102                                  	;DW	OFFSET DOSCODE:INT2F		, 0
 54103                                  	;DW	OFFSET DOSCODE:CALL_ENTRY	, 0
 54104                                  	;DW	OFFSET DOSCODE:IRETT		, 0
 54105                                  	
 54106 00000F7A [0260]0000              	dw	DIVOV 		, 0  ; DOSINTTABLE+0
 54107 00000F7E [C502]0000              	dw	QUIT 		, 0  ; DOSINTTABLE+4
 54108 00000F82 [F102]0000              	dw	COMMAND		, 0  ; DOSINTTABLE+8
 54109 00000F86 [2D05]0000              	dw	ABSDRD		, 0  ; DOSINTTABLE+12
 54110 00000F8A [DC05]0000              	dw	ABSDWRT		, 0  ; DOSINTTABLE+16
 54111 00000F8E [6872]0000              	dw	STAY_RESIDENT	, 0  ; DOSINTTABLE+20
 54112 00000F92 [3607]0000              	dw	INT2F		, 0  ; DOSINTTABLE+24
 54113 00000F96 [CC02]0000              	dw	CALL_ENTRY	, 0  ; DOSINTTABLE+28
 54114                                  
 54115                                  ; 25/03/2024 - Retro DOS v5.0
 54116                                  ; PCDOS 7.1 IBMDOS.COM
 54117                                  %if 0
 54118                                  	dw	IRETT		, 0  ; DOSINTTABLE+32
 54119                                  %endif
 54120                                  
 54121 00000F9A 0000                    SS_Save: dw	0		; save user's stack segment
 54122 00000F9C 0000                    SP_Save: dw	0		; save user's stack offset
 54123                                  
 54124                                  ;-------------------------------------------------------------------------
 54125                                  ;
 54126                                  ; LOW MEM STUB:
 54127                                  ;
 54128                                  ; The low mem stub contains the entry points into DOS for all interrupts
 54129                                  ; handled by DOS. This stub is installed if the user specifies that the
 54130                                  ; DOS load in HIMEM. Each entry point does this.
 54131                                  ;
 54132                                  ; 	1. if jmp to 8 has been patched out
 54133                                  ;	   2. if A20 OFF
 54134                                  ;	      3. Enable A20
 54135                                  ;	   4. else 
 54136                                  ;	      5. just go to dos entry
 54137                                  ;	   6. endif
 54138                                  ;	7. else
 54139                                  ;	   8. just go to dos entry
 54140                                  ;	9. endif
 54141                                  ;
 54142                                  ;--------------------------------------------------------------------------
 54143                                  
 54144                                  ; 27/04/2019 - Retro DOS v4.0
 54145                                  
 54146                                  ; DOSDATA:108Ah (MSDOS 6.21, MSDOS.SYS)
 54147                                  
 54148                                  ; 25/03/2024 - Retro DOS v5.0
 54149                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0F9Eh
 54150                                  
 54151                                  ;--------------------------------------------------------------------------
 54152                                  ;
 54153                                  ; DIVIDE BY 0 handler
 54154                                  ;
 54155                                  ;--------------------------------------------------------------------------
 54156                                  
 54157                                  ldivov:
 54158                                  	; The following jump, skipping the XMS calls will be patched to
 54159                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 54160                                  	; needed because the stub is installed even before the XMS driver
 54161                                  	; is loaded if the user specifies dos=high in the config.sys
 54162                                  i0patch:
 54163 00000F9E EB03                    	jmp	short divov_cont
 54164                                  
 54165 00000FA0 E8E200                  	call	EnsureA20ON		; we must turn on A20 if OFF
 54166                                  divov_cont:
 54167 00000FA3 2EFF2E[7A0F]            	jmp	far [cs:DOSINTTABLE]	; jmp to DOS
 54168                                  
 54169                                  ;--------------------------------------------------------------------------
 54170                                  ;
 54171                                  ; INT 20h Handler
 54172                                  ;
 54173                                  ; Here we do not have to set up the stack to return here as the abort call
 54174                                  ; will return to the address after the int 21 ah=4b call. This would be the
 54175                                  ; common exit point if A20 had been OFF (for TOGGLE DOS) and the A20 line
 54176                                  ; will be restored then.
 54177                                  ;
 54178                                  ;--------------------------------------------------------------------------
 54179                                  
 54180                                  lquit:
 54181                                  	; The following jump, skipping the XMS calls will be patched to
 54182                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 54183                                  	; needed because the stub is installed even before the XMS driver
 54184                                  	; is loaded if the user specifies dos=high in the config.sys
 54185                                  i20patch:
 54186 00000FA8 EB03                    	jmp	short quit_cont
 54187                                  
 54188 00000FAA E8D800                  	call	EnsureA20ON		; we must turn on A20 if OFF
 54189                                  quit_cont:
 54190 00000FAD 2EFF2E[7E0F]            	jmp	far [cs:DOSINTTABLE+4]	; jump to DOS
 54191                                  
 54192                                  ;--------------------------------------------------------------------------
 54193                                  ;
 54194                                  ; INT 21h Handler
 54195                                  ;
 54196                                  ;--------------------------------------------------------------------------
 54197                                  
 54198                                  lcommand:
 54199                                  	; The following jump, skipping the XMS calls will be patched to
 54200                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 54201                                  	; needed because the stub is installed even before the XMS driver
 54202                                  	; is loaded if the user specifies dos=high in the config.sys
 54203                                  i21patch:
 54204 00000FB2 EB03                    	jmp	short command_cont
 54205                                  
 54206 00000FB4 E8CE00                  	call	EnsureA20ON		; we must turn on A20 if OFF
 54207                                  command_cont:
 54208 00000FB7 2EFF2E[820F]            	jmp	far [cs:DOSINTTABLE+8]	; jmp to DOS
 54209                                  
 54210                                  ;--------------------------------------------------------------------------
 54211                                  ;
 54212                                  ; INT 25h
 54213                                  ;
 54214                                  ;--------------------------------------------------------------------------
 54215                                  
 54216                                  labsdrd:
 54217                                  	; The following jump, skipping the XMS calls will be patched to
 54218                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 54219                                  	; needed because the stub is installed even before the XMS driver
 54220                                  	; is loaded if the user specifies dos=high in the config.sys
 54221                                  i25patch:
 54222 00000FBC EB03                    	jmp	short absdrd_cont
 54223                                  
 54224 00000FBE E8C400                  	call	EnsureA20ON		; we must turn on A20 if OFF
 54225                                  absdrd_cont:
 54226 00000FC1 2EFF2E[860F]            	jmp	far [cs:DOSINTTABLE+12]	; jmp to DOS
 54227                                  
 54228                                  ;--------------------------------------------------------------------------
 54229                                  ;
 54230                                  ; INT 26h
 54231                                  ;
 54232                                  ;--------------------------------------------------------------------------
 54233                                  
 54234                                  labsdwrt:
 54235                                  	; The following jump, skipping the XMS calls will be patched to
 54236                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 54237                                  	; needed because the stub is installed even before the XMS driver
 54238                                  	; is loaded if the user specifies dos=high in the config.sys
 54239                                  i26patch:
 54240 00000FC6 EB03                    	jmp	short absdwrt_cont
 54241                                  
 54242 00000FC8 E8BA00                  	call	EnsureA20ON		; we must turn on A20 if OFF
 54243                                  absdwrt_cont:
 54244 00000FCB 2EFF2E[8A0F]            	jmp	far [cs:DOSINTTABLE+16]	; jmp to DOS
 54245                                  
 54246                                  ;--------------------------------------------------------------------------
 54247                                  ;
 54248                                  ; INT 27h
 54249                                  ;
 54250                                  ;--------------------------------------------------------------------------
 54251                                  
 54252                                  lstay_resident:
 54253                                  	; The following jump, skipping the XMS calls will be patched to
 54254                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 54255                                  	; needed because the stub is installed even before the XMS driver
 54256                                  	; is loaded if the user specifies dos=high in the config.sys
 54257                                  i27patch:
 54258 00000FD0 EB03                    	jmp	short sr_cont
 54259                                  
 54260 00000FD2 E8B000                  	call	EnsureA20ON		; we must turn on A20 if OFF
 54261                                  sr_cont:
 54262 00000FD5 2EFF2E[8E0F]            	jmp	far [cs:DOSINTTABLE+20]	; jmp to DOS
 54263                                  
 54264                                  ;--------------------------------------------------------------------------
 54265                                  ;
 54266                                  ; INT 2Fh
 54267                                  ;
 54268                                  ;--------------------------------------------------------------------------
 54269                                  
 54270                                  lint2f:
 54271                                  	; The following jump, skipping the XMS calls will be patched to
 54272                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 54273                                  	; needed because the stub is installed even before the XMS driver
 54274                                  	; is loaded if the user specifies dos=high in the config.sys
 54275                                  i2fpatch:
 54276 00000FDA EB03                    	jmp	short int2f_cont
 54277                                  
 54278 00000FDC E8A600                  	call	EnsureA20ON		; we must turn on A20 if OFF
 54279                                  int2f_cont:
 54280 00000FDF 2EFF2E[920F]            	jmp	far [cs:DOSINTTABLE+24]	; jmp to DOS
 54281                                  
 54282                                  ;--------------------------------------------------------------------------
 54283                                  ;
 54284                                  ; CPM entry
 54285                                  ;
 54286                                  ;--------------------------------------------------------------------------
 54287                                  
 54288                                  lcall_entry:
 54289                                  	; The following jump, skipping the XMS calls will be patched to
 54290                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 54291                                  	; needed because the stub is installed even before the XMS driver
 54292                                  	; is loaded if the user specifies dos=high in the config.sys
 54293                                  cpmpatch:
 54294 00000FE4 EB03                    	jmp	short callentry_cont
 54295                                  
 54296 00000FE6 E89C00                  	call	EnsureA20ON		; we must turn on A20 if OFF
 54297                                  callentry_cont:
 54298 00000FE9 2EFF2E[960F]            	jmp	far [cs:DOSINTTABLE+28]	; jmp to DOS
 54299                                  
 54300                                  ;--------------------------------------------------------------------------
 54301                                  
 54302                                  ; 25/03/2024 - Retro DOS v5.0
 54303                                  ; PCDOS 7.1 IBMDOS.COM
 54304                                  %if 0
 54305                                  
 54306                                  lirett:
 54307                                  	iret
 54308                                  
 54309                                  %endif
 54310                                  
 54311                                  ;---------------------------------------------------------------------------
 54312                                  ;
 54313                                  ; LowIntXX:
 54314                                  ;
 54315                                  ; Interrupts from DOS that pass control to a user program must be done from
 54316                                  ; low memory, as the user program may change the state of the A20 line or
 54317                                  ; they may require that the A20 line be OFF. The following piece of code is
 54318                                  ; far call'd from the following places in DOS:
 54319                                  ;
 54320                                  ;	1. msctrlc.asm where dos issues an int 23h (ctrlc)
 54321                                  ;	2. msctrlc.asm where dos issues an int 24h (critical error)
 54322                                  ;	3. msctrlc.asm where dos issues an int 28h (idle int)
 54323                                  ;
 54324                                  ; The int 23 and int 24 handlers may decide to do a far return instead of an
 54325                                  ; IRET ane leave the flags on the stack. Therefore we save the return address
 54326                                  ; before doing the ints and then do a far junp back into DOS.
 54327                                  ;
 54328                                  ;---------------------------------------------------------------------------
 54329                                  
 54330                                  ; 25/03/2024 - Retro DOS v5.0
 54331                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0FEEh
 54332                                  ; (MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:10DBh)
 54333                                  
 54334 00000FEE 00000000                DosRetAddr23:	dd	0
 54335 00000FF2 00000000                DosRetAddr24:	dd	0
 54336                                  
 54337                                  ; 25/03/2024 - Retro DOS v5.0
 54338                                  ; PCDOS 7.1 IBMDOS.COM
 54339                                  %if 0
 54340                                  DosRetAddr28:	dd	0
 54341                                  %endif
 54342                                  
 54343                                  	; Execute int 23h from low memory
 54344                                  LowInt23:
 54345                                  					; save the return address that is on
 54346                                  					; the stack
 54347 00000FF6 2E8F06[EE0F]            	pop	word [cs:DosRetAddr23]
 54348 00000FFB 2E8F06[F00F]            	pop	word [cs:DosRetAddr23+2]
 54349                                  
 54350 00001000 CD23                    	int	23h			; ctrl C
 54351                                  					; turn on A20 it has been turned OFF
 54352                                  					; by int 28/23/24 handler.
 54353                                  
 54354 00001002 E88000                  	call	EnsureA20ON		; M011: we must turn on A20 if OFF
 54355                                  
 54356 00001005 2EFF2E[EE0F]            	jmp	far [cs:DosRetAddr23]	; jump back to DOS
 54357                                  
 54358                                  
 54359                                  	; Execute int 24h from low memory
 54360                                  LowInt24:
 54361                                  					; save the return address that is on
 54362                                  					; the stack
 54363 0000100A 2E8F06[F20F]            	pop	word [cs:DosRetAddr24]
 54364 0000100F 2E8F06[F40F]            	pop	word [cs:DosRetAddr24+2]
 54365                                  
 54366 00001014 CD24                    	int	24h			; crit error
 54367                                  					; turn on A20 it has been turned OFF
 54368                                  					; by int 28/23/24 handler.
 54369                                  
 54370 00001016 E86C00                  	call	EnsureA20ON		; M011: we must turn on A20 if OFF
 54371                                  
 54372 00001019 2EFF2E[F20F]            	jmp	far [cs:DosRetAddr24]	; jump back to DOS
 54373                                  
 54374                                  
 54375                                   
 54376                                  	; Execute int 28h from low memory
 54377                                  LowInt28:
 54378 0000101E CD28                    	int	28h			; idle int
 54379                                  					; turn on A20 it has been turned OFF
 54380                                  					; by int 28/23/24 handler.
 54381                                  
 54382 00001020 E86200                  	call	EnsureA20ON		; M011: we must turn on A20 if OFF
 54383                                  
 54384 00001023 CB                      	retf
 54385                                  
 54386                                  ; DOSDATA:1115h (MSDOS 6.21, MSDOS.SYS)
 54387                                  
 54388                                  ;-------------------------------------------------------------------------
 54389                                  ;
 54390                                  ; int 21 ah=4b (exec) call will jump to the following label before xferring
 54391                                  ; control to the exec'd program. We turn off A20 inorder to allow programs
 54392                                  ; that have been packed by the faulty exepack utility to unpack correctly.
 54393                                  ; This is so because exepac'd programs rely on address wrap.
 54394                                  ;
 54395                                  ;------------------------------------------------------------------------- 
 54396                                  
 54397                                  ; 25/03/2024 - Retro DOS v5.0
 54398                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1024h
 54399                                  
 54400                                  disa20_xfer:
 54401 00001024 E84800                  	call	XMMDisableA20		; disable A20
 54402                                  
 54403                                  	; Look at msproc.asm at label exec_go for understanding the following:
 54404                                  
 54405                                  	; DS:SI points to entry point
 54406                                  	; AX:DI points to initial stack
 54407                                  	; DX has PDB pointer
 54408                                  	; BX has initial AX value
 54409                                  
 54410 00001027 FA                      	cli
 54411 00001028 2EC606[2103]00          	mov	byte [cs:INDOS],0	; SS Override
 54412                                  
 54413                                  	; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 54414                                  	;;;
 54415 0000102E 36C606[B812]00          	mov     byte [ss:INDOS_FLAG],0
 54416                                  	;;;
 54417                                  
 54418 00001034 8ED0                    	mov	SS,AX			; set up user's stack
 54419 00001036 89FC                    	mov	SP,DI			; and SP
 54420 00001038 FB                      	sti
 54421                                  
 54422 00001039 1E                      	push	DS			; fake long call to entry
 54423 0000103A 56                      	push	SI
 54424 0000103B 8EC2                    	mov	ES,DX			; set up proper seg registers
 54425 0000103D 8EDA                    	mov	DS,DX
 54426 0000103F 89D8                    	mov	AX,BX			; set up proper AX
 54427 00001041 CB                      	retf
 54428                                  
 54429                                  ;-------------------------------------------------------------------------
 54430                                  ;
 54431                                  ; M003:
 54432                                  ;
 54433                                  ; If an int 21 ah=25 call is made immediately after an exec call, DOS will
 54434                                  ; come here, turn A20 OFF restore user stack and registers before returning
 54435                                  ; to user. This is done in dos\msdisp.asm. This has been done to support 
 54436                                  ; programs compiled with MS PASCAL 3.2. See under TAG M003 in DOSSYM.INC for
 54437                                  ; more info.
 54438                                  ;
 54439                                  ; Also at this point DS is DOSDATA. So we can assume DS DOSDATA. Note that
 54440                                  ; SS is also DOS stack. It is important that we do the XMS call on DOS's
 54441                                  ; stack to avoid additional stack overhead for the user.
 54442                                  ;
 54443                                  ; -------------------------------------------------------------------------
 54444                                  
 54445                                  disa20_iret:
 54446 00001042 E82A00                  	call	XMMDisableA20
 54447 00001045 FE0E[2103]              	dec	byte [INDOS]
 54448                                  
 54449                                  	; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 54450                                  	;;;
 54451 00001049 FE0E[B812]              	dec	byte [INDOS_FLAG]
 54452                                  	;;;
 54453                                  
 54454 0000104D 8E16[8605]              	mov	SS,[USER_SS]		; restore user stack
 54455 00001051 8B26[8405]              	mov	SP,[USER_SP]
 54456 00001055 89E5                    	mov	BP,SP
 54457                                  	;mov	[BP+user_env.user_AX],AL
 54458 00001057 884600                  	mov	[bp],al
 54459                                  	
 54460                                  ; 25/03/2024
 54461                                  %if 0
 54462                                  	mov	AX,[NSP]
 54463                                  	mov	[USER_SP],AX
 54464                                  	mov	AX,[NSS]
 54465                                  	mov	[USER_SS],AX
 54466                                  %else
 54467                                  	; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 54468                                  	;;;
 54469                                  	;les	ax, dword ptr ds:NSS
 54470 0000105A C406[F005]              	les	ax,[NSS]
 54471 0000105E 8C06[8405]              	mov	[USER_SP],es
 54472 00001062 A3[8605]                	mov	[USER_SS],ax
 54473                                  	;;;
 54474                                  %endif
 54475 00001065 58                      	pop	AX			; restore user regs
 54476 00001066 5B                      	pop	BX
 54477 00001067 59                      	pop	CX
 54478 00001068 5A                      	pop	DX
 54479 00001069 5E                      	pop	SI
 54480 0000106A 5F                      	pop	DI
 54481 0000106B 5D                      	pop	BP
 54482 0000106C 1F                      	pop	DS
 54483 0000106D 07                      	pop	ES
 54484                                  lirett:		; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 54485 0000106E CF                      	iret
 54486                                  
 54487                                  ;**************************************************************************
 54488                                  ;***	XMMDisableA20 - switch 20th address line
 54489                                  ;
 54490                                  ;	This routine is used to disable the 20th address line in
 54491                                  ;	the system using XMM calls.
 54492                                  ;
 54493                                  ;	ENTRY	none		;ds = _DATA
 54494                                  ;	EXIT	A20 line disabled
 54495                                  ;	USES	NOTHING
 54496                                  ;
 54497                                  ;**************************************************************************
 54498                                  
 54499                                  XMMDisableA20:
 54500 0000106F 53                      	push	bx
 54501 00001070 50                      	push	ax
 54502                                  	;mov	ah,XMM_LOCAL_DISABLE_A20
 54503 00001071 B406                    	mov	ah,6
 54504 00001073 2EFF1E[7B10]            	call	far [cs:XMMcontrol]
 54505 00001078 58                      	pop	ax
 54506 00001079 5B                      	pop	bx
 54507 0000107A C3                      	retn
 54508                                  
 54509                                  ; The entry point in the BIOS XMS driver is defined here.
 54510                                  
 54511                                  XMMcontrol:
 54512 0000107B 00000000                	dd	0
 54513                                  
 54514                                  ;--------------------------------------------------------------------------
 54515                                  ; 24/03/2024 - Retro DOS v5.0
 54516                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:107Fh
 54517                                  ;;;
 54518 0000107F 00000000                	dd	0
 54519                                  SC_STATUS:
 54520 00001083 0000                    	dw	0
 54521                                  ;;;
 54522                                  
 54523                                  ;--------------------------------------------------------------------------
 54524                                  ;
 54525                                  ;***	EnsureA20ON - Ensures that A20 is ON
 54526                                  ;
 54527                                  ;	This routine is used to query the A20 state in
 54528                                  ;	the system using XMM calls.
 54529                                  ;
 54530                                  ;	ENTRY: none
 54531                                  ;
 54532                                  ;	EXIT : A20 will be ON
 54533                                  ;		
 54534                                  ; 	USES : NONE
 54535                                  ;
 54536                                  ;--------------------------------------------------------------------------
 54537                                  
 54538                                  ; 19/09/2023
 54539                                  ;LowMemory:	; label dword		; Set equal to 0000:0080
 54540                                  ;	dw	00080h
 54541                                  ;	dw	00000h
 54542                                  ;
 54543                                  ;HighMemory:	; label dword
 54544                                  ;	dw	00090h			; Set equal to FFFF:0090
 54545                                  ;	dw	0FFFFh
 54546                                  
 54547                                  	; 25/03/2024 - Retro DOS v5.0
 54548                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:1085h
 54549                                  	; (MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:116Fh)
 54550                                  
 54551                                  EnsureA20ON:
 54552 00001085 9C                      	pushf
 54553 00001086 1E                      	push    ds
 54554 00001087 06                      	push	es
 54555 00001088 51                      	push	cx
 54556 00001089 56                      	push	si
 54557 0000108A 57                      	push	di
 54558                                  
 54559                                  	; 19/09/2023
 54560                                  	;lds	si,[cs:LowMemory]	; Compare the 4 words at 0000:0080
 54561                                  	;les	di,[cs:HighMemory]	; with the 4 at FFFF:0090
 54562                                  
 54563                                  	; 25/03/2024 
 54564                                  	; PCDOS 7.1 IBMDOS.COM
 54565                                  	;;;
 54566 0000108B 31F6                    	xor	si,si
 54567 0000108D 8EDE                    	mov	ds,si
 54568 0000108F 4E                      	dec	si
 54569 00001090 BF9000                  	mov	di,90h	; 0FFFFh:0090h	; HighMemory
 54570 00001093 8EC6                    	mov	es,si
 54571 00001095 BE8000                  	mov	si,80h	; 0000h:0080h	; LowMemory
 54572                                  	;;;	
 54573                                  
 54574 00001098 B90400                  	mov	cx,4
 54575 0000109B FC                      	cld
 54576 0000109C F3A7                    	repe    cmpsw
 54577                                  
 54578 0000109E 7407                    	jz	short EA20_OFF
 54579                                  EA20_RET:
 54580 000010A0 5F                      	pop	di
 54581 000010A1 5E                      	pop	si
 54582 000010A2 59                      	pop	cx
 54583 000010A3 07                      	pop	es
 54584 000010A4 1F                      	pop	ds
 54585 000010A5 9D                      	popf
 54586 000010A6 C3                      	retn
 54587                                  
 54588                                  EA20_OFF:
 54589                                  	; We are going to do the XMS call on the DOS's AuxStack.
 54590                                  	; NOTE: ints are disabled at this point.
 54591                                  
 54592 000010A7 53                      	push	bx
 54593 000010A8 50                      	push	ax
 54594                                  
 54595                                  ; 25/03/2024
 54596                                  %if 0
 54597                                  	mov	ax,ss			; save user's stack pointer
 54598                                  	mov	[cs:SS_Save],ax
 54599                                  	mov	[cs:SP_Save],sp
 54600                                  	mov	ax,cs
 54601                                  	mov	ss,ax
 54602                                  %else
 54603                                  	; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 54604                                  	;;;
 54605 000010A9 8CC8                    	mov	ax,cs
 54606 000010AB 2E8C16[9A0F]            	mov	[cs:SS_Save],ss
 54607 000010B0 2E8926[9C0F]            	mov	[cs:SP_Save],sp
 54608 000010B5 8ED0                    	mov	ss,ax
 54609                                  	;;;
 54610                                  %endif
 54611 000010B7 BC[A007]                	mov	sp,AUXSTACK
 54612                                  					; ss:sp -> DOSDATA:AuxStack
 54613                                  	;mov	ah,XMM_LOCAL_ENABLE_A20
 54614 000010BA B405                    	mov	ah,5
 54615 000010BC 2EFF1E[7B10]            	call	far [cs:XMMcontrol]
 54616 000010C1 09C0                    	or	ax,ax
 54617 000010C3 740E                    	jz	short XMMerror		; AX = 0 fatal error
 54618                                  
 54619                                  	;mov	ax,[cs:SS_Save]		; restore user stack
 54620                                  	;mov	ss,ax
 54621                                  	;  25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 54622                                  	;;;
 54623 000010C5 2E8E16[9A0F]            	mov	ss,[cs:SS_Save]
 54624                                  	;;;
 54625 000010CA 2E8B26[9C0F]            	mov	sp,[cs:SP_Save]
 54626                                  
 54627 000010CF 58                      	pop	ax
 54628 000010D0 5B                      	pop	bx
 54629                                  
 54630 000010D1 EBCD                    	jmp	short EA20_RET
 54631                                  
 54632                                  XMMerror:				; M006 - Start
 54633 000010D3 B40F                    	mov	ah,0Fh			; get video mode
 54634 000010D5 CD10                    	int	10h
 54635 000010D7 3C07                    	cmp	al,7			; Q: are we an MDA
 54636 000010D9 7405                    	je	short XMMcont		; Y: do not change mode
 54637                                  	;xor	ah,ah ; 0		; set video mode
 54638                                  	;mov	al,02h			; 80 X 25 text
 54639                                  	; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 54640                                  	;;;
 54641 000010DB B80200                  	mov     ax,2
 54642                                  	;;;
 54643 000010DE CD10                    	int	10h
 54644                                  XMMcont:
 54645                                  	;mov	ah,05h			; set display page
 54646                                  	;xor	al,al			; page 0
 54647                                  	; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 54648                                  	;;;
 54649 000010E0 B80005                  	mov     ax,500h
 54650                                  	;;;
 54651 000010E3 CD10                    	int	10h
 54652                                  	
 54653 000010E5 BE[1312]                	mov	si,XMMERRMSG
 54654 000010E8 0E                      	push	cs
 54655 000010E9 1F                      	pop	ds
 54656 000010EA FC                      	cld				; clear direction flag
 54657                                  XMMprnt:
 54658 000010EB AC                      	lodsb
 54659 000010EC 3C24                    	cmp	al,'$'			; indicates end of XMMERRMSG
 54660 000010EE 7409                    	jz	short XMMStall		; function 0Eh
 54661 000010F0 B40E                    	mov	ah,0Eh
 54662 000010F2 BB0700                  	mov	bx,7
 54663 000010F5 CD10                    	int	10h
 54664 000010F7 EBF2                    	jmp	short XMMprnt
 54665                                  
 54666                                  XMMStall:
 54667 000010F9 FB                      	sti				; allow the user to warm boot
 54668 000010FA EBFD                    	jmp	short XMMStall		; M006 - End
 54669                                  
 54670                                  ;---------------------------------------------------------------------------
 54671                                  
 54672                                  ; 27/04/2019 - Retro DOS v4.0
 54673                                  
 54674                                  ; retrodos4.s ; offset 0Ch in BIOS segment (0070h)
 54675                                  ALTAH	equ 0Ch
 54676                                  
 54677                                  ;This has been put in for WIN386 2.XX support. The format of the instance
 54678                                  ;table was different for this. Segments will be patched in at init time.
 54679                                  
 54680                                  	; 25/03/2024
 54681                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:10FCh
 54682                                  	; (MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:11E7h)
 54683                                  
 54684                                  OldInstanceJunk:
 54685 000010FC 7000                    	dw	70h	;segment of BIOS
 54686 000010FE 0000                    	dw	0	;indicate stacks in SYSINIT area
 54687 00001100 0600                    	dw	6	;6 instance items
 54688                                  
 54689                                  	;dw	0,offset dosdata:contpos, 2
 54690                                  	;dw	0,offset dosdata:bcon, 4
 54691                                  	;dw	0,offset dosdata:carpos,106h
 54692                                  	;dw	0,offset dosdata:charco, 1
 54693                                  	;dw	0,offset dosdata:exec_init_sp, 34               ;M032
 54694                                  	;dw	070h,offset BData:altah, 1	 ; altah byte in bios
 54695                                  
 54696 00001102 0000[2200]0200          	dw	0,CONTPOS,2
 54697 00001108 0000[3200]0400          	dw	0,BCON,4
 54698 0000110E 0000[F901]0601          	dw	0,CARPOS,106h
 54699 00001114 0000[0003]0100          	dw	0,CHARCO,1
 54700 0000111A 0000[BF0E]2200          	dw	0,exec_init_SP,34
 54701 00001120 70000C000100            	dw	70h,ALTAH,1	; altah byte in bios
 54702                                  
 54703                                  ;---------------------------------------------------------------------------
 54704                                  
 54705                                  ; 24/03/2024
 54706                                  ; 17/01/2024
 54707                                  %if 0
 54708                                  
 54709                                  ; M021-
 54710                                  ;
 54711                                  ; DosHasHMA - This flag is set by seg_reinit when the DOS actually
 54712                                  ; 	takes control of the HMA. When running, this word is a reliable
 54713                                  ;	indicator that the DOS is actually using HMA. You can't just use
 54714                                  ;	CS, because ROMDOS uses HMA with CS < F000.
 54715                                  
 54716                                  DosHasHMA:
 54717                                  	db	0
 54718                                  FixExePatch:
 54719                                  	dw	0		; M012
 54720                                  
 54721                                  ; 21/03/2024 - Retro DOS v5.0
 54722                                  ;;28/12/2022 - Retro DOS v4.1
 54723                                  RationalPatchPtr:
 54724                                  	dw	0		; M012
 54725                                  
 54726                                  %endif
 54727                                  
 54728                                  ; End M021
 54729                                  
 54730                                  ;---------------------------------------------------------------------------
 54731                                  
 54732                                  ; 21/03/2024 - Retro DOS v5.0
 54733                                  %if 1
 54734                                  ; 28/12/2022 - Retro DOS v4.1
 54735                                  ;%if 0
 54736                                  
 54737                                  ; M020 Begin
 54738                                  
 54739                                  RatBugCode:	; proc	far
 54740 00001126 51                      	push	cx
 54741 00001127 8B0E1000                	mov	cx,[10h]
 54742                                  rbc_loop:
 54743                                  	;loop	$
 54744 0000112B E2FE                    	loop	rbc_loop
 54745 0000112D 59                      	pop	cx
 54746 0000112E CB                      	retf
 54747                                  
 54748                                  ; M020 End
 54749                                  
 54750                                  %endif
 54751                                  
 54752                                  ;---------------------------------------------------------------------------
 54753                                  
 54754                                  UmbSave1:
 54755                                  	;db	11 dup (?)	; M023
 54756 0000112F 00<rep Bh>              	times	11 db 0
 54757                                  
 54758                                  ;---------------------------------------------------------------------------
 54759                                  ; 16/01/2024 - Retrodos v5.0
 54760                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA: 113Ah
 54761                                  
 54762                                  OLD_FIRSTCLUS_HW:
 54763 0000113A 0000                    	dw	0
 54764                                  
 54765                                  ; 17/01/2024 
 54766                                  %if 1
 54767                                  
 54768                                  ; DOS 3.3 F.C. 6/12/86
 54769                                  ; FASTOPEN communications area DOS 3.3   F.C. 5/29/86
 54770                                  
 54771                                  FastTable:				; a better name
 54772                                  FastOpenTable:
 54773 0000113C 0200                    	dw      2                       ; number of entries
 54774 0000113E [7A18]                  	dw      FastRet			; pointer to ret instr.
 54775 00001140 0000                    	dw      0                       ; and will be modified by
 54776 00001142 [7A18]                  	dw      FastRet			; FASTxxx when loaded in
 54777 00001144 0000                    	dw      0
 54778                                  
 54779                                  ; DOS 3.3 F.C. 6/12/86
 54780                                  
 54781                                  FastFlg:				; flags
 54782                                  FastOpenFlg:
 54783 00001146 00                      	db	0			; don't change the foll: order
 54784                                  
 54785                                  %endif
 54786                                  
 54787                                  ; 24/03/2024 - Retrto DOS v5.0
 54788                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1147h
 54789                                  %if 1
 54790                                  
 54791                                  FastOpen_Ext_Info:
 54792                                  	;db	6 dup(0)
 54793 00001147 00<rep 6h>              	times	6 db 0
 54794                                  UNKNOWN1:
 54795 0000114D 0000                    	dw	0
 54796                                  	;db	5 dup(0)
 54797 0000114F 00<rep 5h>              	times	5 db 0
 54798                                  PATHNAMELEN:
 54799 00001154 4300                    	dw	67
 54800                                   
 54801                                  	;db	31 dup(0)
 54802 00001156 00<rep 1Fh>             	times	31 db 0
 54803                                  %endif
 54804                                  
 54805                                  ; 17/01/2024
 54806                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1175h
 54807                                  CurSC_DRIVE:
 54808 00001175 FF                      	db	-1  ; 0FFh	; current SC drive
 54809                                  
 54810                                  ;M044
 54811                                  ; Second part of save area for saving last para of Windows memory
 54812                                  
 54813                                  ; 17/01/2024
 54814                                  WinoldPatch2:
 54815                                  	;db	8 dup (?)	; M044
 54816 00001176 00<rep 8h>              	times	8 db 0	
 54817                                  
 54818                                  FIRST_BUFF_ADDR:
 54819 0000117E 0000                    	dw	0
 54820                                  
 54821                                  ;----------------------------------------------------------------------------
 54822                                  ; 17/01/2024 - Retrodos v5.0
 54823                                  ; PCDOS 7.1 IBMDOS.COM
 54824                                  ; DOSDATA:1180h
 54825                                  
 54826                                  %if 1
 54827                                  
 54828                                  ;============================================================================
 54829                                  ; WPATCH.INC (MSDOS 6.0, 1991)  ;;; Windows 3.1 patches ;;;
 54830                                  ;============================================================================
 54831                                  ; 27/04/2019 - Retro DOS 4.0
 54832                                  
 54833                                  ; DOSDATA:12CFh (MSDOS 6.21, MSDOS.SYS)
 54834                                  
 54835                                  ; Retro DOS v5.0
 54836                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1180h
 54837                                  
 54838                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 54839                                  ; DOSDATA:12CFh (MSDOS 5.0, MSDOS.SYS)
 54840                                  
 54841                                  ; first and second DOS patches
 54842                                  ;	Non-console device read/write (system calls 3Fh and 40h)
 54843                                  ;
 54844                                  ; Code in disk.asm, 2 locations, one for read, one for write
 54845                                  ;	DVRDLP:
 54846                                  ;	DVWRTLP:
 54847                                  ;
 54848                                  ;
 54849                                  ; 036h	lds	si,SS:[????]				  ; ThisSFT
 54850                                  ;	lds	si,si+7 				  ; sf_devptr
 54851                                  ; 0E8h	call	????		<- "simulate" int28 event ; DSKSTATCHK
 54852                                  
 54853 00001180 36C536                  DOSP1_ID:	db	036h,0C5h,036h
 54854 00001183 3605C57407E8            DOSP1_THISSFT:	db	036h,005h,0C5h,074h,007h,0E8h
 54855                                  DOSP1_ID_LEN	equ	$-DOSP1_ID
 54856                                  
 54857 00001189 9090                    		db	90h, 90h
 54858                                  
 54859 0000118B 36C536                  DOSP12_ID:	db	036h,0C5h,036h
 54860 0000118E 3605C57407E8            DOSP12_THISSFT:	db	036h,005h,0C5h,074h,007h,0E8h
 54861                                  DOSP12_ID_LEN	equ	$-DOSP1_ID
 54862                                  
 54863                                  ; DOSDATA:12E3h
 54864                                  
 54865                                  ; Third/Fourth DOS patch - System call 3Fh (Read) from console
 54866                                  ;
 54867                                  ; Code in disk.asm, 1 location
 54868                                  ;	GETBUF:
 54869                                  ;
 54870                                  ; 051h	push	cx	<- begin special int28 mode
 54871                                  ;	push	es
 54872                                  ;	push	di
 54873                                  ;	mov	dx,???? ; offset dosgroup:CONBUF
 54874                                  ;	call	????	; $STD_CON_STRING_INPUT
 54875                                  ;	pop	di
 54876                                  ;	pop	es
 54877                                  ; 059h	pop	cx	<- end special int28 mode
 54878                                  
 54879 00001194 510657BA                DOSP3_ID:	db	051h,006h,057h,0BAh
 54880 00001198 2902E8                  DOSP3_CONBUF:	db	029h,002h,0E8h
 54881                                  DOSP3_ID_LEN	equ	$-DOSP3_ID
 54882 0000119B 9AE35F07                		db	09Ah,0E3h,05Fh,007h	; ???? , pop di, pop es
 54883 0000119F 59                      DOSP4_ID:	db	059h			; pop cx
 54884                                  DOSP4_ID_OFF	equ	(DOSP4_ID - DOSP3_ID)
 54885                                  	
 54886                                  ; DOSDATA:12EFh
 54887                                  
 54888                                  ; Fifth DOS patch - System call 40h (Write) to console
 54889                                  ;
 54890                                  ; Code in disk.asm, 1 location
 54891                                  ;
 54892                                  ;		push	cx
 54893                                  ;      WRCONLP: lodsb
 54894                                  ;		cmp	al,1Ah
 54895                                  ;		jz	????
 54896                                  ;		call	????	<- "simulate" int28 event
 54897                                  ;		loop	WRCONLP
 54898                                  ;      CONEOF:	pop	ax
 54899                                  
 54900 000011A0 51                      DOSP5_ID:	db	051h			; push cx
 54901 000011A1 AC3C1A7405              		db	0ACh,03Ch,01Ah,074h,005h
 54902 000011A6 E8                      		db	0E8h			; call
 54903                                  DOSP5_ID_LEN	equ	$-DOSP5_ID
 54904                                  
 54905                                  ; DOSDATA:12F6h
 54906                                  
 54907                                  ; Seventh DOS patch - System call entry, patch USER_ID with VMid for share
 54908                                  ;
 54909                                  ; Code in disp.asm, 1 location
 54910                                  ;
 54911                                  ;
 54912                                  ;	mov [SaveDS],ds
 54913                                  ;	mov [SaveBX],bx
 54914                                  ;	mov bx,cs
 54915                                  ;	mov ds,bx
 54916                                  ;	inc [indos]
 54917                                  ;	xor ax,ax
 54918                                  ;	mov [USER_ID],AX	<- Patch to set USER_ID to VMID
 54919                                  
 54920 000011A7 2E8C1E                  DOSP7_ID:	db	02Eh,08Ch,01Eh
 54921 000011AA 7E05                    DOSP7_SAVEDS:	db	07Eh,05h		; mov [SaveDS],ds
 54922 000011AC 2E891E                  		db	02Eh,089h,01Eh
 54923 000011AF 7C05                    DOSP7_SAVEBX:	db	07Ch,05h		; mov [SaveBX],bx
 54924 000011B1 8CCB                    		db	08Ch,0CBh		; mov bx,cs
 54925 000011B3 8EDB                    		db	08Eh,0DBh		; mov ds,bx
 54926 000011B5 FE06                    		db	0FEh,006h
 54927 000011B7 CF02                    DOSP7_INDOS:	db	0CFh,002h		; inc [indos]
 54928 000011B9 33C0                    		db	033h,0C0h		; xor ax,ax
 54929                                  DOSP7_ID_LEN	equ	$-DOSP7_ID
 54930                                  
 54931                                  ; DOSDATA:130Ah
 54932                                  
 54933                                  ; Eighth DOS patch - OWNER check in handle calls. For share, need to NOP test
 54934                                  ;
 54935                                  ; Code in handle.asm, 1 location in routine CheckOwner
 54936                                  ;
 54937                                  ;
 54938                                  ;
 54939                                  ;	push	ax
 54940                                  ;	mov	ax,ss:[USER_ID]     <- patch to XOR AX,AX to set zero
 54941                                  ;	cmp	ax,es:[di.sf_UID]   <- NOP
 54942                                  ;	pop	ax
 54943                                  ;	jz	????
 54944                                  
 54945 000011BB 50                      DOSP8_ID:	db	050h			; push ax
 54946 000011BC 36A1                    		db	036h,0A1h
 54947 000011BE EA02                    DOSP8_USER_ID:	db	0EAh,002h		; mov  ax,ss:[USER_ID]
 54948 000011C0 263B45                  		db	026h,03Bh,045h		; cmp  ax,es:[di+2F]
 54949                                  DOSP8_ID_LEN	equ	$-DOSP8_ID
 54950 000011C3 2F58                    		db	02Fh,058h		; pop  ax
 54951                                  
 54952                                  ; DOSDATA:1314h
 54953                                  
 54954                                  ; 10th, 11th, 12th DOS patch - System call 3Fh (Read) in raw mode
 54955                                  ;
 54956                                  ;   Take RAW read to STDIN SFT and turn it into a polling loop doing
 54957                                  ;   a yeild when a character is not ready to be read.
 54958                                  ;
 54959                                  ; Code in disk.asm, 3 locations
 54960                                  ;
 54961                                  ;   DVRDRAW:
 54962                                  ;	    PUSH    ES
 54963                                  ;	    POP     DS
 54964                                  ;   ReadRawRetry:				<- Patch 10
 54965                                  ;	    MOV     BX,DI
 54966                                  ;	    XOR     AX,AX			<- Reenter #2
 54967                                  ;	    MOV     DX,AX
 54968                                  ;	    call    SETREAD
 54969                                  ;	    PUSH    DS				<- Reenter #1
 54970                                  ;	    LDS     SI,[THISSFT]
 54971                                  ;	    call    DEVIOCALL
 54972                                  ;	    MOV     DX,DI
 54973                                  ;	    MOV     AH,86H
 54974                                  ;	    MOV     DI,[DEVCALL.REQSTAT]
 54975                                  ;	    TEST    DI,STERR
 54976                                  ;	    JZ	    CRDROK
 54977                                  ;	    call    CHARHARD
 54978                                  ;	    MOV     DI,DX
 54979                                  ;	    OR	    AL,AL
 54980                                  ;	    JZ	    CRDROK
 54981                                  ;	    CMP     AL,3
 54982                                  ;	    JZ	    CRDFERR
 54983                                  ;	    POP     DS
 54984                                  ;	    JMP     ReadRawRetry
 54985                                  ;
 54986                                  ;   CRDFERR:
 54987                                  ;	    POP     DI				<- Patch 11
 54988                                  ;   DEVIOFERR:
 54989                                  ;	    LES     DI,[THISSFT]
 54990                                  ;	    jmp     SET_ACC_ERR_DS
 54991                                  ;
 54992                                  ;   CRDROK:
 54993                                  ;	    POP     DI				<- Patch 12
 54994                                  ;	    MOV     DI,DX
 54995                                  ;	    ADD     DI,[CALLSCNT]
 54996                                  ;	    JMP     SHORT ENDRDDEVJ3
 54997                                  
 54998 000011C5 061F                    DOSP10_ID:		db	006H,01FH
 54999                                  DOSP10_LOC_OFFSET	equ	$-DOSP10_ID
 55000 000011C7 8BDF                    DOSP10_LOC:		db	08BH,0DFH
 55001                                  DOSP10_REENT2_OFFSET	equ	$-DOSP10_LOC
 55002 000011C9 33C08BD0E8              			db	033H,0C0H,08BH,0D0H,0E8H
 55003                                  DOSP10_ID_LEN		equ	$-DOSP10_ID
 55004 000011CE DF0E                    			db	0DFH,00EH
 55005                                  DOSP10_REENT1_OFFSET	equ	$-DOSP10_LOC
 55006 000011D0 1E36C5363605E8AF0E      			db	01EH,036H,0C5H,036H,036H,005H,0E8H,0AFH,00EH
 55007 000011D9 8BD7B486368B3E          			db	08BH,0D7H,0B4H,086H,036H,08BH,03EH
 55008                                  DOSP10_PACKVAL_OFFSET	equ	$-DOSP10_ID
 55009 000011E0 0903                    			db	009H,003H
 55010 000011E2 F7C700807419E84717      			db	0F7H,0C7H,000H,080H,074H,019H,0E8H,047H,017H
 55011 000011EB 8BFA0AC074103C0374-     			db	08BH,0FAH,00AH,0C0H,074H,010H,03CH,003H,074H,003H
 55011 000011F4 03                 
 55012 000011F5 1FEBCF                  			db	01FH,0EBH,0CFH
 55013                                  DOSP11_LOC_OFFSET	equ	$-DOSP10_ID
 55014 000011F8 5F                      			db	05FH
 55015                                  DOSP11_REENT_OFFSET	equ	$-DOSP10_LOC
 55016 000011F9 36C43E3605E9A104        			db	036H,0C4H,03EH,036H,005H,0E9H,0A1H,004H
 55017                                  
 55018                                  DOSP12_LOC_OFFSET	equ	$-DOSP10_ID
 55019 00001201 5F8BFA                  			db	05FH,08BH,0FAH
 55020                                  ; DOSDATA:1353h
 55021                                  
 55022                                  ; 13th DOS patch - Actually a SYSINIT patch. Patches the stack fault code
 55023                                  ;		which prints the fatal stack fault error on DOS >= 3.20.
 55024                                  ;
 55025                                  ;	    Sets focus to current VM so user can see fatal message.
 55026                                  ;
 55027                                  ;
 55028                                  ;	l0: lodsb		<- Setfocus here
 55029                                  ;	    cmp al, '$'
 55030                                  ;	    je l1
 55031                                  ;	    mov bl, 7
 55032                                  ;	    mov ah, 0Eh
 55033                                  ;	    int 10h
 55034                                  ;	    jmp l0
 55035                                  ;	l1: jmp $
 55036                                  
 55037 00001204 AC                      DOSP13_ID:	db	0ACh			; l0: lodsb
 55038 00001205 3C24                    		db	03Ch,024h		;     cmp al, '$'
 55039 00001207 7408                    		db	074h,008h		;     je l1
 55040 00001209 B307                    		db	0B3h,007h		;     mov bl, 7
 55041 0000120B B40E                    		db	0B4h,00Eh		;     mov ah, 0Eh
 55042 0000120D CD10                    		db	0CDh,010h		;     int 10h
 55043 0000120F EBF3                    		db	0EBh,0F3h		;     jmp l0
 55044 00001211 EBFE                    		db	0EBh,0FEh		; l1: jmp $
 55045                                  DOSP13_ID_LEN	equ	$-DOSP13_ID
 55046                                  
 55047                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 55048                                  ; DOSDATA:1362h (MSDOS 5.0 MSDOS.SYS)
 55049                                  
 55050                                  ; 05/01/2024
 55051                                  %endif	; 05/11/2022
 55052                                  
 55053                                  ;----------------------------------------------------------------------------
 55054                                  
 55055                                  ; DOSDATA:122Ah
 55056                                  
 55057                                  Mark3:	; label byte
 55058                                  
 55059                                  ;IF2
 55060                                  ;	IF ((OFFSET MARK3) GT (OFFSET COUNTRY_CDPG) )
 55061                                  ;		%OUT !DATA CORRUPTION!MARK3 OFFSET TOO BIG. RE-ORGANIZE DATA.
 55062                                  ;	ENDIF
 55063                                  ;ENDIF
 55064                                  
 55065                                  ;----------------------------------------------------------------------------
 55066                                  
 55067                                  ; 27/04/2019 - Retro DOS v4.0
 55068                                  ; 05/01/2024 - Retro DOS v5.0
 55069                                  
 55070                                  ;include msdos.cl2			; XMMERRMSG
 55071                                  
 55072                                  ; DOSDATA:12B8h (MSDOS 6.22, MSDOS.SYS) ; 17/01/2024
 55073                                  ; DOSDATA:1213h (PCDOS 7.1, IBMDOS.COM) ; 05/01/2024
 55074                                  
 55075                                  XMMERRMSG:
 55076 00001213 0D0A                    	db	0Dh,0Ah
 55077 00001215 413230204861726477-     	db	'A20 Hardware Error',0Dh,0Ah,'$'
 55077 0000121E 617265204572726F72-
 55077 00001227 0D0A24             
 55078                                  
 55079                                  ;----------------------------------------------------------------------------
 55080                                  ; 17/01/2024 - Note: COUNTRY_CDPG must be at DOSDATA:122Ah (to 12B8h) addr
 55081                                  ; It is fixed at 122Ah in PCDOS 7.1 IBMDOS.COM and MSDOS 5.0-6.22 MSDOS.SYS
 55082                                  ;----------------------------------------------------------------------------
 55083                                  
 55084                                  ;############################################################################
 55085                                  ;
 55086                                  ; ** HACK FOR DOS 4.0 REDIR **
 55087                                  ;
 55088                                  ; The dos 4.X redir requires that country_cdpg is at offset 0122ah. Any new
 55089                                  ; data variable that is to be added to DOSDATA must go in between Mark3
 55090                                  ; COUNTRY_CDPG if it can. 
 55091                                  ;
 55092                                  ; MARK3 SHOULD NOT BE > 122AH 
 55093                                  ;
 55094                                  ; As of 9/6/90, this area is FULL!
 55095                                  ;
 55096                                  ;############################################################################
 55097                                   
 55098                                  	;ORG	0122Ah
 55099                                  
 55100                                  ; DOSDATA:122Ah (MSDOS 6.21, MSDOS.SYS)
 55101                                  
 55102                                  ; 09/01/2024 - Retro DOS v5.0
 55103                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:122Ah
 55104                                  
 55105                                  ; 17/01/2024
 55106                                  ; MSDOS 5.0  MSDOS.SYS - DOSDATA:122Ah
 55107                                  ; MSDOS 6.22 MSDOS.SYS - DOSDATA:122Ah
 55108                                  ; 09/03/2024
 55109                                  ; Windows ME    IO.SYS - DOSDATA:122Ah
 55110                                  
 55111                                  ; The following table is used for DOS 3.3
 55112                                  ;DOS country and code page information is defined here for DOS 3.3.
 55113                                  ;The initial value for ccDosCountry is 1 (USA).
 55114                                  ;The initial value for ccDosCodepage is 850.
 55115                                  
 55116                                  ; country and code page information
 55117                                  ; ---------------------------------------------------------------------------
 55118                                  COUNTRY_CDPG:	; label  byte
 55119 0000122A 0000000000000000        	db   0,0,0,0,0,0,0,0		; reserved words
 55120 00001232 5C434F554E5452592E-     	db   '\COUNTRY.SYS',0		; path name of country.sys
 55120 0000123B 53595300           
 55121                                  	;db   51 dup (?)
 55122 0000123F 00<rep 33h>             	times 51 db 0
 55123                                  ; ------------------------------------------------<MSKK01>-------------------
 55124                                  ;ifdef	DBCS
 55125                                  ;  ifdef JAPAN
 55126                                  ;	dw   932			; system code page id (JAPAN)
 55127                                  ;  endif
 55128                                  ;  ifdef TAIWAN
 55129                                  ;	dw   938			; system code page id (TAIWAN)
 55130                                  ;  endif
 55131                                  ;  ifdef KOREA
 55132                                  ;	dw   934			; system code page id (KOREA IBM)
 55133                                  ;  endif
 55134                                  ;else
 55135 00001272 B501                    	dw   437			; system code page id
 55136                                  ;endif
 55137                                  ; ------------------------------------------------<MSKK01>-------------------
 55138 00001274 0600                    	dw   6				; number of entries
 55139                                  COUNTRY_CDPG_76: ; COUNTRY_CDPG + 76 
 55140 00001276 02                      	db   SetUcase  ; 2		; Ucase type
 55141 00001277 [FA0A]                  	dw   UCASE_TAB			;pointer to upper case table
 55142 00001279 0000                    	dw   0				; segment of poiter
 55143 0000127B 04                      	db   SetUcaseFile  ; 4		; Ucase file char type
 55144 0000127C [7C0B]                  	dw   FILE_UCASE_TAB 		;pointer to file upper case table
 55145 0000127E 0000                    	dw   0				; segment of poiter
 55146 00001280 05                      	db   SetFileList ; 5		; valid file chars type
 55147 00001281 [280D]                  	dw   FILE_CHAR_TAB 		;pointer to valid file char tab
 55148 00001283 0000                    	dw   0				; segment of poiter
 55149 00001285 06                      	db   SetCollate	; 6		; collate type
 55150 00001286 [FE0B]                  	dw   COLLATE_TAB		;pointer to collate table
 55151 00001288 0000                    	dw   0				; segment of poiter
 55152 0000128A 07                      	db   SetDBCS	; 7		;AN000; DBCS Ev			2/12/KK
 55153 0000128B [000D]                  	dw   DBCS_TAB			;AN000;pointer to DBCS Ev table	2/12/KK
 55154 0000128D 0000                    	dw   0				;AN000; segment of pointer	2/12/KK
 55155 0000128F 01                      	db   SetCountryInfo  ; 1	; country info type
 55156 00001290 2600                    	dw   NEW_COUNTRY_SIZE		; extended country info size
 55157                                  ; ------------------------------------------------<MSKK01>-------------------
 55158                                  ;ifdef	DBCS
 55159                                  ;	......
 55160                                  ;else
 55161                                  	; 09/01/2024 - Retro DOS v5.0
 55162                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:1292h
 55163                                  _COUNTRY_ID:
 55164 00001292 0100                    	dw   1				; USA country id
 55165 00001294 B501                    	dw   437			; USA system code page id
 55166                                  COUNTRY_CDPG_108: ; COUNTRY_CDPG + 108	
 55167 00001296 0000                    	dw   0 				; date format
 55168 00001298 2400000000              	db   '$',0,0,0,0		; currency symbol
 55169 0000129D 2C00                    	db   ',',0			; thousand separator
 55170 0000129F 2E00                    	db   '.',0			; decimal separator
 55171 000012A1 2D00                    	db   '-',0			; date separator
 55172 000012A3 3A00                    	db   ':',0			; time separator
 55173 000012A5 00                      	db   0				; currency format flag
 55174 000012A6 02                      	db   2				; # of digits in currency
 55175 000012A7 00                      	db   0 				; time format
 55176 000012A8 [6B0D]                  	dw   MAP_CASE			; mono case routine entry point
 55177 000012AA 0000                    	dw   0				; segment of entry point
 55178 000012AC 2C00                    	db   ',',0			; data list separator
 55179 000012AE 000000000000000000-     	dw   0,0,0,0,0			; reserved
 55179 000012B7 00                 
 55180                                  ;endif
 55181                                  ; ------------------------------------------------<MSKK01>-------------------
 55182                                  
 55183                                  ;----------------------------------------------------------------------------
 55184                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 55185                                  
 55186                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:12B8h
 55187                                  
 55188                                  INDOS_FLAG:
 55189 000012B8 00                      	db 0		; duplicated INDOS flag, what for ? 
 55190                                  			; (PCDOS 7.1 kernel CODE always updates it together
 55191                                  			; with 'INDOS' flag !?)
 55192                                  ; 09/01/2024
 55193                                  DEVIO_IN_PROGRESS:
 55194 000012B9 00                      	db 0
 55195                                  
 55196                                  ; 09/01/2024
 55197                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:12BAh
 55198                                  ; ----------
 55199                                  ; INTERNATIONALIZATION INFORMATION
 55200                                  ;	 for Get/Set Extended Country Info functions
 55201                                  
 55202 000012BA 454E5500                _ENU:	db 'ENU',0
 55203 000012BE 55534100                _USA:	db 'USA',0
 55204 000012C2 5553                    _US:	db 'US'
 55205 000012C4 0100                    	dw 1
 55206 000012C6 0200                    	dw 2
 55207 000012C8 0000                    	dw 0
 55208 000012CA 414D00                  _AM:	db 'AM',0
 55209 000012CD 504D00                  _PM:	db 'PM',0
 55210                                  _MMDDYY:
 55211 000012D0 4D2F642F7979202020-     	db 'M/d/yy     dddd,MMMMdd,yyyy         '
 55211 000012D9 2020646464642C4D4D-
 55211 000012E2 4D4D64642C79797979-
 55211 000012EB 202020202020202020 
 55212 000012F4 00                      	db 0
 55213 000012F5 00                      	db 0
 55214 000012F6 0000                    	dw 0
 55215                                  
 55216                                  ; 09/01/2024
 55217                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:12F8h
 55218                                  
 55219                                  VxDpath:
 55220 000012F8 633A5C77696E613230-     	db 'c:\wina20.386',0
 55220 00001301 2E33383600         
 55221 00001306 0000                    	dw 0
 55222                                  
 55223                                  ; 09/01/2024
 55224                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1308h
 55225                                  
 55226                                  drive_flags:
 55227 00001308 00<rep 1Ah>             	times 26 db 0
 55228                                  
 55229                                  DriverLoad:
 55230 00001322 01                              db 1
 55231                                  BiosDataPtr:	; 08/03/2024
 55232 00001323 0000<rep 2h>            	times 2 dw 0
 55233 00001327 00<rep 5h>              	times 5 db 0
 55234 0000132C 0400                    	dw 4
 55235 0000132E [B812]                  	dw INDOS_FLAG
 55236 00001330 [0813]                  	dw drive_flags
 55237 00001332 [3613]                  	dw NLS_YES	; "YN"
 55238 00001334 [3A13]                  	dw unknown_zero_dd
 55239                                  NLS_YES:
 55240 00001336 59                      	db 'Y'
 55241 00001337 4E                      NLS_NO:	db 'N'
 55242                                  NLS_yes2:
 55243 00001338 79                      	db 'y'
 55244                                  NLS_no2:
 55245 00001339 6E                      	db 'n'
 55246                                  
 55247                                  unknown_zero_dd:
 55248 0000133A 00000000                	dd 0
 55249                                  
 55250                                  ; ---------------------------------------------------------------------------
 55251                                  
 55252                                  ; 27/04/2019 - Retro DOS v4.0
 55253                                  
 55254                                  ;include msdos.cl2			; XMMERRMSG
 55255                                  
 55256                                  ; DOSDATA:12B8h (MSDOS 6.21, MSDOS.SYS)
 55257                                  
 55258                                  ;XMMERRMSG:
 55259                                  ;	db	0Dh,0Ah
 55260                                  ;	db	'A20 Hardware Error',0Dh,0Ah,'$'
 55261                                  
 55262                                  ; DOSDATA ends
 55263                                  
 55264                                  ; 05/11/2022
 55265                                  ;----------------------------------------------------------------------------
 55266                                  ; End of MSDOS 5.0 MSDOS.SYS /// Retro DOS v4.0 (2022) - 05/11/2022
 55267                                  ;----------------------------------------------------------------------------
 55268                                  
 55269                                  ; 28/12/2022 - Retro DOS v4.1
 55270                                  ; (windows 3.1 and Rational Extender patches are removed/disabled)
 55271                                  ; (Windows 3.1 does not use the patches below if DOS version is MSDOS 5.0)
 55272                                  ;----------------------------------------------------------------------------
 55273                                  %if 0
 55274                                  
 55275                                  ;----------------------------------------------------------------------------
 55276                                  ; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 55277                                  
 55278                                  ;============================================================================
 55279                                  ; WPATCH.INC (MSDOS 6.0, 1991)  ;;; Windows 3.1 patches ;;;
 55280                                  ;============================================================================
 55281                                  ; 27/04/2019 - Retro DOS 4.0
 55282                                  
 55283                                  ;DOSDATA Segment
 55284                                  
 55285                                  ; DOSDATA:12CFh (MSDOS 6.21, MSDOS.SYS)
 55286                                  
 55287                                  ; Retro DOS v5.0
 55288                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1180h
 55289                                  
 55290                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 55291                                  ; DOSDATA:12CFh (MSDOS 5.0, MSDOS.SYS)
 55292                                  
 55293                                  ; first and second DOS patches
 55294                                  ;	Non-console device read/write (system calls 3Fh and 40h)
 55295                                  ;
 55296                                  ; Code in disk.asm, 2 locations, one for read, one for write
 55297                                  ;	DVRDLP:
 55298                                  ;	DVWRTLP:
 55299                                  ;
 55300                                  ;
 55301                                  ; 036h	lds	si,SS:[????]				  ; ThisSFT
 55302                                  ;	lds	si,si+7 				  ; sf_devptr
 55303                                  ; 0E8h	call	????		<- "simulate" int28 event ; DSKSTATCHK
 55304                                  
 55305                                  DOSP1_ID:	db	036h,0C5h,036h
 55306                                  DOSP1_THISSFT:	db	036h,005h,0C5h,074h,007h,0E8h
 55307                                  DOSP1_ID_LEN	equ	$-DOSP1_ID
 55308                                  
 55309                                  		db	90h, 90h
 55310                                  
 55311                                  DOSP12_ID:	db	036h,0C5h,036h
 55312                                  DOSP12_THISSFT:	db	036h,005h,0C5h,074h,007h,0E8h
 55313                                  DOSP12_ID_LEN	equ	$-DOSP1_ID
 55314                                  
 55315                                  ; DOSDATA:12E3h
 55316                                  
 55317                                  ; Third/Fourth DOS patch - System call 3Fh (Read) from console
 55318                                  ;
 55319                                  ; Code in disk.asm, 1 location
 55320                                  ;	GETBUF:
 55321                                  ;
 55322                                  ; 051h	push	cx	<- begin special int28 mode
 55323                                  ;	push	es
 55324                                  ;	push	di
 55325                                  ;	mov	dx,???? ; offset dosgroup:CONBUF
 55326                                  ;	call	????	; $STD_CON_STRING_INPUT
 55327                                  ;	pop	di
 55328                                  ;	pop	es
 55329                                  ; 059h	pop	cx	<- end special int28 mode
 55330                                  
 55331                                  DOSP3_ID:	db	051h,006h,057h,0BAh
 55332                                  DOSP3_CONBUF:	db	029h,002h,0E8h
 55333                                  DOSP3_ID_LEN	equ	$-DOSP3_ID
 55334                                  		db	09Ah,0E3h,05Fh,007h	; ???? , pop di, pop es
 55335                                  DOSP4_ID:	db	059h			; pop cx
 55336                                  DOSP4_ID_OFF	equ	(DOSP4_ID - DOSP3_ID)
 55337                                  	
 55338                                  ; DOSDATA:12EFh
 55339                                  
 55340                                  ; Fifth DOS patch - System call 40h (Write) to console
 55341                                  ;
 55342                                  ; Code in disk.asm, 1 location
 55343                                  ;
 55344                                  ;		push	cx
 55345                                  ;      WRCONLP: lodsb
 55346                                  ;		cmp	al,1Ah
 55347                                  ;		jz	????
 55348                                  ;		call	????	<- "simulate" int28 event
 55349                                  ;		loop	WRCONLP
 55350                                  ;      CONEOF:	pop	ax
 55351                                  
 55352                                  DOSP5_ID:	db	051h			; push cx
 55353                                  		db	0ACh,03Ch,01Ah,074h,005h
 55354                                  		db	0E8h			; call
 55355                                  DOSP5_ID_LEN	equ	$-DOSP5_ID
 55356                                  
 55357                                  ; DOSDATA:12F6h
 55358                                  
 55359                                  ; Seventh DOS patch - System call entry, patch USER_ID with VMid for share
 55360                                  ;
 55361                                  ; Code in disp.asm, 1 location
 55362                                  ;
 55363                                  ;
 55364                                  ;	mov [SaveDS],ds
 55365                                  ;	mov [SaveBX],bx
 55366                                  ;	mov bx,cs
 55367                                  ;	mov ds,bx
 55368                                  ;	inc [indos]
 55369                                  ;	xor ax,ax
 55370                                  ;	mov [USER_ID],AX	<- Patch to set USER_ID to VMID
 55371                                  
 55372                                  DOSP7_ID:	db	02Eh,08Ch,01Eh
 55373                                  DOSP7_SAVEDS:	db	07Eh,05h		; mov [SaveDS],ds
 55374                                  		db	02Eh,089h,01Eh
 55375                                  DOSP7_SAVEBX:	db	07Ch,05h		; mov [SaveBX],bx
 55376                                  		db	08Ch,0CBh		; mov bx,cs
 55377                                  		db	08Eh,0DBh		; mov ds,bx
 55378                                  		db	0FEh,006h
 55379                                  DOSP7_INDOS:	db	0CFh,002h		; inc [indos]
 55380                                  		db	033h,0C0h		; xor ax,ax
 55381                                  DOSP7_ID_LEN	equ	$-DOSP7_ID
 55382                                  
 55383                                  ; DOSDATA:130Ah
 55384                                  
 55385                                  ; Eighth DOS patch - OWNER check in handle calls. For share, need to NOP test
 55386                                  ;
 55387                                  ; Code in handle.asm, 1 location in routine CheckOwner
 55388                                  ;
 55389                                  ;
 55390                                  ;
 55391                                  ;	push	ax
 55392                                  ;	mov	ax,ss:[USER_ID]     <- patch to XOR AX,AX to set zero
 55393                                  ;	cmp	ax,es:[di.sf_UID]   <- NOP
 55394                                  ;	pop	ax
 55395                                  ;	jz	????
 55396                                  
 55397                                  DOSP8_ID:	db	050h			; push ax
 55398                                  		db	036h,0A1h
 55399                                  DOSP8_USER_ID:	db	0EAh,002h		; mov  ax,ss:[USER_ID]
 55400                                  		db	026h,03Bh,045h		; cmp  ax,es:[di+2F]
 55401                                  DOSP8_ID_LEN	equ	$-DOSP8_ID
 55402                                  		db	02Fh,058h		; pop  ax
 55403                                  
 55404                                  ; DOSDATA:1314h
 55405                                  
 55406                                  ; 10th, 11th, 12th DOS patch - System call 3Fh (Read) in raw mode
 55407                                  ;
 55408                                  ;   Take RAW read to STDIN SFT and turn it into a polling loop doing
 55409                                  ;   a yeild when a character is not ready to be read.
 55410                                  ;
 55411                                  ; Code in disk.asm, 3 locations
 55412                                  ;
 55413                                  ;   DVRDRAW:
 55414                                  ;	    PUSH    ES
 55415                                  ;	    POP     DS
 55416                                  ;   ReadRawRetry:				<- Patch 10
 55417                                  ;	    MOV     BX,DI
 55418                                  ;	    XOR     AX,AX			<- Reenter #2
 55419                                  ;	    MOV     DX,AX
 55420                                  ;	    call    SETREAD
 55421                                  ;	    PUSH    DS				<- Reenter #1
 55422                                  ;	    LDS     SI,[THISSFT]
 55423                                  ;	    call    DEVIOCALL
 55424                                  ;	    MOV     DX,DI
 55425                                  ;	    MOV     AH,86H
 55426                                  ;	    MOV     DI,[DEVCALL.REQSTAT]
 55427                                  ;	    TEST    DI,STERR
 55428                                  ;	    JZ	    CRDROK
 55429                                  ;	    call    CHARHARD
 55430                                  ;	    MOV     DI,DX
 55431                                  ;	    OR	    AL,AL
 55432                                  ;	    JZ	    CRDROK
 55433                                  ;	    CMP     AL,3
 55434                                  ;	    JZ	    CRDFERR
 55435                                  ;	    POP     DS
 55436                                  ;	    JMP     ReadRawRetry
 55437                                  ;
 55438                                  ;   CRDFERR:
 55439                                  ;	    POP     DI				<- Patch 11
 55440                                  ;   DEVIOFERR:
 55441                                  ;	    LES     DI,[THISSFT]
 55442                                  ;	    jmp     SET_ACC_ERR_DS
 55443                                  ;
 55444                                  ;   CRDROK:
 55445                                  ;	    POP     DI				<- Patch 12
 55446                                  ;	    MOV     DI,DX
 55447                                  ;	    ADD     DI,[CALLSCNT]
 55448                                  ;	    JMP     SHORT ENDRDDEVJ3
 55449                                  
 55450                                  DOSP10_ID:		db	006H,01FH
 55451                                  DOSP10_LOC_OFFSET	equ	$-DOSP10_ID
 55452                                  DOSP10_LOC:		db	08BH,0DFH
 55453                                  DOSP10_REENT2_OFFSET	equ	$-DOSP10_LOC
 55454                                  			db	033H,0C0H,08BH,0D0H,0E8H
 55455                                  DOSP10_ID_LEN		equ	$-DOSP10_ID
 55456                                  			db	0DFH,00EH
 55457                                  DOSP10_REENT1_OFFSET	equ	$-DOSP10_LOC
 55458                                  			db	01EH,036H,0C5H,036H,036H,005H,0E8H,0AFH,00EH
 55459                                  			db	08BH,0D7H,0B4H,086H,036H,08BH,03EH
 55460                                  DOSP10_PACKVAL_OFFSET	equ	$-DOSP10_ID
 55461                                  			db	009H,003H
 55462                                  			db	0F7H,0C7H,000H,080H,074H,019H,0E8H,047H,017H
 55463                                  			db	08BH,0FAH,00AH,0C0H,074H,010H,03CH,003H,074H,003H
 55464                                  			db	01FH,0EBH,0CFH
 55465                                  DOSP11_LOC_OFFSET	equ	$-DOSP10_ID
 55466                                  			db	05FH
 55467                                  DOSP11_REENT_OFFSET	equ	$-DOSP10_LOC
 55468                                  			db	036H,0C4H,03EH,036H,005H,0E9H,0A1H,004H
 55469                                  
 55470                                  DOSP12_LOC_OFFSET	equ	$-DOSP10_ID
 55471                                  			db	05FH,08BH,0FAH
 55472                                  ; DOSDATA:1353h
 55473                                  
 55474                                  ; 13th DOS patch - Actually a SYSINIT patch. Patches the stack fault code
 55475                                  ;		which prints the fatal stack fault error on DOS >= 3.20.
 55476                                  ;
 55477                                  ;	    Sets focus to current VM so user can see fatal message.
 55478                                  ;
 55479                                  ;
 55480                                  ;	l0: lodsb		<- Setfocus here
 55481                                  ;	    cmp al, '$'
 55482                                  ;	    je l1
 55483                                  ;	    mov bl, 7
 55484                                  ;	    mov ah, 0Eh
 55485                                  ;	    int 10h
 55486                                  ;	    jmp l0
 55487                                  ;	l1: jmp $
 55488                                  
 55489                                  DOSP13_ID:	db	0ACh			; l0: lodsb
 55490                                  		db	03Ch,024h		;     cmp al, '$'
 55491                                  		db	074h,008h		;     je l1
 55492                                  		db	0B3h,007h		;     mov bl, 7
 55493                                  		db	0B4h,00Eh		;     mov ah, 0Eh
 55494                                  		db	0CDh,010h		;     int 10h
 55495                                  		db	0EBh,0F3h		;     jmp l0
 55496                                  		db	0EBh,0FEh		; l1: jmp $
 55497                                  DOSP13_ID_LEN	equ	$-DOSP13_ID
 55498                                  
 55499                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 55500                                  ; DOSDATA:1362h (MSDOS 5.0 MSDOS.SYS)
 55501                                  
 55502                                  ; 06/12/2022
 55503                                  ;DOSDATASIZE	equ  $ - DOSDATASTART ; 4962 bytes (1362h)
 55504                                  
 55505                                  ; DOSDATA ends
 55506                                  
 55507                                  ; 05/01/2024
 55508                                  %endif	; 05/11/2022
 55509                                  
 55510                                  ;============================================================================
 55511                                  ; MPATCH.ASM (MSDOS 6.0, 1993)
 55512                                  ;============================================================================
 55513                                  ; 27/04/2019 - Retro DOS 4.0
 55514                                  
 55515                                  ;mpatch.asm -- holds data patch location for callouts 
 55516                                  ; -- allocate cluster in rom.asm
 55517                                  ;
 55518                                  ; This area is pointed to by OffsetMagicPatch[609h] in fixed DOS data.
 55519                                  ; Currently, this location is used only by magicdrv.sys's patch to
 55520                                  ; cluster allocation, however it can be expanded to be used by other
 55521                                  ; patches. This is important since we have an easy-access pointer to
 55522                                  ; this location in OffsetMagicPatch. Magicdrv.sys is guaranteed to
 55523                                  ; only patch out a far call/retf, so any space after that could be
 55524                                  ; used as a patch by using OffsetMagicPatch+6. See rom.asm on how
 55525                                  ; to call out here.
 55526                                  ;
 55527                                  ; Currently, we allocate only the minimum space required for the 6
 55528                                  ; byte magicdrv patch, so if you change the dos data, you may want
 55529                                  ; to reserve space here if your new data will be position dependent
 55530                                  ; and would prohibit growing of this table.
 55531                                  ;
 55532                                  ;history	-	created 8-7-92 by scottq
 55533                                  ;		-	added Rational386PatchPtr 2-1-93 by jimmat
 55534                                  ;
 55535                                  ;Exported Functions
 55536                                  ;==================
 55537                                  ;MagicPatch     -       callout patched by magidrv.sys for cluster allocations
 55538                                  
 55539                                  ; DosData Segment
 55540                                  
 55541                                  ; DOSDATA:1362h (MSDOS 6.21, MSDOS.SYS)
 55542                                  
 55543                                  ; ---------------------------------------------------------------------------
 55544                                  
 55545                                  ; Rational386PatchPtr points to either a RET instruction (80286 or less) or
 55546                                  ; a routine to fix buggy versions of the Rational DOS Extender (80386 or
 55547                                  ; greater). Added to this file because it needed to be somewhere and is
 55548                                  ; 'patch' related.
 55549                                  
 55550                                  Rational386PatchPtr:
 55551 0000133E 0000                    	dw	0	; points to patch routine or RET instr.
 55552                                  ; ---------------------------------------------------------------------------
 55553                                  
 55554                                  ; 25/03/2024
 55555                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1340h
 55556                                  ; (Windows ME IO.SYS - DOSDATA:133Eh)
 55557                                  
 55558                                  MagicPatch:
 55559                                  ;MagicPatch proc far
 55560 00001340 CB                              retf            ;default is to just return to allocate
 55561 00001341 90                              nop             ;however, this code will be patched
 55562 00001342 90                              nop             ;by magicdrv.sys to
 55563 00001343 90                              nop             ; call far ?:?     
 55564 00001344 90                              nop             ; retf or perhaps just jmp far
 55565 00001345 90                              nop             ;retf/nop take one byte, so we need six instructions
 55566                                                          ;for 6 byte patch
 55567                                  ;MagicPatch endp
 55568                                  
 55569                                  ; ---------------------------------------------------------------------------
 55570                                  
 55571                                  ;DosData Ends
 55572                                  
 55573                                  ; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:136Ah
 55574                                  ;
 55575                                  ; 25/03/2024 - Retro DOS v5.0
 55576                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1346h
 55577                                  
 55578                                  ;; Windows ME IO.SYS
 55579                                  ;; db 12 dup(0)
 55580                                  
 55581                                  ; (Windows ME IO.SYS - DOSDATA:1344h)
 55582                                  
 55583                                  ;----------------------------------------------------------------------------
 55584                                  
 55585                                  ;DOSDATALAST SEGMENT
 55586                                  
 55587                                  ; 29/04/2019 - Retro DOS v4.0
 55588                                  
 55589                                  ;----------------------------------------------------------------------------
 55590                                  ; 25/05/2019 - Retro DOS v4.0 Modification (paragraph alignment)
 55591                                  
 55592                                  ;db 0,1,12,64,19,0 ; ! Magic numbers !
 55593                                  
 55594                                  ;align 16
 55595                                  
 55596                                  ; !!! DOSDATA:1370h ; Retro DOS v4.0 only!
 55597                                  
 55598                                  ;----------------------------------------------------------------------------
 55599                                  
 55600                                  ; 05/01/2024
 55601                                  ;%endif	; 05/11/2022
 55602                                  
 55603                                  ; 05/12/2022
 55604                                  ;MSDAT001E:	; label byte
 55605                                  
 55606                                  ; 22/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 55607                                  ; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 55608                                  DOSDATAEND equ $
 55609                                  DOSDATASIZE equ DOSDATAEND - DOSDATASTART ; = 4962 for MSDOS 5.0 MSDOS.SYS
 55610                                  					; = 4970 for MSDOS 6.22 MSDOS.SYS
 55611                                  MSDAT001E equ DOSDATAEND - DOSDATASTART ; = 4934 for PCDOS 7.1 IBMDOS.COM
 55612                                  					; (= 4944 for Windows ME IO.SYS)
 55613                                  ;DOSDATALAST ENDS
 55614                                  
 55615                                  ; Retro DOS v4.0 by Erdogan Tan (Redevelopment of MSDOS 5.0 KERNEL via NASM)
 55616                                  ; DECEMBER 2022, ISTANBUL - TURKIYE.
 55617                                  ;============================================================================
 55618                                  ;	END
 55619                                  ;============================================================================
 55620                                  ; Retro DOS v4.0 by Erdogan Tan (Redevelopment of MSDOS 6.21 KERNEL via NASM)
 55621                                  ; -----------------------------
 55622                                  ; MAY 2019, ISTANBUL - TURKIYE.
 55623                                  ;============================================================================
 55624                                  ; 25/03/2024 - RETRO DOS v5.0 KERNEL code is READY! (Start: 01/01/2024)
