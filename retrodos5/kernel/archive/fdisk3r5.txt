     1                                  ; ****************************************************************************
     2                                  ; FDISK3R5.ASM (FDISK3R5.COM) - Retro DOS v5 Hard Disk Partitioning Utility
     3                                  ; fdisk3.s						(for MSDOS/WINDOWS)
     4                                  ; ****************************************************************************
     5                                  ; Last Update: 04/05/2024
     6                                  ; ----------------------------------------------------------------------------
     7                                  ; Beginning: 11/10/2020
     8                                  ; ----------------------------------------------------------------------------
     9                                  ; Assembler: NASM version 2.15
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Modified from 'FDISK3.ASM' (FDISK3.COM) source code by Erdogan Tan
    12                                  ; (04/05/2024) - TRDOS 386 v2 fixed disk partitioning utility -
    13                                  ; ****************************************************************************
    14                                  ; nasm fdisk3r5.s -l fdisk3r5.txt -o FDISK3R5.COM -Z error.txt
    15                                  
    16                                  ; Masterboot / Partition Table at Beginning+1BEh
    17                                  ptBootable      equ 0
    18                                  ptBeginHead     equ 1
    19                                  ptBeginSector   equ 2
    20                                  ptBeginCylinder equ 3
    21                                  ptFileSystemID	equ 4
    22                                  ptEndHead       equ 5
    23                                  ptEndSector     equ 6
    24                                  ptEndCylinder   equ 7
    25                                  ptStartSector   equ 8
    26                                  ptSectors       equ 12
    27                                  
    28                                  ; BIOS Disk Parameters
    29                                  DPDiskNumber  equ 0h
    30                                  DPDType       equ 1h
    31                                  DPReturn      equ 2h
    32                                  DPHeads       equ 3h
    33                                  DPCylinders   equ 4h
    34                                  DPSecPerTrack equ 6h
    35                                  DPDisks       equ 7h
    36                                  DPTableOff    equ 8h
    37                                  DPTableSeg    equ 0Ah
    38                                  DPNumOfSecs   equ 0Ch
    39                                  
    40                                  ; BIOS INT 13h Extensions (LBA extensions)
    41                                  ; Just After DP Data (DPDiskNumber+)
    42                                  DAP_PacketSize equ 10h  ; If extensions present, this byte will be >=10h
    43                                  DAP_Reserved1 equ 11h   ; Reserved Byte 
    44                                  DAP_NumOfBlocks equ 12h ; Value of this byte must be 0 to 127
    45                                  DAP_Reserved2 equ 13h   ; Reserved Byte
    46                                  DAP_Destination equ 14h ; Address of Transfer Buffer as SEGMENT:OFFSET
    47                                  DAP_LBA_Address equ 18h ; LBA=(C1*H0+H1)*S0+S1-1
    48                                                          ; C1= Selected Cylinder Number
    49                                                          ; H0= Number Of Heads (Maximum Head Number + 1)
    50                                                          ; H1= Selected Head Number
    51                                                          ; S0= Maximum Sector Number
    52                                                          ; S1= Selected Sector Number
    53                                                          ; QUAD WORD
    54                                  ; DAP_Flat_Destination equ 20h ; 64 bit address, if value in 4h is FFFF:FFFFh
    55                                                               ; QUAD WORD (Also, value in 0h must be 18h) 
    56                                                               ; TR-DOS will not use 64 bit Flat Address
    57                                  
    58                                  ; INT 13h Function 48h "Get Enhanced Disk Drive Parameters"
    59                                  ; Just After DP Data (DPDiskNumber+)
    60                                  GetDParams_48h equ 20h ; Word. Data Lenght, must be 26 (1Ah) for short data.
    61                                  GDP_48h_InfoFlag equ 22h ; Word
    62                                  ; Bit 1 = 1 -> The geometry returned in bytes 4-15 is valid.
    63                                  GDP_48h_NumOfPCyls equ 24h ; Double Word. Number physical cylinders.
    64                                  GDP_48h_NumOfPHeads equ 28h ; Double Word. Number of physical heads.
    65                                  GDP_48h_NumOfPSpT equ 2Ch ; Double word. Num of physical sectors per track.
    66                                  GDP_48h_LBA_Sectors equ 30h ; 8 bytes. Number of physical/LBA sectors.
    67                                  GDP_48h_BytesPerSec equ 38h ; Word. Number of bytes in a sector.
    68                                  
    69                                  pTableOffset equ 1BEh ; 446
    70                                  
    71                                  	; Convert LBA to CHS
    72                                  	; 08/02/2019
    73                                  
    74                                  	; LBA = ((C1*H0+H1)*S0)+S1-1
    75                                  	;
    76                                  	; C1 = Selected Cylinder Number
    77                                  	; H0 = Number of Heads (Maximum Head Number + 1)
    78                                  	; H1 = Selected Head Number
    79                                  	; S0 = Maximum Sector Number
    80                                  	; S1 = Selected Sector Number
    81                                  	;
    82                                  	; Phoenix, Enchanced Disk Drive Specicifications, v1.1, Page 8)
    83                                  		
    84                                  
    85                                  [BITS 16]
    86                                  [ORG 100h]
    87                                  
    88                                  	;cli
    89                                  	;cld
    90                                  	;push	cs
    91                                  	;pop	ss
    92                                  	;mov	sp, 0FFFEh
    93                                  	;sti
    94                                  	
    95                                  	;mov	bx, SizeOfFile+100
    96                                  	
    97 00000000 BB[B070]                	mov	bx, bss_end
    98                                  
    99 00000003 83C30F                          add	bx, 15
   100 00000006 D1EB                            shr	bx, 1
   101 00000008 D1EB                            shr	bx, 1
   102 0000000A D1EB                    	shr	bx, 1
   103 0000000C D1EB                    	shr	bx, 1
   104 0000000E B44A                            mov	ah, 4Ah ; modify memory allocation
   105                                          ;push	cs
   106                                          ;pop	es
   107 00000010 CD21                            int	21h
   108                                  
   109                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   110                                  ; clear BSS
   111                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   112                                  ; 03/02/2019
   113                                  
   114                                  	;mov	cx, bss_end
   115 00000012 B9[806F]                	mov	cx, bss_clear_end ; 15/02/2019
   116                                  
   117 00000015 BF[3E68]                	mov	di, bss_start
   118 00000018 29F9                    	sub	cx, di
   119 0000001A 41                      	inc	cx
   120 0000001B D1E9                    	shr	cx, 1
   121 0000001D 31C0                    	xor	ax, ax
   122 0000001F F3AB                    	rep	stosw 
   123                                  
   124                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   125                                  ; display program name & version
   126                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   127                                  
   128 00000021 BE[6E43]                	mov	si, TrDOS_Welcome
   129 00000024 E8571B                  	call	print_msg
   130                                  
   131                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   132                                  ; get hard disk name
   133                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   134                                  ; 11/10/2020
   135                                  
   136 00000027 BE8000                  	mov	si, 80h			; PSP command tail
   137 0000002A AC                       	lodsb
   138 0000002B 08C0                    	or	al, al 			; command tail length
   139 0000002D 7431                    	jz	short A_05		; jump if zero
   140                                  A_01:
   141 0000002F AC                      	lodsb
   142 00000030 3C20                    	cmp	al, ' '			; is it SPACE ?
   143 00000032 74FB                    	je	short A_01
   144 00000034 722A                    	jb	short A_05
   145                                  	
   146                                  	; check disk name
   147                                  
   148 00000036 3C68                    	cmp	al, 'h'
   149 00000038 751B                    	jne	short A_03
   150 0000003A 803C64                  	cmp	byte [si], 'd'
   151 0000003D 7516                    	jne	short A_03
   152 0000003F 46                      	inc	si
   153 00000040 AC                      	lodsb
   154 00000041 3C30                    	cmp	al, '0'
   155 00000043 7406                    	je	short A_02
   156 00000045 720E                    	jb	short A_03
   157 00000047 3C33                    	cmp	al, '3'
   158 00000049 770A                    	ja	short A_03
   159                                  A_02:
   160 0000004B 803C20                  	cmp	byte [si], ' '
   161 0000004E 720B                    	jb	short A_04
   162 00000050 7703                    	ja	short A_03
   163 00000052 46                      	inc	si
   164 00000053 EBF6                    	jmp	short A_02
   165                                  A_03:
   166 00000055 BE[CF43]                	mov	si, TrDOS_Usage
   167 00000058 E94F07                  	jmp	_p_exit
   168                                  A_04:
   169 0000005B 0450                    	add	al, 80h - '0'
   170 0000005D A2[3E68]                	mov	[DrvNum], al	; 80h .. 83h
   171                                  
   172                                  A_05:
   173                                  
   174                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   175                                  ; get hard disk parameters 
   176                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   177                                  ; 11/10/2020
   178                                  
   179                                  	; check bios int 13h extensions
   180 00000060 B441                    	mov	ah, 41h
   181 00000062 BBAA55                  	mov	bx, 55AAh
   182 00000065 B280                    	mov	dl, 80h
   183 00000067 CD13                    	int	13h
   184 00000069 720B                    	jc	short A_06
   185 0000006B 81FB55AA                	cmp	bx, 0AA55h
   186 0000006F 7505                    	jne	short A_06
   187                                  
   188 00000071 C606[5631]01            	mov	byte [int13h_x], 1
   189                                  A_06:
   190                                  	;mov	dl, 80h	 ; hd0
   191 00000076 B408                    	mov	ah, 08h  ; return disk parameters
   192 00000078 CD13                    	int	13h	
   193 0000007A 7313                    	jnc	short A_10
   194                                  A_07:
   195 0000007C 803E[3E68]80            	cmp 	byte [DrvNum], 80h  ; hard disk name option ?
   196 00000081 7206                    	jb	short A_09 ; no, default
   197                                  A_08:
   198 00000083 BE[C463]                	mov	si, msg_drv_not_ready ; drive not ready
   199 00000086 E92107                  	jmp	_p_exit
   200                                  A_09:
   201 00000089 BE[EE63]                	mov	si, msg_not_any_disks ; there is not a hard disk
   202 0000008C E91B07                  	jmp	_p_exit
   203                                  A_10:
   204 0000008F 08E4                    	or	ah, ah	 ; ah = 0 ?	
   205 00000091 75E9                    	jnz	short A_07  ; no, there is an error !
   206                                  	
   207 00000093 8816[3F68]              	mov	[hdc], dl ; number of hard disks
   208                                  
   209 00000097 A0[3E68]                	mov	al, [DrvNum]
   210                                  
   211 0000009A 3C80                    	cmp	al, 80h
   212 0000009C 7308                    	jnb	short A_11 ; option
   213                                  	; default
   214 0000009E C606[3E68]80            	mov	byte [DrvNum], 80h
   215 000000A3 E98F00                  	jmp	A_14
   216                                  A_11:
   217                                  	; hard disk name option
   218 000000A6 80C27F                  	add	dl, 7Fh
   219                                  
   220 000000A9 38D0                    	cmp	al, dl
   221 000000AB 77D6                    	ja	short A_08
   222                                  
   223 000000AD 80FA80                  	cmp	dl, 80h
   224 000000B0 760C                    	jna	short A_13 ; hd0 parameters are ready
   225                                  A_12:
   226 000000B2 88C2                    	mov	dl, al ; [DrvNum]
   227                                  
   228 000000B4 B408                    	mov	ah, 08h  ; return (get) disk parameters
   229 000000B6 CD13                    	int	13h	
   230 000000B8 72C2                    	jc	short A_07
   231 000000BA 08E4                    	or	ah, ah
   232 000000BC 75BE                    	jnz	short A_07
   233                                  A_13:
   234 000000BE 88C8                    	mov	al, cl
   235 000000C0 243F                    	and	al, 3Fh ; 63
   236 000000C2 C0E906                  	shr	cl, 6
   237 000000C5 86E9                    	xchg	ch, cl
   238 000000C7 41                      	inc	cx
   239 000000C8 41                      	inc	cx ; 15/10/2020 ; BIOS BugFix 
   240                                  				; (for reserved last cylinder)
   241 000000C9 890E[6E3F]              	mov	[cylinders], cx
   242                                  	;mov	word [cylinders+2], 0 ; 16/10/2020
   243 000000CD FEC6                    	inc	dh
   244 000000CF 8836[6C3F]              	mov	[heads], dh	
   245 000000D3 A2[6A3F]                	mov	[sectors], al
   246 000000D6 F6E6                    	mul	dh
   247 000000D8 A3[006D]                	mov	[hs], ax ; heads*sectors ; 15/10/2020
   248 000000DB F7E1                    	mul	cx
   249 000000DD A3[4268]                	mov	[disksize], ax
   250 000000E0 8916[4468]              	mov	[disksize+2], dx
   251 000000E4 83E801                  	sub	ax, 1	; 17/10/2020
   252 000000E7 83DA00                  	sbb	dx, 0
   253 000000EA A3[4668]                	mov	[chs_limit], ax	
   254 000000ED 8916[4868]              	mov	[chs_limit+2], dx
   255                                  
   256 000000F1 803E[5631]01            	cmp	byte [int13h_x], 1
   257 000000F6 0F82D700                	jb	A_20
   258                                  
   259 000000FA BE[9470]                	mov	si, gdp_buffer
   260                                  	;mov	word [si], 30 ; buffer length (minimum)
   261 000000FD C7041A00                	mov	word [si], 26 ; buffer length (minimum)
   262 00000101 B448                    	mov	ah, 48h
   263 00000103 8A16[3E68]              	mov	dl, [DrvNum]
   264 00000107 CD13                    	int	13h
   265 00000109 0F82C400                	jc	A_20
   266 0000010D 20E4                    	and	ah, ah
   267 0000010F 0F85BE00                	jnz	A_20
   268                                  
   269                                  	; number of physical sectors
   270 00000113 8B4410                  	mov	ax, [si+16]
   271 00000116 8B5412                  	mov	dx, [si+18]
   272 00000119 A3[4268]                	mov	[disksize], ax
   273 0000011C 8916[4468]              	mov	[disksize+2], dx
   274                                  
   275                                  	; 15/10/2020
   276 00000120 8B0E[006D]              	mov	cx, [hs]
   277 00000124 E8560B                  	call	div32
   278                                  	; 16/10/2020
   279                                  	;mov	[lba_cyls], ax
   280                                  	;mov	[lba_cyls+2], dx
   281 00000127 A3[6E3F]                	mov	[cylinders], ax
   282 0000012A 8916[703F]              	mov	[cylinders+2], dx
   283 0000012E 891E[4A68]              	mov	[lba_chs_remain], bx
   284                                  
   285 00000132 E99C00                  	jmp	A_20	
   286                                  A_14:
   287 00000135 80FA01                  	cmp	dl, 1
   288 00000138 7684                    	jna	short A_13 ; [DrvNum] = 80h
   289                                  
   290 0000013A 80C230                  	add	dl, '0' ; '2' to '4'
   291 0000013D 8816[9444]              	mov	byte [TrDOS_dnmax], dl
   292                                  
   293 00000141 BE[7644]                	mov	si, TrDOS_Options
   294 00000144 E8371A                  	call	print_msg
   295                                  
   296                                  	; check bios int 13h extensions
   297 00000147 803E[5631]01            	cmp	byte [int13h_x], 1
   298 0000014C 732D                    	jnb	short A_16
   299                                  A_15:
   300 0000014E 8A16[3E68]              	mov	dl, [DrvNum]
   301 00000152 B408                    	mov	ah, 08h  ; return disk parameters
   302 00000154 CD13                    	int	13h	
   303 00000156 724D                    	jc	short A_17
   304 00000158 08E4                    	or	ah, ah
   305 0000015A 7549                    	jnz	short A_17
   306                                  
   307 0000015C 88C8                    	mov	al, cl
   308 0000015E 243F                    	and	al, 3Fh ; 63
   309 00000160 C0E906                  	shr	cl, 6
   310 00000163 86E9                    	xchg	ch, cl
   311 00000165 41                      	inc	cx
   312 00000166 FEC6                    	inc	dh
   313 00000168 F6E6                    	mul	dh
   314 0000016A F7E1                    	mul	cx
   315                                  
   316                                  	; dx:ax = disk size
   317                                  
   318 0000016C E89D02                  	call	display_hd_row	
   319                                  
   320 0000016F FE0E[3F68]              	dec	byte [hdc]
   321 00000173 7430                    	jz	short A_17
   322 00000175 FE06[3E68]              	inc	byte [DrvNum]
   323 00000179 EBD3                    	jmp	short A_15
   324                                  A_16:
   325 0000017B BE[9470]                	mov	si, gdp_buffer
   326                                  	;mov	word [si], 30 ; buffer length (minimum)
   327 0000017E C7041A00                	mov	word [si], 26 ; buffer length (minimum)
   328 00000182 B448                    	mov	ah, 48h
   329 00000184 8A16[3E68]              	mov	dl, [DrvNum]
   330 00000188 CD13                    	int	13h
   331 0000018A 72C2                    	jc	short A_15
   332 0000018C 20E4                    	and	ah, ah
   333 0000018E 75BE                    	jnz	short A_15
   334                                  
   335                                  	; number of phsical sectors
   336 00000190 8B4410                  	mov	ax, [si+16]
   337 00000193 8B5412                  	mov	dx, [si+18]
   338                                  
   339                                  	; dx:ax = disk size
   340                                  
   341 00000196 E87302                  	call	display_hd_row	
   342                                  
   343 00000199 FE0E[3F68]              	dec	byte [hdc]
   344 0000019D 7406                    	jz	short A_17
   345 0000019F FE06[3E68]              	inc	byte [DrvNum]
   346 000001A3 EBD6                    	jmp	short A_16
   347                                  A_17:
   348 000001A5 BE[6B55]                	mov	si, CRLF
   349 000001A8 E8D319                  	call	print_msg
   350                                  
   351                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   352                                  ; hard disk number input (getchar)
   353                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   354                                  ; 11/10/2020
   355                                  	
   356                                  A_18:
   357 000001AB 31C0                    	xor	ax, ax
   358 000001AD CD16                    	int	16h			; wait for keyboard command
   359                                  
   360 000001AF 83F800                  	cmp	ax, 0			; CTRL+BREAK
   361 000001B2 761A                    	jna	short A_19
   362                                  
   363 000001B4 3C03                    	cmp	al, 'C'-40h		; 3
   364 000001B6 7416                    	je	short A_19             	; CTRL+C
   365 000001B8 3C1B                    	cmp	al, 27			; ESCape
   366 000001BA 7412                    	je	short A_19
   367                                  
   368 000001BC 3C31                    	cmp	al, '1'			; "(1) hd0" 
   369 000001BE 72EB                    	jb	short A_18		; retry
   370 000001C0 3A06[9444]              	cmp	al, [TrDOS_dnmax]	; ('2' to '4')	
   371 000001C4 77E5                    	ja	short A_18		; retry
   372 000001C6 044F                    	add	al, 80h-'1'		; bios disk num (80h-83h)
   373 000001C8 A2[3E68]                	mov	[DrvNum], al
   374 000001CB E9E4FE                  	jmp	A_12			; get disk parameters
   375                                  A_19:
   376 000001CE E9DC05                  	jmp	_exit			; Exit
   377                                  
   378                                  A_20:
   379                                  
   380                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   381                                  ; read masterboot sector
   382                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   383                                  ; 12/10/2020
   384                                  
   385 000001D1 BB[E655]                	mov	bx, MasterBootBuff
   386 000001D4 B90100                  	mov	cx, 1	; cylinder = 0
   387                                  			; sector = 1
   388 000001D7 B600                    	mov	dh, 0	; head = 0
   389 000001D9 8A16[3E68]              	mov	dl, [DrvNum]
   390 000001DD B80102                  	mov	ax, 0201h ; read one sector
   391 000001E0 CD13                    	int	13h
   392 000001E2 7306                    	jnc	short A_21
   393                                  
   394 000001E4 BE[C463]                	mov	si, msg_drv_not_ready ; drive not ready
   395 000001E7 E98700                  	jmp	A_26
   396                                  A_21:
   397                                  
   398                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   399                                  ; display CHS values and disk size (LBA) and partition table
   400                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   401                                  ; 12/10/2020
   402                                  
   403 000001EA B80300                  	mov	ax, 3  ; clear screen
   404 000001ED CD10                    	int	10h
   405                                  
   406 000001EF E8FF20                  	call	init_partition_table ; 13/10/2020
   407                                  
   408 000001F2 E8081B                  	call	display_chs_table
   409                                  
   410 000001F5 A1[4268]                	mov	ax, [disksize]
   411 000001F8 8B16[4468]              	mov	dx, [disksize+2]
   412                                  
   413 000001FC 81FA0001                	cmp	dx, 256 ; >= 8GB  
   414 00000200 7315                    	jnb	short A_22
   415                                  
   416                                  	;mov	cx, 2048 ; /2048 (2048 sectors = 1 MB)
   417                                  	;div	cx
   418                                  
   419                                  	; shift dx:ax to 8 bits right (/256)
   420 00000202 88E0                    	mov	al, ah
   421 00000204 88D4                    	mov	ah, dl
   422 00000206 C1E803                  	shr	ax, 3 ; /8 
   423                                  		; result = (dx:ax)/2048
   424                                  
   425                                  	; ax =  0 to 8191
   426                                  
   427 00000209 C606[CA44]4D            	mov	byte [TrDOS_hdrow_unit], 'M'
   428 0000020E EB11                    	jmp	short A_23
   429                                  
   430                                  
   431                                  A_29:	; 16/10/2020
   432 00000210 E88A27                  	call	partition_table_fix
   433 00000213 73D5                    	jnc	short A_21
   434                                  
   435 00000215 CD20                    	int	20h
   436                                  ;here:	
   437                                  	;jmp	short here
   438                                  
   439                                  A_22:
   440                                  	; 1024 MB = 1GB (2097152 sectors)
   441                                  	; DX/32 --> GB 
   442 00000217 89D0                    	mov	ax, dx
   443 00000219 C1E805                  	shr	ax, 5 ; /32
   444                                  
   445                                  	; ax = 8 to 2047
   446 0000021C C606[CA44]47            	mov	byte [TrDOS_hdrow_unit], 'G'
   447                                  A_23:
   448                                  	;xor	dx, dx
   449 00000221 BE[D044]                	mov	si, TrDOS_hdrow_capacity
   450 00000224 E82402                  	call	convert_to_decimal
   451                                  
   452 00000227 BE[D744]                	mov	si, TrDOS_disksize
   453 0000022A E85119                  	call	print_msg
   454                                  
   455 0000022D BE[D044]                	mov	si, TrDOS_hdrow_capacity
   456 00000230 E84B19                  	call	print_msg
   457                                  
   458 00000233 BE[CA44]                	mov	si, TrDOS_hdrow_unit
   459 00000236 E84519                  	call	print_msg
   460                                  
   461                                  	; 16/10/2020
   462                                  	;cmp	word [lba_cyls+2], 0
   463 00000239 833E[703F]00            	cmp	word [cylinders+2], 0
   464 0000023E 7736                    	ja	short A_27  ; Huge disk ! number of (lba) cylinders > 65335
   465                                  			    ; Current FDISK version (v3) can not be used !
   466                                  
   467 00000240 BE[6B55]                	mov	si, CRLF
   468 00000243 E83819                  	call	print_msg
   469                                  
   470 00000246 E8A625                  	call	dpt_1
   471                                  
   472 00000249 BE[6B55]                	mov	si, CRLF
   473 0000024C E82F19                  	call	print_msg
   474                                  
   475                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   476                                  ; display edit or exit option, getchar
   477                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   478                                  
   479 0000024F BE[9A53]                	mov	si, msg_edit_or_exit
   480 00000252 E82919                  	call	print_msg
   481                                  A_24:
   482 00000255 30E4                    	xor	ah, ah
   483 00000257 CD16                    	int	16h
   484                                  
   485 00000259 3C0D                    	cmp	al, 13 ; CR (ENTER) key
   486 0000025B 744A                    	je	short A_28 
   487                                  
   488 0000025D 3C1B                    	cmp	al, 27 ; ESCape key
   489 0000025F 740D                    	je	short A_25
   490                                  
   491 00000261 3C20                    	cmp	al, 32 ; SPACE key
   492 00000263 7442                    	je	short A_28
   493                                  
   494 00000265 3C03                    	cmp	al, 3 ; CTRL+C
   495 00000267 7405                    	je	short A_25
   496                                  
   497 00000269 83F800                  	cmp	ax, 0 ; CTRL+BREAK
   498 0000026C 77E7                    	ja	short A_24
   499                                  A_25:
   500 0000026E BE[6B55]                	mov	si, CRLF
   501                                  A_26:
   502 00000271 E80A19                  	call	print_msg
   503                                  
   504 00000274 CD20                    	int	20h
   505                                  ;here:
   506                                  ;	jmp	short here
   507                                  
   508                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   509                                  ; display fdisk program disk capacity limit message and then exit
   510                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   511                                  
   512                                  A_27:
   513                                  	; 16/10/2020
   514                                  	; 15/10/2020
   515                                  	; Display FDISK (v3) capacity limit (error) message
   516                                  
   517 00000276 B8FFFF                  	mov	ax, 65535
   518 00000279 F726[006D]              	mul	word [hs]
   519                                  		; 1024 MB = 1GB (2097152 sectors)
   520                                  	; DX/32 --> GB 
   521 0000027D 89D0                    	mov	ax, dx
   522 0000027F C1E805                  	shr	ax, 5 ; /32
   523                                  
   524                                  	; ax = 8 to 2047
   525 00000282 C606[CA44]47            	mov	byte [TrDOS_hdrow_unit], 'G'
   526                                  	;mov	byte [TrDOS_hdrow_unit+1], 'B'
   527 00000287 C606[CC44]2E            	mov	byte [TrDOS_hdrow_unit+2], '.'
   528                                  
   529                                  	;xor	dx, dx
   530 0000028C BE[D044]                	mov	si, TrDOS_hdrow_capacity	
   531 0000028F E8B901                  	call	convert_to_decimal
   532                                  
   533 00000292 BE[E644]                	mov	si, msg_fdisk_capacity_err
   534 00000295 E8E618                  	call 	print_msg
   535                                  
   536 00000298 BE[D044]                	mov	si, TrDOS_hdrow_capacity
   537 0000029B E8E018                  	call	print_msg
   538                                  
   539 0000029E BE[CA44]                	mov	si, TrDOS_hdrow_unit
   540 000002A1 E8DA18                  	call	print_msg
   541                                  	
   542 000002A4 E90605                  	jmp	_exit
   543                                  
   544                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   545                                  ; check defective pte and then init extended partition table(s)
   546                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   547                                  
   548                                  A_28:
   549 000002A7 E8BE01                  	call	check_defective_partition
   550 000002AA 0F8262FF                	jc	A_29 ; ds:si -> defective pte
   551                                  
   552                                  	; 17/10/2020
   553                                  	; 26/02/2019
   554 000002AE 803E[CB6F]00            	cmp	byte [epnumber], 0
   555 000002B3 7603                    	jna	short A_30
   556                                  
   557 000002B5 E8F52C                  	call	init_ext_partition_table
   558                                  A_30:
   559                                  	; 17/10/2020
   560                                  	; 04/02/2019
   561                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
   562 000002B8 E81C25                  	call	display_partition_table ; 12/03/2021
   563                                  
   564                                  	; 17/10/2020
   565 000002BB 803E[C86F]00            	cmp	byte [pcount], 0
   566 000002C0 0F86F000                	jna	A_38 ; empty partition table
   567                                  
   568                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   569                                  ; check CHS parms against start sector address and partition size 
   570                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   571                                  
   572                                  A_31:
   573                                  	; Check disk parameters with current CHS settings
   574 000002C4 31DB                    	xor	bx, bx
   575 000002C6 31C9                    	xor	cx, cx
   576                                  A_32:
   577                                  	; 17/10/2020
   578 000002C8 80BF[856F]00            	cmp	byte [part_table_sys_id+bx], 0
   579 000002CD 767C                    	jna	short A_33
   580                                  
   581                                  	; 27/10/2020
   582                                  	;mov	ax, [sectors]
   583                                  	;mul	word [heads]
   584                                  	; dx = 0, ax = heads*sectors
   585                                  
   586 000002CF 8B97[836F]              	mov	dx, [part_table_start_cyl+bx]
   587                                  	; 27/10/2020
   588 000002D3 81FAFF03                	cmp	dx, 1023 ; fixed cylinder number (> 1023)
   589                                  			 ; (partition's start sector is used for fixing)
   590 000002D7 7772                    	ja	short A_33 ; no need to check CHS parms here
   591                                  			; (also, CHS to LBA calculation is not applicable)
   592 000002D9 A1[006D]                	mov	ax, [hs] ; heads*sectors
   593                                  
   594 000002DC F7E2                    	mul	dx
   595                                  		; dx:ax = cylinder*heads*spt
   596 000002DE 89C6                    	mov	si, ax
   597 000002E0 89D7                    	mov	di, dx
   598 000002E2 8A87[816F]              	mov	al, [part_table_start_head+bx]
   599 000002E6 F626[6A3F]              	mul	byte [sectors]
   600 000002EA 01C6                    	add	si, ax
   601 000002EC 83D700                  	adc	di, 0
   602                                  		; di:si = (cylinder*heads*spt) + head*spt
   603 000002EF 8A87[826F]              	mov	al, [part_table_start_sector+bx]
   604 000002F3 30E4                    	xor	ah, ah
   605 000002F5 FEC8                    	dec	al ; 1 -> 0
   606 000002F7 01C6                    	add	si, ax
   607 000002F9 83D700                  	adc	di, 0
   608                                  		; di:si = (cylinder*heads*spt) + head*spt + sector - 1
   609                                  		; (start sector as converted to LBA)
   610                                  
   611 000002FC 3BBF[8C6F]              	cmp	di, [part_table_rel_sec_hw+bx]
   612 00000300 7556                    	jne	short A_34 ; Invalid !
   613                                  
   614 00000302 3BB7[8A6F]              	cmp	si, [part_table_rel_sec_lw+bx]
   615 00000306 7550                    	jne	short A_34 ; Invalid !
   616                                  		; di:si = partition's start sector (LBA)
   617                                  
   618                                  	; 27/10/2020
   619                                  	;mov	ax, [sectors]
   620                                  	;mul	word [heads]
   621                                  	; dx = 0, ax = heads*sectors
   622                                  
   623 00000308 8B97[886F]              	mov	dx, [part_table_end_cyl+bx]
   624                                  
   625                                  	; 27/10/2020
   626 0000030C 81FAFF03                	cmp	dx, 1023 ; fixed cylinder number (> 1023)
   627                                  			 ; (partition's end sector is used for fixing)
   628 00000310 7739                    	ja	short A_33 ; no need to check CHS parms here
   629                                  			; (also, CHS to LBA calculation is not applicable)
   630 00000312 A1[006D]                	mov	ax, [hs] ; heads*sectors
   631                                  
   632 00000315 F7E2                    	mul	dx
   633                                  		; dx:ax = cylinder*heads*spt
   634 00000317 89C6                    	mov	si, ax
   635 00000319 89D7                    	mov	di, dx
   636 0000031B 8A87[866F]              	mov	al, [part_table_end_head+bx]
   637 0000031F F626[6A3F]              	mul	byte [sectors]
   638 00000323 01C6                    	add	si, ax
   639 00000325 83D700                  	adc	di, 0
   640                                  		; di:si = (cylinder*heads*spt) + head*spt
   641 00000328 8A87[876F]              	mov	al, [part_table_end_sector+bx]
   642 0000032C 30E4                    	xor	ah, ah
   643                                  	;dec	al ; 63 -> 62
   644 0000032E 01C6                    	add	si, ax
   645 00000330 83D700                  	adc	di, 0
   646                                  		; di:si = (cylinder*heads*spt) + head*spt + sector
   647                                  		; (end sector + 1 as converted to LBA)
   648 00000333 8B87[8E6F]              	mov	ax, [part_table_num_sec_lw+bx]
   649 00000337 8B97[906F]              	mov	dx, [part_table_num_sec_hw+bx]
   650                                  	
   651 0000033B 0387[8A6F]              	add	ax, [part_table_rel_sec_lw+bx]
   652 0000033F 1397[8C6F]              	adc	dx, [part_table_rel_sec_hw+bx]
   653                                  		; dx:ax = partition's end sector (LBA) + 1
   654                                  
   655 00000343 39F0                    	cmp	ax, si
   656 00000345 7511                    	jne	short A_34 ; Invalid !
   657                                  
   658 00000347 39FA                    	cmp	dx, di
   659 00000349 750D                    	jne	short A_34 ; Invalid !
   660                                  A_33:
   661 0000034B FEC1                    	inc	cl
   662                                  
   663 0000034D 80F904                  	cmp	cl, 4
   664 00000350 730E                    	jnb	short A_35
   665                                  
   666 00000352 83C312                  	add	bx, 18  ; partition table structure size
   667                                  	
   668 00000355 E970FF                  	jmp	A_32
   669                                  A_34:
   670 00000358 BE[FD5E]                	mov	si, msg_defective_pt
   671 0000035B E82018                  	call	print_msg
   672 0000035E EB54                    	jmp	short A_38
   673                                  
   674                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   675                                  ; sort MBR partitions
   676                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   677                                  
   678                                  A_35:
   679                                  	; LBA and CHS values of all partitions are OK (here)
   680                                  
   681                                  	; sort MBR (primary) partitions
   682                                  
   683 00000360 E85F21                  	call	sort_partition_table
   684                                  
   685                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   686                                  ; Check partition (start, size) overlaps after sorting 
   687                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   688                                  
   689                                  	; Checking partition overlaps (via start and end cylinders)
   690                                  
   691 00000363 31DB                    	xor	bx, bx
   692 00000365 BA1200                  	mov	dx, 18
   693                                  A_36:
   694 00000368 FEC3                    	inc	bl
   695                                  
   696 0000036A 8A87[106D]              	mov	al, [bx+sort]
   697 0000036E F6E2                    	mul	dl
   698 00000370 89C6                    	mov	si, ax	; current
   699                                  
   700 00000372 80BC[856F]00            	cmp	byte [part_table_sys_id+si], 0
   701 00000377 7636                    	jna	short A_37
   702                                  
   703 00000379 8A87[0F6D]              	mov	al, [bx+sort-1]
   704 0000037D F6E2                    	mul	dl
   705 0000037F 89C7                    	mov	di, ax  ; previous
   706                                  
   707 00000381 8B85[886F]              	mov	ax, [part_table_end_cyl+di]
   708 00000385 3B84[836F]              	cmp	ax, [part_table_start_cyl+si]
   709 00000389 7224                    	jb	short A_37
   710                                  	; 29/10/2020
   711 0000038B 77CB                    	ja	short A_34 ; overlap !
   712                                  
   713                                  	; 17/10/2020
   714                                  	;and	ax, ax
   715                                  	;jnz	short A_34 ; overlap error (except empty entries)
   716                                  
   717                                  	; 29/10/2020
   718                                  	; same cylinder
   719                                  	; check end-start sectors for overlap
   720                                  
   721 0000038D 21C0                    	and	ax, ax
   722 0000038F 741E                    	jz	short A_37 ; empty pt entries
   723                                  			; (previous pte is empty)
   724                                  
   725 00000391 8B85[8A6F]              	mov	ax, [part_table_rel_sec_lw+di] ; previous
   726 00000395 8B95[8C6F]              	mov	dx, [part_table_rel_sec_hw+di]
   727 00000399 0385[8E6F]              	add	ax, [part_table_num_sec_lw+di]
   728 0000039D 1395[906F]              	adc	dx, [part_table_num_sec_hw+di]
   729                                  	;jc	short A_34
   730                                  		 ; dx:ax = end sector + 1
   731 000003A1 3B94[8C6F]              	cmp	dx, [part_table_rel_sec_hw+si] ; current
   732 000003A5 7208                    	jb	short A_37
   733 000003A7 77AF                    	ja	short A_34 ; overlap error !	
   734 000003A9 3B84[8A6F]              	cmp	ax, [part_table_rel_sec_lw+si]
   735 000003AD 73A9                    	jnb	short A_34 ; overlap error ! 	
   736                                  A_37:
   737 000003AF 80FB03                  	cmp	bl, 3
   738 000003B2 72B4                    	jb	short A_36
   739                                  
   740                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   741                                  ; display partition table editing options
   742                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   743                                  
   744                                  A_38:
   745 000003B4 BE[D459]                	mov	si, mbr_editing_options
   746 000003B7 E8C417                  	call	print_msg
   747                                  
   748 000003BA BE[825A]                	mov	si, enter_option_number_msg
   749 000003BD E8BE17                  	call	print_msg
   750                                  
   751 000003C0 803E[0E6D]00            	cmp	byte [ldrives], 0
   752 000003C5 760C                    	jna	short A_39
   753                                  
   754 000003C7 BE[6B55]                	mov	si, CRLF
   755 000003CA E8B117                  	call	print_msg
   756                                  
   757 000003CD BE[4560]                	mov	si, str_display_ebr_pt
   758 000003D0 E8AB17                  	call	print_msg
   759                                  A_39:	
   760                                  	;mov	si, CRLF
   761                                  	;call	print_msg
   762                                  
   763                                  A_40:
   764 000003D3 30E4                    	xor	ah, ah
   765 000003D5 CD16                    	int	16h
   766                                  
   767 000003D7 3C30                    	cmp	al, '0'
   768 000003D9 742A                    	je	short A_41
   769                                  
   770 000003DB 3C31                    	cmp	al, '1'
   771 000003DD 0F84A600                	je	create_partition
   772 000003E1 3C32                    	cmp	al, '2'
   773 000003E3 0F843701                	je	activate_partition
   774 000003E7 3C33                    	cmp	al, '3'
   775 000003E9 0F84D001                	je	delete_partition
   776 000003ED 3C34                    	cmp	al, '4'
   777 000003EF 0F84D302                	je	write_pt_mbr
   778                                  	
   779 000003F3 3C1B                    	cmp	al, 27 ; ESCape
   780 000003F5 740E                    	je	short A_41
   781                                  
   782                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   783                                  ; display (EPT) logical drives/partitions if 'SPACE' is pressed
   784                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   785                                  
   786                                  	; 28/02/2019
   787 000003F7 803E[0E6D]00            	cmp	byte [ldrives], 0
   788 000003FC 76D5                    	jna	short A_40
   789                                  
   790 000003FE 3C20                    	cmp	al, 20h ; SPACE
   791 00000400 75D1                    	jne	short A_40
   792                                  
   793 00000402 E9CB25                  	jmp	display_extended_pt
   794                                  
   795                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   796                                  ; exit if ESC key or '0' is pressed
   797                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   798                                  
   799                                  A_41:
   800                                  	; terminate
   801 00000405 CD20                    	int	20h
   802                                  
   803                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   804                                  ; display partition table again
   805                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   806                                  
   807                                  A_42:
   808                                  	; 24/02/2019
   809                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
   810 00000407 E8CD23                  	call	display_partition_table ; 12/03/2021
   811 0000040A EBA8                    	jmp	short A_38
   812                                  
   813                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   814                                  ; display a row for hard disk name, number and capacity 
   815                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   816                                  ; 11/10/2020
   817                                  
   818                                  display_hd_row:
   819                                  	; dx:ax = disk size
   820                                  
   821 0000040C 81FA0001                	cmp	dx, 256 ; >= 8GB  
   822 00000410 730E                    	jnb	short dhdr_1
   823                                  
   824                                  	;mov	cx, 2048 ; /2048 (2048 sectors = 1 MB)
   825                                  	;div	cx
   826                                  
   827                                  	; shift dx:ax to 8 bits right (/256)
   828 00000412 88E0                    	mov	al, ah
   829 00000414 88D4                    	mov	ah, dl
   830 00000416 C1E803                  	shr	ax, 3 ; /8 
   831                                  		; result = (dx:ax)/2048
   832                                  
   833                                  	; ax =  0 to 8191
   834                                  
   835 00000419 C606[CA44]4D            	mov	byte [TrDOS_hdrow_unit], 'M'
   836 0000041E EB0A                    	jmp	short dhdr_2
   837                                  	
   838                                  dhdr_1:
   839                                  	; 1024 MB = 1GB (2097152 sectors)
   840                                  	; DX/32 --> GB 
   841 00000420 89D0                    	mov	ax, dx
   842 00000422 C1E805                  	shr	ax, 5 ; /32
   843                                  
   844                                  	; ax = 8 to 2047
   845 00000425 C606[CA44]47            	mov	byte [TrDOS_hdrow_unit], 'G'
   846                                  dhdr_2:
   847                                  	;xor	dx, dx
   848 0000042A BE[D044]                	mov	si, TrDOS_hdrow_capacity
   849 0000042D E81B00                  	call	convert_to_decimal
   850                                  
   851 00000430 FE06[B544]              	inc	byte [TrDOS_hdrow_n] ; next number for "(#)"
   852                                  	
   853 00000434 BE[B244]                	mov	si, TrDOS_hdrow
   854 00000437 E84417                  	call	print_msg
   855 0000043A BE[D044]                	mov	si, TrDOS_hdrow_capacity ; db "#### ", 0
   856 0000043D E83E17                  	call	print_msg
   857 00000440 BE[CA44]                	mov	si, TrDOS_hdrow_unit ; "GB" or "MB"
   858 00000443 E83817                  	call	print_msg
   859                                  
   860 00000446 FE06[BA44]              	inc	byte [TrDOS_hdrow_i] ; next number for "hd#"
   861                                  
   862 0000044A C3                      	retn	
   863                                  
   864                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   865                                  ; convert binary number to decimal character string
   866                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   867                                  ; 11/10/2020
   868                                  
   869                                  convert_to_decimal:
   870                                  	; ax = binary number
   871                                  	; si = decimal string start addr (max. 5 digits + space)
   872 0000044B B90A00                  	mov	cx, 10
   873 0000044E 89E5                    	mov	bp, sp
   874                                  ctd_1:
   875 00000450 31D2                    	xor	dx, dx
   876 00000452 F7F1                    	div	cx
   877 00000454 52                      	push	dx ; 0 to 9
   878 00000455 09C0                    	or	ax, ax
   879 00000457 75F7                    	jnz	short ctd_1
   880                                  ctd_2:
   881 00000459 58                      	pop	ax
   882 0000045A 0430                    	add	al, '0'
   883 0000045C 8804                    	mov	[si], al
   884 0000045E 46                      	inc	si
   885 0000045F 39E5                    	cmp	bp, sp
   886 00000461 77F6                    	ja	short ctd_2
   887                                  	;mov	byte [si], 20h ; space before size unit char
   888                                  	;inc	si 
   889                                  	;mov	byte [si], 0 ; ASCIIZ string terminator (Z)
   890 00000463 C7042000                	mov	word [si], 20h
   891 00000467 C3                      	retn
   892                                  
   893                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   894                                  ; check defective partition signature 
   895                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   896                                  ; 16/10/2020
   897                                  
   898                                  check_defective_partition:
   899 00000468 BB[806F]                	mov	bx, part_table_boot_ind
   900 0000046B 31F6                    	xor	si, si 
   901                                  chk_dp_1:
   902 0000046D 803FFF                  	cmp	byte [bx], 0FFh ; invalid/defective/partition sign
   903 00000470 7509                    	jne	short chk_dp_2
   904 00000472 C1E604                  	shl	si, 4 ; * 16
   905 00000475 81C6[A457]              	add	si, MasterBootBuff+446
   906 00000479 F9                      	stc
   907 0000047A C3                      	retn
   908                                  chk_dp_2:
   909                                  	;cmp	bx, part_table_boot_ind+(18*4)
   910 0000047B 83FE03                  	cmp	si, 3
   911 0000047E 7306                    	jnb	short chk_dp_3
   912 00000480 83C312                  	add	bx, 18
   913 00000483 46                      	inc	si
   914 00000484 EBE7                    	jmp	short chk_dp_1 
   915                                  chk_dp_3:
   916                                  	;sub	si, si
   917 00000486 C3                      	retn
   918                                  
   919                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   920                                  ; create a disk partition (on MBR partition table)
   921                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   922                                  ; 18/10/2020
   923                                  
   924                                  create_partition:
   925                                  	; 19/10/2020
   926                                  	; 10/02/2019 (hdimage.s)
   927 00000487 31C0                    	xor	ax, ax
   928 00000489 A2[DC6C]                	mov	byte [wholedisk], al ; 0 ; Reset wholedisk flag
   929                                  
   930                                  	; 19/10/2020
   931 0000048C 3806[C86F]              	cmp	byte [pcount], al ; 0 ; number of (valid) partitions
   932 00000490 7621                    	jna	short cp_1
   933                                  ;cp_0:
   934 00000492 803E[C86F]04            	cmp	byte [pcount], 4
   935 00000497 731D                    	jnb	short cp_2 ; full pt !
   936                                  
   937                                  	; al = 0
   938 00000499 E88A20                  	call	find_part_free_space
   939                                  		 ; Following values are for the max. free space on disk
   940                                  
   941 0000049C 21C9                    	and	cx, cx
   942 0000049E 7427                    	jz	short cp_3 ; there is not free space on disk
   943                                  
   944                                  	;mov	[c_cylinders], cx  ; count of free cylinders in the gap
   945 000004A0 891E[6670]              	mov	[c_fspc_offset], bx  ; offset from beginning of 'fspc:'
   946                                  	;mov	[c_gap], al ; gap (space index) number of this free space
   947                                  	;		    ; 0 -> before partition 1 (as PTE)
   948                                  	;		    ; 1-2-3 -> between partitions 1 to 4
   949                                  	;		    ; 4 -> after partition 4 (as PTE)
   950                                  
   951                                  	; Start to job with non-aligned (full) free sectors of this max. space
   952                                  	
   953 000004A4 8B87[1C70]              	mov	ax, [free_space.sectors_unused+bx]
   954 000004A8 8B97[1E70]              	mov	dx, [free_space.sectors_unused+2+bx]
   955                                  
   956 000004AC A3[D86C]                	mov	[pp_Sectors], ax
   957 000004AF 8916[DA6C]              	mov	[pp_Sectors+2], dx
   958                                  cp_1:
   959 000004B3 E9E907                  	jmp	B_01 ; New/Empty disk, create partition menu
   960                                  
   961                                  cp_2:
   962                                  	; 13/02/2019
   963                                  	; There is not a free pt entry to create a new partition
   964                                  
   965                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
   966 000004B6 E81E23                  	call	display_partition_table ; 12/03/2021
   967                                  
   968 000004B9 BE[645B]                	mov	si, msg_full_pt
   969 000004BC E8BF16                  	call	print_msg
   970 000004BF BE[915B]                	mov	si, msg_to_create_new_p
   971 000004C2 E8B916                  	call	print_msg
   972                                  
   973 000004C5 EB67                    	jmp	ap_0
   974                                  cp_3:
   975                                  	; 19/10/2020
   976 000004C7 803E[CB6F]00            	cmp	byte [epnumber], 0
   977 000004CC 7708                    	ja	short create_logical_drives
   978                                  ;cp_4:
   979                                  	; 15/02/2019
   980                                  	; There is not (enough) free space to create a new partition
   981                                  
   982 000004CE BE[AF5B]                	mov	si, msg_no_free_space
   983 000004D1 E8AA16                  	call	print_msg
   984 000004D4 EB58                    	jmp	ap_0
   985                                  
   986                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   987                                  ; create logical -dos- drives
   988                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   989                                  ; 19/10/2020
   990                                  
   991                                  create_logical_drives:
   992                                  	; 05/03/2019
   993 000004D6 E87628                  	call	check_ext_free_space
   994 000004D9 723B                    	jc	short cld_5
   995                                  cld_1:
   996                                  	; 05/03/2019
   997 000004DB 803E[0E6D]04            	cmp	byte [ldrives], 4
   998 000004E0 7203                    	jb	short cld_2
   999 000004E2 E95925                  	jmp	eetc_2
  1000                                  cld_2:
  1001                                  	; 01/11/2020
  1002 000004E5 A3[8A70]                	mov	[ep_free_sectors], ax
  1003 000004E8 8916[8C70]              	mov	[ep_free_sectors+2], dx
  1004                                  
  1005 000004EC BE[4863]                	mov	si, msg_c_ldd_q
  1006 000004EF E88C16                  	call	print_msg
  1007                                  cld_3:	
  1008 000004F2 28E4                    	sub	ah, ah
  1009 000004F4 CD16                    	int	16h
  1010                                  
  1011 000004F6 3C1B                    	cmp	al, 27 ; ESCAPE key
  1012                                  	;je	cp_esc
  1013 000004F8 7419                    	je	short cld_6 ; 19/10/2020
  1014 000004FA 24DF                    	and	al, 0DFh
  1015 000004FC 3C4E                    	cmp	al, 'N'
  1016 000004FE 740D                    	je	short cld_4
  1017 00000500 3C59                    	cmp	al, 'Y'
  1018 00000502 75EE                    	jne	short cld_3
  1019 00000504 BE[A45C]                	mov	si, _msg_YES
  1020 00000507 E87416                  	call	print_msg
  1021                                  
  1022 0000050A E96425                  	jmp	edit_ext_table_create_x
  1023                                  cld_4:	
  1024 0000050D BE[AA5C]                	mov	si, _msg_NO
  1025 00000510 E86B16                  	call	print_msg
  1026                                  cld_6:
  1027                                  	;jmp	cp_esc
  1028                                  	; 19/10/2020
  1029 00000513 E9F1FE                  	jmp	A_42
  1030                                  cld_5:	
  1031 00000516 BE[1863]                	mov	si, msg_c_part_error
  1032 00000519 E86216                  	call	print_msg
  1033                                  
  1034                                  	; 21/03/2021
  1035                                  	;cmp	byte [ldrives], 3
  1036                                  	;;jna	short cld_2
  1037                                  	; 21/03/2021
  1038                                  	;jna	short ap_0
  1039                                  
  1040                                  	;mov	si, msg_c_ldd_error
  1041                                  	;call	print_msg
  1042                                  
  1043 0000051C EB10                    	jmp	short ap_0
  1044                                  
  1045                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1046                                  ; set active partition
  1047                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1048                                  ; 19/10/2020 
  1049                                  	
  1050                                  activate_partition:
  1051                                  	; 12/02/2019
  1052                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1053 0000051E E8B622                  	call	display_partition_table ; 12/03/2021
  1054                                  
  1055 00000521 803E[C86F]00            	cmp	byte [pcount], 0
  1056 00000526 7713                    	ja	short ap_1
  1057                                  
  1058 00000528 BE[185B]                	mov	si, msg_empty_pt
  1059 0000052B E85016                  	call	print_msg
  1060                                  ap_0:
  1061 0000052E BE[C755]                	mov	si, msg_press_any_key
  1062 00000531 E84A16                  	call	print_msg
  1063                                  
  1064 00000534 30E4                    	xor	ah, ah
  1065 00000536 CD16                    	int	16h
  1066                                  ap_5:
  1067                                  	;jmp	ap_esc
  1068                                  	; 19/10/2020
  1069 00000538 E9CCFE                  	jmp	A_42
  1070                                  
  1071                                  ap_1:
  1072                                  	; Set valid_ppnums (MBR partition IDs) list
  1073 0000053B BE[A457]                	mov	si, MasterBootBuff+pTableOffset ; MasterBootBuff+446
  1074 0000053E BB[226F]                	mov	bx, valid_ppnums
  1075 00000541 B104                    	mov	cl, 4
  1076                                  ap_2:
  1077 00000543 8A4404                  	mov	al, [si+ptFileSystemID]
  1078 00000546 8807                    	mov	[bx], al
  1079 00000548 FEC9                    	dec	cl
  1080 0000054A 7406                    	jz	short ap_3
  1081 0000054C 43                      	inc	bx
  1082 0000054D 83C610                  	add	si, 16
  1083 00000550 EBF1                    	jmp	short ap_2
  1084                                  ap_3:
  1085 00000552 BE[975D]                	mov	si, msg_enter_pn_to_act
  1086 00000555 E82616                  	call	print_msg
  1087                                  ap_getchar:
  1088 00000558 30E4                    	xor	ah, ah
  1089 0000055A CD16                    	int	16h
  1090                                  	
  1091                                  	; 19/10/2020
  1092 0000055C 3C1B                    	cmp	al, 27
  1093                                  	;je	ap_esc
  1094 0000055E 74D8                    	je	short ap_5
  1095                                  
  1096                                  	;cmp	al, '0'
  1097                                  	;;je	ap_esc
  1098                                  	;je	short ap_5
  1099                                  
  1100 00000560 3C31                    	cmp	al, '1'
  1101 00000562 72F4                    	jb	short ap_getchar
  1102 00000564 3C34                    	cmp	al, '4'
  1103 00000566 77F0                    	ja	short ap_getchar
  1104                                  
  1105 00000568 30E4                    	xor	ah, ah
  1106 0000056A 89C2                    	mov	dx, ax
  1107                                  	
  1108 0000056C 80EA31                  	sub	dl, '1'
  1109 0000056F 89D6                    	mov	si, dx
  1110 00000571 38A4[226F]              	cmp	byte [si+valid_ppnums], ah  ; 0
  1111 00000575 76E1                    	jna	short ap_getchar ; Empty partition table entry, it is not shown
  1112                                  
  1113 00000577 BB0700                  	mov	bx, 07h
  1114 0000057A B409                    	mov	ah, 09h
  1115 0000057C B90100                  	mov	cx, 1
  1116 0000057F CD10                    	int	10h
  1117                                  
  1118 00000581 BE[A457]                	mov	si, MasterBootBuff+pTableOffset
  1119 00000584 BF[806F]                	mov	di, part_table_boot_ind ; (**)
  1120                                  
  1121                                  	; Clear all of possible active partition flags
  1122 00000587 8834                    	mov	[si], dh ; 0
  1123 00000589 887410                  	mov	[si+16], dh ; 0
  1124 0000058C 887420                  	mov	[si+32], dh ; 0
  1125 0000058F 887430                  	mov	[si+48], dh ; 0
  1126                                  
  1127                                  	; This may not be needed !? 
  1128                                  	; (**) (Primary partitions structure/list)
  1129 00000592 8835                    	mov	[di], dh ; 0	
  1130 00000594 887512                  	mov	[di+18], dh ; 0
  1131 00000597 887524                  	mov	[di+36], dh ; 0
  1132 0000059A 887536                  	mov	[di+54], dh ; 0
  1133                                  
  1134 0000059D 20D2                    	and 	dl, dl
  1135 0000059F 740D                    	jz	short ap_4
  1136                                  
  1137 000005A1 89D0                    	mov	ax, dx
  1138                                  
  1139 000005A3 C0E004                  	shl	al, 4 ; * 16
  1140 000005A6 01C6                    	add	si, ax
  1141                                  
  1142 000005A8 B012                    	mov	al, 18
  1143 000005AA F6E2                    	mul	dl ; 1 to 3
  1144 000005AC 01C7                    	add	di, ax
  1145                                  ap_4:
  1146                                  	; Then	set active partition as requested by user
  1147 000005AE C60480                  	mov	byte [si], 80h
  1148 000005B1 C60580                  	mov	byte [di], 80h ; (**)
  1149                                  
  1150 000005B4 BE[6B55]                	mov	si, CRLF ; Next line	
  1151 000005B7 E8C415                  	call	print_msg
  1152                                  
  1153                                  	; NOTE: Only the MBR buffer has been changed
  1154                                  	; (Masterboot sector will not be updated unless/till
  1155                                  	;  MBR partition table -and MBR code- will be written
  1156                                  	;  to disk image as result of 'write part. table' command.)
  1157                                  
  1158                                  	;; wait for 1 second
  1159                                  	;mov	ah, 02h
  1160                                  	;int	1Ah
  1161                                  	;mov	[GetChar], dh
  1162                                  ;ap_wait:
  1163                                  	;mov	ah, 02h
  1164                                  	;int	1Ah
  1165                                  	;cmp	dh, [GetChar]
  1166                                  	;je	short ap_wait
  1167                                  
  1168                                  	; 17/10/2020
  1169 000005BA E94AFE                  	jmp	A_42 ; display partition table again
  1170                                  
  1171                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1172                                  ; delete selected partition
  1173                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1174                                  ; 19/10/2020
  1175                                  
  1176                                  delete_partition:
  1177                                  	; 10/02/2019
  1178                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1179 000005BD E81722                  	call	display_partition_table ; 12/03/2021
  1180                                  
  1181 000005C0 803E[C86F]00            	cmp	byte [pcount], 0
  1182 000005C5 7712                    	ja	short dp_1
  1183                                  
  1184 000005C7 BE[185B]                	mov	si, msg_empty_pt
  1185 000005CA E8B115                  	call	print_msg
  1186                                  
  1187 000005CD BE[C755]                	mov	si, msg_press_any_key
  1188 000005D0 E8AB15                  	call	print_msg
  1189                                  
  1190 000005D3 30E4                    	xor	ah, ah
  1191 000005D5 CD16                    	int	16h
  1192                                  
  1193 000005D7 EB73                    	jmp	short dp_esc
  1194                                  
  1195                                  dp_1:
  1196                                  	; Set valid_ppnums (MBR partition IDs) list
  1197 000005D9 BE[A457]                	mov	si, MasterBootBuff+pTableOffset ; MasterBootBuff+446
  1198 000005DC BB[226F]                	mov	bx, valid_ppnums
  1199 000005DF B104                    	mov	cl, 4
  1200                                  dp_2:
  1201 000005E1 8A4404                  	mov	al, [si+ptFileSystemID]
  1202 000005E4 8807                    	mov	[bx], al
  1203 000005E6 FEC9                    	dec	cl
  1204 000005E8 7406                    	jz	short dp_3
  1205 000005EA 43                      	inc	bx
  1206 000005EB 83C610                  	add	si, 16
  1207 000005EE EBF1                    	jmp	short dp_2
  1208                                  dp_3:
  1209 000005F0 BE[D35B]                	mov	si, msg_enter_pn_to_del
  1210 000005F3 E88815                  	call	print_msg
  1211                                  dp_getchar1:
  1212 000005F6 30E4                    	xor	ah, ah
  1213 000005F8 CD16                    	int	16h
  1214                                  	
  1215                                  	; 19/10/2020
  1216 000005FA 3C1B                    	cmp	al, 27
  1217 000005FC 744E                    	je	short dp_esc
  1218 000005FE 3C30                    	cmp	al, '0'
  1219 00000600 744A                    	je	short dp_esc
  1220                                  	;cmp	al, '1'
  1221 00000602 72F2                    	jb	short dp_getchar1
  1222 00000604 3C34                    	cmp	al, '4'
  1223 00000606 77EE                    	ja	short dp_getchar1
  1224                                  
  1225 00000608 30FF                    	xor	bh, bh
  1226 0000060A 88C3                    	mov	bl, al
  1227                                  	;dec	bl
  1228 0000060C 80EB31                  	sub	bl, '1'
  1229 0000060F 38BF[226F]              	cmp	byte [bx+valid_ppnums], bh ; 0 ; 12/02/2019
  1230 00000613 76E1                    	jna	short dp_getchar1  ; Empty partition table entry, it is not shown
  1231                                  	
  1232 00000615 881E[2D6F]              	mov	[del_part_num], bl ; Selected partition number to be deleted.
  1233 00000619 A2[F75B]                	mov	[chr_del_pnum1], al ; Partition number for "Enter ..." text
  1234 0000061C A2[995C]                	mov	[chr_del_pnum2], al ; Partition number for "Do you want ..." text
  1235                                  
  1236 0000061F BE[F75B]                	mov	si, chr_del_pnum1 ; write partition number (user input)
  1237 00000622 E85915                  	call	print_msg
  1238                                  
  1239                                  	;xor	al, al
  1240 00000625 A2[F75B]                	mov	[chr_del_pnum1], al ; 0 ; reset
  1241                                  
  1242 00000628 BE[FB5B]                	mov	si, msg_delete_partition_q ; question for deleting (with warning)
  1243 0000062B E85015                  	call	print_msg
  1244                                  
  1245                                  dp_getchar2:
  1246 0000062E 30E4                    	xor	ah, ah
  1247 00000630 CD16                    	int	16h
  1248                                  
  1249 00000632 3C1B                    	cmp	al, 27
  1250 00000634 7416                    	je	short dp_esc
  1251                                  
  1252 00000636 24DF                    	and	al, 0DFh
  1253 00000638 3C59                    	cmp	al, 'Y'
  1254 0000063A 7413                    	je	short dp_yes
  1255 0000063C 3C4E                    	cmp	al, 'N'
  1256 0000063E 75EE                    	jne	short dp_getchar2
  1257                                  dp_no:
  1258 00000640 BE[AB5C]                	mov	si, msg_NO ;  Write 'NO' (it may be shown for a moment)
  1259 00000643 E83815                  	call	print_msg
  1260                                  	
  1261 00000646 BE[6B55]                	mov	si, CRLF  ; Next line
  1262 00000649 E83215                  	call	print_msg
  1263                                  	
  1264                                  	;jmp	short dp_esc
  1265                                  
  1266                                  ;cp_esc:
  1267                                  ;ap_esc:
  1268                                  ;wptmbr_esc:
  1269                                  dp_esc:
  1270                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1271                                  	;call	display_partition_table
  1272                                  	;jmp	A_38 ; 17/10/2020
  1273                                  
  1274                                  	; 19/10/2020
  1275 0000064C E9B8FD                  	jmp	A_42
  1276                                  
  1277                                  dp_yes:
  1278 0000064F BE[A55C]                	mov	si, msg_YES ;  Write 'YES' (it may be shown for a moment)
  1279 00000652 E82915                  	call	print_msg
  1280                                  
  1281 00000655 BF[A457]                	mov	di, MasterBootBuff+pTableOffset
  1282 00000658 A0[2D6F]                	mov	al, [del_part_num]
  1283 0000065B 20C0                    	and 	al, al
  1284 0000065D 7406                    	jz	short dp_4
  1285 0000065F 98                      	cbw
  1286                                  	;xor	ah, ah
  1287 00000660 C0E004                  	shl	al, 4 ; * 16
  1288 00000663 01C7                    	add	di, ax
  1289                                  dp_4:
  1290 00000665 BE[6B55]                	mov	si, CRLF ; Next line
  1291 00000668 E81315                  	call	print_msg
  1292                                  
  1293                                  	; 27/02/2019
  1294 0000066B 807D0405                	cmp	byte [di+ptFileSystemID], 05h ; EXTENDED (CHS)  
  1295                                  	;jne	short dp_5
  1296 0000066F 7406                    	je	short dp_6
  1297                                  	; 24/10/2020
  1298 00000671 807D040F                	cmp	byte [di+ptFileSystemID], 0Fh ; EXTENDED (LBA)
  1299 00000675 7545                    	jne	short dp_5
  1300                                  dp_6:
  1301 00000677 3806[0E6D]              	cmp	byte [ldrives], al ; 0
  1302 0000067B 763F                    	jna	short dp_5
  1303                                  
  1304 0000067D BE[1B5F]                	mov	si, msg_ext_part_del_error
  1305 00000680 E8FB14                  	call	print_msg
  1306 00000683 BE[5B5F]                	mov	si, msg_cancel_continue
  1307 00000686 E8F514                  	call	print_msg
  1308                                       	
  1309 00000689 30E4                    	xor	ah, ah
  1310 0000068B CD16                    	int	16h
  1311                                  	
  1312 0000068D 3C1B                    	cmp	al, 27 ; ESCape
  1313 0000068F 74BB                    	je	short dp_esc
  1314                                  
  1315 00000691 E8282A                  	call	delete_logical_drives
  1316                                  	
  1317                                  	; 28/02/2019
  1318 00000694 803E[0E6D]01            	cmp	byte [ldrives], 1
  1319 00000699 73B1                    	jnb	short dp_esc
  1320                                  
  1321                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1322 0000069B E83921                  	call	display_partition_table ; 12/03/2021
  1323                                  
  1324 0000069E BE[EE5F]                	mov	si, msg_delete_ext_part
  1325 000006A1 E8DA14                  	call	print_msg
  1326                                  
  1327                                  dp_ask_again:
  1328 000006A4 28E4                    	sub	ah, ah
  1329 000006A6 CD16                    	int	16h
  1330                                  
  1331 000006A8 3C1B                    	cmp	al, 27 ; ESCape
  1332 000006AA 74A0                    	je	short dp_esc	
  1333                                  
  1334 000006AC 3C0D                    	cmp	al, 13 ; ENTER/CR
  1335 000006AE 75F4                    	jne	short dp_ask_again
  1336                                  
  1337 000006B0 BF[A457]                	mov	di, MasterBootBuff+pTableOffset
  1338 000006B3 A0[2D6F]                	mov	al, [del_part_num]
  1339 000006B6 98                      	cbw
  1340 000006B7 C0E004                  	shl	al, 4 ; * 16
  1341 000006BA 01C7                    	add	di, ax
  1342                                  dp_5:
  1343 000006BC 31C0                    	xor	ax, ax
  1344                                  
  1345                                  	; clear partition table entry in MBR buffer
  1346 000006BE B90800                  	mov	cx, 8
  1347 000006C1 F3AB                    	rep	stosw
  1348                                  	
  1349                                  	; NOTE: Only the MBR buffer will be cleared
  1350                                  	; (Masterboot sector will not be updated unless/till
  1351                                  	;  MBR partition table -and MBR code- will be written
  1352                                  	;  to disk image as result of 'write part. table' command.)
  1353                                  
  1354 000006C3 E924FB                  	jmp	A_21 ; 17/10/2020
  1355                                   	 
  1356                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1357                                  ; write partition table (and MBR code) onto disk
  1358                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1359                                  ; 18/10/2020
  1360                                  
  1361                                  write_pt_mbr:
  1362                                  	; 18/10/2020 (fdisk3.s)
  1363                                  	; 11/02/2019 (hdimage.s)
  1364                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1365 000006C6 E80E21                  	call	display_partition_table ; 12/03/2021
  1366                                  
  1367 000006C9 BE[AF5C]                	mov	si, msg_write_masterboot_sector
  1368 000006CC E8AF14                  	call	print_msg
  1369                                  
  1370 000006CF A2[FE6C]                	mov	[GetChar], al ; 0
  1371                                  
  1372 000006D2 BE[925D]                	mov	si, option_input
  1373 000006D5 E8A614                  	call	print_msg
  1374                                  
  1375 000006D8 B403                    	mov	ah, 3
  1376                                  	;mov	bx, 7
  1377 000006DA CD10                    	int	10h ; Return Cursor Position
  1378                                  	; DL = Column
  1379                                  	
  1380 000006DC FECA                    	dec	dl ; previous char ; ']'
  1381 000006DE FECA                    	dec	dl ; previous char ; '[ ]'
  1382                                  
  1383 000006E0 B402                    	mov	ah, 2
  1384                                  	;mov	bx, 7
  1385 000006E2 CD10                    	int	10h ; Set Cursor Position
  1386                                  
  1387                                  	; write char at current cursor position
  1388                                  
  1389 000006E4 B030                    	mov	al, '0' ; Write default char
  1390                                  
  1391                                  	;;mov	bx, 07h
  1392 000006E6 B409                    	mov	ah, 09h
  1393 000006E8 B90100                  	mov	cx, 1
  1394 000006EB CD10                    	int	10h
  1395                                  
  1396                                  wptmbr_getchar:
  1397 000006ED 30E4                    	xor	ah, ah
  1398 000006EF CD16                    	int	16h
  1399                                  
  1400 000006F1 3C1B                    	cmp	al, 1Bh ; 27
  1401                                  	;je	wptmbr_esc ; 19/10/2020
  1402 000006F3 0F8410FD                	je	A_42
  1403                                  
  1404 000006F7 3C0D                    	cmp	al, 0Dh ; 13
  1405 000006F9 7414                    	je	short wptmbr_1
  1406                                                  
  1407 000006FB 3C31                    	cmp	al, '1'
  1408 000006FD 72EE                    	jb	short wptmbr_getchar
  1409                                  
  1410 000006FF 3C32                    	cmp	al, '2'
  1411 00000701 77EA                    	ja 	short wptmbr_getchar
  1412                                  
  1413 00000703 A2[FE6C]                	mov	[GetChar], al
  1414                                  
  1415                                  	;;mov	bx, 07h
  1416 00000706 B409                    	mov	ah, 09h
  1417 00000708 B90100                  	mov	cx, 1
  1418 0000070B CD10                    	int	10h
  1419 0000070D EBDE                    	jmp	short wptmbr_getchar
  1420                                  
  1421                                  wptmbr_1:
  1422 0000070F 803E[FE6C]00            	cmp	byte [GetChar], 0
  1423 00000714 76D7                    	jna	short wptmbr_getchar
  1424                                  
  1425 00000716 BE[605D]                	mov	si, msg_writing_ptable
  1426 00000719 E86214                  	call	print_msg
  1427                                  
  1428 0000071C 803E[FE6C]32            	cmp	byte [GetChar], '2'
  1429 00000721 751F                    	jne	short wptmbr_2 ; Do not write Singlix MBR code
  1430                                  
  1431                                  	; Write CHS parameters in Singlix (FS specific) MBR
  1432                                  	
  1433 00000723 BE[5731]                	mov	si, TRDOS386_MASTERBOOT_SECTOR
  1434 00000726 B9DF00                  	mov	cx, 446/2 ; Copy Singlix FS 1 MBR code
  1435                                  			  ; except Partition Table
  1436 00000729 BF[E655]                	mov	di, MasterBootBuff
  1437 0000072C F3A5                    	rep	movsw
  1438                                  	
  1439                                  	; This (Below) is not needed; because, if MBR magicword
  1440                                  	; would not be 0AA55h, we would not be able to come here!
  1441                                  	;;add	di, 64  ; skip partition table	
  1442                                  	;;mov	ax, 0AA55h
  1443                                  	;;stosw
  1444                                  	;mov 	word [MBIDCode], 0AA55h
  1445                                  
  1446                                  	; 12/02/2019
  1447                                  	; Copy CHS parameters to Singlix MBR (on disk)
  1448                                  	
  1449 0000072E BF[8A57]                	mov	di, MasterBootBuff+420
  1450                                  
  1451 00000731 A1[6E3F]                	mov	ax, [cylinders]
  1452 00000734 AB                      	stosw 			; cylinders
  1453 00000735 A1[6C3F]                	mov	ax, [heads]
  1454 00000738 AB                      	stosw 			; heads
  1455 00000739 A1[6A3F]                	mov	ax, [sectors]
  1456 0000073C AB                      	stosw 			; sectors
  1457                                  
  1458                                  	; 13/03/2021
  1459                                  	; copy 32 bit disk size (total LBA sectors) to MBR offset 426
  1460 0000073D BE[4268]                	mov	si, disksize
  1461 00000740 A5                      	movsw
  1462 00000741 A5                      	movsw
  1463                                  
  1464                                  wptmbr_2:
  1465                                  	;xor	ax, ax ; 0
  1466                                  	;xor	dx, dx ; 0
  1467                                  	;; DX_AX = Masterboot Sector = 0
  1468                                  	;mov	bx, MasterBootBuff
  1469                                  	;; ES:BX = Sector Buffer
  1470                                  	;call	write_hd_sector
  1471                                  	;jc	short print_error_code 
  1472                                  			; ! display error msg and then exit !
  1473                                  
  1474 00000742 C606[4168]05            	mov	byte [rcnt], 5  ; retry count
  1475                                  
  1476 00000747 BB[E655]                	mov	bx, MasterBootBuff
  1477                                  
  1478 0000074A B90100                  	mov	cx, 1	; cylinder = 0
  1479                                  			; sector = 1
  1480 0000074D B600                    	mov	dh, 0	; head = 0
  1481 0000074F 8A16[3E68]              	mov	dl, [DrvNum]
  1482                                  wptmbr_3:
  1483 00000753 B80103                  	mov	ax, 0301h ; write one sector
  1484 00000756 CD13                    	int	13h	
  1485 00000758 730C                    	jnc     short wptmbr_4
  1486                                               
  1487 0000075A FE0E[4168]              	dec	byte [rcnt]
  1488 0000075E 7431                    	jz	short print_error_code
  1489                                          
  1490 00000760 30E4                    	xor	ah, ah
  1491                                  	;mov	dl, [DrvNum]
  1492 00000762 CD13                    	int	13h	; BIOS Service func (ah) = 0
  1493                                  			; Reset disk system
  1494 00000764 EBED                    	jmp	short wptmbr_3
  1495                                  
  1496                                  wptmbr_4:
  1497 00000766 BE[895D]                	mov	si, _msg_OK
  1498 00000769 E81214                  	call	print_msg
  1499                                  
  1500                                  	; wait for 1 second
  1501 0000076C B402                    	mov	ah, 02h
  1502 0000076E CD1A                    	int	1Ah
  1503 00000770 8836[FE6C]              	mov	[GetChar], dh
  1504                                  wptmbr_wait:
  1505 00000774 B402                    	mov	ah, 02h
  1506 00000776 CD1A                    	int	1Ah
  1507 00000778 3A36[FE6C]              	cmp	dh, [GetChar]
  1508 0000077C 74F6                    	je	short wptmbr_wait
  1509                                  	
  1510 0000077E BE[C755]                	mov	si, msg_press_any_key
  1511 00000781 E8FA13                  	call	print_msg
  1512                                                  
  1513 00000784 30E4                    	xor	ah, ah	; "Press any key to continue"
  1514 00000786 CD16                    	int	16h
  1515                                  
  1516 00000788 BE[6B55]                	mov	si, CRLF
  1517 0000078B E8F013                  	call	print_msg
  1518                                  
  1519                                  	;jmp	wptmbr_esc
  1520                                  	; 19/10/2020
  1521 0000078E E976FC                  	jmp	A_42
  1522                                  
  1523                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1524                                  ; print error message and exit
  1525                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1526                                  ; 18/10/2020 (fdisk3.s)
  1527                                  	
  1528                                  print_error_code:
  1529                                  	; 25/02/2019 (hdimage.s)
  1530                                  
  1531 00000791 88E0                    	mov	al, ah	; error code
  1532 00000793 E8BE14                  	call	bin_to_hex
  1533 00000796 A3[7955]                	mov 	[error_code], ax
  1534                                  
  1535 00000799 BE[6B55]                	mov	si, CRLF
  1536 0000079C E8DF13                  	call	print_msg
  1537                                  
  1538 0000079F BE[6E55]                	mov	si, Msg_Error
  1539 000007A2 E8D913                  	call	print_msg
  1540                                  	
  1541 000007A5 CD20                    	int	20h	; Exit
  1542                                  
  1543                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1544                                  ; exit, print_msg & exit
  1545                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1546                                  ; 19/10/2020
  1547                                  
  1548                                  _crlf_exit:
  1549 000007A7 BE[6B55]                	mov	si, CRLF
  1550                                  _p_exit:
  1551                                  	; 11/10/2020
  1552 000007AA E8D113                  	call	print_msg
  1553                                  _exit:
  1554 000007AD B8004C                  	mov	ax, 4C00h		; terminate
  1555 000007B0 CD21                    	int	21h
  1556                                  
  1557                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1558                                  ; display create partition menu & get partition type input
  1559                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1560                                  ; 19/10/2020
  1561                                  
  1562                                  create_partition_input:
  1563                                  	; 15/02/2019
  1564                                  	; clear screen
  1565 000007B2 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  1566 000007B5 CD10                    	int	10h
  1567                                  	
  1568 000007B7 BE[6545]                	mov	si, msg_create_partition_h ; header
  1569 000007BA E8C113                  	call	print_msg
  1570 000007BD BE[5A46]                	mov	si, msg_create_partition_m ; menu
  1571 000007C0 E8BB13                  	call	print_msg
  1572                                  cpi_1:
  1573 000007C3 30E4                    	xor	ah, ah
  1574 000007C5 CD16                    	int	16h
  1575 000007C7 3C1B                    	cmp	al, 27 ; ESC key	
  1576 000007C9 7445                    	je	short cpi_4  ; 25/02/2019
  1577 000007CB 3C30                    	cmp	al, '0'
  1578 000007CD 7441                    	je	short cpi_4  ; 25/02/2019
  1579 000007CF 72F2                    	jb	short cpi_1
  1580 000007D1 3C34                    	cmp	al, '4'
  1581 000007D3 77EE                    	ja	short cpi_1
  1582                                  
  1583 000007D5 30E4                    	xor	ah, ah
  1584 000007D7 2C30                    	sub	al, '0'
  1585                                  
  1586                                  	;mov	[pp_type], al
  1587                                  
  1588                                  	;mov	byte [pp_type_user], 0
  1589                                  
  1590 000007D9 3C01                    	cmp	al, 1 ; DOS partition
  1591 000007DB 7536                    	jne	short cpi_5 ; ah = 0 
  1592                                  			    ; (al = 2 -> singlix, al = 3 -> retro unix)
  1593                                  cpi_2:
  1594                                  	; clear screen
  1595 000007DD B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  1596 000007E0 CD10                    	int	10h
  1597                                  	
  1598 000007E2 BE[1048]                	mov	si, msg_create_dos_partition_h ; header
  1599 000007E5 E89613                  	call	print_msg
  1600 000007E8 BE[E44B]                	mov	si, msg_create_dos_partition_m ; menu
  1601 000007EB E89013                  	call	print_msg
  1602                                  cpi_3:
  1603 000007EE 30E4                    	xor	ah, ah
  1604 000007F0 CD16                    	int	16h
  1605 000007F2 3C1B                    	cmp	al, 27 ; ESC key
  1606 000007F4 741A                    	je	short cpi_4
  1607 000007F6 3C30                    	cmp	al, '0'
  1608 000007F8 7416                    	je	short cpi_4
  1609 000007FA 72F2                    	jb	short cpi_3
  1610 000007FC 3C33                    	cmp	al, '3'
  1611 000007FE 77EE                    	ja	short cpi_3
  1612                                  	
  1613 00000800 30E4                    	xor	ah, ah
  1614 00000802 2C30                    	sub	al, '0'
  1615 00000804 3C01                    	cmp	al, 1
  1616 00000806 7424                    	je	short cpi_6  ;	ah = 0 (al = primary dos partition)
  1617                                  
  1618                                  	;mov	byte [pp_type], 5
  1619                                  
  1620 00000808 3C02                    	cmp	al, 2
  1621 0000080A 7621                    	jna	short cpi_7
  1622                                  
  1623 0000080C B80600                  	mov	ax, 6	; ah = 0 (al = logical dos drive/partition)
  1624 0000080F C3                      	retn
  1625                                  
  1626                                  cpi_4:
  1627 00000810 31C0                    	xor	ax, ax	; ah = 0 (al = 0 -> ESCape/Cancel)
  1628 00000812 C3                      	retn
  1629                                  cpi_5:
  1630 00000813 3C04                    	cmp	al, 4	 ; option num. for partition type (user) input
  1631 00000815 7515                    	jne	short cpi_6
  1632                                  
  1633 00000817 E80F18                  	call	partition_type_input
  1634                                  	
  1635                                  	; 29/10/2020
  1636 0000081A 08C0                    	or	al, al
  1637                                  	;jz	short cpi_6 ; invalid (zero) input or ESC key
  1638 0000081C 74F2                    	jz	short cpi_4
  1639                                  
  1640 0000081E B404                    	mov	ah, 4 ; user/another type partition flag
  1641                                  	; al = Partition ID
  1642 00000820 50                      	push	ax
  1643 00000821 BE[C755]                	mov	si, msg_press_any_key 
  1644 00000824 E85713                  	call	print_msg
  1645 00000827 28E4                    	sub	ah, ah
  1646 00000829 CD16                    	int	16h
  1647 0000082B 58                      	pop	ax
  1648                                  cpi_6:
  1649 0000082C C3                      	retn
  1650                                  cpi_7:
  1651 0000082D B80500                  	mov	ax, 5	; ah = 0 (al = extended dos partition)
  1652 00000830 C3                      	retn
  1653                                  
  1654                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1655                                  ; create primary (dos or non-dos) partition
  1656                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1657                                  ; 19/10/2020 
  1658                                  ;	(This procedure must be called after 'find_part_free_space')
  1659                                  
  1660                                  create_primary_partition:  
  1661                                  	; 16/02/2019
  1662                                  
  1663                                  	; INPUT:
  1664                                  	;	none 
  1665                                  	;  (CHS parameters and free space calculation result will be used.) 
  1666                                  	;
  1667                                  	; OUTPUT:
  1668                                  	;	Partition table in MBR buffer will be updated.
  1669                                  	;
  1670                                  	; (Modified registers: ax, bx, cx, dx, si, di)
  1671                                  
  1672                                  	; Create primary dos or non-dos partition,
  1673                                  	; make partition table entry
  1674                                  
  1675                                  	; 19/10/2020
  1676 00000831 803E[C86F]00            	cmp	byte [pcount], 0  ; count of (valid) partitions
  1677 00000836 770A                    	ja	short cpp_0
  1678                                  
  1679                                  	; cylinder = 0, head = 1, sector = 1
  1680                                  	; LBA = (((cylinder*heads)+head)*sectors)+sector-1
  1681                                  
  1682 00000838 BE[A457]                	mov	si, MasterBootBuff+pTableOffset
  1683                                  
  1684 0000083B A1[6A3F]                	mov	ax, [sectors] ; LBA = 17 or 63
  1685 0000083E 31D2                    	xor	dx, dx
  1686 00000840 EB56                    	jmp	short cpp_4
  1687                                  cpp_0:
  1688                                  	; 16/02/2019
  1689 00000842 E8531F                  	call	get_first_free_pte
  1690                                  		 ; CX = First free PTE number, 0 to 3 
  1691                                  		 ;    (CX = 3 if there is not a free PTE, and CF = 1)
  1692                                  		 ;    ((But CF = 1 is not possible here because pcount < 4))
  1693                                   	 	 ; SI = PTE address/offset in MBR buffer
  1694                                  
  1695                                  	;mov	si, MasterBootBuff+pTableOffset
  1696                                  	;shl	cl, 4 ; * 16
  1697                                  	;add	si, cx
  1698                                  
  1699                                  	; 18/02/2019
  1700 00000845 8B3E[6670]              	mov	di, [c_fspc_offset]
  1701 00000849 8B9D[1670]              	mov	bx, [di+free_space.start]
  1702 0000084D A0[6C3F]                	mov	al, [heads]
  1703 00000850 F626[6A3F]              	mul	byte [sectors]
  1704 00000854 F7E3                    	mul	bx
  1705                                  		; DX:AX = LBA of start cylinder, head 0, sector 1
  1706                                  	
  1707 00000856 8A0E[6870]              	mov	cl, [cylinder_boundary]
  1708                                  
  1709                                  	;cmp	cl, 0 ; Default (partition size unit is one of C, G, M)
  1710                                  		      ; boundary alignment is forced as default
  1711                                  	;je	short cpp_4
  1712                                  
  1713                                  	; 20/02/2019
  1714                                  	;and	cl, cl
  1715                                  	;jz 	short cpp_1
  1716                                  
  1717 0000085A 80F959                  	cmp	cl, 'Y'
  1718 0000085D 7439                    	je	short cpp_4 ; cylinder boundary option (answer) = YES
  1719                                  
  1720 0000085F 80F94E                  	cmp	cl, 'N'
  1721 00000862 750A                    	jne	short cpp_1 ; cylinder boundary option (answer) = YES/NO
  1722                                  
  1723                                  	; cylinder boundary option (answer) = NO 
  1724 00000864 8B85[2070]              	mov	ax, [di+free_space.startsector]
  1725 00000868 8B95[2270]              	mov	dx, [di+free_space.startsector+2]
  1726 0000086C EB2A                    	jmp	short cpp_4
  1727                                  cpp_1:
  1728                                  	;cmp	cl, 27 ; ESCape
  1729                                  	;jne	short cpp_4 ; 'Y'
  1730                                  
  1731                                  	; check	cylinder boundary alignment of the start sector
  1732                                  
  1733                                  	; if start sector is not aligned, end sector must not be aligned
  1734                                  	; (this rule is valid for ESCape key from the user) 
  1735                                  
  1736 0000086E C606[6870]59            	mov	byte [cylinder_boundary], 'Y' ; YES for end sector check
  1737                                  
  1738 00000873 8B8D[2070]              	mov	cx, [di+free_space.startsector]
  1739                                  
  1740 00000877 09DB                    	or	bx, bx
  1741                                  
  1742 00000879 8B9D[2270]              	mov	bx, [di+free_space.startsector+2]
  1743                                  
  1744 0000087D 7508                    	jnz	short cpp_2 ; start cylinder > 0
  1745                                  
  1746                                  	;and	bx, bx
  1747                                  	;jnz	short cpp_3
  1748                                  
  1749 0000087F 3B0E[6A3F]              	cmp	cx, [sectors]
  1750 00000883 7413                    	je	short cpp_4 ; start sector is as aligned 
  1751 00000885 EB08                    	jmp	short cpp_3
  1752                                  cpp_2:
  1753 00000887 39C8                    	cmp	ax, cx
  1754 00000889 7504                    	jne	short cpp_3
  1755 0000088B 39DA                    	cmp	dx, bx
  1756 0000088D 7409                    	je	short cpp_4 
  1757                                  cpp_3:
  1758 0000088F 89C8                    	mov	ax, cx
  1759 00000891 89DA                    	mov	dx, bx
  1760 00000893 C606[6870]4E            	mov	byte [cylinder_boundary], 'N'
  1761                                  cpp_4:
  1762 00000898 894408                  	mov	[si+ptStartSector], ax
  1763 0000089B 89540A                  	mov	[si+ptStartSector+2], dx
  1764                                  
  1765                                  	; save start sector (for partition formatting procedure)
  1766 0000089E A3[D46C]                	mov	[pp_StartSector], ax
  1767 000008A1 8916[D66C]              	mov	[pp_StartSector+2], dx
  1768                                  
  1769                                  	; 14/03/2021
  1770 000008A5 8B0E[066D]              	mov	cx, [ppn_Sectors]
  1771 000008A9 8B1E[086D]              	mov	bx, [ppn_Sectors+2]
  1772                                  
  1773                                  	; 19/10/2020
  1774 000008AD 803E[C86F]00            	cmp	byte [pcount], 0
  1775 000008B2 775E                    	ja	short cpp_5
  1776                                  
  1777                                  	;xor	cx, cx
  1778                                  	;mov	[si+ptBeginCylinder], cx ; 0
  1779                                  	;inc	cl  ; 1
  1780                                  	;mov	[si+ptBeginSector], cl ; 1
  1781                                  	;mov	[si+ptBeginHead], cl ; 1
  1782                                  	; 14/03/2021
  1783 000008B4 C744030000              	mov	word [si+ptBeginCylinder], 0
  1784 000008B9 C6440201                	mov	byte [si+ptBeginSector], 1
  1785 000008BD C6440101                	mov	byte [si+ptBeginHead], 1
  1786                                  
  1787                                  	; set active partition flag
  1788                                  	;mov	byte [si+ptBootable], 80h ; bootable/active partition
  1789 000008C1 C60480                  	mov	byte [si], 80h ; bootable/active partition
  1790                                  
  1791                                  	; 14/03/2021
  1792                                  	; 18/02/2019
  1793                                  	;mov	cx, [ppn_Sectors]
  1794                                  	;mov	bx, [ppn_Sectors+2]
  1795                                  
  1796 000008C4 803E[DC6C]00            	cmp	byte [wholedisk], 0
  1797 000008C9 0F865401                	jna	cpp_12
  1798                                  
  1799                                  	; 26/10/2020
  1800 000008CD 01C8                    	add	ax, cx
  1801 000008CF 11DA                    	adc	dx, bx
  1802 000008D1 83E801                  	sub	ax, 1
  1803 000008D4 83DA00                  	sbb	dx, 0 
  1804                                  
  1805                                  	; 24/10/2020
  1806 000008D7 3B16[4868]              	cmp	dx, [chs_limit+2]
  1807 000008DB 7217                    	jb	short cpp_17
  1808 000008DD 7706                    	ja	short cpp_16
  1809 000008DF 3B06[4668]              	cmp	ax, [chs_limit]
  1810 000008E3 760F                    	jna	short cpp_17
  1811                                  cpp_16:
  1812 000008E5 C64405FE                	mov	byte [si+ptEndHead], 0FEh
  1813 000008E9 C64406FF                	mov	byte [si+ptEndSector], 0FFh
  1814 000008ED C64407FF                	mov	byte [si+ptEndCylinder], 0FFh
  1815 000008F1 E9C801                  	jmp	cpp_15
  1816                                  cpp_17:
  1817 000008F4 A0[6C3F]                	mov	al, [heads]
  1818 000008F7 FEC8                    	dec	al
  1819 000008F9 884405                  	mov	[si+ptEndHead], al
  1820 000008FC A0[6A3F]                	mov	al, [sectors]
  1821 000008FF 884406                  	mov	[si+ptEndSector], al
  1822 00000902 A1[6E3F]                	mov	ax, [cylinders]
  1823 00000905 48                      	dec	ax
  1824 00000906 884407                  	mov	[si+ptEndCylinder], al
  1825 00000909 C0E406                  	shl	ah, 6
  1826 0000090C 086406                  	or	[si+ptEndSector], ah
  1827                                  
  1828                                  	;jmp	cpp_16
  1829 0000090F E9AA01                  	jmp	cpp_15 ; 06/03/2019
  1830                                  cpp_5:
  1831                                  	; 18/02/2019
  1832 00000912 803E[6870]59            	cmp	byte [cylinder_boundary], 'Y'
  1833 00000917 753D                    	jne	short cpp_7
  1834                                  
  1835 00000919 30DB                    	xor	bl, bl ; head  = 0
  1836                                  
  1837 0000091B 8B8D[1670]              	mov	cx, [di+free_space.start]
  1838                                  
  1839                                  	; 06/03/2019
  1840                                  	;or	ax, ax
  1841                                  	;jnz	short cpp_6
  1842                                  
  1843                                  	;and	cx, cx  ; start cylinder = 0 ?
  1844                                  	;jnz	short cpp_6
  1845                                  
  1846 0000091F 09C8                    	or	ax, cx
  1847                                  	;jnz	short cpp_6
  1848 00000921 740B                    	jz	short cpp_24 ; 31/10/2020
  1849                                  
  1850                                  	; 31/10/2020
  1851 00000923 A0[6A3F]                	mov	al, [sectors]
  1852 00000926 F626[6C3F]              	mul	byte [heads]
  1853 0000092A F7E1                    	mul	cx
  1854                                  	; dx:ax = LBA sector address
  1855                                  	; bl = head = 0
  1856                                  	; cx = cylinder number
  1857                                  	; ax = sector number
  1858 0000092C EB07                    	jmp	short cpp_6
  1859                                  cpp_24:
  1860 0000092E A1[6A3F]                	mov	ax, [sectors]
  1861                                  	; cylinder 0, head 1, sector 1 (LBA = 17 or 63)
  1862 00000931 FEC3                    	inc	bl  ; head = 1
  1863 00000933 31D2                    	xor	dx, dx ; 0
  1864                                  cpp_6:
  1865                                  	; 31/10/2020
  1866 00000935 894408                  	mov	[si+ptStartSector], ax
  1867 00000938 89540A                  	mov	[si+ptStartSector+2], dx
  1868                                  
  1869 0000093B A3[D46C]                	mov	[pp_StartSector], ax
  1870 0000093E 8916[D66C]              	mov	[pp_StartSector+2], dx
  1871                                  
  1872 00000942 09C9                    	or	cx, cx  ; start cylinder ?
  1873 00000944 7508                    	jnz	short cpp_25 ; > 0
  1874                                  	
  1875                                  	;and	bl, bl  ; head = 0 ?
  1876                                  	;jz	short cpp_25
  1877                                  
  1878                                  	; cylinder = 0, head = 1, dx:ax = [sectors]
  1879                                  
  1880                                  	;sub	[pp_Sectors], ax
  1881                                  	;sbb	[pp_Sectors+2], cx ; 0
  1882                                  
  1883 00000946 2906[066D]              	sub	[ppn_Sectors], ax
  1884 0000094A 190E[086D]              	sbb	[ppn_Sectors+2], cx ; 0
  1885                                  cpp_25:
  1886 0000094E 89C8                    	mov	ax, cx
  1887                                  	; 29/10/2020
  1888 00000950 C6440201                	mov	byte [si+ptBeginSector], 1 ; sector = 1	
  1889 00000954 EB16                    	jmp	short cpp_8
  1890                                  cpp_7:
  1891                                  	; 18/02/2019
  1892                                  
  1893                                  	; [wholedisk] = 0
  1894                                  
  1895                                  	; Fix partition size for MSDOS 3.3 (Retro DOS 3.0) compatibility.
  1896                                  	; (DOS partition size will be changed -down- to 65535 sectors,
  1897                                  	; if it is 65536 sectors.)
  1898                                  	
  1899 00000956 E87301                  	call	fix_32mb_dos_psize
  1900                                  		; bx:cx = [ppn_sectors] = partition size
  1901                                  		; dx:ax = start sector's LBA 
  1902                                  
  1903                                  	;cylinder = LBA / (heads_per_cylinder * sectors_per_track)
  1904                                  	;temp = LBA % (heads_per_cylinder * sectors_per_track)
  1905                                  	;head = temp / sectors_per_track
  1906                                  	;sector = temp % sectors_per_track + 1
  1907                                  	
  1908                                  	; Convert LBA sector address to CHS parameters
  1909 00000959 8B0E[6A3F]              	mov	cx, [sectors]
  1910 0000095D E81D03                  	call	div32
  1911                                  	; BX = Sector number - 1
  1912 00000960 FEC3                    	inc	bl ; sector number (1 based)
  1913 00000962 885C02                  	mov	[si+ptBeginSector], bl	
  1914                                  	; DX_AX = cylinders * heads + head
  1915 00000965 8B0E[6C3F]              	mov	cx, [heads]
  1916 00000969 E81103                  	call	div32
  1917                                  	; ax = cylinder
  1918                                  	; bl = head
  1919                                  cpp_8:
  1920                                  	; 24/10/2020
  1921                                  	;mov	bh, 1  ; [si+ptBeginSector]
  1922 0000096C 3DFF03                  	cmp	ax, 1023  ; CHS limit
  1923 0000096F 7609                    	jna	short cpp_18	
  1924                                  	; > CHS limit
  1925 00000971 B8FF03                  	mov	ax, 1023 ; cylinder
  1926 00000974 B3FE                    	mov	bl, 0FEh ; 254 (head)
  1927                                  	;mov	bh, 3Fh ; 63 (sector)
  1928                                  	; 26/10/2020
  1929 00000976 C644023F                	mov	byte [si+ptBeginSector], 3Fh
  1930                                  cpp_18:
  1931                                  	; BL = Head number
  1932 0000097A 885C01                  	mov	[si+ptBeginHead], bl
  1933                                  	; AX = Cylinder number
  1934                                  	;and	ax, 1023
  1935 0000097D 884403                  	mov	[si+ptBeginCylinder], al
  1936 00000980 C0E406                  	shl	ah, 6
  1937                                  	; 24/10/2020
  1938                                  	;or	ah, bh	; bh = sector number
  1939                                  	; 26/10/2020
  1940 00000983 086402                  	or	[si+ptBeginSector], ah
  1941                                  	;mov	[si+ptBeginSector], ah
  1942                                  
  1943                                  	; clear active partition flag (for now)
  1944                                  	;mov	byte [si+ptBootable], 0 ; not bootable/active partition
  1945 00000986 C60400                  	mov	byte [si], 0 ; not bootable/active partition
  1946                                  
  1947                                  	;mov	di, [c_fspc_offset]
  1948                                  
  1949 00000989 803E[6870]59            	cmp	byte [cylinder_boundary], 'Y'
  1950 0000098E 0F858000                	jne	cpp_11
  1951                                  
  1952 00000992 8A0E[6C3F]              	mov	cl, [heads]
  1953 00000996 A0[6A3F]                	mov	al, [sectors]
  1954 00000999 88C5                    	mov	ch, al
  1955 0000099B F6E1                    	mul	cl	
  1956                                  	; ax = heads*sectors
  1957                                  
  1958 0000099D 8B9D[1870]              	mov	bx, [di+free_space.end]	; end cylinder of the partition
  1959                                  
  1960 000009A1 803E[DC6C]00            	cmp	byte [wholedisk], 0 ; entire free space ?
  1961 000009A6 7721                    	ja	short cpp_10
  1962                                  
  1963 000009A8 89C3                    	mov	bx, ax
  1964 000009AA A1[066D]                	mov	ax, [ppn_Sectors]
  1965 000009AD 8B16[086D]              	mov	dx, [ppn_Sectors+2]
  1966 000009B1 0306[D46C]              	add	ax, [pp_StartSector]
  1967 000009B5 1316[D66C]              	adc	dx, [pp_StartSector+2]
  1968 000009B9 83E801                  	sub	ax, 1
  1969 000009BC 83DA00                  	sbb	dx, 0
  1970                                  		; dx:ax = end sector
  1971 000009BF F7F3                    	div	bx
  1972                                  		; ax = cylinder number
  1973                                  	; 31/10/2020
  1974                                  	;and	dx, dx
  1975                                  	;jz	short cpp_9
  1976                                  	;inc	ax ; + 1 (because of remainder > 0)
  1977                                  cpp_9:	
  1978 000009C1 93                      	xchg	ax, bx
  1979                                  		; bx = end cylinder
  1980                                  		; ax = heads*sectors
  1981                                  	; free space limit check
  1982 000009C2 3B9D[1870]              	cmp	bx, [di+free_space.end]
  1983 000009C6 7601                    	jna	short cpp_10 ; ok
  1984                                  	; end cylinder is out of free space
  1985 000009C8 4B                      	dec	bx  ; decrease end cylinder number
  1986                                  cpp_10: 
  1987 000009C9 F7E3                    	mul	bx
  1988                                  		 ; dx:ax = (end cylinder)*heads*sectors
  1989 000009CB 52                      	push	dx ; **
  1990 000009CC 50                      	push	ax ; *
  1991                                  
  1992                                  	; 24/10/2020
  1993 000009CD 81FBFF03                	cmp	bx, 1023  ; CHS limit
  1994 000009D1 7606                    	jna	short cpp_19	
  1995                                  	; > CHS limit
  1996 000009D3 BBFF03                  	mov	bx, 1023 ; cylinder
  1997                                  	;mov	cl, 0FFh ; 255 (head+1)
  1998                                  	;mov	ch, 3Fh ; 63 (sector)
  1999 000009D6 B9FF3F                  	mov	cx, 3FFFh
  2000                                  cpp_19:
  2001 000009D9 FEC9                    	dec	cl ; heads - 1 = end head
  2002                                  
  2003 000009DB 884C05                  	mov	[si+ptEndHead], cl
  2004                                  	; 26/10/2020
  2005                                  	;mov	al, [sectors]
  2006                                  	; 31/10/2020
  2007 000009DE 88E8                    	mov	al, ch
  2008 000009E0 885C07                  	mov	[si+ptEndCylinder], bl
  2009                                  	;mov	bl, al
  2010                                  	;shl	bh, 6 ; shift high bytes (2 bits) of end cyl num
  2011                                  	;	      ; to 6 bits left	
  2012                                  	;or	bh, bl ; combine high bits of end cyl num and end sector
  2013 000009E3 C0E706                  	shl	bh, 6
  2014 000009E6 08EF                    	or	bh, ch ; ch = end sector (= sectors)
  2015 000009E8 887C06                  	mov	[si+ptEndSector], bh
  2016                                  
  2017                                  	; 24/10/2020
  2018                                  	;mov	bl, [sectors]
  2019                                  	;xor	bh, bh ; clear bh
  2020 000009EB 8B1E[6A3F]              	mov	bx, [sectors] ; 17 or 63
  2021                                  
  2022 000009EF FECB                    	dec	bl ; sectors - 1 ; 22/02/2019
  2023 000009F1 F6E1                    	mul	cl ; sectors * [end head]
  2024 000009F3 5A                      	pop	dx ; *
  2025                                  	; 22/02/2019
  2026 000009F4 31C9                    	xor	cx, cx
  2027 000009F6 01D0                    	add	ax, dx
  2028 000009F8 5A                      	pop	dx ; **
  2029 000009F9 11CA                    	adc	dx, cx ; 0
  2030 000009FB 01D8                    	add	ax, bx
  2031 000009FD 11CA                    	adc	dx, cx ; 0
  2032                                  	; dx:ax = ((([end cylinder]*heads)+[end head])*sectors)+sectors-1
  2033                                  
  2034                                  	; calculate aligned partition size in sectors
  2035 000009FF 89C1                    	mov	cx, ax
  2036 00000A01 89D3                    	mov	bx, dx
  2037 00000A03 83C101                  	add	cx, 1
  2038 00000A06 83D300                  	adc	bx, 0	
  2039 00000A09 2B4C08                  	sub	cx, [si+ptStartSector]
  2040 00000A0C 1B5C0A                  	sbb	bx, [si+ptStartSector+2]
  2041                                  		; bx:cx = partition size
  2042                                  	;mov	[ppn_Sectors], cx
  2043                                  	;mov	[ppn_Sectors+2], bx
  2044                                  	;jmp	cpp_16
  2045 00000A0F E9AA00                  	jmp	cpp_15 ; 06/03/2019
  2046                                  cpp_11:
  2047                                  	; 20/02/2019
  2048 00000A12 8B0E[066D]              	mov	cx, [ppn_Sectors]
  2049 00000A16 8B1E[086D]              	mov	bx, [ppn_Sectors+2]
  2050                                  
  2051                                  	;;mov	ax, [di+free_space.startsector]
  2052                                  	;;mov	ax, [di+free_space.startsector+2]
  2053                                  	;mov	ax, [si+ptStartSector]
  2054                                  	;mov	dx, [si+ptStartSector+2]
  2055 00000A1A A1[D46C]                	mov	ax, [pp_StartSector]
  2056 00000A1D 8B16[D66C]              	mov	dx, [pp_StartSector+2]
  2057                                  cpp_12:	
  2058                                  	; 18/02/2019
  2059                                  
  2060                                  	; [wholedisk] = 0
  2061                                  
  2062                                  	; Fix partition size for MSDOS 3.3 (Retro DOS 3.0) compatibility.
  2063                                  	; (DOS partition size will be changed -down- to 65535 sectors,
  2064                                  	; if it is 65536 sectors.)
  2065                                  
  2066 00000A21 E8A800                  	call	fix_32mb_dos_psize
  2067                                  		; bx:cx = [ppn_sectors] = partition size
  2068                                  		; dx:ax = start sector's LBA
  2069                                  
  2070 00000A24 01C8                    	add	ax, cx
  2071 00000A26 11DA                    	adc	dx, bx
  2072                                  
  2073                                  	; Convert LBA sector address to CHS parameters
  2074 00000A28 83E801                  	sub	ax, 1 ; locate on to end sector of the partition
  2075 00000A2B 83DA00                  	sbb	dx, 0
  2076                                  
  2077                                  	; 06/03/2019
  2078 00000A2E 803E[6870]59            	cmp	byte [cylinder_boundary],'Y'
  2079                                  	;jne	short cpp_15
  2080 00000A33 754D                    	jne	short cpp_14
  2081                                  
  2082 00000A35 89C1                    	mov	cx, ax
  2083 00000A37 A0[6C3F]                	mov	al, [heads]
  2084 00000A3A F626[6A3F]              	mul	byte [sectors]
  2085 00000A3E 89C7                    	mov	di, ax ; [heads]*[sectors]
  2086 00000A40 91                      	xchg	ax, cx
  2087                                  		; cx = heads*spt
  2088                                  
  2089 00000A41 E83902                  	call	div32
  2090                                  		; dx = 0
  2091                                  		; ax = end cylinder
  2092                                  		; bx = remainder	
  2093                                  	;and	bx, bx
  2094                                  	;jz	short cpp_13
  2095                                  	;inc	ax
  2096                                  ;cpp_13:
  2097                                  	;cmp	ax, [cylinders]
  2098                                  	;jb	short cpp_14
  2099                                  	;dec	ax
  2100                                  ;cpp_14:
  2101                                  
  2102                                  	; 26/10/2020
  2103 00000A44 3DFF03                  	cmp	ax, 1023
  2104 00000A47 760E                    	jna	short cpp_20
  2105                                  
  2106 00000A49 C64405FE                	mov	byte [si+ptEndHead], 0FEh
  2107 00000A4D C64406FF                	mov	byte [si+ptEndSector], 0FFh
  2108 00000A51 C64407FF                	mov	byte [si+ptEndCylinder], 0FFh
  2109 00000A55 EB1A                    	jmp	short cpp_21
  2110                                  cpp_20:
  2111 00000A57 8B1E[6C3F]              	mov	bx, [heads]
  2112 00000A5B FECB                    	dec	bl
  2113 00000A5D 885C05                  	mov	[si+ptEndHead], bl
  2114 00000A60 8B0E[6A3F]              	mov	cx, [sectors]
  2115 00000A64 88E2                    	mov	dl, ah
  2116 00000A66 C0E206                  	shl	dl, 6
  2117 00000A69 08CA                    	or	dl, cl
  2118 00000A6B 885406                  	mov	[si+ptEndSector], dl
  2119 00000A6E 884407                  	mov	[si+ptEndCylinder], al	
  2120                                  	;mul	di ; [cylinders]*[heads]*[sectors]
  2121                                  	;;sub	di, cx ; ([heads] - 1) * [sectors]
  2122                                  	;add	ax, di
  2123                                  	;adc	dx, 0
  2124                                  	;;add	ax, cx
  2125                                  	;;adc	dx, 0
  2126                                  cpp_21:
  2127 00000A71 40                      	inc	ax
  2128 00000A72 F7E7                    	mul	di  ; result = start LBA of next cylinder
  2129                                  	; dx:ax = end sector LBA + 1 (as cyl. boundary aligned)
  2130 00000A74 2B06[D46C]              	sub	ax, [pp_StartSector]
  2131 00000A78 1B16[D66C]              	sbb	dx, [pp_StartSector+2]
  2132                                  
  2133 00000A7C 89C1                    	mov	cx, ax
  2134 00000A7E 89D3                    	mov	bx, dx
  2135                                  	;jmp	short cpp_16
  2136 00000A80 EB3A                    	jmp	short cpp_15
  2137                                  ;cpp_15:
  2138                                  cpp_14:
  2139 00000A82 8B0E[6A3F]              	mov	cx, [sectors]
  2140 00000A86 E8F401                  	call	div32
  2141                                  	; BX = Sector number - 1
  2142 00000A89 FEC3                    	inc	bl ; sector number (1 based)
  2143 00000A8B 885C06                  	mov	[si+ptEndSector], bl	
  2144                                  	; DX_AX = cylinders * heads + head
  2145 00000A8E 8B0E[6C3F]              	mov	cx, [heads]
  2146 00000A92 E8E801                  	call	div32
  2147                                  	; BX = Head number
  2148 00000A95 885C05                  	mov	[si+ptEndHead], bl
  2149                                  	; AX = Cylinder number
  2150                                  	;and	ax, 1023
  2151                                  
  2152                                  	; 26/10/2020
  2153 00000A98 3DFF03                  	cmp	ax, 1023
  2154 00000A9B 760E                    	jna	short cpp_22
  2155                                  		
  2156 00000A9D C64405FE                	mov	byte [si+ptEndHead], 0FEh
  2157 00000AA1 C64406FF                	mov	byte [si+ptEndSector], 0FFh
  2158 00000AA5 C64407FF                	mov	byte [si+ptEndCylinder], 0FFh
  2159 00000AA9 EB09                    	jmp	short cpp_23
  2160                                  cpp_22:
  2161 00000AAB 884407                  	mov	[si+ptEndCylinder], al
  2162                                  	; 18/02/2019
  2163 00000AAE C0E406                  	shl	ah, 6
  2164 00000AB1 086406                  	or	[si+ptEndSector], ah
  2165                                  cpp_23:
  2166 00000AB4 8B0E[066D]              	mov	cx, [ppn_Sectors]
  2167 00000AB8 8B1E[086D]              	mov	bx, [ppn_Sectors+2]
  2168                                  ;cpp_16:
  2169                                  cpp_15:
  2170 00000ABC 894C0C                  	mov	[si+ptSectors], cx
  2171 00000ABF 895C0E                  	mov	[si+ptSectors+2], bx
  2172                                  
  2173                                  	; set partition ID after checking DOS FAT limits
  2174 00000AC2 E8EF00                  	call	set_partition_id
  2175                                  	; al = partition ID
  2176                                  
  2177 00000AC5 A2[DD6C]                	mov	[pp_type], al
  2178                                  
  2179 00000AC8 884404                  	mov	[si+ptFileSystemID], al
  2180                                  
  2181 00000ACB C3                      	retn
  2182                                  
  2183                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2184                                  ; decrease DOS partition size when it is (exact) 65536 sectors
  2185                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2186                                  ; 18/02/2019
  2187                                  
  2188                                  fix_32mb_dos_psize:	; call this if [wholedisk] = 0
  2189                                  
  2190                                  ; Purpose: 
  2191                                  ;	If a DOS partition's size is 65536 sectors
  2192                                  ;	MSDOS 3.3 can not use it. (FAT 16 partition ID = 06h)
  2193                                  ;	Decreasing partition size to 65535 sectors will ensure
  2194                                  ;	MSDOS 3.3 compatibility (FAT 16 partition ID will be 04h).
  2195                                  
  2196                                  	; INPUT:
  2197                                  	;    BX:CX = partition size in sectors
  2198                                  	;    [pp_type] = partition type dos, non-dos, user input
  2199                                  	;
  2200                                  	; OUTPUT:
  2201                                  	;    Partition size will be changed to 65535 sectors, if
  2202                                  	;    	- partition size is 65536 sectors and
  2203                                  	; 	- [pp_type] is 1 (DOS)
  2204                                  	;
  2205                                  	;    [ppn_Sectors] = 65535 (if it will be changed)
  2206                                  	;
  2207                                  	; (Modified registers: cx, bx) 
  2208                                  
  2209                                  	;mov	cx, [ppn_Sectors]
  2210                                  	;mov	bx, [ppn_Sectors+2]
  2211                                  
  2212 00000ACC 803E[DD6C]01            	cmp	byte [pp_type], 1 ;  DOS partition
  2213 00000AD1 7513                    	jne	short psfx_0  ; non-dos partition or user input
  2214                                  			      ; nothing to do ! 	
  2215 00000AD3 09C9                    	or	cx, cx
  2216 00000AD5 750F                    	jnz	short psfx_0 ; <> 65536 sectors
  2217 00000AD7 83FB01                  	cmp	bx, 1
  2218 00000ADA 750A                    	jne	short psfx_0
  2219 00000ADC 4B                      	dec	bx
  2220                                  	;mov	[wholedisk], bx ; 0
  2221 00000ADD 49                      	dec	cx  ; bx:cx = 65535
  2222 00000ADE 890E[066D]              	mov	[ppn_Sectors], cx
  2223 00000AE2 891E[086D]              	mov	[ppn_Sectors+2], bx
  2224                                  psfx_0:
  2225 00000AE6 C3                      	retn
  2226                                  
  2227                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2228                                  ; create extended dos partition
  2229                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2230                                  ; 24/10/2020 (fdisk3.s)
  2231                                  
  2232                                  ; 16/02/2019 (hdimage.s) 
  2233                                  ;	(This procedure must be called after 'find_part_free_space')
  2234                                  
  2235                                  create_extended_partition:  
  2236                                  	; 15/02/2019
  2237                                  
  2238                                  	; INPUT:
  2239                                  	;	none 
  2240                                  	;  (CHS parameters and free space calculation result will be used.) 
  2241                                  	;
  2242                                  	; OUTPUT:
  2243                                  	;	Partition table in MBR buffer will be updated.
  2244                                  	;
  2245                                  	; (Modified registers: ax, bx, cx, dx, si, di)
  2246                                  
  2247                                  	; Create extended dos partition, make partition table entry
  2248                                  	; (Extended partition will be created on cylinder bounds.)
  2249                                  
  2250                                  	; 16/02/2019
  2251 00000AE7 E8AE1C                  	call	get_first_free_pte
  2252                                  		 ; CX = First free PTE number, 0 to 3 
  2253                                  		 ;    (CX = 3 if there is not a free PTE, and CF = 1)
  2254                                  		 ;    ((But CF = 1 is not possible here because pcount < 4))
  2255                                   	 	 ; SI = PTE addres/offset in MBR buffer
  2256                                  
  2257                                  	;mov	si, MasterBootBuff+pTableOffset
  2258                                  	;shl	cl, 4 ; * 16
  2259                                  	;add	si, cx
  2260                                  	
  2261 00000AEA 8B1E[6670]              	mov	bx, [c_fspc_offset]
  2262                                  	
  2263 00000AEE 8B87[1670]              	mov	ax, [bx+free_space.start]
  2264                                  
  2265                                  	; 24/10/2020
  2266 00000AF2 89C7                    	mov	di, ax
  2267                                  	;mov	cx, 1
  2268 00000AF4 B101                    	mov	cl, 1 ; head (ch) = 0, sector (cl) = 1
  2269                                  
  2270 00000AF6 3DFF03                  	cmp	ax, 1023
  2271 00000AF9 7606                    	jna	short cep_4
  2272                                  
  2273                                  	; partition start  > CHS limit
  2274 00000AFB B8FF03                  	mov	ax, 1023
  2275                                  	;mov	ch, 254
  2276                                  	;mov	cl, 63
  2277 00000AFE B93FFE                  	mov	cx, 0FE3Fh
  2278                                  cep_4:	
  2279                                  	;mov	byte [si+ptBootable], 0 ; not bootable/active partition
  2280                                  	;mov	[si], ch ; 0 ; not bootable/active partition
  2281                                  	; 26/10/2020
  2282 00000B01 C60400                  	mov	byte [si], 0
  2283 00000B04 886C01                  	mov	[si+ptBeginHead], ch
  2284 00000B07 C0E406                  	shl	ah, 6
  2285 00000B0A 08E1                    	or	cl, ah
  2286 00000B0C 884C02                  	mov	[si+ptBeginSector], cl ; Sector 1 
  2287 00000B0F 884403                  	mov	[si+ptBeginCylinder], al
  2288                                  
  2289 00000B12 A0[6C3F]                	mov	al, [heads]
  2290 00000B15 F626[6A3F]              	mul	byte [sectors]
  2291                                  		; ax = heads*sectors
  2292 00000B19 F7E7                    	mul	di  ; AX * cylinder count before start cylinder
  2293                                  		; DX:AX = LBA of cylinder DI, head 0, sector 1 
  2294                                  
  2295 00000B1B 894408                  	mov	[si+ptStartSector], ax
  2296 00000B1E 89540A                  	mov	[si+ptStartSector+2], dx
  2297                                  
  2298                                  	; This is not needed for extended partition.
  2299                                  	; 16/02/2019
  2300                                  	;mov	[pp_StartSector], ax
  2301                                  	;mov	[pp_StartSector+2], dx
  2302                                  
  2303                                  	; 16/02/2019
  2304 00000B21 803E[DC6C]00            	cmp	byte [wholedisk], 0
  2305 00000B26 772A                    	ja	short cep_2 ; all of free space will be used
  2306                                  			    ; ([bx+free_space.end] will be end cyl)	
  2307                                  
  2308                                  	; calculate cylinder count (from partition size input)
  2309 00000B28 A0[6C3F]                	mov	al, [heads]
  2310 00000B2B F626[6A3F]              	mul	byte [sectors]
  2311 00000B2F 89C1                    	mov	cx, ax
  2312 00000B31 A1[066D]                	mov	ax, [ppn_Sectors]
  2313 00000B34 8B16[086D]              	mov	dx, [ppn_Sectors+2]
  2314 00000B38 E84201                  	call	div32
  2315                                  		; ax = cylinders
  2316                                  		; bx = remainder
  2317 00000B3B 21DB                    	and	bx, bx
  2318 00000B3D 7401                    	jz	short cep_1
  2319                                  
  2320 00000B3F 40                      	inc	ax  ; round up
  2321                                  cep_1:
  2322                                  	; 16/02/2019
  2323                                  	; DI  = extended partition's start cylinder
  2324 00000B40 89C2                    	mov	dx, ax ; cylinder count
  2325 00000B42 01FA                    	add	dx, di ; result is end cyl + 1
  2326 00000B44 4A                      	dec	dx ; decrease number for current end cylinder
  2327 00000B45 8B1E[6670]              	mov	bx, [c_fspc_offset]
  2328 00000B49 3B97[1870]              	cmp	dx, [bx+free_space.end]
  2329 00000B4D 7607                    	jna	short cep_3
  2330                                  	; 24/10/2020
  2331                                  	;dec	ax ; decrease cylinder count down to the limit
  2332 00000B4F 4A                      	dec	dx ; decrease end cylinder down to the limit
  2333 00000B50 EB04                    	jmp	short cep_3 	
  2334                                  cep_2:
  2335 00000B52 8B97[1870]              	mov	dx, [bx+free_space.end]
  2336                                  	;mov	ax, [bx+free_space.space]
  2337                                  cep_3:
  2338                                  	; 24/10/2020
  2339 00000B56 89D0                    	mov	ax, dx ; end cylinder
  2340 00000B58 B305                    	mov	bl, 05h	; Extended Partition ID (CHS)
  2341 00000B5A 3DFF03                  	cmp	ax, 1023
  2342 00000B5D 760A                    	jna	short cep_5
  2343                                  
  2344                                  	; partition end > CHS limit
  2345 00000B5F B8FF03                  	mov	ax, 1023
  2346                                  	;mov	ch, 254
  2347                                  	;mov	cl, 63
  2348 00000B62 B93FFE                  	mov	cx, 0FE3Fh
  2349 00000B65 B30F                    	mov	bl, 0Fh	; Extended Partition ID (LBA)
  2350 00000B67 EB0A                    	jmp	short cep_6
  2351                                  cep_5:
  2352 00000B69 8A2E[6C3F]              	mov	ch, [heads]
  2353 00000B6D FECD                    	dec	ch 
  2354 00000B6F 8A0E[6A3F]              	mov	cl, [sectors]
  2355                                  cep_6:
  2356 00000B73 886C05                  	mov	[si+ptEndHead], ch
  2357                                  	; 24/10/2020
  2358                                  	; ax = (chs limit compatible) end cylinder (<= 1023)
  2359                                  	; 23/02/2019
  2360                                  	;mov	bl, dh
  2361                                  	;shl	bl, 6
  2362                                  	;or	bl, cl
  2363 00000B76 C0E406                  	shl	ah, 6
  2364 00000B79 08E1                    	or	cl, ah
  2365                                  	;mov	[si+ptEndSector], bl
  2366 00000B7B 884C06                  	mov	[si+ptEndSector], cl	
  2367                                  	;mov	[si+ptEndCylinder], dl
  2368 00000B7E 884407                  	mov	[si+ptEndCylinder], al
  2369                                  	; dx = (lba compatible) end cylinder (up to 65535)
  2370                                  
  2371                                  	;mov	al, [heads]
  2372                                  	; 26/10/2020
  2373                                  	;;mul	cl
  2374                                  	;mul	byte [sectors]
  2375 00000B81 8A2E[6C3F]              	mov	ch, [heads]
  2376 00000B85 A0[6A3F]                	mov	al, [sectors]
  2377 00000B88 F6E5                    	mul	ch	
  2378                                  	; ax = heads*sectors	
  2379 00000B8A F7E2                    	mul	dx ; AX * cylinder count before end cylinder
  2380                                  		; DX:AX = LBA of cylinder DX, head 0, sector 1
  2381 00000B8C 52                      	push	dx
  2382 00000B8D 50                      	push	ax
  2383 00000B8E 88E8                    	mov	al, ch
  2384 00000B90 FEC8                    	dec	al ; 26/10/2020 ; [heads] - 1
  2385 00000B92 8B0E[6A3F]              	mov	cx, [sectors]  ; 63 or 17
  2386 00000B96 F6E1                    	mul	cl
  2387                                  		; ax = (heads-1)*sectors
  2388 00000B98 5A                      	pop	dx
  2389 00000B99 01D0                    	add	ax, dx
  2390 00000B9B 5A                      	pop	dx
  2391 00000B9C 83D200                  	adc	dx, 0
  2392                                  		; dx:ax = ((end cylinder)*heads)+(heads-1)*sectors
  2393 00000B9F 01C8                    	add	ax, cx
  2394 00000BA1 83D200                  	adc	dx, 0
  2395                                  	; dx:ax = (((end cylinder)*heads)+(heads-1)*sectors) + sectors
  2396                                  	; dx:ax = LBA of the partition's end sector + 1
  2397 00000BA4 2B4408                  	sub	ax, [si+ptStartSector]
  2398 00000BA7 1B540A                  	sbb	dx, [si+ptStartSector+2] 
  2399                                  
  2400 00000BAA 89440C                  	mov	[si+ptSectors], ax
  2401 00000BAD 89540E                  	mov	[si+ptSectors+2], dx
  2402                                  
  2403                                  	;mov	[pp_type], al
  2404                                  
  2405                                  	;mov	byte [si+ptFileSystemID], 5
  2406                                  	; 24/10/2020
  2407 00000BB0 885C04                  	mov	 [si+ptFileSystemID], bl ; 05h or 0Fh
  2408                                  	
  2409 00000BB3 C3                      	retn
  2410                                  
  2411                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2412                                  ; set DOS (and non-dos) partition ID according to partition size
  2413                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2414                                  ; 23/10/2020
  2415                                  
  2416                                  set_partition_id: 
  2417                                  	; 23/10/2020 (fdisk3.s)
  2418                                  	; input:
  2419                                  	;   si = partition table offset
  2420                                  	;   bx:cx = partition size
  2421                                  
  2422                                  	; 18/02/2019 (hdimage.s)
  2423                                  	;mov	cx, [ppn_Sectors]
  2424                                  	;mov	bx, [ppn_Sectors+2]
  2425                                  
  2426 00000BB4 A0[DD6C]                	mov	al, [pp_type]
  2427                                  
  2428                                  	;cmp	byte [pp_type], 1
  2429 00000BB7 3C01                    	cmp	al, 1 ; primary DOS (FAT12, FAT16, FAT32)
  2430 00000BB9 7519                    	jne	short spid_2 ; singlix, runix or user type 
  2431                                  
  2432                                  	;mov	al, 1	; FAT12
  2433                                  
  2434 00000BBB 09DB                    	or	bx, bx
  2435 00000BBD 750A                    	jnz	short spid_1
  2436                                  
  2437 00000BBF 81F9A87F                	cmp	cx, 32680
  2438                                  	;jna	short spid_8	; FAT12 file system
  2439 00000BC3 761C                    	jna	short spid_19 ; 23/10/2020
  2440                                  
  2441 00000BC5 B004                    	mov	al, 4	; FAT16 (< 32MB)
  2442                                  
  2443 00000BC7 EB39                    	jmp	short spid_8	; FAT16 (CHS) file system
  2444                                  
  2445                                  spid_1:
  2446 00000BC9 B00B                    	mov	al, 0Bh ; FAT32 (CHS)
  2447                                  
  2448 00000BCB 83FB10                  	cmp	bx, 10h
  2449 00000BCE 7332                    	jnb	short spid_8	; FAT32 (CHS) file system
  2450                                  
  2451 00000BD0 B006                    	mov	al, 6	; FAT16 (>= 32MB)
  2452                                  
  2453 00000BD2 EB2E                    	jmp	short spid_8	; FAT16 big (CHS) file system
  2454                                  
  2455                                  spid_2:
  2456                                  	;cmp	byte [pp_type], 2 ; Singlix FS
  2457 00000BD4 3C02                    	cmp	al, 2
  2458 00000BD6 7503                    	jne	short spid_3
  2459 00000BD8 B0A1                    	mov	al, 0A1h
  2460                                  	;jmp	short spid_8
  2461 00000BDA C3                      	retn	; 23/10/2020
  2462                                  spid_3:
  2463                                  	;cmp	byte [pp_type], 3 ; Retro Unix FS
  2464 00000BDB 3C03                    	cmp	al, 3
  2465 00000BDD 7503                    	jne	short spid_4
  2466 00000BDF B071                    	mov	al, 71h	
  2467                                  	;jmp	short spid_8
  2468                                  spid_19:
  2469 00000BE1 C3                      	retn
  2470                                  
  2471                                  spid_4:
  2472                                  	; another partition type (user input)
  2473                                  	
  2474                                  	; [pp_type] = 4
  2475                                  
  2476 00000BE2 A0[DE6C]                	mov	al, [pp_type_user]
  2477                                  
  2478                                  	; Check FAT12 fs size validation
  2479                                  
  2480 00000BE5 3C01                    	cmp	al, 1 ; FAT12
  2481 00000BE7 7737                    	ja	short spid_9
  2482                                  
  2483 00000BE9 21DB                    	and	bx, bx
  2484 00000BEB 750A                    	jnz	short spid_6
  2485                                  
  2486 00000BED 81F9A87F                	cmp	cx, 32680
  2487                                  	;jna	short spid_8
  2488 00000BF1 76EE                    	jna	short spid_19 ; 23/10/2020 
  2489                                  spid_5:
  2490 00000BF3 B004                    	mov	al, 4 ; FAT16 (<= 32MB) 
  2491 00000BF5 EB0B                    	jmp	short spid_8
  2492                                  spid_6:
  2493                                  	;;cmp	bx, 10h	; 512MB (16*32MB)
  2494                                  	; 15/03/2021
  2495 00000BF7 83FB40                  	cmp	bx, 40h ; 2GB (64*32MB)
  2496 00000BFA 7304                    	jnb	short spid_7
  2497                                  	
  2498 00000BFC B006                    	mov	al, 6
  2499 00000BFE EB02                    	jmp	short spid_8
  2500                                  spid_7:
  2501 00000C00 B00B                    	mov	al, 0Bh ; FAT32 (CHS) partition
  2502                                  spid_8:
  2503                                  	; 23/10/2020
  2504                                  	; check the partition's end sector against CHS limit and
  2505                                  	; convert partition ID if the partition overs CHS limit
  2506                                  	;cmp	al, 1  ; FAT12 fs
  2507                                  	;je	short spid_19 ; nothing to do (for FAT12 fs)
  2508 00000C02 034C08                  	add	cx, [si+ptStartSector]
  2509 00000C05 135C0A                  	adc	bx, [si+ptStartSector+2]
  2510 00000C08 3B1E[4868]              	cmp	bx, [chs_limit+2] ; 07/11/2020
  2511 00000C0C 72D3                    	jb	short spid_19 ; partition's end sector is in CHS limit 
  2512 00000C0E 7706                    	ja	short spid_17 ; out of CHS limit
  2513 00000C10 3B0E[4668]              	cmp	cx, [chs_limit]
  2514 00000C14 76CB                    	jna	short spid_19 ; partition's end sector is in CHS limit
  2515                                  spid_17:
  2516                                  	; out of CHS limit, partition ID conversion is needed
  2517 00000C16 3C0B                    	cmp	al, 0Bh	; FAT32 CHS
  2518 00000C18 7203                    	jb	short spid_18
  2519 00000C1A B00C                    	mov	al, 0Ch	; FAT 32 LBA
  2520 00000C1C C3                      	retn
  2521                                  spid_18:
  2522 00000C1D B00E                    	mov	al, 0Eh ; FAT16 LBA
  2523 00000C1F C3                      	retn
  2524                                  spid_9:
  2525 00000C20 3C04                    	cmp	al, 4 ; FAT16 (< 32 MB)
  2526 00000C22 750C                    	jne	short spid_10
  2527                                  
  2528 00000C24 09DB                    	or	bx, bx
  2529 00000C26 75CF                    	jnz	short spid_6
  2530                                  
  2531                                  	; 15/03/2021
  2532 00000C28 81F93610                	cmp	cx, 4150 ; 4085 + 32 + 32 + 1
  2533 00000C2C 7217                    	jb	short spid_12
  2534                                  	
  2535                                  	;retn	; FAT16 (< 32 MB) partition
  2536 00000C2E EBD2                    	jmp	short spid_8  ; 23/10/2020
  2537                                  
  2538                                  spid_10:
  2539 00000C30 3C06                    	cmp	al, 6 ; FAT 16 big partition
  2540 00000C32 7514                    	jne	short spid_13 ; Extended partition or another type
  2541                                  	
  2542 00000C34 21DB                    	and	bx, bx
  2543 00000C36 7407                    	jz	short spid_11
  2544                                  
  2545                                  	;cmp	bx, 10h	; 512MB (16*32MB)
  2546                                  	; 15/03/2021
  2547 00000C38 83FB40                  	cmp	bx, 40h ; 2GB (64*32MB)
  2548 00000C3B 73C3                    	jnb	short spid_7
  2549                                  
  2550                                  	;retn
  2551 00000C3D EBC3                    	jmp	short spid_8 ; 23/10/2020
  2552                                  
  2553                                  spid_11:
  2554                                  	;cmp	ax, 4150 ; 4085 + 32 + 32 + 1
  2555 00000C3F 81F93610                	cmp	cx, 4150 ; 14/09/2020 (BugFix)
  2556 00000C43 73AE                    	jnb	short spid_5
  2557                                  spid_12:
  2558 00000C45 B001                    	mov	al, 1 ;  FAT12 partition
  2559                                  spid_16:
  2560 00000C47 C3                      	retn
  2561                                  spid_13:
  2562                                  	; 14/09/2020
  2563 00000C48 3C0B                    	cmp	al, 0Bh ; FAT 32 (CHS) partition
  2564 00000C4A 7420                    	je	short spid_15 ; FAT 32 CHS
  2565 00000C4C 3C0C                    	cmp	al, 0Ch	 
  2566 00000C4E 750C                    	jne	short spid_14 
  2567                                  	; FAT 32 LBA
  2568 00000C50 21DB                    	and	bx, bx	; < 33 MB
  2569 00000C52 74EB                    	jz	short spid_11 ; force to FAT 16 CHS or FAT 12
  2570 00000C54 83FB10                  	cmp	bx, 10h ; 512 MB
  2571                                  	;jnb	short spid_8  ; OK, FAT 32 LBA has been confirmed
  2572 00000C57 73EE                    	jnb	short spid_16 ; 23/10/2020
  2573 00000C59 B00E                    	mov	al, 0Eh ; force to FAT 16 LBA
  2574 00000C5B C3                      	retn
  2575                                  spid_14:
  2576                                  	; 14/09/2020
  2577 00000C5C 3C0E                    	cmp	al, 0Eh
  2578                                  	;jne	short spid_8 ; non-dos or extended partition
  2579 00000C5E 75E7                    	jne	short spid_16 ; 23/10/2020
  2580                                  	; FAT 16 LBA
  2581 00000C60 09DB                    	or	bx, bx
  2582 00000C62 74DB                    	jz	short spid_11
  2583                                  	; 23/10/2020
  2584 00000C64 83FB20                  	cmp	bx, 20h ; 1 GB
  2585 00000C67 72DE                    	jb	short spid_16
  2586 00000C69 B00C                    	mov	al, 0Ch	; FAT 32 LBA
  2587 00000C6B C3                      	retn
  2588                                  spid_15:
  2589                                  	; Minimum size of FAT 32 FS = 65525 + 512 + 512 + 32
  2590                                   	; >= 66581 sectors (or >= 65525 data clusters)
  2591 00000C6C 83FB01                  	cmp	bx, 1
  2592 00000C6F 72CE                    	jb	short spid_11  ; invalid! (< 33 MB)
  2593 00000C71 778F                    	ja	short spid_8
  2594 00000C73 81F91504                	cmp	cx, 1045
  2595                                  	;jb	short spid_16  ; invalid! (< 33 MB)
  2596                                  	;retn
  2597                                  	;jmp	short spid_8 ; 23/10/2020
  2598 00000C77 7389                    	jnb	short spid_8
  2599                                  ;spid_16:
  2600 00000C79 B006                    	mov	al, 6
  2601                                  	;retn
  2602 00000C7B EB85                    	jmp	short spid_8 ; 23/10/2020
  2603                                  
  2604                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2605                                  ; 32 bit division by using 16 bit registers
  2606                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2607                                  
  2608                                  div32:
  2609                                  	; DX_AX/CX
  2610                                  	; Result: DX_AX, BX (remainder) 
  2611 00000C7D 89C3                    	mov	bx, ax
  2612                                  	;or	dx, ax ; * DX_AX = 0 ?       
  2613                                  	;jz	short div32_retn ; yes, do not divide! 
  2614 00000C7F 89D0                    	mov	ax, dx
  2615 00000C81 31D2                            xor	dx, dx
  2616 00000C83 F7F1                            div	cx	; at first, divide DX
  2617                                  			; remainder is in DX 
  2618 00000C85 93                      	xchg	ax, bx	; now quotient is in BX
  2619                                    			; and initial AX value is in AX
  2620 00000C86 F7F1                    	div	cx	; now, DX_AX has been divided and
  2621                                  			; AX has quotient
  2622                                  			; DX has remainder
  2623 00000C88 87D3                    	xchg	dx, bx	; finally, BX has remainder
  2624                                  ;div32_retn:
  2625 00000C8A C3                              retn
  2626                                  
  2627                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2628                                  ; 32 bit multiplication by using 16 bit registers
  2629                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2630                                  
  2631                                  mul32:
  2632                                  	; DX_AX*CX
  2633                                  	; Result: BX_DX_AX 
  2634 00000C8B 51                      	push	cx
  2635 00000C8C 89D3                    	mov	bx, dx
  2636 00000C8E F7E1                    	mul	cx
  2637 00000C90 93                       	xchg	ax, bx
  2638 00000C91 52                      	push	dx
  2639 00000C92 F7E1                    	mul	cx 
  2640 00000C94 59                      	pop	cx 
  2641 00000C95 01C8                    	add	ax, cx 
  2642 00000C97 83D200                  	adc	dx, 0
  2643 00000C9A 93                      	xchg	bx, ax
  2644 00000C9B 87D3                    	xchg	dx, bx
  2645 00000C9D 59                      	pop	cx
  2646 00000C9E C3                      	retn
  2647                                  
  2648                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2649                                  ; creeate new partition input menu
  2650                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2651                                  
  2652                                  B_01:
  2653                                  	; 06/03/2019
  2654 00000C9F C606[EA6C]4D            	mov	byte [pSize_unit], 'M' ; default (for 'whole' disk/space)
  2655                                  	; 15/02/2019
  2656 00000CA4 E80BFB                  	call	create_partition_input
  2657                                  B_02:		
  2658 00000CA7 21C0                    	and	ax, ax
  2659                                  	;jz	_crlf_exit ; 0 = none or not a valid input
  2660 00000CA9 0F845AF7                	jz	A_42 ; 25/02/2019
  2661                                  
  2662                                  	;or	ah, ah
  2663                                  	;jz	short B_03
  2664                                  
  2665                                  	; 23/02/2019
  2666 00000CAD 80FC04                  	cmp	ah, 4  ; user's partition type input ?
  2667 00000CB0 7505                    	jne	short B_03 ; no
  2668                                  
  2669                                  	; 29/10/2020
  2670                                  	; (ah = 0)
  2671                                  	;or	al, al
  2672                                  	;jz	A_42  ; invalid partition type input
  2673                                  	;	      ; or ESC key has been pressed
  2674                                  
  2675                                  	; user type input
  2676 00000CB2 A2[DE6C]                	mov	[pp_type_user], al
  2677 00000CB5 88E0                    	mov	al, ah ; mov al, 4
  2678                                  B_03:
  2679 00000CB7 A2[DD6C]                	mov	[pp_type], al
  2680                                  
  2681                                  	; clear screen
  2682 00000CBA B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  2683 00000CBD CD10                    	int	10h
  2684                                  
  2685 00000CBF A0[DD6C]                	mov	al, [pp_type]
  2686 00000CC2 3C01                    	cmp	al, 1
  2687 00000CC4 7705                    	ja	short B_04
  2688                                  
  2689 00000CC6 BE[1048]                	mov	si,  msg_create_dos_partition_h ; header
  2690 00000CC9 EB70                    	jmp	short B_09
  2691                                  B_04:
  2692 00000CCB 3C05                    	cmp	al, 5
  2693 00000CCD 7269                    	jb	short B_08
  2694                                  	;ja	short B_07
  2695 00000CCF 7741                    	ja	short B_58 ; 26/10/2020
  2696                                  
  2697                                  	; 23/02/2019
  2698 00000CD1 BE[0549]                	mov	si, msg_create_ext_partition_h
  2699 00000CD4 E8A70E                  	call	print_msg
  2700                                  
  2701                                  	; 24/02/2019
  2702 00000CD7 803E[CB6F]00            	cmp	byte [epnumber], 0
  2703 00000CDC 7613                    	jna	short B_05	
  2704                                  
  2705 00000CDE BE[D75E]                	mov	si, msg_ext_partition_exists
  2706 00000CE1 E89A0E                  	call 	print_msg
  2707                                  
  2708 00000CE4 BE[C755]                	mov	si, msg_press_any_key
  2709 00000CE7 E8940E                  	call	print_msg
  2710                                  
  2711 00000CEA 30E4                    	xor	ah, ah
  2712 00000CEC CD16                    	int	16h
  2713                                  
  2714 00000CEE E916F7                  	jmp	A_42
  2715                                  B_05:
  2716 00000CF1 803E[C96F]00            	cmp	byte [ppcount], 0  ; primary partition count
  2717 00000CF6 7746                    	ja	short B_10
  2718                                  
  2719                                  	; 09/02/2019
  2720 00000CF8 BE[8C4F]                	mov	si, msg_ext_partition_error
  2721 00000CFB E8800E                  	call	print_msg
  2722                                  B_06:	
  2723 00000CFE BE[C755]                	mov	si, msg_press_any_key
  2724 00000D01 E87A0E                  	call	print_msg
  2725                                  
  2726 00000D04 30E4                    	xor	ah, ah
  2727 00000D06 CD16                    	int	16h
  2728                                  
  2729 00000D08 C606[DD6C]01            	mov	byte [pp_type], 1
  2730                                  
  2731 00000D0D E8CDFA                  	call	cpi_2 ; 15/02/2019
  2732 00000D10 EB95                    	jmp	short B_02
  2733                                  
  2734                                  B_58:
  2735                                  	; 26/10/2020
  2736 00000D12 803E[3E68]80            	cmp	byte [DrvNum], 80h ; hd0 ?
  2737 00000D17 7707                    	ja	short B_59 ; Do not check primary dos partition count
  2738                                  	; The second hard disk may contain extended partition without
  2739                                  	; a primary dos partition
  2740 00000D19 803E[C96F]00            	cmp	byte [ppcount], 0  ; primary dos partition count
  2741 00000D1E 760A                    	jna	short B_07
  2742                                  B_59:
  2743 00000D20 803E[CB6F]00            	cmp	byte [epnumber], 0
  2744                                  			; is there an extended partition ?
  2745 00000D25 7603                    	jna	short B_07 ; no
  2746 00000D27 E9ACF7                  	jmp	create_logical_drives
  2747                                  B_07:
  2748 00000D2A BE[FA49]                	mov	si, msg_create_logical_drive_h
  2749 00000D2D E84E0E                  	call	print_msg
  2750                                  
  2751 00000D30 BE[CB4F]                	mov	si, msg_logical_drive_error
  2752 00000D33 E8480E                  	call	print_msg
  2753 00000D36 EBC6                    	jmp	short B_06
  2754                                  
  2755                                  ;	mov	si, msg_use_entire_ep_space
  2756                                  ;	jmp	short B_12
  2757                                  	
  2758                                  B_08:
  2759 00000D38 BE[EF4A]                	mov	si, msg_create_nondos_partition_h
  2760                                  B_09:
  2761 00000D3B E8400E                  	call	print_msg
  2762                                  B_10:
  2763                                  	; 15/02/2019
  2764                                  	;cmp	byte [newdisk], 0
  2765                                  	;ja	short B_11
  2766                                  
  2767 00000D3E 803E[C86F]00            	cmp	byte [pcount], 0 ; (valid) partition count
  2768 00000D43 7605                    	jna	short B_11
  2769                                  
  2770 00000D45 BE[244E]                	mov	si, msg_use_all_space
  2771 00000D48 EB03                    	jmp	short B_12
  2772                                  B_11:
  2773 00000D4A BE[FD4D]                	mov	si, msg_use_whole_disk ; partition size: whole disk
  2774                                  B_12:
  2775 00000D4D E82E0E                  	call	print_msg
  2776                                  B_13:
  2777 00000D50 30E4                    	xor	ah, ah
  2778 00000D52 CD16                    	int	16h
  2779                                  
  2780 00000D54 3C1B                    	cmp	al, 27 ; ESCAPE key
  2781                                  	;;je	_crlf_exit
  2782 00000D56 0F84ADF6                	je	A_42 ; 25/02/2019
  2783 00000D5A 24DF                    	and	al, 0DFh
  2784 00000D5C 3C4E                    	cmp	al, 'N'
  2785 00000D5E 740D                    	je	short B_14  ;02/03/2019
  2786 00000D60 3C59                    	cmp	al, 'Y'
  2787 00000D62 75EC                    	jne	short B_13
  2788                                  	
  2789 00000D64 FE06[DC6C]              	inc	byte [wholedisk]
  2790                                  	
  2791                                  	; 02/03/2019
  2792 00000D68 BE[A45C]                	mov	si, _msg_YES
  2793                                  	;call	print_msg
  2794 00000D6B EB03                    	jmp	short B_15	
  2795                                  B_14:
  2796 00000D6D BE[AA5C]                	mov	si, _msg_NO
  2797                                  B_15:	; 06/03/2019
  2798 00000D70 E80B0E                  	call	print_msg
  2799                                  
  2800                                  	; 15/02/2019
  2801 00000D73 29DB                    	sub	bx, bx
  2802                                  	;cmp	byte [newdisk], bl ; 0
  2803                                  	;ja	short B_16 ; 23/02/2019
  2804                                  	; 19/10/2020
  2805                                  	;cmp	byte [pcount], 0
  2806                                  	; 03/11/2020
  2807 00000D75 381E[C86F]              	cmp	byte [pcount], bl ; 0
  2808 00000D79 7608                    	jna	short B_16 ; [pcount] = 0 (newdisk, empty pt) 
  2809 00000D7B 381E[DC6C]              	cmp	byte [wholedisk], bl ; 0
  2810 00000D7F 0F871C01                	ja	B_27 ; 23/02/2019
  2811                                  B_16:
  2812                                  	; 08/02/2019
  2813                                  	;sub	bx, bx
  2814 00000D83 A1[4268]                	mov	ax, [total_sectors]
  2815 00000D86 8B16[4468]              	mov	dx, [total_sectors+2]
  2816 00000D8A 2B06[6A3F]              	sub	ax, [sectors]
  2817 00000D8E 19DA                    	sbb	dx, bx ; sbb dx, 0
  2818                                  
  2819 00000D90 A3[D86C]                	mov	[pp_Sectors], ax   ; = [total_sectors] - [sectors]
  2820 00000D93 8916[DA6C]              	mov	[pp_Sectors+2], dx ; = [total_sectors+2] - carry bit
  2821                                  B_17:
  2822 00000D97 381E[DC6C]              	cmp	byte [wholedisk], bl ; 0
  2823 00000D9B 0F870701                	ja	B_28 ; 09/02/2019
  2824                                  B_18:
  2825                                  	; clear screen
  2826 00000D9F B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  2827 00000DA2 CD10                    	int	10h
  2828                                  
  2829                                  	; 04/11/2020
  2830 00000DA4 803E[DD6C]01            	cmp	byte [pp_type], 1 ; primary dos partition ?
  2831 00000DA9 7405                    	je	short B_61
  2832                                  	; "Create Partition"
  2833 00000DAB BE[6545]                	mov	si, msg_create_partition_h
  2834 00000DAE EB03                    	jmp	short B_62
  2835                                  B_61:
  2836                                  	; "Create DOS partition"
  2837 00000DB0 BE[1048]                	mov	si, msg_create_dos_partition_h ; header
  2838                                  B_62:
  2839 00000DB3 E8C80D                  	call	print_msg
  2840 00000DB6 BE[A14C]                	mov	si, msg_create_trdos_partition_s ; size options
  2841 00000DB9 E8C20D                  	call	print_msg	
  2842                                  B_19:	
  2843 00000DBC 30E4                    	xor	ah, ah
  2844 00000DBE CD16                    	int	16h
  2845                                  
  2846                                  	; 24/02/2019
  2847 00000DC0 3C1B                    	cmp	al, 27	; ESCAPE key 
  2848 00000DC2 0F8441F6                	je	A_42	; Cancel
  2849                                  
  2850 00000DC6 3C20                    	cmp	al, 32	; SPACE key
  2851 00000DC8 7521                    	jne	short B_21
  2852                                  
  2853                                  		; Entire space
  2854 00000DCA A1[D86C]                	mov	ax, [pp_Sectors]
  2855 00000DCD 8B16[DA6C]              	mov	dx, [pp_Sectors+2]
  2856                                  
  2857 00000DD1 C606[DC6C]01            	mov 	byte [wholedisk], 1 ; 09/02/2019
  2858 00000DD6 EB5A                    	jmp	short B_23
  2859                                  
  2860                                  B_60:	; 31/10/2020
  2861 00000DD8 75C5                    	jnz	short B_18  ; ESCape (return to options menu)
  2862                                  	; partition size input is ZERO !
  2863                                  B_20:
  2864                                  	; ZERO partition size message
  2865 00000DDA BE[B75A]                	mov	si, msg_zero_partition_size
  2866 00000DDD E89E0D                  	call	print_msg
  2867                                  	
  2868 00000DE0 30E4                    	xor	ah, ah
  2869 00000DE2 CD16                    	int	16h
  2870 00000DE4 3C1B                    	cmp	al, 27 ; ESCAPE key
  2871 00000DE6 75B7                    	jne	short B_18 ; Retry
  2872                                  
  2873                                  	; 19/10/2020
  2874 00000DE8 E9BCF9                  	jmp	_crlf_exit ; exit
  2875                                  
  2876                                  B_21:
  2877 00000DEB C606[EA6C]25            	mov	byte [pSize_unit], '%'
  2878 00000DF0 3C25                    	cmp	al, '%'
  2879 00000DF2 7422                    	je	short B_22
  2880 00000DF4 C606[EA6C]53            	mov	byte [pSize_unit], 'S'
  2881 00000DF9 3C0D                    	cmp	al, 13 ; 0Dh, Carriage Return key
  2882 00000DFB 7419                    	je	short B_22
  2883 00000DFD 24DF                    	and	al, 0DFh
  2884 00000DFF 3C53                    	cmp	al, 'S'
  2885 00000E01 7413                    	je	short B_22
  2886 00000E03 A2[EA6C]                	mov	[pSize_unit], al
  2887 00000E06 3C4B                    	cmp	al, 'K'
  2888 00000E08 740C                    	je	short B_22
  2889 00000E0A 3C4D                    	cmp	al, 'M'
  2890 00000E0C 7408                    	je	short B_22
  2891 00000E0E 3C47                    	cmp	al, 'G'
  2892 00000E10 7404                    	je	short B_22
  2893 00000E12 3C43                    	cmp	al, 'C'
  2894 00000E14 75A6                    	jne	short B_19
  2895                                  B_22:
  2896 00000E16 C606[1F64]73            	mov	byte [msg_sectors_crlf_s], 's' ; " sectors"
  2897                                  
  2898 00000E1B E8D00F                  	call	partition_size_input
  2899                                  	;jc	_crlf_exit ; exit if partition size input is 0
  2900                                  	;jc	short B_20
  2901                                  	; 29/10/2020
  2902                                  	;jnc	short B_60
  2903                                  	;jz	short B_20 ; partition size input is ZERO !
  2904                                  	;jmp	short B_18 ; ESCape (return to options menu)
  2905                                  	; 31/10/2020
  2906 00000E1E 72B8                    	jc	short B_60 ; ESC or zero partition size
  2907                                  ;B_60:
  2908 00000E20 21DB                    	and	bx, bx ; bx_dx_ax = partition size
  2909                                  	;jnz	short B_29
  2910                                  	; 23/02/2019 
  2911 00000E22 7540                    	jnz	short B_24 ; invalid! (use maximum available sectors)
  2912                                  
  2913                                  	; 08/02/2019
  2914 00000E24 09D2                    	or	dx, dx
  2915 00000E26 750A                    	jnz	short B_23 ; proper size (for now)
  2916                                  
  2917 00000E28 8B1E[006D]              	mov	bx, [min_sectors] ; minimum sectors
  2918 00000E2C 39C3                    	cmp	bx, ax
  2919 00000E2E 7602                    	jna	short B_23 ; proper size (for now)	 
  2920                                  
  2921                                  	; invalid! (use minimum sectors or sectors per cylinder)
  2922 00000E30 89D8                    	mov	ax, bx
  2923                                  B_23:
  2924                                  	; 09/02/2019
  2925                                  	; save dx,ax
  2926 00000E32 8916[086D]              	mov	[ppn_Sectors+2], dx
  2927 00000E36 A3[066D]                	mov	[ppn_Sectors], ax
  2928                                  
  2929                                  	; write partition size
  2930                                  	;push	dx
  2931                                  	;push	ax
  2932                                  	;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  2933                                  	; 06/11/2020
  2934 00000E39 BE[F76C]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  2935 00000E3C E8FE0D                  	call	bin_to_decimal
  2936                                  	; ds:si = beginning of decimal number text
  2937 00000E3F E83C0D                  	call	print_msg
  2938 00000E42 BE[1864]                	mov	si, msg_sectors_crlf
  2939 00000E45 E8360D                  	call	print_msg
  2940                                  	;pop	ax
  2941                                  	;pop	dx
  2942                                  
  2943 00000E48 803E[DC6C]00            	cmp	byte [wholedisk], 0
  2944 00000E4D 775E                    	ja	short B_29 ; 09/02/2019
  2945                                  
  2946                                  	; restore ax,dx
  2947 00000E4F A1[066D]                	mov	ax, [ppn_Sectors]
  2948 00000E52 8B16[086D]              	mov	dx, [ppn_Sectors+2]
  2949                                  
  2950                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2951                                  ; select whole disk
  2952                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2953                                  
  2954                                  	; select whole disk 
  2955                                  	;   if partition size > disk size
  2956 00000E56 3B16[DA6C]              	cmp	dx, [pp_Sectors+2]
  2957 00000E5A 7708                    	ja	short B_24
  2958 00000E5C 724F                    	jb	short B_29
  2959 00000E5E 3B06[D86C]              	cmp	ax, [pp_Sectors]
  2960 00000E62 7649                    	jna	short B_29
  2961                                  B_24:
  2962                                  	;cmp	byte [newdisk], 0
  2963                                  	;jna	short B_30
  2964                                  	; 19/10/2020
  2965 00000E64 803E[C86F]00            	cmp	byte [pcount], 0
  2966 00000E69 7767                    	ja	short B_30
  2967                                  
  2968                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2969                                  ; "use whole disk or go to back" question
  2970                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2971                                  
  2972 00000E6B BE[224F]                	mov	si, msg_partition_size_overs
  2973                                  B_25:
  2974 00000E6E E80D0D                  	call	print_msg
  2975                                  B_26:
  2976 00000E71 30E4                    	xor	ah, ah
  2977 00000E73 CD16                    	int	16h
  2978                                  	
  2979 00000E75 3C1B                    	cmp	al, 27 ; ESCAPE key
  2980                                  	;je	B_01
  2981 00000E77 0F8424FF                	je	B_18 ; 09/02/2019
  2982 00000E7B 3C0D                    	cmp	al, 13 ; ENTER (Carriage Return) key
  2983 00000E7D 75F2                    	jne	short B_26
  2984                                  
  2985 00000E7F FE06[DC6C]              	inc	byte [wholedisk]
  2986                                  
  2987                                  	; 24/02/2019
  2988                                  	;cmp	byte [newdisk], 0
  2989                                  	;ja	short B_27
  2990 00000E83 803E[C86F]00            	cmp	byte [pcount], 0  ; (valid) partition count
  2991 00000E88 7615                    	jna	short B_27 ; no
  2992                                  
  2993 00000E8A 8B1E[6670]              	mov	bx, [c_fspc_offset]
  2994 00000E8E 8B87[1C70]              	mov	ax, [free_space.sectors_unused+bx]
  2995 00000E92 8B97[1E70]              	mov	dx, [free_space.sectors_unused+bx+2]
  2996 00000E96 A3[D86C]                	mov	[pp_Sectors], ax
  2997 00000E99 8916[DA6C]              	mov	[pp_Sectors+2], dx
  2998 00000E9D EB07                    	jmp	short B_28 
  2999                                  B_27:
  3000                                  	; 09/02/2019
  3001 00000E9F 8B16[DA6C]              	mov	dx, [pp_Sectors+2]
  3002 00000EA3 A1[D86C]                	mov	ax, [pp_Sectors]
  3003                                  B_28:
  3004 00000EA6 8916[086D]              	mov	[ppn_Sectors+2], dx
  3005 00000EAA A3[066D]                	mov	[ppn_Sectors], ax
  3006                                  B_29:
  3007 00000EAD 803E[DD6C]05            	cmp	byte [pp_type], 5
  3008 00000EB2 0F853601                	jne	B_51
  3009                                  
  3010 00000EB6 803E[C96F]00            	cmp	byte [ppcount], 0  ; primary partition count
  3011 00000EBB 0F87C500                	ja	B_45
  3012                                  
  3013 00000EBF BE[8C4F]                	mov	si, msg_ext_partition_error
  3014 00000EC2 E8B90C                  	call	print_msg
  3015 00000EC5 BE[054F]                	mov	si, msg_any_key_to_retry
  3016 00000EC8 E8B30C                  	call	print_msg
  3017                                  
  3018                                  	; 09/02/2019
  3019 00000ECB 30E4                    	xor	ah, ah
  3020 00000ECD CD16                    	int	16h
  3021                                  
  3022                                  	;jmp	B_01
  3023 00000ECF E90BF9                  	jmp	cpi_2 
  3024                                  
  3025                                  B_30:
  3026                                  	; clear screen
  3027 00000ED2 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  3028 00000ED5 CD10                    	int	10h
  3029                                  
  3030 00000ED7 BE[1048]                	mov	si, msg_create_dos_partition_h ; header
  3031 00000EDA E8A10C                  	call	print_msg
  3032                                  
  3033 00000EDD BE[C35D]                	mov	si, msg_partition_size_limit
  3034 00000EE0 E89B0C                  	call	print_msg
  3035                                  
  3036 00000EE3 8B1E[6670]              	mov	bx, [c_fspc_offset]
  3037                                  
  3038 00000EE7 803E[EA6C]53            	cmp	byte [pSize_unit], 'S'
  3039 00000EEC 7415                    	je	short B_31
  3040 00000EEE 803E[EA6C]4B            	cmp	byte [pSize_unit], 'K'
  3041 00000EF3 740E                    	je	short B_31
  3042                                  
  3043 00000EF5 803E[EA6C]25            	cmp	byte [pSize_unit], '%'
  3044 00000EFA 7469                    	je	short B_41
  3045                                  
  3046 00000EFC 803E[EA6C]43            	cmp	byte [pSize_unit], 'C'
  3047 00000F01 7479                    	je	B_44
  3048                                  B_31:
  3049                                  	; 'S', 'K'
  3050 00000F03 81C3[1C70]              	add	bx, free_space.sectors_unused	
  3051 00000F07 8B07                    	mov	ax, [bx]
  3052 00000F09 8B5702                  	mov	dx, [bx+2]
  3053                                  		
  3054 00000F0C B90A00                  	mov	cx, 10
  3055 00000F0F 89E5                    	mov	bp, sp
  3056                                  B_32:
  3057 00000F11 E869FD                  	call	div32
  3058 00000F14 53                      	push	bx
  3059 00000F15 09D2                    	or	dx, dx
  3060 00000F17 75F8                    	jnz	short B_32
  3061 00000F19 83F809                  	cmp	ax, 9
  3062 00000F1C 77F3                    	ja	short B_32
  3063                                  B_33:
  3064 00000F1E BB0700                  	mov	bx, 07h
  3065 00000F21 09C0                    	or	ax, ax
  3066 00000F23 7501                    	jnz	short B_35
  3067                                  B_34:
  3068 00000F25 58                      	pop	ax
  3069                                  B_35:
  3070 00000F26 0430                    	add	al, '0'
  3071                                  B_36:
  3072 00000F28 B40E                    	mov	ah, 0Eh
  3073                                  	;mov	bx, 07h
  3074 00000F2A CD10                    	int	10h	; write character (as tty)
  3075                                  
  3076 00000F2C 39EC                    	cmp	sp, bp
  3077 00000F2E 72F5                    	jb	short B_34
  3078                                  
  3079 00000F30 803E[EA6C]53            	cmp	byte [pSize_unit], 'S'
  3080 00000F35 7422                    	je	short B_38
  3081 00000F37 803E[EA6C]4B            	cmp	byte [pSize_unit], 'K'
  3082 00000F3C 741B                    	je	short B_38
  3083                                  
  3084 00000F3E 803E[EA6C]25            	cmp	byte [pSize_unit], '%'
  3085 00000F43 7508                    	jne	short B_37
  3086                                  
  3087                                  	; 24/02/2019
  3088 00000F45 3C25                    	cmp	al, '%'
  3089 00000F47 7416                    	je	short B_40
  3090 00000F49 B025                    	mov	al, '%'
  3091 00000F4B EBDB                    	jmp	short B_36 
  3092                                  B_37:
  3093 00000F4D 803E[EA6C]43            	cmp	byte [pSize_unit], 'C'
  3094 00000F52 7505                    	jne	short B_38
  3095                                  
  3096 00000F54 BE[5F5E]                	mov	si, msg_cylinders
  3097 00000F57 EB03                    	jmp	short B_39
  3098                                  B_38:
  3099 00000F59 BE[6A5E]                	mov	si, msg_sectors
  3100                                  B_39:
  3101 00000F5C E81F0C                  	call	print_msg
  3102                                  B_40:
  3103 00000F5F BE[105E]                	mov	si, msg_partition_size_limit_r
  3104                                  	;call	print_msg
  3105                                  
  3106 00000F62 E909FF                  	jmp	B_25
  3107                                  
  3108                                  B_41:
  3109                                  	; '%'
  3110 00000F65 81C3[1A70]              	add	bx, free_space.percent_unused
  3111 00000F69 8B07                    	mov	ax, [bx]
  3112                                  B_42:	
  3113 00000F6B 89E5                    	mov	bp, sp
  3114 00000F6D B90A00                  	mov	cx, 10
  3115                                  B_43:	
  3116 00000F70 31D2                    	xor	dx, dx
  3117                                  	;mov	cx, 10
  3118 00000F72 F7F1                    	div	cx
  3119 00000F74 52                      	push	dx
  3120 00000F75 83F809                  	cmp	ax, 9
  3121 00000F78 77F6                    	ja	short B_43	
  3122 00000F7A EBA2                    	jmp	short B_33
  3123                                  B_44:
  3124                                  	; 'C'
  3125 00000F7C 81C3[1470]              	add	bx, free_space.space
  3126 00000F80 8B07                    	mov	ax, [bx]
  3127 00000F82 EBE7                    	jmp	short B_42
  3128                                  
  3129                                  B_45:
  3130                                  	; 23/02/2019
  3131 00000F84 8B1E[6670]              	mov	bx, [c_fspc_offset]
  3132 00000F88 8B87[1670]              	mov	ax, [bx+free_space.start]
  3133                                  
  3134                                  	; set free space start cylinder to 1 if it is 0
  3135 00000F8C 09C0                    	or	ax, ax
  3136 00000F8E 750F                    	jnz	short B_46
  3137                                  
  3138 00000F90 B005                    	mov	al, 5	; Get free space for extended partition
  3139 00000F92 E89115                  	call	find_part_free_space
  3140                                  
  3141 00000F95 891E[6670]              	mov	[c_fspc_offset], bx
  3142                                  
  3143                                  	; 19/10/2020
  3144 00000F99 21C9                    	and	cx, cx
  3145 00000F9B 0F8428F5                	jz	cp_3	; there is not free space on disk
  3146                                  B_46:
  3147                                  	; 24/02/2019
  3148 00000F9F E81100                  	call	partition_size_fixup_x
  3149 00000FA2 0F822CFF                	jc	B_30
  3150                                  
  3151                                  	; 16/02/2019
  3152 00000FA6 E83EFB                  	call	create_extended_partition 
  3153                                  			; must be called after 'find_part_free_space'.
  3154                                  	; 24/02/2019
  3155 00000FA9 E86011                  	call	show_selected_partition
  3156 00000FAC E9BE00                  	jmp	C_02
  3157                                  
  3158                                  partition_size_fixup:
  3159                                  	; 24/02/2019
  3160 00000FAF 8B1E[6670]              	mov	bx, [c_fspc_offset]
  3161                                  partition_size_fixup_x:
  3162                                  	; 19/10/2020
  3163                                  
  3164                                  	;cmp	byte [newdisk], 0
  3165                                  	;ja	short B_50
  3166                                  
  3167 00000FB3 803E[C86F]00            	cmp	byte [pcount], 0 ; (valid) partition count
  3168 00000FB8 7631                    	jna	short B_50
  3169                                  
  3170 00000FBA 81C3[1C70]              	add	bx, free_space.sectors_unused
  3171 00000FBE 8B07                    	mov	ax, [bx]
  3172 00000FC0 8B5702                  	mov	dx, [bx+2]
  3173                                  
  3174 00000FC3 3B16[086D]              	cmp	dx, [ppn_Sectors+2]
  3175 00000FC7 7222                    	jb	short B_50 ; 24/02/2019
  3176 00000FC9 7708                    	ja	short B_47
  3177 00000FCB 3B06[066D]              	cmp	ax, [ppn_Sectors]
  3178 00000FCF 721A                    	jb	short B_50 ; 24/02/2019
  3179 00000FD1 7411                    	je	short B_49
  3180                                  
  3181                                  B_47:
  3182                                  	; 19/02/2019
  3183 00000FD3 A1[066D]                	mov	ax, [ppn_Sectors]
  3184                                  B_48:
  3185 00000FD6 8B16[086D]              	mov	dx, [ppn_Sectors+2]
  3186                                  
  3187                                  	; 18/02/2019
  3188                                  
  3189                                  	; check for best fit
  3190                                  	; (leave max. available space to next time if 
  3191                                  	;  another space/gap fits to partition size request.)
  3192                                  
  3193 00000FDA E86117                  	call	find_enough_free_sectors
  3194                                  		; CX = Free space index (0 to 4)
  3195                                  		; DX:AX = First available space which fits to request
  3196                                  	;mov	bx, cx
  3197                                  	;shl	bl, 4 ; * 16  ; * Free space structure size
  3198                                  	;mov	[c_fspc_offset], bx
  3199                                  	
  3200                                  	; 22/02/2019
  3201 00000FDD C0E104                  	shl	cl, 4
  3202 00000FE0 890E[6670]              	mov	[c_fspc_offset], cx 
  3203                                  
  3204                                  	;add	bx, free_space.sectors_unused
  3205                                  	;mov	ax, [bx]
  3206                                  	;mov	dx, [bx+2]
  3207                                  B_49:		
  3208                                  	; Save max. available space
  3209 00000FE4 A3[D86C]                	mov	[pp_Sectors], ax
  3210 00000FE7 8916[DA6C]              	mov	[pp_Sectors+2], dx
  3211                                  B_50:
  3212 00000FEB C3                      	retn
  3213                                  
  3214                                  B_51:
  3215                                  	; 24/02/2019
  3216 00000FEC E8C0FF                  	call	partition_size_fixup
  3217 00000FEF 0F82DFFE                	jc	B_30
  3218                                  
  3219                                  	; 16/02/2019
  3220                                  	; Force cylinder boundary alignment except
  3221                                  	;   sectors ('S') and kilobytes ('K') as sizing unit.
  3222                                  
  3223 00000FF3 C606[6870]59            	mov	byte [cylinder_boundary], 'Y' ; Default
  3224                                  				; sizing unit is one of
  3225                                  				; 'cylinders','megabytes','gigabytes'
  3226                                  				; and boundary alignment is yes for them.
  3227 00000FF8 A0[EA6C]                	mov	al, [pSize_unit]
  3228                                  
  3229                                  	;cmp	byte [pSize_unit], 'S' ; Sectors
  3230 00000FFB 3C53                    	cmp	al, 'S'
  3231 00000FFD 7404                    	je	short B_52
  3232                                  
  3233                                  	;cmp	byte [pSize_unit], 'K' ; Kilobytes
  3234 00000FFF 3C4B                    	cmp	al, 'K'
  3235 00001001 752F                    	jne	short B_56
  3236                                  B_52:
  3237                                  	; Sizing unit is one of 'sectors' and/or 'kilobytes'
  3238                                  	; and bound aligment will be applied if the answer will be yes.
  3239                                  
  3240 00001003 BE[1450]                	mov	si, msg_cylinder_boundary_set
  3241 00001006 E8750B                  	call	print_msg
  3242                                  B_53:
  3243 00001009 30E4                    	xor	ah, ah
  3244 0000100B CD16                    	int	16h
  3245                                  	; Cylinder boundary adjusting
  3246 0000100D 3C0D                    	cmp	al, 13 ; ENTER key
  3247 0000100F 74F2                    	je	short B_52
  3248 00001011 3C1B                    	cmp	al, 27 ; ESCAPE key
  3249 00001013 741A                    	je	short B_55	; Align end of the partition only
  3250                                  				; if start of the partition is aligned
  3251                                  				; or it starts at cyl 0, head 1, sect 17 or 63.
  3252                                  				; (End of the partition will be extended to
  3253                                  				; end sector of it's last cylinder if the size
  3254                                  				; will not over [pp_Sectors] value.)
  3255 00001015 24DF                    	and	al, 0DFh
  3256                                  
  3257                                  	; 22/02/2019
  3258 00001017 3C59                    	cmp	al, 'Y'
  3259 00001019 7508                    	jne	short B_54
  3260                                  
  3261 0000101B BE[A45C]                	mov	si, _msg_YES
  3262 0000101E E85D0B                  	call	print_msg
  3263                                  
  3264                                  	;mov	al, 'Y'
  3265                                  	;jmp	short B_55
  3266 00001021 EB0F                    	jmp	short B_56
  3267                                  B_54:
  3268 00001023 3C4E                    	cmp	al, 'N'
  3269 00001025 75E2                    	jne	short B_53
  3270                                  
  3271 00001027 BE[AA5C]                	mov	si, _msg_NO
  3272 0000102A E8510B                  	call	print_msg
  3273                                  
  3274 0000102D B04E                    	mov	al, 'N'
  3275                                  		; do not align partition to cylinder boundary 
  3276                                  B_55:
  3277 0000102F A2[6870]                	mov	[cylinder_boundary], al
  3278                                  B_56:
  3279 00001032 E8FCF7                  	call	create_primary_partition
  3280                                  	
  3281                                  	; 18/02/2019
  3282                                  	;cmp	byte [newdisk], 0
  3283                                  	;jna	short B_57
  3284                                  
  3285                                  	; 19/10/2020
  3286 00001035 803E[C86F]00            	cmp	byte [pcount], 0
  3287 0000103A 770E                    	ja	short B_57
  3288                                  
  3289 0000103C 31C0                    	xor	ax, ax ; 0
  3290 0000103E 31D2                    	xor	dx, dx ; 0
  3291                                  	; DX_AX = Masterboot Sector = 0
  3292 00001040 BB[E655]                	mov	bx, MasterBootBuff
  3293                                  	; ES:BX = Sector Buffer
  3294 00001043 E89D0B                  	call	write_hd_sector
  3295 00001046 0F8247F7                	jc	print_error_code ; 18/10/2020
  3296                                  B_57:
  3297                                  	; DS:SI = Partition Table Entry address
  3298                                  	; 25/02/2019
  3299 0000104A 8936[8E70]              	mov	[pte_address], si  ; save PTE address
  3300 0000104E E8BB10                  	call	show_selected_partition
  3301                                  
  3302                                  	;jmp	C_01
  3303                                  
  3304                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3305                                  ; format question
  3306                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3307                                  
  3308                                  C_01:
  3309                                  	;mov	si, CRLF
  3310                                  	;call	print_msg
  3311                                  
  3312 00001051 C606[F96C]01            	mov	byte [format_q], 1
  3313                                  
  3314 00001056 A0[DD6C]                	mov	al, [pp_type]
  3315 00001059 3C01                    	cmp	al, 1		; FAT12 (CHS)
  3316 0000105B 741D                    	je	short C_03
  3317 0000105D 3C04                    	cmp	al, 4		; FAT16 CHS
  3318 0000105F 7419                    	je	short C_03
  3319 00001061 3C06                    	cmp	al, 6		; FAT16 BIG CHS
  3320 00001063 7415                    	je	short C_03
  3321 00001065 3C0B                    	cmp	al, 0Bh		; FAT32 CHS
  3322 00001067 7411                    	je	short C_03
  3323 00001069 3CA1                    	cmp	al, 0A1h	; SINGLIX FS1
  3324 0000106B 740D                    	je	short C_03
  3325                                  
  3326                                  	;cmp	al, 71h
  3327                                  	;je	short C_03	; RETRO UNIX 386
  3328                                  
  3329                                  	;dec	byte [format_q] ; 0
  3330                                  C_02:
  3331 0000106D C606[F96C]00            	mov	byte [format_q], 0 ; 24/02/2019
  3332                                  
  3333                                  	; NON-DOS partition!
  3334                                  	; Ask for editing PT or exit (continue without formatting)
  3335 00001072 BE[9A53]                	mov	si, msg_edit_or_exit
  3336 00001075 E8060B                  	call	print_msg
  3337 00001078 EB06                    	jmp	short C_04
  3338                                  C_03:
  3339                                  	; Ask for formatting, editing PT or exit
  3340 0000107A BE[2B53]                	mov	si, msg_format_stage
  3341 0000107D E8FE0A                  	call	print_msg
  3342                                  C_04:
  3343 00001080 BE[6B53]                	mov	si, msg_partition_edit
  3344 00001083 E8F80A                  	call	print_msg
  3345                                  C_05:
  3346 00001086 28E4                    	sub	ah, ah
  3347 00001088 CD16                    	int	16h
  3348                                  
  3349 0000108A 3C0D                    	cmp	al, 13
  3350 0000108C 7435                    	je	short C_08
  3351                                  
  3352                                  	;; 07/03/2019
  3353 0000108E 3C20                    	cmp	al, 20h ; SPACE
  3354                                  	;je	A_21 ; edit partition table option is selected
  3355 00001090 7503                    	jne	short C_06
  3356                                  	; 19/10/2020	
  3357 00001092 E955F1                  	jmp	A_21
  3358                                  C_06:
  3359 00001095 3C1B                    	cmp	al, 27 ; ESCAPE
  3360 00001097 75ED                    	jne	short C_05
  3361                                  	
  3362                                  	; 19/010/2020
  3363 00001099 E911F7                  	jmp	_exit
  3364                                  
  3365                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3366                                  ; save MBR then exit
  3367                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3368                                  
  3369                                  save_mbr_exit:
  3370                                  	; 24/02/2019
  3371 0000109C E85212                  	call	init_partition_table
  3372                                  
  3373 0000109F E83517                  	call	display_partition_table
  3374                                  
  3375 000010A2 BE[6B55]                	mov	si, CRLF
  3376 000010A5 E8D60A                  	call	print_msg
  3377                                  
  3378 000010A8 BE[1F54]                	mov	si, msg_writing_mbr
  3379 000010AB E8D00A                  	call	print_msg
  3380                                  
  3381 000010AE 31C0                    	xor	ax, ax ; 0
  3382 000010B0 31D2                    	xor	dx, dx ; 0
  3383                                  	; DX_AX = Masterboot Sector = 0
  3384 000010B2 BB[E655]                	mov	bx, MasterBootBuff
  3385                                  	; ES:BX = Sector Buffer
  3386 000010B5 E82B0B                  	call	write_hd_sector
  3387 000010B8 7303                    	jnc	short C_07
  3388 000010BA E9D4F6                  	jmp	print_error_code ; 18/10/2020
  3389                                  
  3390                                  C_07:
  3391 000010BD BE[6755]                	mov	si, Msg_OK
  3392                                  	;call	print_msg
  3393                                  	; 19/10/2020
  3394                                  	;jmp	_exit
  3395 000010C0 E9E7F6                  	jmp	_p_exit
  3396                                  
  3397                                  C_08:
  3398 000010C3 803E[F96C]01            	cmp	byte [format_q], 1
  3399 000010C8 72D2                    	jb	short save_mbr_exit
  3400                                  
  3401                                  	; 25/02/2019
  3402                                  	; Write MBR without writing message
  3403                                  	
  3404                                  	; NOTE: This may be second time of MBR writing...
  3405                                  	;	but, if partition table is modified,
  3406                                  	;	we need to write MBR to disk, here.
  3407                                  	;
  3408                                  	; (Otherwise.. the last created partition would not be recorded.)
  3409                                  
  3410 000010CA 31C0                    	xor	ax, ax ; 0
  3411 000010CC 31D2                    	xor	dx, dx ; 0
  3412                                  	; DX_AX = Masterboot Sector = 0
  3413 000010CE BB[E655]                	mov	bx, MasterBootBuff
  3414                                  	; ES:BX = Sector Buffer
  3415 000010D1 E80F0B                  	call	write_hd_sector
  3416 000010D4 0F82B9F6                	jc	print_error_code ; 18/10/2020
  3417                                  
  3418                                  	;; clear screen
  3419                                  	;mov	ax, 3 ; set video mode to 03h (80x25 text)
  3420                                  	;int	10h
  3421                                  
  3422                                  	; 25/02/2019
  3423 000010D8 8B36[8E70]              	mov	si, [pte_address]
  3424                                  
  3425                                  	; 18/02/2019
  3426 000010DC E82D10                  	call	show_selected_partition	
  3427                                  
  3428 000010DF A0[5253]                	mov	al, [partition_num_chr]
  3429 000010E2 A2[1254]                	mov	[partition_num_txt], al
  3430                                  
  3431 000010E5 BE[F053]                	mov	si, msg_format_question
  3432 000010E8 E8930A                  	call	print_msg
  3433                                  C_09:
  3434 000010EB 30E4                    	xor	ah, ah
  3435 000010ED CD16                    	int	16h
  3436                                  
  3437 000010EF 3C1B                    	cmp	al, 1Bh ; ESCAPE
  3438 000010F1 74A2                    	je	short C_06
  3439                                  
  3440 000010F3 24DF                    	and	al, 0DFh ; capitalization
  3441 000010F5 3C59                    	cmp	al, 'Y'
  3442 000010F7 740C                    	je	short C_10
  3443 000010F9 3C4E                    	cmp	al, 'N'
  3444 000010FB 75EE                    	jne	short C_09
  3445 000010FD BE[AA5C]                	mov	si, _msg_NO 
  3446 00001100 E87B0A                  	call	print_msg
  3447                                  	;jmp	short C_06
  3448                                  	; 24/02/2019
  3449 00001103 EB97                    	jmp	short save_mbr_exit 
  3450                                  C_10:
  3451 00001105 BE[A45C]                	mov	si, _msg_YES
  3452 00001108 E8730A                  	call	print_msg
  3453                                  
  3454                                  	; [pp_StartSector] = partition's start sector
  3455                                  	; [pp_Sectors] = partition size including start & end sector
  3456                                  	; [partition_num_chr] = partition number + '0'
  3457                                  	; [pp_type] = partition type (for TRDOS 386 boot sector)
  3458                                  
  3459 0000110B 8926[4C68]              	mov	[old_sp], sp
  3460                                  	
  3461 0000110F 8A16[DD6C]              	mov	dl, [pp_type]
  3462                                  	; DL = partition type (file system ID)
  3463                                  	;dec	dl
  3464                                  	;jz	FAT12_hd_format
  3465 00001113 80FA01                  	cmp	dl, 1 ; 14/09/2020 (BugFix)
  3466 00001116 0F86D105                	jna	FAT12_hd_format
  3467                                  	;cmp	dl, 4
  3468                                  	;je	FAT16_hd_format
  3469                                  	;cmp	dl, 6
  3470                                  	;je	FAT16_hd_format
  3471 0000111A 80FA0B                  	cmp	dl, 0Bh 
  3472 0000111D 0F82D203                	jb	FAT16_hd_format
  3473                                  	;je	short FAT32_hd_format
  3474                                  	;cmp	dl, 0Ch ; 14/09/2020
  3475 00001121 0F875E07                	ja	SINGLIX_hd_format
  3476                                  
  3477                                  	;cmp	dl, 0A1h
  3478                                  	;je	SINGLIX_hd_format
  3479                                  	;jb	RUNIX386_hd_format ; dl = 071h
  3480                                  
  3481                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3482                                  ; FAT32 FORMATTING
  3483                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3484                                  	
  3485                                  	; 08/02/2019 (Modified for -only- FAT32 CHS partitions)
  3486                                  FAT32_hd_format:
  3487                                  	;mov	ax, 000Ch ; db 0Ch, 00h ; 'or al, 0'
  3488                                  	;cmp	dl, al ; 0Ch
  3489                                  	;je	short FAT32_lbAx_format
  3490                                  	;mov	ax, 0C00Bh ; db 0Bh, 0C0h ; 'or ax, ax'
  3491                                  ;FAT32_lba_format:
  3492                                  	; Put TRDOS 386 FAT32 partition magic word 
  3493                                  	; at offset 5Ah, in TRDOS386 FAT32 boot sector 0.
  3494 00001125 BD[5733]                	mov	bp, TRDOS_FAT32_hd_bs
  3495 00001128 8D7E03                  	lea	di, [bp+3]
  3496 0000112B BE[2464]                	mov	si, bs_oem_name
  3497 0000112E B90400                  	mov	cx, 4
  3498 00001131 F3A5                    	rep	movsw 
  3499                                  	;mov	[bp+5Ah], ax	; [loc_5A]
  3500 00001133 C7465A0BC0              	mov	word [bp+5Ah], 0C00Bh ; 08/02/2019
  3501 00001138 A1[6A3F]                	mov	ax, [sectors]
  3502 0000113B 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  3503 0000113E A1[6C3F]                	mov	ax, [heads]
  3504 00001141 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  3505 00001144 A1[D46C]                	mov	ax, [pp_StartSector]
  3506 00001147 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  3507 0000114A A1[D66C]                	mov	ax, [pp_StartSector+2]
  3508 0000114D 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  3509                                  	;mov	ax, [pp_Sectors]
  3510 00001150 A1[066D]                	mov	ax, [ppn_Sectors] ; 16/02/2019
  3511 00001153 894620                  	mov	[bp+20h], ax	; [BPB_TotSec32]
  3512                                  	;mov	dx, [pp_Sectors+2]
  3513 00001156 8B16[086D]              	mov	dx, [ppn_Sectors+2] ; 16/02/2019
  3514 0000115A 895622                  	mov	[bp+22h], dx	; [BPB_TotSec32+2]
  3515                                  	
  3516                                  	; Sectors per cluster calculation
  3517                                  	; (According to MS FAT32 FS specification.)
  3518 0000115D B108                    	mov	cl, 8  ; 8 sectors per cluster
  3519 0000115F 83FA08                  	cmp	dx, 8  ; >= 532480 sectors
  3520 00001162 7709                    	ja	short FAT32_f_2 ; 8 sectors per cluster
  3521 00001164 7205                    	jb	short FAT32_f_1 ; 1 sector per cluster
  3522 00001166 3D0020                  	cmp	ax, 2000h ; dx_ax = (8*65536)+8192
  3523 00001169 7302                    	jnb	short FAT32_f_2 ; 12/09/2020 (BugFix)
  3524                                  FAT32_f_1:
  3525 0000116B B101                    	mov	cl, 1	; 1 sector per cluster
  3526                                  FAT32_f_2:
  3527 0000116D 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  3528                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  3529                                  	;mov	word [bp+0Eh], 32 ; [BPB_RsvdSecCnt] 
  3530                                  
  3531                                  	; Calculating FAT size in sectors
  3532                                  	; (According to MS FAT32 FS Specification, 2000)
  3533                                  
  3534                                  	; DX_AX = partition (volume) size in sectors
  3535 00001170 2B460E                  	sub	ax, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  3536 00001173 83DA00                  	sbb	dx, 0
  3537                                  		; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  3538                                  		;	     		RootDirsectors)
  3539                                  		; RootDirSectors = 0 (for FAT32 FS)
  3540 00001176 89CB                    	mov	bx, cx ; ch = 0
  3541 00001178 C1E308                  	shl	bx, 8 ; * 256
  3542 0000117B 8A4E10                  	mov	cl, [bp+10h] ; [BPB_NumFATs] 
  3543 0000117E 01CB                    	add	bx, cx	
  3544                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  3545 00001180 D1EB                    	shr	bx, 1
  3546                                  		; TmpVal2 = TmpVal2/2
  3547 00001182 89D9                    	mov	cx, bx
  3548 00001184 4B                      	dec	bx  ; TmpVal2-1
  3549 00001185 01D8                    	add	ax, bx
  3550 00001187 83D200                  	adc	dx, 0
  3551 0000118A E8F0FA                  	call	div32
  3552                                  		; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  3553                                  	; DX_AX = FAT size in sectors
  3554 0000118D 894624                  	mov	[bp+24h], ax	; [BPB_FATSz32]
  3555 00001190 895626                  	mov	[bp+26h], dx	; [BPB_FATSz32+2]
  3556                                  	; * 2
  3557 00001193 89D3                    	mov	bx, dx
  3558 00001195 01C0                    	add	ax, ax
  3559 00001197 11D3                    	adc	bx, dx
  3560                                  	; BX_AX = [BPB_NumFATs] * [BPB_FATSz32]
  3561 00001199 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  3562 0000119C 01C1                    	add	cx, ax
  3563 0000119E 83D300                  	adc	bx, 0
  3564                                  	; BX_CX = [BPB_RsvdSecCnt]+[BPB_NumFATs]*[BPB_FATSz32]
  3565 000011A1 8B4620                  	mov	ax, [bp+20h]	; [BPB_TotSec32]
  3566 000011A4 8B5622                  	mov	dx, [bp+22h]	; [BPB_TotSec32+2]
  3567 000011A7 29C8                    	sub	ax, cx
  3568 000011A9 19DA                    	sbb	dx, bx
  3569 000011AB 890E[4E6A]              	mov	[data_start], cx
  3570 000011AF 891E[506A]              	mov	[data_start+2], bx
  3571                                  	; DX_AX = Data sectors
  3572 000011B3 A3[526A]                	mov	[data_sectors], ax
  3573 000011B6 8916[546A]              	mov	[data_sectors+2], dx
  3574 000011BA 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  3575 000011BD 30ED                    	xor	ch, ch
  3576 000011BF E8BBFA                  	call	div32 ; DX_AX/CX
  3577                                  	; DX_AX = Count of clusters (rounded down)
  3578 000011C2 A3[566A]                	mov	[cluster_count], ax
  3579 000011C5 8916[586A]              	mov	[cluster_count+2], dx
  3580                                  		
  3581 000011C9 8D7E47                  	lea	di, [bp+71] ; [BS_VolLab]
  3582 000011CC E89B01                  	call	write_volume_name
  3583 000011CF 8D7643                  	lea	si, [bp+67] ; [BS_VolID]
  3584 000011D2 E8F401                  	call	write_volume_serial
  3585 000011D5 E80503                  	call	write_cluster_count
  3586                                  
  3587 000011D8 E87502                  	call	write_formatting_msg
  3588 000011DB B000                    	mov	al, 0
  3589 000011DD E8D102                  	call	write_format_percent_x
  3590                                  
  3591 000011E0 8B461C                  	mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  3592 000011E3 8B561E                  	mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  3593 000011E6 0106[4E6A]              	add	[data_start], ax
  3594 000011EA 1116[506A]              	adc	[data_start+2], dx
  3595                                  FAT32_f_3:
  3596                                  	; DX_AX = FAT32 Boot Sector address
  3597 000011EE BB[5733]                	mov	bx, TRDOS_FAT32_hd_bs
  3598                                  	; ES:BX = Boot Sector 1 Buffer
  3599 000011F1 E8EF09                  	call	write_hd_sector
  3600 000011F4 0F82CD02                	jc	formatting_error
  3601 000011F8 E87902                  	call	write_format_percent
  3602 000011FB 83C001                  	add	ax, 1
  3603 000011FE 83D200                  	adc	dx, 0
  3604 00001201 BB[3A66]                	mov	bx, HDFORMAT_FSINFO_BUFF
  3605                                  	; ES:BX = FS INFO Sector Buffer (= BS+1)
  3606 00001204 E8DC09                  	call	write_hd_sector
  3607 00001207 0F82BA02                	jc	formatting_error
  3608 0000120B E86602                  	call	write_format_percent
  3609 0000120E 83C001                  	add	ax, 1
  3610 00001211 83D200                  	adc	dx, 0	
  3611 00001214 BB[5735]                	mov	bx, TRDOS_FAT32_hd_bs + 512
  3612                                  	; ES:BX = Boot Sector 2 Buffer
  3613 00001217 E8C909                  	call	write_hd_sector
  3614 0000121A 0F82A702                	jc	formatting_error
  3615 0000121E E85302                  	call	write_format_percent
  3616 00001221 B90300                  	mov	cx, 3
  3617                                  FAT32_f_4:
  3618 00001224 51                      	push	cx
  3619 00001225 83C001                  	add	ax, 1
  3620 00001228 83D200                  	adc	dx, 0
  3621 0000122B BB[4E68]                	mov	bx, HDFORMAT_EMPTY_BUFF
  3622 0000122E E8B209                  	call	write_hd_sector
  3623 00001231 0F829002                	jc	formatting_error
  3624 00001235 E83C02                  	call	write_format_percent
  3625 00001238 59                      	pop	cx
  3626 00001239 FEC9                    	dec	cl
  3627 0000123B 75E7                    	jnz	short FAT32_f_4
  3628 0000123D 83C001                  	add	ax, 1
  3629 00001240 83D200                  	adc	dx, 0
  3630 00001243 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  3631 00001246 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  3632 00001249 83C10C                  	add	cx, 12
  3633 0000124C 83D300                  	adc	bx, 0
  3634                                  	; write BACKUP sectors
  3635                                  	; (6,7,8 boot+fsi and 9,10,11 empty sectors)
  3636 0000124F 39DA                    	cmp	dx, bx
  3637 00001251 729B                    	jb	short FAT32_f_3
  3638 00001253 39C8                    	cmp	ax, cx
  3639 00001255 7297                    	jb	short FAT32_f_3
  3640                                  	; write remain part of reserved sectors
  3641 00001257 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt]
  3642 0000125A 83E90C                  	sub	cx, 12
  3643 0000125D 7618                    	jna	short FAT32_f_6
  3644                                  FAT32_f_5:
  3645 0000125F 51                      	push	cx
  3646 00001260 BB[4E68]                	mov	bx, HDFORMAT_EMPTY_BUFF
  3647 00001263 E87D09                  	call	write_hd_sector
  3648 00001266 0F825B02                	jc	formatting_error
  3649 0000126A E80702                  	call	write_format_percent
  3650 0000126D 83C001                  	add	ax, 1
  3651 00001270 83D200                  	adc	dx, 0
  3652 00001273 59                      	pop	cx
  3653 00001274 49                      	dec	cx
  3654 00001275 75E8                    	jnz	short FAT32_f_5
  3655                                  FAT32_f_6:
  3656                                  	; write FAT sectors
  3657 00001277 8B0E[4E6A]              	mov	cx, [data_start] ; lba/abs addr
  3658 0000127B 8B1E[506A]              	mov	bx, [data_start+2] ; lba/abs addr
  3659 0000127F 53                      	push	bx
  3660 00001280 51                      	push	cx
  3661 00001281 BB[4E68]                	mov	bx, HDFORMAT_FATBUFFER
  3662                                  	; ES:BX = FAT Sector Buffer
  3663 00001284 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  3664 00001287 B5FF                    	mov	ch, 0FFh
  3665 00001289 890F                    	mov	[bx], cx
  3666 0000128B 88E9                    	mov	cl, ch ; cx = 0FFFFh
  3667 0000128D 894F02                  	mov	[bx+2], cx
  3668 00001290 894F04                  	mov	[bx+4], cx
  3669 00001293 894F06                  	mov	[bx+6], cx
  3670                                  	; Root dir cluster number = 2
  3671                                  	; 0FFFFFFFh = end of cluster chain 
  3672 00001296 894F08                  	mov	[bx+8], cx  ; 0FFFFh
  3673 00001299 80E50F                  	and	ch, 0Fh
  3674 0000129C 894F0A                  	mov	[bx+10], cx ; 0FFFh
  3675                                  	;inc	cx
  3676 0000129F E84109                  	call	write_hd_sector
  3677 000012A2 0F821F02                	jc	formatting_error
  3678 000012A6 E8CB01                  	call	write_format_percent
  3679                                  	;mov	bx, HDFORMAT_FATBUFFER
  3680 000012A9 B90000                  	mov	cx, 0
  3681 000012AC 890F                    	mov	[bx], cx
  3682 000012AE 894F02                  	mov	[bx+2], cx
  3683 000012B1 894F04                  	mov	[bx+4], cx
  3684 000012B4 894F06                  	mov	[bx+6], cx
  3685 000012B7 894F08                  	mov	[bx+8], cx
  3686 000012BA 894F0A                  	mov	[bx+10], cx
  3687 000012BD EB0F                    	jmp	short FAT32_f_8
  3688                                  FAT32_f_7:	
  3689 000012BF 53                      	push	bx
  3690 000012C0 51                      	push	cx
  3691 000012C1 BB[4E68]                	mov	bx, HDFORMAT_FATBUFFER
  3692 000012C4 E81C09                  	call	write_hd_sector
  3693 000012C7 0F82FA01                	jc	formatting_error
  3694 000012CB E8A601                  	call	write_format_percent
  3695                                  FAT32_f_8:	
  3696 000012CE 59                      	pop	cx
  3697 000012CF 5B                      	pop	bx
  3698 000012D0 83C001                  	add	ax, 1
  3699 000012D3 83D200                  	adc	dx, 0
  3700 000012D6 39DA                    	cmp	dx, bx
  3701 000012D8 72E5                    	jb	short FAT32_f_7
  3702 000012DA 39C8                    	cmp	ax, cx
  3703 000012DC 72E1                    	jb	short FAT32_f_7
  3704                                  
  3705                                  	; write	root directory (1st cluster)
  3706                                  	; as empty sectors
  3707 000012DE 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  3708 000012E1 30ED                    	xor	ch, ch
  3709 000012E3 290E[526A]              	sub	[data_sectors], cx
  3710 000012E7 831E[546A]00            	sbb	word [data_sectors+2], 0
  3711                                  FAT32_f_9:
  3712 000012EC 51                      	push	cx
  3713 000012ED BB[4E68]                	mov	bx, HDFORMAT_EMPTY_BUFF
  3714 000012F0 E8F008                  	call	write_hd_sector
  3715 000012F3 0F82CE01                	jc	formatting_error
  3716 000012F7 E87A01                  	call	write_format_percent
  3717 000012FA 83C001                  	add	ax, 1
  3718 000012FD 83D200                  	adc	dx, 0
  3719 00001300 59                      	pop	cx
  3720 00001301 FEC9                    	dec	cl
  3721 00001303 75E7                    	jnz	short FAT32_f_9
  3722                                  
  3723                                  	; write DATA sectors 
  3724                                  	; (after root directory 1st cluster)
  3725 00001305 8B0E[526A]              	mov	cx, [data_sectors]
  3726 00001309 8B1E[546A]              	mov	bx, [data_sectors+2] 
  3727                                  			; NOTE: Partition size must be >= 512 MB
  3728                                  			;	for FAT32 FS  ((BX >= 15))
  3729                                  FAT32_f_10:	
  3730 0000130D 53                      	push	bx
  3731 0000130E 51                      	push	cx	
  3732 0000130F BB[3A64]                	mov	bx, HDFORMAT_SECBUFFER
  3733 00001312 E8CE08                  	call	write_hd_sector
  3734 00001315 0F82AC01                	jc	formatting_error
  3735 00001319 E85801                  	call	write_format_percent
  3736 0000131C 59                      	pop	cx
  3737 0000131D 5B                      	pop	bx
  3738 0000131E 83C001                  	add	ax, 1
  3739 00001321 83D200                  	adc	dx, 0
  3740 00001324 49                      	dec	cx
  3741 00001325 75E6                    	jnz	short FAT32_f_10
  3742 00001327 4B                      	dec	bx
  3743 00001328 75E3                    	jnz	short FAT32_f_10
  3744                                  
  3745                                  	; If there are, format remain sectors which are
  3746                                  	; at beyond of data clusters, with zero bytes.
  3747                                  	
  3748 0000132A 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  3749 0000132D 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  3750                                  FAT16_f_18:	
  3751 00001330 034E20                  	add	cx, [bp+20h]	; [BPB_TotSec32]
  3752 00001333 135E22                  	adc	bx, [bp+22h]	; [BPB_TotSec32+2]
  3753                                  FAT16_f_19:
  3754                                  FAT12_f_8:
  3755                                  	; are there remain sectors (in partition) ?
  3756 00001336 29C1                    	sub	cx, ax
  3757 00001338 19D3                    	sbb	bx, dx
  3758                                  	; 11/02/2019
  3759                                  	; BX must be 0 (Because, 1 cluster <= 32KB. So, 
  3760                                  	;	        remain sectors must not be more than 32K)
  3761 0000133A 751C                    	jnz	short FAT32_f_12 ; There is a wrong thing !!!
  3762                                  				 ; If BX is not zero,	
  3763                                  				 ; it is better to skip this stage...)
  3764 0000133C 09C9                    	or	cx, cx		
  3765 0000133E 7418                    	jz	short FAT32_f_12 ; no..
  3766                                  				 ; (good! FAT contains all data sectors)
  3767                                  FAT32_f_11:
  3768 00001340 51                      	push	cx
  3769 00001341 BB[4E68]                	mov	bx, HDFORMAT_EMPTY_BUFF
  3770 00001344 E89C08                  	call	write_hd_sector
  3771 00001347 0F827A01                	jc	formatting_error
  3772 0000134B E82601                  	call	write_format_percent
  3773 0000134E 59                      	pop	cx
  3774 0000134F 83C001                  	add	ax, 1
  3775 00001352 83D200                  	adc	dx, 0
  3776 00001355 49                      	dec	cx
  3777 00001356 75E8                    	jnz	short FAT32_f_11
  3778                                  
  3779                                  FAT32_f_12:
  3780                                  SINGLIX_fs1_f_12:
  3781                                  	; End of FAT format routine...
  3782                                  end_of_formatting:
  3783 00001358 B064                    	mov	al, 100
  3784 0000135A E85401                  	call	write_format_percent_x
  3785                                  	;mov	si, CRLF
  3786                                  	;call	print_msg
  3787 0000135D BE[6755]                	mov	si, Msg_OK
  3788                                  	;call	print_msg
  3789                                  	;jmp	_exit
  3790                                  	; 19/10/2020
  3791 00001360 E947F4                  	jmp	_p_exit
  3792                                  
  3793                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3794                                  ; set & write volume name
  3795                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3796                                  
  3797                                  write_fs_volume_name:
  3798 00001363 C606[2364]40            	mov	byte [vname_length], 64
  3799 00001368 EB05                    	jmp	short svn_fs
  3800                                  
  3801                                  write_volume_name:
  3802 0000136A C606[2364]0B            	mov	byte [vname_length], 11
  3803                                  svn_fs:
  3804                                  	; DI = (BS) Volume Label address
  3805 0000136F BE[0955]                	mov	si, Msg_Volume_Name
  3806 00001372 E80908                  	call	print_msg
  3807                                  
  3808                                  	; get cursor position
  3809                                  	; bh = 0  ; video page
  3810 00001375 B403                    	mov     ah, 3 ; get cursor pos
  3811 00001377 CD10                    	int     10h
  3812 00001379 8916[AF54]              	mov	[Cursor_Pos], dx
  3813                                  
  3814 0000137D E8EB08                  	call	rw_char
  3815 00001380 7207                    	jc	short svn_1
  3816                                  svn_0:
  3817 00001382 AC                      	lodsb
  3818 00001383 3C20                    	cmp	al, 20h
  3819 00001385 7706                    	ja	short svn_2
  3820 00001387 74F9                    	je	short svn_0 
  3821                                  svn_1:
  3822 00001389 BE[2E64]                	mov	si, no_name
  3823 0000138C AC                      	lodsb
  3824                                  svn_2:
  3825                                  	;mov	di, [bp+47h) ; [BS_VolLab] ; FAT32
  3826                                  	;mov	di, [bp+2Bh) ; [BS_VolLab] ; FAT16 (&FAT12)
  3827 0000138D 89FB                    	mov	bx, di ; *
  3828 0000138F 30ED                    	xor	ch, ch
  3829 00001391 8A0E[2364]              	mov	cl, [vname_length] ; 11
  3830 00001395 EB05                    	jmp	short svn_4
  3831                                  svn_3:
  3832 00001397 AC                      	lodsb
  3833 00001398 3C20                    	cmp	al, 20h
  3834 0000139A 7226                    	jb	short svn_6
  3835                                  svn_4:
  3836 0000139C AA                      	stosb
  3837 0000139D E2F8                    	loop	svn_3
  3838                                  svn_5:
  3839 0000139F 8A0E[2364]              	mov	cl, [vname_length] ; 11
  3840 000013A3 89DE                    	mov	si, bx ; *
  3841 000013A5 BF[C854]                	mov	di, StrVolumeName
  3842 000013A8 F3A4                    	rep	movsb
  3843                                  	;mov	byte [di], 0
  3844                                  
  3845 000013AA 8B16[AF54]              	mov	dx, [Cursor_Pos]
  3846 000013AE BB0700                  	mov	bx, 7
  3847 000013B1 B402                    	mov	ah, 2
  3848 000013B3 CD10                    	int	10h  ; Set Cursor Position
  3849                                  
  3850 000013B5 BE[C854]                	mov	si, StrVolumeName
  3851 000013B8 E8C307                  	call	print_msg
  3852 000013BB BE[6B55]                	mov	si, CRLF
  3853 000013BE E8BD07                  	call	print_msg
  3854 000013C1 C3                      	retn
  3855                                  svn_6:
  3856 000013C2 B020                    	mov	al, 20h
  3857                                  svn_7:
  3858 000013C4 AA                      	stosb
  3859 000013C5 E2FD                    	loop	svn_7
  3860 000013C7 EBD6                    	jmp	short svn_5
  3861                                  
  3862                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3863                                  ; set & write volume serial number (volume ID)
  3864                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3865                                  
  3866                                  write_volume_serial:
  3867                                  	; SI = (BS) Volume Serial Number (binary) address
  3868                                  
  3869                                  	;xor	ax, ax
  3870                                  	;int	1Ah			; get time of day
  3871                                  
  3872                                  	;mov	[si], dx
  3873                                  	;mov	[si+2], cx		; set unique volume ID
  3874                                  
  3875                                  	;mov	ah, 02h			; Return Current Time
  3876                                  	;int	1Ah
  3877                                  	;xchg	ch, cl
  3878                                  	;xchg	dh, dl
  3879                                  
  3880                                  	;add	cx, dx
  3881                                  	;add	[si+2], cx
  3882                                                 
  3883                                  	;mov	ah, 04h			; Return Current Date
  3884                                  	;int	1Ah
  3885                                  
  3886                                  	;xchg	ch,cl
  3887                                  	;xchg	dh,dl
  3888                                  
  3889                                  	;add	cx, dx
  3890                                  	;add	[si+2], cx
  3891                                  
  3892                                  	; According to Microsoft DOS 6.0 serial number
  3893                                  	; production method...
  3894                                  	; < Create unique 32 bit serial number >
  3895                                  
  3896                                  	; Create_Serial_ID (MSDOS 6.0 Source code, MSFOR.ASM)
  3897                                  	; (20/04/1987)
  3898                                  	;
  3899                                  	;  Get date (INT 21h, AH=2Bh)
  3900                                  	;  Get time (INT 21h, AH=2Ch)
  3901                                  	;  Serial_ID+0 = DX reg date + DX reg time
  3902                                  	;  Serial_ID+2 = CX reg date + CX reg time
  3903                                  	;  Serial_Num_Low = Serial_ID+2
  3904                                  	;  Serial_Num_High = Serial_ID+0
  3905                                  
  3906 000013C9 B404                    	mov	ah, 04h		; Return Current Date
  3907 000013CB CD1A                    	int	1Ah
  3908                                  
  3909                                  	; DL = Day (BCD)	(20h)
  3910                                  	; DH = Month (BCD)	(12h)
  3911                                  	; CH = Century (BCD)	(20h)
  3912                                  	; CL = Year (BCD) 	(17h)
  3913                                  
  3914 000013CD 88D0                    	mov	al, dl
  3915 000013CF E87100                  	call	bcd_to_bin
  3916 000013D2 88C2                    	mov	dl, al 
  3917 000013D4 88F0                    	mov	al, dh
  3918 000013D6 E86A00                  	call	bcd_to_bin
  3919 000013D9 88C6                    	mov	dh, al 
  3920 000013DB 88C8                    	mov	al, cl
  3921 000013DD E86300                  	call	bcd_to_bin
  3922 000013E0 88C1                    	mov	cl, al 
  3923 000013E2 88E8                    	mov	al, ch
  3924 000013E4 E85C00                  	call	bcd_to_bin
  3925 000013E7 88C5                    	mov	ch, al
  3926                                  
  3927                                  	; DH = Month (1-10)
  3928                                  	; DL = Day (1-31)
  3929                                  	; CX = Year (1900-2099)
  3930                                  
  3931 000013E9 52                      	push	dx 
  3932 000013EA 51                      	push	cx
  3933                                  
  3934 000013EB B402                    	mov	ah, 02h		; Return Current Time
  3935 000013ED CD1A                    	int	1Ah
  3936                                  	
  3937                                  	; DH = Seconds (BCD)	(59h)
  3938                                  	; CL = Minutes (BCD)	(59h)
  3939                                  	; CH = Hours (BCD)	(23h)
  3940                                  	; DL = Daylight savings time option (1=yes)
  3941                                  
  3942 000013EF 88F0                    	mov	al, dh
  3943 000013F1 E84F00                  	call	bcd_to_bin
  3944 000013F4 88C6                    	mov	dh, al 
  3945 000013F6 88C8                    	mov	al, cl
  3946 000013F8 E84800                  	call	bcd_to_bin
  3947 000013FB 88C1                    	mov	cl, al 
  3948 000013FD 88E8                    	mov	al, ch
  3949 000013FF E84100                  	call	bcd_to_bin
  3950 00001402 88C5                    	mov	ch, al 
  3951                                  
  3952                                  	; CH = Hour (0-23)
  3953                                  	; CL = Minutes (0-59)
  3954                                  	; DH = Seconds (0-59)
  3955                                  	; ((DL = Hundredths (0-99) - MSDOS!))
  3956                                  	; DL = 0 or 1 (here!)
  3957                                  
  3958 00001404 89C8                    	mov	ax, cx
  3959 00001406 59                      	pop	cx
  3960 00001407 01C8                    	add	ax, cx
  3961                                  
  3962 00001409 894402                  	mov	[si+2], ax
  3963                                  
  3964 0000140C 89D0                    	mov	ax, dx
  3965 0000140E 5A                      	pop	dx
  3966 0000140F 01D0                    	add	ax, dx
  3967                                  
  3968 00001411 8904                    	mov	[si], ax
  3969                                  
  3970 00001413 30E4                    	xor	ah, ah		; Read time counter
  3971 00001415 CD1A                    	int	1Ah
  3972                                  
  3973                                  	; CX = High word of clock count
  3974                                  	; DX = Low word of clock count
  3975                                  	; AL = 0 if 24 hours has not passed, else 1
  3976                                  
  3977                                  	; NOTES: 
  3978                                  	; (Ref: vitaly_filatov.tripod.com/ng/asm/asm_029.1.html)
  3979                                  	;
  3980                                     	; Following formulas convert the clock count to
  3981                                          ; the time of day:
  3982                                   	;	Hour      = Clock / 65543 (1007h)
  3983                                  	;	Remainder = Clock MOD 65543
  3984                                   	;
  3985                                  	;	Minutes   = Remainder / 1092 (444h)
  3986                                  	;	Remainder = Remainder MOD 1092
  3987                                  	;
  3988                                  	;	Second    = Remainder / 18.21
  3989                                  	;	Remainder = Remainder MOD 18.21
  3990                                  	;
  3991                                  	;	Hundredths = CINT(Remainder * 100)
  3992                                  
  3993 00001417 0014                    	add	[si], dl
  3994                                  
  3995                                  	; SI = Volume serial number address (4 bytes) 
  3996 00001419 8A04                    	mov	al, [si]
  3997 0000141B E83608                  	call	bin_to_hex
  3998 0000141E A3[3455]                	mov	[Vol_Serial2+2], ax
  3999 00001421 8A4401                  	mov	al, [si+1]
  4000 00001424 E82D08                  	call	bin_to_hex
  4001 00001427 A3[3255]                	mov	[Vol_Serial2], ax
  4002 0000142A 8A4402                  	mov	al, [si+2]
  4003 0000142D E82408                  	call	bin_to_hex
  4004 00001430 A3[2F55]                	mov	[Vol_Serial1+2], ax
  4005 00001433 8A4403                  	mov	al, [si+3]
  4006 00001436 E81B08                  	call	bin_to_hex
  4007 00001439 A3[2D55]                	mov	[Vol_Serial1], ax
  4008                                  
  4009 0000143C BE[1B55]                	mov	si, Msg_Volume_Serial
  4010 0000143F E83C07                  	call	print_msg
  4011                                  
  4012 00001442 C3                      	retn
  4013                                  
  4014                                  bcd_to_bin:
  4015 00001443 53                      	push	bx
  4016 00001444 D410                    	db	0D4h,10h  ; Undocumented inst. AAM
  4017                                  			  ; AH = AL / 10h
  4018                                  			  ; AL = AL MOD 10h
  4019 00001446 88C3                    	mov	bl, al
  4020 00001448 B00A                    	mov	al, 10
  4021 0000144A F6E4                    	mul	ah
  4022 0000144C 00D8                    	add	al, bl
  4023 0000144E 5B                      	pop	bx
  4024 0000144F C3                      	retn
  4025                                  
  4026                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4027                                  ; write formatting percentage
  4028                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4029                                  
  4030                                  write_formatting_msg:
  4031                                  	;mov	ax, [pp_Sectors]
  4032                                  	;mov	dx, [pp_Sectors+2]
  4033                                  	; 16/02/2019
  4034 00001450 A1[066D]                	mov	ax, [ppn_Sectors]
  4035 00001453 8B16[086D]              	mov	dx, [ppn_Sectors+2]
  4036                                  
  4037                                  	; DX_AX = Total sectors for percentage
  4038                                  	;mov	cx, 100	
  4039 00001457 B90064                  	mov	cx, 256*100 ; 16/03/2021 
  4040 0000145A E820F8                  	call	div32
  4041 0000145D A3[5C6A]                	mov	[format_percent], ax
  4042                                  
  4043 00001460 BE[5355]                	mov	si, msg_formatting
  4044 00001463 E81807                  	call	print_msg
  4045                                  
  4046                                  	; get cursor position
  4047                                  	; bh = 0  ; video page
  4048 00001466 B403                    	mov     ah, 3 ; get cursor pos
  4049 00001468 CD10                    	int     10h
  4050 0000146A 8916[AF54]              	mov	[Cursor_Pos], dx
  4051                                  
  4052 0000146E C606[5E6A]FF            	mov	byte [prev_percent], 255
  4053                                  
  4054 00001473 C3                      	retn
  4055                                  
  4056                                  write_format_percent:
  4057                                  	; DX_AX = Current sector (which has been written)
  4058                                  
  4059 00001474 50                      	push	ax
  4060 00001475 52                      	push	dx
  4061 00001476 53                      	push	bx
  4062 00001477 51                      	push	cx
  4063 00001478 56                      	push	si
  4064                                  
  4065 00001479 2B461C                  	sub	ax, [bp+1Ch]	; [BPB_HiddSec]
  4066 0000147C 1B561E                  	sbb	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  4067                                  wpc_t:
  4068 0000147F 8B0E[5C6A]              	mov	cx, [format_percent]
  4069 00001483 E8F7F7                  	call	div32
  4070                                  	; AL = percentage value between 1 to 100
  4071                                  	; 16/03/2021
  4072                                  	; AH = percentage value between 1 to 100
  4073                                  wpc_x:
  4074                                  	;cmp	al, [prev_percent]
  4075                                  	;je	short wpc_y
  4076                                  	;mov	[prev_percent], al
  4077                                  	; 16/03/2021
  4078 00001486 3A26[5E6A]              	cmp	ah, [prev_percent]
  4079 0000148A 741F                    	je	short wpc_y
  4080 0000148C 8826[5E6A]              	mov	[prev_percent], ah
  4081 00001490 8B16[AF54]              	mov	dx, [Cursor_Pos]
  4082 00001494 BB0700                  	mov	bx, 7
  4083 00001497 B402                    	mov	ah, 2
  4084 00001499 CD10                    	int	10h  ; Set Cursor Position
  4085 0000149B 31D2                    	xor	dx, dx
  4086 0000149D 30E4                    	xor	ah, ah
  4087 0000149F A0[5E6A]                	mov	al, [prev_percent] ; 16/03/2021
  4088 000014A2 BE[6155]                	mov	si, format_percent_str + 2
  4089 000014A5 E89507                  	call	bin_to_decimal
  4090 000014A8 E8D306                  	call	print_msg
  4091                                  wpc_y:
  4092 000014AB 5E                      	pop	si
  4093 000014AC 59                      	pop	cx
  4094 000014AD 5B                      	pop	bx
  4095 000014AE 5A                      	pop	dx
  4096 000014AF 58                      	pop	ax
  4097 000014B0 C3                      	retn
  4098                                  
  4099                                  write_format_percent_x:
  4100                                  	; AL = % number
  4101                                  
  4102 000014B1 50                      	push	ax
  4103 000014B2 52                      	push	dx
  4104 000014B3 53                      	push	bx
  4105 000014B4 51                      	push	cx
  4106 000014B5 56                      	push	si
  4107                                  
  4108 000014B6 EBCE                    	jmp	short wpc_x
  4109                                  
  4110                                  write_fs_format_percent:
  4111                                  	; DX_AX = Current sector (which has been written)
  4112                                  
  4113 000014B8 50                      	push	ax
  4114 000014B9 52                      	push	dx
  4115 000014BA 53                      	push	bx
  4116 000014BB 51                      	push	cx
  4117 000014BC 56                      	push	si
  4118                                  
  4119 000014BD 2B460C                  	sub	ax, [bp+0Ch]	; [bsBeginSector]
  4120 000014C0 1B560E                  	sbb	dx, [bp+0Eh]	; [bsBeginSector+2]
  4121 000014C3 EBBA                    	jmp	short wpc_t
  4122                                  	
  4123                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4124                                  ; format error 
  4125                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4126                                  
  4127                                  formatting_error:
  4128 000014C5 8B26[4C68]              	mov	sp, [old_sp]
  4129                                  
  4130 000014C9 88E0                    	mov	al, ah ;  error code
  4131 000014CB E88607                  	call	bin_to_hex
  4132 000014CE A3[7955]                	mov 	[error_code], ax
  4133                                  
  4134 000014D1 BE[6B55]                	mov	si, CRLF
  4135 000014D4 E8A706                  	call	print_msg
  4136                                  
  4137 000014D7 BE[6E55]                	mov	si, Msg_Error
  4138                                  	;call	print_msg
  4139                                  	;jmp	_exit
  4140                                  	; 19/10/2020
  4141 000014DA E9CDF2                  	jmp	_p_exit
  4142                                  
  4143                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4144                                  ; write cluster count
  4145                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4146                                  
  4147                                  write_cluster_count:
  4148 000014DD BE[3955]                	mov	si, msg_cluster_count
  4149 000014E0 E89B06                  	call	print_msg
  4150 000014E3 A1[566A]                	mov	ax, [cluster_count]
  4151 000014E6 8B16[586A]              	mov	dx, [cluster_count+2]
  4152 000014EA BE[4F55]                	mov	si, cluster_count_str+6
  4153 000014ED E84D07                  	call	bin_to_decimal
  4154                                  	;call	print_msg
  4155                                  	;retn
  4156                                  	; 19/10/2020
  4157 000014F0 E98B06                  	jmp	print_msg 
  4158                                  
  4159                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4160                                  ; FAT16 FORMATTING
  4161                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4162                                  	; 08/02/2019 (Modified for -only- FAT16 CHS partitions)
  4163                                  FAT16_hd_format:
  4164                                  ; 04/05/2024 (Retro DOS v5 modification)
  4165                                  ; DL = Partition (FS) ID
  4166                                  ;	mov	ax, 0706h ; db 06h, 07h ; 'push es, pop es'
  4167                                  ;	cmp	dl, al ; 06h ; Big CHS partition (>= 32MB)
  4168                                  ;	je	short FAT16_big_chs_format
  4169                                  ;	;mov	ax, 070Eh ; db 0Eh, 07h	; 'push cs, pop es'
  4170                                  ;	;cmp	dl, al ; 0Eh ; LBA partition
  4171                                  ;	;je	short FAT16_lba_format
  4172                                  ;FAT16_chs_format:  
  4173                                  ;	; Partition Type: 04h, CHS (<32 MB) partition
  4174                                  ;	mov	ax, 0004h ; db 04h, 00h ; 'add al, 0'
  4175                                  ;FAT16_big_chs_format:
  4176                                  ;;;
  4177                                  ;;FAT16_lba_format:
  4178                                  	; Put TRDOS 386 FAT16 partition magic word 
  4179                                  	; at offset 3Eh, in TRDOS386 FAT16 boot sector.
  4180 000014F3 BD[5737]                	mov	bp, TRDOS_FAT16_hd_bs
  4181 000014F6 8D7E03                  	lea	di, [bp+3]
  4182 000014F9 BE[2464]                	mov	si, bs_oem_name
  4183 000014FC B90400                  	mov	cx, 4
  4184 000014FF F3A5                    	rep	movsw 
  4185                                  
  4186                                  	;mov	[bp+3Eh], ax	; [loc_3E]
  4187                                  	; 04/05/2024 (Retro DOS v5 modification)
  4188 00001501 80FA06                  	cmp	dl, 6
  4189 00001504 7404                    	je	short FAT16_f_x ; skip ; db 'RDv5 FAT16 06h', 0
  4190                                  	; dl = 04h or 0Eh
  4191 00001506 8896CE01                	mov	[bp+1CEh], dl	; Retro DOS v5 boot sect off 1CEh
  4192                                  				; (see: 'rd5hdbs.txt' for 1CEh)
  4193                                  FAT16_f_x:
  4194 0000150A A1[6A3F]                	mov	ax, [sectors]
  4195 0000150D 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  4196 00001510 A1[6C3F]                	mov	ax, [heads]
  4197 00001513 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  4198 00001516 A1[D46C]                	mov	ax, [pp_StartSector]
  4199 00001519 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  4200 0000151C A1[D66C]                	mov	ax, [pp_StartSector+2]
  4201 0000151F 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  4202                                  	;mov	ax, [pp_Sectors]
  4203 00001522 A1[066D]                	mov	ax, [ppn_Sectors] ; 16/02/2019
  4204                                  	;mov	dx, [pp_Sectors+2]
  4205 00001525 8B16[086D]              	mov	dx, [ppn_Sectors+2] ; 16/02/2019
  4206 00001529 21D2                    	and	dx, dx
  4207 0000152B 7505                    	jnz	short FAT16_f_0
  4208 0000152D 894613                  	mov	[bp+13h], ax	; [BPB_TotSec16]
  4209                                  	; CX = 0
  4210                                  	;mov	[bp+20h], cx	; [BPB_TotSec32] =  0
  4211                                  	;mov	[bp+22h], cx	; [BPB_TotSec32+2] = 0
  4212 00001530 EB06                    	jmp	short FAT16_f_1
  4213                                  FAT16_f_0:
  4214 00001532 894620                  	mov	[bp+20h], ax	; [BPB_TotSec32]
  4215                                  	;;mov	dx, [pp_Sectors+2]
  4216                                  	;mov	dx, [ppn_Sectors+2] ; 16/02/2019 
  4217 00001535 895622                  	mov	[bp+22h], dx	; [BPB_TotSec32+2]
  4218                                  	; CX = 0
  4219                                  	;mov	[bp+13h], cx ; [BPB_TotSec16] = 0
  4220                                  FAT16_f_1:
  4221                                  	; Sectors per cluster calculation
  4222                                  	; (According to MS FAT32 FS specification.)
  4223 00001538 B102                    	mov	cl, 2  ; 2 sectors per cluster
  4224 0000153A 09D2                    	or	dx, dx
  4225 0000153C 7507                    	jnz	short FAT16_f_2 ; >2 sectors (>16MB)
  4226 0000153E 3DA87F                  	cmp	ax, 32680
  4227 00001541 763C                    	jna	short FAT16_f_10 ; 2 sectors, <=16MB
  4228                                  	; > 16MB
  4229 00001543 EB38                    	jmp	short FAT16_f_9 ; 4 sectors per cluster
  4230                                  FAT16_f_2:
  4231 00001545 83FA04                  	cmp	dx, 4  ; >= 262144 sectors ; >=128MB
  4232 00001548 7708                    	ja	short FAT16_f_3 ; >4 sectors per cluster
  4233 0000154A 7231                    	jb	short FAT16_f_9 ; 4 sectors per cluster	
  4234 0000154C 09C0                    	or	ax, ax ; dx_ax = (4*65536)+0
  4235 0000154E 742D                    	jz	short FAT16_f_9 ; 4 sectors per cluster
  4236 00001550 EB29                    	jmp	short FAT16_f_8 ; 8 sectors per cluster
  4237                                  FAT16_f_3:
  4238 00001552 83FA08                  	cmp	dx, 8  ; >= 524288 sectors ; >=256MB
  4239 00001555 7708                    	ja	short FAT16_f_4 ; >8 sectors per cluster
  4240 00001557 7222                    	jb	short FAT16_f_8 ; 8 sectors per cluster	
  4241 00001559 21C0                    	and	ax, ax ; dx_ax = (8*65536)+0
  4242 0000155B 741E                    	jz	short FAT16_f_8 ; 8 sectors per cluster
  4243 0000155D EB1A                    	jmp	short FAT16_f_7 ; 16 sectors per cluster
  4244                                  FAT16_f_4:
  4245 0000155F 83FA10                  	cmp	dx, 16 ; >= 1048576 sectors ; >=512MB
  4246 00001562 7708                    	ja	short FAT16_f_5 ; >16 sectors per cluster
  4247 00001564 7213                    	jb	short FAT16_f_7 ; 16 sectors per cluster
  4248 00001566 21C0                    	and	ax, ax ; dx_ax = (16*65536)+0
  4249 00001568 740F                    	jz	short FAT16_f_7 ; 16 sectors per cluster
  4250 0000156A EB0B                    	jmp	short FAT16_f_6 ; 32 sectors per cluster
  4251                                  FAT16_f_5:
  4252 0000156C 83FA20                  	cmp	dx, 32 ; >= 2097152 sectors ; >=1GB
  4253 0000156F 7206                    	jb	short FAT16_f_6 ; 32 sectors per cluster
  4254 00001571 09C0                    	or	ax, ax		; dx_ax = (32*65536)+0
  4255 00001573 7402                    	jz	short FAT16_f_6 ; 32 sectors per cluster
  4256                                  	; >1GB (<=2GB)
  4257                                  	; 64 sectors per cluster
  4258 00001575 D0E1                    	shl	cl, 1
  4259                                  FAT16_f_6:
  4260                                  	; 32 sectors per cluster (for <= 2GB volumes)
  4261 00001577 D0E1                    	shl	cl, 1	
  4262                                  FAT16_f_7:
  4263                                  	; 16 sectors per cluster (for <= 1GB volumes)
  4264 00001579 D0E1                    	shl	cl, 1
  4265                                  FAT16_f_8:
  4266                                  	; 8 sectors per cluster (for <= 512MB volumes)
  4267 0000157B D0E1                    	shl	cl, 1	
  4268                                  FAT16_f_9:
  4269                                  	; 4 sectors per cluster (for <= 256MB volumes)
  4270 0000157D D0E1                    	shl	cl, 1	
  4271                                  FAT16_f_10:	
  4272                                  	; 2 sectors per cluster (for <= 128MB volumes)
  4273 0000157F 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  4274                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  4275                                  	;mov	word [bp+0Eh], 1 ; [BPB_RsvdSecCnt] 
  4276                                  	;mov	word [bp+11h], 512 ; [BPB_RootEntCnt]
  4277                                  	
  4278                                  	; Calculating FAT size in sectors
  4279                                  	; (According to MS FAT32 FS Specification, 2000)
  4280                                  
  4281                                  	; DX_AX = partition (volume) size in sectors
  4282 00001582 8B5E11                  	mov	bx, [bp+11h]	; [BPB_RootEntCnt] = 512
  4283 00001585 83C30F                  	add	bx, 15 ; bx = 527
  4284 00001588 C1EB04                  	shr	bx, 4 ; /16 = 527/16 = 32
  4285                                  		; ((32*BX)+511)/512
  4286 0000158B 891E[5A6A]              	mov	[root_dir_secs], bx
  4287 0000158F 035E0E                  	add	bx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4288 00001592 29D8                    	sub	ax, bx
  4289 00001594 83DA00                  	sbb	dx, 0
  4290                                  		; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  4291                                  		;	     		RootDirsectors)
  4292                                  	;mov	bx, cx ; ch = 0
  4293                                  	;shl	bx, 8 ; * 256
  4294                                  	; 11/02/2019
  4295 00001597 88CF                    	mov	bh, cl
  4296 00001599 30DB                    	xor	bl, bl
  4297 0000159B B102                    	mov	cl, 2 ; [BPB_NumFATs]
  4298 0000159D 01CB                    	add	bx, cx	
  4299                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  4300 0000159F 89D9                    	mov	cx, bx
  4301 000015A1 4B                      	dec	bx  ; TmpVal2-1
  4302 000015A2 01D8                    	add	ax, bx
  4303 000015A4 83D200                  	adc	dx, 0
  4304 000015A7 E8D3F6                  	call	div32
  4305                                  		; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  4306                                  	; AX = FAT size in sectors
  4307                                  	; DX = 0
  4308 000015AA 894616                  	mov	[bp+16h], ax	; [BPB_FATSz16]
  4309                                  	; * 2
  4310 000015AD D1E0                    	shl	ax, 1
  4311                                  	; AX = [BPB_NumFATs] * [BPB_FATSz16]
  4312 000015AF 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4313 000015B2 01C1                    	add	cx, ax
  4314                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4315 000015B4 030E[5A6A]              	add	cx, [root_dir_secs] ; + RootDirsectors
  4316 000015B8 29DB                    	sub	bx, bx ; BX = 0
  4317                                  	; BX_CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4318                                  	;	  + RootDirSectors
  4319 000015BA 8B4613                  	mov	ax, [bp+13h]	; [BPB_TotSec16]
  4320                                  	;sub	dx, dx 
  4321                                  	; DX = 0
  4322 000015BD 21C0                    	and	ax, ax
  4323 000015BF 7506                    	jnz	short FAT16_f_11
  4324 000015C1 8B4620                  	mov	ax, [bp+20h]	; [BPB_TotSec32]
  4325 000015C4 8B5622                  	mov	dx, [bp+22h]	; [BPB_TotSec32+2]
  4326                                  FAT16_f_11:
  4327 000015C7 29C8                    	sub	ax, cx
  4328 000015C9 19DA                    	sbb	dx, bx
  4329 000015CB 890E[4E6A]              	mov	[data_start], cx
  4330 000015CF 891E[506A]              	mov	[data_start+2], bx
  4331                                  	; DX_AX = Data sectors
  4332 000015D3 A3[526A]                	mov	[data_sectors], ax
  4333 000015D6 8916[546A]              	mov	[data_sectors+2], dx
  4334 000015DA 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  4335 000015DD 30ED                    	xor	ch, ch
  4336 000015DF E89BF6                  	call	div32 ; DX_AX/CX
  4337                                  	; AX = Count of clusters (rounded down)
  4338                                  	; DX = 0
  4339 000015E2 A3[566A]                	mov	[cluster_count], ax
  4340 000015E5 8916[586A]              	mov	[cluster_count+2], dx
  4341                                  
  4342 000015E9 8D7E2B                  	lea	di, [bp+43] ; [BS_VolLab]
  4343 000015EC E87BFD                  	call	write_volume_name
  4344 000015EF 8D7627                  	lea	si, [bp+39] ; [BS_VolID]
  4345 000015F2 E8D4FD                  	call	write_volume_serial
  4346 000015F5 E8E5FE                  	call	write_cluster_count	
  4347                                  
  4348 000015F8 E855FE                  	call	write_formatting_msg
  4349 000015FB B000                    	mov	al, 0
  4350 000015FD E8B1FE                  	call	write_format_percent_x
  4351                                  
  4352 00001600 8B461C                  	mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  4353 00001603 8B561E                  	mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  4354                                  
  4355 00001606 0106[4E6A]              	add	[data_start], ax
  4356 0000160A 1116[506A]              	adc	[data_start+2], dx
  4357                                  
  4358                                  	; DX_AX = FAT16 Boot Sector address
  4359 0000160E BB[5737]                	mov	bx, TRDOS_FAT16_hd_bs
  4360                                  	; ES:BX = Boot Sector Buffer
  4361 00001611 E8CF05                  	call	write_hd_sector
  4362 00001614 0F82ADFE                	jc	formatting_error
  4363 00001618 E859FE                  	call	write_format_percent
  4364 0000161B 83C001                  	add	ax, 1
  4365 0000161E 83D200                  	adc	dx, 0
  4366                                  	; write remain part of reserved sectors
  4367 00001621 8B4E0E                  	mov	cx, [bp+0Eh] ; [BPB_RsvdSecCnt]
  4368                                  	;sub	cx, 1
  4369                                  	;jna	short FAT16_f_13
  4370                                  	; 11/02/2019
  4371 00001624 49                      	dec	cx
  4372 00001625 7418                    	jz	short FAT16_f_13
  4373                                  FAT16_f_12:
  4374 00001627 51                      	push	cx
  4375 00001628 BB[4E68]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4376 0000162B E8B505                  	call	write_hd_sector
  4377 0000162E 0F8293FE                	jc	formatting_error
  4378 00001632 E83FFE                  	call	write_format_percent
  4379 00001635 83C001                  	add	ax, 1
  4380 00001638 83D200                  	adc	dx, 0
  4381 0000163B 59                      	pop	cx
  4382 0000163C 49                      	dec	cx ; dec cl
  4383 0000163D 75E8                    	jnz	short FAT16_f_12
  4384                                  FAT16_f_13:
  4385                                  	; write FAT sectors
  4386 0000163F 8B0E[4E6A]              	mov	cx, [data_start] ; lba/abs addr
  4387 00001643 8B1E[506A]              	mov	bx, [data_start+2] ; lba/abs addr
  4388                                  
  4389                                  	; 11/02/2019
  4390 00001647 2B0E[5A6A]              	sub	cx, [root_dir_secs]
  4391 0000164B 83DB00                  	sbb	bx, 0
  4392                                  
  4393 0000164E 53                      	push	bx
  4394 0000164F 51                      	push	cx
  4395 00001650 BB[4E68]                	mov	bx, HDFORMAT_FATBUFFER
  4396                                  	; ES:BX = FAT Sector Buffer
  4397 00001653 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  4398 00001656 B5FF                    	mov	ch, 0FFh
  4399 00001658 890F                    	mov	[bx], cx ; 0FFF8h
  4400 0000165A 88E9                    	mov	cl, ch ; cx = 0FFFFh
  4401 0000165C 894F02                  	mov	[bx+2], cx
  4402                                  	;inc	cx
  4403 0000165F E88105                  	call	write_hd_sector
  4404 00001662 0F825FFE                	jc	formatting_error
  4405 00001666 E80BFE                  	call	write_format_percent
  4406                                  	;mov	bx, HDFORMAT_FATBUFFER
  4407 00001669 B90000                  	mov	cx, 0
  4408 0000166C 890F                    	mov	[bx], cx
  4409 0000166E 894F02                  	mov	[bx+2], cx
  4410 00001671 EB0F                    	jmp	short FAT16_f_15
  4411                                  FAT16_f_14:	
  4412 00001673 53                      	push	bx
  4413 00001674 51                      	push	cx	
  4414 00001675 BB[4E68]                	mov	bx, HDFORMAT_FATBUFFER
  4415 00001678 E86805                  	call	write_hd_sector
  4416 0000167B 0F8246FE                	jc	formatting_error
  4417 0000167F E8F2FD                  	call	write_format_percent
  4418                                  FAT16_f_15:	
  4419 00001682 59                      	pop	cx
  4420 00001683 5B                      	pop	bx
  4421 00001684 83C001                  	add	ax, 1
  4422 00001687 83D200                  	adc	dx, 0
  4423 0000168A 39DA                    	cmp	dx, bx
  4424 0000168C 72E5                    	jb	short FAT16_f_14
  4425 0000168E 39C8                    	cmp	ax, cx
  4426 00001690 72E1                    	jb	short FAT16_f_14
  4427                                  
  4428                                  	; write	root directory sectors
  4429                                  	; as empty sectors
  4430 00001692 8B0E[5A6A]              	mov	cx, [root_dir_secs]
  4431                                  FAT16_f_16:
  4432 00001696 51                      	push	cx
  4433 00001697 BB[4E68]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4434 0000169A E84605                  	call	write_hd_sector
  4435 0000169D 0F8224FE                	jc	formatting_error
  4436 000016A1 E8D0FD                  	call	write_format_percent
  4437 000016A4 83C001                  	add	ax, 1
  4438 000016A7 83D200                  	adc	dx, 0
  4439 000016AA 59                      	pop	cx
  4440 000016AB 49                      	dec	cx
  4441 000016AC 75E8                    	jnz	short FAT16_f_16
  4442                                  
  4443                                  	; write DATA sectors 
  4444                                  	; (after root directory sectors)
  4445 000016AE 8B0E[526A]              	mov	cx, [data_sectors]
  4446 000016B2 8B1E[546A]              	mov	bx, [data_sectors+2]
  4447                                  	; 11/02/2019
  4448 000016B6 43                      	inc	bx ; 0 -> 1, 1-> 2
  4449                                  FAT16_f_17:	
  4450 000016B7 53                      	push	bx
  4451 000016B8 51                      	push	cx	
  4452 000016B9 BB[3A64]                	mov	bx, HDFORMAT_SECBUFFER
  4453 000016BC E82405                  	call	write_hd_sector
  4454 000016BF 0F8202FE                	jc	formatting_error
  4455 000016C3 E8AEFD                  	call	write_format_percent
  4456 000016C6 59                      	pop	cx
  4457 000016C7 5B                      	pop	bx
  4458 000016C8 83C001                  	add	ax, 1
  4459 000016CB 83D200                  	adc	dx, 0
  4460 000016CE 49                      	dec	cx
  4461 000016CF 75E6                    	jnz	short FAT16_f_17
  4462 000016D1 4B                      	dec	bx
  4463 000016D2 75E3                    	jnz	short FAT16_f_17
  4464                                  
  4465                                  	; If there are, format remain sectors which are
  4466                                  	; at beyond of data clusters, with zero bytes.
  4467                                  	
  4468 000016D4 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  4469 000016D7 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  4470                                  
  4471 000016DA 837E1300                	cmp	word [bp+13h], 0 ; [BPB_TotSec16]
  4472 000016DE 0F844EFC                	jz	FAT16_f_18
  4473 000016E2 034E13                  	add	cx, [bp+13h]	; [BPB_TotSec16]
  4474 000016E5 83D300                  	adc	bx, 0
  4475 000016E8 E94BFC                  	jmp	FAT16_f_19
  4476                                  
  4477                                  FAT12_hd_format:
  4478 000016EB BD[5739]                	mov	bp, TRDOS_FAT12_hd_bs
  4479 000016EE 8D7E03                  	lea	di, [bp+3]
  4480 000016F1 BE[2464]                	mov	si, bs_oem_name
  4481 000016F4 B90400                  	mov	cx, 4
  4482 000016F7 F3A5                    	rep	movsw 
  4483 000016F9 A1[6A3F]                	mov	ax, [sectors]
  4484 000016FC 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  4485 000016FF A1[6C3F]                	mov	ax, [heads]
  4486 00001702 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  4487 00001705 A1[D46C]                	mov	ax, [pp_StartSector]
  4488 00001708 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  4489 0000170B A1[D66C]                	mov	ax, [pp_StartSector+2]
  4490 0000170E 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  4491                                  	;mov	ax, [pp_Sectors]
  4492 00001711 A1[066D]                	mov	ax, [ppn_Sectors] ; 16/02/2019
  4493 00001714 894613                  	mov	[bp+13h], ax	; [BPB_TotSec16]
  4494                                  
  4495                                  	; 11/02/2019
  4496 00001717 31F6                    	xor	si, si ; reset (FAT size fix) flag
  4497 00001719 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4498 0000171C 8B5611                  	mov	dx, [bp+11h]	; [BPB_RootEntCnt] = 512
  4499 0000171F 83C20F                  	add	dx, 15	; (16-1) (512-1)
  4500 00001722 C1EA04                  	shr	dx, 4	; /16  (*32/512)
  4501                                  	; AX = Root dir sectors
  4502                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4503 00001725 01D1                    	add	cx, dx ; + RootDirsectors ; + 32
  4504 00001727 890E[5A6A]              	mov	[root_dir_secs], cx ; = 33
  4505                                  
  4506                                  	; 11/02/2019
  4507                                  	;sub	ax, 33  ; 1 reserved sector, 32 root dir sectors
  4508                                  			; .. now AX has number of data sectors
  4509                                  			;	 		+ 2* (FAT sectors)
  4510 0000172B 29C8                    	sub	ax, cx	
  4511                                  FAT12_f_10:	; 11/02/2019
  4512                                  	; Sectors per cluster calculation
  4513                                  	; (According to MS FAT32 FS specification.)
  4514                                  	;mov	cx, 1  ; 1 sector per cluster
  4515 0000172D B101                    	mov	cl, 1  ; CH = 0
  4516                                  FAT12_f_0:
  4517 0000172F 3DF50F                  	cmp	ax, 4085 ; Max. cluster count for FAT12
  4518 00001732 7206                    	jb	short FAT12_f_1
  4519 00001734 D0E1                    	shl	cl, 1 ; *2
  4520 00001736 D1E8                    	shr	ax, 1 ; /2
  4521 00001738 EBF5                    	jmp	short FAT12_f_0
  4522                                  FAT12_f_1:
  4523 0000173A 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  4524                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  4525                                  	;mov	word [bp+0Eh], 1 ; [BPB_RsvdSecCnt] 
  4526                                  	;mov	word [bp+11h], 512 ; [BPB_RootEntCnt]
  4527                                  	
  4528                                  	; Calculating FAT size in sectors
  4529                                  	; AX = partition (volume) size in sectors
  4530                                  	; CX = sectors per clusters
  4531 0000173D 31D2                    	xor	dx, dx
  4532 0000173F F7F1                    	div	cx
  4533                                  	; AX = cluster count (only for FAT size calc)
  4534                                  	; DX = 0
  4535 00001741 83C002                  	add	ax, 2  ; cluster 2 to ...
  4536 00001744 89C2                    	mov	dx, ax
  4537 00001746 D1E2                    	shl	dx, 1
  4538 00001748 01D0                    	add	ax, dx ; *3
  4539 0000174A D1E8                    	shr	ax, 1  ; /2
  4540 0000174C 83D000                  	adc	ax, 0  ; +0.5 -> +1
  4541                                  
  4542                                  	; AX = FAT bytes for 12 bit cluster numbers
  4543                                  	
  4544 0000174F B90002                  	mov	cx, 512		; [BPB_BytesPerSec]
  4545 00001752 01C8                    	add	ax, cx
  4546 00001754 48                      	dec	ax		; [BPB_BytesPerSec] - 1
  4547 00001755 29D2                    	sub	dx, dx
  4548 00001757 F7F1                    	div	cx
  4549 00001759 894616                  	mov	[bp+16h], ax	; [BPB_FATSz16]
  4550                                  	; * 2
  4551 0000175C D1E0                    	shl	ax, 1
  4552                                  	; AX = [BPB_NumFATs] * [BPB_FATSz16]
  4553                                  
  4554                                  	;mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4555                                  	;add	cx, ax
  4556                                  	;mov	ax, [bp+11h]	; [BPB_RootEntCnt] = 512
  4557                                  	;add	ax, 15	; (16-1) (512-1)
  4558                                  	;shr	ax, 4	; /16  (*32/512)
  4559                                  	;; AX = Root dir sectors
  4560                                  	;; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4561                                  	;add	cx, ax ; + RootDirsectors
  4562                                  	;mov	[root_dir_secs], ax
  4563                                  
  4564                                  	; 11/02/2019
  4565                                  	;mov	cx, 33
  4566 0000175E 8B0E[5A6A]              	mov	cx, [root_dir_secs]
  4567 00001762 034E0E                  	add	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4568                                  		; cx = root directory sectors + reserved sectors
  4569 00001765 01C1                    	add	cx, ax
  4570                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4571                                  	;	  + RootDirSectors
  4572 00001767 8B4613                  	mov	ax, [bp+13h]	; [BPB_TotSec16]
  4573 0000176A 29C8                    	sub	ax, cx
  4574                                  		 ; AX = data sectors
  4575                                  		 ; cH = 0
  4576                                  
  4577                                  	; 11/02/2019 - fix FAT size (better method)
  4578 0000176C 09F6                    	or	si, si
  4579 0000176E 7504                    	jnz	short FAT12_f_9
  4580                                  
  4581 00001770 89C6                    	mov	si, ax  ; ax = data sectors
  4582 00001772 EBB9                    	jmp	short FAT12_f_10
  4583                                  
  4584                                  FAT12_f_9:
  4585 00001774 31D2                    	xor	dx, dx
  4586 00001776 890E[4E6A]              	mov	[data_start], cx
  4587 0000177A 8916[506A]              	mov	[data_start+2], dx ; 0
  4588                                  	; DX_AX = Data sectors
  4589 0000177E A3[526A]                	mov	[data_sectors], ax
  4590 00001781 8916[546A]              	mov	[data_sectors+2], dx ; 0
  4591 00001785 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  4592 00001788 28ED                    	sub	ch, ch
  4593 0000178A F7F1                    	div	cx
  4594                                  	; AX = Count of clusters (rounded down)
  4595 0000178C 29D2                    	sub	dx, dx ; 0
  4596 0000178E A3[566A]                	mov	[cluster_count], ax
  4597 00001791 8916[586A]              	mov	[cluster_count+2], dx ; 0
  4598                                  
  4599 00001795 8D7E2B                  	lea	di, [bp+43] ; [BS_VolLab]
  4600 00001798 E8CFFB                  	call	write_volume_name
  4601 0000179B 8D7627                  	lea	si, [bp+39] ; [BS_VolID]
  4602 0000179E E828FC                  	call	write_volume_serial
  4603 000017A1 E839FD                  	call	write_cluster_count
  4604                                  
  4605 000017A4 E8A9FC                  	call	write_formatting_msg
  4606 000017A7 B000                    	mov	al, 0
  4607 000017A9 E805FD                  	call	write_format_percent_x
  4608                                  
  4609 000017AC 8B461C                  	mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  4610 000017AF 8B561E                  	mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  4611                                  
  4612 000017B2 0106[4E6A]              	add	[data_start], ax
  4613 000017B6 1116[506A]              	adc	[data_start+2], dx
  4614                                  
  4615                                  	; DX_AX = FAT12 Boot Sector address
  4616 000017BA BB[5739]                	mov	bx, TRDOS_FAT12_hd_bs
  4617                                  	; ES:BX = Boot Sector Buffer
  4618 000017BD E82304                  	call	write_hd_sector
  4619 000017C0 0F8201FD                	jc	formatting_error
  4620 000017C4 E8ADFC                  	call	write_format_percent
  4621 000017C7 83C001                  	add	ax, 1
  4622 000017CA 83D200                  	adc	dx, 0
  4623                                  	; write remain part of reserved sectors
  4624 000017CD 8B4E0E                  	mov	cx, [bp+0Eh] ; [BPB_RsvdSecCnt]
  4625                                  	;sub	cx, 1
  4626                                  	;jna	short FAT12_f_3
  4627                                  	; 11/02/2019
  4628 000017D0 49                      	dec	cx
  4629 000017D1 7418                    	jz	short FAT12_f_3
  4630                                  FAT12_f_2:
  4631 000017D3 51                      	push	cx
  4632 000017D4 BB[4E68]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4633 000017D7 E80904                  	call	write_hd_sector
  4634 000017DA 0F82E7FC                	jc	formatting_error
  4635 000017DE E893FC                  	call	write_format_percent
  4636 000017E1 83C001                  	add	ax, 1
  4637 000017E4 83D200                  	adc	dx, 0
  4638 000017E7 59                      	pop	cx
  4639 000017E8 49                      	dec	cx ; dec cl
  4640 000017E9 75E8                    	jnz	short FAT12_f_2
  4641                                  FAT12_f_3:
  4642                                  	; write FAT sectors
  4643 000017EB 8B0E[4E6A]              	mov	cx, [data_start] ; lba/abs addr
  4644 000017EF 8B1E[506A]              	mov	bx, [data_start+2] ; lba/abs addr
  4645                                  
  4646                                  	; 11/02/2019
  4647 000017F3 2B0E[5A6A]              	sub	cx, [root_dir_secs]
  4648 000017F7 83DB00                  	sbb	bx, 0
  4649                                  
  4650 000017FA 53                      	push	bx
  4651 000017FB 51                      	push	cx
  4652 000017FC BB[4E68]                	mov	bx, HDFORMAT_FATBUFFER
  4653                                  	; ES:BX = FAT Sector Buffer
  4654 000017FF 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  4655 00001802 B5FF                    	mov	ch, 0FFh
  4656 00001804 890F                    	mov	[bx], cx ; 0FFF8h
  4657 00001806 886F02                  	mov	[bx+2], ch ; 0FFFFF8h
  4658                                  	;xor	cx, cx
  4659 00001809 E8D703                  	call	write_hd_sector
  4660 0000180C 0F82B5FC                	jc	formatting_error
  4661 00001810 E861FC                  	call	write_format_percent
  4662                                  	;mov	bx, HDFORMAT_FATBUFFER
  4663 00001813 B90000                  	mov	cx, 0
  4664 00001816 890F                    	mov	[bx], cx
  4665 00001818 884F02                  	mov	[bx+2], cl
  4666 0000181B EB0F                    	jmp	short FAT12_f_5
  4667                                  FAT12_f_4:	
  4668 0000181D 53                      	push	bx
  4669 0000181E 51                      	push	cx	
  4670 0000181F BB[4E68]                	mov	bx, HDFORMAT_FATBUFFER
  4671 00001822 E8BE03                  	call	write_hd_sector
  4672 00001825 0F829CFC                	jc	formatting_error
  4673 00001829 E848FC                  	call	write_format_percent
  4674                                  FAT12_f_5:	
  4675 0000182C 59                      	pop	cx
  4676 0000182D 5B                      	pop	bx
  4677 0000182E 83C001                  	add	ax, 1
  4678 00001831 83D200                  	adc	dx, 0
  4679 00001834 39DA                    	cmp	dx, bx
  4680 00001836 72E5                    	jb	short FAT12_f_4
  4681 00001838 39C8                    	cmp	ax, cx
  4682 0000183A 72E1                    	jb	short FAT12_f_4
  4683                                  
  4684                                  	; write	root directory sectors
  4685                                  	; as empty sectors
  4686 0000183C 8B0E[5A6A]              	mov	cx, [root_dir_secs]
  4687                                  FAT12_f_6:
  4688 00001840 51                      	push	cx
  4689 00001841 BB[4E68]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4690 00001844 E89C03                  	call	write_hd_sector
  4691 00001847 0F827AFC                	jc	formatting_error
  4692 0000184B E826FC                  	call	write_format_percent
  4693 0000184E 83C001                  	add	ax, 1
  4694 00001851 83D200                  	adc	dx, 0
  4695 00001854 59                      	pop	cx
  4696 00001855 49                      	dec	cx ; dec cl
  4697 00001856 75E8                    	jnz	short FAT12_f_6
  4698                                  
  4699                                  	; write DATA sectors 
  4700                                  	; (after root directory sectors)
  4701 00001858 8B0E[526A]              	mov	cx, [data_sectors]
  4702                                  	;mov	bx, [data_sectors+2]
  4703                                  	;inc	bx ; 11/02/2019
  4704                                  FAT12_f_7:	
  4705                                  	;push	bx
  4706 0000185C 51                      	push	cx
  4707 0000185D BB[3A64]                	mov	bx, HDFORMAT_SECBUFFER
  4708 00001860 E88003                  	call	write_hd_sector
  4709 00001863 0F825EFC                	jc	formatting_error
  4710 00001867 E80AFC                  	call	write_format_percent
  4711 0000186A 59                      	pop	cx
  4712                                  	;pop	bx
  4713 0000186B 83C001                  	add	ax, 1
  4714 0000186E 83D200                  	adc	dx, 0
  4715 00001871 49                      	dec	cx
  4716 00001872 75E8                    	jnz	short FAT12_f_7
  4717                                  	;dec	bx
  4718                                  	;jnz	short FAT12_f_7
  4719                                  
  4720                                  	; If there are, format remain sectors which are
  4721                                  	; at beyond of data clusters, with zero bytes.
  4722                                  	
  4723 00001874 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  4724 00001877 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  4725                                  
  4726 0000187A 034E13                  	add	cx, [bp+13h]	; [BPB_TotSec16]
  4727 0000187D 83D300                  	adc	bx, 0
  4728 00001880 E9B3FA                  	jmp	FAT12_f_8
  4729                                  
  4730                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4731                                  ; SINGLIX FS FORMATTING
  4732                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4733                                  
  4734                                  	; 20/03/2021
  4735                                  	; 19/03/2021
  4736                                  SINGLIX_hd_format:
  4737                                  	; 06/01/2018
  4738                                  	; 05/01/2018
  4739                                  	; If Sectors/Track = 17, use CHS+LBA type boot sector
  4740 00001883 8B1E[6A3F]              	mov	bx, [sectors]
  4741 00001887 83FB11                  	cmp	bx, 17
  4742 0000188A 7711                    	ja	short SINGLIX_fs1_f_1
  4743                                  SINGLIX_fs1_f_0:
  4744 0000188C BD[573B]                	mov	bp, TRDOS_TRFS1_chs_bs
  4745 0000188F 887E2D                  	mov	[bp+45], bh ; 0 ; [bs_LBA_Ready] = 0
  4746 00001892 885E2E                  	mov	[bp+46], bl	; [bs_Disk_SecPerTrack]
  4747 00001895 A0[6C3F]                	mov	al, [heads]
  4748 00001898 88462F                  	mov	[bp+47], al	; [bs_Disk_Heads]
  4749 0000189B EB15                    	jmp	short SINGLIX_fs1_f_3
  4750                                  SINGLIX_fs1_f_1:
  4751                                  	; Sectors per Track = 63
  4752                                  	; If disk capacity >= 63*16*1024 use LBA type boot sector
  4753 0000189D 8B0E[6C3F]              	mov	cx, [heads]
  4754 000018A1 A1[6E3F]                	mov	ax, [cylinders]
  4755 000018A4 F7E1                    	mul	cx
  4756 000018A6 21D2                    	and	dx, dx
  4757 000018A8 7505                    	jnz	short SINGLIX_fs1_f_2
  4758 000018AA 3D0040                  	cmp	ax, 16384
  4759 000018AD 72DD                    	jb	short SINGLIX_fs1_f_0
  4760                                  SINGLIX_fs1_f_2:	
  4761 000018AF BD[573D]                	mov	bp, TRDOS_TRFS1_lba_bs
  4762                                  	;mov	byte [bp+45], 1 ; [bs_LBA_Ready] = 1
  4763                                  SINGLIX_fs1_f_3:	
  4764                                  	;mov	ax, [pp_Sectors]
  4765                                  	;mov	dx, [pp_Sectors+2]
  4766                                  	; 16/02/2019
  4767 000018B2 A1[066D]                	mov	ax, [ppn_Sectors]
  4768 000018B5 8B16[086D]              	mov	dx, [ppn_Sectors+2]
  4769 000018B9 894610                  	mov	[bp+16], ax	; [bsVolumeSize]
  4770 000018BC 895612                  	mov	[bp+18], dx	; [bsVolumeSize+2]
  4771 000018BF 8B0E[D46C]              	mov	cx, [pp_StartSector]
  4772 000018C3 8B1E[D66C]              	mov	bx, [pp_StartSector+2]
  4773 000018C7 894E0C                  	mov	[bp+12], cx	; [bsBeginSector]
  4774 000018CA 895E0E                  	mov	[bp+14], bx	; [bsBeginSector+2]
  4775 000018CD C6462C80                	mov	byte [bp+44], 80h ; [bsDriveNumber]  ; hd0
  4776                                  
  4777                                  	; Prepare MAT
  4778 000018D1 A3[B46A]                	mov	[MAT_VolumeSize], ax ; Total Sectors of the FS
  4779 000018D4 8916[B66A]              	mov	[MAT_VolumeSize+2], dx
  4780 000018D8 890E[B86A]              	mov	[MAT_BeginSector], cx ; Beginning Sector of the FS
  4781 000018DC 891E[BA6A]              	mov	[MAT_BeginSector+2], bx
  4782                                  	;mov	cx, [bp+24]	; [bsMATLocation]
  4783                                  	;mov	bx, [bp+26]	; [bsMATLocation+2]
  4784                                  	;add	cx, 1
  4785                                  	;adc	bx, 0
  4786                                  	; Note: (as Default) MAT Address = 1, DAT Address = 2
  4787 000018E0 B90200                  	mov	cx, 2
  4788                                  	;xor	bx, bx ; 0
  4789                                  	;mov	[bp+24], cx	; [bsMATLocation]
  4790                                  	;mov	[bp+26], bx	; [bsMATLocation+2]
  4791 000018E3 890E[BC6A]              	mov	[DAT_Address], cx
  4792                                  	;mov	[DAT_Address+2], bx
  4793                                  	; DX_AX = FS1 Volume Size
  4794 000018E7 83C007                  	add	ax, 7 ; 7 bits more (for round up)
  4795 000018EA 83D200                  	adc	dx, 0
  4796 000018ED B90800                  	mov	cx, 8 ;  1 DAT byte == 8 sectors 
  4797 000018F0 E88AF3                  	call	div32
  4798                                  	; DX_AX = DAT bytes
  4799 000018F3 B9FF01                  	mov	cx, 511
  4800 000018F6 01C8                    	add	ax, cx
  4801 000018F8 83D200                  	adc	dx, 0
  4802 000018FB 41                      	inc	cx ; 512
  4803 000018FC E87EF3                  	call	div32
  4804                                  	; DX_AX = DAT sectors (DX must be 0 for volume sizes < 128GB)
  4805 000018FF A3[C06A]                	mov	[DAT_SectorCount], ax
  4806                                  	; 19/03/2021
  4807 00001902 8916[C26A]              	mov	[DAT_SectorCount+2], dx
  4808                                  
  4809 00001906 83C002                  	add	ax, 2  ; BS + MAT
  4810 00001909 83D200                  	adc	dx, 0  ; 19/03/2021
  4811 0000190C 89461C                  	mov	[bp+28], ax  ; [bsRootDirDT] ; RDT address (offset)
  4812 0000190F 89561E                  	mov	[bp+30], dx ; 19/03/2021
  4813                                  
  4814                                  	; Free Sectors = Total Sectors - (BS+MAT+DATsects+RDT+4)
  4815 00001912 83C005                  	add	ax, 5 ; DATsects + (BS+MAT+RDT+4)
  4816                                  	; 19/03/2021
  4817 00001915 83D200                  	adc	dx, 0
  4818                                  	;mov	dx, ax ; ? ; 19/03/2021
  4819 00001918 8B0E[B46A]              	mov	cx, [MAT_VolumeSize]
  4820 0000191C 8B1E[B66A]              	mov	bx, [MAT_VolumeSize+2]
  4821 00001920 29C1                    	sub	cx, ax
  4822                                  	; 19/03/2021
  4823                                  	;sbb	bx, 0
  4824 00001922 19D3                    	sbb	bx, dx	
  4825                                  
  4826 00001924 890E[C46A]              	mov	[MAT_FreeSectors], cx
  4827 00001928 891E[C66A]              	mov	[MAT_FreeSectors+2], bx
  4828 0000192C A3[C86A]                	mov	[MAT_FirstFreeSector], ax
  4829                                  	;mov	word [MAT_FirstFreeSector+2], 0
  4830                                  	; 19/03/2021
  4831 0000192F 8916[CA6A]              	mov	[MAT_FirstFreeSector+2], dx
  4832                                  	
  4833 00001933 BF[606A]                	mov	di, fs_volume_name
  4834 00001936 E82AFA                  	call	write_fs_volume_name
  4835 00001939 BE[A06A]                	mov	si, fs_volume_serial
  4836 0000193C E88AFA                  	call	write_volume_serial
  4837                                  
  4838                                  	; Modify FS volume name
  4839                                  	; (Convert 20h tail bytes to 0)
  4840 0000193F B94000                  	mov	cx, 64 
  4841 00001942 BE[606A]                	mov	si, fs_volume_name
  4842 00001945 31DB                    	xor	bx, bx
  4843 00001947 B0FF                    	mov	al, 0FFh
  4844                                  modify_fs_vname_1:	
  4845 00001949 88C4                    	mov	ah, al
  4846 0000194B AC                      	lodsb
  4847 0000194C 3C20                    	cmp	al, 20h
  4848 0000194E 7708                    	ja	short modify_fs_vname_2
  4849 00001950 80FC20                  	cmp	ah, 20h
  4850 00001953 7603                    	jna	short modify_fs_vname_2
  4851 00001955 89F3                    	mov	bx, si
  4852 00001957 4B                      	dec	bx
  4853                                  modify_fs_vname_2:
  4854 00001958 E2EF                    	loop	modify_fs_vname_1
  4855 0000195A 09DB                    	or	bx, bx
  4856 0000195C 740B                    	jz	short modify_fs_vname_3
  4857 0000195E 89DF                    	mov	di, bx
  4858 00001960 B9[A06A]                	mov	cx, fs_volume_name+64
  4859 00001963 29D9                    	sub	cx, bx
  4860 00001965 30C0                    	xor	al, al
  4861 00001967 F3AA                    	rep	stosb 
  4862                                  
  4863                                  modify_fs_vname_3:
  4864 00001969 E8E4FA                  	call	write_formatting_msg
  4865 0000196C B000                    	mov	al, 0
  4866 0000196E E840FB                  	call	write_format_percent_x
  4867                                  
  4868 00001971 8B460C                  	mov	ax, [bp+12]	; [bsBeginSector]
  4869 00001974 8B560E                  	mov	dx, [bp+14]	; [bsBeginSector+2]
  4870                                  
  4871                                  	; DX_AX = TRFS1 Boot Sector address
  4872 00001977 89EB                    	mov	bx, bp
  4873                                  	; ES:BX = Boot Sector Buffer
  4874 00001979 E86702                  	call	write_hd_sector
  4875 0000197C 0F8245FB                	jc	formatting_error
  4876                                  	
  4877 00001980 83C001                  	add	ax, 1
  4878 00001983 83D200                  	adc	dx, 0
  4879                                  
  4880                                  	; DX_AX = MAT (DAT header) sector address
  4881 00001986 BB[B06A]                	mov	bx, FS_MAT_Buffer
  4882                                  	; 16/02/2019
  4883 00001989 C7074D41                	mov	word [bx],'MA'
  4884 0000198D C6470254                	mov	byte [bx+2],'T'
  4885 00001991 E84F02                  	call	write_hd_sector
  4886 00001994 0F822DFB                	jc	formatting_error
  4887 00001998 E81DFB                  	call	write_fs_format_percent
  4888                                  
  4889                                  	; Calculate DAT bits 
  4890                                  	; NOTE: 4096 bits per DAT sector
  4891 0000199B A1[C86A]                	mov	ax, [MAT_FirstFreeSector]
  4892                                  	; 19/03/2021
  4893                                  	;xor	dx, dx
  4894 0000199E 8B16[CA6A]              	mov	dx, [MAT_FirstFreeSector+2]
  4895 000019A2 52                      	push	dx
  4896 000019A3 50                      	push	ax
  4897 000019A4 B90010                  	mov	cx, 4096
  4898 000019A7 E8D3F2                  	call	div32
  4899 000019AA 891E[A46A]              	mov	[DAT_FFBit], bx
  4900 000019AE A3[A66A]                	mov	[DAT_FFSector], ax
  4901                                  	; 19/03/2021
  4902 000019B1 8916[A86A]              	mov	[DAT_FFSector+2], dx
  4903 000019B5 58                      	pop	ax
  4904 000019B6 5A                      	pop	dx
  4905 000019B7 83E801                  	sub	ax, 1
  4906 000019BA 83DA00                  	sbb	dx, 0
  4907 000019BD 0306[C46A]              	add	ax, [MAT_FreeSectors]
  4908 000019C1 1316[C66A]              	adc	dx, [MAT_FreeSectors+2]
  4909 000019C5 E8B5F2                  	call	div32
  4910 000019C8 891E[AA6A]              	mov	[DAT_LFBit], bx
  4911 000019CC A3[AC6A]                	mov	[DAT_LFSector], ax
  4912                                  	; 19/03/2021
  4913 000019CF 8916[AE6A]              	mov	[DAT_LFSector+2], dx
  4914                                  	;
  4915 000019D3 31F6                    	xor	si, si ; 0
  4916                                  	; 19/03/2021
  4917 000019D5 8936[AE70]              	mov	[tempword], si ; 0
  4918                                  SINGLIX_fs1_f_4:
  4919                                  	; calculate free bits for current DAT sector
  4920                                  	;			(to be written)
  4921 000019D9 BF[CC6A]                	mov	di, FS_DAT_Buffer
  4922                                  
  4923                                  	; 19/03/2021
  4924 000019DC A1[AE70]                	mov	ax, [tempword]
  4925 000019DF 3B06[A86A]              	cmp	ax, [DAT_FFSector+2]
  4926 000019E3 7260                    	jb	short SINGLIX_fs1_f_9
  4927 000019E5 7708                    	ja	short SINGLIX_fs1_f_13
  4928                                  
  4929 000019E7 3B36[A66A]              	cmp	si, [DAT_FFSector]
  4930 000019EB 743A                    	je	short SINGLIX_fs1_f_7
  4931 000019ED 7256                    	jb	short SINGLIX_fs1_f_9
  4932                                  SINGLIX_fs1_f_13:
  4933                                  	; 19/03/2021
  4934 000019EF 3B06[AE6A]              	cmp	ax, [DAT_LFSector+2]
  4935 000019F3 722D                    	jb	short SINGLIX_fs1_f_6
  4936 000019F5 774E                    	ja	short SINGLIX_fs1_f_9
  4937                                  
  4938 000019F7 3B36[AC6A]              	cmp	si, [DAT_LFSector]
  4939 000019FB 7225                    	jb	short SINGLIX_fs1_f_6
  4940 000019FD 7746                    	ja	short SINGLIX_fs1_f_9
  4941                                  
  4942                                  	;mov	bx, [DAT_LFBit]
  4943                                  	;;mov	al, 0FFh
  4944                                  	;mov	ah, bl
  4945                                  	;shr	bx, 3 ; bit count to byte count
  4946                                  	;jz	short SINGLIX_fs1_f_5
  4947                                  	; 20/03/2021
  4948 000019FF 8B0E[AA6A]              	mov	cx, [DAT_LFBit]
  4949 00001A03 88CC                    	mov	ah, cl
  4950 00001A05 C1E903                   	shr	cx, 3 ; bit count to byte count
  4951 00001A08 7404                    	jz	short SINGLIX_fs1_f_5
  4952                                  	;Example:
  4953                                  	;last free sector = 47 -> byte 5, bit 7
  4954                                  	;last free sector = 48 -> byte 6, bit 0
  4955                                  	; (also previous sectors are free sectors)
  4956 00001A0A B0FF                    	mov	al, 0FFh ; 20/03/2021
  4957                                  	;mov	cx, bx
  4958 00001A0C F3AA                    	rep	stosb
  4959                                  	; 20/03/2021
  4960                                  	;mov	di, FS_DAT_Buffer
  4961                                  	;add	di, bx
  4962                                  SINGLIX_fs1_f_5:
  4963 00001A0E 80E407                  	and	ah, 7
  4964                                  	;mov	cl, ah
  4965                                  	;shl	al, cl
  4966                                  	;not	al
  4967                                  	; 20/03/2021
  4968 00001A11 30C0                    	xor	al, al
  4969                                  SINGLIX_fs1_f_15:
  4970                                  	; 20/03/2021 
  4971                                  	; 0 -> 00000001b (last free bit is bit 0)
  4972                                  	; 1 -> 00000011b (last free bit is bit 1)
  4973                                  	; 7 -> 11111111b (last free bit is bit 7)
  4974 00001A13 0C01                    	or	al, 1
  4975 00001A15 08E4                    	or	ah, ah
  4976 00001A17 7406                    	jz	short SINGLIX_fs1_f_16
  4977 00001A19 D0E0                    	shl	al, 1
  4978 00001A1B FECC                    	dec	ah
  4979 00001A1D EBF4                    	jmp	short SINGLIX_fs1_f_15
  4980                                  SINGLIX_fs1_f_16:
  4981 00001A1F AA                      	stosb
  4982                                  	;mov	cx, 511
  4983                                  	;sub	cx, bx
  4984                                  	;jna	short SINGLIX_fs1_f_9
  4985                                  	;mov	al, 0 ; out of volume bits (=0)
  4986                                  	;rep	stosb
  4987 00001A20 EB23                    	jmp	short SINGLIX_fs1_f_9
  4988                                  SINGLIX_fs1_f_6:
  4989 00001A22 B90002                  	mov	cx, 512
  4990 00001A25 EB1A                    	jmp	short SINGLIX_fs1_f_8
  4991                                  SINGLIX_fs1_f_7:
  4992                                  	; 20/03/2021
  4993                                  	;Example:
  4994                                  	;first free sector = 23 -> byte 2, bit 7
  4995                                  	;first free sector = 24 -> byte 3, bit 0
  4996                                  	; (previous sectors are allocated sectors)
  4997 00001A27 8B1E[A46A]              	mov	bx, [DAT_FFBit]
  4998 00001A2B 88D9                    	mov	cl, bl
  4999 00001A2D 80E107                  	and	cl, 7
  5000 00001A30 C1EB03                  	shr	bx, 3 ; from bits to bytes
  5001 00001A33 01DF                    	add	di, bx
  5002 00001A35 B0FF                    	mov	al, 0FFh
  5003 00001A37 D2E0                    	shl	al, cl
  5004 00001A39 AA                      	stosb
  5005 00001A3A B9FF01                  	mov	cx, 511
  5006 00001A3D 29D9                    	sub	cx, bx
  5007 00001A3F 7604                    	jna	short SINGLIX_fs1_f_9
  5008                                  SINGLIX_fs1_f_8:
  5009 00001A41 B0FF                    	mov	al, 0FFh ; Free sector bits (=1)
  5010 00001A43 F3AA                    	rep	stosb
  5011                                  SINGLIX_fs1_f_9:
  5012 00001A45 A1[B86A]                	mov	ax, [MAT_BeginSector]
  5013 00001A48 8B16[BA6A]              	mov	dx, [MAT_BeginSector+2]
  5014                                  	;add	ax, [DAT_Address] ; = 2
  5015                                  	;adc	dx, [DAT_Address+2]
  5016 00001A4C 83C002                  	add	ax, 2
  5017 00001A4F 83D200                  	adc	dx, 0
  5018 00001A52 01F0                    	add	ax, si
  5019 00001A54 83D200                  	adc	dx, 0
  5020                                  	; Write DAT sector(s)
  5021                                  	; DX_AX = Disk Allocation Table sector address
  5022 00001A57 BB[CC6A]                	mov	bx, FS_DAT_Buffer
  5023 00001A5A E88601                  	call	write_hd_sector
  5024 00001A5D 0F8264FA                	jc	formatting_error
  5025 00001A61 E854FA                  	call	write_fs_format_percent
  5026                                  	; Clear DAT buffer again (for next stage)
  5027 00001A64 B90001                  	mov	cx, 256
  5028 00001A67 BF[CC6A]                	mov	di, FS_DAT_Buffer
  5029 00001A6A 29C0                    	sub	ax, ax
  5030 00001A6C F3AB                    	rep	stosw
  5031                                  
  5032 00001A6E 46                      	inc	si
  5033                                  	; 19/03/2021
  5034 00001A6F 7504                    	jnz	short SINGLIX_fs1_f_14
  5035                                  
  5036                                  	; 19/03/2021
  5037 00001A71 FF06[AE70]              	inc	word [tempword]
  5038                                  SINGLIX_fs1_f_14:
  5039 00001A75 A1[AE70]                	mov	ax, [tempword]
  5040 00001A78 3B06[C26A]              	cmp	ax, [DAT_SectorCount+2]
  5041 00001A7C 0F8259FF                	jb	SINGLIX_fs1_f_4
  5042                                  
  5043 00001A80 3B36[C06A]              	cmp	si, [DAT_SectorCount]
  5044                                  	;jna	SINGLIX_fs1_f_4
  5045                                  	; 19/03/2021 (bugfix)
  5046 00001A84 0F8251FF                	jb	SINGLIX_fs1_f_4
  5047                                  
  5048                                  	; ;;;
  5049                                  	
  5050                                  	; DAT sectors has been written..
  5051                                  	; Now, Root Directory Description Table is in order
  5052                                  
  5053 00001A88 BF[CC6A]                	mov	di, FS_RDT_Buffer
  5054 00001A8B B84444                  	mov	ax, 'DD' 
  5055 00001A8E AB                      	stosw
  5056 00001A8F 30E4                    	xor	ah, ah
  5057 00001A91 B054                    	mov	al, 'T'
  5058 00001A93 AB                      	stosw
  5059 00001A94 B80002                  	mov	ax, 512 ; Sector size (Bytes per sector)
  5060 00001A97 AB                      	stosw
  5061 00001A98 31C0                    	xor	ax, ax ; RDT sequence number (= 0, section 1)
  5062 00001A9A AB                      	stosw	
  5063                                  	; RDT address
  5064 00001A9B A1[C06A]                	mov	ax, [DAT_SectorCount]
  5065 00001A9E 8B16[C26A]              	mov	dx, [DAT_SectorCount+2]
  5066 00001AA2 83C002                  	add	ax, 2 ; BS + MAT
  5067 00001AA5 83D200                  	adc	dx, 0
  5068 00001AA8 AB                      	stosw
  5069 00001AA9 89D0                    	mov	ax, dx
  5070 00001AAB AB                      	stosw
  5071 00001AAC 29C0                    	sub	ax, ax ; Next RDT number
  5072 00001AAE AB                      	stosw
  5073 00001AAF AB                      	stosw
  5074                                  	;mov	ax, 4 ; Sector count of this section	
  5075                                  	;	      ; (4*512)/4 = 512 root dir entries
  5076                                  	; 20/03/2021
  5077 00001AB0 B004                    	mov	al, 4
  5078 00001AB2 AB                      	stosw
  5079 00001AB3 30C0                    	xor	al, al
  5080 00001AB5 AB                      	stosw
  5081                                  	; Volume beginning sector
  5082 00001AB6 8B460C                  	mov	ax, [bp+12]	; [bsBeginSector]
  5083 00001AB9 8B560E                  	mov	dx, [bp+14]	; [bsBeginSector+2]
  5084 00001ABC AB                      	stosw
  5085 00001ABD 89D0                    	mov	ax, dx
  5086 00001ABF AB                      	stosw
  5087 00001AC0 31C0                    	xor	ax, ax
  5088 00001AC2 48                      	dec	ax ; 0FFFFh
  5089                                  	; Parent Dir Serial (= FFFFFFFFh for root dir)
  5090 00001AC3 AB                      	stosw
  5091 00001AC4 AB                      	stosw
  5092                                  
  5093                                  set_fs_volume_serial_number:
  5094 00001AC5 BE[A06A]                	mov	si, fs_volume_serial
  5095 00001AC8 A5                      	movsw
  5096 00001AC9 A5                      	movsw
  5097                                  
  5098 00001ACA 29C0                    	sub	ax, ax
  5099                                  	;stosb	; sub directory level = 0
  5100                                  	;stosb	; 0, reserved
  5101 00001ACC AB                      	stosw
  5102 00001ACD B004                    	mov	al, 00000100b ;  (DOS) System attribute
  5103 00001ACF AA                      	stosb	; (DOS) Basic attributes
  5104 00001AD0 28C0                    	sub	al, al ; Extended attributes (0 for TRDOS 386)
  5105 00001AD2 AA                      	stosb
  5106                                  	; 20/03/2021
  5107                                  	;sub	ax, ax ; reserved (8) bytes for TR-MULTIX
  5108 00001AD3 AB                      	stosw
  5109 00001AD4 AB                      	stosw
  5110 00001AD5 AB                      	stosw
  5111 00001AD6 AB                      	stosw
  5112 00001AD7 B85254                  	mov	ax, 'RT' ; TRFS Root directory signature
  5113 00001ADA AB                      	stosw
  5114 00001ADB 31C0                    	xor	ax, ax ; Country (language, date, text format)
  5115                                  		       ; (0 = Default, 1 = USA, 90 = Turkiye)
  5116                                  	;stosb
  5117                                  	;stosb	; Time Zone (0 = GMT = default ; -11 to +12)
  5118 00001ADD AB                      	stosw
  5119                                  
  5120 00001ADE 89FE                    	mov	si, di
  5121                                  	; get the date (from RTC)
  5122 00001AE0 B404                    	mov	ah, 4
  5123 00001AE2 CD1A                    	int	1Ah
  5124                                  	; Creating Date (of root directory)
  5125 00001AE4 86E9                    	xchg	ch, cl ; 07/01/2018
  5126 00001AE6 89C8                    	mov	ax, cx ; cl = century (BCD), ch = year (BCD)
  5127 00001AE8 AB                      	stosw
  5128 00001AE9 88F0                    	mov	al, dh  ; month (BCD)
  5129 00001AEB AA                      	stosb
  5130 00001AEC 88D0                    	mov	al, dl  ; day (BCD)
  5131 00001AEE AA                      	stosb
  5132                                  	; get the time (from RTC)
  5133 00001AEF B402                    	mov	ah, 2
  5134 00001AF1 CD1A                    	int	1Ah
  5135                                  	; Creating Time (of root directory)
  5136 00001AF3 86CD                    	xchg	cl, ch ; ch = hour (BCD), cl = minute (BSD)
  5137 00001AF5 89C8                    	mov	ax, cx ; al = hour, ah = minute
  5138 00001AF7 AB                      	stosw
  5139 00001AF8 88F0                    	mov	al, dh ; seconds (BCD)
  5140 00001AFA AA                      	stosb
  5141 00001AFB 88D0                    	mov	al, dl ; daylight savings time option 
  5142 00001AFD AA                      	stosb
  5143                                  	; Set Last Modification Date&Time
  5144 00001AFE B90400                  	mov	cx, 4
  5145 00001B01 F3A5                    	rep	movsw ; copy creating date&time values to
  5146                                  		; last modification date time values
  5147                                  		; (last modif date&time = creating date&time)
  5148                                  
  5149                                  set_fs_volume_name:
  5150 00001B03 BE[606A]                	mov	si, fs_volume_name
  5151 00001B06 B120                    	mov	cl, 32 
  5152 00001B08 F3A5                    	rep	movsw
  5153                                  
  5154                                  	; Fill remain bytes (of this RDT) with zero
  5155 00001B0A B9C000                  	mov	cx, (128+256)/2
  5156 00001B0D 31C0                    	xor	ax, ax
  5157 00001B0F F3AB                    	rep	stosw
  5158                                  
  5159                                  	; RDT is ready here...
  5160                                  
  5161 00001B11 8B461C                  	mov	ax, [bp+28]	; [bsRootDirDT]
  5162 00001B14 8B561E                  	mov	dx, [bp+30]	; [bsRootDirDT+2]
  5163                                  	; 20/03/2021
  5164                                  	;xor	dx, dx
  5165 00001B17 03460C                  	add	ax, [bp+12]	; [bsBeginSector]
  5166 00001B1A 13560E                  	adc	dx, [bp+14]	; [bsBeginSector+2]
  5167                                  
  5168                                  	; Write RDT sector
  5169                                  	; DX_AX = Root Directory Description Table address
  5170 00001B1D BB[CC6A]                	mov	bx, FS_RDT_Buffer
  5171 00001B20 E8C000                  	call	write_hd_sector
  5172 00001B23 0F829EF9                	jc	formatting_error
  5173 00001B27 E88EF9                  	call	write_fs_format_percent
  5174                                  
  5175 00001B2A 83C001                  	add	ax, 1
  5176 00001B2D 83D200                  	adc	dx, 0
  5177                                  
  5178                                  	; write root directory data sectors
  5179 00001B30 B90400                  	mov	cx, 4
  5180                                  
  5181                                  SINGLIX_fs1_f_10:
  5182 00001B33 51                      	push	cx
  5183                                  	; Write root directory sector(s)
  5184                                  	; DX_AX = Root Directory Sector address
  5185 00001B34 BB[4E68]                	mov	bx, HDFORMAT_EMPTY_BUFF
  5186 00001B37 E8A900                  	call	write_hd_sector
  5187 00001B3A 0F8287F9                	jc	formatting_error
  5188 00001B3E E877F9                  	call	write_fs_format_percent
  5189 00001B41 83C001                  	add	ax, 1
  5190 00001B44 83D200                  	adc	dx, 0
  5191 00001B47 59                      	pop	cx
  5192 00001B48 FEC9                    	dec	cl
  5193 00001B4A 75E7                    	jnz	short SINGLIX_fs1_f_10
  5194                                  
  5195                                  	; Fill remain sectors with 'F6h' bytes
  5196 00001B4C 8B4E10                  	mov	cx, [bp+16]	; [bsVolumeSize]
  5197 00001B4F 8B5E12                  	mov	bx, [bp+18]	; [bsVolumeSize+2]
  5198 00001B52 034E0C                  	add	cx, [bp+12]	; [bsBeginSector]
  5199 00001B55 135E0E                  	adc	bx, [bp+14]	; [bsBeginSector+2]
  5200                                  
  5201                                  	; write DATA sectors 
  5202                                  	; (after root directory sectors)
  5203                                  SINGLIX_fs1_f_11:
  5204 00001B58 53                      	push	bx
  5205 00001B59 51                      	push	cx
  5206 00001B5A BB[3A64]                	mov	bx, HDFORMAT_SECBUFFER
  5207 00001B5D E88300                  	call	write_hd_sector
  5208 00001B60 0F8261F9                	jc	formatting_error
  5209 00001B64 E80DF9                  	call	write_format_percent
  5210 00001B67 59                      	pop	cx
  5211 00001B68 5B                      	pop	bx
  5212 00001B69 83C001                  	add	ax, 1
  5213 00001B6C 83D200                  	adc	dx, 0
  5214 00001B6F 39DA                    	cmp	dx, bx
  5215 00001B71 72E5                    	jb	short SINGLIX_fs1_f_11
  5216 00001B73 0F87E1F7                	ja	SINGLIX_fs1_f_12
  5217 00001B77 39C8                    	cmp	ax, cx
  5218 00001B79 72DD                    	jb	short SINGLIX_fs1_f_11
  5219 00001B7B E9DAF7                  	jmp	SINGLIX_fs1_f_12	
  5220                                  
  5221                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5222                                  ; print messages
  5223                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5224                                  
  5225                                  print_msg:
  5226                                  
  5227                                  print_msg_LOOP:
  5228 00001B7E AC                      	lodsb                           ; Load byte at DS:SI to AL
  5229 00001B7F 20C0                    	and     al, al
  5230 00001B81 7409                    	jz      short print_msg_OK
  5231 00001B83 B40E                    	mov	ah, 0Eh
  5232 00001B85 BB0700                  	mov     bx, 07h
  5233 00001B88 CD10                    	int	10h			; BIOS Service func ( ah ) = 0Eh
  5234                                  					; Write char as TTY
  5235                                  					; AL-char BH-page BL-color
  5236 00001B8A EBF2                    	jmp     short print_msg_LOOP
  5237                                  
  5238                                  print_msg_OK:
  5239 00001B8C C3                      	retn
  5240                                  
  5241                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5242                                  ; reading a block (sector) on hard disk
  5243                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5244                                  ; 17/10/2020
  5245                                  
  5246                                  read_hd_sector:
  5247                                  
  5248                                  	; INPUT -> DX_AX = Logical Block Address
  5249                                  	; 	   ES:BX = Sector Buffer
  5250                                  	; OUTPUT ->
  5251                                  	;  cf = 0 -> DX_AX = Logical Block Adress
  5252                                  	;	     ES:BX = Sector Buffer
  5253                                  	;  cf = 1 -> AH = Error Number
  5254                                  
  5255 00001B8D 3B16[4868]              	cmp	dx, [chs_limit+2]
  5256 00001B91 770F                    	ja	short read_lba_sector
  5257 00001B93 7206                    	jb	short read_chs_sector
  5258 00001B95 3B06[4668]              	cmp	ax, [chs_limit]
  5259 00001B99 7707                    	ja	short read_lba_sector
  5260                                  	;jmp	short read_chs_sector
  5261                                  
  5262                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5263                                  ; reading a block (sector) by using CHS read (ROMBIOS) function
  5264                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5265                                  ; 17/10/2020
  5266                                  
  5267                                  read_chs_sector:
  5268                                  	; hdformat.s (25/09/2020)
  5269 00001B9B C606[4068]02            	mov	byte [rw], 2 ; read
  5270 00001BA0 EB54                    	jmp	short chs_rw
  5271                                  
  5272                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5273                                  ; reading a block (sector) by using LBA read (ROMBIOS) function
  5274                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5275                                  ; 17/10/2020
  5276                                  
  5277                                  read_lba_sector:
  5278                                  	; hdformat.s (25/09/2020)
  5279 00001BA2 C606[4068]42            	mov	byte [rw], 42h
  5280 00001BA7 EB05                    	jmp	short lba_rw
  5281                                  
  5282                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5283                                  ; writing a block (sector) by using LBA write (ROMBIOS) function
  5284                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5285                                  ; 17/10/2020
  5286                                  
  5287                                  	; 18/10/2020 
  5288                                  write_lba_sector:
  5289                                  	; hdformat.s (25/09/2020)
  5290 00001BA9 C606[4068]43            	mov	byte [rw], 43h
  5291                                  	;jmp	short lba_rw
  5292                                  lba_rw:
  5293                                  	;mov	di, 5
  5294                                  	; 18/10/2020
  5295 00001BAE C606[4168]05            	mov	byte [rcnt], 5  ; Retry count
  5296                                  lba_rw_1:
  5297                                  	;pusha			; db 60h
  5298 00001BB3 60                      	db	60h
  5299                                  	;push 	0		; db 6Ah, 00h
  5300 00001BB4 6A00                    	db	6Ah, 0
  5301                                  	;push	0		; db 6Ah, 00h
  5302 00001BB6 6A00                    	db	6Ah, 0
  5303 00001BB8 52                      	push    dx
  5304 00001BB9 50                      	push    ax
  5305 00001BBA 06                      	push    es
  5306 00001BBB 53                      	push    bx
  5307                                  	;push	1		; db 6Ah, 01h
  5308 00001BBC 6A01                    	db	6Ah, 01h                     
  5309                                  	;push	10h		; db 6Ah, 10h
  5310 00001BBE 6A10                    	db	6Ah, 10h
  5311                                  
  5312 00001BC0 89E6                    	mov     si, sp
  5313 00001BC2 8A16[3E68]              	mov     dl, [DrvNum]
  5314 00001BC6 30C0                    	xor	al, al	; verify off 
  5315                                  lba_rw_2:
  5316 00001BC8 8A26[4068]              	mov     ah, [rw] ; 42h = LBA read, 43h = LBA write
  5317                                  	;xor	al, al	; verify off 
  5318 00001BCC CD13                    	int     13h
  5319                                  
  5320                                  	;mov	[error], ah
  5321 00001BCE 7310                    	jnc     short lba_rw_3
  5322                                  
  5323                                  	;dec	di 
  5324                                  	; 18/10/2020
  5325 00001BD0 FE0E[4168]              	dec	byte [rcnt]
  5326 00001BD4 740A                    	jz	short lba_rw_3 
  5327                                          
  5328 00001BD6 30E4                    	xor	ah, ah
  5329                                  	;mov	dl, [DrvNum]
  5330 00001BD8 CD13                    	int	13h	; BIOS Service func (ah) = 0
  5331                                  			; Reset disk system
  5332                                  
  5333                                  	;mov	word [si+2], 1 ; set r/w count to 1 again
  5334 00001BDA C6440201                	mov	byte [si+2], 1
  5335                                  
  5336 00001BDE EBE8                    	jmp	short lba_rw_2
  5337                                  
  5338                                  lba_rw_3:
  5339                                  	;popa
  5340 00001BE0 61                      	db	61h
  5341                                  	;popa
  5342 00001BE1 61                      	db	61h
  5343 00001BE2 C3                      	retn
  5344                                  
  5345                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5346                                  ; writing a block (sector) on hard disk
  5347                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5348                                  ; 17/10/2020
  5349                                  
  5350                                  write_hd_sector:
  5351                                  
  5352                                  	; INPUT -> DX_AX = Logical Block Address
  5353                                  	; 	   ES:BX = Sector Buffer
  5354                                  	; OUTPUT ->
  5355                                  	;  cf = 0 -> DX_AX = Logical Block Adress
  5356                                  	;	     ES:BX = Sector Buffer
  5357                                  	;  cf = 1 -> AH = Error Number
  5358                                  
  5359 00001BE3 3B16[4868]              	cmp	dx, [chs_limit+2]
  5360 00001BE7 77C0                    	ja	short write_lba_sector
  5361 00001BE9 7206                    	jb	short write_chs_sector
  5362 00001BEB 3B06[4668]              	cmp	ax, [chs_limit]
  5363 00001BEF 77B8                    	ja	short write_lba_sector
  5364                                  	;jmp	short write_chs_sector
  5365                                  
  5366                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5367                                  ; writing a block (sector) by using CHS write (ROMBIOS) function
  5368                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5369                                  ; 17/10/2020
  5370                                  
  5371                                  	; 18/10/2020
  5372                                  write_chs_sector:
  5373                                  	; hdformat.s (25/09/2020)
  5374 00001BF1 C606[4068]03            	mov	byte [rw], 3 ; write
  5375                                  	;jmp	short chs_rw
  5376                                  chs_rw:
  5377 00001BF6 56                      	push	si
  5378 00001BF7 51                              push	cx        
  5379                                  chs_rw_0:
  5380                                  	;mov	di, 5
  5381                                  	; 18/10/2020
  5382 00001BF8 C606[4168]05            	mov	byte [rcnt], 5  ; Retry count
  5383                                  chs_rw_1:               
  5384 00001BFD 52                      	push	dx	; Linear sector #
  5385 00001BFE 50                      	push	ax	; DX_AX = Linear address (sectors)
  5386 00001BFF 8B0E[6A3F]              	mov	cx, [sectors]
  5387 00001C03 53                      	push	bx
  5388                                  
  5389 00001C04 E876F0                  	call    div32	; 32 bit divide
  5390                                  
  5391 00001C07 89D9                    	mov	cx, bx	; Sector (zero based)
  5392 00001C09 41                      	inc	cx	; To make it 1 based
  5393 00001C0A 51                      	push	cx
  5394 00001C0B 8B0E[6C3F]              	mov     cx, [heads]
  5395 00001C0F E86BF0                  	call	div32	; Convert track to head & cyl
  5396 00001C12 88DE                    	mov	dh, bl	; BX = Head (max. FFh)
  5397 00001C14 59                      	pop	cx	; AX=Cyl, DH=Head, CX=Sector
  5398 00001C15 5B                      	pop     bx	; ES:BX = Buffer
  5399                                  
  5400 00001C16 8A16[3E68]              	mov	dl, [DrvNum]
  5401 00001C1A 88C5                    	mov	ch, al
  5402 00001C1C D0CC                    	ror	ah, 1	; Rotate right
  5403 00001C1E D0CC                    	ror	ah, 1
  5404 00001C20 08E1                    	or	cl, ah
  5405                                  chs_rw_2:
  5406 00001C22 8A26[4068]              	mov	ah, [rw] ; 02h = read, 03h = write
  5407 00001C26 B001                    	mov	al, 01h
  5408 00001C28 CD13                    	int	13h	; BIOS Service func (ah) = 2/3
  5409                                  			; Read/Write disk sectors
  5410                                  			; AL-sec num CH-track CL-sec
  5411                                  			; DH-head DL-drive ES:BX-buffer
  5412                                  			; CF-flag AH-status AL-sectors written/read
  5413                                  			; If CF = 1 then AH = Error code (>0) 
  5414                                          
  5415 00001C2A 730C                    	jnc     short chs_rw_3
  5416                                  	;dec	di                 
  5417 00001C2C FE0E[4168]              	dec	byte [rcnt] ; 18/10/2020
  5418 00001C30 7406                    	jz	short chs_rw_3 
  5419                                          
  5420 00001C32 30E4                    	xor	ah, ah
  5421                                  	;mov	dl, [DrvNum]
  5422 00001C34 CD13                    	int	13h	; BIOS Service func (ah) = 0
  5423                                  			; Reset disk system
  5424 00001C36 EBEA                    	jmp	short chs_rw_2
  5425                                  
  5426                                  chs_rw_3:
  5427 00001C38 58                      	pop	ax
  5428 00001C39 5A                      	pop	dx
  5429 00001C3A 59                      	pop	cx
  5430 00001C3B 5E                      	pop	si	
  5431 00001C3C C3                      	retn
  5432                                  	
  5433                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5434                                  ; convert byte to decimal number
  5435                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5436                                  
  5437                                  bin_to_decimal:
  5438                                  	; INPUT: DS:SI = Target location
  5439                                  	;        DX_AX = Binary Number (Integer)
  5440                                  	; OUTPUT: Decimal char at DS:SI
  5441                                  	; 	 SI decremented after every division
  5442                                  	; 	 till AX<10.
  5443                                  	; CX, DX, BX will be changed.
  5444                                  	;
  5445 00001C3D B90A00                  	mov	cx, 10
  5446                                  btd_0:
  5447                                  	; DX_AX = Dividend
  5448                                  	; CX = Divisor
  5449 00001C40 E83AF0                  	call	div32
  5450                                  	; DX_AX = Quotient
  5451                                  	; BX = remainder
  5452 00001C43 80C330                  	add	bl, '0'
  5453 00001C46 881C                    	mov	[si], bl
  5454 00001C48 21D2                    	and	dx, dx
  5455 00001C4A 7403                    	jz	short btd_2
  5456                                  btd_1:
  5457 00001C4C 4E                      	dec	si
  5458 00001C4D EBF1                    	jmp	short btd_0
  5459                                  btd_2:
  5460 00001C4F 09C0                    	or	ax, ax
  5461 00001C51 75F9                    	jnz	short btd_1
  5462                                  
  5463 00001C53 C3                      	retn
  5464                                  
  5465                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5466                                  ; convert byte to hexadecimal number
  5467                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5468                                  
  5469                                  byte_to_hex: ; 04/02/2019
  5470                                  bin_to_hex:
  5471                                  	; INPUT ->
  5472                                  	; 	AL = byte (binary number)
  5473                                  	; OUTPUT ->
  5474                                  	;	AX = hexadecimal string
  5475                                  	;
  5476 00001C54 53                      	push	bx
  5477 00001C55 31DB                    	xor	bx, bx
  5478 00001C57 88C3                    	mov	bl, al
  5479 00001C59 C0EB04                  	shr	bl, 4
  5480 00001C5C 8A9F[583F]              	mov	bl, [bx+hexchrs]
  5481 00001C60 86D8                    	xchg	bl, al
  5482 00001C62 80E30F                  	and	bl, 0Fh
  5483 00001C65 8AA7[583F]              	mov	ah, [bx+hexchrs]
  5484 00001C69 5B                      	pop	bx	
  5485 00001C6A C3                      	retn
  5486                                  
  5487                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5488                                  ; read & write characters
  5489                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5490                                  
  5491                                  rw_char:
  5492                                  	; OUTPUT -> DS:SI = Entered String (ASCIIZ)
  5493 00001C6B BE[C854]                	mov     si, StrVolumeName
  5494 00001C6E BB0700                  	mov     bx, 7
  5495 00001C71 B403                    	mov     ah, 3
  5496 00001C73 CD10                    	int     10h
  5497 00001C75 8916[AF54]              	mov     [Cursor_Pos], dx
  5498                                  read_next_char:
  5499 00001C79 30E4                    	xor     ah, ah
  5500 00001C7B CD16                    	int     16h
  5501 00001C7D 20C0                    	and     al, al
  5502 00001C7F 7439                    	jz      short loc_arrow
  5503 00001C81 3CE0                    	cmp     al, 0E0h
  5504 00001C83 7435                    	je      short loc_arrow
  5505 00001C85 3C08                    	cmp     al, 8
  5506 00001C87 753D                    	jne     short char_return
  5507                                  loc_back:
  5508 00001C89 B403                    	mov     ah, 3
  5509 00001C8B CD10                    	int     10h
  5510 00001C8D 3A16[AF54]              	cmp     dl, byte [Cursor_Pos]
  5511 00001C91 761F                    	jna     short loc_beep
  5512                                  prev_column:
  5513 00001C93 FECA                    	dec     dl
  5514                                  set_cursor_pos:
  5515 00001C95 B402                    	mov     ah, 2
  5516 00001C97 CD10                    	int     10h
  5517 00001C99 88D3                    	mov     bl, dl
  5518 00001C9B 2A1E[AF54]              	sub     bl, byte [Cursor_Pos]
  5519 00001C9F B90100                  	mov     cx, 1
  5520 00001CA2 B409                    	mov     ah, 9
  5521 00001CA4 B020                    	mov     al, 20h
  5522 00001CA6 8800                    	mov     [si+bx], al
  5523                                  loc_write_it:
  5524 00001CA8 B307                    	mov     bl, 7
  5525 00001CAA CD10                    	int     10h
  5526 00001CAC 8B16[AF54]              	mov     dx, [Cursor_Pos]
  5527 00001CB0 EBC7                    	jmp     short read_next_char
  5528                                  loc_beep:
  5529 00001CB2 B40E                    	mov     ah, 0Eh
  5530 00001CB4 B007                    	mov     al, 7
  5531 00001CB6 CD10                    	int     10h
  5532 00001CB8 EBBF                    	jmp     short read_next_char
  5533                                  loc_arrow:    
  5534 00001CBA 80FC4B                  	cmp     ah, 4Bh
  5535 00001CBD 74CA                    	je      short loc_back
  5536 00001CBF 80FC53                  	cmp     ah, 53h
  5537 00001CC2 74C5                    	je      short loc_back
  5538 00001CC4 EBB3                    	jmp     short read_next_char
  5539                                  char_return:
  5540 00001CC6 B403                    	mov     ah, 3
  5541 00001CC8 CD10                    	int     10h
  5542                                  check_char_type:
  5543 00001CCA 3C20                    	cmp     al, 20h
  5544 00001CCC 7229                    	jb      short loc_escape
  5545 00001CCE 88D4                    	mov     ah, dl
  5546 00001CD0 2A26[AF54]              	sub     ah, byte [Cursor_Pos]
  5547                                  	;cmp	ah, 10 
  5548                                  	;ja	short loc_beep
  5549 00001CD4 3A26[2364]              	cmp     ah, [vname_length] ; 05/01/2018
  5550 00001CD8 73D8                    	jnb	short loc_beep
  5551 00001CDA 3C7A                    	cmp     al, 'z'
  5552 00001CDC 779B                    	ja      short read_next_char
  5553 00001CDE 3C61                    	cmp     al, 'a'
  5554 00001CE0 7202                    	jb      short pass_capitalize
  5555 00001CE2 24DF                    	and     al, 0DFh
  5556                                  pass_capitalize:
  5557 00001CE4 88E3                    	mov     bl, ah 
  5558 00001CE6 30E4                    	xor     ah, ah
  5559 00001CE8 8900                    	mov     [si+bx], ax
  5560 00001CEA B307                    	mov     bl, 7
  5561 00001CEC B40E                    	mov     ah, 0Eh
  5562 00001CEE CD10                    	int     10h
  5563 00001CF0 EB87                    	jmp     short read_next_char
  5564                                  pass_escape:
  5565 00001CF2 3C0D                    	cmp     al, 0Dh	; 13 ; ENTER
  5566 00001CF4 7583                    	jne     short read_next_char
  5567                                  	;mov	ah, 0Eh
  5568                                  	;int	10h
  5569                                  	;mov	al, 0Ah
  5570                                  	;int	10h
  5571 00001CF6 C3                      	retn
  5572                                  loc_escape:
  5573 00001CF7 3C1B                    	cmp     al, 1Bh	; 27 ; ESC
  5574 00001CF9 75F7                    	jne     short pass_escape
  5575 00001CFB F9                      	stc
  5576 00001CFC C3                      	retn
  5577                                  
  5578                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5579                                  ; display CHS takle
  5580                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5581                                  
  5582                                  display_chs_table:
  5583                                  
  5584                                  	; 16/10/2020
  5585                                  	; 12/10/2020 (fdisk3)
  5586                                  	; 11/02/2019 (hdimage)
  5587                                  
  5588 00001CFD 06                      	push	es
  5589 00001CFE BF00B8                  	mov	di, 0B800h
  5590 00001D01 8EC7                    	mov	es, di
  5591 00001D03 BFA000                  	mov	di, 160 ; row 1
  5592 00001D06 B407                    	mov	ah, 07h
  5593 00001D08 B044                    	mov	al, 'D'
  5594 00001D0A AB                      	stosw
  5595 00001D0B B069                    	mov	al, 'i'
  5596 00001D0D AB                      	stosw
  5597 00001D0E B073                    	mov	al, 's'
  5598 00001D10 AB                      	stosw
  5599 00001D11 B06B                    	mov	al, 'k'
  5600 00001D13 AB                      	stosw
  5601 00001D14 B03A                    	mov	al, ':'
  5602 00001D16 AB                      	stosw
  5603 00001D17 B020                    	mov	al, ' '
  5604 00001D19 AB                      	stosw
  5605 00001D1A B068                    	mov	al, 'h'
  5606 00001D1C AB                      	stosw
  5607 00001D1D B064                    	mov	al, 'd'
  5608 00001D1F AB                      	stosw
  5609 00001D20 A0[3E68]                	mov	al, [DrvNum]
  5610 00001D23 2C50                    	sub	al, 80h-'0'
  5611 00001D25 AB                      	stosw
  5612 00001D26 BF4001                  	mov	di, 320 ; row 2
  5613 00001D29 B95000                  	mov	cx, 80		
  5614 00001D2C B82007                  	mov	ax, 0720h
  5615 00001D2F F3AB                    	rep	stosw
  5616 00001D31 B150                    	mov	cl, 80	; row 3 
  5617 00001D33 B02D                    	mov	al, "-"
  5618 00001D35 F3AB                    	rep	stosw
  5619                                  	;mov	cl, 19
  5620 00001D37 B112                    	mov	cl, 18 ; 16/10/2020 ; row 4
  5621 00001D39 B020                    	mov	al, 20h
  5622 00001D3B F3AB                    	rep	stosw
  5623 00001D3D B043                    	mov	al, 'C'
  5624 00001D3F AB                      	stosw
  5625 00001D40 B079                    	mov	al, 'y'
  5626 00001D42 AB                      	stosw
  5627 00001D43 B06C                    	mov	al, 'l'
  5628 00001D45 AB                      	stosw
  5629 00001D46 B069                    	mov	al, 'i'
  5630 00001D48 AB                       	stosw
  5631 00001D49 B06E                    	mov	al, 'n'
  5632 00001D4B AB                      	stosw	
  5633 00001D4C B064                    	mov	al, 'd'
  5634 00001D4E AB                      	stosw
  5635 00001D4F B065                    	mov	al, 'e'
  5636 00001D51 AB                      	stosw
  5637 00001D52 B072                    	mov	al, 'r'
  5638 00001D54 AB                       	stosw
  5639 00001D55 B073                    	mov	al, 's'
  5640 00001D57 AB                       	stosw
  5641 00001D58 B03A                    	mov	al, ':'
  5642 00001D5A AB                      	stosw
  5643 00001D5B B020                    	mov	al, 20h
  5644 00001D5D AB                      	stosw
  5645                                  	;mov	[cylnumpos], di
  5646 00001D5E A1[6E3F]                	mov	ax, [cylinders]
  5647 00001D61 8B16[703F]              	mov	dx, [cylinders+2] ; 16/10/2020
  5648                                  	;mov	cl, 4
  5649                                  	;mov	ch, 07h ; color
  5650 00001D65 E86A00                  	call	write_number
  5651                                  	
  5652                                  	;mov	ax, 0720h
  5653 00001D68 B020                    	mov	al, 20h ; 16/10/2020
  5654 00001D6A AB                      	stosw
  5655 00001D6B AB                      	stosw
  5656 00001D6C B048                    	mov	al, 'H'
  5657 00001D6E AB                      	stosw
  5658 00001D6F B065                    	mov	al, 'e'
  5659 00001D71 AB                      	stosw
  5660 00001D72 B061                    	mov	al, 'a'
  5661 00001D74 AB                      	stosw
  5662 00001D75 B064                    	mov	al, 'd'
  5663 00001D77 AB                       	stosw
  5664 00001D78 B073                    	mov	al, 's'
  5665 00001D7A AB                       	stosw
  5666 00001D7B B03A                    	mov	al, ':'
  5667 00001D7D AB                      	stosw
  5668 00001D7E B020                    	mov	al, 20h
  5669 00001D80 AB                      	stosw
  5670                                  	;mov	[hednumpos], di
  5671 00001D81 A1[6C3F]                	mov	ax, [heads]
  5672 00001D84 31D2                    	xor	dx, dx ; 16/10/2020
  5673                                  	;mov	cl, 2
  5674                                  	;mov	ch, 07h ; color
  5675 00001D86 E84900                  	call	write_number
  5676                                  
  5677                                  	;mov	ax, 0720h
  5678 00001D89 B020                    	mov	al, 20h ; 16/10/2020
  5679 00001D8B AB                      	stosw
  5680 00001D8C AB                      	stosw
  5681 00001D8D B053                    	mov	al, 'S'
  5682 00001D8F AB                      	stosw
  5683 00001D90 B065                    	mov	al, 'e'
  5684 00001D92 AB                      	stosw
  5685 00001D93 B063                    	mov	al, 'c'
  5686 00001D95 AB                      	stosw
  5687 00001D96 B074                    	mov	al, 't'
  5688 00001D98 AB                       	stosw
  5689 00001D99 B06F                    	mov	al, 'o'
  5690 00001D9B AB                      	stosw
  5691 00001D9C B072                    	mov	al, 'r'
  5692 00001D9E AB                       	stosw
  5693 00001D9F B073                    	mov	al, 's'
  5694 00001DA1 AB                       	stosw
  5695 00001DA2 B03A                    	mov	al, ':'
  5696 00001DA4 AB                      	stosw
  5697 00001DA5 B020                    	mov	al, 20h
  5698 00001DA7 AB                      	stosw
  5699                                  	;mov	[secnumpos], di
  5700 00001DA8 A1[6A3F]                	mov	ax, [sectors]
  5701 00001DAB 29D2                    	sub	dx, dx ; 16/10/2020
  5702                                  	;mov	cl, 2
  5703                                  	;mov	ch, 07h ; color
  5704 00001DAD E82200                  	call	write_number
  5705                                  
  5706 00001DB0 B92003                  	mov	cx, 800 ; 16/10/2020 ; row 5
  5707 00001DB3 29F9                    	sub	cx, di
  5708 00001DB5 D0E9                    	shr	cl, 1
  5709                                  	;mov	cl, 22
  5710                                  	;mov	ax, 0720h
  5711 00001DB7 B020                    	mov	al, 20h ; 16/10/2020
  5712 00001DB9 F3AB                    	rep	stosw
  5713                                  	
  5714 00001DBB B150                    	mov	cl, 80 	; row 6
  5715 00001DBD B02D                    	mov	al, "-"
  5716 00001DBF F3AB                    	rep	stosw
  5717                                  
  5718 00001DC1 B150                    	mov	cl, 80	 ; row 7
  5719                                  	;mov	cl, 160	 ; row 7, 8
  5720 00001DC3 B020                    	mov	al, 20h
  5721 00001DC5 F3AB                    	rep	stosw
  5722                                  
  5723 00001DC7 BA0006                  	mov	dx, 0600h ; DH = row, DL = 0 column
  5724 00001DCA 31DB                    	xor	bx, bx ; BH = video page (0)
  5725 00001DCC B402                    	mov	ah, 02h ; set cursor position
  5726 00001DCE CD10                    	int	10h
  5727                                  
  5728 00001DD0 07                      	pop	es
  5729 00001DD1 C3                      	retn
  5730                                  
  5731                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5732                                  ; write decimal number
  5733                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5734                                  
  5735                                  ;write_number:
  5736                                  ;	; 12/10/2020
  5737                                  ;	mov	bx, 10
  5738                                  ;	mov	si, cx
  5739                                  ;wnum_1:
  5740                                  ;	xor	dx, dx
  5741                                  ;	div	bx
  5742                                  ;	push	dx
  5743                                  ;	dec	cl
  5744                                  ;	jnz	short wnum_1
  5745                                  ;	mov	cx, si
  5746                                  ;	mov	ah, ch	; color (07h or 0Fh)
  5747                                  ;	xor	ch, ch
  5748                                  ;wnum_2:
  5749                                  ;	pop	dx
  5750                                  ;	mov	al, dl
  5751                                  ;	add	al, '0'
  5752                                  ;	stosw
  5753                                  ;	loop	wnum_2
  5754                                  ;	retn
  5755                                  
  5756                                  write_number:
  5757                                  	; 16/10/2020
  5758                                  	; dx:ax = binary number
  5759                                  	; di = decimal number/string location
  5760                                  	; modified registers: ax, bx, cx, dx, bp, di
  5761 00001DD2 B90A00                  	mov	cx, 10
  5762 00001DD5 89E5                    	mov	bp, sp
  5763                                  wnum_1:
  5764 00001DD7 E8A3EE                  	call	div32
  5765 00001DDA 53                      	push	bx
  5766 00001DDB 21D2                    	and	dx, dx
  5767 00001DDD 75F8                    	jnz	short wnum_1
  5768 00001DDF 09C0                    	or	ax, ax
  5769 00001DE1 75F4                    	jnz	short wnum_1
  5770                                  wnum_2:	
  5771 00001DE3 58                      	pop	ax
  5772 00001DE4 0430                    	add	al, '0'
  5773 00001DE6 B407                    	mov	ah, 07h ; color
  5774 00001DE8 AB                      	stosw
  5775 00001DE9 39E5                    	cmp	bp, sp
  5776 00001DEB 77F6                    	ja	short wnum_2
  5777 00001DED C3                      	retn
  5778                                  
  5779                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5780                                  ; partition size input
  5781                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5782                                  
  5783                                  	; 12/03/2021
  5784                                  partition_size_input:
  5785                                  	; 23/10/2020 (fdisk3.s modification on hdimage.s source code)
  5786                                  
  5787 00001DEE C706[E66C]0000          	mov	word [pSize_multiplier+2], 0
  5788 00001DF4 C606[EB6C]42            	mov	byte [msg_psize_unit+1], 'B'
  5789 00001DF9 A0[EA6C]                	mov	al, [pSize_unit]
  5790 00001DFC 3C25                    	cmp	al, '%'
  5791 00001DFE 7529                    	jne	short psu_0
  5792                                  	; 08/02/2019
  5793                                  	; calculate sector count for max. available sectors percentage
  5794 00001E00 8B16[DA6C]              	mov	dx, [pp_Sectors+2] ; max. available sectors
  5795 00001E04 A1[D86C]                	mov	ax, [pp_Sectors]   ; for a new partition
  5796                                  	;mov	dx, [total_sectors+2]
  5797                                  	;mov	ax, [total_sectors]
  5798                                  	;mov	cx, 100
  5799                                  	; 13/03/2021
  5800 00001E07 B96300                  	mov	cx, 99
  5801 00001E0A 01C8                    	add	ax, cx
  5802 00001E0C 83D200                  	adc	dx, 0
  5803 00001E0F 41                      	inc	cx ; cx = 100
  5804 00001E10 E86AEE                  	call	div32
  5805 00001E13 A3[E46C]                	mov	[pSize_multiplier], ax
  5806                                  	; 29/10/2020
  5807 00001E16 8916[E66C]              	mov	[pSize_multiplier+2], dx
  5808 00001E1A B400                    	mov	ah, 0
  5809 00001E1C 8826[EB6C]              	mov	[msg_psize_unit+1], ah
  5810                                  	;mov	byte [pSize_maxdigits], 2
  5811 00001E20 C606[E86C]03            	mov	byte [pSize_maxdigits], 3 ; 29/10/2020
  5812 00001E25 B025                    	mov	al, '%'
  5813 00001E27 EB65                    	jmp	short psu_6
  5814                                  psu_0:
  5815 00001E29 3C43                    	cmp	al, 'C'
  5816 00001E2B 7517                    	jne	short psu_1
  5817 00001E2D A1[6A3F]                	mov	ax, [sectors]
  5818 00001E30 F726[6C3F]              	mul	word [heads]
  5819 00001E34 A3[E46C]                	mov	[pSize_multiplier], ax
  5820                                  	;mov	byte [pSize_maxdigits], 4
  5821                                  	; <= 65535 cylinders
  5822 00001E37 C606[E86C]05            	mov	byte [pSize_maxdigits], 5 ; 23/10/2020
  5823                                  	;sub	dh, dh
  5824 00001E3C 8836[EB6C]              	mov	[msg_psize_unit+1], dh
  5825 00001E40 B043                    	mov	al, 'C'
  5826 00001E42 EB4A                    	jmp	short psu_6
  5827                                  psu_1:
  5828 00001E44 3C47                    	cmp	al, 'G'
  5829 00001E46 7513                    	jne	short psu_2
  5830 00001E48 C706[E46C]0008          	mov	word [pSize_multiplier], 2*1024
  5831 00001E4E C706[E66C]0004          	mov	word [pSize_multiplier+2], 1024
  5832                                  	;mov	byte [pSize_maxdigits], 1
  5833 00001E54 C606[E86C]03            	mov	byte [pSize_maxdigits], 3 ; <= 512 GB ; 23/10/2020
  5834 00001E59 EB33                    	jmp	short psu_6
  5835                                  psu_2:
  5836 00001E5B 3C4D                    	cmp	al, 'M'
  5837 00001E5D 750D                    	jne	short psu_3
  5838 00001E5F C706[E46C]0008          	mov	word [pSize_multiplier], 2*1024
  5839                                  	;;mov	byte [pSize_maxdigits], 4
  5840                                  	;mov	byte [pSize_maxdigits], 7 ; 23/10/2020
  5841                                  	; 12/03/2021
  5842 00001E65 C606[E86C]06            	mov	byte [pSize_maxdigits], 6 ; <= 524288
  5843 00001E6A EB22                    	jmp	short psu_6
  5844                                  psu_3:
  5845 00001E6C 3C4B                    	cmp	al, 'K'
  5846 00001E6E 750D                    	jne	short psu_4
  5847 00001E70 C706[E46C]0200          	mov	word [pSize_multiplier], 2
  5848                                  	;jmp	short psu_5
  5849                                  	; 12/03/2021
  5850 00001E76 C606[E86C]09            	mov	byte [pSize_maxdigits], 9 ; <= 536870912
  5851 00001E7B EB11                    	jmp	short psu_6 	
  5852                                  psu_4:
  5853                                  	; al = 'S'
  5854 00001E7D 30E4                    	xor	ah, ah
  5855 00001E7F 8826[EB6C]              	mov	[msg_psize_unit+1], ah
  5856 00001E83 C706[E46C]0100          	mov	word [pSize_multiplier], 1
  5857                                  psu_5:
  5858                                  	;mov	byte [pSize_maxdigits], 7
  5859 00001E89 C606[E86C]0A            	mov	byte [pSize_maxdigits], 10 ; 23/10/2020
  5860                                  psu_6:
  5861 00001E8E A2[A74E]                	mov	[msg_partition_size_x], al
  5862 00001E91 BE[934E]                	mov	si, msg_partition_size	
  5863 00001E94 E8E7FC                  	call	print_msg
  5864                                  
  5865 00001E97 89E5                    	mov	bp, sp
  5866 00001E99 31DB                    	xor	bx, bx
  5867 00001E9B 891E[E06C]              	mov	[pSize_temp], bx ; 0
  5868                                  	;mov	[pSize_temp+2], bx ; 0
  5869 00001E9F 881E[E96C]              	mov	[pSize_digitpos], bl ; 0
  5870                                  	; bh = 0  ; video page
  5871 00001EA3 B403                    	mov     ah, 3	; get cursor pos
  5872 00001EA5 CD10                    	int     10h
  5873 00001EA7 8916[AF54]              	mov	[Cursor_Pos], dx
  5874                                  	; 09/02/2019
  5875 00001EAB B307                    	mov     bl, 7   ; page 0, color 7 (light gray)   
  5876                                  psu_7:
  5877 00001EAD 30E4                    	xor	ah, ah
  5878 00001EAF CD16                    	int	16h
  5879                                  
  5880 00001EB1 3C30                    	cmp	al, '0'
  5881 00001EB3 7225                    	jb	short psu_8
  5882 00001EB5 3C39                    	cmp	al, '9'
  5883 00001EB7 77F4                    	ja	short psu_7
  5884 00001EB9 8A1E[E96C]              	mov	bl, [pSize_digitpos]
  5885 00001EBD 3A1E[E86C]              	cmp	bl, [pSize_maxdigits]
  5886 00001EC1 73EA                    	jnb	short psu_7
  5887 00001EC3 FE06[E96C]              	inc	byte [pSize_digitpos]
  5888 00001EC7 2C30                    	sub	al, '0'
  5889 00001EC9 30E4                    	xor	ah, ah
  5890 00001ECB 50                      	push	ax
  5891 00001ECC 0430                    	add	al, '0'
  5892 00001ECE B40E                    	mov	ah, 0Eh	; write char as tty
  5893                                  	;mov	bx, 7   ; page 0, color 7 (light gray)
  5894 00001ED0 CD10                    	int	10h
  5895 00001ED2 EBD9                    	jmp	short psu_7
  5896                                  
  5897                                  psu_8esc:
  5898                                  	; 29/10/2020 (ESCape)
  5899 00001ED4 89EC                    	mov	sp, bp ; clean stack
  5900                                  
  5901 00001ED6 08C0                    	or	al, al ; zf = 0
  5902 00001ED8 F9                      	stc
  5903 00001ED9 C3                      	retn	
  5904                                  psu_8:
  5905 00001EDA 20C0                    	and	al, al
  5906 00001EDC 0F849300                	jz	psu_15 ; check for left arrow key
  5907 00001EE0 3C1B                    	cmp	al, 27
  5908 00001EE2 74F0                    	je	short psu_8esc ; ESCAPE key ; 29/10/2020
  5909 00001EE4 0F878500                	ja	psu_14 ; check for left arrow key
  5910 00001EE8 3C0D                    	cmp	al, 13
  5911                                  	;je	short psu_9  ; ENTER key
  5912 00001EEA 7249                    	jb	short psu_11 ; check for backspace key
  5913                                  	;jmp	short psu_7
  5914 00001EEC 77BF                    	ja	short psu_7
  5915                                  psu_9:
  5916 00001EEE 31C0                    	xor	ax, ax
  5917 00001EF0 A3[E26C]                	mov	[pSize_temp+2], ax ; 0 ; 08/02/2019
  5918 00001EF3 3806[E96C]              	cmp	byte [pSize_digitpos], al ; 0
  5919 00001EF7 0F868500                	jna	psu_16		
  5920                                  	;xor	bh, bh
  5921 00001EFB 8A1E[E96C]              	mov	bl, [pSize_digitpos]
  5922 00001EFF FECB                    	dec	bl
  5923 00001F01 D0E3                    	shl	bl, 1
  5924 00001F03 01E3                    	add	bx, sp
  5925 00001F05 8B07                    	mov	ax, [bx]
  5926 00001F07 A3[E06C]                	mov	[pSize_temp], ax
  5927                                  	;mov	word [pSize_temp+2], 0
  5928 00001F0A B90A00                  	mov	cx, 10
  5929                                  psu_10:
  5930 00001F0D FE0E[E96C]              	dec	byte [pSize_digitpos]
  5931 00001F11 746D                    	jz	short psu_16
  5932                                  	
  5933 00001F13 A1[E06C]                	mov	ax, [pSize_temp]
  5934 00001F16 8B16[E26C]              	mov	dx, [pSize_temp+2]
  5935                                  	;mov	cx, 10
  5936 00001F1A E86EED                  	call	mul32
  5937                                  	;mov	[pSize_temp], ax
  5938                                  	;mov	[pSize_temp+2], dx
  5939                                  	;xor	bh, bh
  5940 00001F1D 8A1E[E96C]              	mov	bl, [pSize_digitpos]
  5941 00001F21 FECB                    	dec	bl
  5942 00001F23 D0E3                    	shl	bl, 1
  5943 00001F25 01E3                    	add	bx, sp ; (*)
  5944                                  	;mov	ax, [bx]
  5945                                  	;add	[pSize_temp], ax
  5946                                  	;adc	word [pSize_temp+2], 0
  5947 00001F27 0307                    	add	ax, [bx]
  5948 00001F29 83D200                  	adc	dx, 0
  5949 00001F2C A3[E06C]                	mov	[pSize_temp], ax
  5950 00001F2F 8916[E26C]              	mov	[pSize_temp+2], dx
  5951 00001F33 EBD8                    	jmp	short psu_10
  5952                                  	
  5953                                  	; Left arrow, backspace, DEL key checking
  5954                                  psu_11:
  5955 00001F35 3C08                    	cmp	al, 8 ; backspace key
  5956 00001F37 0F8572FF                	jne	psu_7
  5957                                  psu_12:
  5958                                  	;; bh = 0  ; video page
  5959                                  	;mov	ah, 3 ; get cursor pos
  5960                                  	;int	10h
  5961                                  	;cmp	dl, [Cursor_Pos]
  5962                                  	;jna	short psu_13
  5963                                  	;dec	dl
  5964                                  	;dec	byte [pSize_digitpos]
  5965                                  
  5966                                  	; 08/02/2019
  5967 00001F3B 8B16[AF54]              	mov	dx, [Cursor_Pos]
  5968 00001F3F 8A1E[E96C]              	mov	bl, [pSize_digitpos]
  5969 00001F43 20DB                    	and	bl, bl
  5970 00001F45 741D                    	jz	short psu_13
  5971                                  
  5972 00001F47 FECB                    	dec	bl 
  5973 00001F49 881E[E96C]              	mov	[pSize_digitpos], bl
  5974                                  	
  5975 00001F4D 00DA                    	add	dl, bl
  5976                                  
  5977                                  	; bh = 0  ; video page
  5978 00001F4F B402                    	mov	ah, 2 ; set cursor pos
  5979 00001F51 CD10                    	int	10h
  5980                                  	;mov	bl, dl
  5981                                  	;sub	bl, [Cursor_Pos] 
  5982 00001F53 B90100                  	mov	cx, 1
  5983 00001F56 B409                    	mov	ah, 9 ; write char at current curs pos
  5984 00001F58 B020                    	mov	al, 20h ; space (blank)
  5985 00001F5A 8800                    	mov	[si+bx], al
  5986                                  	; bh = 0 ; video page
  5987 00001F5C B307                    	mov	bl, 7 ; attribute/color (light gray)
  5988 00001F5E CD10                    	int	10h
  5989                                  
  5990                                  	; 09/02/2019
  5991 00001F60 58                      	pop	ax ; remove last digit on top of stack 
  5992                                  		   ; set sp to correct position for BX (*)
  5993 00001F61 E949FF                  	jmp	psu_7
  5994                                  psu_13:
  5995 00001F64 B40E                    	mov	ah, 0Eh
  5996 00001F66 B007                    	mov	al, 7
  5997                                  	;mov	bx, 7
  5998 00001F68 CD10                    	int	10h
  5999 00001F6A E940FF                  	jmp	psu_7
  6000                                  psu_14:
  6001 00001F6D 3CE0                    	cmp	al, 0E0h
  6002 00001F6F 0F853AFF                	jne	psu_7
  6003                                  psu_15:    
  6004 00001F73 80FC4B                  	cmp	ah, 4Bh ; left arrow
  6005 00001F76 74C3                    	je	short psu_12
  6006 00001F78 80FC53                  	cmp	ah, 53h ; DEL key (backspace)
  6007 00001F7B 74BE                    	je	short psu_12
  6008 00001F7D E92DFF                  	jmp	psu_7
  6009                                  psu_16:
  6010 00001F80 89EC                    	mov	sp, bp
  6011                                  
  6012                                  	; 29/10/2020
  6013 00001F82 803E[EA6C]25            	cmp	byte [pSize_unit], '%'
  6014 00001F87 751E                    	jne	short psu_23
  6015                                  
  6016 00001F89 B86400                  	mov	ax, 100
  6017 00001F8C 3906[E06C]              	cmp	word [pSize_temp], ax ; 100 ; % limit
  6018 00001F90 7624                    	jna	short psu_17
  6019 00001F92 A3[E06C]                	mov	word [pSize_temp], ax
  6020                                  
  6021                                  	; (re)set asciiz number string to '100'
  6022                                  
  6023 00001F95 28FF                    	sub	bh, bh ; 0 ; video page 0
  6024 00001F97 8B16[AF54]              	mov	dx, [Cursor_Pos]
  6025 00001F9B B402                    	mov	ah, 2 ; set cursor pos
  6026 00001F9D CD10                    	int	10h
  6027                                  
  6028 00001F9F BE[3A68]                	mov	si, msg_100
  6029 00001FA2 E8D9FB                  	call	print_msg
  6030                                  
  6031 00001FA5 EB0F                    	jmp	short psu_17
  6032                                  psu_23:
  6033 00001FA7 803E[EA6C]53            	cmp	byte [pSize_unit], 'S'
  6034 00001FAC 7508                    	jne	short psu_17 
  6035                                  
  6036 00001FAE BE[1864]                	mov	si, msg_sectors_crlf
  6037 00001FB1 E8CAFB                  	call	print_msg
  6038                                  	;xor	bx, bx
  6039 00001FB4 EB30                    	jmp	short psu_18
  6040                                  psu_17:
  6041 00001FB6 BE[EA6C]                	mov	si, msg_psize_unit
  6042 00001FB9 E8C2FB                  	call	print_msg
  6043                                  
  6044 00001FBC BE[6B55]                	mov	si, CRLF
  6045 00001FBF E8BCFB                  	call	print_msg
  6046                                  
  6047                                  	; 29/10/2020
  6048 00001FC2 803E[EA6C]25            	cmp	byte [pSize_unit], '%'
  6049 00001FC7 751D                    	jne	short psu_18
  6050                                  	
  6051 00001FC9 8B0E[E06C]              	mov	cx, [pSize_temp]
  6052                                  
  6053 00001FCD 21C9                    	and	cx, cx
  6054 00001FCF 7443                    	jz	short psu_21 ; 0%, ZERO !
  6055                                  
  6056 00001FD1 83F964                  	cmp	cx, 100
  6057 00001FD4 7606                    	jna	short psu_24
  6058                                  
  6059                                  	; show 100% for 1 second (for >100%)
  6060 00001FD6 E83D00                  	call	wait1second ; 29/10/2020
  6061                                  
  6062 00001FD9 B96400                  	mov	cx, 100
  6063                                  psu_24:
  6064 00001FDC A1[E46C]                	mov	ax, [pSize_multiplier]
  6065 00001FDF 8B16[E66C]              	mov	dx, [pSize_multiplier+2]
  6066                                  
  6067                                  	;mov	cx, [pSize_temp]
  6068                                  	;and	cx, cx
  6069                                  	;jz	short psu_21 ; 0%, ZERO !
  6070                                  
  6071 00001FE3 E9A5EC                  	jmp	mul32
  6072                                  psu_18:
  6073 00001FE6 A1[E06C]                	mov	ax, [pSize_temp]
  6074 00001FE9 8B16[E26C]              	mov	dx, [pSize_temp+2]
  6075 00001FED 89C1                    	mov	cx, ax
  6076 00001FEF 09D1                    	or	cx, dx
  6077                                  	;jz	short psu_20
  6078 00001FF1 7421                    	jz	short psu_21 ; 08/02/2019
  6079 00001FF3 8B0E[E46C]              	mov	cx, [pSize_multiplier]
  6080 00001FF7 803E[EA6C]43            	cmp	byte [pSize_unit], 'C'
  6081 00001FFC 7413                    	je	short psu_20 ; 09/02/2019
  6082                                  	;jne	short psu_19
  6083                                  	;call	mul32
  6084                                  	; 08/02/2019
  6085                                  	; dx:ax = requested partition size in sectors
  6086                                  	;retn	
  6087                                  ;psu_19:
  6088                                  	;mov	cx, [pSize_multiplier]
  6089 00001FFE 83F901                  	cmp	cx, 1
  6090                                  	;jna	short psu_20
  6091 00002001 7703                    	ja	short psu_19
  6092                                  	; 09/02/2019
  6093 00002003 31DB                    	xor	bx, bx
  6094 00002005 C3                      	retn
  6095                                  psu_19:
  6096 00002006 E882EC                  	call	mul32
  6097                                  	;and	bx, bx
  6098                                  	;jnz	short psu_22 ; 09/02/2019
  6099 00002009 8B0E[E66C]              	mov	cx, [pSize_multiplier+2]
  6100 0000200D 09C9                    	or	cx, cx
  6101                                  	;jz	short psu_20
  6102 0000200F 7404                    	jz	short psu_22 ; 09/02/2019
  6103                                  psu_20:
  6104                                  	;call	mul32
  6105                                  	;retn
  6106 00002011 E977EC                  	jmp	mul32 ; 23/10/2020
  6107                                  psu_21:
  6108                                  	; zf = 1 ; 29/10/2020
  6109 00002014 F9                      	stc
  6110                                  psu_22:
  6111 00002015 C3                      	retn
  6112                                  
  6113                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6114                                  ; wait for 1 second
  6115                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6116                                  
  6117                                  	; 29/10/2020
  6118                                  wait1second:
  6119 00002016 B402                    	mov	ah, 2
  6120 00002018 CD1A                    	int	1Ah ; get time of day
  6121 0000201A 720C                    	jc	short w1s_2
  6122                                  w1s_1:
  6123 0000201C 52                      	push	dx
  6124 0000201D B402                    	mov	ah, 2
  6125 0000201F CD1A                    	int	1Ah ; get time of day
  6126 00002021 58                      	pop	ax
  6127 00002022 7204                    	jc	short w1s_2
  6128 00002024 38E6                    	cmp	dh, ah
  6129 00002026 74F4                    	je	short w1s_1 ; same second
  6130                                  w1s_2:
  6131 00002028 C3                      	retn
  6132                                  
  6133                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6134                                  ; partition type input
  6135                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6136                                  
  6137                                  partition_type_input:
  6138 00002029 BE[AD4E]                	mov	si, msg_partition_type
  6139 0000202C E84FFB                  	call	print_msg
  6140                                  
  6141 0000202F 31DB                    	xor	bx, bx
  6142                                  
  6143 00002031 881E[FA6C]              	mov	[pType_pos], bl ; 0
  6144 00002035 891E[FB6C]              	mov	[pType_num], bx ; 0
  6145                                  
  6146                                  	; bh = 0  ; video page
  6147 00002039 B403                    	mov     ah, 3 ; get cursor pos
  6148 0000203B CD10                    	int     10h
  6149 0000203D 8916[AF54]              	mov	[Cursor_Pos], dx
  6150                                  ptu_0:
  6151 00002041 30E4                    	xor	ah, ah
  6152 00002043 CD16                    	int	16h
  6153                                  
  6154 00002045 803E[FA6C]01            	cmp	byte [pType_pos], 1
  6155 0000204A 773F                    	ja	short ptu_5	
  6156                                  
  6157 0000204C 3C30                    	cmp	al, '0'
  6158 0000204E 723B                    	jb	short ptu_5
  6159 00002050 3C39                    	cmp	al, '9'
  6160 00002052 7707                    	ja	short ptu_1
  6161 00002054 88C4                    	mov	ah, al
  6162 00002056 80EC30                  	sub	ah, '0'
  6163 00002059 EB13                    	jmp	short ptu_2 
  6164                                  ptu_1:
  6165 0000205B 3CE0                    	cmp     al, 0E0h
  6166 0000205D 7473                    	je	short ptu_9
  6167                                  
  6168 0000205F 24DF                    	and	al, 0DFh
  6169 00002061 3C41                    	cmp	al, 'A'
  6170 00002063 72DC                    	jb	short ptu_0
  6171 00002065 3C46                    	cmp	al, 'F'
  6172 00002067 77D8                    	ja	short ptu_0
  6173 00002069 88C4                    	mov	ah, al
  6174 0000206B 80EC37                  	sub	ah, 'A'-10
  6175                                  ptu_2:
  6176 0000206E 803E[FA6C]00            	cmp	byte [pType_pos], 0
  6177 00002073 7606                    	jna	short ptu_3
  6178 00002075 8826[FC6C]              	mov	[pType_num+1], ah
  6179 00002079 EB04                    	jmp	short ptu_4 
  6180                                  ptu_3:
  6181 0000207B 8826[FB6C]              	mov	[pType_num], ah
  6182                                  ptu_4:
  6183 0000207F B40E                    	mov	ah, 0Eh
  6184 00002081 B307                    	mov	bl, 7
  6185 00002083 CD10                    	int	10h
  6186                                  
  6187 00002085 FE06[FA6C]              	inc	byte [pType_pos]
  6188                                  
  6189 00002089 EBB6                    	jmp	short ptu_0 
  6190                                  ptu_5:
  6191 0000208B 20C0                    	and	al, al
  6192 0000208D 7443                    	jz	short ptu_9 ; check for left arrow key 
  6193 0000208F 3C1B                    	cmp	al, 27
  6194 00002091 744C                    	je	short ptu_10 ; ESCAPE key
  6195 00002093 77AC                    	ja	short ptu_0
  6196 00002095 3C0D                    	cmp	al, 13
  6197 00002097 744A                    	je	short ptu_11  ; ENTER key
  6198 00002099 77A6                    	ja	short ptu_0
  6199                                  ptu_6:
  6200                                  	; Left arrow, backspace, DEL key checking
  6201                                  
  6202 0000209B 3C08                    	cmp	al, 8 ; backspace key
  6203 0000209D 75A2                    	jne	short ptu_0
  6204                                  ptu_7:
  6205                                  	; bh = 0  ; video page
  6206 0000209F B403                    	mov	ah, 3 ; get cursor pos
  6207 000020A1 CD10                    	int	10h
  6208 000020A3 3A16[AF54]              	cmp	dl, [Cursor_Pos]
  6209 000020A7 7620                    	jna	short ptu_8
  6210 000020A9 FECA                    	dec	dl
  6211 000020AB FE0E[FA6C]              	dec	byte [pType_pos]
  6212                                  	; bh = 0  ; video page
  6213 000020AF B402                    	mov	ah, 2 ; set cursor pos
  6214 000020B1 CD10                    	int	10h
  6215 000020B3 88D3                    	mov	bl, dl
  6216 000020B5 2A1E[AF54]              	sub	bl, [Cursor_Pos] 
  6217 000020B9 B90100                  	mov	cx, 1
  6218 000020BC B409                    	mov	ah, 9 ; write char at current curs pos
  6219 000020BE B020                    	mov	al, 20h ; space (blank)
  6220 000020C0 8800                    	mov	[si+bx], al
  6221                                  	; bh = 0 ; video page
  6222 000020C2 B307                    	mov	bl, 7 ; attribute/color (light gray)
  6223 000020C4 CD10                    	int	10h
  6224 000020C6 E978FF                  	jmp	ptu_0
  6225                                  ptu_8:
  6226 000020C9 B40E                    	mov	ah, 0Eh
  6227 000020CB B007                    	mov	al, 7
  6228 000020CD CD10                    	int	10h
  6229 000020CF E96FFF                  	jmp	ptu_0
  6230                                  ptu_9:    
  6231 000020D2 80FC4B                  	cmp	ah, 4Bh ; left arrow
  6232 000020D5 74C8                    	je	short ptu_7
  6233 000020D7 80FC53                  	cmp	ah, 53h ; DEL key (backspace)
  6234 000020DA 74C3                    	je	short ptu_7
  6235 000020DC E962FF                  	jmp	ptu_0
  6236                                  
  6237                                  ptu_10: ; ESCAPE
  6238                                  	;mov	al, 0
  6239                                  	; 29/10/2020
  6240 000020DF 28C0                    	sub	al, al ; 0
  6241                                  	; partition type is 0 (none)
  6242 000020E1 EB12                    	jmp	short ptu_12
  6243                                  ptu_11: ; ENTER
  6244 000020E3 A0[FB6C]                	mov	al, [pType_num]
  6245 000020E6 803E[FA6C]01            	cmp	byte [pType_pos], 1
  6246 000020EB 7608                    	jna	short ptu_12
  6247 000020ED B410                    	mov	ah, 16
  6248 000020EF F6E4                    	mul	ah
  6249 000020F1 0206[FC6C]              	add	al, [pType_num+1]
  6250                                  ptu_12:
  6251 000020F5 50                      	push	ax
  6252 000020F6 E85BFB                  	call	bin_to_hex
  6253 000020F9 A3[C34E]                	mov	[msg_ptype_num], ax
  6254                                  	; bh = 0  ; video page
  6255 000020FC B402                    	mov	ah, 2 ; set cursor pos
  6256 000020FE 8B16[AF54]              	mov	dx, [Cursor_Pos]
  6257 00002102 CD10                    	int	10h
  6258 00002104 BE[C34E]                	mov	si, msg_ptype_num 
  6259 00002107 E874FA                  	call	print_msg
  6260 0000210A 58                      	pop	ax
  6261 0000210B C3                      	retn
  6262                                  
  6263                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6264                                  ; show selected partition
  6265                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6266                                  
  6267                                  show_selected_partition:
  6268                                  	; INPUT ->
  6269                                  	; 	DS:SI = Partition table row address
  6270                                  	
  6271                                  	; 2019 - 2020 (hdimage.s)
  6272                                  	;pt_s_offset	equ 7
  6273                                  	;pt_bh_offset	equ 11
  6274                                  	;pt_bs_offset	equ 15
  6275                                  	;pt_bc_offset	equ 19
  6276                                  	;pt_fs_offset	equ 23
  6277                                  	;pt_eh_offset	equ 27
  6278                                  	;pt_es_offset	equ 31
  6279                                  	;pt_ec_offset	equ 35
  6280                                  	;pt_rs_offset	equ 41
  6281                                  	;pt_ts_offset	equ 52
  6282                                  	;pt_fsn_offset	equ 63
  6283                                  
  6284                                  	; 24/10/2020 (fdisk3.s)
  6285                                  	pt_s_offset	equ 6
  6286                                  	pt_bh_offset	equ 10
  6287                                  	pt_bs_offset	equ 14
  6288                                  	pt_bc_offset	equ 18
  6289                                  	pt_fs_offset	equ 22
  6290                                  	pt_eh_offset	equ 26
  6291                                  	pt_es_offset	equ 30
  6292                                  	pt_ec_offset	equ 34
  6293                                  	pt_rs_offset	equ 40
  6294                                  	pt_ts_offset	equ 51
  6295                                  	pt_fsn_offset	equ 63
  6296                                  
  6297                                  	; clear screen
  6298 0000210C B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  6299 0000210F CD10                    	int	10h	
  6300                                  
  6301 00002111 89F0                    	mov	ax, si
  6302 00002113 2D[A457]                	sub	ax, MasterBootBuff + pTableOffset ; + 446
  6303 00002116 C0E804                  	shr	al, 4 ; from offset to partition number
  6304 00002119 0431                    	add	al, '1'  ; 1 based partition number (chr)
  6305                                  	; Write partition number to the header location
  6306 0000211B A2[8350]                	mov	[msg_selected_partition+43], al ; '1' to '4'
  6307                                  	
  6308                                  	; Partition number will be used at formatting stage
  6309 0000211E A2[5253]                	mov	[partition_num_chr], al ; number + '0'
  6310                                  
  6311 00002121 B268                    	mov	dl, 'h'
  6312 00002123 8A04                    	mov	al, [si+ptBootable]
  6313 00002125 E82CFB                  	call	bin_to_hex
  6314 00002128 A3[9E51]                	mov	[pt_row+pt_s_offset], ax
  6315 0000212B 8816[A051]              	mov	[pt_row+pt_s_offset+2], dl ; 'h'
  6316 0000212F 8A4401                  	mov	al, [si+ptBeginHead]
  6317 00002132 E81FFB                  	call	bin_to_hex
  6318 00002135 A3[A251]                	mov	[pt_row+pt_bh_offset], ax
  6319 00002138 8816[A451]              	mov	[pt_row+pt_bh_offset+2], dl ; 'h'
  6320 0000213C 8A4402                  	mov	al, [si+ptBeginSector]
  6321 0000213F E812FB                  	call	bin_to_hex
  6322 00002142 A3[A651]                	mov	[pt_row+pt_bs_offset], ax
  6323 00002145 8816[A851]              	mov	[pt_row+pt_bs_offset+2], dl ; 'h'
  6324 00002149 8A4403                  	mov	al, [si+ptBeginCylinder]
  6325 0000214C E805FB                  	call	bin_to_hex
  6326 0000214F A3[AA51]                	mov	[pt_row+pt_bc_offset], ax
  6327 00002152 8816[AC51]              	mov	[pt_row+pt_bc_offset+2], dl ; 'h'
  6328 00002156 8A4404                  	mov	al, [si+ptFileSystemID]
  6329                                   	; Partition type will be used at formatting stage
  6330 00002159 A2[DE6C]                	mov	[pp_type_user], al
  6331 0000215C E8F5FA                  	call	bin_to_hex
  6332 0000215F A3[AE51]                	mov	[pt_row+pt_fs_offset], ax
  6333 00002162 8816[B051]              	mov	[pt_row+pt_fs_offset+2], dl ; 'h'
  6334 00002166 8A4405                  	mov	al, [si+ptEndHead]
  6335 00002169 E8E8FA                  	call	bin_to_hex
  6336 0000216C A3[B251]                	mov	[pt_row+pt_eh_offset], ax
  6337 0000216F 8816[B451]              	mov	[pt_row+pt_eh_offset+2], dl ; 'h'
  6338 00002173 8A4406                  	mov	al, [si+ptEndSector]
  6339 00002176 E8DBFA                  	call	bin_to_hex
  6340 00002179 A3[B651]                	mov	[pt_row+pt_es_offset], ax
  6341 0000217C 8816[B851]              	mov	[pt_row+pt_es_offset+2], dl ; 'h'
  6342 00002180 8A4407                  	mov	al, [si+ptEndCylinder]
  6343 00002183 E8CEFA                  	call	bin_to_hex
  6344 00002186 A3[BA51]                	mov	[pt_row+pt_ec_offset], ax
  6345 00002189 8816[BC51]              	mov	[pt_row+pt_ec_offset+2], dl ; 'h'
  6346 0000218D 8A4408                  	mov	al, [si+ptStartSector]
  6347 00002190 E8C1FA                  	call	bin_to_hex
  6348 00002193 A3[C651]                	mov	[pt_row+pt_rs_offset+6], ax
  6349 00002196 8816[C851]              	mov	[pt_row+pt_rs_offset+8], dl ; 'h'
  6350 0000219A 8A4409                  	mov	al, [si+ptStartSector+1]
  6351 0000219D E8B4FA                  	call	bin_to_hex
  6352 000021A0 A3[C451]                	mov	[pt_row+pt_rs_offset+4], ax
  6353 000021A3 8A440A                  	mov	al, [si+ptStartSector+2]
  6354 000021A6 E8ABFA                  	call	bin_to_hex
  6355 000021A9 A3[C251]                	mov	[pt_row+pt_rs_offset+2], ax
  6356 000021AC 8A440B                  	mov	al, [si+ptStartSector+3]
  6357 000021AF E8A2FA                  	call	bin_to_hex
  6358 000021B2 A3[C051]                	mov	[pt_row+pt_rs_offset], ax
  6359 000021B5 8A440C                  	mov	al, [si+ptSectors]
  6360 000021B8 E899FA                  	call	bin_to_hex
  6361 000021BB A3[D151]                	mov	[pt_row+pt_ts_offset+6], ax
  6362 000021BE 8816[D351]              	mov	[pt_row+pt_ts_offset+8], dl ; 'h'
  6363 000021C2 8A440D                  	mov	al, [si+ptSectors+1]
  6364 000021C5 E88CFA                  	call	bin_to_hex
  6365 000021C8 A3[CF51]                	mov	[pt_row+pt_ts_offset+4], ax
  6366 000021CB 8A440E                  	mov	al, [si+ptSectors+2]
  6367 000021CE E883FA                  	call	bin_to_hex
  6368 000021D1 A3[CD51]                	mov	[pt_row+pt_ts_offset+2], ax
  6369 000021D4 8A440F                  	mov	al, [si+ptSectors+3]
  6370 000021D7 E87AFA                  	call	bin_to_hex
  6371 000021DA A3[CB51]                	mov	[pt_row+pt_ts_offset], ax
  6372                                  
  6373 000021DD 8A4404                  	mov	al, [si+ptFileSystemID]
  6374 000021E0 BF[8A40]                	mov	di, valid_partitions
  6375 000021E3 B91300                  	mov	cx, 19
  6376 000021E6 F2AE                    	repnz	scasb
  6377 000021E8 7405                    	jz	short ssp_1
  6378 000021EA B8[7C40]                	mov	ax, FS_OTHERS	 
  6379 000021ED EB0C                    	jmp	short ssp_2
  6380                                  ssp_1:
  6381 000021EF 81EF[8B40]              	sub	di, valid_partitions + 1
  6382 000021F3 B80E00                  	mov	ax, 14
  6383 000021F6 F7E7                    	mul	di
  6384 000021F8 05[723F]                	add	ax, FileSys_Names
  6385                                  ssp_2:
  6386 000021FB 96                      	xchg	ax, si 
  6387 000021FC B107                    	mov	cl, 7
  6388 000021FE BF[D751]                	mov	di, pt_row + pt_fsn_offset
  6389 00002201 F3A5                    	rep	movsw
  6390 00002203 89C7                    	mov	di, ax ; partition table row address
  6391                                  
  6392 00002205 BE[5850]                	mov	si, msg_selected_partition
  6393 00002208 E873F9                  	call	print_msg
  6394                                  
  6395 0000220B BE[3952]                	mov	si, msg_boot_indicator
  6396 0000220E E86DF9                  	call	print_msg
  6397 00002211 BE[A55C]                	mov	si, msg_YES
  6398 00002214 F60580                  	test	byte [di+ptBootable], 80h
  6399 00002217 7503                    	jnz	short ssp_3
  6400 00002219 BE[AB5C]                	mov	si, msg_NO
  6401                                  ssp_3:
  6402 0000221C E85FF9                  	call	print_msg
  6403                                  
  6404 0000221F BE[5152]                	mov	si, msg_starting_head
  6405 00002222 E859F9                  	call	print_msg
  6406 00002225 8A4501                  	mov	al, [di+ptBeginHead]
  6407 00002228 E8B200                  	call	write_byte_decimal
  6408 0000222B E850F9                  	call	print_msg
  6409 0000222E BE[6952]                	mov	si, msg_starting_sector
  6410 00002231 E84AF9                  	call	print_msg
  6411 00002234 8A4502                  	mov	al, [di+ptBeginSector]
  6412 00002237 88C2                    	mov	dl, al  ; bits 7&8 are bits 8&9 of cyl
  6413 00002239 243F                    	and	al, 3Fh ; sector number, 1 to 63
  6414 0000223B E89F00                  	call	write_byte_decimal
  6415 0000223E E83DF9                  	call	print_msg	
  6416 00002241 BE[8152]                	mov	si, msg_starting_cylinder
  6417 00002244 E837F9                  	call	print_msg
  6418 00002247 8A4503                  	mov	al, [di+ptBeginCylinder] ; bits 0to7 of cyl
  6419 0000224A C0EA06                  	shr	dl, 6 ; bits 8&9 of cyl
  6420 0000224D 88D4                    	mov	ah, dl
  6421 0000224F 31D2                    	xor	dx, dx
  6422                                  	;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  6423                                  	; 06/11/2020
  6424 00002251 BE[F76C]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  6425                                  	; dx_ax: binary number
  6426 00002254 E8E6F9                  	call	bin_to_decimal
  6427                                  	; ds:si = decimal number text address
  6428 00002257 E824F9                  	call	print_msg
  6429 0000225A BE[9952]                	mov	si, msg_system_id
  6430 0000225D E81EF9                  	call	print_msg
  6431                                  	; Write file system name (again, copy)
  6432 00002260 BE[D751]                	mov	si, pt_row + pt_fsn_offset
  6433                                  	;mov	cx, 14
  6434 00002263 B10E                    	mov	cl, 14
  6435 00002265 B40E                    	mov	ah, 0Eh ; write tty
  6436 00002267 BB0700                  	mov	bx, 7
  6437                                  ssp_4:	 
  6438 0000226A AC                      	lodsb
  6439 0000226B CD10                    	int	10h
  6440 0000226D E2FB                    	loop	ssp_4
  6441                                  
  6442 0000226F BE[B152]                	mov	si, msg_ending_head
  6443 00002272 E809F9                  	call	print_msg
  6444 00002275 8A4505                  	mov	al, [di+ptEndHead]
  6445 00002278 E86200                  	call	write_byte_decimal
  6446 0000227B E800F9                  	call	print_msg
  6447 0000227E BE[C952]                	mov	si, msg_ending_sector
  6448 00002281 E8FAF8                  	call	print_msg
  6449 00002284 8A4506                  	mov	al, [di+ptEndSector]
  6450 00002287 88C2                    	mov	dl, al  ; bits 7&8 are bits 8&9 of cyl
  6451 00002289 243F                    	and	al, 3Fh ; sector number, 1 to 63
  6452 0000228B E84F00                  	call	write_byte_decimal
  6453 0000228E E8EDF8                  	call	print_msg	
  6454 00002291 BE[E152]                	mov	si, msg_ending_cylinder
  6455 00002294 E8E7F8                  	call	print_msg
  6456 00002297 8A4507                  	mov	al, [di+ptEndCylinder] ; bits 0to7 of cyl
  6457 0000229A C0EA06                  	shr	dl, 6 ; bits 8&9 of cyl
  6458 0000229D 88D4                    	mov	ah, dl
  6459 0000229F 31D2                    	xor	dx, dx
  6460                                  	;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  6461                                  	; 06/11/2020
  6462 000022A1 BE[F76C]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits 
  6463                                  	; dx_ax: binary number
  6464 000022A4 E896F9                  	call	bin_to_decimal
  6465                                  	; ds:si = decimal number text address
  6466 000022A7 E8D4F8                  	call	print_msg
  6467                                  
  6468 000022AA BE[F952]                	mov	si, msg_relative_sectors
  6469 000022AD E8CEF8                  	call	print_msg
  6470 000022B0 8B4508                  	mov	ax, [di+ptStartSector]
  6471 000022B3 8B550A                  	mov	dx, [di+ptStartSector+2]
  6472                                  	;;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  6473                                  	;mov	si, reserved_bytes + 10 ; max. 11 digits
  6474                                  	; 06/11/2020
  6475 000022B6 BE[F76C]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  6476 000022B9 E881F9                  	call	bin_to_decimal
  6477 000022BC E8BFF8                  	call	print_msg
  6478                                  
  6479 000022BF BE[1353]                	mov	si, msg_total_sectors
  6480 000022C2 E8B9F8                  	call	print_msg
  6481 000022C5 8B450C                  	mov	ax, [di+ptSectors]
  6482 000022C8 8B550E                  	mov	dx, [di+ptSectors+2]
  6483                                  	;;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  6484                                  	;mov	si, reserved_bytes + 10 ; max. 11 digits
  6485                                  	; 06/11/2020
  6486 000022CB BE[F76C]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  6487 000022CE E86CF9                  	call	bin_to_decimal	
  6488 000022D1 E8AAF8                  	call	print_msg
  6489                                  
  6490                                  	; 24/02/2019
  6491 000022D4 BE[6B55]                	mov	si, CRLF
  6492 000022D7 E8A4F8                  	call	print_msg
  6493                                  
  6494 000022DA 89FE                    	mov	si, di  ; partition table row address
  6495                                  
  6496 000022DC C3                      	retn
  6497                                  
  6498                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6499                                  ; write byte as descimal number
  6500                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6501                                  
  6502                                  write_byte_decimal:
  6503                                  	; INPUT ->
  6504                                  	;	AL = binary number
  6505                                  	; OUTPUT ->
  6506                                  	;	DS:SI = decimal number text address
  6507                                  	;	        (ASCIIZ string)
  6508                                  	;
  6509                                  	; (SI, AX, CX will be modified)	
  6510                                  
  6511                                  	;mov	si, msg_partition_sectors + 8 ; max. 8 digits
  6512                                  	; 06/11/2020
  6513 000022DD BE[F86C]                	mov	si, msg_partition_sectors + 11 ; max. 11 digits
  6514 000022E0 B10A                    	mov	cl, 10
  6515                                  wbd_loop:
  6516 000022E2 4E                      	dec	si
  6517 000022E3 30E4                    	xor	ah, ah
  6518 000022E5 F6F1                    	div	cl
  6519 000022E7 80C430                  	add	ah, '0'
  6520 000022EA 8824                    	mov	[si], ah
  6521 000022EC 20C0                    	and	al, al
  6522 000022EE 75F2                    	jnz	short wbd_loop
  6523 000022F0 C3                      	retn
  6524                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6525                                  ; init (MBR) partition table
  6526                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6527                                  ; 16/10/2020
  6528                                  
  6529                                  	; 03/02/2019
  6530                                  init_partition_table:
  6531                                  
  6532                                  	; INPUT -> none
  6533                                  	; OUTPUT -> none
  6534                                  
  6535                                  	; 15/10/2020
  6536                                  	; (If a partition row contains invalid/wrong/defective parameters)
  6537                                  	; (it's active partition flag/byte will be 0FFh, an invalid value!)
  6538                                  
  6539                                  	; 12/02/2019	
  6540                                  	;cmp	word [MBIDCode], 0AA55h
  6541                                  	;jne	ipt_stc ; invalid
  6542                                  
  6543                                  	; 15/02/2019
  6544                                  	; clear primary partition table structure/list
  6545                                  
  6546 000022F1 BF[806F]                	mov	di, part_table_boot_ind
  6547 000022F4 B92400                  	mov	cx, 36 ; 18*4 = 72 bytes
  6548 000022F7 31C0                    	xor	ax, ax ; 0
  6549 000022F9 F3AB                    	rep	stosw
  6550                                  
  6551 000022FB A3[C86F]                	mov	[pcount], ax ; reset (pcount & ppcount)
  6552 000022FE A3[CA6F]                	mov	[apcount], ax ; reset (apcount & epnumber)
  6553                                  
  6554 00002301 BE[A457]                	mov	si, MasterBootBuff+446 ; Partition table offset
  6555                                  	;mov	cx, 4
  6556 00002304 B104                    	mov	cl, 4
  6557 00002306 31FF                    	xor	di, di
  6558                                  ipt_0:
  6559 00002308 8A6404                  	mov	ah, [si+ptFileSystemID]
  6560                                  
  6561 0000230B 20E4                    	and	ah, ah
  6562 0000230D 0F841601                	jz	ipt_8 ; empty
  6563                                  
  6564 00002311 FE06[C86F]              	inc	byte [pcount] ; partition count
  6565                                  
  6566 00002315 80FC01                  	cmp	ah, 1	; FAT12
  6567 00002318 7442                    	je	short ipt_2
  6568 0000231A 80FC04                  	cmp	ah, 4	; FAT16
  6569 0000231D 743D                    	je	short ipt_2
  6570 0000231F 723F                    	jb	short ipt_3	
  6571 00002321 80FC06                  	cmp	ah, 6	; FAT16 big
  6572 00002324 7436                    	je	short ipt_2
  6573 00002326 7715                    	ja	short ipt_1 ; EXTENDED
  6574                                  
  6575                                  	;cmp	ah, 5 ; EXTENDED
  6576                                  	;jne	short ipt_3
  6577                                  ipt_17:
  6578 00002328 803E[CB6F]00            	cmp	byte [epnumber], 0
  6579                                  	;ja	short ipt_stc ; invalid  (more than 1 extended dos partition)
  6580 0000232D 7605                    	jna	short ipt_15
  6581                                  	
  6582 0000232F C685[806F]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  6583                                  				; Invalid/Defective partition flag
  6584                                  ipt_15:	
  6585 00002334 B005                    	mov	al, 5
  6586 00002336 28C8                    	sub	al, cl ; partition number 1 to 4
  6587 00002338 A2[CB6F]                	mov	byte [epnumber], al ; extended partition entry number (1 to 4)
  6588 0000233B EB23                    	jmp	short ipt_3
  6589                                  ipt_1:
  6590                                  	; 26/10/2020
  6591 0000233D 80FC07                  	cmp	ah, 07h ; NTFS (Windows FS)
  6592 00002340 741A                    	je	short ipt_2 ; accept NTFS as primary dos partition
  6593                                  			    ; (then, extended partition can be created)	
  6594                                  	; 24/10/2020
  6595 00002342 80FC0C                  	cmp	ah, 0Ch ; FAT32 (LBA)
  6596 00002345 7415                    	je	short ipt_2
  6597 00002347 7707                    	ja	short ipt_18
  6598                                  	; 16/10/2020
  6599 00002349 80FC0B                  	cmp	ah, 0Bh ; FAT32 (CHS)
  6600                                  	;jne	short ipt_3
  6601                                  	; 24/10/2020
  6602 0000234C 740E                    	je	short ipt_2
  6603 0000234E 7210                    	jb	short ipt_3 ; non-dos partition (NTFS or unknown fs type)
  6604                                  ipt_18:
  6605 00002350 80FC0F                  	cmp	ah, 0Fh  ; EXTENDED (LBA)
  6606 00002353 74D3                    	je	short ipt_17
  6607 00002355 7709                    	ja	short ipt_3 ; non-dos partition 
  6608                                  			    ; (xenix/unix/linux/singlix/runix or unknown)
  6609 00002357 80FC0E                  	cmp	ah, 0Eh ; FAT16 (LBA)
  6610 0000235A 7504                    	jne	short ipt_3 ; 0Dh
  6611                                  	; FAT16 LBA (0Eh)
  6612                                  ipt_2:
  6613 0000235C FE06[C96F]              	inc	byte [ppcount] ; primary dos partition count
  6614                                  ipt_3:
  6615 00002360 88A5[856F]              	mov	[part_table_sys_id+di], ah  ; Partition Type (FS type)
  6616                                  	
  6617 00002364 8A04                    	mov	al, [si+ptBootable]
  6618                                  
  6619 00002366 20C0                    	and	al, al
  6620 00002368 7413                    	jz	short ipt_4
  6621                                  
  6622 0000236A 803E[CA6F]01            	cmp	byte [apcount], 1 ; check (previous) active partition count
  6623                                  	;jnb	short ipt_stc  ; invalid (if it is not zero here)
  6624 0000236F 7304                    	jnb	short ipt_16
  6625                                  
  6626 00002371 3C80                    	cmp	al, 80h  ; active partition sign/flag?
  6627                                  	;jne	short ipt_stc  ; invalid flag
  6628 00002373 7404                    	je	short ipt_11
  6629                                  ipt_16:
  6630                                  	; 15/10/2020
  6631 00002375 B0FF                    	mov	al, 0FFh ; Invalid/Defective partition flag
  6632 00002377 EB04                    	jmp	short ipt_4
  6633                                  ipt_11:
  6634 00002379 FE06[CA6F]              	inc	byte [apcount]  ; active partition count = 1
  6635                                  ipt_4:
  6636 0000237D 8885[806F]              	mov	[part_table_boot_ind+di], al
  6637                                  
  6638                                  	;mov	al, [heads]
  6639                                  ;ipt_4_fix:
  6640                                  	;dec	al
  6641 00002381 8A6401                  	mov	ah, [si+ptBeginHead]
  6642                                  	;cmp	al, ah
  6643                                  	;;jb	short ipt_retn ; invalid
  6644                                  	;jb	ipt_heads_fix ; 10/02/2019
  6645 00002384 88A5[816F]              	mov	[part_table_start_head+di], ah
  6646 00002388 8A6405                  	mov	ah, [si+ptEndHead]
  6647                                  	;cmp	al, ah
  6648                                  	;;jb	short ipt_retn ; invalid
  6649                                  	;jb	short ipt_heads_fix ; 10/02/2019
  6650 0000238B 88A5[866F]              	mov	[part_table_end_head+di], ah
  6651                                  	;mov	al, [sectors]
  6652 0000238F 8A7C02                  	mov	bh, [si+ptBeginSector]
  6653 00002392 88FC                    	mov	ah, bh
  6654 00002394 80E43F                  	and	ah, 3Fh ; 63
  6655                                  	;cmp	al, ah
  6656                                  	;jb	short ipt_retn ; invalid
  6657 00002397 88A5[826F]              	mov	[part_table_start_sector+di], ah
  6658 0000239B 8A7406                  	mov	dh, [si+ptEndSector]
  6659 0000239E 88F4                    	mov	ah, dh
  6660 000023A0 80E43F                  	and	ah, 3Fh ; 63
  6661                                  	;cmp	al, ah
  6662                                  	;jb	short ipt_retn ; invalid
  6663 000023A3 88A5[876F]              	mov	[part_table_end_sector+di], ah
  6664 000023A7 C0EF06                  	shr	bh, 6
  6665 000023AA 8A5C03                  	mov	bl, [si+ptBeginCylinder]
  6666                                  	;mov	ax, [cylinders]
  6667                                  	;dec	ax	
  6668                                  	;cmp	ax, bx
  6669                                  	;jb	short ipt_retn ; invalid
  6670 000023AD 899D[836F]              	mov	[part_table_start_cyl+di], bx
  6671 000023B1 C0EE06                  	shr	dh, 6
  6672 000023B4 8A5407                  	mov	dl, [si+ptEndCylinder]
  6673                                  	;cmp	ax, dx
  6674                                  	;jb	short ipt_retn ; invalid
  6675 000023B7 8995[886F]              	mov	[part_table_end_cyl+di], dx
  6676                                  
  6677 000023BB 8B4408                  	mov	ax, [si+ptStartSector]
  6678 000023BE 8B540A                  	mov	dx, [si+ptStartSector+2]
  6679                                  
  6680 000023C1 8985[8A6F]              	mov	[part_table_rel_sec_lw+di], ax
  6681 000023C5 8995[8C6F]              	mov	[part_table_rel_sec_hw+di], dx
  6682                                  
  6683 000023C9 09D0                    	or	ax, dx
  6684                                  	;jz	short ipt_stc ; invalid (start sector must not be zero)
  6685 000023CB 7505                    	jnz	short ipt_12
  6686                                  	; 15/10/2020
  6687 000023CD C685[806F]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  6688                                  				; Invalid/Defective partition flag
  6689                                  ipt_12:
  6690 000023D2 8B440C                  	mov	ax, [si+ptSectors]
  6691 000023D5 8B540E                  	mov	dx, [si+ptSectors+2]
  6692                                  
  6693 000023D8 89D3                    	mov	bx, dx
  6694 000023DA 09C3                    	or	bx, ax
  6695                                  	;jz	short ipt_stc	; invalid (zero size of partition)
  6696 000023DC 7505                    	jnz	short ipt_6 ; 10/02/2019
  6697                                  
  6698                                  	; 15/10/2020
  6699 000023DE C685[806F]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  6700                                  				; Invalid/Defective partition flag
  6701                                  
  6702                                  	;cmp	dx, [total_sectors+2]
  6703                                  	;ja	short ipt_stc	; invalid (partition size > disk capacity)
  6704                                  	;jb	short ipt_6
  6705                                  	;;cmp	ax, [total_sectors] ; (ax + 1) <= total sectors
  6706                                  	;jb	short ipt_6
  6707                                  	
  6708                                  ;ipt_stc:
  6709                                  ;	; invalid MBR data
  6710                                  ;	;stc
  6711                                  ;ipt_retn:
  6712                                  ;	retn
  6713                                  
  6714                                  ;ipt_heads_fix:
  6715                                  	; 10/02/2019
  6716                                  	; AL = [heads] - 1
  6717                                  
  6718                                  	;test	byte [cylinders], 1
  6719                                  	;jnz	short ipt_stc ; odd cylinder count (can not be shifted)
  6720                                  	
  6721                                  	;inc	al ; = [heads]
  6722                                  	;cmp	al, 8
  6723                                  	;ja	short ipt_stc ; this fix is needed for <= 16 heads (& 17 spt)
  6724                                  	;shl	al, 1
  6725                                  	;mov	[heads], al ; heads = heads*2
  6726                                  	;shr	word [cylinders], 1 ; cylinders = cylinders/2
  6727                                  	;jmp	ipt_4_fix
  6728                                  
  6729                                  ipt_6:
  6730 000023E3 8985[8E6F]              	mov	[part_table_num_sec_lw+di], ax
  6731 000023E7 8995[906F]              	mov	[part_table_num_sec_hw+di], dx
  6732                                  
  6733 000023EB 0385[8A6F]              	add	ax, [part_table_rel_sec_lw+di]
  6734 000023EF 1395[8C6F]              	adc	dx, [part_table_rel_sec_hw+di]
  6735                                  	;jc	short ipt_retn  ; invalid
  6736                                  	; 27/10/2020
  6737 000023F3 720E                    	jc	short ipt_13
  6738                                  
  6739 000023F5 3B16[4468]              	cmp	dx, [total_sectors+2]
  6740                                  	;ja	short ipt_stc	; invalid (partition end > disk capacity)
  6741 000023F9 720D                    	jb	short ipt_7
  6742                                  	; 27/10/2020
  6743 000023FB 7706                    	ja	short ipt_13
  6744 000023FD 3B06[4268]              	cmp	ax, [total_sectors] ; ax <= total sectors
  6745                                  	;ja	short ipt_stc	; invalid (partition end > disk capacity)
  6746 00002401 7605                    	jna	short ipt_7
  6747                                  ipt_13:
  6748                                  	; 15/10/2020
  6749 00002403 C685[806F]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  6750                                  				; Invalid/Defective partition flag 
  6751                                  ipt_7:
  6752                                  	; 27/10/2020
  6753 00002408 B8FE03                  	mov	ax, 1022 ; CHS cylinder number limit
  6754 0000240B 3985[836F]              	cmp	[part_table_start_cyl+di], ax
  6755 0000240F 7707                    	ja	short ipt_19 ; = 1023
  6756 00002411 40                      	inc	ax ; 1023
  6757 00002412 3985[886F]              	cmp	[part_table_end_cyl+di], ax
  6758 00002416 7203                    	jb	short ipt_14  ; < 1023
  6759                                  ipt_19:
  6760                                  	; 27/10/2020
  6761                                  	; set cylinder number if the partition's start or end sector is
  6762                                  	; at the beyond of chs limit 
  6763                                  	; ax = 1022 -> set start cylinder
  6764                                  	; ax = 1023 -> set end cylinder
  6765 00002418 E82100                  	call	cylindernumberfix
  6766                                  ipt_14:
  6767 0000241B 83C610                  	add	si, 16
  6768 0000241E E201                    	loop	ipt_5
  6769                                  	
  6770                                  	; OK!
  6771                                  
  6772                                  	;clc
  6773 00002420 C3                      	retn
  6774                                  
  6775                                  ipt_5:
  6776 00002421 83C712                  	add	di, 18
  6777 00002424 E9E1FE                  	jmp	ipt_0
  6778                                  
  6779                                  ipt_8:
  6780                                  	; Empty partition table check (all of 16 bytes must be 0)
  6781 00002427 51                      	push	cx
  6782 00002428 56                      	push	si ; 16/10/2020
  6783 00002429 B108                    	mov	cl, 8
  6784                                  ipt_9:
  6785 0000242B AD                      	lodsw
  6786 0000242C 09C0                    	or	ax, ax
  6787 0000242E 7507                    	jnz	short ipt_10
  6788 00002430 E2F9                    	loop	ipt_9
  6789 00002432 59                      	pop	cx ; 16/10/2020  ; (discard si)
  6790 00002433 59                      	pop	cx
  6791 00002434 E2EB                    	loop	ipt_5
  6792                                  	
  6793                                  	;clc
  6794 00002436 C3                      	retn
  6795                                  ipt_10:
  6796                                  	;pop	cx
  6797                                  	; invalid
  6798                                  	;stc
  6799                                  	; 27/10/2020
  6800                                  	; 15/10/2020
  6801                                  	;mov	byte [part_table_boot_ind+di], 0FFh
  6802                                  				; Invalid/Defective partition flag 
  6803                                  	;retn
  6804                                  	; 16/10/2020
  6805                                  	; 31/10/2020
  6806                                  	;mov	byte [part_table_sys_id+di], 0	; Empty partition
  6807 00002437 5E                      	pop	si
  6808 00002438 59                      	pop	cx
  6809 00002439 E939FF                  	jmp	ipt_16
  6810                                  
  6811                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6812                                  ; set cylinder number to partition's start or end sector 
  6813                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6814                                  ; 27/10/2020
  6815                                  
  6816                                  cylindernumberfix:
  6817                                  	; ax = 1022 -> set start cylinder
  6818                                  	; ax = 1023 -> set end cylinder
  6819                                  	; di = partition table structure offset
  6820                                  
  6821                                  	; modified registers: ax, dx, bx
  6822                                  	
  6823 0000243C 3DFF03                  	cmp	ax, 1023
  6824 0000243F 7343                    	jnb	short cnf_4 ; set end cylinder
  6825                                  	
  6826 00002441 80BD[816F]FE            	cmp	byte [part_table_start_head+di], 0FEh ; 254
  6827 00002446 753C                    	jne	short cnf_4 ; no need to fix (start cyl) 
  6828                                  			; 30/10/2020
  6829                                  	; 28/10/2020
  6830 00002448 80BD[826F]3F            	cmp	byte [part_table_start_sector+di], 3Fh ; 63
  6831 0000244D 7535                    	jne	short cnf_4 ; no need to fix (start cyl)
  6832                                  			; 30/10/2020
  6833                                  
  6834 0000244F 8B85[8A6F]              	mov	ax, [part_table_rel_sec_lw+di] ; start sector, lw
  6835 00002453 8B95[8C6F]              	mov	dx, [part_table_rel_sec_hw+di] ; start sector, hw
  6836 00002457 51                      	push	cx
  6837 00002458 8B0E[006D]              	mov	cx, [hs] ; [heads*spt]
  6838 0000245C E81EE8                  	call	div32
  6839                                  		; dx:ax = cylinder number, dx = 0, quotient
  6840                                  		; bx = remainder
  6841 0000245F 59                      	pop	cx
  6842 00002460 09D2                    	or 	dx, dx
  6843 00002462 751A                    	jnz	short cnf_2 ; invalid
  6844 00002464 3B85[836F]              	cmp	ax, [part_table_start_cyl+di]
  6845                                  	;je	short cnf_5
  6846 00002468 7406                    	je	short cnf_1
  6847 0000246A 7212                    	jb	short cnf_2 ; invalid
  6848 0000246C 8985[836F]              	mov	[part_table_start_cyl+di], ax ; change it
  6849                                  	;jmp	short cnf_5 
  6850                                  cnf_1:
  6851 00002470 80BD[866F]FE            	cmp	byte [part_table_end_head+di], 0FEh ; 254
  6852 00002475 7507                    	jne	short cnf_2 ; no need to fix (also invalid)
  6853                                  	
  6854                                  	; 28/10/2020
  6855 00002477 80BD[876F]3F            	cmp	byte [part_table_end_sector+di], 3Fh ; 63
  6856 0000247C 7414                    	je	short cnf_5 ; fix
  6857                                  	; no need to fix (also invalid)
  6858                                  cnf_2:
  6859 0000247E C685[806F]FF            	mov	byte [part_table_boot_ind+di], 0FFh ; invalid PTE
  6860                                  cnf_3:
  6861 00002483 C3                      	retn
  6862                                  cnf_4:
  6863 00002484 80BD[866F]FE            	cmp	byte [part_table_end_head+di], 0FEh ; 254
  6864 00002489 75F8                    	jne	short cnf_3 ; no need to fix (end cyl)
  6865                                  	
  6866                                  	; 28/10/2020
  6867 0000248B 80BD[876F]3F            	cmp	byte [part_table_end_sector+di], 3Fh ; 63
  6868 00002490 75F1                    	jne	short cnf_3 ; no need to fix (end cyl)
  6869                                  cnf_5:
  6870 00002492 8B85[8A6F]              	mov	ax, [part_table_rel_sec_lw+di] ; start sector, lw
  6871 00002496 8B95[8C6F]              	mov	dx, [part_table_rel_sec_hw+di] ; start sector, hw
  6872                                  
  6873 0000249A 0385[8E6F]              	add	ax, [part_table_num_sec_lw+di] ; number of sectors, lw 
  6874 0000249E 1395[906F]              	adc	dx, [part_table_num_sec_hw+di] ; number of sectors, hw 
  6875                                  	;jc	short cnf_2
  6876                                  
  6877 000024A2 83E801                  	sub	ax, 1
  6878 000024A5 83DA00                  	sbb	dx, 0	
  6879                                  		; dx:ax = end sector
  6880 000024A8 51                      	push	cx
  6881 000024A9 8B0E[006D]              	mov	cx, [hs] ; [heads*spt]
  6882 000024AD E8CDE7                  	call	div32
  6883                                  		; dx:ax = cylinder number, dx = 0, quotient
  6884                                  		; bx = remainder
  6885 000024B0 59                      	pop	cx
  6886 000024B1 09D2                    	or 	dx, dx
  6887 000024B3 75C9                    	jnz	short cnf_2 ; invalid
  6888 000024B5 3B85[886F]              	cmp	ax, [part_table_end_cyl+di]
  6889 000024B9 74C8                    	je	short cnf_3 ; same cylinder number
  6890 000024BB 72C1                    	jb	short cnf_2 ; invalid
  6891 000024BD 8985[886F]              	mov	[part_table_end_cyl+di], ax ; change it
  6892 000024C1 C3                      	retn
  6893                                  
  6894                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6895                                  ; sort partition table in (ending) cylinder number order
  6896                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6897                                  ; 25/10/2020 (fdisk3.s)
  6898                                  
  6899                                  	; 02/02/2019 (hdimage.s)
  6900                                  	
  6901                                  sort_partition_table:
  6902                                  
  6903                                  	; INPUT -> none
  6904                                  	; OUTPUT -> none
  6905                                  
  6906 000024C2 31DB                    	xor	bx, bx
  6907                                  	;jmp	short sortpt_2 ; 25/10/2020
  6908                                  sortpt_1:
  6909 000024C4 889F[106D]              	mov	[bx+sort], bl ; 0
  6910 000024C8 FEC3                    	inc	bl
  6911                                  sortpt_2:
  6912 000024CA 80FB04                  	cmp	bl, 4 ; number of partition table entries to sort
  6913 000024CD 72F5                    	jb	short sortpt_1
  6914                                  
  6915                                  	; Do a bubble sort
  6916                                  
  6917 000024CF EB04                    	jmp	short sortpt_4
  6918                                  sortpt_3:
  6919                                  	; Sort until we don't do a swap
  6920                                  
  6921 000024D1 08C9                    	or	cl, cl ; sort changed ?
  6922 000024D3 7450                    	jz	short sortpt_8 ; no
  6923                                  sortpt_4:
  6924 000024D5 30C9                    	xor	cl, cl
  6925                                  
  6926 000024D7 B301                    	mov	bl, 1
  6927                                  
  6928 000024D9 B212                    	mov	dl, 18  ; partition table structure size
  6929 000024DB EB07                    	jmp	short sortpt_6
  6930                                  sortpt_5:
  6931 000024DD FEC3                    	inc	bl
  6932                                  
  6933 000024DF 80FB04                  	cmp	bl, 4
  6934 000024E2 73ED                    	jnb	short sortpt_3
  6935                                  
  6936                                  sortpt_6:
  6937 000024E4 8A87[106D]              	mov	al, [bx+sort]
  6938                                  
  6939 000024E8 F6E2                    	mul	dl
  6940                                  
  6941 000024EA 89C6                    	mov	si, ax
  6942                                  
  6943 000024EC 8BBC[886F]              	mov	di, [part_table_end_cyl+si]
  6944                                  
  6945 000024F0 8A87[0F6D]              	mov	al, [bx+sort-1]
  6946                                  
  6947 000024F4 F6E2                    	mul	dl ; * 18
  6948                                  
  6949 000024F6 97                      	xchg	di, ax
  6950                                  
  6951 000024F7 3985[886F]              	cmp	[part_table_end_cyl+di], ax ; previous > current
  6952 000024FB 771A                    	ja	short sortpt_7 ; swap order indicators
  6953                                  		; 31/10/2020
  6954                                  		; current end cyl >= previous end cyl
  6955                                  	; 31/10/2020
  6956 000024FD 72DE                    	jb	short sortpt_5  
  6957                                  		; current end cyl > previous end cyl
  6958                                  	
  6959 000024FF 21C0                    	and	ax, ax ; cylinder 0 ?
  6960 00002501 75DA                    	jnz	short sortpt_5 ; no
  6961                                  		; current end cyl = previous end cyl, cyl > 0
  6962                                  	
  6963                                  	; current end cyl = previous end cyl = 0
  6964                                  
  6965                                  	; If current entry is empty partition entry
  6966                                  	; and previous entry is not empty partition entry
  6967                                  	; swap them.
  6968                                  	;
  6969 00002503 8B85[906F]              	mov	ax, [part_table_num_sec_hw+di] ; previous entry
  6970 00002507 0B85[8E6F]              	or	ax, [part_table_num_sec_lw+di]
  6971 0000250B 74D0                    	jz	short sortpt_5
  6972                                  
  6973 0000250D 8B84[906F]              	mov	ax, [part_table_num_sec_hw+si] ; current entry
  6974 00002511 0B84[8E6F]              	or	ax, [part_table_num_sec_lw+si]
  6975 00002515 75C6                    	jnz	short sortpt_5
  6976                                  sortpt_7:
  6977                                  	; Swap the order indicators
  6978                                  
  6979 00002517 8B87[0F6D]              	mov	ax, [bx+sort-1]
  6980 0000251B 86E0                    	xchg	ah, al
  6981 0000251D 8987[0F6D]              	mov	[bx+sort-1], ax
  6982                                  
  6983 00002521 B101                    	mov	cl, 1 ; sort changed
  6984 00002523 EBB8                    	jmp	short sortpt_5
  6985                                  
  6986                                  sortpt_8:
  6987                                  	; 30/10/2020
  6988                                  	;mov 	byte [p_sorted], 1 ; 04/02/2019
  6989                                  
  6990 00002525 C3                      	retn
  6991                                  
  6992                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6993                                  ; find free space before/after/between partitions
  6994                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6995                                  ; 03/02/2019
  6996                                  
  6997                                  find_part_free_space:  ; find/calculate free space for partitions
  6998                                  	; 15/02/2019
  6999                                  
  7000                                  	; INPUT -> 
  7001                                  	;	AL = 0 -> calculate for primary/MBR partitions 
  7002                                  	;	AL = 5 -> calculate for extended partition
  7003                                  	; OUTPUT ->
  7004                                  	;	CX = the largest free space/cylinders (between partitions)
  7005                                  	;	AX = Free space index (gap number) - from 0 to 4 -
  7006                                  	;	BX = Free space structure offset (for the largest free space)
  7007                                  	;
  7008                                  	;	22/02/2019
  7009                                  	;	[freespace_count] = number of free spaces/gaps
  7010                                  
  7011 00002526 A2[2B6F]                	mov	[p_type], al
  7012                                  
  7013                                  	; Sort the partition table
  7014                                  
  7015 00002529 E896FF                  	call	sort_partition_table ; 16/02/2019
  7016                                  
  7017                                  	; Initialize free space to zero
  7018                                  
  7019                                  	; 15/02/2019
  7020 0000252C BF[1470]                	mov	di, fspc ; free_space.space
  7021 0000252F B92800                  	mov	cx, 5*8 ; (5*16/2)
  7022 00002532 31C0                    	xor	ax, ax ; 0
  7023 00002534 F3AB                    	rep	stosw
  7024                                  
  7025 00002536 A2[286F]                	mov	[freespace_count], al ; 0
  7026                                  	; 22/02/2019
  7027                                  	;mov	[last_found_partition], al ; 0
  7028                                  
  7029 00002539 A3[266F]                	mov	[_i_], ax ; 0
  7030                                  	;jmp	short fpfs_2
  7031                                  	; 31/10/020
  7032 0000253C EB0E                    	jmp	short fpfs_3
  7033                                  fpfs_1:	
  7034 0000253E FE06[266F]              	inc	byte [_i_]
  7035                                  ;;fpfs_2:
  7036 00002542 803E[266F]04            	cmp	byte [_i_], 4
  7037 00002547 7203                    	jb	short fpfs_3
  7038 00002549 E97601                  	jmp	fpfs_13
  7039                                  fpfs_3:
  7040                                  	; Find space between start of disk and first partition
  7041                                  
  7042                                  	;mov	ax, [_i_]
  7043 0000254C 8B1E[266F]              	mov	bx, [_i_] ; 31/10/2020
  7044                                  fpfs_2:
  7045                                  	;mov	bx, ax ; 31/10/2020
  7046                                  	;mov	al, [sort+bx]
  7047 00002550 8A8F[106D]              	mov	cl, [sort+bx] ; 15/02/2019
  7048                                  
  7049                                  	;mov	cl, 18 ; partition table structure size = 18 bytes
  7050 00002554 B012                    	mov	al, 18 ; 15/02/2019
  7051 00002556 F6E1                    	mul	cl
  7052 00002558 89C3                    	mov	bx, ax
  7053                                  
  7054 0000255A 80BF[856F]00            	cmp	byte [part_table_sys_id+bx], 0
  7055 0000255F 74DD                    	je	short fpfs_1
  7056                                  
  7057 00002561 880E[2A6F]              	mov	[last_found_partition], cl ; 15/02/2019
  7058                                  
  7059                                  	;xor	cx, cx
  7060 00002565 30C9                    	xor	cl, cl ; 0 	
  7061                                  	;mov	al, 1 ; LBA = 1 (after MBR) ; ah = 0
  7062                                  	; 03/11/2020
  7063 00002567 A0[6A3F]                	mov	al, [sectors] ; 63 or 17 ; 03/11/2020
  7064                                  
  7065 0000256A 803E[2B6F]05            	cmp	byte [p_type], 5  ; EXTENDED
  7066 0000256F 7506                    	jne	short fpfs_4
  7067                                  
  7068                                  	; This is a special case - the extended partition can not start
  7069                                  	; on cylinder 0 due to its architecture. Protect against that here
  7070                                  
  7071                                  	; 13/02/2019
  7072                                  	; LBA value of free space start
  7073                                  	;mov	al, [sectors] ; 03/11/2020
  7074 00002571 F626[6C3F]              	mul	byte [heads]
  7075                                  		; ax = start sector (for Extended Partition)
  7076 00002575 FEC1                    	inc	cl ; 1  ; cx = start cylinder = 1
  7077                                  fpfs_4:
  7078                                  	; Found a partition, get the space
  7079                                  
  7080                                  	; 15/02/2019
  7081 00002577 8B97[836F]              	mov	dx, [part_table_start_cyl+bx] 
  7082                                  		       ; Start cylinder of the 1st partition (as sorted)
  7083 0000257B 39CA                    	cmp	dx, cx ; (cx=0 for primary partition, cx=1 for extd partition)
  7084 0000257D 0F86C300                	jna	fpfs_9 ; It is accepted as free (partition) space
  7085                                  		       ; if this space between masterboot sector and partition 1
  7086                                  		       ; has 1 cylinder (heads*spt) size at least.
  7087                                  	; 22/02/2019
  7088 00002581 31FF                    	xor	di, di  ; 0 ; Reset Free Space Table offset
  7089                                  
  7090 00002583 FE06[286F]              	inc	byte [freespace_count]	; mov byte [freespace_count], 1
  7091                                  
  7092 00002587 890E[1670]              	mov	[free_space.start], cx ; 0 (for PP) or 1 (for EP)
  7093                                  	
  7094                                  	; non-aligned address of start sector (for the 1st partition as sorted)
  7095                                  	; NOTE: later, start sector will be moved to (chs) head 1 and sector 1
  7096                                  	;	if new partition will be selected as a primary dos partition.
  7097                                  	;	(But, start sector -LBA- will not be changed 
  7098                                  	;	 if it is a non-dos or user input type partition.. unless
  7099                                  	;	 cylinder boundary alignment option is used.)
  7100                                  	 	
  7101 0000258B A3[2070]                	mov	[free_space.startsector], ax ; = [sectors]*[heads] (for EP)
  7102                                  					     ; or 1 (for PP)
  7103                                  	;mov	[free_space.startsector+2], 0
  7104                                  
  7105                                  	; free space ends before start of next valid partition
  7106 0000258E 89D0                    	mov	ax, dx	; start cylinder of partition 1 (as sorted)
  7107 00002590 29CA                    	sub	dx, cx	; cylinder count of free space 1 (gap 1)
  7108 00002592 48                      	dec	ax	; end cylinder of free space 1 (gap 1)
  7109 00002593 A3[1870]                	mov	[free_space.end], ax 
  7110 00002596 8916[1470]              	mov	[free_space.space], dx
  7111                                  
  7112                                  	; save free space (1) as (non-aligned) sector count
  7113 0000259A 8B87[8A6F]              	mov	ax, [part_table_rel_sec_lw+bx]
  7114 0000259E 8B97[8C6F]              	mov	dx, [part_table_rel_sec_hw+bx]
  7115 000025A2 2B06[2070]              	sub	ax, [free_space.startsector]
  7116 000025A6 83DA00                  	sbb	dx, 0
  7117 000025A9 A3[1C70]                	mov	[free_space.sectors_unused], ax
  7118 000025AC 8916[1E70]              	mov	[free_space.sectors_unused+2], dx
  7119                                  
  7120                                  	;mov	ax, [free_space.space]
  7121                                  
  7122                                  	;call	cylinders_to_sectors
  7123                                  
  7124                                  	;mov	[free_space.sectors_unused], ax
  7125                                  	;mov	[free_space.sectors_unused+2], dx
  7126                                  
  7127 000025B0 8B0E[6E3F]              	mov	cx, [cylinders]		; Total (disk) cylinders -divisor-
  7128 000025B4 8B1E[1470]              	mov	bx, [free_space.space]	; Partition cylinders -dividend-
  7129                                  
  7130 000025B8 E8F801                  	call	cylinders_to_percent
  7131                                  
  7132 000025BB A3[1A70]                	mov	[free_space.percent_unused], ax
  7133                                  
  7134                                  	; 15/02/2019
  7135                                  	;mov	bl, [_i_]
  7136                                  	;xor	bh, bh
  7137                                  	;mov	al, [sort+bx]
  7138                                  
  7139                                  	;mov	[last_found_partition], al
  7140                                  
  7141                                  	; 31/10/2020
  7142 000025BE E98300                  	jmp	fpfs_9
  7143                                  
  7144                                  	; Look for space between the rest of the partitions
  7145                                  
  7146                                  fpfs_7:
  7147                                  	; ah = 0
  7148                                  	;mov	al, [_i_]
  7149                                  	;;cbw
  7150                                  	;mov	bx, ax
  7151                                  	; 22/02/2019
  7152 000025C1 8B1E[266F]              	mov	bx, [_i_]
  7153                                  
  7154                                  	; 15/02/2019
  7155                                  	;mov	al, [sort+bx]
  7156 000025C5 8A8F[106D]              	mov	cl, [sort+bx]
  7157                                  	;mov	bl, 18
  7158                                  	;mul	bl
  7159 000025C9 B012                    	mov	al, 18
  7160 000025CB F6E1                    	mul	cl
  7161 000025CD 89C6                    	mov	si, ax
  7162                                  	
  7163 000025CF 80BC[856F]00            	cmp	byte [part_table_sys_id+si], 0
  7164 000025D4 746E                    	je	short fpfs_9
  7165                                  
  7166                                  	; 15/02/2019
  7167 000025D6 860E[2A6F]              	xchg	[last_found_partition], cl
  7168                                  
  7169                                  	; Check to see if more than one partition on a cylinder
  7170                                  	; If so, leave the space at zero */
  7171                                  
  7172                                  	; NOTE:
  7173                                  	; It is accepted as valid free (partition) space
  7174                                  	; if free space (gap) between partitions
  7175                                  	; has 1 cylinder (heads*spt) size at least.
  7176                                  
  7177 000025DA B012                    	mov	al, 18 ; Partition tables/data structure size = 18 bytes
  7178 000025DC F6E1                    	mul	cl
  7179 000025DE 89C3                    	mov	bx, ax  ; ah = 0
  7180                                  
  7181 000025E0 8B97[886F]              	mov	dx, [part_table_end_cyl+bx]   ; end cyl. of previous partition 
  7182 000025E4 8B84[836F]              	mov	ax, [part_table_start_cyl+si] ; start cyl. of current partition
  7183                                  
  7184 000025E8 42                      	inc	dx  ; start cylinder of free space is after the end cylinder of
  7185                                  		    ; the previous partition (as sorted)
  7186                                  
  7187 000025E9 39D0                    	cmp	ax, dx ; and it must be before than the next partition (as sorted)
  7188 000025EB 7657                    	jna	short fpfs_9 ; je short fpfs_9
  7189                                  		
  7190                                  	; No, things are normal
  7191                                  	; Get space between the end of the last one and the start of the next one
  7192                                  
  7193                                  	; 22/02/2019
  7194                                  	;add	di, 16
  7195 000025ED 8B3E[286F]              	mov	di, [freespace_count] 
  7196 000025F1 C1E704                  	shl	di, 4	; * 16 ; next entry offset (in free space table)
  7197                                  
  7198 000025F4 FE06[286F]              	inc	byte [freespace_count]
  7199                                  
  7200 000025F8 89C1                    	mov	cx, ax
  7201 000025FA 29D1                    	sub	cx, dx
  7202 000025FC 48                      	dec	ax
  7203 000025FD 8995[1670]              	mov	[free_space.start+di], dx
  7204 00002601 8985[1870]              	mov	[free_space.end+di], ax
  7205 00002605 898D[1470]              	mov	[free_space.space+di], cx
  7206                                  
  7207                                  	;mov	ax, [free_space.space+di]
  7208                                  	;call	cylinders_to_sectors
  7209                                  	;mov	[free_space.sectors_unused+di], ax
  7210                                  	;mov	[free_space.sectors_unused+2+di], dx
  7211                                  
  7212                                  	; calculate and save (non-aligned) free sector count between partitions
  7213                                  
  7214 00002609 8B87[8A6F]              	mov	ax, [part_table_rel_sec_lw+bx]
  7215 0000260D 8B97[8C6F]              	mov	dx, [part_table_rel_sec_hw+bx]
  7216 00002611 0387[8E6F]              	add	ax, [part_table_num_sec_lw+bx]
  7217 00002615 1397[906F]              	adc	dx, [part_table_num_sec_hw+bx]
  7218                                  
  7219 00002619 8B8C[8A6F]              	mov	cx, [part_table_rel_sec_lw+si]
  7220 0000261D 8B9C[8C6F]              	mov	bx, [part_table_rel_sec_hw+si]
  7221                                  
  7222 00002621 8985[2070]              	mov	[free_space.startsector+di], ax
  7223 00002625 8995[2270]              	mov	[free_space.startsector+2+di], dx
  7224                                  
  7225 00002629 29C1                    	sub	cx, ax
  7226 0000262B 19D3                    	sbb	bx, dx
  7227                                  
  7228 0000262D 898D[1C70]              	mov	[free_space.sectors_unused+di], cx
  7229 00002631 899D[1E70]              	mov	[free_space.sectors_unused+2+di], bx
  7230                                  
  7231                                  fpfs_8:
  7232                                  	; NOTE: Percentage is based on cylinder-boundary aligned partition size.
  7233                                  	; (total disk cylinders and partition's cylinder count are used for that)
  7234                                  
  7235 00002635 8B0E[6E3F]              	mov	cx, [cylinders] ; -divisor-
  7236 00002639 8B9D[1470]              	mov	bx, [free_space.space+di] ; -dividend-
  7237 0000263D E87301                  	call	cylinders_to_percent
  7238                                  	
  7239 00002640 8985[1A70]              	mov	[free_space.percent_unused+di], ax
  7240                                  	
  7241                                  	; ah = 0
  7242                                  
  7243                                  	; 15/02/2019
  7244                                  	;mov	bl, [_i_]
  7245                                  	;xor	bh, bh
  7246                                  	;mov	al, [sort+bx]
  7247                                  	;	
  7248                                  	;mov	[last_found_partition], al
  7249                                  
  7250                                  fpfs_9:
  7251 00002644 FE06[266F]              	inc	byte [_i_]
  7252                                  fpfs_10:
  7253 00002648 803E[266F]04            	cmp	byte [_i_], 4
  7254 0000264D 7303                    	jnb	short fpfs_11
  7255                                  
  7256 0000264F E96FFF                  	jmp	fpfs_7
  7257                                  
  7258                                  fpfs_11:
  7259                                  	; Find the space between the last partition and the end of the disk
  7260                                  	; Make sure that freespace cannot become negative
  7261                                  
  7262 00002652 A0[2A6F]                	mov	al, [last_found_partition]
  7263 00002655 B112                    	mov	cl, 18  ; Partition table structure size = 18 bytes
  7264 00002657 F6E1                    	mul	cl
  7265 00002659 89C3                    	mov	bx, ax
  7266 0000265B 8B0E[6E3F]              	mov	cx, [cylinders]
  7267 0000265F 49                      	dec	cx ; 15/02/2019
  7268                                  		   ; (min. cylinder count = 1 for a valid/usable free space)
  7269 00002660 8B87[886F]              	mov	ax, [part_table_end_cyl+bx]
  7270                                  	;cmp	[part_table_end_cyl+bx], cx
  7271 00002664 39C8                    	cmp	ax, cx	; cx = end cylinder of the disk
  7272 00002666 7203                    	jb	short fpfs_12
  7273 00002668 E9A400                  	jmp	fpfs_15
  7274                                  fpfs_12:
  7275                                  	; 22/02/2019
  7276 0000266B 8B3E[286F]              	mov	di, [freespace_count]
  7277 0000266F C1E704                  	shl	di, 4 ; * 16  ; next entry offset (in free space table)
  7278                                  
  7279 00002672 FE06[286F]              	inc	byte [freespace_count]
  7280                                  
  7281 00002676 898D[1870]              	mov	[free_space.end+di], cx	; end cyl. of free space 5 (gap 5)
  7282                                  	;mov	ax, [part_table_end_cyl+bx]
  7283                                  	
  7284                                  	;mov	dx, cx
  7285                                  	;sub	dx, ax
  7286                                  	;mov	[free_space.space+di], dx ; di = 4*16
  7287                                  	; 12/03/2021
  7288                                  	; ax = end cylinder of the last partition
  7289                                  	; cx = end cylinder of the disk
  7290 0000267A 29C1                    	sub	cx, ax
  7291 0000267C 898D[1470]              	mov	[free_space.space+di], cx ; di = 4*16
  7292                                  
  7293 00002680 40                      	inc	ax
  7294 00002681 8985[1670]              	mov	[free_space.start+di], ax
  7295                                  	
  7296                                  	;inc	cx ; [cylinders]
  7297                                  	;mov	ax, [free_space.space+si]
  7298                                  	;call	cylinders_to_sectors
  7299                                  	;mov	[free_space.sectors_unused+di], ax
  7300                                  	;mov	[free_space.sectors_unused+2+di], dx
  7301                                  
  7302                                  	; calculate and save (non-aligned) free sector count
  7303                                  
  7304                                  	; 22/02/2019
  7305 00002685 8B87[8A6F]              	mov	ax, [part_table_rel_sec_lw+bx]
  7306 00002689 8B97[8C6F]              	mov	dx, [part_table_rel_sec_hw+bx]
  7307 0000268D 0387[8E6F]              	add	ax, [part_table_num_sec_lw+bx]
  7308 00002691 1397[906F]              	adc	dx, [part_table_num_sec_hw+bx]
  7309                                  
  7310 00002695 8985[2070]              	mov	[free_space.startsector+di], ax
  7311 00002699 8995[2270]              	mov	[free_space.startsector+2+di], dx
  7312                                  
  7313 0000269D 8B0E[4268]              	mov	cx, [total_sectors]
  7314 000026A1 8B1E[4468]              	mov	bx, [total_sectors+2]
  7315 000026A5 29C1                    	sub	cx, ax
  7316 000026A7 19D3                    	sbb	bx, dx
  7317 000026A9 898D[1C70]              	mov	[free_space.sectors_unused+di], cx
  7318 000026AD 899D[1E70]              	mov	[free_space.sectors_unused+2+di], bx
  7319                                  
  7320 000026B1 8B0E[6E3F]              	mov	cx, [cylinders]
  7321 000026B5 8B9D[1470]              	mov	bx, [free_space.space+di]
  7322 000026B9 E8F700                  	call	cylinders_to_percent
  7323 000026BC 8985[1A70]              	mov	[free_space.percent_unused+di], ax
  7324 000026C0 EB4D                    	jmp	short fpfs_15
  7325                                  
  7326                                  fpfs_13:
  7327                                  	; No partitions found, show entire space as free
  7328                                  
  7329                                  	; 22/02/2019
  7330 000026C2 FE06[286F]              	inc	byte [freespace_count]	; mov byte [freespace_count], 1
  7331                                  	
  7332                                  	; 15/02/2019
  7333                                  	;sub	ax, ax
  7334                                  	; ah = 0 ; 31/10/2020
  7335 000026C6 29D2                    	sub	dx, dx
  7336                                  
  7337                                  	;inc	al ; LBA = 1 (after MBR) ; ah = 0
  7338 000026C8 B001                    	mov	al, 1 ; 25/02/2019
  7339                                  
  7340                                  	;This is a special case - the extended partition can not start
  7341                                  	;on cylinder 0 due to its architecture. Protect against that here
  7342                                  
  7343 000026CA 803E[2B6F]05            	cmp	byte [p_type], 5 ; EXTENDED
  7344 000026CF 7509                    	jne	short fpfs_14
  7345                                  		
  7346 000026D1 FEC2                    	inc	dl
  7347                                  
  7348                                  	; 15/02/2019
  7349                                  	; LBA value of free space start
  7350 000026D3 A0[6A3F]                	mov	al, [sectors]
  7351 000026D6 F626[6C3F]              	mul	byte [heads]
  7352                                  		; ax = start sector (for Extended Partition)
  7353                                  fpfs_14:
  7354 000026DA 8916[1670]              	mov	[free_space.start], dx ; 0 or 1
  7355                                  
  7356                                  	; non-aligned address of start sector (for the 1st partition as sorted)
  7357                                  	; NOTE: later, start sector will be moved to (chs) head 1 and sector 1
  7358                                  	;	if new partition will be selected as a primary dos partition.
  7359                                  	 	
  7360 000026DE A3[2070]                	mov	[free_space.startsector], ax ; = [sectors]*[heads] (for EP)
  7361                                  					     ; or 1 (for PP)
  7362                                  	;mov	[free_space.startsector+2], 0
  7363                                  
  7364 000026E1 A1[6E3F]                	mov	ax, [cylinders] ; disk capacity
  7365 000026E4 89C1                    	mov	cx, ax
  7366 000026E6 48                      	dec	ax
  7367 000026E7 A3[1870]                	mov	[free_space.end], ax
  7368 000026EA 29D0                    	sub	ax, dx
  7369 000026EC 40                      	inc	ax
  7370 000026ED A3[1470]                	mov	[free_space.space], ax
  7371                                  
  7372 000026F0 A1[4268]                	mov	ax, [total_sectors]
  7373 000026F3 8B16[4468]              	mov	dx, [total_sectors+2]
  7374 000026F7 2B06[2070]              	sub	ax, [free_space.startsector]
  7375 000026FB 83DA00                  	sbb	dx, 0
  7376 000026FE A3[1C70]                	mov	[free_space.sectors_unused], ax
  7377 00002701 8916[1E70]              	mov	[free_space.sectors_unused+2], dx
  7378                                  
  7379                                  	;mov	cx, [cylinders] 
  7380 00002705 8B1E[1470]              	mov	bx, [free_space.space]
  7381 00002709 E8A700                  	call	cylinders_to_percent
  7382 0000270C A3[1A70]                	mov	[free_space.percent_unused], ax
  7383                                  
  7384                                  fpfs_15:
  7385                                  	; Find largest free space
  7386 0000270F 29C9                    	sub	cx, cx
  7387                                  	; 22/02/2019
  7388 00002711 29C0                    	sub	ax, ax
  7389 00002713 31DB                    	xor	bx, bx
  7390 00002715 8A16[286F]              	mov	dl, [freespace_count]
  7391 00002719 08D2                    	or	dl, dl
  7392 0000271B 7420                    	jz	short fpfs_19
  7393 0000271D 8816[266F]              	mov	[_i_], dl
  7394                                  fpfs_16:
  7395 00002721 8B97[1470]              	mov	dx, [free_space.space+bx]
  7396 00002725 39CA                    	cmp	dx, cx
  7397 00002727 7604                    	jbe	short fpfs_17
  7398                                  	; 22/02/2019
  7399 00002729 89D1                    	mov	cx, dx ; Largest free space
  7400 0000272B 89D8                    	mov	ax, bx
  7401                                  fpfs_17:
  7402 0000272D FE0E[266F]              	dec	byte [_i_]
  7403 00002731 7405                    	jz	short fpfs_18
  7404                                  
  7405 00002733 83C310                  	add	bx, 16 ; Free space structure size
  7406 00002736 EBE9                    	jmp	short fpfs_16
  7407                                  fpfs_18:
  7408                                  	; 22/02/2019
  7409 00002738 89C3                    	mov	bx, ax ; offset (from 0 to 64)
  7410 0000273A C0E804                  	shr	al, 4  ; index (from 0 to 4)
  7411                                  fpfs_19:
  7412 0000273D C3                      	retn
  7413                                  
  7414                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7415                                  ; find enough free space
  7416                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7417                                  
  7418                                  ;	; 15/02/2019
  7419                                  ;find_enough_free_space:
  7420                                  ;	; Find enough free space
  7421                                  ;	;
  7422                                  ;	; INPUT:
  7423                                  ;	;	AX = Requested space (in cylinders)
  7424                                  ;	;	22/02/2019
  7425                                  ;	;	[freespace_count] = number of free spaces/gaps
  7426                                  ;	; OUTPUT:
  7427                                  ;	;	AX = Available space
  7428                                  	;	DX = Requested space
  7429                                  ;	;	If CF = 0 -> AX >= DX
  7430                                  ;	;	If CF = 1 -> AX < DX
  7431                                  ;	;	CX = Index of available space in free space structure
  7432                                  ;	;	     (GAP number, 0 to 4) - if AX > 0 -
  7433                                  ;
  7434                                  ;	mov	dx, ax ; 22/02/2019
  7435                                  ;	sub	ax, ax
  7436                                  ;	xor	bx, bx
  7437                                  ;	; 22/02/2019
  7438                                  ;	mov	ch, [freespace_count]
  7439                                  ;	mov	[_i_], ax ; 0
  7440                                  ;	jmp	short fefs_1
  7441                                  ;fefs_0:
  7442                                  ;	;mov	al, 16
  7443                                  ;	;mul	byte [_i_]
  7444                                  ;	;mov	bx, ax
  7445                                  ;	mov	bl, [_i_]
  7446                                  ;	shl	bl, 4 ; * 16
  7447                                  ;fefs_1:
  7448                                  ;	mov	ax, [free_space.space+bx]
  7449                                  ;	and	ax, ax
  7450                                  ;	jz	short fefs_2 ; not a free space
  7451                                  ;	mov	cl, [_i_] 
  7452                                  ;	cmp	ax, dx
  7453                                  ;	jnb	short fefs_3 ; enough space
  7454                                  ;fefs_2:
  7455                                  ;	; 22/02/2019
  7456                                  ;	inc	byte [_i_]
  7457                                  ;	cmp	byte [_i_], ch	
  7458                                  ;	jb	short fefs_0
  7459                                  ;	sub	ch, ch
  7460                                  ;	stc
  7461                                  ;	retn
  7462                                  ;fefs_3:
  7463                                  ;	xor	ch, ch
  7464                                  ;	retn
  7465                                  
  7466                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7467                                  ; find enough free sectors
  7468                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7469                                  
  7470                                  	; 15/02/2019
  7471                                  find_enough_free_sectors:
  7472                                  	; Find (first) enough free space in sectors
  7473                                  	;
  7474                                  	; INPUT:
  7475                                  	;	DX:AX = Requested space (as non-aligned free sectors)
  7476                                  	;	22/02/2019
  7477                                  	;	[freespace_count] = number of free spaces/gaps
  7478                                  	; OUTPUT:
  7479                                  	;	DX:AX = Available space
  7480                                  	;	If CF = 0 -> DX:AX >= Request
  7481                                  	;	If CF = 1 -> DX:AX < Request
  7482                                  	;	CX = Index of available space in free space structure
  7483                                  	;	     (GAP number, 0 to 4) - if DX:AX > 0 -
  7484                                  
  7485 0000273E 31FF                    	xor	di, di
  7486 00002740 31F6                    	xor	si, si
  7487 00002742 31DB                    	xor	bx, bx
  7488                                  	; 22/02/2019
  7489 00002744 8A2E[286F]              	mov	ch, [freespace_count]
  7490 00002748 891E[266F]              	mov	[_i_], bx ; 0
  7491 0000274C EB07                    	jmp	short fefss_1
  7492                                  fefss_0:
  7493                                  	;mov	al, 16
  7494                                  	;mul	byte [_i_]
  7495                                  	;mov	bx, ax
  7496 0000274E 8B1E[266F]              	mov	bx, [_i_]
  7497 00002752 C0E304                  	shl	bl, 4 ; * 16
  7498                                  fefss_1:
  7499 00002755 81C3[1C70]              	add	bx, free_space.sectors_unused
  7500 00002759 3B5702                  	cmp	dx, [bx+2]
  7501 0000275C 7230                    	jb	short fefss_7
  7502 0000275E 7706                    	ja	short fefss_2
  7503 00002760 3B07                    	cmp	ax, [bx]
  7504 00002762 742F                    	je	short fefss_8
  7505 00002764 7228                    	jb	short fefss_7 ; 18/02/2019
  7506                                  fefss_2:
  7507                                  	; 30/10/2020
  7508                                  	;cmp	word [bx], 0
  7509                                  	;jne	short fefss_3
  7510                                  	;cmp	word [bx+2], 0
  7511                                  	;je	short fefss_6	
  7512                                  fefss_3:
  7513 00002766 3B7F02                  	cmp	di, [bx+2]
  7514 00002769 7711                    	ja	short fefss_6
  7515 0000276B 7405                    	je	short fefss_4
  7516 0000276D 8B7F02                  	mov	di, [bx+2]
  7517 00002770 EB04                    	jmp	short fefss_5
  7518                                  fefss_4:
  7519 00002772 3B37                    	cmp	si, [bx]
  7520 00002774 7306                    	jnb	short fefss_6
  7521                                  fefss_5:
  7522 00002776 8B37                    	mov	si, [bx]
  7523                                  	; 22/02/2019
  7524 00002778 8A0E[266F]              	mov	cl, [_i_]
  7525                                  fefss_6:
  7526 0000277C FE06[266F]              	inc	byte [_i_]
  7527 00002780 382E[266F]              	cmp	byte [_i_], ch ; [freespace_count]
  7528 00002784 72C8                    	jb	short fefss_0
  7529                                  	
  7530 00002786 89F0                    	mov	ax, si
  7531 00002788 89FA                    	mov	dx, di
  7532 0000278A 30ED                    	xor	ch, ch
  7533 0000278C F9                      	stc
  7534 0000278D C3                      	retn
  7535                                  fefss_7:
  7536 0000278E 8B07                    	mov	ax, [bx]
  7537 00002790 8B5702                  	mov	dx, [bx+2]
  7538                                  fefss_8:
  7539 00002793 8B0E[266F]              	mov	cx, [_i_]
  7540 00002797 C3                      	retn
  7541                                  
  7542                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7543                                  ; get first free partition table entry
  7544                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7545                                  
  7546                                  	; 16/02/2019
  7547                                  get_first_free_pte:
  7548                                  	; Find free partition table entry
  7549                                  	;
  7550                                  	; INPUT:
  7551                                  	;	none
  7552                                  	; OUTPUT:
  7553                                  	;	If CF = 0 -> CX = partition table entry number
  7554                                  	;	If CF = 1 -> there is not a free entry in partition table
  7555                                  
  7556 00002798 BE[A457]                	mov	si, MasterBootBuff+pTableOffset
  7557 0000279B 31C9                    	xor	cx, cx
  7558                                  gffp_1:
  7559 0000279D 8A4404                  	mov	al, [si+ptFileSystemID] ; 23/02/2019
  7560                                  
  7561 000027A0 20C0                    	and	al, al
  7562 000027A2 740E                    	jz	short gffp_3 ; empty
  7563                                  
  7564 000027A4 80F903                  	cmp	cl, 3
  7565 000027A7 7307                    	jnb	short gffp_2
  7566                                  
  7567 000027A9 FEC1                    	inc	cl
  7568 000027AB 83C610                  	add	si, 16 ; Partition table entry size
  7569 000027AE EBED                    	jmp	short gffp_1
  7570                                  gffp_2:
  7571                                  	; CL = 3
  7572 000027B0 F9                      	stc
  7573 000027B1 C3                      	retn
  7574                                  gffp_3:
  7575                                  	; CL = PTE number (0 to 3)
  7576 000027B2 C3                      	retn 	
  7577                                  
  7578                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7579                                  ; convert cylinder count to sectors
  7580                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7581                                  ; 03/02/2019
  7582                                  
  7583                                  	; 15/03/2021
  7584                                  ;cylinders_to_sectors:
  7585                                  	; INPUT:
  7586                                  	;	ax = Cylinders (Total or partition's cylinder count)
  7587                                  	; OUTPUT:
  7588                                  	;	dx:ax = Sectors
  7589                                  
  7590                                  	;;mov	dx, [heads]
  7591                                  	;;mul	dx
  7592                                  	;; 30/10/2020
  7593                                  	;mul	word [heads]	
  7594                                  	;; dx:ax = Number of tracks (cylinders*heads)
  7595                                  	;mov	cx, [sectors]
  7596                                  	;call	mul32
  7597                                  	;	; dx:ax = Number of sectors 
  7598                                  	;retn
  7599                                  		
  7600                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7601                                  ; convert cylinder count to percent of disk size (total cylinders)
  7602                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7603                                  ; 03/02/2019
  7604                                  
  7605                                  cylinders_to_percent:
  7606                                  
  7607                                  	; INPUT:
  7608                                  	;	bx = Number of cylinders (of partition) -dividend-
  7609                                  	;	cx = Total cylinders -divisor-
  7610                                  	; OUTPUT:
  7611                                  	;	ax = Percentage
  7612                                  
  7613                                  	;  if (cylinders_in == 0)
  7614                                  	;	 percentage_out = 0;
  7615                                  	;  else if (total_cylinders == 0)
  7616                                  	;           percentage_out = 0;
  7617                                  	;       else
  7618                                  
  7619 000027B3 09DB                    	or	bx, bx
  7620 000027B5 741B                    	jz	short ctpc_6 ; ax = 0 = percentage_out 
  7621                                  ctpc_1:
  7622 000027B7 09C9                    	or	cx, cx
  7623 000027B9 7417                    	jz	short ctpc_6
  7624                                  
  7625 000027BB B86400                  	mov	ax, 100
  7626 000027BE F7E3                    	mul	bx ; [cylinders_in]
  7627                                  
  7628                                  		; dx:ax = Dividend
  7629                                  
  7630 000027C0 E8BAE4                  	call	div32 ; 100*cylinders_in / total_cylinders
  7631                                  		; DX:AX = Quotient
  7632                                  		; BX = Remainder
  7633                                  
  7634                                  	; ax = percentage_out
  7635                                  
  7636                                  	; 12/03/2021
  7637 000027C3 D1E9                    	shr	cx, 1
  7638                                  
  7639 000027C5 39CB                    	cmp	bx, cx	; is remainder >= total_cylinders/2 ?
  7640 000027C7 7201                    	jb	short ctpc_5 ; No. 
  7641                                  ctpc_4:
  7642 000027C9 40                      	inc	ax
  7643                                  ctpc_5:
  7644 000027CA 83F864                  	cmp	ax, 100
  7645 000027CD 7603                    	jbe	short ctpc_6
  7646 000027CF B86400                  	mov	ax, 100
  7647                                  ctpc_6:
  7648 000027D2 C3                      	retn
  7649                                  
  7650                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7651                                  ; display partition table
  7652                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7653                                  ; 04/02/2019
  7654                                  
  7655                                  	; 12/03/2021
  7656                                  display_partition_table_x:
  7657 000027D3 B005                    	mov	al, 5 ; display extended partition table
  7658 000027D5 EB02                    	jmp	short dpt_x
  7659                                  
  7660                                  display_partition_table:
  7661                                  
  7662                                  	; INPUT:
  7663                                  	;	al = 0 for MBR
  7664                                  	;	   = 5 for EBR (logical drives in extended partition)
  7665                                  	; OUTPUT:
  7666                                  	;	none
  7667                                  
  7668                                  	; 12/03/2021
  7669 000027D7 30C0                    	xor	al, al ; display primary partition table
  7670                                  dpt_x:
  7671                                  ;pt_positions:
  7672                                  n_pos	equ 30 ; 1 byte	
  7673                                  
  7674 000027D9 A2[2C6F]                	mov	[_e_], al	
  7675                                  
  7676                                  	; clear screen
  7677 000027DC B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  7678 000027DF CD10                    	int	10h
  7679                                  
  7680 000027E1 803E[2C6F]05            	cmp	byte [_e_], 5
  7681 000027E6 7507                    	jne	short dpt_1
  7682                                  dpt_0:
  7683 000027E8 BD[CC6F]                	mov	bp, ext_table_boot_ind
  7684 000027EB B045                    	mov	al, 'E'
  7685 000027ED EB05                    	jmp	short dpt_4
  7686                                  dpt_1:
  7687 000027EF BD[806F]                	mov	bp, part_table_boot_ind
  7688 000027F2 B04D                    	mov	al, 'M'
  7689                                  dpt_4:
  7690 000027F4 BE[4058]                	mov	si, p_table_header
  7691 000027F7 88441E                  	mov	[si+n_pos], al
  7692 000027FA E881F3                         	call 	print_msg
  7693                                     
  7694 000027FD 31DB                    	xor	bx, bx
  7695 000027FF 891E[266F]              	mov	[_i_], bx
  7696                                  dpt_5:
  7697 00002803 FE06[266F]              	inc	byte [_i_]
  7698                                  
  7699                                  	; BX = partition entry (0 to 3)
  7700                                  	; BP = partition table structure address
  7701                                  
  7702 00002807 E86600                  	call	display_pt_entry  ; display partition table row
  7703                                  
  7704 0000280A 8B1E[266F]              	mov	bx, [_i_] 
  7705                                  	
  7706 0000280E 80FB04                  	cmp	bl, 4
  7707 00002811 72F0                    	jb	short dpt_5
  7708                                  
  7709 00002813 BE[8159]                	mov	si, p_table_footer
  7710 00002816 E865F3                         	call 	print_msg
  7711                                  
  7712                                  	; 27/02/2019
  7713 00002819 BF[9755]                	mov	di, str_disk_sectors
  7714                                  
  7715 0000281C 803E[2C6F]05            	cmp	byte [_e_], 5
  7716 00002821 741D                    	je	short dpt_9 
  7717                                  
  7718                                  	; display total disk sectors
  7719                                  
  7720                                  	;mov	di, str_disk_sectors
  7721                                  
  7722                                  	;cmp	byte [di], '0'
  7723                                  	;jnb	short dpt_8
  7724                                  
  7725 00002823 A1[4268]                        mov	ax, [total_sectors]
  7726 00002826 8B16[4468]                      mov	dx, [total_sectors+2]
  7727                                  
  7728 0000282A E82200                  	call	dpt_10
  7729                                  dpt_8:
  7730 0000282D BE[8155]                	mov	si, msg_disk_sectors
  7731                                  dpt_11:
  7732 00002830 E84BF3                  	call	print_msg
  7733                                  
  7734 00002833 BE[9755]                	mov	si, str_disk_sectors
  7735 00002836 E845F3                  	call	print_msg
  7736                                  
  7737 00002839 BE[6B55]                	mov	si, CRLF
  7738 0000283C E83FF3                  	call	print_msg
  7739                                  
  7740 0000283F C3                      	retn
  7741                                  
  7742                                  dpt_9:
  7743                                  	; display extended partition size
  7744                                  
  7745 00002840 A1[1E6F]                	mov	ax, [ep_Size]
  7746 00002843 8B16[206F]                      mov	dx, [ep_Size+2]
  7747                                  
  7748 00002847 E80500                  	call	dpt_10
  7749                                  
  7750 0000284A BE[A255]                	mov	si, msg_ep_size
  7751 0000284D EBE1                    	jmp	short dpt_11
  7752                                  
  7753                                  dpt_10:
  7754 0000284F 89E6                    	mov	si, sp
  7755 00002851 B90A00                  	mov	cx, 10
  7756                                  dpt_6:
  7757 00002854 E826E4                  	call	div32
  7758                                  	
  7759 00002857 80C330                  	add	bl, '0'
  7760 0000285A 53                      	push	bx
  7761 0000285B 21C0                    	and	ax, ax
  7762 0000285D 75F5                    	jnz	short dpt_6
  7763 0000285F 21D2                    	and	dx, dx
  7764 00002861 75F1                    	jnz	short dpt_6
  7765                                  
  7766 00002863 29E6                    	sub	si, sp
  7767 00002865 D1EE                    	shr	si, 1
  7768                                  dpt_7:
  7769 00002867 58                      	pop	ax
  7770 00002868 AA                      	stosb
  7771 00002869 4E                      	dec	si
  7772 0000286A 75FB                    	jnz	short dpt_7
  7773                                  
  7774 0000286C 30C0                    	xor	al, al
  7775 0000286E AA                      	stosb
  7776                                  
  7777                                  	; 27/02/2019
  7778 0000286F C3                      	retn
  7779                                  
  7780                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7781                                  ; display partition table entry/row
  7782                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7783                                  ; 04/02/2019
  7784                                  
  7785                                  struc ptbl
  7786                                  
  7787 00000000 ??                      .boot_ind:	resb 1
  7788 00000001 ??                      .start_head:	resb 1
  7789 00000002 ??                      .start_sector:	resb 1
  7790 00000003 ????                    .start_cyl:	resw 1
  7791 00000005 ??                      .sys_id:	resb 1
  7792 00000006 ??                      .end_head:	resb 1
  7793 00000007 ??                      .end_sector:	resb 1
  7794 00000008 ????                    .end_cyl:	resw 1
  7795 0000000A ????                    .rel_sec_lw:	resw 1
  7796 0000000C ????                    .rel_sec_hw:	resw 1
  7797 0000000E ????                    .num_sec_lw:	resw 1
  7798 00000010 ????                    .num_sec_hw:	resw 1
  7799                                  .size:
  7800                                  
  7801                                  endstruc
  7802                                  
  7803                                  display_pt_entry:
  7804                                  	; 24/10/2020 (fdisk3.s)
  7805                                  
  7806                                  	; INPUT:
  7807                                  	;	bl = partition entry
  7808                                  	;	bh = 0
  7809                                  	;	bp = partition table structure address
  7810                                  	; OUTPUT:
  7811                                  	;	none
  7812                                  
  7813                                  ; 24/10/2020 (fdisk3.s)
  7814                                  ;pt_positions:
  7815                                  p_pos	equ 3  ; 1 byte
  7816                                  s_pos	equ 6  ; 2+1 byte
  7817                                  bh_pos	equ 10 ; 2+1 bytes
  7818                                  bs_pos	equ 14 ; 2+1 bytes
  7819                                  bc_pos	equ 18 ; 2+1 bytes
  7820                                  fs_pos  equ 22 ; 2+1 bytes
  7821                                  eh_pos  equ 26 ; 2+1 bytes
  7822                                  es_pos	equ 30 ; 2+1 bytes
  7823                                  ec_pos	equ 34 ; 2+1 bytes
  7824                                  rs_pos	equ 42 ; 10 bytes
  7825                                  ns_pos	equ 53 ; 10 bytes
  7826                                  fsx_pos equ 64 ; 14 bytes
  7827                                  
  7828                                  ; 2019-2020 (hdimage.s)
  7829                                  ;;pt_positions:
  7830                                  ;p_pos	equ 7  ; 1 byte
  7831                                  ;s_pos	equ 9  ; 2+1 byte
  7832                                  ;bh_pos	equ 13 ; 2+1 bytes
  7833                                  ;bs_pos	equ 17 ; 2+1 bytes
  7834                                  ;bc_pos	equ 21 ; 2+1 bytes
  7835                                  ;fs_pos equ 25 ; 2+1 bytes
  7836                                  ;eh_pos equ 29 ; 2+1 bytes
  7837                                  ;es_pos	equ 33 ; 2+1 bytes
  7838                                  ;ec_pos	equ 37 ; 2+1 bytes
  7839                                  ;rs_pos	equ 42 ; 7 bytes
  7840                                  ;ns_pos	equ 52 ; 7 bytes
  7841                                  ;fsx_pos equ 61 ; 14 bytes
  7842                                  
  7843 00002870 55                      	push	 bp ; 23/02/2019
  7844                                  
  7845 00002871 08DB                    	or	bl, bl
  7846 00002873 7406                    	jz	short dpte_0
  7847                                  
  7848                                  	;xor	bh, bh
  7849 00002875 B012                    	mov	al, ptbl.size ; 18
  7850 00002877 F6E3                    	mul	bl
  7851 00002879 01C5                    	add	bp, ax
  7852                                  dpte_0:
  7853 0000287B 807E0500                	cmp	byte [bp+ptbl.sys_id], 0
  7854 0000287F 0F861801                	jna	dpte_9
  7855                                  
  7856 00002883 B768                    	mov	bh, 'h'
  7857                                  
  7858 00002885 BE[2E6F]                	mov	si, pte_row
  7859                                  
  7860                                  	; clear partition table display buffer/row
  7861 00002888 89F7                    	mov	di, si
  7862 0000288A B92800                  	mov	cx, 40
  7863 0000288D B82020                  	mov	ax, 2020h
  7864 00002890 F3AB                    	rep	stosw
  7865                                  
  7866 00002892 88D8                    	mov	al, bl
  7867 00002894 0431                    	add	al, '1'
  7868 00002896 884403                  	mov	[si+p_pos], al  ; partition number '1' to '4'
  7869                                  
  7870                                  	; partition status, type and CHS parameters
  7871                                  	; (as hexadecimal number)
  7872                                  
  7873                                  	;mov	al, [bp+ptbl.boot_ind]
  7874 00002899 8A4600                  	mov	al, [bp]
  7875 0000289C E8B5F3                  	call	byte_to_hex
  7876                                  
  7877 0000289F 894406                  	mov	[si+s_pos], ax
  7878 000028A2 887C08                  	mov	[si+s_pos+2], bh ; 'h'
  7879                                  
  7880 000028A5 8A4601                  	mov	al, [bp+ptbl.start_head]
  7881 000028A8 E8A9F3                  	call	byte_to_hex
  7882                                  
  7883 000028AB 89440A                  	mov	[si+bh_pos], ax
  7884 000028AE 887C0C                  	mov	[si+bh_pos+2], bh ; 'h'
  7885                                  
  7886 000028B1 8B4E03                  	mov	cx, [bp+ptbl.start_cyl]
  7887                                  	; 28/10/2020
  7888 000028B4 81F9FF03                	cmp	cx, 1023
  7889 000028B8 7603                    	jna	short dpte_10 ; cyl number is in CHS limit
  7890 000028BA B9FF03                  	mov	cx, 1023 ; fix cylinder number (to it's PTE value)
  7891                                  			 ; to correct display PTE (CHS bytes)
  7892                                  dpte_10:
  7893 000028BD C0E506                  	shl	ch, 6
  7894 000028C0 8A4602                  	mov	al, [bp+ptbl.start_sector]
  7895 000028C3 08E8                    	or	al, ch
  7896 000028C5 E88CF3                  	call	byte_to_hex
  7897                                  
  7898 000028C8 89440E                  	mov	[si+bs_pos], ax
  7899 000028CB 887C10                  	mov	[si+bs_pos+2], bh ; 'h'
  7900                                  
  7901                                  	;mov	al, [bp+ptbl.start_cyl]
  7902 000028CE 88C8                    	mov	al, cl
  7903 000028D0 E881F3                  	call	byte_to_hex
  7904                                  
  7905 000028D3 894412                  	mov	[si+bc_pos], ax
  7906 000028D6 887C14                  	mov	[si+bc_pos+2], bh ; 'h'
  7907                                  
  7908 000028D9 8A4605                  	mov	al, [bp+ptbl.sys_id]
  7909 000028DC E875F3                  	call	byte_to_hex
  7910                                  
  7911 000028DF 894416                  	mov	[si+fs_pos], ax
  7912 000028E2 887C18                  	mov	[si+fs_pos+2], bh ; 'h'
  7913                                  
  7914 000028E5 8A4606                  	mov	al, [bp+ptbl.end_head]
  7915 000028E8 E869F3                  	call	byte_to_hex
  7916                                  
  7917 000028EB 89441A                  	mov	[si+eh_pos], ax
  7918 000028EE 887C1C                  	mov	[si+eh_pos+2], bh ; 'h'
  7919                                  
  7920 000028F1 8B4E08                  	mov	cx, [bp+ptbl.end_cyl]
  7921                                  	; 28/10/2020
  7922 000028F4 81F9FF03                	cmp	cx, 1023
  7923 000028F8 7603                    	jna	short dpte_11 ; cyl number is in CHS limit
  7924 000028FA B9FF03                  	mov	cx, 1023 ; fix cylinder number (to it's PTE value)
  7925                                  			 ; to correct display PTE (CHS bytes)
  7926                                  dpte_11:
  7927 000028FD C0E506                  	shl	ch, 6
  7928 00002900 8A4607                  	mov	al, [bp+ptbl.end_sector]
  7929 00002903 08E8                    	or	al, ch
  7930 00002905 E84CF3                  	call	byte_to_hex
  7931                                  
  7932 00002908 89441E                  	mov	[si+es_pos], ax
  7933 0000290B 887C20                  	mov	[si+es_pos+2], bh ; 'h'
  7934                                  
  7935                                  	;mov	al, [bp+ptbl.end_cyl]
  7936 0000290E 88C8                    	mov	al, cl
  7937 00002910 E841F3                  	call	byte_to_hex
  7938                                  
  7939 00002913 894422                  	mov	[si+ec_pos], ax
  7940 00002916 887C24                  	mov	[si+ec_pos+2], bh ; 'h'
  7941                                  
  7942                                  	; relative (start) sector address (lba)
  7943                                  	; (as decimal number)
  7944                                  
  7945 00002919 8B460A                          mov	ax, [bp+ptbl.rel_sec_lw]
  7946 0000291C 8B560C                          mov	dx, [bp+ptbl.rel_sec_hw]
  7947                                  
  7948 0000291F 89E7                    	mov	di, sp
  7949 00002921 B90A00                  	mov	cx, 10
  7950                                  dpte_1:
  7951 00002924 E856E3                  	call	div32
  7952                                  	
  7953 00002927 80C330                  	add	bl, '0'
  7954 0000292A 53                      	push	bx
  7955 0000292B 21C0                    	and	ax, ax
  7956 0000292D 75F5                    	jnz	short dpte_1
  7957 0000292F 21D2                    	and	dx, dx
  7958 00002931 75F1                    	jnz	short dpte_1
  7959                                  
  7960 00002933 8D5C31                  	lea	bx, [si+rs_pos+7]
  7961                                  
  7962 00002936 29E7                    	sub	di, sp
  7963 00002938 D1EF                    	shr	di, 1
  7964 0000293A 29FB                    	sub	bx, di	
  7965                                  dpte_2:
  7966 0000293C 58                      	pop	ax
  7967 0000293D 8807                    	mov	[bx], al
  7968 0000293F 4F                      	dec	di
  7969 00002940 7403                    	jz	short dpte_3
  7970                                  	
  7971 00002942 43                      	inc	bx
  7972 00002943 EBF7                    	jmp	short dpte_2
  7973                                  
  7974                                  dpte_3:
  7975                                  	; number of sectors)
  7976                                  	; (as decimal number)
  7977                                  
  7978 00002945 8B460E                          mov	ax, [bp+ptbl.num_sec_lw]
  7979 00002948 8B5610                          mov	dx, [bp+ptbl.num_sec_hw]
  7980                                  
  7981 0000294B 89E7                    	mov	di, sp
  7982                                  	;mov	cx, 10
  7983                                  dpte_4:
  7984 0000294D E82DE3                  	call	div32
  7985                                  	
  7986 00002950 80C330                  	add	bl, '0'
  7987 00002953 53                      	push	bx
  7988 00002954 21C0                    	and	ax, ax
  7989 00002956 75F5                    	jnz	short dpte_4
  7990 00002958 21D2                    	and	dx, dx
  7991 0000295A 75F1                    	jnz	short dpte_4
  7992                                  
  7993 0000295C 8D5C3C                  	lea	bx, [si+ns_pos+7]
  7994                                  
  7995 0000295F 29E7                    	sub	di, sp
  7996 00002961 D1EF                    	shr	di, 1
  7997 00002963 29FB                    	sub	bx, di	
  7998                                  dpte_5:
  7999 00002965 58                      	pop	ax
  8000 00002966 8807                    	mov	[bx], al
  8001 00002968 4F                      	dec	di
  8002 00002969 7403                    	jz	short dpte_6
  8003                                  	
  8004 0000296B 43                      	inc	bx
  8005 0000296C EBF7                    	jmp	short dpte_5
  8006                                  dpte_6:
  8007                                  	; set file system name
  8008                                  
  8009 0000296E 8A4605                  	mov	al, [bp+ptbl.sys_id]
  8010 00002971 BF[8A40]                	mov	di, valid_partitions
  8011 00002974 B91300                  	mov	cx, 19
  8012 00002977 F2AE                    	repnz	scasb
  8013 00002979 7405                    	jz	short dpte_7
  8014 0000297B B8[7C40]                	mov	ax, FS_OTHERS
  8015 0000297E EB0C                    	jmp	short dpte_8
  8016                                  dpte_7:
  8017 00002980 81EF[8B40]              	sub	di, valid_partitions + 1
  8018 00002984 B80E00                  	mov	ax, 14
  8019 00002987 F7E7                    	mul	di
  8020 00002989 05[723F]                	add	ax, FileSys_Names
  8021                                  dpte_8:
  8022 0000298C 8D7C40                  	lea	di, [si+fsx_pos]
  8023 0000298F 89C6                    	mov	si, ax
  8024 00002991 B107                    	mov	cl, 7
  8025 00002993 F3A5                    	rep	movsw
  8026                                  
  8027 00002995 BE[2E6F]                	mov	si, pte_row
  8028 00002998 E8E3F1                  	call	print_msg
  8029                                  dpte_9:
  8030 0000299B 5D                      	pop	bp ; 23/02/2019
  8031                                  	
  8032 0000299C C3                      	retn
  8033                                  
  8034                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8035                                  ; fix partition table
  8036                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8037                                  ; 24/02/2019
  8038                                  
  8039                                  partition_table_fix:
  8040                                  	; DELETE or EXIT option for Invalid Partition Table Entry
  8041                                  	; INPUT: 
  8042                                  	;	DS:SI = PTE address in MBR buffer
  8043                                  	
  8044 0000299D 56                      	push	si  ; save PTE address
  8045                                  
  8046 0000299E 89F0                    	mov	ax, si
  8047 000029A0 2D[A457]                	sub	ax, MasterBootBuff+446
  8048 000029A3 C0E804                  	shr	al, 4 ; / 16 
  8049 000029A6 0431                    	add	al, '1'
  8050 000029A8 A2[A25E]                	mov	[inv_pte_num], al
  8051                                  
  8052                                  	; DS:SI = PTE address in MBR buffer
  8053 000029AB E85EF7                  	call	show_selected_partition
  8054                                  
  8055                                  	;mov	si, CRLF
  8056                                  	;call	print_msg
  8057                                  
  8058                                  	; Warning message...
  8059                                  
  8060 000029AE BE[7E5E]                	mov	si, msg_inv_pte
  8061 000029B1 E8CAF1                  	call	print_msg
  8062                                  
  8063 000029B4 5F                      	pop	di  ; restore PTE address
  8064                                  ptf_0:	
  8065 000029B5 30E4                    	xor	ah, ah
  8066 000029B7 CD16                    	int	16h
  8067                                  
  8068 000029B9 3C0D                    	cmp	al, 13
  8069 000029BB 7406                    	je	short ptf_1
  8070                                  
  8071 000029BD 3C1B                    	cmp	al, 27
  8072 000029BF 75F4                    	jne	short ptf_0
  8073                                  
  8074 000029C1 F9                      	stc
  8075 000029C2 C3                      	retn
  8076                                  ptf_1:
  8077                                  	; Clear that (invalid) PTE
  8078 000029C3 31C0                    	xor	ax, ax	
  8079 000029C5 B90800                  	mov	cx, 8
  8080 000029C8 F3AB                    	rep	stosw
  8081                                  
  8082                                  	; Clear screen
  8083 000029CA B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  8084 000029CD CD10                    	int	10h
  8085                                  
  8086 000029CF C3                      	retn
  8087                                  
  8088                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8089                                  ; display (& edit) EXTENDED (DOS) partition table
  8090                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8091                                  ; 28/02/2019
  8092                                  
  8093                                  display_extended_pt:
  8094                                  	;mov	al, 5 ; extended partition (logical drives)
  8095                                  	;call	display_partition_table
  8096                                  	; 12/03/2021
  8097 000029D0 E800FE                  	call	display_partition_table_x
  8098                                  
  8099 000029D3 BE[7660]                	mov	si, ebr_editing_options
  8100 000029D6 E8A5F1                  	call	print_msg
  8101                                  
  8102 000029D9 BE[2B5D]                	mov	si, enter_opt_num_cancel_msg
  8103 000029DC E89FF1                  	call	print_msg
  8104                                  
  8105 000029DF BE[6B55]                	mov	si, CRLF
  8106 000029E2 E899F1                  	call	print_msg
  8107                                  dept_1:
  8108 000029E5 30E4                    	xor	ah, ah
  8109 000029E7 CD16                    	int	16h
  8110                                  
  8111 000029E9 3C30                    	cmp	al, '0'
  8112 000029EB 740C                    	je	short dept_2
  8113                                  
  8114 000029ED 3C31                    	cmp	al, '1'
  8115 000029EF 7464                    	je	short edit_ext_table_create
  8116 000029F1 3C32                    	cmp	al, '2'
  8117 000029F3 7407                    	je	short edit_ext_table_delete
  8118                                  		
  8119 000029F5 3C1B                    	cmp	al, 27 ; ESCape
  8120 000029F7 75EC                    	jne	short dept_1
  8121                                  dept_2:
  8122 000029F9 E90BDA                  	jmp	A_42
  8123                                  
  8124                                  edit_ext_table_delete:
  8125                                  	; 28/02/2019
  8126                                  	;mov	al, 5 ; extended partition (logical drives)
  8127                                  	;call	display_partition_table
  8128                                  	; 12/03/2021
  8129 000029FC E8D4FD                  	call	display_partition_table_x
  8130                                  
  8131 000029FF BE[F560]                	mov	si, msg_delete_ldd_q
  8132 00002A02 E879F1                  	call	print_msg
  8133                                  
  8134                                  	;mov	si, CRLF
  8135                                  	;call	print_msg
  8136                                  eetd_1:
  8137 00002A05 30E4                    	xor	ah, ah
  8138 00002A07 CD16                    	int	16h
  8139                                  
  8140 00002A09 3C1B                    	cmp	al, 27
  8141 00002A0B 7410                    	je	short eetd_2
  8142                                  
  8143 00002A0D 24DF                    	and	al, 0DFh
  8144 00002A0F 3C59                    	cmp	al, 'Y'
  8145 00002A11 7412                    	je	short eetd_yes
  8146 00002A13 3C4E                    	cmp	al, 'N'
  8147 00002A15 75EE                    	jne	short eetd_1
  8148                                  eetd_no:
  8149 00002A17 BE[AB5C]                	mov	si, msg_NO ;  Write 'NO' (it may be shown for a moment)
  8150 00002A1A E861F1                  	call	print_msg
  8151                                  eetd_2:	
  8152 00002A1D BE[6B55]                	mov	si, CRLF  ; Next line
  8153 00002A20 E85BF1                  	call	print_msg
  8154 00002A23 EBAB                    	jmp	short display_extended_pt
  8155                                  eetd_yes:
  8156 00002A25 BE[A55C]                	mov	si, msg_YES ;  Write 'YES' (it may be shown for a moment)
  8157 00002A28 E853F1                  	call	print_msg
  8158 00002A2B BE[6B55]                	mov	si, CRLF  ; Next line
  8159 00002A2E E84DF1                  	call	print_msg
  8160 00002A31 E88806                  	call	delete_logical_drives
  8161 00002A34 803E[0E6D]00            	cmp	byte [ldrives], 0
  8162 00002A39 7795                    	ja	short display_extended_pt
  8163 00002A3B E9C9D9                  	jmp	A_42
  8164                                  
  8165                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8166                                  ; logical drive count limit error 
  8167                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8168                                  
  8169                                  eetc_2:
  8170 00002A3E BE[5B61]                	mov	si, msg_create_ldd_max_error
  8171                                  eetc_10:
  8172 00002A41 E83AF1                  	call	print_msg
  8173 00002A44 BE[C755]                	mov	si, msg_press_any_key
  8174 00002A47 E834F1                  	call	print_msg
  8175 00002A4A 30E4                    	xor	ah, ah
  8176 00002A4C CD16                    	int	16h
  8177 00002A4E EB80                    	jmp	display_extended_pt
  8178                                  
  8179                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8180                                  ; no free space in extended partition
  8181                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8182                                  	
  8183                                  	; 05/03/2019
  8184                                  eetc_9:
  8185 00002A50 BE[9463]                	mov	si, msg_c_ldd_nofspc_error
  8186 00002A53 EBEC                    	jmp	short eetc_10
  8187                                  
  8188                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8189                                  ; create logical dos drive in EXTENDED (DOS) partition
  8190                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8191                                  ; 19/10/2020 (fdisk3.s) 
  8192                                  
  8193                                  edit_ext_table_create:	; 01/03/2019 (hdimage.s)
  8194                                  
  8195                                  ; Create Method: ; 04/03/2019
  8196                                  ;LDD 1 <- LDD_START0, ebr 1st entry <- MBR (extended partition) - EBR 0
  8197                                  ;LDD 2 <- LDD_START1, ebr 2nd entry <- EBR 1
  8198                                  ;LDD 3 <- LDD_START2, ebr 2nd entry <- EBR 2
  8199                                  ;LDD 4 <- LDD_START3, ebr 2nd entry <- EBR 3
  8200                                  
  8201                                  	; 01/03/2019
  8202 00002A55 803E[CB6F]00            	cmp	byte [epnumber], 0 ; check extended partition
  8203 00002A5A 0F86CCE2                	jna	B_07		; cancel with error message
  8204                                  
  8205                                  	; 05/03/2019
  8206 00002A5E E8EE02                  	call	check_ext_free_space
  8207 00002A61 72ED                    	jc	eetc_9	; error, no free space in extented partition
  8208                                  
  8209                                  	; 30/10/2020
  8210 00002A63 A3[8A70]                	mov	[ep_free_sectors], ax
  8211 00002A66 8916[8C70]              	mov	[ep_free_sectors+2], dx
  8212                                  
  8213 00002A6A 803E[0E6D]04            	cmp	byte [ldrives], 4
  8214 00002A6F 73CD                    	jnb	eetc_2	; error, write program limit message
  8215                                  
  8216                                  edit_ext_table_create_x: ; 02/03/2019
  8217                                  
  8218                                  	; Get logical drive size/cylinders (request) from user
  8219 00002A71 E87303                  	call	get_ldd_size
  8220 00002A74 833E[9070]01            	cmp	word [lcylinders], 1  ; at least 1 cylinder
  8221 00002A79 0F8253FF                	jb	display_extended_pt ; cancel
  8222                                  
  8223                                  	; 03/03/2019
  8224 00002A7D A0[0E6D]                	mov	al, [ldrives]
  8225                                  
  8226                                  	;cmp	byte [ldrives], 1
  8227                                  	;jnb	short eetc_3	; skip verify MBR extended partition
  8228                                  
  8229 00002A80 20C0                    	and	al, al
  8230 00002A82 757E                    	jnz	short eetc_3
  8231                                  
  8232 00002A84 31ED                    	xor	bp, bp
  8233                                  
  8234                                  	; Read MBR at EBR buffer
  8235 00002A86 30E4                    	xor	ah, ah ; 19/10/2020
  8236 00002A88 31D2                    	xor	dx, dx
  8237 00002A8A BB[146D]                	mov	bx, ebr_buffer
  8238 00002A8D E8FDF0                  	call	read_hd_sector
  8239 00002A90 7218                    	jc	short eetc_0
  8240                                  
  8241 00002A92 A0[CB6F]                	mov	al, [epnumber]
  8242 00002A95 98                      	cbw
  8243 00002A96 C0E004                  	shl	al, 4 ; * 16
  8244 00002A99 BE[D26E]                	mov	si, ebr_buffer+446
  8245 00002A9C 01C6                    	add	si, ax
  8246 00002A9E BF[A457]                	mov	di, MasterBootBuff+446
  8247 00002AA1 01C7                    	add	di, ax
  8248 00002AA3 B90800                  	mov	cx, 8
  8249 00002AA6 F3A7                    	repe	cmpsw	; repeat comparising while cx > 0 and zf = 1
  8250 00002AA8 E30C                    	jcxz	eetc_1	; Extended partition entry is not changed 
  8251                                  	; Different PTE (means there is a new extended partition) 
  8252                                  eetc_0:
  8253                                  	; Write current MBR (with modified PT)
  8254 00002AAA BB[E655]                	mov	bx, MasterBootBuff
  8255 00002AAD 31C0                    	xor	ax, ax
  8256                                  	;xor	dx, dx
  8257 00002AAF E831F1                  	call	write_hd_sector
  8258 00002AB2 0F82DBDC                	jc	print_error_code ; ! display error msg and then exit !
  8259                                  eetc_1:
  8260                                  	; clear	EBR buffer
  8261 00002AB6 BF[146D]                	mov	di, ebr_buffer
  8262 00002AB9 31C0                    	xor	ax, ax
  8263 00002ABB B9FF00                  	mov	cx, 255
  8264 00002ABE F3AB                    	rep	stosw
  8265 00002AC0 C70555AA                	mov	word [di], 0AA55h
  8266                                  
  8267                                  	; Set logical dos drive parameters in it's EBR
  8268 00002AC4 BF[D26E]                	mov	di, ebr_buffer+446
  8269                                  
  8270 00002AC7 8B0E[6A3F]              	mov	cx, [sectors]
  8271 00002ACB 29DB                    	sub	bx, bx ; 0
  8272 00002ACD A1[166F]                	mov	ax, [ep_StartSector]
  8273 00002AD0 8B16[186F]              	mov	dx, [ep_StartSector+2]
  8274                                  
  8275                                  	; 03/03/2019
  8276                                  	; set partition start address & size
  8277                                  
  8278 00002AD4 A3[6A70]                	mov	[ldd_start], ax
  8279 00002AD7 8916[6C70]              	mov	[ldd_start+2], dx
  8280                                  
  8281                                  	; 01/11/2020
  8282 00002ADB 833E[9070]FF            	cmp	word [lcylinders], 65535
  8283                                  			; sign for using all of available sectors
  8284 00002AE0 7209                    	jb	short eetc_11
  8285                                  
  8286 00002AE2 A1[8A70]                	mov	ax, [ep_free_sectors]
  8287 00002AE5 8B16[8C70]              	mov	dx, [ep_free_sectors+2]
  8288 00002AE9 EB0B                    	jmp	short eetc_12
  8289                                  eetc_11:
  8290 00002AEB A0[6C3F]                	mov	al, [heads]
  8291 00002AEE F626[6A3F]              	mul	byte [sectors]
  8292 00002AF2 F726[9070]              	mul	word [lcylinders]
  8293                                  eetc_12:
  8294                                  	; 01/11/2020
  8295 00002AF6 31ED                    	xor	bp, bp
  8296 00002AF8 A3[7A70]                	mov	[ldd_size], ax
  8297 00002AFB 8916[7C70]              	mov	[ldd_size+2], dx
  8298                                  
  8299                                  	; 1st ldd start sector is always 63 or 17 (= spt)
  8300                                  	;sub	ax, cx ; cx = 63 or 17, [sectors]
  8301                                  	;sbb	dx, bx ; sbb dx, 0
  8302                                  
  8303                                  	; 01/11/2020
  8304 00002AFF E9DE00                  	jmp	eetc_4
  8305                                  
  8306                                  	;mov	[di+ptStartSector], cx
  8307                                  	;mov	[di+ptStartSector+2], bx
  8308                                  	;
  8309                                  	;; 01/11/2020
  8310                                  	;mov	[di+ptSectors], ax
  8311                                  	;mov	[di+ptSectors+2], dx
  8312                                  	;
  8313                                  	;mov	cx, ax
  8314                                  	;mov	bx, dx
  8315                                  	;; cx:bx = volume size of logical -dos- drive
  8316                                  	;
  8317                                  	;pop	ax ; ldd's LBA
  8318                                  	;pop	dx
  8319                                  	;; dx:ax = start sector address of ldd
  8320                                  	;
  8321                                  	;; 01/11/2020
  8322                                  	;add	cx, ax
  8323                                  	;adc	bx, dx
  8324                                  	;sub	cx, 1
  8325                                  	;sbb	bx, 0
  8326                                  	;; bx:cx = end sector address of ldd
  8327                                  	;push	cx
  8328                                  	;push	bx
  8329                                  	;
  8330                                  	;jmp	eetc_4
  8331                                  
  8332                                  eetc_3:
  8333                                  	; [ldrives] >= 1
  8334                                  	; Read EBR
  8335                                  	;mov	al, [ldrives]
  8336 00002B02 30E4                    	xor	ah, ah ; 02/11/2020
  8337 00002B04 C0E002                  	shl	al, 2
  8338 00002B07 89C5                    	mov	bp, ax
  8339                                  
  8340                                  	; 03/03/2019
  8341 00002B09 8B86[6670]              	mov	ax, [bp+ldd_start-4]
  8342 00002B0D 8B96[6870]              	mov	dx, [bp+ldd_start-2]
  8343 00002B11 BB[146D]                	mov	bx, ebr_buffer
  8344 00002B14 E876F0                  	call	read_hd_sector
  8345 00002B17 0F8276DC                	jc	print_error_code ; ! display error msg and then exit !
  8346                                  
  8347                                  	; 04/03/2019
  8348 00002B1B BE[E26E]                	mov	si, ebr_buffer+446+16 ; 2nd entry (next EBR)
  8349                                  	
  8350                                  	; 03/03/2019
  8351 00002B1E 8B86[6670]              	mov	ax, [bp+ldd_start-4]
  8352 00002B22 8B96[6870]              	mov	dx, [bp+ldd_start-2]
  8353 00002B26 0386[7670]              	add	ax, [bp+ldd_size-4]
  8354 00002B2A 1396[7870]              	adc	dx, [bp+ldd_size-2]
  8355                                  
  8356 00002B2E 8B0E[166F]              	mov	cx, [ep_StartSector]
  8357 00002B32 8B1E[186F]              	mov	bx, [ep_StartSector+2]
  8358                                  
  8359 00002B36 8986[6A70]              	mov	[bp+ldd_start], ax
  8360 00002B3A 8996[6C70]              	mov	[bp+ldd_start+2], dx
  8361                                  
  8362 00002B3E 52                      	push	dx ; ldd's start sector LBA
  8363 00002B3F 50                      	push	ax
  8364                                  	
  8365 00002B40 29C8                    	sub	ax, cx
  8366 00002B42 19DA                    	sbb	dx, bx
  8367                                  	; dx:ax = offset from start of the ep start sector
  8368                                  
  8369 00002B44 894408                  	mov	[si+ptStartSector], ax
  8370 00002B47 89540A                  	mov	[si+ptStartSector+2], dx
  8371                                  
  8372                                  	; 01/11/2020
  8373 00002B4A 833E[9070]FF            	cmp	word [lcylinders], 65535
  8374                                  			; sign for using all of available sectors
  8375 00002B4F 7209                    	jb	short eetc_13
  8376                                  
  8377 00002B51 A1[8A70]                	mov	ax, [ep_free_sectors]
  8378 00002B54 8B16[8C70]              	mov	dx, [ep_free_sectors+2]
  8379 00002B58 EB0B                    	jmp	short eetc_14
  8380                                  eetc_13:
  8381 00002B5A A0[6C3F]                	mov	al, [heads]
  8382 00002B5D F626[6A3F]              	mul	byte [sectors]
  8383 00002B61 F726[9070]              	mul	word [lcylinders]
  8384                                  eetc_14:
  8385                                  	; 01/11/2020
  8386 00002B65 8986[7A70]              	mov	[bp+ldd_size], ax
  8387 00002B69 8996[7C70]              	mov	[bp+ldd_size+2], dx
  8388                                  
  8389 00002B6D 89440C                   	mov	[si+ptSectors], ax
  8390 00002B70 89540E                  	mov	[si+ptSectors+2], dx
  8391                                  
  8392                                  	; 01/11/2020
  8393 00002B73 89C1                    	mov	cx, ax
  8394 00002B75 89D3                    	mov	bx, dx
  8395                                  	; cx:bx = volume size of logical -dos- drive
  8396                                  
  8397 00002B77 58                      	pop	ax ; ldd's start sector LBA
  8398 00002B78 5A                      	pop	dx
  8399                                  
  8400                                  	; 01/11/2020
  8401 00002B79 01C1                    	add	cx, ax
  8402 00002B7B 11D3                    	adc	bx, dx
  8403 00002B7D 83E901                  	sub	cx, 1
  8404 00002B80 83DB00                  	sbb	bx, 0
  8405                                  	; bx:cx = end sector address of ldd
  8406 00002B83 51                      	push	cx
  8407 00002B84 53                      	push	bx
  8408                                  
  8409                                  	; calculate CHS from LBA
  8410 00002B85 E80A02                  	call	lba_to_chs
  8411                                  		; ax = cylinder
  8412                                  		; dl = sector
  8413                                  		; dh = head
  8414                                  
  8415 00002B88 C60400                  	mov	byte [si+ptBootable], 0
  8416 00002B8B 887401                  	mov	[si+ptBeginHead], dh
  8417 00002B8E 884403                  	mov	[si+ptBeginCylinder], al
  8418 00002B91 C0E406                  	shl	ah, 6
  8419 00002B94 08E2                    	or	dl, ah		
  8420 00002B96 885402                  	mov	[si+ptBeginSector], dl
  8421                                  
  8422                                   	;;mov	ax, [si+ptSectors]
  8423                                  	;;mov	dx, [si+ptSectors+2]
  8424                                   	;mov	ax, [bp+ldd_size]
  8425                                  	;mov	dx, [bp+ldd_size+2]
  8426                                  	;sub	ax, 1
  8427                                  	;sbb	dx, 0
  8428                                  	;add	ax, [bp+ldd_start]
  8429                                  	;adc	dx, [bp+ldd_start+2]
  8430                                  	;	; dx:ax = end sector
  8431                                  	
  8432                                  	; 01/11/2020
  8433 00002B99 58                      	pop	ax
  8434 00002B9A 5A                      	pop	dx
  8435                                  	; dx:ax = end sector address of ldd
  8436                                  
  8437 00002B9B E8F401                  	call	lba_to_chs
  8438                                  		; ax = cylinder
  8439                                  		; dl = sector
  8440                                  		; dh = head
  8441                                  		; 24/10/2020
  8442                                  		; bl = Extended partition ID
  8443                                  		
  8444                                  	;mov	byte [si+ptFileSystemID], 5 ; EXTENDED
  8445                                  	; 24/10/2020
  8446 00002B9E 885C04                  	mov	[si+ptFileSystemID], bl ; EXTENDED ; 05h or 0Fh
  8447                                  	;
  8448 00002BA1 887405                  	mov	[si+ptEndHead], dh
  8449 00002BA4 884407                  	mov	[si+ptEndCylinder], al
  8450 00002BA7 C0E406                  	shl	ah, 6
  8451 00002BAA 08D4                    	or	ah, dl	
  8452 00002BAC 886406                  	mov	[si+ptEndSector], ah
  8453                                  
  8454                                  	; Write EBR
  8455 00002BAF 8B86[6670]              	mov	ax, [bp+ldd_start-4]
  8456 00002BB3 8B96[6870]              	mov	dx, [bp+ldd_start-2]
  8457 00002BB7 BB[146D]                	mov	bx, ebr_buffer
  8458 00002BBA E826F0                  	call	write_hd_sector
  8459 00002BBD 0F82D0DB                	jc	print_error_code ; ! display error msg and then exit !
  8460                                  
  8461                                  	; clear	EBR buffer
  8462 00002BC1 BF[146D]                	mov	di, ebr_buffer
  8463 00002BC4 31C0                    	xor	ax, ax
  8464 00002BC6 B9FF00                  	mov	cx, 255
  8465 00002BC9 F3AB                    	rep	stosw
  8466 00002BCB C70555AA                	mov	word [di], 0AA55h
  8467                                  
  8468 00002BCF BF[D26E]                	mov	di, ebr_buffer+446 ; 1st entry points to LDD
  8469                                  
  8470 00002BD2 8B0E[6A3F]              	mov	cx, [sectors]
  8471 00002BD6 29DB                    	sub	bx, bx ; 0
  8472                                  	; 01/11/2020
  8473 00002BD8 8B86[7A70]              	mov	ax, [bp+ldd_size]
  8474 00002BDC 8B96[7C70]              	mov	dx, [bp+ldd_size+2]
  8475                                  	;sub	ax, cx
  8476                                  	;sbb	dx, bx ; sbb dx, 0 
  8477                                  eetc_4:	
  8478 00002BE0 894D08                  	mov	[di+ptStartSector], cx
  8479 00002BE3 895D0A                  	mov	[di+ptStartSector+2], bx
  8480                                  
  8481                                  	; 01/11/2020
  8482                                  	; 1st ldd start sector is always 63 or 17 (= spt)
  8483 00002BE6 29C8                    	sub	ax, cx ; cx = 63 or 17, [sectors]
  8484 00002BE8 19DA                    	sbb	dx, bx ; sbb dx, 0
  8485                                  
  8486                                  	; 01/11/2020
  8487 00002BEA 89450C                  	mov	[di+ptSectors], ax
  8488 00002BED 89550E                  	mov	[di+ptSectors+2], dx
  8489                                  
  8490 00002BF0 8B8E[7A70]              	mov	cx, [bp+ldd_size]
  8491 00002BF4 8B9E[7C70]              	mov	bx, [bp+ldd_size+2]
  8492                                  	; cx:bx = volume size of logical -dos- drive
  8493                                  
  8494 00002BF8 8B86[6A70]              	mov	ax, [bp+ldd_start]
  8495 00002BFC 8B96[6C70]              	mov	dx, [bp+ldd_start+2]
  8496                                  	; dx:ax = start sector address of ldd (EBR addr)
  8497                                  
  8498                                  	; 01/11/2020
  8499 00002C00 01C1                    	add	cx, ax
  8500 00002C02 11D3                    	adc	bx, dx
  8501 00002C04 83E901                  	sub	cx, 1
  8502 00002C07 83DB00                  	sbb	bx, 0
  8503                                  	; bx:cx = end sector address of ldd
  8504 00002C0A 53                      	push	bx
  8505 00002C0B 51                      	push	cx
  8506                                  ;eetc_4:
  8507                                  	; 01/11/2020
  8508                                  	; stack = end sector address of ldd
  8509                                  	; dx:ax = start sector address of ldd
  8510                                  
  8511                                  	; calculate CHS from LBA
  8512                                  
  8513 00002C0C E88301                  	call	lba_to_chs
  8514                                  		; ax = cylinder
  8515                                  		; dl = sector
  8516                                  		; dh = head
  8517                                  
  8518                                  	;mov	byte [di+ptBootable], 0
  8519 00002C0F 887501                  	mov	[di+ptBeginHead], dh
  8520 00002C12 884503                  	mov	[di+ptBeginCylinder], al
  8521                                  	;mov	bl, ah
  8522                                  	;shl	bl, 6
  8523                                  	;or	dl, bl
  8524                                  	; 01/11/2020
  8525 00002C15 C0E406                  	shl	ah, 6
  8526 00002C18 08E2                    	or	dl, ah
  8527 00002C1A 885502                  	mov	[di+ptBeginSector], dl
  8528                                  
  8529                                  	;add	ax, [lcylinders]
  8530                                  	;dec	ax ; end cylinder
  8531                                  	;mov	bx, ax
  8532                                  
  8533                                  	; 01/11/2020
  8534 00002C1D 58                      	pop	ax
  8535 00002C1E 5A                      	pop	dx
  8536                                  	; dx:ax = end sector address of ldd
  8537                                  
  8538 00002C1F E87001                  	call	lba_to_chs
  8539                                  		; ax = cylinder number (0-1023)
  8540                                  		; dl = sector
  8541                                  		; dh = head
  8542                                  		; 01/11/2020
  8543                                  		; cx = cylinder number (0-65535)
  8544                                  
  8545                                  	; 02/11/2020
  8546                                  	;mov	[endcyl], cx ; 01/11/2020
  8547 00002C22 870E[9270]              	xchg	[endcyl], cx 
  8548                                  		; cx = end cylinder of the ep
  8549                                  		; [endcyl] = end cylinder of the ldd
  8550                                  
  8551                                  	;mov	[di+ptFileSystemID], 0
  8552                                  	;mov	cx, [heads]
  8553                                  	;dec	cl
  8554                                  	;mov	[di+ptEndHead], cl
  8555                                  	; 01/11/2020
  8556 00002C26 887505                  	mov	[di+ptEndHead], dh
  8557                                  
  8558 00002C29 884507                  	mov	[di+ptEndCylinder], al
  8559                                  	;mov	dx, [sectors]
  8560 00002C2C C0E406                  	shl	ah, 6
  8561 00002C2F 08D4                    	or	ah, dl	
  8562 00002C31 886506                  	mov	[di+ptEndSector], ah
  8563                                  
  8564                                  	; 02/03/2019
  8565                                  	; Check unused space if it is 3rd LDD
  8566                                  	; (write message to add unused space.)
  8567                                  
  8568                                  	; 02/11/2020
  8569                                  	;cmp	byte [ldrives], 3
  8570                                  	;jb	eetc_7
  8571                                  
  8572                                  	; 01/11/2020
  8573 00002C34 833E[9070]FF            	cmp	word [lcylinders], 65535  
  8574                                  			; sign for using all of available sectors
  8575 00002C39 0F83B500                	jnb	eetc_7	; no need to add unused sector 
  8576                                  			; (there are not any unused sectors)
  8577                                  
  8578                                  	; cx = cylinder number (0 to 65535)
  8579                                  
  8580                                  	; 02/11/2020
  8581 00002C3D 803E[0E6D]03            	cmp	byte [ldrives], 3 ; is this logical drive 4 ?
  8582 00002C42 7309                    	jnb	short eetc_17  
  8583                                  			; force to show unused space message
  8584                                  
  8585                                  	; 02/11/2020
  8586                                  	; (add unused space if cyl nums are same or diff is 1)
  8587 00002C44 49                      	dec	cx  ; tolerate cylinder numbers n and n-1 
  8588 00002C45 3B0E[9270]              	cmp	cx, [endcyl]
  8589 00002C49 0F87A500                	ja	eetc_7  ; the end cyl number of the last ldd
  8590                                  			; is 2 or more cyls less than
  8591                                  			; the end cyl number of the ep
  8592                                  			; (a next ldd can be added to
  8593                                  			; extd partition with 2 or more cyls)
  8594                                  eetc_17:
  8595                                  	; 02/11/2020
  8596 00002C4D A0[0E6D]                	mov	al, [ldrives]
  8597                                  	;add	al, '0'
  8598 00002C50 0431                    	add	al, '1'	; 03/11/2020
  8599 00002C52 A2[D361]                	mov	[char_lddn], al
  8600                                  
  8601 00002C55 A0[6A3F]                	mov	al, [sectors]
  8602 00002C58 88C7                    	mov	bh, al
  8603 00002C5A 8A1E[6C3F]              	mov	bl, [heads]
  8604 00002C5E FECB                    	dec	bl
  8605 00002C60 F6E3                    	mul	bl ; [sectors] * [heads] - 1
  8606                                  
  8607 00002C62 50                      	push	ax
  8608                                  
  8609 00002C63 88F8                    	mov	al, bh  ; [sectors]
  8610                                  	;mul	byte [heads]
  8611 00002C65 FEC3                    	inc	bl
  8612 00002C67 F6E3                    	mul	bl
  8613                                  		; ax = heads * sectors
  8614                                  	;mul	cx ; * end cylinder
  8615 00002C69 F726[9270]              	mul	word [endcyl] ; 02/11/2020
  8616                                  		; dx:ax = end cylinder * heads * sectors
  8617 00002C6D 59                      	pop	cx
  8618 00002C6E 01C8                    	add	ax, cx ; + (sectors * (heads - 1))
  8619 00002C70 83D200                  	adc	dx, 0
  8620                                  
  8621                                  	; 03/03/2019
  8622 00002C73 8B0E[6A3F]              	mov	cx, [sectors]
  8623 00002C77 FEC9                    	dec	cl  ; [sectors] - 1
  8624 00002C79 01C8                    	add	ax, cx ; + (sectors - 1)
  8625 00002C7B 83D200                  	adc	dx, 0
  8626                                  		; DX:AX = end LBA
  8627                                  	
  8628 00002C7E 8B0E[1A6F]              	mov	cx, [ep_EndSector]
  8629 00002C82 8B1E[1C6F]              	mov	bx, [ep_EndSector+2]
  8630                                  
  8631 00002C86 39DA                      	cmp	dx, bx
  8632 00002C88 7504                    	jne	short eetc_5
  8633 00002C8A 39C8                    	cmp	ax, cx
  8634 00002C8C 7464                    	je	short eetc_7 ; 05/03/2019
  8635                                  eetc_5:
  8636 00002C8E 53                      	push	bx
  8637 00002C8F BE[9061]                	mov	si, msg_c_ldd_unused_warning
  8638 00002C92 E8E9EE                  	call	print_msg
  8639 00002C95 5B                      	pop	bx
  8640                                  eetc_6:
  8641 00002C96 28E4                    	sub	ah, ah
  8642 00002C98 CD16                    	int	16h
  8643 00002C9A 3C0D                    	cmp	al, 13 ; ENTER
  8644 00002C9C 7454                    	je	short eetc_7 ; continue
  8645 00002C9E 3C1B                    	cmp	al, 27 ; ESC
  8646 00002CA0 75F4                    	jne	short eetc_6
  8647                                  
  8648                                  	; 03/03/2019
  8649                                  	; change end cylinder value
  8650 00002CA2 A0[CB6F]                	mov	al, [epnumber]
  8651 00002CA5 FEC8                    	dec	al
  8652 00002CA7 B412                    	mov	ah, 18  ; primary partition table structure size
  8653 00002CA9 F6E4                    	mul	ah
  8654 00002CAB 89C6                    	mov	si, ax
  8655 00002CAD 8B84[886F]              	mov	ax, [si+part_table_end_cyl]
  8656                                  	; 02/11/2020
  8657 00002CB1 A3[9270]                	mov	[endcyl], ax ; end cylinder of the ep
  8658                                  eetc_19:
  8659                                  	; 03/11/2020
  8660 00002CB4 3DFF03                  	cmp	ax, 1023 ; overs CHS limit ?
  8661 00002CB7 7603                    	jna	short eetc_20 ; no
  8662 00002CB9 B8FF03                  	mov	ax, 1023 ; 03FFh ; fix end CHS values of the PTE
  8663                                  eetc_20:
  8664 00002CBC 884507                  	mov	[di+ptEndCylinder], al
  8665 00002CBF 8A84[876F]              	mov	al, [si+part_table_end_sector]
  8666 00002CC3 C0E406                  	shl	ah, 6
  8667 00002CC6 08C4                    	or	ah, al	
  8668 00002CC8 886506                  	mov	[di+ptEndSector], ah
  8669 00002CCB 8A84[866F]              	mov	al, [si+part_table_end_head]
  8670 00002CCF 884505                  	mov	[di+ptEndHead], al
  8671                                  
  8672 00002CD2 89C8                    	mov	ax, cx
  8673 00002CD4 89DA                    	mov	dx, bx
  8674 00002CD6 83C001                  	add	ax, 1
  8675 00002CD9 83D200                  	adc	dx, 0
  8676                                  		; dx:ax = end of extd partition + 1 
  8677                                  
  8678                                  	; 02/11/2020
  8679 00002CDC 2B86[6A70]              	sub	ax, [bp+ldd_start]
  8680 00002CE0 1B96[6C70]              	sbb	dx, [bp+ldd_start+2]
  8681 00002CE4 2B4508                  	sub	ax, [di+ptStartSector]
  8682 00002CE7 1B550A                  	sbb	dx, [di+ptStartSector+2]
  8683                                  		; dx:ax = new sector count of the ldd
  8684                                  
  8685 00002CEA 89450C                  	mov	[di+ptSectors], ax
  8686 00002CED 89550E                  	mov	[di+ptSectors+2], dx
  8687 00002CF0 EB06                    	jmp	short eetc_8
  8688                                  eetc_7:
  8689 00002CF2 8B450C                  	mov	ax, [di+ptSectors]
  8690 00002CF5 8B550E                  	mov	dx, [di+ptSectors+2]
  8691                                  eetc_8:
  8692                                  	; 01/11/2020
  8693 00002CF8 813E[9270]FF03          	cmp	word [endcyl], 1023
  8694 00002CFE 7605                    	jna	short eetc_15
  8695                                  
  8696                                  	; 25/10/2020
  8697                                  	;mov	cx, [bp+ldd_start]
  8698                                  	;mov	bx, [bp+ldd_start+2]
  8699                                  	;; 01/11/2020
  8700                                  	;add	cx, [bp+ldd_size]
  8701                                  	;adc	bx, [bp+ldd_size+2]
  8702                                  	;sub	cx, 1 ; *
  8703                                  	;sbb	bx, 0 ; *
  8704                                  	;cmp	bx, [chs_limit+2]
  8705                                  	;jb	short eetc_15
  8706                                  	;ja	short eetc_19
  8707                                  	;cmp	cx, [chs_limit]
  8708                                  	;jna	short eetc_15
  8709                                  ;eetc_19:
  8710 00002D00 E8D000                  	call	size_to_fat_type_lba ; 25/10/2020
  8711 00002D03 EB03                    	jmp	short eetc_16
  8712                                  eetc_15:
  8713                                  	; Get proper FAT type in [ldd_type]
  8714                                  	; by using DX:AX - size -
  8715 00002D05 E8B100                  	call	size_to_fat_type
  8716                                  eetc_16:
  8717 00002D08 884504                  	mov	[di+ptFileSystemID], al
  8718                                  
  8719                                  	; Write current EBR (with modified PT)
  8720 00002D0B 8B86[6A70]              	mov	ax, [bp+ldd_start]
  8721 00002D0F 8B96[6C70]              	mov	dx, [bp+ldd_start+2]
  8722                                  
  8723                                  	; 01/11/2020
  8724                                  	; ! safety ! (to protect MBR and primary partition)
  8725                                  ;eetc_16:
  8726                                  	;cmp	dx, [ep_StartSector+2]
  8727                                  	;jb	short eetc_18
  8728                                  	;ja	short eetc_17
  8729                                  	;cmp	ax, [ep_StartSector]
  8730                                  	;jna	short eetc_18
  8731                                  ;eetc_17:
  8732                                  	;mov	ah, 0FFh
  8733                                  	;jmp	print_error_code
  8734                                  ;eetc_18:
  8735                                  
  8736 00002D13 BB[146D]                	mov	bx, ebr_buffer
  8737 00002D16 E8CAEE                  	call	write_hd_sector
  8738 00002D19 0F8274DA                	jc	print_error_code ; ! display error msg and then exit !
  8739                                  
  8740 00002D1D A0[0E6D]                	mov	al, [ldrives]
  8741 00002D20 B412                    	mov	ah, 18 ; extended partition table structure size
  8742 00002D22 F6E4                    	mul	ah
  8743                                  
  8744 00002D24 89C6                    	mov	si, ax
  8745 00002D26 81C6[CC6F]              	add	si, ext_table_boot_ind
  8746 00002D2A 87F7                    	xchg	si, di
  8747                                  
  8748                                  	; set partition (logical -dos- drive) data
  8749 00002D2C A5                      	movsw	; boot indicator, beginning head
  8750 00002D2D AC                      	lodsb
  8751 00002D2E 88C4                    	mov	ah, al
  8752 00002D30 243F                    	and	al, 3Fh
  8753 00002D32 AA                      	stosb	; beginning sector
  8754 00002D33 C0EC06                  	shr	ah, 6
  8755 00002D36 AC                      	lodsb	; beginning cylinder
  8756 00002D37 AB                      	stosw	
  8757 00002D38 A5                      	movsw	; partition id, end head
  8758 00002D39 AC                      	lodsb
  8759 00002D3A 88C4                    	mov	ah, al
  8760 00002D3C 243F                    	and	al, 3Fh
  8761 00002D3E AA                      	stosb	; end sector
  8762 00002D3F C0EC06                  	shr	ah, 6
  8763 00002D42 AC                      	lodsb	; end cylinder
  8764 00002D43 AB                      	stosw
  8765                                  
  8766 00002D44 A5                      	movsw	; copy start sector (LBA) and sector count
  8767 00002D45 A5                      	movsw
  8768 00002D46 A5                      	movsw
  8769 00002D47 A5                      	movsw
  8770                                  
  8771 00002D48 FE06[0E6D]              	inc	byte [ldrives]
  8772                                  
  8773 00002D4C E981FC                  	jmp	display_extended_pt
  8774                                  
  8775                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8776                                  ; check free space in EXTENDED (DOS) partition
  8777                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8778                                  ; 05/03/2019
  8779                                  
  8780                                  check_ext_free_space:
  8781 00002D4F A1[1E6F]                	mov	ax, [ep_Size]
  8782 00002D52 8B16[206F]              	mov	dx, [ep_Size+2]
  8783                                  
  8784 00002D56 8A1E[0E6D]              	mov	bl, [ldrives]
  8785 00002D5A 20DB                    	and	bl, bl
  8786 00002D5C 7433                    	jz	short cefs_1
  8787 00002D5E 80FB04                  	cmp	bl, 4
  8788 00002D61 7602                    	jna	short cefs_0
  8789 00002D63 B304                    	mov	bl, 4
  8790                                  cefs_0:
  8791 00002D65 FECB                    	dec	bl
  8792 00002D67 C0E302                  	shl	bl, 2 ; * 4
  8793 00002D6A 30FF                    	xor	bh, bh
  8794 00002D6C 89DE                    	mov	si, bx
  8795                                  
  8796 00002D6E 8B8C[6A70]              	mov	cx, [si+ldd_start]
  8797 00002D72 8B9C[6C70]              	mov	bx, [si+ldd_start+2]
  8798 00002D76 038C[7A70]              	add	cx, [si+ldd_size]
  8799 00002D7A 139C[7C70]              	adc	bx, [si+ldd_size+2]
  8800                                  
  8801 00002D7E 0306[166F]              	add	ax, [ep_StartSector]
  8802 00002D82 1316[186F]              	adc	dx, [ep_StartSector+2]
  8803                                  
  8804 00002D86 29C8                    	sub	ax, cx
  8805 00002D88 19DA                    	sbb	dx, bx
  8806 00002D8A 7505                    	jnz	short cefs_1
  8807                                  	
  8808 00002D8C 09C0                    	or	ax, ax
  8809 00002D8E 7501                    	jnz	short cefs_1
  8810                                  
  8811                                  	; cf = 0 if the result not negative
  8812                                  
  8813 00002D90 F9                      	stc
  8814                                  
  8815                                  	; cf = 1 if the result is negative or zero
  8816                                  	 
  8817                                  	; If cf = 0 -> There is free space as in DX:AX
  8818                                  	; NOTE: This calculation is unsafe if
  8819                                  	; logical dos drive count > 4 !	
  8820                                  	; (But still meaningful for creating a new ldd.
  8821                                  	;  Because a new ldd will be created only
  8822                                  	;  if ldd count < 4.)
  8823                                  cefs_1:
  8824 00002D91 C3                      	retn
  8825                                  
  8826                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8827                                  ; convert LBA to CHS parameters (in registers)
  8828                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8829                                  ; 24/10/2020
  8830                                  
  8831                                  	; 13/01/2021 (BugFix)
  8832                                  	; 01/03/2019 (hdimage.s)
  8833                                  lba_to_chs:
  8834                                  	; INPUT:
  8835                                  	;	DX:AX = LBA address
  8836                                  	; OUTPUT:
  8837                                  	;	AX = cylinder
  8838                                  	;	DL = sector
  8839                                  	;	DH = head
  8840                                  	; 24/10/2020
  8841                                  	;	BL = extended partition ID (05h, 0Fh)
  8842                                  	;
  8843                                  	; (modified registers: ax, bx, cx, dx)
  8844                                  
  8845 00002D92 8B0E[6A3F]              	mov	cx, [sectors]
  8846 00002D96 E8E4DE                  	call	div32
  8847 00002D99 FEC3                    	inc	bl
  8848 00002D9B 53                      	push	bx ; BL = sector
  8849 00002D9C 8B0E[6C3F]              	mov	cx, [heads]
  8850 00002DA0 E8DADE                  	call	div32
  8851 00002DA3 5A                      	pop	dx  ; DL = sector	
  8852 00002DA4 88DE                    	mov	dh, bl ; BL = head
  8853                                  	
  8854                                  	; 24/10/2020
  8855                                  	; check cylinder number (CHS) limit
  8856                                  	;mov	bh, 05h ; ENTENTED (LBA)
  8857                                  	; 13/03/2021
  8858 00002DA6 B305                    	mov	bl, 05h ; EXTENDED (LBA)
  8859                                  
  8860 00002DA8 89C1                    	mov	cx, ax ; 01/11/2020
  8861                                  
  8862 00002DAA 3DFF03                  	cmp	ax, 1023
  8863 00002DAD 7609                    	jna	short lbatochs_ok
  8864                                  
  8865 00002DAF B8FF03                  	mov	ax, 1023 ; BC/EC = 0FFh
  8866 00002DB2 B23F                    	mov	dl, 63  ; BS/ES = 0FFh
  8867 00002DB4 B6FE                    	mov	dh, 254 ; BH/EH = 0FEh
  8868 00002DB6 B30F                    	mov	bl, 0Fh ; EXTENDED (CHS)
  8869                                  lbatochs_ok:
  8870 00002DB8 C3                      	retn
  8871                                  
  8872                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8873                                  ; specify FAT type by using partition/volume size (CHS)
  8874                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8875                                  ; 02/03/2019
  8876                                  
  8877                                  size_to_fat_type:
  8878                                  	; INPUT:
  8879                                  	;	DX:AX = DOS Partition Size in sectors
  8880                                  	; OUTPUT:
  8881                                  	;	AL = Partition type/ID (FAT type)
  8882                                  
  8883 00002DB9 09D2                    	or	dx, dx
  8884 00002DBB 750B                    	jnz	short stft_2
  8885                                  
  8886 00002DBD 3DA87F                  	cmp	ax, 32680
  8887 00002DC0 7703                    	ja	short stft_1
  8888                                  stft_0:	
  8889 00002DC2 B001                    	mov	al, 1	; FAT12 file system
  8890 00002DC4 C3                      	retn
  8891                                  stft_1:
  8892 00002DC5 B004                    	mov	al, 4	; FAT16 (< 32MB)
  8893 00002DC7 C3                      	retn	
  8894                                  stft_2:
  8895 00002DC8 83FA10                  	cmp	dx, 10h
  8896 00002DCB 7303                    	jnb	short stft_3 ; FAT32 (CHS) file system
  8897                                  
  8898 00002DCD B006                    	mov	al, 6	; FAT16 (>= 32MB)
  8899 00002DCF C3                      	retn
  8900                                  stft_3:
  8901 00002DD0 B00B                    	mov	al, 0Bh ; FAT32 (CHS)
  8902 00002DD2 C3                      	retn
  8903                                  
  8904                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8905                                  ; specify FAT type by using partition/volume size (LBA)
  8906                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8907                                  ; 25/10/2020
  8908                                  
  8909                                  size_to_fat_type_lba:
  8910                                  	; INPUT:
  8911                                  	;	DX:AX = DOS Partition Size in sectors
  8912                                  	; OUTPUT:
  8913                                  	;	AL = Partition type/ID (FAT type)
  8914                                  
  8915 00002DD3 09D2                    	or	dx, dx
  8916 00002DD5 7408                    	jz	short stft_4
  8917                                  
  8918 00002DD7 83FA10                  	cmp	dx, 10h
  8919 00002DDA 7208                    	jb	short stft_5 ; FAT16 (LBA) file system
  8920                                  
  8921 00002DDC B00C                    	mov	al, 0Ch ; FAT32 file system (LBA)
  8922 00002DDE C3                      	retn
  8923                                  stft_4:
  8924 00002DDF 3DA87F                  	cmp	ax, 32680
  8925 00002DE2 76DE                    	jna	short stft_0  ; FAT12 file system
  8926                                  stft_5:	
  8927 00002DE4 B00E                    	mov	al, 0Eh	; FAT16 file system (LBA)
  8928 00002DE6 C3                      	retn
  8929                                  
  8930                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8931                                  ; get requested logical dos drive size (from user)
  8932                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8933                                  ; 02/03/2019
  8934                                  
  8935                                  get_ldd_size:
  8936                                  	; INPUT -> none
  8937                                  	;
  8938                                  	; OUTPUT -> 
  8939                                  	;	[lcylinders] = cylinder count
  8940                                  	;
  8941                                  	; (Modified registers: ax, bx, cx, dx, si, di) 
  8942                                  
  8943 00002DE7 B80300                  	mov	ax, 3 ; clear screen
  8944 00002DEA CD10                    	int	10h
  8945                                  
  8946 00002DEC BE[1048]                	mov	si, msg_create_dos_partition_h
  8947 00002DEF E88CED                  	call	print_msg
  8948                                  
  8949                                  	; 03/03/2019
  8950 00002DF2 A0[0E6D]                	mov	al, [ldrives]
  8951 00002DF5 08C0                    	or	al, al		; cmp byte [ldrives], 0
  8952 00002DF7 7405                    	jz	short gldds_1	; jna short gldds_0
  8953                                  
  8954                                  	;push	ax ; *	
  8955                                  
  8956                                  	;dec	al
  8957                                  	;mov	ah, 18
  8958                                  	;mul	ah
  8959                                  	
  8960                                  	;mov	di, ext_table_rel_sec_lw
  8961                                  	;add	di, ax
  8962                                  
  8963 00002DF9 BE[244E]                	mov	si, msg_use_all_space
  8964                                  	; 01/11/2020
  8965                                  	;call	print_msg
  8966 00002DFC EB03                    	jmp	short gldds_2
  8967                                  
  8968                                  	; Calculate available space
  8969                                  
  8970                                  	;mov	ax, [ep_Size] ; ext part size in sectors
  8971                                  	;mov	dx, [ep_Size+2]
  8972                                  	
  8973                                  	; 04/03/2019
  8974                                  ;gldds_0:
  8975                                  	;mov	cx, [di]    ; start sector
  8976                                  	;mov	bx, [di+2]
  8977                                  	;add	cx, [di+4]  ; sectors
  8978                                  	;adc	bx, [di+6]
  8979                                  	;	; bx:cx = start of next ldd
  8980                                  	;sub	ax, cx
  8981                                  	;sbb	dx, bx
  8982                                  	;	; dx:ax = free space in sectors
  8983                                  	;
  8984                                  	;pop	cx ; *
  8985                                  	;dec	cl
  8986                                  	;jz	short gldds_2
  8987                                  	;sub	di, 18
  8988                                  	;push	cx ; *
  8989                                  	;jmp	short gldds_0
  8990                                  
  8991                                  	; 05/03/2019
  8992                                  	;call	check_ext_free_space
  8993                                  	;jc	short gldds_cancel
  8994                                  	
  8995                                  	; 01/11/2020
  8996                                  	; 30/10/2020
  8997                                  	;mov	ax, [ep_free_sectors]
  8998                                  	;mov	dx, [ep_free_sectors+2]
  8999                                  	
  9000                                  		; DX:AX = free sectors in extended partition
  9001                                  	;jmp	short gldds_2
  9002                                  gldds_1:
  9003 00002DFE BE[574E]                	mov	si, msg_use_entire_ep_space
  9004                                  	;call	print_msg
  9005                                  	
  9006                                  	; 01/11/2020
  9007                                  	; Calculate free space in extended partition
  9008                                  	;mov	ax, [ep_Size]
  9009                                  	;mov	dx, [ep_Size+2]
  9010                                  gldds_2:
  9011                                  	; 01/11/2020
  9012 00002E01 E87AED                  	call	print_msg
  9013                                  
  9014 00002E04 A0[6C3F]                	mov	al, [heads]
  9015 00002E07 F626[6A3F]              	mul	byte [sectors]
  9016 00002E0B 89C1                    	mov	cx, ax
  9017                                  		
  9018 00002E0D A1[8A70]                	mov	ax, [ep_free_sectors]
  9019 00002E10 8B16[8C70]              	mov	dx, [ep_free_sectors+2]
  9020                                  
  9021                                  	; 01/11/2020
  9022                                  	; this is needed for partition size input
  9023                                  	; (maximum available sectors)
  9024                                  	;mov	[pp_Sectors], ax
  9025                                  	;mov	[pp_Sectors+2], dx
  9026                                  
  9027                                  	; 01/11/2020
  9028                                  	; subtrack start offset (which always equals to spt value)
  9029                                  	;sub	ax, [sectors]
  9030                                  	;sbb	dx, 0
  9031                                  
  9032                                  	;mov	cx, ax
  9033                                  	;mov	al, [heads]
  9034                                  	;mul	byte [sectors]
  9035                                  	;xchg	ax, cx
  9036                                  		; dx:ax = sectors
  9037                                  		; cx = heads*spt 
  9038                                  	;call	div32
  9039                                  		; ax = cylinders
  9040                                  		; bx = remainder
  9041                                   		; dx = 0
  9042                                  	;and	bx, bx
  9043                                  	;jz	short gldds_3
  9044                                  	;inc	ax
  9045                                  	; 01/11/2020
  9046 00002E14 F7F1                    	div	cx
  9047                                  	;and	dx, dx
  9048                                  	;jz	short gldds_3
  9049                                  	;inc	ax
  9050                                  gldds_3:
  9051 00002E16 A3[9070]                	mov	[lcylinders], ax ; <= 65535 (< 65535)
  9052                                  gldds_getchar:
  9053 00002E19 30E4                    	xor	ah, ah
  9054 00002E1B CD16                    	int	16h
  9055                                  
  9056 00002E1D 3C1B                    	cmp	al, 27 ; ESCAPE key
  9057 00002E1F 7416                    	je	short gldds_cancel
  9058 00002E21 24DF                    	and	al, 0DFh
  9059 00002E23 3C4E                    	cmp	al, 'N'
  9060 00002E25 7417                    	je	short gldds_4
  9061 00002E27 3C59                    	cmp	al, 'Y'
  9062 00002E29 75EE                    	jne	short gldds_getchar
  9063                                  
  9064                                  	; 01/11/2020
  9065 00002E2B C706[9070]FFFF          	mov	word [lcylinders], 65535 ; sign for all free sectors
  9066                                  	
  9067 00002E31 BE[A45C]                	mov	si, _msg_YES
  9068                                  	;call	print_msg
  9069                                  	;retn
  9070 00002E34 E947ED                  	jmp	print_msg
  9071                                  
  9072                                  gldds_cancel:
  9073 00002E37 C706[9070]0000          	mov	word [lcylinders], 0
  9074                                  gldds_28:
  9075 00002E3D C3                      	retn
  9076                                  gldds_4:	
  9077 00002E3E BE[AA5C]                	mov	si, _msg_NO
  9078 00002E41 E83AED                  	call	print_msg
  9079                                  gldds_26:
  9080 00002E44 B80300                  	mov	ax, 3 ; clear screen
  9081 00002E47 CD10                    	int	10h
  9082                                  
  9083 00002E49 BE[1048]                	mov	si, msg_create_dos_partition_h
  9084 00002E4C E82FED                  	call	print_msg
  9085                                  
  9086 00002E4F BE[1662]                	mov	si, msg_create_ldd_s
  9087 00002E52 E829ED                  	call	print_msg
  9088 00002E55 BE[E24D]                	mov	si, msg_press_esc_to_cancel
  9089 00002E58 E823ED                  	call	print_msg
  9090                                  gldds_25:
  9091 00002E5B 30E4                    	xor	ah, ah
  9092 00002E5D CD16                    	int	16h
  9093                                  
  9094 00002E5F 3C1B                    	cmp	al, 27 ; ESCAPE key
  9095 00002E61 7502                    	jne	short gldds_5
  9096                                  
  9097 00002E63 EBD2                    	jmp	short gldds_cancel
  9098                                  gldds_5:
  9099                                  	; 04/03/2019
  9100 00002E65 3C20                    	cmp	al, 32 ; SPACE key
  9101 00002E67 74D4                    	je	short gldds_28
  9102                                  	
  9103                                  	; 01/11/2020
  9104                                  	;mov	byte [pSize_unit], '%'
  9105 00002E69 3C25                    	cmp	al, '%'
  9106 00002E6B 7416                    	je	short gldds_6
  9107                                  	;mov	byte [pSize_unit], 'M'
  9108 00002E6D 3C0D                    	cmp	al, 13 ; 0Dh, Carriage Return key
  9109                                  	;je	short gldds_6
  9110 00002E6F 7504                    	jne	short gldds_29
  9111                                  	; 01/11/2020
  9112 00002E71 B04D                    	mov	al, 'M'
  9113 00002E73 EB0E                    	jmp	short gldds_6
  9114                                  gldds_29:
  9115 00002E75 24DF                    	and	al, 0DFh
  9116 00002E77 3C4D                    	cmp	al, 'M'
  9117 00002E79 7408                    	je	short gldds_6
  9118                                  	;mov	[pSize_unit], al
  9119 00002E7B 3C47                    	cmp	al, 'G'
  9120 00002E7D 7404                    	je	short gldds_6
  9121 00002E7F 3C43                    	cmp	al, 'C'
  9122 00002E81 75D8                    	jne	short gldds_25
  9123                                  gldds_6:
  9124                                  	; 01/11/2020
  9125 00002E83 A2[EA6C]                	mov	[pSize_unit], al
  9126                                  
  9127                                  	; Set maximum sector count (all of extended partition)
  9128                                  	;mov	al, [sectors]
  9129                                  	;mul	byte [heads]
  9130                                  	;mul	word [lcylinders]
  9131                                  	; 01/11/2020	
  9132 00002E86 A1[8A70]                	mov	ax, [ep_free_sectors]
  9133 00002E89 8B16[8C70]              	mov	dx, [ep_free_sectors+2]
  9134 00002E8D A3[D86C]                	mov	[pp_Sectors], ax
  9135 00002E90 8916[DA6C]              	mov	[pp_Sectors+2], dx
  9136                                  	
  9137 00002E94 E857EF                   	call	partition_size_input
  9138 00002E97 729E                    	jc	short gldds_cancel
  9139                                  		; DX:AX = Partition size in sectors
  9140                                  	;or	bx, bx
  9141                                  	;jnz	short gldds_cancel
  9142                                  
  9143                                  	; 01/11/2020
  9144 00002E99 A3[066D]                	mov	[ppn_Sectors], ax
  9145 00002E9C 8916[086D]              	mov	[ppn_Sectors+2], dx
  9146                                  		
  9147                                  	;mov	cx, ax
  9148                                  	;mov	al, [heads]
  9149                                  	;mul	byte [sectors]
  9150                                  	;xchg	ax, cx
  9151                                  	; 13/03/2021
  9152 00002EA0 8B0E[006D]              	mov	cx, [hs] ; heads*sectors
  9153                                  		; dx:ax = sectors
  9154                                  		; cx = heads*spt 
  9155 00002EA4 E8D6DD                  	call	div32
  9156                                  		; ax = cylinders
  9157                                  		; bx = remainder
  9158                                   		; dx = 0
  9159                                  	; 02/11/2020
  9160                                  	;and	bx, bx
  9161                                  	;jz	short gldds_7
  9162                                  	;inc	ax
  9163                                  gldds_7:
  9164 00002EA7 3B06[9070]              	cmp	ax, [lcylinders]
  9165 00002EAB 7704                    	ja	short gldds_9
  9166                                  gldds_8:
  9167                                  	; OK
  9168 00002EAD A3[9070]                	mov	[lcylinders], ax
  9169 00002EB0 C3                      	retn
  9170                                  
  9171                                  gldds_9:
  9172                                  	; Partition size limit message
  9173                                  	
  9174 00002EB1 803E[EA6C]43            	cmp	byte [pSize_unit], 'C'
  9175 00002EB6 741C                    	je	short gldds_10
  9176                                  
  9177                                  	; Tolerate 1 cylinder if unit is not cylinder
  9178                                  	;dec	ax
  9179                                  	;cmp	ax, [lcylinders]
  9180                                  	;jna	short gldds_8
  9181                                  
  9182                                  	; 01/11/2020
  9183                                  	; Tolerate sectors if sectorcount doesn't over ep limit
  9184 00002EB8 A1[066D]                	mov	ax, [ppn_Sectors]
  9185 00002EBB 8B16[086D]              	mov	dx, [ppn_Sectors+2]
  9186 00002EBF 3B16[8C70]              	cmp	dx, [ep_free_sectors+2]
  9187 00002EC3 770F                    	ja	short gldds_10
  9188 00002EC5 7206                    	jb	short gldds_30
  9189 00002EC7 3B06[8A70]              	cmp	ax, [ep_free_sectors]
  9190 00002ECB 7707                    	ja	short gldds_10
  9191                                  gldds_30:
  9192 00002ECD C706[9070]FFFF          	mov	word [lcylinders], 65535 ; sign for all free sectors
  9193 00002ED3 C3                      	retn
  9194                                  
  9195                                  gldds_10:
  9196                                  	; clear screen
  9197 00002ED4 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  9198 00002ED7 CD10                    	int	10h
  9199                                  
  9200 00002ED9 BE[1048]                	mov	si, msg_create_dos_partition_h ; header
  9201 00002EDC E89FEC                  	call	print_msg
  9202                                  
  9203 00002EDF BE[C35D]                	mov	si, msg_partition_size_limit
  9204 00002EE2 E899EC                  	call	print_msg
  9205                                  
  9206 00002EE5 803E[EA6C]4D            	cmp	byte [pSize_unit], 'M'
  9207 00002EEA 7413                    	je	short gldds_11
  9208                                  
  9209 00002EEC 803E[EA6C]25            	cmp	byte [pSize_unit], '%'
  9210 00002EF1 7457                    	je	short gldds_22
  9211                                  
  9212 00002EF3 803E[EA6C]43            	cmp	byte [pSize_unit], 'C'
  9213 00002EF8 7505                    	jne	short gldds_11
  9214                                  
  9215 00002EFA A1[9070]                	mov	ax, [lcylinders]
  9216 00002EFD EB0F                    	jmp	short gldds_12
  9217                                  gldds_11:
  9218                                  	; 'M'
  9219 00002EFF A1[D86C]                	mov	ax, [pp_Sectors]
  9220 00002F02 8B16[DA6C]              	mov	dx, [pp_Sectors+2]
  9221 00002F06 B90008                  	mov	cx, 2*1024 ; sectors -> MB
  9222 00002F09 E871DD                  	call	div32
  9223                                  		; DX = 0 
  9224                                  		; AX = Available space in Megabytes
  9225 00002F0C 89C7                    	mov	di, ax
  9226                                  gldds_12:	
  9227 00002F0E B90A00                  	mov	cx, 10
  9228 00002F11 89E5                    	mov	bp, sp
  9229                                  gldds_13:
  9230 00002F13 31D2                    	xor	dx, dx
  9231                                  	;mov	cx, 10
  9232 00002F15 F7F1                    	div	cx
  9233 00002F17 52                      	push	dx
  9234 00002F18 83F809                  	cmp	ax, 9
  9235 00002F1B 77F6                    	ja	short gldds_13
  9236                                  gldds_14:
  9237 00002F1D BB0700                  	mov	bx, 07h
  9238 00002F20 09C0                    	or	ax, ax
  9239 00002F22 7501                    	jnz	short gldds_16
  9240                                  gldds_15:
  9241 00002F24 58                      	pop	ax
  9242                                  gldds_16:
  9243 00002F25 0430                    	add	al, '0'
  9244                                  gldds_17:
  9245 00002F27 B40E                    	mov	ah, 0Eh
  9246                                  	;mov	bx, 07h
  9247 00002F29 CD10                    	int	10h	; write character (as tty)
  9248                                  
  9249 00002F2B 39EC                    	cmp	sp, bp
  9250 00002F2D 72F5                    	jb	short gldds_15
  9251                                  
  9252 00002F2F 803E[EA6C]25            	cmp	byte [pSize_unit], '%'
  9253 00002F34 7508                    	jne	short gldds_18
  9254                                  
  9255 00002F36 3C25                    	cmp	al, '%'
  9256 00002F38 745E                    	je	short gldds_21
  9257 00002F3A B025                    	mov	al, '%'
  9258 00002F3C EBE9                    	jmp	short gldds_17
  9259                                  gldds_18:
  9260 00002F3E 803E[EA6C]43            	cmp	byte [pSize_unit], 'C'
  9261 00002F43 753E                    	jne	short gldds_19
  9262                                  
  9263 00002F45 BE[5F5E]                	mov	si, msg_cylinders
  9264 00002F48 EB4B                    	jmp	short gldds_20
  9265                                  
  9266                                  gldds_22:
  9267                                  	; '%'
  9268                                  	; 01/11/2020
  9269 00002F4A 8B16[206F]              	mov	dx, [ep_Size+2]
  9270 00002F4E A1[1E6F]                	mov	ax, [ep_Size] ; *
  9271 00002F51 21D2                    	and	dx, dx
  9272 00002F53 7419                    	jz	short gldds_33 ; dx = 0
  9273 00002F55 B90100                  	mov	cx, 1
  9274                                  gldds_31:
  9275 00002F58 D1E1                    	shl	cx, 1
  9276 00002F5A E820DD                  	call	div32
  9277 00002F5D 09D2                    	or	dx, dx
  9278 00002F5F 7409                    	jz	short gldds_32 ; *
  9279 00002F61 A1[1E6F]                	mov	ax, [ep_Size]	
  9280 00002F64 8B16[206F]              	mov	dx, [ep_Size+2]
  9281 00002F68 EBEE                    	jmp	short gldds_31
  9282                                  gldds_32:
  9283 00002F6A 8B16[8C70]              	mov	dx, [ep_free_sectors+2]
  9284                                  	; ep free sectors <= ep size
  9285                                  gldds_33:
  9286 00002F6E 50                      	push	ax ; * ; dx = 0 (ep size weight)
  9287 00002F6F A1[8A70]                	mov	ax, [ep_free_sectors]
  9288 00002F72 B96400                  	mov	cx, 100
  9289                                  	;and	dx, dx
  9290                                  	;jnz	short gldds_34
  9291                                  	;mul	cx
  9292                                  	;jmp	short gldds_35
  9293                                  ;gldds_34:
  9294 00002F75 E813DD                  	call	mul32
  9295                                  		; dx:ax = 100 * ep free sectors weight
  9296                                  ;gldds_35:
  9297 00002F78 59                      	pop	cx ; *
  9298 00002F79 E801DD                  	call	div32 ; 100 * ep free sectors / ep size
  9299                                  		; ax = % value (<= 100)
  9300 00002F7C 09C0                    	or	ax, ax
  9301                                  	;jnz	short gldds_23
  9302 00002F7E 758E                    	jnz	short gldds_12 ; 13/01/2021
  9303 00002F80 40                      	inc	ax ; 0 -> 1
  9304                                  	; 13/03/2021
  9305 00002F81 EB8B                    	jmp	short gldds_12
  9306                                  
  9307                                  ;gldds_23:	
  9308                                  	;mov	bp, sp
  9309                                  	;mov	cx, 10
  9310                                  ;gldds_24:	
  9311                                  	;xor	dx, dx
  9312                                  	;div	cx
  9313                                  	;push	dx ; *
  9314                                  	;cmp	ax, 9
  9315                                  	;ja	short gldds_24
  9316                                  	;jmp	short gldds_14
  9317                                  
  9318                                  gldds_19:
  9319 00002F83 BE[735E]                	mov	si, msg_megabytes
  9320 00002F86 C606[7C5E]73            	mov	byte [msg_megabytes_s], 's'
  9321 00002F8B 83FF01                  	cmp	di, 1
  9322 00002F8E 7705                    	ja	short gldds_20
  9323 00002F90 C606[7C5E]00            	mov	byte [msg_megabytes_s], 0
  9324                                  gldds_20:
  9325 00002F95 E8E6EB                  	call	print_msg
  9326                                  gldds_21:
  9327 00002F98 BE[105E]                	mov	si, msg_partition_size_limit_r
  9328 00002F9B E8E0EB                  	call	print_msg
  9329                                  gldds_27:
  9330 00002F9E 30E4                    	xor	ah, ah
  9331 00002FA0 CD16                    	int	16h
  9332                                  	
  9333 00002FA2 3C1B                    	cmp	al, 27 ; ESCAPE key
  9334 00002FA4 0F849CFE                	je	gldds_26
  9335 00002FA8 3C0D                    	cmp	al, 13 ; ENTER (Carriage Return) key
  9336 00002FAA 75F2                    	jne	short gldds_27
  9337                                  
  9338                                  	;mov	ax, [lcylinders]
  9339 00002FAC C3                      	retn
  9340                                  	
  9341                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9342                                  ; initialize extended (dos) partition table 
  9343                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9344                                  ; 18/10/2020 (fdisk3.s)
  9345                                  ; 26/02/2019 (hdimage.s)
  9346                                  
  9347                                  init_ext_partition_table:
  9348                                  
  9349                                  	; INPUT -> 
  9350                                  	;	[epnumber] = extended partition number
  9351                                  	;
  9352                                  	; OUTPUT -> none
  9353                                  
  9354                                  ; Display Method: ; 04/03/2019
  9355                                  ;LDD 1 <- LDD_START0, ebr 1st entry <- MBR (extended partition) - EBR 0
  9356                                  ;LDD 2 <- LDD_START1, ebr 1st entry <- EBR 1
  9357                                  ;LDD 3 <- LDD_START2, ebr 1st entry <- EBR 2
  9358                                  ;LDD 4 <- LDD_START3, ebr 1st entry <- EBR 3
  9359                                  ;LDD 5 <- LDD_START3, ebr 2nd entry (LDD 5 is not displayed)
  9360                                  
  9361                                  	; 08/03/2019
  9362                                  
  9363                                  	; clear extended partition table structure/list
  9364                                  
  9365 00002FAD BF[CC6F]                	mov	di, ext_table_boot_ind
  9366 00002FB0 89FE                    	mov	si, di ; 28/02/2019
  9367 00002FB2 B92400                  	mov	cx, 36 ; 18*4 = 72 bytes
  9368 00002FB5 31C0                    	xor	ax, ax ; 0
  9369 00002FB7 F3AB                    	rep	stosw
  9370 00002FB9 89F7                    	mov	di, si ; 28/02/2019
  9371                                  
  9372                                  	;mov	byte [ldrives], 0
  9373 00002FBB A2[0E6D]                	mov	[ldrives], al ; 0
  9374                                  
  9375                                  	;cmp	byte [epnumber], 1
  9376                                  	;jb	short iept_0
  9377                                  
  9378 00002FBE A0[CB6F]                	mov	al, [epnumber]
  9379 00002FC1 FEC8                    	dec	al
  9380 00002FC3 B412                    	mov	ah, 18  ; partition table structure size 
  9381 00002FC5 F6E4                    	mul	ah
  9382 00002FC7 BE[8A6F]                	mov	si, part_table_rel_sec_lw
  9383 00002FCA 01C6                    	add	si, ax
  9384                                  	; 02/11/2020
  9385                                  	;(save end cylinder for comparising later)
  9386 00002FCC 8B44FE                  	mov	ax, [si-2] ; part_table_end_cyl
  9387                                  			; 16 bit cylinder number
  9388 00002FCF A3[9270]                	mov	[endcyl], ax
  9389                                  	;
  9390 00002FD2 8B04                    	mov	ax, [si]
  9391 00002FD4 8B5402                  	mov	dx, [si+2]
  9392 00002FD7 A3[166F]                	mov	[ep_StartSector], ax
  9393 00002FDA 8916[186F]              	mov	[ep_StartSector+2], dx
  9394 00002FDE 8B4C04                  	mov	cx, [si+4]
  9395 00002FE1 8B5C06                  	mov	bx, [si+6]
  9396 00002FE4 890E[1E6F]              	mov	[ep_Size], cx
  9397 00002FE8 891E[206F]              	mov	[ep_Size+2], bx
  9398 00002FEC 83E901                  	sub	cx, 1
  9399 00002FEF 83DB00                  	sbb	bx, 0
  9400 00002FF2 01C1                    	add	cx, ax
  9401 00002FF4 11D3                    	adc	bx, dx 
  9402 00002FF6 890E[1A6F]              	mov	[ep_EndSector], cx
  9403 00002FFA 891E[1C6F]              	mov	[ep_EndSector+2], bx
  9404                                  
  9405                                  	; 27/02/2019
  9406 00002FFE A3[6A70]                	mov	[ldd_start], ax
  9407 00003001 8916[6C70]              	mov	[ldd_start+2], dx
  9408                                  
  9409                                  	; 03/03/2019
  9410                                  	;mov	word [ldd_size], 0
  9411                                  	;mov	word [ldd_size+2], 0
  9412                                  	
  9413 00003005 BB[146D]                	mov	bx, ebr_buffer
  9414                                  	; dx:ax = Extended partition address
  9415                                  	; es:bx = Extended partition buffer
  9416 00003008 E882EB                  	call	read_hd_sector
  9417 0000300B 7209                    	jc	short iept_0
  9418                                  
  9419                                  	; Check EBR if it is a valid boot record or not
  9420 0000300D 813E[126F]55AA          	cmp	word [ebr_buffer+510], 0AA55h
  9421 00003013 7402                    	je	short iept_1
  9422                                  iept_stc_retn:
  9423 00003015 F9                      	stc
  9424                                  iept_0:
  9425 00003016 C3                      	retn
  9426                                  iept_1:
  9427                                  	; Check PTE 1, if it is valid or not
  9428 00003017 A0[D66E]                	mov	al, [ebr_buffer+446+ptFileSystemID]
  9429 0000301A 20C0                    	and	al, al
  9430 0000301C 74F7                    	jz	short iept_stc_retn ; empty pte, error
  9431 0000301E 3C05                    	cmp	al, 5
  9432 00003020 74F3                    	je	short iept_stc_retn ; extended partition, error
  9433                                  	; 24/10/2020
  9434 00003022 3C0F                    	cmp	al, 0Fh
  9435 00003024 74EF                    	je	short iept_stc_retn ; extended partition, error
  9436                                  
  9437                                  	;inc	byte [ldrives] ; logical (dos) drive count
  9438                                  
  9439 00003026 BE[D26E]                	mov	si, ebr_buffer+446 ; Partition table offset
  9440 00003029 B90400                  	mov	cx, 4
  9441                                  
  9442                                  	; set partition (logical -dos- drive) data
  9443 0000302C A5                      	movsw	; boot indicator, beginning head
  9444 0000302D AC                      	lodsb
  9445 0000302E 88C4                    	mov	ah, al
  9446 00003030 243F                    	and	al, 3Fh
  9447 00003032 AA                      	stosb	; beginning sector
  9448 00003033 C0EC06                  	shr	ah, 6
  9449 00003036 AC                      	lodsb	; beginning cylinder
  9450 00003037 AB                      	stosw	
  9451 00003038 A5                      	movsw	; partition id, end head
  9452 00003039 AC                      	lodsb
  9453 0000303A 88C4                    	mov	ah, al
  9454 0000303C 243F                    	and	al, 3Fh
  9455 0000303E AA                      	stosb	; end sector
  9456 0000303F C0EC06                  	shr	ah, 6
  9457 00003042 AC                      	lodsb	; end cylinder
  9458 00003043 AB                      	stosw
  9459                                  
  9460                                  	; 04/03/2019
  9461 00003044 8A1E[0E6D]              	mov	bl, [ldrives]
  9462                                  	;dec 	bl
  9463                                  	;jnz	short iept_2
  9464                                  
  9465                                  	; 05/03/2019
  9466 00003048 08DB                    	or	bl, bl
  9467 0000304A 7518                    	jnz	short iept_2
  9468                                  
  9469 0000304C 8B04                    	mov	ax, [si]   ; start sector of 1st LDD (offset)
  9470 0000304E 8B5402                  	mov	dx, [si+2]
  9471 00003051 034404                  	add	ax, [si+4] ; size of 1st LDD (volume)
  9472 00003054 135406                  	adc	dx, [si+6]
  9473                                  
  9474 00003057 A3[7A70]                	mov	[ldd_size], ax ; size of 1st LDD (partition)
  9475 0000305A 8916[7C70]              	mov	[ldd_size+2], dx
  9476                                  	; 05/03/2019
  9477 0000305E FE06[0E6D]              	inc	byte [ldrives] ; logical (dos) drive count
  9478 00003062 FEC3                    	inc	bl
  9479                                  iept_2:
  9480 00003064 F3A5                    	rep	movsw ; copy start sector (LBA) and sector count
  9481                                  
  9482                                  	; get next extended partition (logical -dos- drive) data
  9483 00003066 8A4404                  	mov	al, [si+ptFileSystemID]
  9484 00003069 20C0                    	and	al, al ; EMPTY
  9485 0000306B 74A9                    	jz	short iept_0 ; end of logical -dos- drive chain
  9486                                  
  9487 0000306D 3C05                    	cmp	al, 5 ; EXTENDED
  9488                                  	;jne	short iept_stc_retn  ; 2nd PTE must have
  9489                                  	;			     ; extended partition ID
  9490 0000306F 7404                    	je	short iept_4
  9491                                  	; 24/10/2020
  9492 00003071 3C0F                    	cmp	al, 0Fh ; EXTENDED (LBA)
  9493 00003073 75A0                    	jne	short iept_stc_retn  ; 2nd PTE must have
  9494                                  				     ; extended partition ID
  9495                                  iept_4:
  9496                                  	; 05/03/2019
  9497 00003075 FE06[0E6D]              	inc	byte [ldrives] ; logical (dos) drive count
  9498                                  
  9499                                  	;cmp	byte [ldrives], al ; 5
  9500 00003079 80FB04                  	cmp	bl, 4 ; number of logical dos drives (till here)
  9501 0000307C 733D                    	jnb	short iept_3
  9502                                  
  9503 0000307E 83C608                  	add	si, 8
  9504                                  
  9505 00003081 AD                      	lodsw	
  9506 00003082 89C2                    	mov	dx, ax	; start sector
  9507 00003084 AD                      	lodsw
  9508 00003085 92                      	xchg	dx, ax	; start sector + 2
  9509                                  
  9510                                  	; 04/03/2019
  9511 00003086 0306[166F]              	add	ax, [ep_StartSector]
  9512 0000308A 1316[186F]              	adc	dx, [ep_StartSector+2]
  9513                                  	
  9514 0000308E 30FF                    	xor	bh, bh
  9515 00003090 C0E302                  	shl	bl, 2 ; *4
  9516                                  
  9517                                  	; 28/02/2019
  9518 00003093 8987[6A70]              	mov	[bx+ldd_start], ax ; start of (next) LDD (partition)
  9519 00003097 8997[6C70]              	mov	[bx+ldd_start+2], dx
  9520                                  
  9521                                  	; 03/03/2019
  9522                                  	; set partition size for logical dos drive
  9523 0000309B 8B0C                    	mov	cx, [si]
  9524 0000309D 898F[7A70]              	mov	[bx+ldd_size], cx
  9525 000030A1 8B4C02                  	mov	cx, [si+2]
  9526 000030A4 898F[7C70]              	mov	[bx+ldd_size+2], cx
  9527                                  
  9528 000030A8 BB[146D]                	mov	bx, ebr_buffer
  9529                                  	; dx:ax = Extended partition address
  9530                                  	; es:bx = Extended partition buffer
  9531 000030AB E8DFEA                  	call	read_hd_sector
  9532 000030AE 720B                    	jc	short iept_3 ; 03/03/2019
  9533                                  
  9534                                  	; Check EBR if it is valid or not
  9535 000030B0 813E[126F]55AA          	cmp	word [ebr_buffer+510], 0AA55h
  9536 000030B6 0F845DFF                	je	iept_1
  9537                                  
  9538 000030BA F9                      	stc
  9539                                  iept_3:	
  9540 000030BB C3                      	retn
  9541                                  
  9542                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9543                                  ; delete logical -dos- drives in extended partition
  9544                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9545                                  ; 18/10/2020 (fdisk3.s)
  9546                                  
  9547                                  delete_logical_drives:
  9548                                  		; 27/02/2019 (hdimage.s)
  9549                                  
  9550                                  ; Delete Method: ; 04/03/2019
  9551                                  ;LDD 5 <- LDD_START3, ebr 2nd entry
  9552                                  ;LDD 4 <- LDD_START2, ebr 2nd entry
  9553                                  ;LDD 3 <- LDD_START1, ebr 2nd entry
  9554                                  ;LDD 2 <- LDD_START0, ebr 2nd entry
  9555                                  ;LDD 1 <- LDD_START0, ebr 1st entry
  9556                                  
  9557                                  	;cmp	byte [ldrives], 0
  9558                                  	;jna	short dld_stc
  9559                                  
  9560                                  	;mov	al, 5 ; extended partition (logical drives)
  9561                                  	;call	display_partition_table
  9562                                  	; 12/03/2021
  9563 000030BC E814F7                  	call	display_partition_table_x
  9564                                  
  9565 000030BF A0[0E6D]                	mov	al, [ldrives]
  9566 000030C2 0430                    	add	al, '0'
  9567 000030C4 A2[E95F]                	mov	[lddp_num], al
  9568                                  
  9569 000030C7 BE[965F]                	mov	si, msg_delete_ldd
  9570 000030CA E8B1EA                  	call	print_msg
  9571                                  
  9572 000030CD BE[E24D]                	mov	si, msg_press_esc_to_cancel
  9573 000030D0 E8ABEA                  	call	print_msg
  9574                                  dld_0:
  9575 000030D3 30E4                    	xor	ah, ah
  9576 000030D5 CD16                    	int	16h
  9577                                  
  9578 000030D7 80FC53                  	cmp	ah, 53h  ; DELETE or DEL key
  9579 000030DA 751C                    	jne	short dld_1
  9580                                  
  9581                                  	; Delete PTE 1 & PTE 2 on EBR 1
  9582 000030DC 30E4                    	xor	ah, ah
  9583 000030DE A0[0E6D]                	mov	al, [ldrives]
  9584 000030E1 FEC8                    	dec	al
  9585 000030E3 7518                    	jnz	short dld_2
  9586                                  
  9587 000030E5 BF[D26E]                	mov	di, ebr_buffer+446
  9588 000030E8 B91000                  	mov	cx, 16
  9589 000030EB F3AB                    	rep	stosw
  9590                                  
  9591                                  	; 04/03/2019
  9592                                  	; Clear ldd data in extended partition table/structure
  9593 000030ED BF[CC6F]                	mov	di, ext_table_boot_ind
  9594 000030F0 B109                    	mov	cl, 9
  9595 000030F2 F3AB                    	rep	stosw
  9596 000030F4 31F6                    	xor	si, si
  9597 000030F6 EB40                    	jmp	short dld_3
  9598                                  dld_1:	
  9599 000030F8 3C1B                    	cmp	al, 27 ; ESC key
  9600 000030FA 75D7                    	jne	short dld_0
  9601                                  dld_5:
  9602 000030FC C3                      	retn
  9603                                  
  9604                                  ;dld_stc:
  9605                                  ;	stc
  9606                                  ;	retn	
  9607                                  
  9608                                  dld_2:
  9609                                  	; 04/03/2019
  9610                                  	; Delete 2nd PTE on EBR 2 to 4
  9611 000030FD FEC8                    	dec	al 
  9612 000030FF C0E002                  	shl	al, 2 ; * 4
  9613 00003102 89C6                    	mov	si, ax
  9614                                  
  9615 00003104 8B84[6A70]              	mov	ax, [si+ldd_start]
  9616 00003108 8B94[6C70]              	mov	dx, [si+ldd_start+2]
  9617 0000310C BB[146D]                	mov	bx, ebr_buffer
  9618 0000310F E87BEA                  	call	read_hd_sector
  9619 00003112 7238                    	jc	short dld_4
  9620                                  
  9621 00003114 BF[E26E]                	mov	di, ebr_buffer+446+16
  9622 00003117 B90800                  	mov	cx, 8
  9623 0000311A 29C0                    	sub	ax, ax
  9624 0000311C F3AB                    	rep	stosw
  9625                                  
  9626                                  	; 04/03/2019
  9627                                  	;cmp	byte [ldrives], 5
  9628                                  	;jnb	short dld_3
  9629 0000311E 8A26[0E6D]              	mov	ah, [ldrives]
  9630 00003122 80FC05                  	cmp	ah, 5
  9631 00003125 7311                    	jnb	short dld_3
  9632                                  
  9633                                  	; Clear ldd data in extended partition table/structure
  9634                                  	;mov	ah, [ldrives]
  9635 00003127 FECC                    	dec	ah
  9636 00003129 B012                    	mov	al, 18
  9637 0000312B F6E4                    	mul	ah
  9638 0000312D BF[CC6F]                	mov	di, ext_table_boot_ind
  9639 00003130 01C7                    	add	di, ax
  9640                                  	;mov	cx, 9
  9641 00003132 B109                    	mov	cl, 9
  9642                                  	;xor	ax, ax
  9643 00003134 30C0                    	xor	al, al
  9644 00003136 F3AB                    	rep	stosw
  9645                                  dld_3:
  9646                                  	; Write changed EBR
  9647 00003138 8B84[6A70]              	mov	ax, [si+ldd_start]
  9648 0000313C 8B94[6C70]              	mov	dx, [si+ldd_start+2]
  9649 00003140 BB[146D]                	mov	bx, ebr_buffer
  9650 00003143 E89DEA                  	call	write_hd_sector
  9651 00003146 7204                    	jc	short dld_4
  9652                                  
  9653                                  	; 28/02/2019
  9654 00003148 FE0E[0E6D]              	dec	byte [ldrives]
  9655                                  dld_4:
  9656 0000314C 803E[0E6D]00            	cmp	byte [ldrives], 0
  9657 00003151 0F8767FF                	ja	delete_logical_drives
  9658                                  
  9659 00003155 C3                      	retn
  9660                                  
  9661                                  ;=============================================================================
  9662                                  ;        	initialized data
  9663                                  ;=============================================================================
  9664                                  
  9665                                  ; 12/10/2020
  9666 00003156 00                      int13h_x:	db	0
  9667                                  
  9668                                  TRDOS386_MASTERBOOT_SECTOR:
  9669 00003157 <bin 200h>              	incbin	'FS1_MBR.BIN' ; Singlix FS1 MBR
  9670                                  
  9671                                  TRDOS_FAT_hd_bs:
  9672                                  	;incbin 'TRHDBS.BIN'
  9673                                  	; 04/05/2024
  9674                                  TRDOS_FAT32_hd_bs:
  9675                                  	;incbin	'FAT32_BS.BIN' ; 27/04/2024
  9676 00003357 <bin 400h>              	incbin	'RD5HDBS3.BIN' ; 29/04/2024
  9677                                  TRDOS_FAT16_hd_bs: 
  9678                                  	;incbin	'FAT16_BS.BIN' ; 26/12/2017
  9679 00003757 <bin 200h>              	incbin	'RD5HDBS2.BIN' ; 20/04/2024
  9680                                  TRDOS_FAT12_hd_bs: 
  9681                                  	;incbin	'FAT12_BS.BIN' ; 26/12/2017
  9682 00003957 <bin 200h>              	incbin	'RD5HDBS1.BIN' ; 20/04/2024
  9683                                  
  9684                                  TRDOS_TRFS1_chs_bs:
  9685 00003B57 <bin 200h>              	incbin	'TRFS1CHS.BIN' ; Singlix FS1 (CHS+LBA Disk) BS
  9686                                  TRDOS_TRFS1_lba_bs:
  9687 00003D57 <bin 200h>              	incbin	'TRFS1LBA.BIN' ; Singlix FS1 (LBA Disk) BS
  9688                                  
  9689 00003F57 00                      	db	0
  9690                                  
  9691                                  hexchrs:
  9692 00003F58 303132333435363738-     	db	'0123456789ABCDEF'
  9692 00003F61 39414243444546     
  9693                                  
  9694                                  ; 05/11/2020
  9695 00003F68 00                      	db	0
  9696                                  
  9697 00003F69 90                      align 2
  9698                                  
  9699                                  ; (TR-DOS 386 compatible) Hard Disk (image) parameters
  9700                                  
  9701                                  sectors: ; sectors per track (63)
  9702 00003F6A 3F00                    	dw 63
  9703                                  heads:	 ; number of heads (16 or 32 or 64) 
  9704 00003F6C 1000                    	dw 16
  9705                                  cylinders: ; number of cylinders (16 to 1024)
  9706 00003F6E 0004                    	dw 1024
  9707 00003F70 0000                    	dw 0 ; 16/10/2020 (double word)
  9708                                  
  9709                                  ; 05/11/2020
  9710                                  
  9711                                  ;random:
  9712                                  ;	db 0  ; random write to file (0 = sequental)
  9713                                  ;newdisk:
  9714                                  ;	db 0
  9715                                  
  9716                                  FileSys_Names: ; 2003-2017
  9717                                  ; (Valid FileSystems for TRDOS 386, SINGLIX, RETRO UNIX OS projects in 2017)
  9718 00003F72 464154313220202020-     FS_FAT12:     db "FAT12         "  ; 01h = FAT12
  9718 00003F7B 2020202020         
  9719 00003F80 58454E495820202020-     FS_XENIX:     db "XENIX         "  ; 02h , XENIX System V root
  9719 00003F89 2020202020         
  9720 00003F8E 58454E495820757372-     FS_XENIX_USR: db "XENIX usr     "  ; 03h , XENIX System V user
  9720 00003F97 2020202020         
  9721 00003F9C 464154313620283034-     FS_FAT16:     db "FAT16 (04h)   "  ; 04h = FAT16 < 32MB
  9721 00003FA5 6829202020         
  9722 00003FAA 455854454E44454420-     FS_EXT_CHS:   db "EXTENDED (CHS)"  ; 05h = Extended DOS Partition
  9722 00003FB3 2843485329         
  9723 00003FB8 464154313620283036-     FS_FAT16_BIG: db "FAT16 (06h)   "  ; 06h = FAT16 > 32MB, CHS mode
  9723 00003FC1 6829202020         
  9724 00003FC6 4E5446532020202020-     FS_NTFS:      db "NTFS          "  ; 07h , WINDOWS NTFS Partition
  9724 00003FCF 2020202020         
  9725 00003FD4 464154333220284348-     FS_FAT32_CHS: db "FAT32 (CHS)   "  ; 0Bh = FAT32, CHS mode
  9725 00003FDD 5329202020         
  9726 00003FE2 464154333220284C42-     FS_FAT32_LBA: db "FAT32 (LBA)   "  ; 0Ch = FAT32, LBA mode
  9726 00003FEB 4129202020         
  9727 00003FF0 464154313620284C42-     FS_FAT16_LBA: db "FAT16 (LBA)   "  ; 0Eh = FAT16, LBA mode
  9727 00003FF9 4129202020         
  9728 00003FFE 455854454E44454420-     FS_EXT_LBA:   db "EXTENDED (LBA)"  ; 0Fh = Extented Partition, LBA mode
  9728 00004007 284C424129         
  9729 0000400C 554E49582053595354-     FS_UNIX_SYSV: db "UNIX SYSTEM V "  ; 63h , SCO UNIX, UNIXWARE, OPENSERVER
  9729 00004015 454D205620         
  9730 0000401A 524554524F20554E49-     FS_RETROUNIX: db "RETRO UNIX    "  ; 71h , Retro UNIX 386 v2 Partition
  9730 00004023 5820202020         
  9731 00004028 554E49582056372020-     FS_UNIX_V7:   db "UNIX V7       "  ; 72h , UNIX v7 x86 Partition  
  9731 00004031 2020202020         
  9732 00004036 4C494E555820535741-     FS_LINUXSWAP: db "LINUX SWAP    "  ; 82h , LINUX SWAP Partition
  9732 0000403F 5020202020         
  9733 00004044 4C494E555820202020-     FS_LINUX:     db "LINUX         "  ; 83h , LINUX NATIVE (ext2) Partition
  9733 0000404D 2020202020         
  9734 00004052 4C494E555820455854-     FS_LINUXEXT:  db "LINUX EXTENDED"  ; 85h , LINUX EXTENDED Partition
  9734 0000405B 454E444544         
  9735 00004060 524444202020202020-     FS_TRDD:      db "RDD           "  ; A0h , (Random Data Disk) LBA
  9735 00004069 2020202020         
  9736 0000406E 53494E474C49582046-     FS_TRFS:      db "SINGLIX FS1   "  ; A1h , (32 bit, 512 bytes per sector)
  9736 00004077 5331202020         
  9737 0000407C 554E4B4E4F574E2046-     FS_OTHERS:    db "UNKNOWN FS    "  ; Another or Unknown File Systems
  9737 00004085 5320202020         
  9738                                   
  9739                                  valid_partitions: ; (*)
  9740 0000408A 01020304050607          	      db 01h, 02h, 03h, 04h, 05h, 06h, 07h
  9741 00004091 0B0C0E0F637172          	      db 0Bh, 0Ch, 0Eh, 0Fh, 63h, 71h, 72h
  9742 00004098 828385A0A1              	      db 82h, 83h, 85h, 0A0h, 0A1h
  9743                                  
  9744                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9745                                  ;  messages
  9746                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9747                                  
  9748                                  CHS_msg: ; 80 bytes per row
  9749 0000409D 507265737320274327-     db  "Press 'C' to set cylinders then press '+,-' keys to change number of cylinders. "
  9749 000040A6 20746F207365742063-
  9749 000040AF 796C696E6465727320-
  9749 000040B8 7468656E2070726573-
  9749 000040C1 7320272B2C2D27206B-
  9749 000040CA 65797320746F206368-
  9749 000040D3 616E6765206E756D62-
  9749 000040DC 6572206F662063796C-
  9749 000040E5 696E646572732E20   
  9750 000040ED 507265737320274827-     db  "Press 'H' to set heads then press '+,-' keys to change number of heads.         "
  9750 000040F6 20746F207365742068-
  9750 000040FF 65616473207468656E-
  9750 00004108 20707265737320272B-
  9750 00004111 2C2D27206B65797320-
  9750 0000411A 746F206368616E6765-
  9750 00004123 206E756D626572206F-
  9750 0000412C 662068656164732E20-
  9750 00004135 2020202020202020   
  9751 0000413D 507265737320275327-     db  "Press 'S' to set sectors then press '+,-' keys to change numb of sectors/track. "
  9751 00004146 20746F207365742073-
  9751 0000414F 6563746F7273207468-
  9751 00004158 656E20707265737320-
  9751 00004161 272B2C2D27206B6579-
  9751 0000416A 7320746F206368616E-
  9751 00004173 6765206E756D62206F-
  9751 0000417C 6620736563746F7273-
  9751 00004185 2F747261636B2E20   
  9752 0000418D 202020202020202020-     db  "                                                                                "
  9752 00004196 202020202020202020-
  9752 0000419F 202020202020202020-
  9752 000041A8 202020202020202020-
  9752 000041B1 202020202020202020-
  9752 000041BA 202020202020202020-
  9752 000041C3 202020202020202020-
  9752 000041CC 202020202020202020-
  9752 000041D5 2020202020202020   
  9753 000041DD 202020202020202020-     db  "                                                                                "
  9753 000041E6 202020202020202020-
  9753 000041EF 202020202020202020-
  9753 000041F8 202020202020202020-
  9753 00004201 202020202020202020-
  9753 0000420A 202020202020202020-
  9753 00004213 202020202020202020-
  9753 0000421C 202020202020202020-
  9753 00004225 2020202020202020   
  9754 0000422D 507265737320454E54-     db  "Press ENTER to use current CHS values.                                          "
  9754 00004236 455220746F20757365-
  9754 0000423F 2063757272656E7420-
  9754 00004248 4348532076616C7565-
  9754 00004251 732E20202020202020-
  9754 0000425A 202020202020202020-
  9754 00004263 202020202020202020-
  9754 0000426C 202020202020202020-
  9754 00004275 2020202020202020   
  9755 0000427D 202020202020202020-     db  "                                                                                "
  9755 00004286 202020202020202020-
  9755 0000428F 202020202020202020-
  9755 00004298 202020202020202020-
  9755 000042A1 202020202020202020-
  9755 000042AA 202020202020202020-
  9755 000042B3 202020202020202020-
  9755 000042BC 202020202020202020-
  9755 000042C5 2020202020202020   
  9756 000042CD 507265737320455343-     db  "Press ESC to cancel.                                                            "
  9756 000042D6 20746F2063616E6365-
  9756 000042DF 6C2E20202020202020-
  9756 000042E8 202020202020202020-
  9756 000042F1 202020202020202020-
  9756 000042FA 202020202020202020-
  9756 00004303 202020202020202020-
  9756 0000430C 202020202020202020-
  9756 00004315 2020202020202020   
  9757 0000431D 202020202020202020-     db  "                                                                                "
  9757 00004326 202020202020202020-
  9757 0000432F 202020202020202020-
  9757 00004338 202020202020202020-
  9757 00004341 202020202020202020-
  9757 0000434A 202020202020202020-
  9757 00004353 202020202020202020-
  9757 0000435C 202020202020202020-
  9757 00004365 2020202020202020   
  9758 0000436D 00                      db  0
  9759                                  
  9760                                  	; 04/05/2024
  9761                                  TrDOS_Welcome:
  9762 0000436E 0D0A                    	db	0Dh, 0Ah
  9763                                  	;db	'TR-DOS 386 Fixed Disk Partitioning Utility'
  9764 00004370 526574726F20444F53-     	db	'Retro DOS v5 Fixed Disk Partitioning Utility'
  9764 00004379 207635204669786564-
  9764 00004382 204469736B20506172-
  9764 0000438B 746974696F6E696E67-
  9764 00004394 205574696C697479   
  9765 0000439C 0D0A                    	db	0Dh, 0Ah
  9766                                  	;db	"v1.1.240504 (c) Erdogan TAN 2021-2024"
  9767 0000439E 464449534B33207632-     	db	"FDISK3 v2.0.240504 (c) Erdogan TAN 2021-2024"
  9767 000043A7 2E302E323430353034-
  9767 000043B0 20286329204572646F-
  9767 000043B9 67616E2054414E2032-
  9767 000043C2 3032312D32303234   
  9768 000043CA 0D0A                    	db	0Dh,0Ah
  9769 000043CC 0D0A                    	db	0Dh,0Ah
  9770 000043CE 00                      	db	0
  9771                                  TrDOS_Usage:
  9772 000043CF 55736167653A206664-     	db	'Usage: fdisk3r5 <hard disk name> '
  9772 000043D8 69736B337235203C68-
  9772 000043E1 617264206469736B20-
  9772 000043EA 6E616D653E20       
  9773 000043F0 0D0A                    	db	0Dh, 0Ah
  9774 000043F2 0D0A                    	db	0Dh, 0Ah
  9775 000043F4 48617264206469736B-     	db	"Hard disk names: "
  9775 000043FD 206E616D65733A20   
  9776 00004405 0D0A                    	db	0Dh, 0Ah
  9777 00004407 0D0A                    	db	0Dh, 0Ah
  9778 00004409 20686430202E2E666F-     	db	" hd0 ..for 1st hard disk "
  9778 00004412 722031737420686172-
  9778 0000441B 64206469736B20     
  9779 00004422 0D0A                    	db	0Dh, 0Ah
  9780 00004424 20686431202E2E666F-     	db	" hd1 ..for 2nd hard disk "
  9780 0000442D 7220326E6420686172-
  9780 00004436 64206469736B20     
  9781 0000443D 0D0A                    	db	0Dh, 0Ah
  9782 0000443F 20686432202E2E666F-     	db	" hd2 ..for 3rd hard disk "
  9782 00004448 722033726420686172-
  9782 00004451 64206469736B20     
  9783 00004458 0D0A                    	db	0Dh, 0Ah
  9784 0000445A 20686433202E2E666F-     	db	" hd3 ..for 4th hard disk "
  9784 00004463 722034746820686172-
  9784 0000446C 64206469736B20     
  9785 00004473 0D0A00                  	db	0Dh, 0Ah, 0
  9786                                  
  9787                                  TrDOS_Options:
  9788 00004476 53656C656374206861-     	db	"Select hard disk number (1 to "
  9788 0000447F 7264206469736B206E-
  9788 00004488 756D62657220283120-
  9788 00004491 746F20             
  9789                                  TrDOS_dnmax:
  9790 00004494 3429206F7220707265-     	db	"4) or press ESC to exit ..."
  9790 0000449D 73732045534320746F-
  9790 000044A6 2065786974202E2E2E 
  9791 000044AF 0D0A00                  	db	0Dh, 0Ah, 0
  9792                                  TrDOS_hdrow:
  9793 000044B2 0D0A                    	db	0Dh, 0Ah 
  9794 000044B4 28                      	db	"("
  9795                                  TrDOS_hdrow_n:
  9796 000044B5 3029206864              	db	"0) hd"
  9797                                  TrDOS_hdrow_i:
  9798 000044BA 30202D204361706163-     	db	"0 - Capacity : "
  9798 000044C3 697479203A20       
  9799 000044C9 00                      	db	0
  9800                                  TrDOS_hdrow_unit:
  9801 000044CA 474220                  	db	"GB "
  9802 000044CD 0D0A00                  	db 	0Dh, 0Ah, 0
  9803                                  
  9804                                  TrDOS_hdrow_capacity:
  9805 000044D0 303030302000            	db	"0000 ", 0
  9806 000044D6 00                      	db	0
  9807                                  
  9808                                  TrDOS_disksize:
  9809 000044D7 0D0A                    	db	0Dh, 0Ah
  9810 000044D9 4469736B2073697A65-     	db	"Disk size : "
  9810 000044E2 203A20             
  9811 000044E5 00                      	db	0
  9812                                  
  9813                                  msg_fdisk_capacity_err:
  9814 000044E6 0D0A                    	db	0Dh, 0Ah
  9815 000044E8 48756765206469736B-     	db	"Huge disk !"
  9815 000044F1 2021               
  9816 000044F3 0D0A                    	db	0Dh, 0Ah
  9817 000044F5 546869732046444953-     	db	"This FDISK version (v3) can work with disk sizes up to "
  9817 000044FE 4B2076657273696F6E-
  9817 00004507 20287633292063616E-
  9817 00004510 20776F726B20776974-
  9817 00004519 68206469736B207369-
  9817 00004522 7A657320757020746F-
  9817 0000452B 20                 
  9818 0000452C 00                      	db	0
  9819                                  
  9820                                  msg_any_key_esc_exit:
  9821 0000452D 0D0A                    	db	0Dh, 0Ah
  9822 0000452F 507265737320455343-     	db	"Press ESC to exit or press another key to continue..."
  9822 00004538 20746F206578697420-
  9822 00004541 6F7220707265737320-
  9822 0000454A 616E6F74686572206B-
  9822 00004553 657920746F20636F6E-
  9822 0000455C 74696E75652E2E2E   
  9823 00004564 00                      	db	0
  9824                                  
  9825                                  msg_create_partition_h:
  9826 00004565 0D0A                    	db	0Dh, 0Ah
  9827 00004567 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9827 00004570 2D2D2D2D2D2D2D2D2D-
  9827 00004579 2D2D2D2D2D2D2D2D2D-
  9827 00004582 2D2D2D2D2D2D2D2D2D-
  9827 0000458B 2D2D2D2D2D2D2D2D2D-
  9827 00004594 2D2D2D2D2D2D2D2D2D-
  9827 0000459D 2D2D2D2D2D2D2D2D2D-
  9827 000045A6 2D2D2D2D2D2D2D2D2D-
  9827 000045AF 2D2D2D2D2D2D2D2D   
  9828 000045B7 202020202020202020-     	db	"                               Create Partition                                 "
  9828 000045C0 202020202020202020-
  9828 000045C9 202020202020202020-
  9828 000045D2 202020204372656174-
  9828 000045DB 652050617274697469-
  9828 000045E4 6F6E20202020202020-
  9828 000045ED 202020202020202020-
  9828 000045F6 202020202020202020-
  9828 000045FF 2020202020202020   
  9829 00004607 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  9829 00004610 2D2D2D2D2D2D2D2D2D-
  9829 00004619 2D2D2D2D2D2D2D2D2D-
  9829 00004622 2D2D2D2D2D2D2D2D2D-
  9829 0000462B 2D2D2D2D2D2D2D2D2D-
  9829 00004634 2D2D2D2D2D2D2D2D2D-
  9829 0000463D 2D2D2D2D2D2D2D2D2D-
  9829 00004646 2D2D2D2D2D2D2D2D2D-
  9829 0000464F 2D2D2D2D2D2D2D2D   
  9830 00004657 0D0A00                  	db	0Dh, 0Ah, 0
  9831                                  msg_create_partition_m:
  9832 0000465A 53656C65637420616E-     	db	"Select an option: "
  9832 00004663 206F7074696F6E3A20 
  9833 0000466C 0D0A                    	db	0Dh, 0Ah
  9834 0000466E 0D0A                    	db	0Dh, 0Ah
  9835 00004670 202031292043726561-     	db	"  1) Create DOS partition ", 0Dh, 0Ah
  9835 00004679 746520444F53207061-
  9835 00004682 72746974696F6E200D-
  9835 0000468B 0A                 
  9836 0000468C 202032292043726561-     	db	"  2) Create SINGLIX FS partition ", 0Dh, 0Ah
  9836 00004695 74652053494E474C49-
  9836 0000469E 582046532070617274-
  9836 000046A7 6974696F6E200D0A   
  9837 000046AF 202033292043726561-     	db	"  3) Create RETRO UNIX partition ", 0Dh, 0Ah
  9837 000046B8 746520524554524F20-
  9837 000046C1 554E49582070617274-
  9837 000046CA 6974696F6E200D0A   
  9838 000046D2 202034292043726561-     	db	"  4) Create another type of partition ", 0Dh, 0Ah
  9838 000046DB 746520616E6F746865-
  9838 000046E4 722074797065206F66-
  9838 000046ED 20706172746974696F-
  9838 000046F6 6E200D0A           
  9839 000046FA 0D0A                    	db	0Dh, 0Ah
  9840 000046FC 507265737320455343-     	db	"Press ESC or 0 to cancel .. "
  9840 00004705 206F72203020746F20-
  9840 0000470E 63616E63656C202E2E-
  9840 00004717 20                 
  9841 00004718 0D0A00                   	db 	0Dh, 0Ah, 0
  9842                                  
  9843                                  msg_create_primary_partition_h:
  9844 0000471B 0D0A                    	db	0Dh, 0Ah
  9845 0000471D 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9845 00004726 2D2D2D2D2D2D2D2D2D-
  9845 0000472F 2D2D2D2D2D2D2D2D2D-
  9845 00004738 2D2D2D2D2D2D2D2D2D-
  9845 00004741 2D2D2D2D2D2D2D2D2D-
  9845 0000474A 2D2D2D2D2D2D2D2D2D-
  9845 00004753 2D2D2D2D2D2D2D2D2D-
  9845 0000475C 2D2D2D2D2D2D2D2D2D-
  9845 00004765 2D2D2D2D2D2D2D2D   
  9846 0000476D 202020202020202020-     	db	"                          Create Primary DOS Partition                          "
  9846 00004776 202020202020202020-
  9846 0000477F 202020202020202043-
  9846 00004788 726561746520507269-
  9846 00004791 6D61727920444F5320-
  9846 0000479A 506172746974696F6E-
  9846 000047A3 202020202020202020-
  9846 000047AC 202020202020202020-
  9846 000047B5 2020202020202020   
  9847 000047BD 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  9847 000047C6 2D2D2D2D2D2D2D2D2D-
  9847 000047CF 2D2D2D2D2D2D2D2D2D-
  9847 000047D8 2D2D2D2D2D2D2D2D2D-
  9847 000047E1 2D2D2D2D2D2D2D2D2D-
  9847 000047EA 2D2D2D2D2D2D2D2D2D-
  9847 000047F3 2D2D2D2D2D2D2D2D2D-
  9847 000047FC 2D2D2D2D2D2D2D2D2D-
  9847 00004805 2D2D2D2D2D2D2D2D   
  9848 0000480D 0D0A00                  	db	0Dh, 0Ah, 0
  9849                                  
  9850                                  msg_create_dos_partition_h:
  9851 00004810 0D0A                    	db	0Dh, 0Ah
  9852 00004812 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9852 0000481B 2D2D2D2D2D2D2D2D2D-
  9852 00004824 2D2D2D2D2D2D2D2D2D-
  9852 0000482D 2D2D2D2D2D2D2D2D2D-
  9852 00004836 2D2D2D2D2D2D2D2D2D-
  9852 0000483F 2D2D2D2D2D2D2D2D2D-
  9852 00004848 2D2D2D2D2D2D2D2D2D-
  9852 00004851 2D2D2D2D2D2D2D2D2D-
  9852 0000485A 2D2D2D2D2D2D2D2D   
  9853 00004862 202020202020202020-     	db	"                   Create DOS Partition or Logical DOS Drive                    "
  9853 0000486B 202020202020202020-
  9853 00004874 204372656174652044-
  9853 0000487D 4F5320506172746974-
  9853 00004886 696F6E206F72204C6F-
  9853 0000488F 676963616C20444F53-
  9853 00004898 204472697665202020-
  9853 000048A1 202020202020202020-
  9853 000048AA 2020202020202020   
  9854 000048B2 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  9854 000048BB 2D2D2D2D2D2D2D2D2D-
  9854 000048C4 2D2D2D2D2D2D2D2D2D-
  9854 000048CD 2D2D2D2D2D2D2D2D2D-
  9854 000048D6 2D2D2D2D2D2D2D2D2D-
  9854 000048DF 2D2D2D2D2D2D2D2D2D-
  9854 000048E8 2D2D2D2D2D2D2D2D2D-
  9854 000048F1 2D2D2D2D2D2D2D2D2D-
  9854 000048FA 2D2D2D2D2D2D2D2D   
  9855 00004902 0D0A00                  	db	0Dh, 0Ah, 0
  9856                                  
  9857                                  msg_create_ext_partition_h:
  9858 00004905 0D0A                    	db	0Dh, 0Ah
  9859 00004907 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9859 00004910 2D2D2D2D2D2D2D2D2D-
  9859 00004919 2D2D2D2D2D2D2D2D2D-
  9859 00004922 2D2D2D2D2D2D2D2D2D-
  9859 0000492B 2D2D2D2D2D2D2D2D2D-
  9859 00004934 2D2D2D2D2D2D2D2D2D-
  9859 0000493D 2D2D2D2D2D2D2D2D2D-
  9859 00004946 2D2D2D2D2D2D2D2D2D-
  9859 0000494F 2D2D2D2D2D2D2D2D   
  9860 00004957 202020202020202020-     	db	"                         Create Extended DOS Partition                          "
  9860 00004960 202020202020202020-
  9860 00004969 202020202020204372-
  9860 00004972 656174652045787465-
  9860 0000497B 6E64656420444F5320-
  9860 00004984 506172746974696F6E-
  9860 0000498D 202020202020202020-
  9860 00004996 202020202020202020-
  9860 0000499F 2020202020202020   
  9861 000049A7 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  9861 000049B0 2D2D2D2D2D2D2D2D2D-
  9861 000049B9 2D2D2D2D2D2D2D2D2D-
  9861 000049C2 2D2D2D2D2D2D2D2D2D-
  9861 000049CB 2D2D2D2D2D2D2D2D2D-
  9861 000049D4 2D2D2D2D2D2D2D2D2D-
  9861 000049DD 2D2D2D2D2D2D2D2D2D-
  9861 000049E6 2D2D2D2D2D2D2D2D2D-
  9861 000049EF 2D2D2D2D2D2D2D2D   
  9862 000049F7 0D0A00                  	db	0Dh, 0Ah, 0
  9863                                  
  9864                                  msg_create_logical_drive_h:
  9865 000049FA 0D0A                    	db	0Dh, 0Ah
  9866 000049FC 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9866 00004A05 2D2D2D2D2D2D2D2D2D-
  9866 00004A0E 2D2D2D2D2D2D2D2D2D-
  9866 00004A17 2D2D2D2D2D2D2D2D2D-
  9866 00004A20 2D2D2D2D2D2D2D2D2D-
  9866 00004A29 2D2D2D2D2D2D2D2D2D-
  9866 00004A32 2D2D2D2D2D2D2D2D2D-
  9866 00004A3B 2D2D2D2D2D2D2D2D2D-
  9866 00004A44 2D2D2D2D2D2D2D2D   
  9867 00004A4C 202020202020202020-     	db	"                            Create Logical DOS Drive                            "
  9867 00004A55 202020202020202020-
  9867 00004A5E 202020202020202020-
  9867 00004A67 20437265617465204C-
  9867 00004A70 6F676963616C20444F-
  9867 00004A79 532044726976652020-
  9867 00004A82 202020202020202020-
  9867 00004A8B 202020202020202020-
  9867 00004A94 2020202020202020   
  9868 00004A9C 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  9868 00004AA5 2D2D2D2D2D2D2D2D2D-
  9868 00004AAE 2D2D2D2D2D2D2D2D2D-
  9868 00004AB7 2D2D2D2D2D2D2D2D2D-
  9868 00004AC0 2D2D2D2D2D2D2D2D2D-
  9868 00004AC9 2D2D2D2D2D2D2D2D2D-
  9868 00004AD2 2D2D2D2D2D2D2D2D2D-
  9868 00004ADB 2D2D2D2D2D2D2D2D2D-
  9868 00004AE4 2D2D2D2D2D2D2D2D   
  9869 00004AEC 0D0A00                  	db	0Dh, 0Ah, 0
  9870                                  
  9871                                  msg_create_nondos_partition_h:
  9872 00004AEF 0D0A                    	db	0Dh, 0Ah
  9873 00004AF1 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9873 00004AFA 2D2D2D2D2D2D2D2D2D-
  9873 00004B03 2D2D2D2D2D2D2D2D2D-
  9873 00004B0C 2D2D2D2D2D2D2D2D2D-
  9873 00004B15 2D2D2D2D2D2D2D2D2D-
  9873 00004B1E 2D2D2D2D2D2D2D2D2D-
  9873 00004B27 2D2D2D2D2D2D2D2D2D-
  9873 00004B30 2D2D2D2D2D2D2D2D2D-
  9873 00004B39 2D2D2D2D2D2D2D2D   
  9874 00004B41 202020202020202020-     	db	"                            Create NON-DOS Partition                            "
  9874 00004B4A 202020202020202020-
  9874 00004B53 202020202020202020-
  9874 00004B5C 20437265617465204E-
  9874 00004B65 4F4E2D444F53205061-
  9874 00004B6E 72746974696F6E2020-
  9874 00004B77 202020202020202020-
  9874 00004B80 202020202020202020-
  9874 00004B89 2020202020202020   
  9875 00004B91 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  9875 00004B9A 2D2D2D2D2D2D2D2D2D-
  9875 00004BA3 2D2D2D2D2D2D2D2D2D-
  9875 00004BAC 2D2D2D2D2D2D2D2D2D-
  9875 00004BB5 2D2D2D2D2D2D2D2D2D-
  9875 00004BBE 2D2D2D2D2D2D2D2D2D-
  9875 00004BC7 2D2D2D2D2D2D2D2D2D-
  9875 00004BD0 2D2D2D2D2D2D2D2D2D-
  9875 00004BD9 2D2D2D2D2D2D2D2D   
  9876 00004BE1 0D0A00                  	db	0Dh, 0Ah, 0
  9877                                  
  9878                                  msg_create_dos_partition_m:
  9879 00004BE4 53656C65637420616E-     	db	"Select an option: "
  9879 00004BED 206F7074696F6E3A20 
  9880 00004BF6 0D0A                    	db	0Dh, 0Ah
  9881 00004BF8 0D0A                    	db	0Dh, 0Ah
  9882 00004BFA 202031292043726561-     	db	"  1) Create Primary DOS partition ", 0Dh, 0Ah
  9882 00004C03 7465205072696D6172-
  9882 00004C0C 7920444F5320706172-
  9882 00004C15 746974696F6E200D0A 
  9883 00004C1E 202032292043726561-     	db	"  2) Create Extended DOS partition ", 0Dh, 0Ah
  9883 00004C27 746520457874656E64-
  9883 00004C30 656420444F53207061-
  9883 00004C39 72746974696F6E200D-
  9883 00004C42 0A                 
  9884 00004C43 202033292043726561-     	db	"  3) Create Logical DOS drive(s) in Extended DOS partition ", 0Dh, 0Ah
  9884 00004C4C 7465204C6F67696361-
  9884 00004C55 6C20444F5320647269-
  9884 00004C5E 766528732920696E20-
  9884 00004C67 457874656E64656420-
  9884 00004C70 444F53207061727469-
  9884 00004C79 74696F6E200D0A     
  9885 00004C80 0D0A                    	db	0Dh, 0Ah	
  9886 00004C82 507265737320455343-     	db	"Press ESC or 0 to cancel .. "
  9886 00004C8B 206F72203020746F20-
  9886 00004C94 63616E63656C202E2E-
  9886 00004C9D 20                 
  9887 00004C9E 0D0A00                   	db 	0Dh, 0Ah, 0
  9888                                  
  9889                                  msg_create_trdos_partition_s:
  9890 00004CA1 53656C65637420616E-     	db	"Select an option to set partition size: "
  9890 00004CAA 206F7074696F6E2074-
  9890 00004CB3 6F2073657420706172-
  9890 00004CBC 746974696F6E207369-
  9890 00004CC5 7A653A20           
  9891 00004CC9 0D0A                    	db	0Dh, 0Ah
  9892 00004CCB 0D0A                    	db	0Dh, 0Ah
  9893 00004CCD 202043292043796C69-     	db	"  C) Cylinder count", 0Dh, 0Ah   
  9893 00004CD6 6E64657220636F756E-
  9893 00004CDF 740D0A             
  9894 00004CE2 2020252920566F6C75-     	db	"  %) Volume percentage (##%)", 0Dh, 0Ah
  9894 00004CEB 6D652070657263656E-
  9894 00004CF4 746167652028232325-
  9894 00004CFD 290D0A             
  9895 00004D00 202053292053656374-     	db	"  S) Sectors (number of 512 bytes)", 0Dh, 0Ah
  9895 00004D09 6F727320286E756D62-
  9895 00004D12 6572206F6620353132-
  9895 00004D1B 206279746573290D0A 
  9896 00004D24 20204B29204B696C6F-     	db	"  K) Kilo bytes (KB, 2*K sectors)", 0Dh, 0Ah
  9896 00004D2D 20627974657320284B-
  9896 00004D36 422C20322A4B207365-
  9896 00004D3F 63746F7273290D0A   
  9897 00004D47 20204D29204D656761-     	db	"  M) Mega bytes (MB, 2*1024*M sectors)", 0Dh, 0Ah
  9897 00004D50 20627974657320284D-
  9897 00004D59 422C20322A31303234-
  9897 00004D62 2A4D20736563746F72-
  9897 00004D6B 73290D0A           
  9898 00004D6F 202047292047696761-     	db	"  G) Giga bytes (GB, 2*1024*1024*G sectors)", 0Dh, 0Ah
  9898 00004D78 206279746573202847-
  9898 00004D81 422C20322A31303234-
  9898 00004D8A 2A313032342A472073-
  9898 00004D93 6563746F7273290D0A 
  9899 00004D9C 0D0A                    	db	0Dh, 0Ah	
  9900 00004D9E 507265737320535041-     	db	"Press SPACE to use whole disk or press ENTER to set sector count .. "
  9900 00004DA7 434520746F20757365-
  9900 00004DB0 2077686F6C65206469-
  9900 00004DB9 736B206F7220707265-
  9900 00004DC2 737320454E54455220-
  9900 00004DCB 746F20736574207365-
  9900 00004DD4 63746F7220636F756E-
  9900 00004DDD 74202E2E20         
  9901                                  msg_press_esc_to_cancel:
  9902 00004DE2 0D0A                     	db	0Dh, 0Ah
  9903 00004DE4 285072657373204553-     	db	"(Press ESC to CANCEL) "
  9903 00004DED 4320746F2043414E43-
  9903 00004DF6 454C2920           
  9904 00004DFA 0D0A00                  	db 	0Dh, 0Ah, 0
  9905                                  
  9906                                  msg_use_whole_disk:
  9907 00004DFD 446F20796F75207761-     	db	"Do you want to use WHOLE disk !? (Y/N)", 0
  9907 00004E06 6E7420746F20757365-
  9907 00004E0F 2057484F4C45206469-
  9907 00004E18 736B20213F2028592F-
  9907 00004E21 4E2900             
  9908                                  
  9909                                  msg_use_all_space:
  9910 00004E24 446F20796F75207761-     	db	"Do you want to use all of available space !? (Y/N)", 0
  9910 00004E2D 6E7420746F20757365-
  9910 00004E36 20616C6C206F662061-
  9910 00004E3F 7661696C61626C6520-
  9910 00004E48 737061636520213F20-
  9910 00004E51 28592F4E2900       
  9911                                  
  9912                                  msg_use_entire_ep_space:
  9913 00004E57 446F20796F75207761-     	db	"Do you want to use entire extended partition space !? (Y/N)", 0
  9913 00004E60 6E7420746F20757365-
  9913 00004E69 20656E746972652065-
  9913 00004E72 7874656E6465642070-
  9913 00004E7B 6172746974696F6E20-
  9913 00004E84 737061636520213F20-
  9913 00004E8D 28592F4E2900       
  9914                                  
  9915                                  msg_partition_size:
  9916 00004E93 0D0A                    	db	0Dh, 0Ah
  9917 00004E95 0D0A                    	db	0Dh, 0Ah
  9918 00004E97 506172746974696F6E-     	db	"Partition size ("
  9918 00004EA0 2073697A652028     
  9919                                  msg_partition_size_x:
  9920 00004EA7 3F29203A20              	db	"?) : "
  9921 00004EAC 00                      	db	0
  9922                                  
  9923                                  msg_partition_type:
  9924 00004EAD 0D0A                    	db	0Dh, 0Ah
  9925 00004EAF 0D0A                    	db	0Dh, 0Ah
  9926 00004EB1 506172746974696F6E-     	db	"Partition type : "
  9926 00004EBA 2074797065203A20   
  9927 00004EC2 00                      	db	0
  9928                                  
  9929                                  msg_ptype_num:
  9930 00004EC3 3030680D0A00            	db	"00h", 0Dh, 0Ah, 0
  9931                                  
  9932                                  msg_partition_type_error:
  9933 00004EC9 506172746974696F6E-     	db	"Partition size is not proper for selected partition type !"
  9933 00004ED2 2073697A6520697320-
  9933 00004EDB 6E6F742070726F7065-
  9933 00004EE4 7220666F722073656C-
  9933 00004EED 656374656420706172-
  9933 00004EF6 746974696F6E207479-
  9933 00004EFF 70652021           
  9934 00004F03 0D0A                    	db	0Dh, 0Ah
  9935                                  msg_any_key_to_retry:
  9936 00004F05 28507265737320616E-     	db	"(Press any key to retry..)"
  9936 00004F0E 79206B657920746F20-
  9936 00004F17 72657472792E2E29   
  9937 00004F1F 0D0A00                  	db	0Dh, 0Ah, 0
  9938                                  
  9939                                  msg_partition_size_overs:
  9940 00004F22 0D0A                    	db	0Dh, 0Ah
  9941 00004F24 506172746974696F6E-     	db	"Partition size overs the disk capacity !"
  9941 00004F2D 2073697A65206F7665-
  9941 00004F36 727320746865206469-
  9941 00004F3F 736B20636170616369-
  9941 00004F48 74792021           
  9942 00004F4C 0D0A                    	db	0Dh, 0Ah
  9943 00004F4E 28507265737320454E-     	db	"(Press ENTER to use WHOLE disk or press ESC key to retry..)" 
  9943 00004F57 54455220746F207573-
  9943 00004F60 652057484F4C452064-
  9943 00004F69 69736B206F72207072-
  9943 00004F72 65737320455343206B-
  9943 00004F7B 657920746F20726574-
  9943 00004F84 72792E2E29         
  9944 00004F89 0D0A00                  	db	0Dh, 0Ah, 0
  9945                                  
  9946                                  msg_ext_partition_error:
  9947 00004F8C 457874656E64656420-     	db	"Extended partition must be created after primary partition !"
  9947 00004F95 706172746974696F6E-
  9947 00004F9E 206D75737420626520-
  9947 00004FA7 637265617465642061-
  9947 00004FB0 66746572207072696D-
  9947 00004FB9 617279207061727469-
  9947 00004FC2 74696F6E2021       
  9948 00004FC8 0D0A00                  	db	0Dh, 0Ah,0
  9949                                  
  9950                                  msg_logical_drive_error:
  9951 00004FCB 5072696D6172792061-     	db	"Primary and extended partitions must be created before logical drive !"
  9951 00004FD4 6E6420657874656E64-
  9951 00004FDD 656420706172746974-
  9951 00004FE6 696F6E73206D757374-
  9951 00004FEF 206265206372656174-
  9951 00004FF8 6564206265666F7265-
  9951 00005001 206C6F676963616C20-
  9951 0000500A 64726976652021     
  9952 00005011 0D0A00                  	db	0Dh, 0Ah,0
  9953                                  
  9954                                  msg_cylinder_boundary_set:
  9955 00005014 0D0A                    	db	0Dh, 0Ah
  9956 00005016 446F20796F75207761-     	db	"Do you want to adjust partition size to cylinder boundary ? (Y/N)"
  9956 0000501F 6E7420746F2061646A-
  9956 00005028 757374207061727469-
  9956 00005031 74696F6E2073697A65-
  9956 0000503A 20746F2063796C696E-
  9956 00005043 64657220626F756E64-
  9956 0000504C 617279203F2028592F-
  9956 00005055 4E29               
  9957 00005057 00                      	db	0
  9958                                  
  9959                                  	; 2019 - 2020 (hdimage.s)
  9960                                  ;msg_selected_partition:
  9961                                  ;	db	"                                 PARTITION 0                                    "
  9962                                  ;	db	"================================================================================"
  9963                                  ;	db	"        S  BH  BS  BC  FS  EH  ES  EC    START SEC   SECTORS   FILE SYSTEM      "
  9964                                  ;	db	"--------------------------------------------------------------------------------"
  9965                                  ;pt_row: db	"                                                                                "
  9966                                  ;	db	"================================================================================"
  9967                                  ;	db	0
  9968                                  
  9969                                  	; 24/10/2020 (fdisk3.s)
  9970                                  msg_selected_partition:
  9971 00005058 202020202020202020-     	db	"                                 PARTITION 0                                    "
  9971 00005061 202020202020202020-
  9971 0000506A 202020202020202020-
  9971 00005073 202020202020504152-
  9971 0000507C 544954494F4E203020-
  9971 00005085 202020202020202020-
  9971 0000508E 202020202020202020-
  9971 00005097 202020202020202020-
  9971 000050A0 2020202020202020   
  9972 000050A8 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
  9972 000050B1 3D3D3D3D3D3D3D3D3D-
  9972 000050BA 3D3D3D3D3D3D3D3D3D-
  9972 000050C3 3D3D3D3D3D3D3D3D3D-
  9972 000050CC 3D3D3D3D3D3D3D3D3D-
  9972 000050D5 3D3D3D3D3D3D3D3D3D-
  9972 000050DE 3D3D3D3D3D3D3D3D3D-
  9972 000050E7 3D3D3D3D3D3D3D3D3D-
  9972 000050F0 3D3D3D3D3D3D3D3D   
  9973 000050F8 202020202020205320-     	db	"       S  BH  BS  BC  FS  EH  ES  EC   START SECT    SECTORS   FILE SYSTEM      "
  9973 00005101 204248202042532020-
  9973 0000510A 424320204653202045-
  9973 00005113 482020455320204543-
  9973 0000511C 202020535441525420-
  9973 00005125 534543542020202053-
  9973 0000512E 4543544F5253202020-
  9973 00005137 46494C452053595354-
  9973 00005140 454D202020202020   
  9974 00005148 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9974 00005151 2D2D2D2D2D2D2D2D2D-
  9974 0000515A 2D2D2D2D2D2D2D2D2D-
  9974 00005163 2D2D2D2D2D2D2D2D2D-
  9974 0000516C 2D2D2D2D2D2D2D2D2D-
  9974 00005175 2D2D2D2D2D2D2D2D2D-
  9974 0000517E 2D2D2D2D2D2D2D2D2D-
  9974 00005187 2D2D2D2D2D2D2D2D2D-
  9974 00005190 2D2D2D2D2D2D2D2D   
  9975 00005198 202020202020202020-     pt_row:	db	"                                                                                "
  9975 000051A1 202020202020202020-
  9975 000051AA 202020202020202020-
  9975 000051B3 202020202020202020-
  9975 000051BC 202020202020202020-
  9975 000051C5 202020202020202020-
  9975 000051CE 202020202020202020-
  9975 000051D7 202020202020202020-
  9975 000051E0 2020202020202020   
  9976 000051E8 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
  9976 000051F1 3D3D3D3D3D3D3D3D3D-
  9976 000051FA 3D3D3D3D3D3D3D3D3D-
  9976 00005203 3D3D3D3D3D3D3D3D3D-
  9976 0000520C 3D3D3D3D3D3D3D3D3D-
  9976 00005215 3D3D3D3D3D3D3D3D3D-
  9976 0000521E 3D3D3D3D3D3D3D3D3D-
  9976 00005227 3D3D3D3D3D3D3D3D3D-
  9976 00005230 3D3D3D3D3D3D3D3D   
  9977 00005238 00                      	db	0
  9978                                  msg_boot_indicator:
  9979 00005239 0D0A                    	db	0Dh, 0Ah
  9980 0000523B 20202020426F6F7420-     	db	"    Boot Indicator : ", 0 ; "YES", "NO"
  9980 00005244 496E64696361746F72-
  9980 0000524D 203A2000           
  9981                                  msg_starting_head:
  9982 00005251 0D0A                    	db	0Dh, 0Ah
  9983 00005253 202020202053746172-     	db 	"     Starting Head : ", 0
  9983 0000525C 74696E672048656164-
  9983 00005265 203A2000           
  9984                                  msg_starting_sector:
  9985 00005269 0D0A                    	db	0Dh, 0Ah
  9986 0000526B 202020537461727469-     	db	"   Starting Sector : ", 0
  9986 00005274 6E6720536563746F72-
  9986 0000527D 203A2000           
  9987                                  msg_starting_cylinder:
  9988 00005281 0D0A                    	db	0Dh, 0Ah
  9989 00005283 205374617274696E67-     	db	" Starting Cylinder : ", 0
  9989 0000528C 2043796C696E646572-
  9989 00005295 203A2000           
  9990                                  msg_system_id:
  9991 00005299 0D0A                    	db	0Dh, 0Ah
  9992 0000529B 202020202020202020-     	db	"         System ID : ", 0
  9992 000052A4 53797374656D204944-
  9992 000052AD 203A2000           
  9993                                  msg_ending_head:
  9994 000052B1 0D0A                    	db	0Dh, 0Ah
  9995 000052B3 20202020202020456E-     	db 	"       Ending Head : ", 0
  9995 000052BC 64696E672048656164-
  9995 000052C5 203A2000           
  9996                                  msg_ending_sector:
  9997 000052C9 0D0A                    	db	0Dh, 0Ah
  9998 000052CB 2020202020456E6469-     	db	"     Ending Sector : ", 0
  9998 000052D4 6E6720536563746F72-
  9998 000052DD 203A2000           
  9999                                  msg_ending_cylinder:
 10000 000052E1 0D0A                    	db	0Dh, 0Ah
 10001 000052E3 202020456E64696E67-     	db	"   Ending Cylinder : ", 0
 10001 000052EC 2043796C696E646572-
 10001 000052F5 203A2000           
 10002                                  msg_relative_sectors:
 10003 000052F9 0D0A                    	db	0Dh, 0Ah
 10004 000052FB 0D0A                    	db	0Dh, 0Ah
 10005 000052FD 202052656C61746976-     	db	"  Relative Sectors : ", 0
 10005 00005306 6520536563746F7273-
 10005 0000530F 203A2000           
 10006                                  msg_total_sectors:
 10007 00005313 0D0A                    	db	0Dh, 0Ah
 10008 00005315 2020202020546F7461-     	db	"     Total Sectors : ", 0
 10008 0000531E 6C20536563746F7273-
 10008 00005327 203A2000           
 10009                                  
 10010                                  msg_format_stage:
 10011 0000532B 0D0A                    	db	0Dh, 0Ah
 10012 0000532D 507265737320454E54-     	db	"Press ENTER to FORMAT disk partition "
 10012 00005336 455220746F20464F52-
 10012 0000533F 4D4154206469736B20-
 10012 00005348 706172746974696F6E-
 10012 00005351 20                 
 10013                                  partition_num_chr:
 10014 00005352 30                      	db	"0"
 10015 00005353 206F72207072657373-     	db	" or press ESC to EXIT.."
 10015 0000535C 2045534320746F2045-
 10015 00005365 5849542E2E         
 10016 0000536A 00                      	db	0
 10017                                  msg_partition_edit:
 10018 0000536B 0D0A                    	db	0Dh, 0Ah
 10019 0000536D 2E2E206F7220707265-     	db	".. or press SPACE to EDIT partition table."
 10019 00005376 737320535041434520-
 10019 0000537F 746F20454449542070-
 10019 00005388 6172746974696F6E20-
 10019 00005391 7461626C652E       
 10020 00005397 0D0A00                  	db	0Dh, 0Ah, 0
 10021                                  
 10022                                  msg_edit_or_exit:
 10023 0000539A 0D0A                    	db 	0Dh, 0Ah
 10024 0000539C 507265737320454E54-     	db	"Press ENTER to continue or press ESC to exit.."
 10024 000053A5 455220746F20636F6E-
 10024 000053AE 74696E7565206F7220-
 10024 000053B7 707265737320455343-
 10024 000053C0 20746F20657869742E-
 10024 000053C9 2E                 
 10025 000053CA 00                      	db	0
 10026                                  
 10027                                  msg_overwrite_question1:
 10028 000053CB 0D0A                    	db	0Dh, 0Ah
 10029 000053CD 446F20796F75207761-     	db	'Do you want to overwrite '
 10029 000053D6 6E7420746F206F7665-
 10029 000053DF 72777269746520     
 10030 000053E6 27                      	db	27h
 10031 000053E7 00                      	db	0
 10032                                  
 10033                                  msg_overwrite_question2: 
 10034 000053E8 27                      	db	27h
 10035 000053E9 2066696C6520            	db	' file '
 10036 000053EF 00                      	db	0
 10037                                  
 10038                                  msg_format_question:
 10039 000053F0 0D0A                    	db	0Dh, 0Ah
 10040 000053F2 446F20796F75207761-     	db	"Do you want to format partition "
 10040 000053FB 6E7420746F20666F72-
 10040 00005404 6D6174207061727469-
 10040 0000540D 74696F6E20         
 10041                                  partition_num_txt:
 10042 00005412 3020                    	db	 "0 "
 10043                                  msg_yes_no:
 10044 00005414 285965732F4E6F293F-     	db	'(Yes/No)? ', 0
 10044 0000541D 2000               
 10045                                  
 10046                                  msg_writing_mbr:
 10047 0000541F 57726974696E67206D-     	db	"Writing masterboot sector...", 0
 10047 00005428 6173746572626F6F74-
 10047 00005431 20736563746F722E2E-
 10047 0000543A 2E00               
 10048                                  
 10049                                  msg_writing_disk_sectors:
 10050 0000543C 57726974696E672064-     	db	"Writing disk sector: ", 0
 10050 00005445 69736B20736563746F-
 10050 0000544E 723A2000           
 10051                                  
 10052                                  Msg_Writing_Boot_Sector:
 10053 00005452 57726974696E672074-     	db	"Writing trdos boot sector...", 0
 10053 0000545B 72646F7320626F6F74-
 10053 00005464 20736563746F722E2E-
 10053 0000546D 2E00               
 10054                                  
 10055                                  Msg_Writing_Root_Dir:
 10056 0000546F 57726974696E672072-     	db	"Writing root directory sectors...", 0
 10056 00005478 6F6F74206469726563-
 10056 00005481 746F72792073656374-
 10056 0000548A 6F72732E2E2E00     
 10057                                  
 10058                                  Msg_Writing_Data_Sectors:
 10059 00005491 57726974696E672064-     	db	"Writing data sector: ", 0
 10059 0000549A 61746120736563746F-
 10059 000054A3 723A2000           
 10060                                  
 10061                                  Sector_Str:
 10062 000054A7 3030303030303000        	db	"0000000", 0
 10063                                  Cursor_Pos:
 10064 000054AF 0000                    	dw	0
 10065                                  
 10066                                  Msg_Writing_FAT_Sectors:
 10067 000054B1 57726974696E672046-     	db	"Writing FAT sectors...", 0
 10067 000054BA 415420736563746F72-
 10067 000054C3 732E2E2E00         
 10068                                  
 10069                                  StrVolumeName:
 10070                                  	;times 	12 db  0
 10071 000054C8 00<rep 41h>             	times	65 db 0  ; 05/01/2018 (fs1 volume name)	
 10072                                  
 10073                                  Msg_Volume_Name:
 10074 00005509 0D0A                    	db	0Dh, 0Ah
 10075 0000550B 0D0A                    	db	0Dh, 0Ah
 10076 0000550D 566F6C756D65204E61-     	db	"Volume Name: ", 0
 10076 00005516 6D653A2000         
 10077                                  
 10078                                  Msg_Volume_Serial:
 10079 0000551B 566F6C756D65205365-     	db	"Volume Serial No: "
 10079 00005524 7269616C204E6F3A20 
 10080                                  Vol_Serial1:
 10081 0000552D 30303030                	db	"0000"
 10082 00005531 2D                      	db	"-"
 10083                                  Vol_Serial2:
 10084 00005532 30303030                	db	"0000"
 10085 00005536 0D0A00                  	db	0Dh, 0Ah, 0
 10086                                  
 10087                                  msg_cluster_count:
 10088 00005539 436C75737465722043-     	db	"Cluster Count: ", 0
 10088 00005542 6F756E743A2000     
 10089                                  cluster_count_str:
 10090 00005549 30303030303030          	db	"0000000"
 10091 00005550 0D0A00                  	db	0Dh, 0Ah, 0
 10092                                  msg_formatting:
 10093 00005553 466F726D617474696E-     	db	"Formatting ", 0
 10093 0000555C 672000             
 10094                                  format_percent_str:
 10095 0000555F 30303025                	db	"000%"
 10096 00005563 00                      	db	0
 10097                                  
 10098                                  Msg_3dot_OK:
 10099 00005564 2E2E2E                  	db	"..."
 10100                                  Msg_OK:
 10101 00005567 204F4B2E                	db	' OK.'
 10102                                  CRLF:
 10103 0000556B 0D0A00                  	db	0Dh, 0Ah, 0
 10104                                  
 10105                                  Msg_Error:
 10106 0000556E 0D0A                    	db	0Dh, 0Ah
 10107 00005570 4572726F72202120        	db	'Error ! '
 10108 00005578 28                      	db	'('
 10109                                  error_code:
 10110 00005579 3030                    	dw	3030h
 10111 0000557B 68                      	db	'h'
 10112 0000557C 2920                    	db	') '
 10113 0000557E 0D0A                    	db	0Dh, 0Ah
 10114 00005580 00                      	db	0
 10115                                  
 10116                                  msg_disk_sectors:
 10117 00005581 546F74616C20446973-     	db	"Total Disk Sectors : ", 0
 10117 0000558A 6B20536563746F7273-
 10117 00005593 203A2000           
 10118                                  
 10119                                  str_disk_sectors:
 10120                                  	;times	8 db 0
 10121 00005597 00<rep Bh>              	times	11 db 0 ; 27/10/2020
 10122                                  
 10123                                  msg_ep_size:
 10124 000055A2 457874656E64656420-     	db	"Extended Partition Size in Sectors: ", 0
 10124 000055AB 506172746974696F6E-
 10124 000055B4 2053697A6520696E20-
 10124 000055BD 536563746F72733A20-
 10124 000055C6 00                 
 10125                                  
 10126                                  msg_press_any_key:
 10127 000055C7 0D0A                    	db	0Dh, 0Ah
 10128 000055C9 50726573732061206B-     	db	"Press a key to continue..." 
 10128 000055D2 657920746F20636F6E-
 10128 000055DB 74696E75652E2E2E   
 10129 000055E3 0D0A00                  	db	0Dh, 0Ah, 0
 10130                                  
 10131                                  align 2
 10132                                  
 10133                                  ; Masterboot sector
 10134                                  
 10135                                  MasterBootBuff:
 10136                                  MasterBootCode: 
 10137 000055E6 00<rep 1BEh>            	times	446 db 0
 10138                                  PartitionTable:
 10139 000057A4 00<rep 40h>             	times	64 db 0
 10140                                  MBIDCode:
 10141 000057E4 0000                    	dw	0
 10142                                  
 10143                                  PTable_Buffer:
 10144 000057E6 00<rep 40h>             	times	64 db 0
 10145                                   
 10146 00005826 286329204572646F67-     	db	'(c) Erdogan TAN 2019-2024'
 10146 0000582F 616E2054414E203230-
 10146 00005838 31392D32303234     
 10147                                  
 10148                                  ; 05/11/2020
 10149 0000583F 00                      	db	0
 10150                                  
 10151                                  	; 2019 - 2020 (hdimage.s)
 10152                                  ;p_table_header:
 10153                                  ;	db	"                              ?BR PARTITION TABLE                               "
 10154                                  ;	db	"================================================================================"
 10155                                  ;	db	"       P  S  BH  BS  BC  FS  EH  ES  EC  START SEC  SECTORS  FILE SYSTEM        "
 10156                                  ;	db	"--------------------------------------------------------------------------------"
 10157                                  ;	db	0
 10158                                  ;p_table_footer:
 10159                                  ;	db	"================================================================================"
 10160                                  ;	db	0Dh, 0Ah, 0
 10161                                  
 10162                                  	; 24/10/2020 (fdisk3.s)
 10163                                  p_table_header:
 10164 00005840 202020202020202020-     	db	"                              ?BR PARTITION TABLE                               "
 10164 00005849 202020202020202020-
 10164 00005852 202020202020202020-
 10164 0000585B 2020203F4252205041-
 10164 00005864 52544954494F4E2054-
 10164 0000586D 41424C452020202020-
 10164 00005876 202020202020202020-
 10164 0000587F 202020202020202020-
 10164 00005888 2020202020202020   
 10165 00005890 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 10165 00005899 3D3D3D3D3D3D3D3D3D-
 10165 000058A2 3D3D3D3D3D3D3D3D3D-
 10165 000058AB 3D3D3D3D3D3D3D3D3D-
 10165 000058B4 3D3D3D3D3D3D3D3D3D-
 10165 000058BD 3D3D3D3D3D3D3D3D3D-
 10165 000058C6 3D3D3D3D3D3D3D3D3D-
 10165 000058CF 3D3D3D3D3D3D3D3D3D-
 10165 000058D8 3D3D3D3D3D3D3D3D   
 10166 000058E0 202020502020205320-     	db	"   P   S  BH  BS  BC  FS  EH  ES  EC   START SECT    SECTORS    FILE SYSTEM     "
 10166 000058E9 204248202042532020-
 10166 000058F2 424320204653202045-
 10166 000058FB 482020455320204543-
 10166 00005904 202020535441525420-
 10166 0000590D 534543542020202053-
 10166 00005916 4543544F5253202020-
 10166 0000591F 2046494C4520535953-
 10166 00005928 54454D2020202020   
 10167 00005930 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 10167 00005939 2D2D2D2D2D2D2D2D2D-
 10167 00005942 2D2D2D2D2D2D2D2D2D-
 10167 0000594B 2D2D2D2D2D2D2D2D2D-
 10167 00005954 2D2D2D2D2D2D2D2D2D-
 10167 0000595D 2D2D2D2D2D2D2D2D2D-
 10167 00005966 2D2D2D2D2D2D2D2D2D-
 10167 0000596F 2D2D2D2D2D2D2D2D2D-
 10167 00005978 2D2D2D2D2D2D2D2D   
 10168 00005980 00                      	db	0
 10169                                  p_table_footer:
 10170 00005981 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 10170 0000598A 3D3D3D3D3D3D3D3D3D-
 10170 00005993 3D3D3D3D3D3D3D3D3D-
 10170 0000599C 3D3D3D3D3D3D3D3D3D-
 10170 000059A5 3D3D3D3D3D3D3D3D3D-
 10170 000059AE 3D3D3D3D3D3D3D3D3D-
 10170 000059B7 3D3D3D3D3D3D3D3D3D-
 10170 000059C0 3D3D3D3D3D3D3D3D3D-
 10170 000059C9 3D3D3D3D3D3D3D3D   
 10171 000059D1 0D0A00                  	db	0Dh, 0Ah, 0
 10172                                  
 10173                                  mbr_editing_options:
 10174 000059D4 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah 
 10175 000059D8 4D4252205061727469-     	db	"MBR Partition Table Editing Options:"
 10175 000059E1 74696F6E205461626C-
 10175 000059EA 652045646974696E67-
 10175 000059F3 204F7074696F6E733A 
 10176 000059FC 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 10177 00005A00 20202020202020312E-     	db	"       1. Create Partition", 0Dh, 0Ah
 10177 00005A09 204372656174652050-
 10177 00005A12 6172746974696F6E0D-
 10177 00005A1B 0A                 
 10178 00005A1C 20202020202020322E-     	db	"       2. Set Active Partition", 0Dh, 0Ah
 10178 00005A25 205365742041637469-
 10178 00005A2E 766520506172746974-
 10178 00005A37 696F6E0D0A         
 10179 00005A3C 20202020202020332E-     	db	"       3. Delete Partition", 0Dh, 0Ah  
 10179 00005A45 2044656C6574652050-
 10179 00005A4E 6172746974696F6E0D-
 10179 00005A57 0A                 
 10180 00005A58 20202020202020342E-     	db	"       4. Write Current Partition Table", 0Dh, 0Ah, 0
 10180 00005A61 205772697465204375-
 10180 00005A6A 7272656E7420506172-
 10180 00005A73 746974696F6E205461-
 10180 00005A7C 626C650D0A00       
 10181                                  
 10182                                  enter_option_number_msg:
 10183 00005A82 0D0A                    	db	0Dh, 0Ah
 10184 00005A84 456E74657220746865-     	db	"Enter the option number or press ESC to exit ...", 0Dh, 0Ah
 10184 00005A8D 206F7074696F6E206E-
 10184 00005A96 756D626572206F7220-
 10184 00005A9F 707265737320455343-
 10184 00005AA8 20746F206578697420-
 10184 00005AB1 2E2E2E0D0A         
 10185                                  	;db	0Dh, 0Ah, 0
 10186 00005AB6 00                      	db	0 
 10187                                  
 10188                                  msg_zero_partition_size:  ; 19/02/2019
 10189 00005AB7 0D0A                    	db	0Dh, 0Ah
 10190 00005AB9 506172746974696F6E-     	db	"Partition size input must not be ZERO !", 0Dh, 0Ah
 10190 00005AC2 2073697A6520696E70-
 10190 00005ACB 7574206D757374206E-
 10190 00005AD4 6F74206265205A4552-
 10190 00005ADD 4F20210D0A         
 10191 00005AE2 285072657373204553-     	db	"(Press ESC to exit or press another key to retry..)", 0Dh, 0Ah
 10191 00005AEB 4320746F2065786974-
 10191 00005AF4 206F72207072657373-
 10191 00005AFD 20616E6F7468657220-
 10191 00005B06 6B657920746F207265-
 10191 00005B0F 7472792E2E290D0A   
 10192 00005B17 00                      	db	0 
 10193                                  
 10194                                  msg_empty_pt:
 10195 00005B18 0D0A                    	db	0Dh, 0Ah
 10196 00005B1A 456D70747920706172-     	db	"Empty partition table !", 0Dh, 0Ah
 10196 00005B23 746974696F6E207461-
 10196 00005B2C 626C6520210D0A     
 10197 00005B33 28412076616C696420-     	db	"(A valid partition must be created at first..)", 0Dh, 0Ah
 10197 00005B3C 706172746974696F6E-
 10197 00005B45 206D75737420626520-
 10197 00005B4E 637265617465642061-
 10197 00005B57 742066697273742E2E-
 10197 00005B60 290D0A             
 10198 00005B63 00                      	db	0
 10199                                  
 10200                                  msg_full_pt:
 10201 00005B64 0D0A                    	db	0Dh, 0Ah
 10202 00005B66 546865726520697320-     	db	"There is not a free partition table entry ", 0
 10202 00005B6F 6E6F74206120667265-
 10202 00005B78 652070617274697469-
 10202 00005B81 6F6E207461626C6520-
 10202 00005B8A 656E7472792000     
 10203                                  msg_to_create_new_p: 
 10204 00005B91 746F20637265617465-     	db	"to create a new partition !", 0Dh, 0Ah
 10204 00005B9A 2061206E6577207061-
 10204 00005BA3 72746974696F6E2021-
 10204 00005BAC 0D0A               
 10205 00005BAE 00                      	db	0
 10206                                  msg_no_free_space:
 10207 00005BAF 0D0A                    	db	0Dh, 0Ah
 10208 00005BB1 546865726520697320-     	db	"There is not (enough) free space ", 0
 10208 00005BBA 6E6F742028656E6F75-
 10208 00005BC3 676829206672656520-
 10208 00005BCC 73706163652000     
 10209                                  
 10210                                  msg_enter_pn_to_del:
 10211 00005BD3 0D0A                    	db	0Dh, 0Ah
 10212 00005BD5 456E74657220706172-     	db	"Enter partition number to delete: "
 10212 00005BDE 746974696F6E206E75-
 10212 00005BE7 6D62657220746F2064-
 10212 00005BF0 656C6574653A20     
 10213                                  chr_del_pnum1:
 10214 00005BF7 00                      	db	0       
 10215 00005BF8 0D0A00                  	db	0Dh, 0Ah, 0
 10216                                  
 10217                                  msg_delete_partition_q:
 10218 00005BFB 0D0A                    	db 	0Dh, 0Ah
 10219 00005BFD 5741524E494E472120-     	db 	"WARNING! All of data in the selected partition will be lost", 0Dh, 0Ah
 10219 00005C06 416C6C206F66206461-
 10219 00005C0F 746120696E20746865-
 10219 00005C18 2073656C6563746564-
 10219 00005C21 20706172746974696F-
 10219 00005C2A 6E2077696C6C206265-
 10219 00005C33 206C6F73740D0A     
 10220 00005C3A 202020202020202020-     	db	"         after you write changed partition table to disk !!", 0Dh, 0Ah
 10220 00005C43 616674657220796F75-
 10220 00005C4C 207772697465206368-
 10220 00005C55 616E67656420706172-
 10220 00005C5E 746974696F6E207461-
 10220 00005C67 626C6520746F206469-
 10220 00005C70 736B2021210D0A     
 10221 00005C77 0D0A                    	db	0Dh, 0Ah
 10222 00005C79 446F20796F75207761-     	db	"Do you want to delete PARTITION "
 10222 00005C82 6E7420746F2064656C-
 10222 00005C8B 657465205041525449-
 10222 00005C94 54494F4E20         
 10223                                  chr_del_pnum2:
 10224 00005C99 30                      	db	'0'
 10225 00005C9A 203F2028592F4E2920-     	db	' ? (Y/N) ', 0
 10225 00005CA3 00                 
 10226                                  
 10227                                  _msg_YES:
 10228 00005CA4 20                      	db	 20h
 10229                                  msg_YES:
 10230 00005CA5 5945532000              	db	'YES ', 0
 10231                                  _msg_NO:
 10232 00005CAA 20                      	db	20h
 10233                                  msg_NO:
 10234 00005CAB 4E4F2000                	db	'NO ', 0
 10235                                  
 10236                                  ; 11/02/2019
 10237                                  msg_write_masterboot_sector:
 10238 00005CAF 0D0A                    	db	0Dh, 0Ah 
 10239 00005CB1 577269746520437572-     	db	"Write Current Partition Table:" 
 10239 00005CBA 72656E742050617274-
 10239 00005CC3 6974696F6E20546162-
 10239 00005CCC 6C653A             
 10240 00005CCF 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 10241 00005CD3 20312E205772697465-     	db	" 1. Write Partition Table only", 0Dh, 0Ah
 10241 00005CDC 20506172746974696F-
 10241 00005CE5 6E205461626C65206F-
 10241 00005CEE 6E6C790D0A         
 10242 00005CF3 20322E205772697465-     	db	" 2. Write Partition Table and Singlix Master Boot Code", 0Dh, 0Ah
 10242 00005CFC 20506172746974696F-
 10242 00005D05 6E205461626C652061-
 10242 00005D0E 6E642053696E676C69-
 10242 00005D17 78204D617374657220-
 10242 00005D20 426F6F7420436F6465-
 10242 00005D29 0D0A               
 10243                                  enter_opt_num_cancel_msg:
 10244 00005D2B 0D0A                    	db	0Dh, 0Ah
 10245 00005D2D 456E74657220746865-     	db	"Enter the option number or press ESC to cancel ...", 0
 10245 00005D36 206F7074696F6E206E-
 10245 00005D3F 756D626572206F7220-
 10245 00005D48 707265737320455343-
 10245 00005D51 20746F2063616E6365-
 10245 00005D5A 6C202E2E2E00       
 10246                                  
 10247                                  msg_writing_ptable:
 10248 00005D60 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah  
 10249 00005D64 57726974696E672070-     	db	"Writing partition table on disk ... ", 0
 10249 00005D6D 6172746974696F6E20-
 10249 00005D76 7461626C65206F6E20-
 10249 00005D7F 6469736B202E2E2E20-
 10249 00005D88 00                 
 10250                                  _msg_OK:
 10251                                  	;db	7
 10252 00005D89 0D0A                    	db	0Dh, 0Ah
 10253 00005D8B 4F4B2021                	db	"OK !"
 10254 00005D8F 0D0A00                  	db	0Dh, 0Ah, 0
 10255                                  
 10256                                  option_input:
 10257 00005D92 205B205D00              	db	' [ ]', 0
 10258                                  
 10259                                  msg_enter_pn_to_act:
 10260 00005D97 0D0A                    	db	0Dh, 0Ah
 10261 00005D99 456E74657220706172-     	db	"Enter partition number to set as active: ", 0 
 10261 00005DA2 746974696F6E206E75-
 10261 00005DAB 6D62657220746F2073-
 10261 00005DB4 657420617320616374-
 10261 00005DBD 6976653A2000       
 10262                                  
 10263                                  ; 04/05/2024
 10264                                  ;trdos386_disk_chs_header:
 10265                                  ;	db	0Dh, 0Ah
 10266                                  ;	db	"                     TRDOS 386 (SINGLIX) HARD DISK IMAGE                        "
 10267                                  ;	db 	0
 10268                                  
 10269                                  ;disk_chs_header:
 10270                                  ;	db	0Dh, 0Ah
 10271                                  ;	db	"                                HARD DISK IMAGE                                 "
 10272                                  ;	db 	0
 10273                                  
 10274                                  msg_partition_size_limit:
 10275 00005DC3 0D0A                    	db	0Dh, 0Ah
 10276 00005DC5 506172746974696F6E-     	db	"Partition size overs available free space !"
 10276 00005DCE 2073697A65206F7665-
 10276 00005DD7 727320617661696C61-
 10276 00005DE0 626C65206672656520-
 10276 00005DE9 73706163652021     
 10277 00005DF0 0D0A                    	db	0Dh, 0Ah
 10278 00005DF2 4D61782E2061766169-     	db 	"Max. available free space is ", 0
 10278 00005DFB 6C61626C6520667265-
 10278 00005E04 652073706163652069-
 10278 00005E0D 732000             
 10279                                  
 10280                                  msg_partition_size_limit_r:
 10281 00005E10 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 10282 00005E14 28507265737320454E-     	db	"(Press ENTER to use all of available space or press ESC key to retry..) " 
 10282 00005E1D 54455220746F207573-
 10282 00005E26 6520616C6C206F6620-
 10282 00005E2F 617661696C61626C65-
 10282 00005E38 207370616365206F72-
 10282 00005E41 207072657373204553-
 10282 00005E4A 43206B657920746F20-
 10282 00005E53 72657472792E2E2920 
 10283 00005E5C 000A00                  	db	0D, 0Ah, 0
 10284                                  
 10285                                  msg_cylinders:
 10286 00005E5F 2063796C696E646572-     	db	" cylinders", 0
 10286 00005E68 7300               
 10287                                  msg_sectors:
 10288 00005E6A 20736563746F727300      	db	" sectors", 0
 10289                                  
 10290                                  ; 02/03/2019
 10291                                  msg_megabytes:
 10292 00005E73 206D65676162797465      	db	" megabyte"
 10293                                  msg_megabytes_s:
 10294 00005E7C 0000                    	db	0, 0
 10295                                  
 10296                                  msg_inv_pte:
 10297 00005E7E 0D0A                    	db	0Dh, 0Ah
 10298 00005E80 496E76616C69642070-     	db	"Invalid partition table entry ! (P"
 10298 00005E89 6172746974696F6E20-
 10298 00005E92 7461626C6520656E74-
 10298 00005E9B 72792021202850     
 10299 00005EA2 3F290D0A                inv_pte_num: db	"?)", 0Dh, 0Ah
 10300 00005EA6 28507265737320454E-     	db	"(Press ENTER to DELETE or press ESC to EXIT..)"
 10300 00005EAF 54455220746F204445-
 10300 00005EB8 4C455445206F722070-
 10300 00005EC1 726573732045534320-
 10300 00005ECA 746F20455849542E2E-
 10300 00005ED3 29                 
 10301 00005ED4 0D0A00                  	db	0Dh, 0Ah, 0
 10302                                  
 10303                                  msg_ext_partition_exists:
 10304 00005ED7 457874656E64656420-     	db	"Extended partition already exists !"
 10304 00005EE0 706172746974696F6E-
 10304 00005EE9 20616C726561647920-
 10304 00005EF2 6578697374732021   
 10305 00005EFA 0D0A00                  	db	0Dh, 0Ah, 0
 10306                                  
 10307                                  msg_defective_pt:
 10308 00005EFD 0D0A                    	db	0Dh, 0Ah
 10309 00005EFF 446566656374697665-     	db	"Defective partition table !", 0
 10309 00005F08 20706172746974696F-
 10309 00005F11 6E207461626C652021-
 10309 00005F1A 00                 
 10310                                  
 10311                                  ; 27/02/2019
 10312                                  msg_ext_part_del_error:
 10313 00005F1B 0D0A                    	db	0Dh, 0Ah
 10314 00005F1D 457874656E64656420-     	db	"Extended partition must be deleted after logical drive(s) !"
 10314 00005F26 706172746974696F6E-
 10314 00005F2F 206D75737420626520-
 10314 00005F38 64656C657465642061-
 10314 00005F41 66746572206C6F6769-
 10314 00005F4A 63616C206472697665-
 10314 00005F53 2873292021         
 10315 00005F58 0D0A00                  	db	0Dh, 0Ah, 0
 10316                                  
 10317                                  msg_cancel_continue:
 10318 00005F5B 285072657373204553-     	db	"(Press ESC to cancel or press another key to continue..)"
 10318 00005F64 4320746F2063616E63-
 10318 00005F6D 656C206F7220707265-
 10318 00005F76 737320616E6F746865-
 10318 00005F7F 72206B657920746F20-
 10318 00005F88 636F6E74696E75652E-
 10318 00005F91 2E29               
 10319 00005F93 0D0A00                  	db	0Dh, 0Ah, 0
 10320                                  
 10321                                  msg_delete_ldd:
 10322 00005F96 0D0A                    	db	0Dh, 0Ah
 10323 00005F98 0D0A                    	db	0Dh, 0Ah
 10324 00005F9A 44656C657465204C6F-     	db	"Delete Logical (DOS) Drive:"
 10324 00005FA3 676963616C2028444F-
 10324 00005FAC 53292044726976653A 
 10325 00005FB5 0D0A                    	db	0Dh, 0Ah
 10326 00005FB7 50726573732044454C-     	db	"Press DELETE key to delete logical disk partition "
 10326 00005FC0 455445206B65792074-
 10326 00005FC9 6F2064656C65746520-
 10326 00005FD2 6C6F676963616C2064-
 10326 00005FDB 69736B207061727469-
 10326 00005FE4 74696F6E20         
 10327 00005FE9 3F2E                    lddp_num: db	"?."
 10328 00005FEB 0D0A00                  	db	0Dh, 0Ah, 0
 10329                                  
 10330                                  msg_delete_ext_part:
 10331 00005FEE 0D0A                    	db	0Dh, 0Ah
 10332 00005FF0 0D0A                    	db	0Dh, 0Ah
 10333 00005FF2 44656C657465204578-     	db	"Delete Extended (DOS) Partition:"
 10333 00005FFB 74656E646564202844-
 10333 00006004 4F5329205061727469-
 10333 0000600D 74696F6E3A         
 10334 00006012 0D0A                    	db	0Dh, 0Ah
 10335 00006014 507265737320454E54-     	db	"Press ENTER to delete or press ESC to cancel.."
 10335 0000601D 455220746F2064656C-
 10335 00006026 657465206F72207072-
 10335 0000602F 657373204553432074-
 10335 00006038 6F2063616E63656C2E-
 10335 00006041 2E                 
 10336 00006042 0D0A00                  	db	0Dh, 0Ah, 0
 10337                                  
 10338                                  str_display_ebr_pt:
 10339 00006045 285072657373205350-     	db	"(Press SPACE to edit EXTENDED Partition Table)", 0Dh, 0Ah, 0
 10339 0000604E 41434520746F206564-
 10339 00006057 697420455854454E44-
 10339 00006060 454420506172746974-
 10339 00006069 696F6E205461626C65-
 10339 00006072 290D0A00           
 10340                                  
 10341                                  ebr_editing_options:
 10342 00006076 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah 
 10343 0000607A 457874656E64656420-     	db	"Extended Partition Table Editing Options:" 
 10343 00006083 506172746974696F6E-
 10343 0000608C 205461626C65204564-
 10343 00006095 6974696E67204F7074-
 10343 0000609E 696F6E733A         
 10344 000060A3 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 10345 000060A7 20202020202020312E-     	db	"       1. Create Logical DOS Drive", 0Dh, 0Ah
 10345 000060B0 20437265617465204C-
 10345 000060B9 6F676963616C20444F-
 10345 000060C2 532044726976650D0A 
 10346 000060CB 20202020202020322E-     	db	"       2. Delete Logical (DOS) Drive(s)",0Dh, 0Ah, 0
 10346 000060D4 2044656C657465204C-
 10346 000060DD 6F676963616C202844-
 10346 000060E6 4F5329204472697665-
 10346 000060EF 2873290D0A00       
 10347                                  
 10348                                  msg_delete_ldd_q:
 10349 000060F5 0D0A                    	db 	0Dh, 0Ah
 10350 000060F7 5741524E494E47210D-     	db 	"WARNING!", 0Dh, 0Ah 
 10350 00006100 0A                 
 10351 00006101 416C6C206F66206461-     	db	"All of data in logical (DOS) drive(s) will be lost !!", 0Dh, 0Ah
 10351 0000610A 746120696E206C6F67-
 10351 00006113 6963616C2028444F53-
 10351 0000611C 292064726976652873-
 10351 00006125 292077696C6C206265-
 10351 0000612E 206C6F73742021210D-
 10351 00006137 0A                 
 10352 00006138 0D0A                    	db	0Dh, 0Ah
 10353 0000613A 446F20796F75207761-     	db	"Do you want to continue ? (Y/N) ", 0
 10353 00006143 6E7420746F20636F6E-
 10353 0000614C 74696E7565203F2028-
 10353 00006155 592F4E292000       
 10354                                  
 10355                                  msg_create_ldd_max_error:
 10356 0000615B 0D0A                    	db	0Dh, 0Ah
 10357 0000615D 50726F6772616D206C-     	db	"Program limit for logical dos drive count is 4 !"
 10357 00006166 696D697420666F7220-
 10357 0000616F 6C6F676963616C2064-
 10357 00006178 6F7320647269766520-
 10357 00006181 636F756E7420697320-
 10357 0000618A 342021             
 10358 0000618D 0D0A00                  	db 	0Dh, 0Ah, 0
 10359                                  
 10360                                  msg_c_ldd_unused_warning:
 10361 00006190 0D0A                    	db	0Dh, 0Ah
 10362 00006192 546865726520697320-     	db	"There is unused extended partition space after logical dos drive "
 10362 0000619B 756E75736564206578-
 10362 000061A4 74656E646564207061-
 10362 000061AD 72746974696F6E2073-
 10362 000061B6 706163652061667465-
 10362 000061BF 72206C6F676963616C-
 10362 000061C8 20646F732064726976-
 10362 000061D1 6520               
 10363                                  char_lddn:
 10364 000061D3 342021                  	db	"4 !"
 10365 000061D6 0D0A                    	db 	0Dh, 0Ah
 10366 000061D8 285072657373204553-     	db	"(Press ESC to add unused space or press ENTER to continue.)"
 10366 000061E1 4320746F2061646420-
 10366 000061EA 756E75736564207370-
 10366 000061F3 616365206F72207072-
 10366 000061FC 65737320454E544552-
 10366 00006205 20746F20636F6E7469-
 10366 0000620E 6E75652E29         
 10367 00006213 0D0A00                  	db 	0Dh, 0Ah, 0
 10368                                  
 10369                                  msg_create_ldd_s:
 10370 00006216 53656C65637420616E-     	db	"Select an option to set logical dos drive size: "
 10370 0000621F 206F7074696F6E2074-
 10370 00006228 6F20736574206C6F67-
 10370 00006231 6963616C20646F7320-
 10370 0000623A 64726976652073697A-
 10370 00006243 653A20             
 10371 00006246 0D0A                    	db	0Dh, 0Ah
 10372 00006248 0D0A                    	db	0Dh, 0Ah
 10373 0000624A 202043292043796C69-     	db	"  C) Cylinder count", 0Dh, 0Ah   
 10373 00006253 6E64657220636F756E-
 10373 0000625C 740D0A             
 10374 0000625F 2020252920566F6C75-     	db	"  %) Volume percentage (##%)", 0Dh, 0Ah
 10374 00006268 6D652070657263656E-
 10374 00006271 746167652028232325-
 10374 0000627A 290D0A             
 10375 0000627D 20204D29204D656761-     	db	"  M) Mega bytes (MB, 2*1024*M sectors)", 0Dh, 0Ah
 10375 00006286 20627974657320284D-
 10375 0000628F 422C20322A31303234-
 10375 00006298 2A4D20736563746F72-
 10375 000062A1 73290D0A           
 10376 000062A5 202047292047696761-     	db	"  G) Giga bytes (GB, 2*1024*1024*G sectors)", 0Dh, 0Ah
 10376 000062AE 206279746573202847-
 10376 000062B7 422C20322A31303234-
 10376 000062C0 2A313032342A472073-
 10376 000062C9 6563746F7273290D0A 
 10377 000062D2 0D0A                    	db	0Dh, 0Ah	
 10378 000062D4 507265737320535041-     	db	"Press SPACE to use entire space or press ENTER to set Megabytes .. ", 0
 10378 000062DD 434520746F20757365-
 10378 000062E6 20656E746972652073-
 10378 000062EF 70616365206F722070-
 10378 000062F8 7265737320454E5445-
 10378 00006301 5220746F2073657420-
 10378 0000630A 4D6567616279746573-
 10378 00006313 202E2E2000         
 10379                                  
 10380                                  msg_c_part_error:
 10381 00006318 0D0A                    	db 	0Dh, 0Ah
 10382                                  	;db	"No free space for a new primary partition", 0Dh, 0Ah, 0
 10383                                  	; 21/03/2021
 10384 0000631A 4E6F20667265652073-     	db	"No free space for a new primary partition !", 0Dh, 0Ah, 0
 10384 00006323 7061636520666F7220-
 10384 0000632C 61206E657720707269-
 10384 00006335 6D6172792070617274-
 10384 0000633E 6974696F6E20210D0A-
 10384 00006347 00                 
 10385                                  ; 21/03/2021
 10386                                  ;msg_c_ldd_error: 
 10387                                  ;	db	"and logical dos drives over program limit (4) !", 0Dh, 0Ah, 0
 10388                                  msg_c_ldd_q:
 10389 00006348 0D0A                    	db	0Dh, 0Ah
 10390 0000634A 446F20796F75207761-     	db	"Do you want to create logical dos drive in extended dos partition "
 10390 00006353 6E7420746F20637265-
 10390 0000635C 617465206C6F676963-
 10390 00006365 616C20646F73206472-
 10390 0000636E 69766520696E206578-
 10390 00006377 74656E64656420646F-
 10390 00006380 732070617274697469-
 10390 00006389 6F6E20             
 10391 0000638C 3F2028592F4E2900        	db	'? (Y/N)', 0
 10392                                  
 10393                                  msg_c_ldd_nofspc_error:
 10394 00006394 0D0A                    	db 	0Dh, 0Ah
 10395 00006396 4E6F20667265652073-     	db	"No free space for a new logical dos drive !", 0Dh, 0Ah, 0
 10395 0000639F 7061636520666F7220-
 10395 000063A8 61206E6577206C6F67-
 10395 000063B1 6963616C20646F7320-
 10395 000063BA 647269766520210D0A-
 10395 000063C3 00                 
 10396                                  
 10397                                  	; 12/10/2020
 10398                                  msg_drv_not_ready:
 10399 000063C4 0D0A                    	db	0Dh, 0Ah
 10400 000063C6 4469736B2064726976-     	db	"Disk drive not ready or read error ! "
 10400 000063CF 65206E6F7420726561-
 10400 000063D8 6479206F7220726561-
 10400 000063E1 64206572726F722021-
 10400 000063EA 20                 
 10401 000063EB 0D0A00                  	db	0Dh, 0Ah, 0
 10402                                  
 10403                                  msg_not_any_disks:
 10404 000063EE 0D0A                    	db	0Dh, 0Ah
 10405 000063F0 546865726520697320-     	db	"There is not a hard disk (ready) ! "
 10405 000063F9 6E6F74206120686172-
 10405 00006402 64206469736B202872-
 10405 0000640B 6561647929202120   
 10406 00006413 0D0A00                  	db	0Dh, 0Ah, 0
 10407                                  
 10408 00006416 90<rep 2h>              align 4
 10409                                  
 10410                                  msg_sectors_crlf:
 10411 00006418 20736563746F72          	db	" sector"
 10412                                  msg_sectors_crlf_s:
 10413 0000641F 73                      	db	"s"
 10414 00006420 0D0A00                  	db	0Dh, 0Ah, 0
 10415                                  
 10416                                  vname_length:
 10417 00006423 00                      	db	0 ; 05/01/2018
 10418                                  
 10419                                  bs_oem_name:
 10420                                  	;db	'TRDOS2.0', 0
 10421                                  	; 04/05/2024
 10422 00006424 524554524F444F5300      	db	'RETRODOS', 0
 10423 0000642D 90                      align 2
 10424                                  
 10425                                  no_name:
 10426 0000642E 4E4F204E414D452020-     	db 	'NO NAME    ', 0
 10426 00006437 202000             
 10427                                  
 10428                                  align 2
 10429                                  
 10430                                  FDFORMAT_SECBUFFER:
 10431                                  HDFORMAT_SECBUFFER:
 10432 0000643A F6<rep 200h>            	times	512 db 0F6h
 10433                                  HDFORMAT_FSINFO_BUFF:
 10434 0000663A 52526141                	dd	41615252h  ; FSI_LeadSig
 10435 0000663E 00<rep 1E0h>            	times	480 db 0   ; FSI_Reserved1
 10436 0000681E 72724161                	dd	61417272h  ; FSI_StrucSig
 10437 00006822 FFFFFFFF                	dd	0FFFFFFFFh ; FSI_Free_Count
 10438 00006826 02000000                	dd	000000002h ; FSI_Nxt_Free
 10439 0000682A 00<rep Ch>              	times	12 db 0	   ; FSI_Reserved2
 10440 00006836 000055AA                	dd	0AA550000h ; FSI_TrailSig
 10441                                  
 10442                                  ; 29/10/2020
 10443                                  msg_100:
 10444 0000683A 31303000                	db	'100', 0
 10445                                  
 10446                                  SizeOfFile equ $-100
 10447                                  
 10448                                  ; 03/02/2019
 10449                                  
 10450                                  ;=============================================================================
 10451                                  ;        	uninitialized data
 10452                                  ;=============================================================================
 10453                                  
 10454                                  bss_start:
 10455                                  
 10456                                  ABSOLUTE bss_start
 10457                                  
 10458                                  ; 12/10/2020
 10459 0000683E ??                      DrvNum:	resb 1
 10460 0000683F ??                      hdc:	resb 1
 10461                                  ;hs:	resw 1 ; (bios/dos virtual) head*sectors ; 16/10/2020
 10462 00006840 ??                      rw:	resb 1 
 10463 00006841 ??                      rcnt:	resb 1 ; 18/10/2020
 10464                                  total_sectors:
 10465 00006842 ????????                disksize: resd 1
 10466 00006846 ????????                chs_limit: resd 1
 10467                                  
 10468                                  ; 16/10/2020
 10469                                  ;lba_cyls: resd 1  ; cylinder count calculated from LBA sectors
 10470 0000684A ????                    lba_chs_remain: resw 1	 ; remain sectors after the last cylinder
 10471                                  
 10472                                  alignb 2
 10473 0000684C ????                    old_sp:	resw 1
 10474                                  
 10475                                  HDFORMAT_FATBUFFER:
 10476                                  HDFORMAT_EMPTY_BUFF:
 10477 0000684E <res 200h>              	resb 512
 10478                                  
 10479 00006A4E ????????                data_start: resd 1
 10480 00006A52 ????????                data_sectors: resd 1
 10481 00006A56 ????????                cluster_count: resd 1
 10482 00006A5A ????                    root_dir_secs: resw 1
 10483 00006A5C ????                    format_percent: resw 1
 10484 00006A5E ??                      prev_percent:	resb 1
 10485 00006A5F ??                      rsvdbyte:	resb 1
 10486                                  
 10487                                  alignb 4
 10488                                  
 10489                                  ; 05/01/2018
 10490 00006A60 <res 40h>               fs_volume_name: resb 64
 10491 00006AA0 ????????                fs_volume_serial: resd 1
 10492 00006AA4 ????                    DAT_FFBit:	resw 1
 10493 00006AA6 ????                    DAT_FFSector:	resw 1
 10494 00006AA8 ????                    		resw 1 ; 19/03/2021
 10495 00006AAA ????                    DAT_LFBit:	resw 1
 10496 00006AAC ????                    DAT_LFSector:	resw 1
 10497 00006AAE ????                    		resw 1 ; 19/03/2021
 10498                                  
 10499                                  ;alignb 4
 10500                                  
 10501                                  FS_MAT_Buffer: ; TRFS1 Master Allocation Table (05/01/2018)
 10502 00006AB0 ??????                  MAT_Sign:		resb    3	; Offset 0  ; 'MAT' 
 10503 00006AB3 ??                      MAT_Version:		resb 	1	; 	 3  ; 0	
 10504 00006AB4 ????????                MAT_VolumeSize:		resd	1	;	 4  ; FS1 Volume Size
 10505 00006AB8 ????????                MAT_BeginSector:	resd	1	;	 8  ; FS1 Start Sector
 10506 00006ABC ????????                DAT_Address:		resd	1	;	12  ; Offset (=2)
 10507 00006AC0 ????????                DAT_SectorCount:	resd	1	;	16  
 10508 00006AC4 ????????                MAT_FreeSectors:	resd 	1	; 	20
 10509 00006AC8 ????????                MAT_FirstFreeSector:	resd	1	;	24
 10510                                  ;MAT_OS_Reserved:
 10511                                  ;	 		resb	9
 10512                                  ;MAT_Unused:
 10513                                  ;			resb	112
 10514                                  FS_DAT_Buffer: ; TRFS1 Disk Allocation Table (05/01/2018)
 10515                                  FS_RDT_Buffer: ; TRFS1 Root Directory Description Table (05/01/2018)
 10516 00006ACC <res 200h>              			resb	512		
 10517                                  ;alignb 4
 10518                                  
 10519                                  ; (TR-DOS 386 compatible) Hard Disk (image) parameters
 10520                                  
 10521                                  ;total_sectors: resd 1
 10522 00006CCC ????????                pType:	       resb 4
 10523 00006CD0 ????????                file_size:     resd 1
 10524 00006CD4 ????????                pp_StartSector: resd 1
 10525 00006CD8 ????????                pp_Sectors:	resd 1
 10526 00006CDC ??                      wholedisk:	resb 1
 10527 00006CDD ??                      pp_type: resb 1 ; Primary partition type (for this program)
 10528 00006CDE ??                      pp_type_user: resb 1
 10529 00006CDF ??                      chs_focus: resb 1
 10530 00006CE0 ????????                pSize_temp: resd 1
 10531 00006CE4 ????????                pSize_multiplier: resd 1
 10532 00006CE8 ??                      pSize_maxdigits: resb 1
 10533 00006CE9 ??                      pSize_digitpos: resb 1
 10534                                  msg_psize_unit:
 10535 00006CEA ????                    pSize_unit:	resw 1
 10536 00006CEC ??                      		resb 1
 10537                                  ; 06/11/2020		
 10538                                  ;reserved_bytes: resb 3 ; for 11 bytes of numbers
 10539                                  msg_partition_sectors:
 10540                                  		;resb 8
 10541 00006CED <res Bh>                		resb 11 ; 06/11/2020
 10542 00006CF8 ??                      		resb 1
 10543 00006CF9 ??                      format_q:	resb 1 ; 03/02/2018
 10544                                  
 10545                                  ;alignb 2
 10546 00006CFA ??                      pType_pos:	resb 1
 10547 00006CFB ??                      pType_num:	resb 1
 10548 00006CFC ??                      		resb 1
 10549                                  ;cylinder_boundary:
 10550 00006CFD ??                      		resb 1
 10551                                  ; 05/11/2020
 10552                                  
 10553                                  alignb 2
 10554                                  
 10555 00006CFE ??                      GetChar:	resb 1 ; 11/02/2019
 10556 00006CFF ??                      existingfile:	resb 1 ; 12/02/2019
 10557                                  
 10558                                  hs: ; 17/10/2020 ; (bios/dos virtual) head*sectors
 10559 00006D00 ????                    min_sectors:	resw 1 ; 08/02/2019
 10560 00006D02 ????                    pp_StartCylinder: resw 1
 10561 00006D04 ????                    pp_EndCylinder:	resw 1
 10562                                  
 10563 00006D06 ????????                ppn_Sectors:	resd 1 ; 09/02/2019
 10564                                  
 10565 00006D0A ????                    input_col:	resw 1
 10566 00006D0C ??                      No:		resb 1
 10567 00006D0D ??                      Yes:		resb 1
 10568                                  
 10569                                  ; 26/02/2019
 10570 00006D0E ??                      ldrives:	resb 1	
 10571                                  
 10572                                  ;sort_1:	resb 1
 10573 00006D0F ??                      		resb 1 ; 23/10/2020
 10574 00006D10 ????????                sort:		resb 4
 10575                                  
 10576                                  ;max_sector:	resb 8
 10577                                  ebr_buffer:		; 26/02/2019
 10578 00006D14 <res 200h>              boot_record:	resb 512
 10579                                  
 10580 00006F14 ??                      valid_input:	resb 1
 10581 00006F15 ??                      		resb 1
 10582                                  
 10583                                  ; 26/02/2019
 10584 00006F16 ????????                ep_StartSector:	resd 1
 10585 00006F1A ????????                ep_EndSector:	resd 1
 10586 00006F1E ????????                ep_Size:	resd 1
 10587                                  
 10588                                  ; 10/02/2019
 10589 00006F22 ????????                valid_ppnums:	resb 4	
 10590                                  
 10591 00006F26 ????                    _i_:	resw 1
 10592                                  
 10593 00006F28 ????                    freespace_count: resw 1
 10594 00006F2A ??                      last_found_partition: resb 1
 10595 00006F2B ??                      p_type: resb 1	
 10596                                  
 10597                                  ; 30/10/2020
 10598                                  ;p_sorted:
 10599                                  ;	resb 1
 10600                                  ;ep_sorted:
 10601                                  ;	resb 1
 10602                                  
 10603 00006F2C ??                      _e_:	resb 1
 10604                                  
 10605                                  act_part_num:
 10606                                  cre_part_num:
 10607 00006F2D ??                      del_part_num: resb 1 ; 10/02/2019
 10608                                  
 10609                                  alignb 2
 10610                                  
 10611 00006F2E <res 50h>               pte_row: resb 80
 10612                                  
 10613 00006F7E ??                      _zero_:	resb 1
 10614                                  
 10615                                  ;alignb 2
 10616                                  
 10617 00006F7F ??                      	resb 1
 10618                                  
 10619                                  bss_clear_end: ; 15/02/2019
 10620                                  
 10621                                  ; PARTITION DATA STRUCTURE
 10622                                  ; 4 partitions
 10623                                  ; 18 byte partition data structure per partition
 10624                                  ; 72 bytes (4*18)
 10625                                  
 10626 00006F80 ??                      part_table_boot_ind:	 resb 1
 10627 00006F81 ??                      part_table_start_head:	 resb 1
 10628 00006F82 ??                      part_table_start_sector: resb 1
 10629 00006F83 ????                    part_table_start_cyl:	 resw 1
 10630 00006F85 ??                      part_table_sys_id:	 resb 1
 10631 00006F86 ??                      part_table_end_head:	 resb 1
 10632 00006F87 ??                      part_table_end_sector:	 resb 1
 10633 00006F88 ????                    part_table_end_cyl:	 resw 1
 10634 00006F8A ????                    part_table_rel_sec_lw:	 resw 1
 10635 00006F8C ????                    part_table_rel_sec_hw:	 resw 1
 10636 00006F8E ????                    part_table_num_sec_lw:	 resw 1
 10637 00006F90 ????                    part_table_num_sec_hw:	 resw 1
 10638                                  
 10639 00006F92 <res 36h>               			resb 54 ; 3*18 bytes
 10640                                  
 10641 00006FC8 ??                      pcount:		resb 1
 10642 00006FC9 ??                      ppcount:	resb 1
 10643 00006FCA ??                      apcount:	resb 1
 10644 00006FCB ??                      epnumber:	resb 1
 10645                                  
 10646                                  ; LOGICAL PARTITION DATA STRUCTURE
 10647                                  ; (for logical partitions in extended partition)
 10648                                  
 10649                                  ; 1 extended partition
 10650                                  ; 4 logical drives (18 bytes)
 10651                                  ; 72 bytes (4*18)
 10652                                  
 10653 00006FCC ??                      ext_table_boot_ind:	resb 1
 10654 00006FCD ??                      ext_table_start_head:	resb 1
 10655 00006FCE ??                      ext_table_start_sector: resb 1
 10656 00006FCF ????                    ext_table_start_cyl:	resw 1
 10657 00006FD1 ??                      ext_table_sys_id:	resb 1
 10658 00006FD2 ??                      ext_table_end_head:	resb 1
 10659 00006FD3 ??                      ext_table_end_sector:	resb 1
 10660 00006FD4 ????                    ext_table_end_cyl:	resw 1
 10661 00006FD6 ????                    ext_table_rel_sec_lw:	resw 1
 10662 00006FD8 ????                    ext_table_rel_sec_hw:	resw 1
 10663 00006FDA ????                    ext_table_num_sec_lw:	resw 1
 10664 00006FDC ????                    ext_table_num_sec_hw:	resw 1
 10665                                  
 10666 00006FDE <res 36h>               			resb 54 ; 3*18 bytes
 10667                                  
 10668                                  fspc:		; 5*8 words (for free space calculations)
 10669                                  
 10670                                  ; Space 1 - unused cylinders before partition 0
 10671                                  ; Space 2 - unused cylinders between partition 0 & 1
 10672                                  ; Space 3 - unused cylinders between partition 1 & 2
 10673                                  ; Space 4 - unused cylinders between partition 2 & 3
 10674                                  ; Space 5 - unused cylinders after partition 3
 10675                                  
 10676 00007014 ????                    free_space.space:   	   resw 1
 10677 00007016 ????                    free_space.start:   	   resw 1
 10678 00007018 ????                    free_space.end:	   	   resw 1
 10679 0000701A ????                    free_space.percent_unused: resw 1
 10680 0000701C ????????                free_space.sectors_unused: resd 1
 10681 00007020 ????????                free_space.startsector:   resd 1 ; 13/02/2019
 10682                                  		;resw  4*6 
 10683 00007024 <res 40h>               		resw   4*8 ; 4*16 bytes ; 13/02/2019
 10684                                  
 10685                                  ; 18/02/2019
 10686 00007064 ????                    c_cylinder:	resw 1
 10687 00007066 ????                    c_fspc_offset:	resw 1
 10688 00007068 ??                      cylinder_boundary: resb 1
 10689                                  ;c_gap:		resb 1
 10690 00007069 ??                      		resb 1
 10691                                  
 10692                                  ; 27/02/2019
 10693 0000706A <res 10h>               ldd_start:	resd 4
 10694                                  ; 03/03/2019
 10695 0000707A <res 10h>               ldd_size:	resd 4
 10696                                  ; 30/10/2020
 10697 0000708A ????????                ep_free_sectors: resd 1
 10698                                  
 10699                                  ; 25/02/2019
 10700 0000708E ????                    pte_address:	resw 1
 10701                                  ; 02/03/2019
 10702 00007090 ????                    lcylinders:	resw 1
 10703                                  ; 01/11/2020
 10704 00007092 ????                    endcyl:		resw 1
 10705                                  
 10706                                  ;bss_clear_end: ; 18/02/2019
 10707                                  
 10708                                  ; 11/10/2020
 10709                                  ;gdp_buffer:	resb 30 ; buffer for int 13h, ah = 48h
 10710 00007094 <res 1Ah>               gdp_buffer:	resb 26 ; buffer for int 13h, ah = 48h
 10711                                  ; 19/03/2021
 10712 000070AE ????                    tempword:	resw 1
 10713                                  
 10714                                  bss_end:
