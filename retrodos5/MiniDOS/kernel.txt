     1                                  ;*****************************************************************************
     2                                  ; KERNEL.S (PCDOS 7.1 - MiniDOS 1.0 Kernel) - ERDOGAN TAN - 03/03/2025
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Modified from Retro DOS v5.0 'ibmdos7.s' (10/07/2024) ((PCDOS 7.1 Kernel))
     5                                  ;
     6                                  ; Last Update: 16/03/2025
     7                                  ;
     8                                  ; ----------------------------------------------------------------------------
     9                                  ; Assembler: NASM version 2.15
    10                                  ; ----------------------------------------------------------------------------
    11                                  ;	   ((nasm kernel.s -l kernel.txt -o KERNEL.BIN -Z error.txt))
    12                                  ;
    13                                  ;*****************************************************************************
    14                                  ; main file: 'minidos.s'
    15                                  ; incbin 'KERNEL.BIN'
    16                                  ;=============================================================================
    17                                  ; Modified from 'msdos6.s' (modified MSDOS 6.21 kernel src as Retro DOS v4.2)
    18                                  ; 29/09/2023 /// Retro DOS v4.2 (2023) -> Modified MSDOS 6.22 IO.SYS+MSDOS.SYS
    19                                  ;=============================================================================
    20                                  
    21                                  ; 03/03/2025
    22                                  ;-----------------------------------------------------------------------------
    23                                  ; "Mini DOS" modifications on Retro DOS v5.0 Kernel (Modified PCDOS 7.1)
    24                                  ; ----------------------------------------------------------------------------
    25                                  ; 1) 'FastOpen' functions removed.
    26                                  ;     07/03/2025
    27                                  ; 2) 'ExePackPatch', 'MagicPatch' and 'Rational386Patch' patches removed
    28                                  
    29                                  ; ----------------------------------------------------------------------------
    30                                  ; ----------------------------------------------------------------------------
    31                                  ; ibmdos7.s (Last Update: 10/07/2025)
    32                                  ; ----------------------------------------------------------------------------
    33                                  ; ----------------------------------------------------------------------------
    34                                  
    35                                  ; 30/12/2022 - Retro DOS v4.2 Kernel ('msdos6.s')
    36                                  ; Modified from 'msdos5.s' (29/12/2022, Retro DOS v4.1 Kernel) file
    37                                  ; as below:
    38                                  ;	1) MS-DOS version has been changed to 6.22 (It was 5.0) 
    39                                  ;	2) Retro DOS version has been changed to 4.2 (It was 4.1)
    40                                  ; (The content has not been changed except kernel version because the kernel
    41                                  ;  code is already compatible with MSDOS 6.x and it is optimized before.)
    42                                  ;	(But IO.SYS part of the kernel is not same with Retro DOS v4.1 code.)
    43                                  
    44                                  ; ----------------------------------------------------------------------------
    45                                  
    46                                  ; 03/11/2022 - Erdogan Tan (Istanbul)
    47                                  
    48                                  ; Note:	This code is a part of Retro DOS 4.0 kernel source code
    49                                  ;	(as included binary, 'MSDOS5.BIN') 
    50                                  ;	Equivalent of MSDOS 5.0 MSDOS.SYS kernel file 
    51                                  ;	
    52                                  ;	((MSDOS 6.0 kernel source code has been modified by using disassembled
    53                                  ;	MSDOS 5.0 MSDOS.SYS)) -- Disassembler: HEX-RAYS IDA Pro --
    54                                  ;	((Disassembly -Reverse engineering- reference: MSDOS 6.0 kernel src))
    55                                        
    56                                  ;------ Retro DOS v2 (v3) boot sector loads RETRODOS.SYS (MSDOS.SYS)
    57                                  ;	at 1000h:0000h and loader (initialization) part of RETRODOS kernel
    58                                  ;	moves IO.SYS (DOSBIOSCODE & DOSBIOSDATA, 'IOSYS5.BIN') to 70h:0000h.
    59                                  ;	Then SYSINIT code to the next segment (4D6h for current version)..
    60                                  ;	SYSINIT code relocates itself and DOSBIOSCODE and MSDOS.SYS
    61                                  ;	(MSDOS5.BIN) according to request/setting in 'config.sys' file.
    62                                  
    63                                  ; ----------------------------------------------------------------------------
    64                                  
    65                                  ; 01/01/2024 - Retro DOS v5.0 Kernel ('ibmdos7.s')
    66                                  ; Modified from 'msdos6.s' (29/09/2023, Retro DOS v4.2 kernel: MSDOS.SYS) file
    67                                  ; as below:
    68                                  ;
    69                                  ;    1) Retro DOS v5.0 IBMDOS.COM is based on disassembled source code
    70                                  ;	of PCDOS 7.1 IBMDOS.COM (2003) and it is derived using Retro DOS v4.2
    71                                  ;	MSDOS.SYS source code. Retro DOS v5.0 (IBMDOS.COM) kernel source code
    72                                  ;	is modified (and optimized) and so, it is not same with the original
    73                                  ;	PCDOS 7.1 IBMDOS.COM.
    74                                  ;
    75                                  ;    2) Retro DOS v4.2 MSDOS.SYS is based on disassembled source code
    76                                  ;	of MSDOS 6.21 MSDOS.SYS, derived using MSDOS 6.0 source code.
    77                                  ;	(And then it has been verified and updated by comparing it with
    78                                  ;	the disassembled source code of MSDOS 6.22 kernel file MSDOS.SYS.)
    79                                  ;
    80                                  ;    3) Labels, names, comments, explanations and structure definitions
    81                                  ;	about procedures and code details are almost entirely taken from
    82                                  ;	the original MSDOS 6.0 source code, except for the details that
    83                                  ;	Erdogan Tan personally experienced. Some of them are incompatible
    84                                  ;	with PCDOS 7.1 code. But they have not been deleted to preserve
    85                                  ;	the originality of the descriptions.)
    86                                  ;
    87                                  ; ('msdos6.s' has been converted to 'ibmdos7.s' and 'retrodos42.s' has been
    88                                  ; converted to 'retrodos5.s'. 'ibmdos7.s' is IBMDOS.COM source code file
    89                                  ; while 'retrodos5.s' is source code of Retro DOS v5 kernel file 'PCDOS.SYS'.
    90                                  ; 'retrodos5.s' includes 'ibmdos7.bin' or IBMDOS.COM as binary file.)
    91                                  		
    92                                  ; ----------------------------------------------------------------------------
    93                                  
    94                                  ;=============================================================================
    95                                  ; Most of comments in this file are from the original MSDOS 6.0 source code
    96                                  ;-----------------------------------------------------------------------------
    97                                  
    98                                  ; MSDOS 6.0 Kernel source files:
    99                                  ;	MSDATA.ASM, 
   100                                  ; 		(MSHEAD.ASM, MSCONST.ASM,CONST2.ASM, MS_DATA.ASM,
   101                                  ;		DOSTAB.ASM, LMSTUB.ASM, WPATCH.INC, MPATCH.ASM)
   102                                  ;	MSTABLE.ASM, MSCODE.ASM, MSDOSME.ASM (DOSMES.INC), TIME.ASM,
   103                                  ;	GETSET.ASM, PARSE.ASM, MISC.ASM, MISC2.ASM, CRIT.ASM, CPMIO.ASM,
   104                                  ;	CPMIO2.ASM, FCBIO.ASM, FCBIO2.ASM, SEARCH.ASM, PATH.ASM, IOCTL.ASM,
   105                                  ;	DELETE.ASM, RENAME.ASM, FINFO.ASM, DUP.ASM, CREATE.ASM, OPEN.ASM,
   106                                  ;	DINFO.ASM, ISEARCH.ASM, BUF.ASM, ABORT.ASM,CLOSE.ASM, DIRCALL.ASM,
   107                                  ;	DISK.ASM, DISK2.ASM, DISK3.ASM, DIR.ASM, DIR2.ASM, DEV.ASM,
   108                                  ;	MKNODE.ASM, ROM.ASM, FCB.ASM, MSCTRLC.ASM, FAT.ASM, MSPROC.ASM
   109                                  ;	ALLOC.ASM, SRVCALL.ASM, UTIL.ASM, MACRO.ASM, MACRO2.ASM, HANDLE.ASM
   110                                  ;	FILE.ASM, LOCK.ASM, ROMFIND.ASM, SHARE.ASM, MSINIT.ASM, ORIGIN.ASM
   111                                  ;
   112                                  ; MSDOS 2.0 Kernel source files:
   113                                  ; 	MSDOS.ASM (STDSW.ASM + MSHEAD.ASM + MSDATA.ASM)
   114                                  ;	MSCODE.ASM
   115                                  ;	DOSMES.ASM ... STDIO.ASM, TIME.ASM, XENIX.ASM, XENIX2.ASM
   116                                  
   117                                  ;============================================================================
   118                                  ; DOSLINK
   119                                  ;============================================================================
   120                                  ;msdos mscode dosmes misc getset dircall alloc dev dir +
   121                                  ;disk fat rom stdbuf stdcall stdctrlc stdfcb stdproc +
   122                                  ;stdio time xenix xenix2
   123                                  
   124                                  ;============================================================================
   125                                  ; This MSDOS source code is verified & modified by using IDA Pro Disassembler
   126                                  ; output in TASM syntax (July 2018 -> NASM syntax) [ IBMDOS.COM, 17/03/1987 ]
   127                                  ;============================================================================
   128                                  ;
   129                                  ; ###########################################################################
   130                                  ; #	This file is generated by The Interactive Disassembler (IDA)	    #
   131                                  ; #	Copyright (c) 2010 by Hex-Rays SA, <support@hex-rays.com>	    #
   132                                  ; #			 Licensed to: Freeware version			    #
   133                                  ; ###########################################################################
   134                                  ;
   135                                  ; Input	MD5   :	75959BC417C19135B982F7959EE9C92A
   136                                  
   137                                  ; ---------------------------------------------------------------------------
   138                                  ; File Name   :	C:\Documents and Settings\Erdoðan Tan\Desktop\MSDOS621.BIN
   139                                  ; Format      :	Binary file
   140                                  ;============================================================================
   141                                  ; MSDOS621.BIN = MSDOS.SYS, 13/02/1994, 38138 bytes (MSDOS 6.21 kernel) 2019
   142                                  ;----------------------------------------------------------------------------
   143                                  ; MSDOS5.BIN = MSDOS.SYS, 11/11/1991, 37394 bytes (MSDOS 5.0 kernel) 2022
   144                                  
   145                                  ;============================================================================
   146                                  ; MSDOS.ASM
   147                                  ;============================================================================
   148                                  
   149                                  ;TITLE   Standard MSDOS
   150                                  ;NAME    MSDOS_2
   151                                  
   152                                  ; Number of disk I/O buffers
   153                                  
   154                                  ;	INCLUDE STDSW.ASM
   155                                  ;       INCLUDE MSHEAD.ASM
   156                                  ;       INCLUDE MSDATA.ASM
   157                                  
   158                                  ;	END
   159                                  
   160                                  ;============================================================================
   161                                  ; STDSW.ASM
   162                                  ;============================================================================
   163                                  
   164                                  TRUE    EQU     0FFFFH
   165                                  FALSE   EQU     ~TRUE ; NOT TRUE
   166                                  
   167                                  ; Use the switches below to produce the standard Microsoft version or the IBM
   168                                  ; version of the operating system
   169                                  ;MSVER   EQU	false
   170                                  ;IBM     EQU	true
   171                                  ;WANG    EQU	FALSE
   172                                  ;ALTVECT EQU	FALSE
   173                                  
   174                                  ; Set this switch to cause DOS to move itself to the end of memory
   175                                  ;HIGHMEM EQU     FALSE
   176                                  
   177                                  ;	IF      IBM
   178                                  ESCCH    EQU	 0			;character to begin escape seq.
   179                                  CANCEL   EQU	 27			;Cancel with escape
   180                                  TOGLINS  EQU	TRUE			;One key toggles insert mode
   181                                  TOGLPRN  EQU	TRUE			;One key toggles printer echo
   182                                  ZEROEXT  EQU	TRUE
   183                                  ;       ELSE
   184                                  ;       IF      WANG			;Are we assembling for WANG?
   185                                  ;ESCCH	 EQU	1FH			;Yes. Use 1FH for escape character
   186                                  ;       ELSE
   187                                  ;ESCCH	 EQU	1BH
   188                                  ;       ENDIF
   189                                  ;CANCEL  EQU	"X"-"@"			;Cancel with Ctrl-X
   190                                  ;TOGLINS EQU	WANG			;Separate keys for insert mode on
   191                                  					;and off if not WANG
   192                                  ;TOGLPRN EQU	FALSE			;Separate keys for printer echo on
   193                                  					;and off
   194                                  ;ZEROEXT EQU	TRUE
   195                                  ;        ENDIF
   196                                  
   197                                  ;============================================================================
   198                                  ; MSHEAD.ASM
   199                                  ;============================================================================
   200                                  
   201                                  ;--------------------------------------------------------------
   202                                  ; TITLE   MSHEAD.ASM -- MS-DOS DEFINITIONS
   203                                  ;--------------------------------------------------------------
   204                                  
   205                                  ; MS-DOS High-performance operating system for the 8086  version 1.28
   206                                  ;        by Microsoft MSDOS development group:
   207                                  ;           Tim Paterson (Ret.)
   208                                  ;           Aaron Reynolds
   209                                  ;           Nancy Panners (Parenting)
   210                                  ;           Mark Zbikowski
   211                                  ;           Chris Peters (BIOS) (ret.)
   212                                  
   213                                  ; ****************** Revision History *************************
   214                                  ;          >> EVERY change must noted below!! <<
   215                                  ;
   216                                  ; 0.34 12/29/80 General release, updating all past customers
   217                                  ; 0.42 02/25/81 32-byte directory entries added
   218                                  ; 0.56 03/23/81 Variable record and sector sizes
   219                                  ; 0.60 03/27/81 Ctrl-C exit changes, including register save on user stack
   220                                  ; 0.74 04/15/81 Recognize I/O devices with file names
   221                                  ; 0.75 04/17/81 Improve and correct buffer handling
   222                                  ; 0.76 04/23/81 Correct directory size when not 2^N entries
   223                                  ; 0.80 04/27/81 Add console input without echo, Functions 7 & 8
   224                                  ; 1.00 04/28/81 Renumber for general release
   225                                  ; 1.01 05/12/81 Fix bug in `STORE'
   226                                  ; 1.10 07/21/81 Fatal error trapping, NUL device, hidden files, date & time,
   227                                  ;               RENAME fix, general cleanup
   228                                  ; 1.11 09/03/81 Don't set CURRENT BLOCK to 0 on open; fix SET FILE SIZE
   229                                  ; 1.12 10/09/81 Zero high half of CURRENT BLOCK after all (CP/M programs don't)
   230                                  ; 1.13 10/29/81 Fix classic "no write-through" error in buffer handling
   231                                  ; 1.20 12/31/81 Add time to FCB; separate FAT from DPT; Kill SMALLDIR; Add
   232                                  ;               FLUSH and MAPDEV calls; allow disk mapping in DSKCHG; Lots
   233                                  ;               of smaller improvements
   234                                  ; 1.21 01/06/82 HIGHMEM switch to run DOS in high memory
   235                                  ; 1.22 01/12/82 Add VERIFY system call to enable/disable verify after write
   236                                  ; 1.23 02/11/82 Add defaulting to parser; use variable escape character Don't
   237                                  ;               zero extent field in IBM version (back to 1.01!)
   238                                  ; 1.24 03/01/82 Restore fcn. 27 to 1.0 level; add fcn. 28
   239                                  ; 1.25 03/03/82 Put marker (00) at end of directory to speed searches
   240                                  ; 1.26 03/03/82 Directory buffers searched as a circular queue, current buffer
   241                                  ;               is searched first when possible to minimize I/O
   242                                  ;      03/03/82 STORE routine optimized to tack on partial sector tail as
   243                                  ;               full sector write when file is growing
   244                                  ;      03/09/82 Multiple I/O buffers
   245                                  ;      03/29/82 Two bugs:  Delete all case resets search to start at beginning
   246                                  ;               of directory (infinite loop possible otherwise), DSKRESET
   247                                  ;               must invalidate all buffers (disk and directory).
   248                                  ; 1.27 03/31/82 Installable device drivers
   249                                  ;                 Function call 47 - Get pointer to device table list
   250                                  ;                 Function call 48 - Assign CON AUX LIST
   251                                  ;      04/01/82 Spooler interrupt (INT 28) added.
   252                                  ; 1.28 04/15/82 DOS retructured to use ASSUMEs and PROC labels around system
   253                                  ;               call entries.  Most CS relative references changed to SS
   254                                  ;               relative with an eye toward putting a portion of the DOS in
   255                                  ;               ROM.  DOS source also broken into header, data and code pieces
   256                                  ;      04/15/82 GETDMA and GETVECT calls added as 24 and 32.  These calls
   257                                  ;               return the current values.
   258                                  ;      04/15/82 INDOS flag implemented for interrupt processing along with
   259                                  ;               call to return flag location (call 29)
   260                                  ;      04/15/82 Volume ID attribute added
   261                                  ;      04/17/82 Changed ABORT return to user to a long ret from a long jump to
   262                                  ;               avoid a CS relative reference.
   263                                  ;      04/17/82 Put call to STATCHK in dispatcher to catch ^C more often
   264                                  ;      04/20/82 Added INT int_upooler into loop ^S wait
   265                                  ;      04/22/82 Dynamic disk I/O buffer allocation and call to manage them
   266                                  ;               call 49.
   267                                  ;      04/23/82 Added GETDSKPTDL as call 50, similar to GETFATPT(DL), returns
   268                                  ;               address of DPB
   269                                  ;      04/29/82 Mod to WRTDEV to look for ^C or ^S at console input when
   270                                  ;               writting to console device via file I/O.  Added a console
   271                                  ;               output attribute to devices.
   272                                  ;      04/30/82 Call to en/dis able ^C check in dispatcher Call 51
   273                                  ;      04/30/82 Code to allow assignment of func 1-12 to disk files as well
   274                                  ;               as devices....  pipes, redirection now possible
   275                                  ;      04/30/82 Expanded GETLIST call to 2.0 standard
   276                                  ;      05/04/82 Change to INT int_fatal_abort callout int HARDERR.  DOS SS
   277                                  ;               (data segment) stashed in ES, INT int_fatal_abort routines must
   278                                  ;               preserve ES.  This mod so HARDERR can be ROMed.
   279                                  ; 1.29 06/01/82 Installable block and character devices as per 2.0 spec
   280                                  ;      06/04/82 Fixed Bug in CLOSE regarding call to CHKFATWRT.  It got left
   281                                  ;               out back about 1.27 or so (oops).  ARR
   282                                  ; 1.30 06/07/82 Directory sector buffering added to main DOS buffer queue
   283                                  ; 1.40 06/15/82 Tree structured directories.  XENIX Path Parser MKDIR CHDIR
   284                                  ;               RMDIR Xenix calls
   285                                  ; 1.41 06/13/82 Made GETBUFFR call PLACEBUF
   286                                  ; 1.50 06/17/82 FATs cached in buffer pool, get FAT pointer calls disappear
   287                                  ;               Frees up lots of memory.
   288                                  ; 1.51 06/24/82 BREAKDOWN modified to do EXACT one sector read/write through
   289                                  ;               system buffers
   290                                  ; 1.52 06/30/82 OPEN, CLOSE, READ, WRITE, DUP, DUP2, LSEEK implemented
   291                                  ; 1.53 07/01/82 OPEN CLOSE mod for Xenix calls, saves and gets remote dir
   292                                  ; 1.54 07/11/82 Function calls 1-12 make use of new 2.0 PDB. Init code
   293                                  ;               changed to set file handle environment.
   294                                  ; 2.00 08/01/82 Number for IBM release
   295                                  ;      01/19/83 No environ bug in EXEC
   296                                  ;      01/19/83 MS-DOS OEM INT 21 extensions (SET_OEM_HANDLER)
   297                                  ;      01/19/83 Performance bug fix in cooked write to NUL
   298                                  ;      01/27/83 Growcnt fixed for 32-bits
   299                                  ;      01/27/83 Find-first problem after create
   300                                  ; 2.01 02/17/83 International DOS
   301                                  ; 2.11 08/12/83 Dos split into several more modules for assembly on
   302                                  ;               an IBM PC
   303                                  ; 08/07/2018 - Retro DOS v3.0 by Erdogan Tan
   304                                  ; (MSHEAD.ASM, MSDOS 6.0, 1991) - mshead.asm 1.1 85/04/10 -
   305                                  ; 2.10 03/09/83 Start of NETWORK support
   306                                  ;		New Buffer structure
   307                                  ;		New Sytem file table structure
   308                                  ;		FCB moved to internal representation
   309                                  ;		DOS re-organized
   310                                  ; 2.11 04/21/83 Continuation of 2.10, preliminary Network
   311                                  ;		device interface.
   312                                  ; 2.11 08/12/83 Dos split into several more modules for assembly on
   313                                  ;               an IBM PC
   314                                  ; 2.50 09/12/83 More network stuff
   315                                  ;
   316                                  ; *************************************************************
   317                                  
   318                                  ; ----------------------------------------------------------------------------
   319                                  ; EQUATES
   320                                  
   321                                  ; Interrupt Entry Points:
   322                                  
   323                                  ; INTBASE:      ABORT
   324                                  ; INTBASE+4:    COMMAND
   325                                  ; INTBASE+8:    BASE EXIT ADDRESS
   326                                  ; INTBASE+C:    CONTROL-C ABORT
   327                                  ; INTBASE+10H:  FATAL ERROR ABORT
   328                                  ; INTBASE+14H:  BIOS DISK READ
   329                                  ; INTBASE+18H:  BIOS DISK WRITE
   330                                  ; INTBASE+1CH:  END BUT STAY RESIDENT (NOT SET BY DOS)
   331                                  ; INTBASE+20H:  SPOOLER INTERRUPT
   332                                  ; INTBASE+40H:  Long jump to CALL entry point
   333                                  
   334                                  ENTRYPOINTSEG   EQU     0Ch
   335                                  MAXDIF          EQU     0FFFh
   336                                  SAVEXIT         EQU     10
   337                                  ; 06/05/2019
   338                                  WRAPOFFSET	EQU	0FEF0h  ; (MISC.ASM, MSDOS 6.0, 1991)
   339                                  
   340                                         ; INCLUDE DOSSYM.ASM
   341                                         ; INCLUDE DEVSYM.ASM
   342                                  
   343                                  ; SUBTTL ^C, terminate/abort/exit and Hard error actions
   344                                  ; PAGE
   345                                  ; There are three kinds of context resets that can occur during normal DOS
   346                                  ; functioning:  ^C trap, terminate/abort/exit, and Hard-disk error.  These must
   347                                  ; be handles in a clean fashion that allows nested executions along with the
   348                                  ; ability to trap one's own errors.
   349                                  ;
   350                                  ; ^C trap - A process may elect to catch his own ^Cs.  This is achieved by
   351                                  ;           using the $GET_INTERRUPT_VECTOR and $SET_INTERRUPT_VECTOR as
   352                                  ;           follows:
   353                                  ;
   354                                  ;           $GET_INTERRUPT_VECTOR for INT int_ctrl_c
   355                                  ;           Save it in static memory.
   356                                  ;           $SET_INTERRUPT_VECTOR for INT int_ctrl_c
   357                                  ;
   358                                  ;           The interrupt service routine must preserve all registers and
   359                                  ;           return carry set iff the operation is to be aborted (via abort
   360                                  ;           system call), otherwise, carry is reset and the operation is
   361                                  ;           restarted.  ANY DEVIATION FROM THIS WILL LEAD TO UNRELIABLE
   362                                  ;           RESULTS.
   363                                  ;
   364                                  ;           To restore original ^C processing (done on terminate/abort/exit),
   365                                  ;           restore INT int_ctrl_c from the saved vector.
   366                                  ;
   367                                  ; Hard-disk error -- The interrupt service routine for INT int_fatal_abort must
   368                                  ;           also preserve registers and return one of three values in AL: 0 and
   369                                  ;           1 imply retry and ignore (???)  and 2 indicates an abort.  The user
   370                                  ;           himself is not to issue the abort, rather, the dos will do it for
   371                                  ;           him by simulating a normal abort/exit system call.  ANY DEVIATION
   372                                  ;           FROM THIS WILL LEAD TO UNRELIABLE RESULTS.
   373                                  ;
   374                                  ; terminate/abort/exit -- The user may not, under any circumstances trap an
   375                                  ;           abort call.  This is reserved for knowledgeable system programs.
   376                                  ;           ANY DEVIATION FROM THIS WILL LEAD TO UNRELIABLE RESULTS.
   377                                  
   378                                  ;SUBTTL SEGMENT DECLARATIONS
   379                                  
   380                                  ; The following are all of the segments used.  They are declared in the order
   381                                  ; that they should be placed in the executable
   382                                  
   383                                  ;
   384                                  ; segment ordering for MSDOS
   385                                  ;
   386                                  
   387                                  ;START           SEGMENT BYTE PUBLIC 'START'
   388                                  ;START           ENDS
   389                                  
   390                                  ;CONSTANTS       SEGMENT BYTE PUBLIC 'CONST'
   391                                  ;CONSTANTS       ENDS
   392                                  
   393                                  ;DATA            SEGMENT WORD PUBLIC 'DATA'
   394                                  ;DATA            ENDS
   395                                  
   396                                  ;CODE            SEGMENT BYTE PUBLIC 'CODE'
   397                                  ;CODE            ENDS
   398                                  
   399                                  ;LAST            SEGMENT BYTE PUBLIC 'LAST'
   400                                  ;LAST            ENDS
   401                                  
   402                                  ;DOSGROUP    GROUP   CODE,CONSTANTS,DATA,LAST
   403                                  
   404                                  ; The following segment is defined such that the data/const classes appear
   405                                  ; before the code class for ROMification
   406                                  
   407                                  ;START		SEGMENT BYTE PUBLIC 'START'
   408                                  ;           	ASSUME  CS:DOSGROUP,DS:NOTHING,ES:NOTHING,SS:NOTHING
   409                                  ;		JMP     DOSINIT
   410                                  ;START		ENDS
   411                                  
   412                                  ;============================================================================
   413                                  ; BPB.INC, MSDOS 6.0, 1991
   414                                  ;============================================================================
   415                                  ; 09/07/2018 - Retro DOS v3.0
   416                                  
   417                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   418                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   419                                  ;									   ;
   420                                  
   421                                  ;**	BIOS PARAMETER BLOCK DEFINITION
   422                                  ;
   423                                  ;	The BPB contains information about the disk structure. It dates
   424                                  ;	back to the earliest FAT systems and so FAT information is
   425                                  ;	intermingled with physical driver information.
   426                                  ;
   427                                  ;	A boot sector contains a BPB for its device; for other disks
   428                                  ;	the driver creates a BPB. DOS keeps copies of some of this
   429                                  ;	information in the DPB.
   430                                  ;
   431                                  ;	The BDS structure contains a BPB within it. 
   432                                  
   433                                  ; 01/01/2024
   434                                  %if 0
   435                                  
   436                                  struc A_BPB
   437                                  .BPB_BYTESPERSECTOR:	resw	1
   438                                  .BPB_SECTORSPERCLUSTER:	resb	1
   439                                  .BPB_RESERVEDSECTORS:	resw	1
   440                                  .BPB_NUMBEROFFATS:	resb	1
   441                                  .BPB_ROOTENTRIES: 	resw	1
   442                                  .BPB_TOTALSECTORS:	resw	1
   443                                  .BPB_MEDIADESCRIPTOR:	resb	1
   444                                  .BPB_SECTORSPERFAT:	resw	1
   445                                  .BPB_SECTORSPERTRACK:	resw	1
   446                                  .BPB_HEADS:		resw	1
   447                                  .BPB_HIDDENSECTORS:	resw	1
   448                                  			resw	1
   449                                  .BPB_BIGTOTALSECTORS:	resw	1
   450                                  			resw	1
   451                                  			resb	6	; NOTE:  many times these
   452                                  ;					; 	 6 bytes are omitted
   453                                  ;					;	 when BPB manipulations
   454                                  ;					;	 are performed!
   455                                  .size:
   456                                  endstruc
   457                                  
   458                                  %else
   459                                  
   460                                  ; 14/04/2024
   461                                  ; 01/01/2024 - Retro DOS v5.0
   462                                  
   463                                  struc A_BPB
   464 00000000 ????                    .BYTESPERSECTOR:    resw 1
   465 00000002 ??                      .SECTORSPERCLUSTER: resb 1
   466 00000003 ????                    .RESERVEDSECTORS:   resw 1
   467 00000005 ??                      .NUMBEROFFATS:	    resb 1
   468 00000006 ????                    .ROOTENTRIES:	    resw 1
   469 00000008 ????                    .TOTALSECTORS:	    resw 1
   470 0000000A ??                      .MEDIADESCRIPTOR:   resb 1
   471 0000000B ????                    .SECTORSPERFAT:	    resw 1
   472 0000000D ????                    .SECTORSPERTRACK:   resw 1
   473 0000000F ????                    .HEADS:		    resw 1
   474 00000011 ????????                .HIDDENSECTORS:	    resd 1
   475 00000015 ????????                .BIGTOTALSECTORS:   resd 1
   476                                  ;............ FAT32 ......  + 28
   477 00000019 ????????                .FATSIZE32:	    resd 1
   478 0000001D ????                    .EXTFLAGS:	    resw 1
   479 0000001F ????                    .FSVER:		    resw 1
   480 00000021 ????????                .ROOTDIRCLUSTER:    resd 1
   481 00000025 ????                    .FSINFOSECTOR:	    resw 1  ; (offset from FAT32 bs)
   482 00000027 ????                    .BACKUPBOOTSECTOR:  resw 1  ; (offset from FAT32 bs)
   483 00000029 <res Ch>                .RESERVEDBYTES:	    resb 12 ; (zero bytes)
   484                                  		; 14/04/2024
   485 00000035 ????????????            		    resb 6  ; A_BPB.size must be 59
   486                                  .size:
   487                                  endstruc
   488                                  
   489                                  %endif
   490                                  
   491                                  ;                                                                          ;
   492                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
   493                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   494                                  
   495                                  ;============================================================================
   496                                  ; BUFFER.INC, MSDOS 6.0, 1991
   497                                  ;============================================================================
   498                                  ; 04/05/2019 - Retro DOS v4.0
   499                                  ; 03/01/2024 - Retro DOS v5.0
   500                                  
   501                                  ; <Disk I/O Buffer Header>
   502                                  
   503                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   504                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   505                                  ;									   ;
   506                                  
   507                                  ; Field definition for I/O buffer information
   508                                  
   509                                  	; 03/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
   510                                  
   511                                  struc BUFFINFO
   512 00000000 ????                    .buf_next:	resw 1		; Pointer to next buffer in list
   513 00000002 ????                    .buf_prev:	resw 1		; Pointer to prev buffer in list
   514 00000004 ??                      .buf_ID:	resb 1		; Drive of buffer (bit 7 = 0)
   515                                  				; SFT table index (bit 7 = 1)
   516                                  				; = FFH if buffer free
   517 00000005 ??                      .buf_flags:	resb 1		; Bit 7 = 1 if Remote file buffer
   518                                  				;	= 0 if Local device buffer
   519                                  				; Bit 6 = 1 if buffer dirty
   520                                  				; Bit 5 = Reserved
   521                                  				; Bit 4 = Search bit (bit 7 = 1)
   522                                  				; Bit 3 = 1 if buffer is DATA
   523                                  				; Bit 2 = 1 if buffer is DIR
   524                                  				; Bit 1 = 1 if buffer is FAT
   525                                  				; Bit 0 = Reserved
   526 00000006 ????????                .buf_sector:	resd 1		; Sector number of buffer (flags bit 7 = 0)
   527                                  ; The next two items are often refed as a word (flags bit 7 = 0)
   528 0000000A ??                      .buf_wrtcnt:	resb 1		; For FAT sectors, # times sector written out
   529 0000000B ????                    .buf_wrtcntinc:	resw 1		; "   "     "   , # sectors between each write
   530 0000000D ????                    		resw 1 ; * ; 03/01/2024 ; PCDOS 7.1
   531                                  			   ; hw of sectors per FAT
   532 0000000F ????????                .buf_DPB:	resd 1		; Pointer to drive parameters
   533 00000013 ????                    .buf_fill:	resw 1		; How full buffer is (flags bit 7 = 1)
   534 00000015 ??                      .buf_reserved:	resb 1		; make DWORD boundary for 386
   535 00000016 ????                    		resw 1 ; * ; 03/01/2024 ; PCDOS 7.1
   536                                  			   ; reserved word for dword boundary
   537                                  .size:	; 20 bytes ; MSDOS 5.0 to 6.22
   538                                  	; 24 bytes ; PCDOS 7.1 ; 03/01/2024
   539                                  endstruc
   540                                  
   541                                  %define buf_offset	BUFFINFO.buf_sector ; 22/07/2019
   542                                  				;For buf_flags bit 7 = 1, this is the byte
   543                                  				;offset of the start of the buffer in
   544                                  				;the file pointed to by buf_ID. Thus
   545                                  				;the buffer starts at location
   546                                  				;buf_offset in the file and contains
   547                                  				;buf_fill bytes.
   548                                  
   549                                  BUFINSIZ        EQU     BUFFINFO.size
   550                                  
   551                                  buf_Free	EQU	0FFh	; buf_id of free buffer
   552                                  
   553                                  ;Flag byte masks
   554                                  buf_isnet	EQU	10000000B
   555                                  buf_dirty	EQU	01000000B
   556                                  ;***
   557                                  buf_visit	EQU	00100000B
   558                                  ;***
   559                                  buf_snbuf	EQU	00010000B
   560                                  
   561                                  buf_isDATA	EQU	00001000B
   562                                  buf_isDIR	EQU	00000100B
   563                                  buf_isFAT	EQU	00000010B
   564                                  buf_type_0	EQU	11110001B	; AND sets type to "none"
   565                                  
   566                                  buf_NetID	EQU	BUFINSIZ
   567                                  
   568                                  ;                                                                          ;
   569                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
   570                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   571                                  
   572                                  ;============================================================================
   573                                  ; DOSSSYM.INC, MSDOS 6.0, 1991
   574                                  ;============================================================================
   575                                  ; 04/05/2019 - Retro DOS v4.0
   576                                  
   577                                  ; <Control character definitions>
   578                                  
   579                                  c_DEL	    EQU     7Fh 	;    ASCII rubout or delete previous char
   580                                  c_BS	    EQU     08h 	; ^H ASCII backspace
   581                                  c_CR	    EQU     0Dh 	; ^M ASCII carriage return
   582                                  c_LF	    EQU     0Ah 	; ^J ASCII linefeed
   583                                  c_ETB	    EQU     17h 	; ^W ASCII end of transmission
   584                                  c_NAK	    EQU     15h 	; ^U ASCII negative acknowledge
   585                                  c_ETX	    EQU     03h 	; ^C ASCII end of text
   586                                  c_HT	    EQU     09h 	; ^I ASCII tab
   587                                  
   588                                  ; <User stack inside of system call>
   589                                  ; Location of user registers relative user stack pointer
   590                                  
   591                                  struc	user_env   ; user_environ
   592 00000000 ????                    .user_AX: resw 1
   593 00000002 ????                    .user_BX: resw 1
   594 00000004 ????                    .user_CX: resw 1
   595 00000006 ????                    .user_DX: resw 1
   596 00000008 ????                    .user_SI: resw 1
   597 0000000A ????                    .user_DI: resw 1
   598 0000000C ????                    .user_BP: resw 1
   599 0000000E ????                    .user_DS: resw 1
   600 00000010 ????                    .user_ES: resw 1
   601 00000012 ????                    .user_IP: resw 1
   602 00000014 ????                    .user_CS: resw 1
   603 00000016 ????                    .user_F:  resw 1
   604                                  .size:
   605                                  endstruc
   606                                  
   607                                  ; ---- <Disk map> ----
   608                                  
   609                                  ;	MSDOS partitions the disk into 4 sections:
   610                                  ;
   611                                  ;  phys sector 0:   +-------------------+
   612                                  ;	|	    | boot/reserved	|
   613                                  ;	|	    +-------------------+
   614                                  ;	|	    |  File allocation	|
   615                                  ;	v	    |	   table(s)	|
   616                                  ;		    |  (multiple copies |
   617                                  ;		    |	  are kept)	|
   618                                  ;		    +-------------------+
   619                                  ;		    |	  Directory	|
   620                                  ;		    +-------------------+
   621                                  ;		    |	  File space	|
   622                                  ;		    +-------------------+
   623                                  ;		    |	Unaddressable	|
   624                                  ;		    |  (to end of disk) |
   625                                  ;		    +-------------------+
   626                                  ;
   627                                  ; All partition boundaries are sector boundaries. The size of the FAT is
   628                                  ; adjusted to maximize the file space addressable.
   629                                  
   630                                  ; <File allocation Table information>
   631                                  
   632                                  ; The File Allocation Table uses a 12-bit entry for each allocation unit on
   633                                  ; the disk. These entries are packed, two for every three bytes. The contents
   634                                  ; of entry number N is found by 1) multiplying N by 1.5; 2) adding the result
   635                                  ; to the base address of the Allocation Table; 3) fetching the 16-bit word
   636                                  ; at this address; 4) If N was odd (so that N*1.5 was not an integer), shift
   637                                  ; the word right four bits; 5) mask to 12 bits (AND with 0FFF hex). Entry
   638                                  ; number zero is used as an end-of-file trap in the OS and is passed to the
   639                                  ; BIOS to help determine disk format. Entry 1 is reserved for future use.
   640                                  ; The first available allocation unit is assigned entry number two, and even
   641                                  ; though it is the first, is called cluster 2. Entries greater than 0FF8H
   642                                  ; (12-bit fats) or 0FFF8H (16-bit fats) are end of file marks; entries of zero
   643                                  ; are unallocated. Otherwise, the contents of a FAT entry is the number of
   644                                  ; the next cluster in the file.
   645                                  ;
   646                                  ; Clusters with bad sectors are tagged with FF7H. Any non-zero number would
   647                                  ; do because these clusters show as allocated, but are not part of any
   648                                  ; allocation chain and thus will never be allocated to a file. A particular
   649                                  ; number is selected so that disk checking programs know what to do (ie. a
   650                                  ; cluster with entry FF7H which is not in a chain is not an error).
   651                                  
   652                                  ;**	Character Type Flags
   653                                  ;
   654                                  ;	These flags are used in a lookup table indexed by the character code.
   655                                  ;	They're used to quickly classify characters when parsing paths.
   656                                  ;	I think that these are only used to parse FCBs - jgl
   657                                  
   658                                  FCHK	equ 1	; I think this means "normal name char, no chks needed" -jgl
   659                                  FDELIM	equ 2	; is a delimiter
   660                                  FSPCHK	equ 4	; set if character is not a space or equivalent
   661                                  FFCB	equ 8	; is valid in an FCB
   662                                  
   663                                  ;** Bit definitions for DOS_FLAG
   664                                  ;
   665                                  ; Bit 0 - this is set when a $open call is made from $exec. This is used in
   666                                  ;	  $open to indicate to the redirector that this open is being made
   667                                  ;	  by an exec call.
   668                                  ;
   669                                  ; Bit 2
   670                                  ;
   671                                  ; M003, M027:
   672                                  ;
   673                                  ; The start up code of MS PASCAL 3.2 programs depend on the 1M address wrap 
   674                                  ; if they load below 64K. This is a likely possiblity in DOS 5.x with DOS in
   675                                  ; the HMA. By default DOS will turn A20 OFF before Xferring control to the
   676                                  ; user program in the case of an Exec call. The next call to DOS will turn
   677                                  ; A20 line ON. It has been observed that MS PASCAL 3.2 start up does an int
   678                                  ; 21 ah=25h call before executing the faulty code. This will turn A20 On. 
   679                                  ; In order to support this we will set Bit 2 of this flag in the DOS exec
   680                                  ; call (msproc.asm) if DOS is running in the HMA. In $set_interrupt_vector in
   681                                  ; getset.asm A20OFF_COUNT is set to 1 if bit 2 of DOS_FLAG was previously set 
   682                                  ; by a call to exec and if A20OFF_COUNT is 0. In msdisp.asm, if A20OFF_COUNT 
   683                                  ; is non zero then A20 will be turned OFF before returning to the user. 
   684                                  ; Bit 2 will be unconditionally cleared here.
   685                                  ;
   686                                  ; M009, M027:
   687                                  ;
   688                                  ; Mace utilities MKEYRATE.COM version 1.0 copyright 1987 is an execpacked 
   689                                  ; program converted to a com file. Therefore if DOS is loaded high and if 
   690                                  ; this program is loaded below 64K it will blurt out "packed file is corrupt".
   691                                  ; This program does an int 21 ah=49h before executing the buggy execpacked
   692                                  ; code. This int21 call turns a20 on and hence the problem. In $dealloc
   693                                  ; alloc.asm A20OFF_COUNT is set to 1 if bit 2 of DOS_FLAG was previously set 
   694                                  ; by a call to exec and if A20OFF_COUNT is 0. In msdisp.asm, if A20OFF_COUNT 
   695                                  ; is non zero then A20 will be turned OFF before returning to the user. 
   696                                  ; Bit 2 will be unconditionally cleared here.
   697                                  
   698                                  EXECOPEN	EQU	00000001b	; bit 0 of DOS_FLAG
   699                                  SUPPRESS_WINA20	EQU	00000010b	; M025
   700                                  EXECA20OFF	EQU	00000100b	; bit 2 of DOS_FLAG
   701                                  
   702                                  ;============================================================================
   703                                  ; VECTOR.INC, MSDOS 6.0, 1991
   704                                  ;============================================================================
   705                                  ; 04/05/2019 - Retro DOS v4.0
   706                                  
   707                                  ; 09/07/2018 - Retro DOS v3.0 (VECTOR.INC, MSDOS 3.3, 1987)
   708                                  
   709                                  ; <interrupt definitions>
   710                                  
   711                                  INTTAB          EQU     20H
   712                                  INTBASE         EQU     4 * INTTAB
   713                                  ENTRYPOINT      EQU     INTBASE+40H
   714                                  
   715                                  ;	IF      ALTVECT
   716                                  ;ALTTAB  EQU     0F0H
   717                                  ;ALTBASE EQU     4 * ALTTAB
   718                                  ;	ENDIF
   719                                  
   720                                  ;
   721                                  ; interrupt assignments
   722                                  ;
   723                                  ;	IF	NOT ALTVECT
   724                                  int_abort	    EQU     INTTAB	; abort process
   725                                  int_command	    EQU     int_abort+1 ; call MSDOS
   726                                  int_terminate	    EQU     int_abort+2 ; int to terminate address
   727                                  int_ctrl_c	    EQU     int_abort+3 ; ^c trapper
   728                                  int_fatal_abort     EQU     int_abort+4 ; hard disk error
   729                                  int_disk_read	    EQU     int_abort+5 ; logical sector disk read
   730                                  int_disk_write	    EQU     int_abort+6 ; logical sector disk write
   731                                  int_keep_process    EQU     int_abort+7 ; terminate program and stay
   732                                  					; resident
   733                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   734                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   735                                  ;									   ;
   736                                  int_spooler	    EQU     int_abort+8 ; spooler call
   737                                  int_fastcon	    EQU     int_abort+9 ; fast CON interrupt
   738                                  int_IBM 	    EQU     int_abort+10; critical section maintenance
   739                                  ;									   ;
   740                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   741                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   742                                  ;	ELSE
   743                                  ;int_abort	    EQU     INTTAB	; abort process
   744                                  ;int_command	    EQU     int_abort+1 ; call MSDOS
   745                                  ;int_terminate	    EQU     ALTTAB	; int to terminate address
   746                                  ;int_ctrl_c	    EQU     int_terminate+1 ; ^c trapper
   747                                  ;int_fatal_abort    EQU     int_terminate+2 ; hard disk error
   748                                  ;int_disk_read	    EQU     int_abort+5 ; logical sector disk read
   749                                  ;int_disk_write	    EQU     int_abort+6 ; logical sector disk write
   750                                  ;int_keep_process   EQU     int_abort+7 ; terminate program and stay resident
   751                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   752                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   753                                  ;									   ;
   754                                  ;int_spooler	    EQU     int_terminate+3 ; spooler call
   755                                  ;int_fastcon	    EQU     int_abort+9 ; fast CON interrupt
   756                                  ;									   ;
   757                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   758                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   759                                  ;	ENDIF
   760                                  
   761                                  addr_int_abort		EQU    4 * int_abort
   762                                  addr_int_command	EQU    4 * int_command
   763                                  addr_int_terminate	EQU    4 * int_terminate
   764                                  addr_int_ctrl_c 	EQU    4 * int_ctrl_c
   765                                  addr_int_fatal_abort	EQU    4 * int_fatal_abort
   766                                  addr_int_disk_read	EQU    4 * int_disk_read
   767                                  addr_int_disk_write	EQU    4 * int_disk_write
   768                                  addr_int_keep_process	EQU    4 * int_keep_process
   769                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   770                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   771                                  ;									   ;
   772                                  addr_int_spooler	EQU    4 * int_spooler
   773                                  addr_int_fastcon	EQU    4 * int_fastcon
   774                                  addr_int_ibm		EQU    4 * int_IBM
   775                                  ;									   ;
   776                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   777                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   778                                  
   779                                  ;============================================================================
   780                                  ; DIRENT.INC, MSDOS 6.0, 1991
   781                                  ;============================================================================
   782                                  ; 04/05/2019 - Retro DOS v4.0
   783                                  
   784                                  ; BREAK <Directory entry>
   785                                  
   786                                  ;
   787                                  ;       +---------------------------+
   788                                  ;       |  (12 BYTE) filename/ext   |       0       0
   789                                  ;       +---------------------------+
   790                                  ;       |     (BYTE) attributes     |       11      B
   791                                  ;       +---------------------------+
   792                                  ;       |    (10 BYTE) reserved     |       12      C
   793                                  ;       +---------------------------+
   794                                  ;       | (WORD) time of last write |       22      16
   795                                  ;       +---------------------------+
   796                                  ;       | (WORD) date of last write |       24      18
   797                                  ;       +---------------------------+
   798                                  ;       |   (WORD) First cluster    |       26      1A
   799                                  ;       +---------------------------+
   800                                  ;       |     (DWORD) file size     |       28      1C
   801                                  ;       +---------------------------+
   802                                  ;
   803                                  ;   First byte of filename  = E5 -> free directory entry
   804                                  ;                           = 00 -> end of allocated directory
   805                                  ;   Time:   Bits 0-4=seconds/2, bits 5-10=minute, 11-15=hour
   806                                  ;   Date:   Bits 0-4=day, bits 5-8=month, bits 9-15=year-1980
   807                                  
   808                                  ; 01/01/2024
   809                                  %if 0
   810                                  
   811                                  struc dir_entry
   812                                  .dir_name:	resb 11			; file name
   813                                  .dir_attr:	resb 1			; attribute bits
   814                                  .dir_codepg:	resw 1			; code page DOS 4.00
   815                                  .dir_extcluster: resw 1			; extended attribute starting cluster
   816                                  .dir_attr2:	resb 1			; reserved
   817                                  .dir_pad:	resb 5			; reserved for expansion
   818                                  .dir_time:	resw 1			; time of last write
   819                                  .dir_date:	resw 1			; date of last write
   820                                  .dir_first:	resw 1			; first allocation unit of file
   821                                  .dir_size_l:	resw 1			; low 16 bits of file size
   822                                  .dir_size_h:	resw 1			; high 16 bits of file size
   823                                  .size:
   824                                  endstruc
   825                                  
   826                                  %else
   827                                  
   828                                  ; 01/01/2024 - Retro DOS v5.0 (*)
   829                                  
   830                                  struc dir_entry
   831 00000000 <res Bh>                .dir_name:	resb 11			; file name (short file name)
   832 0000000B ??                      .dir_attr:	resb 1			; file attributes (*)
   833 0000000C ??                      .dir_nt_res:	resb 1			; reserved for use by Windows NT. 0
   834                                  .dir_pad:	;resb 7			; (creation time, last access date
   835                                  					;  for use by Windows) 
   836                                  .dir_crttime_tenth:
   837 0000000D ??                      		resb 1
   838 0000000E ????                    .dir_crttime:	resw 1
   839 00000010 ????                    .dir_crtdate:	resw 1
   840                                  .dir_lstaccdate:
   841 00000012 ????                    		resw 1
   842 00000014 ????                    .dir_fclus_hi:	resw 1	; FAT32	fs	; high word of first cluster number
   843 00000016 ????                    .dir_time:	resw 1			; time of last write
   844 00000018 ????                    .dir_date:	resw 1			; date of last write
   845                                  .dir_fclus:				
   846 0000001A ????                    .dir_first:	resw 1			; first cluster (alloc. unit) of file
   847                                  .dir_file_size:
   848 0000001C ????                    .dir_size_l:	resw 1			; low 16 bits of file size
   849 0000001E ????                    .dir_size_h:	resw 1			; high 16 bits of file size
   850                                  .size:
   851                                  endstruc
   852                                  
   853                                  %endif
   854                                  
   855                                  attr_read_only      EQU      1h
   856                                  attr_hidden         EQU      2h
   857                                  attr_system         EQU      4h
   858                                  attr_volume_id      EQU      8h
   859                                  attr_directory      EQU     10h
   860                                  attr_archive        EQU     20h
   861                                  attr_device	    EQU     40h	; This is a VERY special bit.
   862                                  				;   NO directory entry on a disk EVER
   863                                  				;   has this bit set. It is set non-zero
   864                                  				;   when a device is found by GETPATH
   865                                  
   866                                  attr_all            EQU     attr_hidden+attr_system+attr_directory
   867                                                                          ; OR of hard attributes for FINDENTRY
   868                                  
   869                                  attr_ignore         EQU     attr_read_only+attr_archive
   870                                                                          ; ignore this(ese) attribute(s)
   871                                                                          ; during search first/next
   872                                  
   873                                  attr_changeable     EQU     attr_read_only+attr_hidden+attr_system+attr_archive
   874                                                                          ; changeable via CHMOD
   875                                  
   876                                  DIRFREE		equ	0E5h	; stored in dir_name[0] to indicate free slot
   877                                  
   878                                  ; ----------------------------------------------------------------------------
   879                                  ; 01/01/2024 - Retro DOS v5.0
   880                                  ; ref: FAT32 File System Specification v1.03 (Microsoft, December 6, 2000) (*)
   881                                  
   882                                  attr_long_name	equ attr_read_only|attr_hidden|attr_system|attr_volume_id
   883                                  attr_longname_mask equ attr_long_name|attr_directory|attr_archive
   884                                  
   885                                  ;============================================================================
   886                                  ; DPB.INC, MSDOS 6.0, 1991
   887                                  ;============================================================================
   888                                  ; 24/04/2019 - Retro DOS v4.0
   889                                  
   890                                  ; 19/07/2018 - Retro DOS v3.0 (DPB.INC, MSDOS 3.3, 1987)
   891                                  ; 07/07/2018 - Retro DOS v3.0 (DPB.INC, MSDOS 6.0, 1991)
   892                                  
   893                                  ; ---------------------------------------------------------------------------
   894                                  ;**	DPB - Drive Parameter Block
   895                                  ;
   896                                  ;	BUGBUG - this isn't authorative - it's my probably incomplete and
   897                                  ;	possibly inaccurate deductions from code study... - jgl
   898                                  ;
   899                                  ;	The DPB is DOS's main structure for describing block devices.
   900                                  ;	It contains info about the "Drive" intermingled with info about
   901                                  ;	the FAT file system which is presumably on the drive. I don't know
   902                                  ;	how those fields are used if it's not the FAT file system - BUGBUG
   903                                  ;
   904                                  ;	The DPBs are statically allocated and chained off of DPBHead.
   905                                  ;	Users scan this chain looking for a match on DPB_DRIVE.
   906                                  ;	The DPBs are built at init time from info in the SYSDEV structure.
   907                                  ; ---------------------------------------------------------------------------
   908                                  
   909                                  ; 01/01/2024
   910                                  %if 0
   911                                  
   912                                  struc	DPB
   913                                  .DRIVE:		resb 1		; Logical drive # assoc with DPB (A=0,B=1,...)
   914                                  .UNIT:		resb 1		; Driver unit number of DPB
   915                                  .SECTOR_SIZE:	resw 1		; Size of physical sector in bytes
   916                                  .CLUSTER_MASK:	resb 1		; Sectors/cluster - 1
   917                                  .CLUSTER_SHIFT:	resb 1		; Log2 of sectors/cluster
   918                                  .FIRST_FAT:	resw 1		; Starting record of FATs
   919                                  .FAT_COUNT:	resb 1		; Number of FATs for this drive
   920                                  .ROOT_ENTRIES:	resw 1		; Number of directory entries
   921                                  .FIRST_SECTOR:	resw 1		; First sector of first cluster
   922                                  .MAX_CLUSTER:	resw 1		; Number of clusters on drive + 1
   923                                  ; MSDOS 3.3
   924                                  ;.FAT_SIZE:	resb 1		; Number of records occupied by FAT
   925                                  ; MSDOS 6.0
   926                                  .FAT_SIZE:	resw 1		; Number of records occupied by FAT
   927                                  .DIR_SECTOR:	resw 1		; Starting record of directory
   928                                  .DRIVER_ADDR:	resd 1		; Pointer to driver
   929                                  .MEDIA:		resb 1		; Media byte
   930                                  .FIRST_ACCESS:	resb 1		; This is initialized to -1 to force a media
   931                                  				; check the first time this DPB is used
   932                                  .NEXT_DPB:	resd 1		; Pointer to next Drive parameter block
   933                                  .NEXT_FREE:	resw 1		; Cluster # of last allocated cluster
   934                                  .FREE_CNT:	resw 1		; Count of free clusters, -1 if unknown
   935                                  .size:
   936                                  endstruc
   937                                  
   938                                  %else
   939                                  
   940                                  ; 01/01/2024 - Retro DOS v5.0 (PCDOS 7.1)
   941                                  
   942                                  struc	DPB
   943 00000000 ??                      .DRIVE:		resb 1	; 0	; Logical drive # assoc with DPB (A=0,B=1,...)
   944 00000001 ??                      .UNIT:		resb 1	; 1	; Driver unit number of DPB
   945 00000002 ????                    .SECTOR_SIZE:	resw 1	; 2	; Size of physical sector in bytes
   946 00000004 ??                      .CLUSTER_MASK:	resb 1	; 4	; Sectors/cluster - 1
   947 00000005 ??                      .CLUSTER_SHIFT:	resb 1	; 5	; Log2 of sectors/cluster
   948 00000006 ????                    .FIRST_FAT:	resw 1	; 6	; Starting record of FATs
   949 00000008 ??                      .FAT_COUNT:	resb 1	; 8	; Number of FATs for this drive
   950 00000009 ????                    .ROOT_ENTRIES:	resw 1	; 9	; Number of directory entries
   951 0000000B ????                    .FIRST_SECTOR:	resw 1	; 11	; First sector of first cluster
   952 0000000D ????                    .MAX_CLUSTER:	resw 1	; 13	; Number of clusters on drive + 1
   953 0000000F ????                    .FAT_SIZE:	resw 1	; 15	; Number of records occupied by FAT
   954 00000011 ????                    .DIR_SECTOR:	resw 1	; 17	; Starting record of directory
   955 00000013 ????????                .DRIVER_ADDR:	resd 1  ; 19	; Pointer to driver
   956 00000017 ??                      .MEDIA:		resb 1	; 23	; Media byte
   957 00000018 ??                      .FIRST_ACCESS:	resb 1	; 24	; This is initialized to -1 to force a media
   958                                  				; check the first time this DPB is used
   959 00000019 ????????                .NEXT_DPB:	resd 1	; 25	; Pointer to next Drive parameter block
   960 0000001D ????                    .NEXT_FREE:	resw 1	; 29	; Cluster # of last allocated cluster
   961 0000001F ????                    .FREE_CNT:	resw 1	; 31	; Count of free clusters, -1 if unknown
   962                                  ; FAT32 fs ; 01/01/2024
   963                                  ; ref: https://en.wikibooks.org/wiki/
   964                                  ;      First_steps_towards_system_programming_under_MS-DOS_7/Appendix
   965                                  ;   -- A.03-1. Structure of Drive Parameters Blocks (DPB) ---
   966 00000021 ????                    .FREE_CNT_HW:	resw 1	; 33	; High word of free cluster count
   967 00000023 ????                    .EXT_FLAGS:	resw 1	; 35	; FAT32 extended flags (active FAT number)
   968 00000025 ????                    .FSINFO_SECTOR:	resw 1	; 37	; (FAT32 fs) FSINFO structure sector address
   969 00000027 ????                    .BKBOOT_SECTOR:	resw 1	; 39	; (FAT32 fs) Backup Boot Sector address
   970 00000029 ????????                .FCLUS_FSECTOR: resd 1	; 41	; The first cluster's first sector address
   971 0000002D ????????                .LAST_CLUSTER:	resd 1	; 45	; The last cluster number
   972 00000031 ????????                .FAT32_SIZE:	resd 1	; 49	; Number of FAT sectors (for FAT32 fs)	 
   973 00000035 ????????                .ROOT_CLUSTER:	resd 1	; 53	; Root directory's cluster number (FAT32 fs)
   974                                  ; 01/01/2024 - Retro DOS v5.0
   975 00000039 ????????                .FAT32_NXTFREE:	resd 1  ; 57	; The next free cluster (for FAT32 fs)
   976                                  .size:		; 61 bytes ; 01/01/2024 (PCDOS 7.1)
   977                                  endstruc
   978                                  
   979                                  
   980                                  %endif
   981                                  
   982                                  DPBSIZ  EQU     DPB.size	; Size of the structure in bytes
   983                                  
   984                                  DSKSIZ  EQU	DPB.MAX_CLUSTER	; Size of disk (temp used during init only)
   985                                  
   986                                  ;                                                                          ;
   987                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
   988                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   989                                  
   990                                  ;============================================================================
   991                                  ; SF.INC, MSDOS 6.0, 1991
   992                                  ;============================================================================
   993                                  ; 25/04/2019 - Retro DOS v4.0
   994                                  ; 07/07/2018 - Retro DOS v3.0
   995                                  
   996                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   997                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
   998                                  ;                                                                          ;
   999                                  
  1000                                  ; ---------------------------------------------------------------------------
  1001                                  ;**	SF.INC - System File Table
  1002                                  ;
  1003                                  ;   AN000   version 4.00   Jan. 1988
  1004                                  ;   AN003   PTM 3680 --  make NAME offset the same as before (<=3.30)
  1005                                  ;   AN009   PTM 3839	 reorder SFT for MS WINDOWS
  1006                                  ; ---------------------------------------------------------------------------
  1007                                  ;**	System File Table SuperStructure
  1008                                  ;
  1009                                  ;	The system file table entries are allocated in contiguous groups.
  1010                                  ;	There may be more than one such groups; the SF "superstructure"
  1011                                  ;	tracks the groups.
  1012                                  ; ---------------------------------------------------------------------------
  1013                                  
  1014                                  struc	SFT
  1015 00000000 ????????                .SFLink:	resd 1
  1016 00000004 ????                    .SFCount:	resw 1		; number of entries
  1017 00000006 ????                    .SFTable:	resw 1		; beginning of array of the following
  1018                                  .size:
  1019                                  endstruc
  1020                                  
  1021                                  ; ---------------------------------------------------------------------------
  1022                                  ;**	System file table entry
  1023                                  ;
  1024                                  ;	These are the structures which are at SFTABLE in the SF structure.
  1025                                  ; ---------------------------------------------------------------------------
  1026                                  
  1027                                  ; 01/01/2024 - Retro DOS v5.0
  1028                                  ; 25/04/2019 - Retro DOS v4.0
  1029                                  
  1030                                  struc SF_ENTRY
  1031 00000000 ????                    .sf_ref_count:	resw 1	; 0	; number of processes sharing entry
  1032                                  				;   if FCB then ref count
  1033 00000002 ????                    .sf_mode:	resw 1	; 2	; mode of access or high bit on if FCB
  1034 00000004 ??                      .sf_attr:	resb 1	; 4	; attribute of file
  1035 00000005 ????                    .sf_flags:	resw 1	; 5	;Bits 8-15
  1036                                  				; Bit 15 = 1 if remote file
  1037                                  				;	 = 0 if local file or device
  1038                                  				; Bit 14 = 1 if date/time is not to be
  1039                                  				;   set from clock at CLOSE. Set by
  1040                                  				;   FILETIMES and FCB_CLOSE. Reset by
  1041                                  				;   other reseters of the dirty bit
  1042                                  				;   (WRITE)
  1043                                  				; Bit 13 = Pipe bit (reserved)
  1044                                  				;
  1045                                  				; Bits 0-7 (old FCB_devid bits)
  1046                                  				; If remote file or local file, bit
  1047                                  				; 6=0 if dirty Device ID number, bits
  1048                                  				; 0-5 if local file.
  1049                                  				; bit 7=0 for local file, bit 7
  1050                                  				;      =1 for local I/O device
  1051                                  				; If local I/O device, bit 6=0 if EOF (input)
  1052                                  				;		Bit 5=1 if Raw mode
  1053                                  				;		Bit 0=1 if console input device
  1054                                  				;		Bit 1=1 if console output device
  1055                                  				;		Bit 2=1 if null device
  1056                                  				;		Bit 3=1 if clock device
  1057 00000007 ????????                .sf_devptr:	resd	1 ; 7	; Points to DPB if local file, points
  1058                                  				; to device header if local device,
  1059                                  				; points to net device header if
  1060                                  				; remote
  1061 0000000B ????                    .sf_firclus:	resw	1 ; 11	; First cluster of file (bit 15 = 0)
  1062 0000000D ????                    .sf_time:	resw	1 ; 13	; Time associated with file
  1063 0000000F ????                    .sf_date:	resw	1 ; 15	; Date associated with file
  1064 00000011 ????????                .sf_size:	resd 	1 ; 17	; Size associated with file
  1065 00000015 ????????                .sf_position:	resd	1 ; 21	; Read/Write pointer or LRU count for FCBs
  1066                                  
  1067                                  ; Starting here, the next 7 bytes may be used by the file system to store
  1068                                  ; an ID
  1069                                  
  1070                                  ; 09/07/2018 - Retro DOS v3.0
  1071                                  
  1072                                  ; MSDOS 3.3 SF.INC, 1987
  1073                                  ;.sf_cluspos:	resw	1	; Position of last cluster accessed
  1074                                  ;.sf_lstclus	resw	1	; Last cluster accessed
  1075                                  ;.sf_dirsec:	resw	1	; Sector number of directory sector
  1076                                  ;				; for this file
  1077                                  ;.sf_dirpos:	resb	1	; Offset of this entry in the above
  1078                                  
  1079                                  ; MSDOS 6.0, SF.INC, 1991
  1080 00000019 ????                    .sf_cluspos:	resw	1 ; 25	; Position of last cluster accessed
  1081 0000001B ????????                .sf_dirsec:	resd	1 ; 27	; Sector number of directory sector
  1082                                  				; for this file
  1083 0000001F ??                      .sf_dirpos:	resb	1 ; 31	; Offset of this entry in the above
  1084                                  
  1085                                  ; End of 7 bytes of file-system specific info.
  1086                                  
  1087 00000020 <res Bh>                .sf_name:	resb	11 ; 32	; 11 character name that is in the
  1088                                  				; directory entry. This is used by
  1089                                  				; close to detect file deleted and
  1090                                  				; disk changed errors.
  1091                                  .sf_fclus32:	; 22/03/2024
  1092                                  ; SHARING INFO
  1093 0000002B ????????                .sf_chain:	resd	1 ; 43	; link to next SF
  1094 0000002F ????                    .sf_UID:	resw	1 ; 47
  1095 00000031 ????                    .sf_PID:	resw	1 ; 49	; owner process identifier (PSP segment) 
  1096 00000033 ????                    .sf_MFT:	resw	1 ; 51
  1097                                  
  1098                                  ; MSDOS 6.0, SF.INC, 1991
  1099 00000035 ????                    .sf_lstclus:	resw	1 ; 53	;AN009; Last cluster accessed
  1100 00000037 ????????                .sf_IFS_HDR:	resd	1 ; 55	; pointer to IFS drive or 0:0 for files
  1101                                  
  1102                                  .size:
  1103                                  endstruc
  1104                                  
  1105                                  ; 20/07/2018
  1106                                  ; MSDOS 3.3, SF.INC, 1987
  1107                                  %define sf_netid   SF_ENTRY.sf_cluspos    ; byte
  1108                                  %define sf_OpenAge SF_ENTRY.sf_position+2 ; word
  1109                                  %define sf_LRU	   SF_ENTRY.sf_position	  ; word
  1110                                  ; MSDOS 6.0, SF.INC, 1991
  1111                                  %define sf_fsda	     SF_ENTRY.sf_cluspos  ; byte ;DOS 4.00
  1112                                  %define sf_serial_ID SF_ENTRY.sf_firclus  ; word ;DOS 4.00
  1113                                  
  1114                                  ; 19/07/2018
  1115                                  ; MSDOS 3.3, SF.INC, 1987
  1116                                  
  1117                                  sf_default_number  EQU	5
  1118                                  
  1119                                  ; Note that we need to mark an SFT as being busy for OPEN/CREATE. This is
  1120                                  ; because an INT 24 may prevent us from 'freeing' it. We mark this as such
  1121                                  ; by placing a -1 in the ref_count field.
  1122                                  
  1123                                  sf_busy EQU -1
  1124                                  
  1125                                  ; mode mask for FCB detection
  1126                                  sf_isFCB		EQU	1000000000000000B
  1127                                  
  1128                                  ; Flag word masks
  1129                                  sf_isnet		EQU	1000000000000000B
  1130                                  sf_close_nodate 	EQU	0100000000000000B
  1131                                  sf_pipe 		EQU	0010000000000000B
  1132                                  sf_no_inherit		EQU	0001000000000000B
  1133                                  sf_net_spool		EQU	0000100000000000B
  1134                                  
  1135                                  ; 25/04/2019
  1136                                  sf_entry_size equ SF_ENTRY.size ; 59 (MSDOS 6.0)
  1137                                  
  1138                                  ; ---------------------------------------------------------------------------
  1139                                  ; Local file/device flag masks
  1140                                  ; ---------------------------------------------------------------------------
  1141                                  
  1142                                  devid_file_clean        EQU     40h     ; true if file and not written
  1143                                  devid_file_mask_drive   EQU     3Fh     ; mask for drive number
  1144                                  
  1145                                  devid_device            EQU     80h     ; true if a device
  1146                                  devid_device_EOF        EQU     40h     ; true if end of file reached
  1147                                  devid_device_raw        EQU     20h     ; true if in raw mode
  1148                                  devid_device_special    EQU     10h     ; true if special device
  1149                                  devid_device_clock      EQU     08h     ; true if clock device
  1150                                  devid_device_null       EQU     04h     ; true if null device
  1151                                  devid_device_con_out    EQU     02h     ; true if console output
  1152                                  devid_device_con_in     EQU     01h     ; true if console input
  1153                                  
  1154                                  ; ---------------------------------------------------------------------------
  1155                                  ; structure of devid field as returned by IOCTL is:
  1156                                  ;
  1157                                  ;       BIT     7   6   5   4   3   2   1   0
  1158                                  ;             |---|---|---|---|---|---|---|---|
  1159                                  ;             | I | E | R | S | I | I | I | I |
  1160                                  ;             | S | O | A | P | S | S | S | S |
  1161                                  ;             | D | F | W | E | C | N | C | C |
  1162                                  ;             | E |   |   | C | L | U | O | I |
  1163                                  ;             | V |   |   | L | K | L | T | N |
  1164                                  ;             |---|---|---|---|---|---|---|---|
  1165                                  ;       ISDEV = 1 if this channel is a device
  1166                                  ;             = 0 if this channel is a disk file
  1167                                  ;
  1168                                  ;       If ISDEV = 1
  1169                                  ;
  1170                                  ;             EOF = 0 if End Of File on input
  1171                                  ;             RAW = 1 if this device is in Raw mode
  1172                                  ;                 = 0 if this device is cooked
  1173                                  ;             ISCLK = 1 if this device is the clock device
  1174                                  ;             ISNUL = 1 if this device is the null device
  1175                                  ;             ISCOT = 1 if this device is the console output
  1176                                  ;             ISCIN = 1 if this device is the console input
  1177                                  ;
  1178                                  ;       If ISDEV = 0
  1179                                  ;             EOF = 0 if channel has been written
  1180                                  ;             Bits 0-5 are the block device number for
  1181                                  ;                 the channel (0 = A, 1 = B, ...)
  1182                                  ; ---------------------------------------------------------------------------
  1183                                  
  1184                                  devid_ISDEV     EQU     80h
  1185                                  devid_EOF       EQU     40h
  1186                                  devid_RAW       EQU     20h
  1187                                  devid_SPECIAL   EQU     10H
  1188                                  devid_ISCLK     EQU     08h
  1189                                  devid_ISNUL     EQU     04h
  1190                                  devid_ISCOT     EQU     02h
  1191                                  devid_ISCIN     EQU     01h
  1192                                  
  1193                                  devid_block_dev EQU     1Fh             ; mask for block device number
  1194                                  
  1195                                  ;============================================================================
  1196                                  ; PDB.INC, MSDOS 6.0, 1991
  1197                                  ;============================================================================
  1198                                  ; 04/05/2019 - Retro DOS v4.0
  1199                                  ; 08/07/2018 - Retro DOS v3.0
  1200                                  
  1201                                  ; ---------------------------------------------------------------------------
  1202                                  ; BREAK <Process data block>
  1203                                  ; ---------------------------------------------------------------------------
  1204                                  ;**	Process data block (otherwise known as program header)
  1205                                  ;
  1206                                  
  1207                                  ;	These offset are documented in the MSDOS Encyclopedia, so nothing
  1208                                  ;	can be rearranged here, ever. Reserved areas are probably safe
  1209                                  ;	for use.
  1210                                  ; ---------------------------------------------------------------------------
  1211                                  
  1212                                  FILPERPROC	EQU     20
  1213                                  
  1214                                  struc PDB	; Process_data_block
  1215 00000000 ????                    .EXIT_CALL:	resw 1   	; INT int_abort system terminate
  1216 00000002 ????                    .BLOCK_LEN:	resw 1		; size of execution block
  1217 00000004 ??                                      resb 1
  1218 00000005 ??????????              .CPM_CALL:	resb 5		; ancient call to system
  1219 0000000A ????????                .EXIT:		resd 1		; pointer to exit routine
  1220 0000000E ????????                .CTRL_C:	resd 1		; pointer to ^C routine
  1221 00000012 ????????                .FATAL_ABORT:	resd 1		; pointer to fatal error
  1222 00000016 ????                    .PARENT_PID:	resw 1		; PID of parent (terminate PID)
  1223 00000018 <res 14h>               .JFN_TABLE:     resb FILPERPROC ; indices into system table
  1224 0000002C ????                    .ENVIRON:	resw 1		; segment address of environment
  1225 0000002E ????????                .USER_STACK:	resd 1		; stack of self during system calls
  1226 00000032 ????                    .JFN_Length:	resw 1		; number of handles allowed
  1227 00000034 ????????                .JFN_Pointer:	resd 1		; pointer to JFN table
  1228 00000038 ????????                .Next_PDB:	resd 1		; pointer to nested PDB's
  1229 0000003C ??                      .InterCon:	resb 1	; MSDOS 6.0 ; *** jh-3/28/90 *** 
  1230 0000003D ??                      .Append:	resb 1	; MSDOS 6.0 ; *** Not sure if still used ***
  1231 0000003E ????                    .Novell_Used:	resb 2	; MSDOS 6.0 ; Novell shell (redir) uses these
  1232 00000040 ????                    .Version:	resw 1	; MSDOS 6.0 ; DOS version reported to this app
  1233 00000042 <res Eh>                .PAD1:		resb 14 ; 0Eh
  1234 00000050 ??????????              .CALL_SYSTEM:	resb 5		; portable method of system call
  1235 00000055 ??????????????          .PAD2:		resb 7		; reserved so FCB 1 can be used as
  1236                                  				;  an extended FCB
  1237                                  ;endstruc 	; MSDOS 3.3
  1238                                  	  	; MSDOS 6.0
  1239 0000005C <res 10h>               .FCB1:		resb 16 ; 10h	; default FCB 1
  1240 0000006C <res 10h>               .FCB2:		resb 16 ; 10h	; default FCB 2
  1241 0000007C ????????                .PAD3:		resb 4		; not sure if this is used by PDB_FCB2
  1242 00000080 <res 80h>               .TAIL:		resb 128	; command tail and default DTA
  1243                                  endstruc
  1244                                  
  1245                                  ;============================================================================
  1246                                  ; EXE.INC, MSDOS 6.0, 1991
  1247                                  ;============================================================================
  1248                                  ; 04/05/2019 - Retro DOS v4.0
  1249                                  
  1250                                  ;**	EXE.INC - Definitions for the EXEC command and EXE files
  1251                                  ; ---------------------------------------------------------------------------
  1252                                  ; The following get used as arguments to the EXEC system call.  They indicate
  1253                                  ; whether or not the program is executed or whether or not a program header
  1254                                  ; gets created.
  1255                                  
  1256                                  exec_func_no_execute EQU 1	; no execute bit
  1257                                  exec_func_overlay    EQU 2	; overlay bit
  1258                                  
  1259                                  struc EXEC0
  1260 00000000 ????                    .ENVIRON:	resw 1		; seg addr of environment
  1261 00000002 ????????                .COM_LINE:	resd 1		; pointer to asciz command line
  1262 00000006 ????????                .5C_FCB:	resd 1		; default fcb at 5C
  1263 0000000A ????????                .6C_FCB:	resd 1		; default fcb at 6C
  1264                                  .size:
  1265                                  endstruc
  1266                                  
  1267                                  struc EXEC1
  1268 00000000 ????                    .ENVIRON:	resw 1		; seg addr of environment
  1269 00000002 ????????                .COM_LINE:	resd 1		; pointer to asciz command line
  1270 00000006 ????????                .5C_FCB:	resd 1		; default fcb at 5C
  1271 0000000A ????????                .6C_FCB:	resd 1		; default fcb at 6C
  1272 0000000E ????                    .SP:		resw 1		; stack pointer of program
  1273 00000010 ????                    .SS:		resw 1		; stack seg register of program
  1274 00000012 ????                    .IP:		resw 1		; entry point IP
  1275 00000014 ????                    .CS:		resw 1		; entry point CS
  1276                                  .size:
  1277                                  endstruc
  1278                                  
  1279                                  struc EXEC3
  1280 00000000 ????                    .load_addr:	resw 1		; seg address of load point
  1281 00000002 ????                    .reloc_fac:	resw 1		; relocation factor
  1282                                  endstruc
  1283                                  
  1284                                  ;**	Exit codes (in upper byte) for terminating programs
  1285                                  
  1286                                  EXIT_TERMINATE		EQU	0
  1287                                  EXIT_ABORT		EQU	0
  1288                                  EXIT_CTRL_C		EQU	1
  1289                                  EXIT_HARD_ERROR 	EQU	2
  1290                                  EXIT_KEEP_PROCESS	EQU	3
  1291                                  
  1292                                  ;**	EXE File Header Description
  1293                                  
  1294                                  struc EXE
  1295 00000000 ????                    .signature:   resw 1		; must contain 4D5A (yay zibo!)
  1296 00000002 ????                    .len_mod_512: resw 1		; low 9 bits of length
  1297 00000004 ????                    .pages:       resw 1		; number of 512b pages in file
  1298 00000006 ????                    .rle_count:   resw 1		; count of reloc entries
  1299 00000008 ????                    .par_dir:     resw 1		; number of paragraphs before image
  1300 0000000A ????                    .min_BSS:     resw 1		; minimum number of para of BSS
  1301 0000000C ????                    .max_BSS:     resw 1		; max number of para of BSS
  1302 0000000E ????                    .SS:          resw 1		; stack of image
  1303 00000010 ????                    .SP:          resw 1		; SP of image
  1304 00000012 ????                    .chksum:      resw 1		; checksum of file (ignored)
  1305 00000014 ????                    .IP:          resw 1		; IP of entry
  1306 00000016 ????                    .CS:          resw 1		; CS of entry
  1307 00000018 ????                    .rle_table:   resw 1		; byte offset of reloc table
  1308 0000001A ????                    .iov:         resw 1		; overlay number (0 for root)
  1309 0000001C ????????                .sym_tab:     resd 1		; offset of symbol table in file
  1310                                  .size:
  1311                                  endstruc
  1312                                  
  1313                                  exe_valid_signature     EQU 5A4Dh
  1314                                  exe_valid_old_signature EQU 4D5Ah
  1315                                  
  1316                                  ;**	EXE file symbol info definitions
  1317                                  
  1318                                  struc symbol_entry
  1319 00000000 ????????                .value:	resd 1
  1320 00000004 ????                    .type:	resw 1
  1321 00000006 ??                      .len:	resb 1
  1322 00000007 <res FFh>               .name:	resb 255
  1323                                  endstruc
  1324                                  
  1325                                  ;**	Data structure passed for ExecReady call
  1326                                  
  1327                                  struc ERStruc
  1328 00000000 ????                     .ER_Reserved:	resw	1	; reserved, should be zero
  1329 00000002 ????                     .ER_Flags:	resw	1
  1330 00000004 ????????                 .ER_ProgName:	resd	1	; ptr to ASCIIZ str of prog name
  1331 00000008 ????                     .ER_PSP:	resw	1	; PSP of the program
  1332 0000000A ????????                 .ER_StartAddr:	resd	1	; Start CS:IP of the program
  1333 0000000E ????????                 .ER_ProgSize:	resd	1	; Program size including PSP
  1334                                   .size:
  1335                                  endstruc
  1336                                  
  1337                                  ;** bit fields in ER_Flags
  1338                                  
  1339                                  ER_EXE		equ	0001h
  1340                                  ER_OVERLAY	equ	0002h
  1341                                  
  1342                                  
  1343                                  ;============================================================================
  1344                                  ; ARENA.INC, MSDOS 6.0, 1991
  1345                                  ;============================================================================
  1346                                  ; 24/04/2019 - Retro DOS v4.0
  1347                                  ; 04/08/2018 - Retro DOS v3.0
  1348                                  
  1349                                  ;BREAK <Memory arena structure>
  1350                                  
  1351                                  ;**	Arena Header
  1352                                  
  1353                                  struc ARENA
  1354 00000000 ??                      .SIGNATURE:	resb 1		; 4D for valid item, 5A for last item
  1355 00000001 ????                    .OWNER:		resw 1		; owner of arena item
  1356 00000003 ????                    .SIZE:		resw 1		; size in paragraphs of item
  1357 00000005 ??????                  .RESERVED:	resb 3		; reserved
  1358 00000008 ????????????????        .NAME:		resb 8		; owner file name
  1359                                  .headersize:
  1360                                  endstruc
  1361                                  
  1362                                  ; 20/05/2019 - Retro DOS v4.0
  1363                                  ARENAHEADERSIZE equ ARENA.headersize 
  1364                                  
  1365                                  ; CAUTION: The routines in ALLOC.ASM rely on the fact that arena_signature
  1366                                  ; and arena_owner_system are all equal to zero and are contained in DI.
  1367                                  ; Change them and change ALLOC.ASM.
  1368                                  
  1369                                  arena_owner_system  EQU 0               ; free block indication
  1370                                  
  1371                                  arena_signature_normal	EQU 4Dh		; valid signature, not end of arena
  1372                                  arena_signature_end     EQU 5Ah         ; valid signature, last block in arena
  1373                                  
  1374                                  FIRST_FIT	EQU	00000000B
  1375                                  BEST_FIT	EQU	00000001B
  1376                                  LAST_FIT	EQU	00000010B
  1377                                  
  1378                                  ; MSDOS 6.0
  1379                                  LOW_FIRST	EQU	00000000B	; M001
  1380                                  HIGH_FIRST	EQU	10000000B	; M001
  1381                                  HIGH_ONLY	EQU	01000000B	; M001
  1382                                  
  1383                                  LINKSTATE	EQU	00000001B	; M002
  1384                                  
  1385                                  HF_MASK		EQU	~HIGH_FIRST	; M001
  1386                                  HO_MASK		EQU	~HIGH_ONLY	; M001
  1387                                  
  1388                                  STRAT_MASK	EQU	HF_MASK & HO_MASK	; M001;
  1389                                  						; M026: used to mask of bits
  1390                                  						; M026: 6 & 7 of AllocMethod
  1391                                  
  1392                                  ;============================================================================
  1393                                  ; MI.INC, MSDOS 6.0, 1991
  1394                                  ;============================================================================
  1395                                  ; 07/07/2018 - Retro DOS v3.0
  1396                                  
  1397                                  ;BREAK <Machine instruction, flag definitions and character types>
  1398                                  
  1399                                  mi_INT		EQU	0CDh
  1400                                  mi_long_jmp	EQU	0EAh
  1401                                  mi_Long_CALL	EQU	09Ah
  1402                                  mi_Long_RET	EQU	0CBh
  1403                                  mi_Near_RET	EQU	0C3h
  1404                                  
  1405                                  ;			xxxxoditszxaxpxc
  1406                                  f_Overflow	EQU	0000100000000000B
  1407                                  f_Direction	EQU	0000010000000000B
  1408                                  f_Interrupt	EQU	0000001000000000B
  1409                                  f_Trace 	EQU	0000000100000000B
  1410                                  f_Sign		EQU	0000000010000000B
  1411                                  f_Zero		EQU	0000000001000000B
  1412                                  f_Aux		EQU	0000000000010000B
  1413                                  f_Parity	EQU	0000000000000100B
  1414                                  f_Carry 	EQU	0000000000000001B
  1415                                  
  1416                                  ;============================================================================
  1417                                  ; FILEMODE.INC, MSDOS 6.0, 1991
  1418                                  ;============================================================================
  1419                                  ; 13/07/2018 - Retro DOS v3.0
  1420                                  ; 29/04/2019 - Retro DOS v4.0
  1421                                  
  1422                                  ;**	Standard I/O file handles
  1423                                  
  1424                                  stdin       EQU     0
  1425                                  stdout      EQU     1
  1426                                  stderr      EQU     2
  1427                                  stdaux      EQU     3
  1428                                  stdprn      EQU     4
  1429                                  
  1430                                  ;**	File Modes
  1431                                  ; <Xenix subfunction assignments>  ; MSDOS 3.3 FILEMODE.INC
  1432                                  
  1433                                  open_for_read   EQU 0
  1434                                  open_for_write  EQU 1
  1435                                  open_for_both   EQU 2
  1436                                  
  1437                                  ; MSDOS 6.0
  1438                                  OPEN_FOR_BOTH	equ 2
  1439                                  EXEC_OPEN	equ 3	; access code of 3 indicates that open was 
  1440                                  				; made from exec
  1441                                  
  1442                                  access_mask	EQU 0Fh ; 09/08/2018
  1443                                  
  1444                                  SHARING_MASK	    equ 0F0h
  1445                                  SHARING_COMPAT	    equ 000h
  1446                                  SHARING_DENY_BOTH   equ 010h
  1447                                  SHARING_DENY_WRITE  equ 020h
  1448                                  SHARING_DENY_READ   equ 030h
  1449                                  SHARING_DENY_NONE   equ 040h
  1450                                  SHARING_NET_FCB     equ 070h
  1451                                  SHARING_NO_INHERIT  equ 080h
  1452                                  
  1453                                  ; 29/04/2019
  1454                                  
  1455                                  ;**	Extended Open Definitions
  1456                                  
  1457                                  RESERVED_BITS_MASK equ 0FE00h	; reserved bits for extended open flags
  1458                                  EXISTS_MASK	   equ 0Fh 	; "file exists" action field
  1459                                  NOT_EXISTS_MASK    equ 0F0h
  1460                                  
  1461                                  ;*	SF_MODE values
  1462                                  
  1463                                  AUTO_COMMIT_WRITE	equ 4000h
  1464                                  INT_24_ERROR		equ 2000h
  1465                                  
  1466                                  ;*	Flags in EXTOPEN_ON
  1467                                  
  1468                                  EXT_OPEN_ON		equ 01h
  1469                                  EXT_FILE_NOT_EXISTS	equ 04h
  1470                                  EXT_OPEN_I24_OFF	equ 02h
  1471                                  
  1472                                  ;*	Flags in EXTOPEN_FLAG
  1473                                  
  1474                                  ACTION_OPENED		equ 01h
  1475                                  ACTION_CREATED_OPENED	equ 02h
  1476                                  ACTION_REPLACED_OPENED	equ 03h
  1477                                  EXT_EXISTS_OPEN 	equ 01h
  1478                                  EXT_EXISTS_FAIL 	equ 00h
  1479                                  EXT_NEXISTS_CREATE	equ 10h
  1480                                  
  1481                                  ;**	Extended Open Structure
  1482                                  
  1483                                  struc EXT_OPEN_PARM
  1484 00000000 ????????                .SET_LIST:	resd 1
  1485 00000004 ????                    .NUM_OF_PARM:	resw 1
  1486                                  endstruc
  1487                                  
  1488                                  ;============================================================================
  1489                                  ; SYSCALL.INC, MSDOS 6.0, 1991
  1490                                  ;============================================================================
  1491                                  ; 29/04/2019 - Retro DOS v4.0
  1492                                  ; 09/07/2018 - Retro DOS v3.0 (SYSCALL.INC, MSDOS 3.3, 1987)
  1493                                  
  1494                                  ; <system call definitions>
  1495                                  
  1496                                  ABORT                           EQU 0   ;  0      0
  1497                                  STD_CON_INPUT                   EQU 1   ;  1      1
  1498                                  STD_CON_OUTPUT                  EQU 2   ;  2      2
  1499                                  STD_AUX_INPUT                   EQU 3   ;  3      3
  1500                                  STD_AUX_OUTPUT                  EQU 4   ;  4      4
  1501                                  STD_PRINTER_OUTPUT              EQU 5   ;  5      5
  1502                                  RAW_CON_IO                      EQU 6   ;  6      6
  1503                                  RAW_CON_INPUT                   EQU 7   ;  7      7
  1504                                  STD_CON_INPUT_NO_ECHO           EQU 8   ;  8      8
  1505                                  STD_CON_STRING_OUTPUT           EQU 9   ;  9      9
  1506                                  STD_CON_STRING_INPUT            EQU 10  ; 10      A
  1507                                  STD_CON_INPUT_STATUS            EQU 11  ; 11      B
  1508                                  STD_CON_INPUT_FLUSH             EQU 12  ; 12      C
  1509                                  DISK_RESET                      EQU 13  ; 13      D
  1510                                  SET_DEFAULT_DRIVE               EQU 14  ; 14      E
  1511                                  FCB_OPEN                        EQU 15  ; 15      F
  1512                                  FCB_CLOSE                       EQU 16  ; 16     10
  1513                                  DIR_SEARCH_FIRST                EQU 17  ; 17     11
  1514                                  DIR_SEARCH_NEXT                 EQU 18  ; 18     12
  1515                                  FCB_DELETE                      EQU 19  ; 19     13
  1516                                  FCB_SEQ_READ                    EQU 20  ; 20     14
  1517                                  FCB_SEQ_WRITE                   EQU 21  ; 21     15
  1518                                  FCB_CREATE                      EQU 22  ; 22     16
  1519                                  FCB_RENAME                      EQU 23  ; 23     17
  1520                                  GET_DEFAULT_DRIVE               EQU 25  ; 25     19
  1521                                  SET_DMA                         EQU 26  ; 26     1A
  1522                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1523                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1524                                  ;                                                                          ;
  1525                                  GET_DEFAULT_DPB                 EQU 31  ; 31     1F
  1526                                  ;                                                                          ;
  1527                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1528                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1529                                  FCB_RANDOM_READ                 EQU 33  ; 33     21
  1530                                  FCB_RANDOM_WRITE                EQU 34  ; 34     22
  1531                                  GET_FCB_FILE_LENGTH             EQU 35  ; 35     23
  1532                                  GET_FCB_POSITION                EQU 36  ; 36     24
  1533                                  SET_INTERRUPT_VECTOR            EQU 37  ; 37     25
  1534                                  CREATE_PROCESS_DATA_BLOCK       EQU 38  ; 38     26
  1535                                  FCB_RANDOM_READ_BLOCK           EQU 39  ; 39     27
  1536                                  FCB_RANDOM_WRITE_BLOCK          EQU 40  ; 40     28
  1537                                  PARSE_FILE_DESCRIPTOR           EQU 41  ; 41     29
  1538                                  GET_DATE                        EQU 42  ; 42     2A
  1539                                  SET_DATE                        EQU 43  ; 43     2B
  1540                                  GET_TIME                        EQU 44  ; 44     2C
  1541                                  SET_TIME                        EQU 45  ; 45     2D
  1542                                  SET_VERIFY_ON_WRITE             EQU 46  ; 46     2E
  1543                                  ; Extended functionality group
  1544                                  GET_DMA                         EQU 47  ; 47     2F
  1545                                  GET_VERSION                     EQU 48  ; 48     30
  1546                                  KEEP_PROCESS                    EQU 49  ; 49     31
  1547                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1548                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1549                                  ;                                                                          ;
  1550                                  GET_DPB                         EQU 50  ; 50     32
  1551                                  ;                                                                          ;
  1552                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1553                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1554                                  SET_CTRL_C_TRAPPING             EQU 51  ; 51     33
  1555                                  GET_INDOS_FLAG                  EQU 52  ; 52     34
  1556                                  GET_INTERRUPT_VECTOR            EQU 53  ; 53     35
  1557                                  GET_DRIVE_FREESPACE             EQU 54  ; 54     36
  1558                                  CHAR_OPER                       EQU 55  ; 55     37
  1559                                  INTERNATIONAL                   EQU 56  ; 56     38
  1560                                  ; XENIX CALLS
  1561                                  ;   Directory Group
  1562                                  MKDIR                           EQU 57  ; 57     39
  1563                                  RMDIR                           EQU 58  ; 58     3A
  1564                                  CHDIR                           EQU 59  ; 59     3B
  1565                                  ;   File Group
  1566                                  CREAT                           EQU 60  ; 60     3C
  1567                                  OPEN                            EQU 61  ; 61     3D
  1568                                  CLOSE                           EQU 62  ; 62     3E
  1569                                  READ                            EQU 63  ; 63     3F
  1570                                  WRITE                           EQU 64  ; 64     40
  1571                                  UNLINK                          EQU 65  ; 65     41
  1572                                  LSEEK                           EQU 66  ; 66     42
  1573                                  CHMOD                           EQU 67  ; 67     43
  1574                                  IOCTL                           EQU 68  ; 68     44
  1575                                  XDUP                            EQU 69  ; 69     45
  1576                                  XDUP2                           EQU 70  ; 70     46
  1577                                  CURRENT_DIR                     EQU 71  ; 71     47
  1578                                  ;    Memory Group
  1579                                  ALLOC                           EQU 72  ; 72     48
  1580                                  DEALLOC                         EQU 73  ; 73     49
  1581                                  SETBLOCK                        EQU 74  ; 74     4A
  1582                                  ;    Process Group
  1583                                  EXEC                            EQU 75  ; 75     4B
  1584                                  EXIT                            EQU 76  ; 76     4C
  1585                                  _WAIT				EQU 77  ; 77     4D
  1586                                  FIND_FIRST                      EQU 78  ; 78     4E
  1587                                  ;   Special Group
  1588                                  FIND_NEXT                       EQU 79  ; 79     4F
  1589                                  ; SPECIAL SYSTEM GROUP
  1590                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1591                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1592                                  ;                                                                          ;
  1593                                  SET_CURRENT_PDB                 EQU 80  ; 80     50
  1594                                  GET_CURRENT_PDB                 EQU 81  ; 81     51
  1595                                  GET_IN_VARS                     EQU 82  ; 82     52
  1596                                  SETDPB                          EQU 83  ; 83     53
  1597                                  ;                                                                          ;
  1598                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1599                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1600                                  GET_VERIFY_ON_WRITE             EQU 84  ; 84     54
  1601                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1602                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1603                                  ;                                                                          ;
  1604                                  DUP_PDB                         EQU 85  ; 85     55
  1605                                  ;                                                                          ;
  1606                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1607                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1608                                  RENAME                          EQU 86  ; 86     56
  1609                                  FILE_TIMES                      EQU 87  ; 87     57
  1610                                  ALLOCOPER			EQU 88	; 88	 58
  1611                                  ; Network extention system calls
  1612                                  GETEXTENDEDERROR		EQU 89	; 89	 59
  1613                                  CREATETEMPFILE			EQU 90	; 90	 5A
  1614                                  CREATENEWFILE			EQU 91	; 91	 5B
  1615                                  LOCKOPER			EQU 92	; 92	 5C Lock and Unlock
  1616                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1617                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  1618                                  ;									   ;
  1619                                  SERVERCALL			EQU 93	; 93	 5D CommitAll, ServerDOSCall,
  1620                                  					;	    CloseByName, CloseUser,
  1621                                  					;	    CloseUserProcess,
  1622                                  					;	    GetOpenFileList
  1623                                  ;									   ;
  1624                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  1625                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1626                                  USEROPER			EQU 94	; 94	 5E Get and Set
  1627                                  ASSINGOPER			EQU 95	; 95	 5F On, Off, Get, Set, Cancel
  1628                                  XNAMETRANS			EQU 96	; 96	 60
  1629                                  PATHPARSE			EQU 97	; 97	 61
  1630                                  GETCURRENTPSP			EQU 98	; 98	 62
  1631                                  HONGEUL 			EQU 99	; 99	 63
  1632                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1633                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  1634                                  ;									   ;
  1635                                  SET_PRINTER_FLAG		EQU 100 ; 100	 64
  1636                                  ;									   ;
  1637                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  1638                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1639                                  GETEXTCNTRY			EQU 101 ; 101	 65 
  1640                                  GETSETCDPG			EQU 102 ; 102	 66
  1641                                  EXTHANDLE			EQU 103 ; 103	 67
  1642                                  COMMIT				EQU 104 ; 104	 68
  1643                                  
  1644                                  ; 29/04/2019 - Retro DOS v4.0
  1645                                  ; (MSDOS 6.0, SYSCALL.INC, 1987)
  1646                                  
  1647                                  GetSetMediaID			EQU 105 ; 105	 69
  1648                                  IFS_IOCTL			EQU 107 ; 107	 6B
  1649                                  ExtOpen 			EQU 108 ; 108	 6C
  1650                                  
  1651                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1652                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1653                                  ;                                                                          ;
  1654                                  ;ifdef ROMEXEC
  1655                                  ;ROM_FIND_FIRST			EQU 109 ; 109    6D
  1656                                  ;ROM_FIND_NEXT			EQU 110 ; 110    6E
  1657                                  ;ROM_EXCLUDE			EQU 111 ; 111	 6F		; M035
  1658                                  ;endif
  1659                                  ;                                                                          ;
  1660                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  1661                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  1662                                  
  1663                                  SET_OEM_HANDLER			EQU 248 ; 248    F8
  1664                                  ;OEM_C1				EQU 249 ; 249    F9
  1665                                  ;OEM_C2				EQU 250 ; 250    FA
  1666                                  ;OEM_C3				EQU 251 ; 251    FB
  1667                                  ;OEM_C4				EQU 252 ; 252    FC
  1668                                  ;OEM_C5				EQU 253 ; 253    FD
  1669                                  ;OEM_C6				EQU 254 ; 254    FE
  1670                                  ;OEM_C7				EQU 255 ; 255    FF
  1671                                  
  1672                                  ; 01/01/2024 - Retro DOS v5.0 - PCDOS 7.1 IBMDOS.COM
  1673                                  ; (PCDOS 7.1 extension to MSDOS 6.22 system calls)
  1674                                   
  1675                                  ExtCountryInfo 			equ 112	; 70h
  1676                                  LONGNAME			equ 113	; 71h
  1677                                  LFNFINDCLOSE			equ 114 ; 72h
  1678                                  FAT32EXT			equ 115	; 73h
  1679                                  
  1680                                  ;============================================================================
  1681                                  ; VERSIONA.INC (MSDOS 6.0, 1991)
  1682                                  ;============================================================================
  1683                                  ; 24/04/2019 - Retro DOS 4.0
  1684                                  
  1685                                  ;MAJOR_VERSION	EQU     6
  1686                                  ;;MINOR_VERSION	EQU	00
  1687                                  ;MINOR_VERSION	EQU     21  ; MSDOS 6.21
  1688                                  
  1689                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  1690                                  ;MAJOR_VERSION	EQU     5
  1691                                  ;MINOR_VERSION	EQU     0
  1692                                  
  1693                                  ; 30/12/2022 - Retro DOS v4.2
  1694                                  ;MAJOR_VERSION	EQU     6
  1695                                  ;MINOR_VERSION	EQU     22
  1696                                  
  1697                                  ; 01/01/2024 - Retro DOS v5.0
  1698                                  MAJOR_VERSION	EQU     7
  1699                                  MINOR_VERSION	EQU     10  ; PCDOS 7.1	(7.10)
  1700                                  
  1701                                  ;============================================================================
  1702                                  ; INTNAT.INC, MSDOS 3.3, 1987
  1703                                  ;============================================================================
  1704                                  ; 09/07/2018 - Retro DOS 3.0
  1705                                  
  1706                                  ; Current structure of the data returned by the international call
  1707                                  
  1708                                  struc	INTERNAT_BLOCK		; (-*-) Same with MSDOS 2.11 & MSDOS 6.0
  1709                                  .Date_tim_format:
  1710 00000000 ????                    		RESW 1		; 0-USA, 1-EUR, 2-JAP
  1711                                  .Currency_sym:
  1712 00000002 ??????????              		RESB 5		; Currency Symbol 5 bytes
  1713                                  .Thous_sep:
  1714 00000007 ????                    		RESB 2		; Thousands separator 2 bytes
  1715                                  .Decimal_sep:
  1716 00000009 ????                    		RESB 2		; Decimal separator 2 bytes
  1717                                  .Date_sep:
  1718 0000000B ????                    		RESB 2		; Date separator 2 bytes
  1719                                  .Time_sep:
  1720 0000000D ????                    		RESB 2		; Time separator 2 bytes
  1721                                  .Bit_field:	
  1722 0000000F ??                      		RESB 1		; Bit values
  1723                                                                     ;   Bit 0 = 0 if currency symbol first
  1724                                                                     ;         = 1 if currency symbol last
  1725                                                                     ;   Bit 1 = 0 if No space after currency symbol
  1726                                                                     ;         = 1 if space after currency symbol
  1727                                  .Currency_cents:
  1728 00000010 ??                      		RESB 	1	; Number of places after currency dec point
  1729                                  .Time_24:
  1730 00000011 ??                      		RESB 	1	; 1 if 24 hour time, 0 if 12 hour time
  1731                                  .Map_call:
  1732 00000012 ????                    		RESW	1	; Address of case mapping call (DWORD)
  1733 00000014 ????                                    RESW	1       ; THIS IS TWO WORDS SO IT CAN BE INITIALIZED
  1734                                  				;  in pieces.
  1735                                  .Data_sep:
  1736 00000016 ????                    		RESB	2	; Data list separator character
  1737                                  .size:		
  1738                                  endstruc
  1739                                  
  1740                                  ; Max size of the block returned by the INTERNATIONAL call
  1741                                  
  1742                                  internat_block_max	EQU	32
  1743                                  
  1744                                  ;============================================================================
  1745                                  ; SYSVAR.INC (MSDOS 6.0, 1991)
  1746                                  ;============================================================================
  1747                                  ; 08/07/2018 - Retro DOS v3.0
  1748                                  
  1749                                  ; 01/01/2024 - Retro DOS v5.0
  1750                                  
  1751                                  ;SysInitVars STRUC
  1752                                  struc SYSI
  1753 00000000 ????????                .DPB:	    resd 1	; 0	; DPB chain
  1754 00000004 ????????                .SFT:	    resd 1	; 4	; SFT chain
  1755 00000008 ????????                .CLOCK:	    resd 1	; 8	; CLOCK device
  1756 0000000C ????????                .CON:	    resd 1	; 12	; CON device
  1757 00000010 ????                    .MAXSEC:    resw 1	; 16	; maximum sector size
  1758 00000012 ????????                .BUF:	    resd 1	; 18	; points to Hashinitvar
  1759 00000016 ????????                .CDS:	    resd 1	; 22	; CDS list
  1760 0000001A ????????                .FCB:	    resd 1	; 26	; FCB chain
  1761 0000001E ????                    .Keep:	    resw 1	; 30	; keep count
  1762 00000020 ??                      .NUMIO:	    resb 1	; 32	; Number of block devices
  1763 00000021 ??                      .NCDS:	    resb 1	; 33	; number of CDS's
  1764 00000022 ????????                .DEV:	    resd 1	; 34	; device list
  1765                                  ; 09/07/2018
  1766                                  ; Above parameters are described in MSDOS 3.3 SYSVAR.INC (85/04/10)
  1767                                  ; Following parameters are used with MSDOS 6.0 (Retro DOS v4.0)
  1768 00000026 ????                    .ATTR:	    resw 1	; 38	; null device attribute word
  1769 00000028 ????                    .STRAT:	    resw 1	; 40	; null device strategy entry point
  1770 0000002A ????                    .INTER:	    resw 1	; 42	; null device interrupt entry point
  1771 0000002C ????????????????        .NAME:	    resb 8	; 44	; null device name
  1772 00000034 ??                      .SPLICE:    resb 1	; 52	; TRUE -> splicees being done
  1773 00000035 ????                    .IBMDOS_SIZE: resw 1	; 53 	; DOS size in paragraphs
  1774 00000037 ????????                .IFS_DOSCALL@: resd 1	; 55	; IFS DOS service routine entry
  1775 0000003B ????????                .IFS:	    resd 1	; 59	; IFS header chain
  1776 0000003F ????????                .BUFFERS:   resw 2	; 63	; BUFFERS= values (m,n)
  1777 00000043 ??                      .BOOT_DRIVE: resb 1	; 67	; boot drive A=1 B=2,..
  1778 00000044 ??                      .DWMOVE:    resb 1	; 68	; 1 if 386 machine
  1779 00000045 ????                    .EXT_MEM:   resw 1	; 69	; Extended memory size in KB.
  1780                                  endstruc
  1781                                  ;SysInitVars ENDS
  1782                                  
  1783                                  ;This is added for more information exchange between DOS, BIOS.
  1784                                  ;DOS will give the pointer to SysInitTable in ES:DI. - J.K. 5/29/86
  1785                                  
  1786                                  ;SysInitVars_Ext struc
  1787                                  struc SYSI_EXT
  1788 00000000 ????????                .SysInitVars:	resd 1		; Points to the above structure.
  1789 00000004 ????????                .Country_Tab:	resd 1		; DOS_Country_cdpg_info
  1790                                  endstruc
  1791                                  ;SysInitVars_Ext ends
  1792                                  
  1793                                  ;============================================================================
  1794                                  ; IOCTL.INC - MSDOS 6.0 - 1991
  1795                                  ;============================================================================
  1796                                  ; 09/07/2018 - Retro DOS v3.0
  1797                                  
  1798                                  ;*** J.K.
  1799                                  ;General Guide -
  1800                                  ;Category Code:
  1801                                  ; 0... .... DOS Defined
  1802                                  ; 1... .... User defined
  1803                                  ; .xxx xxxx Code
  1804                                  
  1805                                  ;Function Code:
  1806                                  ; 0... .... Return error if unsupported
  1807                                  ; 1... .... Ignore if unsupported
  1808                                  ; .0.. .... Intercepted by DOS
  1809                                  ; .1.. .... Passed to driver
  1810                                  ; ..0. .... Sends data/commands to device
  1811                                  ; ..1. .... Quries data/info from device
  1812                                  ; ...x .... Subfunction
  1813                                  ;
  1814                                  ; Note that "Sends/queries" data bit is intended only to regularize the
  1815                                  ; function set.  It plays no critical role; some functions may contain both
  1816                                  ; command and query elements. The convention is that such commands are
  1817                                  ; defined as "sends data".
  1818                                  
  1819                                  ;*****************************;*
  1820                                  ; BLOCK DRIVERS 	      ;*
  1821                                  ;*****************************;*
  1822                                  
  1823                                  ; IOCTL SUB-FUNCTIONS
  1824                                  ; (MSDOS 3.3 + MSDOS 6.0)
  1825                                  IOCTL_GET_DEVICE_INFO	EQU	0
  1826                                  IOCTL_SET_DEVICE_INFO	EQU	1
  1827                                  IOCTL_READ_HANDLE	EQU	2
  1828                                  IOCTL_WRITE_HANDLE	EQU	3
  1829                                  IOCTL_READ_DRIVE	EQU	4
  1830                                  IOCTL_WRITE_DRIVE	EQU	5
  1831                                  IOCTL_GET_INPUT_STATUS	EQU	6
  1832                                  IOCTL_GET_OUTPUT_STATUS EQU	7
  1833                                  IOCTL_CHANGEABLE?	EQU	8
  1834                                  IOCTL_DeviceLocOrRem?	EQU	9
  1835                                  IOCTL_HandleLocOrRem?	EQU	0Ah   ;10
  1836                                  IOCTL_SHARING_RETRY	EQU	0Bh   ;11
  1837                                  GENERIC_IOCTL_HANDLE	EQU	0Ch   ;12
  1838                                  GENERIC_IOCTL		EQU	0Dh   ;13
  1839                                  ; (MSDOS 6.0 + MSDOS 3.3)
  1840                                  IOCTL_GET_DRIVE_MAP 	EQU	0Eh   ;14
  1841                                  IOCTL_SET_DRIVE_MAP	EQU	0Fh   ;15
  1842                                  ; (MSDOS 6.0)
  1843                                  IOCTL_QUERY_HANDLE	EQU	10h   ;16
  1844                                  IOCTL_QUERY_BLOCK	EQU	11h   ;17
  1845                                  
  1846                                  ; GENERIC IOCTL CATEGORY CODES
  1847                                  IOC_OTHER		EQU	0	; Other device control J.K. 4/29/86
  1848                                  IOC_SE			EQU	1	; SERIAL DEVICE CONTROL
  1849                                  IOC_TC			EQU	2	; TERMINAL CONTROL
  1850                                  IOC_SC			EQU	3	; SCREEN CONTROL
  1851                                  IOC_KC			EQU	4	; KEYBOARD CONTROL
  1852                                  IOC_PC			EQU	5	; PRINTER CONTROL
  1853                                  IOC_DC			EQU	8	; DISK CONTROL (SAME AS RAWIO)
  1854                                  
  1855                                  ; GENERIC IOCTL SUB-FUNCTIONS
  1856                                  RAWIO			EQU	8
  1857                                  
  1858                                  ; RAWIO SUB-FUNCTIONS
  1859                                  ; (MSDOS 3.3 + MSDOS 6.0)
  1860                                  GET_DEVICE_PARAMETERS	EQU	60H
  1861                                  SET_DEVICE_PARAMETERS	EQU	40H
  1862                                  READ_TRACK		EQU	61H
  1863                                  WRITE_TRACK		EQU	41H
  1864                                  VERIFY_TRACK		EQU	62H
  1865                                  FORMAT_TRACK		EQU	42H
  1866                                  ; (MSDOS 6.0)
  1867                                  GET_MEDIA_ID		EQU	66h	;AN000;AN003;changed from 63h
  1868                                  SET_MEDIA_ID		EQU	46h	;AN000;AN003;changed from 43h
  1869                                  GET_ACCESS_FLAG 	EQU	67h	;AN002;AN003;Unpublished function.Changed from 64h
  1870                                  SET_ACCESS_FLAG 	EQU	47h	;AN002;AN003;Unpublished function.Changed from 44h
  1871                                  SENSE_MEDIA_TYPE	EQU	68H	;Added for 5.00
  1872                                  
  1873                                  ; SPECIAL FUNCTION FOR GET DEVICE PARAMETERS
  1874                                  BUILD_DEVICE_BPB	EQU	000000001B
  1875                                  
  1876                                  ; SPECIAL FUNCTIONS FOR SET DEVICE PARAMETERS
  1877                                  INSTALL_FAKE_BPB	EQU	000000001B
  1878                                  ONLY_SET_TRACKLAYOUT	EQU	000000010B
  1879                                  TRACKLAYOUT_IS_GOOD	EQU	000000100B
  1880                                  
  1881                                  ; SPECIAL FUNCTION FOR FORMAT TRACK
  1882                                  ; (MSDOS 3.3 + MSDOS 6.0)
  1883                                  STATUS_FOR_FORMAT	EQU	000000001B
  1884                                  ; (MSDOS 6.0)
  1885                                  DO_FAST_FORMAT		EQU	000000010B ;AN001;
  1886                                  
  1887                                  ; CODES RETURNED FROM FORMAT STATUS CALL
  1888                                  FORMAT_NO_ROM_SUPPORT	EQU	000000001B
  1889                                  FORMAT_COMB_NOT_SUPPORTED EQU	000000010B
  1890                                  
  1891                                  ; DEVICETYPE VALUES
  1892                                  ; (MSDOS 3.3 + MSDOS 6.0)
  1893                                  MAX_SECTORS_IN_TRACK	EQU	63	; MAXIMUM SECTORS ON A DISK.(Was 40 in DOS 3.2)
  1894                                  DEV_5INCH		EQU	0
  1895                                  DEV_5INCH96TPI		EQU	1
  1896                                  DEV_3INCH720KB		EQU	2
  1897                                  DEV_8INCHSS		EQU	3
  1898                                  DEV_8INCHDS		EQU	4
  1899                                  DEV_HARDDISK		EQU	5
  1900                                  DEV_OTHER		EQU	7
  1901                                  ; (MSDOS 6.0)
  1902                                  ;DEV_3INCH1440KB	EQU	7
  1903                                  DEV_3INCH2880KB		EQU	9
  1904                                  ; Retro DOS v2.0 - 26/03/2018
  1905                                  ;;DEV_TAPE		EQU	6
  1906                                  ;;DEV_ERIMO		EQU	8
  1907                                  ;DEV_3INCH2880KB	EQU	9
  1908                                  DEV_3INCH1440KB		EQU	10
  1909                                  
  1910                                  ; (MSDOS 3.3)
  1911                                  ;MAX_DEV_TYPE		EQU	7
  1912                                  
  1913                                  ; (MSDOS 6.0)
  1914                                  MAX_DEV_TYPE		EQU	10	; MAXIMUM DEVICE TYPE THAT WE
  1915                                  					; CURRENTLY SUPPORT.
  1916                                  struc A_SECTORTABLE
  1917 00000000 ????                    .ST_SECTORNUMBER:	resw	1
  1918 00000002 ????                    .ST_SECTORSIZE:		resw	1
  1919                                  .size:
  1920                                  endstruc
  1921                                  
  1922                                  ;============================================================================
  1923                                  ; DEVSYM.INC
  1924                                  ;============================================================================
  1925                                  ; 07/07/2018 - Retro DOS v3.0
  1926                                  ; 30/04/2019 - Retro DOS v4.0 (DEVSYM.INC, MSDOS 6.0, 1991)
  1927                                  ; 21/02/2024 - Retro DOS v5.0
  1928                                  
  1929                                  ;**	DevSym.inc - Device Symbols
  1930                                  
  1931                                  ; The device table list has the form:
  1932                                  struc	SYSDEV
  1933 00000000 ????????                .NEXT:		resd 1		;Pointer to next device header
  1934 00000004 ????                    .ATT:		resw 1		;Attributes of the device
  1935 00000006 ????                    .STRAT:		resw 1		;Strategy entry point
  1936 00000008 ????                    .INT:		resw 1		;Interrupt entry point
  1937 0000000A ????????????????        .NAME:		resb 8		;Name of device (only first byte used for block)
  1938                                  .size:
  1939                                  endstruc
  1940                                  
  1941                                  ;
  1942                                  ; ATTRIBUTE BIT MASKS
  1943                                  ;
  1944                                  ; CHARACTER DEVICES:
  1945                                  ;
  1946                                  ; BIT 15 -> MUST BE 1
  1947                                  ;     14 -> 1 IF THE DEVICE UNDERSTANDS IOCTL CONTROL STRINGS
  1948                                  ;     13 -> 1 IF THE DEVICE SUPPORTS OUTPUT-UNTIL-BUSY
  1949                                  ;     12 -> UNUSED
  1950                                  ;     11 -> 1 IF THE DEVICE UNDERSTANDS OPEN/CLOSE
  1951                                  ;     10 -> MUST BE 0
  1952                                  ;      9 -> MUST BE 0
  1953                                  ;      8 -> UNUSED
  1954                                  ;      7 -> UNUSED
  1955                                  ;      6 -> UNUSED
  1956                                  ;      5 -> UNUSED
  1957                                  ;      4 -> 1 IF DEVICE IS RECIPIENT OF INT 29H
  1958                                  ;      3 -> 1 IF DEVICE IS CLOCK DEVICE
  1959                                  ;      2 -> 1 IF DEVICE IS NULL DEVICE
  1960                                  ;      1 -> 1 IF DEVICE IS CONSOLE OUTPUT
  1961                                  ;      0 -> 1 IF DEVICE IS CONSOLE INPUT
  1962                                  ;
  1963                                  ; BLOCK DEVICES:
  1964                                  ;
  1965                                  ; BIT 15 -> MUST BE 0
  1966                                  ;     14 -> 1 IF THE DEVICE UNDERSTANDS IOCTL CONTROL STRINGS
  1967                                  ;     13 -> 1 IF THE DEVICE DETERMINES MEDIA BY EXAMINING THE FAT ID BYTE.
  1968                                  ;	    THIS REQUIRES THE FIRST SECTOR OF THE FAT TO *ALWAYS* RESIDE IN
  1969                                  ;	    THE SAME PLACE.
  1970                                  ;     12 -> UNUSED
  1971                                  ;     11 -> 1 IF THE DEVICE UNDERSTANDS OPEN/CLOSE/REMOVABLE MEDIA
  1972                                  ;     10 -> MUST BE 0
  1973                                  ;      9 -> MUST BE 0
  1974                                  ;      8 -> UNUSED
  1975                                  ;      7 -> UNUSED
  1976                                  ;      6 -> IF DEVICE HAS SUPPORT FOR GETMAP/SETMAP OF LOGICAL DRIVES.
  1977                                  ;	    IF THE DEVICE UNDERSTANDS GENERIC IOCTL FUNCTION CALLS.
  1978                                  ;      5 -> UNUSED
  1979                                  ;      4 -> UNUSED
  1980                                  ;      3 -> UNUSED
  1981                                  ;      2 -> UNUSED
  1982                                  ;      1 -> UNUSED
  1983                                  ;      0 -> UNUSED
  1984                                  ;
  1985                                  
  1986                                  ;Attribute bit masks
  1987                                  DEVTYP	EQU     8000H           ;Bit 15 - 1 if Char, 0 if block
  1988                                  DEVIOCTL EQU    4000H           ;Bit 14 - CONTROL mode bit
  1989                                  ISFATBYDEV EQU  2000H           ;Bit 13 - Device uses FAT ID bytes, comp media.
  1990                                  
  1991                                  ; 09/07/2018 - Retro DOS (DEVSYM.INC, MSDOS 3.3, 1987) 
  1992                                  
  1993                                  OUTTILBUSY EQU	2000H		; OUTPUT UNTIL BUSY IS ENABLED
  1994                                  ISNET	   EQU	1000H		; BIT 12 - 1 IF A NET DEVICE, 0 IF
  1995                                  				;  NOT.  CURRENTLY BLOCK ONLY.
  1996                                  DEVOPCL    EQU	0800H		; BIT 11 - 1 IF THIS DEVICE HAS
  1997                                  				;  OPEN,CLOSE AND REMOVABLE MEDIA
  1998                                  				;  ENTRY POINTS, 0 IF NOT
  1999                                  
  2000                                  EXTENTBIT  EQU	0400H		; BIT 10 - CURRENTLY 0 ON ALL DEVS
  2001                                  				;  THIS BIT IS RESERVED FOR FUTURE USE
  2002                                  				;  TO EXTEND THE DEVICE HEADER BEYOND
  2003                                  				;  ITS CURRENT FORM.
  2004                                  
  2005                                  ; NOTE BIT 9 IS CURRENTLY USED ON IBM SYSTEMS TO INDICATE "DRIVE IS SHARED".
  2006                                  ;    SEE IOCTL FUNCTION 9. THIS USE IS NOT DOCUMENTED, IT IS USED BY SOME
  2007                                  ;    OF THE UTILITIES WHICH ARE SUPPOSED TO FAIL ON SHARED DRIVES ON SERVER
  2008                                  ;    MACHINES (FORMAT,CHKDSK,RECOVER,..).
  2009                                  
  2010                                  IOQUERY	EQU	0080H		;Bit 7 - Supports generic IOCtl query
  2011                                  
  2012                                  DEV320	EQU	0040H		;BIT 6 - FOR BLOCK DEVICES, THIS
  2013                                  				;DEVICE SUPPORTS SET/GET MAP OF
  2014                                  				;LOGICAL DRIVES, AND SUPPORTS
  2015                                  				;GENERIC IOCTL CALLS.
  2016                                  				;FOR CHARACTER DEVICES, THIS
  2017                                  				;DEVICE SUPPORTS GENERIC IOCTL.
  2018                                  				;THIS IS A DOS 3.2 DEVICE DRIVER.
  2019                                  
  2020                                  ISSPEC	EQU     0010H		;Bit 4 - This device is special ; 15/03/2018
  2021                                  ;ISIBM	EQU     0010H		;Bit 4 - This device is special
  2022                                  ISCLOCK EQU     0008H           ;Bit 3 - This device is the clock device.
  2023                                  ISNULL  EQU     0004H           ;Bit 2 - This device is the null device.
  2024                                  ISCOUT  EQU     0002H           ;Bit 1 - This device is the console output.
  2025                                  ISCIN   EQU     0001H           ;Bit 0 - This device is the console input.
  2026                                  
  2027                                  EXTDRVR	EQU	0002h		;BIT 1 - BLOCK DEVICE EXTENDED DRIVER
  2028                                  				; (MSDOS 6.0, DEVSYM.INC, 1991) ; 30/04/2019
  2029                                  
  2030                                  ;Static Reguest Header
  2031                                  struc	SRHEAD
  2032 00000000 ??                      .REQLEN:	resb 1		;Length in bytes of request block
  2033 00000001 ??                      .REQUNIT:	resb 1		;Device unit number
  2034 00000002 ??                      .REQFUNC:	resb 1		;Type of request
  2035 00000003 ????                    .REQSTAT:	resw 1		;Status Word
  2036 00000005 ????????????????                	resb 8		;Reserved for queue links
  2037                                  .size:
  2038                                  endstruc
  2039                                  
  2040                                  ;Status word masks
  2041                                  STERR   EQU     8000H           ;Bit 15 - Error
  2042                                  STBUI   EQU     0200H           ;Bit 9 - Buisy
  2043                                  STDON   EQU     0100H           ;Bit 8 - Done
  2044                                  STECODE EQU     00FFH           ;Error code
  2045                                  WRECODE EQU     0
  2046                                  
  2047                                  ;Function codes
  2048                                  ;DINITHL EQU    26              ;Size of init header
  2049                                  ; 11/04/2024 - Retro DOS 5.0
  2050                                  DINITHL EQU     25 ; PCDOS 7.1  ;Size of init header
  2051                                  DMEDHL  EQU     15              ;Size of media check header
  2052                                  DBPBHL  EQU     22              ;Size of Get BPB header
  2053                                  DRDWRHL EQU     22              ;Size of RD/WR header
  2054                                  DRDNDHL EQU     14              ;Size of non destructive read header
  2055                                  DSTATHL EQU     13              ;Size of status header
  2056                                  ; 21/02/2024
  2057                                  ;DFLSHL EQU     15              ;Size of flush header
  2058                                  DFLSHL	equ	13	; PCDOS 7.1 IBMDOS.COM  ; 21/02/2024
  2059                                  
  2060                                  DEVINIT EQU     0               ;Initialization
  2061                                  DEVMDCH EQU     1               ;Media check
  2062                                  DEVBPB  EQU     2               ;Get BPB
  2063                                  DEVRDIOCTL EQU  3               ;IOCTL read
  2064                                  DEVRD   EQU     4               ;Read
  2065                                  DEVRDND EQU     5               ;Non destructive read no wait (character devs)
  2066                                  DEVIST  EQU     6               ;Input status
  2067                                  DEVIFL  EQU     7               ;Input flush
  2068                                  DEVWRT  EQU     8               ;Write
  2069                                  DEVWRTV EQU     9               ;Write with verify
  2070                                  DEVOST  EQU     10              ;Output status
  2071                                  DEVOFL  EQU     11              ;Output flush
  2072                                  DEVWRIOCTL EQU  12              ;IOCTL write
  2073                                  
  2074                                  ; 09/07/2018 - Retro DOS v3.0 (DEVSYM.INC, MSDOS 3.3, 1987) 
  2075                                  DEVOPN	EQU	13		;DEVICE OPEN
  2076                                  DEVCLS	EQU	14		;DEVICE CLOSE
  2077                                  DOPCLHL EQU	13		;SIZE OF OPEN/CLOSE HEADER
  2078                                  DEVRMD	EQU	15		;REMOVABLE MEDIA
  2079                                  ; 07/08/2018 - Retro DOS v3.0
  2080                                  REMHL	EQU	13		;SIZE OF REMOVABLE MEDIA HEADER
  2081                                  GENIOCTL EQU	19
  2082                                  
  2083                                  ; THE NEXT THREE ARE USED IN DOS 4.0
  2084                                  ;		     20
  2085                                  ;		     21
  2086                                  ;		     22
  2087                                  
  2088                                  DEVGETOWN      EQU   23		;GET DEVICE OWNER
  2089                                  DEVSETOWN      EQU   24		;SET DEVICE OWNER
  2090                                  ; 18/05/2019 - Retro DOS v4.0
  2091                                  IOCTL_QUERY    EQU   25		;Query generic ioctl support
  2092                                  
  2093                                  OWNHL	       EQU   13		;SIZE OF DEVICE OWNER HEADER
  2094                                  
  2095                                  DEVOUT	       EQU   16		; OUTPUT UNTIL BUSY.
  2096                                  DEVOUTL        EQU   DEVWRT	; LENGTH OF OUTPUT UNTIL BUSY
  2097                                  
  2098                                  ; ADDED FOR DOS 5.00
  2099                                  
  2100                                  ; GENERIC IOCTL REQUEST STRUCTURE
  2101                                  ;	SEE THE DOS 4.0 DEVICE DRIVER SPEC FOR FURTHER ELABORATION.
  2102                                  
  2103                                  struc IOCTL_REQ
  2104 00000000 <res Dh>                .SRHEAD:	resb SRHEAD.size
  2105                                  				; GENERIC IOCTL ADDITION.
  2106 0000000D ??                      .MAJORFUNCTION: resb 1		;FUNCTION CODE
  2107 0000000E ??                      .MINORFUNCTION: resb 1		;FUNCTION CATEGORY
  2108 0000000F ????                    .REG_SI:	resw 1
  2109 00000011 ????                    .REG_DI:	resw 1
  2110 00000013 ????????                .GENERICIOCTL_PACKET: resd 1	; POINTER TO DATA BUFFER
  2111                                  .size: ; 07/08/2018
  2112                                  endstruc
  2113                                  
  2114                                  ; DEFINITIONS FOR IOCTL_REQ.MINORFUNCTION
  2115                                  GEN_IOCTL_WRT_TRK EQU	40H
  2116                                  GEN_IOCTL_RD_TRK  EQU	60H
  2117                                  GEN_IOCTL_FN_TST  EQU	20H	; USED TO DIFF. BET READS AND WRTS
  2118                                  
  2119                                  ;; 32-bit absolute read/write input list structure
  2120                                  
  2121                                  struc ABS_32RW
  2122 00000000 ????????                .SECTOR_RBA:	resd 1		; relative block address
  2123 00000004 ????                    .ABS_RW_COUNT:	resw 1		; number of sectors to be transferred
  2124 00000006 ????????                .BUFFER_ADDR:	resd 1		; data addrress
  2125                                  .size:
  2126                                  endstruc
  2127                                  
  2128                                  ;; media ID info
  2129                                  
  2130                                  struc MEDIA_ID_INFO
  2131 00000000 ????                    .MEDIA_level:	resw	1	; info level
  2132 00000002 ????????                .MEDIA_Serial:	resd	1	; serial #
  2133 00000006 <res Bh>                .MEDIA_Label:	resb	11	; volume label
  2134 00000011 ????????????????        .MEDIA_System:	resb	8	; system type
  2135                                  .size:
  2136                                  endstruc
  2137                                  
  2138                                  ; equates for DOS34_FLAG
  2139                                  ; (BUGBUG: why are bits 0,1,3 and 4 not defined.)
  2140                                  
  2141                                  FROM_DISK_RESET       EQU   000000000100b   ;from disk reset
  2142                                  Force_I24_Fail	      EQU   000000100000b   ;form IFS CALL BACK
  2143                                  Disable_EOF_I24       EQU   000001000000b   ;disable EOF int24 for input status
  2144                                  DBCS_VOLID	      EQU   000010000000b   ;indicate from volume id
  2145                                  DBCS_VOLID2	      EQU   000100000000b   ;indicate 8th char is DBCS
  2146                                  CTRL_BREAK_FLAG       EQU   001000000000b   ;indicate control break is input
  2147                                  SEARCH_FASTOPEN       EQU   010000000000b   ;set fastopen flag for search
  2148                                  EXEC_AWARE_REDIR      EQU   100000000000b   ;M018: this bit is set by a redir 
  2149                                  					    ;M018: that knows how to handle 
  2150                                  					    ;M018: open for exec
  2151                                  
  2152                                  NO_FROM_DISK_RESET    EQU   ~FROM_DISK_RESET	;not from disk reset
  2153                                  NO_Force_I24_Fail     EQU   ~Force_I24_Fail	;not form IFS CALL BACK
  2154                                  NO_Disable_EOF_I24    EQU   ~Disable_EOF_I24
  2155                                  
  2156                                  ;============================================================================
  2157                                  ; ERROR.INC (MSDOS 6.0, 1991)
  2158                                  ;============================================================================
  2159                                  ; 16/07/2018 - Retro DOS v3.0 
  2160                                  
  2161                                  ;**	ERROR.INC - DOS Error Codes
  2162                                  ;
  2163                                  ;    The newer (DOS 2.0 and above) "XENIX-style" calls
  2164                                  ;    return error codes through AX. If an error occurred then
  2165                                  ;    the carry bit will be set and the error code is in AX. If no error
  2166                                  ;    occurred then the carry bit is reset and AX contains returned info.
  2167                                  ;
  2168                                  ;    Since the set of error codes is being extended as we extend the operating
  2169                                  ;    system, we have provided a means for applications to ask the system for a
  2170                                  ;    recommended course of action when they receive an error.
  2171                                  ;
  2172                                  ;    The GetExtendedError system call returns a universal error, an error
  2173                                  ;    location and a recommended course of action. The universal error code is
  2174                                  ;    a symptom of the error REGARDLESS of the context in which GetExtendedError
  2175                                  ;    is issued.
  2176                                  
  2177                                  ;	2.0 error codes
  2178                                  
  2179                                  error_invalid_function		EQU	1
  2180                                  error_file_not_found		EQU	2
  2181                                  error_path_not_found		EQU	3
  2182                                  error_too_many_open_files	EQU	4
  2183                                  error_access_denied		EQU	5
  2184                                  error_invalid_handle		EQU	6
  2185                                  error_arena_trashed		EQU	7
  2186                                  error_not_enough_memory 	EQU	8
  2187                                  error_invalid_block		EQU	9
  2188                                  error_bad_environment		EQU	10
  2189                                  error_bad_format		EQU	11
  2190                                  error_invalid_access		EQU	12
  2191                                  error_invalid_data		EQU	13
  2192                                  ;**** reserved			EQU	14	; *****
  2193                                  error_invalid_drive		EQU	15
  2194                                  error_current_directory 	EQU	16
  2195                                  error_not_same_device		EQU	17
  2196                                  error_no_more_files		EQU	18
  2197                                  
  2198                                  ;	These are the universal int 24 mappings for the old INT 24 set of errors
  2199                                  
  2200                                  error_write_protect		EQU	19
  2201                                  error_bad_unit			EQU	20
  2202                                  error_not_ready 		EQU	21
  2203                                  error_bad_command		EQU	22
  2204                                  error_CRC			EQU	23
  2205                                  error_bad_length		EQU	24
  2206                                  error_seek			EQU	25
  2207                                  error_not_DOS_disk		EQU	26
  2208                                  error_sector_not_found		EQU	27
  2209                                  error_out_of_paper		EQU	28
  2210                                  error_write_fault		EQU	29
  2211                                  error_read_fault		EQU	30
  2212                                  error_gen_failure		EQU	31
  2213                                  
  2214                                  ;	the new 3.0 error codes reported through INT 24
  2215                                  
  2216                                  error_sharing_violation 	EQU	32
  2217                                  error_lock_violation		EQU	33
  2218                                  error_wrong_disk		EQU	34
  2219                                  error_FCB_unavailable		EQU	35
  2220                                  error_sharing_buffer_exceeded	EQU	36
  2221                                  error_Code_Page_Mismatched	EQU	37    ; DOS 4.00  ;AN000;
  2222                                  error_handle_EOF		EQU	38    ; DOS 4.00  ;AN000;
  2223                                  error_handle_Disk_Full		EQU	39    ; DOS 4.00  ;AN000;
  2224                                  
  2225                                  ;	New OEM network-related errors are 50-79
  2226                                  
  2227                                  error_not_supported		EQU	50
  2228                                  
  2229                                  error_net_access_denied		EQU	65	;M028
  2230                                  
  2231                                  ;	End of INT 24 reportable errors
  2232                                  
  2233                                  error_file_exists		EQU	80
  2234                                  error_DUP_FCB			EQU	81	; *****
  2235                                  error_cannot_make		EQU	82
  2236                                  error_FAIL_I24			EQU	83
  2237                                  
  2238                                  ;	New 3.0 network related error codes
  2239                                  
  2240                                  error_out_of_structures 	EQU	84
  2241                                  error_already_assigned		EQU	85
  2242                                  error_invalid_password		EQU	86
  2243                                  error_invalid_parameter 	EQU	87
  2244                                  error_NET_write_fault		EQU	88
  2245                                  error_sys_comp_not_loaded	EQU	90    ; DOS 4.00  ;AN000;
  2246                                  
  2247                                  ;	BREAK <Interrupt 24 error codes>
  2248                                  
  2249                                  ;**	Int24 Error Codes
  2250                                  
  2251                                  error_I24_write_protect 	EQU	0
  2252                                  error_I24_bad_unit		EQU	1
  2253                                  error_I24_not_ready		EQU	2
  2254                                  error_I24_bad_command		EQU	3
  2255                                  error_I24_CRC			EQU	4
  2256                                  error_I24_bad_length		EQU	5
  2257                                  error_I24_Seek			EQU	6
  2258                                  error_I24_not_DOS_disk		EQU	7
  2259                                  error_I24_sector_not_found	EQU	8
  2260                                  error_I24_out_of_paper		EQU	9
  2261                                  error_I24_write_fault		EQU	0Ah
  2262                                  error_I24_read_fault		EQU	0Bh
  2263                                  error_I24_gen_failure		EQU	0Ch
  2264                                  ; NOTE: Code 0DH is used by MT-DOS.
  2265                                  error_I24_wrong_disk		EQU	0Fh
  2266                                  
  2267                                  ;	THE FOLLOWING ARE MASKS FOR THE AH REGISTER ON Int 24
  2268                                  ;
  2269                                  ;	NOTE: ABORT is ALWAYS allowed
  2270                                  
  2271                                  Allowed_FAIL			EQU	00001000B
  2272                                  Allowed_RETRY			EQU	00010000B
  2273                                  Allowed_IGNORE			EQU	00100000B
  2274                                  
  2275                                  I24_operation			EQU	00000001B  ;Z if READ,NZ if Write
  2276                                  I24_area			EQU	00000110B  ; 00 if DOS
  2277                                  						   ; 01 if FAT
  2278                                  						   ; 10 if root DIR
  2279                                  						   ; 11 if DATA
  2280                                  I24_class			EQU	10000000B  ;Z if DISK, NZ if FAT or char
  2281                                  
  2282                                  ;	BREAK <GetExtendedError CLASSes ACTIONs LOCUSs>
  2283                                  
  2284                                  ;**	The GetExtendedError call takes an error code and returns CLASS,
  2285                                  ;	ACTION and LOCUS codes to help programs determine the proper action
  2286                                  ;	to take for error codes that they don't explicitly understand.
  2287                                  
  2288                                  ;	Values for error CLASS
  2289                                  
  2290                                  errCLASS_OutRes 	EQU	1	; Out of Resource
  2291                                  errCLASS_TempSit	EQU	2	; Temporary Situation
  2292                                  errCLASS_Auth		EQU	3	; Permission problem
  2293                                  errCLASS_Intrn		EQU	4	; Internal System Error
  2294                                  errCLASS_HrdFail	EQU	5	; Hardware Failure
  2295                                  errCLASS_SysFail	EQU	6	; System Failure
  2296                                  errCLASS_Apperr 	EQU	7	; Application Error
  2297                                  errCLASS_NotFnd 	EQU	8	; Not Found
  2298                                  errCLASS_BadFmt 	EQU	9	; Bad Format
  2299                                  errCLASS_Locked 	EQU	10	; Locked
  2300                                  errCLASS_Media		EQU	11	; Media Failure
  2301                                  errCLASS_Already	EQU	12	; Collision with Existing Item
  2302                                  errCLASS_Unk		EQU	13	; Unknown/other
  2303                                  
  2304                                  ;	Values for error ACTION
  2305                                  
  2306                                  errACT_Retry		EQU	1	; Retry
  2307                                  errACT_DlyRet		EQU	2	; Delay Retry, retry after pause
  2308                                  errACT_User		EQU	3	; Ask user to regive info
  2309                                  errACT_Abort		EQU	4	; abort with clean up
  2310                                  errACT_Panic		EQU	5	; abort immediately
  2311                                  errACT_Ignore		EQU	6	; ignore
  2312                                  errACT_IntRet		EQU	7	; Retry after User Intervention
  2313                                  
  2314                                  ;	Values for error LOCUS
  2315                                  
  2316                                  errLOC_Unk		EQU	1	; No appropriate value
  2317                                  errLOC_Disk		EQU	2	; Random Access Mass Storage
  2318                                  errLOC_Net		EQU	3	; Network
  2319                                  errLOC_SerDev		EQU	4	; Serial Device
  2320                                  errLOC_Mem		EQU	5	; Memory
  2321                                  
  2322                                  ;============================================================================
  2323                                  ; INT2A.INC (MSDOS 6.0, 1991)
  2324                                  ;============================================================================
  2325                                  ; 04/05/2019 - Retro DOS v4.0
  2326                                  
  2327                                  ;**	Int 2A functions
  2328                                  ; ---------------------------------------------------------------------------
  2329                                  ;	Int 2A is an interface to the network code; it's also overloaded
  2330                                  ;		as a critical section handler since critical sections
  2331                                  ;		were originally created to support the net.
  2332                                  ; ---------------------------------------------------------------------------
  2333                                  
  2334                                  ; ---------------------------------------------------------------------------
  2335                                  ;**	This table was created by examining the source and may not be
  2336                                  ;	complete or completely accurate - JGL
  2337                                  ;
  2338                                  ;	M010	MD	8/31/90 - Added definition for AH = 5
  2339                                  
  2340                                  ;	(ah) = 0	installation check
  2341                                  ;			   (returns ah !=0 if installed)
  2342                                  ;	(ah) = 1	cooked net bios call
  2343                                  ;	(ah) = 3	query drive shared
  2344                                  ;			   (ds:si) = "n:" asciz string
  2345                                  ;	(ah) = 4	net bios
  2346                                  ;	       (al) = 0	   cooked net bios call
  2347                                  ;	       (al) = 1	   raw net bios call
  2348                                  ;	       (al) = 2	   ???
  2349                                  ;
  2350                                  ;	(ah) = 5	Get Net Adaptor Resources. CX returns the number of
  2351                                  ;			NCBs available/outstanding. DX returns the number of
  2352                                  ;			sessions. Supposedly, this is documented in an old
  2353                                  ;			IBM PC-LAN reference. Lotus Notes uses it. DOS LAN
  2354                                  ;			Manager 2.0 Enhanced responds to it. But it should
  2355                                  ;			not be used, as it is a hack, only to get Lotus
  2356                                  ;			Notes running.
  2357                                  ;
  2358                                  ;	(ah) = 80h	enter critical section
  2359                                  ;	(ah) = 81h	leave critical section
  2360                                  ;	(ah) = 82h	free all critical sections (Leave-all)
  2361                                  ;	(ah) = 84h	entering idle loop (don't understand how this works)
  2362                                  ; ---------------------------------------------------------------------------
  2363                                  
  2364                                  ;**	Critical section definitions
  2365                                  ; ---------------------------------------------------------------------------
  2366                                  ;	Although DOS is not designed to be reentrant there are some hacks
  2367                                  ;	which various programs use to make it so, in a limited fashion.
  2368                                  ;	Both WIN386 and some servers block copy a section of the DOS data
  2369                                  ;	area so that DOS can be reentered on behalf of another thread/program.
  2370                                  ;	DOS's global data structures, such as the memory arena, are not
  2371                                  ;	in this area, so critical section indicators are used to protect
  2372                                  ;	those areas.  DOS flags a critical section by issuing an INT_IBM
  2373                                  ;	(int 2Ah) at each critical section entry and exit.  Some clients
  2374                                  ;	(such as WIN386) just don't "context switch" the DOS when one
  2375                                  ;	of these is in effect, others, such as the IBM server, go ahead
  2376                                  ;	and reenter the DOS and if they get an int 2A to reenter the same
  2377                                  ;	critical section they then switch away from that second thread and
  2378                                  ;	let the first one finish and exit the section.
  2379                                  ; ---------------------------------------------------------------------------
  2380                                  
  2381                                  ; These below are subject to leave-all sections
  2382                                  critDisk    EQU     1			; Disk I/O critical section
  2383                                  critShare   EQU     1			; Sharer I/O critical section
  2384                                  critMem     EQU     1			; memory maintenance critical section
  2385                                  critSFT     EQU     1			; sft table allocation
  2386                                  critDevice  EQU     2			; Device I/O critical section
  2387                                  critNet     EQU     5			; network critical section
  2388                                  critIFS     EQU     6			; ifsfunc critical section
  2389                                  ; These below are not subject to leave-all sections
  2390                                  critASSIGN  EQU     8			; Assign has munged a system call
  2391                                  
  2392                                  ;============================================================================
  2393                                  ; MULT.INC (MSDOS 6.0, 1991)
  2394                                  ;============================================================================
  2395                                  ; 04/05/2019 - Retro DOS v4.0
  2396                                  
  2397                                  ;Break <Multiplex channels>
  2398                                  
  2399                                  ; ---------------------------------------------------------------------------
  2400                                  ; The current set of defined multiplex channels is (* means documented):
  2401                                  ;
  2402                                  ;   Channel(h)  Issuer          Receiver    Function
  2403                                  ;      00       server          PSPRINT     print job control
  2404                                  ;     *01       print/apps      PRINT       Queueing of files
  2405                                  ;      02       BIOS            REDIR       signal open/close of printers
  2406                                  ;
  2407                                  ;      05       command         REDIR       obtain text of net int 24 message
  2408                                  ;     *06       server/assign   ASSIGN      Install check
  2409                                  ;
  2410                                  ;      08       external driver IBMBIO      interface to internal routines
  2411                                  ;
  2412                                  ;      10       sharer/server   Sharer      install check
  2413                                  ;      11       DOS/server      Redir       install check/redirection funcs
  2414                                  ;      12       sharer/redir    DOS         dos functions and structure maint
  2415                                  ;      13       MSNET           MSNET       movement of NCBs
  2416                                  ;      13       external driver IBMBIO      Reset_Int_13, allows installation
  2417                                  ;                                           of alternative INT_13 drivers after
  2418                                  ;                                           boot_up
  2419                                  ;      14 (IBM) DOS             NLSFUNC     down load NLS country info,DOS 3.3
  2420                                  ;      14 (MS)  APPS            POPUP       MSDOS 4 popup screen functions
  2421                                  ;      15       APPS            MSCDEX      CD-ROM extensions interface
  2422                                  ;      16       WIN386          WIN386      Windows communications
  2423                                  ;      17       Clipboard       WINDOWS     Clipboard interface
  2424                                  ;     *18       Applications    MS-Manger   Toggle interface to manager
  2425                                  ;      19       Shell
  2426                                  ;      1A       Ansi.sys
  2427                                  ;      1B       Fastopen,Vdisk   IBMBIO     EMS INT 67H stub handler
  2428                                  ;
  2429                                  ;      40h      OS/2
  2430                                  ;      41h      Lanman
  2431                                  ;      42h      Lanman
  2432                                  ;      43h      Himem
  2433                                  ;                               AL = 20h    reserved for Mach 20 Himem support
  2434                                  ;                               AL = 30h    reserved for Himem external A20 code
  2435                                  ;      44h      Dosextender
  2436                                  ;      45H      Windows profiler
  2437                                  ;      46h      Windows/286 DOS extender
  2438                                  ;      47h      Basic Compiler Vn. 7.0
  2439                                  ;      48h      Doskey
  2440                                  ;      49h      DOS 5.x install 
  2441                                  ;      4Ah      Multi Purpose
  2442                                  ;                multMULTSWPDSK         0 - Swap Disk in drive A (BIOS)
  2443                                  ;                multMULTGETHMAPTR      1 - Get available HMA & ptr
  2444                                  ;                multMULTALLOCHMA       2 - Allocate HMA (bx == no of bytes)
  2445                                  ;                multMULTTASKSHELL      5 - Shell/switcher API
  2446                                  ;                multMULTRPLTOM         6 - Top Of Memory for RPL support
  2447                                  ;
  2448                                  ;                multSmartdrv           10h
  2449                                  ;                multMagicdrv           11h
  2450                                  ;      4Bh      Task Switcher API
  2451                                  ;
  2452                                  ;      4Ch      APPS            APM         Advanced power management
  2453                                  ;      4Dh      Kana Kanji Converter, MSKK
  2454                                  ;
  2455                                  ;      51h      ODI real mode support driver (for Chicago)
  2456                                  ;
  2457                                  ;      53h      POWER.EXE - used for broadcasting APM events    ; M036
  2458                                  ;      54h      POWER.EXE - used for POWER API                  ; M036
  2459                                  ;
  2460                                  ;      55h      COMMAND.COM
  2461                                  ;                multCOMFIRST           0 - API to determine whether 1st
  2462                                  ;                                           instance of command.com
  2463                                  ;                multCOMFIRSTROM        1 - API to determine whether 1st
  2464                                  ;                                           instance of ROM COMMAND
  2465                                  ;      56h      Sewell Development
  2466                                  ;               INTERLNK
  2467                                  ;
  2468                                  ;      57h      Iomega Corp.
  2469                                  ;
  2470                                  ;      ABh      Unspecified IBM use
  2471                                  ;      ACh      Graphics
  2472                                  ;      ADh      NLS (toronto)
  2473                                  ;      AEh
  2474                                  ;      AFh      Mode
  2475                                  ;      B0h      GRAFTABL        GRAFTABL
  2476                                  ;
  2477                                  ;      D7h      Banyan VINES
  2478                                  ; ---------------------------------------------------------------------------
  2479                                  
  2480                                  ;MUX 00-3F reserverd for IBM
  2481                                  ;MUX 80-BF reserverd for IBM
  2482                                  
  2483                                  ;MUX 40-7F reserved for Microsoft
  2484                                  
  2485                                  ;MUX C0-FF users
  2486                                  
  2487                                  MultSHARE   EQU     10h 		; sharer
  2488                                      ;	1   MFT_enter
  2489                                      ;	2   MFTClose
  2490                                      ;	3   MFTclU
  2491                                      ;	4   MFTCloseP
  2492                                      ;	5   MFTCloN
  2493                                      ;	6   set_block
  2494                                      ;	7   clr_block
  2495                                      ;	8   chk_block
  2496                                      ;	9   MFT_get
  2497                                      ;	10  ShSave
  2498                                      ;	11  ShChk
  2499                                      ;	12  ShCol
  2500                                      ;	13  ShCloseFile
  2501                                  
  2502                                  MultNET     EQU     11h 		; Network support
  2503                                  MultIFS     EQU     11h                 ; Network support
  2504                                      ;   1   IFS_RMDIR
  2505                                      ;   2   IFS_SEQ_RMDIR
  2506                                      ;   3   IFS_MKDIR
  2507                                      ;   4   IFS_SEQ_MKDIR
  2508                                      ;   5   IFS_CHDIR
  2509                                      ;   6   IFS_CLOSE
  2510                                      ;   7   IFS_COMMIT
  2511                                      ;   8   IFS_READ
  2512                                      ;   9   IFS_WRITE
  2513                                      ;   10  IFS_LOCK
  2514                                      ;   11  IFS_UNLOCK
  2515                                      ;   12  IFS_DISK_INFO
  2516                                      ;   13  IFS_SET_FILE_ATTRIBUTE
  2517                                      ;   14  IFS_SEQ_SET_FILE_ATTRIBUTE
  2518                                      ;   15  IFS_GET_FILE_INFO
  2519                                      ;   16  IFS_SEQ_GET_FILE_INFO
  2520                                      ;   17  IFS_RENAME
  2521                                      ;   18  IFS_SEQ_RENAME
  2522                                      ;   19  IFS_DELETE
  2523                                      ;   20  IFS_SEQ_DELETE
  2524                                      ;   21  IFS_OPEN
  2525                                      ;   22  IFS_SEQ_OPEN
  2526                                      ;   23  IFS_CREATE
  2527                                      ;   24  IFS_SEQ_CREATE
  2528                                      ;   25  IFS_SEQ_SEARCH_FIRST
  2529                                      ;   26  IFS_SEQ_SEARCH_NEXT
  2530                                      ;   27  IFS_SEARCH_FIRST
  2531                                      ;   28  IFS_SEARCH_NEXT
  2532                                      ;   29  IFS_ABORT
  2533                                      ;   30  IFS_ASSOPER
  2534                                      ;   31  Printer_SET_STRING
  2535                                      ;   32  IFSFlushBuf
  2536                                      ;   33  IFSBufWrite
  2537                                      ;   34  IFSResetEnvironment
  2538                                      ;   35  IFSSpoolCheck
  2539                                      ;   36  IFSSpoolClose
  2540                                      ;   37  IFSDeviceOper
  2541                                      ;   38  IFSSpoolEchoCheck
  2542                                      ;   39      - - -   Unused   - - -
  2543                                      ;   40      - - -   Unused   - - -
  2544                                      ;   41      - - -   Unused   - - -
  2545                                      ;   42  SERVER_DOSCALL_CLOSEFILES_FOR_UID
  2546                                      ;   43  DEVICE_IOCTL
  2547                                      ;   44  IFS_UPDATE_CB
  2548                                      ;   45  IFS_FILE_XATTRIBUTES
  2549                                      ;   46  IFS_XOPEN
  2550                                      ;   47  IFS_DEPENDENT_IOCTL
  2551                                  
  2552                                  MultDOS     EQU     12h 		; DOS call back
  2553                                      ;	1   DOS_CLOSE
  2554                                      ;	2   RECSET
  2555                                      ;	3   Get DOSGROUP
  2556                                      ;	4   PATHCHRCMP
  2557                                      ;	5   OUT
  2558                                      ;	6   NET_I24_ENTRY
  2559                                      ;	7   PLACEBUF
  2560                                      ;	8   FREE_SFT
  2561                                      ;	9   BUFWRITE
  2562                                      ;	10  SHARE_VIOLATION
  2563                                      ;	11  SHARE_ERROR
  2564                                      ;	12  SET_SFT_MODE
  2565                                      ;	13  DATE16
  2566                                      ;	14  SETVISIT
  2567                                      ;	15  SCANPLACE
  2568                                      ;	16  SKIPVISIT
  2569                                      ;	17  StrCpy
  2570                                      ;	18  StrLen
  2571                                      ;	19  UCase
  2572                                      ;	20  POINTCOMP
  2573                                      ;	21  CHECKFLUSH
  2574                                      ;	22  SFFromSFN
  2575                                      ;	23  GetCDSFromDrv
  2576                                      ;	24  Get_User_Stack
  2577                                      ;	25  GetThisDrv
  2578                                      ;	26  DriveFromText
  2579                                      ;	27  SETYEAR
  2580                                      ;	28  DSUM
  2581                                      ;	29  DSLIDE
  2582                                      ;	30  StrCmp
  2583                                      ;	31  initcds
  2584                                      ;	32  pjfnfromhandle
  2585                                      ;	33  $NameTrans
  2586                                      ;	34  CAL_LK
  2587                                      ;	35  DEVNAME
  2588                                      ;	36  Idle
  2589                                      ;   37  DStrLen
  2590                                      ;   38  NLS_OPEN      DOS 3.3
  2591                                      ;   39  $CLOSE        DOS 3.3
  2592                                      ;   40  NLS_LSEEK     DOS 3.3
  2593                                      ;   41  $READ         DOS 3.3
  2594                                      ;   42  FastInit      DOS 4.0
  2595                                      ;   43  NLS_IOCTL     DOS 3.3
  2596                                      ;   44  GetDevList    DOS 3.3
  2597                                      ;   45  NLS_GETEXT    DOS 3.3
  2598                                      ;   46  MSG_RETRIEVAL DOS 4.0
  2599                                      ;   47  FAKE_VERSION  DOS 4.0
  2600                                  
  2601                                  NLSFUNC     EQU     14h 		; NLSFUNC CALL , DOS 3.3
  2602                                      ;	0   NLSInstall
  2603                                      ;	1   ChgCodePage
  2604                                      ;	2   GetExtInfo
  2605                                      ;	3   SetCodePage
  2606                                      ;	4   GetCntry
  2607                                  
  2608                                  multANSI    EQU     1Ah                 ; ANSI multiplex number
  2609                                      ;   0   INSTALL_CHECK               ; install check for ANSI
  2610                                      ;   1   IOCTL_2F                    ; 2F interface to IOCTL
  2611                                      ;   2   DA_INFO_2F                  ; J.K. Information passing to ANSI.
  2612                                  
  2613                                  multMULT        EQU     4Ah
  2614                                  multMAGIC       EQU     256*multMULT + 11h
  2615                                  multMULTRPLTOM  EQU     06h
  2616                                  
  2617                                      ;   0   swap disk function for single floppy drive m/cs
  2618                                      ;       BIOS broadcasts with cx==0, and apps who handle
  2619                                      ;       swap disk messaging set cx == -1. BIOS sets dl == requested
  2620                                      ;       drive
  2621                                      ;
  2622                                      ;   1   Get available HMA & pointer to it. Returns in BX & ES:DI
  2623                                      ;   2   Allocate HMA. BX == number of bytes in HMA to be allocated
  2624                                      ;       returns pointer in ES:DI
  2625                                      ;
  2626                                      ;   3-4 currently used by nobody
  2627                                      ;   5   Switcher API
  2628                                      ;   6   Top of Memory for RPL.
  2629                                      ;           BIOS issues INT 2f AX=4a06 & DX = Top of Mem and any RPL
  2630                                      ;           code present in TOM should respond with a new TOM in DX
  2631                                      ;           to protect itself from MSLOAD & SYSINIT tromping over it.
  2632                                      ;           SYSINIT builds an arena with owner type 8 & name 'RPL' to
  2633                                      ;           protect the RPL code from COMMAND.COM transient protion.
  2634                                      ;           It is the responsibility of RPL program to release the mem.
  2635                                      ;   7   Reserved for PROTMAN support.
  2636                                      ;  10   smartdrv 4.0
  2637                                      ;  11   dblspace api
  2638                                      ;  12   MRCI     api
  2639                                      ;  13   dblspace/mrci stealth packet api
  2640                                  
  2641                                  MultAPM     EQU     4ch             ; Obselete ???
  2642                                      ;       00h     APM_VER_CHK
  2643                                      ;       01h     APM_SUS_SYS_REQ
  2644                                      ;       FFh     APM_SUS_RES_BATT_NOTIFY
  2645                                  
  2646                                  MultPWR_BRDCST  EQU     53h     ; Used by POWER.EXE to broadcast      ; M036
  2647                                  				;  APM events                         ; M036
  2648                                  MultPWR_API     EQU     54h     ; Used for accessing POWER.EXE's API  ; M036
  2649                                  
  2650                                  ;FASTOPEN is not chained through INT 2F   ; DOS 3.3 F.C.
  2651                                  ;	  it calls Multdos 42 to set up an entry routine address
  2652                                      ;	0   Install status  (reserved)
  2653                                      ;	1   Lookup
  2654                                      ;	2   Insert
  2655                                      ;	3   Delete
  2656                                      ;	4   Purge	    (reserved)
  2657                                  
  2658                                  ;============================================================================
  2659                                  ; FIND.INC (MSDOS 6.0, 1991)
  2660                                  ;============================================================================
  2661                                  ; 17/05/2019 - Retro DOS v4.0
  2662                                  ; 09/07/2018 - Retro DOS v3.0 (MSDOS 3.3, 1987)
  2663                                  
  2664                                  ;Break	<find first/next buffer>
  2665                                  
  2666                                  struc find_buf
  2667 00000000 ??                      .drive:	    resb 1		; drive of search
  2668 00000001 <res Bh>                .name:	    resb 11		; formatted name
  2669 0000000C ??                      .sattr:	    resb 1		; attribute of search
  2670 0000000D ????                    .LastEnt:   resw 1		; LastEnt
  2671 0000000F ????                    .DirStart:  resw 1		; DirStart
  2672 00000011 ????????                .NETID:	    resb 4 ; MSDOS 6.0 	; Reserved for NET
  2673 00000015 ??                      .attr:	    resb 1		; attribute found
  2674 00000016 ????                    .time:	    resw 1		; time
  2675 00000018 ????                    .date:	    resw 1		; date
  2676 0000001A ????                    .size_l:    resw 1		; low(size)
  2677 0000001C ????                    .size_h:    resw 1		; high(size)
  2678 0000001E <res Dh>                .pname:	    resb 13		; packed name
  2679                                  .size:
  2680                                  endstruc
  2681                                  
  2682                                  ;============================================================================
  2683                                  ; DOSCNTRY.INC (MSDOS 6.0, 1991)
  2684                                  ;============================================================================
  2685                                  ; 29/04/2019 - Retro DOS v4.0
  2686                                  ; 09/07/2018 - Retro DOS v3.0 (MSDOS 3.3, 1987)
  2687                                  
  2688                                  ;Equates for COUNTRY INFORMATION.
  2689                                  SetCountryInfo	EQU	1	;country info
  2690                                  SetUcase	EQU	2	;uppercase table
  2691                                  SetLcase	EQU	3	;lowercase table (Reserved)
  2692                                  SetUcaseFile	EQU	4	;uppercase file spec table
  2693                                  SetFileList	EQU	5	;valid file character list
  2694                                  SetCollate	EQU	6	;collating sequence
  2695                                  SetDBCS 	EQU	7	;double byte character set
  2696                                  SetALL		EQU	-1	;all the entries
  2697                                  
  2698                                  ;DOS country and code page information table structure.
  2699                                  ;Internally, IBMDOS gives a pointer to this table.
  2700                                  ;IBMBIO, MODE and NLSFUNC modules communicate with IBMDOS through
  2701                                  ;this structure.
  2702                                  
  2703                                  struc  DOS_CCDPG	; DOS_country_cdpg_info
  2704 00000000 ????????????????        .ccInfo_reserved: 	resb 8	;reserved for internal use
  2705 00000008 <res 40h>               .ccPath_CountrySys:	resb 64 ;path and filename for country info
  2706 00000048 ????                    .ccSysCodePage:		resw 1	;system code page id
  2707 0000004A ????                    .ccNumber_of_entries:	resw 1  ; (default value = 6)
  2708 0000004C ??                      .ccSetUcase:		resb 1  ; (default value = SetUcase)
  2709 0000004D ????????                .ccUcase_ptr:		resd 1	;pointer to Ucase table
  2710                                  
  2711 00000051 ??                      .ccSetUcaseFile:	resb 1	; (default value = SetUcaseFile)
  2712 00000052 ????????                .ccFileUcase_ptr: 	resd 1	;pointer to File Ucase table
  2713                                  
  2714 00000056 ??                      .ccSetFileList:		resb 1 	; (default value = SetFileList)
  2715 00000057 ????????                .ccFileChar_ptr:	resd 1	;pointer to File char list table
  2716                                  
  2717 0000005B ??                      .ccSetCollate:		resb 1	; (default value = SetCollate)
  2718 0000005C ????????                .ccCollate_ptr:		resd 1	;pointer to collate table
  2719                                  
  2720                                  ; MSDOS 6.0
  2721 00000060 ??                      .ccSetDBCS:		resb 1	; (default value = SetDBCS)
  2722 00000061 ????????                .ccDBCS_ptr:		resd 1	; pointer to DBCS table
  2723                                  
  2724 00000065 ??                      .ccSetCountryInfo:	resb 1  ; (default value = SetCountryInfo)
  2725 00000066 ????                    .ccCountryInfoLen:	resw 1	;length of country info
  2726 00000068 ????                    .ccDosCountry:		resw 1	;system country code id
  2727 0000006A ????                    .ccDosCodePage:		resw 1	;system code page id
  2728 0000006C ????                    .ccDFormat:		resw 1	;date format
  2729 0000006E ??????????              .ccCurSymbol:		resb 5	;5 byte of (currency symbol+0)
  2730 00000073 ????                    .cc1000Sep:		resb 2	;2 byte of (1000 sep. + 0)
  2731 00000075 ????                    .ccDecSep:		resb 2	;2 byte of (Decimal sep. + 0)
  2732 00000077 ????                    .ccDateSep:		resb 2	;2 byte of (date sep. + 0)
  2733 00000079 ????                    .ccTimeSep:		resb 2	;2 byte of (time sep. + 0)
  2734 0000007B ??                      .ccCFormat:		resb 1	;currency format flags
  2735 0000007C ??                      .ccCSigDigits:		resb 1	;# of digits in currency
  2736 0000007D ??                      .ccTFormat:		resb 1	;time format
  2737 0000007E ????????                .ccMono_ptr:		resd 1	;monocase routine entry point
  2738 00000082 ????                    .ccListSep:		resb 2	;data list separator
  2739 00000084 <res Ah>                .ccReserved_area: 	resw 5	;reserved
  2740                                  .size:
  2741                                  endstruc
  2742                                  
  2743                                  ;Ucase table
  2744                                  struc CC_UCASE_TAB
  2745 00000000 ????                    .ccUcase_leng:		resw 1	; (default value = 128)
  2746 00000002 <res 80h>               .ccUcase_data:		resb 128
  2747                                  endstruc
  2748                                  
  2749                                  ;File Ucase table
  2750                                  struc CC_FILE_UCASE_TAB
  2751 00000000 ????                    .ccFileucase_leng:	resw 1	; (default value = 128)
  2752 00000002 <res 80h>               .ccFileucase_data:	resb 128
  2753                                  endstruc
  2754                                  
  2755                                  ;File char list
  2756                                  struc CC_FILE_CHAR_TAB
  2757 00000000 ????                    .ccFilechar_leng:	resw 1
  2758 00000002 <res 2Eh>               .ccFilechar_data:	resb 46
  2759                                  endstruc
  2760                                  
  2761                                  ;collate table
  2762                                  struc CC_COLLATE_TAB
  2763 00000000 ????                    .ccCollate_leng:	resw 1	; (default value = 128)
  2764 00000002 <res 100h>              .ccCollate_data:	resb 256
  2765                                  endstruc
  2766                                  
  2767                                  OLD_COUNTRY_SIZE  equ	(DOS_CCDPG.size - DOS_CCDPG.ccDFormat - 10)
  2768                                  NEW_COUNTRY_SIZE  equ	(DOS_CCDPG.size - DOS_CCDPG.ccDosCountry) ; 38
  2769                                  
  2770                                  ; 06/08/2018
  2771                                  ; DOSCNTRY.INC (MSDOS 6.0, 1991)
  2772                                  
  2773                                  ;CAPITALIZATION equates
  2774                                  CAP_ONE_CHAR	equ	20H
  2775                                  CAP_STRING	equ	21H
  2776                                  CAP_ASCIIZ	equ	22H
  2777                                  CHECK_YES_NO	equ	23H
  2778                                  UPPER_TABLE	equ	80H
  2779                                  
  2780                                  ;NLS_YES	equ	59H  ; 'Y'
  2781                                  ;NLS_yes2	equ	79H  ; 'y'
  2782                                  ;NLS_NO		equ	4EH  ; 'N'
  2783                                  ;NLS_no2	equ	6EH  ; 'n'
  2784                                  
  2785                                  ;============================================================================
  2786                                  ; CURDIR.INC (MSDOS 6.0, 1991)
  2787                                  ;============================================================================
  2788                                  ; 25/04/2019 - Retro DOS v4.0
  2789                                  ; 09/07/2018 - Retro DOS v3.0 (CURDIR.INC, MSDOS 3.3, 1987)
  2790                                  
  2791                                  ;BREAK <Current directory list structure>
  2792                                  
  2793                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  2794                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  2795                                  ;									   ;
  2796                                  ; CDS items are used bu the internal routines to store cluster numbers and ;
  2797                                  ; network identifiers for each logical name.  The ID field is used dually, ;
  2798                                  ; both as net ID and for a cluster number for local devices.  In the case  ;
  2799                                  ; of local devices, the cluster number will be -1 if there is a potential  ;
  2800                                  ; of the disk being changed or if the path must be recracked.		   ;
  2801                                  ;
  2802                                  ;	Some pathnames have special preambles, such as
  2803                                  ;
  2804                                  ;		\\machine\sharename\...
  2805                                  ;	For these pathnames we can't allow ".." processing to back us
  2806                                  ;	up into the special front part of the name.  The CURDIR_END field
  2807                                  ;	holds the address of the seperator character which marks
  2808                                  ;	the split between the special preamble and the regular
  2809                                  ;	path list; ".." processing isn't allowed to back us up past
  2810                                  ;	(i.e., before) CURDIR_END
  2811                                  ;	For the root, it points at the leading /.  For net
  2812                                  ;	assignments it points at the end (nul) of the initial assignment:
  2813                                  ;	A:/	\\foo\bar	    \\foo\bar\blech\bozo
  2814                                  ;	  ^		 ^		     ^
  2815                                  
  2816                                  DIRSTRLEN	EQU	64+3		; Max length in bytes of directory strings
  2817                                  
  2818                                  TEMPLEN 	EQU	DIRSTRLEN*2
  2819                                  
  2820                                  struc curdir	; curdir_list
  2821 00000000 <res 43h>               .text:		resb DIRSTRLEN		; text of assignment and curdir
  2822 00000043 ????                    .flags:		resw 1			; various flags
  2823 00000045 ????????                .devptr:	resd 1			; local pointer to DPB or net device
  2824 00000049 ????????                .ID:		resw 2			; cluster of current dir (net ID)
  2825 0000004D ????                    .user_word:	resw 1
  2826 0000004F ????                    .end:		resw 1			; index to ".." backup limit - see above
  2827                                  ; MSDOS 6.0
  2828 00000051 ??                      .type:		resb 1			; IFS drive (2=ifs, 4=netuse)
  2829 00000052 ????????                .ifs_hdr:	resd 1			; Ptr to File System Header
  2830 00000056 ????                    .fsda:		resb 2			; File System Dependent Data Area
  2831                                  .size:
  2832                                  endstruc
  2833                                  
  2834                                  curdirLen	EQU curdir.size	; 88	; Needed for screwed up
  2835                                  
  2836                                  %define curdir_netID curdir_ID  ; dword
  2837                                  
  2838                                  ;**	Flag values for CURDIR_FLAGS
  2839                                  
  2840                                  curdir_isnet	EQU	1000000000000000B
  2841                                  CURDIR_isifs	EQU	1000000000000000B ; MSDOS 6.0	
  2842                                  curdir_inuse	EQU	0100000000000000B
  2843                                  curdir_splice	EQU	0010000000000000B
  2844                                  curdir_local	EQU	0001000000000000B
  2845                                  
  2846                                  ;									   ;
  2847                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  2848                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  2849                                  
  2850                                  ;============================================================================
  2851                                  ; CPMFCB.INC (MSDOS 3.3, 1987)
  2852                                  ;============================================================================
  2853                                  ; 09/07/2018 - Retro DOS v3.0
  2854                                  
  2855                                  ;BREAK <File Control Block definition>
  2856                                  
  2857                                  ;
  2858                                  ; Field definition for FCBs
  2859                                  ; The FCB has the following structure:
  2860                                  ;
  2861                                  ;	+---------------------------+
  2862                                  ;	|   Drive indicator(byte)   |
  2863                                  ;	+---------------------------+
  2864                                  ;	|    Filename (8 chars)     |
  2865                                  ;	+---------------------------+
  2866                                  ;	|    Extension (3 chars)    |
  2867                                  ;	+---------------------------+
  2868                                  ;	|   Current Extent(word)    |
  2869                                  ;	+---------------------------+
  2870                                  ;	|    Record size (word)     |
  2871                                  ;	+---------------------------+
  2872                                  ;	|    File Size (2 words)    |
  2873                                  ;	+---------------------------+
  2874                                  ;	|	Date of write	    |
  2875                                  ;	+---------------------------+
  2876                                  ;	|	Time of write	    |
  2877                                  ;	+---------------------------+
  2878                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  2879                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  2880                                  ;									   ;
  2881                                  ;	+---------------------------+
  2882                                  ;	|   8 bytes reserved	    |
  2883                                  ;	+---------------------------+
  2884                                  ;									   ;
  2885                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  2886                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  2887                                  ;	|    next record number     |
  2888                                  ;	+---------------------------+
  2889                                  ;	|   random record number    |
  2890                                  ;	+---------------------------+
  2891                                  ;
  2892                                  
  2893                                  struc	SYS_FCB
  2894 00000000 ??                      .drive:	resb 1
  2895 00000001 ????????????????        .name:	resb 8
  2896 00000009 ??????                  .ext:	resb 3
  2897 0000000C ????                    .EXTENT: resw 1
  2898 0000000E ????                    .RECSIZ: resw 1			; Size of record (user settable)
  2899 00000010 ????                    .FILSIZ: resw 1			; Size of file in bytes; used with the
  2900                                  				; following word
  2901 00000012 ????                    .DRVBP:	resw 1			; BP for SEARCH FIRST and SEARCH NEXT
  2902 00000014 ????                    .FDATE:	resw 1			; Date of last writing
  2903 00000016 ????                    .FTIME:	resw 1			; Time of last writing
  2904                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  2905                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  2906                                  ;									   ;
  2907 00000018 ????????????????        .reserved: resb 8		; RESERVED
  2908                                  ;									   ;
  2909                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
  2910                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  2911 00000020 ??                      .NR:	resb 1			; Next record
  2912 00000021 ????????                .RR:	resb 4			; Random record
  2913                                  .size:
  2914                                  endstruc
  2915                                  
  2916                                  FILDIRENT EQU SYS_FCB.FILSIZ	; Used only by SEARCH FIRST and SEARCH
  2917                                  				; NEXT
  2918                                  ; 20/07/2018
  2919                                  %define fcb_sfn	SYS_FCB.reserved ; byte
  2920                                  
  2921                                  ; Note that fcb_net_handle, fcb_nsl_drive, fcb_nsld_drive and fcb_l_drive
  2922                                  ; all must point to the same byte.  Otherwise, the FCBRegen will fail.
  2923                                  ; NOTE about this byte (fcb_nsl_drive)
  2924                                  ;   The high two bits of this byte are used as follows to indicate the FCB type
  2925                                  ;	00 means a local file or device with sharing loaded
  2926                                  ;	10 means a remote (network) file
  2927                                  ;	01 means a local file with no sharing loaded
  2928                                  ;	11 means a local device with no sharing loaded
  2929                                  
  2930                                  ; 20/07/2018
  2931                                  
  2932                                  ;
  2933                                  ; Network FCB
  2934                                  ;
  2935                                  
  2936                                  %define fcb_net_drive	SYS_FCB.reserved+1  ; byte
  2937                                  %define fcb_net_handle	SYS_FCB.reserved+2  ; word
  2938                                  %define fcb_netID	SYS_FCB.reserved+4  ; dword
  2939                                  
  2940                                  ;
  2941                                  ; No sharing local file FCB
  2942                                  ;
  2943                                  
  2944                                  %define fcb_nsl_drive	SYS_FCB.reserved+1  ; byte
  2945                                  %define fcb_nsl_bits	SYS_FCB.reserved+2  ; byte
  2946                                  %define fcb_nsl_firclus SYS_FCB.reserved+3  ; word
  2947                                  %define fcb_nsl_dirsec	SYS_FCB.reserved+5  ; word
  2948                                  %define fcb_nsl_dirpos  SYS_FCB.reserved+7  ; byte
  2949                                  
  2950                                  ;
  2951                                  ; No sharing local device FCB
  2952                                  ;
  2953                                  
  2954                                  %define fcb_nsld_drive	SYS_FCB.reserved+1  ; byte
  2955                                  %define fcb_nsld_drvptr SYS_FCB.reserved+2  ; dword
  2956                                  
  2957                                  ;
  2958                                  ; Sharing local FCB
  2959                                  ;
  2960                                  
  2961                                  %define fcb_l_drive	SYS_FCB.reserved+1  ; byte
  2962                                  %define fcb_l_firclus	SYS_FCB.reserved+2  ; word
  2963                                  %define fcb_l_mfs	SYS_FCB.reserved+4  ; word
  2964                                  %define fcb_l_attr	SYS_FCB.reserved+6  ; byte
  2965                                  
  2966                                  ;
  2967                                  ; Bogusness:  the four cases are:
  2968                                  ;
  2969                                  ;   local file	    00
  2970                                  ;   local device    40
  2971                                  ;   local sharing   C0
  2972                                  ;   network	    80
  2973                                  ;
  2974                                  ; Since sharing and network collide, we cannot use a test instruction for
  2975                                  ; deciding whether a network or a share check in involved
  2976                                  ;
  2977                                  FCBDEVICE   EQU 040h
  2978                                  FCBNETWORK  EQU 080h
  2979                                  FCBSHARE    EQU 0C0h
  2980                                  
  2981                                  ; FCBSPECIAL must be able to mask off both net and share
  2982                                  FCBSPECIAL  EQU 080h
  2983                                  FCBMASK     EQU 0C0h
  2984                                  
  2985                                  ;============================================================================
  2986                                  ; LOCK.INC, MSDOS 6.0, 1991
  2987                                  ;============================================================================
  2988                                  ; 14/07/2018 - Retro DOS v3.0
  2989                                  
  2990                                  ;**	LOCK.INC - Definitions for Record Locking
  2991                                  
  2992                                  ;**	LOCK functions
  2993                                  
  2994                                  LOCK_ALL	    equ    0
  2995                                  UNLOCK_ALL	    equ    1
  2996                                  LOCK_MUL_RANGE	    equ    2
  2997                                  UNLOCK_MUL_RANGE    equ    3
  2998                                  LOCK_READ	    equ    4
  2999                                  WRITE_UNLOCK	    equ    5
  3000                                  LOCK_ADD	    equ    6
  3001                                  
  3002                                  ;**	Structure for Lock buffer
  3003                                  
  3004                                  struc LockBuf
  3005 00000000 ????????                .Lock_position:	resd 1		; file position for LOCK
  3006 00000004 ????????                .Lock_length:	resd 1		; number of bytes to LOCK
  3007                                  endstruc
  3008                                  
  3009                                  ;============================================================================
  3010                                  ; DPL.ASM, MSDOS 6.0, 1991
  3011                                  ;============================================================================
  3012                                  ; 04/08/2018 - Retro DOS v3.0
  3013                                  
  3014                                  ; (SRVCALL.ASM)
  3015                                  
  3016                                  struc DPL
  3017 00000000 ????                    .AX:	resw	1	; AX register
  3018 00000002 ????                    .BX:	resw	1	; BX register
  3019 00000004 ????                    .CX:	resw	1	; CX register
  3020 00000006 ????                    .DX:	resw	1	; DX register
  3021 00000008 ????                    .SI:	resw	1	; SI register
  3022 0000000A ????                    .DI:	resw	1	; DI register
  3023 0000000C ????                    .DS:	resw	1	; DS register
  3024 0000000E ????                    .ES:	resw	1	; ES register
  3025 00000010 ????                    .rsrvd: resw	1	; Reserved
  3026 00000012 ????                    .UID:	resw	1	; User (Machine) ID (0 = local macine)
  3027 00000014 ????                    .PID:	resw	1	; Process ID (0 = local user PID)
  3028                                  .size:
  3029                                  endstruc
  3030                                   
  3031                                  ;----------------------------------------------------------------------------
  3032                                  ; DOSDATA
  3033                                  ;----------------------------------------------------------------------------
  3034                                  ;============================================================================
  3035                                  ; 24/04/2019 - Retro DOS v4.0
  3036                                  
  3037                                  DosDataSg equ 3 ; DOS Data Segment address (dw in 'retrodos4.s')
  3038                                  		; ((just after resident IO.SYS code&data))
  3039                                  
  3040                                  ;============================================================================
  3041                                  ; WIN386.INC, MSDOS 6.0, 1991
  3042                                  ;============================================================================
  3043                                  ; 24/04/2019 - Retro DOS 4.0
  3044                                  
  3045                                  ;
  3046                                  ;  Symbols and structures relating to WIN386 support.
  3047                                  ;
  3048                                  ;  Used by files in both the DOS and the BIOS.
  3049                                  ;
  3050                                  ;  Created: 7-13-89 by MRW
  3051                                  ;
  3052                                  
  3053                                  ; WIN386 broadcast int 2fh multiplex number and subfunction numbers
  3054                                  
  3055                                  MultWin386		equ     16h	; Int 2f multiplex number
  3056                                  
  3057                                  Win386_Init		equ	05h	; Win386 initialization
  3058                                  Win386_Exit		equ	06h	; Win386 exit
  3059                                  Win386_Devcall		equ	07h	; Win386 device call out
  3060                                  Win386_InitDone		equ	08h	; Win386 initialization is complete
  3061                                  
  3062                                  ; When Win386_Devcall is broadcast, BX is the Device ID. DOS must 
  3063                                  ; answer call outs from the DOSMGR
  3064                                  
  3065                                  Win386_DOSMGR		equ	15H
  3066                                  
  3067                                  ; The following structures are used to communicate instance data to 
  3068                                  ; Win386 from the DOS and the BIOS. See Win386 API documentation
  3069                                  ; (chapter 3, "Call Out Interfaces") for further description.
  3070                                  
  3071                                  struc Win386_SIS	; Startup Info Structure
  3072 00000000 ????                     .Version:		resb	2	; db 3, 0
  3073 00000002 ????????                 .Next_Dev_Ptr:		resd	1	; pointer to next SIS in list
  3074 00000006 ????????                 .Virt_Dev_File_Ptr:	resd	1
  3075 0000000A ????????                 .Reference_Data:	resd	1
  3076 0000000E ????????                 .Instance_Data_Ptr:	resd	1	; pointer to instance data array
  3077                                  endstruc
  3078                                  
  3079                                  size_of_Win386_SIS equ 18 ; 24/04/2019 - Retro DOS v4.0
  3080                                  
  3081                                  struc Win386_IIS	; Instance Item Structure
  3082 00000000 ????????                .Ptr:			resd	1	; pointer to an instance item
  3083 00000004 ????                    .Size:			resw	1	; size of an instance item
  3084                                  endstruc
  3085                                  
  3086                                  size_of_Win386_IIS equ 6 ; 24/04/2019 - Retro DOS v4.0
  3087                                  
  3088                                  ;Win386 DOSMGR function return values to indicate operation done
  3089                                  
  3090                                  WIN_OP_DONE		equ	0B97Ch	;
  3091                                  DOSMGR_OP_DONE		equ	0A2ABh	;
  3092                                  
  3093                                  ;M021
  3094                                  ; WInoldap callout multiplex number
  3095                                  
  3096                                  WINOLDAP		equ	46h	;
  3097                                  
  3098                                  ;============================================================================
  3099                                  ;----------------------------------------------------------------------------
  3100                                  ; DOSCODE
  3101                                  ;----------------------------------------------------------------------------
  3102                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3103                                  
  3104                                  ;============================================================================
  3105                                  ; MSHEAD.ASM (MSDOS 6.0, 1991)
  3106                                  ;============================================================================
  3107                                  ; 16/07/2018 - Retro DOS 3.0
  3108                                  ;----------------------------------------------------------------------------
  3109                                  ; 24/04/2019 - Retro DOS 4.0
  3110                                  
  3111                                  ; MSDOS 6.0
  3112                                  ;----------------------------------------------------------------------------
  3113                                  ; FILE : ORIGIN.INC
  3114                                  ;----------------------------------------------------------------------------
  3115                                  ; This is included in origin.asm and mshead.asm. Contains the equate that
  3116                                  ; is used for ORGing the DOS code.
  3117                                  ;
  3118                                  ; Brief Description of the necessacity of this ORG:
  3119                                  ; -------------------------------------------------
  3120                                  ;
  3121                                  ; A special problem exits when running out of the HMA. The HMA starts at 
  3122                                  ; address FFFF:10. There is no place in the HMA with an offset of zero.
  3123                                  ; This means programs running out off the HMA must use non-zero offset base
  3124                                  ; addresses. It also means that if we're running multiple programs from the
  3125                                  ; HMA, the base offset of each segment must atleast be as big as all of the
  3126                                  ; HMA segments that precede it.
  3127                                  ; 
  3128                                  ; One solution to this problem to ORG each module at 64K minus its size.
  3129                                  ; For instance a code segment 1234h bytes in length would org'd at edcbh.
  3130                                  ; This gives max. flexibility regarding it's location in the HMA. By 
  3131                                  ; selecting segment values between f124h and ffffh it could be located 
  3132                                  ; anywhere in the HMA. The problem with this is that programs with such 
  3133                                  ; high ORGs would not be able to run in low RAM.
  3134                                  ;
  3135                                  ; A compromise solution is to set the ORG address somewhere between 0010h
  3136                                  ; and ffffh - their size. In the particular case of the BIOS and the DOS 
  3137                                  ; the following solution has been implemented:
  3138                                  ;
  3139                                  ; The Bios Code segment will have a very small offset and run at the very
  3140                                  ; front of the HMA, after the VDISK header. THE Dos Code segment will have 
  3141                                  ; a base offset of (700+<min. size off RAM based BIOS>+<min. size of the DOS
  3142                                  ; DATA segment when DOS is running low>). This will reflect the lowest 
  3143                                  ; possible physical address at which DOS code will run, while still providing
  3144                                  ; max. possible flexibility in HMA positioning. This offset MUST NOT be 
  3145                                  ; smaller then that 20+size of Bios Code segment when running high. This is 
  3146                                  ; mostly true.
  3147                                  ;
  3148                                  ; Also this ORG'd value must be communicated to the BIOS. This is done by
  3149                                  ; putting this value after the first jmp instruction in the DOS code in
  3150                                  ; mshead.asm. 
  3151                                  ;
  3152                                  ; In order for the stripz utility to know how many zeroes to be stripped 
  3153                                  ; out, this value is placed at the beginning of the binary in origin.asm.
  3154                                  ;
  3155                                  ; Revision History:
  3156                                  ;
  3157                                  ; Currently this is being done manually. Therefore any change in the DOS DATA
  3158                                  ; Size or the BIOS size should be reflected here. --- Feb 90
  3159                                  ;
  3160                                  ; BDSIZE.INC contains the equates for BIODATASIZE, BIOCODESIZ and DOSDATASIZ.
  3161                                  ; A utility called getsize will obtain the corresponding values from msdos
  3162                                  ; and msbio.map and update the values in BDSIZ.INC if they are different. 
  3163                                  ; DOS should now be built using the batch file makedos.bat which invokes this
  3164                                  ; utility. The FORMAT of BDSIZE.INC should not be changed as getsize is 
  3165                                  ; dependant on that.				  --- Apr 3 '90
  3166                                  ;
  3167                                  ; For ROMDOS, however, there is no need to org the doscode to any location
  3168                                  ; other than zero.  Therefore the stripz utility will not need to be used,
  3169                                  ; so the offset will not need to be included at the beginning of the code
  3170                                  ; segment.  Also, the BIOS can just assume that the resident code begins
  3171                                  ; at offset zero within the segment.
  3172                                  ; 
  3173                                  ;
  3174                                  ;--------------------------------------------------------------------------
  3175                                  
  3176                                  BIODATASTART	EQU	00700h
  3177                                  ;include	bdsize.inc	; this sets the values:
  3178                                  				;	BIODATASIZ
  3179                                  				;	BIOCODESIZ
  3180                                  				;	DOSDATASIZ
  3181                                  
  3182                                  ; 05/12/2022
  3183                                  ;BIODATASIZ EQU 00910H	; 0900h for MSDOS 6.21 IO.SYS
  3184                                  			; 0900h for MSDOS 5.0 IO.SYS
  3185                                  ;BIOCODESIZ EQU 01A70H	; 1A70h for MSDOS 6.21 IO.SYS
  3186                                  			; 1A60h for MSDOS 5.0 IO.SYS
  3187                                  ;DOSDATASIZ EQU 01370H	; 1370h for MSDOS 6.21 IO.SYS
  3188                                  			; 1370h for MSDOS 5.0 IO.SYS
  3189                                  ;ifndef ROMDOS
  3190                                  ;
  3191                                  ;BYTSTART	EQU    	BIODATASTART+BIODATASIZ+BIOCODESIZ+DOSDATASIZ
  3192                                  ;PARASTART	EQU	(BYTSTART + 0FH) AND (NOT 0FH)	
  3193                                  ;
  3194                                  ;else
  3195                                  ;
  3196                                  ;BYTSTART	EQU	0
  3197                                  ;PARASTART	EQU	0
  3198                                  ;
  3199                                  ;endif ; ROMDOS
  3200                                  
  3201                                  ; 24/04/2019 - Retro DOS v4.0 - Modification
  3202                                  ; -----------------------------------------------------------------
  3203                                  ;MSDAT001E equ 136Ah ; 4970 ; for MSDOS 6.21
  3204                                  ;MSDAT001E equ 1370h ; 4976 ; for Retro DOS v4.0 modif. 25/05/2019
  3205                                  ;DOSDATASIZE equ MSDAT001E
  3206                                  ; 05/12/2022
  3207                                  ;DOSDATASIZE equ $ ; 29/04/2019 ; -only- for RETRO DOS v4.0 :
  3208                                  ;_PARASTART_ equ DOSDATASIZE ; segment value will point to start of
  3209                                  			    ; of DOSDATA (in low memory) while
  3210                                  			    ; dos/kernel code starts just after 
  3211                                  			    ; this data block ((org = DOSDATASIZE))
  3212                                  			    ; (in low memory or in HMA)	
  3213                                  ; -----------------------------------------------------------------
  3214                                  
  3215                                  ; 04/11/2022
  3216                                  ; -----------------------------------------------------------------
  3217                                  ; NOTE:
  3218                                  ; Microsoft dos programmers were calling 'IO.SYS' as dos 'BIOS'
  3219                                  ; (Also, they were calling 'ROMBIOS' as 'ROM' only!)
  3220                                  ; -----------------------------------------------------------------
  3221                                  
  3222                                  ; ----------------------------------------------------------------------------
  3223                                  ; 06/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3224                                  ; ----------------------------------------------------------------------------
  3225                                  ; ----------------------------------------------------------------------------
  3226                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  3227                                  ; ----------------------------------------------------------------------------
  3228                                  
  3229                                  ;-----------------------------------------------------------------------------
  3230                                  ; Start of (PCDOS 7.1) IBMDOS.COM
  3231                                  ;-----------------------------------------------------------------------------
  3232                                  
  3233                                  ;segment .code vstart=3DD0h ; 06/12/2022
  3234                                  ; 29/09/2023
  3235                                  ;segment .code vstart=3DE0h ; 19/09/2023 - Retro DOS v4.2 (Modified MSDOS 6.22)
  3236                                  ; ----------------------------------------------------------------------------
  3237                                  ; 01/01/2024
  3238                                  segment .code vstart=3F10h ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1)
  3239                                  								
  3240                                  ; ============================================================================
  3241                                  
  3242                                  ;[ORG 3DE0h]
  3243                                  
  3244                                  ;[ORG _PARASTART_]     ; [org 136Ah]
  3245                                  
  3246                                  ;[ORG 1370h] ; 25/05/2019 - Retro DOS v4.0
  3247                                  
  3248                                  ; 01/01/2024 - Retro DOS v5.0 
  3249                                  ;[ORG 3F10h] 
  3250                                  
  3251                                  	; 05/12/2022 - RetroDOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3252                                  	;PARASTART equ 3DD0h ; BIOSDATASTART+BIOSDATASIZE
  3253                                  			     ; +BIOSCODESIZE+DOSDATASIZE (rounded up)
  3254                                  	
  3255                                  	; 29/09/2023 
  3256                                  	; 19/09/2023 - Retro DOS v4.2 (Modified MSDOS 6.22 MSDOS.SYS)
  3257                                  	;PARASTART equ 3DE0h	; (MSDOS 6.22 MSDOS.SYS)
  3258                                  
  3259                                  	; 01/01/2024 - Retro DOS v4.2 (Modified PCDOS 7.1 IBMDOS.COM)
  3260                                  	PARASTART equ 3F10h	; (PCDOS 7.1 IBMDOS.COM)
  3261                                  
  3262                                  	[ORG PARASTART]	
  3263                                  
  3264                                  _$STARTCODE:
  3265                                  
  3266                                  ;PARASTART:
  3267 00000000 E9C881                          JMP     DOSINIT
  3268                                  
  3269                                  	;dw	PARASTART	; PARASTART = 3DE0h for MSDOS 6.0, 6.22
  3270                                  	; 04/11/2022		; PARASTART = 3DD0h for MSDOS 5.0
  3271 00000003 [0000]                  	dw	_$STARTCODE	; PARASTART = 3F10h for PCDOS 7.1 ; 01/01/2024
  3272                                  
  3273                                  BioDataSeg:
  3274 00000005 7000                    	dw	0070h		; Bios data segment fixed at 70h
  3275                                  
  3276                                  ; DosDSeg is a data word in the DOSCODE segment that is loaded with
  3277                                  ; the segment address of DOSDATA. This is purely an optimization, that
  3278                                  ; allows getting the DOS data segment without going through the 
  3279                                  ; BIOS data segment. It is used by the "getdseg" macro.
  3280                                  
  3281                                  DosDSeg:
  3282 00000007 0000                    	dw	0
  3283                                  	
  3284                                  ;============================================================================
  3285                                  ; MSTABLE.ASM (MSDOS 6.0, 1991)
  3286                                  ;============================================================================
  3287                                  ; 16/07/2018 - Retro DOS 3.0
  3288                                  ; 29/04/2019 - Retro DOS 4.0
  3289                                  
  3290                                  	; (MSDOS version)
  3291                                  	; DOSCODE:3DE9h (MSDOS 6.21, MSDOS.SYS)
  3292                                  	;db	6
  3293                                  	;db	20
  3294                                  	; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS) 
  3295                                  	; DOSCODE:3DD9h (MSDOS 5.0, MSDOS.SYS)
  3296                                  	;db	5
  3297                                  	;db	0
  3298                                  
  3299                                  	; Offset 0C78h in IBMDOS.COM (MSDOS 3.3, 1987)
  3300                                  MSVERS:				; MS-DOS version in hex for $GET_VERSION
  3301 00000009 07                      MSMAJOR: DB	MAJOR_VERSION	; DOS_MAJOR_VERSION
  3302 0000000A 0A                      MSMINOR: DB	MINOR_VERSION	; DOS_MINOR_VERSION  
  3303                                  
  3304                                  ;;hkn YRTAB & MONTAB moved to DOSDATA in ms_data.asm
  3305                                  ;	I_am	YRTAB,8,<200,166,200,165,200,165,200,165>   ; [SYSTEM]
  3306                                  ;	I_am	MONTAB,12,<31,28,31,30,31,30,31,31,30,31,30,31> ; [SYSTEM]
  3307                                  
  3308                                  ; DOSTAB.ASM (MSDOS 6.0, 1991)
  3309                                  ; YRTAB & MONTAB moved from TABLE segment in ms_table.asm
  3310                                  ;
  3311                                  ;	I_am    YRTAB,8,<200,166,200,165,200,165,200,165>   
  3312                                  ;	I_am    MONTAB,12,<31,28,31,30,31,30,31,31,30,31,30,31> 
  3313                                  
  3314                                  ; This is the error code mapping table for INT 21 errors. This table defines
  3315                                  ; those error codes which are "allowed" for each system call. If the error
  3316                                  ; code ABOUT to be returned is not "allowed" for the call, the correct action
  3317                                  ; is to return the "real" error via Extended error, and one of the allowed
  3318                                  ; errors on the actual call.
  3319                                  ;
  3320                                  ; The table is organized as follows:
  3321                                  ;
  3322                                  ;    Each entry in the table is of variable size, but the first
  3323                                  ;       two bytes are always:
  3324                                  ;
  3325                                  ;       Call#,Cnt of bytes following this byte
  3326                                  ;
  3327                                  ; EXAMPLE:
  3328                                  ;       Call 61 (OPEN)
  3329                                  ;
  3330                                  ;       DB      61,5,12,3,2,4,5
  3331                                  ;
  3332                                  ;       61 is the AH INT 21 call value for OPEN.
  3333                                  ;        5 indicates that there are 5 bytes after this byte (12,3,2,4,5).
  3334                                  ;       Next five bytes are those error codes which are "allowed" on OPEN.
  3335                                  ;       The order of these values is not important EXCEPT FOR THE LAST ONE (in
  3336                                  ;       this case 5).  The last value will be the one returned on the call if
  3337                                  ;       the "real" error is not one of the allowed ones.
  3338                                  ;
  3339                                  ; There are a number of calls (for instance all of the FCB calls) for which
  3340                                  ;   there is NO entry.  This means that NO error codes are returned on this
  3341                                  ;   call, so set up an Extended error and leave the current error code alone.
  3342                                  ;
  3343                                  ; The table is terminated by a call value of 0FFh
  3344                                  
  3345                                  ;PUBLIC I21_MAP_E_TAB
  3346                                  	; 10/08/2018
  3347                                  
  3348                                  ; 29/04/2019
  3349                                  ; DOSCODE:3DE9h (MSDOS 6.21, MSDOS.SYS)
  3350                                  ; 04/11/2022
  3351                                  ; DOSCODE:3DDBh	(MSDOS 5.0 MSDOS.SYS)
  3352                                  ; 01/01/2024
  3353                                  ; DOSCODE:3F1Bh	(PCDOS 7.1 IBMDOS.COM)
  3354                                  
  3355                                  I21_MAP_E_TAB:	; LABEL	BYTE
  3356 0000000B 38020102                    DB  INTERNATIONAL,2,error_invalid_function,error_file_not_found
  3357 0000000F 3903030205                  DB  MKDIR,3,error_path_not_found,error_file_not_found,error_access_denied
  3358 00000014 3A041003                    DB  RMDIR,4,error_current_directory,error_path_not_found
  3359 00000018 0205                        DB          error_file_not_found,error_access_denied
  3360 0000001A 3B020203                    DB  CHDIR,2,error_file_not_found,error_path_not_found
  3361 0000001E 3C040302                    DB  CREAT,4,error_path_not_found,error_file_not_found
  3362 00000022 04                          DB          error_too_many_open_files
  3363 00000023 05                          DB          error_access_denied
  3364                                      ; MSDOS 6.0
  3365 00000024 3D0603020C                  DB	OPEN,6,error_path_not_found,error_file_not_found,error_invalid_access
  3366 00000029 04                          DB          error_too_many_open_files
  3367 0000002A 1A05                        DB          error_not_DOS_disk,error_access_denied
  3368                                      ; MSDOS 3.3
  3369                                      ;DB	OPEN,5,error_path_not_found,error_file_not_found,error_invalid_access
  3370                                      ;DB		error_too_many_open_files,error_access_denied
  3371 0000002C 3E0106                      DB  CLOSE,1,error_invalid_handle
  3372 0000002F 3F020605                    DB  READ,2,error_invalid_handle,error_access_denied
  3373 00000033 40020605                    DB  WRITE,2,error_invalid_handle,error_access_denied
  3374 00000037 4103030205                  DB  UNLINK,3,error_path_not_found,error_file_not_found,error_access_denied
  3375 0000003C 42020601                    DB  LSEEK,2,error_invalid_handle,error_invalid_function
  3376 00000040 4304030201                  DB  CHMOD,4,error_path_not_found,error_file_not_found,error_invalid_function
  3377 00000045 05                          DB          error_access_denied
  3378 00000046 44050F0D01                  DB  IOCTL,5,error_invalid_drive,error_invalid_data,error_invalid_function
  3379 0000004B 0605                        DB          error_invalid_handle,error_access_denied
  3380 0000004D 45020604                    DB  XDUP,2,error_invalid_handle,error_too_many_open_files
  3381 00000051 46020604                    DB  XDUP2,2,error_invalid_handle,error_too_many_open_files
  3382                                      ; MSDOS 6.0	
  3383 00000055 47021A0F                    DB  CURRENT_DIR,2,error_not_DOS_disk,error_invalid_drive
  3384                                      ; MSDOS 3.3	
  3385                                      ;DB  CURRENT_DIR,1,error_invalid_drive
  3386 00000059 48020708                    DB  ALLOC,2,error_arena_trashed,error_not_enough_memory
  3387 0000005D 49020709                    DB  DEALLOC,2,error_arena_trashed,error_invalid_block
  3388 00000061 4A03070908                  DB  SETBLOCK,3,error_arena_trashed,error_invalid_block,error_not_enough_memory
  3389 00000066 4B08030102                  DB  EXEC,8,error_path_not_found,error_invalid_function,error_file_not_found
  3390 0000006B 040B0A                      DB          error_too_many_open_files,error_bad_format,error_bad_environment
  3391 0000006E 0805                        DB          error_not_enough_memory,error_access_denied
  3392 00000070 4E03030212                  DB  FIND_FIRST,3,error_path_not_found,error_file_not_found,error_no_more_files
  3393 00000075 4F0112                      DB  FIND_NEXT,1,error_no_more_files
  3394                                      ; MSDOS 6.0
  3395 00000078 5605110302                  DB  RENAME,5,error_not_same_device,error_path_not_found,error_file_not_found
  3396 0000007D 1005                        DB		error_current_directory,error_access_denied
  3397                                      ; MSDOS 3.3
  3398                                      ;DB  RENAME,4,error_not_same_device,error_path_not_found,error_file_not_found
  3399                                      ;DB		error_access_denied
  3400                                      ; MSDOS 6.0	
  3401 0000007F 57040608                    DB  FILE_TIMES,4,error_invalid_handle,error_not_enough_memory
  3402 00000083 0D01                        DB		error_invalid_data,error_invalid_function
  3403                                      ; MSDOS 3.3	
  3404                                      ;DB  FILE_TIMES,2,error_invalid_handle,error_invalid_function
  3405 00000085 580101                      DB  ALLOCOPER,1,error_invalid_function
  3406 00000088 5A040302                    DB  CREATETEMPFILE,4,error_path_not_found,error_file_not_found
  3407 0000008C 0405                        DB          error_too_many_open_files,error_access_denied
  3408 0000008E 5B055003                    DB  CREATENEWFILE,5,error_file_exists,error_path_not_found
  3409 00000092 020405                      DB          error_file_not_found,error_too_many_open_files,error_access_denied
  3410 00000095 5C040601                    DB  LOCKOPER,4,error_invalid_handle,error_invalid_function
  3411 00000099 2421                        DB          error_sharing_buffer_exceeded,error_lock_violation
  3412 0000009B 65020102                    DB  GETEXTCNTRY,2,error_invalid_function,error_file_not_found	;DOS 3.3
  3413 0000009F 66020102                    DB  GETSETCDPG,2,error_invalid_function,error_file_not_found        ;DOS 3.3
  3414 000000A3 680106                      DB  COMMIT,1,error_invalid_handle                                   ;DOS 3.3
  3415 000000A6 67030408                    DB  EXTHANDLE,3,error_too_many_open_files,error_not_enough_memory
  3416 000000AA 01                          DB              error_invalid_function
  3417                                      ; MSDOS 6.0
  3418 000000AB 6C0A                        DB	ExtOpen,10
  3419 000000AD 03020C                      DB	  error_path_not_found,error_file_not_found,error_invalid_access
  3420 000000B0 045008                      DB		error_too_many_open_files,error_file_exists,error_not_enough_memory
  3421 000000B3 1A0D                        DB		error_not_DOS_disk,error_invalid_data
  3422 000000B5 0105                        DB		error_invalid_function,error_access_denied
  3423 000000B7 69040F0D                    DB	GetSetMediaID,4,error_invalid_drive,error_invalid_data
  3424 000000BB 0105                        DB		error_invalid_function,error_access_denied
  3425                                      ; 01/01/2024
  3426                                      ; PCDOS 7.1
  3427 000000BD 700101                      db	ExtCountryInfo,1,error_invalid_function 
  3428 000000C0 FF                          DB  0FFh
  3429                                  
  3430                                  ;19/09/2023
  3431                                  ;22/12/2022
  3432                                  ;04/11/2022	
  3433                                  ;29/04/2019 - Retro DOS v4.0
  3434                                  ;============================================================================
  3435                                  ; 	Retro DOS v4.0
  3436                                  ;============================================================================
  3437 000000C1 00                      	db 	0
  3438                                  RETRODOSMSG:
  3439 000000C2 0D0A                    	db	13,10
  3440                                  	;;;;;db	"Retro DOS v4.0 by Erdogan Tan [2019]"
  3441                                  	;;;;db	"Retro DOS v4.0 by Erdogan Tan [2022]"
  3442                                  	;;;db	"Retro DOS v4.1 by Erdogan Tan [2022]" ; 28/12/2022
  3443                                  	;;db	"Retro DOS v4.2 by Erdogan Tan [2022]" ; 30/12/2022
  3444                                  	;db	"Retro DOS v4.2 by Erdogan Tan [2023]"
  3445 000000C4 526574726F20444F53-     	db	"Retro DOS v5.0 by Erdogan Tan [2024]" ; 01/01/2024	 
  3445 000000CD 2076352E3020627920-
  3445 000000D6 4572646F67616E2054-
  3445 000000DF 616E205B323032345D 
  3446 000000E8 0D0A2400                	db	13,10,"$", 0 
  3447                                  
  3448                                  ;============================================================================
  3449                                  ; MSTABLE.ASM, MSDOS 6.0, 1991
  3450                                  ;============================================================================
  3451                                  ; 11/07/2018 - Retro DOS v3.0
  3452                                  
  3453                                  	%define short_addr dw  ; 03/03/2018 - Retro DOS v2.0
  3454                                  align 2
  3455                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 0E00h
  3456                                  
  3457                                  ; Standard Functions
  3458                                  ;DISPATCH  LABEL WORD
  3459                                  DISPATCH:
  3460                                  	; 16/07/2018 - Retro DOS v3.0
  3461                                  	; (MSDOS 3.3)
  3462                                  
  3463                                  ; 29/04/2019
  3464                                  ; DOSCODE:3E9Eh (MSDOS 6.21, MSDOS.SYS)
  3465                                  
  3466                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3467                                  ; DOSCODE:3E8Eh (MSDOS 5.0, MSDOS.SYS)
  3468                                  
  3469                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  3470                                  ; DOSCODE:3FD2h (PCDOS 7.1, IBMDOS.COM)
  3471                                  
  3472 000000EC [F66E]                          short_addr  _$ABORT			    ;  0      0
  3473 000000EE [C81B]                          short_addr  _$STD_CON_INPUT		    ;  1      1
  3474 000000F0 [D11B]                          short_addr  _$STD_CON_OUTPUT		    ;  2      2
  3475 000000F2 [831C]                          short_addr  _$STD_AUX_INPUT		    ;  3      3
  3476 000000F4 [9E1C]                          short_addr  _$STD_AUX_OUTPUT		    ;  4      4
  3477 000000F6 [A41C]                          short_addr  _$STD_PRINTER_OUTPUT	    ;  5      5
  3478 000000F8 [091B]                          short_addr  _$RAW_CON_IO		    ;  6      6
  3479 000000FA [351B]                          short_addr  _$RAW_CON_INPUT		    ;  7      7
  3480 000000FC [E418]                          short_addr  _$STD_CON_INPUT_NO_ECHO	    ;  8      8
  3481 000000FE [3C19]                          short_addr  _$STD_CON_STRING_OUTPUT	    ;  9      9
  3482 00000100 [4819]                          short_addr  _$STD_CON_STRING_INPUT	    ; 10      A
  3483 00000102 [B81C]                          short_addr  _$STD_CON_INPUT_STATUS	    ; 11      B
  3484 00000104 [C11C]                          short_addr  _$STD_CON_INPUT_FLUSH	    ; 12      C
  3485 00000106 [FB13]                          short_addr  _$DISK_RESET		    ; 13      D
  3486 00000108 [340F]                          short_addr  _$SET_DEFAULT_DRIVE		    ; 14      E
  3487 0000010A [B323]                          short_addr  _$FCB_OPEN			    ; 15      F
  3488 0000010C [601D]                          short_addr  _$FCB_CLOSE			    ; 16     10
  3489 0000010E [CA24]                          short_addr  _$DIR_SEARCH_FIRST		    ; 17     11
  3490 00000110 [1025]                          short_addr  _$DIR_SEARCH_NEXT		    ; 18     12
  3491 00000112 [061D]                          short_addr  _$FCB_DELETE		    ; 19     13
  3492 00000114 [0E22]                          short_addr  _$FCB_SEQ_READ		    ; 20     14
  3493 00000116 [1222]                          short_addr  _$FCB_SEQ_WRITE	            ; 21     15
  3494 00000118 [BA24]                          short_addr  _$FCB_CREATE		    ; 22     16
  3495 0000011A [CC1D]                          short_addr  _$FCB_RENAME		    ; 23     17
  3496                                  	; 16/07/2018
  3497                                          ;short_addr _CPMFUNC			    ; 24     18	
  3498 0000011C [8706]                          short_addr  NO_OP			    ; 24     18
  3499 0000011E [2F0F]                          short_addr  _$GET_DEFAULT_DRIVE		    ; 25     19
  3500 00000120 [240F]                          short_addr  _$SET_DMA			    ; 26     1A
  3501                                  
  3502                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3503                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3504                                  ;                                                                          ;
  3505 00000122 [D212]                          short_addr  _$SLEAZEFUNC		    ; 27     1B
  3506 00000124 [D412]                          short_addr  _$SLEAZEFUNCDL		    ; 28     1C
  3507                                  ;                                                                          ;
  3508                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3509                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3510                                  
  3511                                          ;short_addr  _CPMFUNC			    ; 29     1D
  3512                                          ;short_addr  _CPMFUNC			    ; 30     1E
  3513                                  
  3514                                  ; 08/07/2018 - Retro DOS v3.0
  3515                                  ; MSDOS 6.0 - MSTABLE.ASM, 1991
  3516                                  
  3517 00000126 [8706]                  	short_addr  NO_OP			    ; 29     1D
  3518 00000128 [8706]                  	short_addr  NO_OP			    ; 30     1E
  3519                                  
  3520                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3521                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3522                                  ;                                                                          ;
  3523 0000012A [1F13]                          short_addr  _$GET_DEFAULT_DPB               ; 31     1F
  3524                                  ;                                                                          ;
  3525                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3526                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3527                                          ;short_addr _CPMFUNC			    ; 32     20
  3528                                  
  3529                                  ; 08/07/2018 - Retro DOS v3.0
  3530                                  ; MSDOS 6.0 - MSTABLE.ASM, 1991
  3531                                  
  3532 0000012C [8706]                  	short_addr  NO_OP			    ; 32     20
  3533                                  
  3534 0000012E [1622]                          short_addr  _$FCB_RANDOM_READ               ; 33     21
  3535 00000130 [1A22]                          short_addr  _$FCB_RANDOM_WRITE              ; 34     22
  3536 00000132 [181D]                          short_addr  _$GET_FCB_FILE_LENGTH	    ; 35     23
  3537 00000134 [EE1C]                          short_addr  _$GET_FCB_POSITION		    ; 36     24
  3538                                  
  3539                                  ;MAXCALL = ($-DISPATCH)/2 - 1
  3540                                  MAXCALL EQU ($-DISPATCH)/2 - 1
  3541                                  
  3542                                  ; Extended Functions
  3543 00000136 [550F]                          short_addr  _$SET_INTERRUPT_VECTOR	    ; 37     25
  3544                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3545                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3546                                  ;                                                                          ;
  3547 00000138 [2C16]                          short_addr  _$CREATE_PROCESS_DATA_BLOCK	    ; 38     26
  3548                                  ;                                                                          ;
  3549                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3550                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3551 0000013A [0A22]                          short_addr  _$FCB_RANDOM_READ_BLOCK	    ; 39     27
  3552 0000013C [0622]                          short_addr  _$FCB_RANDOM_WRITE_BLOCK        ; 40     28
  3553 0000013E [AF12]                          short_addr  _$PARSE_FILE_DESCRIPTOR	    ; 41     29
  3554 00000140 [B50A]                          short_addr  _$GET_DATE                      ; 42     2A
  3555 00000142 [D20A]                          short_addr  _$SET_DATE                      ; 43     2B
  3556 00000144 [F10A]                          short_addr  _$GET_TIME                      ; 44     2C
  3557 00000146 [020B]                          short_addr  _$SET_TIME                      ; 45     2D
  3558 00000148 [A00C]                          short_addr  _$SET_VERIFY_ON_WRITE           ; 46     2E
  3559                                  
  3560                                  ; Extended functionality group
  3561 0000014A [110F]                          short_addr  _$GET_DMA                       ; 47     2F
  3562 0000014C [790C]                          short_addr  _$GET_VERSION                   ; 48     30
  3563 0000014E [9A6E]                          short_addr  _$KEEP_PROCESS		    ; 49     31
  3564                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3565                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3566                                  ;                                                                          ;
  3567 00000150 [2113]                          short_addr  _$GET_DPB			    ; 50     32
  3568                                  ;                                                                          ;
  3569                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3570                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3571 00000152 [3D02]                          short_addr  _$SET_CTRL_C_TRAPPING           ; 51     33
  3572 00000154 [0913]                          short_addr  _$GET_INDOS_FLAG                ; 52     34
  3573 00000156 [460F]                          short_addr  _$GET_INTERRUPT_VECTOR          ; 53     35
  3574 00000158 [E00E]                          short_addr  _$GET_DRIVE_FREESPACE           ; 54     36
  3575 0000015A [820F]                          short_addr  _$CHAR_OPER                     ; 55     37
  3576 0000015C [A70C]                          short_addr  _$INTERNATIONAL                 ; 56     38
  3577                                  ; XENIX CALLS
  3578                                  ;   Directory Group
  3579 0000015E [BE27]                          short_addr  _$MKDIR			    ; 57     39
  3580 00000160 [DF26]                          short_addr  _$RMDIR			    ; 58     3A
  3581 00000162 [2E27]                          short_addr  _$CHDIR			    ; 59     3B
  3582                                  ;   File Group
  3583 00000164 [267D]                          short_addr  _$CREAT			    ; 60     3C
  3584 00000166 [4E7C]                          short_addr  _$OPEN			    ; 61     3D
  3585 00000168 [F273]                          short_addr  _$CLOSE		 	    ; 62     3E
  3586 0000016A [F974]                          short_addr  _$READ			    ; 63     3F
  3587 0000016C [5675]                          short_addr  _$WRITE			    ; 64     40
  3588 0000016E [987D]                          short_addr  _$UNLINK			    ; 65     41
  3589 00000170 [5B75]                          short_addr  _$LSEEK			    ; 66     42
  3590 00000172 [337D]                          short_addr  _$CHMOD			    ; 67     43
  3591 00000174 [2628]                          short_addr  _$IOCTL			    ; 68     44
  3592 00000176 [BF75]                          short_addr  _$DUP			    ; 69     45
  3593 00000178 [DD75]                          short_addr  _$DUP2			    ; 70     46
  3594 0000017A [7B26]                          short_addr  _$CURRENT_DIR		    ; 71     47
  3595                                  ;   Memory Group
  3596 0000017C [936F]                          short_addr  _$ALLOC			    ; 72     48
  3597 0000017E [0871]                          short_addr  _$DEALLOC                       ; 73     49
  3598 00000180 [E470]                          short_addr  _$SETBLOCK                      ; 74     4A
  3599                                  ;   Process Group
  3600 00000182 [8E68]                          short_addr  _$EXEC			    ; 75     4B
  3601 00000184 [D26E]                          short_addr  _$EXIT			    ; 76     4C
  3602 00000186 [8468]                          short_addr  _$WAIT			    ; 77     4D
  3603 00000188 [C525]                          short_addr  _$FIND_FIRST		    ; 78     4E
  3604                                  ;   Special Group
  3605 0000018A [1926]                          short_addr  _$FIND_NEXT			    ; 79     4F
  3606                                  ; SPECIAL SYSTEM GROUP
  3607                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3608                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3609                                  ;                                                                          ;
  3610 0000018C [A202]                          short_addr  _$SET_CURRENT_PDB		    ; 80     50
  3611 0000018E [AE02]                          short_addr  _$GET_CURRENT_PDB               ; 81     51
  3612 00000190 [1513]                          short_addr  _$GET_IN_VARS                   ; 82     52
  3613 00000192 [4214]                          short_addr  _$SETDPB			    ; 83     53
  3614                                  ;                                                                          ;
  3615                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3616                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3617 00000194 [9B0C]                          short_addr  _$GET_VERIFY_ON_WRITE	    ; 84     54
  3618                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3619                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3620                                  ;                                                                          ;
  3621 00000196 [1B16]                          short_addr  _$DUP_PDB                       ; 85     55
  3622                                  ;                                                                          ;
  3623                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3624                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3625 00000198 [BE7D]                          short_addr  _$RENAME			    ; 86     56
  3626 0000019A [EB75]                          short_addr  _$FILE_TIMES                    ; 87     57
  3627 0000019C [3D71]                          short_addr  _$ALLOCOPER                     ; 88     58
  3628                                  
  3629                                  ; 08/07/2018 - Retro DOS v3.0
  3630                                  ; -------------------------------------------------------------------------;
  3631                                  ; MSDOS 6.0 - MSTABLE.ASM, 1991
  3632                                  
  3633                                  ; Network extention system calls
  3634 0000019E [960F]                          short_addr  _$GetExtendedError              ; 89     59
  3635 000001A0 [4A7E]                          short_addr  _$CreateTempFile                ; 90     5A
  3636 000001A2 [327E]                          short_addr  _$CreateNewFile                 ; 91     5B
  3637 000001A4 [0D80]                          short_addr  _$LockOper                      ; 92     5C
  3638 000001A6 [0872]                          short_addr  _$ServerCall                    ; 93     5D
  3639 000001A8 [A777]                          short_addr  _$UserOper                      ; 94     5E
  3640 000001AA [0C77]                          short_addr  _$AssignOper                    ; 95     5F
  3641 000001AC [E97B]                          short_addr  _$NameTrans                     ; 96     60
  3642 000001AE [8706]                  	short_addr  NO_OP			    ; 97     61
  3643 000001B0 [AE02]                          short_addr  _$GET_CURRENT_PDB		    ; 98     62
  3644                                  ; the next call is reserved for hangool sys call
  3645                                  	; 29/04/2019 - Retro DOS v4.0 (MSDOS 6.0)
  3646 000001B2 [B60F]                  	short_addr  _$ECS_Call			    ; 99     63
  3647                                  	;short_addr  NO_OP  ;  MSDOS 3.3	    ; 99     63
  3648                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3649                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3650                                  ;                                                                          ;
  3651 000001B4 [BA02]                          short_addr  _$SET_PRINTER_FLAG              ; 100    64
  3652                                  ;                                                                          ;
  3653                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3654                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3655 000001B6 [640D]                          short_addr  _$GetExtCntry                   ; 101    65
  3656 000001B8 [8E0E]                          short_addr  _$GetSetCdPg                    ; 102    66
  3657 000001BA [3D74]                          short_addr  _$ExtHandle                     ; 103    67
  3658 000001BC [2574]                          short_addr  _$COMMIT                        ; 104    68
  3659                                  
  3660                                  ; 08/07/2018
  3661                                  ; Above system calls are valid for Retro DOS v3.0 (MSDOS 3.3) 
  3662                                  ; Following system calls are valid for Retro DOS v4.0 (MSDOS 6.0)
  3663                                  
  3664                                  ; 29/04/2019 - Retro DOS v4.0 (MSDOS 6.0)
  3665 000001BE [1E17]                  	short_addr  _$GSetMediaID                   ; 105    69   ;AN000;
  3666 000001C0 [2574]                  	short_addr  _$COMMIT                        ; 106    6A   ;AN000;
  3667 000001C2 [8706]                  	short_addr  NO_OP                           ; 107    6B   
  3668                                  						    ; IFS_IOCTL no longer 
  3669                                  						    ; supported
  3670 000001C4 [F57E]                  	short_addr  _$Extended_Open                 ; 108    6C   ;AN000;
  3671                                  
  3672                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3673                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3674                                  ;                                                                          ;
  3675                                  ;ifdef ROMEXEC
  3676                                  ;       short_addr  $ROM_FIND_FIRST	   	    ; 109    6D
  3677                                  ;       short_addr  $ROM_FIND_NEXT	   	    ; 110    6E
  3678                                  ;	short_addr  $ROM_EXCLUDE		    ; 111    6F	  ; M078
  3679                                  ;endif
  3680                                  ;                                                                          ;
  3681                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
  3682                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
  3683                                  
  3684                                  ; --------------------------------------------------------------------------
  3685                                  
  3686                                  ; 01/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  3687                                  
  3688 000001C6 [8706]                  	short_addr NO_OP	; 6Dh, OS/2 "DosMkDir2" - ROM DOS: Find first ROM program
  3689 000001C8 [8706]                  	short_addr NO_OP	; 6Eh, OS/2 "DosEnumAttrib" - ROM DOS: Find next ROM program
  3690 000001CA [8706]                  	short_addr NO_OP	; 6Fh, OS/2 "DosQMaxEASize" - ROM DOS: Get/set searched ROM area
  3691 000001CC [2A0D]                  	short_addr _$ExtCountryInfo ; 70h, MSDOS 7 (WIN 95) - Get/set extended country information
  3692                                  				; GET/SET INTERNATIONALIZATION INFORMATION
  3693 000001CE [D10F]                  	short_addr _$LONGNAME	; 71h, MSDOS 7 (WIN 95) LONG FILENAME FUNCTIONS
  3694 000001D0 [D10F]                  	short_addr _$LONGNAME	; 72h, MSDOS 7 (WIN 95) LFN-FindClose
  3695 000001D2 [DE0F]                  	short_addr _$FAT32EXT	; 73h, MSDOS 7 - FAT32 extended drive functions
  3696                                  
  3697                                  ;MAXCOM  = ($-DISPATCH)/2 - 1
  3698                                  
  3699                                  MAXCOM  EQU ($-DISPATCH)/2 - 1
  3700                                  
  3701                                  ; 08/07/2018 - Retro DOS v3.0
  3702                                  ; MSDOS 6.0 - MSTABLE.ASM, 1991
  3703                                  
  3704                                  ;	If Installed
  3705                                  
  3706                                  align 2
  3707                                  
  3708                                  ;PUBLIC FOO
  3709                                  
  3710                                  FOO:	; LABEL WORD
  3711 000001D4 [4407]                          short_addr Leave2F
  3712                                  
  3713 000001D6 [D801]                  DTab:	DW DOSTable
  3714                                  
  3715                                  	;PUBLIC FOO,DTAB
  3716                                  
  3717                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 0ED6h
  3718                                  
  3719                                  ; 29/04/2019
  3720                                  ; DOSCODE:3F7Ch (MSDOS 6.21, MSDOS.SYS)
  3721                                  
  3722                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3723                                  ; DOSCODE:3F6Ch (MSDOS 5.0, MSDOS.SYS)
  3724                                  
  3725                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  3726                                  ; DOSCODE:40BEh (PCDOS 7.1, IBMDOS.COM)
  3727                                         
  3728                                  DOSTable:  ; LABEL  WORD
  3729 000001D8 32                              DB	(DOSTableEnd-DOSTable-1)/2 ; db 50 ; 01/01/2024 
  3730 000001D9 [B609]                          short_addr  DOSInstall          ;   0 install check
  3731 000001DB [0E36]                          short_addr  DOS_CLOSE           ;   1   DOS_CLOSE
  3732 000001DD [770F]                          short_addr  RECSET              ;   2   RECSET
  3733 000001DF [B009]                          short_addr  DosGetGroup         ;   3   Get DOSGROUP
  3734 000001E1 [905A]                          short_addr  PATHCHRCMP          ;   4   PATHCHRCMP
  3735 000001E3 [D31B]                          short_addr  OUTT                ;   5   OUT
  3736 000001E5 [A05D]                          short_addr  NET_I24_ENTRY       ;   6   NET_I24_ENTRY
  3737 000001E7 [7865]                          short_addr  PLACEBUF            ;   7   PLACEBUF
  3738 000001E9 [6B37]                          short_addr  FREE_SFT            ;   8   FREE_SFT
  3739 000001EB [C267]                          short_addr  BUFWRITE            ;   9   BUFWRITE
  3740 000001ED [D180]                          short_addr  SHARE_VIOLATION     ;   10  SHARE_VIOLATION
  3741 000001EF [1C32]                          short_addr  SHARE_ERROR         ;   11  SHARE_ERROR
  3742 000001F1 [0632]                          short_addr  SET_SFT_MODE        ;   12  SET_SFT_MODE
  3743 000001F3 [3D0B]                          short_addr  DATE16              ;   13  DATE16
  3744 000001F5 [C117]                          short_addr  Idle		;   14      empty slot
  3745 000001F7 [7165]                          short_addr  SCANPLACE           ;   15  SCANPLACE
  3746 000001F9 [C117]                          short_addr  Idle		;   16      empty slot
  3747 000001FB [8E17]                          short_addr  StrCpy              ;   17  StrCpy
  3748 000001FD [A617]                          short_addr  StrLen              ;   18  StrLen
  3749 000001FF [3D5A]                          short_addr  UCase		;   19  UCase
  3750 00000201 [B565]                          short_addr  POINTCOMP           ;   20  POINTCOMP
  3751 00000203 [8D67]                          short_addr  CHECKFLUSH          ;   21  CHECKFLUSH
  3752 00000205 [6E73]                          short_addr  SFFromSFN           ;   22  SFFromSFN
  3753 00000207 [6178]                          short_addr  GetCDSFromDrv       ;   23  GetCDSFromDrv
  3754 00000209 [7704]                          short_addr  Get_User_Stack      ;   24  Get_User_Stack
  3755 0000020B [1278]                          short_addr  GETTHISDRV          ;   25  GetThisDrv
  3756 0000020D [0E7C]                          short_addr  DriveFromText       ;   26  DriveFromText
  3757 0000020F [E00B]                          short_addr  SETYEAR             ;   27  SETYEAR
  3758 00000211 [6F0C]                          short_addr  DSUM                ;   28  DSUM
  3759 00000213 [D40B]                          short_addr  DSLIDE              ;   29  DSLIDE
  3760 00000215 [6C17]                          short_addr  StrCmp              ;   30  StrCmp
  3761 00000217 [5A77]                          short_addr  InitCDS             ;   31  initcds
  3762 00000219 [3B73]                          short_addr  pJFNFromHandle      ;   32  pJfnFromHandle
  3763 0000021B [E97B]                          short_addr  _$NameTrans		;   33  $NameTrans
  3764 0000021D [AE06]                          short_addr  CAL_LK              ;   34  CAL_LK
  3765 0000021F [FB4B]                          short_addr  DEVNAME             ;   35  DEVNAME
  3766 00000221 [C117]                          short_addr  Idle                ;   36  Idle
  3767 00000223 [B417]                          short_addr  DStrLen             ;   37  DStrLen
  3768 00000225 [2818]                          short_addr  NLS_OPEN            ;   38  NLS_OPEN      DOS 3.3
  3769 00000227 [F273]                          short_addr  _$CLOSE		;   39  $CLOSE        DOS 3.3
  3770 00000229 [2E18]                          short_addr  NLS_LSEEK           ;   40  NLS_LSEEK     DOS 3.3
  3771 0000022B [F974]                          short_addr  _$READ		;   41  $READ         DOS 3.3
  3772 0000022D [2518]                          short_addr  FastInit            ;   42  FastInit      DOS 3.4  ;AN000;
  3773 0000022F [6B18]                          short_addr  NLS_IOCTL           ;   43  NLS_IOCTL     DOS 3.3
  3774 00000231 [5A18]                          short_addr  GetDevList          ;   44  GetDevList    DOS 3.3
  3775 00000233 [7F18]                          short_addr  NLS_GETEXT          ;   45  NLS_GETEXT    DOS 3.3
  3776                                          
  3777                                  	; 29/04/2019 - Retro DOS v4.0
  3778 00000235 [8318]                  	short_addr  MSG_RETRIEVAL	;   46  MSG_RETRIEVAL DOS 4.0  ;AN000;
  3779                                  
  3780 00000237 [8706]                  	short_addr  NO_OP		;   M006: 47  no longer supported
  3781                                  ;*** 	short_addr  Fake_Version	;   47  Fake_Version  DOS 4.0  ;AN006;
  3782                                  
  3783                                  	; -------------------------------
  3784                                  
  3785                                  	; 01/01/2024 - Retro DOS v5.0 (PCDOS 7.1)
  3786 00000239 [5149]                  	short_addr  int_2Fh_1230h	;   48
  3787                                  				; FIND SFT ENTRY IN INTERNAL FILE TABLES
  3788 0000023B [6909]                  	short_addr  int_2Fh_1231h	;   49
  3789                                  				; SET/CLEAR REPORT WINDOWS TO DOS PROGRAMS FLAG	
  3790                                  
  3791                                  DOSTableEnd:  ; LABEL BYTE
  3792                                  
  3793                                  	;ENDIF
  3794                                  
  3795                                  ; ----------------------------------------------------------------------------
  3796                                  ; BREAK   <Copyright notice and version>
  3797                                  ; ----------------------------------------------------------------------------
  3798                                  
  3799                                  ;CODSTRT EQU	$
  3800                                  
  3801                                  ; 08/07/2018 - Retro DOS v3.0 by Erdogan Tan
  3802                                  ; (MSTABLE.ASM, MSDOS 6.0, 1991)
  3803                                  
  3804                                  ; NOTE WARNING: This declaration of HEADER must be THE LAST thing in this
  3805                                  ;       module. The reason is so that the data alignments are the same in
  3806                                  ;       IBM-DOS and MS-DOS up through header.
  3807                                  
  3808                                  	;PUBLIC	HEADER
  3809                                  
  3810                                  HEADER:	; LABEL	BYTE
  3811                                          ;IF	DEBUG
  3812                                          ;DB	13,10,"Debugging DOS version "
  3813                                          ;DB	MAJOR_VERSION + "0"
  3814                                          ;DB	"."
  3815                                          ;DB	(MINOR_VERSION / 10) + "0"
  3816                                          ;DB	(MINOR_VERSION MOD 10) + "0"
  3817                                          ;ENDIF
  3818                                  
  3819                                  ; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3820                                  ; (MSDOS 5.0 MSDOS.SYS compatibility)
  3821                                  %if 0
  3822                                          ;IF	NOT IBM
  3823                                          DB	13,10,"MS-DOS version "
  3824                                          DB	MAJOR_VERSION + "0"
  3825                                          DB	"."
  3826                                          DB	(MINOR_VERSION / 10) + "0"
  3827                                          ;DB	(MINOR_VERSION MOD 10) + "0"
  3828                                          DB	(MINOR_VERSION % 10) + "0"
  3829                                  
  3830                                          ;IF	HIGHMEM
  3831                                          ;DB	"H"
  3832                                          ;ENDIF
  3833                                  
  3834                                  	;DB	13,10,"Copyright 1981,82,83,84,88 Microsoft Corp.",13,10,"$"
  3835                                  	; 30/04/2019 - Retro DOS v4.0
  3836                                  	DB	13,10,"Copyright 1981-1993 Microsoft Corp.",13,10,"$"	
  3837                                  
  3838                                  	;ENDIF
  3839                                  
  3840                                  %endif
  3841                                  
  3842                                  ;IF DEBUG
  3843                                  ;	DB	13,10,"$"
  3844                                  ;ENDIF
  3845                                  
  3846                                  ;include copyrigh.inc
  3847                                  
  3848                                  ; DOSCODE:3FDDh (MSDOS 6.21, MSDOS.SYS)
  3849                                  
  3850                                  	;DB	"MS DOS Version 6 (C)Copyright 1981-1993 Microsoft Corp "
  3851                                  	;DB	"Licensed Material - Property of Microsoft "
  3852                                  	;DB	"All rights reserved "
  3853                                  
  3854                                  ; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3855                                  ; DOSCODE:3FCDh (MSDOS 5.0, MSDOS.SYS)
  3856                                  
  3857                                  ; 28/12/2022 - Retro DOS v4.1
  3858                                  %if 0
  3859                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  3860                                  ms_copyright:
  3861                                  	db	'MS DOS Version 5.00 (C)Copyright 1981-1991 Microsoft Corp '
  3862                                  	db	'Licensed Material - Property of Microsoft '
  3863                                  	db	'All rights reserved '
  3864                                  
  3865                                  %endif
  3866                                  	;; 28/12/2022 - Retro DOS v4.1
  3867                                  ;ms_copyright:	
  3868                                    	;db	13,10,"MS DOS Version 5.0"
  3869                                  	;db	13,10,"Copyright 1981-1991 Microsoft Corp.",13,10,"$",0	
  3870                                  
  3871                                  ;	; 21/09/2023 - Retro DOS v4.2 MSDOS.SYS
  3872                                  ;	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:3FDDh (File offset: 509))
  3873                                  ;ms_copyright:
  3874                                  ;	db 'MS DOS Version 6 (C)Copyright 1981-1994 Microsoft Corp '
  3875                                  ;	db 'Licensed Material - Property of Microsoft All rights reserved '
  3876                                  
  3877                                  	; 01/01/2024 - Retro DOS v5.0
  3878                                  	
  3879                                  	; 20/09/2023 - Retro DOS v4.2
  3880                                  ;ms_copyright:	
  3881                                  	;db	13,10,"MS DOS Version 6.22"
  3882                                  	;db	13,10,"Copyright 1981-1994 Microsoft Corp.",13,10,"$",0	
  3883                                  
  3884                                  ;============================================================================
  3885                                  ; MSCODE.ASM
  3886                                  ;============================================================================
  3887                                  
  3888                                  ; Retro DOS v2.0 (NASM 2.11) source code modifications by Erdogan Tan
  3889                                  ; 03/03/2018
  3890                                  
  3891                                  ;
  3892                                  ; MSCODE.ASM -- MSDOS code
  3893                                  ;
  3894                                  
  3895                                  ;INCLUDE DOSSEG.ASM
  3896                                  ;INCLUDE STDSW.ASM
  3897                                  
  3898                                  ;CODE    SEGMENT BYTE PUBLIC  'CODE'
  3899                                  ;ASSUME  CS:DOSGROUP,DS:NOTHING,ES:NOTHING,SS:NOTHING
  3900                                  
  3901                                  ;.xcref
  3902                                  ;INCLUDE DOSSYM.ASM
  3903                                  ;INCLUDE DEVSYM.ASM
  3904                                  ;.cref
  3905                                  ;.list
  3906                                  
  3907                                  ;IFNDEF  KANJI
  3908                                  ;KANJI   EQU     0       ; FALSE
  3909                                  ;ENDIF
  3910                                  
  3911                                  ;IFNDEF  IBM
  3912                                  ;IBM     EQU     0
  3913                                  ;ENDIF
  3914                                  
  3915                                  ;IFNDEF  HIGHMEM
  3916                                  ;HIGHMEM  EQU     0
  3917                                  ;ENDIF
  3918                                  
  3919                                          ;i_need  USER_SP,WORD
  3920                                          ;i_need  USER_SS,WORD
  3921                                          ;i_need  SAVEDS,WORD
  3922                                          ;i_need  SAVEBX,WORD
  3923                                          ;i_need  INDOS,BYTE
  3924                                          ;i_need  NSP,WORD
  3925                                          ;i_need  NSS,WORD
  3926                                          ;i_need  CURRENTPDB,WORD
  3927                                          ;i_need  AUXSTACK,BYTE
  3928                                          ;i_need  CONSWAP,BYTE
  3929                                          ;i_need  IDLEINT,BYTE
  3930                                          ;i_need  NOSETDIR,BYTE
  3931                                          ;i_need  ERRORMODE,BYTE
  3932                                          ;i_need  IOSTACK,BYTE
  3933                                          ;i_need  WPERR,BYTE
  3934                                          ;i_need  DSKSTACK,BYTE
  3935                                          ;i_need  CNTCFLAG,BYTE
  3936                                          ;i_need  LEAVEADDR,WORD
  3937                                          ;i_need  NULLDEVPT,DWORD
  3938                                  
  3939                                          ;IF NOT IBM
  3940                                          ;i_need  OEM_HANDLER,DWORD
  3941                                          ;ENDIF
  3942                                  
  3943                                          ;EXTRN   DSKSTATCHK:NEAR,GETBP:NEAR,DSKREAD:NEAR,DSKWRITE:NEAR
  3944                                  
  3945                                  ;============================================================================
  3946                                  ; MSDISP.ASM, MSDOS 6.0, 1991
  3947                                  ;============================================================================
  3948                                  ; 11/07/2018 - Retro DOS v3.0
  3949                                  ; 01/05/2019 - Retro DOS v4.0
  3950                                  
  3951                                  ; DosCode SEGMENT
  3952                                  
  3953                                  ; ==========================================================================
  3954                                  
  3955                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  3956                                  ; DOSCODE:4045h (MSDOS 5.0, MSDOS.SYS)
  3957                                  
  3958                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  3959                                  ; DOSCODE:4123h (PCDOS 7.1, IBMDOS.COM)
  3960                                  
  3961                                  _$SET_CTRL_C_TRAPPING:
  3962                                  	; 01/05/2019 - Retro DOS v4.0
  3963                                  
  3964 0000023D 3C07                    	cmp	al,7	; 01/01/2024 - Retro DOS v5.0
  3965                                  	;cmp	AL,6			; Is this a valid subfunction?
  3966 0000023F 7603                    	jbe	short scct_1		; If yes continue processing
  3967                                  
  3968 00000241 B0FF                    	mov	AL,0FFh			; Else set AL to -1 and
  3969 00000243 CF                      	iret
  3970                                  scct_1:
  3971 00000244 1E                      	push	DS
  3972                                  
  3973                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  3974 00000245 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  3975                                  	
  3976 0000024A 50                      	push	AX			; DL only register that can change
  3977 0000024B 56                      	push	SI
  3978                                  
  3979 0000024C BE[3703]                	mov	SI,CNTCFLAG		; DS:SI --> Ctrl C Status byte
  3980 0000024F 30E4                    	xor	AH,AH			; Clear high byte of AX
  3981 00000251 09C0                    	or	AX,AX			; Check for subfunction 0
  3982 00000253 7504                    	jnz	short scct_2		; If not 0 jmp to next check
  3983                                  
  3984 00000255 8A14                    	mov	DL,[SI]			; Else move current ctrl C status
  3985 00000257 EB32                    	jmp	SHORT scct_9s		; into DL and jmp to exit
  3986                                  scct_2:
  3987 00000259 48                      	dec	AX			; Now dec AX and see if it was 1
  3988 0000025A 7507                    	jnz	short scct_3		; If not 0 it wasn't 1 so do next chk
  3989                                  
  3990 0000025C 80E201                  	and	DL,1			; Else mask off bit 0 of DL and
  3991 0000025F 8814                    	mov	[SI],DL			; save it as new Ctrl C status
  3992 00000261 EB28                    	jmp	SHORT scct_9s		; Jmp to exit
  3993                                  scct_3:
  3994 00000263 48                      	dec	AX			; Dec AX again to see if it was 2
  3995 00000264 7507                    	jnz	short scct_4		; If not 0 wasn't 2 so go to next chk
  3996                                  
  3997 00000266 80E201                  	and	DL,1			; Else mask off bit 0 of DL and
  3998 00000269 8614                    	xchg	[SI],DL			; Exchange DL with old status byte
  3999 0000026B EB1E                    	jmp	SHORT scct_9s		; Jump to exit (returning old status)
  4000                                  scct_4:
  4001 0000026D 3C03                    	cmp	al,3 ; 01/01/2024
  4002                                  	;cmp	AX,3 			; Test for 5 after it was dec twice
  4003 0000026F 7506                    	jne	short scct_5		; If not equal then not get boot drv
  4004 00000271 8A16[6900]              	mov	DL,[BOOTDRIVE]		; Else return boot drive in DL
  4005 00000275 EB14                    	jmp	SHORT scct_9s		; Jump to exit (returning boot drive)
  4006                                  scct_5:
  4007                                  	; 01/01/2024 - Retro DOS v5.0
  4008 00000277 7212                    	jb	short scct_9s ; PCDOS 7.1
  4009                                  	;
  4010 00000279 3C04                    	cmp	al,4 ; 01/01/2024
  4011                                  	;cmp	AX,4 			; Test for 6 after it was dec twice
  4012                                  	;jne	short scct_9s		; If not equal then not get version
  4013 0000027B 7512                    	jne	short scct_6 ; 01/01/2024 ; PCDOS 7.1	
  4014                                  
  4015                                  	;mov	BX,(Minor_Version SHL 8) + Major_Version
  4016                                  
  4017                                  	;;mov	bx,1406h ; 6.20	; DOSCODE:4092h (MSDOS 6.21, MSDOS.SYS)
  4018                                  	;;mov	bx,1606h ; 6.22	; DOSCODE:4092h (MSDOS 6.22, MSDOS.SYS)
  4019                                  
  4020                                  	;mov	bx,0A07h ; 7.10	; DOSCODE:4163h (PCDOS 7.1, IMBDOS.COM)
  4021 0000027D BB070A                  	mov	bx,(MINOR_VERSION<<8)+MAJOR_VERSION  ; true dos version
  4022                                  	
  4023                                  	;mov	dl,0			; revision 0
  4024                                  	;mov	DL,DOSREVNM ; 0
  4025                                  
  4026                                  	;xor	dh,dh			; assume vanilla DOS
  4027                                  	; 01/01/2024
  4028 00000280 BA0000                  	mov	dx,0
  4029 00000283 3836[660D]              	cmp	byte [DosHasHMA],dh ; 0
  4030                                  	;cmp	byte [DosHasHMA],0	; is DOS in HMA?  (M021)
  4031                                  	;;je	short @F
  4032                                  	;je	short scct_6
  4033 00000287 7402                    	je	short scct_9s ; 01/01/2024
  4034                                  	; 01/01/2024
  4035 00000289 B610                    	mov	dh,10h			; version flags bit 4
  4036                                  	;or	DH,DOSINHMA ; 10h	; 'DOS in HMA' status
  4037                                  ;@@:
  4038                                  ;scct_6:
  4039                                  ;ifdef ROMDOS
  4040                                  ;	or	DH,DOSINROM ; 08h
  4041                                  ;endif ; ROMDOS
  4042                                  
  4043                                  	; 01/01/2024 (PCDOS 7.1)
  4044                                  	;jmp	short short scct_9s
  4045                                  
  4046                                  	; 01/01/2024
  4047                                  ;scct_6:
  4048                                  	; ....
  4049                                  
  4050                                  scct_9s:
  4051 0000028B 5E                      	pop	SI
  4052 0000028C 58                      	pop	AX
  4053 0000028D 1F                      	pop	DS
  4054                                  scct_9f:
  4055 0000028E CF                      	iret
  4056                                  
  4057                                  	; 01/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  4058                                  scct_6:
  4059 0000028F 8026[8600]DF            	and	byte [DOS_FLAG],0DFh	; clear bit 5 of DOS flag
  4060 00000294 80FA01                  	cmp	dl, 1
  4061 00000297 75F2                    	jne	short scct_9s
  4062 00000299 800E[8600]20            	or	byte [DOS_FLAG],20h	; set bit 5 of DOS flag
  4063 0000029E EBEB                    	jmp	short scct_9s
  4064                                  
  4065                                  SetCtrlShortEntry:			; This allows a conditional entry
  4066                                  					; from main dispatch code
  4067 000002A0 EB9B                    	jmp	SHORT _$SET_CTRL_C_TRAPPING
  4068                                  
  4069                                  ; ==========================================================================
  4070                                  ;
  4071                                  ; The following two routines are dispatched to directly with ints disabled
  4072                                  ; immediately after the int 21h entry.	no DIS state is set.
  4073                                  ;
  4074                                  ; $Set_current_PDB takes BX and sets it to be the current process
  4075                                  ;   *** THIS FUNCTION CALL IS SUBJECT TO CHANGE!!! ***
  4076                                  ;
  4077                                  ; ==========================================================================
  4078                                  
  4079                                  _$SET_CURRENT_PDB:
  4080 000002A2 1E                      	push	DS
  4081                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4082 000002A3 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4083 000002A8 891E[3003]              	mov	[CurrentPDB],BX		; Set new PSP segment from caller's BX
  4084 000002AC 1F                      	pop	DS
  4085 000002AD CF                      	iret
  4086                                  
  4087                                  ; ==========================================================================
  4088                                  ;
  4089                                  ; $get_current_PDB returns in BX the current process
  4090                                  ;   *** THIS FUNCTION CALL IS SUBJECT TO CHANGE!!! ***
  4091                                  ;
  4092                                  ; ==========================================================================
  4093                                  
  4094                                  _$GET_CURRENT_PDB:
  4095 000002AE 1E                      	push	DS
  4096                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4097 000002AF 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4098 000002B4 8B1E[3003]              	mov	BX,[CurrentPDB]		; Return current PSP segment in BX
  4099 000002B8 1F                      	pop	DS
  4100 000002B9 CF                      	iret
  4101                                  
  4102                                  ; ==========================================================================
  4103                                  ;
  4104                                  ; Sets the Printer Flag to whatever is in AL.
  4105                                  ; NOTE: THIS PROCEDURE IS SUBJECT TO CHANGE!!!
  4106                                  ;
  4107                                  ; ==========================================================================
  4108                                  
  4109                                  _$SET_PRINTER_FLAG:
  4110 000002BA 1E                      	push	ds
  4111                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4112 000002BB 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4113 000002C0 A2[A00A]                	mov	[PRINTER_FLAG],AL 	; Set printer flag from caller's AL
  4114 000002C3 1F                      	pop	ds
  4115 000002C4 CF                      	iret
  4116                                  
  4117                                  ; 01/05/2019 - Retro DOS v4.0
  4118                                  ; 08/07/2018 - Retro DOS v3.0
  4119                                  ; (MSDISP.ASM, MSDOS 6.0, 1991)
  4120                                  
  4121                                  ; ----------------------------------------------------------------------------
  4122                                  ; BREAK   <System call entry points and dispatcher>
  4123                                  ; ----------------------------------------------------------------------------
  4124                                  
  4125                                  ; DOSCODE:40CCh (MSDOS 6.21, MSDOS.SYS)
  4126                                  
  4127                                  ; ==========================================================================
  4128                                  ;
  4129                                  ; The Quit entry point is where all INT 20h's come from. These are old- style
  4130                                  ; exit system calls. The CS of the caller indicates which Process is dying.
  4131                                  ; The error code is presumed to be 0. We simulate an ABORT system call.
  4132                                  ;
  4133                                  ; ==========================================================================
  4134                                  
  4135                                  SYSTEM_CALL:    ; PROC NEAR
  4136                                  
  4137                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  4138                                  ; DOSCODE:40BFh (MSDOS 5.0, MSDOS.SYS)
  4139                                  
  4140                                  ;entry	QUIT				
  4141                                  QUIT:				; INT 20H entry point
  4142                                  	;MOV	AH,0
  4143 000002C5 30E4                    	xor	ah,ah ; 08/07/2018
  4144 000002C7 EB36                    	JMP     SHORT SAVREGS
  4145                                  
  4146                                  ; ---------------------------------------------------------------------------
  4147                                  
  4148                                  	; The system call in AH is out of the range that we know how
  4149                                  	; to handle. We arbitrarily set the contents of AL to 0 and
  4150                                  	; IRET. Note that we CANNOT set the carry flag to indicate an
  4151                                  	; error as this may break some programs compatability.
  4152                                  
  4153                                  BADCALL:
  4154                                          ;MOV	AL,0
  4155 000002C9 30C0                    	xor	al,al ; 08/07/2018
  4156                                  IRETT:	; 06/05/2019
  4157                                  _IRET:
  4158 000002CB CF                              IRET
  4159                                  
  4160                                  ; ---------------------------------------------------------------------------
  4161                                  
  4162                                  ; 01/05/2019 - Retro DOS v4.0
  4163                                  ; DOSCODE:40D3h (MSDOS 6.21 MSDOS.SYS)
  4164                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  4165                                  ; DOSCODE:40C6h (MSDOS 5.0 MSDOS.SYS)
  4166                                  
  4167                                  	; An alternative method of entering the system is to perform a
  4168                                  	; CALL 5 in the program segment prefix with the contents of CL
  4169                                  	; indicating what system call the user would like. A subset of
  4170                                  	; the possible system calls is allowed here only the
  4171                                  	; CPM-compatible calls may get dispatched.
  4172                                  
  4173                                  		; System call entry point and dispatcher
  4174                                  CALL_ENTRY:
  4175 000002CC 1E                      	push	DS
  4176                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4177 000002CD 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4178 000002D2 8F06[EC05]              	pop	word [SAVEDS]		; Save original DS
  4179                                  
  4180 000002D6 58                              POP     AX                      ; IP from the long call at 5
  4181 000002D7 58                              POP     AX                      ; Segment from the long call at 5
  4182 000002D8 8F06[8405]              	POP	WORD [USER_SP]		; IP from the CALL 5
  4183                                  
  4184                                  		; Re-order the stack to simulate an interrupt 21.
  4185                                  
  4186 000002DC 9C                      	PUSHF				; Start re-ordering the stack
  4187 000002DD FA                      	CLI
  4188 000002DE 50                              PUSH    AX                      ; Save segment
  4189 000002DF FF36[8405]                      PUSH	WORD [USER_SP]		; Stack now ordered as if INT had been used
  4190                                  	; 04/11/2022
  4191                                  	; DOSCODE:40EAh (MSDOS 6.21 MSDOS.SYS)
  4192                                  	; DOSCODE:40DDh (MSDOS 5.0 MSDOS.SYS)
  4193 000002E3 FF36[EC05]              	push	word [SAVEDS]
  4194 000002E7 1F                      	pop	ds
  4195                                  	;
  4196                                  	;cmp	cl,36
  4197 000002E8 80F924                          CMP     CL,MAXCALL              ; This entry point doesn't get as many calls
  4198 000002EB 77DC                            JA      SHORT BADCALL
  4199 000002ED 88CC                            MOV     AH,CL
  4200                                  	; 08/07/2018
  4201 000002EF EB0E                    	jmp	short SAVREGS
  4202                                  
  4203                                  ; ---------------------------------------------------------------------------
  4204                                  
  4205                                  ; 01/05/2019 - Retro DOS v4.0
  4206                                  ; 01/01/2024 - Retro DOS v5.0
  4207                                  
  4208                                  	; This is the normal INT 21 entry point. We first perform a
  4209                                  	; quick test to see if we need to perform expensive DOS-entry
  4210                                  	; functions. Certain system calls are done without interrupts
  4211                                  	; being enabled.
  4212                                  
  4213                                  	;entry	COMMAND 		; Interrupt call entry point (int 21h)
  4214                                  
  4215                                  ; DOSCODE:40F8h (MSDOS 6.21, MSDOS.SYS)
  4216                                  ; 04/11/2022
  4217                                  ; DOSCODE:40EBh (MSDOS 5.0, MSDOS.SYS)
  4218                                  ; 01/01/2024
  4219                                  ; DOSCODE:41D7h (PCDOS 7.1, IBMDOS.COM)
  4220                                  
  4221                                  COMMAND:
  4222                                  	; 22/12/2022
  4223 000002F1 FA                      	cli
  4224                                  
  4225                                  	; 01/05/2019 - Retro DOS v4.0
  4226                                  	; 08/07/2018 - Retro DOS v3.0
  4227                                  
  4228                                  ; 22/12/2022
  4229                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  4230                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  4231                                  
  4232                                  	;IF	NOT IBM
  4233 000002F2 80FCF8                  	CMP	AH,SET_OEM_HANDLER
  4234 000002F5 7203                    	JB	SHORT NOTOEM
  4235 000002F7 E98701                  	JMP	_$SET_OEM_HANDLER
  4236                                  
  4237                                  NOTOEM:
  4238                                  	;ENDIF
  4239                                  
  4240                                  ; DOSCODE:40F8h (MSDOS 6.21, MSDOS.SYS)
  4241                                  ; DOSCODE:40EBh (MSDOS 5.0, MSDOS.SYS)
  4242                                  ; 01/01/2024 - Retro DOS v5.0
  4243                                  ; DOSCODE:41D7h (PCDOS 7.1, IBMDOS.COM)
  4244                                  
  4245                                  	; 22/12/2022
  4246                                  	;cli	; 08/07/2018
  4247                                  	
  4248                                  	; 01/01/2024
  4249                                  _COMMAND: ; MSDOS 3.3 (IBMDOS)
  4250                                  	;;cmp	ah,6Ch  ; MSDOS 6.21
  4251                                  	;cmp	ah,73h	; PCDOS 7.1 ; Max int 21h function call number 
  4252                                  	; 04/11/2022
  4253 000002FA 80FC73                  	CMP     AH,MAXCOM ; 6Ch for MSDOS 6.0 (6.21,6.22) & MSDOS 5.0
  4254                                  			; 73h for PCDOS 7.1
  4255                                  	;JBE	SHORT SAVREGS
  4256 000002FD 77CA                            JA	SHORT BADCALL ; 08/07/2018
  4257                                  
  4258                                  	; 31/05/2019
  4259                                  
  4260                                  	; The following set of calls are issued by the server at
  4261                                  	; *arbitrary* times and, therefore, must be executed on
  4262                                  	; the user's entry stack and executed with interrupts off.
  4263                                  
  4264                                  SAVREGS:
  4265                                  	; 01/05/2019 - Retro DOS v4.0
  4266                                  	; 10/08/2018
  4267                                  	; 08/07/2018 - Retro DOS v3.0
  4268 000002FF 80FC33                  	cmp	ah,33h			; Check Minimum special case #
  4269                                  	;;je	_$SET_CTRL_C_TRAPPING
  4270                                  	;je	short SetCtrlShortEntry ; If equal jmp directly to function
  4271 00000302 7218                    	jb	short SaveAllRegs	; Not special case so continue	
  4272                                  	; 04/11/2022
  4273 00000304 749A                    	je	short SetCtrlShortEntry ; If equal jmp directly to function
  4274 00000306 80FC64                  	cmp	ah,64h			; Check Max case number
  4275 00000309 7711                    	ja	short SaveAllRegs	; Not special case so continue
  4276 0000030B 74AD                    	je	short _$SET_PRINTER_FLAG ; If equal jmp directly to function
  4277 0000030D 80FC51                  	cmp	ah,51h			; Is this a Get PSP call (51h)?
  4278 00000310 749C                    	je	short _$GET_CURRENT_PDB	; Yes, jmp directly to function
  4279                                  	; 25/06/2024
  4280 00000312 80FC50                  	cmp     ah,50h			; Is this a Set PSP call (50h) ?
  4281 00000315 748B                    	je	short _$SET_CURRENT_PDB	; Yes, jmp directly to function
  4282 00000317 80FC62                  	cmp	ah,62h			; Is this a Get PSP call (62h)?
  4283 0000031A 7492                    	je	short _$GET_CURRENT_PDB	; Yes, jmp directly to function
  4284                                  
  4285                                  SaveAllRegs:
  4286                                  	; 01/05/2019 - Retro DOS v4.0
  4287                                  	; 01/01/2024 - Retro DOS v5.0
  4288                                  
  4289 0000031C 06                              push	ES
  4290 0000031D 1E                      	push	DS
  4291 0000031E 55                      	push	BP
  4292 0000031F 57                      	push	DI
  4293 00000320 56                      	push	SI
  4294 00000321 52                      	push	DX
  4295 00000322 51                      	push	CX
  4296 00000323 53                      	push	BX
  4297 00000324 50                      	push	AX
  4298                                  
  4299 00000325 8CD8                    	mov	AX,DS
  4300                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4301 00000327 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4302 0000032C A3[EC05]                	mov	[SAVEDS],AX		; save caller's DS
  4303 0000032F 891E[EA05]              	mov	[SAVEBX],BX
  4304                                  
  4305                                          ;INC     BYTE [INDOS]		; Flag that we're in the DOS
  4306                                  	
  4307                                  	; 08/07/2018 - Retro DOS v3.0
  4308                                  	;xor     ax,ax
  4309                                  	;mov     [USER_ID],ax
  4310                                  	;mov     ax,[CurrentPDB]
  4311                                  	;mov     [PROC_ID],ax
  4312                                  
  4313                                  	; 01/05/2019
  4314                                  
  4315                                  	; Note: Nsp and Nss have to be unconditionally initialized here 
  4316                                  	; even if InDOS is zero. Programs like CROSSTALK 3.7 depend on
  4317                                  	; this!!!
  4318                                  
  4319 00000333 A1[8405]                	MOV     AX,[USER_SP]
  4320 00000336 A3[F205]                        MOV     [NSP],AX
  4321 00000339 A1[8605]                        MOV     AX,[USER_SS]
  4322 0000033C A3[F005]                        MOV     [NSS],AX
  4323                                  
  4324 0000033F 31C0                    	xor	AX,AX ; 0
  4325 00000341 A2[7205]                	mov	[FSHARING],AL		; allow redirection
  4326                                  
  4327 00000344 F606[470F]01            	test	byte [IsWin386],1	; WIN386 patch. Do not update USER_ID
  4328 00000349 7503                    	jnz	short set_indos_flag	; if win386 present
  4329 0000034B A3[3E03]                	mov	[USER_ID],AX
  4330                                  set_indos_flag:
  4331 0000034E FE06[2103]              	INC     BYTE [INDOS]		; Flag that we're in the DOS
  4332                                  
  4333                                  	; 01/01/2024 (PCDOS 7.1 IBMDOS.COM)
  4334 00000352 FE06[C411]              	inc	byte [INDOS_FLAG]	; duplicated INDOS flag (what for ?)
  4335                                  
  4336 00000356 8926[8405]                      MOV     [USER_SP],SP
  4337 0000035A 8C16[8605]                      MOV     [USER_SS],SS
  4338                                  
  4339 0000035E A1[3003]                	mov	AX,[CurrentPDB]
  4340 00000361 A3[3C03]                	mov	[PROC_ID],AX
  4341 00000364 8ED8                    	mov	DS,AX
  4342 00000366 58                      	pop	AX
  4343 00000367 50                      	push	AX
  4344                                  
  4345                                  	; save user stack in his area for later returns (possibly from EXEC)
  4346                                  
  4347 00000368 89262E00                        MOV     [PDB.USER_STACK],SP	; mov [2Eh], sp
  4348 0000036C 8C163000                        MOV     [PDB.USER_STACK+2],SS	; mov [30h], ss
  4349                                  
  4350                                  	; 18/07/2018
  4351                                  	;mov	byte [CS:FSHARING], 0
  4352                                  
  4353                                  	;MOV     BX,CS			; no holes here.
  4354                                  	;MOV     SS,BX
  4355                                  
  4356                                  	;getdseg <ss>			; ss -> dosdat, already flag is CLI
  4357 00000370 2E8E16[0700]            	mov	ss,[cs:DosDSeg]
  4358                                  					;entry	REDISP
  4359                                  REDISP:
  4360 00000375 BC[A007]                        MOV     SP,AUXSTACK		; Enough stack for interrupts
  4361 00000378 FB                              STI                             ; stack is in our space now...
  4362                                  
  4363 00000379 8CD3                    	mov	bx,ss
  4364 0000037B 8EDB                    	mov	ds,bx
  4365                                  
  4366 0000037D 93                      	xchg	ax,bx
  4367                                  
  4368 0000037E 31C0                    	xor	ax,ax ; 0
  4369                                  
  4370                                  	; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  4371                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:416Eh  (from org 3DD0h)
  4372                                  	; MSDOS 6.21 MSDOS.SYS - DOSCODE:417Bh (from org 3DE0h)
  4373                                  
  4374                                  	; (Note: ss: segment prefix was not needed here! ds=ss ! -04/11/2022-)
  4375                                  
  4376                                  	;mov	[ss:EXTOPEN_ON],al ; 0	; Clear extended open flag
  4377                                  	;;and	word [ss:DOS34_FLAG],EXEC_AWARE_REDIR
  4378                                  	;and	word [ss:DOS34_FLAG],800h ; clear all bits except bit 11
  4379                                  	;mov	[ss:CONSWAP],al  ; 0	; random clean up of possibly mis-set flags
  4380                                  	;mov	[ss:NoSetDir],al ; 0	; set directories on search
  4381                                  	;mov	[ss:FAILERR],al ; 0	; FAIL not in progress
  4382                                  	;inc	ax
  4383                                  	;;inc	AL			; AL = 1
  4384                                  	;mov	[ss:IDLEINT],al		; presume that we can issue INT 28h
  4385                                  
  4386                                  	; 15/12/2022
  4387 00000380 A2[F605]                	mov	[EXTOPEN_ON],al ; 0	; Clear extended open flag
  4388                                  	;and	word [DOS34_FLAG],EXEC_AWARE_REDIR
  4389 00000383 8126[1106]0008          	and	word [DOS34_FLAG],800h	; clear all bits except bit 11
  4390 00000389 A2[5703]                	mov	[CONSWAP],al  ; 0	; random clean up of possibly mis-set flags
  4391                                  	;mov	byte [IDLEINT],1
  4392 0000038C A2[4C03]                	mov	[NoSetDir],al ; 0	; set directories on search
  4393 0000038F A2[4A03]                	mov	[FAILERR],al ; 0	; FAIL not in progress
  4394 00000392 40                      	inc	ax
  4395                                  	;inc	al			; AL = 1
  4396 00000393 A2[5803]                	mov	[IDLEINT],al		; presume that we can issue INT 28h
  4397                                  
  4398 00000396 93                      	XCHG	AX,BX			; Restore AX and BX = 1
  4399                                  
  4400 00000397 88E3                    	MOV     BL,AH
  4401 00000399 D1E3                            SHL     BX,1			; 2 bytes per call in table
  4402                                         
  4403 0000039B FC                      	CLD
  4404                                  		; Since the DOS maintains mucho state information across system
  4405                                  		; calls, we must be very careful about which stack we use.
  4406                                  		; First, all abort operations must be on the disk stack. This
  4407                                  		; is due to the fact that we may be hitting the disk (close
  4408                                  		; operations, flushing) and may need to report an INT 24.
  4409                                          
  4410 0000039C 08E4                    	OR      AH,AH
  4411 0000039E 7416                            JZ      SHORT DSKROUT		; ABORT
  4412                                  
  4413                                          ;CMP	AH,12
  4414                                          ;JBE	SHORT IOROUT		; Character I/O
  4415                                          ;CMP	AH,GET_CURRENT_PDB      ; INT 24h needs GET,SET PDB
  4416                                          ;JZ	SHORT IOROUT
  4417                                          ;CMP	AH,SET_CURRENT_PDB
  4418                                          ;JNZ	SHORT DSKROUT
  4419                                  
  4420                                  		; Second, PRINT and PSPRINT and the server issue
  4421                                  		; GetExtendedError calls at INT 28 and INT 24 time.
  4422                                  		; This call MUST, therefore, use the AUXSTACK.
  4423                                  
  4424                                  	; 10/08/2018
  4425 000003A0 80FC59                  	cmp     ah,GETEXTENDEDERROR ; 59h
  4426 000003A3 7439                    	je      short DISPCALL
  4427                                  	
  4428                                  	; 01/05/2019
  4429                                  	
  4430                                  		; Old 1-12 system calls may be either on the IOSTACK (normal
  4431                                  		; operation) or on the AUXSTACK (at INT 24 time).
  4432                                  
  4433 000003A5 80FC0C                  	cmp     ah,12 ; STD_CON_INPUT_FLUSH ; 0Ch
  4434 000003A8 770C                    	ja      short DSKROUT
  4435                                  
  4436                                  IOROUT:
  4437                                  	; 04/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  4438                                  	; (ss: prefix was not needed here! ds=ss)
  4439                                  	;cmp	byte [ss:ERRORMODE],0	; Are we in an INT 24h? 
  4440                                  	; 15/12/2022
  4441 000003AA 803E[2003]00            	cmp     BYTE [ERRORMODE],0	; Are we in an INT 24h?
  4442 000003AF 752D                            JNZ     SHORT DISPCALL		; Stay on AUXSTACK if INT 24h
  4443 000003B1 BC[A00A]                        MOV     SP,IOSTACK
  4444 000003B4 EB28                            JMP     SHORT DISPCALL
  4445                                  
  4446                                  		; We are on a system call that is classified as "the rest".
  4447                                  		; We place ourselves onto the DSKSTACK and away we go.
  4448                                  		; We know at this point:
  4449                                  		; *  An INT 24 cannot be in progress. Therefore we reset
  4450                                  		;    ErrorMode and WpErr
  4451                                  		; *  That there can be no critical sections in effect.
  4452                                  		;    We signal the server to remove all the resources.
  4453                                  
  4454                                  DSKROUT:
  4455                                  	; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  4456                                  	; 15/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  4457                                  	; 08/07/2018 - Retro DOS v3.0
  4458 000003B6 A3[3A03]                	mov     [USER_IN_AX],ax		; Remember what user is doing
  4459                                  	; 01/01/2024
  4460                                  	;mov	byte [EXTERR_LOCUS],1	; errLOC_Unk (Default)
  4461                                  	;MOV	BYTE [WPERR],-1		; error mode, so good place to
  4462                                  	                   		; make sure flags are reset
  4463 000003B9 C706[2203]FF01          	mov	word [WPERR],1FFh
  4464                                  
  4465 000003BF C606[2003]00            	MOV     BYTE [ERRORMODE],0	; Cannot make non 1-12 calls in
  4466                                  
  4467                                  
  4468                                  	; 04/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  4469                                  	; (ss: prefix was not needed here! ds=ss)
  4470                                  
  4471                                  	;mov	[ss:USER_IN_AX],ax	; Remember what user is doing
  4472                                  	;mov	byte [ss:EXTERR_LOCUS],1 ; errLOC_Unk (Default)
  4473                                  	;mov	byte [ss:ERRORMODE],0	; Cannot make non 1-12 calls in
  4474                                  	;mov	byte [ss:WPERR],-1	; error mode, so good place to
  4475                                                                          ; make sure flags are reset
  4476 000003C4 50                      	push    ax
  4477 000003C5 B482                    	mov     ah,82h			; Release all resource information
  4478 000003C7 CD2A                    	int     2Ah 		; Microsoft Networks 
  4479                                  				; END DOS CRITICAL SECTIONS 0 THROUGH 7
  4480 000003C9 58                      	pop     ax
  4481                                  
  4482                                  		; Since we are going to be running on the DSKStack and since
  4483                                  		; INT 28 people will use the DSKStack, we must turn OFF the
  4484                                  		; generation of INT 28's.
  4485                                  
  4486                                  	; 15/12/2022
  4487                                  	;mov     byte [ss:IDLEINT],0
  4488                                  	;
  4489                                          ;mov	sp,DSKSTACK
  4490                                  	;test	byte [ss:CNTCFLAG],-1  ; 0FFh
  4491                                          ;jz	short DISPCALL
  4492                                  
  4493 000003CA C606[5803]00            	mov     byte [IDLEINT],0
  4494                                  
  4495 000003CF BC[2009]                	MOV     SP,DSKSTACK
  4496 000003D2 F606[3703]FF            	TEST    BYTE [CNTCFLAG],-1
  4497 000003D7 7405                    	JZ      SHORT DISPCALL
  4498                                  
  4499 000003D9 50                              PUSH    AX
  4500                                          ;invoke	DSKSTATCHK
  4501 000003DA E8CC56                          CALL	DSKSTATCHK
  4502 000003DD 58                      	POP     AX
  4503                                  DISPCALL:
  4504                                  	; 01/05/2019 - Retro DOS v4.0
  4505 000003DE 2E8B9F[EC00]            	mov	bx,[CS:BX+DISPATCH]
  4506                                  
  4507                                  	; 15/12/2022
  4508 000003E3 871E[EA05]              	xchg	bx,[SAVEBX]
  4509 000003E7 8E1E[EC05]              	MOV	DS,[SAVEDS]
  4510                                  
  4511                                  	; 04/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  4512                                  	; (ss: prefix was not needed here! ds=ss)
  4513                                  	;xchg	bx,[ss:SAVEBX]
  4514                                  	;mov	ds,[ss:SAVEDS]
  4515                                  
  4516 000003EB 36FF16[EA05]            	call	word [SS:SAVEBX] ; near call
  4517                                  
  4518                                  	; The EXEXA20OFF bit of DOS_FLAG will now be unconditionally cleared
  4519                                  	; here. Please see under M003, M009 and M068 tags in dossym.inc
  4520                                  	; for explanation. Also NOTE that a call to ExecReady (ax=4b05) will
  4521                                  	; return to LeaveDos and hence will not clear this bit. This is
  4522                                  	; because this bit is used to indicate to the next int 21 call that
  4523                                  	; the previous int 21 was an exec.
  4524                                  	;
  4525                                  	; So do not add any code between the call above and the label
  4526                                  	; LeaveDOS if it needs to be executed even for ax=4b05
  4527                                  
  4528                                  	;;and	byte [ss:DOS_FLAG],~EXECA20OFF
  4529                                  	;and	byte [ss:DOS_FLAG],0FBh ; clear bit 2
  4530                                  
  4531                                  	; 01/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  4532 000003F0 368026[8600]DB          	and	byte [ss:DOS_FLAG],0DBh ; clear bit 2 and bit 5
  4533                                  
  4534                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  4535                                  ; DOSCODE:41F7h
  4536                                  
  4537                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  4538                                  ; DOSCODE:42D4h
  4539                                  
  4540                                  ;entry LEAVE
  4541                                  ;;;_LEAVE:				; Exit from a system call
  4542                                  LeaveDOS: ; 18/07/2018
  4543                                  ;ASSUME	SS:NOTHING			; User routines may misbehave
  4544 000003F6 FA                      	CLI
  4545                                  
  4546                                  	; 01/05/2019
  4547                                  	;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4548 000003F7 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4549 000003FC 803E[8500]00            	cmp	byte [A20OFF_COUNT],0	; M068: Q: is count 0
  4550 00000401 752A                    	jne	short disa20		; M068: N: dec count and turn a20 off
  4551                                  
  4552                                  LeaveA20On:
  4553 00000403 FE0E[2103]                      DEC     BYTE [INDOS]
  4554                                  	
  4555                                  	; 01/01/2024 (PCDOS 7.1 IBMDOS.COM)
  4556 00000407 FE0E[C411]              	dec	byte [INDOS_FLAG]	; duplicated INDOS flag (what for ?)
  4557                                  
  4558                                          ; 04/11/2022
  4559 0000040B 8E16[8605]              	mov	ss,[USER_SS]
  4560 0000040F 8B26[8405]              	MOV     SP,[USER_SP]
  4561                                  	;MOV	SS,[USER_SS]
  4562 00000413 89E5                    	MOV     BP,SP
  4563                                  	;MOV	[BP.user_AX],AL	
  4564                                          ; 04/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  4565                                  	;;mov	[bp+0],al ; MSDOS 5.0 MSDOS.SYS - DOSCODE:4212h	
  4566                                  	;MOV	[BP+user_env.user_AX],AL  ; user_env.user_AX = 0
  4567                                  	
  4568                                  	; 15/12/2022
  4569 00000415 884600                  	MOV	[BP],AL	; mov [bp+0],al
  4570                                  	
  4571                                  	;MOV	AX,[NSP]
  4572                                          ;MOV	[USER_SP],AX
  4573                                          ;MOV	AX,[NSS]
  4574                                          ;MOV	[USER_SS],AX
  4575                                  	; 01/01/2024
  4576 00000418 C406[F005]              	les	ax,[NSS]
  4577 0000041C A3[8605]                	mov	[USER_SS],ax
  4578 0000041F 8C06[8405]              	mov	[USER_SP],es
  4579                                  
  4580 00000423 58                      	pop	AX
  4581 00000424 5B                      	pop	BX
  4582 00000425 59                      	pop	CX
  4583 00000426 5A                      	pop	DX
  4584 00000427 5E                      	pop	SI
  4585 00000428 5F                      	pop	DI
  4586 00000429 5D                      	pop	BP
  4587 0000042A 1F                      	pop	DS
  4588 0000042B 07                      	pop	ES
  4589                                  
  4590 0000042C CF                              IRET
  4591                                  
  4592                                  disa20:	   				; M068 - Start
  4593 0000042D 8B1E[6300]              	mov	bx,[A20OFF_PSP]		; bx = PSP for which a20 to be off'd
  4594 00000431 3B1E[3003]              	cmp	bx,[CurrentPDB]		; Q: do the PSP's match
  4595 00000435 75CC                    	jne	short LeaveA20On	; N: don't clear bit and don't turn 
  4596                                  					;    a20 off
  4597                                  					; Y: turn a20 off and dec a20off_count
  4598 00000437 FE0E[8500]              	dec	byte [A20OFF_COUNT]	; M068 - End
  4599                                   					; Start - M004
  4600 0000043B 1E                      	push	ds			; segment of stub
  4601 0000043C BB[1610]                	mov	bx,disa20_iret		; offset in stub
  4602 0000043F 53                      	push	bx
  4603 00000440 CB                      	retf	  			; go to stub
  4604                                  					; End - M004
  4605                                  ;SYSTEM_CALL ENDP
  4606                                  
  4607                                  ; DOSCODE:424Ch (MSDOS 6.21, MSDOS.SYS)
  4608                                  ; 04/11/2022
  4609                                  ; DOSCODE:423Fh (MSDOS 5.0, MSDOS.SYS)
  4610                                  
  4611                                  ; ==========================================================================
  4612                                  ;
  4613                                  ; Restore_World restores all registers ('cept SS:SP, CS:IP, flags) from
  4614                                  ; the stack prior to giving the user control
  4615                                  ;
  4616                                  ; ==========================================================================
  4617                                  
  4618                                  ; 01/05/2019 - Retro DOS v4.0
  4619                                  
  4620                                          ;procedure restore_world,NEAR
  4621                                  restore_world:
  4622                                  	;getdseg <es>		; es -> dosdata
  4623 00000441 2E8E06[0700]            	mov	es,[cs:DosDSeg]
  4624                                  
  4625 00000446 268F06[EE05]                    POP	WORD [ES:RESTORE_TMP]
  4626                                  
  4627 0000044B 58                              POP     AX
  4628 0000044C 5B                              POP     BX
  4629 0000044D 59                              POP     CX
  4630 0000044E 5A                              POP     DX
  4631 0000044F 5E                              POP     SI
  4632 00000450 5F                              POP     DI
  4633 00000451 5D                              POP     BP
  4634 00000452 1F                              POP     DS
  4635                                  
  4636 00000453 26FF26[EE05]                   	jmp	word [ES:RESTORE_TMP]
  4637                                  
  4638                                  ;restore_world	ENDP
  4639                                  
  4640                                  ; 01/05/2019 - Retro DOS v4.0 (MSDOS 6.0, MSDISP.ASM, 1991)
  4641                                  
  4642                                  ; DOSCODE:4263h (MSDOS 6.21, MSDOS.SYS)
  4643                                  ; 04/11/2022
  4644                                  ; DOSCODE:4256h (MSDOS 5.0, MSDOS.SYS)
  4645                                  
  4646                                  ; ==========================================================================
  4647                                  ;
  4648                                  ; Save_World saves complete registers on the stack
  4649                                  ;
  4650                                  ; ==========================================================================
  4651                                  
  4652                                          ;procedure save_world,NEAR
  4653                                  save_world:
  4654                                  	;getdseg <es>		; es -> dosdata
  4655 00000458 2E8E06[0700]            	mov	es,[cs:DosDSeg]
  4656                                  
  4657 0000045D 268F06[EE05]                    POP	WORD [ES:RESTORE_TMP]
  4658                                  
  4659                                  	; 12/05/2019
  4660                                          
  4661 00000462 1E                      	PUSH    DS
  4662 00000463 55                              PUSH    BP
  4663 00000464 57                              PUSH    DI
  4664 00000465 56                              PUSH    SI
  4665 00000466 52                              PUSH    DX
  4666 00000467 51                              PUSH    CX
  4667 00000468 53                              PUSH    BX
  4668 00000469 50                              PUSH    AX
  4669                                  
  4670 0000046A 26FF36[EE05]            	push	word [ES:RESTORE_TMP]
  4671                                  
  4672 0000046F 55                      	push	BP
  4673 00000470 89E5                    	mov	BP,SP
  4674 00000472 8E4614                  	mov	ES,[BP+20]	; es was pushed before call
  4675 00000475 5D                      	pop	BP
  4676                                  	
  4677 00000476 C3                      	retn
  4678                                  
  4679                                  ;save_world	ENDP
  4680                                  
  4681                                  ; 01/05/2019
  4682                                  
  4683                                  ; DOSCODE:4282h (MSDOS 6.21, MSDOS.SYS)
  4684                                  ; 04/11/2022
  4685                                  ; DOSCODE:4275h (MSDOS 5.0, MSDOS.SYS)
  4686                                  
  4687                                  ; ==========================================================================
  4688                                  ;
  4689                                  ; Get_User_Stack returns the user's stack (and hence registers) in DS:SI
  4690                                  ;
  4691                                  ; ==========================================================================
  4692                                  
  4693                                          ;procedure get_user_stack,NEAR
  4694                                  Get_User_Stack:
  4695                                          ;getdseg <DS>			; DS -> DosData, ASSUME DS:DosSeg
  4696 00000477 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  4697 0000047C C536[8405]                      lds	si,[USER_SP]
  4698 00000480 C3                      	retn
  4699                                  
  4700                                  ;get_user_stack  ENDP
  4701                                  
  4702                                  ; 22/12/2022
  4703                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0, MSDOS.SYS)
  4704                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1, IBMDOS.COM)
  4705                                  ;%if 0
  4706                                  
  4707                                  ; ---------------------------------------------------------------------------
  4708                                  ;
  4709                                  ; Set_OEM_Handler -- Set OEM sys call address and handle OEM Calls
  4710                                  ; Inputs:
  4711                                  ;	User registers, User Stack, INTS disabled
  4712                                  ;	If CALL F8, DS:DX is new handler address
  4713                                  ; Function:
  4714                                  ;	Process OEM INT 21 extensions
  4715                                  ; Outputs:
  4716                                  ;	Jumps to OEM_HANDLER if appropriate
  4717                                  ;
  4718                                  ; ---------------------------------------------------------------------------
  4719                                  
  4720                                  ;IF	NOT IBM
  4721                                  
  4722                                  _$SET_OEM_HANDLER:
  4723                                  	; 01/05/2019 - Retro DOS v4.0
  4724                                  	
  4725                                  	;(cmp	ah,SET OEM HANDLER  ; 0F8h)
  4726                                  	;(jb	short NOTOOEM)
  4727                                  
  4728 00000481 06                      	push	es ; *
  4729                                  	;getdseg <es>			; es -> dosdata
  4730 00000482 2E8E06[0700]            	mov	es,[cs:DosDSeg]
  4731                                  
  4732 00000487 750C                    	jne	short check_trueversion_request ; check Retro DOS true version
  4733                                  						; (message) request
  4734                                  	; AH = 0F8h = SET OEM HANDLER
  4735                                  
  4736 00000489 268916[1400]            	MOV     [es:OEM_HANDLER],DX	; Set Handler
  4737 0000048E 268C1E[1600]            	MOV     [es:OEM_HANDLER+2],DS
  4738                                  
  4739 00000493 07                      	pop	es ; *
  4740                                  
  4741 00000494 CF                      	IRET                            ; Quick return, Have altered no registers
  4742                                  
  4743                                  check_trueversion_request:
  4744                                  	; 18/07/2019 - Retro DOS v3.0
  4745                                  
  4746                                  	; Retro DOS v2.0 - 20/04/2018
  4747 00000495 83F8FF                  	CMP	AX,0FFFFh
  4748                                  	; 18/07/2018
  4749 00000498 7520                    	jne	short DO_OEM_FUNC ; 01/05/2019
  4750                                  
  4751                                  	; 01/05/2019
  4752 0000049A 07                      	pop	es ; *
  4753                                  
  4754 0000049B B40E                    	mov	ah,0Eh
  4755                                  
  4756                                  	; Retro DOS v4.0 feature only!
  4757 0000049D 81FBA101                	cmp	bx,417  ; Signature to bypass
  4758                                  			; Retro DOS true version message
  4759 000004A1 7414                    	je	short true_version_iret
  4760                                  
  4761 000004A3 56                      	push	si
  4762 000004A4 53                      	push	bx
  4763                                  
  4764 000004A5 BE[C200]                	mov	si,RETRODOSMSG
  4765                                  wrdosmsg:
  4766                                  	;movb	ah,0Eh
  4767 000004A8 BB0700                  	mov	bx,7
  4768                                  wrdosmsg_nxt:
  4769 000004AB 2EAC                    	cs	lodsb
  4770 000004AD 3C24                    	cmp	al,'$'
  4771 000004AF 7404                    	je	short wrdosmsg_ok
  4772 000004B1 CD10                    	int	10h
  4773 000004B3 EBF6                    	jmp	short wrdosmsg_nxt
  4774                                  
  4775                                  wrdosmsg_ok:
  4776 000004B5 5B                      	pop	bx
  4777 000004B6 5E                      	pop	si
  4778                                  
  4779                                  true_version_iret:
  4780                                  	; ah = 0Eh
  4781                                  	;mov	al,40h ; Retro DOS v4.0
  4782                                  	; 
  4783                                  	;mov	al,41h ; Retro DOS v4.1 
  4784                                  	; 30/12/2022
  4785                                  	;mov	al,42h ; Retro DOS v4.2
  4786                                  	; 01/01/2024
  4787 000004B7 B050                    	mov	al,50h ; Retro DOS v5.0	
  4788 000004B9 CF                      	iret
  4789                                  
  4790                                  	; If above F8 try to jump to handler
  4791                                  
  4792                                  DO_OEM_FUNC:
  4793                                  	; 01/05/2019
  4794 000004BA 26833E[1400]FF          	cmp     word [es:OEM_HANDLER],-1
  4795 000004C0 7504                    	JNE     short OEM_JMP
  4796 000004C2 07                      	pop	es ; *
  4797 000004C3 E903FE                  	JMP     BADCALL                 ; Handler not initialized
  4798                                  OEM_JMP:
  4799 000004C6 06                      	push	es
  4800 000004C7 1F                      	pop	ds ; DOSDATA segment !
  4801 000004C8 07                      	pop	es ; *
  4802                                  
  4803                                  	; 22/12/2022
  4804 000004C9 FB                      	sti	; (enable interrupts before jumping to private handler)  
  4805                                  
  4806 000004CA FF2E[1400]              	JMP     FAR [OEM_HANDLER]
  4807                                  
  4808                                  ;       ENDIF
  4809                                  
  4810                                  ; ---------------------------------------------------------------------------
  4811                                  
  4812                                  ;%endif
  4813                                  
  4814                                  ;============================================================================
  4815                                  ; MCODE.ASM, MSDOS 6.0, 1991
  4816                                  ;============================================================================
  4817                                  ; 17/07/2018 - Retro DOS v3.0
  4818                                  
  4819                                  ;	TITLE	MISC DOS ROUTINES - Int 25 and 26 handlers and other
  4820                                  ;	NAME	IBMCODE
  4821                                  
  4822                                  ;BREAK <NullDev -- Driver for null device>
  4823                                  
  4824                                  ; ROMDOS note:
  4825                                  ;	NUL device driver used to be here, but it was removed and placed in
  4826                                  ;	DOSDATA, because the entry points have to be in the segment as the
  4827                                  ;	header, which is also in DOSDATA.
  4828                                  
  4829                                  ;BREAK <AbsDRD, AbsDWRT -- INT int_disk_read, int_disk_write handlers>
  4830                                  
  4831                                  ;----------------------------------------------------------------------------
  4832                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0, MSDOS.SYS)
  4833                                  ;----------------------------------------------------------------------------
  4834                                  ; DOSCODE:428Ch (MSDOS 6.21 MSDOS.SYS)
  4835                                  ; DOSCODE:427Fh (MSDOS 5.0 MSDOS.SYS)
  4836                                  
  4837                                  ; 01/01/2024 - Retro DOS v5.0
  4838                                  ; DOSCODE:435Fh (PCDOS 7.1 IBMDOS.COM)
  4839                                  
  4840                                  ;Public MSC001S,MSC001E
  4841                                  ;MSC001S label byte
  4842                                  	;IF	IBM
  4843                                  ; Codes returned by BIOS
  4844                                  ERRIN:
  4845 000004CE 02                      	DB	2			; NO RESPONSE
  4846 000004CF 06                      	DB	6			; SEEK FAILURE
  4847 000004D0 0C                      	DB	12			; GENERAL ERROR
  4848 000004D1 04                      	DB	4			; BAD CRC
  4849 000004D2 08                      	DB	8			; SECTOR NOT FOUND
  4850 000004D3 00                      	DB	0			; WRITE ATTEMPT ON WRITE-PROTECT DISK
  4851                                  ERROUT:
  4852                                  ; DISK ERRORS RETURNED FROM INT 25 and 26
  4853 000004D4 80                      	DB	80H			; NO RESPONSE
  4854 000004D5 40                      	DB	40H			; Seek failure
  4855 000004D6 02                      	DB	2			; Address Mark not found
  4856 000004D7 10                      	DB	10H			; BAD CRC
  4857 000004D8 04                      	DB	4			; SECTOR NOT FOUND
  4858 000004D9 03                      	DB	3			; WRITE ATTEMPT TO WRITE-PROTECT DISK
  4859                                  
  4860                                  NUMERR	EQU	$-ERROUT
  4861                                  	;ENDIF
  4862                                  ;MSC001E label byte
  4863                                  ;----------------------------------------------------------------------------
  4864                                  
  4865                                  ;============================================================================
  4866                                  ; MSCODE.ASM - MSDOS 6.0 - 1991
  4867                                  ;============================================================================
  4868                                  ; 18/07/2018 - Retro DOS v3.0
  4869                                  ; 15/05/2019 - Retro DOS v4.0
  4870                                  
  4871                                  ; 02/01/2024 - Retro DOS v5.0
  4872                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:436Bh
  4873                                  
  4874                                  ;BREAK <AbsDRD, AbsDWRT -- INT int_disk_read, int_disk_write handlers>>
  4875                                  
  4876                                  ;   AbsSetup - setup for abs disk functions
  4877                                  ;----------------------------------------------------------------------------
  4878                                  
  4879                                  AbsSetup:
  4880                                  	; 02/01/2024 (PCDOS 7.1, Retro DOS 5.0)
  4881                                  	;;;
  4882                                  	;
  4883 000004DA 1E                      	push	ds ; *
  4884 000004DB 16                      	push	ss
  4885 000004DC 1F                      	pop	ds
  4886                                  	;
  4887 000004DD 8826[DB0A]              	mov	[absdrw_extd],ah
  4888                                  	;mov	[ss:absdrw_extd],ah	; Extended ABS Disk Read/Write flag
  4889                                  					; (AH=1 for INT 21h ax=7305h function)
  4890 000004E1 08E4                    	or	ah,ah
  4891 000004E3 7508                    	jnz	short AbsSetup1		; INT 21h AX=7305h
  4892                                  
  4893                                  	; INT 25h
  4894 000004E5 FE06[C411]              	inc	byte [INDOS_FLAG]
  4895                                  	;inc	byte [ss:INDOS_FLAG]	; Windows DOSBOX's INDOS flag ?
  4896                                  	;;;
  4897 000004E9 FE06[2103]              	inc	byte [INDOS]
  4898                                  	;INC	byte [SS:INDOS]		; SS override
  4899                                  AbsSetup1:
  4900 000004ED FB                      	STI
  4901 000004EE FC                      	CLD
  4902                                  	; 02/01/2024
  4903                                  	;PUSH	DS
  4904                                  	;push	ss
  4905                                  	;pop	ds
  4906 000004EF E83901                  	CALL	GETBP
  4907                                  	; 02/01/2024
  4908 000004F2 1F                      	pop	ds ; *
  4909 000004F3 7229                    	JC	short errdriv 		; PM. error drive ;AN000;
  4910                                  	
  4911                                  	; 02/01/2024
  4912                                  	;;mov	word [es:bp+1Fh]
  4913                                  	;MOV	WORD [ES:BP+DPB.FREE_CNT],-1 ; do not trust user at all.
  4914                                  ;errdriv:
  4915                                  	;POP	DS
  4916                                  	;jnc	short AbsSetup2
  4917                                  ;AbsSetup_retn:
  4918                                  	;retn
  4919                                  
  4920                                  AbsSetup2:
  4921                                  	; 15/05/2019 - Retro DOS v4.0
  4922                                  	; MSDOS 6.0
  4923                                  					; SS override
  4924 000004F5 36C706[0706]0000        	MOV	word [SS:HIGH_SECTOR],0 ;>32mb	from API		;AN000;
  4925 000004FC E8BA04                  	CALL	RW32_CONVERT		;>32mb convert 32bit format to 16bit ;AN000;
  4926                                  	;jc	short AbsSetup_retn
  4927                                  	;call	SET_RQ_SC_PARMS 	;LB. set up SC parms		;AN000;
  4928                                  	; 02/01/2024 - Retro DOS v5.0
  4929 000004FF 721D                    	jc	short errdriv
  4930                                  	;call	null_sub ; retn	; PCDOS 7.1 IBMDOS.COM
  4931                                  
  4932                                  	; MSDOS 3.3 (& MSDOS 6.0)
  4933 00000501 1E                      	PUSH	DS
  4934 00000502 56                      	PUSH	SI
  4935 00000503 50                      	PUSH	AX
  4936                                  
  4937 00000504 16                      	push	ss
  4938 00000505 1F                      	pop	ds
  4939                                  	
  4940 00000506 BE[BE03]                	MOV	SI,OPENBUF
  4941 00000509 8804                    	MOV	[SI],AL
  4942 0000050B 800441                  	ADD	BYTE [SI],"A"
  4943 0000050E C744013A00              	MOV	WORD [SI+1],003AH ; ":",0
  4944 00000513 B80003                  	MOV	AX,0300H
  4945 00000516 F8                      	CLC
  4946 00000517 CD2A                    	INT	int_IBM ; int 2Ah	; Will set carry if shared
  4947                                  		
  4948                                  		; 04/11/2022
  4949                                  		; (INT 2Ah - AX = 0300h)
  4950                                  		; Microsoft Networks - CHECK DIRECT I/O
  4951                                  		; DS:SI -> ASCIIZ disk device name (may be full path or
  4952                                  		;    only drive specifier--must include the colon)
  4953                                  		; Return: CF clear if absolute disk access allowed
  4954                                  
  4955 00000519 58                      	POP	AX
  4956 0000051A 5E                      	POP	SI
  4957 0000051B 1F                      	POP	DS
  4958 0000051C 730E                    	jnc	short AbsSetup_retn
  4959                                  
  4960                                  	; 02/01/2024
  4961                                  errdriv:
  4962                                  	;mov	word [ss:EXTERR],32h
  4963 0000051E 36C706[2403]3200        	MOV	word [ss:EXTERR],error_not_supported
  4964                                  	; 02/01/2024 - Retro DOS v5.0
  4965 00000525 36C706[BF0D]0702        	mov	word [ss:AbsDskErr],207h ; PCDOS 7.1 IBMDOS.COM
  4966                                  
  4967                                  	; 02/01/2024
  4968                                  AbsSetup_retn:
  4969 0000052C C3                      	retn
  4970                                  
  4971                                  ;---------------------------------------------------------------------------
  4972                                  ;
  4973                                  ; Procedure Name : ABSDRD
  4974                                  ;
  4975                                  ; Interrupt 25 handler. Performs absolute disk read.
  4976                                  ; Inputs:	AL - 0-based drive number
  4977                                  ;		DS:BX point to destination buffer
  4978                                  ;		CX number of logical sectors to read
  4979                                  ;		DX starting logical sector number (0-based)
  4980                                  ; Outputs:	Original flags still on stack
  4981                                  ;		Carry set
  4982                                  ;		    AH error from BIOS
  4983                                  ;		    AL same as low byte of DI from INT 24
  4984                                  ;
  4985                                  ;---------------------------------------------------------------------------
  4986                                          ;procedure   ABSDRD,FAR
  4987                                  ABSDRD:
  4988                                  	; 15/05/2019 - Retro DOS v4.0
  4989                                  	; MSDOS 6.21 (DOSCODE:42E5h)
  4990                                  	; 04/11/2022
  4991                                  	; MSDOS 5.0 (DOSCODE:42D8h)
  4992                                  
  4993                                  	; 02/01/2024 - Retro DOS v5.0
  4994                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:43C4h
  4995                                  	
  4996                                  	;;;
  4997 0000052D 30E4                    	xor     ah,ah	; ah=0		; Interrupt 25h handler (ah=0)
  4998 0000052F 31F6                    	xor     si,si	; si=0		; clear read/write mode flags
  4999                                  					; (used with INT 21h ax=7305h)
  5000                                  FAT32_ABSDRD:	; ah=1 si=0 cf=0 (jump from '_$FAT32EXT')
  5001                                  	; 25/06/2024
  5002                                  	;cli ; *
  5003                                  	;clc ; not necessary
  5004                                  				; INT 21h
  5005                                  				;	AX = 7305h
  5006                                  				; FAT32 - EXTENDED ABSOLUTE DISK READ/WRITE
  5007                                  				;	CX = FFFFh
  5008                                  				;	DL = drive number (01h=A:, etc.)
  5009                                  				;	SI = read/write mode flags
  5010                                  				;	DS:BX -> disk I/O packet
  5011                                  				;
  5012                                  				; Extended Absolute Disk Read/Write mode flags:
  5013                                  				;
  5014                                  				;	Bit(s)  Description
  5015                                  				;	0	direction (0=read, 1=write)
  5016                                  				;	12-1	reserved (0)
  5017                                  				;	14-13	write type (should be 00 on reads).
  5018                                  				;		00 unknown data.
  5019                                  				;		01 FAT data.
  5020                                  				;		10 directory data.
  5021                                  				;		11 file data
  5022                                  				;	15     reserved (0)
  5023                                  				;
  5024                                  				; Format of disk read/write packet:
  5025                                  				;
  5026                                  				;	Offset Size    Description
  5027                                  				;	00h    DWORD   sector number
  5028                                  				;	04h    WORD    number of sectors to r/w
  5029                                  				;	06h    DWORD   transfer address
  5030                                  				;
  5031                                  				; ref: Ralf Brown's Interrupt List
  5032                                  	;;;
  5033                                  absdrd_1:
  5034                                  	; MSDOS 6.0
  5035                                  	; 25/06/2024 - Retro DOS v5.0
  5036 00000531 FA                      	CLI ; *
  5037                                  	
  5038                                  ;	set up ds to point to DOSDATA
  5039                                  
  5040 00000532 50                      	push	ax			; preserve AX value
  5041 00000533 8CD8                    	mov	ax,ds			; store DS value in AX
  5042                                  	;getdseg <ds>
  5043 00000535 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  5044 0000053A A3[630D]                	mov	[TEMPSEG],ax		; store DS value in TEMPSEG
  5045 0000053D 58                      	pop	ax			; restore AX value
  5046                                  
  5047                                  	; M072:
  5048                                  	; We shall save es on the user stack here. We need to use ES in
  5049                                  	; order to access the DOSDATA variables AbsRdWr_SS/SP at exit
  5050                                  	; time in order to restore the user stack.
  5051                                  
  5052 0000053E 06                      	push	es  ; ****		; M072
  5053                                  
  5054                                  	; 25/06/2024
  5055                                  	; 02/01/2024 - Retrodos v5.0 (PCDOS 7.1 IBMDOS.COM)
  5056                                  	;;;
  5057 0000053F 7305                    	jnc	short absdrd_2		; (not jumped from ABSDWRT) absolute disk read
  5058                                  	
  5059                                  	;(jumped from ABSDRWT)
  5060 00000541 08E4                    	or	ah,ah
  5061 00000543 F9                      	stc				; absolute disk write
  5062 00000544 EB02                    	jmp	short absdrd_3
  5063                                  absdrd_2:
  5064 00000546 08E4                    	or	ah,ah
  5065                                  absdrd_3:
  5066 00000548 7510                    	jnz	short absdrd_4		; EXTENDED ABSOLUTE DISK READ/WRITE
  5067                                  	;;;
  5068                                  
  5069 0000054A 8C16[1B06]              	MOV	[AbsRdWr_SS],SS		; M013
  5070 0000054E 8926[1D06]              	MOV	[AbsRdWr_SP],SP		; M013
  5071                                  
  5072                                  ; 	set up ss to point to DOSDATA
  5073                                  ;
  5074                                  ; NOTE! Due to an obscure bug in the 80286, you cannot use the ROMDOS
  5075                                  ; version of the getdseg macro with the SS register! An interrupt will
  5076                                  ; sneak through.
  5077                                  
  5078                                  ;ifndef ROMDOS
  5079                                  	;getdseg <ss>			; cli in entry of routine
  5080                                  
  5081 00000552 2E8E16[0700]            	mov     ss,[cs:DosDSeg]
  5082                                  
  5083                                  ;else
  5084                                  ;	mov	ds, cs:[BioDataSeg]
  5085                                  ;	assume	ds:bdata
  5086                                  ;
  5087                                  ;	mov	ss, ds:[DosDataSg]
  5088                                  ;	assume	ss:DOSDATA
  5089                                  ;
  5090                                  ;endif ; ROMDOS
  5091                                  					; 02/01/2024
  5092 00000557 BC[2009]                	MOV	SP,DSKSTACK	 	;"@#IBM:12.01.2003.build_1.32#@ IBMDOS.COM(USA)"
  5093                                  					; (PCDOS 7.1 IBMDOS.COM)
  5094                                  absdrd_4:
  5095 0000055A 8E1E[630D]              	mov	ds,[TEMPSEG]		; restore DS value
  5096                                  
  5097 0000055E 06                      	push	es ; *** (MSDOS 6.21)
  5098 0000055F E8F6FE                  	call	save_world		; save all regs
  5099                                  
  5100 00000562 06                      	PUSH	ES ; **
  5101                                  
  5102                                  	; 02/01/2024 - Retrodos v5.0
  5103                                  	;;;
  5104 00000563 7303                    	jnc	short absdrd_5		; absolute disk read
  5105 00000565 E9A400                  	jmp	absdrwt_3		; (jumping back to) absolute disk write
  5106                                  absdrd_5:
  5107                                  	;;;
  5108                                  
  5109 00000568 E86FFF                  	CALL	AbsSetup
  5110 0000056B 723D                    	JC	short ILEAVE
  5111                                  
  5112                                  	; Here is a gross temporary fix to get around a serious design flaw in
  5113                                  	;  the secondary cache. The secondary cache does not check for media
  5114                                  	;  changed (it should). Hence, you can change disks, do an absolute
  5115                                  	;  read, and get data from the previous disk. To get around this,
  5116                                  	;  we just won't use the secondary cache for absolute disk reads.
  5117                                  	;                                                      -mw 8/5/88
  5118                                  
  5119                                  	;EnterCrit critDisk
  5120 0000056D E81413                  	call	ECritDisk
  5121 00000570 36C606[1211]FF          	MOV	byte [ss:CurSC_DRIVE],-1 ; invalidate SC  ;AN000;
  5122                                  	;LeaveCrit critDisk
  5123 00000576 E83813                  	call	LCritDisk
  5124                                  
  5125                                          ;invoke	DSKREAD
  5126 00000579 E89839                  	CALL	DSKREAD
  5127 0000057C 7513                            jnz	short ERR_LEAVE		;Jump if read unsuccessful.
  5128                                  
  5129 0000057E 89F9                            mov	cx,di
  5130 00000580 368C1E[0E06]                    mov	[ss:TEMP_VAR2],ds
  5131 00000585 36891E[0C06]                    mov	[ss:TEMP_VAR],bx
  5132                                  
  5133                                  ;       CX = # of contiguous sectors read. (These constitute a block of
  5134                                  ;            sectors, also termed an "Extent".)
  5135                                  ;       [HIGH_SECTOR]:DX = physical sector # of first sector in extent.
  5136                                  ;       [TEMP_VAR2]:[TEMP_VAR] = Transfer address (destination data address).
  5137                                  ;       ES:BP -> Drive Parameter Block (DPB).
  5138                                  ;
  5139                                  ;	The Buffer Queue must now be scanned: the contents of any dirty
  5140                                  ;	buffers must be "read" into the transfer memory block, so that the
  5141                                  ;       transfer memory reflects the most recent data.
  5142                                  
  5143                                  	;invoke	DskRdBufScan		;This trashes DS, but don't care.
  5144 0000058A E8193C                          call	DskRdBufScan
  5145 0000058D EB1B                    	jmp	short ILEAVE
  5146                                  
  5147                                  TLEAVE:
  5148 0000058F 7419                    	JZ	short ILEAVE
  5149                                  
  5150                                  ERR_LEAVE:				; M039
  5151                                  	; 15/07/2018 - Retro DOS v3.0
  5152                                          ;IF	IBM
  5153                                  ; Translate the error code to ancient 1.1 codes
  5154 00000591 06                              PUSH	ES ; *
  5155 00000592 0E                              PUSH	CS
  5156 00000593 07                              POP	ES
  5157 00000594 30E4                            XOR	AH,AH			; Nul error code
  5158                                  	;mov	cx,6
  5159 00000596 B90600                          MOV	CX,NUMERR		; Number of possible error conditions
  5160 00000599 BF[CE04]                        MOV	DI,ERRIN		; Point to error conditions
  5161 0000059C F2AE                            REPNE	SCASB
  5162 0000059E 7504                            JNZ	SHORT LEAVECODE		; Not found
  5163                                  	;mov	ah,[ES:DI+5]
  5164 000005A0 268A6505                        MOV	AH,[ES:DI+NUMERR-1]	; Get translation
  5165                                  LEAVECODE:
  5166 000005A4 07                              POP	ES ; *
  5167                                  	; 15/05/2019 - Retro DOS v4.0
  5168 000005A5 36A3[BF0D]              	mov	[ss:AbsDskErr],ax
  5169                                          ;ENDIF
  5170                                  
  5171 000005A9 F9                              STC
  5172                                  ILEAVE:
  5173                                  	; 15/05/2019
  5174 000005AA 07                              POP	ES ; **
  5175 000005AB E893FE                  	call	restore_world
  5176 000005AE 07                              pop	es ; *** (MSDOS 6.21)
  5177                                  
  5178                                  	; 02/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  5179                                  	;;;
  5180 000005AF 9C                      	pushf
  5181 000005B0 36803E[DB0A]00          	cmp	byte [ss:absdrw_extd],0
  5182                                  			; FAT32- EXTENDED ABSOLUTE DISK READ/WRITE flag
  5183 000005B6 751F                    	jnz	short ILEAVE_EXTD	; INT 21h AX=7305h
  5184                                  	; INT 25h
  5185 000005B8 9D                      	popf
  5186                                  	;;;
  5187                                  
  5188 000005B9 FA                      	CLI
  5189 000005BA 36A1[BF0D]              	mov	ax,[ss:AbsDskErr]	; restore error
  5190 000005BE 36FE0E[2103]            	DEC	BYTE [SS:INDOS]
  5191                                  	;
  5192                                  	; 02/01/2024 (PCDOS 7.1 IBMDOS.COM)
  5193 000005C3 36FE0E[C411]            	dec	byte [ss:INDOS_FLAG]	; Windows DOSBOX's INDOS flag ?
  5194                                  	;
  5195 000005C8 16                              push	ss			; M072 - Start
  5196 000005C9 07                      	pop	es			; es - dosdata
  5197 000005CA 268E16[1B06]                    mov	ss,[es:AbsRdWr_SS]	; M013
  5198 000005CF 268B26[1D06]            	mov	sp,[es:AbsRdWr_SP]	; M013
  5199 000005D4 07                      	pop	es  ; ****		; Note es was saved on user
  5200                                  					; stack at entry
  5201                                  					; M072 - End
  5202 000005D5 FB                              STI
  5203 000005D6 CB                      	RETF   ; ! FAR return !
  5204                                  
  5205                                  	; 02/01/2024 - Retro DOS v5.0
  5206                                  	; (PCDOS 7.1 IBMDOS.COM)
  5207                                  	;;;
  5208                                  ILEAVE_EXTD:	; return from INT 21h AX=7305h
  5209 000005D7 9D                      	popf
  5210 000005D8 36A1[BF0D]              	mov	ax,[ss:AbsDskErr]	; restore error
  5211 000005DC 07                      	pop	es ; ****
  5212 000005DD FB                      	sti
  5213 000005DE C3                      	retn
  5214                                  	;;;
  5215                                  
  5216                                  ;ABSDRD	ENDP
  5217                                  
  5218                                  ;---------------------------------------------------------------------------
  5219                                  ;
  5220                                  ; Procedure Name : ABSDWRT
  5221                                  ;
  5222                                  ; Interrupt 26 handler. Performs absolute disk write.
  5223                                  ; Inputs:	AL - 0-based drive number
  5224                                  ;		DS:BX point to source buffer
  5225                                  ;		CX number of logical sectors to write
  5226                                  ;		DX starting logical sector number (0-based)
  5227                                  ; Outputs:	Original flags still on stack
  5228                                  ;		Carry set
  5229                                  ;		    AH error from BIOS
  5230                                  ;		    AL same as low byte of DI from INT 24
  5231                                  ;
  5232                                  ;---------------------------------------------------------------------------
  5233                                          ;procedure   ABSDWRT,FAR
  5234                                  ABSDWRT:
  5235                                  	; 15/05/2019 - Retro DOS v4.0
  5236                                  	; MSDOS 6.21 (DOSCODE:436Ch)
  5237                                  	; 04/11/2022
  5238                                  	; MSDOS 5.0 (DOSCODE:435Fh)
  5239                                  
  5240                                  	; 03/01/2024 - Retro DOS v5.0
  5241                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:4477h
  5242                                  
  5243                                  	;;;
  5244 000005DF 30E4                    	xor	ah,ah	; ah=0		; Interrupt 26h handler (ah=0)
  5245 000005E1 BE0100                  	mov	si,1			; set direction flag/bit to write
  5246                                  					; (used with INT 21h ax=7305h)
  5247                                  FAT32_ABSDWRT:	; ah=1 si=1 cf=0 (jump from '_$FAT32EXT')
  5248                                  
  5249                                  				; INT 21h
  5250                                  				;	AX = 7305h
  5251                                  				; FAT32 - EXTENDED ABSOLUTE DISK READ/WRITE
  5252                                  				;	CX = FFFFh
  5253                                  				;	DL = drive number (01h=A:, etc.)
  5254                                  				;	SI = read/write mode flags
  5255                                  				;	DS:BX -> disk I/O packet
  5256                                  				;
  5257                                  				; Extended Absolute Disk Read/Write mode flags:
  5258                                  				;
  5259                                  				;	Bit(s)  Description
  5260                                  				;	0	direction (0=read, 1=write)
  5261                                  				;	12-1	reserved (0)
  5262                                  				;	14-13	write type (should be 00 on reads).
  5263                                  				;		00 unknown data.
  5264                                  				;		01 FAT data.
  5265                                  				;		10 directory data.
  5266                                  				;		11 file data
  5267                                  				;	15     reserved (0)
  5268                                  				;
  5269                                  				; Format of disk read/write packet:
  5270                                  				;
  5271                                  				;	Offset Size    Description
  5272                                  				;	00h    DWORD   sector number
  5273                                  				;	04h    WORD    number of sectors to r/w
  5274                                  				;	06h    DWORD   transfer address
  5275                                  				;
  5276                                  				; ref: Ralf Brown's Interrupt List
  5277 000005E4 3C02                    	cmp	al,2
  5278 000005E6 7220                    	jb	short absdrwt_2	; floppy disk
  5279                                  	; hard disk
  5280 000005E8 53                      	push	bx
  5281 000005E9 1E                      	push	ds
  5282 000005EA 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  5283 000005EF 30FF                    	xor	bh,bh
  5284 000005F1 88C3                    	mov	bl,al			;
  5285                                  					; NOTE: PCDOS 7.1 kernel does not set
  5286                                  					; DOS_FLAG bit 6 or drive_flags bit 7
  5287                                  					; (It appears that these bits are set
  5288                                  					; by Windows or a system utility or
  5289                                  					; driver that knows the addresses of
  5290                                  					; these FLAGs in the DOSDATA segment.)
  5291                                  					; Erdogan Tan - 03/01/2024
  5292                                  					;
  5293 000005F3 F687[1412]80            	test	byte [drive_flags+bx],80h 
  5294                                  					; test bit 7 (locked bit) ; 29/01/2024
  5295 000005F8 7505                    	jnz	short absdwrt_1		; locked (logical drive) -allowed to abs write-
  5296                                  					; NOTE: lock/unlock are MSDOS/PCDOS 7 extd functions
  5297 000005FA F606[8600]40            	test	byte [DOS_FLAG],40h	; test bit 6 (large disk support -windows- bit?)
  5298                                  					; (Windows OS running bit ?) ; 23/02/2024
  5299                                  					; NOTE: Retro DOS v5 kernel must set this bit.
  5300                                  absdwrt_1:
  5301 000005FF 1F                      	pop	ds
  5302 00000600 5B                      	pop	bx
  5303 00000601 7505                    	jnz	short absdrwt_2	; allowed
  5304 00000603 F9                      	stc
  5305 00000604 E817FF                  	call	errdriv		; error
  5306 00000607 CB                      	retf
  5307                                  
  5308                                  ;absdrwt_2:
  5309                                  	;;;
  5310                                  
  5311                                  ; 03/01/2024
  5312                                  %if 0
  5313                                  	CLI
  5314                                  
  5315                                  ;	set up ds to point to DOSDATA
  5316                                  
  5317                                  	push	ax
  5318                                  	mov	ax,ds
  5319                                  	;getdseg <ds>
  5320                                  	mov	ds,[cs:DosDSeg]
  5321                                  	mov	[TEMPSEG],ax
  5322                                  	pop	ax
  5323                                  
  5324                                  	; M072:
  5325                                  	; We shall save es on the user stack here. We need to use ES in
  5326                                  	; order to access the DOSDATA variables AbsRdWr_SS/SP at exit
  5327                                  	; time in order to restore the user stack.
  5328                                  
  5329                                  	push	es ; ****		; M072
  5330                                  
  5331                                  	MOV	[AbsRdWr_SS],SS		; M013
  5332                                  	MOV	[AbsRdWr_SP],SP		; M013
  5333                                  
  5334                                  	; set up ss to point to DOSDATA
  5335                                  	;
  5336                                  	; NOTE! Due to an obscure bug in the 80286, you cannot use the
  5337                                  	; ROMDOS version of the getdseg macro with the SS register!
  5338                                  	; An interrupt will sneak through.
  5339                                  
  5340                                  ;ifndef ROMDOS
  5341                                  	;getdseg <ss>			; cli in entry of routine
  5342                                  	mov     ss,[cs:DosDSeg]
  5343                                  ;else
  5344                                  ;	mov	ds, cs:[BioDataSeg]
  5345                                  ;	assume	ds:bdata
  5346                                  ;
  5347                                  ;	mov	ss, ds:[DosDataSg]
  5348                                  ;	assume	ss:DOSDATA
  5349                                  ;
  5350                                  ;endif ; ROMDOS
  5351                                  
  5352                                  	MOV	SP,DSKSTACK
  5353                                  		; we are now switched to DOS's disk stack
  5354                                  
  5355                                  	mov	ds,[TEMPSEG]		; restore user's ds
  5356                                  
  5357                                  	push	es ; *** (MSDOS 6.21)
  5358                                  
  5359                                  	call	save_world		; save all regs
  5360                                  
  5361                                  	PUSH	ES ; **
  5362                                  %endif
  5363                                  	; 03/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  5364                                  	;;;
  5365                                  absdrwt_2:
  5366                                  	; 25/06/2024
  5367                                  	;cli
  5368 00000608 F9                      	stc			; writable disk
  5369                                  				; ('jumped from ABSDWRT' sign for common r/w code)
  5370 00000609 E925FF                  	jmp	absdrd_1	; jump to ABSDRD (common r/w) code
  5371                                  	;;;
  5372                                  
  5373                                  absdrwt_3:
  5374 0000060C E8CBFE                  	CALL	AbsSetup
  5375 0000060F 7299                    	JC	short ILEAVE
  5376                                  
  5377                                  	; 03/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  5378 00000611 E8445C                  	call	chk_set_first_access
  5379                                  
  5380                                  	;EnterCrit critDisk
  5381 00000614 E86D12                  	call	ECritDisk
  5382 00000617 36C606[1211]FF          	MOV	byte [ss:CurSC_DRIVE],-1 ; invalidate SC ;AN000;
  5383                                  
  5384                                  	; 07/03/2025 (MiniDOS 1.0)
  5385                                  	;CALL	Fastxxx_Purge		; purge fatopen ;AN000;
  5386                                  	
  5387                                  	;LeaveCrit critDisk
  5388 0000061D E89112                  	call	LCritDisk
  5389                                  
  5390                                  ;M039
  5391                                  ;       DS:BX = transfer address (source data address).
  5392                                  ;       CX = # of contiguous sectors to write. (These constitute a block of
  5393                                  ;	     sectors, also termed an "Extent".)
  5394                                  ;       [HIGH_SECTOR]:DX = physical sector # of first sector in extent.
  5395                                  ;       ES:BP -> Drive Parameter Block (DPB).
  5396                                  ;       [CURSC_DRIVE] = -1 (invalid drive).
  5397                                  ;
  5398                                  ;       Free any buffered sectors which are in Extent; they are being over-
  5399                                  ;       written. Note that all the above registers are preserved for
  5400                                  ;       DSKWRITE.
  5401                                  
  5402 00000620 1E                              push	ds
  5403                                  	;invoke	DskWrtBufPurge          ; This trashes DS.
  5404 00000621 E8523F                  	call	DskWrtBufPurge
  5405 00000624 1F                              pop	ds
  5406                                  ;M039
  5407                                  	;invoke	DSKWRITE
  5408 00000625 E81039                  	call	DSKWRITE
  5409 00000628 E964FF                  	JMP	TLEAVE
  5410                                  
  5411                                  ;ABSDWRT ENDP
  5412                                  
  5413                                  ;----------------------------------------------------------------------------
  5414                                  ;
  5415                                  ; Procedure Name : GETBP
  5416                                  ;
  5417                                  ; Inputs:
  5418                                  ;	AL = Logical unit number (A = 0)
  5419                                  ; Function:
  5420                                  ;	Find Drive Parameter Block
  5421                                  ; Outputs:
  5422                                  ;	ES:BP points to DPB
  5423                                  ;	[THISDPB] = ES:BP
  5424                                  ;	Carry set if unit number bad or unit is a NET device.
  5425                                  ;		Later case sets extended error error_I24_not_supported
  5426                                  ; No other registers altered
  5427                                  ;
  5428                                  ;----------------------------------------------------------------------------
  5429                                  
  5430                                  	; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  5431                                  	; 04/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  5432                                  	; PCDOS 76.1 IBMDOS.COM - DOSCODE:44C7h
  5433                                  GETBP:
  5434                                  	; 15/05/2019 - Retro DOS v4.0
  5435                                  	; 11/07/2018 - Retro DOS v3.0
  5436 0000062B 50                      	PUSH	AX
  5437 0000062C 0401                    	ADD	AL,1		; No increment; need carry flag
  5438 0000062E 7210                    	JC	SHORT SKIPGET
  5439 00000630 E8DF71                  	CALL	GETTHISDRV
  5440                                  	; MSDOS 6.0
  5441 00000633 730B                    	JNC	SHORT SKIPGET		;PM. good drive		;AN000;
  5442                                  	
  5443                                  	; 23/03/2024 - Retro DOS v5.0
  5444                                  	;XOR	AH,AH			;DCR. ax= error code 	;AN000;
  5445                                  	;CMP	AX,error_not_DOS_disk	;DCR. is unknown media ? ;AN000;
  5446                                  	;JZ	SHORT SKIPGET 		;DCR. yes, let it go 	;AN000;
  5447                                  	;STC				;DCR.			;AN000;
  5448 00000635 B400                    	mov	ah,0	
  5449                                  
  5450 00000637 A3[2403]                	MOV	[EXTERR],AX	;PM. invalid drive or Non DOS drive ;AN000;
  5451 0000063A C706[BF0D]0102          	MOV	WORD [AbsDskErr],201h
  5452                                  SKIPGET:
  5453 00000640 58                      	POP	AX
  5454 00000641 7212                    	JC	SHORT GETBP_RETN ; 15/12/2022
  5455                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  5456                                  	;jnc	short getbp_t
  5457                                  	;retn
  5458                                  getbp_t:
  5459 00000643 C42E[A205]              	LES	BP,[THISCDS]
  5460                                  	; 15/12/2022
  5461 00000647 26F6464480              	test	byte [es:bp+curdir.flags+1],curdir_isnet>>8
  5462                                  	; 07/12/2022
  5463                                  	;TEST	WORD [ES:BP+43H],8000H
  5464                                  	;TEST	WORD [ES:BP+curdir.flags],curdir_isnet ; Clears carry
  5465 0000064C 7408                    	JZ	SHORT GETBP_CDS
  5466                                  GETBP_err:	; 04/01/2024
  5467 0000064E C706[2403]3200          	MOV	WORD [EXTERR],error_not_supported  ; 32h
  5468 00000654 F9                      	STC
  5469                                  GETBP_RETN:
  5470 00000655 C3                      	RETN
  5471                                  
  5472                                  GETBP_CDS:
  5473                                  	;LES	BP,[ES:BP+45H]
  5474 00000656 26C46E45                	LES	BP,[ES:BP+curdir.devptr]
  5475                                  	; 04/01/2024 (PCDOS 7.1 IBMDOS.COM)
  5476                                  	;;;
  5477 0000065A 50                      	push	ax
  5478                                  	; 25/06/2024
  5479 0000065B 8CC0                    	mov	ax,es
  5480 0000065D 09E8                    	or	ax,bp
  5481 0000065F 58                      	pop	ax
  5482 00000660 74EC                    	jz	short GETBP_err ; zero address, error
  5483                                  	;;;
  5484                                  ;----------------------------------------------------------------------------
  5485                                  GOTDPB:
  5486                                  	; Load THISDPB from ES:BP
  5487 00000662 892E[8A05]              	MOV	[THISDPB],BP
  5488 00000666 8C06[8C05]              	MOV	[THISDPB+2],ES
  5489 0000066A C3                      	RETN
  5490                                  
  5491                                  ;BREAK <SYS_RET_OK SYS_RET_ERR CAL_LK ETAB_LK set system call returns>
  5492                                  
  5493                                  ;----------------------------------------------------------------------------
  5494                                  ;
  5495                                  ; Procedure Name : SYS_RETURN
  5496                                  ;
  5497                                  ; These are the general system call exit mechanisms. All internal system
  5498                                  ; calls will transfer (jump) to one of these at the end. Their sole purpose
  5499                                  ; is to set the user's flags and set his AX register for return.
  5500                                  ;
  5501                                  ;----------------------------------------------------------------------------
  5502                                  
  5503                                          ;procedure   SYS_RETURN,NEAR
  5504                                  SYS_RETURN:        
  5505                                          ;entry	SYS_RET_OK
  5506                                  SYS_RET_OK:   
  5507 0000066B E809FE                  	call    Get_User_Stack
  5508                                  		; turn off user's carry flag
  5509                                  SYS_RET_OK_clc: ; 25/06/2019 
  5510                                          ;;and	word [SI+16h],0FFFEh 
  5511                                  	;and	word [SI+user_env.user_F],~f_Carry
  5512                                          ; 25/06/2019
  5513 0000066E 806416FE                	and	byte [SI+user_env.user_F],~f_Carry ; 0FEh
  5514                                  	; 04/01/2024
  5515                                  	;JMP	SHORT DO_RET
  5516                                  DO_RET:
  5517                                          ;MOV	[SI+user_env.user_AX],AX ; Really only sets AH
  5518 00000672 8904                    	MOV	[SI],AX
  5519 00000674 C3                      	RETN
  5520                                  
  5521                                          ;entry   SYS_RET_ERR
  5522                                  SYS_RET_ERR:        
  5523 00000675 30E4                    	XOR     AH,AH 		; hack to allow for smaller error rets
  5524 00000677 E86B00                  	call	ETAB_LK 	; Make sure code is OK, EXTERR gets set
  5525 0000067A E81900                  	CALL	ErrorMap
  5526                                  
  5527                                  	;entry	From_GetSet
  5528                                  From_GetSet:
  5529 0000067D E8F7FD                          call    Get_User_Stack
  5530                                  		 ; signal carry to user
  5531                                  	;;or	word [SI+16h],1
  5532                                  	;OR	word [SI+user_env.user_F],f_Carry
  5533                                  	; 25/06/2019
  5534 00000680 804C1601                	or	byte [SI+user_env.user_F],f_Carry
  5535 00000684 F9                      	STC			; also, signal internal error
  5536                                  	; 04/01/2024
  5537 00000685 EBEB                    	jmp	short DO_RET
  5538                                  ;DO_RET:
  5539                                  	;;MOV	[SI+user_env.user_AX],AX ; Really only sets AH
  5540                                  	;MOV	[SI],AX
  5541                                  	;RETN
  5542                                  
  5543                                  	;entry	FCB_RET_OK
  5544                                  FCB_RET_OK:
  5545                                  	;entry	NO_OP		; obsolete system calls dispatch to here
  5546                                  NO_OP:
  5547 00000687 30C0                    	XOR	AL,AL
  5548 00000689 C3                      	retn
  5549                                  
  5550                                  	;entry	FCB_RET_ERR
  5551                                  FCB_RET_ERR:
  5552 0000068A 30E4                    	XOR	AH,AH
  5553 0000068C 36A3[2403]              	mov	[ss:EXTERR],AX
  5554 00000690 E80300                  	CALL	ErrorMap
  5555 00000693 B0FF                    	MOV	AL,-1
  5556 00000695 C3                      	retn
  5557                                  
  5558                                  	;entry	ErrorMap
  5559                                  ErrorMap:
  5560 00000696 56                      	PUSH	SI
  5561                                  				; ERR_TABLE_21 is now in DOSDATA
  5562 00000697 BE[DB0D]                	MOV	SI,ERR_TABLE_21
  5563                                  				; SS override for FAILERR and EXTERR
  5564 0000069A 36803E[4A03]00          	CMP	byte [SS:FAILERR],0 ; Check for SPECIAL case.
  5565 000006A0 7407                    	JZ	short EXTENDED_NORMAL ; All is OK.
  5566                                  		 ; Ooops, this is the REAL reason
  5567                                  	;mov	word [SS:EXTERR],53h
  5568 000006A2 36C706[2403]5300        	MOV	word [SS:EXTERR],error_FAIL_I24
  5569                                  EXTENDED_NORMAL:
  5570 000006A9 E80200                  	call	CAL_LK		; Set CLASS,ACTION,LOCUS for EXTERR
  5571 000006AC 5E                      	POP	SI
  5572 000006AD C3                      	retn
  5573                                  
  5574                                  	;EndProc SYS_RETURN
  5575                                  
  5576                                  ;---------------------------------------------------------------------------
  5577                                  ;
  5578                                  ; Procedure Name : CAL_LK
  5579                                  ;
  5580                                  ; Inputs:
  5581                                  ;	SI is OFFSET in DOSDATA of CLASS,ACTION,LOCUS Table to use
  5582                                  ;		(DS NEED not be DOSDATA)
  5583                                  ;	[EXTERR] is set with error
  5584                                  ; Function:
  5585                                  ;	Look up and set CLASS ACTION and LOCUS values for GetExtendedError
  5586                                  ; Outputs:
  5587                                  ;	[EXTERR_CLASS] set
  5588                                  ;	[EXTERR_ACTION] set
  5589                                  ;	[EXTERR_LOCUS] set  (EXCEPT on certain errors as determined by table)
  5590                                  ; Destroys SI, FLAGS
  5591                                  ;
  5592                                  ;---------------------------------------------------------------------------
  5593                                  
  5594                                  	;procedure CAL_LK,NEAR
  5595                                  CAL_LK:
  5596 000006AE 1E                      	PUSH	DS
  5597 000006AF 50                      	PUSH	AX
  5598 000006B0 53                      	PUSH	BX
  5599                                  
  5600                                  ;M048	Context DS		; DS:SI -> Table
  5601                                  ;
  5602                                  ; Since this function can be called thru int 2f we shall not assume that SS
  5603                                  ; is DOSDATA
  5604                                  
  5605                                  	;getdseg  <ds>	; M048: DS:SI -> Table
  5606                                  	; 15/05/2019 - Retro DOS v4.0
  5607 000006B1 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  5608                                  
  5609                                  	; 18/07/2018
  5610                                  	;push	ss
  5611                                  	;pop	ds
  5612                                  
  5613 000006B6 8B1E[2403]              	MOV	BX,[EXTERR]	; Get error in BL
  5614                                  TABLK1:
  5615 000006BA AC                      	LODSB
  5616                                  
  5617 000006BB 3CFF                    	CMP	AL,0FFH
  5618 000006BD 7409                    	JZ	short GOT_VALS	; End of table
  5619 000006BF 38D8                    	CMP	AL,BL
  5620 000006C1 7405                    	JZ	short GOT_VALS	; Got entry
  5621 000006C3 83C603                  	ADD	SI,3		; Next table entry
  5622                                  	; 15/08/2018
  5623 000006C6 EBF2                    	JMP	short TABLK1
  5624                                  
  5625                                  GOT_VALS:
  5626 000006C8 AD                      	LODSW			; AL is CLASS, AH is ACTION
  5627                                  
  5628 000006C9 80FCFF                  	CMP	AH,0FFH
  5629 000006CC 7404                    	JZ	short NO_SET_ACT
  5630 000006CE 8826[2603]              	MOV	[EXTERR_ACTION],AH ; Set ACTION
  5631                                  NO_SET_ACT:
  5632 000006D2 3CFF                    	CMP	AL,0FFH
  5633 000006D4 7403                    	JZ	short NO_SET_CLS
  5634 000006D6 A2[2703]                	MOV	[EXTERR_CLASS],AL ; Set CLASS
  5635                                  NO_SET_CLS:
  5636 000006D9 AC                      	LODSB			; Get LOCUS
  5637                                  
  5638 000006DA 3CFF                    	CMP	AL,0FFH
  5639 000006DC 7403                    	JZ	short NO_SET_LOC
  5640 000006DE A2[2303]                	MOV	[EXTERR_LOCUS],AL
  5641                                  NO_SET_LOC:
  5642 000006E1 5B                      	POP	BX
  5643 000006E2 58                      	POP	AX
  5644 000006E3 1F                      	POP	DS
  5645 000006E4 C3                      	retn
  5646                                  
  5647                                  	;EndProc CAL_LK
  5648                                  
  5649                                  ;---------------------------------------------------------------------------
  5650                                  ;
  5651                                  ; Procedure Name : ETAB_LK
  5652                                  ;
  5653                                  ; Inputs:
  5654                                  ;	AX is error code
  5655                                  ;	[USER_IN_AX] has AH value of system call involved
  5656                                  ; Function:
  5657                                  ;	Make sure error code is appropriate to this call.
  5658                                  ; Outputs:
  5659                                  ;	AX MAY be mapped error code
  5660                                  ;	[EXTERR] = Input AX
  5661                                  ; Destroys ONLY AX and FLAGS
  5662                                  ;
  5663                                  ;---------------------------------------------------------------------------
  5664                                  
  5665                                  	;procedure ETAB_LK,NEAR
  5666                                  
  5667                                  ETAB_LK: ; 10/08/2018 - Retro DOS v3.0
  5668 000006E5 1E                      	PUSH	DS
  5669 000006E6 56                      	PUSH	SI
  5670 000006E7 51                      	PUSH	CX
  5671 000006E8 53                      	PUSH	BX
  5672                                  
  5673                                  	;Context DS			; SS is DOSDATA
  5674                                  
  5675 000006E9 16                      	push	ss
  5676 000006EA 1F                      	pop	ds
  5677                                  
  5678 000006EB A3[2403]                	MOV	[EXTERR],AX		; Set EXTERR with "real" error
  5679                                  
  5680                                  					; I21_MAP_E_TAB is now in DOSCODE
  5681 000006EE BE[0B00]                	MOV	SI,I21_MAP_E_TAB
  5682 000006F1 88C7                    	MOV	BH,AL			; Real code to BH
  5683 000006F3 8A1E[3B03]              	MOV	BL,[USER_IN_AX+1]	; Sys call to BL
  5684                                  TABLK2:
  5685                                  	; 15/05/2019 - Retro DOS v4.0
  5686 000006F7 2E                      	cs
  5687 000006F8 AD                      	lodsw	; MSDOS 6.0 (MSDOS 6.21 - MSDOS.SYS, DOSCODE:447Dh)
  5688                                  	
  5689                                  	; 18/07/2018 - Retro DOS v3.0
  5690                                  	;lodsw		; IBMDOS.COM (MSDOS 3.3) - Offset 16F7h
  5691                                  
  5692 000006F9 3CFF                    	CMP	AL,0FFH 		; End of table?
  5693 000006FB 740C                    	JZ	short NOT_IN_TABLE	; Yes
  5694 000006FD 38D8                    	CMP	AL,BL			; Found call?
  5695 000006FF 740C                    	JZ	short GOT_CALL		; Yes
  5696 00000701 86C4                    	XCHG	AH,AL			; Count to AL
  5697 00000703 30E4                    	XOR	AH,AH			; Make word for add
  5698 00000705 01C6                    	ADD	SI,AX			; Next table entry
  5699 00000707 EBEE                    	JMP	short TABLK2
  5700                                  
  5701                                  NOT_IN_TABLE:
  5702 00000709 88F8                    	MOV	AL,BH			; Restore original code
  5703 0000070B EB0C                    	JMP	SHORT NO_MAP
  5704                                  
  5705                                  GOT_CALL:
  5706 0000070D 88E1                    	MOV	CL,AH
  5707 0000070F 30ED                    	XOR	CH,CH			; Count of valid err codes to CX
  5708                                  CHECK_CODE:
  5709                                  	; 15/05/2019 - Retro DOS v4.0
  5710 00000711 2E                      	cs
  5711 00000712 AC                      	lodsb	; MSDOS 6.0 (MSDOS 6.21 - MSDOS.SYS, DOSCODE:4497h)
  5712                                  
  5713                                  	; 18/07/2018
  5714                                  	;lodsb		; IBMDOS.COM (MSDOS 3.3) - Offset 1710h
  5715                                  
  5716 00000713 38F8                    	CMP	AL,BH			; Code OK?
  5717 00000715 7402                    	JZ	short NO_MAP		; Yes
  5718 00000717 E2F8                    	LOOP	CHECK_CODE
  5719                                  NO_MAP:
  5720 00000719 30E4                    	XOR	AH,AH			; AX is now valid code
  5721 0000071B 5B                      	POP	BX
  5722 0000071C 59                      	POP	CX
  5723 0000071D 5E                      	POP	SI
  5724 0000071E 1F                      	POP	DS
  5725 0000071F C3                      	retn
  5726                                  
  5727                                  	;EndProc ETAB_LK
  5728                                  
  5729                                  ; 18/07/2018 - Retro DOS v3.0
  5730                                  ;---------------------------------------------------------------------------
  5731                                  ; BREAK <DOS 2F Handler and default NET 2F handler>
  5732                                  
  5733                                  ;IF installed ; (*)
  5734                                  
  5735                                  ;---------------------------------------------------------------------------
  5736                                  ;
  5737                                  ; Procedure Name : SetBad
  5738                                  ;
  5739                                  ; SetBad sets up info for bad functions
  5740                                  ;
  5741                                  ;---------------------------------------------------------------------------
  5742                                  
  5743                                  SetBad:
  5744                                  	;mov	ax,1
  5745 00000720 B80100                  	MOV	AX,error_invalid_function ; ALL NET REQUESTS get inv func
  5746                                  
  5747                                  	; MSDOS 3.3
  5748                                  	;;mov	byte [cs:EXTERR_LOCUS],1
  5749                                  	;MOV	byte [CS:EXTERR_LOCUS],errLOC_Unk
  5750                                  
  5751                                  ;	set up ds to point to DOSDATA
  5752                                  
  5753                                  	; 15/05/2019 - Retro DOS v4.0
  5754                                  	; MSDOS 6.0
  5755 00000723 1E                      	push	ds
  5756                                  
  5757                                  	;getdseg <ds>
  5758 00000724 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  5759                                  
  5760 00000729 C606[2303]01            	MOV	byte [EXTERR_LOCUS],errLOC_Unk ; 1
  5761                                  
  5762 0000072E 1F                      	pop	ds	  	;hkn; restore ds
  5763                                  
  5764 0000072F F9                      	STC
  5765 00000730 C3                      	retn
  5766                                  
  5767                                  ;--------------------------------------------------------------------------
  5768                                  ;
  5769                                  ; Procedure Name : BadCall
  5770                                  ;
  5771                                  ; BadCall is the initial routine for bad function calls
  5772                                  ;
  5773                                  ;--------------------------------------------------------------------------
  5774                                  
  5775                                  BadCall:
  5776 00000731 E8ECFF                  	call	SetBad
  5777 00000734 CB                      	retf
  5778                                  
  5779                                  ;--------------------------------------------------------------------------
  5780                                  ;
  5781                                  ; OKCall always sets carry to off.
  5782                                  ;
  5783                                  ;-----------------------------------------------------------------------
  5784                                  
  5785                                  OKCall:
  5786 00000735 F8                      	CLC
  5787 00000736 CB                      	retf
  5788                                  
  5789                                  ;---------------------------------------------------------------------------
  5790                                  ;
  5791                                  ; Procedure Name : INT2F
  5792                                  ;
  5793                                  ; INT 2F handler works as follows:
  5794                                  ;   PUSH    AX
  5795                                  ;   MOV     AX,multiplex:function
  5796                                  ;   INT     2F
  5797                                  ;   POP     ...
  5798                                  ; The handler itself needs to make the AX available for the various routines.
  5799                                  ;
  5800                                  ;----------------------------------------------------------------------------
  5801                                  
  5802                                  ; 15/05/2019 - Retro DOS v4.0
  5803                                  
  5804                                  ;KERNEL_SEGMENT equ 70h
  5805                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  5806                                  DOSBIODATASEG equ 70h
  5807                                  
  5808                                  ; retrodos4.s - offset in BIOSDATA
  5809                                  bios_i2f equ 5
  5810                                  
  5811                                  ;PUBLIC	Int2F
  5812                                  ;INT2F	PROC	FAR
  5813                                  
  5814                                  ; 15/05/2019
  5815                                  ; DOSCODE:44BDh (MSDOS 6.21, MSDOS.SYS)
  5816                                  
  5817                                  ; 04/11/2022
  5818                                  ; DOSCODE:44B0h (MSDOS 5.0, MSDOS.SYS)
  5819                                  
  5820                                  	; 15/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  5821                                  	; 18/07/2018 - Retro DOS v3.0
  5822                                  	; 05/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  5823                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:45DAh
  5824                                  INT2F:
  5825                                  	; Offset 172Fh in IBMDOS.COM (MSDOS 3.3), 1987
  5826                                  INT2FNT:
  5827                                  	;ASSUME	CS:DOSCODE,DS:NOTHING,ES:NOTHING,SS:NOTHING
  5828 00000737 FB                      	STI
  5829                                  	;cmp	ah,11h
  5830 00000738 80FC11                  	CMP	AH,MultNET
  5831 0000073B 750A                    	JNZ	short INT2FSHR
  5832                                  TestInstall:
  5833 0000073D 08C0                    	OR	AL,AL
  5834 0000073F 7403                    	JZ	short Leave2F
  5835                                  BadFunc:
  5836 00000741 E8DCFF                  	CALL	SetBad
  5837                                  
  5838                                  	;entry	Leave2F
  5839                                  Leave2F:
  5840 00000744 CA0200                  	RETF	2			; long return + clear flags off stack
  5841                                  
  5842                                  INT2FSHR:
  5843                                  	;cmp	ah,10h
  5844 00000747 80FC10                  	CMP	AH,MultSHARE		; is this a share request
  5845 0000074A 74F1                    	JZ	short TestInstall	; yes, check for installation
  5846                                  INT2FNLS:
  5847                                  	;cmp	ah,14h
  5848 0000074C 80FC14                  	CMP	AH,NLSFUNC		; is this a DOS 3.3 NLSFUNC request
  5849 0000074F 74EC                    	JZ	short TestInstall	; yes check for installation
  5850                                  INT2FDOS:
  5851                                  	;ASSUME	CS:DOSCODE,DS:NOTHING,ES:NOTHING,SS:NOTHING
  5852                                  
  5853                                  	; 18/07/2018
  5854                                  	; MSDOS 3.3
  5855                                  	;;cmp	ah,12h	
  5856                                  	;CMP	AH,MultDOS
  5857                                  	;jz	short DispatchDOS
  5858                                  	;iret
  5859                                  
  5860                                  	; 15/05/2019
  5861                                  	; MSDOS 6.0
  5862                                  	;cmp	ah,12h	; 07/12/2022
  5863 00000751 80FC12                  	CMP	AH,MultDOS
  5864 00000754 7503                    	JNZ	short check_win		;check if win386 broadcast
  5865 00000756 E93F02                  	jmp	DispatchDOS
  5866                                  
  5867                                  	; .... win386 .... 
  5868                                  
  5869                                  check_win:
  5870                                  	;cmp	ah,16h
  5871 00000759 80FC16                  	cmp	ah,MultWin386		; Is this a broadcast from Win386?
  5872 0000075C 7408                    	je	short Win386_Msg
  5873                                  
  5874                                  	; M044
  5875                                  	; Check if the callout is from Winoldap indicating swapping out or in 
  5876                                  	; of Windows. If so, do special action of going and saving last para
  5877                                  	; of the Windows memory arena which Winoldap does not save due to a 
  5878                                  	; bug
  5879                                  
  5880 0000075E 80FC46                  	cmp	ah,WINOLDAP ; 46h	; from Winoldap?
  5881                                  	;jne	short next_i2f		; no, chain on
  5882                                  	; 15/12/2022
  5883                                  	;jmp	winold_swap		; yes, do desired action
  5884 00000761 7460                    	je	short winold_swap
  5885 00000763 E92301                  	jmp	next_i2f
  5886                                  
  5887                                  	; 15/12/2022
  5888                                  ;next_i2f:
  5889                                  ;	;;;jmp	bios_i2f
  5890                                  ;	;;jmp	far ptr 70h:5 ; MSDOS 6.21 (MSDOS.SYS, DOSCODE:44F1h)
  5891                                  ;	;jmp	KERNEL_SEGMENT:bios_i2f
  5892                                  ;	; 04/11/2022
  5893                                  ;	jmp	DOSBIODATASEG:bios_i2f
  5894                                  
  5895                                  ;	IRET				; This assume that we are at the head
  5896                                  					; of the list
  5897                                  ;INT2F	ENDP
  5898                                  
  5899                                  ; 15/05/2019 - Retro DOS v4.0
  5900                                  
  5901                                  ; We have received a message from Win386. There are three possible
  5902                                  ; messages we could get from Win386:
  5903                                  ;
  5904                                  ; Init 		- for this, we set the IsWin386 flag and return a pointer
  5905                                  ;		  to the Win386 startup info structure.
  5906                                  ; Exit		- for this, we clear the IsWin386 flag.
  5907                                  ; DOSMGR query 	- for this, we need to indicate that instance data
  5908                                  ;		  has already been handled. this is indicated by setting
  5909                                  ;		  CX to a non-zero value.
  5910                                  
  5911                                  Win386_Msg:
  5912 00000766 1E                      	push	ds
  5913                                  
  5914                                  	;getdseg <DS>			; ds is DOSDATA
  5915 00000767 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  5916                                  
  5917                                  	; For WIN386 2.xx instance data
  5918                                  
  5919 0000076C 3C03                    	cmp	al,3			; win386 2.xx instance data call?
  5920 0000076E 7503                    	jne	short Win386_Msg_exit
  5921 00000770 E94801                  	jmp	OldWin386Init		; yes, return instance data
  5922                                  Win386_Msg_exit:
  5923 00000773 3C06                    	cmp	al,Win386_Exit	 ; 6	; is it an exit call?
  5924 00000775 7503                    	jne	short Win386_Msg_devcall
  5925 00000777 E94A01                  	jmp	Win386_Leaving
  5926                                  Win386_Msg_devcall:
  5927 0000077A 3C07                    	cmp	al,Win386_Devcall ; 7	; is it call from DOSMGR?
  5928 0000077C 7503                    	jne	short Win386_Msg_init
  5929 0000077E E97E01                  	jmp	Win386_Query
  5930                                  Win386_Msg_init:
  5931 00000781 3C05                    	cmp	al,Win386_Init	; 5	; is it an init call?
  5932 00000783 7403                    	je	short Win386_Starting
  5933 00000785 E90001                  	jmp	win_nexti2f		; no, return
  5934                                  
  5935                                  Win386_Starting:
  5936                                  	; 05/01/2024 - Retro DOS v5.0
  5937                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:4630h
  5938                                  	;;;
  5939 00000788 50                      	push	ax
  5940 00000789 51                      	push	cx
  5941 0000078A 57                      	push	di
  5942 0000078B 06                      	push	es
  5943 0000078C 1E                      	push	ds
  5944 0000078D 07                      	pop	es
  5945 0000078E BF[FB01]                	mov	di,INBUF
  5946 00000791 B90500                  	mov	cx,5
  5947 00000794 FC                      	cld
  5948                                  Win386_s_floop:
  5949 00000795 B8434F                  	mov	ax,'CO'	; 4F43h
  5950 00000798 AB                      	stosw
  5951 00000799 B84E20                  	mov	ax,'N '	; 204Eh
  5952 0000079C AB                      	stosw
  5953 0000079D 83C737                  	add	di,55	; (write 5 times 'CON ' and skip 55 bytes between them)
  5954                                  			; what for ?
  5955 000007A0 E2F3                    	loop	Win386_s_floop
  5956 000007A2 07                      	pop	es
  5957 000007A3 5F                      	pop	di
  5958 000007A4 59                      	pop	cx
  5959 000007A5 58                      	pop	ax
  5960                                  	;;;
  5961                                  
  5962                                  	; 17/12/2022
  5963 000007A6 F6C201                  	test	dl,1
  5964                                  	;test	dx,1			; is this really win386?
  5965 000007A9 7403                    	jz	short Win386_vchk	; YES! go and handle it
  5966 000007AB E9DA00                  	jmp	win_nexti2f		; NO! It's win 286 dos extender! M002
  5967                                  Win386_vchk:
  5968                                  	; M018 -- start of block changes
  5969                                  	; The VxD needs to be loaded only for Win 3.0. If version is greater 
  5970                                  	; than 030Ah, we skip the VxD presence check
  5971                                  
  5972                                  ;M067 -- Begin changes
  5973                                  ; If Win 3.0 is run, the VxD ptr has been initialized. If Win 3.1 is now
  5974                                  ;run, it tries to unnecesarily load the VxD even though it is not needed.
  5975                                  ;So, we null out the VxD ptr before the check.
  5976                                  
  5977                                  	;mov	word [Win386_Info+6],0
  5978 000007AE C706[E70E]0000          	mov	word [Win386_Info+Win386_SIS.Virt_Dev_File_Ptr],0
  5979                                  	;mov	word [Win386_Info+8],0
  5980 000007B4 C706[E90E]0000          	mov	word [Win386_Info+Win386_SIS.Virt_Dev_File_Ptr+2],0
  5981                                  
  5982                                  ;M067 -- End changes
  5983                                  
  5984                                  ;ifdef JAPAN
  5985                                  ;	cmp	di,0300h		; version >= 300 i.e 3.10 ;M037
  5986                                  ;else
  5987                                  	;cmp	di,030Ah		; version >= 30a i.e 3.10 ;M037
  5988                                  	; 05/01/2024 - PCDOS 7.1 - Retro DOS v5.0
  5989 000007BA 81FF0004                	cmp	di,0400h		; version >= 400 ; 05/01/2024
  5990                                  ;endif
  5991                                  	;jae	noVxD31			; yes, VxD not needed 	 ;M037
  5992 000007BE 724E                    	jb	short Win386_vxd
  5993 000007C0 E9DD00                  	jmp	noVxD31
  5994                                  
  5995                                  	; 15/12/2022
  5996                                  winold_swap:
  5997 000007C3 1E                      	push	ds
  5998 000007C4 06                      	push	es
  5999 000007C5 56                      	push	si
  6000 000007C6 57                      	push	di
  6001 000007C7 51                      	push	cx
  6002                                  
  6003                                  	;getdseg <ds>			;ds = DOSDATA
  6004 000007C8 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  6005                                  
  6006 000007CD 3C01                    	cmp	al,1			;swap Windows out call
  6007 000007CF 751B                    	jne	short swapin		;no, check if Swap in call
  6008 000007D1 E88801                  	call	getwinlast
  6009 000007D4 1E                      	push	ds
  6010 000007D5 07                      	pop	es
  6011 000007D6 8EDE                    	mov	ds,si			;ds = memory arena of Windows
  6012 000007D8 31F6                    	xor	si,si
  6013                                  	;mov	di,6 ; 05/01/2024
  6014 000007DA BF[0600]                	mov	di,WinoldPatch1 ; 6
  6015 000007DD B90800                  	mov	cx,8
  6016 000007E0 FC                      	cld
  6017                                  	;push	cx
  6018 000007E1 F3A4                    	rep	movsb			;save first 8 bytes
  6019                                  	;pop	cx
  6020                                  	; 25/06/2024
  6021 000007E3 B108                    	mov	cl,8
  6022                                  	;mov	di,1176h ; 05/01/2024
  6023 000007E5 BF[1311]                	mov	di,WinoldPatch2 ; 1176h
  6024 000007E8 F3A4                    	rep	movsb			;save next 8 bytes
  6025 000007EA EB1B                    	jmp	short winold_done
  6026                                  swapin:
  6027 000007EC 3C02                    	cmp	al,2			;swap Windows in call?
  6028 000007EE 7517                    	jne	short winold_done	;no, something else, pass it on
  6029 000007F0 E86901                  	call	getwinlast
  6030 000007F3 8EC6                    	mov	es,si
  6031 000007F5 31FF                    	xor	di,di
  6032 000007F7 BE[0600]                	mov	si,WinoldPatch1
  6033 000007FA B90800                  	mov	cx,8
  6034 000007FD FC                      	cld
  6035                                  	;push	cx
  6036 000007FE F3A4                    	rep	movsb			;restore first 8 bytes
  6037                                  	;pop	cx
  6038                                  	; 25/06/2024
  6039 00000800 B108                    	mov	cl,8
  6040 00000802 BE[1311]                	mov	si,WinoldPatch2
  6041 00000805 F3A4                    	rep	movsb			;restore next 8 bytes
  6042                                  winold_done:
  6043 00000807 59                      	pop	cx
  6044 00000808 5F                      	pop	di
  6045 00000809 5E                      	pop	si
  6046 0000080A 07                      	pop	es
  6047 0000080B 1F                      	pop	ds
  6048 0000080C EB7B                    	jmp	short next_i2f		;chain on
  6049                                  	; 15/12/2022
  6050                                  	;jmp	next_i2f
  6051                                  
  6052                                  Win386_vxd:
  6053 0000080E 50                      	push	ax
  6054 0000080F 53                      	push	bx
  6055 00000810 51                      	push	cx
  6056 00000811 52                      	push	dx
  6057 00000812 56                      	push	si
  6058 00000813 57                      	push	di			; save regs !!dont change order!!
  6059                                  
  6060 00000814 8B1E[8C00]              	mov	bx,[UMB_HEAD]		; M062 - Start
  6061 00000818 83FBFF                  	cmp	bx,0FFFFh    		; Q: have umbs been initialized
  6062 0000081B 741F                    	je	short Vxd31		; N: continue
  6063                                  					; Y: save arena associated with 
  6064                                  					;    umb_head
  6065                                  
  6066 0000081D C606[DA0D]01            	mov	byte [UmbSaveFlag],1	; indicate that we're saving 
  6067                                  					; umb_arena
  6068 00000822 1E                      	push	ds
  6069 00000823 06                      	push	es
  6070                                  
  6071                                  	;mov	ax,ds
  6072                                  	;mov	es,ax			; es - > dosdata
  6073                                  	; 05/01/2024
  6074 00000824 1E                      	push	ds
  6075 00000825 07                      	pop	es
  6076                                  
  6077 00000826 8EDB                    	mov	ds,bx
  6078 00000828 31F6                    	xor	si,si			; ds:si -> umb_head
  6079                                  
  6080                                  	; 05/01/2024 PCDOS 7.1
  6081                                  	;;;
  6082                                  	;clc	; not necessary (XOR already clears CF)
  6083                                  
  6084                                  restore_ubmhead:		; !! PCDOS 7.1 bug !!
  6085                                  				; jump from 'Win386_Leaving' here was/is wrong
  6086                                  				; (DI and SI would be reversed for 'Win386_Leaving')
  6087                                  				; Erdogan Tan - 05/01/2024
  6088                                  	;;;
  6089                                  
  6090 0000082A FC                      	cld
  6091                                  
  6092 0000082B BF[0311]                	mov	di,UmbSave1
  6093 0000082E B90B00                  	mov	cx,11
  6094 00000831 F3A4                    	rep	movsb
  6095                                  
  6096 00000833 BF[D50D]                	mov	di,UmbSave2
  6097                                  	;mov	cx,5
  6098                                  	; 18/12/2022
  6099 00000836 B105                    	mov	cl,5
  6100 00000838 F3A4                    	rep	movsb
  6101                                  	
  6102                                  	; 05/01/2024 PCDOS 7.1
  6103                                  	;;;	
  6104                                  	;jnb	short restore_ubmhead_c ; (not jumped from 'Win386_Leaving')
  6105                                  	;jmp	restore_ubmhead_ok ; (jumped from 'Win386_Leaving' just after 'stc')
  6106                                  ;restore_ubmhead_c:
  6107                                  	;;;
  6108                                  
  6109 0000083A 07                      	pop	es
  6110 0000083B 1F                      	pop	ds			; M062 - End
  6111                                  
  6112                                  Vxd31:
  6113                                  	;test	byte [DOS_FLAG],2
  6114 0000083C F606[8600]02            	test	byte [DOS_FLAG],SUPPRESS_WINA20	; M066
  6115 00000841 7408                    	jz	short Dont_Supress		; M066
  6116 00000843 5F                      	pop	di				; M066
  6117 00000844 5E                      	pop	si				; M066
  6118 00000845 5A                      	pop	dx				; M066
  6119 00000846 59                      	pop	cx				; M066
  6120 00000847 5B                      	pop	bx				; M066
  6121 00000848 58                      	pop	ax				; M066
  6122 00000849 EB55                    	jmp	short noVxD31			; M066
  6123                                  
  6124                                  	; We check here if the VxD is available in the root of the boot drive. 
  6125                                  	; We do an extended open to suppress any error messages
  6126                                  	
  6127                                  Dont_Supress:
  6128 0000084B A0[6900]                	mov	al,[BOOTDRIVE]
  6129 0000084E 0440                    	add	al,'A' - 1		; get drive letter
  6130 00000850 A2[0412]                	mov	[VxDpath],al		; path is root of bootdrive
  6131                                  	;mov	ah,ExtOpen  ;6Ch	; extended open
  6132                                  	;mov	al,0			; no extended attributes
  6133                                  	; 18/12/2022
  6134 00000853 B8006C                  	mov	ax,ExtOpen<<8 ; 6C00h
  6135 00000856 BB8020                  	mov	bx,2080h		; read access, compatibility mode
  6136                                  					; no inherit, suppress crit err
  6137 00000859 B90700                  	mov	cx,7			; hidden,system,read-only attr
  6138                                  	;05/01/2024
  6139                                  	;inc	dx			; dx bit 0 = 1 ; fail if file does not exist
  6140 0000085C BA0100                  	mov	dx,1			; fail if file does not exist
  6141                                  	
  6142 0000085F BE[0412]                	mov	si,VxDpath ; "c:\\wina20.386"	
  6143                                  					; path of VxD file
  6144 00000862 BFFFFF                  	mov	di,0FFFFh		; no extended attributes
  6145                                  
  6146 00000865 CD21                    	int	21h			; do extended open
  6147                                  
  6148 00000867 5F                      	pop	di
  6149 00000868 5E                      	pop	si
  6150 00000869 5A                      	pop	dx
  6151 0000086A 59                      	pop	cx
  6152                                  
  6153 0000086B 7321                    	jnc	short VxDthere		; we found the VxD, go ahead
  6154                                  
  6155                                  	; We could not find the VxD. Cannot let windows load. Return cx != 0
  6156                                  	; to indicate error to Windows after displaying message to user that
  6157                                  	; VxD needs to be present to run Windows in enhanced mode.
  6158                                  
  6159 0000086D 52                      	push	dx
  6160 0000086E 1E                      	push	ds
  6161 0000086F 56                      	push	si
  6162 00000870 BE[0D0A]                	mov	si,NoVxDErrMsg
  6163 00000873 0E                      	push	cs
  6164 00000874 1F                      	pop	ds
  6165 00000875 B96300                  	mov	cx,VxDMesLen ; 99	;
  6166 00000878 B402                    	mov	ah,2			; write char to console
  6167 0000087A FC                      	cld
  6168                                  vxdlp:
  6169 0000087B AC                      	lodsb
  6170 0000087C 86C2                    	xchg	dl,al			; get char in dl
  6171 0000087E CD21                    	int	21h
  6172 00000880 E2F9                    	loop	vxdlp
  6173                                  
  6174 00000882 5E                      	pop	si
  6175 00000883 1F                      	pop	ds
  6176 00000884 5A                      	pop	dx
  6177 00000885 5B                      	pop	bx
  6178 00000886 58                      	pop	ax			;all registers restored
  6179 00000887 41                      	inc	cx			;cx != 0 to indicate error
  6180                                  	; 15/12/22022
  6181                                  	;jmp	win_nexti2f		;chain on
  6182                                  	;jmp	short win_nexti2f
  6183                                  
  6184                                  	; 15/12/2022
  6185                                  win_nexti2f:
  6186 00000888 1F                      	pop	ds
  6187                                  	;jmp	short next_i2f		; go to BIOS i2f handler
  6188                                  	; 15/12/2022
  6189                                  next_i2f:
  6190                                  	;;;jmp	bios_i2f
  6191                                  	;;jmp	far ptr 70h:5 ; MSDOS 6.21 (MSDOS.SYS, DOSCODE:44F1h)
  6192                                  	;jmp	KERNEL_SEGMENT:bios_i2f
  6193                                  	; 04/11/2022
  6194 00000889 EA05007000              	jmp	DOSBIODATASEG:bios_i2f
  6195                                  
  6196                                  VxDthere:
  6197 0000088E 89C3                    	mov	bx,ax
  6198 00000890 B43E                    	mov	ah,CLOSE ; 3Eh
  6199 00000892 CD21                    	int	21h			;close the file
  6200                                  
  6201                                  	; Update the VxD ptr in the instance data structure with path to VxD
  6202                                  
  6203                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  6204                                  	;mov	bx,Win386_Info
  6205                                  	;mov	word [bx+Win386_SIS.Virt_Dev_File_Ptr],VxDpath
  6206                                  	;mov	word [bx+Win386_SIS.Virt_Dev_File_Ptr+2],ds
  6207                                  	; 15/12/2022
  6208 00000894 C706[E70E][0412]        	mov	word [Win386_Info+Win386_SIS.Virt_Dev_File_Ptr],VxDpath
  6209 0000089A 8C1E[E90E]              	mov	word [Win386_Info+Win386_SIS.Virt_Dev_File_Ptr+2],ds
  6210                                  
  6211 0000089E 5B                      	pop	bx
  6212 0000089F 58                      	pop	ax
  6213                                  noVxD31:
  6214                                  	; M018; End of block changes
  6215                                  
  6216 000008A0 800E[470F]01            	or	byte [IsWin386],1 	; Indicate WIN386 present
  6217 000008A5 800E[650D]01            	or	byte [redir_patch],1	; Enable critical sections; M002
  6218                                  
  6219                                  	; M002;
  6220                                  	; Save the previous es:bx (instance data ptr) into our instance table
  6221                                  
  6222 000008AA 52                      	push	dx			; M002
  6223 000008AB 89DA                    	mov	dx,bx			; M002
  6224                                  					; point ES:BX to Win386_Info ; M002
  6225 000008AD BB[E10E]                	mov	bx,Win386_Info
  6226 000008B0 895702                  	mov	[bx+2],dx		; M002
  6227 000008B3 8C4704                  	mov	[bx+4],es		; M002
  6228 000008B6 5A                      	pop	dx			; M002
  6229 000008B7 1E                      	push	ds			; M002
  6230 000008B8 07                      	pop	es			; M002
  6231                                  	;jmp	win_nexti2f		; M002
  6232                                  	; 15/12/2022
  6233 000008B9 EBCD                    	jmp	short win_nexti2f
  6234                                  
  6235                                  	; 15/12/2022
  6236                                  	; Code to return Win386 2.xx instance table
  6237                                  OldWin386Init:
  6238 000008BB 58                      	pop	ax			; discard ds pushed on stack
  6239 000008BC BE[D010]                	mov	si,OldInstanceJunk 
  6240                                  					; ds:si = instance table
  6241 000008BF B84852                  	mov	ax,5248h ; 'HR'		; indicate instance data present
  6242                                  	;jmp	next_i2f
  6243                                  	; 15/12/2022
  6244 000008C2 EBC5                    	jmp	short next_i2f
  6245                                  
  6246                                  Win386_Leaving:
  6247                                  	; 15/12/2022
  6248 000008C4 F6C201                  	test 	dl,1
  6249                                  	;test	dx,1			; is this really win386?
  6250                                  	;jz	short Win386_Leaving_c
  6251                                  	;jmp	win_nexti2f		; NO! It's win 286 dos extender! M002
  6252                                  	; 15/12/2022
  6253 000008C7 75BF                    	jnz	short win_nexti2f
  6254                                  
  6255                                  Win386_Leaving_c:
  6256                                  					; M062 - Start
  6257 000008C9 803E[DA0D]01            	cmp	byte [UmbSaveFlag],1	; Q: was umb_arena saved at win start
  6258                                  					;    up.
  6259 000008CE 7523                    	jne	short noumb		; N: not saved 
  6260 000008D0 C606[DA0D]00            	mov	byte [UmbSaveFlag],0	; Y: clear UmbSaveFlag and restore 
  6261                                  					;    previously saved umb_head
  6262                                  
  6263                                  	; 05/01/2024 - PCDOS 7.1 (has BUG here!)
  6264                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:472Bh
  6265                                  	;;;
  6266                                  	;push	ax ; (not necessary)
  6267                                  	;push	es
  6268                                  	;push	cx
  6269                                  	;push	si
  6270                                  	;push	di
  6271                                  	;mov	es,[UMB_HEAD]
  6272                                  	;xor	di,di
  6273                                  	;stc
  6274                                  	;jmp	restore_ubmhead	; !! PCDOS 7.1 bug !! IBMDOS.COM - DOSCODE:4737h
  6275                                  	;			; (jumped code does not restore umbhead,
  6276                                  	;			; MSDOS 6.22 "Win386_Leaving" code was/is correct,
  6277                                  	;			; modified code -in PCDOS 7.1 IBMDOS.COM- is wrong)
  6278                                  	;			; Erdogan Tan - 05/01/2024
  6279                                  	;
  6280                                  	;;;
  6281                                  
  6282                                  	; 05/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1)
  6283                                  	;push	ax ; (not necessary)
  6284 000008D5 06                      	push	es
  6285 000008D6 51                      	push	cx
  6286 000008D7 56                      	push	si
  6287 000008D8 57                      	push	di
  6288                                  
  6289                                  	;mov	ax,[UMB_HEAD]
  6290                                  	;mov	es,ax
  6291                                  	; 05/01/2024
  6292 000008D9 8E06[8C00]              	mov	es,[UMB_HEAD]
  6293 000008DD 31FF                    	xor	di,di			; es:di -> umb_head
  6294                                  
  6295 000008DF FC                      	cld
  6296                                  
  6297 000008E0 BE[0311]                	mov	si,UmbSave1
  6298 000008E3 B90B00                  	mov	cx,11
  6299 000008E6 F3A4                    	rep	movsb
  6300 000008E8 BE[D50D]                	mov	si,UmbSave2
  6301                                  	;mov	cx,5
  6302                                  	; 18/12/2022
  6303 000008EB B105                    	mov	cl,5
  6304 000008ED F3A4                    	rep	movsb
  6305                                  
  6306                                  restore_ubmhead_ok:	; 05/01/2024 - PCDOS 7.1 IBMDOS.COM - DOSCODE:473Ah
  6307 000008EF 5F                      	pop	di
  6308 000008F0 5E                      	pop	si
  6309 000008F1 59                      	pop	cx
  6310 000008F2 07                      	pop	es
  6311                                  	; 05/01/2024
  6312                                  	;pop	ax
  6313                                  noumb:					; M062 - End
  6314                                  	;and	byte [IsWin386],0	; Win386 is gone
  6315                                  	; 26/06/2024
  6316 000008F3 8026[470F]FE            	and	byte [IsWin386],0FEh ; ~1
  6317 000008F8 8026[650D]00            	and	byte [redir_patch],0	; Disable critical sections ; M002
  6318 000008FD EB89                    	jmp	short win_nexti2f
  6319                                  
  6320                                  ;	; 15/12/2022
  6321                                  ;	; Code to return Win386 2.xx instance table
  6322                                  ;OldWin386Init:
  6323                                  ;	pop	ax			; discard ds pushed on stack
  6324                                  ;	mov	si,OldInstanceJunk
  6325                                  ;					; ds:si = instance table
  6326                                  ;	mov	ax,5248h ; 'RH'		; indicate instance data present
  6327                                  ;	;jmp	next_i2f
  6328                                  ;	; 15/12/2022
  6329                                  ;	jmp	short _next_i2f
  6330                                  
  6331                                  Win386_Query:
  6332 000008FF 83FB15                  	cmp	bx,Win386_DOSMGR ; 15h	; is this from DOSMGR?
  6333 00000902 7584                    	jne	short win_nexti2f     	; no, ignore it & chain to next
  6334 00000904 09C9                    	or	cx,cx			; is it an instance query?
  6335 00000906 7508                    	jnz	short dosmgr_func	; no, some DOSMGR query
  6336 00000908 41                      	inc	cx			; indicate that data is instanced
  6337                                  ;
  6338                                  ; M001; We were previously returning a null ptr in es:bx. This will not work.
  6339                                  ; M001; WIN386 needs a ptr to a table in es:bx with the following offsets:
  6340                                  ; M001;  
  6341                                  ; M001; OFFSETS STRUC
  6342                                  ; M001; 	Major_version	db	?
  6343                                  ; M001; 	Minor_version	db	?
  6344                                  ; M001; 	SaveDS		dw	?
  6345                                  ; M001; 	SaveBX		dw	?
  6346                                  ; M001; 	Indos		dw	?
  6347                                  ; M001; 	User_id		dw	?
  6348                                  ; M001; 	CritPatch	dw	?
  6349                                  ; M001; OFFSETS	ENDS
  6350                                  ; M001; 
  6351                                  ; M001; User_Id is the only variable really important for proper functioning
  6352                                  ; M001; of Win386. The other variables are used at init time to patch stuff
  6353                                  ; M001; out. In DOS 5.0, we do the patching ourselves. But we still need to
  6354                                  ; M001; pass this table because Win386 depends on this table to get the 
  6355                                  ; M001; User_Id offset.
  6356                                  ; M001; 
  6357 00000909 BB[390F]                	mov	bx,Win386_DOSVars	; M001
  6358 0000090C 1E                      	push	ds			; M001
  6359 0000090D 07                      	pop	es			; es:bx points at offset table ; M001
  6360 0000090E EB40                    	jmp	short PopIret		; M001
  6361                                  
  6362                                  ; 15/12/2022
  6363                                  ;	; Code to return Win386 2.xx instance table
  6364                                  ;OldWin386Init:
  6365                                  ;	pop	ax			; discard ds pushed on stack
  6366                                  ;	mov	si,OldInstanceJunk
  6367                                  ;					; ds:si = instance table
  6368                                  ;	mov	ax,5248h ; 'RH'		; indicate instance data present
  6369                                  ;	;jmp	next_i2f
  6370                                  ;	; 15/12/2022
  6371                                  ;	jmp	short _next_i2f
  6372                                  
  6373                                  dosmgr_func:
  6374 00000910 49                      	dec	cx
  6375 00000911 7435                    	jz	short win386_patch	; call to patch DOS
  6376 00000913 49                      	dec	cx
  6377 00000914 743A                    	jz	short PopIret		; remove DOS patches, ignore
  6378 00000916 49                      	dec	cx
  6379 00000917 7439                    	jz	short win386_size	; get size of DOS data structures
  6380 00000919 49                      	dec	cx
  6381 0000091A 7428                    	jz	short win386_inst	; instance more data
  6382                                  	;dec	cx
  6383                                  	;jnz	short PopIret		; no functions above this
  6384                                  	; 05/01/2024 (PCDOS 7.1 IBMDOS.COM DOSCODE:4771h)
  6385 0000091C E232                    	loop	PopIret
  6386                                  
  6387                                  	; Get DOS device driver size -- es:di points at device driver header
  6388                                  	; In DOS 4.x, the para before the device header contains an arena
  6389                                  	; header for the driver.
  6390                                  
  6391 0000091E 8CC0                    	mov	ax,es			; ax = device header segment
  6392                                  
  6393                                  	; We check to see if we have a memory arena for this device driver.
  6394                                  	; The way to do this would be to look at the previous para to see if
  6395                                  	; it has a 'D' marking it as an arena and also see if the owner-field
  6396                                  	; in the arena is the same as the device header segment. These two
  6397                                  	; checks together should take care of all cases
  6398                                  
  6399 00000920 48                      	dec	ax			; get arena header
  6400 00000921 06                      	push	es
  6401 00000922 8EC0                    	mov	es,ax			; arena header for device driver
  6402                                  
  6403 00000924 26803D44                	cmp	byte [es:di],'D'	; is it a device arena?
  6404 00000928 7517                    	jnz	short cantsize		; no, cant size this driver
  6405 0000092A 40                      	inc	ax			; get back device header segment
  6406 0000092B 26394501                	cmp	[es:di+1],ax		; owner field pointing at driver?
  6407 0000092F 7510                    	jnz	short cantsize		; no, not a proper arena
  6408                                  
  6409 00000931 268B4503                	mov	ax,[es:di+3]		; get arena size in paras
  6410 00000935 07                      	pop	es
  6411                                  
  6412                                  	; We have to multiply by 16 to get the number of bytes in (bx:cx)
  6413                                  	; Speed is not critical and so we choose the shortest method
  6414                                  	; -- use "mul"
  6415                                  
  6416 00000936 BB1000                  	mov	bx,16
  6417 00000939 F7E3                    	mul	bx
  6418 0000093B 89C1                    	mov	cx,ax
  6419 0000093D 89D3                    	mov	bx,dx
  6420 0000093F EB09                    	jmp	short win386_done	; return with device driver size
  6421                                  cantsize:
  6422 00000941 07                      	pop	es
  6423 00000942 31C0                    	xor	ax,ax
  6424                                  win386_inst:	; 05/01/2024
  6425 00000944 31D2                    	xor	dx,dx			; ask DOSMGR to use its methods
  6426 00000946 EB08                    	jmp	short PopIret		; return
  6427                                  
  6428                                  win386_patch:
  6429                                  	; dx contains bits marking the patches to be applied. We return
  6430                                  	; the field with all bits set to indicate that all patches have been
  6431                                  	; done
  6432                                  
  6433 00000948 89D3                    	mov	bx,dx			; move patch bitfield to bx
  6434                                   	;jmp	short win386_done	; done, return
  6435                                  	; 15/12/2022
  6436                                  	; 15/12/2022
  6437                                  win386_done:
  6438 0000094A B87CB9                  	mov	ax,WIN_OP_DONE		; 0B97Ch
  6439 0000094D BAABA2                  	mov	dx,DOSMGR_OP_DONE	; 0A2ABh
  6440                                  PopIret:
  6441 00000950 1F                      	pop	ds
  6442 00000951 CF                      	iret	
  6443                                  
  6444                                  win386_size:
  6445                                  	; Return the size of DOS data structures -- currently only CDS size
  6446                                  
  6447                                  	; 17/12/2022
  6448 00000952 F6C201                  	test	dl,1
  6449                                  	;test	dx,1			; check for CDS size bit
  6450 00000955 74F9                    	jz	short PopIret		; no, unknown structure -- return
  6451                                  
  6452 00000957 B95800                  	mov	cx,curdirLen	; 88 	; cx = CDS size
  6453 0000095A EBEE                    	jmp	short win386_done	; return with the size
  6454                                  
  6455                                  ; 05/01/2024
  6456                                  %if 0
  6457                                  win386_inst:
  6458                                  	; WIN386 check to see if DOS has identified the CDS,SFT and device
  6459                                  	; chain as instance data. Currently, we let the WIN386 DOSMGR handle
  6460                                  	; this by returning a status of not previously instanced. The basic
  6461                                  	; structure of these things have not changed and so the current
  6462                                  	; DOSMGR code should be able to work it out
  6463                                  
  6464                                  	xor	dx,dx			; make sure dx has a not done value
  6465                                  	jmp	short PopIret		; skip done indication
  6466                                  %endif
  6467                                  
  6468                                  	; 15/12/2022
  6469                                  ;win386_done:
  6470                                  ;	mov	ax,WIN_OP_DONE		; 0B97Ch
  6471                                  ;	mov	dx,DOSMGR_OP_DONE	; 0A2ABh
  6472                                  ;PopIret:
  6473                                  ;	pop	ds
  6474                                  ;	iret				; return back up the chain
  6475                                  
  6476                                  	; 15/12/2022
  6477                                  ;win_nexti2f:
  6478                                  	;pop	ds
  6479                                  	;jmp	next_i2f		; go to BIOS i2f handler
  6480                                  
  6481                                  ;End WIN386 support
  6482                                  
  6483                                  ; 15/05/2019
  6484                                  
  6485                                  ;M044; Start of changes
  6486                                  ; Winoldap has a bug in that its calculations for the Windows memory image
  6487                                  ; to save is off by 1 para. This para can happen to be a Windows arena if the
  6488                                  ; DOS top of memory happens to be at an odd boundary (as is the case when
  6489                                  ; UMBs are present). This is because Windows builds its arenas only at even
  6490                                  ; para boundaries. This arena now gets trashed when Windows is swapped back
  6491                                  ; in leading to a crash. Winoldap issues callouts when it swaps Windows out
  6492                                  ; and back in. We sit on these callouts. On the Windows swapout, we save the
  6493                                  ; last para of the Windows memory block and then restore this para on the
  6494                                  ; Windows swapin callout. 
  6495                                  
  6496                                  getwinlast:
  6497                                  	; 07/12/2022
  6498 0000095C 8B36[3003]              	mov	si,[CurrentPDB]
  6499 00000960 4E                      	dec	si
  6500 00000961 8EC6                    	mov	es,si
  6501 00000963 2603360300              	add	si,[es:3]
  6502 00000968 C3                      	retn
  6503                                  
  6504                                  ; 15/12/2022
  6505                                  %if 0
  6506                                  winold_swap:
  6507                                  	push	ds
  6508                                  	push	es
  6509                                  	push	si
  6510                                  	push	di
  6511                                  	push	cx
  6512                                  
  6513                                  	;getdseg <ds>			;ds = DOSDATA
  6514                                  	mov	ds,[cs:DosDSeg]
  6515                                  
  6516                                  	cmp	al,1			;swap Windows out call
  6517                                  	jne	short swapin		;no, check if Swap in call
  6518                                  	call	getwinlast
  6519                                  	push	ds
  6520                                  	pop	es
  6521                                  	mov	ds,si			;ds = memory arena of Windows
  6522                                  	xor	si,si
  6523                                  	mov	di,WinoldPatch1
  6524                                  	mov	cx,8
  6525                                  	cld
  6526                                  	push	cx
  6527                                  	rep	movsb			;save first 8 bytes
  6528                                  	pop	cx
  6529                                  	mov	di,WinoldPatch2
  6530                                  	rep	movsb			;save next 8 bytes
  6531                                  	jmp	short winold_done
  6532                                  swapin:
  6533                                  	cmp	al,2			;swap Windows in call?
  6534                                  	jne	short winold_done	;no, something else, pass it on
  6535                                  	call	getwinlast
  6536                                  	mov	es,si
  6537                                  	xor	di,di
  6538                                  	mov	si,WinoldPatch1
  6539                                  	mov	cx,8
  6540                                  	cld
  6541                                  	push	cx
  6542                                  	rep	movsb			;restore first 8 bytes
  6543                                  	pop	cx
  6544                                  	mov	si,WinoldPatch2
  6545                                  	rep	movsb			;restore next 8 bytes
  6546                                  winold_done:
  6547                                  	pop	cx
  6548                                  	pop	di
  6549                                  	pop	si
  6550                                  	pop	es
  6551                                  	pop	ds
  6552                                  	jmp	next_i2f		;chain on
  6553                                  
  6554                                  %endif
  6555                                  
  6556                                  ;M044; End of changes
  6557                                  
  6558                                  ; ---------------------------------------------------------------------
  6559                                  ; 06/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM/MSDOS.SYS)
  6560                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:4811h
  6561                                  
  6562                                  	; INT 2Fh AX=1231h
  6563                                  	; Windows95 - SET/CLEAR "REPORT WINDOWS TO DOS PROGRAMS" FLAG
  6564                                  	; 			(Ref: Ralf Brown's Interrupt List)
  6565                                  int_2Fh_1231h:
  6566 00000969 1E                      	push	ds
  6567 0000096A 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  6568 0000096F 31C0                    	xor	ax,ax ; 0
  6569 00000971 08D2                    	or	dl,dl
  6570 00000973 7507                    	jnz	short not_1231_dl_0
  6571 00000975 C606[480F]01            	mov	byte [IsWin386+1],1	; set byte after "IsWIN386" to 01h
  6572 0000097A EB1A                    	jmp	short int_2f_1231h_retn
  6573                                  
  6574                                  	;nop
  6575                                  
  6576                                  not_1231_dl_0:
  6577 0000097C 80FA01                  	cmp	dl,1
  6578 0000097F 7507                    	jne	short not_1231_dl_1	; clear "IsWIN386" bit 1
  6579 00000981 800E[470F]02            	or	byte [IsWin386],2	; set "IsWIN386" bit 1
  6580 00000986 EB0E                    	jmp	short int_2f_1231h_retn
  6581                                  
  6582                                  	;nop
  6583                                  
  6584                                  not_1231_dl_1:
  6585 00000988 80FA02                  	cmp	dl,2
  6586 0000098B 7507                    	jne	short not_1231_dl_2
  6587 0000098D 8026[470F]FD            	and	byte [IsWin386],0FDh	; clear bit 1
  6588 00000992 EB02                    	jmp	short int_2f_1231h_retn
  6589                                  not_1231_dl_2:
  6590 00000994 40                      	inc	ax              	; return error, ax = 1
  6591 00000995 F9                      	stc
  6592                                  int_2f_1231h_retn:
  6593 00000996 1F                      	pop	ds
  6594 00000997 C3                      	retn
  6595                                  
  6596                                  ; ---------------------------------------------------------------------
  6597                                  
  6598                                  ; 15/05/2019
  6599                                  
  6600                                  ; 06/01/2024 - Retro DOS v5.0
  6601                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:4842h
  6602                                  
  6603                                  DispatchDOS:
  6604 00000998 2EFF36[D401]            	PUSH	word [CS:FOO]		; push return address
  6605 0000099D 2EFF36[D601]            	PUSH	word [CS:DTab]		; push table address
  6606 000009A2 50                      	PUSH	AX			; push index
  6607 000009A3 55                      	PUSH	BP
  6608 000009A4 89E5                    	MOV	BP,SP
  6609                                  		; stack looks like:
  6610                                  		;   0	BP
  6611                                  		;   2	DISPATCH
  6612                                  		;   4	TABLE
  6613                                  		;   6	RETURN
  6614                                  		;   8	LONG-RETURN
  6615                                  		;   C	FLAGS
  6616                                  		;   E	AX
  6617                                  	
  6618 000009A6 8B460E                  	MOV	AX,[BP+0Eh]		; get AX value
  6619 000009A9 5D                      	POP	BP
  6620 000009AA E82E0E                  	call	TableDispatch
  6621 000009AD E991FD                  	JMP	BadFunc 		; return indicates invalid function
  6622                                  
  6623                                  INT2F_etcetera:
  6624                                  	;entry	DosGetGroup
  6625                                  DosGetGroup:
  6626                                  	; MSDOS 3.3
  6627                                  	;push	cs
  6628                                  	;pop	ds
  6629                                  	;retn
  6630                                  
  6631                                  	; MSDOS 6.0
  6632                                  ;SR; Cannot use CS now
  6633                                  ;
  6634                                  ;	PUSH	CS
  6635                                  ;	POP	DS
  6636                                  
  6637                                  	; 04/11/2022
  6638                                  	; (MSDOS 5.0 MSDOS.SYS - DOSCODE:46FBh)
  6639                                  
  6640                                  	;getdseg <ds>
  6641 000009B0 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  6642 000009B5 C3                      	retn
  6643                                  
  6644                                  	;entry	DOSInstall
  6645                                  DOSInstall:
  6646 000009B6 B0FF                    	MOV	AL,0FFh
  6647 000009B8 C3                      	retn
  6648                                  
  6649                                  ;ENDIF ; (*)
  6650                                  
  6651                                  
  6652                                  ; 15/05/2019 - Retro DOS v4.0
  6653                                  ; 06/01/2024 - Retro DOS v5.0
  6654                                  
  6655                                  ;------------------------------------------------------------------------
  6656                                  ;
  6657                                  ; Procedure Name : RW32_CONVERT
  6658                                  ;
  6659                                  ;Input: same as ABSDRD and ABSDWRT
  6660                                  ;	 ES:BP -> DPB
  6661                                  ;Functions: convert 32bit absolute RW input parms to 16bit input parms
  6662                                  ;Output: carry set when CX=-1 and drive is less then 32mb
  6663                                  ;	 carry clear, parms ok
  6664                                  ;
  6665                                  ;------------------------------------------------------------------------
  6666                                  
  6667                                  	; 06/01/2024
  6668                                  RW32_CONVERT:
  6669 000009B9 83F9FF                  	CMP	CX,-1			;>32mb  new format ?	;AN000;
  6670                                  	;inc	cx ; *	; 01 -> 0
  6671 000009BC 7423                    	JZ	short new32format	;>32mb  yes		;AN000;
  6672                                  	;dec	cx
  6673                                  	
  6674                                  	;cmp	word [es:bp+0Fh],0
  6675 000009BE 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0 ; PCDOS 7.1
  6676 000009C3 741A                    	jz	short rw32_conv_err ; FAT32 fs
  6677                                  
  6678 000009C5 50                      	PUSH	AX			;>32mb  save ax		;AN000;
  6679 000009C6 52                      	PUSH	DX			;>32mb  save dx		;AN000;
  6680                                  	;mov	ax,[es:bp+0Dh]
  6681 000009C7 268B460D                	MOV	AX,[ES:BP+DPB.MAX_CLUSTER] ;>32mb  get max cluster # ;AN000;
  6682                                  	;mov	dl,[es:bp+4]
  6683 000009CB 268A5604                	MOV	DL,[ES:BP+DPB.CLUSTER_MASK] ;>32mb		;AN000;
  6684 000009CF 80FAFE                  	CMP	DL,0FEh ; 254		;>32mb  removable ?	;AN000;
  6685 000009D2 7407                    	JZ	short letold		;>32mb  yes		;AN000;
  6686                                  	;INC	DL			;>32mb			;AN000;
  6687                                  	; 17/12/2022
  6688 000009D4 42                      	inc	dx
  6689 000009D5 30F6                    	XOR	DH,DH			;>32mb  dx = sector/cluster ;AN000;
  6690 000009D7 F7E2                    	MUL	DX			;>32mb  dx:ax= max sector # ;AN000;
  6691 000009D9 09D2                    	OR	DX,DX	; (clears CF)	;>32mb  > 32mb ?	;AN000;
  6692                                  letold:
  6693 000009DB 5A                      	POP	DX			;>32mb  restore dx	;AN000;
  6694 000009DC 58                      	POP	AX			;>32mb  restore ax 	;AN000;
  6695 000009DD 7418                    	JZ	short old_style	; cf=0	;>32mb  no 		;AN000;
  6696                                  
  6697                                  	; 06/01/2024
  6698                                  	;push	ds
  6699                                  	;;getdseg <ds>
  6700                                  	;mov	ds,[cs:DosDSeg]
  6701                                  	;mov	word [AbsDskErr],207h	;>32mb  bad address mark
  6702                                  	;pop	ds
  6703                                  rw32_conv_err:
  6704 000009DF F9                      	STC				;>32mb			;AN000;
  6705 000009E0 C3                      	retn				;>32mb			;AN000;
  6706                                  
  6707                                  new32format:
  6708                                  	;mov	dx,[bx+2]
  6709 000009E1 8B5702                  	MOV	DX,[BX+ABS_32RW.SECTOR_RBA+2] ;>32mb		;AN000;
  6710                                  
  6711 000009E4 1E                      	push	ds			; set up ds to DOSDATA
  6712                                  	;getdseg <ds>
  6713 000009E5 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  6714 000009EA 8916[0706]              	MOV	[HIGH_SECTOR],DX	;>32mb			;AN000;
  6715 000009EE 1F                      	pop	ds
  6716                                  
  6717 000009EF 8B17                    	mov	dx,[bx]
  6718                                  	;MOV	DX,[BX+ABS_32RW.SECTOR_RBA]  ;>32mb		;AN000;
  6719                                  	;mov	cx,[bx+4]
  6720 000009F1 8B4F04                  	MOV	CX,[BX+ABS_32RW.ABS_RW_COUNT] ;>32mb		;AN000;
  6721                                  	;lds	bx,[bx+6]
  6722 000009F4 C55F06                  	LDS	BX,[BX+ABS_32RW.BUFFER_ADDR] ;>32mb		;AN000;
  6723                                  old_style:				;>32mb			;AN000;
  6724                                  	; 06/01/2024
  6725                                  	; cf=0
  6726                                  	;CLC				;>32mb			;AN000;
  6727 000009F7 C3                      	retn				;>32mb			;AN000;
  6728                                  
  6729                                  
  6730                                  ;============================================================================
  6731                                  ; DOSMES.INC (MSDOS 6.0, 1991)
  6732                                  ;============================================================================
  6733                                  ; 29/04/2019 - Retro DOS v4.0
  6734                                  
  6735                                  ;include dossym.inc
  6736                                  ;include dosmac.inc
  6737                                  ;include doscntry.inc
  6738                                  
  6739                                  ; DOSCODE Segment
  6740                                  
  6741                                  ; 17/07/2018 - Retro DOS v3.0  [ DOSMES.INC (MSDOS 3.3, 1987) ]
  6742                                  ; ---------------------------------------------------------------------------
  6743                                  ;include divmes.inc
  6744                                  
  6745                                  ; DOSCODE:48C3h (PCDOS 7.1, IBMDOS.COM) - 06/04/2024 -
  6746                                  ; -------------------------------------
  6747                                  ; DOSCODE:4778h (MSDOS 6.21, MSDOS.SYS)
  6748                                  ; -------------------------------------
  6749                                  ; DOSCODE:476Bh (MSDOS 5.0, MSDOS.SYS) - 05/11/2022 -
  6750                                  
  6751                                  ; THIS IS THE ONLY DOS "MESSAGE". IT DOES NOT NEED A TERMINATOR.
  6752                                  	;PUBLIC	DIVMES
  6753                                  
  6754 000009F8 0D0A44697669646520-     DIVMES:	DB	13,10,"Divide overflow",13,10
  6754 00000A01 6F766572666C6F770D-
  6754 00000A0A 0A                 
  6755                                  
  6756                                  	;PUBLIC	DivMesLen
  6757                                  DivMesLen:
  6758 00000A0B 1300                    	DW	$-DIVMES  ; 19	; Length of the above message in bytes
  6759                                  
  6760                                  ; DOSCODE:478Dh (MSDOS 6.21, MSDOS.SYS)
  6761                                  ; -------------------------------------
  6762                                  ; DOSCODE:4780h (MSDOS 5.0, MSDOS.SYS) - 05/11/2022 -
  6763                                  
  6764                                  ; (MSDOS 6.0)
  6765                                  ; VxD not found error message
  6766                                  
  6767                                  NoVxDErrMsg:
  6768 00000A0D 596F75206D75737420-     	db  'You must have the file WINA20.386 in the root of your boot drive'
  6768 00000A16 686176652074686520-
  6768 00000A1F 66696C652057494E41-
  6768 00000A28 32302E33383620696E-
  6768 00000A31 2074686520726F6F74-
  6768 00000A3A 206F6620796F757220-
  6768 00000A43 626F6F742064726976-
  6768 00000A4C 65                 
  6769 00000A4D 0D0A746F2072756E20-     	db  0Dh,0Ah,'to run Windows in Enhanced Mode',0Dh,0Ah
  6769 00000A56 57696E646F77732069-
  6769 00000A5F 6E20456E68616E6365-
  6769 00000A68 64204D6F64650D0A   
  6770                                  
  6771                                  VxDMesLen equ $ - NoVxDErrMsg  ; 99
  6772                                  
  6773                                  ; 13/05/2019 - Retro DOS v4.0
  6774                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  6775                                  
  6776                                  ;include yesno.asm  (MNSDOS 6.0)
  6777                                  ; -------------------------------------
  6778                                  ; DOSCODE:47F0h (MSDOS 6.21, MSDOS.SYS)
  6779                                  ; DOSCODE:47E3h (MSDOS 5.0, MSDOS.SYS) - 05/11/2022 -
  6780                                  
  6781                                  ; This is for country Yes and No
  6782                                  
  6783                                  ; 06/01/2024 (Retro DOS 5.0 - PCDOS 7.1 IBMDOS.COM)
  6784                                  ;NLS_YES:	db 'Y'
  6785                                  ;NLS_NO:	db 'N'
  6786                                  ;NLS_yes2:	db 'y'
  6787                                  ;NLS_no2:	db 'n'
  6788                                  
  6789                                  ; ---------------------------------------------------------------------------
  6790                                  
  6791                                  ; DOSCODE:493Bh (PCDOS 7.1, IBMDOS.COM) - 06/04/2024 -
  6792                                  ; -------------------------------------
  6793                                  ; DOSCODE:47F4h (MSDOS 6.21, MSDOS.SYS)
  6794                                  ; DOSCODE:47E7h (MSDOS 5.0, MSDOS.SYS) - 05/11/2022 -
  6795                                  
  6796                                  ;SUBTTL EDIT FUNCTION ASSIGNMENTS AND HEADERS
  6797                                  
  6798                                  ; The following two tables implement the current buffered input editing
  6799                                  ; routines. The tables are pairwise associated in reverse order for ease
  6800                                  ; in indexing. That is; The first entry in ESCTAB corresponds to the last
  6801                                  ; entry in ESCFUNC, and the last entry in ESCTAB to the first entry in ESCFUNC.
  6802                                  
  6803                                  	;PUBLIC	CANCHAR
  6804                                  CANCHAR:
  6805 00000A70 1B                      	DB	CANCEL	; 1Bh	;Cancel line character
  6806                                  	
  6807                                  	;PUBLIC	ESCCHAR
  6808                                  ESCCHAR:
  6809 00000A71 00                      	DB	ESCCH	; 0	;Lead-in character for escape sequences
  6810                                  	
  6811                                  	;IF	NOT Rainbow
  6812                                  
  6813                                  ESCTAB:	; LABEL BYTE
  6814                                  
  6815                                  	;IF	IBM
  6816 00000A72 40                      	DB	64		; Ctrl-Z - F6
  6817 00000A73 4D                      	DB	77		; Copy one char - -->
  6818 00000A74 3B                      	DB	59		; Copy one char - F1
  6819 00000A75 53                      	DB	83		; Skip one char - DEL
  6820 00000A76 3C                      	DB	60		; Copy to char - F2
  6821 00000A77 3E                      	DB	62		; Skip to char - F4
  6822 00000A78 3D                      	DB	61		; Copy line - F3
  6823 00000A79 3D                      	DB	61		; Kill line (no change to template ) - Not used
  6824 00000A7A 3F                      	DB	63		; Reedit line (new template) - F5
  6825 00000A7B 4B                      	DB	75		; Backspace - <--
  6826 00000A7C 52                      	DB	82		; Enter insert mode - INS (toggle)
  6827 00000A7D 52                      	DB	82		; Exit insert mode - INS (toggle)
  6828 00000A7E 41                      	DB	65		; Escape character - F7
  6829 00000A7F 41                      	DB	65		; End of table
  6830                                  	;ENDIF
  6831                                  
  6832                                  ESCEND: ; LABEL BYTE
  6833                                  
  6834                                  ESCTABLEN EQU ESCEND-ESCTAB
  6835                                  
  6836                                  ESCFUNC: ; LABEL WORD
  6837                                  	
  6838 00000A80 [8119]                  	short_addr  GETCH	; Ignore the escape sequence
  6839 00000A82 [FE19]                  	short_addr  TWOESC
  6840 00000A84 [F31A]                  	short_addr  EXITINS
  6841 00000A86 [F31A]                  	short_addr  ENTERINS
  6842 00000A88 [F919]                  	short_addr  BACKSP
  6843 00000A8A [DF1A]                  	short_addr  REEDIT
  6844 00000A8C [E619]                  	short_addr  KILNEW
  6845 00000A8E [751A]                  	short_addr  COPYLIN
  6846 00000A90 [A71A]                  	short_addr  SKIPSTR
  6847 00000A92 [7B1A]                  	short_addr  COPYSTR
  6848 00000A94 [9E1A]                  	short_addr  SKIPONE
  6849 00000A96 [801A]                  	short_addr  COPYONE
  6850 00000A98 [801A]                  	short_addr  COPYONE
  6851 00000A9A [FA1A]                  	short_addr  CTRLZ
  6852                                  
  6853                                  	;ENDIF
  6854                                  
  6855                                  ; DOSMES.INC (MSDOS 6.0, 1991)
  6856                                  ; ---------------------------------------------------------------------------
  6857                                  ; DOSMES.ASM (MSDOS 2.11, 1983)
  6858                                  
  6859                                  ; OEMFunction key is expected to process a single function
  6860                                  ;   key input from a device and dispatch to the proper
  6861                                  ;   routines leaving all registers UNTOUCHED.
  6862                                  ;
  6863                                  ; Inputs:   CS, SS are DOSGROUP
  6864                                  ; Outputs:  None. This function is expected to JMP to onw of
  6865                                  ;           the following labels:
  6866                                  ;
  6867                                  ;           GetCh       - ignore the sequence
  6868                                  ;           TwoEsc      - insert an ESCChar in the buffer
  6869                                  ;           ExitIns     - toggle insert mode
  6870                                  ;           EnterIns    - toggle insert mode
  6871                                  ;           BackSp      - move backwards one space
  6872                                  ;           ReEdit      - reedit the line with a new template
  6873                                  ;           KilNew      - discard the current line and start from scratch
  6874                                  ;           CopyLin     - copy the rest of the template into the line
  6875                                  ;           SkipStr     - read the next character and skip to it in the template
  6876                                  ;           CopyStr     - read next char and copy from template to line until char
  6877                                  ;           SkipOne     - advance position in template one character
  6878                                  ;           CopyOne     - copy next character in template into line
  6879                                  ;           CtrlZ       - place a ^Z into the template
  6880                                  ; Registers that are allowed to be modified by this function are:
  6881                                  ;           AX, CX, BP
  6882                                  
  6883                                  ; 13/05/2019 - Retro DOS v4.0
  6884                                  ; -------------------------------------
  6885                                  ; DOSCODE:4820h (MSDOS 6.21, MSDOS.SYS)
  6886                                  
  6887                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  6888                                  ; -------------------------------------
  6889                                  ; DOSCODE:4813h (MSDOS 5.0, MSDOS.SYS)
  6890                                  
  6891                                  ; 06/01/2024 - Retro DOS v5.0
  6892                                  ; -------------------------------------
  6893                                  ; DOSCODE:4967h (PCDOS 7.1, IBMDOS.COM)
  6894                                  
  6895                                  OEMFunctionKey:
  6896 00000A9C E8450E                  	CALL	_$STD_CON_INPUT_NO_ECHO	; Get the second byte of the sequence
  6897 00000A9F B10E                    	MOV     CL,ESCTABLEN ; 14	; length of table for scan
  6898 00000AA1 57                      	PUSH    DI                      ; save DI (cannot change it!)
  6899 00000AA2 BF[720A]                	MOV     DI,ESCTAB		; offset of second byte table
  6900 00000AA5 06                      	push	es
  6901 00000AA6 0E                      	push	cs
  6902 00000AA7 07                      	pop	es
  6903 00000AA8 F2AE                    	REPNE   SCASB                   ; Look it up in the table
  6904 00000AAA 07                      	pop	es
  6905 00000AAB 5F                      	POP     DI                      ; restore DI
  6906 00000AAC D1E1                    	SHL     CX,1                    ; convert byte offset to word
  6907 00000AAE 89CD                    	MOV     BP,CX                   ; move to indexable register
  6908                                  	;JMP	word [BP+ESCFUNC]	; Go to the right routine
  6909 00000AB0 2EFFA6[800A]            	JMP	word [CS:BP+ESCFUNC]
  6910                                  
  6911                                  ;DOSCODE ENDS
  6912                                  	
  6913                                  ;============================================================================
  6914                                  ; TIME.ASM (MSDOS 6.0, 1991)
  6915                                  ;============================================================================
  6916                                  ; Retro DOS v3.0 - 18/07/2018
  6917                                  
  6918                                  ; SYSCALL.ASM (MSDOS 2.11, 1983)
  6919                                  ;----------------------------------------------------------------------------
  6920                                  ; Retro DOS v2.0 - 13/03/2018
  6921                                  
  6922                                  ;**	TIME.ASM - System Calls and low level routines for DATE and TIME
  6923                                  
  6924                                  	;BREAK <DATE AND TIME - SYSTEM CALLS 42,43,44,45>
  6925                                  
  6926                                  ;**	$GET_DATE - Get Current Date
  6927                                  ;----------------------------------------
  6928                                  ;	ENTRY	none
  6929                                  ;	EXIT	(cx:dx) = current date
  6930                                  ;	USES	all
  6931                                  
  6932                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  6933                                  ; 06/01/2024 - Retro DOS v5.0 (Modified MSDOS 7.1 IBMDOS.COM)	
  6934                                  
  6935                                  _$GET_DATE:	;System call 42
  6936                                  
  6937 00000AB5 16                      	PUSH	SS
  6938 00000AB6 1F                      	POP	DS
  6939 00000AB7 E8AD00                  	CALL	READTIME	;Check for rollover to next day
  6940 00000ABA A1[5203]                	MOV	AX,[YEAR]
  6941                                  
  6942                                  ;	WARNING!!!! DAY and MONTH must be adjacently allocated!
  6943                                  
  6944 00000ABD 8B1E[5003]              	MOV	BX,[DAY]	; fetch both day and month
  6945 00000AC1 E8B3F9                  	CALL	Get_User_Stack	;Get pointer to user registers
  6946                                  	;MOV	[SI+6],BX	;DH=month, DL=day
  6947 00000AC4 895C06                  	MOV	[SI+user_env.user_DX],BX
  6948 00000AC7 05BC07                  	ADD	AX,1980		;Put bias back
  6949                                  	;MOV	[SI+4],AX	;CX=year
  6950 00000ACA 894404                  	MOV	[SI+user_env.user_CX],AX
  6951 00000ACD 36A0[5603]              	MOV	AL,[SS:WEEKDAY]	;hkn; SS override
  6952                                  RET20:	; 05/11/2022
  6953                                  RET24:	; 18/12/2022
  6954 00000AD1 C3                      	RETN
  6955                                  
  6956                                  ;**	$SET_DATE - Set Current Date
  6957                                  ;----------------------------------------
  6958                                  ;	ENTRY	(cx:dx) = current date
  6959                                  ;	EXIT	(al) = -1 iff bad date
  6960                                  ;		(al) = 0 if ok
  6961                                  ;	USES	all
  6962                                  
  6963                                  _$SET_DATE:	;System call 43
  6964                                  
  6965 00000AD2 B0FF                    	MOV	AL,-1		;Be ready to flag error
  6966 00000AD4 81E9BC07                	SUB	CX,1980		;Fix bias in year
  6967                                  	;JC	SHORT RET24	;Error if not big enough
  6968                                  	; 05/11/2022
  6969 00000AD8 72F7                    	jc	short RET20
  6970 00000ADA 83F977                  	CMP	CX,119		;Year must be less than 2100
  6971 00000ADD 77F2                    	JA	SHORT RET24
  6972 00000ADF 08F6                    	OR	DH,DH
  6973                                  	;JZ	SHORT RET24
  6974                                   	; 05/11/2022
  6975 00000AE1 74EE                    	jz	short RET20
  6976 00000AE3 08D2                    	OR	DL,DL
  6977                                  	;JZ	SHORT RET24	;Error if either month or day is 0
  6978                                  	; 05/11/2022
  6979 00000AE5 74EA                    	jz	short RET20
  6980 00000AE7 80FE0C                  	CMP	DH,12		;Check against max. month
  6981 00000AEA 77E5                    	JA	SHORT RET24
  6982 00000AEC 16                      	PUSH	SS
  6983 00000AED 1F                      	POP	DS
  6984                                  	;CALL	DODATE
  6985                                  	; 18/12/2022
  6986 00000AEE E90501                  	jmp	DODATE
  6987                                  ;RET24:  
  6988                                  	;RETN
  6989                                  
  6990                                  ;**	$GET_TIME - Get Current Time
  6991                                  ;----------------------------------------
  6992                                  ;	ENTRY	none
  6993                                  ;	EXIT	(cx:dx) = current time
  6994                                  ;	USES	all
  6995                                  
  6996                                  _$GET_TIME:			;System call 44
  6997                                  
  6998 00000AF1 16                      	PUSH	SS
  6999 00000AF2 1F                      	POP	DS
  7000 00000AF3 E87100                  	CALL	READTIME
  7001 00000AF6 E87EF9                  	CALL	Get_User_Stack	;Get pointer to user registers
  7002                                  	;MOV	[SI+6],DX
  7003 00000AF9 895406                  	MOV	[SI+user_env.user_DX],DX
  7004                                  	;MOV	[SI+4],CX
  7005 00000AFC 894C04                  	MOV	[SI+user_env.user_CX],CX
  7006                                  set_time_ok:	; 06/01/2024
  7007 00000AFF 30C0                    	XOR	AL,AL
  7008                                  RET26:  
  7009 00000B01 C3                      	RETN
  7010                                  
  7011                                  ;**	$SET_TIME - Set Current Time
  7012                                  ;----------------------------------------
  7013                                  ;	ENTRY	(cx:dx) = time
  7014                                  ;	EXIT	(al) = 0 if 0k
  7015                                  ;		(al) = -1 if invalid
  7016                                  ;	USES	ALL
  7017                                  
  7018                                  _$SET_TIME:			;System call 45
  7019                                  
  7020 00000B02 B0FF                    	MOV	AL,-1		;Flag in case of error
  7021 00000B04 80FD18                  	CMP	CH,24		;Check hours
  7022 00000B07 73F8                    	JAE	SHORT RET26
  7023 00000B09 80F93C                  	CMP	CL,60		;Check minutes
  7024 00000B0C 73F3                    	JAE	SHORT RET26
  7025 00000B0E 80FE3C                  	CMP	DH,60		;Check seconds
  7026 00000B11 73EE                    	JAE	SHORT RET26
  7027 00000B13 80FA64                  	CMP	DL,100		;Check 1/100's
  7028 00000B16 73E9                    	JAE	SHORT RET26
  7029 00000B18 51                      	PUSH	CX
  7030 00000B19 52                      	PUSH	DX
  7031 00000B1A 16                      	PUSH	SS
  7032 00000B1B 1F                      	POP	DS
  7033                                  
  7034                                  ; 07/02/2024
  7035                                  %if 0
  7036                                  	MOV	BX,TIMEBUF
  7037                                  	MOV	CX,6
  7038                                  	; 06/02/2024 ; *
  7039                                  	;;XOR	DX,DX
  7040                                  	;;MOV	AX,DX
  7041                                  	;xor	ax,ax
  7042                                  	;cwd	; 06/01/2024
  7043                                  	PUSH	BX
  7044                                  	;CALL	SETREAD
  7045                                  	; 06/02/2024 ; *
  7046                                  	call	SETREAD_X
  7047                                  %else
  7048 00000B1C E8D044                  	call	SETREAD_XT
  7049                                  %endif
  7050                                  
  7051 00000B1F 1E                      	PUSH	DS
  7052 00000B20 C536[2E00]              	LDS	SI,[BCLOCK]
  7053 00000B24 E85144                  	CALL	DEVIOCALL2	;Get correct day count
  7054 00000B27 1F                      	POP	DS
  7055 00000B28 5B                      	POP	BX
  7056 00000B29 E80045                  	CALL	SETWRITE
  7057 00000B2C 8F06[BA03]              	POP	WORD [TIMEBUF+4]
  7058 00000B30 8F06[B803]              	POP	WORD [TIMEBUF+2]
  7059 00000B34 C536[2E00]              	LDS	SI,[BCLOCK]
  7060 00000B38 E83D44                  	CALL	DEVIOCALL2	;Set the time
  7061                                  	; 06/01/2024
  7062                                  	;XOR	AL,AL
  7063                                  	;RETN
  7064 00000B3B EBC2                    	jmp	short set_time_ok
  7065                                  
  7066                                  ; 11/07/2018 - Retro DOS v3.0
  7067                                  ; Retro DOS v2.0 - 14/03/2018
  7068                                  
  7069                                  FOURYEARS EQU 3*365 + 366  ; = 1461 
  7070                                  
  7071                                  ;SUBTTL DATE16, READTIME, DODATE -- GUTS OF TIME AND DATE
  7072                                  ;----------------------------------------------------------
  7073                                  ; Date16 returns the current date in AX, current time in DX
  7074                                  ;   AX - YYYYYYYMMMMDDDDD  years months days
  7075                                  ;   DX - HHHHHMMMMMMSSSSS  hours minutes seconds/2
  7076                                  
  7077                                  DATE16:
  7078                                  	
  7079                                  ;M048	Context DS
  7080                                  ;
  7081                                  ; Since this function can be called thru int 2f we shall not assume that SS
  7082                                  ; is DOSDATA
  7083                                  
  7084                                  	;push	ss
  7085                                  	;pop	ds
  7086                                  
  7087                                  	;getdseg <ds>		; M048
  7088                                  
  7089                                  	; 13/05/2019 - Retro DOS v4.0
  7090 00000B3D 2E8E1E[0700]            	mov	ds, [cs:DosDSeg]	
  7091                                  
  7092 00000B42 51                      	PUSH	CX
  7093 00000B43 06                      	PUSH	ES
  7094 00000B44 E82000                  	CALL	READTIME
  7095 00000B47 07                      	POP	ES
  7096 00000B48 D0E1                    	SHL	CL,1		;Minutes to left part of byte
  7097 00000B4A D0E1                    	SHL	CL,1
  7098 00000B4C D1E1                    	SHL	CX,1		;Push hours and minutes to left end
  7099 00000B4E D1E1                    	SHL	CX,1
  7100 00000B50 D1E1                    	SHL	CX,1
  7101 00000B52 D0EE                    	SHR	DH,1		;Count every two seconds
  7102 00000B54 08F1                    	OR	CL,DH		;Combine seconds with hours and minutes
  7103 00000B56 89CA                    	MOV	DX,CX
  7104                                  
  7105                                  ;	WARNING! MONTH and YEAR must be adjacently allocated
  7106                                  
  7107 00000B58 A1[5103]                	MOV	AX,[MONTH]	;Fetch month and year
  7108 00000B5B B104                    	MOV	CL,4
  7109 00000B5D D2E0                    	SHL	AL,CL		;Push month to left to make room for day
  7110 00000B5F D1E0                    	SHL	AX,1
  7111 00000B61 59                      	POP	CX
  7112 00000B62 0A06[5003]              	OR	AL,[DAY]
  7113                                  RET21:
  7114 00000B66 C3                      	RETN
  7115                                  
  7116                                  ;----------------------------------------------------------
  7117                                  
  7118                                  READTIME:
  7119                                  
  7120                                  ;Gets time in CX:DX. Figures new date if it has changed.
  7121                                  ;Uses AX, CX, DX.
  7122                                  
  7123 00000B67 C706[BD0D]0000          	MOV	word [DATE_FLAG],0 ; reset date flag for CPMIO
  7124 00000B6D 56                      	PUSH	SI
  7125 00000B6E 53                      	PUSH	BX
  7126                                  
  7127 00000B6F BB[B603]                	MOV	BX,TIMEBUF
  7128                                  ; 07/02/2024
  7129                                  %if 0
  7130                                  	MOV	CX,6
  7131                                  	; 06/02/2024
  7132                                  	;;XOR	DX,DX
  7133                                  	;;MOV	AX,DX
  7134                                  	;; 06/01/2024
  7135                                  	;xor	ax,ax
  7136                                  	;cwd
  7137                                  	;CALL	SETREAD
  7138                                  	; 06/02/2024
  7139                                  	call	SETREAD_X
  7140                                  %else
  7141 00000B72 E87E44                  	call	SETREAD_XTC
  7142                                  %endif
  7143 00000B75 1E                      	PUSH	DS
  7144 00000B76 C536[2E00]              	LDS	SI,[BCLOCK]
  7145 00000B7A E8FB43                  	CALL	DEVIOCALL2	;Get correct date and time
  7146 00000B7D 1F                      	POP	DS
  7147 00000B7E 5B                      	POP	BX
  7148 00000B7F 5E                      	POP	SI
  7149 00000B80 A1[B603]                	MOV	AX,[TIMEBUF]
  7150 00000B83 8B0E[B803]              	MOV	CX,[TIMEBUF+2]
  7151 00000B87 8B16[BA03]              	MOV	DX,[TIMEBUF+4]
  7152 00000B8B 3B06[5403]              	CMP	AX,[DAYCNT]	;See if day count is the same
  7153                                  	;JZ	SHORT RET22
  7154 00000B8F 74D5                    	JZ	SHORT RET21 ; 18/07/2018
  7155                                  	;cmp	ax,43830
  7156 00000B91 3D36AB                  	CMP	AX,FOURYEARS*30 ;Number of days in 120 years
  7157 00000B94 733D                    	JAE	SHORT RET22	;Ignore if too large
  7158 00000B96 A3[5403]                	MOV	[DAYCNT],AX
  7159 00000B99 56                      	PUSH	SI
  7160 00000B9A 51                      	PUSH	CX
  7161 00000B9B 52                      	PUSH	DX		;Save time
  7162 00000B9C 31D2                    	XOR	DX,DX
  7163                                  	;mov	cx,1461
  7164 00000B9E B9B505                  	MOV	CX,FOURYEARS	;Number of days in 4 years
  7165 00000BA1 F7F1                    	DIV	CX		;Compute number of 4-year units
  7166 00000BA3 D1E0                    	SHL	AX,1
  7167 00000BA5 D1E0                    	SHL	AX,1
  7168 00000BA7 D1E0                    	SHL	AX,1		;Multiply by 8 (no. of half-years)
  7169 00000BA9 89C1                    	MOV	CX,AX		;<240 implies AH=0
  7170                                  
  7171 00000BAB BE[140D]                	MOV	SI,YRTAB	;Table of days in each year
  7172                                  
  7173                                  	;CALL	DSLIDE		;Find out which of four years we're in
  7174                                  	; 26/06/2024
  7175 00000BAE E82500                  	call	DSLIDE1  ; ah = 0
  7176 00000BB1 D1E9                    	SHR	CX,1		;Convert half-years to whole years
  7177 00000BB3 7304                    	JNC	SHORT SK	;Extra half-year?
  7178 00000BB5 81C2C800                	ADD	DX,200
  7179                                  SK:
  7180 00000BB9 E82400                  	CALL	SETYEAR
  7181 00000BBC B101                    	MOV	CL,1		;At least at first month in year
  7182                                  
  7183 00000BBE BE[1C0D]                	MOV	SI,MONTAB	;Table of days in each month
  7184                                  	
  7185                                  	;CALL	DSLIDE		;Find out which month we're in
  7186                                  	; 26/06/2024
  7187 00000BC1 E81200                  	call	DSLIDE1  ; ah = 0
  7188 00000BC4 880E[5103]              	MOV	[MONTH],CL
  7189 00000BC8 42                      	INC	DX		;Remainder is day of month (start with one)
  7190 00000BC9 8816[5003]              	MOV	[DAY],DL
  7191 00000BCD E88C00                  	CALL	WKDAY		;Set day of week
  7192 00000BD0 5A                      	POP	DX
  7193 00000BD1 59                      	POP	CX
  7194 00000BD2 5E                      	POP	SI
  7195                                  RET22:  
  7196 00000BD3 C3                      	RETN
  7197                                  
  7198                                  ;----------------------------------------------------------
  7199                                  
  7200                                  DSLIDE:
  7201                                  	; 26/06/2024
  7202 00000BD4 B400                    	MOV	AH,0
  7203                                  	; 06/01/2024
  7204                                  	; (AH=0)
  7205                                  DSLIDE1:
  7206 00000BD6 AC                      	LODSB			;Get count of days
  7207 00000BD7 39C2                    	CMP	DX,AX		;See if it will fit
  7208                                  	;JB	SHORT RET23	;If not, done
  7209 00000BD9 72F8                    	jb	short RET22 ; 13/05/2019 - Retro DOS v4.0
  7210 00000BDB 29C2                    	SUB	DX,AX
  7211 00000BDD 41                      	INC	CX		;Count one more month/year
  7212 00000BDE EBF6                    	JMP	SHORT DSLIDE1
  7213                                  
  7214                                  ;----------------------------------------------------------
  7215                                  
  7216                                  SETYEAR:
  7217                                  
  7218                                  ;Set year with value in CX. Adjust length of February for this year.
  7219                                  
  7220                                  ; NOTE: This can also be called thru int 2f. If this is called then it will
  7221                                  ;	  set DS to DOSDATA. Since the only guy calling this should be the DOS
  7222                                  ;	redir, DS will be DOSDATA anyway. It is going to be in-efficient to
  7223                                  ;	preserve DS as CHKYR is also called as a routine.
  7224                                  
  7225                                  	; MSDOS 6.0 (18/07/2018) ; *
  7226                                  
  7227                                  	;GETDSEG DS
  7228                                  
  7229                                  	;PUSH	CS  ; *
  7230                                  	;POP	DS  ; *
  7231                                  
  7232                                  	; 13/05/2019 - Retro DOS v4.0
  7233 00000BE0 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
  7234                                  
  7235                                  	; Offset 18CEh in IBMDOS.COM (MSDOS 3.3), 1987
  7236                                  	; 05/11/2022 
  7237                                  	; DOSCODE:4970h in MSDOS.SYS (MSDOS 5.0), 1991 
  7238                                  
  7239 00000BE5 880E[5203]              	MOV	[YEAR],CL
  7240                                  CHKYR:
  7241 00000BE9 F6C103                  	TEST	CL,3		;Check for leap year
  7242 00000BEC B01C                    	MOV	AL,28
  7243 00000BEE 7502                    	JNZ	SHORT SAVFEB	;28 days if no leap year
  7244 00000BF0 FEC0                    	INC	AL		;Add leap day
  7245                                  SAVFEB:
  7246 00000BF2 A2[1D0D]                	mov	[february],al
  7247                                  	;MOV	[MONTAB+1],AL	;Store for February
  7248                                  RET23:  
  7249 00000BF5 C3                      	RETN
  7250                                  
  7251                                  ;----------------------------------------------------------
  7252                                  
  7253                                  DODATE:
  7254 00000BF6 E8F0FF                  	CALL	CHKYR		;Set Feb. up for new year
  7255 00000BF9 88F0                    	MOV	AL,DH
  7256                                  
  7257 00000BFB BB[1B0D]                	MOV	BX,MONTAB-1	;DOSDATA:0D1Bh for MSDOS 6.21
  7258                                  				; 06/01/2024
  7259                                  				;DOSDATA:0D1Bh for PCDOS 7.1 
  7260                                  
  7261 00000BFE D7                      	XLAT			;Look up days in month
  7262 00000BFF 38D0                    	CMP	AL,DL
  7263 00000C01 B0FF                    	MOV	AL,-1		;Restore error flag, just in case
  7264                                  	;JB	SHORT RET25	;Error if too many days
  7265 00000C03 72F0                    	jb	short RET23 ; 18/07/2018
  7266 00000C05 E8D8FF                  	CALL	SETYEAR
  7267                                  ;
  7268                                  ; WARNING! DAY and MONTH must be adjacently allocated
  7269                                  ;
  7270 00000C08 8916[5003]              	MOV	[DAY],DX	;Set both day and month
  7271 00000C0C D1E9                    	SHR	CX,1
  7272 00000C0E D1E9                    	SHR	CX,1
  7273                                  	;mov	ax,1461
  7274 00000C10 B8B505                  	MOV	AX,FOURYEARS
  7275 00000C13 89D3                    	MOV	BX,DX
  7276 00000C15 F7E1                    	MUL	CX
  7277 00000C17 8A0E[5203]              	MOV	CL,[YEAR]
  7278 00000C1B 80E103                  	AND	CL,3
  7279                                  
  7280 00000C1E BE[140D]                	MOV	SI,YRTAB
  7281                                  
  7282 00000C21 89C2                    	MOV	DX,AX
  7283 00000C23 D1E1                    	SHL	CX,1		;Two entries per year, so double count
  7284 00000C25 E84700                  	CALL	DSUM		;Add up the days in each year
  7285 00000C28 88F9                    	MOV	CL,BH		;Month of year
  7286                                  
  7287 00000C2A BE[1C0D]                	MOV	SI,MONTAB
  7288                                  
  7289 00000C2D 49                      	DEC	CX		;Account for months starting with one
  7290 00000C2E E83E00                  	CALL	DSUM		;Add up days in each month
  7291 00000C31 88D9                    	MOV	CL,BL		;Day of month
  7292 00000C33 49                      	DEC	CX		;Account for days starting with one
  7293 00000C34 01CA                    	ADD	DX,CX		;Add in to day total
  7294 00000C36 92                      	XCHG	AX,DX		;Get day count in AX
  7295 00000C37 A3[5403]                	MOV	[DAYCNT],AX
  7296 00000C3A 56                      	PUSH	SI
  7297 00000C3B 53                      	PUSH	BX
  7298 00000C3C 50                      	PUSH	AX
  7299                                  
  7300                                  ; 07/02/2024
  7301                                  %if 0
  7302                                  	MOV	BX,TIMEBUF
  7303                                  	MOV	CX,6
  7304                                  	; 06/02/2024 ; *
  7305                                  	;;XOR	DX,DX
  7306                                  	;;MOV	AX,DX
  7307                                  	;; 06/01/2024
  7308                                  	;xor	ax,ax
  7309                                  	;cwd
  7310                                  	PUSH	BX
  7311                                  	;CALL	SETREAD
  7312                                  	; 06/02/2024 ; *
  7313                                  	call	SETREAD_X
  7314                                  %else
  7315 00000C3D E8AF43                  	call	SETREAD_XT
  7316                                  %endif
  7317                                  
  7318 00000C40 1E                      	PUSH	DS
  7319 00000C41 C536[2E00]              	LDS	SI,[BCLOCK]
  7320 00000C45 E83043                  	CALL	DEVIOCALL2	;Get correct date and time
  7321 00000C48 1F                      	POP	DS
  7322 00000C49 5B                      	POP	BX
  7323 00000C4A E8DF43                  	CALL	SETWRITE
  7324 00000C4D 8F06[B603]              	POP	WORD [TIMEBUF]
  7325 00000C51 1E                      	PUSH	DS
  7326 00000C52 C536[2E00]              	LDS	SI,[BCLOCK]
  7327 00000C56 E81F43                  	CALL	DEVIOCALL2	;Set the date
  7328 00000C59 1F                      	POP	DS
  7329 00000C5A 5B                      	POP	BX
  7330 00000C5B 5E                      	POP	SI
  7331                                  WKDAY:
  7332 00000C5C A1[5403]                	MOV	AX,[DAYCNT]
  7333 00000C5F 31D2                    	XOR	DX,DX
  7334 00000C61 B90700                  	MOV	CX,7
  7335 00000C64 40                      	INC	AX
  7336 00000C65 40                      	INC	AX		;First day was Tuesday
  7337 00000C66 F7F1                    	DIV	CX		;Compute day of week
  7338 00000C68 8816[5603]              	MOV	[WEEKDAY],DL
  7339 00000C6C 30C0                    	XOR	AL,AL		;Flag OK
  7340                                  RET25:
  7341 00000C6E C3                      	RETN
  7342                                  
  7343                                  ;----------------------------------------------------------
  7344                                  
  7345                                  ;**	DSUM - Compute the sum of a string of bytes
  7346                                  ;
  7347                                  ;	ENTRY	(cx) = byte count
  7348                                  ;		(ds:si) = byte address
  7349                                  ;		(dx) = sum register, initialized by caller
  7350                                  ;	EXIT	(dx) updated
  7351                                  ;	USES	ax, cx, dx, si, flags
  7352                                  
  7353                                  DSUM:
  7354 00000C6F B400                    	MOV	AH,0
  7355 00000C71 E305                    	JCXZ	DSUM9 ; 13/05/2019 - Retro DOS v4.0
  7356                                  	;JCXZ	RET25 ; 18/07/2018
  7357                                  DSUM1:
  7358 00000C73 AC                      	LODSB
  7359 00000C74 01C2                    	ADD	DX,AX
  7360 00000C76 E2FB                    	LOOP	DSUM1
  7361                                  DSUM9:
  7362 00000C78 C3                      	RETN
  7363                                  
  7364                                  ;============================================================================
  7365                                  ; GETSET.ASM (MSDOS 6.0, 1991)
  7366                                  ;============================================================================
  7367                                  ; 29/04/2019 - Retro DOS v4.0
  7368                                  ; 18/07/2018 - Retro DOS v3.0 (GETSET.ASM, MSDOS 6.0, 1991)
  7369                                  
  7370                                  ; 12/03/2018 - Retro DOS v2.0 
  7371                                  
  7372                                  ;TITLE	GETSET - GETting and SETting MS-DOS system calls
  7373                                  ;NAME	GETSET
  7374                                  
  7375                                  ;CODE	SEGMENT BYTE PUBLIC  'CODE'
  7376                                  ;       ASSUME  SS:DOSGROUP,CS:DOSGROUP
  7377                                  
  7378                                  ;USERNUM:
  7379                                  ;	DW	0			; 24 bit user number
  7380                                  ;       DB      0
  7381                                  ;;	IF      IBM
  7382                                  ;;OEMNUM: DB    0			; 8 bit OEM number
  7383                                  ;;	ELSE
  7384                                  ;OEMNUM: DB     0FFH			; 8 bit OEM number
  7385                                  ;;	ENDIF
  7386                                  
  7387                                  ;MSVERS:		; MS-DOS version in hex for $GET_VERSION
  7388                                  ;; 08/07/2018 - Retro DOS v3.0
  7389                                  ;MSMAJOR: DB	MAJOR_VERSION	; DOS_MAJOR_VERSION
  7390                                  ;MSMINOR: DB	MINOR_VERSION	; DOS_MINOR_VERSION  
  7391                                  
  7392                                  ;BREAK <$Get_Version -- Return MSDOS version number>
  7393                                  ;----------------------------------------------------------------------------
  7394                                  
  7395                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  7396                                  ; DOSCODE:4A0Fh (MSDOS 5.0 MSDOS.SYS)
  7397                                  
  7398                                  ; 06/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  7399                                  ; DOSCODE:4B5Fh (PCDOS 7.1 IBMDOS.COM)
  7400                                  
  7401                                  _$GET_VERSION:
  7402                                  
  7403                                  ; Inputs:
  7404                                  ;       None
  7405                                  ; Function:
  7406                                  ;       Return MS-DOS version number
  7407                                  ; Outputs:
  7408                                  ;       OEM number in BH
  7409                                  ;       User number in BL:CX (24 bits)
  7410                                  ;       Version number as AL.AH in binary
  7411                                  ;       NOTE: On pre 1.28 DOSs AL will be zero
  7412                                  
  7413                                  ; MSDOS 6.0
  7414                                  ;
  7415                                  ;	Fake_Count is used to lie about the version numbers to support
  7416                                  ;	old binarys. See ms_table.asm for more info.
  7417                                  ;
  7418                                  ;		if input al = 00
  7419                                  ;		  (bh) = OEM number			
  7420                                  ;		else if input al = 01
  7421                                  ;		  (bh) = version flags
  7422                                  ;		 
  7423                                  ;		       	 bits 0-2 = DOS internal revision
  7424                                  ;		       	 bits 3-7 = DOS type flags
  7425                                  ;		              bit 3    = DOS is in ROM
  7426                                  ;		              bit 4    = DOS in in HMA
  7427                                  ;		              bits 5-7 = reserved
  7428                                  ;               M007 change - only bit 3 is now valid. Other bits
  7429                                  ;               are 0 when AL = 1
  7430                                  
  7431                                  	; 06/01/2024 (PCDOS 7.1 IBMDOS.COM)
  7432 00000C79 36C50E[B203]            	lds	cx, [ss:USERNUM]
  7433 00000C7E 8CDB                    	mov	bx, ds
  7434                                  
  7435                                  	; MSDOS 3.3 (IBMDOS.COM, offset 196Dh)
  7436                                  	;--------------------------------------
  7437                                  	; MSDOS 6.21 (MSDOS.SYS, DOSCODE:4A1Ch)
  7438                                  
  7439 00000C80 16                              PUSH    SS
  7440 00000C81 1F                              POP     DS
  7441                                          
  7442                                  	; 06/01/2024
  7443                                  	;MOV	BX,[USERNUM+2]
  7444                                          ;MOV	CX,[USERNUM]
  7445                                  
  7446                                  	; 13/05/2019 - Retro DOS v4.0
  7447                                  
  7448                                  	;If AL == 1, ROMDOS will return BH = dos internal version # &
  7449                                  	;DOS flags
  7450                                  
  7451 00000C82 3C01                    	cmp	AL,1
  7452 00000C84 7502                    	jne	short Norm_Vers
  7453                                  
  7454                                  ;ifdef ROMDOS
  7455                                  ;	mov	BH,DOSINROM 	; Just set the bit for ROM version
  7456                                  ;				(DOSINROM = 8)
  7457                                  ;else
  7458 00000C86 30FF                            xor     bh,bh		; Otherwise return 0
  7459                                  ;endif				;M007 end
  7460                                  
  7461                                  Norm_Vers:
  7462                                  	;MOV	AX,[MSVERS]  ; MSDOS 3.3
  7463                                  
  7464                                          	; MSDOS 6.0	; MSVERS is a label in TABLE segment	
  7465                                  	; 26/06/2024 - Retro DOS v5.0
  7466                                  	;	(PCDOS 7.1 IBMDOS.COM)
  7467                                  	; 13/05/2019 - Retro DOS v4.0
  7468                                  	;push	ds		; Get the version number from the
  7469 00000C88 8E1E[3003]              	mov	ds,[CurrentPDB]	; current app's PSP segment
  7470                                  	;mov	ax,[40h]
  7471 00000C8C A14000                  	mov	ax,[PDB.Version] ; AX = DOS version number	
  7472                                  	; 07/12/2022
  7473                                  	;pop	ds
  7474 00000C8F E8E5F7                  	call	Get_User_Stack
  7475                                  				; Put values for return registers
  7476                                  				; in the proper place on the user's	 
  7477                                  				; stack addressed by DS:SI
  7478                                  	; 06/01/2024 (PCDOS 7.1 IBMDOS.COM)
  7479                                  gdrvfspc_ret:
  7480                                          ;MOV	[SI+user_env.user_AX],AX
  7481 00000C92 8904                            MOV	[SI],AX
  7482                                          ;MOV	[SI+4],CX
  7483 00000C94 894C04                  	mov	[SI+user_env.user_CX],CX
  7484                                  set_user_bx:
  7485                                  	;MOV	[SI+2],BX
  7486 00000C97 895C02                  	mov	[SI+user_env.user_BX],BX
  7487                                  
  7488 00000C9A C3                      	RETN
  7489                                  
  7490                                  ; 18/07/2018 - Retro DOS v3.0
  7491                                  
  7492                                  ;BREAK <$Get/Set_Verify_on_Write - return/set verify-after-write flag>
  7493                                  ;----------------------------------------------------------------------------
  7494                                  
  7495                                  ;**	$Get_Verify_On_Write - Get Status of Verify on write flag
  7496                                  ;
  7497                                  ;	ENTRY	none
  7498                                  ;	EXIT	(al) = value of VERIFY flag
  7499                                  ;	USES	all
  7500                                  
  7501                                  
  7502                                  _$GET_VERIFY_ON_WRITE:
  7503                                  
  7504                                  ;hkn; SS override
  7505 00000C9B 36A0[FF02]              	MOV	AL,[SS:VERFLG]	; Retro DOS v2.0 - 12/03/2018
  7506 00000C9F C3                      	retn
  7507                                  
  7508                                  ;**	$Set_Verify_On_Write - Set Status of Verify on write flag
  7509                                  ;
  7510                                  ;	ENTRY	(al) = value of VERIFY flag
  7511                                  ;	EXIT	none
  7512                                  ;	USES	all
  7513                                  
  7514                                  _$SET_VERIFY_ON_WRITE:
  7515                                  
  7516 00000CA0 2401                    	AND	AL,1
  7517                                  ;hkn; SS override
  7518 00000CA2 36A2[FF02]              	MOV	[SS:VERFLG],AL	; Retro DOS v2.0 - 12/03/2018
  7519                                  RET27:	; 18/07/2018
  7520 00000CA6 C3                      	retn
  7521                                  
  7522                                  ; 19/07/2018 - Retro DOS v3.0
  7523                                  
  7524                                  ;BREAK <$International - return country-dependent information>
  7525                                  ;----------------------------------------------------------------------------
  7526                                  ;
  7527                                  ; Procedure Name : $INTERNATIONAL
  7528                                  ;
  7529                                  ; Inputs:
  7530                                  ;	MOV	AH,International
  7531                                  ;	MOV	AL,country	(al = 0 => current country)
  7532                                  ;      [MOV	BX,country]
  7533                                  ;	LDS	DX,block
  7534                                  ;	INT	21
  7535                                  ; Function:
  7536                                  ;	give users an idea of what country the application is running
  7537                                  ; Outputs:
  7538                                  ;	IF DX != -1 on input (get country)
  7539                                  ;	  AL = 0 means return current country table.
  7540                                  ;	  0<AL<0FFH means return country table for country AL
  7541                                  ;	  AL = 0FF means return country table for country BX
  7542                                  ;	  No Carry:
  7543                                  ;	     Register BX will contain the 16-bit country code.
  7544                                  ;	     Register AL will contain the low 8 bits of the country code.
  7545                                  ;	     The block pointed to by DS:DX is filled in with the information
  7546                                  ;	     for the particular country.
  7547                                  ;		BYTE  Size of this table excluding this byte and the next
  7548                                  ;		BYTE  Country code represented by this table
  7549                                  ;			A sequence of n bytes, where n is the number specified
  7550                                  ;			by the first byte above and is not > internat_block_max,
  7551                                  ;			in the correct order for being returned by the
  7552                                  ;			INTERNATIONAL call as follows:
  7553                                  ;		WORD	Date format 0=mdy, 1=dmy, 2=ymd
  7554                                  ;		5 BYTE	Currency symbol null terminated
  7555                                  ;		2 BYTE	thousands separator null terminated
  7556                                  ;		2 BYTE	Decimal point null terminated
  7557                                  ;		2 BYTE	Date separator null terminated
  7558                                  ;		2 BYTE	Time separator null terminated
  7559                                  ;		1 BYTE	Bit field.  Currency format.
  7560                                  ;			Bit 0.	=0 $ before #  =1 $ after #
  7561                                  ;			Bit 1.	no. of spaces between # and $ (0 or 1)
  7562                                  ;		1 BYTE	No. of significant decimal digits in currency
  7563                                  ;		1 BYTE	Bit field.  Time format.
  7564                                  ;			Bit 0.	=0 12 hour clock  =1 24 hour
  7565                                  ;		DWORD	Call address of case conversion routine
  7566                                  ;		2 BYTE	Data list separator null terminated.
  7567                                  ;	  Carry:
  7568                                  ;	     Register AX has the error code.
  7569                                  ;	IF DX = -1 on input (set current country)
  7570                                  ;	  AL = 0 is an error
  7571                                  ;	  0<AL<0FFH means set current country to country AL
  7572                                  ;	  AL = 0FF means set current country to country BX
  7573                                  ;	  No Carry:
  7574                                  ;	    Current country SET
  7575                                  ;	    Register AL will contain the low 8 bits of the country code.
  7576                                  ;	  Carry:
  7577                                  ;	     Register AX has the error code.
  7578                                  ;-----------------------------------------------------------------------------
  7579                                  
  7580                                  ;procedure   $INTERNATIONAL,NEAR   ; DOS 3.3
  7581                                  
  7582                                  ; 13/05/2019 - Retro DOS v4.0
  7583                                  ; DOSCODE:4A4Dh (MSDOS 6.21, MSDOS.SYS)
  7584                                  
  7585                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  7586                                  ; DOSCODE:4A40h (MSDOS 5.0, MSDOS.SYS)
  7587                                  
  7588                                  ; 06/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 PCDOS.COM)
  7589                                  ; DOSCODE:4B8Dh (PCDOS 7.1, IBMDOS.COM)
  7590                                  
  7591                                  _$INTERNATIONAL:  ; IBMDOS.COM (MSDOS 3.3), offset 1992h
  7592                                  	 
  7593 00000CA7 3CFF                    	CMP	AL,0FFH
  7594 00000CA9 7404                    	JZ	short BX_HAS_CODE	; -1 means country code is in BX
  7595 00000CAB 88C3                    	MOV	BL,AL			; Put AL country code in BX
  7596 00000CAD 30FF                    	XOR	BH,BH
  7597                                  BX_HAS_CODE:
  7598 00000CAF 1E                      	PUSH	DS
  7599 00000CB0 07                      	POP	ES
  7600 00000CB1 52                      	PUSH	DX
  7601 00000CB2 5F                      	POP	DI			; User buffer to ES:DI
  7602                                  
  7603                                  ;hkn; SS is DOSDATA
  7604                                  ;	context DS
  7605                                  
  7606 00000CB3 16                      	push	ss
  7607 00000CB4 1F                      	pop	ds
  7608                                  
  7609 00000CB5 83FFFF                  	CMP	DI,-1
  7610 00000CB8 745D                    	JZ	short international_set
  7611 00000CBA 09DB                    	OR	BX,BX
  7612 00000CBC 7505                    	JNZ	short international_find
  7613                                  
  7614                                  ;hkn; country_cdpg is in DOSDATA segment.
  7615 00000CBE BE[3611]                	MOV	SI,COUNTRY_CDPG
  7616                                  
  7617 00000CC1 EB39                    	JMP	SHORT international_copy
  7618                                  
  7619                                  international_find:
  7620                                  	;MOV	BP,0			 ; flag it for GetCntry only
  7621                                  	; 06/01/2024
  7622 00000CC3 31ED                    	xor	bp,bp ; 0
  7623 00000CC5 E80A00                  	CALL	international_get
  7624 00000CC8 7255                    	JC	short errtn
  7625                                  	;CMP	BX,0			 ; nlsfunc finished it ?
  7626                                  	; 06/01/2024
  7627 00000CCA 09DB                    	or	bx,bx
  7628 00000CCC 752E                    	JNZ	SHORT international_copy ; no, copy by myself
  7629 00000CCE 89D3                    	MOV	BX,DX			 ; put country back
  7630 00000CD0 EB3A                    	JMP	SHORT international_ok3
  7631                                  
  7632                                  international_get:
  7633 00000CD2 BE[3611]                	MOV	SI,COUNTRY_CDPG
  7634                                  
  7635                                  ;hkn; country_cdpg is in DOSDATA segment.
  7636                                  ;hkn; use ss override to access COUNTRY_CDPG fields
  7637                                  
  7638                                  	; MSDOS 3.3
  7639                                  	;;cmp	bx,[SI+63h]
  7640                                  	;CMP	BX,[SI+DOS_CCDPG.ccDosCountry]
  7641                                  	;jz	short RET27
  7642                                  
  7643                                  	; 13/05/2019 - Retro DOS v4.0
  7644                                  
  7645                                  	; MSDOS 6.0
  7646                                  	;cmp	bx,[ss:si+68h]
  7647 00000CD5 363B5C68                	CMP	BX,[ss:SI+DOS_CCDPG.ccDosCountry] ; = current country id
  7648 00000CD9 74CB                    	jz	short RET27			; return if equal
  7649                                  
  7650 00000CDB 89DA                    	MOV	DX,BX
  7651 00000CDD 31DB                    	XOR	BX,BX			; bx = 0, default code page
  7652                                  	;CallInstall NLSInstall,NLSFUNC,0 ; check if NLSFUNC in memory
  7653 00000CDF B80014                  	mov	ax,1400h
  7654 00000CE2 CD2F                    	int     2Fh	; - Multiplex - NLSFUNC.COM - INSTALLATION CHECK
  7655                                  			; Return: AL = 00h not installed, OK to install
  7656                                  			; 01h not installed, not OK
  7657                                  			; FFh installed
  7658 00000CE4 3CFF                    	CMP	AL,0FFH
  7659 00000CE6 7510                    	JNZ	short interr		; not in memory
  7660                                  	
  7661                                  	; 06/01/2024
  7662 00000CE8 B80314                  	mov	ax,1403h		; set country info
  7663                                  
  7664                                  	;cmp	bp,0
  7665 00000CEB 09ED                    	or	bp,bp			; GetCntry ?
  7666 00000CED 7501                    	JNZ	short stcdpg
  7667                                  	
  7668                                  	;CallInstall GetCntry,NLSFUNC,4	; get country info
  7669                                  	;mov	ax,1404h
  7670 00000CEF 40                      	inc	ax	; AX = 1404h ; get country info
  7671                                  
  7672                                  	; 06/01/2024
  7673                                  	;int	2Fh	; - Multiplex - NLSFUNC.COM - GET COUNTRY INFO
  7674                                  	;		; BX = code page, DX = country code,
  7675                                  	;		; DS:SI -> internal code page structure
  7676                                  	;		; ES:DI -> user buffer
  7677                                  	;		; Return: AL = status
  7678                                  	;
  7679                                  	;JMP	short chkok
  7680                                  	
  7681                                  	;nop
  7682                                  
  7683                                  stcdpg:
  7684                                  	;CallInstall SetCodePage,NLSFUNC,3  ; set country info
  7685                                  	; 06/01/2024
  7686                                  	;mov     ax,1403h
  7687                                  gscdpg:
  7688 00000CF0 CD2F                    	int     2Fh	; - Multiplex - NLSFUNC.COM - SET COUNTRY INFO
  7689                                  			; DS:SI -> internal code page structure
  7690                                  			; BX = code page, DX = country code
  7691                                  			; Return: AL = status
  7692                                  chkok:
  7693 00000CF2 08C0                    	or	al,al			; success ?
  7694                                  	;retz				; yes
  7695 00000CF4 74B0                    	jz	short RET27
  7696                                  
  7697                                  setcarry:
  7698 00000CF6 F9                      	STC				; set carry
  7699 00000CF7 C3                      	retn
  7700                                  interr:
  7701 00000CF8 B0FF                    	MOV	AL,0FFH			; flag nlsfunc error
  7702 00000CFA EBFA                    	JMP	short setcarry
  7703                                  
  7704                                  international_copy:
  7705                                  
  7706                                  ;hkn; country_cdpg is in DOSDATA segment.
  7707                                  ;hkn; use ss override to access COUNTRY_CDPG fields
  7708                                  
  7709                                  	; MSDOS 3.3
  7710                                  	;;mov	bx,[SI+63h]
  7711                                  	;mov	BX,[SI+DOS_CCDPG.ccDosCountry]
  7712                                  	;mov	SI,COUNTRY_CDPG+DOS_CCDPG.ccDFormat ; 08/09/2018
  7713                                  
  7714                                  	; 13/05/2019 - Retro DOS v4.0
  7715                                  
  7716                                  	; MSDOS 6.0
  7717                                  	;mov	bx,[ss:si+68h]
  7718 00000CFC 368B5C68                	MOV	BX,[ss:SI+DOS_CCDPG.ccDosCountry] ; = current country id
  7719 00000D00 BE[A211]                	MOV	SI,COUNTRY_CDPG+DOS_CCDPG.ccDFormat ; COUNTRY_CDPG + 108
  7720                                  
  7721                                  	;mov	cx,24
  7722 00000D03 B91800                  	MOV	CX,OLD_COUNTRY_SIZE
  7723                                  
  7724                                  	; MSDOS 6.0
  7725                                  
  7726                                  ;hkn;	must set up DS to SS so that international info can be copied
  7727                                  	
  7728 00000D06 1E                      	push	ds
  7729                                  
  7730 00000D07 16                      	push	ss			; cs -> ss
  7731 00000D08 1F                      	pop	ds
  7732                                  
  7733 00000D09 F3A4                    	REP	MOVSB			; copy country info
  7734                                  
  7735                                  	; MSDOS 6.0
  7736                                  
  7737 00000D0B 1F                      	pop	ds	;hkn;	restore ds
  7738                                  
  7739                                  international_ok3:
  7740 00000D0C E868F7                  	call	Get_User_Stack
  7741                                  ;ASSUME	DS:NOTHING
  7742                                  	;;MOV	[SI+2],BX
  7743                                  	;MOV	[SI+user_env.user_BX],BX
  7744                                  	; 26/06/2024 (PCDOS 7.1 IBMDOS.COM)
  7745 00000D0F E885FF                  	call	set_user_bx
  7746                                  international_ok:
  7747 00000D12 89D8                    	MOV	AX,BX			; Return country code in AX too.
  7748                                  ;SYS_RET_OK_jmp:
  7749                                  	; 05/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  7750                                  	; 09/01/2024
  7751                                  ;nono:	; 15/12/2022
  7752                                  SYS_RET_OK_jmp:
  7753 00000D14 E954F9                  	jmp	SYS_RET_OK
  7754                                  
  7755                                  international_set:
  7756                                  
  7757                                  ;hkn; ASSUME	DS:DOSGROUP
  7758                                  ;ASSUME	DS:DOSDATA
  7759                                  
  7760 00000D17 BD0100                  	MOV	BP,1			; flag it for SetCodePage only
  7761 00000D1A E8B5FF                  	CALL	international_get
  7762 00000D1D 73F3                    	JNC	short international_ok
  7763                                  errtn:
  7764 00000D1F 3CFF                    	CMP	AL,0FFH
  7765 00000D21 7403                    	JZ	short errtn2
  7766                                  errtn1:
  7767 00000D23 E94FF9                  	jmp	SYS_RET_ERR		; return what we got from NLSFUNC
  7768                                  errtn2:
  7769                                  	;error	error_invalid_function	; NLSFUNC not existent
  7770                                  
  7771                                  	;mov	al,1
  7772 00000D26 B001                    	mov	al,error_invalid_function
  7773 00000D28 EBF9                    	jmp	short errtn1 ; 13/05/2019 - Retro DOS v4.0
  7774                                  ;errtn3:
  7775                                  ;	jmp	SYS_RET_ERR
  7776                                  
  7777                                  ;EndProc $INTERNATIONAL
  7778                                  
  7779                                  
  7780                                  ; ---------------------------------------------------------------------------
  7781                                  
  7782                                  	; 06/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 PCDOS.COM)
  7783                                  	; DOSCODE:4C10h (PCDOS 7.1, IBMDOS.COM)
  7784                                  
  7785                                  _$ExtCountryInfo:
  7786                                  			; INT 21h, AH = 70h
  7787                                  			; GET/SET INTERNATIONALIZATION INFORMATION
  7788                                  			; ****
  7789                                  			; AL = subfunction
  7790                                  			; 00h SET general internationalization info
  7791                                  			;    CX = buffer size (up to 38 bytes)
  7792                                  			;    DS:SI -> buffer containing internationalization info
  7793                                  			;  first three bytes are skipped, the rest is copied to
  7794                                  			;  somewhere in the DOS data segment
  7795                                  			; 01h SET extended internationalization info
  7796                                  			;    CX = number of bytes to set (up to 58 bytes)
  7797                                  			;    DS:SI -> buffer containing internationalization info
  7798                                  			; 02h GET extended internationalization info
  7799                                  			;    CX = buffer size in bytes (up to 58 bytes used)
  7800                                  			;    ES:DI -> buffer
  7801                                  			; ****
  7802                                  			; (Ref: Ralf Brown's Interrupt List) - had some mistakes -
  7803 00000D2A 3C02                    	cmp	al,2 
  7804 00000D2C 77F8                    	ja	short errtn2
  7805 00000D2E 06                      	push    es
  7806 00000D2F 16                      	push    ss
  7807 00000D30 750F                    	jnz	short ext_cntry_inf_1
  7808 00000D32 07                      	pop	es		; AX = GET 35 bytes info (from offset 3 to 37)
  7809                                  				; (38 bytes buffer is used)
  7810 00000D33 BF[9E11]                	mov	di,_COUNTRY_ID
  7811 00000D36 268B45FE                	mov	ax,[es:di-2]	; NEW_COUNTRY_SIZE = 38
  7812 00000D3A BB0300                  	mov	bx,3		; skip the 1st 3 bytes of the buffer
  7813 00000D3D 01DE                    	add	si,bx
  7814 00000D3F EB13                    	jmp	short ext_cntry_inf_4
  7815                                  
  7816                                  ext_cntry_inf_1:
  7817 00000D41 FEC8                    	dec	al
  7818 00000D43 7506                    	jnz	short ext_cntry_inf_2 ; AX = 2
  7819                                  				; AX = 1 (set)
  7820 00000D45 07                      	pop	es
  7821 00000D46 BF[C611]                	mov	di,_ENU		; "ENU"
  7822 00000D49 EB04                    	jmp	short ext_cntry_inf_3
  7823                                  
  7824                                  ext_cntry_inf_2:
  7825 00000D4B 1F                      	pop	ds		; AX = 2 (get)
  7826 00000D4C BE[C611]                	mov	si,_ENU		; "ENU"
  7827                                  
  7828                                  ext_cntry_inf_3:		; CODE XREF: DOSCODE:4C2F^j
  7829 00000D4F 31DB                    	xor	bx,bx		; 0
  7830 00000D51 B83A00                  	mov	ax,58		; 3Ah
  7831                                  
  7832                                  ext_cntry_inf_4:
  7833 00000D54 39C1                    	cmp	cx,ax		; > 38 ? (58)
  7834                                  	;jb	short ext_cntry_inf_5 ; no
  7835 00000D56 7602                    	jna	short ext_cntry_inf_5 ; 06/01/2024
  7836 00000D58 89C1                    	mov	cx,ax		; yes, decrease size to 38 (58)
  7837                                  
  7838                                  ext_cntry_inf_5:
  7839 00000D5A 89C8                    	mov	ax,cx		; buffer (filled) size
  7840 00000D5C 29D9                    	sub	cx,bx		; copy byte count
  7841 00000D5E F3A4                    	rep movsb
  7842 00000D60 07                      	pop	es
  7843 00000D61 E91D03                  	jmp	ret_ax_to_user_cx ; ax -> user's cx
  7844                                  
  7845                                  ; ---------------------------------------------------------------------------
  7846                                  
  7847                                  ; 19/07/2018
  7848                                  
  7849                                  ;BREAK <$GetExtCntry - return extended country-dependent information>
  7850                                  
  7851                                  ;----------------------------------------------------------------------------
  7852                                  ;
  7853                                  ; Procedure Name : $GetExtCntry
  7854                                  ;
  7855                                  ; Inputs:
  7856                                  ;	if AL >= 20H
  7857                                  ;	  AL= 20H    capitalize single char, DL= char
  7858                                  ;	      21H    capitalize string, CX= string length
  7859                                  ;	      22H    capitalize ASCIIZ string
  7860                                  ;	      23H    YES/NO check, DL=1st char DH= 2nd char (DBCS)
  7861                                  ;	      80H bit 0 = use normal upper case table
  7862                                  ;		      1 = use file upper case table
  7863                                  ;	   DS:DX points to string
  7864                                  ;
  7865                                  ;	else
  7866                                  ;
  7867                                  ;	MOV	AH,GetExtCntry	 ; DOS 3.3
  7868                                  ;	MOV	AL,INFO_ID	( info type,-1 selects all )
  7869                                  ;	MOV	BX,CODE_PAGE	( -1 = active code page )
  7870                                  ;	MOV	DX,COUNTRY_ID	( -1 = active country )
  7871                                  ;	MOV	CX,SIZE 	( amount of data to return )
  7872                                  ;	LES	DI,COUNTRY_INFO ( buffer for returned data )
  7873                                  ;	INT	21
  7874                                  ; Function:
  7875                                  ;	give users extended country dependent information
  7876                                  ;	or capitalize chars
  7877                                  ; Outputs:
  7878                                  ;	  No Carry:
  7879                                  ;	     extended country info is succesfully returned
  7880                                  ;	  Carry:
  7881                                  ;	     Register AX has the error code.
  7882                                  ;	     AX=0, NO	 for YES/NO CHECK
  7883                                  ;		1, YES
  7884                                  ;----------------------------------------------------------------------------
  7885                                  
  7886                                  ;procedure   $GetExtCntry,NEAR	; DOS 3.3
  7887                                  
  7888                                  	; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  7889                                  	; 06/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  7890                                  
  7891                                  	; MSDOS 6.0
  7892                                  _$GetExtCntry:
  7893 00000D64 3C20                    	CMP	AL,CAP_ONE_CHAR 	; < 20H ?
  7894 00000D66 726A                    	JB	short notcap
  7895                                  capcap: 				;
  7896 00000D68 A880                    	TEST	AL,UPPER_TABLE	; 80h	; which upper case table
  7897 00000D6A 7505                    	JNZ	short fileupper		; file upper case
  7898                                  
  7899                                  ;hkn; UCASE_TAB in DOSDATA
  7900 00000D6C BB[FC0A]                	MOV	BX,UCASE_TAB+2		; get normal upper case
  7901 00000D6F EB05                    	JMP	SHORT capit
  7902                                  
  7903                                  fileupper:
  7904                                  	; 06/01/2024 (PCDOS 7.1 IBMDOS.COM - DOSCODE:4C57h)
  7905                                  	; ((Note: This must be a bugfix, because bit 7 of AX is 1 here!))
  7906                                  	; AL >= 80h
  7907 00000D71 247F                    	and	al,7Fh 
  7908                                  
  7909                                  ;hkn; FILE_UCASE_TAB in DOSDATA
  7910 00000D73 BB[7E0B]                	MOV	BX,FILE_UCASE_TAB+2 ; get file upper case
  7911                                  capit:					;
  7912 00000D76 3C20                    	CMP	AL,CAP_ONE_CHAR ; 20h	; cap one char ?
  7913 00000D78 750D                    	JNZ	short chkyes		; no
  7914 00000D7A 88D0                    	MOV	AL,DL			; set up AL
  7915 00000D7C E8E34C                  	call	GETLET3 		; upper case it
  7916 00000D7F E8F5F6                  	call	Get_User_Stack		; get user stack
  7917                                  	;mov	[si+6],al
  7918 00000D82 884406                  	MOV	[SI+user_env.user_DX],AL ; user's DL=AL
  7919 00000D85 EB24                    	JMP	SHORT nono		; done
  7920                                  chkyes: 				;
  7921 00000D87 3C23                    	CMP	AL,CHECK_YES_NO	; 23h	; check YES or NO ?
  7922 00000D89 7523                    	JNZ	short capstring		; no
  7923                                  
  7924 00000D8B 31C0                    	XOR	AX,AX			; presume NO
  7925                                  		      
  7926                                  ;hkn; NLS_YES, NLS_NO, NLS_yes2, NLS_no2 is defined in msdos.cl3 which is
  7927                                  ;hkn; included in yesno.asm in the DOSCODE segment.
  7928                                  
  7929                                  	; 06/08/2018 - Retro DOS v3.0
  7930                                  	; 13/05/2019 - Retro DOS v4.0
  7931                                  	;cmp	dl,'Y'
  7932 00000D8D 2E3A16[4212]            	CMP	DL,[cs:NLS_YES]		; is 'Y' ?
  7933 00000D92 7416                    	JZ	short yesyes		; yes
  7934                                  	;cmp	dl,'y'
  7935 00000D94 2E3A16[4412]            	CMP	DL,[cs:NLS_yes2]	; is 'y' ?
  7936 00000D99 740F                    	JZ	short yesyes		; yes
  7937                                  	;cmp	dl,'N'
  7938 00000D9B 2E3A16[4312]            	CMP	DL,[cs:NLS_NO]		; is  'N'?
  7939 00000DA0 7409                    	JZ	short nono		; no
  7940                                  	;cmp	dl,'n'
  7941 00000DA2 2E3A16[4512]            	CMP	DL,[cs:NLS_no2]		; is 'n' ?
  7942 00000DA7 7402                    	JZ	short nono		; no
  7943                                  ;dbcs_char:				;
  7944 00000DA9 40                      	INC	AX			; not YES or NO
  7945                                  yesyes: 				;
  7946 00000DAA 40                      	INC	AX			; return 1
  7947                                  	; 15/12/2022
  7948                                  	; 09/01/2024 - Retro DOS v5.0
  7949                                  nono:	
  7950                                  	;jmp	short SYS_RET_OK_jmp	;
  7951                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  7952                                  	; 09/01/2024
  7953 00000DAB E9BDF8                  	jmp	SYS_RET_OK		; done
  7954                                  
  7955                                  capstring:				;
  7956 00000DAE 89D6                    	MOV	SI,DX			; si=dx
  7957 00000DB0 3C21                    	CMP	AL,CAP_STRING	; 21h	; cap string ?
  7958 00000DB2 750D                    	JNZ	short capascii		; no
  7959                                  	;OR	CX,CX			; check count 0
  7960                                  	;JZ	short nono		; yes finished
  7961                                  	; 06/01/2024
  7962 00000DB4 E3F5                    	jcxz	nono
  7963                                  concap: 				;
  7964 00000DB6 AC                      	LODSB				; get char
  7965 00000DB7 E8A84C                  	call	GETLET3 		; upper case it
  7966 00000DBA 8844FF                  	MOV	byte [SI-1],AL		; store back
  7967                                  ;next99: 				;
  7968 00000DBD E2F7                    	LOOP	concap			; continue
  7969 00000DBF EBEA                    	JMP	short nono		; done
  7970                                  capascii:				;
  7971 00000DC1 3C22                    	CMP	AL,CAP_ASCIIZ	; 22h	; cap ASCIIZ string ?
  7972 00000DC3 7573                    	JNZ	short capinval		; no
  7973                                  concap2:				;
  7974 00000DC5 AC                      	LODSB				; get char
  7975 00000DC6 08C0                    	or	al,al			; end of string ?
  7976 00000DC8 74E1                    	JZ	short nono		; yes
  7977 00000DCA E8954C                  	call	GETLET3 		; upper case it
  7978 00000DCD 8844FF                  	MOV	[SI-1],AL		; store back
  7979 00000DD0 EBF3                    	JMP	short concap2 		; continue
  7980                                  
  7981                                  	; MSDOS 3.3 (& MSDOS 6.0)
  7982                                  
  7983                                  ; Offset 1A19h in IBMDOS.COM (MSDOS 3.3), 1987 	
  7984                                  ; _$GetExtCntry:
  7985                                  
  7986                                  notcap:
  7987 00000DD2 83F905                  	CMP	CX,5			; minimum size is 5
  7988                                  	;jb	short sizeerror
  7989                                  	; 09/01/2024
  7990 00000DD5 7261                    	jb	short capinval		; (size error)
  7991                                  
  7992                                  GEC_CONT:
  7993                                  ;hkn; SS is DOSDATA
  7994                                  	;context DS
  7995                                  
  7996 00000DD7 16                      	push	ss
  7997                                  	;pop	es  ; ! (Retro DOS v3.0 BUG) !
  7998 00000DD8 1F                      	pop	ds  ; 13/05/2019 - Retro DOS v4.0	
  7999                                  	
  8000                                  ;hkn; COUNTRY_CDPG is in DOSDATA
  8001 00000DD9 BE[3611]                	MOV	SI,COUNTRY_CDPG
  8002                                  
  8003                                  ; ------------------------------------------------------------
  8004                                  	; 06/01/2024 - Retro DOS v5.0
  8005                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:4CC6h
  8006                                  	;;;
  8007 00000DDC 08C0                    	or	al,al
  8008 00000DDE 752A                    	jnz	short GETCNTRY
  8009                                  			; AL = 0 (INT 21h, AX=6500h)
  8010                                  			; Set extended country-dependent information
  8011                                  			; (SET GENERAL INTERNATIONALIZATION INFO)
  8012                                  
  8013 00000DE0 83E907                  	sub	cx,7		; minimum 8 bytes
  8014 00000DE3 7653                    	jbe	short capinval	; error_invalid_function
  8015 00000DE5 8B5C48                  	mov	bx,[si+48h]	; [SI+DOS_CCDPG.ccSysCodePage]
  8016 00000DE8 8D7466                  	lea	si,[si+66h]	; SI+DOS_CCDPG.ccCountryInfoLen
  8017 00000DEB 8B04                    	mov	ax,[si]
  8018 00000DED 83E804                  	sub	ax,4
  8019 00000DF0 39C1                    	cmp	cx,ax
  8020 00000DF2 7602                    	jbe	short set_intern_inf
  8021 00000DF4 89C1                    	mov	cx,ax
  8022                                  set_intern_inf:
  8023 00000DF6 89C8                    	mov	ax,cx
  8024 00000DF8 83C004                  	add	ax,4
  8025 00000DFB 26894501                	mov	[es:di+1], ax	; info length/size (will be written)
  8026 00000DFF 83C606                  	add	si,6		; DOS_CCDPG.ccDFormat
  8027 00000E02 83C707                  	add	di,7		; points to date format
  8028 00000E05 E8B209                  	call	XCHGP		; ds:si = user's buffer + 6
  8029                                  				; es:di = country info buffer + 7
  8030 00000E08 EB3F                    	jmp	short OK_RETN
  8031                                  	;;;
  8032                                  ; ------------------------------------------------------------
  8033                                  	
  8034                                  	; 06/01/2024
  8035                                  GETCNTRY:
  8036 00000E0A 83FAFF                  	CMP	DX,-1 ; COUNTRY_ID	; active country ?
  8037 00000E0D 7503                    	JNZ	short GETCDPG 		; no
  8038                                  
  8039                                  ;hkn; use DS override to accesss country_cdpg fields
  8040                                  	;;mov	dx,[si+63h] ; MSDOS 3.3
  8041                                  	;mov	dx,[si+68h] ; MSDOS 6.0
  8042 00000E0F 8B5468                  	MOV	DX,[SI+DOS_CCDPG.ccDosCountry]
  8043                                  					; get active country id;smr;use DS
  8044                                  GETCDPG:
  8045 00000E12 83FBFF                  	CMP	BX,-1 ; CODE_PAGE	; active code page?
  8046 00000E15 7503                    	JNZ	short CHKAGAIN		; no, check again
  8047                                  
  8048                                  ;hkn; use DS override to accesss country_cdpg fields
  8049                                  	;;mov	bx,[si+65h] ; MSDOS 3.3	
  8050                                  	;mov	bx,[si+6Ah] ; MSDOS 6.0
  8051 00000E17 8B5C6A                  	MOV	BX,[SI+DOS_CCDPG.ccDosCodePage]
  8052                                  					; get active code page id;smr;Use DS
  8053                                  CHKAGAIN:
  8054                                  	;cmp	dx,[si+68h] ; MSDOS 6.0
  8055 00000E1A 3B5468                  	CMP	DX,[SI+DOS_CCDPG.ccDosCountry]
  8056                                  					; same as active country id?;smr;use DS
  8057 00000E1D 7550                    	JNZ	short CHKNLS		; no
  8058                                  	;cmp	bx,[si+6Ah] ; MSDOS 6.0	
  8059 00000E1F 3B5C6A                  	CMP	BX,[SI+DOS_CCDPG.ccDosCodePage]	
  8060                                  					; same as active code pg id?;smr;use DS
  8061 00000E22 754B                    	JNZ	short CHKNLS		; no
  8062                                  CHKTYPE:
  8063                                  	;mov	bx,[si+48h]
  8064 00000E24 8B5C48                  	MOV	BX,[SI+DOS_CCDPG.ccSysCodePage]	
  8065                                  					; bx = sys code page id;smr;use DS
  8066 00000E27 51                      	PUSH	CX			; save cx
  8067                                  	;mov	cx,[si+4Ah]
  8068 00000E28 8B4C4A                  	MOV	CX,[SI+DOS_CCDPG.ccNumber_of_entries]  ;smr;use DS
  8069                                  	;mov	si,COUNTRY_CDPG+76
  8070 00000E2B BE[8211]                	MOV	SI,COUNTRY_CDPG+DOS_CCDPG.ccSetUcase   ;smr;CDPG in DOSDATA
  8071                                  NXTENTRY:
  8072 00000E2E 3A04                    	CMP	AL,[SI] 		; compare info type;smr;use DS
  8073 00000E30 740B                    	JZ	short FOUNDIT
  8074 00000E32 83C605                  	ADD	SI,5			; next entry
  8075 00000E35 E2F7                    	LOOP	NXTENTRY
  8076 00000E37 59                      	POP	CX
  8077                                  capinval:
  8078                                  	;error	error_invalid_function	; info type not found
  8079                                  	;mov	al,1
  8080 00000E38 B001                    	mov	al,error_invalid_function
  8081                                  ;SYS_RET_ERR_jmp:
  8082                                  	;jmp	SYS_RET_ERR
  8083                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8084                                  SYS_RET_ERR_jmp:
  8085 00000E3A E938F8                  	jmp	SYS_RET_ERR	
  8086                                  
  8087                                  FOUNDIT:
  8088 00000E3D A4                      	MOVSB				; move info id byte
  8089 00000E3E 59                      	POP	CX			; restore char count
  8090                                  	;cmp	al,1
  8091 00000E3F 3C01                    	CMP	AL,SetCountryInfo	; select country info type ?
  8092 00000E41 7415                    	JZ	short setsize
  8093 00000E43 B90400                  	MOV	CX,4			; 4 bytes will be moved
  8094 00000E46 B80500                  	MOV	AX,5			; 5 bytes will be returned in CX
  8095                                  OK_RETN:
  8096 00000E49 F3A4                    	REP	MOVSB			; copy info
  8097 00000E4B 89C1                    	MOV	CX,AX			; CX = actual length returned
  8098 00000E4D 89D8                    	MOV	AX,BX			; return sys code page in ax
  8099                                  GETDONE:
  8100 00000E4F E825F6                  	call	Get_User_Stack		; return actual length to user's CX
  8101                                  	;mov	[si+4],cx 
  8102 00000E52 894C04                  	MOV	[SI+user_env.user_CX],CX
  8103                                  	;jmp	SYS_RET_OK
  8104                                  	; 15/12/2022
  8105                                  	; 25/06/2019
  8106 00000E55 E916F8                  	jmp	SYS_RET_OK_clc
  8107                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8108                                  	; 15/12/2022
  8109                                  ;nono_jmp:
  8110                                  	;jmp	short nono
  8111                                  setsize:
  8112 00000E58 83E903                  	SUB	CX,3			; size after length field
  8113 00000E5B 390C                    	CMP	[SI],CX			; less than table size ;smr;use ds
  8114 00000E5D 7302                    	JAE	short setsize2		; no
  8115 00000E5F 8B0C                    	MOV	CX,[SI]			; truncate to table size ;smr;use ds
  8116                                  setsize2:
  8117 00000E61 26890D                  	MOV	[ES:DI],CX		; copy actual length to user's buffer
  8118                                  	;ADD	DI,2			; update index
  8119                                  	;ADD	SI,2
  8120                                  	; 06/01/2024
  8121 00000E64 47                      	inc	di
  8122 00000E65 47                      	inc	di
  8123 00000E66 46                      	inc	si
  8124 00000E67 46                      	inc	si
  8125 00000E68 89C8                    	MOV	AX,CX
  8126 00000E6A 83C003                  	ADD	AX,3			; AX has the actual length
  8127 00000E6D EBDA                    	JMP	short OK_RETN 		; go move it
  8128                                  CHKNLS:
  8129 00000E6F 30E4                    	XOR	AH,AH
  8130                                  	;PUSH	AX			; save info type
  8131                                  	;POP	BP			; bp = info type
  8132                                  	; 06/01/2024
  8133 00000E71 89C5                    	mov	bp,ax
  8134                                  
  8135                                  	;CallInstall NLSInstall,NLSFUNC,0 ; check if NLSFUNC in memory
  8136 00000E73 B80014                  	mov     ax,1400h
  8137 00000E76 CD2F                    	int     2Fh     ; - Multiplex - NLSFUNC.COM - INSTALLATION CHECK
  8138                                  			; Return: AL = 00h not installed, OK to install
  8139                                  			; 01h not installed, not OK
  8140                                  			; FFh installed
  8141 00000E78 3CFF                    	CMP	AL,0FFH
  8142 00000E7A 7402                    	JZ	short NLSNXT		; in memory
  8143                                  
  8144                                  sizeerror:
  8145                                  	; 09/01/2024 - Retro DOS v5.0
  8146                                  	;
  8147                                  ;	;error	error_invalid_function
  8148                                  ;	;mov	al,1
  8149                                  ;	mov	al,error_invalid_function
  8150                                  ;	;jmp	SYS_RET_ERR
  8151                                  ;	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8152                                  ;sys_ret_err_jmp2:
  8153                                  ;	jmp	short SYS_RET_ERR_jmp
  8154                                  	; 09/01/2024
  8155 00000E7C EBBA                    	jmp	short capinval
  8156                                  
  8157                                  NLSNXT: 
  8158                                  	;CallInstall GetExtInfo,NLSFUNC,2 ;get extended info
  8159 00000E7E B80214                  	mov     ax,1402h
  8160 00000E81 CD2F                    	int     2Fh	; - Multiplex - NLSFUNC.COM - GET COUNTRY INFO
  8161                                  			; BP = subfunction, BX = code page
  8162                                  			; DX = country code, DS:SI -> internal code page structure
  8163                                  			; ES:DI -> user buffer, CX = size of user buffer
  8164                                  			; Return: AL = status
  8165                                  			; 00h successful
  8166                                  			; else DOS error code
  8167                                  
  8168 00000E83 3C00                    	CMP	AL,0			; success ?
  8169 00000E85 7505                    	JNZ	short NLSERROR
  8170                                  	;mov	ax,[si+48h] ; 13/05/2019 
  8171 00000E87 8B4448                  	MOV	AX,[SI+DOS_CCDPG.ccSysCodePage]
  8172                                  			; ax = sys code page id;smr;use ds;
  8173                                  			;BUGBUG;check whether DS is OK after the above calls
  8174 00000E8A EBC3                    	JMP	short GETDONE
  8175                                  seterr:
  8176                                  	; 15/12/2022
  8177                                  NLSERROR:
  8178                                  	;jmp	SYS_RET_ERR		; return what is got from NLSFUNC
  8179                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8180                                  	;jmp	short sys_ret_err_jmp2
  8181                                  	; 15/12/2022
  8182 00000E8C EBAC                    	jmp	short SYS_RET_ERR_jmp
  8183                                  
  8184                                  ;EndProc $GetExtCntry
  8185                                  
  8186                                  ; 13/05/2019 - Retro DOS v4.0
  8187                                  ; DOSCODE:4BD6h (MSDOS 6.21, MSDOS.SYS)
  8188                                  
  8189                                  ;BREAK <$GetSetCdPg - get or set global code page>
  8190                                  ;----------------------------------------------------------------------------
  8191                                  ;**	$GetSetCdPg - Get or Set Global Code Page
  8192                                  ;
  8193                                  ;   System call format:
  8194                                  ;
  8195                                  ;	MOV	AH,GetSetCdPg	; DOS 3.3
  8196                                  ;	MOV	AL,n		; n = 1 : get code page, n = 2 : set code page
  8197                                  ;	MOV	BX,CODE_PAGE	(set code page only)
  8198                                  ;	INT	21
  8199                                  ;
  8200                                  ;	ENTRY	(al) = n
  8201                                  ;		(bx) = code page
  8202                                  ;	EXIT	'C' clear
  8203                                  ;		  global code page is set	(set global code page)
  8204                                  ;		  (BX) = active code page id	(get global code page)
  8205                                  ;		  (DX) = system code page id	(get global code page)
  8206                                  ;		'C' set
  8207                                  ;		  (AX) = error code
  8208                                  
  8209                                  ;procedure  $GetSetCdPg,NEAR   ; DOS 3.3
  8210                                  
  8211                                  	; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  8212                                  	; DOSCODE:4BC9h
  8213                                  
  8214                                  	; 06/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  8215                                  	; DOSCODE:4D73h
  8216                                  
  8217                                  _$GetSetCdPg:
  8218                                  
  8219                                  ;hkn; SS is DOSDATA
  8220                                  	;context DS
  8221                                  
  8222 00000E8E 16                      	push	ss
  8223 00000E8F 1F                      	pop	ds
  8224                                  
  8225                                  ;hkn; COUNTRY_CDPG is in DOSDATA
  8226 00000E90 BE[3611]                	MOV	SI,COUNTRY_CDPG	  ; (DOSDATA:122Ah for MSDOS 6.21)
  8227                                  
  8228 00000E93 3C01                    	CMP	AL,1		       ; get global code page
  8229 00000E95 7512                    	JNZ	short setglpg 	       ; set global code page
  8230                                  	
  8231                                  	;;mov	bx,[si+65h] ; MSDOS 3.3
  8232                                  	;mov	bx,[si+6Ah] ; MSDOS 6.0
  8233 00000E97 8B5C6A                  	MOV	BX,[SI+DOS_CCDPG.ccDosCodePage]
  8234                                  					; get active code page id;smr;use ds
  8235                                  	;mov	dx,[si+48h]
  8236 00000E9A 8B5448                  	MOV	DX,[SI+DOS_CCDPG.ccSysCodePage]
  8237                                  				  	; get sys code page id;smr;use ds
  8238 00000E9D E8D7F5                  	call	Get_User_Stack
  8239                                  ;ASSUME DS:NOTHING
  8240                                  	;;mov	[si+2],bx
  8241                                  	;MOV	[SI+user_env.user_BX],BX ; update returned bx
  8242                                  	; 06/01/2024 (PCDOS 7.1 IBMDOS.COM)
  8243 00000EA0 E8F4FD                  	call    set_user_bx	; MOV [SI+user_env.user_BX],BX 
  8244                                  	;mov	[si+6],dx
  8245 00000EA3 895406                  	MOV	[SI+user_env.user_DX],DX ; update returned dx
  8246                                  OK_RETURN:
  8247                                  	; 15/12/2022
  8248                                  	;transfer SYS_RET_OK
  8249 00000EA6 E9C2F7                  	jmp	SYS_RET_OK
  8250                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8251                                  	;jmp	short nono_jmp
  8252                                  
  8253                                  ;hkn; ASSUME DS:DOSGROUP
  8254                                  ;ASSUME	DS:DOSDATA
  8255                                  
  8256                                  setglpg:
  8257 00000EA9 3C02                    	CMP	AL,2
  8258 00000EAB 752F                    	JNZ	short nomem
  8259                                  	
  8260                                  	;;mov	dx,[si+63h] ; MSDOS 3.3
  8261                                  	;mov	dx,[si+68h] ; MSDOS 6.0
  8262 00000EAD 8B5468                  	MOV	DX,[SI+DOS_CCDPG.ccDosCountry]	;smr;use ds
  8263                                  	
  8264                                  	;CallInstall NLSInstall,NLSFUNC,0 ; check if NLSFUNC in memory
  8265 00000EB0 B80014                  	mov     ax,1400h
  8266 00000EB3 CD2F                    	int     2Fh	; - Multiplex - NLSFUNC.COM - INSTALLATION CHECK
  8267                                  			; Return: AL = 00h not installed, OK to install
  8268                                  			; 01h not installed, not OK
  8269                                  			; FFh installed
  8270 00000EB5 3CFF                    	CMP	AL,0FFH
  8271 00000EB7 7523                    	JNZ	short nomem		; not in memory
  8272                                  
  8273                                  	;CallInstall SetCodePage,NLSFUNC,1 ;set the code page
  8274 00000EB9 B80114                  	mov     ax,1401h
  8275 00000EBC CD2F                    	int     2Fh	; - Multiplex - NLSFUNC.COM - CHANGE CODE PAGE
  8276                                  			; DS:SI -> internal code page structure
  8277                                  			; BX = new code page, DX = country code???
  8278                                  			; Return: AL = status
  8279                                  			; 00h successful
  8280                                  			; else DOS error code
  8281                                  	;cmp	al,0
  8282 00000EBE 08C0                    	or	al,al			; success ?
  8283 00000EC0 74E4                    	JZ	short OK_RETURN		; yes
  8284                                  
  8285 00000EC2 3C41                    	CMP	AL,65			; set device code page failed
  8286 00000EC4 75C6                    	JNZ	short seterr
  8287                                  	;MOV	AX,65
  8288                                  	; 06/01/2024
  8289 00000EC6 98                      	cbw
  8290 00000EC7 A3[2403]                	MOV	[EXTERR],AX
  8291                                  	;mov	byte [EXTERR_ACTION],6
  8292                                  	;mov	byte [EXTERR_CLASS],5
  8293                                  	;mov	byte [EXTERR_LOCUS],4
  8294 00000ECA C606[2603]06            	MOV	byte [EXTERR_ACTION],errACT_Ignore
  8295 00000ECF C606[2703]05            	MOV	byte [EXTERR_CLASS],errCLASS_HrdFail
  8296 00000ED4 C606[2303]04            	MOV	byte [EXTERR_LOCUS],errLOC_SerDev
  8297                                  	;transfer From_GetSet
  8298 00000ED9 E9A1F7                  	jmp	From_GetSet
  8299                                  
  8300                                  	; 15/12/2022
  8301                                  ;seterr:
  8302                                  	;;;transfer SYS_RET_ERR
  8303                                  	;;jmp	SYS_RET_ERR
  8304                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8305                                  	;jmp	short NLSERROR
  8306                                  
  8307                                  nomem:
  8308                                  	;error	error_invalid_function	; function not defined
  8309                                  	;mov	al,1
  8310 00000EDC B001                    	mov	al,error_invalid_function
  8311 00000EDE EBAC                    	jmp	short seterr
  8312                                  
  8313                                  ;EndProc $GetSetCdPg
  8314                                  
  8315                                  ; 13/05/2019 - Retro DOS v4.0
  8316                                  ; DOSCODE:4C2Bh (MSDOS 6.21, MSDOS.SYS)
  8317                                  
  8318                                  ;BREAK <$Get_Drive_Freespace -- Return bytes of free disk space on a drive>
  8319                                  ;----------------------------------------------------------------------------
  8320                                  ;**	$Get_Drive_Freespace - Return amount of drive free space
  8321                                  ;
  8322                                  ;	$Get_Drive_Freespace returns the # of free allocation units on a
  8323                                  ;		drive.
  8324                                  ;
  8325                                  ;	This call returns the same info in the same registers (except for the
  8326                                  ;	FAT pointer) as the old FAT pointer calls
  8327                                  ;
  8328                                  ;	ENTRY	DL = Drive number
  8329                                  ;	EXIT	AX = Sectors per allocation unit
  8330                                  ;		   = -1 if bad drive specified
  8331                                  ;		On User Stack
  8332                                  ;		    BX = Number of free allocation units
  8333                                  ;		    DX = Total Number of allocation units on disk
  8334                                  ;		    CX = Sector size
  8335                                  
  8336                                  ;procedure   $GET_DRIVE_FREESPACE,NEAR
  8337                                  
  8338                                  	; 09/01/2024
  8339                                  	; 06/01/2024 - Retro DOS v5.0
  8340                                  	; (PCDOS 7.1 IBMDOS.COM - DOSCODE:4DC4h)
  8341                                  
  8342                                  _$GET_DRIVE_FREESPACE:
  8343                                  
  8344                                  ;hkn; SS is DOSDATA
  8345                                  	;context DS
  8346 00000EE0 16                      	push	ss
  8347 00000EE1 1F                      	pop	ds
  8348                                  
  8349 00000EE2 88D0                    	MOV	AL,DL
  8350                                  	;invoke	GetThisDrv		; Get drive
  8351 00000EE4 E82B69                  	call	GETTHISDRV
  8352                                  SET_AX_RET:
  8353 00000EE7 7220                    	JC	short BADFDRV
  8354                                  
  8355                                  	;invoke	DISK_INFO
  8356 00000EE9 E89623                  	call	DISK_INFO
  8357                                  	; 09/01/2024
  8358                                  	;XCHG	DX,BX
  8359                                  	;;JC	short SET_AX_RET	; User FAILed to I 24
  8360                                  	; 26/06/2024
  8361                                  	; 06/01/2024
  8362                                  	;jc	short BADFDRV
  8363                                  	; 26/06/2024
  8364 00000EEC 7304                    	jnc	short gdrvfspc_1
  8365 00000EEE 87DA                    	xchg	dx,bx
  8366 00000EF0 EB17                    	jmp	short BADFDRV
  8367                                  
  8368                                  	; 09/01/2024 - Retro DOS v5.0 (PCDOS 7.1)
  8369                                  gdrvfspc_1:
  8370 00000EF2 30E4                    	XOR	AH,AH			; Chuck Fat ID byte
  8371                                  	;;;
  8372 00000EF4 57                      	push	di
  8373 00000EF5 E80E09                  	call	TestNet
  8374 00000EF8 5F                      	pop	di
  8375 00000EF9 7203                    	jc	short gdrvfspc_2
  8376 00000EFB E88824                  	call    modify_cluster_count
  8377                                  			; if hw of total clusters (di) > 0
  8378                                  			; sectors per cluster and cluster counts
  8379                                  			; will be modified (shifted)
  8380                                  			; (but sectors per clust * clust count will be same)
  8381                                  			; /// disk size -calculation- limit = 2 GB ///
  8382                                  gdrvfspc_2:
  8383 00000EFE 87DA                    	xchg	dx,bx		; bx = free clusters (after xchg)
  8384                                  	;;;
  8385                                  DoSt:
  8386 00000F00 E874F5                  	call	Get_User_Stack
  8387                                  ;ASSUME	DS:NOTHING
  8388                                  	;mov	[si+6],dx
  8389                                  	;;mov	[si+4],cx
  8390                                  	;;mov	[si+2],bx
  8391                                  	; 09/01/2024
  8392 00000F03 895406                  	MOV	[SI+user_env.user_DX],DX ; total clusters
  8393                                  	;MOV	[SI+user_env.user_CX],CX
  8394                                  	;MOV	[SI+user_env.user_BX],BX
  8395                                  	;;MOV	[SI+user_env.user_AX],AX
  8396                                  	;mov	[si],ax
  8397                                  	;;return
  8398                                  	;retn
  8399                                  	; 09/01/2024
  8400 00000F06 E989FD                  	jmp     gdrvfspc_ret	; ax = sectors per cluster (modified)
  8401                                  
  8402                                  BADFDRV:
  8403                                  	; MSDOS 3.3
  8404                                  	;;mov	al,0Fh
  8405                                  	;mov	al,error_invalid_drive	; Assume error
  8406                                  
  8407                                  	; 13/05/2019 - Retro DOS v4.0
  8408                                  
  8409                                  	; MSDOS 6.0 & MSDOS 3.3
  8410                                  	;invoke	FCB_RET_ERR
  8411 00000F09 E87EF7                  	call	FCB_RET_ERR
  8412                                  	
  8413 00000F0C B8FFFF                  	MOV	AX,-1
  8414 00000F0F EBEF                    	JMP	short DoSt
  8415                                  
  8416                                  ;EndProc $GET_DRIVE_FREESPACE
  8417                                  
  8418                                  ;	BREAK <$Get_DMA, $Set_DMA -- Get/Set current DMA address>
  8419                                  ;----------------------------------------------------------------------------
  8420                                  ;**	$Get_DMA - Get Disk Transfer Address
  8421                                  ;
  8422                                  ;	ENTRY	none
  8423                                  ;	EXIT	ES:BX is current transfer address
  8424                                  ;	USES	all
  8425                                  
  8426                                  	; 09/01/2024
  8427                                  _$GET_DMA:
  8428 00000F11 368B1E[2C03]            	MOV	BX,[SS:DMAADD]
  8429 00000F16 368B0E[2E03]            	MOV	CX,[SS:DMAADD+2]
  8430 00000F1B E859F5                  	call	Get_User_Stack
  8431                                  	;mov	[si+2],bx
  8432                                  	;mov	[si+10h],cx
  8433                                  	; 09/01/2024
  8434                                  	;MOV	[SI+user_env.user_BX],BX
  8435 00000F1E 894C10                  	MOV	[SI+user_env.user_ES],CX
  8436                                  	;retn
  8437                                  	; 09/01/2024
  8438 00000F21 E973FD                  	jmp	set_user_bx
  8439                                  
  8440                                  ;**	$Set_DMA - Set Disk Transfer Address
  8441                                  ;----------------------------------------------------------------------------
  8442                                  ;	ENTRY	DS:DX is current transfer address
  8443                                  ;	EXIT	none
  8444                                  ;	USES	all
  8445                                  
  8446                                  _$SET_DMA:
  8447 00000F24 368916[2C03]            	MOV	[SS:DMAADD],DX
  8448 00000F29 368C1E[2E03]            	MOV	[SS:DMAADD+2],DS
  8449 00000F2E C3                      	retn
  8450                                  
  8451                                  ;	BREAK <$Get_Default_Drive, $Set_Default_Drive -- Set/Get default drive>
  8452                                  ;------------------------------------------------------------------------------
  8453                                  
  8454                                  ;**	$Get_Default_Drive - Get Current Default Drive
  8455                                  ;-----------------------------------------------------
  8456                                  ;	ENTRY	none
  8457                                  ;	EXIT	(AL) = drive number
  8458                                  ;	USES	all
  8459                                  
  8460                                  _$GET_DEFAULT_DRIVE:
  8461 00000F2F 36A0[3603]              	MOV	AL,[SS:CURDRV]
  8462 00000F33 C3                      	retn
  8463                                  
  8464                                  ;**	$Set_Default_Drive - Specify new Default Drive
  8465                                  ;-----------------------------------------------------
  8466                                  ;	ENTRY	(DL) = Drive number for new default drive
  8467                                  ;	EXIT	(AL) = Number of drives, NO ERROR RETURN IF DRIVE NUMBER BAD
  8468                                  
  8469                                  _$SET_DEFAULT_DRIVE:
  8470 00000F34 88D0                    	MOV	AL,DL
  8471 00000F36 FEC0                    	INC	AL			; A=1, B=2...
  8472 00000F38 E8BB68                  	call	GetVisDrv		; see if visible drive
  8473 00000F3B 7204                    	JC	short SETRET		; errors do not set
  8474 00000F3D 36A2[3603]              	MOV	[SS:CURDRV],AL		; no, set
  8475                                  
  8476                                  SETRET:
  8477 00000F41 36A0[4700]              	MOV	AL,[SS:CDSCOUNT]	; let user see what the count really is
  8478 00000F45 C3                      	retn
  8479                                  
  8480                                  ;BREAK <$Get/Set_Interrupt_Vector - Get/Set interrupt vectors>
  8481                                  ;----------------------------------------------------------------------------
  8482                                  
  8483                                  ;**	$Get_Interrupt_Vector - Get Interrupt Vector
  8484                                  ;---------------------------------------------------
  8485                                  ;	$Get_Interrupt_Vector is the official way for user pgms to get the
  8486                                  ;	contents of an interrupt vector.
  8487                                  ;
  8488                                  ;	ENTRY	(AL) = interrupt number
  8489                                  ;	EXIT	(ES:BX) = current interrupt vector
  8490                                  
  8491                                  _$GET_INTERRUPT_VECTOR:
  8492 00000F46 E82E00                  	CALL	RECSET
  8493 00000F49 26C41F                  	LES	BX,[ES:BX]
  8494 00000F4C E828F5                  	call	Get_User_Stack
  8495                                  set_user_es_bx:
  8496                                  	; 09/01/2024 (PCDOS 7.1 IBMDOS.COM)
  8497                                  	;;mov	[si+2],bx
  8498                                  	;mov	[si+10h],es
  8499                                  	;MOV	[SI+user_env.user_BX],BX
  8500 00000F4F 8C4410                  	MOV	[SI+user_env.user_ES],ES
  8501                                  	;retn
  8502 00000F52 E942FD                  	jmp	set_user_bx
  8503                                  
  8504                                  ;**	$Set_Interrupt_Vector - Set Interrupt Vector
  8505                                  ;---------------------------------------------------
  8506                                  ;	$Set_Interrupt_Vector is the official way for user pgms to set the
  8507                                  ;	contents of an interrupt vector.
  8508                                  ;
  8509                                  ;	M004, M068: Also set A20OFF_COUNT to 1 if EXECA20OFF bit has been set 
  8510                                  ;	and if A20OFF_COUNT is non-zero. See under tag M003 in inc\dossym.inc 
  8511                                  ;	for explanation.
  8512                                  ;
  8513                                  ;	ENTRY	(AL) = interrupt number
  8514                                  ;		(ds:dx) = desired new vector value
  8515                                  ;	EXIT	none
  8516                                  ;	USES	all
  8517                                  
  8518                                  ; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  8519                                  ; 13/05/2019 - Retro DOS v4.0
  8520                                  
  8521                                  _$SET_INTERRUPT_VECTOR:
  8522 00000F55 E81F00                  	CALL	RECSET
  8523 00000F58 FA                      	CLI				; Watch out!!!!! Folks sometimes use
  8524 00000F59 268917                  	MOV	[ES:BX],DX		;   this for hardware ints (like timer).
  8525 00000F5C 268C5F02                	MOV	[ES:BX+2],DS
  8526 00000F60 FB                      	STI
  8527                                  					; M004, M068 - Start
  8528                                  	; MSDOS 6.0
  8529 00000F61 36F606[8600]04          	test	byte [ss:DOS_FLAG],EXECA20OFF ; 4
  8530                                  					; Q: was the previous call an int 21h
  8531                                  					;    exec call
  8532                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8533                                  	;jnz	short siv_1		; Y: go set count
  8534                                  	;retn				; N: return
  8535                                  	; 15/12/2022
  8536 00000F67 740D                    	jz	short siv_2
  8537                                  siv_1:	
  8538 00000F69 36803E[8500]00          	cmp	byte [ss:A20OFF_COUNT],0 ; Q: is count 0
  8539 00000F6F 7505                    	jnz	short siv_2		 ; N: done 
  8540                                  	; 20/09/2023
  8541 00000F71 36FE06[8500]            	inc	byte [ss:A20OFF_COUNT]
  8542                                  	;mov	byte [ss:A20OFF_COUNT],1 ; Y: set it to 1 to indicate to dos
  8543                                  					 ; dispatcher to turn A20 Off before
  8544                                  					 ; returning to user.
  8545                                  siv_2:
  8546                                  	; 07/12/2022
  8547 00000F76 C3                      	retn				; M004, M068 - End
  8548                                  	
  8549                                  RECSET:
  8550 00000F77 31DB                    	XOR	BX,BX
  8551 00000F79 8EC3                    	MOV	ES,BX
  8552 00000F7B 88C3                    	MOV	BL,AL
  8553 00000F7D D1E3                    	SHL	BX,1
  8554 00000F7F D1E3                    	SHL	BX,1
  8555 00000F81 C3                      	retn
  8556                                  
  8557                                  ;	BREAK <$Char_Oper - hack on paths, switches so that xenix can look like PCDOS>
  8558                                  ;-------------------------------------------------------------------------------------
  8559                                  
  8560                                  ;**	$Char_Oper - Manipulate Switch Character
  8561                                  ;
  8562                                  ;	This function was put in to facilitate XENIX path/switch compatibility
  8563                                  ;
  8564                                  ;	ENTRY	AL = function:
  8565                                  ;		    0 - read switch char
  8566                                  ;		    1 - set switch char (char in DL)
  8567                                  ;		    2 - read device availability
  8568                                  ;			Always returns available
  8569                                  ;		    3 - set device availability
  8570                                  ;			No longer supported (NOP)
  8571                                  ;	EXIT	(al) = 0xff iff error
  8572                                  ;		(al) != 0xff if ok
  8573                                  ;		  (dl) = character/flag, if "read switch char" subfunction
  8574                                  ;	USES	AL, DL
  8575                                  ;
  8576                                  ;	NOTE	This already obsolete function has been deactivated in DOS 5.0
  8577                                  ;		The character / is always returned for subfunction 0,
  8578                                  ;		subfunction 2 always returns -1, all other subfunctions are ignored.
  8579                                  
  8580                                  ; 13/05/2019 - Retro DOS v4.0
  8581                                  ; DOSCODE:4CC9h (MSDOS 6.21, MSDOS.SYS)
  8582                                  
  8583                                  ; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  8584                                  ; DOSCODE:4CBCh (MSDOS 5.0, MSDOS.SYS)
  8585                                  
  8586                                  _$CHAR_OPER:
  8587                                  	; MSDOS 6.0
  8588 00000F82 08C0                    	or	al,al				; get switch?
  8589 00000F84 B22F                    	mov	dl,'/'				; assume yes
  8590 00000F86 7407                    	jz	short chop_1			; jump if yes
  8591 00000F88 3C02                    	cmp	al,2				; check device availability?
  8592 00000F8A B2FF                    	mov	dl,-1				; assume yes
  8593 00000F8C 7401                    	jz	short chop_1			; jump if yes
  8594 00000F8E C3                      	retn					; otherwise just quit
  8595                                  
  8596                                  ; subfunctions requiring return of value to user come here. DL holds
  8597                                  ; value to return
  8598                                  
  8599                                  chop_1:
  8600 00000F8F E8E5F4                  	call	Get_User_Stack
  8601 00000F92 895406                  	mov	[SI+user_env.user_DX],dx	; store value for user
  8602 00000F95 C3                      	retn
  8603                                  
  8604                                  	; MSDOS 3.3
  8605                                  	; Offset 1B87h in IBMDOS.COM (MSDOS 3.3), 1987
  8606                                  	;push	ss
  8607                                  	;pop	ds
  8608                                  	;cmp	al,1
  8609                                  	;jb	short chop_1
  8610                                  	;jz	short chop_2
  8611                                  	;cmp	al,3
  8612                                  	;jb	short chop_3
  8613                                  	;jz	short chop_5
  8614                                  	;mov	al,0FFh
  8615                                  	;retn
  8616                                  ;chop_1:
  8617                                  	;mov	dl,[chSwitch]
  8618                                  	;jmp	short chop_4
  8619                                  ;chop_2:
  8620                                  	;mov	[chSwitch],dl
  8621                                  	;retn
  8622                                  ;chop_3:
  8623                                  	;mov	dl, FFh
  8624                                  ;chop_4:
  8625                                  	;call	Get_User_Stack
  8626                                  	;mov	[si+6],dx
  8627                                  ;chop_5:
  8628                                  	;retn
  8629                                  
  8630                                  ;**	$GetExtendedError - Return Extended error code
  8631                                  ;----------------------------------------------------------------------------
  8632                                  ;	This function reads up the extended error info from the static
  8633                                  ;	variables where it was stored.
  8634                                  ;
  8635                                  ;	ENTRY	none
  8636                                  ;	EXIT	AX = Extended error code (0 means no extended error)
  8637                                  ;		BL = recommended action
  8638                                  ;		BH = class of error
  8639                                  ;		CH = locus of error
  8640                                  ;		ES:DI = may be pointer
  8641                                  ;	USES	ALL
  8642                                  
  8643                                  	; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  8644                                  
  8645                                  _$GetExtendedError:
  8646 00000F96 16                      	push	ss
  8647 00000F97 1F                      	pop	ds
  8648 00000F98 A1[2403]                	MOV	AX,[EXTERR]
  8649 00000F9B C43E[2803]              	LES	DI,[EXTERRPT]
  8650 00000F9F 8B1E[2603]              	MOV	BX,[EXTERR_ACTION]	; BL = Action, BH = Class
  8651 00000FA3 8A2E[2303]              	MOV	CH,[EXTERR_LOCUS]
  8652 00000FA7 E8CDF4                  	call	Get_User_Stack
  8653                                  	;mov	[si+0Ah],di
  8654 00000FAA 897C0A                  	MOV	[SI+user_env.user_DI],DI
  8655                                  
  8656                                  	; 09/01/2024 (PCDOS 7.1 IBMDOS.COM)
  8657                                  	;;mov	[si+10h],es
  8658                                  	;MOV	[SI+user_env.user_ES],ES
  8659                                  	;;mov	[si+2],bx
  8660                                  	;MOV	[SI+user_env.user_BX],BX
  8661 00000FAD E89FFF                  	call	set_user_es_bx
  8662                                  
  8663                                  	;mov	[si+4],cx
  8664 00000FB0 894C04                  	MOV	[SI+user_env.user_CX],CX
  8665                                  jmp_SYS_RET_OK:
  8666                                  	; 15/12/2022
  8667                                  	;jmp	SYS_RET_OK
  8668                                  	; 25/06/2019
  8669 00000FB3 E9B8F6                  	jmp	SYS_RET_OK_clc ; 15/12/2022
  8670                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8671                                  ;jmp_SYS_RET_OK:
  8672                                  	;jmp	SYS_RET_OK
  8673                                  
  8674                                  ; --------------------------------------------------------------------------
  8675                                  ; 09/01/2024
  8676                                  %if 0
  8677                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8678                                  	; DOSCODE:4CF3h
  8679                                  ;patch_or_unknown:
  8680                                  ;get_code_page:
  8681                                  	push    si
  8682                                  	mov     si, COUNTRY_CDPG
  8683                                  	;mov	ax, [si+DOS_CCDPG.ccDosCodePage]
  8684                                  	mov     ax, [ss:si+6Ah]
  8685                                  	pop     si
  8686                                  	retn
  8687                                  %endif
  8688                                  ; --------------------------------------------------------------------------
  8689                                  
  8690                                  ; 29/04/2019 - Retro DOS v4.0
  8691                                  
  8692                                  ;BREAK	<ECS_call - Extended Code System support function>
  8693                                  ;---------------------------------------------------------------------------
  8694                                  ; Inputs:
  8695                                  ;	AL = 0	get lead byte table
  8696                                  ;		on return DS:SI has the table location
  8697                                  ;
  8698                                  ;	AL = 1	set / reset interim console flag
  8699                                  ;		DL = flag (00H or 01H)
  8700                                  ;		no return
  8701                                  ;
  8702                                  ;	AL = 2	get interim console flag
  8703                                  ;		on return DL = current flag value
  8704                                  ;
  8705                                  ;	AL = OTHER then error, and returns with:
  8706                                  ;		AX = error_invalid_function
  8707                                  ;
  8708                                  ;  NOTE: THIS CALL DOES GUARANTEE THAT REGISTER OTHER THAN
  8709                                  ;	 SS:SP WILL BE PRESERVED!
  8710                                  ;---------------------------------------------------------------------------
  8711                                  
  8712                                  _$ECS_Call:
  8713 00000FB6 08C0                    	or	al,al			; AL = 0 (get table)?
  8714                                  	;jnz	short _okok
  8715                                  	; 15/12/2022
  8716 00000FB8 7403                    	jz	short get_lbt
  8717                                  ;_okok:
  8718 00000FBA E9AEF6                  	jmp	SYS_RET_OK
  8719                                  get_lbt:
  8720 00000FBD E8B7F4                  	call	Get_User_Stack		; *
  8721                                  
  8722                                  ;hkn; dbcs_table moved low to dosdata
  8723                                  	;mov	word [si+8],DBCS_TAB+2
  8724 00000FC0 C74408[020D]            	mov	word [SI+user_env.user_SI],DBCS_TAB+2
  8725                                  
  8726 00000FC5 06                      	push	es
  8727                                  	;getdseg <es>			; es = DOSDATA
  8728 00000FC6 2E8E06[0700]            	mov	es,[cs:DosDSeg]
  8729                                  	;mov	[si+14],es
  8730 00000FCB 8C440E                  	mov	[SI+user_env.user_DS],es
  8731 00000FCE 07                      	pop	es
  8732                                  
  8733                                  	; 15/12/2022
  8734 00000FCF EBE2                    	jmp	short jmp_SYS_RET_OK ; jmp SYS_RET_OK_clc ; *
  8735                                  ;_okok:
  8736                                  	; 15/12/2022	
  8737                                  	;;transfer SYS_RET_OK
  8738                                  	;jmp	short jmp_SYS_RET_OK
  8739                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  8740                                  	;;jmp	SYS_RET_OK
  8741                                  	;jmp	short jmp_SYS_RET_OK
  8742                                  
  8743                                  ; --------------------------------------------------------------------------
  8744                                  ; 10/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM - DOSCODE:4EB4h)
  8745                                  ; --------------------------------------------------------------------------
  8746                                  
  8747                                  	; INT 21h, AH=71h - LONG FILENAME FUNCTIONS
  8748                                  	; INT 21h, AH=72h - LFN FindClose
  8749                                  _$LONGNAME:
  8750 00000FD1 30C0                    	xor	al,al			; longname functions are not supported
  8751                                  lfn_error:
  8752 00000FD3 E8A1F4                  	call	Get_User_Stack
  8753 00000FD6 834C1601                	or	word [si+16h],1		; [SI+user_env.user_F],f_Carry
  8754 00000FDA F9                      	stc
  8755 00000FDB 8904                    	mov	[si],ax			; [SI+user_env.user_ax]
  8756 00000FDD C3                      	retn
  8757                                  ; ---------------------------------------------------------------------------
  8758                                  
  8759                                  	; FAT32 - EXTENDED FUNCTIONS 
  8760                                  	; INT 21h, AH=73h
  8761                                  _$FAT32EXT:
  8762 00000FDE 3C05                    	cmp	al,5			; INT 21h AX = 7305h
  8763 00000FE0 7609                    	jbe	short valid_fat32_ext_function
  8764 00000FE2 B001                    	mov	al,1			; error_invalid_function
  8765                                  fat32_ext_func_err:
  8766 00000FE4 E98EF6                  	jmp	SYS_RET_ERR
  8767                                  
  8768                                  function_5_invalid_cx:
  8769 00000FE7 B057                    	mov	al,57h			; error_invalid_parameter
  8770                                  fat32_ext_func_err_j:
  8771 00000FE9 EBF9                    	jmp	short fat32_ext_func_err
  8772                                  
  8773                                  valid_fat32_ext_function:
  8774 00000FEB 7524                    	jnz	short not_function_5
  8775 00000FED 83F9FF                  	cmp	cx,0FFFFh 	; Function 5 - FAT32 - EXTENDED ABSOLUTE DISK READ/WRITE
  8776 00000FF0 75F5                    	jne	short function_5_invalid_cx
  8777 00000FF2 F7C6FE9F                	test	si,9FFEh		; read/write mode flags
  8778 00000FF6 75EF                    	jnz	short function_5_invalid_cx
  8779 00000FF8 88D0                    	mov	al,dl			; drive number, 1 = A
  8780 00000FFA FEC8                    	dec	al
  8781 00000FFC B401                    	mov	ah,1
  8782 00000FFE F7C60100                	test	si,1
  8783 00001002 7405                    	jz	short function_5_read
  8784 00001004 E8DDF5                  	call	FAT32_ABSDWRT		; INT 21h AX = 7305h (SI bit 0 = 1)
  8785 00001007 EB03                    	jmp	short fat32_absdrw_ret
  8786                                  
  8787                                  function_5_read:
  8788 00001009 E825F5                  	call	FAT32_ABSDRD		; INT 21h AX = 7305h (SI bit 0 = 0)
  8789                                  fat32_absdrw_ret:
  8790 0000100C 72C5                    	jc	short lfn_error
  8791 0000100E E95AF6                  	jmp	SYS_RET_OK
  8792                                  
  8793                                  not_function_5:
  8794 00001011 3C03                    	cmp	al,3		; Function 3 - FAT32 - GET EXTENDED FREE SPACE ON DRIVE
  8795 00001013 7475                    	je	short function_73_3
  8796 00001015 3C02                    	cmp	al,2
  8797 00001017 7203                    	jb	short chk_drive_lock_flush
  8798 00001019 E90503                  	jmp	_$GET_DPB	; Function 2 - FAT32 - "Get_ExtDPB" - GET EXTENDED DPB
  8799                                  			  	; Function 4 - FAT32 - Set DPB TO USE FOR FORMATTING
  8800                                  
  8801                                  chk_drive_lock_flush:
  8802 0000101C 80FA1A                  	cmp	dl,26			; MSDOS 7 - DRIVE LOCKING AND FLUSHING
  8803 0000101F 7604                    	jbe	short drv_lock_flush_1
  8804 00001021 B00F                    	mov	al,0Fh			; invalid drive number
  8805                                  drv_lock_flush_err:
  8806                                  	;jmp	short fat32_ext_func_err_j ; ax = error code
  8807                                  	; 10/01/2024
  8808 00001023 EBBF                    	jmp	short fat32_ext_func_err
  8809                                  
  8810                                  drv_lock_flush_1:
  8811 00001025 FECA                    	dec	dl
  8812 00001027 7905                    	jns	short drv_lock_flush_2
  8813 00001029 368A16[3603]            	mov	dl,[ss:CURDRV]		; 0 = default/current drive)
  8814                                  drv_lock_flush_2:
  8815 0000102E B600                    	mov	dh,0
  8816 00001030 89D3                    	mov	bx,dx
  8817 00001032 80F901                  	cmp	cl,1			; which flag to get or set
  8818 00001035 7604                    	jbe	short drv_lock_flush_3
  8819 00001037 B001                    	mov	al,1			; error_invalid_function
  8820                                  	;jmp	short drv_lock_flush_err
  8821                                  	; 10/01/2024
  8822 00001039 EBA9                    	jmp	short fat32_ext_func_err
  8823                                  
  8824                                  drv_lock_flush_3:
  8825 0000103B 368AA7[1412]            	mov	ah,[ss:drive_flags+bx]
  8826 00001040 08C9                    	or	cl,cl
  8827 00001042 7422                    	jz	short get_set_indctd_flag ; use bit 1 and bit 2
  8828 00001044 08C0                    	or	al,al			; get drive's dirty-buffers flag
  8829 00001046 7419                    	jz	short get_dirty_buf_flag ; use bit 3
  8830 00001048 80E4F7                  	and	ah,0F7h			; clear bit 3
  8831 0000104B 80E508                  	and	ch,8			; izolate bit 3 of the new flag value
  8832 0000104E 08EC                    	or	ah,ch			; set AH bit 3 according to CH bit 3
  8833 00001050 3688A7[1412]            	mov	[ss:drive_flags+bx],ah	; set or reset dirty buffer flag
  8834 00001055 F6C408                  	test	ah,8
  8835 00001058 7505                    	jnz	short set_dirty_flag_ok	; bit 3 is set/1
  8836 0000105A B0FF                    	mov	al,0FFh
  8837 0000105C E8DF56                  	call	FLUSHBUF
  8838                                  set_dirty_flag_ok:
  8839 0000105F EB26                    	jmp	short jmp_to_SYS_RET_OK
  8840                                  
  8841                                  get_dirty_buf_flag:
  8842 00001061 80E408                  	and	ah,8			; izolate dirty buffers flag
  8843 00001064 EB19                    	jmp	short mov_flag_cl_to_al	; AH = new flag and 08h (bit 3 used)
  8844                                  
  8845                                  get_set_indctd_flag:
  8846 00001066 08C0                    	or	al,al
  8847 00001068 7412                    	jz	short get_indicated_flag
  8848 0000106A 80E4F9                  	and	ah,0F9h			; clear bit 1 and bit 2
  8849 0000106D F6C502                  	test	ch,2			; new value for indicated flag
  8850 00001070 7403                    	jz	short reset_indctd_flags ; bit 1 is zero
  8851 00001072 80CC06                  	or	ah,6			; set bit 1 and bit 2
  8852                                  reset_indctd_flags:
  8853 00001075 3688A7[1412]            	mov	[ss:drive_flags+bx],ah
  8854 0000107A EB0B                    	jmp	short jmp_to_SYS_RET_OK
  8855                                  
  8856                                  get_indicated_flag:
  8857 0000107C 80E406                  	and	ah,6			; AH = new flag and 06h (bits 1 and 2 used)
  8858                                  mov_flag_cl_to_al:			; CODE XREF: DOSCODE:4F47^j
  8859 0000107F 88C8                    	mov	al,cl			; value of CL on entry
  8860                                  ret_ax_to_user_cx:  ; ax -> user's cx
  8861 00001081 E8F3F3                  	call	Get_User_Stack
  8862 00001084 894404                  	mov	[si+4],ax		; [SI+user_env.user_cx] ; requested flag
  8863                                  jmp_to_SYS_RET_OK:
  8864 00001087 E9E1F5                  	jmp	SYS_RET_OK
  8865                                  
  8866                                  function_73_3:
  8867 0000108A 89D6                    	mov	si,dx		; FAT32 - GET EXTENDED FREE SPACE ON DRIVE
  8868                                  				; AX = 7303h
  8869                                  				; DS:DX -> ASCIZ string for drive ("C:\" or "\\SERVER\Share")
  8870                                  				; ES:DI -> buffer for extended free space structure
  8871                                  				; CX = length of buffer for extended free space
  8872 0000108C E87F6B                  	call	DriveFromText
  8873 0000108F 92                      	xchg	ax,dx
  8874 00001090 AD                      	lodsw
  8875 00001091 FECA                    	dec	dl
  8876 00001093 80FA1A                  	cmp	dl,26
  8877 00001096 7323                    	jnb	short func_73_3_err2
  8878 00001098 08E4                    	or	ah,ah
  8879 0000109A 751F                    	jnz	short func_73_3_err2
  8880 0000109C E8F149                  	call	PATHCHRCMP
  8881 0000109F 751A                    	jnz	short func_73_3_err2
  8882 000010A1 FEC2                    	inc	dl
  8883 000010A3 83F92C                  	cmp	cx,44			; buffer (Structure) size must be 44
  8884 000010A6 721C                    	jb	short func_73_3_err4
  8885 000010A8 26837D0200              	cmp	word [es:di+2],0	; buffer structure version (must be 0)
  8886 000010AD 7511                    	jnz	short func_73_3_err3
  8887 000010AF 16                      	push	ss
  8888 000010B0 1F                      	pop	ds
  8889 000010B1 88D0                    	mov	al,dl
  8890 000010B3 E85C67                  	call	GETTHISDRV
  8891 000010B6 7310                    	jnc	short fill_efs_struc_b
  8892                                  func_73_3_err1:
  8893 000010B8 E8CFF5                  	call	FCB_RET_ERR
  8894                                  func_73_3_err2:
  8895 000010BB B00F                    	mov	al,0Fh			; error_invalid_drive
  8896                                  jmp_to_SYS_RET_ERR:
  8897 000010BD E9B5F5                  	jmp	SYS_RET_ERR
  8898                                  
  8899                                  func_73_3_err3:
  8900 000010C0 B057                    	mov	al,57h			; error_invalid_parameter
  8901                                  jmp_to_jmp_SYS_RET_ERR:
  8902 000010C2 EBF9                    	jmp	short jmp_to_SYS_RET_ERR
  8903                                  
  8904                                  func_73_3_err4:
  8905 000010C4 B018                    	mov	al,18h	   		; error_bad_length
  8906 000010C6 EBFA                    	jmp	short jmp_to_jmp_SYS_RET_ERR
  8907                                  
  8908                                  fill_efs_struc_b:
  8909 000010C8 E8B721                  	call	DISK_INFO
  8910 000010CB 72EB                    	jc	short func_73_3_err1
  8911 000010CD 30E4                    	xor	ah,ah
  8912 000010CF 56                      	push	si			; si:dx = free cluster count
  8913 000010D0 57                      	push	di			; di:bx = number of clusters
  8914 000010D1 E8A3F3                  	call	Get_User_Stack
  8915 000010D4 8E4410                  	mov	es,[si+10h]		; user's buffer segment (in ES)
  8916 000010D7 8B7C0A                  	mov	di,[si+0Ah]		; user's buffer offset/address (in DI)
  8917                                  	; 10/01/2024
  8918 000010DA 06                      	push	es
  8919 000010DB 1F                      	pop	ds ; (*)
  8920                                  	;
  8921                                  	;mov	[es:di+10h],bx		; total number of clusters on the drive
  8922                                  	;mov	[es:di+20h],bx		; total allocation units, without adjustment for compression
  8923 000010DC 895D10                  	mov	[di+10h],bx
  8924 000010DF 895D20                  	mov	[di+20h],bx
  8925 000010E2 5B                      	pop	bx
  8926                                  	;mov	[es:di+12h],bx		; total number of clusters on the drive, hw
  8927                                  	;mov	[es:di+22h],bx		; total allocation units, hw
  8928                                  	;mov	[es:di+0Ch],dx		; number of available clusters
  8929                                  	;mov	[es:di+1Ch],dx		; number of available allocation units, without adjustment
  8930 000010E3 895D12                  	mov	[di+12h],bx
  8931 000010E6 895D22                  	mov	[di+22h],bx
  8932 000010E9 89550C                  	mov	[di+0Ch],dx
  8933 000010EC 89551C                  	mov	[di+1Ch],dx
  8934 000010EF 5A                      	pop	dx
  8935                                  	;mov	[es:di+0Eh],dx		; number of available clusters, hw
  8936                                  	;mov	[es:di+1Eh],dx		; number of available allocation units, hw
  8937                                  	;mov	[es:di+8],cx		; bytes per sector
  8938                                  	;mov	[es:di+4],ax		; sectors per cluster (with adjustment for compression)
  8939 000010F0 89550E                  	mov	[di+0Eh],dx
  8940 000010F3 89551E                  	mov	[di+1Eh],dx
  8941 000010F6 894D08                  	mov	[di+8],cx
  8942 000010F9 894504                  	mov	[di+4],ax	
  8943 000010FC 89C1                    	mov	cx,ax
  8944 000010FE F7E3                    	mul	bx			; 32 bit multiplication
  8945 00001100 720B                    	jc	short dsk_cap_calc_overf ; disk capacity calculation overflow error
  8946 00001102 89C3                    	mov	bx,ax
  8947                                  	;mov	ax,[es:di+20h]		; total allocation units, lw
  8948 00001104 8B4520                  	mov	ax,[di+20h]
  8949 00001107 F7E1                    	mul	cx
  8950 00001109 01DA                    	add	dx,bx
  8951 0000110B 7305                    	jnb	short dsk_cap_calc_ok
  8952                                  dsk_cap_calc_overf:
  8953 0000110D B8FFFF                  	mov	ax,0FFFFh		; set to 0FFFFFFFFh
  8954 00001110 89C2                    	mov	dx,ax
  8955                                  dsk_cap_calc_ok:
  8956                                  	; 10/01/2024
  8957                                  	; ds = es (*)
  8958                                  	;mov	[es:di+1Ah],dx
  8959                                  	;mov	[es:di+18h],ax		; total number of physical sectors on the drive,
  8960                                  					; without adjustment for compression
  8961 00001112 89551A                  	mov	[di+1Ah],dx
  8962 00001115 894518                  	mov	[di+18h],ax
  8963 00001118 89C8                    	mov	ax,cx			; 32 bit multiplication
  8964                                  	;mul	word [es:di+0Eh]	; number of available clusters, hw
  8965 0000111A F7650E                  	mul	word [di+0Eh]
  8966 0000111D 720B                    	jc	short dsk_free_calc_overf
  8967 0000111F 89C3                    	mov	bx,ax
  8968                                  	;mov	ax,[es:di+0Ch]		; number of available clusters, lw
  8969 00001121 8B450C                  	mov	ax,[di+0Ch]
  8970 00001124 F7E1                    	mul	cx
  8971 00001126 01DA                    	add	dx,bx
  8972 00001128 7305                    	jnc	short dsk_free_calc_ok
  8973                                  dsk_free_calc_overf:
  8974 0000112A B8FFFF                  	mov	ax,0FFFFh
  8975 0000112D 89C2                    	mov	dx,ax
  8976                                  dsk_free_calc_ok:
  8977                                  	; 10/01/2024
  8978                                  	;mov	[es:di+16h],dx		; hw
  8979                                  	;mov	[es:di+14h],ax		; number of physical sectors available on the drive,
  8980                                  					; without adjustment for compression
  8981 0000112F 895516                  	mov	[di+16h],dx
  8982 00001132 894514                  	mov	[di+14h],ax
  8983 00001135 31C0                    	xor	ax,ax	; 0
  8984                                  	;mov	[es:di+0Ah],ax		; number of bytes per sector, high word = 0
  8985                                  	;mov	[es:di+6],ax		; number of sectors per cluster, high word = 0
  8986 00001137 89450A                  	mov	[di+0Ah],ax
  8987 0000113A 894506                  	mov	[di+6],ax
  8988                                  	
  8989                                  	;mov	[es:di+24h],ax		; reserved, 8 bytes zero
  8990                                  	;mov	[es:di+26h],ax
  8991                                  	;mov	[es:di+28h],ax
  8992                                  	;mov	[es:di+2Ah],ax
  8993 0000113D 83C724                  	add	di,24h ; 36 ; 10/01/2024
  8994 00001140 AB                      	stosw
  8995 00001141 AB                      	stosw
  8996 00001142 AB                      	stosw
  8997 00001143 AB                      	stosw
  8998 00001144 B82C00                  	mov	ax,44
  8999 00001147 29C7                    	sub	di,ax ; 10/01/2024 
  9000                                  	;mov	[es:di],ax		; size of returned structure = 44
  9001                                  	; 10/01/2024
  9002                                  	;mov	[di],ax
  9003 00001149 AB                      	stosw
  9004 0000114A E91EF5                  	jmp	SYS_RET_OK
  9005                                  
  9006                                  ; ---------------------------------------------------------------------------
  9007                                  
  9008                                  ; 12/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM/MSDOS.SYS)
  9009                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:504Ah
  9010                                  
  9011                                  Set_DPBforFormat:	; INT 21h, AX = 7304h (continues from _$GET_DPB)
  9012                                  	; 12/01/2024			; (Ref: Ralf Brown's Interrupt List)
  9013 0000114D B81800                  	mov	ax,18h
  9014 00001150 394404                  	cmp	[si+4],ax	
  9015                                  	;cmp	word ptr [si+4],24	; [SI+user_env.user_CX]
  9016                                  					; size of buffer (must be at least 18h)
  9017                                  	;jnb	short setdpbf_2
  9018                                  	;mov	al,18h			; error_bad_length
  9019                                  ;setdpbf_1:
  9020                                  	;jmp	SYS_RET_ERR
  9021 00001153 7223                    	jb	short setdpbf_1 ; al = 18h
  9022                                  setdpbf_2:
  9023 00001155 06                      	push	es			; ES:BP = Drive parameter block
  9024 00001156 55                      	push	bp
  9025 00001157 8E4410                  	mov	es,[si+10h]		; [SI+user_env.user_ES]
  9026 0000115A 8B7C0A                  	mov	di,[si+0Ah]		; [SI+user_env.user_DI]
  9027 0000115D 5E                      	pop	si
  9028 0000115E 1F                      	pop	ds
  9029                                  
  9030 0000115F 268B4504                	mov	ax,[es:di+4]		; (call) function number
  9031 00001163 26837D0200              	cmp	word [es:di+2],0	; structure version (must be 0)
  9032 00001168 750C                    	jnz	short setdpbf_3
  9033 0000116A 26837D0600              	cmp	word [es:di+6],0	; (must be 0)
  9034 0000116F 7505                    	jnz	short setdpbf_3
  9035 00001171 83F804                  	cmp	ax,4			; (max) 5 functions (0 to 4)
  9036 00001174 7605                    	jbe	short setdpbf_4
  9037                                  setdpbf_3:
  9038 00001176 B057                    	mov	al,57h			; error_invalid_parameter
  9039                                  	;jmp	short setdpbf_1
  9040                                  setdpbf_1:
  9041 00001178 E9FAF4                  	jmp	SYS_RET_ERR
  9042                                  
  9043                                  setdpbf_4:
  9044 0000117B 26C7051800              	mov	word [es:di],18h	; (call) size
  9045 00001180 08C0                    	or	al,al
  9046 00001182 7403                    	jz	short setdpbf_5		; invalidate DPB counts
  9047 00001184 E98200                  	jmp	setdpbf_18
  9048                                  
  9049                                  setdpbf_5:
  9050 00001187 31D2                    	xor	dx,dx	; 0
  9051 00001189 8B5C0D                  	mov	bx,[si+0Dh]		; DPB.MAX_CLUSTER
  9052 0000118C 39540F                  	cmp	[si+0Fh],dx ; 0
  9053                                  	;cmp	word [si+0Fh],0		; DPB.FAT_SIZE
  9054 0000118F 7506                    	jnz	short setdpbf_6		; not FAT32
  9055 00001191 8B542F                  	mov	dx,[si+2Fh]
  9056 00001194 8B5C2D                  	mov	bx,[si+2Dh]		; DPB.LAST_CLUSTER
  9057                                  setdpbf_6:
  9058 00001197 268B450A                	mov	ax,[es:di+0Ah]
  9059 0000119B 268B4D08                	mov	cx,[es:di+8]		; new DPB free count
  9060                                  		  		; (00000000h=no change, FFFFFFFFh=unknown)
  9061 0000119F 09C0                    	or	ax,ax
  9062 000011A1 7502                    	jnz	short setdpbf_7
  9063 000011A3 E322                    	jcxz	setdpbf_11
  9064                                  setdpbf_7:
  9065 000011A5 83F8FF                  	cmp	ax,0FFFFh
  9066 000011A8 7505                    	jne	short setdpbf_8
  9067 000011AA 83F9FF                  	cmp	cx,0FFFFh
  9068 000011AD 7408                    	je	short setdpbf_10	; (set as UNKNOWN/INITIAL)
  9069                                  setdpbf_8:
  9070 000011AF 39D0                    	cmp	ax,dx			; must be < DPB.LAST_CLUSTER
  9071 000011B1 7502                    	jne	short setdpbf_9
  9072 000011B3 39D9                    	cmp	cx,bx
  9073                                  setdpbf_9:
  9074 000011B5 73BF                    	jnb	short setdpbf_3
  9075                                  setdpbf_10:
  9076 000011B7 804C1801                	or	byte [si+18h],1		; DPB.FIRST_ACCESS (bit 0 = 1)
  9077 000011BB 894C1F                  	mov	[si+1Fh],cx		; DPB.FREE_CNT
  9078 000011BE 837C0F00                	cmp	word [si+0Fh],0		; DP.FAT_SIZE
  9079 000011C2 7503                    	jnz	short setdpbf_11	; FAT12 or FAT16
  9080 000011C4 894421                  	mov	[si+21h],ax		; DPB.FREE_CNT_HW
  9081                                  setdpbf_11:
  9082 000011C7 268B450E                	mov	ax,[es:di+0Eh]
  9083 000011CB 268B4D0C                	mov	cx,[es:di+0Ch]		; new DPB next-free
  9084                                  		  		; (00000000h=no change, FFFFFFFFh=unknown)
  9085 000011CF 09C0                    	or	ax,ax
  9086 000011D1 7502                    	jnz	short setdpbf_12
  9087 000011D3 E32E                    	jcxz	setdpbf_17
  9088                                  setdpbf_12:
  9089 000011D5 83F8FF                  	cmp	ax,0FFFFh
  9090 000011D8 7505                    	jne	short setdpbf_13
  9091 000011DA 83F9FF                  	cmp	cx,0FFFFh
  9092 000011DD 7411                    	je	short setdpbf_16	; (set as UNKNOWN/INITIAL)
  9093                                  setdpbf_13:
  9094 000011DF 21C0                    	and	ax,ax
  9095                                  	;cmp	ax,0			; must be >= 2
  9096 000011E1 7505                    	jnz	short setdpbf_14
  9097 000011E3 83F902                  	cmp	cx,2
  9098                                  ;setdpbf_14:
  9099 000011E6 728E                    	jb	short setdpbf_3
  9100                                  setdpbf_14:
  9101 000011E8 39D0                    	cmp	ax,dx			; must be < DPB.LAST_CLUSTER
  9102 000011EA 7502                    	jne	short setdpbf_15
  9103 000011EC 39D9                    	cmp	cx,bx
  9104                                  setdpbf_15:
  9105 000011EE 7786                    	ja	short setdpbf_3
  9106                                  setdpbf_16:
  9107 000011F0 804C1801                	or	byte [si+18h],1		; DPB.FIRST_ACCESS (bit 0 = 1)
  9108 000011F4 894C1D                  	mov	[si+1Dh],cx		; DPB.NEXT_FREE
  9109 000011F7 837C0F00                	cmp	word [si+0Fh],0		; DPB.FAT_SIZE
  9110 000011FB 7506                    	jnz	short setdpbf_17	; FAT16 or FAT12
  9111 000011FD 89443B                  	mov	[si+3Bh],ax
  9112 00001200 894C39                  	mov	[si+39h],cx		; DPB.FAT32_NXTFREE
  9113                                  setdpbf_17:
  9114 00001203 B80473                  	mov	ax,7304h		; done (successful)
  9115 00001206 E962F4                  	jmp	SYS_RET_OK
  9116                                  
  9117                                  setdpbf_18:
  9118                                  	;dec	al
  9119 00001209 48                      	dec	ax
  9120 0000120A 7514                    	jnz	short setdpbf_19
  9121 0000120C 1E                      	push	ds			; rebuild DPB from BPB
  9122 0000120D 56                      	push	si
  9123 0000120E 26C57508                	lds	si,[es:di+8]		; BIOS Parameter Block
  9124 00001212 5D                      	pop	bp
  9125 00001213 07                      	pop	es
  9126 00001214 B95845                  	mov	cx,4558h		; 'XE' (NASM syntax)
  9127 00001217 BA5241                  	mov	dx,4152h		; 'RA' (NASM syntax)
  9128 0000121A E82502                  	call	_$SETDPB
  9129 0000121D E94BF4                  	jmp	SYS_RET_OK
  9130                                  
  9131                                  setdpbf_19:
  9132                                  	;dec	al
  9133 00001220 48                      	dec	ax
  9134 00001221 7507                    	jnz	short setdpbf_20
  9135                                  		  ; force media change
  9136                                  		  ; (next access to drive rebuild DPB)
  9137 00001223 804C1880                	or	byte [si+18h],80h	; DPB.FIRST_ACCESS (bit 7 = 1)
  9138                                  setdpbf_29:	; 12/01/2024
  9139 00001227 E941F4                  	jmp	SYS_RET_OK
  9140                                  
  9141                                  setdpbf_20:
  9142 0000122A 837C0F00                	cmp	word [si+0Fh],0		; DPB.FAT_SIZE
  9143 0000122E 7405                    	jz	short setdpbf_22 ; FAT32
  9144 00001230 B00F                    	mov	al,0Fh			; error_invalid_drive
  9145                                  		 ; (function 3 or 4 are only for drives with FAT32 fs)
  9146                                  setdpbf_21:
  9147 00001232 E940F4                  	jmp	SYS_RET_ERR
  9148                                  
  9149                                  setdpbf_22:
  9150                                  	;dec	al
  9151 00001235 48                      	dec	ax
  9152 00001236 7454                    	jz	short setdpbf_30	; get/set active FAT number and mirroring
  9153 00001238 8B4435                  	mov	ax,[si+35h]		; DPB.ROOT_CLUSTER		
  9154                                  			; get/set root directory cluster number
  9155 0000123B 2689450C                	mov	[es:di+0Ch],ax		; (ret) previous root directory cluster number
  9156 0000123F 8B4437                  	mov	ax,[si+37h]
  9157 00001242 2689450E                	mov	[es:di+0Eh],ax
  9158 00001246 268B4D0A                	mov	cx,[es:di+0Ah]
  9159 0000124A 268B4508                	mov	ax,[es:di+8]		; (call) new root directory cluster number
  9160 0000124E 83F8FF                  	cmp	ax,0FFFFh		; -1 --> return only previous root dir cluster number
  9161 00001251 7505                    	jne	short setdpbf_23
  9162 00001253 83F9FF                  	cmp	cx,0FFFFh
  9163 00001256 74CF                    	je	short setdpbf_29
  9164                                  setdpbf_23:
  9165 00001258 21C9                    	and	cx,cx
  9166                                  	;cmp	cx,0			; cluster number must be >= 2
  9167                                  	;jnz	short setdpbf_24
  9168 0000125A 7509                    	jnz	short setdpbf_26
  9169 0000125C 83F802                  	cmp	ax,2
  9170                                  setdpbf_24:
  9171 0000125F 7304                    	jnb	short setdpbf_26
  9172                                  setdpbf_25:
  9173                                  	;jmp	setdpbf_3		; error (invalid parameter)
  9174                                  	; 12/01/2024
  9175 00001261 B057                    	mov	al,57h			; error_invalid_parameter
  9176 00001263 EBCD                    	jmp	short setdpbf_21
  9177                                  
  9178                                  setdpbf_26:
  9179 00001265 3B4C2F                  	cmp	cx,[si+2Fh]		; must be <= DPB.LAST_CLUSTER
  9180 00001268 7503                    	jne	short setdpbf_27
  9181 0000126A 3B442D                  	cmp	ax,[si+2Dh]
  9182                                  setdpbf_27:
  9183 0000126D 77F2                    	ja	short setdpbf_25	; error
  9184 0000126F 894C37                  	mov	[si+37h],cx		; DPB.ROOT_CLUSTER
  9185 00001272 894435                  	mov	[si+35h],ax
  9186 00001275 804C1802                	or	byte [si+18h],2		; DPB.FIRST_ACCESS (bit 1 = 1)
  9187 00001279 1E                      	push    ds
  9188 0000127A 56                      	push    si
  9189 0000127B 5D                      	pop	bp
  9190 0000127C 07                      	pop	es
  9191 0000127D E80406                  	call    ECritDisk
  9192 00001280 E80821                  	call    update_fat32_fsinfo
  9193 00001283 E82B06                  	call    LCritDisk
  9194 00001286 739F                    	jnc	short setdpbf_29
  9195 00001288 B01F                    	mov	al,1Fh			; error_gen_failure
  9196                                  setdpbf_28:
  9197 0000128A EBA6                    	jmp	short setdpbf_21
  9198                                  
  9199                                  	; 12/01/2024
  9200                                  ;setdpbf_29:
  9201                                  	;jmp	SYS_RET_OK
  9202                                  
  9203                                  setdpbf_30:
  9204                                  	; 12/01/2024
  9205                                  	; ax = 0
  9206 0000128C 8164238F00              	and	word [si+23h],8Fh	; DPB.EXT_FLAGS (clear bit 4-6)
  9207 00001291 8B4C23                  	mov	cx,[si+23h]
  9208 00001294 26894D0C                	mov	[es:di+0Ch],cx		; (ret) previous active FAT/mirroring state
  9209 00001298 2689450E                	mov	[es:di+0Eh],ax ; 0
  9210                                  	;mov	word [es:di+0Eh],0	; put zero to Set_DPBforFormat struc offset 14
  9211 0000129C 268B5508                	mov	dx,[es:di+8]		; (call) new active FAT/mirroring state,
  9212                                  		  			;  or FFFFFFFFh to get
  9213 000012A0 83FAFF                  	cmp	dx,0FFFFh
  9214                                  	;jnz	short setdpbf_31
  9215                                  	;jmp	SYS_RET_OK
  9216                                  	; 12/01/2024
  9217 000012A3 7482                    	je	short setdpbf_29
  9218                                  
  9219                                  setdpbf_31:
  9220 000012A5 F7C270FF                	test    dx,0FF70h
  9221                                  	;jz	short setdpbf_33	; bit 4-6 of DPB.EXT_FLAGS must be 0
  9222                                  	;mov	al,57h			; error_invalid_parameter
  9223                                  	; 12/01/2024
  9224 000012A9 75B6                    	jnz	short setdpbf_25
  9225                                  setdpbf_32:
  9226                                  	;;jmp	short setdpbf_28
  9227                                  	; 12/01/2024
  9228                                  	;jmp	short setdpbf_21
  9229                                  	
  9230                                  setdpbf_33:
  9231 000012AB B001                    	mov	al,1			; error_invalid_function
  9232                                  					; (modification is not allowed)
  9233                                  	;jmp	short setdpbf_32
  9234                                  	; 12/01/2024
  9235 000012AD EB83                    	jmp	short setdpbf_21
  9236                                  
  9237                                  ; ---------------------------------------------------------------------------
  9238                                  
  9239                                  ;============================================================================
  9240                                  ; PARSE.ASM, MSDOS 6.0, 1991
  9241                                  ;============================================================================
  9242                                  ; 19/07/2018 - Retro DOS v3.0
  9243                                  ; 15/05/2019 - Retro DOS v4.0
  9244                                  
  9245                                  ; System calls for parsing command lines
  9246                                  ;
  9247                                  ;   $PARSE_FILE_DESCRIPTOR
  9248                                  ;
  9249                                  ;   Modification history:
  9250                                  ;
  9251                                  ;       Created: ARR 30 March 1983
  9252                                  ;               EE PathParse 10 Sept 1983
  9253                                  ;
  9254                                  
  9255                                  ;BREAK <$Parse_File_Descriptor -- Parse an arbitrary string into an FCB>
  9256                                  ;---------------------------------------------------------------------------
  9257                                  ; Inputs:
  9258                                  ;       DS:SI Points to a command line
  9259                                  ;       ES:DI Points to an empty FCB
  9260                                  ;       Bit 0 of AL = 1 At most one leading separator scanned off
  9261                                  ;                   = 0 Parse stops if separator encountered
  9262                                  ;       Bit 1 of AL = 1 If drive field blank in command line - leave FCB
  9263                                  ;                   = 0  "    "    "     "         "      "  - put 0 in FCB
  9264                                  ;       Bit 2 of AL = 1 If filename field blank - leave FCB
  9265                                  ;                   = 0  "       "      "       - put blanks in FCB
  9266                                  ;       Bit 3 of AL = 1 If extension field blank - leave FCB
  9267                                  ;                   = 0  "       "      "        - put blanks in FCB
  9268                                  ; Function:
  9269                                  ;       Parse command line into FCB
  9270                                  ; Returns:
  9271                                  ;       AL = 1 if '*' or '?' in filename or extension, 0 otherwise
  9272                                  ;       DS:SI points to first character after filename
  9273                                  ;---------------------------------------------------------------------------
  9274                                  
  9275                                  	; 13/01/2024
  9276                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:51BFh
  9277                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:4D22h
  9278                                  
  9279                                  _$PARSE_FILE_DESCRIPTOR:
  9280 000012AF E85846                  	call	MAKEFCB
  9281 000012B2 56                      	PUSH    SI
  9282 000012B3 E8C1F1                  	call	Get_User_Stack
  9283                                  	;pop	word [si+8]
  9284 000012B6 8F4408                  	POP     word [SI+user_env.user_SI]
  9285 000012B9 C3                      	retn
  9286                                  
  9287                                  ; --------------------------------------------------------------------------
  9288                                  ; 13/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM - DOSCODE:51CAh)
  9289                                  ; --------------------------------------------------------------------------
  9290                                  
  9291                                  set_exerr_locus_unk:
  9292 000012BA 50                      	push    ax
  9293 000012BB B001                    	mov     al,1		; errLOC_Unk
  9294                                  set_exerr_locus:
  9295 000012BD 36A2[2303]                      mov	[ss:EXTERR_LOCUS],al
  9296 000012C1 58                              pop	ax
  9297 000012C2 C3                              retn
  9298                                  
  9299                                  set_exerr_locus_disk:
  9300 000012C3 50                      	push	ax
  9301 000012C4 B002                    	mov	al,2		; errLOC_Disk
  9302 000012C6 EBF5                    	jmp	short set_exerr_locus
  9303                                  
  9304                                  set_exerr_locus_ser:
  9305 000012C8 50                      	push	ax
  9306 000012C9 B004                    	mov	al,4		; errLOC_SerDev
  9307 000012CB EBF0                    	jmp	short set_exerr_locus
  9308                                  
  9309                                  set_exerr_locus_mem:
  9310 000012CD 50                      	push	ax
  9311 000012CE B005                    	mov	al,5		; errLOC_Mem
  9312 000012D0 EBEB                    	jmp	short set_exerr_locus
  9313                                  
  9314                                  ; ---------------------------------------------------------------------------
  9315                                  
  9316                                  ;============================================================================
  9317                                  ; MISC.ASM, MSDOS 6.0, 1991
  9318                                  ;============================================================================
  9319                                  ; 19/07/2018 - Retro DOS v3.0
  9320                                  
  9321                                  ; 29/04/2019 - Retro DOS v4.0
  9322                                  
  9323                                  ;ENTRYPOINTSEG	EQU	0CH
  9324                                  ;MAXDIF		EQU	0FFFH
  9325                                  ;SAVEXIT 	EQU	10
  9326                                  ;WRAPOFFSET	EQU	0FEF0h
  9327                                  
  9328                                  ;
  9329                                  ;----------------------------------------------------------------------------
  9330                                  ;
  9331                                  ;**	$SLEAZEFUNC - Get a Pointer to the Media Byte
  9332                                  ;
  9333                                  ;	Return Stuff sort of like old get fat call
  9334                                  ;
  9335                                  ;	ENTRY	none
  9336                                  ;	EXIT	DS:BX = Points to FAT ID byte (IBM only)
  9337                                  ;			GOD help anyone who tries to do ANYTHING except
  9338                                  ;			READ this ONE byte.
  9339                                  ;		DX = Total Number of allocation units on disk
  9340                                  ;		CX = Sector size
  9341                                  ;		AL = Sectors per allocation unit
  9342                                  ;		   = -1 if bad drive specified
  9343                                  ;	USES	all
  9344                                  ;
  9345                                  ;**	$SLEAZEFUNCDL - Get a Pointer to the Media Byte
  9346                                  ;
  9347                                  ;	Identical to $SLEAZEFUNC except (dl) = drive
  9348                                  ;
  9349                                  ;	ENTRY	(dl) = drive (0=default, 1=A, 2=B, etc.)
  9350                                  ;	EXIT	DS:BX = Points to FAT ID byte (IBM only)
  9351                                  ;			GOD help anyone who tries to do ANYTHING except
  9352                                  ;			READ this ONE byte.
  9353                                  ;		DX = Total Number of allocation units on disk
  9354                                  ;		CX = Sector size
  9355                                  ;		AL = Sectors per allocation unit
  9356                                  ;		   = -1 if bad drive specified
  9357                                  ;	USES	all
  9358                                  ;
  9359                                  ;----------------------------------------------------------------------------
  9360                                  ;
  9361                                  	; 10/01/2024 - Retro DOS v5.0
  9362                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:51E2h
  9363                                  
  9364                                  _$SLEAZEFUNC:
  9365                                  	; 15/05/2019 - Retro DOS v4.0
  9366 000012D2 B200                    	MOV	DL,0
  9367                                  _$SLEAZEFUNCDL:
  9368 000012D4 16                      	push	ss
  9369 000012D5 1F                      	pop	ds
  9370                                  	
  9371 000012D6 88D0                    	MOV	AL,DL
  9372 000012D8 E83765                  	call	GETTHISDRV		; Get CDS structure
  9373                                  SET_AL_RET:
  9374                                  	; MSDOS 3.3
  9375                                  	;;mov	al, 0Fh
  9376                                  	;MOV	AL,error_invalid_drive	; Assume error	;AC000;
  9377                                  	
  9378                                  	; MSDOS 6.0 & MSDOS 3.3
  9379 000012DB 7229                    	JC	short BADSLDRIVE
  9380                                  
  9381 000012DD E8A21F                  	call	DISK_INFO
  9382                                  	;JC	short SET_AL_RET	; User FAILed to I 24
  9383 000012E0 7224                    	jc	short BADSLDRIVE
  9384 000012E2 8826[9805]              	MOV	[FATBYTE],AH	; FAT (MEDIA) ID byte
  9385                                  
  9386                                  	; 10/01/2024 - Retro DOS v5.0 (PCDOS 7.1)
  9387                                  	;;;
  9388 000012E6 30E4                    	xor     ah, ah		; AH = 0
  9389                                  				; AL = sectors per cluster
  9390 000012E8 57                      	push    di		; di:bx = number of clusters
  9391 000012E9 E81A05                  	call    TestNet
  9392 000012EC 5F                      	pop     di
  9393 000012ED 7205                    	jc      short sleazefunc1
  9394 000012EF 51                      	push    cx		; bytes per sector
  9395 000012F0 E89320                  	call    modify_cluster_count
  9396 000012F3 59                      	pop     cx		; ax = sectors per cluster (modified)
  9397                                  				; dx = number of clusters (modified)
  9398                                  				; if bytes per cluster > 16384
  9399                                  				;    and hw of cluster count > 0
  9400                                  				;    bx = 0FFFEh (invalidated parm sign)
  9401                                  sleazefunc1:
  9402                                  	;;;
  9403                                  
  9404                                  ; NOTE THAT A FIXED MEMORY CELL IS USED --> THIS CALL IS NOT
  9405                                  ; RE-ENTRANT. USERS BETTER GET THE ID BYTE BEFORE THEY MAKE THE
  9406                                  ; CALL AGAIN
  9407                                  
  9408                                  	;MOV	DI,FATBYTE
  9409                                  	; 10/01/2024 
  9410                                  	;XOR	AH,AH			; AL has sectors/cluster
  9411 000012F4 E880F1                  	call	Get_User_Stack
  9412                                  	;mov	[si+4],cx
  9413                                  	;mov	[si+6],bx
  9414                                  	;mov	[si+2],di
  9415 000012F7 894C04                  	MOV	[SI+user_env.user_CX],CX
  9416 000012FA 895C06                  	MOV	[SI+user_env.user_DX],BX
  9417                                  	;MOV	[SI+user_env.user_BX],DI
  9418                                  	; 10/01/2024
  9419 000012FD C74402[9805]            	MOV	word [SI+user_env.user_BX],FATBYTE
  9420                                  	
  9421                                  	;mov	[si+0Eh],ss
  9422 00001302 8C540E                  	MOV     [SI+user_env.user_DS],SS ; stash correct pointer
  9423                                  
  9424 00001305 C3                      	retn
  9425                                  
  9426                                  BADSLDRIVE:
  9427 00001306 E981F3                  	jmp	FCB_RET_ERR
  9428                                  
  9429                                  ;
  9430                                  ;----------------------------------------------------------------------------
  9431                                  ;
  9432                                  ;**	$Get_INDOS_Flag - Return location of DOS Critical Section Flag
  9433                                  ;
  9434                                  ;	Returns location of DOS status for interrupt routines
  9435                                  ;
  9436                                  ;	ENTRY	none
  9437                                  ;	EXIT	(es:bx) = flag location
  9438                                  ;	USES	all
  9439                                  ;
  9440                                  ;----------------------------------------------------------------------------
  9441                                  ;
  9442                                  
  9443                                  _$GET_INDOS_FLAG:
  9444 00001309 E86BF1                  	CALL	Get_User_Stack
  9445                                  	;MOV	WORD [SI+2],INDOS
  9446 0000130C C74402[2103]            	MOV	word [SI+user_env.user_BX],INDOS
  9447                                  getin_segm:	; 13/01/2024
  9448                                  	;MOV	[SI+10H],SS
  9449 00001311 8C5410                  	MOV	[SI+user_env.user_ES],SS
  9450 00001314 C3                      	RETN 
  9451                                  
  9452                                  ;
  9453                                  ;----------------------------------------------------------------------------
  9454                                  ;
  9455                                  ;**	$Get_IN_Vars - Return Pointer to DOS Variables
  9456                                  ;
  9457                                  ;	Return a pointer to interesting DOS variables This call is version
  9458                                  ;	dependent and is subject to change without notice in future versions.
  9459                                  ;	Use at risk.
  9460                                  ;
  9461                                  ;	ENTRY	none
  9462                                  ;	EXIT	(es:bx) = address of SYSINITVAR
  9463                                  ;	uses	ALL
  9464                                  ;
  9465                                  ;----------------------------------------------------------------------------
  9466                                  ;
  9467                                  
  9468                                  	; 13/01/2024 - Retro DOS v5.0
  9469                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:5226h
  9470                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:4D65h
  9471                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:4D58h
  9472                                  
  9473                                  _$GET_IN_VARS:
  9474 00001315 E85FF1                  	CALL	Get_User_Stack
  9475                                  	;MOV	WORD [SI+2],SYSINITVAR
  9476                                  	;MOV	word [SI+user_env.user_BX],SYSINITVAR
  9477 00001318 C74402[2600]            	MOV	word [SI+user_env.user_BX],SYSINITVARS
  9478                                  	; 13/01/2024
  9479                                  	;;MOV	[SI+10H],SS
  9480                                  	;MOV	[SI+user_env.user_ES],SS
  9481                                  	;RETN
  9482 0000131D EBF2                    	jmp	short getin_segm
  9483                                  ;
  9484                                  ;----------------------------------------------------------------------------
  9485                                  ;
  9486                                  ;**	$Get_Default_DPB - Return a pointer to the Default DPB
  9487                                  ;
  9488                                  ;	Return pointer to drive parameter table for default drive
  9489                                  ;
  9490                                  ;	ENTRY	none
  9491                                  ;	EXIT	(ds:bx) = DPB address
  9492                                  ;	USES	all
  9493                                  ;
  9494                                  ;**	$Get_DPB - Return a pointer to a specified DPB
  9495                                  ;
  9496                                  ;	Return pointer to a specified drive parameter table
  9497                                  ;
  9498                                  ;	ENTRY	(dl) = drive # (0 = default, 1=A, 2=B, etc.)
  9499                                  ;	EXIT	(al) = 0 iff ok
  9500                                  ;		  (ds:bx) = DPB address
  9501                                  ;		(al) = -1 if bad drive
  9502                                  ;	USES	all
  9503                                  ;
  9504                                  ;----------------------------------------------------------------------------
  9505                                  ;
  9506                                  
  9507                                  ; 10/01/2024
  9508                                  %if 0
  9509                                  
  9510                                  ; 15/05/2019 - Retro DOS v4.0
  9511                                  
  9512                                  _$GET_DEFAULT_DPB:
  9513                                  	MOV	DL,0
  9514                                  _$GET_DPB:
  9515                                  	push	ss
  9516                                  	pop	ds
  9517                                  
  9518                                  	MOV	AL,DL
  9519                                  	call	GETTHISDRV		; Get CDS structure
  9520                                  	JC	short ISNODRV 		; no valid drive
  9521                                  	LES	DI,[THISCDS]		; check for net CDS
  9522                                  	;;test	word [es:di+43h],8000h
  9523                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
  9524                                  	;test	byte [es:di+44h],80h
  9525                                  	test	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8)
  9526                                  	JNZ	short ISNODRV 		; No DPB to point at on NET stuff
  9527                                  	call	ECritDisk
  9528                                  	call	FATREAD_CDS		; Force Media Check and return DPB
  9529                                  	call	LCritDisk
  9530                                  	JC	short ISNODRV 		; User FAILed to I 24, only error we
  9531                                  					;   have.
  9532                                  	call	Get_User_Stack
  9533                                  	;mov	[si+2],bp
  9534                                  	MOV	[SI+user_env.user_BX],BP
  9535                                  	;mov	[si+0Eh],es
  9536                                  	MOV	[SI+user_env.user_DS],ES
  9537                                  	XOR	AL,AL
  9538                                  	retn
  9539                                  ISNODRV:
  9540                                  	MOV	AL,-1
  9541                                  	retn
  9542                                  
  9543                                  %else
  9544                                  
  9545                                  ; 13/01/2024
  9546                                  ; 10/01/2024 - Retro DOS v5.0
  9547                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:5230h
  9548                                  
  9549                                  _$GET_DEFAULT_DPB:
  9550 0000131F B200                    	MOV	DL,0
  9551                                  _$GET_DPB:
  9552 00001321 16                      	push	ss
  9553 00001322 1F                      	pop	ds
  9554                                  
  9555 00001323 88D0                    	MOV	AL,DL
  9556 00001325 E8EA64                  	call	GETTHISDRV		; Get CDS structure
  9557 00001328 B00F                    	mov	al,0Fh			; error_invalid_drive
  9558 0000132A 7315                    	jnc	short getdpb_3
  9559                                  
  9560                                  	; no valid drive
  9561                                  getdpb_1:
  9562                                  	; 13/01/2024
  9563 0000132C E848F1                  	call	Get_User_Stack
  9564 0000132F 813C0273                	cmp	word [si],7302h		; INT 21h, AX = 7302h ? Get_ExtDPB
  9565                                  					; GET EXTENDED DPB
  9566 00001333 7406                    	je      short getdpb_2
  9567 00001335 813C0473                	cmp	word [si],7304h		; INT 21h, AX = 7304h ? Set_DPBforFormat
  9568                                  					; Set DPB TO USE FOR FORMATTING
  9569 00001339 7503                    	jne	short ISNODRV
  9570                                  getdpb_2:
  9571 0000133B E937F3                  	jmp     SYS_RET_ERR
  9572                                  
  9573                                  ISNODRV:
  9574 0000133E B0FF                    	mov	al,0FFh	; -1		; invalid (or network) drive
  9575 00001340 C3                      	retn
  9576                                  
  9577                                  getdpb_3:
  9578 00001341 C43E[A205]              	LES	DI,[THISCDS]		; check for net CDS
  9579                                  	;;test	word [es:di+43h],8000h
  9580                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
  9581                                  	;test	byte [es:di+44h],80h
  9582 00001345 26F6454480              	test	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8)
  9583                                  	;JNZ	short ISNODRV 		; No DPB to point at on NET stuff
  9584                                  	; 10/01/2024
  9585 0000134A 75E0                    	jnz	short getdpb_1
  9586 0000134C E83505                  	call	ECritDisk
  9587 0000134F E8AF4E                  	call	FATREAD_CDS		; Force Media Check and return DPB
  9588 00001352 E85C05                  	call	LCritDisk
  9589                                  	;JC	short ISNODRV 		; User FAILed to I 24,
  9590 00001355 B053                    	mov	al,53h ; error_FAIL_I24 ;  only error we have.
  9591 00001357 72D3                    	jc	short getdpb_1
  9592 00001359 E81BF1                  	call	Get_User_Stack
  9593                                  	; 13/01/2024
  9594 0000135C 813C0473                	cmp	word [si],7304h		; INT 21h, AX = 7304h ?
  9595 00001360 7503                    	jnz	short getdpb_4
  9596 00001362 E9E8FD                  	jmp	Set_DPBforFormat
  9597                                  
  9598                                  	; 13/01/2024
  9599                                  getdpb_4:
  9600 00001365 813C0273                	cmp	word [si],7302h		; INT 21h, AX = 7302h ?
  9601 00001369 7410                    	je	short getdpb_5
  9602 0000136B 26837E0F00              	cmp	word [es:bp+0Fh],0
  9603 00001370 74BA                    	jz	short getdpb_1
  9604 00001372 896C02                  	mov	[si+2],bp
  9605 00001375 8C440E                  	mov	[si+0Eh],es
  9606 00001378 30C0                    	xor	al,al			; status = 0 = successful
  9607 0000137A C3                      	retn
  9608                                  
  9609                                  getdpb_5:
  9610 0000137B B018                    	mov	al,18h			; error_bad_length
  9611 0000137D 837C043F                	cmp	word [si+4],63		; [SI+user_env.user_CX]
  9612                                  					; length of buffer (must be 63 bytes)
  9613 00001381 72B8                    	jb	short getdpb_2		; error
  9614                                  
  9615 00001383 06                      	push	es			; ES:BP = Drive parameter block
  9616 00001384 55                      	push	bp
  9617 00001385 8E4410                  	mov	es,[si+16]		; [SI+user_env.user_ES]
  9618 00001388 8B7C0A                  	mov	di,[si+10]		; [SI+user_env.user_DI]
  9619 0000138B 8B5C08                  	mov	bx,[si+8]		; [SI+user_env.user_SI] (!)
  9620 0000138E 5E                      	pop	si
  9621 0000138F 1F                      	pop	ds
  9622                                  
  9623 00001390 B83D00                  	mov	ax,61			; length of following data (003Dh)
  9624 00001393 AB                      	stosw
  9625 00001394 89C1                    	mov	cx,ax
  9626 00001396 57                      	push	di
  9627 00001397 F3A4                    	rep movsb
  9628 00001399 5F                      	pop	di
  9629                                  	
  9630                                  	; 13/01/2024
  9631 0000139A 06                      	push	es
  9632 0000139B 1F                      	pop	ds
  9633 0000139C 31C0                    	xor	ax,ax ; 0
  9634                                  
  9635 0000139E 81FBA6F1                	cmp	bx,0F1A6h		; (!) signature (undocumented),
  9636                                  					;  must be 0F1A6h to get device driver
  9637                                  					;  address and next-DPB pointer
  9638                                  					; (Ref: Ralf Brown's Interrupt List)
  9639 000013A2 740E                    	je	short getdpb_6
  9640                                  	
  9641                                  	;xor	ax,ax	; 0
  9642 000013A4 48                      	dec	ax 	; -1
  9643                                  	;mov	[es:di+19h],ax		; pointer to next DPB (invalidated)
  9644                                  	;mov	[es:di+1Bh],ax
  9645                                  	;mov	[es:di+13h],ax		; pointer to driver address (invalidated)
  9646                                  	;mov	[es:di+15h],ax
  9647                                  	; 13/01/2024
  9648 000013A5 894519                  	mov	[di+19h],ax ; -1	; pointer to next DPB (invalidated)
  9649 000013A8 89451B                  	mov	[di+1Bh],ax
  9650 000013AB 894513                  	mov	[di+13h],ax		; pointer to driver address (invalidated)
  9651 000013AE 894515                  	mov	[di+15h],ax
  9652                                  
  9653                                  	; 13/01/2024
  9654 000013B1 40                      	inc	ax ; 0
  9655                                  getdpb_6:
  9656                                  	; 13/01/2024
  9657                                  	; ax = 0
  9658 000013B2 39450F                  	cmp	[di+0Fh],ax ; 0
  9659                                  	;cmp	[es:di+0Fh],ax ; 0	; FAT (16 bit) size ?
  9660                                  	;;cmp	word [es:di+0Fh],0
  9661 000013B5 7441                    	jz	short getdpb_8		; FAT32
  9662                                  			  ; FAT16 or FAT12
  9663                                  	;mov	ax,[es:di+0Dh]		; DPB.MAX_CLUSTER
  9664                                  	;mov	[es:di+2Dh],ax		; DPB.LAST_CLUSTER
  9665                                  	;mov	ax,[es:di+0Fh]		; DPB.FAT_SIZE
  9666                                  	;mov	[es:di+31h],ax		; DPB.FAT32_SIZE
  9667                                  	;mov	ax,[es:di+1Dh]		; DPB.NEXT_FREE
  9668                                  	;mov	[es:di+39h],ax		; DPB.FAT32_NXTFREE
  9669                                  	;mov	ax,[es:di+0Bh]		; DPB.FIRST_SECTOR
  9670                                  	;mov	[es:di+29h],ax		; DPB.FCLUS_FSECTOR
  9671                                  	; 13/01/2024
  9672 000013B7 8B450D                  	mov	ax,[di+0Dh]		; DPB.MAX_CLUSTER
  9673 000013BA 89452D                  	mov	[di+2Dh],ax		; DPB.LAST_CLUSTER
  9674 000013BD 8B450F                  	mov	ax,[di+0Fh]		; DPB.FAT_SIZE
  9675 000013C0 894531                  	mov	[di+31h],ax		; DPB.FAT32_SIZE
  9676 000013C3 8B451D                  	mov	ax,[di+1Dh]		; DPB.NEXT_FREE
  9677 000013C6 894539                  	mov	[di+39h],ax		; DPB.FAT32_NXTFREE
  9678 000013C9 8B450B                  	mov	ax,[di+0Bh]		; DPB.FIRST_SECTOR
  9679 000013CC 894529                  	mov	[di+29h],ax		; DPB.FCLUS_FSECTOR
  9680                                  
  9681 000013CF 31C0                    	xor	ax,ax	; 0
  9682                                  	;mov	[es:di+2Fh],ax		; DPB.LAST_CLUSTER high word
  9683                                  	;mov	[es:di+33h],ax		; DPB.FAT32_SIZE high word
  9684                                  	;mov	[es:di+3Bh],ax		; DPB.FAT32_NXTFREE high word
  9685                                  	;mov	[es:di+2Bh],ax		; DPB.FCLUS_FSECTOR high word
  9686                                  	;mov	[es:di+35h],ax		; DPB.ROOT_CLUSTER
  9687                                  	;mov	[es:di+37h],ax		; DPB.ROOT_CLUSTER high word
  9688                                  	;mov	[es:di+23h],ax		; DPB.EXT_FLAGS
  9689                                  	; 13/01/2024
  9690 000013D1 89452F                  	mov	[di+2Fh],ax ; 0		; DPB.LAST_CLUSTER high word
  9691 000013D4 894533                  	mov	[di+33h],ax		; DPB.FAT32_SIZE high word
  9692 000013D7 89453B                  	mov	[di+3Bh],ax		; DPB.FAT32_NXTFREE high word
  9693 000013DA 89452B                  	mov	[di+2Bh],ax		; DPB.FCLUS_FSECTOR high word
  9694 000013DD 894535                  	mov	[di+35h],ax		; DPB.ROOT_CLUSTER
  9695 000013E0 894537                  	mov	[di+37h],ax		; DPB.ROOT_CLUSTER high word
  9696 000013E3 894523                  	mov	[di+23h],ax		; DPB.EXT_FLAGS
  9697 000013E6 48                      	dec	ax	; -1
  9698                                  	;mov	[es:di+25h],ax		; DPB.FSINFO_SECTOR (invalidated)
  9699                                  	;mov	[es:di+27h],ax		; DPB.BKBOOT_SECTOR (invalidated)
  9700                                  	; 13/01/2024
  9701 000013E7 894525                  	mov	[di+25h],ax		; DPB.FSINFO_SECTOR (invalidated)
  9702 000013EA 894527                  	mov	[di+27h],ax		; DPB.BKBOOT_SECTOR (invalidated)
  9703 000013ED 3B451F                  	cmp	ax,[di+1Fh]
  9704                                  	;cmp	ax,[es:di+1Fh]		; DPB.FREE_COUNT (= -1 ?)
  9705 000013F0 7401                    	je	short getdpb_7
  9706 000013F2 40                      	inc	ax	; -1 -> 0
  9707                                  getdpb_7:
  9708 000013F3 894521                  	mov	[di+21h],ax
  9709                                  	;mov	[es:di+21h],ax		; DPB.PB.FREE_COUNT high word
  9710                                  ;getdpb_8:
  9711                                  	; 26/06/2024
  9712 000013F6 31C0                    	xor	ax,ax			; status = 0 = successful
  9713                                  getdpb_8:	; 03/07/2024
  9714 000013F8 E970F2                  	jmp	SYS_RET_OK
  9715                                  
  9716                                  %endif
  9717                                  
  9718                                  ;
  9719                                  ;----------------------------------------------------------------------------
  9720                                  ;
  9721                                  ;**	$Disk_Reset - Flush out Dirty Buffers
  9722                                  ;
  9723                                  ;	$DiskReset flushes and invalidates all buffers. BUGBUG - do
  9724                                  ;		we really invalidate? SHould we? THis screws non-removable
  9725                                  ;		caching. Maybe CHKDSK relies upon it, though....
  9726                                  ;
  9727                                  ;	ENTRY	none
  9728                                  ;	EXIT	none
  9729                                  ;	USES	all
  9730                                  ;
  9731                                  ;----------------------------------------------------------------------------
  9732                                  ;
  9733                                  	; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
  9734                                  	; DOSCODE:4D94h
  9735                                  	; 13/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
  9736                                  	; DOSCODE:5322h
  9737                                  _$DISK_RESET:
  9738                                  	; 15/05/2019 - Retro DOS v4.0
  9739 000013FB B0FF                    	mov	al,0FFh	; -1
  9740 000013FD 16                      	push	ss
  9741 000013FE 1F                      	pop	ds
  9742                                  	; 06/11/2022
  9743                                  	;MOV	AL,-1
  9744 000013FF E88204                  	call	ECritDisk
  9745                                  	; MSDOS 6.0
  9746                                  	;;or	word [DOS34_FLAG],4
  9747                                  	;or	word [DOS34_FLAG],FROM_DISK_RESET    ;AN000;
  9748 00001402 800E[1106]04            	or	byte [DOS34_FLAG],FROM_DISK_RESET ; 4 ; 15/05/2019
  9749 00001407 E83453                  	call	FLUSHBUF
  9750                                  	; MSDOS 6.0
  9751                                  	;and	word [DOS34_FLAG],0FFFBh
  9752                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  9753                                  	;and	word [DOS34_FLAG],NO_FROM_DISK_RESET ;AN000;
  9754                                  	; 15/12/2022
  9755 0000140A 8026[1106]FB            	and	byte [DOS34_FLAG],NO_FROM_DISK_RESET ; 0FBh ; 15/05/2019
  9756                                  
  9757                                  	; 13/01/2024 - Retro DOS v5.0
  9758                                  	; (PCDOS 7.1 IBMDOS.COM)
  9759                                  	;;;
  9760 0000140F C42E[2600]              	les     bp,[DPBHEAD]
  9761                                  drst_1:
  9762 00001413 83FDFF                  	cmp	bp,0FFFFh	; -1 ?
  9763 00001416 7409                    	je	short drst_2	; yes, it is the last DPB
  9764 00001418 E8701F                  	call	update_fat32_fsinfo ; update FSINFO (sector) parameters
  9765 0000141B 26C46E19                	les	bp,[es:bp+19h]	; DPB.NEXT_DPB
  9766 0000141F EBF2                    	jmp	short drst_1
  9767                                  drst_2:
  9768                                  	;;;
  9769                                  
  9770 00001421 C706[5710]0000          	mov	word [SC_STATUS],0	; Throw out secondary cache ; M041
  9771                                  ;
  9772                                  ; We will "ignore" any errors on the flush, and go ahead and invalidate. This
  9773                                  ; call doesn't return any errors and it is supposed to FORCE a known state, so
  9774                                  ; let's do it.
  9775                                  ;
  9776                                  ; Invalidate 'last-buffer' used
  9777                                  ;
  9778 00001427 BBFFFF                  	MOV	BX,-1 ; 0FFFFh	
  9779 0000142A 891E[2000]              	MOV	[LastBuffer+2],BX
  9780 0000142E 891E[1E00]              	MOV	[LastBuffer],BX
  9781                                  
  9782                                  	; MSDOS 3.3 
  9783                                  	; IBMDOS.COM, Offset 1C66h
  9784                                  	;;;;
  9785                                  	;lds	si,[BUFFHEAD]
  9786                                  	;mov	ax,20FFh	; .buf_ID,    AL = FFh (Free buffer)
  9787                                  				; .buf_flags, AH = 0, reset/clear
  9788                                  ;DRST_1:
  9789                                  	;;mov	[si+4],ax
  9790                                  	;mov	[si+BUFFINFO.buf_ID],ax
  9791                                  	;lds	si,[SI]
  9792                                  	;cmp	si,bx ; -1
  9793                                  	;je	short DRST_2
  9794                                  	;;mov	[si+4],ax
  9795                                  	;mov	[si+BUFFINFO.buf_ID],ax
  9796                                  	;lds	si,[SI]
  9797                                  	;cmp	si,bx
  9798                                  	;jne	short DRST_1
  9799                                  	;;;;
  9800                                  ;DRST_2:
  9801 00001432 E87C04                  	call	LCritDisk
  9802 00001435 B8FFFF                  	MOV	AX,-1
  9803                                  	; 07/12/2022
  9804                                  	;mov	ax,0FFFFh
  9805                                  	;CallInstall NetFlushBuf,MultNET,32,AX,AX
  9806 00001438 50                      	push	ax ; * MSDOS 6.0 ; 15/05/2019
  9807 00001439 B82011                  	mov     ax,1120h
  9808 0000143C CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - FLUSH ALL DISK BUFFERS
  9809                                  			; DS = DOS CS
  9810                                  			; Return: CF clear (successful)
  9811 0000143E 58                      	pop	ax ; * MSDOS 6.0 ; 15/05/2019
  9812                                  	
  9813 0000143F C3                      	retn
  9814                                  
  9815                                  	; 19/07/2018 - Retro DOS v3.0
  9816                                  
  9817                                  ;
  9818                                  ;	BREAK <$SetDPB - Create a valid DPB from a user-specified BPB>
  9819                                  ;
  9820                                  ;----------------------------------------------------------------------------
  9821                                  ;
  9822                                  ;**	$SetDPB - Create a DPB
  9823                                  ;
  9824                                  ;	SetDPB Creates a valid DPB from a user-specified BPB
  9825                                  ;
  9826                                  ;	ENTRY	ES:BP Points to DPB
  9827                                  ;		DS:SI Points to BPB
  9828                                  ;	EXIT	DPB setup
  9829                                  ;	USES	ALL but BP, DS, ES
  9830                                  ;
  9831                                  ;----------------------------------------------------------------------------
  9832                                  ;
  9833                                  
  9834                                  ; 10/05/2019 - Retro DOS v4.0
  9835                                  
  9836                                  ; DOSCODE:4DD6h (MSDOS 6.21, MSDOS.SYS)
  9837                                  
  9838                                  ; MSDOS 6.0
  9839 00001440 0300                    word3:	dw	3			; M008 -- word value for divides
  9840                                  
  9841                                  ; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0)
  9842                                  ; DOSCODE:4DC9h (MSDOS 5.0, MSDOS.SYS)
  9843                                  
  9844                                  ; 13/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1)
  9845                                  ; DOSCODE:5369h (PCDOS 7.1, IBMDOS.COM)
  9846                                  
  9847                                  ; 13/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1)
  9848                                  ; Windows ME IO.SYS (Extracted) - BIOSCODE:4EF8h
  9849                                  
  9850                                  ;procedure   $SETDPB,NEAR
  9851                                  
  9852                                  	; 12/04/2024
  9853                                  _$SETDPB:
  9854 00001442 89EF                    	MOV	DI,BP
  9855                                  	;ADD	DI,2			; Skip over dpb_drive and dpb_UNIT
  9856                                  	; 13/01/2024
  9857 00001444 47                      	inc	di
  9858 00001445 47                      	inc	di
  9859 00001446 AD                      	LODSW
  9860 00001447 AB                      	STOSW				; dpb_sector_size
  9861                                  
  9862                                  	; 13/01/2024
  9863                                  	; Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  9864                                  	;;;
  9865 00001448 81F95845                	cmp	cx,4558h	; 'XE' (NASM syntax)
  9866                                  				; CX = signature 4558h ('EX') for FAT32 extended BPB/DPB
  9867 0000144C 7506                    	jne	short not_fat32_extension
  9868 0000144E 81FA5241                	cmp	dx,4152h	; 'RA' (NASM syntax)
  9869                                  				; DX = signature 4152h ('AR') for FAT32 extended BPB/DPB
  9870 00001452 7402                    	je	short chk_fat32_conditions
  9871                                  not_fat32_extension:                    ; ...
  9872 00001454 31C9                    	xor	cx,cx	; 0	; (Do not use FAT32 extensions -32 bit parameters-)
  9873                                  chk_fat32_conditions:  
  9874 00001456 51                      	push	cx	; (*)
  9875                                  	;;;
  9876                                  	
  9877                                  	; 13/01/2024
  9878                                  	; MSDOS 6.0
  9879                                  	;cmp	byte [si+3],0
  9880                                  	;CMP	BYTE [SI+A_BPB.BPB_NUMBEROFFATS-2],0
  9881 00001457 807C0300                	cmp	byte [SI+A_BPB.NUMBEROFFATS-2],0 ; FAT file system drive ;AN000;
  9882                                  	;JNZ	short yesfat			 ; yes			 ;AN000;
  9883 0000145B 740C                    	jz	short nofat ; 13/01/2024 (PCDOS 7.1)
  9884                                  
  9885                                  	; 13/01/2024 - Retro DOS v5.0
  9886                                  	;;;
  9887                                  	;cmp	word [si+9],0	; .BPB_SECTORSPERFAT ; BPB_FATSz16
  9888 0000145D 837C0900                	cmp	word [si+A_BPB.SECTORSPERFAT-2],0
  9889 00001461 7516                    	jnz	short yesfat
  9890                                  	;cmp	word [si+29],0	; .BPB_FAT32VERSION ; BPB_FSVer
  9891 00001463 837C1D00                	cmp	word [si+A_BPB.FSVER-2],0
  9892 00001467 7410                    	jz	short yesfat
  9893                                  nofat:             
  9894                                  	;;;
  9895                                  
  9896                                  	; 13/01/2024
  9897                                  	;;mov	byte [es:di+4],0
  9898                                  	;MOV	BYTE [ES:DI+DPB.FAT_COUNT-4],0
  9899                                  	;JMP	short setend			; NO		;AN000;
  9900                                  
  9901                                  	; 13/01/2024 (WINME IO.SYS)
  9902                                  	;mov	byte [es:di+4],0 ; DPB.FAT_COUNT
  9903                                  	;xor	eax,eax
  9904                                  	;jmp	setend
  9905                                  
  9906                                  	; 13/01/2024 (PCDOS7.1 IBMDOS.COM)
  9907 00001469 31C0                    	xor	ax,ax ; 0
  9908 0000146B 26884504                	mov	[es:di+DPB.FAT_COUNT-4],al ; DPB.FAT_COUNT = 0
  9909                                  
  9910                                  	; 13/01/2024 (not necessary) 
  9911                                  	;add	di,15	; DPB.DRIVER_ADDR
  9912                                  
  9913 0000146F 83C60B                  	add	si,11	; .BPB_SECTORSPERTRACK
  9914                                  
  9915                                  	;mov	[es:bp+15],ax	; DPB.FAT_SIZE = 0
  9916 00001472 2689460F                	mov	[es:bp+DPB.FAT_SIZE],ax
  9917                                  
  9918 00001476 E9B500                  	jmp	setend
  9919                                  
  9920                                  yesfat: ; 10/08/2018
  9921 00001479 89C2                    	MOV	DX,AX
  9922 0000147B AC                      	LODSB
  9923                                  	;;;
  9924                                  	; 13/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
  9925 0000147C 08C0                    	or	al,al
  9926 0000147E 74E9                    	jz	short nofat
  9927                                  	;;;
  9928                                  	;DEC	AL
  9929                                  	; 17/12/2022
  9930 00001480 48                      	dec	ax
  9931 00001481 AA                      	STOSB				; dpb_cluster_mask
  9932                                  	;INC	AL
  9933 00001482 40                      	inc	ax
  9934 00001483 30E4                    	XOR	AH,AH
  9935                                  LOG2LOOP:
  9936 00001485 A801                    	test	AL,1
  9937 00001487 7506                    	JNZ	short SAVLOG
  9938 00001489 FEC4                    	INC	AH
  9939 0000148B D0E8                    	SHR	AL,1
  9940 0000148D EBF6                    	JMP	SHORT LOG2LOOP
  9941                                  SAVLOG:
  9942 0000148F 88E0                    	MOV	AL,AH
  9943 00001491 AA                      	STOSB				; dpb_cluster_shift
  9944 00001492 88C3                    	MOV	BL,AL
  9945 00001494 A5                      	MOVSW				; dpb_first_FAT Start of FAT (# of reserved sectors)
  9946 00001495 AC                      	LODSB
  9947 00001496 AA                      	STOSB				; dpb_FAT_count Number of FATs
  9948                                  ;	OR	AL,AL			; NONFAT ?				;AN000;
  9949                                  ;	JZ	short setend		; yes, don't do anything                ;AN000;
  9950 00001497 88C7                    	MOV	BH,AL
  9951 00001499 AD                      	LODSW
  9952 0000149A AB                      	STOSW				; dpb_root_entries Number of directory entries
  9953 0000149B B105                    	MOV	CL,5
  9954 0000149D D3EA                    	SHR	DX,CL			; Directory entries per sector
  9955 0000149F 48                      	DEC	AX
  9956 000014A0 01D0                    	ADD	AX,DX			; Cause Round Up
  9957 000014A2 89D1                    	MOV	CX,DX
  9958 000014A4 31D2                    	XOR	DX,DX
  9959 000014A6 F7F1                    	DIV	CX
  9960 000014A8 89C1                    	MOV	CX,AX			; Number of (root) directory sectors
  9961 000014AA 47                      	INC	DI
  9962 000014AB 47                      	INC	DI			; Skip dpb_first_sector
  9963 000014AC A5                      	MOVSW			; Total number of sectors in DSKSIZ (temp as dpb_max_cluster)
  9964 000014AD AC                      	LODSB
  9965                                  	;mov	[es:bp+17h],al
  9966 000014AE 26884617                	MOV	[ES:BP+DPB.MEDIA],AL	; Media byte
  9967 000014B2 AD                      	LODSW				; Number of sectors in a FAT
  9968                                  	
  9969                                  	;;;
  9970                                  	;MSDOS 3.3
  9971                                  	;
  9972                                  	;STOSB		; DPB.FAT_SIZE
  9973                                  	;MUL	BH
  9974                                  	
  9975                                  	;MSDOS 6.0
  9976                                  	;
  9977 000014B3 AB                      	STOSW		; DPB.FAT_SIZE	;AC000;;>32mb dpb_FAT_size
  9978                                  
  9979                                  ; 13/01/2024
  9980                                  %if 0
  9981                                  	MOV	DL,BH			;AN000;;>32mb
  9982                                  	XOR	DH,DH			;AN000;;>32mb
  9983                                  	MUL	DX			;AC000;;>32mb Space occupied by all FATs
  9984                                  	;;;
  9985                                  	
  9986                                  	;add	ax,[es:bp+6]
  9987                                  	ADD	AX,[ES:BP+DPB.FIRST_FAT]
  9988                                  	STOSW				; dpb_dir_sector
  9989                                  	ADD	AX,CX			; Add number of (root) directory sectors
  9990                                  	;mov	[es:bp+0Bh],ax
  9991                                  	MOV	[ES:BP+DPB.FIRST_SECTOR],AX
  9992                                  	
  9993                                  	; MSDOS 6.0
  9994                                  	MOV	CL,BL			;F.C. >32mb				;AN000;
  9995                                  	;;cmp	word [es:bp+0Dh],0
  9996                                  	;CMP	WORD [ES:BP+DSKSIZ],0	;F.C. >32mb				;AN000;
  9997                                  	;JNZ	short normal_dpb	;F.C. >32mb				;AN000;
  9998                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
  9999                                  	; 15/12/2022
 10000                                  	; 28/07/2019
 10001                                  	mov	bx,[ES:BP+DSKSIZ]
 10002                                  	or	bx,bx
 10003                                  	JNZ	short normal_dpb	;F.C. >32mb				;AN000;
 10004                                  	;CMP	WORD [ES:BP+DSKSIZ],0	;F.C. >32mb				;AN000;
 10005                                  	;JNZ	short normal_dpb	;F.C. >32mb				;AN000;
 10006                                  	
 10007                                  
 10008                                  	XOR	CH,CH			;F.C. >32mb				;AN000;
 10009                                  	;mov	bx,[si+8]
 10010                                  	mov	bx,[si+A_BPB.BIGTOTALSECTORS-A_BPB.SECTORSPERTRACK] ; 01/01/2024 (temporary)
 10011                                  	;MOV	BX,[SI+A_BPB.BPB_BIGTOTALSECTORS-A_BPB.BPB_SECTORSPERTRACK]	;AN000;
 10012                                  	;mov	dx,[si+10]
 10013                                  	mov	dx,[si+A_BPB.BIGTOTALSECTORS-A_BPB.SECTORSPERTRACK+2] ; 01/01/2024 (temporary)
 10014                                  	;MOV	DX,[SI+A_BPB.BPB_BIGTOTALSECTORS-A_BPB.BPB_SECTORSPERTRACK+2]	;AN000;
 10015                                  	SUB	BX,AX			;AN000;;F.C. >32mb
 10016                                  	SBB	DX,0			;AN000;;F.C. >32mb
 10017                                  	OR	CX,CX			;AN000;;F.C. >32mb
 10018                                  	JZ	short norot		;AN000;;F.C. >32mb
 10019                                  rott:					;AN000;;F.C. >32mb
 10020                                  	CLC				;AN000;;F.C. >32mb
 10021                                  	RCR	DX,1			;AN000;;F.C. >32mb
 10022                                  	RCR	BX,1			;AN000;;F.C. >32mb
 10023                                  	LOOP	rott			;AN000;;F.C. >32mb
 10024                                  norot:					;AN000;
 10025                                  	; 15/12/2022
 10026                                  	;MOV	AX,BX			;AN000;;F.C. >32mb
 10027                                  	JMP	short setend		;AN000;;F.C. >32mb
 10028                                  normal_dpb:
 10029                                  	;;sub	ax,[es:bp+0Dh]
 10030                                  	;SUB	AX,[ES:BP+DSKSIZ]
 10031                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10032                                  	; 15/12/2022
 10033                                  	; bx = [es:bp+DSKSIZ]
 10034                                  	;sub	ax,bx ; 28/07/2019
 10035                                  	;;SUB	AX,[ES:BP+DSKSIZ]
 10036                                  	; 15/12/2022
 10037                                  	sub	bx,ax
 10038                                  	;NEG	AX			; Sectors in data area
 10039                                  ;;	MOV	CL,BL			; dpb_cluster_shift
 10040                                  	; 15/12/2022
 10041                                  	; CL = cluster shift
 10042                                  	; BX = number of data sectors
 10043                                  	;SHR	AX,CL			; Div by sectors/cluster
 10044                                  	shr	bx,cl 
 10045                                  setend:
 10046                                  ;	M008 - CAS
 10047                                  ;
 10048                                  	; 15/12/2022
 10049                                  	inc	bx
 10050                                  	;INC	AX			; +2 (reserved), -1 (count -> max)
 10051                                  ;
 10052                                  ;	There has been a bug in our fatsize calculation for so long
 10053                                  ;	  that we can't correct it now without causing some user to
 10054                                  ;	  experience data loss. There are even cases where allowing
 10055                                  ;	  the number of clusters to exceed the fats is the optimal
 10056                                  ;	  case -- where adding 2 more fat sectors would make the
 10057                                  ;	  data field smaller so that there's nothing to use the extra
 10058                                  ;	  fat sectors for.
 10059                                  ;
 10060                                  ;	Note that this bug had very minor known symptoms. CHKDSK would
 10061                                  ;	  still report that there was a cluster left when the disk was
 10062                                  ;	  actually full. Very graceful failure for a corrupt system
 10063                                  ;	  configuration. There may be worse cases that were never
 10064                                  ;	  properly traced back to this bug. The problem cases only
 10065                                  ;	  occurred when partition sizes were very near FAT sector
 10066                                  ;	  rounding boundaries, which were rare cases.
 10067                                  ;
 10068                                  ;	Also, it's possible that some third-party partition program might
 10069                                  ;	  create a partition that had a less-than-perfect FAT calculation
 10070                                  ;	  scheme. In this hypothetical case, the number of allocation
 10071                                  ;	  clusters which don't actually have FAT entries to represent
 10072                                  ;	  them might be larger and might create a more catastrophic
 10073                                  ;	  failure. So we'll provide the safeguard of limiting the
 10074                                  ;	  max_cluster to the amount that will fit in the FATs.
 10075                                  ;
 10076                                  ;	ax = maximum legal cluster, ES:BP -> dpb
 10077                                  
 10078                                  ;	make sure the number of fat sectors is actually enough to
 10079                                  ;	  hold that many clusters. otherwise, back the number of
 10080                                  ;	  clusters down
 10081                                  
 10082                                  	; 15/12/2022
 10083                                  	; bx = number of clusters
 10084                                  
 10085                                  	; 19/07/2018 - Retro DOS v3.0
 10086                                  	; MSDOS 6.0
 10087                                  	; 15/12/2022
 10088                                  	;mov	bx,ax			; remember calculated # clusters
 10089                                  
 10090                                  	; 01/08/2018 (MSDOS 3.3)
 10091                                  	;mov	al,[ES:BP+DPB.FAT_SIZE]
 10092                                  	;xor	ah,ah 
 10093                                  
 10094                                  	; 10/05/2019 - Retro DOS v4.0
 10095                                  	;mov	ax,[ES:BP+0Fh]
 10096                                  	mov	ax,[ES:BP+DPB.FAT_SIZE]
 10097                                  
 10098                                  	;mul	word [es:bp+2]	
 10099                                  	mul	word [ES:BP+DPB.SECTOR_SIZE] ; how big is the FAT?
 10100                                  	cmp	bx,4096-10  ; 0FF6h	; test for 12 vs. 16 bit fat
 10101                                  	jb	short setend_fat12
 10102                                  	shr	dx,1
 10103                                  
 10104                                  ; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10105                                  	; 15/12/2022
 10106                                  ;cs3 7/2/92
 10107                                  	jnz	short setend_faterr	; some bonehead gave us more fatspace
 10108                                  					; than enough for the maximum FAT,
 10109                                  					; so go ahead and use the calculated
 10110                                  					; number of clusters.
 10111                                  ;cs3 7/2/92
 10112                                  
 10113                                  	rcr	ax,1			; find number of entries
 10114                                  	cmp	ax,4096-10+1		; would this truncation move us
 10115                                  ;					;  into 12-bit fatland?
 10116                                  	jb	short setend_faterr	; then go ahead and let the
 10117                                  ;					;  inconsistency pass through
 10118                                  ;					;  rather than lose data by
 10119                                  ;					;  correcting the fat type
 10120                                  	jmp	short setend_fat16
 10121                                  
 10122                                  setend_fat12:
 10123                                  	add	ax,ax			; (fatsiz*2)/3 = # of fat entries
 10124                                  	adc	dx,dx
 10125                                  
 10126                                  ; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10127                                  ;cs3 7/2/92
 10128                                  	; 15/12/2022
 10129                                  	cmp	dx,3			; if our fatspace is WAY more than
 10130                                  	jnb	short setend_faterr	; we need, we may get an overflow
 10131                                  					; here. Check for it and use
 10132                                  					; the calculated size in this case.
 10133                                  ;cs3 7/2/92
 10134                                  
 10135                                  	div	word [cs:word3]
 10136                                  
 10137                                  setend_fat16:
 10138                                  	dec	ax			; limit at 1
 10139                                  	cmp	ax,bx			; is fat big enough?
 10140                                  	jbe	short setend_fat	; use max value that'll fit
 10141                                  
 10142                                  setend_faterr:
 10143                                  	mov	ax,bx			; use calculated value
 10144                                  
 10145                                  setend_fat:
 10146                                  
 10147                                  ;	now ax = maximum legal cluster
 10148                                  
 10149                                  ;	end M008
 10150                                  
 10151                                  
 10152                                  	;mov	[es:bp+0Dh], ax
 10153                                  	MOV	[ES:BP+DPB.MAX_CLUSTER],AX
 10154                                  
 10155                                  	;;mov	word [es:bp+1Ch],0  ; MSDOS 3.3
 10156                                  	;mov	word [es:bp+1Dh],0  ; MSDOS 6.0
 10157                                  	MOV	word [ES:BP+DPB.NEXT_FREE],0 
 10158                                  					; Init so first ALLOC starts at
 10159                                  					; begining of FAT
 10160                                  	;;mov	word [es:bp+1Eh],-1 ; MSDOS 3.3
 10161                                  	;mov	word [es:bp+1Fh],-1 ; MSDOS 6.0
 10162                                  	MOV	word [ES:BP+DPB.FREE_CNT],-1 ; current count is invalid.
 10163                                  
 10164                                  	retn
 10165                                  
 10166                                  %else
 10167                                  	; 13/01/2024 - Retro DOS v5.0
 10168                                  	;;;
 10169 000014B4 31D2                    	xor	dx,dx ; 0
 10170 000014B6 09C0                    	or	ax,ax
 10171 000014B8 750C                    	jnz	short savlog1	; 16 bit FAT size
 10172 000014BA 5A                      	pop	dx		; (*) FAT32 extensions
 10173                                  				; (use 32 bit FAT and Root Dir size if >0)
 10174 000014BB 52                      	push    dx		; (*)
 10175 000014BC 09D2                    	or	dx,dx
 10176 000014BE 7406                    	jz	short savlog1	; Do not use FAT32 extensions
 10177                                  				; (do not use 32 bit FAT size field)
 10178 000014C0 8B440C                  	mov	ax,[si+12]	; .BPB_SECTORSPERFAT32 ; BPB_FATSz32
 10179 000014C3 8B540E                  	mov	dx,[si+14]	; .BPB_SECTORSPERFAT32+2
 10180                                  savlog1:
 10181 000014C6 51                      	push    cx		; (**) Root directory sectors
 10182 000014C7 89C1                    	mov	cx,ax		; 32 bit multiply
 10183 000014C9 88F8                    	mov	al,bh		; FAT count
 10184 000014CB 30E4                    	xor	ah,ah
 10185 000014CD F7E2                    	mul	dx
 10186 000014CF 91                      	xchg    ax,cx
 10187 000014D0 88FA                    	mov	dl,bh		; FAT count
 10188 000014D2 30F6                    	xor	dh,dh
 10189 000014D4 F7E2                    	mul	dx
 10190 000014D6 01CA                    	add	dx,cx
 10191 000014D8 59                      	pop	cx		; (**)
 10192 000014D9 39D0                    	cmp	ax,dx
 10193 000014DB 7504                    	jne	short savlog2
 10194                                  
 10195                                  	; 13/01/2024
 10196                                  	;or	ax,ax
 10197                                  	;jnz	short savlog2
 10198                                  
 10199                                  	; 13/01/2024 (not necessary)
 10200                                  	;inc	di
 10201                                  	;inc	di
 10202                                  	; di = DPB.DRIVER_ADDR	
 10203                                  
 10204                                  	;jmp	short setend
 10205                                  
 10206                                  	; 13/01/2024
 10207 000014DD 09C0                    	or	ax,ax
 10208 000014DF 744D                    	jz	short setend
 10209                                  
 10210                                  savlog2:
 10211 000014E1 26034606                	add	ax,[es:bp+DPB.FIRST_FAT]
 10212                                  	;add	ax,[es:bp+6]	; dx:ax = (total) FAT sectors
 10213 000014E5 83D200                  	adc	dx,0
 10214 000014E8 AB                      	stosw			; DPB.DIR_SECTOR
 10215 000014E9 01C8                    	add	ax,cx		; + root directory size
 10216 000014EB 2689460B                	mov	[es:bp+DPB.FIRST_SECTOR],ax
 10217                                  	;mov	[es:bp+11],ax	; DPB.FIRST_SECTOR ; First data sector
 10218 000014EF 83D200                  	adc	dx,0
 10219 000014F2 59                      	pop	cx		; (*)
 10220 000014F3 51                      	push    cx
 10221 000014F4 E308                    	jcxz    savlog3
 10222 000014F6 26894629                	mov	[es:bp+DPB.FCLUS_FSECTOR],ax
 10223                                  	;mov	[es:bp+41],ax	; DPB.BIG_FIRST_SECTOR ; FAT32 first sector field
 10224 000014FA 2689562B                	mov	[es:bp+DPB.FCLUS_FSECTOR+2],dx
 10225                                  	;mov	[es:bp+43],dx
 10226                                  savlog3: 
 10227 000014FE 88D9                    	mov	cl,bl		; cluster shift
 10228 00001500 26837E0D00              	cmp	word [es:bp+DPB.MAX_CLUSTER],0
 10229                                  	;cmp	word [es:bp+13],0 ; DPB.MAX_CLUSTER
 10230                                  				; (contains 16 bit .BPB_TOTALSECTORS as temporary)
 10231 00001505 751D                    	jnz	short normal_dpb
 10232 00001507 30ED                    	xor	ch,ch
 10233 00001509 52                      	push    dx	; (**)
 10234 0000150A 8B5C08                  	mov	bx,[si+8]	; SI points to .BPB_SECTORSPERTRACK and SI+8 is
 10235                                  				; .BPB_BIGTOTALSECTORS (32 bit total sectors)
 10236 0000150D 8B540A                  	mov	dx,[si+10]
 10237 00001510 29C3                    	sub	bx,ax
 10238 00001512 58                      	pop	ax	; (**)
 10239 00001513 19C2                    	sbb	dx,ax		; dx:bx = data sectors (for cluster count calc)
 10240 00001515 09C9                    	or	cx,cx
 10241 00001517 7407                    	jz	short norot
 10242                                  rott:
 10243 00001519 F8                      	clc
 10244 0000151A D1DA                    	rcr	dx,1
 10245 0000151C D1DB                    	rcr	bx,1
 10246 0000151E E2F9                    	loop    rott
 10247                                  norot:
 10248 00001520 89D8                    	mov	ax,bx		; dx:ax = cluster count
 10249 00001522 EB0A                    	jmp	short setend
 10250                                  
 10251                                  normal_dpb:
 10252 00001524 262B460D                	sub	ax,[es:bp+DPB.MAX_CLUSTER]
 10253                                  	;sub	ax,[es:bp+13]	; first sector - total sectors
 10254 00001528 31D2                    	xor	dx,dx
 10255 0000152A F7D8                    	neg	ax		; data sectors = total sectors - first sector
 10256 0000152C D3E8                    	shr	ax,cl		; cluster count
 10257                                  
 10258                                  setend:
 10259                                  	; 13/01/2024 (PCDOS 7.1 IBMDOS.COM)
 10260 0000152E 59                      	pop	cx		; (*) 0 = not 32 bit fat sectors
 10261 0000152F 51                      	push	cx		; (*)
 10262                                  
 10263                                  	; si = BIOS Parameter Block + 13
 10264                                  		
 10265                                  	; 12/04/2024
 10266                                  	; 13/01/2024 (PCDOS 7.1 IBMDOS.COM)
 10267 00001530 83C001                  	add	ax,1
 10268 00001533 83D200                  	adc	dx,0			; calculated # clusters HW
 10269 00001536 89C3                    	mov	bx,ax			; calculated # clusters LW
 10270 00001538 268B460F                	mov	ax,[es:bp+DPB.FAT_SIZE]
 10271                                  	;mov	ax,[es:bp+15]		; FAT size (16 bit)
 10272 0000153C E30C                    	jcxz	setend1			; Do not use 32 bit FAT sectors field
 10273 0000153E 31C9                    	xor	cx,cx
 10274 00001540 09C0                    	or	ax,ax
 10275 00001542 7506                    	jnz	short setend1
 10276 00001544 8B440C                  	mov	ax,[si+12]		; .BPB_SECTORSPERFAT32  ; 32 bit FAT size field.
 10277 00001547 8B4C0E                  	mov	cx,[si+14]		; .BPB_SECTORSPERFAT32+2
 10278                                  setend1:
 10279 0000154A 52                      	push    dx	; (**)		; cx:ax = FAT size (in sectors)
 10280                                  					; dx:bx = calculated number of clusters
 10281 0000154B 91                      	xchg    ax,cx
 10282 0000154C 26F76602                	mul	word [es:bp+DPB.SECTOR_SIZE]
 10283                                  	;mul	word [es:bp+2]		; DPB.SECTOR_SIZE
 10284 00001550 91                      	xchg    ax,cx
 10285 00001551 26F76602                	mul	word [es:bp+DPB.SECTOR_SIZE]
 10286                                  	;mul	word [es:bp+2]
 10287 00001555 01CA                    	add	dx,cx			; dx:ax = FAT size in bytes
 10288 00001557 59                      	pop	cx	; (**)		; calculated # clusters HW
 10289 00001558 09C9                    	or	cx,cx
 10290                                  	;jnz	short setend2		; FAT32
 10291 0000155A 750B                    	jnz	short setend3 ; 12/04/2024 (BugFix)
 10292 0000155C 81FBF60F                	cmp	bx,0FF6h
 10293 00001560 721E                    	jb	short setend_fat12	; FAT12
 10294                                  setend2:
 10295                                  	; (PCDOS 7.1 IBMDOS.COM)
 10296                                  	;or	cx,cx			; HW of calculated cluster count
 10297                                  	;jnz	short setend3
 10298 00001562 83FBF6                  	cmp	bx,0FFF6h
 10299 00001565 720C                    	jb	short setend4		; FAT16
 10300                                  setend3:
 10301 00001567 D1EA                    	shr	dx,1			; FAT32 ; 4 byte (32 bit) cluster number
 10302                                  					; fatsiz/4 = # of fat entries
 10303 00001569 D1D8                    	rcr	ax,1
 10304 0000156B D1EA                    	shr	dx,1
 10305 0000156D 7408                    	jz	short setend5		; dx = 0
 10306 0000156F D1D8                    	rcr	ax,1
 10307 00001571 EB1B                    	jmp	short setend_fat16
 10308                                  
 10309                                  setend4:
 10310 00001573 D1EA                    	shr	dx,1			; FAT16 ; 2 byte (16 bit) cluster number
 10311                                  					; fatsiz/2 = # of fat entries
 10312 00001575 7525                    	jnz	short setend_faterr ; dx > 0
 10313                                  setend5:
 10314 00001577 D1D8                    	rcr	ax,1			; FAT16 ; 2 byte (16 bit) cluster number
 10315                                  					; fatsiz/2 = # of fat entries
 10316 00001579 3DF70F                  	cmp	ax,0FF7h		; 4096-10+1
 10317 0000157C 721E                    	jb	short setend_faterr
 10318 0000157E EB0E                    	jmp	short setend_fat16
 10319                                  
 10320                                  setend_fat12:
 10321 00001580 01C0                    	add	ax,ax			; FAT12 ; 1.5 byte (12 bit) cluster number
 10322                                  					; (fatsiz*2)/3 = # of fat entries
 10323 00001582 11D2                    	adc	dx,dx
 10324 00001584 83FA03                  	cmp	dx,3			; if our fatspace is more than we need
 10325                                  					; use calculated size
 10326 00001587 7313                    	jnb	short setend_faterr
 10327 00001589 2EF736[4014]            	div	word [cs:word3]
 10328                                  setend_fat16:
 10329 0000158E 83E801                  	sub	ax,1
 10330 00001591 83DA00                  	sbb	dx,0
 10331 00001594 39CA                    	cmp	dx,cx			; is fat big enough?
 10332 00001596 7704                    	ja	short setend_faterr
 10333 00001598 39D8                    	cmp	ax,bx
 10334 0000159A 7604                    	jbe	short setend_fat32	; use max value that'll fit
 10335                                  setend_faterr:
 10336 0000159C 89D8                    	mov	ax,bx			; use calculated value
 10337 0000159E 89CA                    	mov	dx,cx
 10338                                  setend_fat32:
 10339 000015A0 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 10340                                  	;cmp	word [es:bp+15],0	; DPB.FAT_SIZE ; 16 bit FAT size
 10341 000015A5 750E                    	jnz	short setend6
 10342 000015A7 26C74611FFFF            	mov	word [es:bp+DPB.DIR_SECTOR],-1 
 10343                                  	;mov	word [es:bp+17],0FFFFh	; DPB.DIR_SECTOR
 10344                                  					; (16 bit directory sector field)
 10345 000015AD 26C7460D0000            	mov	word [es:bp+DPB.MAX_CLUSTER],0 
 10346                                  	;mov	word [es:bp+13],0	; DPB.MAX_CLUSTER (16 bit)
 10347 000015B3 EB04                    	jmp	short setend7
 10348                                  
 10349                                  setend6:
 10350 000015B5 2689460D                	mov	[es:bp+DPB.MAX_CLUSTER],ax
 10351                                  	;mov	[es:bp+13],ax	; DPB.MAX_CLUSTER = calculated last cluster number
 10352                                  setend7:
 10353 000015B9 59                      	pop	cx	; (*)		; 1 = use FAT32 extensions
 10354                                  					; 0 = don't use FAT32 extensions (32 bit fields)
 10355 000015BA E353                    	jcxz	setend_fat		; do not use FAT32 extensions
 10356                                  	;mov	[es:bp+45],ax		; DPB.MAX_CLUSTER32 ; dx:ax = last cluster number
 10357                                  	;mov	[es:bp+47],dx
 10358 000015BC 2689462D                	mov	[es:bp+DPB.LAST_CLUSTER],ax
 10359 000015C0 2689562F                	mov	[es:bp+DPB.LAST_CLUSTER+2],dx
 10360 000015C4 B8FFFF                  	mov	ax,0FFFFh ; -1
 10361 000015C7 8D7E21                  	lea	di,[bp+DPB.FREE_CNT_HW]
 10362                                  	;lea	di,[bp+33]		; DPB.FAT32_EXT ; FAT32 extensions
 10363                                  					; -1 = ready
 10364 000015CA AB                      	stosw
 10365 000015CB 8D7410                  	lea	si,[si+16]		; FAT32 flags
 10366 000015CE A5                      	movsw	   			; DPB FAT32 flags ; [bp+23h]
 10367 000015CF 83C606                  	add	si,6
 10368 000015D2 AD                      	lodsw				; FSINFO structure sector number
 10369 000015D3 8B54DC                  	mov	dx,[si-24h]		; .BPB_RESERVEDSECTORS ; Number of reserved sectors.
 10370 000015D6 09C0                    	or	ax,ax
 10371 000015D8 7404                    	jz	short setend8
 10372 000015DA 39D0                    	cmp	ax,dx
 10373 000015DC 7203                    	jb	short setend9
 10374                                  setend8:
 10375 000015DE B8FFFF                  	mov	ax,0FFFFh ; -1		; invalid
 10376                                  setend9:
 10377 000015E1 AB                      	stosw				; DPB FSINFO structure sector number
 10378                                  					; [bp+25h]
 10379 000015E2 AD                      	lodsw				; Sector number of the backup boot sector
 10380 000015E3 09C0                    	or	ax,ax
 10381 000015E5 7404                    	jz	short setend10
 10382 000015E7 39D0                    	cmp	ax,dx
 10383 000015E9 7203                    	jb	short setend11
 10384                                  setend10:
 10385 000015EB B8FFFF                  	mov	ax,0FFFFh ; -1		; invalid
 10386                                  setend11:
 10387 000015EE AB                      	stosw	   			; DPB backup boot sector address
 10388                                  					; [bp+27h]
 10389 000015EF 83C708                  	add	di,8			; [bp+31h]
 10390 000015F2 31D2                    	xor	dx,dx
 10391 000015F4 268B45DE                	mov	ax,[es:di-34]		; [bp+0Fh] ; DPB.MAX_CLUSTER
 10392 000015F8 39D0                    	cmp	ax,dx
 10393 000015FA 7506                    	jnz	short setend12		; > 0 (not FAT32)
 10394 000015FC 8B44F0                  	mov	ax,[si-16]		; FAT32 Sectors per FAT ; .BPB_SECTORSPERFAT32
 10395 000015FF 8B54F2                  	mov	dx,[si-14]
 10396                                  setend12:
 10397 00001602 AB                      	stosw				; DPB FAT32 FAT size in sectors ; [bp+31h]
 10398 00001603 89D0                    	mov	ax,dx
 10399 00001605 AB                      	stosw
 10400 00001606 83EE08                  	sub	si,8			; Root directory cluster number
 10401 00001609 A5                      	movsw				; DPB Root Dir Cluster ; [bp+35h]
 10402 0000160A A5                      	movsw
 10403 0000160B 31C0                    	xor	ax,ax			; DPB reserved ; [bp+39h]
 10404 0000160D AB                      	stosw
 10405 0000160E AB                      	stosw	
 10406                                  %endif
 10407                                  	;;;
 10408                                  
 10409                                  setend_fat:
 10410                                  	; 13/01/2024 - Retro DOS v5.0
 10411 0000160F 31C0                    	xor	ax,ax ; 0
 10412                                  
 10413                                  	;mov	word [es:bp+1Dh],ax ; 0
 10414 00001611 2689461D                	mov	word [es:bp+DPB.NEXT_FREE],ax ; 0 
 10415                                  					; Init so first ALLOC starts at
 10416                                  					; begining of FAT
 10417 00001615 48                      	dec	ax  ; -1
 10418                                  	;mov	word [es:bp+1Fh],ax ; -1
 10419 00001616 2689461F                	mov	word [es:bp+DPB.FREE_CNT],ax ; -1 ; current count is invalid.
 10420                                  
 10421 0000161A C3                      	retn
 10422                                  
 10423                                  ;EndProc $SETDPB
 10424                                  
 10425                                  ;BREAK <$Create_Process_Data_Block,SetMem -- Set up process data block>
 10426                                  
 10427                                  ;
 10428                                  ;----------------------------------------------------------------------------
 10429                                  ;
 10430                                  ;**	$Dup_PDB
 10431                                  ;
 10432                                  ; Inputs:   DX is new segment address of process
 10433                                  ;	    SI is end of new allocation block
 10434                                  ;
 10435                                  ;----------------------------------------------------------------------------
 10436                                  ;
 10437                                  	; 14/01/2024 - Retro DOS 5.0
 10438                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:554Fh
 10439                                  
 10440                                  _$DUP_PDB:
 10441                                  
 10442                                  ;hkn;	CreatePDB would have a CS override. This is not valid.
 10443                                  ;hkn;	Must set up ds in order to acess CreatePDB. Also SS is 
 10444                                  ;hkn;	has been assumed to be NOTHING. It may not have DOSDATA.
 10445                                  
 10446                                  	; MSDOS 3.3
 10447                                  	;MOV	byte [CS:CreatePDB],0FFh  ; indicate a new process
 10448                                  	;MOV	DS,[CS:CurrentPDB]
 10449                                  
 10450                                  	; 15/05/2019 - Retro DOS v4.0
 10451                                  	; MSDOS 6.0
 10452 0000161B 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 10453 00001620 C606[A803]FF            	MOV	byte [CreatePDB],0FFh
 10454 00001625 8E1E[3003]              	MOV	DS,[CurrentPDB]
 10455                                  
 10456 00001629 56                      	PUSH	SI
 10457 0000162A EB0A                    	JMP	SHORT CreateCopy
 10458                                  
 10459                                  ;
 10460                                  ;----------------------------------------------------------------------------
 10461                                  ;
 10462                                  ; Inputs:
 10463                                  ;	DX = Segment number of new base
 10464                                  ; Function:
 10465                                  ;	Set up program base and copy term and ^C from int area
 10466                                  ; Returns:
 10467                                  ;	None
 10468                                  ; Called at DOS init
 10469                                  ;
 10470                                  ;----------------------------------------------------------------------------
 10471                                  ;
 10472                                  
 10473                                  ; 15/05/2019 - Retro DOS v4.0
 10474                                  ; DOSCODE:4EB6h (MSDOS 6.21, MSDOS.SYS)
 10475                                  
 10476                                  ; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 10477                                  ; DOSCODE:4EA2h (MSDOS 5.0, MSDOS.SYS)
 10478                                  
 10479                                  _$CREATE_PROCESS_DATA_BLOCK:
 10480                                  			; Offset 1D02h in IBMDOS.COM (MSDOS 3.3), 1987
 10481 0000162C E848EE                  	CALL	Get_User_Stack
 10482                                  	;mov	ds,[si+14h]
 10483 0000162F 8E5C14                  	MOV	DS,[SI+user_env.user_CS]
 10484                                  	;push	word [2]
 10485 00001632 FF360200                	PUSH	word [PDB.BLOCK_LEN] ;*
 10486                                  CreateCopy:
 10487 00001636 8EC2                    	MOV	ES,DX
 10488                                  
 10489 00001638 31F6                    	XOR	SI,SI			; copy entire PDB
 10490 0000163A 89F7                    	MOV	DI,SI
 10491 0000163C B98000                  	MOV	CX,128
 10492 0000163F F3A5                    	REP	MOVSW
 10493                                  
 10494                                  ; DOS 3.3 7/9/86
 10495                                  	;mov	cx,20
 10496                                  	;MOV	CX,FILPERPROC		; copy handles in case of
 10497                                  	; 15/12/2022
 10498 00001641 B114                    	mov	cl,FILPERPROC ; 06/07/2019
 10499                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10500                                  	;mov	cx,FILPERPROC
 10501                                  
 10502                                  	;mov	di,18h
 10503 00001643 BF1800                  	MOV	DI,PDB.JFN_TABLE	; Set Handle Count has been issued
 10504                                  	;;PUSH	DS ; * 15/05/2019
 10505                                  	;;lds	si,[34h]
 10506                                  	;LDS	SI,[PDB.JFN_Pointer]
 10507                                  	;REP	MOVSB
 10508                                  	;;POP	DS ; * 15/05/2019
 10509                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10510                                  	; 05/12/2022
 10511                                  	; (push ds then pop ds is not needed here!)
 10512                                  	;push	ds
 10513                                  	;lds	si,[34h]
 10514 00001646 C5363400                	lds	si,[PDB.JFN_Pointer]
 10515 0000164A F3A4                    	rep	movsb
 10516                                  	;pop	ds
 10517                                  
 10518                                  ; DOS 3.3 7/9/86
 10519                                  	;hkn ;CreatePDB would have a CS override. This is not valid.
 10520                                  	;hkn ;Must set up ds in order to access CreatePDB. Also SS is 
 10521                                  	;hkn ;has been assumed to be NOTHING. It may not have DOSDATA.
 10522                                  
 10523 0000164C 2E8E1E[0700]            	mov	ds,[cs:DosDSeg] ; 15/05/2019
 10524                                  
 10525                                  	;;test	byte [cs:CreatePDB],0FFh
 10526                                  	;cmp	byte [CS:CreatePDB],0	; Shall we create a process?
 10527                                  	; 17/12/2022
 10528 00001651 380E[A803]              	cmp	[CreatePDB],cl ; 0
 10529                                  	;cmp	byte [CreatePDB],0 ; 15/05/2019
 10530 00001655 744A                    	JZ	short Create_PDB_cont 	; nope, old style call
 10531                                  
 10532                                  ; Here we set up for a new process...
 10533                                  
 10534                                  	;PUSH	CS			; Called at DOSINIT time, NO SS
 10535                                  	;POP	DS
 10536                                  
 10537                                  	; MSDOS 6.0
 10538                                  	;;getdseg <ds>			; ds -> dosdata
 10539                                  	;mov	ds,[cs:DosDSeg] ; 15/05/2019
 10540                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10541                                  	; (nonsense! but i put this for addr compatibility as temporary)
 10542                                  	; 15/12/2022
 10543                                  	;mov	ds,[cs:DosDSeg] ; 15/05/2019
 10544                                  
 10545 00001657 31DB                    	XOR	BX,BX			; dup all jfns
 10546                                  	;mov	cx,20
 10547                                  	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10548                                  	;MOV	CX,FILPERPROC		; only 20 of them
 10549                                  	; 15/12/2022
 10550 00001659 B114                    	mov	cl,FILPERPROC ; 06/07/2019
 10551                                  
 10552                                  Create_dup_jfn:
 10553 0000165B 06                      	PUSH	ES ;**			; save new PDB
 10554 0000165C E8F95C                  	call	SFFromHandle		; get sf pointer
 10555 0000165F B0FF                    	MOV	AL,-1			; unassigned JFN
 10556 00001661 7224                    	JC	short CreateStash	; file was not really open
 10557                                  	;;test	word [es:di+5],1000h
 10558                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_no_inherit
 10559                                  	; 15/05/2019
 10560                                  	;test	byte [es:di+6],10h
 10561 00001663 26F6450610              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_no_inherit>>8)
 10562 00001668 751D                    	JNZ	short CreateStash	; if no-inherit bit is set, skip dup.
 10563                                  
 10564                                  ; We do not inherit network file handles.
 10565                                  
 10566                                  	;mov	ah,[es:di+2]
 10567 0000166A 268A6502                	MOV	AH,[ES:DI+SF_ENTRY.sf_mode]
 10568                                  	;and	ah,0F0h
 10569 0000166E 80E4F0                  	AND	AH,SHARING_MASK
 10570                                  	;cmp	ah,70h
 10571 00001671 80FC70                  	CMP	AH,SHARING_NET_FCB
 10572 00001674 7411                    	jz	short CreateStash
 10573                                  
 10574                                  ; The handle we have found is duplicatable (and inheritable). Perform
 10575                                  ; duplication operation.
 10576                                  
 10577 00001676 893E[9E05]              	MOV	[THISSFT],DI
 10578 0000167A 8C06[A005]              	MOV	[THISSFT+2],ES
 10579 0000167E E86619                  	call	DOS_DUP 		; signal duplication
 10580                                  
 10581                                  ; get the old sfn for copy
 10582                                  
 10583 00001681 E8B75C                  	call	pJFNFromHandle		; ES:DI is jfn
 10584 00001684 268A05                  	MOV	AL,[ES:DI]		; get sfn
 10585                                  
 10586                                  ; Take AL (old sfn or -1) and stash it into the new position
 10587                                  
 10588                                  CreateStash:
 10589 00001687 07                      	POP	ES ;**
 10590                                  	;mov	[es:bx+18h],al
 10591 00001688 26884718                	MOV	[ES:BX+PDB.JFN_TABLE],AL ; copy into new place!
 10592 0000168C 43                      	INC	BX			; next jfn...
 10593 0000168D E2CC                    	LOOP	Create_dup_jfn
 10594                                  
 10595 0000168F 8B1E[3003]              	MOV	BX,[CurrentPDB]		; get current process
 10596                                  	; 06/11/2022
 10597                                  	;mov	[es:16h],bx
 10598 00001693 26891E1600              	MOV	[ES:PDB.PARENT_PID],BX	; stash in child
 10599 00001698 8C06[3003]              	MOV	[CurrentPDB],ES
 10600                                  	;MOV	DS,BX ; 28/07/2019
 10601                                  	; 07/12/2022
 10602                                  	;mov	ds,[cs:DosDSeg]
 10603                                  	; 15/12/2022
 10604                                  	; ds = [cs:DosDSeg]
 10605 0000169C C606[A803]00            	mov	byte [CreatePDB],0	; reset flag
 10606                                  	;mov	ds,bx
 10607                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10608                                  	; 15/12/2022
 10609                                  	;mov	ds,bx
 10610                                  
 10611                                  ; end of new process create
 10612                                  
 10613                                  Create_PDB_cont:
 10614                                  	;MOV	BYTE [CS:CreatePDB],0	; reset flag
 10615                                  
 10616                                  ;hkn; It comes to this point from 2 places. So, change to DOSDATA temporarily	
 10617                                  
 10618                                  	;; 28/07/2019
 10619                                  	;;push	ds
 10620                                  	;;mov	ds,[cs:DosDSeg]
 10621                                  	;mov	byte [CreatePDB],0
 10622                                  	;;pop	ds
 10623                                  
 10624                                  ; 05/12/2022
 10625                                  ;	; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 10626                                  ;	; (push-pop ds is nonsense here! 
 10627                                  ;	;  but i am using same code with original MSDOS.SYS
 10628                                  ;	;  for address compatibility.)
 10629                                  ;	push	ds
 10630                                  ;	; ds = [cs:DosDSeg] !
 10631                                  ;	mov	ds,[cs:DosDSeg]  ; again !
 10632                                  ;	mov	byte [CreatePDB],0
 10633                                  ;	pop	ds
 10634                                  
 10635 000016A1 58                      	POP	AX ;*
 10636                                  
 10637                                  	;entry	SETMEM
 10638                                  
 10639                                  	; 17/12/2022
 10640                                  	; cx = 0
 10641                                  
 10642                                  ;---------------------------------------------------------------------------
 10643                                  ; Inputs:
 10644                                  ;	AX = Size of memory in paragraphs
 10645                                  ;	DX = Segment
 10646                                  ; Function:
 10647                                  ;	Completely prepares a program base at the
 10648                                  ;	specified segment.
 10649                                  ; Called at DOS init
 10650                                  ; Outputs:
 10651                                  ;	DS = DX
 10652                                  ;	ES = DX
 10653                                  ;	[0] has INT int_abort
 10654                                  ;	[2] = First unavailable segment
 10655                                  ;	[5] to [9] form a long call to the entry point
 10656                                  ;	[10] to [13] have exit address (from int_terminate)
 10657                                  ;	[14] to [17] have ctrl-C exit address (from int_ctrl_c)
 10658                                  ;	[18] to [21] have fatal error address (from int_fatal_abort)
 10659                                  ; DX,BP unchanged. All other registers destroyed.
 10660                                  ;---------------------------------------------------------------------------
 10661                                  
 10662                                  SETMEM:
 10663                                  	;XOR	CX,CX
 10664                                  	; 17/12/2022
 10665                                  	; cx = 0
 10666 000016A2 8ED9                    	MOV	DS,CX
 10667 000016A4 8EC2                    	MOV	ES,DX
 10668                                  	;mov	si,88h
 10669 000016A6 BE8800                  	MOV	SI,addr_int_terminate
 10670                                  	;mov	di,10 ; 0Ah
 10671 000016A9 BF0A00                  	MOV	DI,SAVEXIT
 10672                                  	;MOV	CX,6
 10673                                  	; 15/12/2022
 10674 000016AC B106                    	mov	cl,6
 10675 000016AE F3A5                    	REP	MOVSW
 10676 000016B0 26A30200                	MOV	[ES:2],AX
 10677 000016B4 29D0                    	SUB	AX,DX
 10678 000016B6 3DFF0F                  	CMP	AX,MAXDIF ; 0FFFh
 10679 000016B9 7603                    	JBE	short HAVDIF
 10680 000016BB B8FF0F                  	MOV	AX,MAXDIF
 10681                                  HAVDIF:
 10682 000016BE 83E810                  	SUB	AX,10h			; Allow for 100h byte "stack"
 10683 000016C1 BB0C00                  	MOV	BX,ENTRYPOINTSEG ; 0Ch	;	in .COM files
 10684 000016C4 29C3                    	SUB	BX,AX
 10685 000016C6 B104                    	MOV	CL,4
 10686 000016C8 D3E0                    	SHL	AX,CL
 10687 000016CA 8EDA                    	MOV	DS,DX
 10688                                  
 10689                                  	; (MSDOS 6.0 note)
 10690                                  	;
 10691                                  	; The address in BX:AX will be F01D:FEF0 if there is 64K or more 
 10692                                  	; memory in the system. This is equivalent to 0:c0 if A20 is OFF.
 10693                                  	; If DOS is in HMA this equivalence is no longer valid as A20 is ON.
 10694                                  	; But the BIOS which now resides in FFFF:30 has 5 bytes in FFFF:D0
 10695                                  	; (F01D:FEF0) which is the same as the ones in 0:C0, thereby 
 10696                                  	; making this equvalence valid for this particular case. If however
 10697                                  	; there is less than 64K remaining the address in BX:AX will not 
 10698                                  	; be the same as above. We will then stuff 0:c0, the call 5 address
 10699                                  	; into the PSP.
 10700                                  	;
 10701                                  	; Therefore for the case where there is less than 64K remaining in 
 10702                                  	; the system old CPM Apps that look at PSP:6 to determine memory
 10703                                  	; requirements will not work. Call 5, however will continue to work
 10704                                  	; for all cases.
 10705                                  	;
 10706                                  
 10707                                  	;mov	[6],ax
 10708                                  	;mov	[8],bx
 10709                                  
 10710 000016CC A30600                  	MOV	[PDB.CPM_CALL+1],AX
 10711 000016CF 891E0800                	MOV	[PDB.CPM_CALL+3],BX
 10712                                  
 10713                                  	; 06/05/2019 - Retro DOS v4.0
 10714 000016D3 3DF0FE                  	cmp	ax,WRAPOFFSET ; 0FEF0h	; Q: does the system have >= 64k of
 10715                                  					;    memory left
 10716 000016D6 740C                    	je	short addr_ok		; Y: the above calculated address is
 10717                                  					;    OK
 10718                                  					; N: 
 10719                                  
 10720 000016D8 C7060600C000            	MOV	WORD [PDB.CPM_CALL+1],0C0h
 10721 000016DE C70608000000            	MOV	WORD [PDB.CPM_CALL+3],0
 10722                                  addr_ok:
 10723                                  	;mov	word [0],20CDh
 10724 000016E4 C7060000CD20            	MOV	word [PDB.EXIT_CALL],(int_abort*256) + mi_INT
 10725                                  	;mov	byte [5],9Ah
 10726 000016EA C60605009A              	MOV	BYTE [PDB.CPM_CALL],mi_Long_CALL
 10727                                  	;mov	word [50h],21CDh
 10728 000016EF C7065000CD21            	MOV	WORD [PDB.CALL_SYSTEM],(int_command*256) + mi_INT
 10729                                  	;mov	byte [52h],0CBh
 10730 000016F5 C6065200CB              	MOV	BYTE [PDB.CALL_SYSTEM+2],mi_Long_RET
 10731                                  	;mov	word [34h],18h
 10732 000016FA C70634001800            	MOV	WORD [PDB.JFN_Pointer],PDB.JFN_TABLE
 10733                                  	;mov	word [36h],ds
 10734 00001700 8C1E3600                	MOV	WORD [PDB.JFN_Pointer+2],DS
 10735                                  	;mov	word [32h],20
 10736 00001704 C70632001400            	MOV	WORD [PDB.JFN_Length],FILPERPROC
 10737                                  ;
 10738                                  ; The server runs several PDB's without creating them VIA EXEC.  We need to
 10739                                  ; enumerate all PDB's at CPS time in order to find all references to a
 10740                                  ; particular SFT.  We perform this by requiring that the server link together
 10741                                  ; for us all sub-PDB's that he creates. The requirement for us, now, is to
 10742                                  ; initialize this pointer.
 10743                                  ;
 10744                                   	;mov	word [38h],-1
 10745 0000170A C7063800FFFF            	MOV	word [PDB.Next_PDB],-1
 10746                                  	;mov	word [3Ah],-1
 10747 00001710 C7063A00FFFF            	MOV	word [PDB.Next_PDB+2],-1
 10748                                  
 10749                                  	; 06/05/2019
 10750                                  	; Set the real version number in the PSP - 5.00
 10751                                  
 10752                                  	;mov	word [es:PDB.Version],1406h ; MSDOS 6.21 (DOSCODE:4FB6h)
 10753                                  	; 07/12/2022
 10754 00001716 26C7064000070A          	mov	word [ES:PDB.Version],(MINOR_VERSION*256)+MAJOR_VERSION
 10755                                  
 10756 0000171D C3                      	retn
 10757                                  
 10758                                  ; 29/04/2019 - Retro DOS v4.0
 10759                                  
 10760                                  ;BREAK <$GSetMediaID -- get set media ID>
 10761                                  
 10762                                  ;---------------------------------------------------------------------------
 10763                                  ; Inputs:
 10764                                  ;	BL= drive number as defined in IOCTL
 10765                                  ;	AL= 0 get media ID
 10766                                  ;	    1 set media ID
 10767                                  ;	DS:DX= buffer containing information
 10768                                  ;		DW  0  info level (set on input)
 10769                                  ;		DD  ?  serial #
 10770                                  ;		DB  11 dup(?)  volume id
 10771                                  ;		DB   8 dup(?)  file system type
 10772                                  ; Function:
 10773                                  ;	Get or set media ID
 10774                                  ; Returns:
 10775                                  ;	carry clear, DS:DX is filled
 10776                                  ;	carry set, error
 10777                                  ;---------------------------------------------------------------------------
 10778                                  
 10779                                  	; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 10780                                  
 10781                                  ; 14/01/2024
 10782                                  %if 0
 10783                                  
 10784                                  _$GSetMediaID:
 10785                                  	; RAWIO - GET_MEDIA_ID
 10786                                  	mov	cx,0866h	      ;AN000;MS.; assume get for IOCTL
 10787                                  	cmp	al,0		      ;AN001;MS.; get ?
 10788                                  	je	short doioctl 	      ;AN000;MS.; yes
 10789                                  	;cmp	al,1		      ;AN000;MS.; set ?
 10790                                  	;jne	short errorfunc	      ;AN000;MS.; no
 10791                                  	; 15/12/2022
 10792                                  	dec	al
 10793                                  	jnz	short errorfunc ; al > 1
 10794                                  	; RAWIO - SET_MEDIA_ID
 10795                                  	;mov	cx,0846h	      ;AN001;MS.;
 10796                                  	; 15/12/2022
 10797                                  	mov	cl,46h	; cx = 0846h
 10798                                  doioctl:			      ;AN000;
 10799                                  	mov	al,0Dh		      ;AN000;MS.; generic IOCTL
 10800                                  	;invoke	$IOCTL		      ;AN000;MS.; let IOCTL take care of it
 10801                                  	;call	_$IOCTL
 10802                                  	;retn			      ;AN000;MS.;
 10803                                  	; 15/12/2022
 10804                                  	jmp	_$IOCTL
 10805                                  errorfunc:			      ;AN000;
 10806                                  	;error	error_invalid_function;AN000;MS. ; invalid function
 10807                                  	;mov	al,1
 10808                                  	mov	al,error_invalid_function
 10809                                  	jmp	SYS_RET_ERR
 10810                                  
 10811                                  %else
 10812                                  	; 14/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 10813                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:5667h
 10814                                  
 10815                                  _$GSetMediaID:
 10816 0000171E 1E                      	push	ds
 10817 0000171F 56                      	push	si
 10818 00001720 36C536[A205]            	lds	si,[ss:THISCDS]
 10819 00001725 C57445                  	lds	si,[si+45h]		; [si+curdir.devptr]
 10820                                  					; local pointer to DPB or net device
 10821 00001728 8B740F                  	mov	si,[si+0Fh]		; [si+DPB.FAT_SIZE]
 10822 0000172B B96608                  	mov	cx,0866h		; assume get for IOCTL
 10823 0000172E 3C01                    	cmp	al,1			; set ?
 10824 00001730 7208                    	jb	short doioctl1		; get
 10825 00001732 7733                    	ja	short errorfunc		; invalid
 10826 00001734 B146                    	mov	cl,46h	; cx = 0846h
 10827                                  	;or	si,si
 10828 00001736 21F6                    	and	si,si ; 14/01/2024
 10829 00001738 7424                    	jz	short doioctl2
 10830                                  doioctl1:
 10831 0000173A 09F6                    	or	si,si
 10832 0000173C 7522                    	jnz	short doioctl
 10833 0000173E 1F                      	pop	ds
 10834 0000173F 1E                      	push	ds
 10835 00001740 89D6                    	mov	si,dx	; disk info
 10836                                  			; .................................
 10837                                  			;
 10838                                  			; 00h    WORD    0000h (info level)
 10839                                  			; 02h    DWORD   disk serial number (binary)
 10840                                  			; 06h 11 BYTEs   volume label or "NO NAME    " if none present
 10841                                  			; 11h  8 BYTEs   (AL=00h only) filesystem type
 10842                                  			;		"FAT12   "
 10843                                  			;		"FAT16   "
 10844                                  			;		"FAT32   " ; PCDOS 7.1
 10845                                  			;		"CDROM   "
 10846                                  			;		"CD001   " 
 10847                                  			;		"CDAUDIO "
 10848                                  			; .................................
 10849                                  			; (ref: Ralf Brown's Interrupt List) 		
 10850                                  
 10851 00001742 817C114641              	cmp	word [si+11h],4146h ; 'FA'
 10852 00001747 7517                    	jne	short doioctl
 10853 00001749 817C135433              	cmp	word [si+13h],3354h ; 'T3'
 10854 0000174E 7510                    	jne	short doioctl
 10855 00001750 817C153220              	cmp     word [si+15h],2032h ; '2 '
 10856 00001755 7509                    	jne	short doioctl
 10857 00001757 817C172020              	cmp	word [si+17h],2020h ; '  '
 10858 0000175C 7502                    	jne	short doioctl
 10859                                  doioctl2:
 10860 0000175E B548                    	mov	ch,48h	; cx = 4846h
 10861                                  doioctl:
 10862 00001760 5E                      	pop	si
 10863 00001761 1F                      	pop	ds
 10864 00001762 B00D                    	mov	al,0Dh			; generic IOCTL
 10865                                  	;call	_$IOCTL
 10866                                          ;retn
 10867 00001764 E9BF10                  	jmp	_$IOCTL			; let IOCTL take care of it
 10868                                  errorfunc:
 10869 00001767 B001                    	mov	al,1			; error_invalid_function
 10870 00001769 E909EF                  	jmp	SYS_RET_ERR
 10871                                  
 10872                                  %endif
 10873                                  
 10874                                  ; 16/05/2019 - Retro DOS v4.0
 10875                                  
 10876                                  ;============================================================================
 10877                                  ; MISC2.ASM, MSDOS 6.0, 1991
 10878                                  ;============================================================================
 10879                                  ; 20/07/2018 - Retro DOS v3.0
 10880                                  ; 29/04/2019 - Retro DOS v4.0
 10881                                  
 10882                                  ; Break <STRCMP - compare two ASCIZ strings DS:SI to ES:DI>
 10883                                  ;----------------------------------------------------------------------------
 10884                                  ;
 10885                                  ;   Strcmp - compare ASCIZ DS:SI to ES:DI. Case INSENSITIVE. '/' = '\'
 10886                                  ;	     Strings of different lengths don't match.
 10887                                  ;   Inputs:  DS:SI - pointer to source string  ES:DI - pointer to dest string
 10888                                  ;   Outputs: Z if strings same, NZ if different
 10889                                  ;   Registers modified: NONE
 10890                                  ;----------------------------------------------------------------------------
 10891                                  
 10892                                  	; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 10893                                  
 10894                                  	; 14/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 10895                                  	; (PCDOS 7.1 IBMDOS.COM DOSCODE:56B6h)
 10896                                  	; (MSDOS 6.22 MSDOS.SYS DOSCODE:4FD7h)
 10897                                  StrCmp:
 10898 0000176C 56                      	push	si
 10899 0000176D 57                      	push	di
 10900 0000176E 50                      	push	ax
 10901                                  Cmplp:
 10902 0000176F AC                      	LODSB
 10903 00001770 E8CA42                  	call	UCase			; convert to upper case
 10904 00001773 E81A43                  	call	PATHCHRCMP		; convert '/' to '\' ; 07/12/2022 ('\')
 10905 00001776 88C4                    	MOV	AH,AL
 10906 00001778 268A05                  	MOV	AL,[ES:DI]
 10907 0000177B 47                      	INC	DI
 10908 0000177C E8BE42                  	call	UCase			; convert to upper case
 10909 0000177F E80E43                  	call	PATHCHRCMP		; convert '/' to '\' ; 07/12/2022 ('\')
 10910 00001782 38C4                    	CMP	AH,AL
 10911 00001784 7504                    	JNZ	short PopRet		; Strings dif
 10912                                  
 10913 00001786 08C0                    	OR	AL,AL
 10914 00001788 75E5                    	JNZ	short Cmplp		; More string
 10915                                  PopRet:
 10916 0000178A 58                      	pop	ax
 10917 0000178B 5F                      	pop	di
 10918 0000178C 5E                      	pop	si
 10919 0000178D C3                      	retn
 10920                                  
 10921                                  ;Break <STRCPY - copy ASCIZ string from DS:SI to ES:DI>
 10922                                  ;----------------------------------------------------------------------------
 10923                                  ;
 10924                                  ;   Strcpy - copy an ASCIZ string from DS:SI to ES:DI and make uppercase
 10925                                  ;   FStrcpy - copy an ASCIZ string from DS:SI to ES:DI. no modification of
 10926                                  ;	characters.
 10927                                  ;
 10928                                  ;   Inputs:	DS:SI - pointer to source string
 10929                                  ;		ES:DI - pointer to destination string
 10930                                  ;   Outputs:	ES:DI point byte after nul byte at end of dest string
 10931                                  ;		DS:SI point byte after nul byte at end of source string
 10932                                  ;   Registers modified: SI,DI
 10933                                  ;----------------------------------------------------------------------------
 10934                                  
 10935                                  StrCpy:
 10936 0000178E 50                      	push	ax
 10937                                  CPYLoop:
 10938 0000178F AC                      	LODSB
 10939 00001790 E8AA42                  	call	UCase			; convert to upper case
 10940 00001793 E8FA42                  	call	PATHCHRCMP		; convert / to \ ;
 10941 00001796 AA                      	STOSB
 10942                                  
 10943 00001797 08C0                    	OR	AL,AL
 10944 00001799 75F4                    	JNZ	short CPYLoop
 10945 0000179B 58                      	pop	ax
 10946 0000179C C3                      	retn
 10947                                  
 10948                                  ;----------------------------------------------------------------------------
 10949                                  ; Procedure Name : FStrCpy
 10950                                  ;----------------------------------------------------------------------------
 10951                                  
 10952                                  FStrCpy:
 10953 0000179D 50                      	push	ax
 10954                                  FCPYLoop:
 10955 0000179E AC                      	LODSB
 10956 0000179F AA                      	STOSB
 10957 000017A0 08C0                    	OR	AL,AL
 10958 000017A2 75FA                    	JNZ	short FCPYLoop
 10959 000017A4 58                      	pop	ax
 10960 000017A5 C3                      	retn
 10961                                  
 10962                                  ; 20/07/2018 - Retro DOS v3.0
 10963                                  ;----------------------------------------------------------------------------
 10964                                  ; UCase, IBMDOS.COM (MSDOS 3.3), 1987 - Offset 1E2Fh
 10965                                  ;----------------------------------------------------------------------------
 10966                                  ;
 10967                                  ;UCase:	
 10968                                  ;	call	_UCase	 ; Offset 5518h (GetLet, Offset 5517h)
 10969                                  ;	retn
 10970                                  
 10971                                  ;Break <StrLen - compute length of string ES:DI>
 10972                                  ;----------------------------------------------------------------------------
 10973                                  ;**	StrLen - Compute Length of String
 10974                                  ;
 10975                                  ;	StrLen computes the length of a string, including the trailing 00
 10976                                  ;
 10977                                  ;	ENTRY	(es:di) = address of string
 10978                                  ;	EXIT	(cx) = size of string
 10979                                  ;	USES	cx, flags
 10980                                  ;----------------------------------------------------------------------------
 10981                                  
 10982                                  StrLen:
 10983 000017A6 57                      	push	di
 10984 000017A7 50                      	push	ax
 10985                                  	;MOV	CX,-1
 10986 000017A8 B9FFFF                  	mov	cx,65535
 10987 000017AB 30C0                    	XOR	AL,AL
 10988 000017AD F2AE                    	REPNE	SCASB
 10989 000017AF F7D1                    	NOT	CX
 10990 000017B1 58                      	pop	ax
 10991 000017B2 5F                      	pop	di
 10992 000017B3 C3                      	retn
 10993                                  
 10994                                  ;----------------------------------------------------------------------------
 10995                                  ;**	DStrLen - Compute Length of String
 10996                                  ;
 10997                                  ;	ENTRY	(ds:si) = address of string
 10998                                  ;	EXIT	(cx) = size of string, including trailing NUL
 10999                                  ;	USES	cx, flags
 11000                                  ;----------------------------------------------------------------------------
 11001                                  
 11002                                  DStrLen:	; BUGBUG - this guy is a pig, who uses him?
 11003 000017B4 E80300                  	CALL	XCHGP
 11004 000017B7 E8ECFF                  	CALL	StrLen
 11005                                  	;CALL	XCHGP
 11006                                  	;retn
 11007                                  	; 18/12/2022
 11008                                  	;jmp	short XCHGP
 11009                                  
 11010                                  ;----------------------------------------------------------------------------
 11011                                  ;**	XCHGP - Exchange Source and Destination Pointers
 11012                                  ;
 11013                                  ;	XCHGP exchanges (DS:SI) and (ES:DI)
 11014                                  ;
 11015                                  ;	ENTRY	none
 11016                                  ;	EXIT	pairs exchanged
 11017                                  ;	USES	SI, DI, DS, ES
 11018                                  ;----------------------------------------------------------------------------
 11019                                  
 11020                                  XCHGP:
 11021 000017BA 1E                      	push	ds
 11022 000017BB 06                      	push	es
 11023 000017BC 1F                      	pop	ds
 11024 000017BD 07                      	pop	es
 11025 000017BE 87FE                    	XCHG	SI,DI
 11026                                  xchgp_retn:
 11027 000017C0 C3                      	retn
 11028                                  
 11029                                  ;Break	<Idle - wait for a specified amount of time>
 11030                                  ;----------------------------------------------------------------------------
 11031                                  ;
 11032                                  ;   Idle - when retrying an operation due to a lock/sharing violation,
 11033                                  ;   	   we spin until RetryLoop is exhausted.
 11034                                  ;
 11035                                  ;   Inputs:	RetryLoop is the number of times we spin
 11036                                  ;   Outputs:	Wait
 11037                                  ;   Registers modified: none
 11038                                  ;----------------------------------------------------------------------------
 11039                                  
 11040                                  Idle:
 11041                                  	;test	byte [SS:FSHARING],0FFh
 11042 000017C1 36803E[7205]00          	cmp	byte [SS:FSHARING],0	;hkn; SS override
 11043                                  	;retnz
 11044 000017C7 75F7                    	jnz	short xchgp_retn
 11045                                  	;SAVE	<CX>
 11046 000017C9 51                      	push	cx
 11047 000017CA 368B0E[1C00]            	MOV	CX,[ss:RetryLoop]	;hkn; SS override
 11048 000017CF E308                    	JCXZ	Idle3
 11049                                  Idle1:	
 11050 000017D1 51                      	PUSH	CX
 11051 000017D2 31C9                    	XOR	CX,CX
 11052                                  Idle2:	
 11053 000017D4 E2FE                    	LOOP	Idle2
 11054 000017D6 59                      	POP	CX
 11055 000017D7 E2F8                    	LOOP	Idle1
 11056                                  Idle3:	
 11057                                  	;RESTORE <CX>
 11058 000017D9 59                      	pop	cx
 11059 000017DA C3                      	retn
 11060                                  
 11061                                  ;Break	<TableDispatch - dispatch to a table>
 11062                                  ;----------------------------------------------------------------------------
 11063                                  ;
 11064                                  ;   TableDispatch - given a table and an index, jmp to the approptiate
 11065                                  ;   routine. Preserve all input registers to the routine.
 11066                                  ;
 11067                                  ;   Inputs:	Push	return address
 11068                                  ;		Push	Table address
 11069                                  ;		Push	index (byte)
 11070                                  ;   Outputs:	appropriate routine gets jumped to.
 11071                                  ;		return indicates invalid index
 11072                                  ;   Registers modified: none.
 11073                                  ;----------------------------------------------------------------------------
 11074                                  
 11075                                  struc TFrame	 ; TableFrame
 11076 00000000 ????                    .OldBP:	 resw 1  ; 0
 11077 00000002 ????                    .OldRet: resw 1  ; 2
 11078 00000004 ??                      .Index:	 resb 1  ; 4
 11079 00000005 ??                      .Pad:	 resb 1  ; 5  
 11080 00000006 ????                    .Tab:	 resw 1  ; 6
 11081 00000008 ????                    .NewRet: resw 1  ; 8
 11082                                  endstruc
 11083                                  
 11084                                  TableDispatch:
 11085 000017DB 55                      	PUSH	BP
 11086 000017DC 89E5                    	MOV	BP,SP
 11087 000017DE 53                      	PUSH	BX			; save BX
 11088                                  	;mov	bx,[bp+6]
 11089 000017DF 8B5E06                  	MOV	BX,[BP+TFrame.Tab]	; get pointer to table
 11090 000017E2 2E8A1F                  	MOV	BL,[CS:BX]		; maximum index
 11091                                  	;cmp	[bp+4],bl
 11092 000017E5 385E04                  	CMP	[BP+TFrame.Index],BL	; table error?
 11093 000017E8 7317                    	JAE	short TableError	; yes
 11094                                  	;mov	bl,[bp+4]
 11095 000017EA 8A5E04                  	MOV	BL,[BP+TFrame.Index]	; get desired table index
 11096 000017ED 30FF                    	XOR	BH,BH			; convert to word
 11097 000017EF D1E3                    	SHL	BX,1			; convert to word pointer
 11098 000017F1 43                      	INC	BX			; point past first length byte
 11099                                  	; 17/08/2018
 11100                                  	;add	bx,[bp+6]
 11101 000017F2 035E06                  	ADD	BX,[BP+TFrame.Tab]	; get real offset
 11102 000017F5 2E8B1F                  	MOV	BX,[CS:BX]		; get contents of table entry
 11103                                  	;mov	[bp+6],bx
 11104 000017F8 895E06                  	MOV	[BP+TFrame.Tab],BX	; put table entry into return address
 11105 000017FB 5B                      	POP	BX			; restore BX
 11106 000017FC 5D                      	POP	BP			; restore BP
 11107 000017FD 83C404                  	ADD	SP,4			; clean off Index and our return addr
 11108 00001800 C3                      	retn				; do operation
 11109                                  TableError:
 11110 00001801 5B                      	POP	BX			; restore BX
 11111 00001802 5D                      	POP	BP			; restore BP
 11112 00001803 C20600                  	RETN	6			; clean off Index, Table and RetAddr
 11113                                  
 11114                                  ;Break	<TestNet - determine if a CDS is for the network>
 11115                                  ;----------------------------------------------------------------------------
 11116                                  ;
 11117                                  ;   TestNet - examine CDS pointed to by ThisCDS and see if it indicates a
 11118                                  ;	network CDS. This will handle NULL cds also.
 11119                                  ;
 11120                                  ;   Inputs:	ThisCDS points to CDS or NULL
 11121                                  ;   Outputs:	ES:DI = ThisCDS
 11122                                  ;		carry Set => network
 11123                                  ;		carry Clear => local
 11124                                  ;   Registers modified: none.
 11125                                  ;----------------------------------------------------------------------------
 11126                                  
 11127                                  TestNet:
 11128                                  	;LES	DI,[CS:THISCDS]
 11129                                  
 11130                                  	; 16/05/2019 - Retro DOS v4.0
 11131 00001806 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 11132 0000180B 26C43E[A205]            	LES	DI,[ES:THISCDS]
 11133 00001810 83FFFF                  	CMP	DI,-1
 11134 00001813 7408                    	JZ	short CMCRet		; UNC? carry is clear
 11135                                  	;;test	word [es:di+43h],8000h
 11136                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
 11137                                  	;test	byte [es:di+44h],80h
 11138 00001815 26F6454480              	TEST	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8)
 11139 0000181A 7501                    	JNZ	short CMCRet		; jump has carry clear
 11140 0000181C C3                      	retn				; carry is clear
 11141                                  CMCRet: 
 11142 0000181D F5                      	CMC
 11143 0000181E C3                      	retn
 11144                                  
 11145                                  ;Break	<IsSFTNet - see if an sft is for the network>
 11146                                  ;----------------------------------------------------------------------------
 11147                                  ;
 11148                                  ;   IsSFTNet - examine SF pointed to by ES:DI and see if it indicates a
 11149                                  ;	network file.
 11150                                  ;
 11151                                  ;   Inputs:	ES:DI point to SFT
 11152                                  ;   Outputs:	Zero set if not network sft
 11153                                  ;		zero reset otherwise
 11154                                  ;		Carry CLEAR!!!
 11155                                  ;   Registers modified: none.
 11156                                  ;----------------------------------------------------------------------------
 11157                                  
 11158                                  IsSFTNet:
 11159                                  	;;test	word [es:di+5],8000h
 11160                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 11161                                  	; 16/05/2019 
 11162                                  	;test	byte [es:di+6],80h
 11163 0000181F 26F6450680              	TEST	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 11164 00001824 C3                      	retn
 11165                                  
 11166                                  ;----------------------------------------------------------------------------
 11167                                  
 11168                                  	; 07/03/2025 - MiniDOS 1.0
 11169                                  FastInit:
 11170                                  	; 16/03/2025
 11171 00001825 31C0                    	xor ax, ax
 11172                                  	;stc
 11173 00001827 C3                      	retn
 11174                                  
 11175                                  ;----------------------------------------------------------------------------
 11176                                  
 11177                                  ;Break	<NLS_OPEN - do $open for NLSFUNC>
 11178                                  ;----------------------------------------------------------------------------
 11179                                  ;   DOS 3.3   6/10/86
 11180                                  ;   NLS_OPEN	- call $OPEN for NLSFUNC
 11181                                  ;
 11182                                  ;   Inputs:	Same input as $OPEN except CL = mode
 11183                                  ;   Outputs:	same output as $OPEN
 11184                                  ;
 11185                                  ;----------------------------------------------------------------------------
 11186                                  
 11187                                  ;hkn; NOTE! SS MUST HAVE BEEN SET UP TO DOSDATA BY THE TIME THESE
 11188                                  ;hkn; NLS FUNCTIONS ARE CALLED!!! THERE FORE WE WILL USE SS OVERRIDES
 11189                                  ;hkn; IN ORDER TO ACCESS DOS DATA VARIABLES!
 11190                                  
 11191                                  NLS_OPEN:
 11192                                  ;	MOV	BL,[CPSWFLAG]	 ; disable code page matching logic
 11193                                  ;	MOV	BYTE [CPSWFLAG],0
 11194                                  ;	PUSH	BX		 ; save current state
 11195                                  
 11196 00001828 88C8                    	MOV	AL,CL		 ; set up correct interface for $OPEN
 11197 0000182A E82164                  	call	_$OPEN
 11198                                  
 11199                                  ;	POP	BX		 ; restore current state
 11200                                  ;	MOV	[CPSWFLAG],BL
 11201                                  
 11202 0000182D C3                      	RETN
 11203                                  
 11204                                  ;Break	<NLS_LSEEK - do $LSEEK for NLSFUNC>
 11205                                  ;----------------------------------------------------------------------------
 11206                                  ;   DOS 3.3   6/10/86
 11207                                  ;   NLS_LSEEK	- call $LSEEK for NLSFUNC
 11208                                  ;
 11209                                  ;   Inputs:	BP = open mode
 11210                                  ;   Outputs:	same output as $LSEEK
 11211                                  ;
 11212                                  ;----------------------------------------------------------------------------
 11213                                  
 11214                                  ; 16/05/2019 - Retro DOS v4.0
 11215                                  
 11216                                  NLS_LSEEK:
 11217 0000182E 36FF36[8405]            	PUSH	word [SS:USER_SP] ; save user stack
 11218 00001833 36FF36[8605]            	PUSH	word [SS:USER_SS]
 11219 00001838 E81000                  	CALL	Fake_User_Stack
 11220 0000183B 89E8                    	MOV	AX,BP		; set up correct interface for $LSEEK
 11221 0000183D E81B5D                  	call	_$LSEEK
 11222                                  NLS_SEEK_RET:	; 26/06/2024
 11223 00001840 368F06[8605]            	POP	word [SS:USER_SS] ; restore user stack
 11224 00001845 368F06[8405]            	POP	word [SS:USER_SP]
 11225 0000184A C3                      	RETN
 11226                                  
 11227                                  ;Break	<Fake_User_Stack - save user stack>
 11228                                  ;----------------------------------------------------------------------------
 11229                                  ;   DOS 3.3   6/10/86
 11230                                  ;   Fake_User_Stack - save user stack pointer
 11231                                  ;
 11232                                  ;----------------------------------------------------------------------------
 11233                                  
 11234                                  Fake_User_Stack:
 11235 0000184B 36A1[9E0D]              	MOV	AX,[SS:USER_SP_2F] ; replace with INT 2Fh stack
 11236 0000184F 36A3[8405]              	MOV	[SS:USER_SP],AX
 11237 00001853 8CD0                    	MOV	AX,SS
 11238 00001855 36A3[8605]              	MOV	[SS:USER_SS],AX
 11239 00001859 C3                      	RETN
 11240                                  
 11241                                  ;Break	<GetDevList - get device header list pointer>
 11242                                  ;----------------------------------------------------------------------------
 11243                                  ;   DOS 3.3   7/25/86
 11244                                  ;   GetDevList - get device header list pointer
 11245                                  ;
 11246                                  ;   Output: AX:BX points to the device header list
 11247                                  ;----------------------------------------------------------------------------
 11248                                  
 11249                                  GetDevList:
 11250                                  	; 16/05/2019 - Retro DOS v4.0
 11251 0000185A BE[580D]                	MOV	SI,SysInitTable
 11252 0000185D 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 11253 00001862 C534                    	LDS	SI,[SI]
 11254                                  	;mov	ax,[si+34]  ; SSYSINITVARS offset 34 = [SI+SYSI.DEV]
 11255 00001864 8B4422                  	MOV	AX,[SI+SYSI.DEV]
 11256                                  	;mov	bx,[si+36]  ; SSYSINITVARS offset 36 = [SI+SYSI.DEV+2]
 11257 00001867 8B5C24                  	MOV	BX,[SI+SYSI.DEV+2]
 11258 0000186A C3                      	RETN
 11259                                  
 11260                                  ;Break	<NLS_IOCTL - do $IOCTL for NLSFUNC>
 11261                                  ;----------------------------------------------------------------------------
 11262                                  ;   DOS 3.3   7/25/86
 11263                                  ;   NLS_IOCTL	- call $IOCTL for NLSFUNC
 11264                                  ;
 11265                                  ;   Inputs:	BP = function code 0CH
 11266                                  ;   Outputs:	same output as generic $IOCTL
 11267                                  ;
 11268                                  ;----------------------------------------------------------------------------
 11269                                  
 11270                                  NLS_IOCTL:
 11271                                  	; 16/05/2019 - Retro DOS v4.0
 11272 0000186B 36FF36[8405]            	PUSH	word [SS:USER_SP] ; save user stack
 11273 00001870 36FF36[8605]            	PUSH	word [SS:USER_SS]
 11274 00001875 E8D3FF                  	CALL	Fake_User_Stack
 11275 00001878 89E8                    	MOV	AX,BP		; set up correct interface for $IOCTL
 11276 0000187A E8A90F                  	call	_$IOCTL
 11277                                  	;POP	word [SS:USER_SS] ; restore user stack
 11278                                  	;POP	word [SS:USER_SP]
 11279                                  	;RETN
 11280                                  	; 26/06/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 11281 0000187D EBC1                    	jmp	short NLS_SEEK_RET
 11282                                  
 11283                                  ;Break	<NLS_GETEXT- get extended error for NLSFUNC>
 11284                                  ;----------------------------------------------------------------------------
 11285                                  ;   DOS 3.3   7/25/86
 11286                                  ;   NLS_GETEXT	-
 11287                                  ;
 11288                                  ;   Inputs:	none
 11289                                  ;   Outputs:	AX = extended error
 11290                                  ;
 11291                                  ;----------------------------------------------------------------------------
 11292                                  
 11293                                  NLS_GETEXT:
 11294                                  	; 16/05/2019 - Retro DOS v4.0
 11295 0000187F 36A1[2403]              	MOV	AX,[SS:EXTERR]	 ; return extended error
 11296                                  	; 23/09/2023
 11297                                  MSG_RETRIEVAL:
 11298 00001883 C3                      	RETN
 11299                                  
 11300                                  ; 29/04/2019 - Retro DOS v4.0
 11301                                  
 11302                                  ;Break	<MSG_RETRIEVAL- get beginning addr of system and parser messages>
 11303                                  
 11304                                  ;----------------------------------------------------------------------------
 11305                                  ;   DOS 4.00
 11306                                  ;
 11307                                  ;   Inputs:	DL=0 get extended error message addr
 11308                                  ;		  =1 set extended error message addr
 11309                                  ;		  =2 get parser error message addr
 11310                                  ;		  =3 set parser error message addr
 11311                                  ;		  =4 get critical error message addr
 11312                                  ;		  =5 set critical error message addr
 11313                                  ;		  =6 get file system error message addr
 11314                                  ;		  =7 set file system error message addr
 11315                                  ;		  =8 get address for code reduction
 11316                                  ;		  =9 set address for code reduction
 11317                                  ;   Function:	get/set message address
 11318                                  ;   Outputs:	ES:DI points to addr when get
 11319                                  ;----------------------------------------------------------------------------
 11320                                  
 11321                                  ;Procedure MSG_RETRIEVAL,NEAR
 11322                                  ;	ASSUME	CS:DOSCODE,SS:NOTHING
 11323                                  
 11324                                  ; 23/09/2023
 11325                                  ;MSG_RETRIEVAL:
 11326                                  
 11327                                  ;;	NOTE:  This function lives in command.com resident code now.
 11328                                  ;;	If the int 2F ever gets this far, we'll return registers
 11329                                  ;;	unchanged, which produces the same result as before, if
 11330                                  ;;	command.com wasn't present (and therefore no messages available).
 11331                                  ;;
 11332                                  ;;	I didn't point the entry in the 2F table to No_Op because
 11333                                  ;;	No_Op zeroes AL.
 11334                                  ;;
 11335                                  ;;;hkn; set up ds to point to DOSDATA
 11336                                  ;;	push	ds
 11337                                  ;;	getdseg	<ds>			; ds -> dosdata
 11338                                  ;;
 11339                                  ;;	PUSH	AX		    ;AN000;;MS. save regs
 11340                                  ;;	PUSH	SI		    ;AN000;;MS. save regs
 11341                                  ;;	MOV	AX,DX		    ;AN000;;MS.
 11342                                  ;;	MOV	SI,OFFSET DOSDATA:MSG_EXTERROR ;AN000;;MS.
 11343                                  ;;	test	AL,1		    ;AN000;;MS. get ?
 11344                                  ;;	JZ	toget		    ;AN000;;MS. yes
 11345                                  ;;	DEC	AL		    ;AN000;;MS.
 11346                                  ;;toget:				    ;AN000;
 11347                                  ;;	SHL	AL,1		    ;AN000;;MS. times 2
 11348                                  ;;	XOR	AH,AH		    ;AN000;;MS.
 11349                                  ;;	ADD	SI,AX		    ;AN000;;MS. position to the entry
 11350                                  ;;	test	DL,1		    ;AN000;;MS. get ?
 11351                                  ;;	JZ	getget			     ;AN000;;MS. yes
 11352                                  ;;	MOV	WORD PTR DS:[SI],DI    ;AN000;;MS. set MSG
 11353                                  ;;	MOV	WORD PTR DS:[SI+2],ES  ;AN000;;MS. address to ES:DI
 11354                                  ;;	JMP	SHORT MSGret		     ;AN000;;MS. exit
 11355                                  ;;getget: 				     ;AN000;
 11356                                  ;;	LES	DI,DWORD PTR DS:[SI]	     ;AN000;;MS. get msg addr
 11357                                  ;;MSGret: 				     ;AN000;
 11358                                  ;;	POP	SI			     ;AN000;;MS.
 11359                                  ;;	POP	AX			     ;AN000;;MS.
 11360                                  ;;
 11361                                  ;;	pop	ds
 11362                                  
 11363                                  ;	return				     ;AN000;;MS. exit
 11364                                  
 11365                                  ; 23/09/2023
 11366                                  ;	retn	; 29/04/2019
 11367                                  
 11368                                  ;============================================================================
 11369                                  ; ECritDisk, LCritDisk, ECritDevice, LCritDevice
 11370                                  ; IBMDOS.COM (MSDOS 3.3), 1987 - Offset 1F36h
 11371                                  ;============================================================================
 11372                                  ; 20/07/2018 - Retro DOS v3.0
 11373                                  
 11374                                  ;	; MSDOS 3.3
 11375                                  ;	; 08/08/2018 - Retro DOS v3.0
 11376                                  ;ECritMEM:
 11377                                  ;ECritSFT:
 11378                                  ;	;
 11379                                  ;ECritDisk:
 11380                                  ;	retn
 11381                                  ;	;push	ax
 11382                                  ;	
 11383                                  ;	mov	ax,8001h
 11384                                  ;	int	2Ah	; Microsoft Networks - BEGIN DOS CRITICAL SECTION
 11385                                  ;			; AL = critical section number (00h-0Fh)
 11386                                  ;	pop	ax
 11387                                  ;	retn
 11388                                  ;
 11389                                  ;	; MSDOS 3.3
 11390                                  ;	; 08/08/2018 - Retro DOS v3.0
 11391                                  ;LCritMEM:
 11392                                  ;LCritSFT:
 11393                                  ;	;
 11394                                  ;LCritDisk:
 11395                                  ;	retn
 11396                                  ;	;push	ax
 11397                                  ;	
 11398                                  ;	mov	ax,8101h
 11399                                  ;	int	2Ah	; Microsoft Networks - END DOS CRITICAL SECTION
 11400                                  ;			; AL = critical section number (00h-0Fh)
 11401                                  ;	pop	ax
 11402                                  ;	retn
 11403                                  ;
 11404                                  ;ECritDevice:
 11405                                  ;	retn
 11406                                  ;	;push	ax
 11407                                  ;	
 11408                                  ;	mov	ax,8002h
 11409                                  ;	int	2Ah	; Microsoft Networks - BEGIN DOS CRITICAL SECTION
 11410                                  ;			; AL = critical section number (00h-0Fh)
 11411                                  ;	pop	ax
 11412                                  ;	retn
 11413                                  ;
 11414                                  ;LCritDevice:
 11415                                  ;	retn
 11416                                  ;	;push	ax
 11417                                  ;	
 11418                                  ;	mov	ax,8102h
 11419                                  ;	int	2Ah	; Microsoft Networks - END DOS CRITICAL SECTION
 11420                                  ;			; AL = critical section number (00h-0Fh)
 11421                                  ;	pop	ax
 11422                                  ;	retn
 11423                                  
 11424                                  ;============================================================================
 11425                                  ; CRIT.ASM, MSDOS 6.0, 1991
 11426                                  ;============================================================================
 11427                                  ; 12/05/2019 - Retro DOS v4.0
 11428                                  
 11429                                  ; Critical Section Routines
 11430                                  
 11431                                  ; MSDOS 6.21 - MSDOS.SYS - DOSCODE:513Ah
 11432                                  
 11433                                  ; 06/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 11434                                  ; DOSCODE:5126h (MSDOS 5.0 MSDOS.SYS)
 11435                                  
 11436                                  ; ---------------------------------------------------------------------------
 11437                                  ; Each handler must leave everything untouched; including flags!
 11438                                  ;
 11439                                  ; Sleaze for time savings: first instruction is a return. This is patched
 11440                                  ; by the sharer to be a PUSH AX to complete the correct routines.
 11441                                  ; ---------------------------------------------------------------------------
 11442                                  
 11443                                  ; (DOSMAC.INC, MSDOS 6.0, 1991)
 11444                                  ; ---------------------------------------------------------------------------
 11445                                  ; Some old versions of the 80286 have a bug in the chip. The popf instruction
 11446                                  ; will enable interrupts. Therefore in a section of code with interrupts
 11447                                  ; disabled and you need a popf instruction use the 'popff' macro instead.
 11448                                  ; ---------------------------------------------------------------------------
 11449                                  
 11450                                  ;%macro POPFF 0
 11451                                  ;	jmp	$+3
 11452                                  ;	iret
 11453                                  ;	push	cs
 11454                                  ;	call	$-2
 11455                                  ;%endmacro
 11456                                  
 11457                                  ; ---------------------------
 11458                                  
 11459                                  ; 14/01/2024 - Retro DOS v5.0
 11460                                  %if 0
 11461                                  
 11462                                  ;Procedure  ECritDisk,NEAR
 11463                                  	;public  ECritMEM
 11464                                  	;public  ECritSFT
 11465                                  ECritMEM:
 11466                                  ECritSFT:
 11467                                  ;
 11468                                  ECritDisk:
 11469                                  
 11470                                  ;SR; Check if critical section is to be entered
 11471                                  
 11472                                  	pushf
 11473                                  	cmp	byte [ss:redir_patch],0
 11474                                  	jz	short ECritDisk_2
 11475                                  
 11476                                  ; 06/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 11477                                  ;	;popff  ; * (macro)
 11478                                  ;	jmp	short ECritDisk_1 ; *
 11479                                  ;
 11480                                  ;ECritDisk_iret: ; *
 11481                                  ;	iret ; *
 11482                                  
 11483                                  	; 16/12/2022
 11484                                  	; 13/11/2022
 11485                                  	;jmp	short ECritDisk_1
 11486                                  	; 06/11/2022
 11487                                  ;ECritDisk_iret:
 11488                                  ;	iret	
 11489                                  
 11490                                  	; 06/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 11491                                  ECritDisk_1:
 11492                                  	push	cs ; *
 11493                                  	call	ECritDisk_iret ; *		
 11494                                  	
 11495                                  ECritDisk_0:
 11496                                  	PUSH    AX
 11497                                  	;MOV	AX,8000h+critDisk
 11498                                  	;INT	int_IBM
 11499                                  	mov	ax,8001h
 11500                                  	int	2Ah	; Microsoft Networks - BEGIN DOS CRITICAL SECTION
 11501                                  			; AL = critical section number (00h-0Fh)
 11502                                  	POP     AX
 11503                                  	retn
 11504                                  
 11505                                  	; 16/12/2022
 11506                                  	; 13/11/2022
 11507                                  ECritDisk_iret:  ; 12/05/2019 - Retro DOS v4.0
 11508                                  LCritDisk_iret: 
 11509                                  	iret
 11510                                  
 11511                                  ECritDisk_2:
 11512                                  	;;popff ; *
 11513                                  	;;retn
 11514                                  ;	jmp	short ECritDisk_3 ; *
 11515                                  ;ECritDisk_iret2: ; *
 11516                                  ;	iret
 11517                                  	
 11518                                  	; 16/12/2022
 11519                                  	; 13/11/2022
 11520                                  	;jmp	short ECritDisk_3
 11521                                  ;ECritDisk_iret2:
 11522                                  	;iret
 11523                                  
 11524                                  ECritDisk_3:
 11525                                  	push    cs ; *
 11526                                  	; 13/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 11527                                  	;call	ECritDisk_iret2 ; *
 11528                                  	;retn
 11529                                  	; 16/12/2022
 11530                                  	call	ECritDisk_iret
 11531                                  	retn
 11532                                  
 11533                                  ;EndProc ECritDisk
 11534                                  
 11535                                  ; ---------------------------
 11536                                  
 11537                                  ;Procedure   LCritDisk,NEAR
 11538                                  	;public  LCritMEM
 11539                                  	;public  LCritSFT
 11540                                  LCritMEM:
 11541                                  LCritSFT:
 11542                                  ;
 11543                                  LCritDisk:
 11544                                  
 11545                                  ;SR; Check if critical section is to be entered
 11546                                  
 11547                                  	pushf
 11548                                  	cmp	byte [ss:redir_patch],0
 11549                                  	jz	short LCritDisk_2
 11550                                  	;popff  ; * (macro)
 11551                                  ;	jmp	short LCritDisk_1 ; *
 11552                                  ;
 11553                                  ;LCritDisk_iret: ; *
 11554                                  ;	iret ; *
 11555                                  
 11556                                  	; 16/12/2022
 11557                                  	; 13/11/2022
 11558                                  	;jmp	short LCritDisk_1
 11559                                  ;LCritDisk_iret:
 11560                                  	;iret
 11561                                  
 11562                                  LCritDisk_1:
 11563                                  	push	cs ; *
 11564                                  	call	LCritDisk_iret ; *		
 11565                                  	
 11566                                  LCritDisk_0:
 11567                                  	PUSH	AX
 11568                                  	;MOV	AX,8100h+critDisk
 11569                                  	;INT	int_IBM
 11570                                  	mov	ax,8101h
 11571                                  	int	2Ah	; Microsoft Networks - END DOS CRITICAL SECTION
 11572                                  			; AL = critical section number (00h-0Fh)
 11573                                  	POP	AX
 11574                                  	retn
 11575                                  
 11576                                  ;LCritDisk_iret:  ; 12/05/2019 - Retro DOS v4.0 
 11577                                  ;	iret
 11578                                  
 11579                                  LCritDisk_2:
 11580                                  	;;popff ; *
 11581                                  	;;retn
 11582                                  ;	jmp	short LCritDisk_3 ; *
 11583                                  ;LCritDisk_iret2: ; *
 11584                                  ;	iret
 11585                                  
 11586                                  	; 16/12/2022
 11587                                  	; 13/11/2022
 11588                                  	;jmp	short LCritDisk_3
 11589                                  ;LCritDisk_iret2:
 11590                                  	;iret
 11591                                  
 11592                                  LCritDisk_3:
 11593                                  	push    cs ; *
 11594                                  	; 13/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 11595                                  	;call	LCritDisk_iret2 ; *
 11596                                  	;retn
 11597                                  	; 16/12/2022
 11598                                  	call	LCritDisk_iret
 11599                                  	retn
 11600                                  
 11601                                  ;EndProc LCritDisk
 11602                                  
 11603                                  ; ---------------------------
 11604                                  
 11605                                  ;Procedure   ECritDevice,NEAR
 11606                                  
 11607                                  ECritDevice:
 11608                                  
 11609                                  ;SR; Check if critical section is to be entered
 11610                                  
 11611                                  	pushf
 11612                                  	cmp	byte [ss:redir_patch],0
 11613                                  	jz	short ECritDevice_2
 11614                                  	;popff  ; * (macro)
 11615                                  ;	jmp	short ECritDevice_1 ; *
 11616                                  ;
 11617                                  ;ECritDevice_iret: ; *
 11618                                  ;	iret ; *
 11619                                  
 11620                                  	; 16/12/2022	
 11621                                  	; 13/11/2022
 11622                                  	;jmp	short ECritDevice_1
 11623                                  ;ECritDevice_iret:
 11624                                  	;iret
 11625                                  
 11626                                  ECritDevice_1:
 11627                                  	push	cs ; *
 11628                                  	call	ECritDevice_iret ; *		
 11629                                  	
 11630                                  ECritDevice_0:
 11631                                  	PUSH	AX
 11632                                  	;MOV	AX,8000h+critDevice
 11633                                  	;INT	int_IBM
 11634                                  	mov	ax,8002h
 11635                                  	int	2Ah	; Microsoft Networks - BEGIN DOS CRITICAL SECTION
 11636                                  			; AL = critical section number (00h-0Fh)
 11637                                  	POP     AX
 11638                                  	retn
 11639                                  
 11640                                  	; 16/12/2022
 11641                                  	; 06/12/2022
 11642                                  ECritDevice_iret:  ; 12/05/2019 - Retro DOS v4.0
 11643                                  LCritDevice_iret: 
 11644                                  	iret
 11645                                  
 11646                                  ECritDevice_2:
 11647                                  	;;popff ; *
 11648                                  	;;retn
 11649                                  ;	jmp	short ECritDevice_3 ; *
 11650                                  ;ECritDevice_iret2: ; *
 11651                                  ;	iret
 11652                                  
 11653                                  	; 16/12/2022
 11654                                  	; 13/11/2022
 11655                                  	;jmp	short ECritDevice_3
 11656                                  ;ECritDevice_iret2:
 11657                                  	;iret
 11658                                  
 11659                                  ECritDevice_3:
 11660                                  	push    cs ; *
 11661                                  	; 13/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 11662                                  	;call	ECritDevice_iret2 ; *
 11663                                  	;retn
 11664                                  	; 16/12/2022
 11665                                  	call	ECritDevice_iret
 11666                                  	retn
 11667                                  
 11668                                  ;EndProc ECritDevice
 11669                                  
 11670                                  ; ---------------------------
 11671                                  
 11672                                  ;Procedure   LCritDevice,NEAR
 11673                                  
 11674                                  LCritDevice:
 11675                                  
 11676                                  ;SR; Check if critical section is to be entered
 11677                                  
 11678                                  	pushf
 11679                                  	cmp	byte [ss:redir_patch],0
 11680                                  	jz	short LCritDevice_2
 11681                                  	;popff  ; * (macro)
 11682                                  ;	jmp	short LCritDevice_1 ; *
 11683                                  ;
 11684                                  ;LCritDevice_iret: ; *
 11685                                  ;	iret ; *
 11686                                  
 11687                                  	; 16/12/2022
 11688                                  	; 13/11/2022
 11689                                  	;jmp	short LCritDevice_1
 11690                                  ;LCritDevice_iret:
 11691                                  	;iret
 11692                                  
 11693                                  LCritDevice_1:
 11694                                  	push	cs ; *
 11695                                  	call	LCritDevice_iret ; *		
 11696                                  	
 11697                                  LCritDevice_0:
 11698                                  	PUSH	AX
 11699                                  	;MOV	AX,8100h+critDevice
 11700                                  	;INT	int_IBM
 11701                                  	mov	ax,8102h
 11702                                  	int	2Ah	; Microsoft Networks - END DOS CRITICAL SECTION
 11703                                  			; AL = critical section number (00h-0Fh)
 11704                                  	POP     AX
 11705                                  	retn
 11706                                  
 11707                                  ;LCritDevice_iret:  ; 12/05/2019 - Retro DOS v4.0 
 11708                                  ;	iret
 11709                                  
 11710                                  LCritDevice_2:
 11711                                  	;;popff ; *
 11712                                  	;;retn
 11713                                  ;	jmp	short LCritDevice_3 ; *
 11714                                  ;LCritDevice_iret2: ; *
 11715                                  ;	iret
 11716                                  
 11717                                  	; 16/12/2022
 11718                                  	; 13/11/2022
 11719                                  	;jmp	short LCritDevice_3
 11720                                  ;LCritDevice_iret2:
 11721                                  	;iret
 11722                                  
 11723                                  LCritDevice_3:
 11724                                  	push    cs ; *
 11725                                  	; 13/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 11726                                  	;call	LCritDevice_iret2 ; *
 11727                                  	;retn
 11728                                  	; 16/12/2022
 11729                                  	call	LCritDevice_iret
 11730                                  	retn
 11731                                  
 11732                                  ;EndProc LCritDevice
 11733                                  
 11734                                  %endif
 11735                                  
 11736                                  	; 15/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1)
 11737                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:580Dh
 11738                                  
 11739                                  ; 15/01/2024 - Retro DOS v5.0
 11740                                  %if 1
 11741                                  	;;;
 11742                                  ; ---------------------------------------------------------------------------
 11743                                  ECritMEM:
 11744                                  ECritSFT:
 11745                                  ; ---------------------------------------------------------------------------
 11746                                  	; PCDOS 7.1 IBMDOS.COM
 11747                                  ECritDisk:
 11748 00001884 51                      	push	cx
 11749 00001885 B500                    	mov	ch,0
 11750 00001887 368A0E[650D]            	mov	cl,[ss:redir_patch]
 11751 0000188C E321                    	jcxz	ECritDisk_3
 11752 0000188E 59                      	pop	cx
 11753 0000188F 50                      	push	ax
 11754 00001890 B80180                  	mov	ax,8001h	; BEGIN DOS CRITICAL SECTION
 11755                                  				; AL = critical section number (01h)
 11756                                  ECritDisk_1:
 11757                                  ; ----------------------------------------
 11758                                  LCritDisk_1:
 11759                                  ECritDevice_1:
 11760                                  LCritDevice_1:
 11761 00001893 51                      	push	cx
 11762 00001894 B500                    	mov	ch,0
 11763 00001896 368A0E[470F]            	mov	cl,[ss:IsWin386]
 11764 0000189B E305                    	jcxz	ECritDisk2
 11765 0000189D 59                      	pop	cx
 11766 0000189E CD2A                    	int	2Ah		; Microsoft Networks - BEGIN DOS CRITICAL SECTION
 11767                                  				; AL = critical section number (00h-0Fh)
 11768 000018A0 58                      	pop	ax
 11769 000018A1 C3                      	retn
 11770                                  
 11771                                  ECritDisk2:
 11772 000018A2 06                      	push	es
 11773                                  	;mov	cx,0
 11774                                  	; 15/01/2024
 11775                                  	; cx = 0
 11776 000018A3 8EC1                    	mov	es,cx
 11777 000018A5 9C                      	pushf			; simulate INT 2Ah
 11778 000018A6 26FF1EA800              	call	far [es:00A8h]	; call far (INT 2Ah vector)
 11779 000018AB 07                      	pop	es
 11780 000018AC 59                      	pop	cx
 11781 000018AD 58                      	pop	ax
 11782 000018AE C3                      	retn
 11783                                  
 11784                                  ECritDisk_3:
 11785                                  ; ----------------------------------------
 11786                                  LCritDisk_3:
 11787                                  ECritDevice_3:
 11788                                  LCritDevice_3:
 11789 000018AF 59                      	pop	cx
 11790 000018B0 C3                      	retn
 11791                                  
 11792                                  ; ---------------------------------------------------------------------------
 11793                                  LCritMEM:
 11794                                  LCritSFT:
 11795                                  ; ---------------------------------------------------------------------------
 11796                                  	; PCDOS 7.1 IBMDOS.COM
 11797                                  LCritDisk:
 11798 000018B1 51                      	push	cx
 11799 000018B2 B500                    	mov	ch,0
 11800 000018B4 368A0E[650D]            	mov	cl,[ss:redir_patch]
 11801 000018B9 E3F4                    	jcxz	LCritDisk_3
 11802 000018BB 59                      	pop	cx
 11803 000018BC 50                      	push	ax
 11804 000018BD B80181                  	mov	ax,8101h	; END DOS CRITICAL SECTION
 11805                                  				; AL = critical section number (01h)
 11806 000018C0 EBD1                    	jmp	short LCritDisk_1
 11807                                  
 11808                                  ; ---------------------------------------------------------------------------
 11809                                  
 11810                                  ECritDevice:
 11811 000018C2 51                      	push	cx
 11812 000018C3 B500                    	mov	ch,0
 11813 000018C5 368A0E[650D]            	mov	cl,[ss:redir_patch]
 11814 000018CA E3E3                    	jcxz	ECritDevice_3
 11815 000018CC 59                      	pop	cx
 11816 000018CD 50                      	push	ax
 11817 000018CE B80280                  	mov	ax,8002h	; BEGIN DOS CRITICAL SECTION
 11818                                  				; AL = critical section number (02h)
 11819 000018D1 EBC0                    	jmp	short ECritDevice_1
 11820                                  
 11821                                  ; ---------------------------------------------------------------------------
 11822                                  
 11823                                  LCritDevice:
 11824 000018D3 51                      	push	cx
 11825 000018D4 B500                    	mov	ch,0
 11826 000018D6 368A0E[650D]            	mov	cl,[ss:redir_patch]
 11827 000018DB E3D2                    	jcxz	LCritDevice_3
 11828 000018DD 59                      	pop	cx
 11829 000018DE 50                      	push	ax
 11830 000018DF B80281                  	mov	ax,8102h	; END DOS CRITICAL SECTION
 11831                                  				; AL = critical section number (02h)
 11832 000018E2 EBAF                    	jmp	short LCritDevice_1
 11833                                  
 11834                                  ; ---------------------------------------------------------------------------
 11835                                  	;;;
 11836                                  %endif
 11837                                  
 11838                                  ;============================================================================
 11839                                  ; CPMIO.ASM, MSDOS 6.0, 1991
 11840                                  ;============================================================================
 11841                                  ; 20/07/2018 - Retro DOS v3.0
 11842                                  
 11843                                  ;============================================================================
 11844                                  ; STDIO.ASM - (MSDOS 2.0)
 11845                                  ;============================================================================
 11846                                  
 11847                                  ;
 11848                                  ; Standard device IO for MSDOS (first 12 function calls)
 11849                                  ;
 11850                                  
 11851                                  ;.xlist
 11852                                  ;.xcref
 11853                                  ;INCLUDE STDSW.ASM
 11854                                  ;INCLUDE DOSSEG.ASM
 11855                                  ;.cref
 11856                                  ;.list
 11857                                  
 11858                                  ;TITLE   STDIO - device IO for MSDOS
 11859                                  ;NAME    STDIO
 11860                                  
 11861                                  ;INCLUDE IO.ASM
 11862                                  
 11863                                  ; ---------------------------------------------------------------------------
 11864                                  ;
 11865                                  ; NOTE for Retro DOS v2.0 :  (ERDOGAN TAN - 13/03/2018)
 11866                                  ;	  I0.ASM is missing in MSDOS 2.0 kernel source code files !!!
 11867                                  ;	  INSTEAD of IO.ASM, I have disassembled IBMDOS.COM (MSDOS 2.0)
 11868                                  ;			    and I have used CPMIO.ASM (MSDOS 6.0 source code)
 11869                                  ;			    to restore MSDOS 2.0 device IO source code 
 11870                                  ;
 11871                                  ;		(STRIN.ASM has '$STD_CON_STRING_INPUT' code.)	
 11872                                  	
 11873                                  ;============================================================================
 11874                                  ; STDIO.ASM - (MSDOS 2.0)
 11875                                  ;============================================================================
 11876                                  
 11877                                  ;
 11878                                  ; Standard device IO for MSDOS (first 12 function calls)
 11879                                  ;
 11880                                  
 11881                                  ;.xlist
 11882                                  ;.xcref
 11883                                  ;INCLUDE STDSW.ASM
 11884                                  ;INCLUDE DOSSEG.ASM
 11885                                  ;.cref
 11886                                  ;.list
 11887                                  
 11888                                  ;TITLE   STDIO - device IO for MSDOS
 11889                                  ;NAME    STDIO
 11890                                  
 11891                                  ;INCLUDE IO.ASM
 11892                                  
 11893                                  ; ---------------------------------------------------------------------------
 11894                                  ;
 11895                                  ; NOTE for Retro DOS v2.0 :  (ERDOGAN TAN - 13/03/2018)
 11896                                  ;	  I0.ASM is missing in MSDOS 2.0 kernel source code files !!!
 11897                                  ;	  INSTEAD of IO.ASM, I have disassembled IBMDOS.COM (MSDOS 2.0)
 11898                                  ;			    and I have used CPMIO.ASM (MSDOS 6.0 source code)
 11899                                  ;			    to restore MSDOS 2.0 device IO source code 
 11900                                  ;
 11901                                  ;		(STRIN.ASM has '$STD_CON_STRING_INPUT' code.)		
 11902                                  ;
 11903                                  ;============================================================================
 11904                                  ; IO.ASM (MSDOS 2.0) (IBMDOS.COM 2.0) - STRIN.ASM (MSDOS 2.0, 19/08/1983)
 11905                                  ;============================================================================
 11906                                  ; Retro DOS v2.0 by Erdogan Tan, 13/03/2018 - 14/03/2018
 11907                                  
 11908                                  ; (Disassembled code of IBMDOS.COM, 08/03/1983) - Dissassembler: IDA Pro Free
 11909                                  ; (Comments are from CPMIO.ASM - 1991, MSDOS 6.0) 
 11910                                  
 11911                                  ;============================================================================
 11912                                  ; CPMIO.ASM (MSDOS 6.0, 1991)
 11913                                  ;============================================================================
 11914                                  ; Retro DOS v4.0 by Erdogan Tan, 04/05/2019
 11915                                  
 11916                                  	; 08/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 11917                                  
 11918                                  ;**	Standard device IO for MSDOS (first 12 function calls)
 11919                                  ;
 11920                                  ;	TITLE	IBMCPMIO - device IO for MSDOS
 11921                                  ;	NAME	IBMCPMIO
 11922                                  
 11923                                  ;	Old style CP/M 1-12 system calls to talk to reserved devices
 11924                                  ;
 11925                                  ;	$Std_Con_Input_No_Echo
 11926                                  ;	$Std_Con_String_Output
 11927                                  ;	$Std_Con_String_Input
 11928                                  ;	$RawConIO
 11929                                  ;	$RawConInput
 11930                                  ;	RAWOUT
 11931                                  ;	RAWOUT2
 11932                                  ;
 11933                                  
 11934                                  ; The following routines form the console I/O group (funcs 1,2,6,7,8,9,10,11).
 11935                                  ; They assume ES and DS NOTHING, while not strictly correct, this forces data
 11936                                  ; references to be SS or CS relative which is desired.
 11937                                  
 11938                                  ; ---------------------------------------------------------------------------
 11939                                  
 11940                                  ;	TITLE	CPMIO2 - device IO for MSDOS
 11941                                  ;	NAME	CPMIO2
 11942                                  
 11943                                  ;
 11944                                  ;	Microsoft Confidential
 11945                                  ;	Copyright (C) Microsoft Corporation 1991
 11946                                  ;	All Rights Reserved.
 11947                                  ;
 11948                                  
 11949                                  ;**	Old style CP/M 1-12 system calls to talk to reserved devices
 11950                                  ;
 11951                                  ;	$Std_Con_Input
 11952                                  ;	$Std_Con_Output
 11953                                  ;	OUTT
 11954                                  ;	TAB
 11955                                  ;	BUFOUT
 11956                                  ;	$Std_Aux_Input
 11957                                  ;	$Std_Aux_Output
 11958                                  ;	$Std_Printer_Output
 11959                                  ;	$Std_Con_Input_Status
 11960                                  ;	$Std_Con_Input_Flush
 11961                                  ;
 11962                                  ;	Revision History:
 11963                                  ;
 11964                                  ;	  AN000	 version 4.00 - Jan. 1988
 11965                                  
 11966                                  ; The following routines form the console I/O group (funcs 1,2,6,7,8,9,10,11).
 11967                                  ; They assume ES and DS NOTHING, while not strictly correct, this forces data
 11968                                  ; references to be SS or CS relative which is desired.
 11969                                  
 11970                                  ;DOSCODE SEGMENT
 11971                                  ;	ASSUME	SS:DOSDATA,CS:DOSCODE
 11972                                  
 11973                                  
 11974                                  ;hkn; 	All the variables use SS override or DS. Therefore there is
 11975                                  ;hkn;	no need to specifically set up any seg regs unless SS assumption is
 11976                                  ;hkn;	not valid. 
 11977                                  
 11978                                  ; DOSCODE:51BAh (MSDOS 6.21, MSDOS.SYS)
 11979                                  ; 08/11/2022
 11980                                  ; DOSCODE:51A6h (MSDOS 5.0, MSDOS.SYS)
 11981                                  
 11982                                  ;
 11983                                  ;----------------------------------------------------------------------------
 11984                                  ;
 11985                                  ; Procedure : $Std_Con_Input_No_Echo
 11986                                  ;
 11987                                  ;----------------------------------------------------------------------------
 11988                                  ;
 11989                                  
 11990                                  _$STD_CON_INPUT_NO_ECHO:   ;System call 8
 11991                                  
 11992                                  ; Inputs:
 11993                                  ;	None
 11994                                  ; Function:
 11995                                  ;	Input character from console, no echo
 11996                                  ; Returns:
 11997                                  ;	AL = character
 11998                                  
 11999 000018E4 1E                      	push	ds
 12000 000018E5 56                      	push	si
 12001                                  INTEST:
 12002 000018E6 E86F42                  	call	STATCHK
 12003 000018E9 753A                    	jnz	short GET ; 08/09/2018
 12004                                  ;*************************************************************************
 12005                                  ;hkn; SS override
 12006 000018EB 36803E[A00A]00          	cmp	byte [SS:PRINTER_FLAG],0  ; is printer idle?
 12007 000018F1 7505                    	jnz	short no_sys_wait
 12008 000018F3 B405                    	mov	ah,5			; get input status with system wait
 12009 000018F5 E8B334                  	call	IOFUNC
 12010                                  no_sys_wait:
 12011                                  ;**************************************************************************
 12012 000018F8 B484                    	MOV	AH,84h		; (Microsoft Networks - KEYBOARD BUSY LOOP)
 12013 000018FA CD2A                    	INT	int_IBM	 ; int 2Ah
 12014                                  
 12015                                  ;;; 7/15/86  update the date in the idle loop
 12016                                  ;;; Dec 19, 1986 D.C.L. changed following CMP to Byte Ptr from Word Ptr
 12017                                  ;;;;		 to shorten loop in consideration of the PC Convertible
 12018                                  
 12019                                  ;hkn; SS override
 12020 000018FC 36803E[BD0D]FF          	CMP	byte [SS:DATE_FLAG],-1	; date is updated may be every
 12021 00001902 751A                    	JNZ	short NoUpdate		; 65535 x ? ms if no one calls
 12022                                  
 12023 00001904 50                      	PUSH	AX
 12024 00001905 53                      	PUSH	BX			; following is tricky,
 12025 00001906 51                      	PUSH	CX			; it may be called by critical handler
 12026 00001907 52                      	PUSH	DX			; at that time, DEVCALL is used by
 12027                                  					; other's READ or WRITE
 12028 00001908 1E                      	PUSH	DS			; save DS = SFT's segment
 12029                                  
 12030                                  ;hkn; READTIME must use ds = DOSDATA
 12031                                  ;hkn;	PUSH	CS			; READTIME must use DS=CS
 12032                                  
 12033 00001909 16                      	PUSH	SS ; 04/05/2019
 12034 0000190A 1F                      	POP	DS
 12035                                  
 12036                                  	;MOV	AX,0			; therefore, we save DEVCALL
 12037                                  	; 26/06/2024
 12038 0000190B 31C0                    	xor	ax,ax
 12039 0000190D E89A02                  	CALL	Save_Restore_Packet	; save DEVCALL packet
 12040                                  	;invoke	READTIME		; readtime
 12041 00001910 E854F2                  	call	READTIME
 12042 00001913 B80100                  	MOV	AX,1
 12043 00001916 E89102                  	CALL	Save_Restore_Packet	; restore DEVCALL packet
 12044                                  
 12045                                  ;	; MSDOS 3.3 (IBMDOS.COM, Offset 1F8Ch)
 12046                                  ;	; (MSDOS 6.0 code does not contain IBM DOS FETCHI_TAG check)
 12047                                  ;	push	bx
 12048                                  ;	mov	bx,DATE_FLAG
 12049                                  ;	add	bx,2  ; mov bx,FETCHI_FLAG
 12050                                  ;	cmp	word [cs:bx],5872h
 12051                                  ;	jz	short FETCHI_TAG_chk_ok
 12052                                  ;	call	DOSINIT
 12053                                  ;FETCHI_TAG_chk_ok:
 12054                                  ;	pop	bx
 12055                                  
 12056 00001919 1F                      	POP	DS			; restore DS
 12057 0000191A 5A                      	POP	DX
 12058 0000191B 59                      	POP	CX
 12059 0000191C 5B                      	POP	BX
 12060 0000191D 58                      	POP	AX
 12061                                  NoUpdate:
 12062                                  
 12063                                  ;hkn; SS override
 12064 0000191E 36FF06[BD0D]            	INC	word [SS:DATE_FLAG]
 12065                                  
 12066                                  ;;; 7/15/86 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 12067 00001923 EBC1                    	JMP	short INTEST
 12068                                  GET:
 12069 00001925 30E4                    	XOR	AH,AH
 12070 00001927 E88134                  	call	IOFUNC
 12071 0000192A 5E                      	POP	SI
 12072 0000192B 1F                      	POP	DS
 12073                                  ;;; 7/15/86
 12074                                  
 12075                                  ;hkn; SS override
 12076                                  	; MSDOS 6.0
 12077 0000192C 36C606[BC0D]00          	MOV	BYTE [SS:SCAN_FLAG],0
 12078                                  	;
 12079 00001932 3C00                    	CMP	AL,0	    ; extended code ( AL )
 12080 00001934 7505                    	JNZ	short noscan
 12081                                  
 12082                                  ;hkn; SS override
 12083                                  	;MOV	BYTE [SS:SCAN_FLAG],1 ; set this flag for ALT_Q key
 12084                                  	; 20/06/2023
 12085 00001936 36FE06[BC0D]            	inc	byte [SS:SCAN_FLAG]
 12086                                  noscan:
 12087 0000193B C3                      	retn
 12088                                  ;
 12089                                  ;----------------------------------------------------------------------------
 12090                                  ;
 12091                                  ;**	$STD_CON_STRING_OUTPUT - Console String Output
 12092                                  ;
 12093                                  ;
 12094                                  ;	ENTRY	(DS:DX) Point to output string '$' terminated
 12095                                  ;	EXIT	none
 12096                                  ;	USES	ALL
 12097                                  ;
 12098                                  ;----------------------------------------------------------------------------
 12099                                  ;
 12100                                  
 12101                                  _$STD_CON_STRING_OUTPUT:	;System call 9
 12102 0000193C 89D6                    	mov	si,dx
 12103                                  STRING_OUT1:	
 12104 0000193E AC                      	lodsb
 12105 0000193F 3C24                    	cmp	al,'$'
 12106 00001941 74F8                    	je	short noscan
 12107                                  NEXT_STR1:
 12108 00001943 E88D02                  	call	OUTT
 12109 00001946 EBF6                    	jmp	short STRING_OUT1
 12110                                  
 12111                                  ;----------------------------------------------------------------------------
 12112                                  ;
 12113                                  ;**	$STD_CON_STRING_INPUT - Input Line from Console
 12114                                  ;
 12115                                  ;	$STD_CON_STRING_INPUT Fills a buffer from console input until CR
 12116                                  ;
 12117                                  ;	ENTRY	(ds:dx) = input buffer
 12118                                  ;	EXIT	none
 12119                                  ;	USES	ALL
 12120                                  ;
 12121                                  ;----------------------------------------------------------------------------
 12122                                  
 12123                                  	; 15/01/2024 - Retro DOS v5.0
 12124                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:58D4h
 12125                                  
 12126                                  _$STD_CON_STRING_INPUT:		;System call 10
 12127                                  
 12128                                  	; 15/01/2024
 12129                                  	;mov	ax,ss
 12130                                  	;mov	es,ax
 12131 00001948 16                      	push	ss
 12132 00001949 07                      	pop	es
 12133                                  
 12134 0000194A 89D6                    	mov	si,dx
 12135 0000194C 30ED                    	xor	ch,ch
 12136 0000194E AD                      	lodsw
 12137                                  
 12138                                  ;	(AL) = the buffer length
 12139                                  ;	(AH) = the template length
 12140                                  
 12141 0000194F 08C0                            or	al,al
 12142 00001951 74E8                            jz	short noscan	;Buffer is 0 length!!?
 12143 00001953 88E3                    	mov	bl,ah		;Init template counter
 12144 00001955 88EF                            mov	bh,ch		;Init template counter
 12145                                  
 12146                                  ;	(BL) = the number of bytes in the template
 12147                                  
 12148 00001957 38D8                            cmp	al,bl
 12149 00001959 7605                            jbe	short NOEDIT	;If length of buffer inconsistent with contents
 12150 0000195B 80380D                          cmp	byte [bx+si],c_CR ; 0Dh
 12151 0000195E 7402                            jz	short EDITON	;If CR correctly placed EDIT is OK
 12152                                  
 12153                                  ; The number of chars in the template is >= the number of chars in buffer or
 12154                                  ; there is no CR at the end of the template. This is an inconsistant state
 12155                                  ; of affairs. Pretend that the template was empty:
 12156                                  ;
 12157                                  
 12158                                  NOEDIT:	
 12159 00001960 88EB                    	mov	bl,ch		;Reset buffer
 12160                                  EDITON: 
 12161 00001962 88C2                    	mov	dl,al
 12162 00001964 4A                      	dec	dx		;DL is # of bytes we can put in the buffer
 12163                                  
 12164                                  ;	Top level. We begin to read a line in.
 12165                                  
 12166                                  NEWLIN: 
 12167 00001965 36A0[F901]              	mov	al,[SS:CARPOS]
 12168 00001969 36A2[FA01]              	mov	[SS:STARTPOS],al ;Remember position in raw buffer
 12169                                  
 12170 0000196D 56                      	push	si
 12171 0000196E BF[FB01]                	mov	di,INBUF ;Build the new line here
 12172 00001971 36882E[7905]            	mov	byte [SS:INSMODE],ch ;Insert mode off
 12173 00001976 88EF                    	mov	bh,ch		;No chars from template yet
 12174 00001978 88EE                    	mov	dh,ch		;No chars to new line yet
 12175 0000197A E867FF                  	call	_$STD_CON_INPUT_NO_ECHO ;Get first char
 12176 0000197D 3C0A                    	cmp	al,c_LF		; 0Ah	;Linefeed 
 12177 0000197F 7503                    	jnz	short GOTCH
 12178                                  
 12179                                  ;	This is the main loop of reading in a character and processing it.
 12180                                  ;
 12181                                  ;	(BH) = the index of the next byte in the template
 12182                                  ;	(BL) = the length of the template
 12183                                  ;	(DH) = the number of bytes in the buffer
 12184                                  ;	(DL) = the length of the buffer
 12185                                  
 12186                                  GETCH:
 12187 00001981 E860FF                  	call	_$STD_CON_INPUT_NO_ECHO
 12188                                  GOTCH:
 12189                                  ;
 12190                                  ; Brain-damaged Tim Patterson ignored ^F in case his BIOS did not flush the
 12191                                  ; input queue.
 12192                                  ;
 12193 00001984 3C06                            cmp	al,"F"-"@"  ; CMP AL, 6  ; Ignore ^F
 12194 00001986 74F9                    	jz	short GETCH
 12195                                  
 12196                                  ;	If the leading char is the function-key lead byte
 12197                                  
 12198                                  	;cmp	al,[SS:ESCCHAR]
 12199                                  
 12200                                  	; 04/05/2019 - Retro DOS v4.0
 12201                                  
 12202                                  ;hkn; 	ESCCHAR is in TABLE seg (DOSCODE)
 12203                                  
 12204 00001988 2E3A06[710A]            	CMP	AL,[cs:ESCCHAR]
 12205 0000198D 7439                            jz	short ESCAPE	;change reserved keyword DBM 5-7-87
 12206                                  
 12207                                  ;	Rubout and ^H are both destructive backspaces.
 12208                                  
 12209 0000198F 3C7F                            cmp	al,c_DEL ; 7FH
 12210                                          ;jz	short BACKSPJ
 12211                                          ; 15/01/2024
 12212 00001991 7466                    	je	short BACKSP
 12213 00001993 3C08                    	cmp	al,c_BS  ; 8
 12214                                          ;jz	short BACKSPJ
 12215                                          ; 15/01/2024
 12216 00001995 7462                    	je	short BACKSP
 12217                                  
 12218                                  	; 04/05/2019 -	MSDOS 6.0, also MSDOS 6.21 has bug (bullshit) here.
 12219                                  	;		Two NOPs -instead of a JMP short, as two bytes-
 12220                                  	;	   	after CMP and a CMP again!
 12221                                  	;		
 12222                                  	;		-It would be better if they use a 'JMP short' to 
 12223                                  	;	      	DOSCODE:5279h from DOSCODE:5271h and leave NOPs
 12224                                  	;		between them. Then, they would be able use a patch
 12225                                  	;		between 5271h and 5279h when if it will be required.
 12226                                  	;		I think Tim Patterson would not do this CMP mistake!-
 12227                                  	;	
 12228                                  	; (MSDOS.SYS, from DOSCODE:5271h to DOSCODE:5279h)
 12229                                  
 12230                                  	; 08/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 12231                                  	;
 12232                                  	; (Note: nops below might be used for patching code for Windows 3.1)
 12233                                  
 12234                                  ;DOSCODE:526D	cmp     al, 8
 12235                                  ;DOSCODE:526F	jz      short BACKSPJ
 12236                                  ;DOSCODE:5271	cmp     al, 17h
 12237                                  ;DOSCODE:5273	nop
 12238                                  ;DOSCODE:5274	nop
 12239                                  ;DOSCODE:5275	cmp     al, 15h
 12240                                  ;DOSCODE:5277	nop
 12241                                  ;DOSCODE:5278	nop
 12242                                  ;DOSCODE:5279	cmp     al, 0Dh
 12243                                  ;DOSCODE:527B	jz      short ENDLIN
 12244                                  ;DOSCODE:527D	cmp     al, 0Ah
 12245                                  ;DOSCODE:527F	jz      short PHYCRLF
 12246                                  	
 12247                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 12248                                  	; DOSCODE:525Dh
 12249                                  
 12250                                  ; 16/12/2022
 12251                                  %if 0
 12252                                  	; MSDOS 6.0
 12253                                  ;	^W deletes backward once and then backs up until a letter is before the
 12254                                  ;	cursor
 12255                                  
 12256                                  	CMP     AL,"W"-"@" ; 17h
 12257                                  
 12258                                  ;	The removal of the comment characters before the jump statement will
 12259                                  ;	cause ^W to backup a word.
 12260                                  
 12261                                  ;***	JZ	short WordDel
 12262                                  	NOP
 12263                                  	NOP
 12264                                  
 12265                                  	CMP     AL,"U"-"@" ; 15h
 12266                                  
 12267                                  ;	The removal of the comment characters before the jump statement will
 12268                                  ;	cause ^U to clear a line.
 12269                                  
 12270                                  ;***	JZ	short LineDel
 12271                                  	NOP
 12272                                  	NOP
 12273                                  
 12274                                  %endif
 12275                                  
 12276                                  ;	CR terminates the line.
 12277                                  
 12278 00001997 3C0D                            cmp	al,c_CR ; 0Dh
 12279 00001999 7430                            jz	short ENDLIN
 12280                                  
 12281                                  ;	LF goes to a new line and keeps on reading.
 12282                                  
 12283 0000199B 3C0A                            cmp	al,c_LF ; 0Ah
 12284 0000199D 7442                    	jz	short PHYCRLF
 12285                                  
 12286                                  ;	^X (or ESC) deletes the line and starts over
 12287                                  
 12288                                  	; MSDOS 3.3
 12289                                  	;cmp	al,[ss:CANCHAR] ; 1Bh
 12290                                  	;jz	short KILNEW
 12291                                  
 12292                                  	; MSDOS 6.0 (& MSDOS 6.21)
 12293                                  
 12294                                  ;hkn; 	CANCHAR is in TABLE seg (DOSCODE), so CS override
 12295                                  
 12296 0000199F 2E3A06[700A]            	cmp	al,[cs:CANCHAR] ; 1Bh
 12297 000019A4 7440                    	jz	short KILNEW
 12298                                  	
 12299                                  	;cmp	al,CANCEL ; 1Bh	; Retro DOS v3.0
 12300                                  	;jz	short KILNEW
 12301                                  
 12302                                  ; Otherwise, we save the input character.
 12303                                  
 12304                                  SAVCH:	
 12305 000019A6 38D6                    	cmp	dh,dl
 12306 000019A8 7317                    	jnb	short BUFFUL		; buffer is full.
 12307 000019AA AA                              stosb
 12308 000019AB FEC6                    	inc	dh                      ; increment count in buffer.
 12309 000019AD E8B702                  	call	BUFOUT			; Print control chars nicely
 12310                                  
 12311 000019B0 36803E[7905]00                  cmp	byte [SS:INSMODE], 0
 12312 000019B6 75C9                    	jnz	short GETCH		; insertmode => don't advance template
 12313 000019B8 38DF                            cmp	bh,bl
 12314 000019BA 73C5                            jnb	short GETCH		; no more characters in template
 12315 000019BC 46                              inc	si                      ; Skip to next char in template
 12316 000019BD FEC7                            inc	bh                      ; remember position in template
 12317 000019BF EBC0                            jmp	short GETCH
 12318                                  
 12319                                  	; 15/01/2024
 12320                                  ;BACKSPJ: 
 12321                                  	;jmp	short BACKSP
 12322                                  
 12323                                  BUFFUL: 
 12324 000019C1 B007                    	mov	al, 7			; Bell to signal full buffer
 12325 000019C3 E80D02                  	call	OUTT
 12326 000019C6 EBB9                    	jmp	short GETCH
 12327                                  
 12328                                  ESCAPE: 
 12329                                  	;transfer OEMFunctionKey
 12330 000019C8 E9D1F0                  	JMP	OEMFunctionKey		; let the OEM's handle the key dispatch
 12331                                  
 12332                                  ENDLIN:
 12333 000019CB AA                              stosb				; Put the CR in the buffer
 12334 000019CC E80402                  	call	OUTT                    ; Echo it
 12335 000019CF 5F                              pop	di                      ; Get start of user buffer
 12336 000019D0 8875FF                          mov	[di-1], dh		; Tell user how many bytes
 12337 000019D3 FEC6                            inc	dh			; DH is length including CR
 12338                                  
 12339                                  COPYNEW:
 12340                                  	; (IBMDOS.COM, MSDOS 2.0, STRIN.ASM)
 12341                                  	;mov	bp, es
 12342                                  	;mov	bx, ds
 12343                                  	;mov	es, bx
 12344                                  	;mov	ds, bp
 12345                                  	;mov	si, INBUF
 12346                                  	;mov	cl, dh
 12347                                  	;rep	movsb
 12348                                  	;retn
 12349                                  
 12350                                  	; CPMIO.ASM (MSDOS 6.0)
 12351                                  	; (IBMDOS.COM, MSDOS 3.3, Offset 2061h) 
 12352                                  	;SAVE	<DS,ES>
 12353 000019D5 1E                      	PUSH	DS
 12354 000019D6 06                      	PUSH	ES
 12355                                  	;RESTORE <DS,ES>		; XCHG ES,DS
 12356 000019D7 1F                      	POP	DS
 12357 000019D8 07                      	POP	ES
 12358                                  
 12359                                  ;;hkn; INBUF is in DOSDATA
 12360 000019D9 BE[FB01]                        MOV     SI,INBUF
 12361 000019DC 88F1                            MOV     CL,DH                   ; set up count
 12362 000019DE F3A4                            REP     MOVSB                   ; Copy final line to user buffer
 12363                                  OLDBAK_RETN:
 12364 000019E0 C3                              RETN
 12365                                  
 12366                                  ;	Output a CRLF to the user screen and do NOT store it into the buffer
 12367                                  
 12368                                  PHYCRLF:
 12369 000019E1 E81B01                  	CALL	CRLF
 12370 000019E4 EB9B                            JMP	short GETCH
 12371                                  
 12372                                  	; MSDOS 6.0 (& MSDOS 3.3, IBMDOS.COM, 1987)
 12373                                  
 12374                                  ; DOSCODE:52CAh (MSDOS 621, MSDOS.SYS)
 12375                                  
 12376                                  	; Note: Following routines were not used in IBMDOS.COM
 12377                                  	;	-CRTL+W, CRTL+U is not activated-
 12378                                  	;	but they were in the kernel code!?)
 12379                                  
 12380                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 12381                                  	; DOSCODE:52B6h
 12382                                  
 12383                                  ;;;;;;;;
 12384                                  
 12385                                  ; 16/12/2022
 12386                                  %if 0
 12387                                  ;
 12388                                  ; Delete the previous line
 12389                                  ;
 12390                                  LineDel:
 12391                                  	OR      DH,DH
 12392                                  	JZ	short GETCH	 ; 06/12/2022
 12393                                  	Call    BackSpace
 12394                                  	JMP	short LineDel
 12395                                  
 12396                                  %endif
 12397                                  
 12398                                  ;
 12399                                  ; delete the previous word.
 12400                                  ;
 12401                                  WordDel:
 12402                                  WordLoop:
 12403                                  ;	Call    BackSpace               ; backspace the one spot
 12404                                  ;	OR      DH,DH
 12405                                  ;	JZ	short GetChj
 12406                                  ;	MOV     AL,[ES:DI-1]
 12407                                  ;	cmp     al,'0'
 12408                                  ;	jb	short GetChj
 12409                                  ;	cmp     al,'9'
 12410                                  ;	jbe	short WordLoop
 12411                                  ;	OR      AL,20h
 12412                                  ;	CMP     AL,'a'
 12413                                  ;	JB	short GetChj
 12414                                  ;	CMP     AL,'z'
 12415                                  ;	JBE	short WordLoop
 12416                                  ;GetChj: 
 12417                                  ;	JMP	GETCH
 12418                                  
 12419                                  ; 16/12/2022
 12420                                  %if 0
 12421                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 12422                                  	; (Worddel is not called or jumped from anywhere!)
 12423                                  WordDel:
 12424                                  WordLoop:
 12425                                  	Call    BackSpace               ; backspace the one spot
 12426                                  	OR      DH,DH
 12427                                  	JZ	short GetChj
 12428                                  	MOV     AL,[ES:DI-1]
 12429                                  	cmp     al,'0'
 12430                                  	jb	short GetChj
 12431                                  	cmp     al,'9'
 12432                                  	jbe	short WordLoop
 12433                                  	OR      AL,20h
 12434                                  	CMP     AL,'a'
 12435                                  	JB	short GetChj
 12436                                  	CMP     AL,'z'
 12437                                  	JBE	short WordLoop
 12438                                  GetChj: 
 12439                                  	JMP	GETCH
 12440                                  
 12441                                  %endif
 12442                                  
 12443                                  ;;;;;;;;
 12444                                  
 12445                                  ; DOSCODE:52F3h (MSDOS 621, MSDOS.SYS)
 12446                                  
 12447                                  ; The user wants to throw away what he's typed in and wants to start over.
 12448                                  ; We print the backslash and then go to the next line and tab to the correct
 12449                                  ; spot to begin the buffered input.
 12450                                  
 12451                                  KILNEW:
 12452 000019E6 B05C                            mov	al,'\'
 12453 000019E8 E8E801                          call	OUTT            ;Print the CANCEL indicator
 12454 000019EB 5E                              pop	si		;Remember start of edit buffer
 12455                                  PUTNEW:
 12456 000019EC E81001                  	call	CRLF            ;Go to next line on screen
 12457 000019EF 36A0[FA01]              	mov	al,[SS:STARTPOS]
 12458 000019F3 E85102                  	call	TAB             ;Tab over
 12459 000019F6 E96CFF                          JMP     NEWLIN		;Start over again
 12460                                  
 12461                                  ;	Destructively back up one character position
 12462                                  
 12463                                  BACKSP:
 12464                                  	; 09/09/2018
 12465 000019F9 E80800                  	Call    BackSpace
 12466 000019FC EB83                    	JMP     short GETCH	; 15/01/2024
 12467                                  
 12468                                  	; 15/01/2024
 12469                                  ;User really wants an ESC character in his line
 12470                                  TWOESC:	
 12471 000019FE 2EA0[710A]              	mov	al,[cs:ESCCHAR] ; 10/06/2019
 12472 00001A02 EBA2                    	jmp	short SAVCH
 12473                                  
 12474                                  BackSpace:
 12475 00001A04 08F6                    	or	dh,dh
 12476 00001A06 7419                    	jz	short OLDBAK	;No chars in line, do nothing to line
 12477 00001A08 E85800                  	call	BACKUP          ;Do the backup
 12478 00001A0B 268A05                  	mov	al,[es:di]	;Get the deleted char
 12479 00001A0E 3C20                            cmp	al,20h	; ' '
 12480 00001A10 730F                    	jnb	short OLDBAK	;Was a normal char
 12481 00001A12 3C09                            cmp	al,c_HT ; 9
 12482 00001A14 741B                    	jz	short BAKTAB	;Was a tab, fix up users display
 12483                                  ;; 9/27/86 fix for ctrl-U backspace
 12484 00001A16 3C15                    	CMP     AL,"U"-"@" ; 15h ; ctrl-U is a section symbol not ^U
 12485 00001A18 7407                    	JZ	short OLDBAK
 12486 00001A1A 3C14                           	CMP     AL,"T"-"@" ; 14h ; ctrl-T is a paragraphs symbol not ^T
 12487 00001A1C 7403                    	JZ	short OLDBAK
 12488                                  ;; 9/27/86 fix for ctrl-U backspace
 12489 00001A1E E84500                          call	BACKMES         ;Was a control char, zap the '^'
 12490                                  OLDBAK:
 12491 00001A21 36803E[7905]00                  cmp	byte [SS:INSMODE], 0
 12492 00001A27 75B7                    	jnz	short OLDBAK_RETN ;In insert mode, done
 12493 00001A29 08FF                    	or	bh,bh
 12494 00001A2B 74B3                            jz	short OLDBAK_RETN 
 12495                                  				;Not advanced in template, stay where we are
 12496 00001A2D FECF                    	dec	bh		;Go back in template
 12497 00001A2F 4E                              dec	si
 12498 00001A30 C3                      	retn
 12499                                  BAKTAB:
 12500 00001A31 57                              push	di
 12501 00001A32 4F                              dec	di		;Back up one char
 12502 00001A33 FD                              std			;Go backward
 12503 00001A34 88F1                            mov	cl,dh		;Number of chars currently in line
 12504 00001A36 B020                            mov	al,20h	; ' '
 12505 00001A38 53                              push	bx
 12506 00001A39 B307                            mov	bl,7		;Max
 12507 00001A3B E30E                            jcxz	FIGTAB		;At start, do nothing
 12508                                  FNDPOS:
 12509 00001A3D AE                              scasb			;Look back
 12510 00001A3E 7609                    	jbe	short CHKCNT
 12511 00001A40 26807D0109              	cmp	byte [es:di+1],9
 12512 00001A45 7409                    	jz	short HAVTAB	;Found a tab
 12513 00001A47 FECB                    	dec	bl		;Back one char if non tab control char
 12514                                  CHKCNT:
 12515 00001A49 E2F2                            loop	FNDPOS
 12516                                  FIGTAB:		
 12517 00001A4B 362A1E[FA01]            	sub	bl,[SS:STARTPOS]
 12518                                  HAVTAB:
 12519 00001A50 28F3                    	sub	bl,dh
 12520 00001A52 00D9                    	add	cl,bl
 12521 00001A54 80E107                  	and	cl,7		;CX has correct number to erase
 12522 00001A57 FC                      	cld			;Back to normal
 12523 00001A58 5B                      	pop	bx
 12524 00001A59 5F                      	pop	di
 12525 00001A5A 74C5                    	jz	short OLDBAK	;Nothing to erase
 12526                                  TABBAK:
 12527 00001A5C E80700                  	call	BACKMES
 12528 00001A5F E2FB                    	loop	TABBAK		;Erase correct number of chars
 12529 00001A61 EBBE                    	jmp	short OLDBAK
 12530                                  
 12531                                  BACKUP:
 12532 00001A63 FECE                            dec	dh		;Back up in line
 12533 00001A65 4F                              dec	di
 12534                                  BACKMES:
 12535 00001A66 B008                            mov	al,c_BS ; 8	;Backspace
 12536 00001A68 E86801                          call	OUTT
 12537 00001A6B B020                            mov	al,20h ; ' '	;Erase
 12538 00001A6D E86301                          call	OUTT
 12539 00001A70 B008                            mov	al,c_BS ; 8	;Backspace
 12540 00001A72 E95E01                  	jmp	OUTT		;Done
 12541                                  
 12542                                  	; 15/01/2024
 12543                                  ;User really wants an ESC character in his line
 12544                                  ;TWOESC:	
 12545                                  ;	mov	al,[cs:ESCCHAR] ; 10/06/2019
 12546                                  ;	jmp	SAVCH
 12547                                  
 12548                                  ;Copy the rest of the template
 12549                                  COPYLIN:
 12550 00001A75 88D9                            mov	cl,bl		;Total size of template
 12551 00001A77 28F9                    	sub	cl,bh		;Minus position in template, is number to move
 12552 00001A79 EB07                            jmp	short COPYEACH
 12553                                  
 12554                                  COPYSTR:
 12555 00001A7B E83200                  	call	FINDOLD         ;Find the char
 12556 00001A7E EB02                    	jmp	short COPYEACH  ;Copy up to it
 12557                                  
 12558                                  ;Copy one char from template to line
 12559                                  COPYONE:
 12560 00001A80 B101                            mov	cl,1
 12561                                  ;Copy CX chars from template to line
 12562                                  COPYEACH:
 12563 00001A82 36C606[7905]00                  mov	byte [SS:INSMODE],0	;All copies turn off insert mode
 12564 00001A88 38D6                    	cmp	dh,dl
 12565 00001A8A 740F                            jz	short GETCH2		;At end of line, can't do anything
 12566 00001A8C 38DF                            cmp	bh,bl
 12567 00001A8E 740B                            jz	short GETCH2		;At end of template, can't do anything
 12568 00001A90 AC                              lodsb
 12569 00001A91 AA                              stosb
 12570 00001A92 E8D201                  	call	BUFOUT
 12571 00001A95 FEC7                            inc	bh			;Ahead in template
 12572 00001A97 FEC6                            inc	dh			;Ahead in line
 12573 00001A99 E2E7                            loop	COPYEACH
 12574                                  GETCH2:
 12575 00001A9B E9E3FE                          jmp	GETCH
 12576                                  
 12577                                  ;Skip one char in template
 12578                                  SKIPONE:
 12579 00001A9E 38DF                    	cmp	bh,bl
 12580 00001AA0 74F9                    	jz	short GETCH2		;At end of template
 12581 00001AA2 FEC7                    	inc	bh			;Ahead in template
 12582 00001AA4 46                      	inc	si
 12583                                          ;jmp	GETCH
 12584                                  	; 15/01/2024
 12585 00001AA5 EBF4                    	jmp	short GETCH2
 12586                                  
 12587                                  SKIPSTR:
 12588 00001AA7 E80600                  	call	FINDOLD                 ;Find out how far to go
 12589 00001AAA 01CE                            add	si,cx			;Go there
 12590 00001AAC 00CF                            add	bh,cl
 12591                                          ;jmp	GETCH
 12592                                  	; 15/01/2024
 12593 00001AAE EBEB                    	jmp	short GETCH2
 12594                                  
 12595                                  ;Get the next user char, and look ahead in template for a match
 12596                                  ;CX indicates how many chars to skip to get there on output
 12597                                  ;NOTE: WARNING: If the operation cannot be done, the return
 12598                                  ;       address is popped off and a jump to GETCH is taken.
 12599                                  ;       Make sure nothing extra on stack when this routine
 12600                                  ;       is called!!! (no PUSHes before calling it).
 12601                                  
 12602                                  FINDOLD:
 12603 00001AB0 E831FE                          call	_$STD_CON_INPUT_NO_ECHO
 12604                                  
 12605                                  	; STRIN.ASM (MSDOS 2.11, 19/07/2018) 
 12606                                  
 12607                                  	;CMP     AL,[SS:ESCCHAR]	
 12608                                  	;JNZ     SHORT FINDSETUP
 12609                                  
 12610                                  	; CPMIO.ASM (MSDOS 6.0, 04/05/2019 - Retro DOS v4.0)
 12611                                  
 12612                                  ;hkn; ESCCHAR is in TABLE seg (DOSCODE), so CS override
 12613                                  
 12614 00001AB3 2E3A06[710A]            	CMP	AL,[CS:ESCCHAR]		; did he type a function key?
 12615 00001AB8 7505                    	JNZ	SHORT FINDSETUP		; no, set up for scan
 12616                                  
 12617 00001ABA E827FE                  	CALL	_$STD_CON_INPUT_NO_ECHO	; eat next char
 12618 00001ABD EB1D                            JMP	SHORT NOTFND		; go try again
 12619                                  FINDSETUP:
 12620 00001ABF 88D9                    	mov	cl,bl
 12621 00001AC1 28F9                            sub	cl,bh		;CX is number of chars to end of template
 12622 00001AC3 7417                    	jz	short NOTFND	;At end of template
 12623 00001AC5 49                              dec	cx		;Cannot point past end, limit search
 12624 00001AC6 7414                            jz	short NOTFND	;If only one char in template, forget it
 12625 00001AC8 06                      	push	es
 12626 00001AC9 1E                      	push	ds
 12627 00001ACA 07                      	pop	es
 12628 00001ACB 57                      	push	di
 12629 00001ACC 89F7                    	mov	di,si		;Template to ES:DI
 12630 00001ACE 47                      	inc	di
 12631 00001ACF F2AE                    	repne	scasb		;Look
 12632 00001AD1 5F                      	pop	di
 12633 00001AD2 07                      	pop	es
 12634 00001AD3 7507                    	jnz	short NOTFND	;Didn't find the char
 12635 00001AD5 F6D1                            not	cl		;Turn how far to go into how far we went
 12636 00001AD7 00D9                            add	cl,bl		;Add size of template
 12637 00001AD9 28F9                            sub	cl,bh		;Subtract current pos, result distance to skip
 12638                                  FINDOLD_RETN:
 12639 00001ADB C3                      	retn
 12640                                  
 12641                                  NOTFND:
 12642 00001ADC 5D                      	pop	bp              ;Chuck return address
 12643                                  	;jmp	GETCH
 12644                                  	; 15/01/2024
 12645                                  GETCH2_j:
 12646 00001ADD EBBC                    	jmp	short GETCH2
 12647                                  
 12648                                  REEDIT:
 12649 00001ADF B040                    	mov	al,'@'		;Output re-edit character
 12650 00001AE1 E8EF00                  	call	OUTT
 12651 00001AE4 5F                      	pop	di
 12652 00001AE5 57                      	push	di
 12653 00001AE6 06                      	push	es
 12654 00001AE7 1E                      	push	ds
 12655 00001AE8 E8EAFE                  	call	COPYNEW		;Copy current line into template
 12656 00001AEB 1F                      	pop	ds
 12657 00001AEC 07                      	pop	es
 12658 00001AED 5E                      	pop	si
 12659 00001AEE 88F3                    	mov	bl,dh		;Size of line is new size template
 12660 00001AF0 E9F9FE                  	jmp	PUTNEW		;Start over again
 12661                                  
 12662                                  EXITINS:
 12663                                  ENTERINS:
 12664 00001AF3 36F616[7905]            	not	byte [SS:INSMODE]
 12665                                  	;jmp	GETCH
 12666                                  	; 15/01/2024
 12667 00001AF8 EBE3                    	jmp	short GETCH2_j
 12668                                  
 12669                                  ;Put a real live ^Z in the buffer (embedded)
 12670                                  CTRLZ:
 12671 00001AFA B01A                    	mov	al,"Z"-"@" ; 1Ah
 12672 00001AFC E9A7FE                          jmp	SAVCH
 12673                                  
 12674                                  ;Output a CRLF
 12675                                  CRLF:
 12676 00001AFF B00D                    	mov	al,c_CR ; 0Dh 
 12677 00001B01 E8CF00                  	call	OUTT
 12678 00001B04 B00A                    	mov	al,c_LF ; 0Ah
 12679 00001B06 E9CA00                  	jmp	OUTT
 12680                                  
 12681                                  ;
 12682                                  ;----------------------------------------------------------------------------
 12683                                  ;
 12684                                  ;**	$RAW_CON_IO - Do Raw Console I/O
 12685                                  ;
 12686                                  ;	Input or output raw character from console, no echo
 12687                                  ;
 12688                                  ;	ENTRY	DL = -1 if input
 12689                                  ;		   =  output character if output
 12690                                  ;	EXIT	(AL) = input character if input
 12691                                  ;	USES	all
 12692                                  ;
 12693                                  ;----------------------------------------------------------------------------
 12694                                  ; 20/07/2018 - Retro DOS v3.0
 12695                                  
 12696                                  ; 04/05/2019 - Retro DOS v4.0
 12697                                  ; DOSCODE:541Ch (MSDOS 6.21, MSDOS.SYS)
 12698                                  
 12699                                  ; 08/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 12700                                  ; DOSCODE:5408h (MSDOS 5.0, MSDOS.SYS)
 12701                                  
 12702                                  _$RAW_CON_IO:			; System call 6
 12703                                  
 12704 00001B09 88D0                            MOV	AL,DL
 12705 00001B0B 3CFF                            CMP	AL,-1
 12706 00001B0D 7541                    	JNZ	SHORT RAWOUT ; 16/12/2022
 12707                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 12708                                  	;jz	short rci1
 12709                                  	;jmp	short RAWOUT
 12710                                  	; 16/12/202
 12711                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 12712                                  	;nop
 12713                                  rci1:
 12714                                  			; Get pointer to register save area
 12715 00001B0F 36C43E[8405]            	LES	DI,[SS:USER_SP] ; 12/03/2018
 12716 00001B14 31DB                    	XOR	BX,BX
 12717                                      	;CALL	GET_IO_FCB	; MSDOS 2.11 (Retro DOS v2.0)
 12718 00001B16 E88122                  	CALL	GET_IO_SFT	; MSDOS 3.3 & MSDOS 6.0
 12719                                          ;JC	SHORT RET17
 12720 00001B19 72C0                            jc	short FINDOLD_RETN
 12721 00001B1B B401                    	MOV	AH,1
 12722 00001B1D E88B32                  	CALL	IOFUNC
 12723 00001B20 750B                    	JNZ	SHORT RESFLG
 12724 00001B22 E80540                  	CALL	SPOOLINT
 12725                                  	;OR	BYTE [ES:DI+16H],40H
 12726 00001B25 26804D1640              	OR	BYTE [ES:DI+user_env.user_F],40H ; Set user's zero flag
 12727 00001B2A 30C0                    	XOR	AL,AL
 12728                                  RET17:
 12729 00001B2C C3                      	RETN
 12730                                  
 12731                                  RESFLG:
 12732                                  	;AND	BYTE [ES:DI+16H],0FFH-40H  ; 0BFh
 12733 00001B2D 26806516BF              	AND	BYTE [ES:DI+user_env.user_F],0FFH-40H
 12734                                  				; Reset user's zero flag
 12735                                  ;RILP:
 12736                                  rci0:
 12737 00001B32 E8F53F                       	CALL	SPOOLINT
 12738                                  ;
 12739                                  ;----------------------------------------------------------------------------
 12740                                  ;
 12741                                  ;**	$Raw_CON_INPUT - Raw Console Input
 12742                                  ;
 12743                                  ;	Input raw character from console, no echo
 12744                                  ;
 12745                                  ;	ENTRY	none
 12746                                  ;	EXIT	(al) = character
 12747                                  ;	USES	all
 12748                                  ;
 12749                                  ;----------------------------------------------------------------------------
 12750                                  ;
 12751                                  
 12752                                  ;rci0:	invoke	SPOOLINT
 12753                                  
 12754                                  	;entry	$RAW_CON_INPUT
 12755                                  
 12756                                  	; 04/05/2019 - Retro DOS v4.0
 12757                                  
 12758                                  ; DOSCODE:544Bh (MSDOS 6.21, MSDOS.SYS)
 12759                                  
 12760                                  	; 15/01/2024 - Retro DOS v5.0
 12761                                  
 12762                                  ; DOSCODE:5ACBh (PCDOS 7.1, IBMDOS.COM)
 12763                                  
 12764                                  _$RAW_CON_INPUT:		; System call 7
 12765 00001B35 53                      	push	bx
 12766 00001B36 31DB                    	XOR	BX,BX
 12767                                  	;CALL	GET_IO_FCB	; MSDOS 2.11 (Retro DOS v2.0)
 12768 00001B38 E85F22                  	CALL	GET_IO_SFT	; MSDOS 3.3 & MSDOS 6.0
 12769 00001B3B 5B                      	pop	bx
 12770 00001B3C 72EE                    	JC	SHORT RET17
 12771 00001B3E B401                    	MOV	AH,1
 12772 00001B40 E86832                  	CALL	IOFUNC
 12773                                  	;JZ	SHORT RILP	; MSDOS 2.11
 12774                                  	;XOR	AH,AH
 12775                                          ;CALL	IOFUNC
 12776                                          ;RETN
 12777 00001B43 7506                    	jnz	short rci5	; MSDOS 3.3 & MSDOS 6.0
 12778 00001B45 B484                    	MOV	AH,84h
 12779 00001B47 CD2A                    	INT	int_IBM  ; int 2Ah
 12780 00001B49 EBE7                    	JMP	short rci0
 12781                                  rci5:	
 12782 00001B4B 30E4                    	XOR	AH,AH
 12783                                  	;CALL	IOFUNC
 12784                                  	;RETN
 12785                                  	; 18/12/2022
 12786 00001B4D E95B32                  	jmp	IOFUNC
 12787                                  
 12788                                  ;       Output the character in AL to stdout
 12789                                  ;
 12790                                  	;entry	RAWOUT
 12791                                  RAWOUT:
 12792 00001B50 53                      	PUSH    BX
 12793 00001B51 BB0100                  	MOV     BX,1
 12794                                  
 12795                                  	;CALL	GET_IO_FCB	; MSDOS 2.11 (Retro DOS v2.0)
 12796 00001B54 E84322                  	CALL	GET_IO_SFT	; MSDOS 3.3 & MSDOS 6.0
 12797 00001B57 7224                    	JC	SHORT RAWRET1
 12798                                  
 12799                                  	;
 12800                                  	; MSDOS 2.11
 12801                                          ;TEST	BYTE [SI+18H],080H	; output to file?
 12802                                          ;JZ	SHORT RAWNORM		; if so, do normally
 12803                                          ;PUSH	DS
 12804                                          ;PUSH	SI
 12805                                          ;LDS	SI,[SI+19H]		; output to special?
 12806                                  	;TEST	BYTE [SI+4],ISSPEC
 12807                                  	;POP	SI
 12808                                  	;
 12809                                          
 12810                                  	; MSDOS 3.3 & MSDOS 6.0
 12811                                  	;mov	bx,[si+5]
 12812 00001B59 8B5C05                  	MOV	BX,[SI+SF_ENTRY.sf_flags] ;hkn; DS set up by get_io_sft
 12813                                   ;
 12814                                   ; If we are a network handle OR if we are not a local device then go do the
 12815                                   ; output the hard way.
 12816                                   ;	
 12817                                  	;and	bx,8080h
 12818 00001B5C 81E38080                	AND	BX,sf_isnet+devid_device
 12819                                  	;cmp	bx,80h
 12820 00001B60 81FB8000                	CMP	BX,devid_device
 12821 00001B64 7519                    	jnz     short RAWNORM
 12822 00001B66 1E                      	push    ds
 12823                                  	;lds	bx,[si+7]
 12824 00001B67 C55C07                  	LDS	BX,[SI+SF_ENTRY.sf_devptr] ; output to special?
 12825                                  	;test	byte [bx+4],10h
 12826 00001B6A F6470410                	TEST	BYTE [BX+SYSDEV.ATT],ISSPEC
 12827                                  	;
 12828                                  
 12829 00001B6E 1F                      	POP	DS
 12830 00001B6F 740E                    	JZ	SHORT RAWNORM		; if not, do normally
 12831                                  
 12832                                  	; 15/01/2024
 12833                                  	;INT	int_fastcon  ; int 29h	; quickly output the char
 12834                                  
 12835                                  	; 26/06/2024
 12836 00001B71 1E                      	push	ds ; *
 12837                                  
 12838                                  	; 12/04/2024 - Retro DOS v5.0
 12839                                  	; (PCDOS 7.1 IBMBOS.COM)
 12840 00001B72 31DB                    	xor	bx,bx
 12841 00001B74 8EDB                    	mov	ds,bx ; 0	
 12842                                  
 12843                                  	; 15/01/2024
 12844 00001B76 9C                      	pushf			; simulate INT 29h
 12845 00001B77 FF1EA400                	call    far [29h*4]	; call far [00A4h]
 12846                                  
 12847                                  	; 26/06/2024
 12848 00001B7B 1F                      	pop	ds ; *
 12849                                  
 12850                                  	;JMP	SHORT RAWRET
 12851                                  ;RAWNORM:
 12852                                  ;	CALL    RAWOUT3
 12853                                  RAWRET: 
 12854 00001B7C F8                      	CLC
 12855                                  RAWRET1:
 12856 00001B7D 5B                      	POP     BX
 12857                                  RAWRET2:
 12858 00001B7E C3                      	RETN
 12859                                  RAWNORM:
 12860 00001B7F E80700                  	CALL    RAWOUT3
 12861 00001B82 EBF8                    	jmp	short RAWRET
 12862                                  
 12863                                  ;	Output the character in AL to handle in BX
 12864                                  ;
 12865                                  ;	entry	RAWOUT2
 12866                                  
 12867                                  RAWOUT2:
 12868                                  	;CALL	GET_IO_FCB	; MSDOS 2.11 (Retro DOS v2.0)
 12869                                  	;JC	SHORT RET18
 12870 00001B84 E81322                  	CALL	GET_IO_SFT	; MSDOS 3.3 & MSDOS 6.0
 12871 00001B87 72F5                    	JC	SHORT RAWRET2
 12872                                  RAWOUT3:
 12873 00001B89 50                      	PUSH	AX
 12874 00001B8A EB0C                    	JMP	SHORT RAWOSTRT
 12875                                  ROLP:
 12876 00001B8C E89B3F                  	CALL	SPOOLINT
 12877                                  
 12878                                  	; 01/05/2019 - Retro DOS v4.0
 12879                                  
 12880                                  	; MSDOS 6.0
 12881                                  	;OR	word [ss:DOS34_FLAG],CTRL_BREAK_FLAG ; 001000000000b
 12882                                  	; 17/12/2022
 12883 00001B8F 36800E[1206]02          	or	byte [ss:DOS34_FLAG+1],(CTRL_BREAK_FLAG>>8) ; 02h
 12884                                  	;or	word [ss:DOS34_FLAG],200h
 12885                                  				;AN002; set control break
 12886                                  	;invoke DSKSTATCHK
 12887 00001B95 E8113F                  	call	DSKSTATCHK	;AN002; check control break
 12888                                  RAWOSTRT:
 12889 00001B98 B403                    	MOV	AH,3
 12890 00001B9A E80E32                  	CALL	IOFUNC
 12891 00001B9D 74ED                    	JZ	SHORT ROLP
 12892                                  
 12893                                  	; MSDOS 6.0
 12894                                  ;SR;
 12895                                  ; IOFUNC now returns ax = 0ffffh if there was an I24 on a status call and
 12896                                  ;the user failed. We do not send a char if this happens. We however return
 12897                                  ;to the caller with carry clear because this DOS call does not return any
 12898                                  ;status. 
 12899                                  ;
 12900 00001B9F 40                      	inc	ax		;fail on I24 if ax = -1
 12901 00001BA0 58                      	POP	AX
 12902 00001BA1 7405                    	jz	short nosend	;yes, do not send char
 12903 00001BA3 B402                    	MOV	AH,2
 12904 00001BA5 E80332                  	call	IOFUNC
 12905                                  nosend:
 12906 00001BA8 F8                      	CLC			; Clear carry indicating successful
 12907 00001BA9 C3                      	retn
 12908                                  
 12909                                  	; MSDOS 3.3 & MSDOS 2.11
 12910                                  	;POP	AX
 12911                                  	;MOV	AH,2
 12912                                          ;CALL	IOFUNC
 12913                                  	;CLC			; Clear carry indicating successful
 12914                                  ;RET18:    
 12915                                  	;RETN
 12916                                  
 12917                                  ;;10/08/2018
 12918                                  ; 20/07/2018 - Retro DOS v3.0
 12919                                  ; ---------------------------------------------------------------------------
 12920                                  ; Retro DOS v2.0 (MSDOS 2.11) - OUTMES
 12921                                  ; ---------------------------------------------------------------------------
 12922                                  
 12923                                  ; This routine is called at DOS init
 12924                                  
 12925                                  ;;	;procedure OUTMES,NEAR ; String output for internal messages
 12926                                  ;;OUTMES:
 12927                                  ;;	;LODS	CS:BYTE PTR [SI]
 12928                                  ;;	CS	LODSB
 12929                                  ;;	CMP     AL,"$" ; 24h
 12930                                  ;;	JZ	SHORT RET18
 12931                                  ;;	CALL	OUTT
 12932                                  ;;	JMP     SHORT OUTMES
 12933                                  
 12934                                  ; ---------------------------------------------------------------------------
 12935                                  
 12936                                  ; 20/07/2018 - Retro DOS v3.0
 12937                                  
 12938                                  ; IBMDOS.COM (MSDOS 3.3 kernel) - Offset 2252h
 12939                                  
 12940                                  ;
 12941                                  ;----------------------------------------------------------------------------
 12942                                  ;
 12943                                  ; Inputs:
 12944                                  ;	AX=0 save the DEVCALL request packet
 12945                                  ;	  =1 restore the DEVCALL request packet
 12946                                  ; Function:
 12947                                  ;	save or restore the DEVCALL packet
 12948                                  ; Returns:
 12949                                  ;	none
 12950                                  ;
 12951                                  ;----------------------------------------------------------------------------
 12952                                  ;
 12953                                  
 12954                                  ; 04/05/2019 - Retro DOS v4.0
 12955                                  ; DOSCODE:54B9h (MSDOS 6.21, MSDOS.SYS)
 12956                                  
 12957                                  ; 08/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 12958                                  ; DOSCODE:54A5h (MSDOS 5.0, MSDOS.SYS)
 12959                                  
 12960                                  ; 12/05/2019
 12961                                  
 12962                                  	; 15/01/2024 - Retro DOS v5.0
 12963                                  	; DOSCODE:5B42h (PCDOS 7.1, IBMDOS.COM)
 12964                                  
 12965                                  Save_Restore_Packet:
 12966 00001BAA 1E                      	PUSH	DS
 12967 00001BAB 06                      	PUSH	ES
 12968 00001BAC 56                      	PUSH	SI
 12969 00001BAD 57                      	PUSH	DI
 12970                                  
 12971                                  	; 16/12/2022
 12972                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 12973                                  	; 09/09/2018
 12974 00001BAE BF[A00D]                	mov	di,FAKE_STACK_2F 
 12975 00001BB1 BE[5A03]                	mov	si,DEVCALL
 12976                                  	;
 12977                                  	; 21/09/2023
 12978 00001BB4 09C0                    	or	ax,ax 
 12979                                  	;CMP	AX,0		; save packet
 12980 00001BB6 7402                    	JZ	short save_packet ; 16/12/2022
 12981                                  	;je	short set_seg
 12982                                  
 12983                                  	; MSDOS 6.0
 12984                                  restore_packet:
 12985                                  ;	MOV	SI,OFFSET DOSDATA:Packet_Temp	;source
 12986                                  ;	MOV	DI,OFFSET DOSDATA:DEVCALL	;destination
 12987                                  	; MSDOS 3.3
 12988                                  	;mov	si,FAKE_STACK_2F ; DOS_TEMP ; Packed_Temp 
 12989                                  	;mov	di,DEVCALL  ; 09/09/2018
 12990                                  	;
 12991                                  	;JMP	short set_seg
 12992                                  
 12993                                  	; 16/12/2022	
 12994                                  	; 09/09/2018
 12995 00001BB8 87FE                    	xchg	si,di  ; DI = offset DEVCALL, SI = offset FAKE_STACK_2F
 12996                                  
 12997                                  ; 16/12/2022
 12998                                  %if 0
 12999                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13000                                  	cmp	ax,0		; save packet
 13001                                  	jz	short save_packet
 13002                                  	mov	si,FAKE_STACK_2F ; 07/12/2022
 13003                                  	mov	di,DEVCALL 
 13004                                  	jmp	short set_seg
 13005                                  
 13006                                  	; MSDOS 6.0
 13007                                  save_packet:
 13008                                  ;	MOV	DI,OFFSET DOSDATA:Packet_Temp	;destination
 13009                                  ;	MOV	SI,OFFSET DOSDATA:DEVCALL	;source
 13010                                  	; 09/09/2018
 13011                                  	; MSDOS 3.3
 13012                                  	;mov	di,FAKE_STACK_2F ; DOS_TEMP ; Packed_Temp 
 13013                                  	;mov	si,DEVCALL ; 09/09/2018
 13014                                  
 13015                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13016                                  	mov	di,FAKE_STACK_2F ; DOS_TEMP ; Packed_Temp 
 13017                                  	mov	si,DEVCALL
 13018                                  %endif
 13019                                  
 13020                                  ; 16/12/2022
 13021                                  save_packet:
 13022                                  ;set_seg:
 13023                                  	; MSDOS 3.3
 13024                                  	;mov	ax,cs
 13025                                  
 13026                                  	; MSDOS 6.0
 13027                                  	;MOV	AX,SS		; set DS,ES to DOSDATA
 13028                                  	;MOV	DS,AX
 13029                                  	;MOV	ES,AX
 13030                                  	; 15/01/2024
 13031 00001BBA 16                      	push	ss
 13032 00001BBB 1F                      	pop	ds
 13033 00001BBC 1E                      	push	ds
 13034 00001BBD 07                      	pop	es
 13035                                  
 13036 00001BBE B90B00                  	MOV	CX,11		; 11 words to move
 13037 00001BC1 F3A5                    	REP	MOVSW
 13038                                  
 13039 00001BC3 5F                      	POP	DI
 13040 00001BC4 5E                      	POP	SI
 13041 00001BC5 07                      	POP	ES
 13042 00001BC6 1F                      	POP	DS
 13043 00001BC7 C3                      	retn
 13044                                  
 13045                                  ;============================================================================
 13046                                  ; CPMIO2.ASM, MSDOS 6.0, 1991
 13047                                  ;============================================================================
 13048                                  ; 20/07/2018 - Retro DOS v3.0
 13049                                  ; 01/05/2019 - Retro DOS v4.0
 13050                                  
 13051                                  ;hkn; 	All the variables use SS override or DS. Therefore there is
 13052                                  ;hkn;	no need to specifically set up any seg regs unless SS assumption is
 13053                                  ;hkn;	not valid. 
 13054                                  
 13055                                  ;
 13056                                  ;----------------------------------------------------------------------------
 13057                                  ;
 13058                                  ;**	$STD_CON_INPUT - System Call 1
 13059                                  ;
 13060                                  ;	Input character from console, echo
 13061                                  ;
 13062                                  ;	ENTRY	none
 13063                                  ;	EXIT	(al) = character
 13064                                  ;	USES	ALL
 13065                                  ;
 13066                                  ;----------------------------------------------------------------------------
 13067                                  ;
 13068                                  
 13069                                  _$STD_CON_INPUT:	;System call 1
 13070                                  	
 13071 00001BC8 E819FD                  	CALL	_$STD_CON_INPUT_NO_ECHO
 13072 00001BCB 50                      	PUSH	AX
 13073 00001BCC E80400                  	CALL	OUTT
 13074 00001BCF 58                      	POP	AX
 13075                                  CON_INPUT_RETN:	
 13076 00001BD0 C3                      	RETN
 13077                                  
 13078                                  ;
 13079                                  ;----------------------------------------------------------------------------
 13080                                  ;
 13081                                  ;**	$STD_CON_OUTPUT - System Call 2
 13082                                  ;
 13083                                  ;	Output character to console
 13084                                  ;
 13085                                  ;	ENTRY	(dl) = character
 13086                                  ;	EXIT	none
 13087                                  ;	USES	all
 13088                                  ;
 13089                                  ;----------------------------------------------------------------------------
 13090                                  ;
 13091                                  
 13092                                  ; DOSCODE:54E9h (MSDOS 6.21, MSDOS.SYS)
 13093                                  
 13094                                  ; 08/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 13095                                  ; DOSCODE:54D5h (MSDOS 5.0, MSDOS.SYS)
 13096                                  
 13097                                  ; 15/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 13098                                  ; DOSCODE:5B70h (PCDOS 7.1, IBMDOS.COM)
 13099                                  
 13100                                  _$STD_CON_OUTPUT:	;System call 2
 13101                                  
 13102 00001BD1 88D0                    	MOV	AL,DL
 13103                                  OUTT:
 13104 00001BD3 3C20                    	CMP	AL,20H ; " "
 13105 00001BD5 725C                    	JB	SHORT CTRLOUT
 13106 00001BD7 3C7F                    	CMP	AL,c_DEL ; 7Fh
 13107 00001BD9 7405                    	JZ	SHORT OUTCH
 13108                                  OUTCHA:	
 13109                                  	;INC	BYTE PTR [CARPOS]
 13110 00001BDB 36FE06[F901]            	INC	BYTE [SS:CARPOS]
 13111                                  OUTCH:
 13112 00001BE0 1E                      	PUSH	DS
 13113 00001BE1 56                      	PUSH	SI
 13114                                  	;INC	BYTE PTR [CHARCO]		;invoke statchk...
 13115                                  	;AND	BYTE PTR [CHARCO],00111111B	;AN000; every 64th char
 13116 00001BE2 36FE06[0003]            	INC	BYTE [SS:CHARCO]	
 13117                                  	;AND	BYTE [SS:CHARCO],00111111B
 13118                                  	; 01/05/2019 - Retro DOS v4.0
 13119 00001BE7 368026[0003]3F          	and	byte [SS:CHARCO],3Fh
 13120 00001BED 7505                    	JNZ	SHORT OUTSKIP
 13121                                  
 13122 00001BEF 50                      	PUSH	AX
 13123 00001BF0 E8653F                  	CALL	STATCHK
 13124 00001BF3 58                      	POP	AX
 13125                                  OUTSKIP:
 13126 00001BF4 E859FF                  	CALL	RAWOUT				;output the character
 13127                                  
 13128 00001BF7 5E                      	POP	SI
 13129 00001BF8 1F                      	POP	DS
 13130                                  
 13131                                  	;TEST	BYTE PTR [PFLAG],-1
 13132                                  	;retz
 13133 00001BF9 36F606[FE02]FF          	TEST	BYTE [SS:PFLAG],0FFh
 13134 00001BFF 74CF                    	JZ	SHORT CON_INPUT_RETN
 13135                                  
 13136 00001C01 53                      	PUSH	BX
 13137 00001C02 1E                      	PUSH	DS
 13138 00001C03 56                      	PUSH	SI
 13139 00001C04 BB0100                  	MOV	BX,1
 13140                                  	; 20/07/2018 - Retro DOS v3.0
 13141                                  	; MSDOS 3.3
 13142                                  	; MSDOS 6.0 (CPMIO2.ASM)
 13143 00001C07 E89021                  	CALL	GET_IO_SFT		;hkn; GET_IO_SFT will set up DS:SI
 13144                                  					;hkn; to sft entry
 13145 00001C0A 7224                    	JC	SHORT TRIPOPJ
 13146                                  
 13147                                  	; 01/05/2019 - Retro DOS v4.0
 13148                                  
 13149                                  	;mov	bx,[si+5]
 13150 00001C0C 8B5C05                  	MOV	BX,[SI+SF_ENTRY.sf_flags]
 13151                                  	;test	bx,8000h
 13152                                  	;TEST	BX,sf_isnet	; 8000h		; output to NET?
 13153 00001C0F F6C780                  	test	bh,(sf_isnet>>8) ; 80h
 13154 00001C12 751C                    	JNZ	short TRIPOPJ 			; if so, no echo
 13155                                  	;;test	bx,80h
 13156                                  	;TEST	BX,devid_device 		; output to file?
 13157 00001C14 F6C380                  	test	bl,devid_device ; 80h
 13158 00001C17 7417                    	JZ	SHORT TRIPOPJ 			; if so, no echo
 13159                                  	; 14/03/2018
 13160                                  	;call	GET_IO_FCB	 	; IBMDOS.COM, MSDOS 2.11
 13161                                  	;jc	short TRIPOPJ
 13162                                  	; MSDOS 2.11
 13163                                  	;test	byte [SI+18H], 80h
 13164                                  	;jz	short TRIPOPJ
 13165 00001C19 BB0400                  	MOV	BX,4
 13166 00001C1C E87B21                  	CALL	GET_IO_SFT
 13167 00001C1F 720F                    	JC	SHORT TRIPOPJ
 13168                                  	;;test	word [si+5], 800h
 13169                                  	;TEST	word [SI+SF_ENTRY.sf_flags],sf_net_spool ; 800H
 13170                                  	;test	byte [si+6],8 ; 08/11/2022
 13171 00001C21 F6440608                	test	byte [SI+SF_ENTRY.sf_flags+1],(sf_net_spool>>8) ; 8 
 13172                                  						; StdPrn redirected?
 13173                                  	;;JZ	SHORT LISSTRT2J			; No, OK to echo
 13174                                  	;jz	LISSTRT2 ; 10/08/2018 
 13175                                  	; 16/12/2022
 13176 00001C25 7503                    	jnz	short outch1
 13177 00001C27 E98700                  	jmp	LISSTRT2
 13178                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13179                                  	;jz	short LISSTRT2J
 13180                                  outch1:
 13181                                  	;MOV	BYTE [PFLAG],0
 13182 00001C2A 36C606[FE02]00          	MOV	BYTE [SS:PFLAG],0		; If a spool, NEVER echo
 13183                                  	; MSDOS 2.11
 13184                                  	;mov	bx,4
 13185                                  	;jmp	short LISSTRT2
 13186                                  	
 13187                                  TRIPOPJ:
 13188                                  	; 20/07/2018
 13189 00001C30 E98100                  	JMP	TRIPOP
 13190                                  
 13191                                  	; 16/12/2022
 13192                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13193                                  ;LISSTRT2J:
 13194                                  ;	JMP	LISSTRT2
 13195                                  
 13196                                  CTRLOUT:
 13197 00001C33 3C0D                    	CMP	AL,c_CR ; 0Dh
 13198 00001C35 7420                    	JZ	SHORT ZERPOS
 13199 00001C37 3C08                    	CMP	AL,c_BS ; 8
 13200 00001C39 7424                    	JZ	SHORT BACKPOS
 13201 00001C3B 3C09                    	CMP	AL,c_HT ; 9
 13202 00001C3D 75A1                    	JNZ	SHORT OUTCH
 13203                                  	;MOV	AL,[CARPOS]
 13204 00001C3F 36A0[F901]              	MOV	AL,[SS:CARPOS]
 13205 00001C43 0CF8                    	OR	AL,0F8H
 13206 00001C45 F6D8                    	NEG	AL
 13207                                  TAB:
 13208 00001C47 51                      	PUSH	CX
 13209 00001C48 88C1                    	MOV	CL,AL
 13210 00001C4A B500                    	MOV	CH,0
 13211 00001C4C E307                    	JCXZ	POPTAB
 13212                                  TABLP:
 13213 00001C4E B020                    	MOV	AL," "
 13214 00001C50 E880FF                  	CALL	OUTT
 13215 00001C53 E2F9                    	LOOP	TABLP
 13216                                  POPTAB:
 13217 00001C55 59                      	POP	CX
 13218                                  
 13219 00001C56 C3                      	RETN
 13220                                  
 13221                                  ZERPOS:
 13222                                  	;MOV	BYTE PTR [CARPOS],0
 13223 00001C57 36C606[F901]00          	MOV	BYTE [SS:CARPOS],0
 13224                                  	; 10/08/2018
 13225 00001C5D EB81                    	JMP	short OUTCH ; 04/05/2019
 13226                                  	
 13227                                  	; 18/12/2022
 13228                                  ;OUTJ:	
 13229                                  	;JMP	OUTT
 13230                                  
 13231                                  BACKPOS:
 13232                                  	;DEC	BYTE PTR [CARPOS]
 13233 00001C5F 36FE0E[F901]            	DEC	BYTE [SS:CARPOS]
 13234 00001C64 E979FF                  	JMP	OUTCH
 13235                                  
 13236                                  BUFOUT:
 13237 00001C67 3C20                    	CMP	AL," "
 13238 00001C69 7315                    	JAE	SHORT OUTJ		;Normal char
 13239 00001C6B 3C09                    	CMP	AL,9
 13240 00001C6D 7411                    	JZ	SHORT OUTJ		;OUT knows how to expand tabs
 13241                                  	;DOS 3.3  7/14/86
 13242 00001C6F 3C15                    	CMP	AL,"U"-"@" ; 15h	; turn ^U to section symbol
 13243 00001C71 740D                    	JZ	short CTRLU
 13244 00001C73 3C14                    	CMP	AL,"T"-"@" ; 14h	; turn ^T to paragraph symbol
 13245 00001C75 7409                    	JZ	short CTRLU
 13246                                  NOT_CTRLU:
 13247                                  	;DOS 3.3  7/14/86
 13248 00001C77 50                      	PUSH	AX
 13249 00001C78 B05E                    	MOV	AL,"^"
 13250 00001C7A E856FF                  	CALL	OUTT		;Print '^' before control chars
 13251 00001C7D 58                      	POP	AX
 13252 00001C7E 0C40                    	OR	AL,40H		;Turn it into Upper case mate
 13253                                  CTRLU:
 13254                                  	;CALL	OUTT
 13255                                  	; 18/12/2022
 13256                                  OUTJ:
 13257 00001C80 E950FF                  	jmp	OUTT
 13258                                  ;BUFOUT_RETN:
 13259                                  	;RETN
 13260                                  
 13261                                  ;
 13262                                  ;----------------------------------------------------------------------------
 13263                                  ;
 13264                                  ;**	$STD_AUX_INPUT - System Call 3
 13265                                  ;
 13266                                  ;	$STD_AUX_INPUT returns a character from Aux Input
 13267                                  ;
 13268                                  ;	ENTRY	none
 13269                                  ;	EXIT	(al) = character
 13270                                  ;	USES	all
 13271                                  ;
 13272                                  ;----------------------------------------------------------------------------
 13273                                  ;
 13274                                  
 13275                                  	; 08/11/2022 Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 13276                                  
 13277                                  _$STD_AUX_INPUT:	;System call 3
 13278                                  
 13279 00001C83 E8D23E                  	CALL	STATCHK
 13280 00001C86 BB0300                  	MOV	BX,3
 13281 00001C89 E80E21                  	CALL	GET_IO_SFT	; 20/07/2018 - MSDOS 3.3 (MSDOS 6.0)
 13282                                  	;CALL	GET_IO_FCB	; 14/03/2018 - MSDOS 2.11
 13283                                  	;retc
 13284                                  	; 16/12/2022
 13285                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13286                                  	;JC	SHORT BUFOUT_RETN
 13287                                  	;JMP	SHORT TAISTRT
 13288                                  	; 07/12/2022
 13289 00001C8C 7304                    	jnc	SHORT TAISTRT
 13290 00001C8E C3                      	retn	
 13291                                  
 13292                                  AUXILP:
 13293 00001C8F E8983E                  	CALL	SPOOLINT
 13294                                  TAISTRT:
 13295 00001C92 B401                    	MOV	AH,1
 13296 00001C94 E81431                  	CALL	IOFUNC
 13297 00001C97 74F6                    	JZ	SHORT AUXILP
 13298 00001C99 30E4                    	XOR	AH,AH
 13299                                  	; 16/12/2022
 13300                                  	;CALL	IOFUNC
 13301                                  	;RETN
 13302                                  	; 07/12/2022
 13303 00001C9B E90D31                  	jmp	IOFUNC
 13304                                  
 13305                                  ;
 13306                                  ;----------------------------------------------------------------------------
 13307                                  ;
 13308                                  ;**	$STD_AUX_OUTPUT - Output character to AUX
 13309                                  ;
 13310                                  ;	ENTRY	(dl) = character
 13311                                  ;	EXIT	none
 13312                                  ;	USES	all
 13313                                  ;
 13314                                  ;----------------------------------------------------------------------------
 13315                                  ;
 13316                                  
 13317                                  _$STD_AUX_OUTPUT:	;System call 4
 13318                                  
 13319 00001C9E 53                      	PUSH	BX
 13320 00001C9F BB0300                  	MOV	BX,3
 13321 00001CA2 EB04                    	JMP	SHORT SENDOUT
 13322                                  
 13323                                  ;
 13324                                  ;----------------------------------------------------------------------------
 13325                                  ;
 13326                                  ;**	$STD_PRINTER_OUTPUT - Output character to printer
 13327                                  ;
 13328                                  ;	ENTRY	(dl) = character
 13329                                  ;	EXIT	none
 13330                                  ;	USES	all
 13331                                  ;
 13332                                  ;----------------------------------------------------------------------------
 13333                                  ;
 13334                                  
 13335                                  _$STD_PRINTER_OUTPUT:	;System call 5
 13336                                  
 13337 00001CA4 53                      	PUSH	BX
 13338 00001CA5 BB0400                  	MOV	BX,4
 13339                                  SENDOUT:
 13340 00001CA8 88D0                    	MOV	AL,DL
 13341 00001CAA 50                      	PUSH	AX
 13342 00001CAB E8AA3E                  	CALL	STATCHK
 13343 00001CAE 58                      	POP	AX
 13344 00001CAF 1E                      	PUSH	DS
 13345 00001CB0 56                      	PUSH	SI
 13346                                  LISSTRT2:
 13347 00001CB1 E8D0FE                  	CALL	RAWOUT2
 13348                                  TRIPOP:
 13349 00001CB4 5E                      	POP	SI
 13350 00001CB5 1F                      	POP	DS
 13351 00001CB6 5B                      	POP	BX
 13352                                  SCIS_RETN:	; 20/07/2018
 13353 00001CB7 C3                      	RETN
 13354                                  ;
 13355                                  ;----------------------------------------------------------------------------
 13356                                  ;
 13357                                  ;**	$STD_CON_INPUT_STATUS - System Call 11
 13358                                  ;
 13359                                  ;	Check console input status
 13360                                  ;
 13361                                  ;	ENTRY	none
 13362                                  ;	EXIT	AL = -1 character available, = 0 no character
 13363                                  ;	USES	all
 13364                                  ;
 13365                                  ;----------------------------------------------------------------------------
 13366                                  ;
 13367                                  
 13368                                  _$STD_CON_INPUT_STATUS:		;System call 11
 13369                                  
 13370 00001CB8 E89D3E                  	CALL	STATCHK
 13371 00001CBB B000                    	MOV	AL,0		; no xor!!
 13372                                  	;retz
 13373 00001CBD 74F8                    	JZ	SHORT SCIS_RETN ; 15/04/2018
 13374                                  	;OR	AL,-1
 13375                                  	; 15/01/2024 (PCDOS 7.1 IBMDOS.COM)
 13376 00001CBF 48                      	dec	ax ; al = -1 
 13377                                  ;SCIS_RETN:
 13378 00001CC0 C3                      	RETN
 13379                                  ;
 13380                                  ;----------------------------------------------------------------------------
 13381                                  ;
 13382                                  ;**	$STD_CON_INPUT_FLUSH - System Call 12
 13383                                  ;
 13384                                  ;	Flush console input buffer and perform call in AL
 13385                                  ;
 13386                                  ;	ENTRY	(AL) = DOS function to be called after flush (1,6,7,8,10)
 13387                                  ;	EXIT	(al) = 0 iff (al) was not one of the supported fcns
 13388                                  ;		return arguments for the fcn supplied in (AL)
 13389                                  ;	USES	all
 13390                                  ;
 13391                                  ;----------------------------------------------------------------------------
 13392                                  ;
 13393                                  
 13394                                  _$STD_CON_INPUT_FLUSH:		;System call 12
 13395                                  
 13396 00001CC1 50                      	PUSH	AX
 13397 00001CC2 52                      	PUSH	DX
 13398 00001CC3 31DB                    	XOR	BX,BX
 13399 00001CC5 E8D220                  	CALL	GET_IO_SFT	; 20/07/2018 - MSDOS 3.3 (MSDOS 6.0)
 13400                                  	;CALL	GET_IO_FCB	; 14/03/2018 - MSDOS 2.11
 13401 00001CC8 7205                    	JC	SHORT BADJFNCON
 13402 00001CCA B404                    	MOV	AH,4
 13403 00001CCC E8DC30                  	CALL	IOFUNC
 13404                                  
 13405                                  BADJFNCON:
 13406 00001CCF 5A                      	POP	DX
 13407 00001CD0 58                      	POP	AX
 13408 00001CD1 88C4                    	MOV	AH,AL
 13409 00001CD3 3C01                    	CMP	AL,1
 13410 00001CD5 7413                    	JZ	SHORT REDISPJ
 13411 00001CD7 3C06                    	CMP	AL,6
 13412 00001CD9 740F                    	JZ	SHORT REDISPJ
 13413 00001CDB 3C07                    	CMP	AL,7
 13414 00001CDD 740B                    	JZ	SHORT REDISPJ
 13415 00001CDF 3C08                    	CMP	AL,8
 13416 00001CE1 7407                    	JZ	SHORT REDISPJ
 13417 00001CE3 3C0A                    	CMP	AL,10
 13418 00001CE5 7403                    	JZ	SHORT REDISPJ
 13419 00001CE7 B000                    	MOV	AL,0
 13420 00001CE9 C3                      	RETN
 13421                                  
 13422                                  REDISPJ:
 13423 00001CEA FA                      	CLI
 13424                                  	;transfer REDISP
 13425 00001CEB E987E6                  	JMP	REDISP
 13426                                  
 13427                                  ;============================================================================
 13428                                  ; FCBIO.ASM, MSDOS 6.0, 1991
 13429                                  ;============================================================================
 13430                                  ; 20/07/2018 - Retro DOS v3.0
 13431                                  ; 17/05/2019 - Retro DOS v4.0
 13432                                  
 13433                                  ;**	FCBIO.ASM - Ancient 1.0 1.1 FCB system calls
 13434                                  ;
 13435                                  ;	$GET_FCB_POSITION
 13436                                  ;	$FCB_DELETE
 13437                                  ;	$GET_FCB_FILE_LENGTH
 13438                                  ;	$FCB_CLOSE
 13439                                  ;	$FCB_RENAME
 13440                                  ;	SaveFCBInfo
 13441                                  ;	ResetLRU
 13442                                  ;	SetOpenAge
 13443                                  ;	LRUFCB
 13444                                  ;	FCBRegen
 13445                                  ;	BlastSFT
 13446                                  ;	CheckFCB
 13447                                  ;	SFTFromFCB
 13448                                  ;	FCBHardErr
 13449                                  ;
 13450                                  ;	Revision history:
 13451                                  ;
 13452                                  ;		Created: ARR 4 April 1983"
 13453                                  ;			 MZ  6 June  1983 completion of functions
 13454                                  ;			 MZ 15 Dec   1983 Brain damaged programs close FCBs multiple
 13455                                  ;					  times.  Change so successive closes work by
 13456                                  ;					  always returning OK.	Also, detect I/O to
 13457                                  ;					  already closed FCB and return EOF.
 13458                                  ;			 MZ 16 Jan   1984 More braindamage.  Need to separate info
 13459                                  ;					  out of sft into FCB for reconnection
 13460                                  ;
 13461                                  ;		A000	 version 4.00  Jan. 1988
 13462                                  
 13463                                  ;Break <$Get_FCB_Position - set random record fields to current pos>
 13464                                  ;----------------------------------------------------------------------------
 13465                                  ;
 13466                                  ;   $Get_FCB_Position - look at an FCB, retrieve the current position from the
 13467                                  ;	extent and next record field and set the random record field to point
 13468                                  ;	to that record
 13469                                  ;
 13470                                  ;   Inputs:	DS:DX point to a possible extended FCB
 13471                                  ;   Outputs:	The random record field of the FCB is set to the current record
 13472                                  ;   Registers modified: all
 13473                                  ;
 13474                                  ;----------------------------------------------------------------------------
 13475                                  ;
 13476                                  
 13477                                  _$GET_FCB_POSITION:
 13478 00001CEE E8FB04                  	call	GetExtended		; point to FCB
 13479 00001CF1 E8CC04                  	call	GetExtent		; DX:AX is current record
 13480                                  	;mov	[si+21h],ax
 13481 00001CF4 894421                  	MOV	[SI+SYS_FCB.RR],AX 	; drop in low order piece
 13482                                  	;mov	[si+23h],dl
 13483 00001CF7 885423                  	MOV	[SI+SYS_FCB.RR+2],DL	; drop in high order piece
 13484                                  	;cmp	word [si+0Eh],64
 13485 00001CFA 837C0E40                	CMP	word [SI+SYS_FCB.RECSIZ],64
 13486 00001CFE 7303                    	JAE	short GetFCBBye
 13487                                  	;mov	[si+24h],dh
 13488 00001D00 887424                  	MOV	[SI+SYS_FCB.RR+2+1],DH	; Set 4th byte only if record size < 64
 13489                                  GoodPath:	; 16/12/2022
 13490                                  GetFCBBye:
 13491 00001D03 E981E9                  	jmp	FCB_RET_OK
 13492                                  
 13493                                  ;Break <$FCB_Delete - remove several files that match the input FCB>
 13494                                  ;----------------------------------------------------------------------------
 13495                                  ;
 13496                                  ;**	$FCB_Delete - Delete from FCB Template
 13497                                  ;
 13498                                  ;	given an FCB, remove all directory entries in the current
 13499                                  ;	directory that have names that match the FCB's ?  marks.
 13500                                  ;
 13501                                  ;	ENTRY	(DS:DX) = address of FCB
 13502                                  ;	EXIT	entries matching the FCB are deleted
 13503                                  ;		(al) = ff iff no entries were deleted
 13504                                  ;	USES	all
 13505                                  ;
 13506                                  ;----------------------------------------------------------------------------
 13507                                  ;
 13508                                  	; 08/11/2022 Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 13509                                  
 13510                                  _$FCB_DELETE:		; System call 19
 13511                                  					; OpenBuf is in DOSDATA
 13512 00001D06 BF[BE03]                	MOV	DI,OPENBUF 		; appropriate place 
 13513                                  
 13514 00001D09 E8755B                  	call	TransFCB		; convert FCB to path
 13515 00001D0C 7207                    	JC	short BadPath 		; signal no deletions
 13516                                  
 13517 00001D0E 16                      	push	SS
 13518 00001D0F 1F                      	pop	DS			; SS is DOSDATA
 13519                                  
 13520 00001D10 E8F30D                  	call	DOS_DELETE		; wham
 13521                                  	;JC	short BadPath
 13522                                  	; 16/12/2022
 13523 00001D13 73EE                    	jnc 	short GoodPath
 13524                                  ;GoodPath:
 13525                                  ;	;jmp	FCB_RET_OK		; do a good return
 13526                                  ;	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13527                                  ;	jmp	short GetFCBBye
 13528                                  
 13529                                  BadPath:
 13530                                  	; Error code is in AX
 13531                                  
 13532 00001D15 E972E9                  	jmp	FCB_RET_ERR		; let someone else signal the error
 13533                                  
 13534                                  ;Break <$Get_FCB_File_Length - return the length of a file>
 13535                                  ;----------------------------------------------------------------------------
 13536                                  ;
 13537                                  ;   $Get_FCB_File_Length - set the random record field to the length of the
 13538                                  ;	file in records (rounded up if partial).
 13539                                  ;
 13540                                  ;   Inputs:	DS:DX - point to a possible extended FCB
 13541                                  ;   Outputs:	Random record field updated to reflect the number of records
 13542                                  ;   Registers modified: all
 13543                                  ;
 13544                                  ;----------------------------------------------------------------------------
 13545                                  ;
 13546                                  	; 15/01/2024 - Retrodos v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 13547                                  
 13548                                  _$GET_FCB_FILE_LENGTH:
 13549                                  
 13550 00001D18 E8D104                  	call	GetExtended		; get real FCB pointer
 13551                                  					; DX points to Input FCB
 13552                                  
 13553                                  					; OpenBuf is in DOSDATA
 13554 00001D1B BF[BE03]                	MOV	DI,OPENBUF		; appropriate buffer
 13555                                  
 13556 00001D1E 1E                      	push	ds			; save pointer to true FCB
 13557 00001D1F 56                      	push	si
 13558 00001D20 E85E5B                  	call	TransFCB		; Trans name DS:DX, sets SATTRIB
 13559 00001D23 5E                      	pop	si
 13560 00001D24 1F                      	pop	ds
 13561 00001D25 72EE                    	JC	short BadPath
 13562 00001D27 1E                      	push	ds			; save pointer
 13563 00001D28 56                      	push	si
 13564 00001D29 16                      	push	ss		
 13565 00001D2A 1F                      	pop	ds
 13566 00001D2B E8E711                  	call	GET_FILE_INFO		; grab the info
 13567 00001D2E 5E                      	pop	si			; get pointer back
 13568 00001D2F 1F                      	pop	ds
 13569 00001D30 72E3                    	JC	short BadPath 		; invalid something
 13570                                  	; 15/01/2024
 13571                                  	;MOV	DX,BX (*)		; get high order size
 13572                                  	;MOV	AX,DI (**)		; get low order size
 13573 00001D32 89D8                    	mov	ax,bx ; hw of file size
 13574                                  	;
 13575                                  	;mov	bx,[si+0Eh]
 13576 00001D34 8B5C0E                  	MOV	BX,[SI+SYS_FCB.RECSIZ]	; get his record size
 13577 00001D37 09DB                    	OR	BX,BX			; empty record => 0 size for file
 13578 00001D39 7502                    	JNZ	short GetSize 		; not empty
 13579                                  	;MOV	BX,128
 13580 00001D3B B380                    	mov	bl,128	; 15/01/2024
 13581                                  GetSize:
 13582                                  	; 15/01/2024
 13583                                  	;MOV	DI,AX			; save low order word
 13584                                  	;MOV	AX,DX			; move high order for divide
 13585                                  	;xchg	ax,dx ; (*)
 13586                                  	; ax = hw of file size
 13587                                  
 13588 00001D3D 31D2                    	XOR	DX,DX			; clear out high
 13589 00001D3F F7F3                    	DIV	BX			; wham
 13590 00001D41 50                      	PUSH	AX			; save dividend
 13591 00001D42 89F8                    	MOV	AX,DI ; (**)		; get low order piece
 13592 00001D44 F7F3                    	DIV	BX			; wham
 13593 00001D46 89D1                    	MOV	CX,DX			; save remainder
 13594 00001D48 5A                      	POP	DX			; get high order dividend
 13595 00001D49 E306                    	JCXZ	LengthStore		; no roundup
 13596 00001D4B 83C001                  	ADD	AX,1
 13597 00001D4E 83D200                  	ADC	DX,0			; 32-bit increment
 13598                                  LengthStore:
 13599                                  	;mov	[si+21h],ax
 13600 00001D51 894421                  	MOV	[SI+SYS_FCB.RR],AX	; store low order
 13601                                  	;mov	[si+23h],dl
 13602 00001D54 885423                  	MOV	[SI+SYS_FCB.RR+2],DL	; store high order
 13603 00001D57 08F6                    	OR	DH,DH
 13604 00001D59 74A8                    	JZ	short GoodPath		; not storing insignificant zero
 13605                                  	;mov	[si+24h],dh
 13606 00001D5B 887424                  	MOV	[SI+SYS_FCB.RR+3],DH	; save that high piece
 13607                                  	; 16/12/2022
 13608                                  GoodRet:
 13609                                  	;jmp	FCB_RET_OK
 13610 00001D5E EBA3                    	jmp	short GoodPath
 13611                                  
 13612                                  ;Break <$FCB_Close - close a file>
 13613                                  ;----------------------------------------------------------------------------
 13614                                  ;
 13615                                  ;   $FCB_Close - given an FCB, look up the SFN and close it. Do not free it
 13616                                  ;	as the FCB may be used for further I/O
 13617                                  ;
 13618                                  ;   Inputs:	DS:DX point to FCB
 13619                                  ;   Outputs:	AL = FF if file was not found on disk
 13620                                  ;   Registers modified: all
 13621                                  ;
 13622                                  ;----------------------------------------------------------------------------
 13623                                  ;
 13624                                  	; 16/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 13625                                  
 13626                                  _$FCB_CLOSE:		; System call 16
 13627                                  
 13628 00001D60 30C0                    	XOR	AL,AL			; default search attributes
 13629 00001D62 E88704                  	call	GetExtended		; DS:SI point to real FCB
 13630 00001D65 7403                    	JZ	short NoAttr		; not extended
 13631 00001D67 8A44FF                  	MOV	AL,[SI-1]		; get attributes
 13632                                  NoAttr:
 13633                                  					; SS override
 13634 00001D6A 36A2[6B05]              	MOV	[SS:ATTRIB],AL		; stash away found attributes
 13635 00001D6E E8CE03                  	call	SFTFromFCB
 13636 00001D71 72EB                    	JC	short GoodRet 		; MZ 16 Jan Assume death
 13637                                  
 13638                                  	; If the sharer is present, then the SFT is not regenable. Thus, 
 13639                                  	; there is no need to set the SFT's attribute.
 13640                                  
 13641                                  	;;; 9/8/86 F.C. save SFT attribute and restore it back when close is 
 13642                                  	;;; done
 13643                                  
 13644                                  	;mov	al,[es:di+4]
 13645 00001D73 268A4504                	MOV	AL,[ES:DI+SF_ENTRY.sf_attr]
 13646 00001D77 30E4                    	XOR	AH,AH
 13647 00001D79 50                      	PUSH	AX
 13648                                  
 13649                                  	;;; 9/8/86 F.C. save SFT attribute and restore it back when close is 
 13650                                  	;;; done
 13651                                  
 13652 00001D7A E84263                  	call	CheckShare
 13653 00001D7D 7508                    	JNZ	short NoStash
 13654 00001D7F 36A0[6B05]              	MOV	AL,[SS:ATTRIB]
 13655                                  	;mov	[es:di+4],al
 13656 00001D83 26884504                	MOV	[ES:DI+SF_ENTRY.sf_attr],AL ; attempted attribute for close
 13657                                  NoStash:
 13658                                  
 13659                                  ; 16/01/2024
 13660                                  %if 0
 13661                                  	;mov	ax,[si+14h]
 13662                                  	MOV	AX,[SI+SYS_FCB.FDATE] ; move in the time and date
 13663                                  	;mov	[es:di+0Fh],ax
 13664                                  	MOV	[ES:DI+SF_ENTRY.sf_date],AX
 13665                                  	;mov	ax,[si+16h]
 13666                                  	MOV	AX,[SI+SYS_FCB.FTIME]
 13667                                  	;mov	[es:di+0Dh],ax
 13668                                  	MOV	[ES:DI+SF_ENTRY.sf_time],AX
 13669                                  	;mov	ax,[si+10h]
 13670                                  	MOV	AX,[SI+SYS_FCB.FILSIZ]
 13671                                  	;mov	[es:di+11h],ax
 13672                                  	MOV	[ES:DI+SF_ENTRY.sf_size],AX
 13673                                  	;mov	ax,[si+12h]
 13674                                  	MOV	AX,[SI+SYS_FCB.FILSIZ+2]
 13675                                  	;mov	[es:di+13h],ax
 13676                                  	MOV	[ES:DI+SF_ENTRY.sf_size+2],AX
 13677                                  	;or	word [es:di+5],4000h
 13678                                  	; 17/12/2022
 13679                                  	or	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_close_nodate>>8) ; 40h
 13680                                  	;OR	word [ES:DI+SF_ENTRY.sf_flags],sf_close_nodate
 13681                                  %else
 13682                                  	; 16/01/2024 (PCDOS 7.1 IBMDOS.COM)
 13683 00001D87 1E                      	push	ds
 13684                                  	;lds	ax,[si+14h]
 13685 00001D88 C54414                  	lds	ax,[si+SYS_FCB.FDATE]	; move in the time and date
 13686                                  	;mov	[es:di+0Fh],ax
 13687 00001D8B 2689450F                	mov	[es:di+SF_ENTRY.sf_date],ax
 13688                                  	;mov	[es:di+0Dh],ds		
 13689 00001D8F 268C5D0D                	mov	[es:di+SF_ENTRY.sf_time],ds
 13690 00001D93 1F                      	pop	ds
 13691                                  	;lds	ax,[si+10h]
 13692 00001D94 C54410                  	lds	ax,[si+SYS_FCB.FILSIZ]
 13693                                  	;mov	[es:di+11h],ax
 13694 00001D97 26894511                	mov	[es:di+SF_ENTRY.sf_size],ax
 13695                                  	;mov	[es:di+13h],ds
 13696 00001D9B 268C5D13                	mov	[es:di+SF_ENTRY.sf_size+2],ds
 13697                                  	; 16/01/2024
 13698                                  	;;or	word [es:di+5],4000h
 13699                                  	;or	word [es:di+SF_ENTRY.sf_flags],sf_close_nodate
 13700 00001D9F 26804D0640              	or	byte [es:di+SF_ENTRY.sf_flags+1],(sf_close_nodate>>8) ; 40h
 13701                                  %endif
 13702                                  
 13703 00001DA4 16                      	push	ss
 13704 00001DA5 1F                      	pop	ds
 13705 00001DA6 E86518                  	call	DOS_CLOSE	; wham
 13706 00001DA9 C43E[9E05]              	LES	DI,[THISSFT]
 13707                                  
 13708                                  	;;; 9/8/86 F.C. restore SFT attribute
 13709 00001DAD 59                      	POP	CX
 13710                                  	;mov	[es:di+4],cl
 13711 00001DAE 26884D04                	MOV	[ES:DI+SF_ENTRY.sf_attr],CL
 13712                                  	;;; 9/8/86 F.C. restore SFT attribute
 13713                                  
 13714 00001DB2 9C                      	PUSHF
 13715                                  	;test	word [es:di],0FFFFh
 13716                                  	;cmp	word [ES:DI+SF_ENTRY.sf_ref_count],0
 13717                                  				; zero ref count gets blasted
 13718 00001DB3 26833D00                	cmp	word [ES:DI],0
 13719 00001DB7 7507                    	jnz     short CloseOK
 13720 00001DB9 50                      	PUSH	AX
 13721 00001DBA B04D                    	MOV	AL,'M' ; 4Dh
 13722 00001DBC E8FB02                  	call	BlastSFT
 13723 00001DBF 58                      	POP	AX
 13724                                  CloseOK:
 13725 00001DC0 9D                      	POPF
 13726 00001DC1 739B                    	JNC	short GoodRet
 13727                                  	;cmp	al,6
 13728 00001DC3 3C06                    	CMP	AL,error_invalid_handle
 13729 00001DC5 7497                    	JZ	short GoodRet
 13730                                  	;mov	al,2
 13731 00001DC7 B002                    	MOV	AL,error_file_not_found
 13732                                  fren90:
 13733                                  	; 16/12/2022
 13734                                  fcb_close_err:
 13735 00001DC9 E9BEE8                  	jmp	FCB_RET_ERR
 13736                                  
 13737                                  ;
 13738                                  ;----------------------------------------------------------------------------
 13739                                  ;
 13740                                  ;**	$FCB_Rename - Rename a File
 13741                                  ;
 13742                                  ;	$FCB_Rename - rename a file in place within a directory. Renames
 13743                                  ;	multiple files copying from the meta characters.
 13744                                  ;
 13745                                  ;	ENTRY	DS:DX point to an FCB. The normal name field is the source
 13746                                  ;		    name of the files to be renamed. Starting at offset 11h
 13747                                  ;		    in the FCB is the destination name.
 13748                                  ;	EXIT	AL = 0 -> no error occurred and all files were renamed
 13749                                  ;		AL = FF -> some files may have been renamed but:
 13750                                  ;			rename to existing file or source file not found
 13751                                  ;	USES	ALL
 13752                                  ;
 13753                                  ;----------------------------------------------------------------------------
 13754                                  ;
 13755                                  	; 08/11/2022 Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 13756                                  	; 16/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 13757                                  
 13758                                  _$FCB_RENAME:		; System call 23
 13759                                  
 13760 00001DCC E81D04                  	call	GetExtended		; get pointer to real FCB
 13761 00001DCF 52                      	push	dx
 13762 00001DD0 8A04                    	MOV	AL,[SI] 		; get drive byte
 13763 00001DD2 83C610                  	ADD	SI,10h			; point to destination
 13764                                  
 13765                                  					; RenBuf is in DOSDATA
 13766 00001DD5 BF[3E04]                	MOV	DI,RENBUF		; point to destination buffer
 13767 00001DD8 FF34                    	push	word [SI]
 13768 00001DDA 1E                      	push	ds
 13769                                  	;push	di			; save source pointer for TransFCB
 13770                                  	; 16/01/2024 (Retro DOS v4 BugFix!)
 13771 00001DDB 56                      	push	si
 13772 00001DDC 8804                    	MOV	[SI],AL			; drop in real drive
 13773 00001DDE 89F2                    	MOV	DX,SI			; let TransFCB know where the FCB is
 13774 00001DE0 E89E5A                  	call	TransFCB		; munch this pathname
 13775 00001DE3 5E                      	pop	si
 13776 00001DE4 1F                      	pop	ds	
 13777 00001DE5 8F04                    	pop	WORD [SI]		; get path back
 13778 00001DE7 5A                      	pop	dx			; Original FCB pointer
 13779 00001DE8 72DF                    	JC	short fren90		; bad path -> error
 13780                                  
 13781                                  					; SS override for WFP_Start & Ren_WFP
 13782 00001DEA 368B36[B205]            	MOV	SI,[ss:WFP_START]	; get pointer
 13783 00001DEF 368936[B405]            	MOV	[ss:REN_WFP],SI		; stash it
 13784                                  
 13785                                  					; OpenBuf is in DOSDATA
 13786 00001DF4 BF[BE03]                	MOV	DI,OPENBUF		; appropriate spot
 13787 00001DF7 E8875A                  	call	TransFCB		; wham
 13788                                  					; NOTE that this call is pointing
 13789                                  					;  back to the ORIGINAL FCB so
 13790                                  					;  SATTRIB gets set correctly
 13791 00001DFA 72CD                    	JC	short fren90		; error
 13792                                  	;;;
 13793                                  	; 16/01/2024 - Retro DOS 5.0
 13794                                  	; (PCDOS 7.1 IBMDOS.COM)
 13795 00001DFC 36C606[1011]43          	mov	byte [ss:PATHNAMELEN], 67 ; DIRSTRLEN = 67
 13796                                  	;mov	word [ss:PATHNAMELEN], 67 ; set pathname length to 67
 13797                                  	;;;
 13798 00001E02 E8D90E                  	call	DOS_RENAME
 13799 00001E05 72C2                    	JC	short fren90
 13800                                  	; 16/12/2022
 13801 00001E07 E97DE8                  	jmp	FCB_RET_OK
 13802                                  	
 13803                                  ;	Error -
 13804                                  ;
 13805                                  ;	(al) = error code
 13806                                  
 13807                                  	; 16/12/2022
 13808                                  ;fren90:	
 13809                                  ;	;jmp	FCB_RET_ERR
 13810                                  ;	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13811                                  ;	jmp	short fcb_close_err
 13812                                  
 13813                                  ;Break <Misbehavior fixers>
 13814                                  ;
 13815                                  ;   FCBs suffer from several problems. First, they are maintained in the
 13816                                  ;   user's space so he may move them at will. Second, they have a small
 13817                                  ;   reserved area that may be used for system information. Third, there was
 13818                                  ;   never any "rules for behavior" for FCBs; there was no protocol for their
 13819                                  ;   usage.
 13820                                  ;
 13821                                  ;   This results in the following misbehavior:
 13822                                  ;
 13823                                  ;	infinite opens of the same file:
 13824                                  ;
 13825                                  ;	While (TRUE) {			While (TRUE) {
 13826                                  ;	    FCBOpen (FCB);		    FCBOpen (FCB);
 13827                                  ;	    Read (FCB); 		    Write (FCB);
 13828                                  ;	    }				    }
 13829                                  ;
 13830                                  ;	infinite opens of different files:
 13831                                  ;
 13832                                  ;	While (TRUE) {			While (TRUE) {
 13833                                  ;	    FCBOpen (FCB[i++]); 	    FCBOpen (FCB[i++]);
 13834                                  ;	    Read (FCB); 		    Write (FCB);
 13835                                  ;	    }				    }
 13836                                  ;
 13837                                  ;	multiple closes of the same file:
 13838                                  ;
 13839                                  ;	FCBOpen (FCB);
 13840                                  ;	while (TRUE)
 13841                                  ;	    FCBClose (FCB);
 13842                                  ;
 13843                                  ;	I/O after closing file:
 13844                                  ;
 13845                                  ;	FCBOpen (FCB);
 13846                                  ;	while (TRUE) {
 13847                                  ;	    FCBWrite (FCB);
 13848                                  ;	    FCBClose (FCB);
 13849                                  ;	    }
 13850                                  ;
 13851                                  ;   The following is am implementation of a methodology for emulating the
 13852                                  ;   above with the exception of I/O after close. We are NOT attempting to
 13853                                  ;   resolve that particular misbehavior. We will enforce correct behaviour in
 13854                                  ;   FCBs when they refer to a network file or when there is file sharing on
 13855                                  ;   the local machine.
 13856                                  ;
 13857                                  ;   The reserved fields of the FCB (10 bytes worth) is divided up into various
 13858                                  ;   structures depending on the file itself and the state of operations of the
 13859                                  ;   OS. The information contained in this reserved field is enough to
 13860                                  ;   regenerate the SFT for the local non-shared file. It is assumed that this
 13861                                  ;   regeneration procedure may be expensive. The SFT for the FCB is
 13862                                  ;   maintained in a LRU cache as the ONLY performance inprovement.
 13863                                  ;
 13864                                  ;   No regeneration of SFTs is attempted for network FCBs.
 13865                                  ;
 13866                                  ;   To regenerate the SFT for a local FCB, it is necessary to determine if the
 13867                                  ;   file sharer is working. If the file sharer is present then the SFT is not
 13868                                  ;   regenerated.
 13869                                  ;
 13870                                  ;   Finally, if there is no local sharing, the full name of the file is no
 13871                                  ;   longer available. We can make up for this by using the following
 13872                                  ;   information:
 13873                                  ;
 13874                                  ;	The Drive number (from the DPB).
 13875                                  ;	The physical sector of the directory that contains the entry.
 13876                                  ;	The relative position of the entry in the sector.
 13877                                  ;	The first cluster field.
 13878                                  ;	The last used SFT.
 13879                                  ;      OR In the case of a device FCB
 13880                                  ;	The low 6 bits of sf_flags (indicating device type)
 13881                                  ;	The pointer to the device header
 13882                                  ;
 13883                                  ;   We read in the particular directory sector and examine the indicated
 13884                                  ;   directory entry. If it matches, then we are kosher; otherwise, we fail.
 13885                                  ;
 13886                                  ;   Some key items need to be remembered:
 13887                                  ;
 13888                                  ;	Even though we are caching SFTs, they may contain useful sharing
 13889                                  ;	information. We enforce good behavior on the FCBs.
 13890                                  ;
 13891                                  ;	Network support must not treat FCBs as impacting the ref counts on
 13892                                  ;	open VCs. The VCs may be closed only at process termination.
 13893                                  ;
 13894                                  ;	If this is not an installed version of the DOS, file sharing will
 13895                                  ;	always be present.
 13896                                  ;
 13897                                  ;	We MUST always initialize lstclus to = firclus when regenerating a
 13898                                  ;	file. Otherwise we start allocating clusters up the wazoo.
 13899                                  ;
 13900                                  ;	Always initialize, during regeneration, the mode field to both isFCB
 13901                                  ;	and open_for_both. This is so the FCB code in the sharer can find the
 13902                                  ;	proper OI record.
 13903                                  ;
 13904                                  ;   The test bits are:
 13905                                  ;
 13906                                  ;	00 -> local file
 13907                                  ;	40 -> sharing local
 13908                                  ;	80 -> network
 13909                                  ;	C0 -> local device
 13910                                  
 13911                                  ;Break	<SaveFCBInfo - store pertinent information from an SFT into the FCB>
 13912                                  ;----------------------------------------------------------------------------
 13913                                  ;
 13914                                  ;   SaveFCBInfo - given an FCB and its associated SFT, copy the relevant
 13915                                  ;	pieces of information into the FCB to allow for subsequent
 13916                                  ;	regeneration. Poke LRU also.
 13917                                  ;
 13918                                  ;   Inputs:	ThisSFT points to a complete SFT.
 13919                                  ;		DS:SI point to the FCB (not an extended one)
 13920                                  ;   Outputs:	The relevant reserved fields in the FCB are filled in.
 13921                                  ;		DS:SI preserved
 13922                                  ;		ES:DI point to sft
 13923                                  ;   Registers modified: All
 13924                                  ;
 13925                                  ;
 13926                                  ;----------------------------------------------------------------------------
 13927                                  ;
 13928                                  
 13929                                  	; 08/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 13930                                  	; 20/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 13931                                  	
 13932                                  SaveFCBInfo:
 13933                                  
 13934 00001E0A 36C43E[9E05]            	LES	DI,[SS:THISSFT]		; SS override
 13935 00001E0F E80DFA                  	call	IsSFTNet
 13936 00001E12 740B                    	JZ	short SaveLocal		; if not network then save local info
 13937                                  ;
 13938                                  ;----- In net support -----
 13939                                  ;
 13940                                  	; 17/05/2019 - Retro DOS v4.0
 13941                                  
 13942                                  	; MSDOS 3.3
 13943                                  	;;mov	ax,[es:di+1Dh]
 13944                                  	;mov	ax,[es:di+SF_ENTRY.sf_dirsec]
 13945                                  	;;mov	[si+1Ah],ax
 13946                                  	;mov	[si+fcb_net_handle],ax
 13947                                  	;push	es
 13948                                  	;push	di
 13949                                  	;;les	di,[es:di+19h]
 13950                                  	;LES	DI,[ES:DI+sf_netid]
 13951                                  	;;mov	[si+1Ch],di
 13952                                  	;MOV	[SI+fcb_netID],DI	; save net ID
 13953                                  	;;mov 	[si+1Eh],es
 13954                                  	;MOV	[SI+fcb_netID+2],ES
 13955                                  	;pop	di
 13956                                  	;pop	es
 13957                                  
 13958                                  	; MSDOS 6.0
 13959                                  	;mov	ax,[es:di+0Bh]
 13960 00001E14 268B450B                	MOV	AX,[ES:DI+sf_serial_ID] ;AN000;;IFS. save IFS ID
 13961                                  	;mov	[si+1Ch],ax
 13962 00001E18 89441C                  	MOV	[SI+fcb_netID],ax	;AN000;;IFS.
 13963                                  	
 13964                                  	;mov	bl,80h
 13965 00001E1B B380                    	MOV	BL,FCBNETWORK
 13966                                  ;
 13967                                  ;----- END In net support -----
 13968                                  ;
 13969 00001E1D EB63                    	jmp	SHORT SaveSFN
 13970                                  
 13971                                  SaveLocal:
 13972                                  	;IF	Installed
 13973 00001E1F E89D62                  	call	CheckShare
 13974                                  	;JZ	short SaveNoShare	; no sharer
 13975                                  	;JMP	short SaveShare		; sharer present
 13976                                  	; 16/12/2022
 13977                                  	; 28/07/2019
 13978 00001E22 7559                    	jnz	short SaveShare
 13979                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 13980                                  	;JZ	short SaveNoShare	; no sharer
 13981                                  	;JMP	short SaveShare		; sharer present
 13982                                  
 13983                                  SaveNoShare:
 13984                                  	;;test 	word [es:di+5],80h
 13985                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device
 13986 00001E24 26F6450580              	test	byte [ES:DI+SF_ENTRY.sf_flags],devid_device ; 80h	
 13987 00001E29 7542                    	JNZ	short SaveNoShareDev	; Device
 13988                                  
 13989                                  	; Save no sharing local file information
 13990                                  
 13991                                  	;;mov	ax,[es:di+1Dh]  ; MSDOS 3.3
 13992                                  	;mov	ax,[es:di+1Bh]  ; MSDOS 6.0
 13993 00001E2B 268B451B                	MOV	AX,[ES:DI+SF_ENTRY.sf_dirsec] ; get directory sector F.C.
 13994                                  	;mov	[si+1Dh],ax
 13995 00001E2F 89441D                  	MOV	[SI+fcb_nsl_dirsec],AX
 13996                                  
 13997                                  	; MSDOS 6.0
 13998                                  
 13999                                  	;SR; Store high byte of directory sector
 14000                                  	;mov	ax,[es:di+1Dh]
 14001 00001E32 268B451D                	mov	ax,[es:di+SF_ENTRY.sf_dirsec+2] ; get high word
 14002                                  	
 14003                                  	; SR;
 14004                                  	; We have to store the read-only and archive attributes of the file.
 14005                                  	; We extract it from the SFT and store it in the top two bits of the 
 14006                                  	; sector number ( sector number == 22 bits only )
 14007                                  
 14008                                  	;mov	bl,[es:di+4]
 14009 00001E36 268A5D04                	mov	bl,[es:di+SF_ENTRY.sf_attr]
 14010 00001E3A 88DF                    	mov	bh,bl
 14011 00001E3C D0CB                    	ror	bl,1
 14012 00001E3E D0E7                    	shl	bh,1
 14013 00001E40 08FB                    	or	bl,bh
 14014 00001E42 80E3C0                  	and	bl,0C0h
 14015 00001E45 08D8                    	or	al,bl
 14016                                  	;mov	[si+18h],al ; 08/11/2022
 14017 00001E47 884418                  	mov	[si+fcb_sfn],al	; sector number = 22 bits
 14018                                  
 14019                                  	; MSDOS 6.0 (& MSDOS 3.3)
 14020                                  	;mov	al,[es:di+1Fh]
 14021 00001E4A 268A451F                	MOV	AL,[ES:DI+SF_ENTRY.sf_dirpos] ; location in sector
 14022                                  	;mov	[si+1Fh],al
 14023 00001E4E 88441F                  	MOV	[SI+fcb_nsl_dirpos],AL
 14024                                  
 14025                                  	; 20/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 14026                                  	;;;
 14027                                  	;;mov	ax,[es:di+0Bh]	; .sf_firclus:
 14028                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_firclus] ; first cluster
 14029                                  	; 20/01/2024
 14030                                  	; (PCDOS 7.1 IBMDOS.COM - DOSCODE:5DF5h)
 14031                                  	; (Windows ME IO.SYS - BIOSCODE:5D60h)
 14032 00001E51 268B452B                	mov	ax,[es:di+2Bh]  ; .sf_chain !!! (MSDOS 6.22)
 14033                                  	;mov	ax,[es:di+SF_ENTRY.sf_chain] ; first cluster (32 bit) !?
 14034                                  	;;;
 14035                                  	;mov	[si+1Bh],ax
 14036 00001E55 89441B                  	MOV	[SI+fcb_nsl_firclus],AX
 14037 00001E58 B300                    	MOV	BL,0
 14038                                  
 14039                                  	; Create the bits field from the dirty/device bits of the flags word 
 14040                                  	; and the mode byte
 14041                                  
 14042                                  SetFCBBits:
 14043                                  	;mov	ax,[es:di+5]
 14044 00001E5A 268B4505                	MOV	AX,[ES:DI+SF_ENTRY.sf_flags]
 14045 00001E5E 24C0                    	AND	AL,0C0h 		; mask off drive bits
 14046                                  	;or	al,[es:di+2]
 14047 00001E60 260A4502                	OR	AL,[ES:DI+SF_ENTRY.sf_mode] ; stick in open mode
 14048                                  	;mov	[si+1Ah], al
 14049 00001E64 88441A                  	MOV	[SI+fcb_nsl_bits],AL	; save dirty info
 14050                                  
 14051                                  	; MSDOS 6.0
 14052                                  	
 14053                                  	; SR;
 14054                                  	; Check if we came here for local file or device. If for local file, 
 14055                                  	; skip setting of SFT index
 14056                                  	
 14057 00001E67 08DB                    	or	bl,bl
 14058 00001E69 7428                    	jz	short SaveNoSFN		; do not save SFN if local file
 14059                                  
 14060 00001E6B EB15                    	JMP	short SaveSFN 		; go and save SFN
 14061                                  
 14062                                  	; Save no sharing local device information
 14063                                  
 14064                                  SaveNoShareDev:
 14065                                  	; 20/01/2024
 14066                                  	;;mov	ax,[es:di+7]
 14067                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_devptr]
 14068                                  	;;mov	[si+1Ah],ax
 14069                                  	;MOV	[SI+fcb_nsld_drvptr],AX
 14070                                  	;;mov	ax,[es:di+9]
 14071                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_devptr+2]
 14072                                  	;MOV	[SI+fcb_nsld_drvptr+2],AX
 14073                                  	; 20/01/2024 (PCDOS 7.1 IBMDOS.COM)
 14074 00001E6D 06                      	push	es
 14075 00001E6E 26C44507                	les	ax,[es:di+SF_ENTRY.sf_devptr]
 14076 00001E72 89441A                  	mov	[si+fcb_nsld_drvptr],ax
 14077 00001E75 8C441C                  	mov	[si+fcb_nsld_drvptr+2],es
 14078 00001E78 07                      	pop	es
 14079                                  	
 14080                                  	;mov	bl,40h
 14081 00001E79 B340                    	MOV	BL,FCBDEVICE
 14082                                  	; 28/12/2022
 14083 00001E7B EBDD                    	JMP	short SetFCBBits	; go and save SFN
 14084                                  
 14085                                  SaveShare:
 14086                                  	;ENDIF
 14087                                  
 14088                                  ;----- In share support -----
 14089                                  
 14090                                  	;call	far [ss:ShSave]
 14091 00001E7D 36FF1E[B800]            	Call	far [ss:JShare+(10*4)] ; 10 = ShSave ; SS Override
 14092                                  
 14093                                  ;----- end in share support -----
 14094                                  
 14095                                  	; 17/05/2019
 14096                                  
 14097                                  SaveSFN:
 14098                                  	;lea	ax,[di-6]
 14099 00001E82 8D45FA                  	LEA	AX,[DI-SFT.SFTable]
 14100                                  	
 14101                                  	; Adjust for offset to table.
 14102                                  	
 14103 00001E85 362B06[4000]            	SUB	AX,[SS:SFTFCB]		; SS override for SftFCB
 14104                                  
 14105 00001E8A 53                      	push	bx			;bx = FCB type (net/Share or local)
 14106                                  	;;mov	bl,53 ; MSDOS 3.3
 14107                                  	;mov	bl,59 ; MSDOS 6.0
 14108 00001E8B B33B                    	MOV	BL,SF_ENTRY.size
 14109 00001E8D F6F3                    	DIV	BL
 14110                                  	;mov	[si+18h],al
 14111 00001E8F 884418                  	MOV	[SI+fcb_sfn],AL		; last used SFN
 14112 00001E92 5B                      	pop	bx			;restore bx
 14113                                  
 14114                                  SaveNoSFN:
 14115                                  	;mov	ax,[es:di+5]
 14116 00001E93 268B4505                	MOV	AX,[ES:DI+SF_ENTRY.sf_flags]
 14117 00001E97 243F                    	AND	AL,3Fh			; get real drive
 14118 00001E99 08D8                    	OR	AL,BL
 14119                                  	;mov	[si+19h],al
 14120 00001E9B 884419                  	MOV	[SI+fcb_l_drive],AL
 14121                                  
 14122 00001E9E 36A1[1000]              	MOV	AX,[SS:FCBLRU]		; get lru count
 14123 00001EA2 40                      	INC	AX
 14124                                  	;mov	[es:di+15h],ax
 14125 00001EA3 26894515                	MOV	[ES:DI+sf_LRU],AX
 14126 00001EA7 7506                    	JNZ	short SimpleStuff
 14127                                  	
 14128                                  	; lru flag overflowed. Run through all FCB sfts and adjust:  
 14129                                  	; LRU < 8000H get set to 0. Others -= 8000h. This LRU = 8000h
 14130                                  	
 14131                                  	;mov	bx,15h
 14132 00001EA9 BB1500                  	MOV	BX,SF_ENTRY.sf_position
 14133 00001EAC E80500                  	call	ResetLRU
 14134                                  
 14135                                  	; Set new LRU to AX
 14136                                  SimpleStuff:
 14137 00001EAF 36A3[1000]              	MOV	[SS:FCBLRU],AX
 14138 00001EB3 C3                      	retn
 14139                                  
 14140                                  ;Break	<ResetLRU - reset overflowed lru counts>
 14141                                  ;----------------------------------------------------------------------------
 14142                                  ;
 14143                                  ;   ResetLRU - during lru updates, we may wrap at 64K. We must walk the
 14144                                  ;   entire set of SFTs and subtract 8000h from their lru counts and truncate
 14145                                  ;   at 0.
 14146                                  ;
 14147                                  ;   Inputs:	BX is offset into SFT field where lru firld is kept
 14148                                  ;		ES:DI point to SFT currently being updated
 14149                                  ;   Outputs:	All FCB SFTs have their lru fields truncated
 14150                                  ;		AX has 8000h
 14151                                  ;   Registers modified: none
 14152                                  ;
 14153                                  ;----------------------------------------------------------------------------
 14154                                  ;
 14155                                  
 14156                                  	; 17/05/2019 - Retro DOS v4.0
 14157                                  ResetLRU:
 14158                                  	; ResetLRU is only called from fcbio.asm. So SS can be assumed to be 
 14159                                  	; DOSDATA
 14160                                  
 14161 00001EB4 B80080                  	MOV	AX,8000h
 14162 00001EB7 06                      	push	es
 14163 00001EB8 57                      	push	di
 14164                                  	;LES	DI,[CS:SFTFCB]		; get pointer to head
 14165 00001EB9 36C43E[4000]            	LES	DI,[SS:SFTFCB] ; MSDOS 6.0
 14166                                  	;mov	cx,[es:di+4]
 14167 00001EBE 268B4D04                	MOV	CX,[ES:DI+SFT.SFCount]
 14168                                  	;lea	di,[di+6]
 14169 00001EC2 8D7D06                  	LEA	DI,[DI+SFT.SFTable] 	; point at table
 14170                                  ovScan:
 14171 00001EC5 262901                  	SUB	[ES:DI+BX],AX		; decrement lru count
 14172 00001EC8 7703                    	JA	short ovLoop
 14173 00001ECA 268901                  	MOV	[ES:DI+BX],AX		; truncate at 0
 14174                                  ovLoop:
 14175                                  	;;add	di,53	; MSDOS 3.3
 14176                                  	;add	di,59	; MSDOS 6.0	
 14177 00001ECD 83C73B                  	ADD	DI,SF_ENTRY.size	; advance to next
 14178 00001ED0 E2F3                    	LOOP	ovScan
 14179 00001ED2 5F                      	pop	di
 14180 00001ED3 07                      	pop	es
 14181 00001ED4 268901                  	MOV	[ES:DI+BX],AX
 14182 00001ED7 C3                      	retn
 14183                                  
 14184                                  ;IF  0  ; We dont need this routine any more.
 14185                                  ;
 14186                                  ;Break	<SetOpenAge - update the open age of a SFT>
 14187                                  ;----------------------------------------------------------------------------
 14188                                  ;
 14189                                  ;   SetOpenAge - In order to maintain the first N open files in the FCB cache,
 14190                                  ;   we keep the 'open age' or an LRU count based on opens. We update the
 14191                                  ;   count here and fill in the appropriate field.
 14192                                  ;
 14193                                  ;   Inputs:	ES:DI point to SFT
 14194                                  ;   Outputs:	ES:DI has the open age field filled in.
 14195                                  ;		If open age has wraparound, we will have subtracted 8000h
 14196                                  ;		    from all open ages.
 14197                                  ;   Registers modified: AX
 14198                                  ;
 14199                                  ;----------------------------------------------------------------------------
 14200                                  ;
 14201                                  ;SetOpenAge:
 14202                                  ;	; 20/07/2018 - Retro DOS v3.0
 14203                                  ;	; MSDOS 3.3 - IBMDOS.COM, Offset 2597h 
 14204                                  ;	; (& MSDOS 6.0, FCBIO.ASM)
 14205                                  ;
 14206                                  ;	; SetOpenAge is called from fcbio2.asm. SS can be assumed to be valid.
 14207                                  ;
 14208                                  ;	MOV	AX,[CS:OpenLRU]	; SS override
 14209                                  ;	INC	AX
 14210                                  ;	;mov	[es:di+17h],ax
 14211                                  ;	MOV	[ES:DI+sf_OpenAge],AX
 14212                                  ;	JNZ	short SetDone
 14213                                  ;	;mov	bx,17h
 14214                                  ;	MOV	BX,SF_ENTRY.sf_position+2 ; mov bx,sf_OpenAge
 14215                                  ;	call	ResetLRU
 14216                                  ;SetDone:
 14217                                  ;	MOV	[CS:OpenLRU],AX
 14218                                  ;	retn
 14219                                  ;
 14220                                  ;ENDIF	; SetOpenAge no longer needed
 14221                                  
 14222                                  ; 21/07/2018 - Retro DOS v3.0
 14223                                  ; LRUFCB for MSDOS 6.0 !
 14224                                  
 14225                                  ;Break	<LRUFCB - perform LRU on FCB sfts>
 14226                                  ;----------------------------------------------------------------------------
 14227                                  ;
 14228                                  ;   LRUFCB - find LRU fcb in cache. Set ThisSFT and return it. We preserve
 14229                                  ;	the first keepcount sfts if they are network sfts or if sharing is
 14230                                  ;	loaded.  If carry is set then NO BLASTING is NECESSARY.
 14231                                  ;
 14232                                  ;   Inputs:	none
 14233                                  ;   Outputs:	ES:DI point to SFT
 14234                                  ;		ThisSFT points to SFT
 14235                                  ;		SFT is zeroed
 14236                                  ;		Carry set of closes failed
 14237                                  ;   Registers modified: none
 14238                                  ;
 14239                                  ;----------------------------------------------------------------------------
 14240                                  ;
 14241                                  ; MSDOS 6.0
 14242                                  ;IF 0	; rewritten this routine
 14243                                  ;
 14244                                  ;LRUFCB: ; MSDOS 3.3 - IBMDOS.COM (1987) - Offset 25ADh
 14245                                  ;	call	save_world
 14246                                  ;	
 14247                                  ; Find nth oldest NET/SHARE FCB. We want to find its age for the second scan
 14248                                  ; to find the lease recently used one that is younger than the open age.  We
 14249                                  ; operate be scanning the list n times finding the least age that is greater
 14250                                  ; or equal to the previous minimum age.
 14251                                  ;
 14252                                  ;   BP is the count of times we need to go through this loop.
 14253                                  ;   AX is the current acceptable minimum age to consider
 14254                                  ;
 14255                                  ;	mov	bp,[CS:KEEPCOUNT]	; k = keepcount;
 14256                                  ;	XOR	AX,AX			; low = 0;
 14257                                  ;
 14258                                  ; If we've scanned the table n times, then we are done.
 14259                                  ;
 14260                                  ;lru1:
 14261                                  ;	CMP	bp,0			; while (k--) {
 14262                                  ;	JZ	short lru75
 14263                                  ;	DEC	bp
 14264                                  ;
 14265                                  ; Set up for scan.
 14266                                  ;
 14267                                  ;   AX is the minimum age for consideration
 14268                                  ;   BX is the minimum age found during the scan
 14269                                  ;   SI is the position of the entry that corresponds to BX
 14270                                  ;
 14271                                  ;	MOV	BX,-1			;     min = 0xffff;
 14272                                  ;	MOV	si,BX			;     pos = 0xffff;
 14273                                  ;	LES	DI,[CS:SFTFCB]		;     for (CX=FCBCount; CX>0; CX--)
 14274                                  ;	;mov	cx,[es:di+4]
 14275                                  ;	MOV	CX,[ES:DI+SFT.SFCount]
 14276                                  ;	;lea	di,[di+6]
 14277                                  ;	LEA	DI,[DI+SFT.SFTable]
 14278                                  ;
 14279                                  ; Innermost loop.  If the current entry is free, then we are done.  Or, if the
 14280                                  ; current entry is busy (indicating a previous aborted allocation), then we
 14281                                  ; are done.  In both cases, we use the found entry.
 14282                                  ;
 14283                                  ;lru2:
 14284                                  ;	cmp	word [es:di],0
 14285                                  ;	;cmp	word [es:di+SF_ENTRY.sf_ref_count],0
 14286                                  ;	jz	short lru25
 14287                                  ;	;cmp	word [es:di],-1
 14288                                  ;	;cmp	word [es:di+SF_ENTRY.sf_ref_count],sf_busy
 14289                                  ;	cmp	word [es:di],sf_busy
 14290                                  ;	jnz	short lru3
 14291                                  ;
 14292                                  ; The entry is usable without further scan.  Go and use it.
 14293                                  ;
 14294                                  ;lru25:
 14295                                  ;	MOV	si,DI			;	      pos = i;
 14296                                  ;	JMP	short lru11		;	      goto got;
 14297                                  ;
 14298                                  ; See if the entry is for the network or for the sharer.
 14299                                  ;
 14300                                  ;  If for the sharer or network then
 14301                                  ;	if the age < current minimum AND >= allowed minimum then
 14302                                  ;	    this entry becomes current minimum
 14303                                  ;
 14304                                  ;lru3:
 14305                                  ;	;test	word [es:di+5],8000h
 14306                                  ;	TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet 
 14307                                  ;					;	  if (!net[i]
 14308                                  ;	JNZ	short lru35
 14309                                  ;if installed
 14310                                  ;	call	CheckShare		;		&& !sharing)
 14311                                  ;	JZ	short lru5		;	  else
 14312                                  ;ENDIF
 14313                                  ;
 14314                                  ; This SFT is for the net or is for the sharer. See if it less than the
 14315                                  ; current minimum.
 14316                                  ;
 14317                                  ;lru35:
 14318                                  ;	;mov	dx,[es:di+17h]
 14319                                  ;	MOV	DX,[ES:DI+sf_OpenAge]
 14320                                  ;	CMP	DX,AX			;	  if (age[i] >= low &&
 14321                                  ;	JB	short lru5
 14322                                  ;	CMP	DX,BX
 14323                                  ;	JAE	short lru5		;	      age[i] < min) {
 14324                                  ;
 14325                                  ; entry is new minimum.  Remember his age.
 14326                                  ;
 14327                                  ;	mov	bx,DX			;	      min = age[i];
 14328                                  ;	mov	si,di			;	      pos = i;
 14329                                  ;
 14330                                  ; End of loop.	gp back for more
 14331                                  ;
 14332                                  ;lru5:
 14333                                  ;	;add	di,53
 14334                                  ;	add	di,SF_ENTRY.size
 14335                                  ;	loop	lru2			;	      }
 14336                                  ;
 14337                                  ; The scan is complete. If we have successfully found a new minimum (pos != -1)
 14338                                  ; set then threshold value to this new minimum + 1. Otherwise, the scan is
 14339                                  ; complete.  Go find LRU.
 14340                                  ;
 14341                                  ;lru6:	
 14342                                  ;	cmp	si,-1			; position not -1?
 14343                                  ;	jz	short lru75		; no, done with everything
 14344                                  ;	lea	ax,[bx+1]		; set new threshold age
 14345                                  ;	jmp	short lru1		; go and loop for more
 14346                                  ;lru65:	
 14347                                  ;	stc
 14348                                  ;	jmp	short LRUDead		;	  return -1;
 14349                                  ;
 14350                                  ; Main loop is done. We have AX being the age+1 of the nth oldest sharer or
 14351                                  ; network entry. We now make a second pass through to find the LRU entry
 14352                                  ; that is local-no-share or has age >= AX
 14353                                  ;
 14354                                  ;lru75:
 14355                                  ;	mov	bx,-1			; min = 0xffff;
 14356                                  ;	mov	si,bx			; pos = 0xffff;
 14357                                  ;	LES	DI,[CS:SFTFCB]		; for (CX=FCBCount; CX>0; CX--)
 14358                                  ;	;mov	cx,[es:di+4]
 14359                                  ;	MOV	CX,[ES:DI+SFT.SFCount]
 14360                                  ;	;lea	di,[di+6]
 14361                                  ;	LEA	DI,[DI+SFT.SFTable]
 14362                                  ;
 14363                                  ; If this is is local-no-share then go check for LRU else if age >= threshold
 14364                                  ; then check for lru.
 14365                                  ;
 14366                                  ;lru8:
 14367                                  ;	;test	word [es:di+5],8000h
 14368                                  ;	TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 14369                                  ;	jnz	short lru85		; is for network, go check age
 14370                                  ;	call	CheckShare		; sharer here?
 14371                                  ;	jz	short lru86		; no, go check lru
 14372                                  ;
 14373                                  ; Network or sharer.  Check age
 14374                                  ;
 14375                                  ;lru85:
 14376                                  ;	;cmp	[es:di+17h],ax
 14377                                  ;	cmp	[es:di+sf_OpenAge],ax
 14378                                  ;	jb	short lru9		; age is before threshold, skip it
 14379                                  ;
 14380                                  ; Check LRU
 14381                                  ;
 14382                                  ;lru86:
 14383                                  ;	;cmp	[es:di+15h],bx
 14384                                  ;	cmp	[es:di+sf_LRU],bx	; is LRU less than current LRU?
 14385                                  ;	jae	short lru9		; no, skip this
 14386                                  ;	mov	si,di			; remember position
 14387                                  ;	;mov	bx,[es:di+15h]
 14388                                  ;	mov	bx,[es:di+sf_LRU]	; remember new minimum LRU
 14389                                  ;
 14390                                  ; Done with this entry, go back for more.
 14391                                  ;
 14392                                  ;lru9:
 14393                                  ;	;add	di, 53
 14394                                  ;	add	di,SF_ENTRY.size
 14395                                  ;	loop	lru8
 14396                                  ;
 14397                                  ; Scan is complete. If we found NOTHING that satisfied us then we bomb
 14398                                  ; out. The conditions here are:
 14399                                  ;
 14400                                  ;  No local-no-shares AND all net/share entries are older than threshold
 14401                                  ;
 14402                                  ;lru10:
 14403                                  ;	cmp	si,-1			; if no one f
 14404                                  ;	jz	short lru65		;     return -1;
 14405                                  ;lru11:
 14406                                  ;	mov	di,si
 14407                                  ;	MOV	[CS:THISSFT],DI		; set thissft
 14408                                  ;	MOV	[CS:THISSFT+2],ES
 14409                                  ;
 14410                                  ; If we have sharing or thisSFT is a net sft, then close it until ref count
 14411                                  ; is 0.
 14412                                  ;
 14413                                  ;	;test	word [es:di+5],8000h
 14414                                  ;	TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 14415                                  ;	JNZ	short LRUClose
 14416                                  ;IF INSTALLED
 14417                                  ;	call	CheckShare
 14418                                  ;	JZ	short LRUDone
 14419                                  ;ENDIF
 14420                                  ;
 14421                                  ; Repeat close until ref count is 0
 14422                                  ;
 14423                                  ;LRUClose:
 14424                                  ;	push	ss
 14425                                  ;	pop	ds
 14426                                  ;	LES	DI,[THISSFT]
 14427                                  ;	cmp     word [es:di],0
 14428                                  ;	;CMP	word [ES:DI+SFT.sf_ref_count],0 ; is ref count still <> 0?
 14429                                  ;	JZ	short LRUDone 		; nope, all done
 14430                                  ;	call	DOS_CLOSE
 14431                                  ;	jnc	short LRUClose		; no error => clean up
 14432                                  ;	;cmp	al,6
 14433                                  ;	cmp	al,error_invalid_handle
 14434                                  ;	jz	short LRUClose
 14435                                  ;	stc
 14436                                  ;	JMP	short LRUDead
 14437                                  ;LRUDone:
 14438                                  ;	XOR	AL,AL
 14439                                  ;	call	BlastSFT		; fill SFT with 0 (AL), 'C' cleared
 14440                                  ;
 14441                                  ;LRUDead:
 14442                                  ;	call	restore_world
 14443                                  ;	LES     DI,[CS:THISSFT]
 14444                                  ;	jnc	short LRUFCB_retn
 14445                                  ;LRUFCB_err:
 14446                                  ;	; mov	al, 23h	
 14447                                  ;	MOV	AL,error_FCB_unavailable
 14448                                  ;LRUFCB_retn:	
 14449                                  ;	retn:
 14450                                  ;
 14451                                  ;ENDIF	; LRUFCB has been rewritten below.
 14452                                  
 14453                                  ; 17/05/2019 - Retro DOS v4.0
 14454                                  ; LRUFCB for MSDOS 6.0 !
 14455                                  ;----------------------------------------------------------------------------
 14456                                  ;
 14457                                  ; LruFCB -- allocate the LRU SFT from the SFT Table. The LRU scheme
 14458                                  ; maintains separate counts for net/Share and local SFTs. We allocate a 
 14459                                  ; net/Share SFT only if we do not find a local SFT. This helps keep
 14460                                  ; net/Share SFTs which cannot be regenerated for as long as possible. We
 14461                                  ; optimize regeneration operations by keeping track of the current local
 14462                                  ; SFT. This avoids scanning of the SFTs as long as we have at least one 
 14463                                  ; local SFT in the SFT Block.
 14464                                  ;
 14465                                  ; Inputs: al = 0 => Regenerate SFT operation
 14466                                  ;	    = 1 => Allocate new SFT for Open/Create
 14467                                  ;
 14468                                  ; Outputs: Carry clear
 14469                                  ;	 	es:di = Address of allocated SFT
 14470                                  ;	  	ThisSFT = Address of allocated SFT
 14471                                  ;
 14472                                  ;	  carry set if closes of net/Share files failed 
 14473                                  ;		al = error_FCB_unavailable
 14474                                  ;
 14475                                  ; Registers affected: None
 14476                                  ;
 14477                                  ;----------------------------------------------------------------------------
 14478                                  
 14479                                  ;LruFCB	PROC	NEAR
 14480                                  LRUFCB:
 14481                                  	; 17/05/2019 - Retro DOS v4.0
 14482                                  	; DOSCODE:5805h (MSDOS 6.21, MSDOS.SYS)
 14483                                  
 14484                                  	; 08/11/2022 Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 14485                                  	; DOSCODE:57F1h (MSDOS 5.0, MSDOS.SYS)
 14486                                  
 14487                                  	; 20/01/2024 Retro DOS v5.0 (Modified PCDOS 7.1 IBMMDOS.COM)
 14488                                  	; DOSCODE:5E7Ch (PCDOS 7.1, IBMDOS.COM)
 14489                                  
 14490 00001ED8 06                      	push	es	; * (MSDOS 6.21)
 14491                                  	
 14492 00001ED9 E87CE5                  	call	save_world
 14493                                  	
 14494                                  	;getdseg <ds>		;ds = DOSDATA
 14495 00001EDC 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 14496                                  
 14497 00001EE1 08C0                    	or	al,al		;Check if regenerate allocation
 14498 00001EE3 7516                    	jnz	short lru1	;Try to find SFT to use
 14499                                  
 14500                                  	; This is a regen call. If LocalSFT contains the address of a valid 
 14501                                  	; local SFT, just return that SFT to reuse
 14502                                  
 14503                                  	; 20/01/2024
 14504                                  	;mov	di,[LocalSFT]
 14505                                  	;or	di,[LocalSFT+2]	;is address == 0?
 14506                                  	;jz	short lru1	;invalid local SFT, find one
 14507                                  
 14508                                  	; We have found a valid local SFT. Recycle this SFT
 14509                                  
 14510 00001EE5 C43E[490F]              	les	di,[LocalSFT]
 14511                                  
 14512                                  	; 20/01/2024 (PCDOS 7.1 IBMDOS.COM)
 14513 00001EE9 8CC1                    	mov	cx,es
 14514 00001EEB 09F9                    	or	cx,di		; is address == 0?
 14515 00001EED 740C                    	jz	short lru1	; invalid local SFT, find one
 14516                                  
 14517                                  gotlocalSFT:
 14518 00001EEF 893E[9E05]              	mov	[THISSFT],di
 14519 00001EF3 8C06[A005]              	mov	[THISSFT+2],es
 14520 00001EF7 F8                      	clc
 14521 00001EF8 E9A900                  	jmp	LRUDone		;clear up SFT and return
 14522                                  
 14523                                  lru1:
 14524 00001EFB C43E[4000]              	les	di,[SFTFCB]	;es:di = SF Table for FCBs
 14525                                  	;mov	cx,[es:di+4]
 14526 00001EFF 268B4D04                	mov	cx,[es:di+SFT.SFCount]	;cx = number of SFTs
 14527                                  	;lea	di,[di+6]
 14528 00001F03 8D7D06                  	lea	di,[di+SFT.SFTable]	;es:di = first SFT
 14529                                  
 14530                                  	; We scan through all the SFTs scanning for a free one. It also 
 14531                                  	; remembers the LRU SFT for net/Share SFTs and local SFTs separately. 
 14532                                  	; bx = min. LRU for local SFTs
 14533                                  	; si = pos. of local SFT with min. LRU
 14534                                  	; dx = min. LRU for net/Share SFTs
 14535                                  	; bp = pos. of net/Share SFT with min. LRU
 14536                                  
 14537 00001F06 BBFFFF                  	mov	bx,-1		; init. to 0xffff ( max. LRU value )
 14538 00001F09 89DE                    	mov	si,bx
 14539 00001F0B 89DA                    	mov	dx,bx
 14540 00001F0D 89DD                    	mov	bp,bx
 14541                                  
 14542                                  findSFT:
 14543                                  	;See if this SFT is a free one. If so, return it
 14544 00001F0F 26830D00                	or	word [es:di],0
 14545                                  	;or	word [es:di+SF_ENTRY.sf_ref_count],0 ;reference count = 0 ?
 14546 00001F13 744C                    	jz	short gotSFT	;yes, SFT is free
 14547                                  	;;cmp	word [es:di],-1
 14548                                  	;cmp	word [es:di+SF_ENTRY.sf_ref_count],sf_busy ;Is it busy?
 14549 00001F15 26833DFF                	cmp	word [es:di],sf_busy ; -1 
 14550 00001F19 7446                    	jz	short gotSFT	;no, can use it
 14551                                  
 14552                                  	; Check if this SFT is local and store its address in LocalSFT. Can be 
 14553                                  	; used for a later regen.
 14554                                  
 14555                                  	; 16/12/2022
 14556                                  	; 08/11/2022
 14557                                  	;test	byte [es:di+6],80h
 14558 00001F1B 26F6450680              	test	byte [es:di+SF_ENTRY.sf_flags+1],(sf_isnet>>8) ; 80h
 14559                                  	; 08/11/2022 Retro DOS v4.0 (MSDOS 5.0 MSDOS.SYS compatibility)
 14560                                  	;;test	word [es:di+5],8000h
 14561                                  	;test	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet ; network SFT?
 14562 00001F20 7531                    	jnz	short lru5	;yes, get net/Share LRU
 14563                                  
 14564                                  ;IF installed
 14565 00001F22 E89A61                  	call	CheckShare	;Share present?
 14566                                  ;ENDIF
 14567 00001F25 752C                    	jnz	short lru5	;yes, get net/Share LRU
 14568                                  
 14569                                  	;Local SFT, register its address
 14570                                  
 14571                                  	; !!HACK!!!
 14572                                  	; There is a slightly dirty hack out here in a desperate bid to save  
 14573                                  	; code space. There is similar code duplicated at label 'gotSFT'. We 
 14574                                  	; enter from there if al = 0, update the LocalSFT variable, and since 
 14575                                  	; al = 0, we jump out of the loop to the exit point. I have commented 
 14576                                  	; out the code that previously existed at label 'gotSFT'
 14577                                  
 14578                                  hackpoint:
 14579 00001F27 893E[490F]              	mov	[LocalSFT],di
 14580 00001F2B 8C06[4B0F]              	mov	[LocalSFT+2],es	;store local SFT address
 14581                                  
 14582 00001F2F 08C0                    	or	al,al		;Is operation = REGEN?
 14583 00001F31 74BC                    	jz	short gotlocalSFT ;yes, return this SFT for reuse
 14584                                  
 14585                                  	;Get LRU for local files
 14586                                  	
 14587                                  	;cmp	[es:di+15h],bx
 14588 00001F33 26395D15                	cmp	[es:di+sf_LRU],bx ;SFT.LRU < min?
 14589 00001F37 7306                    	jae	short lru4	;no, skip 
 14590                                  
 14591                                  	;mov	bx,[es:di+15h]
 14592 00001F39 268B5D15                	mov	bx,[es:di+sf_LRU] ;yes, store new minimum
 14593 00001F3D 89FE                    	mov	si,di		;store SFT position
 14594                                  lru4:
 14595                                  	;add	di,59
 14596 00001F3F 83C73B                  	add	di,SF_ENTRY.size ;go to next SFT
 14597 00001F42 E2CB                    	loop	findSFT
 14598                                  	
 14599                                  	; 20/01/2024
 14600 00001F44 49                      	dec	cx ; -1
 14601                                  
 14602                                  	; Check whether we got a net/Share or local SFT. If local SFT
 14603                                  	; available, we will reuse it instead of net/Share LRU
 14604                                  
 14605 00001F45 89F7                    	mov	di,si
 14606                                  	;cmp	si,-1		;local SFT available?
 14607 00001F47 39CE                    	cmp	si,cx ; 20/01/2024
 14608 00001F49 7516                    	jnz	short gotSFT	;yes, return it
 14609                                  
 14610                                  	;No local SFT, see if we got a net/Share SFT
 14611                                  
 14612 00001F4B 89EF                    	mov	di,bp
 14613                                  
 14614 00001F4D 39CD                    	cmp	bp,cx ; -1 ; 20/01/2024
 14615                                  	;cmp	bp,-1		;net/Share SFT available?
 14616 00001F4F 752D                    	jnz	short gotnetSFT	;yes, return it
 14617                                  noSFT:
 14618                                  	; NB: This error should never occur. We always must have an LRU SFT.
 14619                                  	; This error can occur only if the SFT has been corrupted or the LRU
 14620                                  	; count is not maintained properly.
 14621                                  
 14622 00001F51 EB4E                    	jmp	short errorbadSFT ;error, no FCB available.
 14623                                  
 14624                                  	; Handle the LRU for net/Share SFTs
 14625                                  lru5:
 14626                                  	;cmp	[es:di+15h],dx
 14627 00001F53 26395515                	cmp	[es:di+sf_LRU],dx ;SFT.LRU < min?
 14628 00001F57 73E6                    	jae	short lru4	;no, skip
 14629                                  
 14630                                  	;mov	dx,[es:di+15h]
 14631 00001F59 268B5515                	mov	dx,[es:di+sf_LRU] ;yes, store new minimum
 14632                                  
 14633 00001F5D 89FD                    	mov	bp,di		;store SFT position
 14634 00001F5F EBDE                    	jmp	short lru4	;continue with next SFT
 14635                                  
 14636                                  gotSFT:
 14637 00001F61 08C0                    	or	al,al
 14638 00001F63 74C2                    	jz	short hackpoint	;save es:di in LocalSFT
 14639                                  
 14640                                  	; HACK!!!
 14641                                  	; The code here differs from the code at 'hackpoint' only in the 
 14642                                  	; order of the check for al. If al = 0, we can jump to 'hackpoint'
 14643                                  	; and then from there jump out to 'gotlocalSFT'. The original code
 14644                                  	; has been commented out below and replaced by the code just above.
 14645                                  
 14646                                  ;If regen, then this SFT can be registered as a local one ( even if free ).
 14647                                  ;
 14648                                  ;	or	al,al		  ;Regen?
 14649                                  ;	jnz	short notlocaluse ;yes, register it and return
 14650                                  ;
 14651                                  ;Register this SFT as a local one
 14652                                  ;
 14653                                  ;	mov	[LocalSFT],di
 14654                                  ;	mov	[LocalSFT+2],es
 14655                                  ;	jmp	gotlocalSFT	;return to caller
 14656                                  ;
 14657                                  ;notlocaluse:
 14658                                  
 14659                                  	; The caller is probably going to use this SFT for a net/Share file.
 14660                                  	; We will come here only on a Open/Create when the caller($FCB_OPEN)
 14661                                  	; does not really know whether it is a local file or not. We
 14662                                  	; invalidate LocalSFT if the SFT we are going to use was previously
 14663                                  	; registered as a local SFT that can be recycled.
 14664                                  
 14665 00001F65 8CC0                    	mov	ax,es
 14666 00001F67 393E[490F]              	cmp	[LocalSFT],di		;Offset same?
 14667 00001F6B 750E                    	jne	short notinvalid
 14668 00001F6D 3906[4B0F]              	cmp	[LocalSFT+2],ax		;Segments same?
 14669                                  	;je	short zerolocalSFT	;no, no need to invalidate
 14670                                  	; 20/01/2024 (PCDOS 7.1 IBMDOS.COM)
 14671 00001F71 7508                    	jne	short notinvalid
 14672                                  zerolocalSFT:	
 14673 00001F73 31C0                    	xor	ax,ax ; 0
 14674 00001F75 A3[490F]                	mov	[LocalSFT],ax
 14675 00001F78 A3[4B0F]                	mov	[LocalSFT+2],ax
 14676                                  	
 14677                                  notinvalid:
 14678 00001F7B E971FF                  	jmp	gotlocalSFT
 14679                                  
 14680                                  	; The SFT we are going to use was registered in the LocalSFT variable.
 14681                                  	; Invalidate this variable i.e LocalSFT = NULL
 14682                                  
 14683                                  ;zerolocalSFT:
 14684                                  	;xor	ax,ax ; 0
 14685                                  	;mov	[LocalSFT],ax
 14686                                  	;mov	[LocalSFT+2],ax
 14687                                  	;
 14688                                  	;jmp	gotlocalSFT
 14689                                  
 14690                                  gotnetSFT:
 14691                                  	; We have an SFT that is currently net/Share. If it is going to be
 14692                                  	; used for a regen, we know it has to be a local SFT. Update the
 14693                                  	; LocalSFT variable
 14694                                  
 14695 00001F7E 08C0                    	or	al,al
 14696 00001F80 7508                    	jnz	short closenet
 14697                                  
 14698 00001F82 893E[490F]              	mov	[LocalSFT],di
 14699 00001F86 8C06[4B0F]              	mov	[LocalSFT+2],es	;store local SFT address
 14700                                  closenet:
 14701 00001F8A 893E[9E05]              	mov	[THISSFT],di	; set thissft
 14702 00001F8E 8C06[A005]              	mov	[THISSFT+2],es	
 14703                                  
 14704                                  	; If we have sharing or thisSFT is a net sft, then close it until ref
 14705                                  	; count is 0.
 14706                                  	; NB: We come here only if it is a net/Share SFT that is going to be
 14707                                  	; recycled -- no need to check for this.
 14708                                  
 14709                                  LRUClose:
 14710 00001F92 26833D00                	cmp	word [es:di],0
 14711                                  	;cmp	word [es:di+SF_ENTRY.sf_ref_count],0 ; is ref count still <> 0?
 14712 00001F96 740C                    	jz	short LRUDone	; nope, all done
 14713                                  
 14714 00001F98 E87316                  	call	DOS_CLOSE
 14715 00001F9B 73F5                    	jnc	short LRUClose	; no error => clean up
 14716                                  
 14717                                  	; Bugbug: I dont know why we are trying to close after we get an
 14718                                  	; error closing. Seems like we could have a potential infinite loop
 14719                                  	; here. This has to be verified.
 14720                                  
 14721 00001F9D 3C06                    	cmp	al,error_invalid_handle ; 6
 14722 00001F9F 74F1                    	je	short LRUClose
 14723                                  errorbadSFT:
 14724 00001FA1 F9                      	stc
 14725 00001FA2 EB05                    	JMP	short LRUDead
 14726                                  LRUDone:
 14727 00001FA4 30C0                    	XOR	AL,AL
 14728 00001FA6 E81101                  	call	BlastSFT		; fill SFT with 0 (AL), 'C' cleared
 14729                                  
 14730                                  LRUDead:
 14731 00001FA9 E895E4                  	call	restore_world		; use macro
 14732                                  	
 14733 00001FAC 07                      	pop	es ; * (MSDOS 6.21)
 14734                                  
 14735                                  	;getdseg <es>
 14736 00001FAD 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 14737 00001FB2 26C43E[9E05]            	les	di,[es:THISSFT]		;es:di points at allocated SFT
 14738                                  
 14739                                  	;;retnc
 14740                                  	;jc	short LruFCB_err
 14741                                  	;retn
 14742                                  
 14743                                  	; 16/12/2022
 14744                                  	; 08/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 14745 00001FB7 7302                    	jnc	short LruFCB_retn
 14746                                  	;jc	short LruFCB_err
 14747                                  	;retn
 14748                                  		
 14749                                  LruFCB_err:
 14750 00001FB9 B023                    	MOV	AL,error_FCB_unavailable ; 23h
 14751                                  LruFCB_retn:
 14752 00001FBB C3                      	retn
 14753                                  	
 14754                                  ;LruFCB	ENDP
 14755                                  
 14756                                  ; 17/05/2019 - Retro DOS v4.0
 14757                                  
 14758                                  ; DOSCODE:58F3h (MSDOS 6.21, MSDOS.SYS)
 14759                                  
 14760                                  ; 26/06/2024
 14761                                  %if 0
 14762                                  
 14763                                  ; --------------------------------------------------------------------------
 14764                                  ;**** RegenCopyName -- This function copies the filename from the FCB to
 14765                                  ; SFT and also to DOS local buffers. There was duplicate code in FCBRegen
 14766                                  ; to copy the name to different destinations
 14767                                  ;
 14768                                  ; Inputs: ds:si = source string
 14769                                  ;	 es:di = destination string
 14770                                  ;	 cx = length of string
 14771                                  ;
 14772                                  ; Outputs: String copied to destination
 14773                                  ;
 14774                                  ; Registers affected: cx,di,si
 14775                                  ; --------------------------------------------------------------------------
 14776                                  
 14777                                  RegenCopyName:
 14778                                  CopyName:
 14779                                  	lodsb			;load character
 14780                                  	call	UCase		; convert char to upper case
 14781                                  StuffChar2:
 14782                                  	STOSB			;store converted character
 14783                                  	LOOP	CopyName	;
 14784                                  DoneName:
 14785                                  	retn
 14786                                  
 14787                                  %endif
 14788                                  
 14789                                  ; --------------------------------------------------------------------------
 14790                                  
 14791                                  	; 09/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 14792                                  	; 21/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 14793                                  
 14794                                  FCBRegen:
 14795                                  	; called from SFTFromFCB. SS already DOSDATA
 14796                                  
 14797                                  	; General data filling. Mode is sf_isFCB + open_for_both, date/time 
 14798                                  	; we do not fill, size we do no fill, position we do not fill,
 14799                                  	; bit 14 of flags = TRUE, other bits = FALSE
 14800                                  
 14801                                  	;mov	al,[si+19h]
 14802 00001FBC 8A4419                  	MOV	AL,[SI+fcb_l_drive]
 14803                                  
 14804                                  	; We discriminate based on the first two bits in the reserved field.
 14805                                  	
 14806                                  	;test	al,80h
 14807 00001FBF A880                    	test	AL,FCBSPECIAL		; check for no sharing test
 14808 00001FC1 741C                    	JZ	short RegenNoSharing	; yes, go regen from no sharing
 14809                                  
 14810                                  	; The FCB is for a network or a sharing based system. At this point 
 14811                                  	; we have already closed the SFT for this guy and reconnection is 
 14812                                  	; impossible.
 14813                                  	;
 14814                                  	; Remember that he may have given us a FCB with bogus information in
 14815                                  	; it. Check to see if sharing is present or if the redir is present.
 14816                                  	; If either is around, presume that we have cycled out the FCB and 
 14817                                  	; give the hard error. Otherwise, just return with carry set.
 14818                                  
 14819 00001FC3 E8F960                  	call	CheckShare		; test for sharer
 14820 00001FC6 7509                    	JNZ	short RegenFail		; yep, fail this.
 14821                                  	
 14822                                  	;mov	ax,1100h
 14823 00001FC8 B80011                  	MOV	AX,MultNET<<8		; install check on multnet
 14824 00001FCB CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - INSTALLATION CHECK
 14825                                  			; Return: AL = 00h  not installed, OK to install
 14826                                  			; 01h  not installed, not OK to install
 14827                                  			; FFh  installed
 14828 00001FCD 08C0                    	OR	AL,AL			; is it there?
 14829 00001FCF 740C                    	JZ	short RegenDead		; no, just fail the operation
 14830                                  RegenFail:
 14831                                  	; 17/05/2019 - Retro DOS v4.0
 14832                                  	;MOV	AX,[CS:USER_IN_AX]	; SS override
 14833 00001FD1 36A1[3A03]              	mov	ax,[SS:USER_IN_AX] ; MSDOS 6.0
 14834                                  
 14835                                  	;cmp	ah,10h
 14836 00001FD5 80FC10                  	cmp	AH,FCB_CLOSE
 14837 00001FD8 7403                    	jz	short RegenDead
 14838 00001FDA E89801                  	call	FCBHardErr		; massive hard error.
 14839                                  RegenDead:
 14840 00001FDD F9                      	STC				; carry set
 14841                                  FCBRegen_retn:
 14842 00001FDE C3                      	retn
 14843                                  
 14844                                  	; Local FCB without sharing. Check to see if sharing is loaded. If 
 14845                                  	; so fail the operation.
 14846                                  
 14847                                  RegenNoSharing:
 14848 00001FDF E8DD60                  	call	CheckShare		; Sharing around?
 14849 00001FE2 75ED                    	JNZ	short RegenFail
 14850                                  	
 14851                                  	; Find an SFT for this guy.
 14852                                  	
 14853                                  	; 17/05/2019 - Retro DOS v4.0
 14854                                  
 14855                                  	; MSDOS 3.3
 14856                                  	;call	LRUFCB
 14857                                  	;jc	short FCBRegen_retn
 14858                                  	
 14859                                  	; MSDOS 6.0
 14860 00001FE4 50                      	push	ax
 14861 00001FE5 B000                    	mov	al,0			;indicate it is a regen operation
 14862 00001FE7 E8EEFE                  	call	LRUFCB
 14863 00001FEA 58                      	pop	ax
 14864 00001FEB 72F1                    	jc	short FCBRegen_retn
 14865                                  
 14866                                  	;mov	word [es:di+2],8002h
 14867 00001FED 26C745020280            	MOV	word [ES:DI+SF_ENTRY.sf_mode],sf_isFCB+open_for_both+SHARING_COMPAT
 14868 00001FF3 243F                    	AND	AL,3Fh			; get drive number for flags
 14869 00001FF5 98                      	CBW
 14870                                  	;or	ax,4000h
 14871 00001FF6 0D0040                  	OR	AX,sf_close_nodate	; normal FCB operation
 14872                                  
 14873                                  	; The bits field consists of the upper two bits (dirty and device) 
 14874                                  	; from the SFT and the low 4 bits from the open mode.
 14875                                  
 14876                                  	;mov	cl,[si+1Ah]
 14877 00001FF9 8A4C1A                  	MOV	CL,[SI+fcb_nsl_bits]	; stick in dirty bits.
 14878 00001FFC 88CD                    	MOV	CH,CL
 14879 00001FFE 80E5C0                  	AND	CH,0C0h 		; mask off the dirty/device bits
 14880 00002001 08E8                    	OR	AL,CH
 14881                                  	;and	cl,0Fh
 14882 00002003 80E10F                  	AND	CL,access_mask		; get the mode bits
 14883                                  	;mov	[es:di+2],cl
 14884 00002006 26884D02                	MOV	[ES:DI+SF_ENTRY.sf_mode],CL
 14885                                  	;mov	[es:di+5],ax
 14886 0000200A 26894505                	MOV	[ES:DI+SF_ENTRY.sf_flags],AX ; initial flags
 14887                                  	;MOV	AX,[CS:PROC_ID]		; SS override
 14888 0000200E 36A1[3C03]              	mov	ax,[ss:PROC_ID] ; MSDOS 6.0
 14889                                  	;mov	[es:di+31h],ax
 14890 00002012 26894531                	MOV	[ES:DI+SF_ENTRY.sf_PID],AX
 14891 00002016 1E                      	push	ds
 14892 00002017 56                      	push	si
 14893 00002018 06                      	push	es
 14894 00002019 57                      	push	di
 14895 0000201A 16                      	push	ss
 14896 0000201B 07                      	pop	es
 14897 0000201C BF[4B05]                	MOV	DI,NAME1		; NAME1 is in DOSDATA
 14898                                  
 14899 0000201F B90800                  	MOV	CX,8
 14900 00002022 46                      	INC	SI			; Skip past drive byte to name in FCB
 14901                                  
 14902                                  	; MSDOS 3.3
 14903                                  ;RegenCopyName:
 14904                                  	;lodsb
 14905                                  	;call	UCase
 14906                                  	;stosb
 14907                                  	;loop	RegenCopyName
 14908                                  
 14909                                  	; MSDOS 6.0
 14910 00002023 E88C00                  	call	RegenCopyName		;copy the name to NAME1
 14911                                  
 14912 00002026 16                      	push	ss	; SS is DOSDATA
 14913 00002027 1F                      	pop	ds
 14914                                  
 14915                                  	;mov	byte [ATTRIB],16h
 14916 00002028 C606[6B05]16            	MOV	byte [ATTRIB],attr_hidden+attr_system+attr_directory
 14917                                  					; Must set this to something interesting
 14918                                  					; to call DEVNAME.
 14919 0000202D E8CB2B                  	call	DEVNAME 		; check for device
 14920 00002030 5E                      	pop	si
 14921 00002031 07                      	pop	es
 14922 00002032 5E                      	pop	si
 14923 00002033 1F                      	pop	ds
 14924 00002034 7219                    	JC	short RegenFileNoSharing ; not found on device list => file
 14925                                  
 14926                                  	; Device found. We can ignore disk-specific info
 14927                                  
 14928                                  	;mov	[es:di+5],bh
 14929 00002036 26887D05                	MOV	[ES:DI+SF_ENTRY.sf_flags],BH ; device parms
 14930                                  	;mov	byte [es:di+4],0
 14931 0000203A 26C6450400              	MOV	byte [ES:DI+SF_ENTRY.sf_attr],0 ; attribute
 14932                                  					; SS override
 14933                                  	;LDS	SI,[CS:DEVPT]		; get device driver
 14934 0000203F 36C536[9A05]            	lds	si,[ss:DEVPT] ; MSDOS 6.0
 14935                                  regen_save_dpb:	; 26/06/2024
 14936                                  	;mov	[es:di+7],si
 14937 00002044 26897507                	MOV	[ES:DI+SF_ENTRY.sf_devptr],SI
 14938                                  	;mov	[es:di+9],ds
 14939 00002048 268C5D09                	MOV	[ES:DI+SF_ENTRY.sf_devptr+2],DS
 14940 0000204C C3                      	retn				; carry is clear
 14941                                  
 14942                                  RegenDeadJ:
 14943 0000204D EB8E                    	JMP	short RegenDead
 14944                                  
 14945                                  	; File found. Just copy in the remaining pieces.
 14946                                  
 14947                                  RegenFileNoSharing:
 14948                                  	;mov	ax,[es:di+5]
 14949 0000204F 268B4505                	MOV	AX,[ES:DI+SF_ENTRY.sf_flags]
 14950 00002053 83E03F                  	AND	AX,03Fh
 14951 00002056 1E                      	push	ds
 14952 00002057 56                      	push	si
 14953 00002058 E8EA56                  	call	FIND_DPB
 14954                                  	;;mov	[es:di+7],si
 14955                                  	;MOV	[ES:DI+SF_ENTRY.sf_devptr],SI
 14956                                  	;;mov	[es:di+9],ds
 14957                                  	;MOV	[ES:DI+SF_ENTRY.sf_devptr+2],DS
 14958                                  	; 26/06/2024 (PCDOS 7.1 IBMDOS.COM)
 14959 0000205B E8E6FF                  	call	regen_save_dpb
 14960 0000205E 5E                      	pop	si
 14961 0000205F 1F                      	pop	ds
 14962 00002060 72EB                    	jc	short RegenDeadJ	; if find DPB fails, then drive
 14963                                  					; indicator was bogus
 14964                                  	;mov	ax,[si+1Dh]
 14965 00002062 8B441D                  	MOV	AX,[SI+fcb_nsl_dirsec]
 14966                                  	;;mov	[es:di+1Dh],ax ; MSDOS 3.3
 14967                                  	;mov	[es:di+1Bh],ax ; MSDOS 6.0
 14968 00002065 2689451B                	MOV	[ES:DI+SF_ENTRY.sf_dirsec],AX
 14969                                  
 14970                                  	; MSDOS 6.0
 14971                                  
 14972                                  	; SR;
 14973                                  	; Extract the read-only and archive bits from the top 2 bits of the sector
 14974                                  	; number
 14975                                  
 14976                                  	;mov	al,[si+18h]
 14977 00002069 8A4418                  	mov	al,[si+fcb_sfn]
 14978 0000206C 24C0                    	and	al,0C0h		;get the 2 attribute bits
 14979 0000206E 88C4                    	mov	ah,al
 14980 00002070 D0C4                    	rol	ah,1
 14981 00002072 D0E8                    	shr	al,1
 14982 00002074 08E0                    	or	al,ah
 14983 00002076 243F                    	and	al,03Fh		;mask off unused bits
 14984                                  	;mov	[es:di+4],al
 14985 00002078 26884504                	mov	[es:di+SF_ENTRY.sf_attr],al
 14986                                  
 14987                                  	; SR;
 14988                                  	; Update the higher word of the directory sector from the FCB
 14989                                  
 14990                                  	;;mov	al,[si+18h]
 14991 0000207C 8A4418                  	mov	al,[si+fcb_sfn]
 14992 0000207F 243F                    	and	al,03Fh		;mask off top 2 bits -- attr bits
 14993 00002081 28E4                    	sub	ah,ah
 14994                                  	;mov	[es:di+1Dh],ax
 14995 00002083 2689451D                	mov	[es:di+SF_ENTRY.sf_dirsec+2],ax ;update high word
 14996                                  
 14997                                  	; 21/01/2024
 14998                                  	; MSDOS 6.0 (& MSDOS 3.3)
 14999                                  	;mov	ax,[si+1Bh]
 15000 00002087 8B441B                  	MOV	AX,[SI+fcb_nsl_firclus]
 15001                                  	;;mov	[es:di+0Bh],ax
 15002                                  	;MOV	[ES:DI+SF_ENTRY.sf_firclus],AX
 15003                                  	;;;
 15004                                  	; 21/01/2024 (PCDOS 7.1 IBMDOS.COM)
 15005 0000208A 2689452B                	mov	[es:di+2Bh],ax	; .sf_chain !!! (MSDOS 6.22)
 15006                                  	;mov	[es:di+SF_ENTRY.sf_chain],ax ; first cluster (32 bit) !?
 15007                                  	;;;	
 15008                                  
 15009                                  	;;mov	[es:di+1Bh],ax ; MSDOS 3.3
 15010                                  	;mov	[es:di+35h],ax ; MSDOS 6.0
 15011 0000208E 26894535                	MOV	[ES:DI+SF_ENTRY.sf_lstclus],AX
 15012                                  
 15013                                  	;;;
 15014                                  	; 21/01/2024 (PCDOS 7.1 IBMDOS.COM)
 15015 00002092 31C0                    	xor	ax,ax	; 0
 15016 00002094 2689452D                	mov	[es:di+2Dh], ax ; 0
 15017                                  	;mov	[es:di+SF_ENTRY.sf_chain+2],ax
 15018                                  				; .sf_chain ! (MSDOS 6.22)
 15019                                  				; high word of first cluster (32 bit) !?
 15020 00002098 26894537                	mov	[es:di+37h],ax ; 0
 15021                                  	;mov	[es:di+SF_ENTRY.sf_lstclus+2],ax ; hw of last cluster
 15022                                  	;;;
 15023                                  
 15024                                  	;mov	al,[si+1Fh]
 15025 0000209C 8A441F                  	MOV	AL,[SI+fcb_nsl_dirpos]
 15026                                  	;mov  	[es:di+1Fh],al
 15027 0000209F 2688451F                	MOV	[ES:DI+SF_ENTRY.sf_dirpos],AL
 15028                                  	;INC	word [ES:DI+SF_ENTRY.sf_ref_count]
 15029 000020A3 26FF05                  	inc	word [ES:DI]		; Increment reference count.
 15030                                  					; Existing FCB entries would be
 15031                                  					; flushed unnecessarily because of
 15032                                  					; check in CheckFCB of the ref_count.
 15033                                  					; July 22/85 - BAS
 15034                                  	;;;
 15035                                  	; 21/01/2024 (PCDOS 7.1 IBMDOS.COM)
 15036 000020A6 E82028                  	call	set_sftfcb_entry ; put SFT entry number in the SFTFCB table
 15037                                  				 ; as FCB index number
 15038                                  	;;;
 15039                                  
 15040                                  	;lea	si,[si+1]
 15041 000020A9 8D7401                  	LEA	SI,[SI+SYS_FCB.name]
 15042                                  	;lea	di,[di+20h]
 15043 000020AC 8D7D20                  	LEA	DI,[DI+SF_ENTRY.sf_name]
 15044                                  	;mov	cx,11
 15045 000020AF B90B00                  	MOV	CX,SYS_FCB.EXTENT-SYS_FCB.name ; 12-1
 15046                                  	
 15047                                  	; 26/06/2024
 15048                                  	; MSDOS 6.0
 15049                                  	;call	RegenCopyName	;copy name to SFT
 15050                                  	; 26/06/2024
 15051                                  	; cf = 0 (at the result of the 'test' instruction) 
 15052                                  	
 15053                                  	; MSDOS 3.3
 15054                                  ;RegenCopyName2:
 15055                                  	;lodsb
 15056                                  	;call    UCase
 15057                                  	;stosb
 15058                                  	;loop    RegenCopyName2
 15059                                  
 15060                                  	; 26/06/2024
 15061                                  	; cf = 0
 15062                                  	;clc
 15063                                  	;retn
 15064                                  
 15065                                  ; 26/06/2024
 15066                                  %if 1
 15067                                  
 15068                                  ; --------------------------------------------------------------------------
 15069                                  ;**** RegenCopyName -- This function copies the filename from the FCB to
 15070                                  ; SFT and also to DOS local buffers. There was duplicate code in FCBRegen
 15071                                  ; to copy the name to different destinations
 15072                                  ;
 15073                                  ; Inputs: ds:si = source string
 15074                                  ;	 es:di = destination string
 15075                                  ;	 cx = length of string
 15076                                  ;
 15077                                  ; Outputs: String copied to destination
 15078                                  ;
 15079                                  ; Registers affected: cx,di,si
 15080                                  ; --------------------------------------------------------------------------
 15081                                  
 15082                                  RegenCopyName:
 15083                                  CopyName:
 15084 000020B2 AC                      	lodsb			;load character
 15085 000020B3 E88739                  	call	UCase ; *	; convert char to upper case
 15086                                  StuffChar2:
 15087 000020B6 AA                      	STOSB			;store converted character
 15088 000020B7 E2F9                    	LOOP	CopyName	;
 15089                                  	; 26/06/2024
 15090                                  	; cf= 0 ; *
 15091                                  DoneName:
 15092 000020B9 C3                      	retn
 15093                                  
 15094                                  %endif
 15095                                  
 15096                                  ; 17/05/2019 - Retro DOS v4.0
 15097                                  ; 21/01/2024 - Retro DOS v5.0
 15098                                  
 15099                                  ;**	BlastSFT - FIll SFT with Garbage
 15100                                  ; --------------------------------------------------------------------------
 15101                                  ;	BlastSFT is used when an SFT is no longer needed; it's called with
 15102                                  ;	various garbage values to put into the SFT.  I don't know why,
 15103                                  ;	presumably to help with debugging (jgl).  We clear the few fields
 15104                                  ;	necessary to show that the SFT is free after filling it.
 15105                                  ;
 15106                                  ;	ENTRY	(es:di) = address of SFT
 15107                                  ;		(al) = fill character
 15108                                  ;	EXIT	(ax) = -1
 15109                                  ;		'C' clear
 15110                                  ;	USES	AX, CX, Flags
 15111                                  
 15112                                  BlastSFT:
 15113                                  	; 21/01/2024 (PCDOS 7.1 IBMDOS.COM)
 15114                                  	;;;
 15115 000020BA E8DF28                  	call	SFT_FREE
 15116                                  	;;;
 15117 000020BD 57                      	push	di
 15118                                  	;mov	cx,53 ; MSDOS 3.3
 15119                                  	;mov	cx,59 ; MSDOS 6.0
 15120 000020BE B93B00                  	mov	cx,SF_ENTRY.size
 15121 000020C1 F3AA                    	rep	stosb
 15122 000020C3 5F                      	pop	di
 15123 000020C4 29C0                    	sub	ax,ax	; 0		; clear 'C'-----------------;
 15124 000020C6 268905                  	mov	[es:di],ax
 15125                                  	;mov	[es:di+SF_ENTRY.sf_ref_count],ax ; set ref count    ;
 15126                                  	;mov	[es:di+15h],ax
 15127 000020C9 26894515                	mov	[es:di+sf_LRU],ax	; set lru		    ;
 15128 000020CD 48                      	dec	ax	; -1					    ;
 15129                                  	;mov	[es:di+17h],ax ; 0FFFFh ; -1
 15130 000020CE 26894517                	mov	[es:di+sf_OpenAge],ax	; set open age to -1	    ;
 15131                                  BlastSFT_retn:
 15132 000020D2 C3                      	retn				; return with 'C' clear     ;
 15133                                  
 15134                                  ;Break	<CheckFCB - see if the SFT pointed to by the FCB is still OK>
 15135                                  ; --------------------------------------------------------------------------
 15136                                  ;
 15137                                  ;   CheckFCB - examine an FCB and its contents to see if it needs to be
 15138                                  ;   regenerated.
 15139                                  ;
 15140                                  ;   Inputs:	DS:SI point to FCB (not extended)
 15141                                  ;		AL is SFT index
 15142                                  ;   Outputs:	Carry Set - FCB needs to be regened
 15143                                  ;		Carry clear - FCB is OK. ES:DI point to SFT
 15144                                  ;   Registers modified: AX and BX
 15145                                  ;
 15146                                  ; --------------------------------------------------------------------------
 15147                                  
 15148                                  	; 09/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 15149                                  	; DOSCODE:59F0h (MSDOS 5.0, MSDOS.SYS)
 15150                                  
 15151                                  	; 21/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 15152                                  	; DOSCODE:607Eh (PCDOS 7.1 IBMDOS.COM)
 15153                                  CheckFCB:
 15154                                  		
 15155                                  	; called from $fcb_open and sftfromfcb. SS already set up to DOSDATA
 15156                                  
 15157                                  	; MSDOS 3.3
 15158                                  
 15159                                  	; LES	DI,[CS:SFTFCB]
 15160                                  
 15161                                  	; MSDOS 6.0
 15162                                  	
 15163                                  	; SR;
 15164                                  	; We check if the given FCB is for a local file. If so, we return a 
 15165                                  	; bad SFT status forcing the caller to regenerate the SFT.
 15166                                  
 15167                                  	;test	byte [si+19h],0C0h
 15168 000020D3 F64419C0                	test	byte [si+fcb_l_drive],FCBNETWORK|FCBSHARE|FCBDEVICE
 15169 000020D7 7464                    	jz	short BadSFT		;Local file, return bad SFT
 15170 000020D9 36C43E[4000]            	LES     DI,[SS:SFTFCB]		; SS override
 15171                                  
 15172                                  	; MSDOS 6.0 (& MSDOS 3.3)
 15173                                  	;cmp	[es:di+4],al
 15174 000020DE 26384504                	CMP	[ES:DI+SFT.SFCount],AL
 15175 000020E2 7259                    	JC	short BadSFT
 15176                                  	;;mov	bl,53 ; MSDOS 3.3
 15177                                  	;mov	bl,59 ; MSDOS 6.0
 15178 000020E4 B33B                    	MOV	BL,SF_ENTRY.size
 15179 000020E6 F6E3                    	MUL	BL
 15180                                  	;lea	di,[di+6]
 15181 000020E8 8D7D06                  	LEA	DI,[DI+SFT.SFTable]
 15182 000020EB 01C7                    	ADD	DI,AX
 15183                                  	;MOV	AX,[CS:PROC_ID]	; MSDOS 3.3
 15184 000020ED 36A1[3C03]              	mov	ax,[SS:PROC_ID] ; MSDOS 6.0  ; SS override
 15185                                  	;cmp	[es:di+31h],ax
 15186 000020F1 26394531                	CMP	[ES:DI+SF_ENTRY.sf_PID],AX
 15187 000020F5 7546                    	JNZ	short BadSFT		; must match process
 15188 000020F7 26833D00                	cmp	word [es:di],0
 15189                                  	;CMP	word [ES:DI+SF_ENTRY.sf_ref_count],0
 15190 000020FB 7440                    	JZ	short BadSFT		; must also be in use
 15191                                  	;mov	al,[si+19h]
 15192 000020FD 8A4419                  	MOV	AL,[SI+fcb_l_drive]
 15193                                  	;test	al,80h
 15194 00002100 A880                    	test	AL,FCBSPECIAL		; a special FCB?
 15195 00002102 7427                    	JZ	short CheckNoShare	; No. try local or device
 15196                                  
 15197                                  	; Since we are a special FCB, try NOT to use a bogus test instruction.
 15198                                  	; FCBSHARE is a superset of FCBNETWORK.
 15199                                  
 15200 00002104 50                      	PUSH	AX
 15201                                  	;and	al,0C0h
 15202 00002105 24C0                    	AND	AL,FCBMASK
 15203                                  	;cmp	al,0C0h
 15204 00002107 3CC0                    	CMP	AL,FCBSHARE		; net FCB?
 15205 00002109 58                      	POP	AX
 15206 0000210A 7515                    	JNZ	short CheckNet		; no
 15207                                  					; yes
 15208                                  ;
 15209                                  ;----- In share support -----
 15210                                  ;
 15211                                  	;call	far [cs:JShare+(11*4)]
 15212 0000210C 36FF1E[BC00]            	Call    far [ss:JShare+(11*4)] ; 11 = ShChk ; SS Override
 15213 00002111 722A                    	JC	short BadSFT
 15214                                  
 15215                                  ; 21/01/2024
 15216                                  %if 0
 15217                                  	JMP	SHORT CheckD
 15218                                  ;
 15219                                  ;----- End in share support -----
 15220                                  ;
 15221                                  	; 09/11/2022
 15222                                  	; (There is not any procedure/sub
 15223                                  	;  which calls or jumps to CheckFirClus here)
 15224                                  	;;;
 15225                                  CheckFirClus:
 15226                                  	;cmp     bx,[es:di+0Bh]
 15227                                  	; 07/12/2022
 15228                                  	CMP	BX,[ES:DI+SF_ENTRY.sf_firclus]
 15229                                  	JNZ	short BadSFT
 15230                                  	;;;
 15231                                  %endif
 15232                                  
 15233                                  CheckD:
 15234 00002113 243F                    	AND	AL,3Fh
 15235                                  	;mov	ah,[es:di+5]
 15236 00002115 268A6505                	MOV	AH,[ES:DI+SF_ENTRY.sf_flags]
 15237 00002119 80E43F                  	AND	AH,3Fh
 15238 0000211C 38C4                    	CMP	AH,AL
 15239                                  	; 26/06/2024
 15240                                  	; 16/12/2022
 15241                                  	;jz	short BlastSFT_retn	; carry is clear
 15242                                  	; 09/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 15243 0000211E 751D                    	jnz	short BadSFT
 15244                                  CheckD_retn:
 15245 00002120 C3                      	retn
 15246                                  
 15247                                  ; 26/06/2024
 15248                                  ;BadSFT: 
 15249                                  ;	STC
 15250                                  ;	retn
 15251                                  				
 15252                                  CheckNet:
 15253                                  	; 17/05/2019 - Retro DOS v4.0
 15254                                  	
 15255                                  ;----- In net support -----
 15256                                  
 15257                                  	; MSDOS 3.3
 15258                                  	;;mov	ax,[si+1Ah]
 15259                                  	;mov	ax,[si+fcb_net_handle]
 15260                                  	;;cmp	ax,[es:di+1Dh]
 15261                                  	;cmp	ax,[ES:DI+SF_ENTRY.sf_dirsec]
 15262                                  	;jnz	short BadSFT
 15263                                  	;;cmp	ax,[es:di+19h]
 15264                                  	;cmp	ax,[ES:DI+sf_netid]
 15265                                  	;jnz     short BadSFT
 15266                                  	;;mov	ax,[si+1Eh]
 15267                                  	;mov	ax,[si+fcb_l_attr]
 15268                                  	;;cmp	ax,[es:di+1Bh]
 15269                                  	;cmp	ax,[es:di+SF_ENTRY.sf_lstclus]
 15270                                  	;jnz     short BadSFT
 15271                                  
 15272                                  	; MSDOS 6.0
 15273                                  	;mov	ax,[si+1Ch]
 15274 00002121 8B441C                  	MOV	AX,[SI+fcb_netID]	;AN000;IFS.DOS 4.00
 15275                                  	; 09/11/2022
 15276                                  	;cmp	ax,[es:di+0Bh] 
 15277 00002124 263B450B                	CMP	AX,[ES:DI+sf_serial_ID]	;AN000;IFS.DOS 4.00
 15278 00002128 7513                    	JNZ	short BadSFT
 15279                                  
 15280                                  ;----- END In net support -----
 15281                                  
 15282                                  CheckNet_retn:
 15283 0000212A C3                      	retn
 15284                                  
 15285                                  CheckNoShare:
 15286                                  
 15287                                  ; 16/12/2022
 15288                                  ;	; 09/11/2022 (following test instruction is nonsense!)
 15289                                  ;	; (I am leaving it here for MSDOS 5.0 MSDOS.SYS compatibility)
 15290                                  ;	;test	al,40h
 15291                                  ;	test	AL,FCBDEVICE		; Device?
 15292                                  ;	;jnz	short $+2 ; 09/11/2022
 15293                                  ;	JNZ	short CheckNoShareDev 	; Yes
 15294                                  
 15295                                  	; MSDOS 3.3 - IBMDOS.COM - Offset 27EFh
 15296                                  	;;mov	bx,[si+1Dh]
 15297                                  	;MOV	BX,[SI+fcb_nsl_dirsec]
 15298                                  	;;cmp	bx,[es:di+1Dh]
 15299                                  	;cmp	bx,[ES:DI+SF_ENTRY.sf_dirsec]
 15300                                  	;jnz	short BadSFT
 15301                                  	;;mov	bl,[si+1Fh]
 15302                                  	;MOV	bl,[SI+fcb_nsl_dirpos]
 15303                                  	;;cmp	bl,[es:di+1Fh]
 15304                                  	;cmp	bl,[ES:DI+SF_ENTRY.sf_dirpos]
 15305                                  	;jnz	short BadSFT
 15306                                  	;;mov	bl,[si+1Ah]
 15307                                  	;MOV	bl,[SI+fcb_nsl_bits]
 15308                                  	;;mov	bh,[es:di+5]
 15309                                  	;MOV	bh,[ES:DI+SF_ENTRY.sf_flags]
 15310                                  	;xor	bh,bl
 15311                                  	;and	bh,0C0h
 15312                                  	;jnz	short BadSFT
 15313                                  	;;xor	bl,[es:di+2]
 15314                                  	;xor	bl,[ES:DI+SF_ENTRY.sf_mode]
 15315                                  	;and	bl,0Fh
 15316                                  	;jnz	short BadSFT
 15317                                  	;push	di
 15318                                  	;push	si
 15319                                  	;;lea	di,[di+20h]  ; MSDOS 3.3
 15320                                  	;LEA	DI,[DI+SF_ENTRY.sf_name]
 15321                                  	;;lea	si,[si+1]
 15322                                  	;LEA	SI,[SI+SYS_FCB.name]
 15323                                  	;;mov	cx,11
 15324                                  	;MOV	CX,SYS_FCB.EXTENT-SYS_FCB.name ; 12-1
 15325                                  	;repe	cmpsb
 15326                                  	;pop	si
 15327                                  	;pop	di
 15328                                  	;jnz	short BadSFT
 15329                                  	;;mov	bx,[si+1Bh]
 15330                                  	;MOV	bX,[SI+fcb_nsl_firclus]
 15331                                  	;jmp	short CheckFirClus
 15332                                  
 15333                                  	; MSDOS 6.0
 15334                                  
 15335                                  	; SR;
 15336                                  	; The code below to match a local FCB with its SFT can no longer be
 15337                                  	; used. We just return a no-match status. This check is done right
 15338                                  	; at the top.
 15339                                  
 15340                                  CheckNoShareDev:
 15341                                  	;mov	bx,[si+1Ah]
 15342 0000212B 8B5C1A                  	MOV	BX,[SI+fcb_nsld_drvptr]
 15343                                  	;cmp	bx,[es:di+7]
 15344 0000212E 263B5D07                	CMP	BX,[ES:DI+SF_ENTRY.sf_devptr]
 15345 00002132 7509                    	JNZ	short BadSFT
 15346                                  	;mov	bx,[si+1Ch]
 15347 00002134 8B5C1C                  	MOV	BX,[SI+fcb_nsld_drvptr+2]
 15348                                  	;cmp	bx,[es:di+9]
 15349 00002137 263B5D09                	CMP	BX,[ES:DI+SF_ENTRY.sf_devptr+2]
 15350                                  	;JNZ	short BadSFT
 15351                                  	;JMP	short CheckD
 15352                                  	; 26/06/2024
 15353 0000213B 74D6                    	jz	short CheckD
 15354                                  
 15355                                  ; 26/06/2024
 15356                                  BadSFT: 
 15357 0000213D F9                      	STC
 15358 0000213E C3                      	retn
 15359                                  
 15360                                  ;Break	<SFTFromFCB - take a FCB and obtain a SFT from it>
 15361                                  ;----------------------------------------------------------------------------
 15362                                  ;
 15363                                  ;   SFTFromFCB - the workhorse of this compatability crap. Check to see if
 15364                                  ;	the SFT for the FCB is Good. If so, make ThisSFT point to it. If not
 15365                                  ;	good, get one from the cache and regenerate it. Overlay the LRU field
 15366                                  ;	with PID
 15367                                  ;
 15368                                  ;   Inputs:	DS:SI point to FCB
 15369                                  ;   Outputs:	ThisSFT point to appropriate SFT
 15370                                  ;		Carry clear -> OK ES:DI -> SFT
 15371                                  ;		Carry set -> error in ax
 15372                                  ;   Registers modified: ES,DI, AX
 15373                                  ;
 15374                                  ;----------------------------------------------------------------------------
 15375                                  
 15376                                  SFTFromFCB:
 15377                                  	; called from fcbio and $fcb_close. SS already set up to DOSDATA
 15378                                  
 15379                                  	; 17/05/2019 - Retro DOS v4.0
 15380                                  
 15381 0000213F 50                      	push	ax
 15382 00002140 53                      	push	bx
 15383                                  	;mov	al,[si+18h]
 15384 00002141 8A4418                  	MOV	AL,[SI+fcb_sfn] 	; set SFN for check
 15385 00002144 E88CFF                  	call	CheckFCB
 15386 00002147 5B                      	pop	bx
 15387 00002148 58                      	pop	ax
 15388                                  	;MOV	[CS:THISSFT],DI		; SS override
 15389                                  	;MOV	[CS:THISSFT+2],ES
 15390 00002149 36893E[9E05]            	MOV	[SS:THISSFT],DI		; SS override
 15391 0000214E 368C06[A005]            	MOV	[SS:THISSFT+2],ES
 15392 00002153 7311                    	JNC	short Set_SFT		; no problems, just set thissft
 15393                                  	
 15394                                  	; 09/11/2022 (MSDOS 5.0)
 15395                                  	; 31/05/2019
 15396 00002155 06                      	push	es ; * (MSDOS 6.21) & (MSDOS 5.0)
 15397 00002156 E8FFE2                  	call	save_world
 15398 00002159 E860FE                  	call	FCBRegen
 15399 0000215C E8E2E2                  	call	restore_world		; use macro restore world
 15400 0000215F 07                      	pop	es ; * (MSDOS 6.21) ; 31/05/2019 ; 09/11/2022 (MSDOS 5.0)	
 15401                                  
 15402                                  	;MOV	AX,[CS:EXTERR]		; SS override
 15403 00002160 36A1[2403]              	MOV	AX,[SS:EXTERR]		; SS override
 15404 00002164 72C4                    	jc	short CheckNet_retn
 15405                                  
 15406                                  Set_SFT: 
 15407                                  	;LES	DI,[CS:THISSFT]		; SS override for THISSFT & PROC_ID
 15408 00002166 36C43E[9E05]            	les	di,[ss:THISSFT]
 15409                                  	;PUSH	word [CS:PROC_ID]	; set process id
 15410 0000216B 36FF36[3C03]            	push	word [ss:PROC_ID]
 15411                                  	;pop	word [es:di+31h]
 15412 00002170 268F4531                	POP     word [ES:DI+SF_ENTRY.sf_PID]
 15413 00002174 C3                      	retn				; carry is clear
 15414                                  
 15415                                  ;Break	<FCBHardErr - generate INT 24 for hard errors on FCBS>
 15416                                  ;----------------------------------------------------------------------------
 15417                                  ;
 15418                                  ;   FCBHardErr - signal to a user app that he is trying to use an
 15419                                  ;	unavailable FCB.
 15420                                  ;
 15421                                  ;   Inputs:	none.
 15422                                  ;   Outputs:	none.
 15423                                  ;   Registers modified: all
 15424                                  ;
 15425                                  ;----------------------------------------------------------------------------
 15426                                  
 15427                                  	; 21/01/2024 - Retro DOS v5.0
 15428                                  FCBHardErr:
 15429                                  	; 17/05/2019 - Retro DOS v4.0
 15430 00002175 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 15431                                  	;
 15432                                  	;mov	ax,23h
 15433 0000217A B82300                  	MOV	AX,error_FCB_unavailable
 15434                                  	;;mov	byte [cs:ALLOWED],8
 15435                                  	;MOV	byte [CS:ALLOWED],Allowed_FAIL
 15436 0000217D 26C606[4B03]08          	mov	byte [es:ALLOWED],Allowed_FAIL	
 15437                                  	
 15438                                  	;LES	BP,[CS:THISDPB]
 15439 00002183 26C42E[8A05]            	les	bp,[es:THISDPB]
 15440                                  	
 15441 00002188 BF0100                  	MOV	DI,1			; Fake some registers
 15442 0000218B 89F9                    	MOV	CX,DI
 15443                                  	;;;
 15444                                  	; 21/01/2024 (PCDOS 7.1 IBMDOS.COM) 
 15445 0000218D 31D2                    	xor	dx,dx ; 0
 15446                                  	;cmp	[es:bp+0Fh],dx
 15447 0000218F 2639560F                	cmp	[es:bp+DPB.FAT_SIZE],dx ; 0
 15448 00002193 740B                    	jz	short fcbharderr_fat32 ; FAT32
 15449 00002195 268916[0706]            	mov	[es:HIGH_SECTOR],dx ; 0
 15450                                  	;mov	dx,[es:bp+0Bh]
 15451 0000219A 268B560B                	mov	dx,[es:bp+DPB.FIRST_SECTOR]
 15452 0000219E EB0D                    	jmp	short fcbharderr_fat
 15453                                  fcbharderr_fat32:
 15454                                  	;mov	dx,[es:bp+2Bh]
 15455 000021A0 268B562B                	mov	dx,[es:bp+DPB.FCLUS_FSECTOR+2]
 15456 000021A4 268916[0706]            	mov	[es:HIGH_SECTOR],dx
 15457                                  	;mov	dx,[es:bp+29h]
 15458 000021A9 268B5629                	mov	dx,[es:bp+DPB.FCLUS_FSECTOR]
 15459                                  fcbharderr_fat: 
 15460                                  	;;;
 15461                                  	; 21/01/2024
 15462                                  	;;mov	dx,[es:bp+0Bh]
 15463                                  	;MOV	DX,[ES:BP+DPB.FIRST_SECTOR]
 15464                                  	
 15465 000021AD E84A3B                  	call	HARDERR
 15466 000021B0 F9                      	STC
 15467 000021B1 C3                      	retn
 15468                                  
 15469                                  ;============================================================================
 15470                                  ; FCBIO2.ASM, MSDOS 6.0, 1991
 15471                                  ;============================================================================
 15472                                  ; 21/07/2018 - Retro DOS v3.0
 15473                                  ; 17/05/2019 - Retro DOS v4.0
 15474                                  
 15475                                  ;**	FCBIO2.ASM - Ancient 1.0 1.1 FCB system calls
 15476                                  ;
 15477                                  ;	GetRR
 15478                                  ;	GetExtent
 15479                                  ;	SetExtent
 15480                                  ;	GetExtended
 15481                                  ;	GetRecSize
 15482                                  ;	FCBIO
 15483                                  ;	$FCB_OPEN
 15484                                  ;	$FCB_CREATE
 15485                                  ;	$FCB_RANDOM_WRITE_BLOCK
 15486                                  ;	$FCB_RANDOM_READ_BLOCK
 15487                                  ;	$FCB_SEQ_READ
 15488                                  ;	$FCB_SEQ_WRITE
 15489                                  ;	$FCB_RANDOM_READ
 15490                                  ;	$FCB_RANDOM_WRITE
 15491                                  ;
 15492                                  ;	Revision history:
 15493                                  ;
 15494                                  ;		Created: ARR 4 April 1983
 15495                                  ;			 MZ  6 June  1983 completion of functions
 15496                                  ;			 MZ 15 Dec   1983 Brain damaged programs close FCBs multiple
 15497                                  ;				  times.  Change so successive closes work by
 15498                                  ;				  always returning OK.	Also, detect I/O to
 15499                                  ;				  already closed FCB and return EOF.
 15500                                  ;		 MZ 16 Jan   1984 More braindamage.  Need to separate info
 15501                                  ;				  out of sft into FCB for reconnection
 15502                                  ;
 15503                                  ;	    A000   version 4.00	Jan. 1988
 15504                                  
 15505                                  ; Defintions for FCBOp flags
 15506                                  
 15507                                  RANDOM	equ 2				; random operation
 15508                                  FCBREAD equ 4				; doing a read
 15509                                  BLOCK	equ 8				; doing a block I/O
 15510                                  
 15511                                  ;Break <GetRR - return the random record field in DX:AX>
 15512                                  ;---------------------------------------------------------------------------
 15513                                  ;
 15514                                  ;   GetRR - correctly load DX:AX with the random record field (3 or 4 bytes)
 15515                                  ;	from the FCB pointed to by DS:SI
 15516                                  ;
 15517                                  ;   Inputs:	DS:SI point to an FCB
 15518                                  ;		BX has record size
 15519                                  ;   Outputs:	DX:AX contain the contents of the random record field
 15520                                  ;   Registers modified: none
 15521                                  ;---------------------------------------------------------------------------
 15522                                  
 15523                                  GetRR:
 15524                                  	;mov	ax,[si+21h]
 15525 000021B2 8B4421                  	MOV	AX,[SI+SYS_FCB.RR]	; get low order part
 15526                                  	;mov	dx,[si+23h]
 15527 000021B5 8B5423                  	MOV	DX,[SI+SYS_FCB.RR+2]	; get high order part
 15528 000021B8 83FB40                  	CMP	BX,64			; ignore MSB of RR if recsiz > 64
 15529 000021BB 7202                    	JB	short GetRRBye
 15530                                  GetExtent_bye:	; 21/01/2024
 15531 000021BD 30F6                    	XOR	DH,DH
 15532                                  GetRRBye:
 15533 000021BF C3                      	retn
 15534                                  
 15535                                  ;Break <GetExtent - retrieve next location for sequential IO>
 15536                                  ;---------------------------------------------------------------------------
 15537                                  ;
 15538                                  ;   GetExtent - Construct the next record to perform I/O from the EXTENT and
 15539                                  ;	NR fields in the FCB.
 15540                                  ;
 15541                                  ;   Inputs:	DS:SI - point to FCB
 15542                                  ;   Outputs:	DX:AX contain the contents of the random record field
 15543                                  ;   Registers modified: none
 15544                                  ;---------------------------------------------------------------------------
 15545                                  
 15546                                  GetExtent:
 15547                                  	;mov	al,[si+20h]
 15548 000021C0 8A4420                  	MOV	AL,[SI+SYS_FCB.NR]	; get low order piece
 15549                                  	;mov	dx,[si+0Ch]
 15550 000021C3 8B540C                  	MOV	DX,[SI+SYS_FCB.EXTENT]	; get high order piece
 15551 000021C6 D0E0                    	SHL	AL,1
 15552 000021C8 D1EA                    	SHR	DX,1
 15553 000021CA D0D8                    	RCR	AL,1	; move low order bit of DL to high order of AH
 15554 000021CC 88D4                    	MOV	AH,DL
 15555 000021CE 88F2                    	MOV	DL,DH
 15556                                  	; 21/01/2024 (PCDOS 7.1 IBMDOS.COM)
 15557                                  	;XOR	DH,DH
 15558                                  	;retn
 15559 000021D0 EBEB                    	jmp	short GetExtent_bye
 15560                                  
 15561                                  ;Break <SetExtent - update the extent/NR field>
 15562                                  ;---------------------------------------------------------------------------
 15563                                  ;
 15564                                  ;   SetExtent - change the position of an FCB by filling in the extent/NR
 15565                                  ;	fields
 15566                                  ;
 15567                                  ;   Inputs:	DS:SI point to FCB
 15568                                  ;		DX:AX is a record location in file
 15569                                  ;   Outputs:	Extent/NR fields are filled in
 15570                                  ;   Registers modified: CX
 15571                                  ;---------------------------------------------------------------------------
 15572                                  
 15573                                  SetExtent:
 15574 000021D2 50                      	push	ax
 15575 000021D3 52                      	push	dx
 15576 000021D4 89C1                    	MOV	CX,AX
 15577 000021D6 247F                    	AND	AL,7FH			; next rec field
 15578                                  	;mov	[si+20h],al
 15579 000021D8 884420                  	MOV	[SI+SYS_FCB.NR],AL
 15580 000021DB 80E180                  	AND	CL,80H			; save upper bit
 15581 000021DE D1E1                    	SHL	CX,1
 15582 000021E0 D1D2                    	RCL	DX,1			; move high bit of CX to low bit of DX
 15583 000021E2 88E8                    	MOV	AL,CH
 15584 000021E4 88D4                    	MOV	AH,DL
 15585                                  	;mov	[si+0Ch], ax
 15586 000021E6 89440C                  	MOV	[SI+SYS_FCB.EXTENT],AX	; all done
 15587 000021E9 5A                      	pop	dx
 15588 000021EA 58                      	pop	ax
 15589 000021EB C3                      	retn
 15590                                  
 15591                                  ;Break <GetExtended - find FCB in potential extended fcb>
 15592                                  ;---------------------------------------------------------------------------
 15593                                  ;
 15594                                  ;   GetExtended - Make DS:SI point to FCB from DS:DX
 15595                                  ;
 15596                                  ;   Inputs:	DS:DX point to a possible extended FCB
 15597                                  ;   Outputs:	DS:SI point to the FCB part
 15598                                  ;		zeroflag set if not extended fcb
 15599                                  ;   Registers modified: SI
 15600                                  ;---------------------------------------------------------------------------
 15601                                  
 15602                                  GetExtended:
 15603 000021EC 89D6                    	MOV	SI,DX			; point to Something
 15604 000021EE 803CFF                  	CMP	BYTE [SI],-1		; look for extention
 15605 000021F1 7503                    	JNZ	short GetBye		; not there
 15606 000021F3 83C607                  	ADD	SI,7			; point to FCB
 15607                                  GetBye:
 15608 000021F6 39D6                    	CMP	SI,DX			; set condition codes
 15609                                  getextd_retn:
 15610 000021F8 C3                      	retn
 15611                                  
 15612                                  ;Break <GetRecSize - return in BX the FCB record size>
 15613                                  ;---------------------------------------------------------------------------
 15614                                  ;
 15615                                  ;   GetRecSize - return in BX the record size from the FCB at DS:SI
 15616                                  ;
 15617                                  ;   Inputs:	DS:SI point to a non-extended FCB
 15618                                  ;   Outputs:	BX contains the record size
 15619                                  ;   Registers modified: None
 15620                                  ;---------------------------------------------------------------------------
 15621                                  
 15622                                  	; 22/01/2024
 15623                                  	; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 15624                                  GetRecSize:
 15625                                  	;mov	bx,[si+0Eh]
 15626 000021F9 8B5C0E                  	MOV	BX,[SI+SYS_FCB.RECSIZ]	; get his record size
 15627 000021FC 09DB                    	OR	BX,BX			; is it nul?
 15628                                  	;jz	short getextd_retn
 15629                                  	; 22/01/2024 (BugFix)
 15630 000021FE 75F8                    	jnz	short getextd_retn
 15631                                  	;MOV	BX,128			; use default size
 15632 00002200 B380                    	mov	bl,128	; (PCDOS 7.1 IBMDOS.COM)
 15633                                  	;mov	[si+0Eh],bx
 15634 00002202 895C0E                  	MOV	[SI+SYS_FCB.RECSIZ],BX	; stuff it back
 15635 00002205 C3                      	retn
 15636                                  
 15637                                  ; 23/01/2024 - Retro DOS v5.0
 15638                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:61B3h
 15639                                  
 15640                                  ; 22/07/2018 - Retro DOS v3.0
 15641                                  
 15642                                  ;BREAK <$FCB_Random_write_Block - write a block of records to a file >
 15643                                  ;----------------------------------------------------------------------------
 15644                                  ;
 15645                                  ;   $FCB_Random_Write_Block - retrieve a location from the FCB, seek to it
 15646                                  ;	and write a number of blocks from it.
 15647                                  ;
 15648                                  ;   Inputs:	DS:DX point to an FCB
 15649                                  ;   Outputs:	AL = 0 write was successful and the FCB position is updated
 15650                                  ;		AL <> 0 Not enough room on disk for the output
 15651                                  ;
 15652                                  ;----------------------------------------------------------------------------
 15653                                  
 15654                                  _$FCB_RANDOM_WRITE_BLOCK:
 15655                                  	;mov	AL,0Ah	
 15656 00002206 B00A                    	MOV	AL,RANDOM+BLOCK
 15657 00002208 EB12                    	JMP	short FCBIO	; 23/01/2024
 15658                                  
 15659                                  ;BREAK <$FCB_Random_Read_Block - read a block of records to a file >
 15660                                  ;----------------------------------------------------------------------------
 15661                                  ;
 15662                                  ;   $FCB_Random_Read_Block - retrieve a location from the FCB, seek to it
 15663                                  ;	and read a number of blocks from it.
 15664                                  ;
 15665                                  ;   Inputs:	DS:DX point to an FCB
 15666                                  ;   Outputs:	AL = error codes defined above
 15667                                  ;
 15668                                  ;----------------------------------------------------------------------------
 15669                                  
 15670                                  _$FCB_RANDOM_READ_BLOCK:
 15671                                  	;mov	AL,0Eh	
 15672 0000220A B00E                    	MOV	AL,RANDOM+FCBREAD+BLOCK
 15673 0000220C EB0E                    	JMP	short FCBIO	; 23/01/2024
 15674                                  
 15675                                  ;BREAK <$FCB_Seq_Read - read the next record from a file >
 15676                                  ;----------------------------------------------------------------------------
 15677                                  ;
 15678                                  ;   $FCB_Seq_Read - retrieve the next record from an FCB and read it into
 15679                                  ;	memory
 15680                                  ;
 15681                                  ;   Inputs:	DS:DX point to an FCB
 15682                                  ;   Outputs:	AL = error codes defined above
 15683                                  ;
 15684                                  ;----------------------------------------------------------------------------
 15685                                  
 15686                                  _$FCB_SEQ_READ:
 15687                                  	;mov	AL,4	
 15688 0000220E B004                    	MOV	AL,FCBREAD
 15689 00002210 EB0A                    	JMP	short FCBIO	; 23/01/2024
 15690                                  
 15691                                  ;BREAK <$FCB_Seq_Write - write the next record to a file >
 15692                                  ;----------------------------------------------------------------------------
 15693                                  ;
 15694                                  ;   $FCB_Seq_Write - retrieve the next record from an FCB and write it to the
 15695                                  ;	file
 15696                                  ;
 15697                                  ;   Inputs:	DS:DX point to an FCB
 15698                                  ;   Outputs:	AL = error codes defined above
 15699                                  ;
 15700                                  ;----------------------------------------------------------------------------
 15701                                  
 15702                                  _$FCB_SEQ_WRITE:
 15703 00002212 B000                    	MOV	AL,0
 15704 00002214 EB06                    	JMP	short FCBIO	; 23/01/2024
 15705                                  
 15706                                  ;BREAK <$FCB_Random_Read - Read a single record from a file >
 15707                                  ;----------------------------------------------------------------------------
 15708                                  ;
 15709                                  ;   $FCB_Random_Read - retrieve a location from the FCB, seek to it and read a
 15710                                  ;	record from it.
 15711                                  ;
 15712                                  ;   Inputs:	DS:DX point to an FCB
 15713                                  ;   Outputs:	AL = error codes defined above
 15714                                  ;
 15715                                  ;----------------------------------------------------------------------------
 15716                                  
 15717                                  _$FCB_RANDOM_READ:
 15718                                  	;mov	AL,6	
 15719 00002216 B006                    	MOV	AL,RANDOM+FCBREAD
 15720                                  	; 23/01/2024
 15721                                  	;jmp	FCBIO 		; single block
 15722 00002218 EB02                    	jmp	short FCBIO
 15723                                  
 15724                                  ;BREAK <$FCB_Random_Write - write a single record to a file >
 15725                                  ;----------------------------------------------------------------------------
 15726                                  ;
 15727                                  ;   $FCB_Random_Write - retrieve a location from the FCB, seek to it and write
 15728                                  ;	a record to it.
 15729                                  ;
 15730                                  ;   Inputs:	DS:DX point to an FCB
 15731                                  ;   Outputs:	AL = error codes defined above
 15732                                  ;
 15733                                  ;----------------------------------------------------------------------------
 15734                                  
 15735                                  _$FCB_RANDOM_WRITE:
 15736                                  	;mov	AL,2	
 15737 0000221A B002                    	MOV	AL,RANDOM
 15738                                  	; 23/01/2024
 15739                                  	;;jmp	FCBIO
 15740                                  	;jmp	short FCBIO
 15741                                  
 15742                                  ;BREAK <FCBIO - do internal FCB I/O>
 15743                                  ;---------------------------------------------------------------------------
 15744                                  ;
 15745                                  ;   FCBIO - look at FCBOP and merge all FCB operations into a single routine.
 15746                                  ;
 15747                                  ;   Inputs:	FCBOP flags which operations need to be performed
 15748                                  ;		DS:DX point to FCB
 15749                                  ;		CX may have count of number of records to xfer
 15750                                  ;   Outputs:	AL has error code
 15751                                  ;   Registers modified: all
 15752                                  ;---------------------------------------------------------------------------
 15753                                  
 15754                                  	; 09/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 15755                                  	; DOSCODE:5B17h (MSDOS 5.0 MSDOS.SYS)
 15756                                  
 15757                                  	; 23/01/2024
 15758                                  	; DOSCODE:5B2Bh (MSDOS 6.22 MSDOS.SYS)
 15759                                  
 15760                                  	; 23/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 15761                                  	; DOSCODE:61C9h (PCDOS 7.1 IBMDOS.COM)
 15762                                  
 15763                                  FCBIO:
 15764                                  
 15765                                  FEOF	EQU	1
 15766                                  FTRIM	EQU	2
 15767                                  
 15768                                  %define	FCBErr	byte [bp-1]  ; byte	
 15769                                  %define	cRec	word [bp-3]  ; word	
 15770                                  ;%define RecPos	word [bp-7]  ; dword
 15771                                  %define RecPosL	word [bp-7]  ; word
 15772                                  %define RecPosH	word [bp-5]  ; word
 15773                                  %define	RecSize	word [bp-9]  ; word
 15774                                  ;%define bPos	word [bp-13] ; dword
 15775                                  %define bPosL	word [bp-13] ; word
 15776                                  %define bPosH	word [bp-11] ; word
 15777                                  %define cByte	word [bp-15] ; word	
 15778                                  %define cResult word [bp-17] ; word	
 15779                                  %define	cRecRes	word [bp-19] ; word
 15780                                  %define	FCBOp	byte [bp-20] ; byte
 15781                                  ; 23/01/2024
 15782                                  %define bPos bp-13
 15783                                  
 15784                                  	;Enter
 15785                                  
 15786 0000221C 55                      	push	bp
 15787 0000221D 89E5                    	mov	bp,sp
 15788 0000221F 83EC14                  	sub	sp,20
 15789                                  	;mov	[bp-20],al
 15790 00002222 8846EC                  	MOV	FCBOp,AL
 15791                                  	;mov	byte [bp-1],0
 15792 00002225 C646FF00                	MOV	FCBErr,0		;   FCBErr = 0;
 15793 00002229 E8C0FF                  	call	GetExtended		;   FCB = GetExtended ();
 15794                                  	;test	byte [bp-20],8
 15795 0000222C F646EC08                	TEST	FCBOp,BLOCK		;   if ((OP&BLOCK) == 0)
 15796 00002230 7503                    	JNZ	short GetPos
 15797 00002232 B90100                  	MOV	CX,1			;	cRec = 1;
 15798                                  GetPos:
 15799                                  	;mov	[bp-3],cx
 15800 00002235 894EFD                  	MOV	cRec,CX 		;*Tail coalesce
 15801 00002238 E885FF                  	call	GetExtent		;   RecPos = GetExtent ();
 15802 0000223B E8BBFF                  	call	GetRecSize		;   RecSize = GetRecSize ();
 15803                                  	;mov	[bp-9],bx
 15804 0000223E 895EF7                  	MOV	RecSize,BX
 15805                                  	;test	byte [bp-20],2
 15806 00002241 F646EC02                	TEST	FCBOp,RANDOM		;   if ((OP&RANDOM) <> 0)
 15807 00002245 7403                    	JZ	short GetRec
 15808 00002247 E868FF                  	call	GetRR			;	RecPos = GetRR ();
 15809                                  GetRec:
 15810                                  	;mov	[bp-7],ax
 15811 0000224A 8946F9                  	MOV	RecPosL,AX		;*Tail coalesce
 15812                                  	;mov	[bp-5],dx
 15813 0000224D 8956FB                  	MOV	RecPosH,DX
 15814 00002250 E87FFF                  	call	SetExtent		;   SetExtent (RecPos);
 15815                                  	;mov	ax,[bp-5]
 15816 00002253 8B46FB                  	MOV	AX,RecPosH		;   bPos = RecPos * RecSize;
 15817 00002256 F7E3                    	MUL	BX
 15818 00002258 89C7                    	MOV	DI,AX
 15819                                  	;mov	ax,[bp-7]
 15820 0000225A 8B46F9                  	MOV	AX,RecPosL
 15821 0000225D F7E3                    	MUL	BX
 15822 0000225F 01FA                    	ADD	DX,DI
 15823                                  	;mov	[bp-13],ax
 15824 00002261 8946F3                  	MOV	bPosL,AX
 15825                                  	;mov	[bp-11],dx
 15826 00002264 8956F5                  	MOV	bPosH,DX
 15827                                  	;mov	ax,[bp-3]
 15828 00002267 8B46FD                  	MOV	AX,cRec 		;   cByte = cRec * RecSize;
 15829 0000226A F7E3                    	MUL	BX
 15830                                  	;mov	[bp-15],ax
 15831 0000226C 8946F1                  	MOV	cByte,AX
 15832                                  
 15833                                  ;hkn; 	SS override
 15834 0000226F 360306[2C03]            	ADD	AX,[SS:DMAADD]		;   if (cByte+DMA > 64K) {
 15835 00002274 83D200                  	ADC	DX,0
 15836 00002277 7419                    	JZ	short DoOper
 15837                                  	;mov	byte [bp-1],2
 15838 00002279 C646FF02                	MOV	FCBErr,FTRIM		;	FCBErr = FTRIM;
 15839                                  
 15840                                  ;hkn; 	SS override
 15841 0000227D 36A1[2C03]              	MOV	AX,[SS:DMAADD]		;	cRec = (64K-DMA)/RecSize;
 15842 00002281 F7D8                    	NEG	AX
 15843 00002283 7501                    	JNZ	short DoDiv
 15844 00002285 48                      	DEC	AX
 15845                                  DoDiv:
 15846 00002286 31D2                    	XOR	DX,DX
 15847 00002288 F7F3                    	DIV	BX
 15848                                  	;mov	[bp-3],ax
 15849 0000228A 8946FD                  	MOV	cRec,AX
 15850 0000228D F7E3                    	MUL	BX			;	cByte = cRec * RecSize;
 15851                                  	;mov	[bp-15],ax
 15852 0000228F 8946F1                  	MOV	cByte,AX		;	}
 15853                                  DoOper:
 15854 00002292 31DB                    	XOR	BX,BX
 15855                                  	;mov	[bp-17],bx
 15856 00002294 895EEF                  	MOV	cResult,BX		;   cResult = 0;
 15857                                  	;cmp	[bp-15],bx
 15858 00002297 395EF1                  	CMP	cByte,BX		;   if (cByte <> 0 ||
 15859 0000229A 7506                    	JNZ	short DoGetExt
 15860                                  	;test	byte [bp-1],2
 15861 0000229C F646FF02                	TEST	FCBErr,FTRIM		;	(FCBErr&FTRIM) == 0) {
 15862                                  	;JZ	short DoGetExt
 15863                                  	;JMP	short SkipOp
 15864                                  	; 16/12/2022
 15865 000022A0 756E                    	jnz	short SkipOp
 15866                                  	; 09/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 15867                                  	;JZ	short DoGetExt
 15868                                  	;JMP	short SkipOp
 15869                                  DoGetExt:
 15870 000022A2 E89AFE                  	call	SFTFromFCB		;	if (!SFTFromFCB (SFT,FCB))
 15871 000022A5 730F                    	JNC	short ContinueOp
 15872                                  FCBDeath:
 15873 000022A7 E8E0E3                  	call	FCB_RET_ERR		; signal error, map for extended
 15874                                  	;mov	word [bp-19],0
 15875 000022AA C746ED0000              	MOV	cRecRes,0		; no bytes transferred
 15876                                  	;mov	byte [bp-1],1
 15877 000022AF C646FF01                	MOV	FCBErr,FEOF		;	    return FTRIM;
 15878 000022B3 E9E700                  	JMP	FCBSave 		; bam!
 15879                                  ContinueOp:
 15880                                  	; 23/01/2024
 15881                                  	; (PCDOS 7.1 IBMDOS.COM)
 15882                                  	;
 15883                                  	;;mov	ax,[si+10h]
 15884                                  	;MOV	AX,[SI+SYS_FCB.FILSIZ]
 15885                                  	;;mov	[es:di+11h],ax
 15886                                  	;MOV	[ES:DI+SF_ENTRY.sf_size],AX
 15887                                  	;;mov	ax,[si+12h]
 15888                                  	;MOV	AX,[SI+SYS_FCB.FILSIZ+2]
 15889                                  	;;mov	[es:di+13h],ax
 15890                                  	;MOV	[ES:DI+SF_ENTRY.sf_size+2],AX
 15891                                  	;;;
 15892 000022B6 1E                      	push	ds
 15893 000022B7 C54410                  	lds	ax,[si+SYS_FCB.FILSIZ]
 15894 000022BA 26894511                	mov	[es:di+SF_ENTRY.sf_size],ax
 15895 000022BE 268C5D13                	mov	[es:di+SF_ENTRY.sf_size+2],ds
 15896 000022C2 C546F3                  	lds	ax,[bPos] ; lds ax,[bp-13]
 15897 000022C5 8CDA                    	mov	dx,ds
 15898 000022C7 1F                      	pop	ds
 15899                                  	;;;
 15900                                  	;;mov	ax,[bp-13]
 15901                                  	;MOV	AX,bPosL
 15902                                  	;;mov	dx,[bp-11]
 15903                                  	;MOV	DX,bPosH
 15904                                  	
 15905                                  	;mov	[es:di+15h],ax
 15906 000022C8 26894515                	MOV	[ES:DI+SF_ENTRY.sf_position],AX
 15907                                  	;xchg	dx,[es:di+17h]
 15908 000022CC 26875517                	XCHG	[ES:DI+SF_ENTRY.sf_position+2],DX
 15909 000022D0 52                      	PUSH	DX			; save away Open age.
 15910                                  	;mov	cx,[bp-15]
 15911 000022D1 8B4EF1                  	MOV	CX,cByte		;	cResult =
 15912                                  
 15913                                  ;hkn; DOS_Read is in DOSCODE
 15914 000022D4 BF[483A]                	MOV	DI,DOS_READ		;	    *(OP&FCBRead ? DOS_Read
 15915                                  	;test	byte [bp-20],4
 15916 000022D7 F646EC04                	TEST	FCBOp,FCBREAD		;		 : DOS_Write)(cRec);
 15917 000022DB 7503                    	JNZ	short DoContext
 15918                                  
 15919                                  ;hkn; DOS_Write is in DOSCODE
 15920 000022DD BF[493C]                	MOV	DI,DOS_WRITE
 15921                                  DoContext:
 15922 000022E0 55                      	push	bp
 15923 000022E1 1E                      	push	ds
 15924 000022E2 56                      	push	si
 15925                                  
 15926                                  ;hkn; SS is DOSDATA
 15927 000022E3 16                      	push	ss
 15928 000022E4 1F                      	pop	ds
 15929                                  
 15930                                  ;; Fix for disk full
 15931 000022E5 FFD7                    	CALL	DI	; DOS_READ or DOS_WRITE	
 15932                                  	
 15933 000022E7 5E                      	pop	si
 15934 000022E8 1F                      	pop	ds
 15935 000022E9 5D                      	pop	bp
 15936 000022EA 72BB                    	JC	short FCBDeath
 15937                                  	
 15938 000022EC 36803E[0B06]00          	CMP	BYTE [SS:DISK_FULL],0	; treat disk full as error
 15939 000022F2 7406                    	JZ	short NODSKFULL
 15940 000022F4 36C606[0B06]00          	MOV	BYTE [SS:DISK_FULL],0	; clear the flag
 15941                                  
 15942                                  	; 23/01/2024
 15943                                  	; (PCDOS 7.1 IBMDOS.COM)
 15944                                  	;;mov	byte [bp-1],1 
 15945                                  	;MOV	FCBErr,FEOF		; set disk full flag
 15946                                  
 15947                                  NODSKFULL:
 15948                                  ;; Fix for disk full
 15949                                  	;mov	[bp-17],cx
 15950 000022FA 894EEF                  	MOV	cResult,CX
 15951 000022FD E80AFB                  	call	SaveFCBInfo		;	SaveFCBInfo (FCB);
 15952                                  	;pop	word [es:di+17h]	
 15953 00002300 268F4517                	POP	WORD [ES:DI+SF_ENTRY.sf_position+2] ; restore open age
 15954                                  			       ; (sf_OpenAge = SF_ENTRY.sf_position+2)
 15955                                  
 15956                                  	; 23/01/2024
 15957                                  	; (PCDOS 7.1 IBMDOS.COM)
 15958                                  	;
 15959                                  	;;mov	ax,[es:di+11h]
 15960                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_size]
 15961                                  	;;mov	[si+10h],ax
 15962                                  	;MOV	[SI+SYS_FCB.FILSIZ],AX
 15963                                  	;;mov	ax,[es:di+13h]
 15964                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_size+2]
 15965                                  	;;mov	[si+12h],ax
 15966                                  	;MOV	[SI+SYS_FCB.FILSIZ+2],AX
 15967                                  	;;;
 15968 00002304 06                      	push	es
 15969 00002305 26C44511                	les	ax,[es:di+SF_ENTRY.sf_size]
 15970 00002309 894410                  	mov	[si+SYS_FCB.FILSIZ],ax
 15971 0000230C 8C4412                  	mov	[si+SYS_FCB.FILSIZ+2],es
 15972 0000230F 07                      	pop	es
 15973                                  	;;;
 15974                                  					;	}
 15975                                  SkipOp:
 15976                                  	;mov	ax,[bp-17]
 15977 00002310 8B46EF                  	MOV	AX,cResult		;   cRecRes = cResult / RecSize;
 15978 00002313 31D2                    	XOR	DX,DX
 15979                                  	;div	word [bp-9]
 15980 00002315 F776F7                  	DIV	RecSize
 15981                                  	;mov	[bp-19],ax
 15982 00002318 8946ED                  	MOV	cRecRes,AX
 15983                                  	;add	[bp-7],ax
 15984 0000231B 0146F9                  	ADD	RecPosL,AX		;   RecPos += cRecResult;
 15985                                  	;adc	word [bp-5],0
 15986 0000231E 8356FB00                	ADC	RecPosH,0
 15987                                  
 15988                                  ; If we have not gotten the expected number of records, we signal an EOF
 15989                                  ; condition. On input, this is EOF. On output this is usually disk full.
 15990                                  ; BUT... Under 2.0 and before, all device output IGNORED this condition. So
 15991                                  ; do we.
 15992                                  
 15993                                  	;cmp	ax,[bp-3]
 15994 00002322 3B46FD                  	CMP	AX,cRec 		;   if (cRecRes <> cRec)
 15995 00002325 7411                    	JZ	short TryBlank
 15996                                  	;test	byte [bp-20],4
 15997 00002327 F646EC04                	TEST	FCBOp,FCBREAD		;	if (OP&FCBRead || !DEVICE)
 15998 0000232B 7507                    	JNZ	short SetEOF
 15999                                  	; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 16000                                  	; MSDOS 3.3
 16001                                  	;;test	word [es:di+5],80h
 16002                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device
 16003                                  	;JNZ	short TryBlank
 16004                                  	; MSDOS 5.0 & MSDOS 6.0
 16005                                  	;test	byte [es:di+5],80h
 16006 0000232D 26F6450580              	test	byte [ES:DI+SF_ENTRY.sf_flags],devid_device
 16007 00002332 7504                    	jnz	short TryBlank
 16008                                  
 16009                                  SetEOF:
 16010                                  	;mov	byte [bp-1],1
 16011 00002334 C646FF01                	MOV	FCBErr,FEOF		;	FCBErr = FEOF;
 16012                                  TryBlank:				;
 16013 00002338 09D2                    	OR	DX,DX			;   if (cResult%RecSize <> 0) {
 16014 0000233A 7426                    	JZ	short SetExt
 16015                                  	;add	word [bp-7],1
 16016 0000233C 8346F901                	ADD	RecPosL,1		;	RecPos++;
 16017                                  	;adc	word [bp-5],0
 16018 00002340 8356FB00                	ADC	RecPosH,0
 16019                                  	;test	byte [bp-20],4
 16020 00002344 F646EC04                	TEST	FCBOp,FCBREAD		;	if(OP&FCBRead) <> 0) {
 16021 00002348 7418                    	JZ	short SetExt
 16022                                  	;inc	word [bp-19]
 16023 0000234A FF46ED                  	INC	cRecRes 		;	cRecRes++;
 16024                                  	;mov	byte [bp-1],3
 16025 0000234D C646FF03                	MOV	FCBErr,FTRIM+FEOF	;	FCBErr = FTRIM | FEOF;
 16026                                  	;mov	cx,[bp-9]
 16027 00002351 8B4EF7                  	MOV	CX,RecSize		;	Blank (RecSize-cResult%RecSize,
 16028 00002354 29D1                    	SUB	CX,DX			;	       DMA+cResult);
 16029 00002356 30C0                    	XOR	AL,AL
 16030                                  ;hkn; 	SS override
 16031 00002358 36C43E[2C03]            	les     di,[ss:DMAADD]
 16032                                  	;add	di,[bp-17]
 16033 0000235D 037EEF                  	ADD	DI,cResult
 16034 00002360 F3AA                    	REP	STOSB			;   }	}
 16035                                  SetExt:
 16036                                  	;mov	dx,[bp-5]
 16037 00002362 8B56FB                  	MOV	DX,RecPosH
 16038                                  	;mov	ax,[bp-7]
 16039 00002365 8B46F9                  	MOV	AX,RecPosL
 16040                                  	;test	byte [bp-20],2
 16041 00002368 F646EC02                	TEST	FCBOp,RANDOM		;   if ((OP&Random) == 0 ||
 16042 0000236C 7406                    	JZ	short DoSetExt
 16043                                  	;test	byte [bp-20],8
 16044 0000236E F646EC08                	TEST	FCBOp,BLOCK		;	(OP&BLOCK) <> 0)
 16045 00002372 7403                    	JZ	short TrySetRR
 16046                                  DoSetExt:
 16047 00002374 E85BFE                  	call	SetExtent		;	SetExtent (RecPos, FCB);
 16048                                  TrySetRR:
 16049                                  	;test	byte [bp-20],8
 16050 00002377 F646EC08                	TEST	FCBOp,BLOCK		;   if ((op&BLOCK) <> 0)
 16051 0000237B 740F                    	JZ	short TryReturn
 16052                                  	;mov	[si+21h],ax
 16053 0000237D 894421                  	MOV	[SI+SYS_FCB.RR],AX	;	FCB->RR = RecPos;
 16054                                  	;mov	[si+23h],dl
 16055 00002380 885423                  	MOV	[SI+SYS_FCB.RR+2],DL
 16056                                  	;cmp	word [si+0Eh],64
 16057 00002383 837C0E40                	CMP	word [SI+SYS_FCB.RECSIZ],64
 16058 00002387 7303                    	JAE	short TryReturn
 16059                                  	;mov	[si+24h],dh
 16060 00002389 887424                  	MOV	[SI+SYS_FCB.RR+2+1],DH	; Set 4th byte only if record size < 64
 16061                                  TryReturn: 
 16062                                  	;test	byte [bp-20],4
 16063 0000238C F646EC04                	TEST	FCBOp,FCBREAD		;   if (!(FCBOP & FCBREAD)) {
 16064 00002390 750B                    	JNZ	short FCBSave
 16065 00002392 1E                      	push	ds			;	FCB->FDate = date;
 16066 00002393 E8A7E7                  	call	DATE16			;	FCB->FTime = time;
 16067 00002396 1F                      	pop	ds
 16068                                  	;mov	[si+14h],ax
 16069 00002397 894414                  	MOV	[SI+SYS_FCB.FDATE],AX
 16070                                  	;mov	[si+16h],dx
 16071 0000239A 895416                  	MOV	[SI+SYS_FCB.FTIME],DX	;	}
 16072                                  FCBSave: 
 16073                                  	;test	byte [bp-20],8
 16074 0000239D F646EC08                	TEST	FCBOp,BLOCK		;   if ((op&BLOCK) <> 0)
 16075 000023A1 7409                    	jz	short DoReturn
 16076                                  	;mov	cx,[bp-19]
 16077 000023A3 8B4EED                  	MOV	CX,cRecRes		;	user_CX = cRecRes;
 16078 000023A6 E8CEE0                  	call    Get_User_Stack
 16079                                  	;mov	[si+4],cx
 16080 000023A9 894C04                  	MOV	[SI+user_env.user_CX],CX
 16081                                  DoReturn:
 16082                                  	;mov	al,[bp-1]
 16083 000023AC 8A46FF                  	MOV	AL,FCBErr		;   return (FCBERR);
 16084                                  	;Leave	
 16085 000023AF 89EC                    	mov     sp,bp
 16086 000023B1 5D                      	pop     bp
 16087 000023B2 C3                      	retn
 16088                                  
 16089                                  ; 22/07/2018 - Retro DOS v3.0
 16090                                  
 16091                                  ;Break <$FCB_Open - open an old-style FCB>
 16092                                  ;---------------------------------------------------------------------------
 16093                                  ;
 16094                                  ;   $FCB_Open - CPM compatability file open. The user has formatted an FCB
 16095                                  ;	for us and asked to have the rest filled in.
 16096                                  ;
 16097                                  ;   Inputs:	DS:DX point to an unopenned FCB
 16098                                  ;   Outputs:	AL indicates status 0 is ok FF is error
 16099                                  ;		FCB has the following fields filled in:
 16100                                  ;		    Time/Date Extent/NR Size
 16101                                  ;---------------------------------------------------------------------------
 16102                                  
 16103                                  	; 23/01/2024 - Retro DOS v5.0
 16104                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:6362h
 16105                                  
 16106                                  _$FCB_OPEN:			; System call 15
 16107                                  	
 16108                                  	;mov	ax,2 
 16109 000023B3 B80200                  	MOV	AX,SHARING_COMPAT+open_for_both
 16110                                  
 16111                                  ;hkn; DOS_Open is in DOSCODE
 16112 000023B6 B9[2B31]                	MOV	CX,DOS_OPEN
 16113                                  
 16114                                  ; The following is common code for Creation and openning of FCBs. AX is
 16115                                  ; either attributes (for create) or open mode (for open)... DS:DX points to
 16116                                  ; the FCB
 16117                                  
 16118                                  DoAccess:
 16119 000023B9 1E                      	push	ds
 16120 000023BA 52                      	push	dx
 16121 000023BB 51                      	push	cx
 16122 000023BC 50                      	push	ax			; save FCB pointer away
 16123                                  
 16124                                  ;hkn; 	OpenBuf is in DOSDATA
 16125 000023BD BF[BE03]                	MOV	DI,OPENBUF
 16126 000023C0 E8BE54                  	call	TransFCB		; crunch the fcb
 16127 000023C3 58                      	pop	ax
 16128 000023C4 59                      	pop	cx
 16129 000023C5 5A                      	pop	dx
 16130 000023C6 1F                      	pop	ds			; get fcb
 16131 000023C7 7303                    	JNC	short FindFCB		; everything seems ok
 16132                                  FCBOpenErr:
 16133                                  	; AL has error code
 16134 000023C9 E9BEE2                  	jmp	FCB_RET_ERR
 16135                                  FindFCB:
 16136 000023CC E81DFE                  	call	GetExtended		; DS:SI will point to FCB
 16137                                  
 16138                                  	; 17/05/2019 - Retro DOS v4.0
 16139                                  
 16140                                  	; MSDOS 3.3
 16141                                  	;call	LRUFCB
 16142                                  	;jc	short HardMessage
 16143                                  
 16144                                  	; MSDOS 6.0
 16145 000023CF 50                      	push	ax
 16146 000023D0 B001                    	mov	al,1			;indicate Open/Create operation
 16147 000023D2 E803FB                  	call	LRUFCB			; get a sft entry (no error)
 16148 000023D5 58                      	pop	ax
 16149 000023D6 722A                    	jc	short HardMessage
 16150                                  	
 16151                                  	;mov	word [es:di+2],8000h
 16152 000023D8 26C745020080            	mov	word [es:di+SF_ENTRY.sf_mode],sf_isFCB
 16153 000023DE 1E                      	push	ds
 16154 000023DF 56                      	push	si	
 16155 000023E0 53                      	push	bx			; save fcb pointer
 16156 000023E1 89CE                    	MOV	SI,CX
 16157                                  
 16158                                  ;hkn; SS is DOSDATA
 16159 000023E3 16                      	push	ss
 16160 000023E4 1F                      	pop	ds			    ; let DOS_Open see variables
 16161 000023E5 FFD6                    	CALL	SI ; DOS_OPEN or DOS_CREATE ; go open the file
 16162 000023E7 5B                      	pop	bx
 16163 000023E8 5E                      	pop	si
 16164 000023E9 1F                      	pop	ds			; get fcb
 16165                                  
 16166                                  ;hkn; SS override
 16167 000023EA 36C43E[9E05]            	LES	DI,[SS:THISSFT]		; get sf pointer
 16168 000023EF 7318                    	JNC	short FCBOK		; operation succeeded
 16169                                  failopen:
 16170 000023F1 50                      	PUSH	AX
 16171 000023F2 B052                    	MOV	AL,"R"	; 52h		; clear out field (free sft)
 16172 000023F4 E8C3FC                  	call	BlastSFT
 16173 000023F7 58                      	POP	AX
 16174                                  	;cmp	ax,4
 16175 000023F8 83F804                  	CMP	AX,error_too_many_open_files
 16176 000023FB 7405                    	JZ	short HardMessage
 16177                                  	;cmp	ax,24h
 16178 000023FD 83F824                  	CMP	AX,error_sharing_buffer_exceeded
 16179 00002400 7505                    	jnz	short DeadFCB
 16180                                  HardMessage:
 16181 00002402 50                      	PUSH	AX
 16182 00002403 E86FFD                  	call	FCBHardErr
 16183 00002406 58                      	POP	AX
 16184                                  DeadFCB:
 16185                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 16186                                  	;jmp	FCB_RET_ERR
 16187 00002407 EBC0                    	jmp	short FCBOpenErr
 16188                                  FCBOK:
 16189                                  	; MSDOS 6.0
 16190 00002409 E813F4                  	call	IsSFTNet		;AN007;F.C. >32mb  Non Fat file?
 16191 0000240C 7531                    	JNZ	short FCBOK2		;AN007;F.C. >32mb  yes
 16192 0000240E E8AE5C                  	call	CheckShare		;AN000;F.C. >32mb  share around?
 16193                                  	;JNZ	short FCBOK2		;AN000;F.C. >32mb  yes
 16194                                  	; 23/01/2024 - Retro DOS v5.0
 16195                                  	; (PCDOS 7.1 IBMDOS.COM)
 16196 00002411 750A                    	jnz	short FCBOK1
 16197                                  
 16198                                  ;SR;
 16199                                  ; If we reach here, we know we have got a local SFT. Let's update the 
 16200                                  ; LocalSFT variable to reflect this.
 16201                                  
 16202 00002413 36893E[490F]            	mov	[ss:LocalSFT],di
 16203 00002418 368C06[4B0F]            	mov	[ss:LocalSFT+2],es; Store the SFT address
 16204                                  ;;SR;
 16205                                  ;; The check below is not valid anymore since we regenerate for media > 32M.
 16206                                  ;;
 16207                                  ;;	CMP	WORD [ES:DI+SF_ENTRY.sf_dirsec+2],0 
 16208                                  ;;					       ;AN000;F.C. >32mb  if dirsec >32mb
 16209                                  ;;	JZ	short FCBOK2		       ;AN000;F.C. >32mb    then error
 16210                                  ;;	MOV	AX,error_sys_comp_not_loaded   ;AN000;F.C. >32mb
 16211                                  ;;	JMP	short failopen		       ;AN000;F.C. >32mb
 16212                                  
 16213                                  	; 23/01/2024 - Retro DOS v5.0
 16214                                  	; (PCDOS 7.1 IBMDOS.COM)
 16215                                  	;;;
 16216                                  FCBOK1:
 16217                                  	;test	byte [es:di+5],80h
 16218 0000241D 26F6450580              	test	byte [es:di+SF_ENTRY.sf_flags],devid_device
 16219 00002422 751B                    	jnz	short FCBOK2	; local device
 16220                                  	;test	byte [es:di+4],8
 16221 00002424 26F6450408              	test	byte [es:di+SF_ENTRY.sf_attr],attr_volume_id
 16222 00002429 7514                    	jnz	short FCBOK2
 16223                                  		; local file
 16224 0000242B 06                      	push	es
 16225 0000242C 57                      	push	di
 16226                                  	;les	di,[es:di+07h]
 16227 0000242D 26C47D07                	les	di,[es:di+SF_ENTRY.sf_devptr] ; local file's DPB
 16228                                  	;cmp	word [es:di+0Fh],0
 16229 00002431 26837D0F00              	cmp	word [es:di+DPB.FAT_SIZE],0 ; (16 bit FAT size)	
 16230 00002436 5F                      	pop	di
 16231 00002437 07                      	pop	es
 16232 00002438 7505                    	jnz	short FCBOK2	; not FAT32 (ok)
 16233                                  	;mov	ax,0Fh		; error_invalid_drive (for FAT32)
 16234 0000243A B80F00                  	mov	ax,error_invalid_drive
 16235 0000243D EBB2                    	jmp	short failopen
 16236                                  	;;; 
 16237                                  
 16238                                  FCBOK2:
 16239                                  	; MSDOS 6.0 (& MSDOS 3.3)
 16240 0000243F 26FF05                  	inc	word [es:di]
 16241                                  	;INC	word [ES:DI+SF_ENTRY.sf_ref_count] ; increment reference count
 16242                                  
 16243                                  	; 23/01/2024 - Retro DOS v5.0
 16244                                  	; (PCDOS 7.1 IBMDOS.COM)
 16245                                  	;;;
 16246 00002442 E88424                  	call	set_sftfcb_entry
 16247                                  	;;;
 16248                                  
 16249 00002445 E8C2F9                  	call	SaveFCBInfo
 16250                                  
 16251                                  	; MSDOS 3.3
 16252                                  	;call	SetOpenAge
 16253                                  	; MSDOS 6.0 (& MSDOS 3.3)
 16254                                  	;test	word [es:di+5],80h
 16255                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device
 16256 00002448 26F6450580              	test	byte [ES:DI+SF_ENTRY.sf_flags],devid_device  ; 28/07/2019
 16257 0000244D 7508                    	JNZ	short FCBNoDrive	; do not munge drive on devices
 16258                                  
 16259 0000244F 8A04                    	MOV	AL,[SI]			; get drive byte
 16260 00002451 E8BE53                  	call	GETTHISDRV		; convert
 16261                                  	;INC	AL
 16262                                  	; 17/12/2022
 16263 00002454 40                      	inc	ax
 16264 00002455 8804                    	MOV	[SI],AL			; stash in good drive letter
 16265                                  
 16266                                  FCBNoDrive:
 16267                                  	;mov	word [si+0Eh],128
 16268 00002457 C7440E8000              	MOV	word [SI+SYS_FCB.RECSIZ],80h ; stuff in default record size
 16269                                  
 16270                                  	; 23/01/2024 - Retro DOS v5.0
 16271                                  	; (PCDOS 7.1 IBMDOS.COM)
 16272                                  	;;;
 16273                                  	;;mov	ax,[es:di+0Dh]
 16274                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_time] ; set time
 16275                                  	;;mov	[si+16h],ax
 16276                                  	;MOV	[SI+SYS_FCB.FTIME],AX
 16277                                  	;;mov	ax,[es:di+0Fh]
 16278                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_date] ; set date
 16279                                  	;;mov	[si+14h],ax
 16280                                  	;MOV	[SI+SYS_FCB.FDATE],AX
 16281                                  	;;mov	ax,[es:di+11h]
 16282                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_size] ; set sizes
 16283                                  	;;mov	[si+10h],ax
 16284                                  	;MOV	[SI+SYS_FCB.FILSIZ],AX
 16285                                  	;;mov	ax,[es:di+13h]
 16286                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_size+2]
 16287                                  	;;mov	[si+12h],ax
 16288                                  	;MOV	[SI+SYS_FCB.FILSIZ+2],AX
 16289                                  	;
 16290 0000245C 06                      	push	es
 16291                                  	;les	ax,[es:di+0Dh]
 16292 0000245D 26C4450D                	les	ax,[es:di+SF_ENTRY.sf_time]
 16293                                  	;mov	[si+16h],ax
 16294 00002461 894416                  	mov	[si+SYS_FCB.FTIME],ax	; set time
 16295                                  	;mov	[si+14h],es
 16296 00002464 8C4414                  	mov	[si+SYS_FCB.FDATE],es	; set date
 16297 00002467 07                      	pop	es
 16298 00002468 06                      	push	es
 16299                                  	;les	ax,[es:di+11h]
 16300 00002469 26C44511                	les	ax,[es:di+SF_ENTRY.sf_size] ; set size
 16301                                  	;mov	[si+10h],ax
 16302 0000246D 894410                  	mov	[si+SYS_FCB.FILSIZ],ax
 16303                                  	;mov	[si+12h],ax
 16304 00002470 8C4412                  	mov	[si+SYS_FCB.FILSIZ+2],es
 16305 00002473 07                      	pop	es
 16306                                  	;;;
 16307                                  	
 16308 00002474 31C0                    	XOR	AX,AX			; convenient zero
 16309                                  	;mov	[si+0Ch],ax
 16310 00002476 89440C                  	MOV	[SI+SYS_FCB.EXTENT],AX	; point to beginning of file
 16311                                  
 16312                                  ; We must scan the set of FCB SFTs for one that appears to match the current
 16313                                  ; one.	We cheat and use CheckFCB to match the FCBs.
 16314                                  
 16315                                  ;hkn; 	SS override
 16316 00002479 36C43E[4000]            	LES	DI,[SS:SFTFCB]		; get the pointer to head of the list
 16317                                  	;mov	ah,[es:di+4]
 16318 0000247E 268A6504                	MOV	AH,[ES:DI+SFT.SFCount]	; get number of SFTs to scan
 16319                                  OpenScan:
 16320                                  	;cmp	al,[si+18h]
 16321 00002482 3A4418                  	CMP	AL,[SI+fcb_sfn]		; don't compare ourselves
 16322 00002485 7407                    	JZ	short SkipCheck
 16323 00002487 50                      	push	ax			; preserve count
 16324 00002488 E848FC                  	call	CheckFCB		; do they match
 16325 0000248B 58                      	pop	ax			; get count back
 16326 0000248C 7309                    	JNC	short OpenFound		; found a match!
 16327                                  SkipCheck:
 16328 0000248E FEC0                    	INC	AL			; advance to next FCB
 16329 00002490 38E0                    	CMP	AL,AH			; table full?
 16330 00002492 75EE                    	JNZ	short OpenScan		; no, go for more
 16331                                  OpenDone:
 16332 00002494 30C0                    	xor	al,al			; return success
 16333 00002496 C3                      	retn
 16334                                  
 16335                                  ; The SFT at ES:DI is the one that is already in use for this FCB. We set the
 16336                                  ; FCB to use this one. We increment its ref count. We do NOT close it at all.
 16337                                  ; Consider:
 16338                                  ;
 16339                                  ;   open (foo)	delete (foo) open (bar)
 16340                                  ;
 16341                                  ; This causes us to recycle (potentially) bar through the same local SFT as
 16342                                  ; foo even though foo is no longer needed; this is due to the server closing
 16343                                  ; foo for us when we delete it. Unfortunately, we cannot see this closure.
 16344                                  ; If we were to CLOSE bar, the server would then close the only reference to
 16345                                  ; bar and subsequent I/O would be lost to the redirector.
 16346                                  ;
 16347                                  ; This gets solved by NOT closing the sft, but zeroing the ref count
 16348                                  ; (effectively freeing the SFT) and informing the sharer (if relevant) that
 16349                                  ; the SFT is no longer in use. Note that the SHARER MUST keep its ref counts
 16350                                  ; around. This will allow us to access the same file through multiple network
 16351                                  ; connections and NOT prematurely terminate when the ref count on one
 16352                                  ; connection goes to zero.
 16353                                  
 16354                                  OpenFound:
 16355                                  	;mov	[si+18h],al
 16356 00002497 884418                  	MOV	[SI+fcb_sfn],AL 	; assign with this
 16357 0000249A 26FF05                  	inc	word [es:di]
 16358                                  	;INC	word [ES:DI+SF_ENTRY.sf_ref_count]
 16359                                  					; remember this new invocation
 16360                                  	; 23/01/2024 - Retro DOS v5.0
 16361                                  	; (PCDOS 7.1 IBMDOS.COM)
 16362                                  	;;;
 16363 0000249D E82924                  	call	set_sftfcb_entry
 16364                                  	;;;
 16365                                  
 16366                                  	; 24/01/2024
 16367 000024A0 16                      	push	ss
 16368 000024A1 1F                      	pop	ds
 16369                                  	
 16370                                  	;MOV	AX,[SS:FCBLRU]		; update LRU counts
 16371 000024A2 A1[1000]                	mov	ax,[FCBLRU] ; 24/01/2024
 16372                                  	;mov	[es:di+15h],ax
 16373 000024A5 26894515                	MOV	[ES:DI+sf_LRU],AX
 16374                                  ;
 16375                                  ; We have an FCB sft that is now of no use. We release sharing info and then
 16376                                  ; blast it to prevent other reuse.
 16377                                  ;
 16378                                  	;push	ss
 16379                                  	;pop	ds
 16380                                  	
 16381 000024A9 C43E[9E05]              	LES	DI,[THISSFT]
 16382 000024AD 26FF0D                  	dec	word [es:di]
 16383                                  	;DEC	word [ES:DI+SF_ENTRY.sf_ref_count]
 16384                                  					; free the newly allocated SFT
 16385 000024B0 E8565C                  	call	ShareEnd
 16386 000024B3 B043                    	MOV	AL,'C'	 ; 43h
 16387 000024B5 E802FC                  	call	BlastSFT
 16388 000024B8 EBDA                    	JMP	short OpenDone
 16389                                  
 16390                                  ;BREAK	<$FCB_Create - create a new directory entry>
 16391                                  ;----------------------------------------------------------------------------
 16392                                  ;
 16393                                  ;   $FCB_Create - CPM compatability file create. The user has formatted an
 16394                                  ;	FCB for us and asked to have the rest filled in.
 16395                                  ;
 16396                                  ;   Inputs:	DS:DX point to an unopenned FCB
 16397                                  ;   Outputs:	AL indicates status 0 is ok FF is error
 16398                                  ;		FCB has the following fields filled in:
 16399                                  ;		    Time/Date Extent/NR Size
 16400                                  ;----------------------------------------------------------------------------
 16401                                  
 16402                                  _$FCB_CREATE:		; System call 22
 16403                                  
 16404                                  ;hkn; DOS_Create is in DOSCODE
 16405 000024BA B9[FD2F]                	MOV	CX,DOS_CREATE		; routine to call
 16406 000024BD 31C0                    	XOR	AX,AX			; attributes to create
 16407 000024BF E82AFD                  	call	GetExtended		; get extended FCB
 16408 000024C2 7403                    	JZ	short DoAccessJ		; not an extended FCB
 16409 000024C4 8A44FF                  	MOV	AL,[SI-1]		; get attributes
 16410                                  DoAccessJ:
 16411 000024C7 E9EFFE                  	JMP	DoAccess		; do dirty work
 16412                                  
 16413                                  ;============================================================================
 16414                                  ; SEARCH.ASM, MSDOS 6.0, 1991
 16415                                  ;============================================================================
 16416                                  ; 22/07/2018 - Retro DOS v3.0
 16417                                  ; 17/05/2019 - Retro DOS v4.0
 16418                                  
 16419                                  ; DOSCODE:5DDFh (MSDOS 6.21, MSDOS.SYS)
 16420                                  
 16421                                  ; 09/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 16422                                  ; DOSCODE:5DCBh (MSDOS 5.0, MSDOS.SYS)
 16423                                  
 16424                                  ;**	Search.asm
 16425                                  ;----------------------------------------------------------------------------
 16426                                  ;	Directory search system calls.
 16427                                  ;	These will be passed direct text of the pathname from the user. 
 16428                                  ;	They will need to be passed through the macro expander prior to
 16429                                  ;	being sent through the low-level stuff. 
 16430                                  ;	I/O specs are defined in DISPATCH. The system calls are:
 16431                                  ;
 16432                                  ;	$Dir_Search_First	  written
 16433                                  ;	$Dir_Search_Next	  written
 16434                                  ;	$Find_First	  written
 16435                                  ;	$Find_Next		  written
 16436                                  ;	PackName		  written
 16437                                  ;
 16438                                  ;	Modification history:
 16439                                  ;
 16440                                  ;	  Created: ARR 4 April 1983
 16441                                  
 16442                                  ;----------------------------------------------------------------------------
 16443                                  ; Procedure Name : $DIR_SEARCH_FIRST
 16444                                  ;
 16445                                  ; Inputs:
 16446                                  ;	DS:DX Points to unopenned FCB
 16447                                  ; Function:
 16448                                  ;	Directory is searched for first matching entry and the directory
 16449                                  ;	entry is loaded at the disk transfer address
 16450                                  ; Returns:
 16451                                  ;	AL = -1 if no entries matched, otherwise 0
 16452                                  ;----------------------------------------------------------------------------
 16453                                  
 16454                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 2B88h
 16455                                  	
 16456                                  	; 24/01/2024
 16457                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:5DCBh
 16458                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:5DDFh
 16459                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:647Bh
 16460                                  	; Windows ME IO.SYS - BIOSCODE:61E5h
 16461                                  
 16462                                  _$DIR_SEARCH_FIRST:
 16463 000024CA 368916[A605]            	MOV	[SS:THISFCB],DX
 16464 000024CF 368C1E[A805]            	MOV	[SS:THISFCB+2],DS
 16465 000024D4 89D6                    	MOV	SI,DX
 16466 000024D6 803CFF                  	CMP	BYTE [SI],0FFH
 16467 000024D9 7503                    	JNZ	short NORMFCB4
 16468 000024DB 83C607                  	ADD	SI,7			; Point to drive select byte
 16469                                  NORMFCB4:
 16470 000024DE FF34                    	push	word [SI]		; Save original drive byte for later
 16471                                  
 16472 000024E0 16                      	push	ss
 16473 000024E1 07                      	pop	es			; get es to address DOSGroup
 16474                                  
 16475 000024E2 BF[BE03]                	MOV	DI,OPENBUF		; appropriate buffer
 16476 000024E5 E89953                  	call	TransFCB		; convert the FCB, set SATTRIB EXTFCB
 16477 000024E8 7304                    	JNC	short SearchIt		; no error, go and look
 16478 000024EA 5B                      	pop	bx			; Clean stack
 16479                                  
 16480                                  ; Error code is in AX
 16481                                  
 16482                                  	; 09/11/2022
 16483                                  dcf_errj:
 16484 000024EB E99CE1                  	jmp	FCB_RET_ERR		; error
 16485                                  
 16486                                  SearchIt:
 16487 000024EE 16                      	push	ss
 16488 000024EF 1F                      	pop	ds			; get ready for search
 16489                                  	;push	word [DMAADD]
 16490                                  	;push	word [DMAADD+2]
 16491                                  	; 24/01/2024
 16492 000024F0 C43E[2C03]              	les	di,[DMAADD]
 16493 000024F4 57                      	push	di
 16494 000024F5 06                      	push	es
 16495 000024F6 C706[2C03][BE04]        	MOV	WORD [DMAADD],SEARCHBUF
 16496 000024FC 8C1E[2E03]              	MOV	WORD [DMAADD+2],DS
 16497                                  	; 03/03/2025 (MiniDOS)
 16498                                  	; MSDOS 3.3
 16499 00002500 E83A0F                  	call	DOS_SEARCH_FIRST
 16500                                  	; MSDOS 6.0
 16501                                  	;call	GET_FAST_SEARCH		; search
 16502 00002503 8F06[2E03]              	pop	word [DMAADD+2]
 16503 00002507 8F06[2C03]              	pop	word [DMAADD]
 16504 0000250B 735A                    	JNC	short SearchSet		; no error, transfer info
 16505 0000250D 5B                      	pop	bx			; Clean stack
 16506                                  
 16507                                  ; Error code is in AX
 16508                                  
 16509                                  	; 09/11/2022
 16510                                  	;jmp	FCB_RET_ERR
 16511 0000250E EBDB                    	jmp	short dcf_errj
 16512                                  
 16513                                  ;----------------------------------------------------------------------------
 16514                                  ;
 16515                                  ; Procedure Name : $DIR_SEARCH_NEXT
 16516                                  ;
 16517                                  ; Inputs:
 16518                                  ;	DS:DX points to unopenned FCB returned by $DIR_SEARCH_FIRST
 16519                                  ; Function:
 16520                                  ;	Directory is searched for the next matching entry and the directory
 16521                                  ;	entry is loaded at the disk transfer address
 16522                                  ; Returns:
 16523                                  ;	AL = -1 if no entries matched, otherwise 0
 16524                                  ;----------------------------------------------------------------------------
 16525                                  
 16526                                  	; 24/01/2024
 16527                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:5E5Fh
 16528                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:5E73h
 16529                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:6517h
 16530                                  	; Windows ME IO.SYS - BIOSCODE:6273h
 16531                                  
 16532                                  _$DIR_SEARCH_NEXT:
 16533 00002510 368916[A605]            	MOV	[SS:THISFCB],DX
 16534 00002515 368C1E[A805]            	MOV	[SS:THISFCB+2],DS
 16535                                  	; 24/01/2024 (PCDOS 7.1)
 16536                                  	;MOV	byte [SS:SATTRIB],0
 16537                                  	;MOV	byte [SS:EXTFCB],0
 16538 0000251A B000                    	mov	al,0
 16539 0000251C 36A2[6D05]              	mov	[SS:SATTRIB],al ; 0
 16540 00002520 36A2[6D05]              	mov	[SS:SATTRIB],al ; 0
 16541                                  
 16542 00002524 16                      	push	ss
 16543 00002525 07                      	pop	es
 16544                                  
 16545 00002526 BF[BE04]                	MOV	DI,SEARCHBUF
 16546                                  
 16547 00002529 89D6                    	MOV	SI,DX
 16548 0000252B 803CFF                  	CMP	BYTE [SI],0FFh
 16549 0000252E 750D                    	JNZ	short NORMFCB6
 16550 00002530 83C606                  	ADD	SI,6
 16551 00002533 AC                      	LODSB
 16552                                  
 16553 00002534 36A2[6D05]              	MOV	[SS:SATTRIB],AL
 16554 00002538 36FE0E[6C05]            	DEC	byte [SS:EXTFCB]
 16555                                  NORMFCB6:
 16556 0000253D AC                      	LODSB				; Get original user drive byte
 16557 0000253E 50                      	push	ax			; Put it on stack
 16558 0000253F 8A4414                  	MOV	AL,[SI+20]		; Get correct search contin drive byte
 16559 00002542 AA                      	STOSB				; Put in correct place
 16560 00002543 B90A00                  	MOV	CX,20/2
 16561 00002546 F3A5                    	REP	MOVSW			; Transfer in rest of search contin info
 16562                                  
 16563 00002548 16                      	push	ss
 16564 00002549 1F                      	pop	ds
 16565                                  
 16566                                  	;push	word [DMAADD]
 16567                                  	;push	word [DMAADD+2]
 16568                                  	; 24/01/2024
 16569 0000254A C43E[2C03]              	les	di,[DMAADD]
 16570 0000254E 57                      	push	di
 16571 0000254F 06                      	push	es
 16572 00002550 C706[2C03][BE04]        	MOV	WORD [DMAADD],SEARCHBUF
 16573 00002556 8C1E[2E03]              	MOV	WORD [DMAADD+2],DS
 16574 0000255A E8A60F                  	call	DOS_SEARCH_NEXT 	; Find it
 16575 0000255D 8F06[2E03]              	pop	word [DMAADD+2]
 16576 00002561 8F06[2C03]              	pop	word [DMAADD]
 16577 00002565 7249                    	JC	short SearchNoMore
 16578                                  	; 24/01/2024
 16579                                  	;JMP	SearchSet		; Ok set return
 16580                                  
 16581                                  ;;;	; 24/01/2024 - Retro DOS v5.0
 16582                                  
 16583                                  ; The search was successful (or the search-next). We store the information
 16584                                  ; into the user's FCB for continuation.
 16585                                  
 16586                                  SearchSet:
 16587 00002567 BE[BE04]                	MOV	SI,SEARCHBUF
 16588 0000256A C43E[A605]              	LES	DI,[THISFCB]		; point to the FCB
 16589 0000256E F606[6C05]FF            	TEST	byte [EXTFCB],0FFh
 16590 00002573 7403                    	JZ	short NORMFCB1
 16591 00002575 83C707                  	ADD	DI,7			; Point past the extension
 16592                                  NORMFCB1:
 16593 00002578 5B                      	pop	bx			; Get original drive byte
 16594 00002579 08DB                    	OR	BL,BL
 16595 0000257B 7506                    	JNZ	short SearchDrv
 16596 0000257D 8A1E[3603]              	MOV	BL,[CURDRV]
 16597 00002581 FEC3                    	INC	BL
 16598                                  SearchDrv:
 16599 00002583 AC                      	LODSB				; Get correct search contin drive byte
 16600 00002584 86D8                    	XCHG	AL,BL			; Search byte to BL, user byte to AL
 16601 00002586 47                      	INC	DI
 16602                                  	;STOSB				; Store the correct "user" drive byte
 16603                                  					;  at the start of the search info
 16604 00002587 B90A00                  	MOV	CX,20/2
 16605 0000258A F3A5                    	REP	MOVSW			; Rest of search cont info, SI -> entry
 16606 0000258C 86D8                    	XCHG	AL,BL			; User drive byte back to BL, search
 16607                                  					;   byte to AL
 16608 0000258E AA                      	STOSB				; Search contin drive byte at end of
 16609                                  					;   contin info
 16610 0000258F C43E[2C03]              	LES	DI,[DMAADD]
 16611 00002593 F606[6C05]FF            	TEST	byte [EXTFCB],0FFh
 16612 00002598 740C                    	JZ	short NORMFCB2
 16613 0000259A B0FF                    	MOV	AL,0FFh
 16614 0000259C AA                      	STOSB
 16615 0000259D FEC0                    	INC	AL
 16616                                  	;MOV	CX,5
 16617                                  	; 17/12/2022
 16618                                  	;mov	cl,5
 16619                                  	;REP	STOSB
 16620                                  	; 03/07/2024
 16621 0000259F AB                      	stosw
 16622 000025A0 AB                      	stosw
 16623 000025A1 AA                      	stosb
 16624 000025A2 A0[6D05]                	MOV	AL,[SATTRIB]
 16625 000025A5 AA                      	STOSB
 16626                                  NORMFCB2:
 16627 000025A6 88D8                    	MOV	AL,BL			; User Drive byte
 16628 000025A8 AA                      	STOSB
 16629                                  	;MOV	CX,16			; 32 / 2 words of dir entry
 16630                                  	; 17/12/2022
 16631 000025A9 B110                    	mov	cl,16
 16632 000025AB F3A5                    	REP	MOVSW
 16633 000025AD E9D7E0                  	jmp	FCB_RET_OK
 16634                                  ;;;
 16635                                  
 16636                                  SearchNoMore:
 16637 000025B0 C43E[A605]              	LES	DI,[THISFCB]
 16638 000025B4 F606[6C05]FF            	TEST	byte [EXTFCB],0FFh
 16639 000025B9 7403                    	JZ	short NORMFCB8
 16640 000025BB 83C707                  	ADD	DI,7			; Point past the extension
 16641                                  NORMFCB8:
 16642 000025BE 5B                      	pop	bx			; Get original drive byte
 16643 000025BF 26881D                  	MOV	[ES:DI],BL		; Store the correct "user" drive byte
 16644                                  					;  at the right spot
 16645                                  ; error code is in AX
 16646                                  
 16647 000025C2 E9C5E0                  	jmp	FCB_RET_ERR
 16648                                  
 16649                                  ; 17/05/2019 - Retro DOS v4.0
 16650                                  
 16651                                  ; DOSCODE:5EE6h (MSDOS 6.21, MSDOS.SYS)
 16652                                  
 16653                                  ;---------------------------------------------------------------------------
 16654                                  ;
 16655                                  ;   Procedure Name : $FIND_FIRST
 16656                                  ; 
 16657                                  ;   Assembler usage:
 16658                                  ;	    MOV AH, FindFirst
 16659                                  ;	    LDS DX, name
 16660                                  ;	    MOV CX, attr
 16661                                  ;	    INT 21h
 16662                                  ;	; DMA address has datablock
 16663                                  ;
 16664                                  ;   Error Returns:
 16665                                  ;	    AX = error_path_not_found
 16666                                  ;	       = error_no_more_files
 16667                                  ;---------------------------------------------------------------------------
 16668                                  
 16669                                  	; 09/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 16670                                  	; DOSCODE:5ED2h (MSDOS 5.0, MSDOS.SYS)
 16671                                  
 16672                                  	; 24/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 16673                                  	; DOSCODE:6594h (PCDOS 7.1, IBMDOS.COM)
 16674                                  
 16675                                  _$FIND_FIRST:
 16676 000025C5 89D6                    	MOV	SI,DX			; get name in appropriate place
 16677 000025C7 36880E[6D05]            	MOV	[SS:SATTRIB],CL		; Search attribute to correct loc
 16678                                  
 16679 000025CC BF[BE03]                	MOV	DI,OPENBUF		; appropriate buffer
 16680                                  
 16681 000025CF E81553                  	call	TransPathSet		; convert the path
 16682 000025D2 7305                    	JNC	short Find_it 		; no error, go and look
 16683                                  FindError:
 16684                                  	;mov	al,3
 16685 000025D4 B003                    	mov	al,error_path_not_found	; error and map into one.
 16686                                  	; 09/11/2022
 16687                                  FF_errj:
 16688 000025D6 E99CE0                  	jmp	SYS_RET_ERR
 16689                                  Find_it:
 16690 000025D9 16                      	push	ss
 16691 000025DA 1F                      	pop	ds
 16692                                  
 16693                                  	;push	word [DMAADD]
 16694                                  	;push	word [DMAADD+2]
 16695                                  	; 24/01/2024 (PCDOS 7.1 IBMDOS.COM)
 16696 000025DB C43E[2C03]              	les	di,[DMAADD]
 16697 000025DF 57                      	push	di
 16698 000025E0 06                      	push	es
 16699                                  	
 16700 000025E1 C706[2C03][BE04]        	MOV	WORD [DMAADD],SEARCHBUF
 16701 000025E7 8C1E[2E03]              	MOV	WORD [DMAADD+2],DS
 16702                                  	; 03/03/2025 (MiniDOS)
 16703                                  	; MSDOS 3.3
 16704 000025EB E84F0E                  	call	DOS_SEARCH_FIRST
 16705                                  	; MSDOS 6.0
 16706                                  	;call	GET_FAST_SEARCH 	; search
 16707 000025EE 8F06[2E03]              	pop	word [DMAADD+2]
 16708 000025F2 8F06[2C03]              	pop	word [DMAADD]
 16709                                  	
 16710                                  	; 16/12/2022
 16711                                  	;JNC	short FindSet 		; no error, transfer info
 16712 000025F6 72DE                    	jc	short FF_errj	; jmp SYS_RET_ERR
 16713                                  	;
 16714                                  	;jmp	SYS_RET_ERR
 16715                                  	; 09/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 16716                                  ;FFF_errj:
 16717                                  	;jmp	short FF_errj	; jmp SYS_RET_ERR
 16718                                  
 16719                                  FindSet:
 16720 000025F8 BE[BE04]                	MOV	SI,SEARCHBUF
 16721 000025FB C43E[2C03]              	LES	DI,[DMAADD]
 16722 000025FF B91500                  	MOV	CX,21
 16723 00002602 F3A4                    	REP	MOVSB
 16724 00002604 56                      	PUSH	SI			; Save pointer to start of entry
 16725                                  	;mov	al,[si+0Bh]
 16726 00002605 8A440B                  	MOV	AL,[SI+dir_entry.dir_attr]
 16727 00002608 AA                      	STOSB
 16728                                  	;add	si,16h ; 22
 16729 00002609 83C616                  	ADD	SI,dir_entry.dir_time
 16730 0000260C A5                      	MOVSW				; dir_time
 16731 0000260D A5                      	MOVSW				; dir_date
 16732 0000260E 46                      	INC	SI
 16733 0000260F 46                      	INC	SI			; Skip dir_first
 16734 00002610 A5                      	MOVSW				; dir_size (2 words)
 16735 00002611 A5                      	MOVSW
 16736 00002612 5E                      	POP	SI			; Point back to dir_name
 16737 00002613 E83300                   	CALL	PackName
 16738 00002616 E952E0                  	jmp	SYS_RET_OK		; bye with no errors
 16739                                  
 16740                                  ;---------------------------------------------------------------------------
 16741                                  ;
 16742                                  ;   Procedure Name : $FIND_NEXT
 16743                                  ;
 16744                                  ;   Assembler usage:
 16745                                  ;	; dma points at area returned by find_first
 16746                                  ;	    MOV AH, findnext
 16747                                  ;	    INT 21h
 16748                                  ;	; next entry is at dma
 16749                                  ;
 16750                                  ;   Error Returns:
 16751                                  ;	    AX = error_no_more_files
 16752                                  ;---------------------------------------------------------------------------
 16753                                  
 16754                                  	; 09/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 16755                                  
 16756                                  	; 24/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 16757                                  	; DOSCODE:65ECh (PCDOS 7.1, IBMDOS.COM)
 16758                                  
 16759                                  _$FIND_NEXT:
 16760 00002619 16                      	push	ss
 16761 0000261A 07                      	pop	es
 16762                                  
 16763 0000261B BF[BE04]                	MOV	DI,SEARCHBUF
 16764                                  
 16765 0000261E 36C536[2C03]            	LDS	SI,[SS:DMAADD]
 16766                                  
 16767 00002623 B91500                  	MOV	CX,21
 16768 00002626 F3A4                    	REP	MOVSB			; Put the search continuation info
 16769                                  					;  in the right place
 16770 00002628 16                      	push	ss
 16771 00002629 1F                      	pop	ds			; get ready for search
 16772                                  	
 16773                                  	; 24/01/2024 (Retro DOS v5-v4)
 16774                                  	;push	word [DMAADD]
 16775                                  	;push	word [DMAADD+2]
 16776 0000262A C43E[2C03]              	les	di,[DMAADD]
 16777 0000262E 57                      	push	di
 16778 0000262F 06                      	push	es
 16779 00002630 C706[2C03][BE04]        	MOV	WORD [DMAADD],SEARCHBUF
 16780 00002636 8C1E[2E03]              	MOV	WORD [DMAADD+2],DS
 16781 0000263A E8C60E                  	call	DOS_SEARCH_NEXT 	; Find it
 16782 0000263D 8F06[2E03]              	pop	word [DMAADD+2]
 16783 00002641 8F06[2C03]              	pop	word [DMAADD]
 16784 00002645 73B1                    	JNC	short FindSet 		; No error, set info
 16785                                  	;jmp	SYS_RET_ERR
 16786                                  	; 16/12/2022
 16787 00002647 EB8D                    	jmp	short FF_errj	; jmp SYS_RET_ERR
 16788                                  	; 09/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 16789                                  	;jmp	short FFF_errj	; jmp SYS_RET_ERR
 16790                                  
 16791                                  ;---------------------------------------------------------------------------
 16792                                  ;**	PackName - Convert file names from FCB to ASCIZ format.
 16793                                  ;
 16794                                  ;	PackName transfers a file name from DS:SI to ES:DI and converts it to
 16795                                  ;	the ASCIZ format.
 16796                                  ;
 16797                                  ;	ENTRY	(DS:SI) = 11 character FCB or dir entry name
 16798                                  ;		(ES:DI) = destination area (13 bytes)
 16799                                  ;	EXIT	(ds:SI) and (es:DI) advanced
 16800                                  ;	USES	al, CX, SI, DI, Flags  (BUGBUG - not verified - jgl)
 16801                                  ;---------------------------------------------------------------------------
 16802                                  
 16803                                  	; 25/01/2024 - Retro DOS v5.0
 16804                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:6627h
 16805                                  
 16806                                  PackName:
 16807                                  ;	Move over 8 characters to cover the name component, then trim it's
 16808                                  ;	trailing blanks.
 16809                                  
 16810                                  	;MOV	CX,8			; Pack the name
 16811                                  	;REP	MOVSB			; Move all of it
 16812                                  	; 25/01/2024
 16813 00002649 B90400                  	mov	cx,4
 16814 0000264C F3A5                    	rep	movsw
 16815                                  main_kill_tail:
 16816 0000264E 26807DFF20              	CMP	BYTE [ES:DI-1]," "
 16817 00002653 7507                    	JNZ	short find_check_dot
 16818 00002655 4F                      	DEC	DI			; Back up over trailing space
 16819 00002656 41                      	INC	CX
 16820 00002657 83F908                  	CMP	CX,8
 16821 0000265A 72F2                    	JB	short main_kill_tail
 16822                                  find_check_dot:
 16823                                  	;CMP	WORD [SI],(" " << 8) | " "
 16824 0000265C 813C2020                	cmp     word [si],2020h 
 16825 00002660 7506                    	JNZ	short got_ext 		; Some chars in extension
 16826 00002662 807C0220                	CMP	BYTE [SI+2]," "
 16827 00002666 740F                    	JZ	short find_done		; No extension
 16828                                  got_ext:
 16829 00002668 B02E                    	MOV	AL,"."	; 2Eh
 16830 0000266A AA                      	STOSB
 16831                                  	;MOV	CX,3
 16832                                  	;; 18/12/2022
 16833                                  	;;mov	cl,3
 16834                                  	;;REP	MOVSB
 16835                                  	;movsb
 16836                                  	;movsb
 16837                                  	;movsb
 16838                                  	; 25/01/2024
 16839 0000266B A5                      	movsw
 16840 0000266C A4                      	movsb
 16841                                  ext_kill_tail:
 16842 0000266D 26807DFF20              	CMP	BYTE [ES:DI-1]," "
 16843 00002672 7503                    	JNZ	short find_done
 16844 00002674 4F                      	DEC	DI			; Back up over trailing space
 16845 00002675 EBF6                    	JMP	short ext_kill_tail
 16846                                  find_done:
 16847 00002677 31C0                    	XOR	AX,AX
 16848 00002679 AA                      	STOSB				; NUL terminate
 16849 0000267A C3                      	retn
 16850                                  
 16851                                  ;============================================================================
 16852                                  ; PATH.ASM, MSDOS 6.0, 1991
 16853                                  ;============================================================================
 16854                                  ; 06/08/2018 - Retro DOS v3.0
 16855                                  ; 17/05/2019 - Retro DOS v4.0
 16856                                  
 16857                                  ; DOSCODE:5FB0h (MSDOS 6.21, MSDOS.SYS)
 16858                                  
 16859                                  ;**	Directory related system calls. These will be passed direct text of the
 16860                                  ;	pathname from the user. They will need to be passed through the macro
 16861                                  ;	expander prior to being sent through the low-level stuff. I/O specs are
 16862                                  ;	defined in DISPATCH. The system calls are:
 16863                                  ;
 16864                                  ;	$CURRENT_DIR  Written
 16865                                  ;	$RMDIR	  Written
 16866                                  ;	$CHDIR	  Written
 16867                                  ;	$MKDIR	  Written
 16868                                  ;
 16869                                  ;
 16870                                  ;	Modification history:
 16871                                  ;
 16872                                  ;	    Created: ARR 4 April 1983
 16873                                  ;		 MZ 10 May 1983     CurrentDir implemented
 16874                                  ;		 MZ 11 May 1983     RmDir, ChDir, MkDir implemented
 16875                                  ;		 EE 19 Oct 1983     RmDir no longer allows you to delete a
 16876                                  ;				    current directory.
 16877                                  ;		 MZ 19 Jan 1983     Brain damaged applications rely on success
 16878                                  
 16879                                  ;	I_Need	ThisCDS,DWORD		; pointer to Current CDS
 16880                                  ;	I_Need	WFP_Start,WORD		; pointer to beginning of directory text
 16881                                  ;	I_Need	Curr_Dir_End,WORD	; offset to end of directory part
 16882                                  ;	I_Need	OpenBuf,128		; temp spot for translated name
 16883                                  ;	I_need	fSplice,BYTE		; TRUE => do splice
 16884                                  ;	I_Need	NoSetDir,BYTE		; TRUE => no exact match on splice
 16885                                  ;	I_Need	cMeta,BYTE
 16886                                  ;	I_Need	DrvErr,BYTE					;AN000;
 16887                                  
 16888                                  ;BREAK <$CURRENT_DIR - dump the current directory into user space>
 16889                                  ;----------------------------------------------------------------------------
 16890                                  ;
 16891                                  ;   Procedure Name : $CURRENT_DIR
 16892                                  ;
 16893                                  ;   Assembler usage:
 16894                                  ;		LDS	SI,area
 16895                                  ;		MOV	DL,drive
 16896                                  ;		INT	21h
 16897                                  ;	    ; DS:SI is a pointer to 64 byte area that contains drive
 16898                                  ;	    ; current directory.
 16899                                  ;   Error returns:
 16900                                  ;	    AX = error_invalid_drive
 16901                                  ;
 16902                                  ;----------------------------------------------------------------------------
 16903                                  
 16904                                  	; 06/08/2018 - Retro DOS v3.0
 16905                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 2D4Eh
 16906                                  
 16907                                  	; 25/01/2024 - Retro DOS v5.0
 16908                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:5F9Ch  ; Retro DOS v4.1 (& v4.0)
 16909                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:5FB0h ; Retro DOS v4.2
 16910                                  	; Windows ME IO.SYS - BIOSCODE:6393h
 16911                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:6664h ; Retro DOS v5.0
 16912                                  
 16913                                  _$CURRENT_DIR:
 16914 0000267B E806F2                  	call	ECritDisk
 16915 0000267E 88D0                    	MOV	AL,DL			; get drive number (0=def, 1=A)
 16916 00002680 E87351                  	call	GetVisDrv		; grab it
 16917 00002683 7310                    	JNC	short CurrentValidate 	; no error -> go and validate dir
 16918                                  CurdirErr:
 16919 00002685 E829F2                  	call	LCritDisk
 16920                                  
 16921                                  	; MSDOS 3.3
 16922                                  	;mov	al,0Fh
 16923                                  	
 16924                                  	; MSDOS 6.0
 16925 00002688 1E                      	push	ds
 16926 00002689 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 16927 0000268E A0[1006]                	mov	al,[DrvErr]		;IFS.			;AN000;
 16928 00002691 1F                      	pop	ds
 16929                                  
 16930                                  curdir_errj:
 16931 00002692 E9E0DF                  	jmp	SYS_RET_ERR		;IFS. make noise	;AN000;
 16932                                  
 16933                                  CurrentValidate:
 16934 00002695 1E                      	push	ds			; save destination
 16935 00002696 56                      	push	si
 16936                                  	
 16937                                  	;LDS	SI,[CS:THISCDS] ; MSDOS 3.3
 16938                                  	
 16939                                  	; MSDOS 6.0
 16940 00002697 2E8E1E[0700]            	mov     ds,[cs:DosDSeg]
 16941                                  	; 25/01/2024 (PCDOS 7.1 IBMDOS.COM)
 16942 0000269C C606[4C03]00            	mov	byte [NoSetDir],0 ; *
 16943                                  	
 16944                                  	; 25/01/2024
 16945                                  	;lds     si,[THISCDS]
 16946                                  
 16947                                  ; 16/12/2022
 16948                                  %if 0
 16949                                  	; 09/11/2022 (following test instruction is nonsense!)
 16950                                  	; (I am leaving it here for MSDOS 5.0 MSDOS.SYS compatibility)
 16951                                  
 16952                                  	;test	word [si+43h],8000h
 16953                                  	TEST	word [SI+curdir.flags],curdir_isnet
 16954                                  	;jnz	short $+2  ; 09/11/2022
 16955                                  	jnz	short DoCheck
 16956                                  %endif
 16957                                  
 16958                                  ; Random optimization nuked due to some utilities using GetCurrentDir to do
 16959                                  ; media check.
 16960                                  ;	CMP	word [SI+curdir.ID],0
 16961                                  ;	JZ	short GetDst
 16962                                  DoCheck:
 16963                                  	;MOV	byte [cs:NoSetDir],0	; interested only in contents
 16964                                  
 16965                                  	; 25/01/2024
 16966                                  	; MSDOS 6.0
 16967                                  	;push	ds
 16968                                  	;mov	ds,[cs:DosDSeg]
 16969                                  	;mov	byte [NoSetDir],0 ; *
 16970                                  	;pop	ds
 16971                                  
 16972 000026A1 BF[BE03]                	MOV	DI,OPENBUF
 16973 000026A4 E8E025                  	call	ValidateCDS		; output is ES:DI -> CDS
 16974                                  
 16975 000026A7 06                      	push	es	 		; swap source and destination
 16976 000026A8 57                      	push	di
 16977 000026A9 5E                      	pop	si
 16978 000026AA 1F                      	pop	ds
 16979                                  GetDst:
 16980 000026AB 5F                      	pop	di
 16981 000026AC 07                      	pop	es			; get real destination
 16982 000026AD 72D6                    	JC	short CurdirErr
 16983                                  	;ADD	SI,curdir.text ; add si,0 ; 09/08/2018
 16984                                  	;
 16985                                  	; 09/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 16986                                  	; DOSCODE:5FE2h (MSDOS 5.0, MSDOS.SYS)
 16987                                  	; 16/12/2022
 16988                                  	;add	si,0  ; add si,curdir.text
 16989                                  	;
 16990                                  	;add	si,[si+4Fh] ; 17/05/2019
 16991 000026AF 03744F                  	ADD	SI,[SI+curdir.end]
 16992 000026B2 803C5C                  	CMP	BYTE [SI],'\'	; 5Ch	; root or subdirs present?
 16993 000026B5 7501                    	JNZ	short CurrentCopy
 16994 000026B7 46                      	INC	SI
 16995                                  CurrentCopy:
 16996                                  ;	call	FStrCpy
 16997                                  ;; 10/29/86 E5 char
 16998 000026B8 50                      	PUSH	AX
 16999 000026B9 AC                      	LODSB				; get char
 17000 000026BA 08C0                    	OR	AL,AL
 17001 000026BC 7413                    	JZ	short FOK
 17002 000026BE 3C05                    	CMP	AL,05H
 17003 000026C0 740D                    	JZ	short FCHANGE
 17004 000026C2 EB01                    	JMP	short FFF
 17005                                  FCPYNEXT:
 17006 000026C4 AC                      	LODSB				; get char
 17007                                  FFF:
 17008 000026C5 3C5C                    	CMP	AL,'\'			; beginning of directory
 17009 000026C7 7508                    	JNZ	short FOK		; no
 17010 000026C9 AA                      	STOSB				; put into user's buffer
 17011 000026CA AC                      	LODSB				; 1st char of dir is 05?
 17012 000026CB 3C05                    	CMP	AL,05H
 17013 000026CD 7502                    	JNZ	short FOK		; no
 17014                                  FCHANGE:
 17015 000026CF B0E5                    	MOV	AL,0E5H			; make it E5
 17016                                  FOK:
 17017 000026D1 AA                      	STOSB				; put into user's buffer
 17018 000026D2 08C0                    	OR	AL,AL			; final char
 17019 000026D4 75EE                    	JNZ	short FCPYNEXT		; no
 17020 000026D6 58                      	POP	AX
 17021                                  
 17022                                  ;; 10/29/86 E5 char
 17023 000026D7 30C0                    	xor	AL,AL			; MZ 19 Jan 84
 17024 000026D9 E8D5F1                  	call	LCritDisk
 17025 000026DC E98CDF                  	jmp	SYS_RET_OK		; no more, bye!
 17026                                  
 17027                                  ; 17/05/2019 - Retro DOS v4.0
 17028                                  
 17029                                  ; DOSCODE:6029h (MSDOS 6.21, MSDOS.SYS)
 17030                                  
 17031                                  ;BREAK <$RmDir -- Remove a directory>
 17032                                  ;----------------------------------------------------------------------------
 17033                                  ;
 17034                                  ; Procedure Name : $RmDir
 17035                                  ;
 17036                                  ; Inputs:
 17037                                  ;	DS:DX Points to asciz name
 17038                                  ; Function:
 17039                                  ;	Delete directory if empty
 17040                                  ; Returns:
 17041                                  ;	STD XENIX Return
 17042                                  ;	AX = error_path_not_found If path bad
 17043                                  ;	AX = error_access_denied If
 17044                                  ;		Directory not empty
 17045                                  ;		Path not directory
 17046                                  ;		Root directory specified
 17047                                  ;		Directory malformed (. and .. not first two entries)
 17048                                  ;		User tries to delete a current directory
 17049                                  ;	AX = error_current_directory
 17050                                  ;
 17051                                  ;----------------------------------------------------------------------------
 17052                                  
 17053                                  	; 10/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 17054                                  	; DOSCODE:6015h (MSDOS 5.0, MSDOS.SYS)
 17055                                  
 17056                                  	; 25/01/2025 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 17057                                  	; DOSCODE:66C8h (PCDOS 7.1, IBMDOS.COM)
 17058                                  
 17059                                  _$RMDIR:
 17060 000026DF 52                      	push	dx			; Save ptr to name
 17061 000026E0 1E                      	push	ds
 17062 000026E1 89D6                    	mov	si,dx			; Load ptr into si
 17063 000026E3 BF[BE03]                	mov	di,OPENBUF		; di = ptr to buf for trans name
 17064 000026E6 57                      	push	di
 17065 000026E7 E80552                  	call	TransPathNoSet		; Translate the name
 17066 000026EA 5F                      	pop	di			; di = ptr to buf for trans name
 17067 000026EB 7306                    	jnc	short rmlset		; If transpath succeeded, continue
 17068 000026ED 1F                      	pop	ds
 17069 000026EE 5A                      	pop	dx			; Restore the name
 17070                                  	;mov	al,3
 17071 000026EF B003                    	mov	al,error_path_not_found ; Otherwise, return an error
 17072                                  	; 16/12/2022
 17073                                  rmdir_errj: ; 10/08/2018
 17074                                  chdir_errj:
 17075 000026F1 EB9F                    	jmp	short curdir_errj
 17076                                  	;jmp	SYS_RET_ERR
 17077                                  rmlset:
 17078 000026F3 36803E[7A05]FF          	CMP	byte [ss:CMETA],-1	;   if (cMeta >= 0)
 17079 000026F9 7518                    	Jnz	short rmerr		;	return (-1);
 17080 000026FB 16                      	push	ss
 17081 000026FC 07                      	pop	es
 17082 000026FD 30C0                    	xor	al,al			; al = 0 , ie drive a:
 17083                                  rmloop: 
 17084 000026FF E85F51                  	call	GetCDSFromDrv		; Get curdir for drive in al
 17085 00002702 7215                    	jc	short rmcont		; If error, exit loop & cont normally
 17086                                  
 17087                                  	; 25/01/2024 - Retro DOS v5.0
 17088                                  	; (PCDOS 7.1 IBMDOS.COM)
 17089                                  	;;;
 17090                                  	;;test	word [si+43h],4000h
 17091                                  	;test	word [si+curdir.flags],curdir_inuse
 17092 00002704 F6444440                	test	byte [si+curdir.flags+1],(curdir_inuse>>8)
 17093 00002708 7405                    	jz	short rmdir_nxt
 17094                                  	;;;
 17095                                  
 17096 0000270A E85FF0                  	call	StrCmp			; Are the 2 paths the same?
 17097 0000270D 7404                    	jz	short rmerr		; Yes, report error.
 17098                                  rmdir_nxt:	; 25/01/2024
 17099 0000270F FEC0                    	inc	al			; No, inc al to next drive number
 17100 00002711 EBEC                    	jmp	short rmloop		; Go check next drive.
 17101                                  rmerr:
 17102 00002713 1F                      	pop	ds
 17103 00002714 5A                      	pop	dx			; Restore ptr the name
 17104                                  	;mov	al,10h
 17105 00002715 B010                    	mov	al,error_current_directory ; error
 17106                                  	; 16/12/2022
 17107                                  	; 10/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 17108                                  ;chdir_errj:
 17109 00002717 EBD8                    	jmp	short rmdir_errj
 17110                                  rmcont:
 17111 00002719 1F                      	pop	ds
 17112 0000271A 5A                      	pop	dx			; Restore ptr the name
 17113 0000271B BE[5239]                	MOV	SI,DOS_RMDIR
 17114                                  
 17115                                  	; 25/01/2024 - Retro DOS v5.0
 17116                                  	; (PCDOS 7.1 IBMDOS.COM)
 17117                                  	;;;
 17118 0000271E E8E5F0                  	call	TestNet
 17119                                  	;mov	di,67		; DIRSTRLEN
 17120                                  	; 26/06/2024
 17121 00002721 B043                    	mov	al,67
 17122 00002723 7302                    	jnc	short rmcont2   ; local directory
 17123                                  	;mov	di,128
 17124 00002725 B080                    	mov	al,128
 17125                                  rmcont2:
 17126                                  	; 26/06/2024
 17127                                  	;mov	[ss:PATHNAMELEN],di
 17128 00002727 36A2[1011]              	mov	[ss:PATHNAMELEN],al
 17129                                  	;;;
 17130 0000272B E99900                  	JMP	DoDirCall
 17131                                  
 17132                                  ; 17/05/2019 - Retro DOS v4.0
 17133                                  
 17134                                  ; DOSCODE:6065h (MSDOS 6.21, MSDOS.SYS)
 17135                                  
 17136                                  ;BREAK <$ChDir -- Change current directory on a drive>
 17137                                  ;----------------------------------------------------------------------------
 17138                                  ;
 17139                                  ; $ChDir - Top-level change directory system call.  This call is responsible
 17140                                  ; for setting up the CDS for the specified drive appropriately.  There are
 17141                                  ; several cases to consider:
 17142                                  ;
 17143                                  ;   o	Local, simple CDS.  In this case, we take the input path and convert
 17144                                  ;	it into a WFP.	We verify the existance of this directory and then
 17145                                  ;	copy the WFP into the CDS and set up the ID field to point to the
 17146                                  ;	directory cluster.
 17147                                  ;   o	Net CDS.  We form the path from the root (including network prefix)
 17148                                  ;	and verify its existance (via DOS_Chdir).  If successful, we copy the
 17149                                  ;	WFP back into the CDS.
 17150                                  ;   o	SUBST'ed CDS.  This is no different than the local, simple CDS.
 17151                                  ;   o	JOIN'ed CDS.  This is trouble as there are two CDS's at work.  If we
 17152                                  ;	call TransPath, we will get the PHYSICAL CDS that the path refers to
 17153                                  ;	and the PHYSICAL WFP that the input path refers to.  This is perfectly
 17154                                  ;	good for the validation but not for currency.  We call TransPathNoSet
 17155                                  ;	to process the path but to return the logical CDS and the logical
 17156                                  ;	path.  We then copy the logical path into the logical CDS.
 17157                                  ;
 17158                                  ; Inputs:
 17159                                  ;	DS:DX Points to asciz name
 17160                                  ; Returns:
 17161                                  ;	STD XENIX Return
 17162                                  ;	AX = chdir_path_not_found if error
 17163                                  ;
 17164                                  ;----------------------------------------------------------------------------
 17165                                  	
 17166                                  	; 25/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 17167                                  	
 17168                                  _$CHDIR:
 17169                                  	; 25/01/2024
 17170                                  	;;;
 17171 0000272E 36C606[1011]43          	mov	byte [ss:PATHNAMELEN],67 ; Retro DOS v5.0
 17172                                  	;mov	word [ss:PATHNAMELEN],67 ; DIRSTRLEN = 67
 17173                                  	;;;
 17174 00002734 BF[BE03]                	MOV	DI,OPENBUF		; spot for translated name
 17175 00002737 89D6                    	MOV	SI,DX			; get source
 17176 00002739 E8A751                  	call	TransPath		; go munge the path and get real CDS
 17177 0000273C 7304                    	JNC	short ChDirCrack	; no errors, try path
 17178                                  ChDirErrP:
 17179                                  	;mov	al,3
 17180 0000273E B003                    	MOV	AL,error_path_not_found
 17181                                  ChDirErr:
 17182                                  	;jmp	SYS_RET_ERR 	; oops!
 17183                                  	; 10/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 17184 00002740 EBAF                    	jmp	short chdir_errj
 17185                                  
 17186                                  ChDirCrack:
 17187 00002742 803E[7A05]FF            	CMP	byte [CMETA],-1		; No meta chars allowed.
 17188 00002747 75F5                    	JNZ	short ChDirErrP
 17189                                  
 17190                                  ; We cannot do a ChDir (yet) on a raw CDS. This is treated as a path not
 17191                                  ; found.
 17192                                  
 17193 00002749 C43E[A205]              	LES	DI,[THISCDS]
 17194 0000274D 83FFFF                  	CMP	DI,-1			; if (ThisCDS == NULL)
 17195 00002750 74EC                    	JZ	short ChDirErrP		;    error ();
 17196                                  
 17197                                  ; Find out if the directory exists.
 17198                                  
 17199 00002752 E8C111                  	call	DOS_CHDIR
 17200                                  	;Jc	short ChDirErr
 17201                                  	; 16/12/2022
 17202 00002755 729A                    	jc	short chdir_errj
 17203                                  ;
 17204                                  ; Get back CDS to see if a join as seen. Set the currency pointer (only if
 17205                                  ; not network). If one was seen, all we need to do is copy in the text
 17206                                  ;
 17207                                  	; 25/01/2024 - Retro DOS V5.0
 17208 00002757 FF36[DC0A]              	push	word [DIRSTART_HW] ; *
 17209                                  
 17210 0000275B C43E[A205]              	LES	DI,[THISCDS]
 17211                                  	;test	word [es:di+43h],2000h
 17212                                  	; 17/12/2022
 17213 0000275F 26F6454420              	test	byte [ES:DI+curdir.flags+1],curdir_splice>>8
 17214                                  	;TEST	word [ES:DI+curdir.flags],curdir_splice
 17215                                  
 17216                                  	; 25/01/2024 (PCDOS 7.1)
 17217                                  	;mov	dx,[DIRSTART_HW]
 17218                                  
 17219 00002764 742B                    	JZ	short GotCDS
 17220                                  
 17221                                  ; The CDS was joined. Let's go back and grab the logical CDS.
 17222                                  
 17223 00002766 06                      	push	es	
 17224 00002767 57                      	push	di
 17225                                  	;push	dx ; 25/01/2024 (PCDOS 7.1)
 17226 00002768 51                      	push	cx ; word [DIRSTART]	; save CDS and cluster...
 17227 00002769 E80BDD                  	call	Get_User_Stack		; get original text
 17228                                  	
 17229                                  	;mov	di,[si+6]
 17230 0000276C 8B7C06                  	MOV	DI,[SI+user_env.user_DX]
 17231                                  	;mov	ds,[si+0Eh]
 17232 0000276F 8E5C0E                  	MOV	DS,[SI+user_env.user_DS]
 17233                                  	
 17234 00002772 BE[BE03]                	MOV	SI,OPENBUF		; spot for translated name
 17235 00002775 87FE                    	XCHG	SI,DI
 17236 00002777 30C0                    	XOR	AL,AL			; do no splicing
 17237 00002779 57                      	push	di
 17238 0000277A E87251                  	call	TransPathNoSet		; Munge path
 17239 0000277D 5E                      	pop	si
 17240                                  
 17241                                  ; There should NEVER be an error here.
 17242                                  
 17243                                  ;IF FALSE
 17244                                  ;	JNC SKipErr
 17245                                  ;	fmt <>,<>,<"$p: Internal CHDIR error\n">
 17246                                  ;SkipErr:
 17247                                  ;ENDIF
 17248 0000277E C43E[A205]              	LES	DI,[THISCDS]		; get new CDS
 17249                                  	;mov	word [es:di+49h],-1
 17250 00002782 26C74549FFFF            	MOV	word [ES:DI+curdir.ID],-1
 17251                                  					; no valid cluster here...
 17252                                  	;;; 25/01/2024 (PCDOS 7.1)
 17253                                  	;mov	word [es:di+4Bh],-1
 17254 00002788 26C7454BFFFF            	mov	word [es:di+curdir.ID+2],-1
 17255                                  	;;;
 17256 0000278E 59                      	pop	cx ; word [DIRSTART]
 17257                                  	;pop	dx ; 25/01/2024 (PCDOS 7.1)
 17258 0000278F 5F                      	pop	di
 17259 00002790 07                      	pop	es
 17260                                  
 17261                                  ; ES:DI point to the physical CDS, CX is the ID (local only)
 17262                                  
 17263                                  GotCDS:
 17264                                  	; 25/01/2024 - Retro DOS v5.0
 17265 00002791 5A                      	pop	dx ; word [DIRSTART_HW] ; *
 17266                                  
 17267                                  ; wfp_start points to the text. See if it is long enough
 17268                                  
 17269                                  	; MSDOS 3.3
 17270                                  	;push	ss
 17271                                  	;pop	ds
 17272                                  	;mov	si,[WFP_START]
 17273                                  	;push	cx
 17274                                  	;call	DStrLen
 17275                                  	;cmp	cx,67 ; cmp cx,DIRSTRLEN
 17276                                  	;pop	cx
 17277                                  	;ja	short ChDirErrP
 17278                                  
 17279                                  	; MSDOS 6.0
 17280 00002792 E85C00                  	CALL	Check_PathLen		;PTM.		;AN000;
 17281 00002795 77A7                    	JA	short ChDirErrP
 17282                                  	; MSDOS 3.3 & MSDOS 6.0
 17283                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet ; 8000h
 17284                                  	; 17/12/2022
 17285 00002797 26F6454480              	test	byte [ES:DI+curdir.flags+1],curdir_isnet>>8
 17286 0000279C 7518                    	JNZ	short SkipRecency
 17287                                  	; MSDOS 6.0
 17288                                  	;test	word [es:di+43h],2000h
 17289                                  	; 17/12/2022
 17290 0000279E 26F6454420              	test	byte [ES:DI+curdir.flags+1],curdir_splice>>8
 17291                                  	;TEST	word [ES:DI+curdir.flags],curdir_splice 
 17292                                  					;PTM. for Join and Subst ;AN000;
 17293 000027A3 7405                    	JZ	short setdirclus	;PTM.		;AN000;
 17294 000027A5 B9FFFF                  	MOV	CX,-1			;PTM.		;AN000;
 17295                                  	;;; 25/01/2024 (PCDOS 7.1 IBMDOS.COM)
 17296 000027A8 89CA                    	mov	dx,cx
 17297                                  setdirclus:
 17298                                  	;mov	[es:di+49h],cx
 17299 000027AA 26894D49                	MOV	[ES:DI+curdir.ID],CX
 17300                                  	;;; 25/01/2024 (PCDOS 7.1 IBMDOS.COM)
 17301 000027AE 2689554B                	mov	[es:di+curdir.ID+2],dx
 17302                                  	;;;
 17303 000027B2 C43E[A205]              	LES	DI,[THISCDS]		; get logical CDS
 17304                                  SkipRecency:
 17305 000027B6 E8E4EF                  	call	FStrCpy
 17306 000027B9 30C0                    	XOR	AL,AL
 17307                                  mkdir_ok:
 17308 000027BB E9ADDE                  	jmp	SYS_RET_OK
 17309                                  
 17310                                  ; 17/05/2019 - Retro DOS v4.0
 17311                                  
 17312                                  ; DOSCODE:60E1h (MSDOS 6.21, MSDOS.SYS)
 17313                                  
 17314                                  ;BREAK <$MkDir - Make a directory entry>
 17315                                  ;---------------------------------------------------------------------------
 17316                                  ;
 17317                                  ; Procedure Name : $MkDir
 17318                                  ; Inputs:
 17319                                  ;	DS:DX Points to asciz name
 17320                                  ; Function:
 17321                                  ;	Make a new directory
 17322                                  ; Returns:
 17323                                  ;	STD XENIX Return
 17324                                  ;	AX = mkdir_path_not_found if path bad
 17325                                  ;	AX = mkdir_access_denied  If
 17326                                  ;		Directory cannot be created
 17327                                  ;		Node already exists
 17328                                  ;		Device name given
 17329                                  ;		Disk or directory(root) full
 17330                                  ;---------------------------------------------------------------------------
 17331                                  
 17332                                  	; 10/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 17333                                  
 17334                                  	; 25/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 17335                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:67B0h
 17336                                  
 17337                                  _$MKDIR:
 17338                                  	;MOV	SI,DOS_MKDIR
 17339                                  	;;;
 17340                                  	; 25/01/2024 (PCDOS 7.1 IBMDOS.COM)
 17341 000027BE 36C606[1011]43          	mov	byte [ss:PATHNAMELEN],67 ; Retro DOS v5.0
 17342                                  	;mov	word [ss:PATHNAMELEN],67 ; DIRSTRLEN (standard length = 67)
 17343                                  mkdir_x:	; (windows) extended length (128)
 17344 000027C4 BE[0138]                	mov	si,DOS_MKDIR
 17345                                  	;;;
 17346                                  DoDirCall:
 17347 000027C7 BF[BE03]                	MOV	DI,OPENBUF		; spot for translated name
 17348                                  
 17349 000027CA 56                      	push	si
 17350 000027CB 89D6                    	MOV	SI,DX			; get source
 17351 000027CD E81351                  	call	TransPath		; go munge the path
 17352 000027D0 5E                      	pop	si
 17353 000027D1 7305                    	JNC	short MkDirCrack	; no errors, try path
 17354                                  MkErrP:
 17355 000027D3 B003                    	MOV	AL,error_path_not_found	; oops!
 17356                                  MkErr:
 17357 000027D5 E99DDE                  	jmp	SYS_RET_ERR
 17358                                  MkDirCrack:
 17359 000027D8 36803E[7A05]FF          	CMP	byte [SS:CMETA],-1
 17360 000027DE 75F3                    	JNZ	short MkErrP
 17361                                  
 17362                                  	; MSDOS 3.3
 17363                                  	;push	ss
 17364                                  	;pop	ds
 17365                                  	;call	si
 17366                                  	;jb	short MkErr
 17367                                  	;;jmp	short mkdir_ok
 17368                                  	;jmp	SYS_RET_OK
 17369                                  
 17370                                  	; MSDOS 6.0
 17371 000027E0 56                      	PUSH	SI			;PTM.			;AN000;
 17372                                  		; 25/01/2024 (PCDOS 7.1 IBMDOS.COM)
 17373                                  		; check path len > [PATNAMELEN] ; 67 or 128
 17374 000027E1 E80D00                  	CALL	Check_PathLen		;PTM. check path len > 67 ? ;AN000;
 17375 000027E4 5E                      	POP	SI			;PTM.			;AN000;
 17376 000027E5 7604                    	JBE	short pathok		;PTM.			;AN000;
 17377                                  	;mov	al,5
 17378 000027E7 B005                    	MOV	AL,error_access_denied	;PTM. ops!
 17379                                  	;jmp	SYS_RET_ERR		;PTM.
 17380 000027E9 EBEA                    	jmp	short MkErr
 17381                                  pathok:
 17382 000027EB FFD6                    	CALL	SI			; go get file
 17383 000027ED 72E6                    	JC	short MkErr		; error
 17384                                  	; 16/12/2022
 17385                                  	; 10/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 17386 000027EF EBCA                    	jmp	short mkdir_ok		; ok
 17387                                  	;jmp	SYS_RET_OK
 17388                                  
 17389                                  ;----------------------------------------------------------------------------
 17390                                  ;
 17391                                  ; Procedure Name : Check_PathLen
 17392                                  ;
 17393                                  ; Inputs:
 17394                                  ;	nothing
 17395                                  ; Function:
 17396                                  ;	check if final path length greater than 67
 17397                                  ; Returns:
 17398                                  ;	Above flag set if > 67
 17399                                  ;
 17400                                  ;---------------------------------------------------------------------------
 17401                                  
 17402                                  	; 25/01/2024 - Retro DOS v5.0
 17403                                  	; (PCDOS 7.1 IBMDOS.COM)
 17404                                  
 17405                                  Check_PathLen:
 17406                                  	; 09/09/2018
 17407                                  	;mov	SI,[WFP_START]
 17408 000027F1 368B36[B205]            	MOV	SI,[SS:WFP_START] ; MSDOS 6.0
 17409                                  Check_PathLen2:
 17410                                  	; 25/01/2024 - Retro DOS v5.0
 17411                                  	; Note: dx is not changed in 'Check_PathLen';
 17412                                  	;	no need to push/pop (*)
 17413                                  	;
 17414 000027F6 16                      	push	ss
 17415 000027F7 1F                      	pop	ds
 17416                                  	;mov	SI,[WFP_START]	  ; MSDOS 3.3
 17417 000027F8 51                      	push	CX
 17418                                  	; (PCDOS 7.1 IBMDOS.COM)
 17419                                  	;push	dx ; 25/01/2024	(*)
 17420 000027F9 E8B8EF                  	CALL	DStrLen
 17421                                  	; (PCDOS 7.1 IBMDOS.COM)
 17422 000027FC 3B0E[1011]              	cmp	cx,[PATHNAMELEN] ; 67 or 128
 17423                                  	;CMP	CX,DIRSTRLEN ; 67
 17424                                  	;pop	dx
 17425 00002800 59                      	POP	CX
 17426 00002801 C3                      	retn
 17427                                  
 17428                                  ;============================================================================
 17429                                  ; IOCTL.ASM, MSDOS 6.0, 1991
 17430                                  ;============================================================================
 17431                                  ; 07/08/2018 - Retro DOS v3.0
 17432                                  ; 17/05/2019 - Retro DOS v4.0
 17433                                  
 17434                                  ;**	IOCTL system call.
 17435                                  ;----------------------------------------------------------------------------
 17436                                  ;	$IOCTL
 17437                                  ;
 17438                                  ;	  Revision history:
 17439                                  ;
 17440                                  ;		Created: ARR 4 April 1983
 17441                                  ;
 17442                                  ;		GenericIOCTL added:		KGS	22 April 1985
 17443                                  ;
 17444                                  ;		A000	version 4.00	Jan. 1988
 17445                                  ;
 17446                                  ;		Used jump table to dispatch IOCTL functions. HKN 3/12/90
 17447                                  ;
 17448                                  
 17449                                  ;BREAK <IOCTL - munge on a handle to do device specific stuff>
 17450                                  ;---------------------------------------------------------------------------
 17451                                  ;
 17452                                  ;   Assembler usage:
 17453                                  ;	    MOV     BX, Handle
 17454                                  ;	    MOV     DX, Data
 17455                                  ;
 17456                                  ;	(or LDS     DX,BUF
 17457                                  ;	    MOV     CX,COUNT)
 17458                                  ;
 17459                                  ;	    MOV     AH, Ioctl
 17460                                  ;	    MOV     AL, Request
 17461                                  ;	    INT     21h
 17462                                  ;
 17463                                  ;   AH = 0  Return a combination of low byte of sf_flags and device driver
 17464                                  ;	    attribute word in DX, handle in BX:
 17465                                  ;	    DH = high word of device driver attributes
 17466                                  ;	    DL = low byte of sf_flags
 17467                                  ;	 1  Set the bits contained in DX to sf_flags.  DH MUST be 0.  Handle
 17468                                  ;	    in BX.
 17469                                  ;	 2  Read CX bytes from the device control channel for handle in BX
 17470                                  ;	    into DS:DX.  Return number read in AX.
 17471                                  ;	 3  Write CX bytes to the device control channel for handle in BX from
 17472                                  ;	    DS:DX.  Return bytes written in AX.
 17473                                  ;	 4  Read CX bytes from the device control channel for drive in BX
 17474                                  ;	    into DS:DX.  Return number read in AX.
 17475                                  ;	 5  Write CX bytes to the device control channel for drive in BX from
 17476                                  ;	    DS:DX.  Return bytes written in AX.
 17477                                  ;	 6  Return input status of handle in BX. If a read will go to the
 17478                                  ;	    device, AL = 0FFh, otherwise 0.
 17479                                  ;	 7  Return output status of handle in BX. If a write will go to the
 17480                                  ;	    device, AL = 0FFh, otherwise 0.
 17481                                  ;	 8  Given a drive in BX, return 1 if the device contains non-
 17482                                  ;	    removable media, 0 otherwise.
 17483                                  ;	 9  Return the contents of the device attribute word in DX for the
 17484                                  ;	    drive in BX.  0200h is the bit for shared.	1000h is the bit for
 17485                                  ;	    network. 8000h is the bit for local use.
 17486                                  ;	 A  Return 8000h if the handle in BX is for the network or not.
 17487                                  ;	 B  Change the retry delay and the retry count for the system. BX is
 17488                                  ;	    the count and CX is the delay.
 17489                                  ;
 17490                                  ;   Error returns:
 17491                                  ;	    AX = error_invalid_handle
 17492                                  ;	       = error_invalid_function
 17493                                  ;	       = error_invalid_data
 17494                                  ;
 17495                                  ;-------------------------------------------------------------------------------
 17496                                  ;
 17497                                  ;   This is the documentation copied from DOS 4.0 it is much better
 17498                                  ;   than the above
 17499                                  ;
 17500                                  ;	There are several basic forms of IOCTL calls:
 17501                                  ;
 17502                                  ;
 17503                                  ;	** Get/Set device information:	**
 17504                                  ;
 17505                                  ;	ENTRY	(AL) = function code
 17506                                  ;		  0 - Get device information
 17507                                  ;		  1 - Set device information
 17508                                  ;		(BX) = file handle
 17509                                  ;		(DX) = info for "Set Device Information"
 17510                                  ;	EXIT	'C' set if error
 17511                                  ;		  (AX) = error code
 17512                                  ;		'C' clear if OK
 17513                                  ;		  (DX) = info for "Get Device Information"
 17514                                  ;	USES	ALL
 17515                                  ;
 17516                                  ;
 17517                                  ;	**  Read/Write Control Data From/To Handle  **
 17518                                  ;
 17519                                  ;	ENTRY	(AL) = function code
 17520                                  ;		  2 - Read device control info
 17521                                  ;		  3 - Write device control info
 17522                                  ;		(BX) = file handle
 17523                                  ;		(CX) = transfer count
 17524                                  ;		(DS:DX) = address for data
 17525                                  ;	EXIT	'C' set if error
 17526                                  ;		  (AX) = error code
 17527                                  ;		'C' clear if OK
 17528                                  ;		  (AX) = count of bytes transfered
 17529                                  ;	USES	ALL
 17530                                  ;
 17531                                  ;
 17532                                  ;	**  Read/Write Control Data From/To Block Device  **
 17533                                  ;
 17534                                  ;	ENTRY	(AL) = function code
 17535                                  ;		  4 - Read device control info
 17536                                  ;		  5 - Write device control info
 17537                                  ;		(BL) = Drive number (0=default, 1='A', 2='B', etc)
 17538                                  ;		(CX) = transfer count
 17539                                  ;		(DS:DX) = address for data
 17540                                  ;	EXIT	'C' set if error
 17541                                  ;		  (AX) = error code
 17542                                  ;		'C' clear if OK
 17543                                  ;		  (AX) = count of bytes transfered
 17544                                  ;	USES	ALL
 17545                                  ;
 17546                                  ;
 17547                                  ;	**  Get Input/Output Status  **
 17548                                  ;
 17549                                  ;	ENTRY	(AL) = function code
 17550                                  ;		  6 - Get Input status
 17551                                  ;		  7 - Get Output Status
 17552                                  ;		(BX) = file handle
 17553                                  ;	EXIT	'C' set if error
 17554                                  ;		  (AX) = error code
 17555                                  ;		'C' clear if OK
 17556                                  ;		  (AL) = 00 if not ready
 17557                                  ;		  (AL) = FF if ready
 17558                                  ;	USES	ALL
 17559                                  ;
 17560                                  ;
 17561                                  ;	**  Get Drive Information  **
 17562                                  ;
 17563                                  ;	ENTRY	(AL) = function code
 17564                                  ;		  8 - Check for removable media
 17565                                  ;		  9 - Get device attributes
 17566                                  ;		(BL) = Drive number (0=default, 1='A', 2='B', etc)
 17567                                  ;	EXIT	'C' set if error
 17568                                  ;		  (AX) = error code
 17569                                  ;		'C' clear if OK
 17570                                  ;		  (AX) = 0/1 media is removable/fixed (func. 8)
 17571                                  ;		  (DX) = device attribute word (func. 9)
 17572                                  ;	USES	ALL
 17573                                  ;
 17574                                  ;
 17575                                  ;	**  Get Redirected bit	**
 17576                                  ;
 17577                                  ;	ENTRY	(AL) = function code
 17578                                  ;		  0Ah - Network stuff
 17579                                  ;		(BX) = file handle
 17580                                  ;	EXIT	'C' set if error
 17581                                  ;		  (AX) = error code
 17582                                  ;		'C' clear if OK
 17583                                  ;		  (DX) = SFT flags word, 8000h set if network file
 17584                                  ;	USES	ALL
 17585                                  ;
 17586                                  ;
 17587                                  ;	**  Change sharer retry parameters  **
 17588                                  ;
 17589                                  ;	ENTRY	(AL) = function code
 17590                                  ;		  0Bh - Set retry parameters
 17591                                  ;		(CX) = retry loop count
 17592                                  ;		(DX) = number of retries
 17593                                  ;	EXIT	'C' set if error
 17594                                  ;		  (AX) = error code
 17595                                  ;		'C' clear if OK
 17596                                  ;	USES	ALL
 17597                                  ;
 17598                                  ;
 17599                                  ;   =================================================================
 17600                                  ;
 17601                                  ;	**  New Standard Control  **
 17602                                  ;
 17603                                  ;	ALL NEW IOCTL FACILITIES SHOULD USE THIS FORM.	THE OTHER
 17604                                  ;	FORMS ARE OBSOLETE.
 17605                                  ;
 17606                                  ;   =================================================================
 17607                                  ;
 17608                                  ;	ENTRY	(AL) = function code
 17609                                  ;		  0Ch - Control Function subcode
 17610                                  ;		(BX) = File Handle
 17611                                  ;		(CH) = Category Indicator
 17612                                  ;		(CL) = Function within category
 17613                                  ;		(DS:DX) = address for data, if any
 17614                                  ;		(SI) = Passed to device as argument, use depends upon function
 17615                                  ;		(DI) = Passed to device as argument, use depends upon function
 17616                                  ;	EXIT	'C' set if error
 17617                                  ;		  (AX) = error code
 17618                                  ;		'C' clear if OK
 17619                                  ;		  (SI) = Return value, meaning is function dependent
 17620                                  ;		  (DI) = Return value, meaning is function dependent
 17621                                  ;		  (DS:DX) = Return address, use is function dependent
 17622                                  ;	USES	ALL
 17623                                  ;
 17624                                  ;    ============== Generic IOCTL Definitions for DOS 3.2 ============
 17625                                  ;     (See inc\ioctl.inc for more info)
 17626                                  ;
 17627                                  ;	ENTRY	(AL) = function code
 17628                                  ;		  0Dh - Control Function subcode
 17629                                  ;		(BL) = Drive Number (0 = Default, 1= 'A')
 17630                                  ;		(CH) = Category Indicator
 17631                                  ;		(CL) = Function within category
 17632                                  ;		(DS:DX) = address for data, if any
 17633                                  ;		(SI) = Passed to device as argument, use depends upon function
 17634                                  ;		(DI) = Passed to device as argument, use depends upon function
 17635                                  ;
 17636                                  ;	EXIT	'C' set if error
 17637                                  ;		  (AX) = error code
 17638                                  ;		'C' clear if OK
 17639                                  ;		  (DS:DX) = Return address, use is function dependent
 17640                                  ;	USES	ALL
 17641                                  ;
 17642                                  ;---------------------------------------------------------------------------
 17643                                  	
 17644                                  	; 17/05/2019 - Retro DOS v4.0
 17645                                  	; DOSCODE:611Eh (MSDOS 6.21, MSDOS.SYS)
 17646                                  
 17647                                  	; 11/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 17648                                  	; DOSCODE:610Ah (MSDOS 5.0, MSDOS.SYS)
 17649                                  
 17650                                  	; 14/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 17651                                  	; DOSCODE:67F7h (PCDOS 7.1, IBMDOS.COM)
 17652                                  
 17653                                  IOCTLJMPTABLE:	;label	word
 17654                                  	; MSDOS 3.3 (& MSDOS 6.0)
 17655 00002802 [3E28]                  	dw	ioctl_getset_data	; 0
 17656 00002804 [3E28]                  	dw	ioctl_getset_data   	; 1
 17657 00002806 [8828]                  	dw	ioctl_control_string	; 2
 17658 00002808 [8828]                  	dw	ioctl_control_string	; 3
 17659 0000280A [202A]                  	dw	ioctl_get_dev		; 4
 17660 0000280C [202A]                  	dw	ioctl_get_dev		; 5
 17661 0000280E [A028]                  	dw	ioctl_status		; 6
 17662 00002810 [A028]                  	dw	ioctl_status		; 7
 17663 00002812 [7A29]                  	dw	ioctl_rem_media		; 8
 17664 00002814 [C329]                  	dw	ioctl_drive_attr	; 9
 17665 00002816 [122A]                  	dw	ioctl_handle_redir	; A
 17666 00002818 [B529]                  	dw	Set_Retry_Parameters	; B
 17667 0000281A [BC28]                  	dw	GENERICIOCTLHANDLE	; C
 17668 0000281C [D628]                  	dw	GENERICIOCTL		; D
 17669                                  	; MSDOS 6.0 (& MSDOS 3.3)
 17670 0000281E [C12A]                  	dw	ioctl_drive_owner	; E
 17671 00002820 [C12A]                  	dw	ioctl_drive_owner	; F
 17672                                  	; MSDOS 6.0
 17673 00002822 [BC28]                  	dw	query_handle_support	; 10h
 17674 00002824 [D628]                  	dw	query_device_support	; 11h
 17675                                  
 17676                                  	; 11/11/2022
 17677                                  _$IOCTL:
 17678 00002826 8CDE                    	MOV	SI,DS			; Stash DS for calls 2,3,4 and 5
 17679 00002828 16                      	push	ss
 17680 00002829 1F                      	pop	ds			;hkn; SS is DOSDATA
 17681                                  
 17682                                  	; MSDOS 3.3
 17683                                  	;cmp	al,0Fh 
 17684                                  	; MSDOS 6.0
 17685 0000282A 3C11                    	cmp	al,11h			; al must be between 0 & 11h
 17686 0000282C 770D                    	ja	short ioctl_bad_funj2	; if not bad function #
 17687                                  
 17688                                  	; 14/01/2024
 17689                                  	; 28/05/2019
 17690                                  	;push	AX	; 14/01/2024	; Need to save AL for generic IOCTL
 17691 0000282E 89C7                    	mov	di,ax			; di NOT a PARM
 17692 00002830 81E7FF00                	and	di,0FFh			; di = al
 17693 00002834 D1E7                    	shl	di,1			; di = index into jmp table
 17694                                  	;pop	AX			; Restore AL for generic IOCTL
 17695                                  
 17696 00002836 2EFFA5[0228]            	jmp	word [CS:DI+IOCTLJMPTABLE]
 17697                                  
 17698                                  ioctl_bad_funj2:
 17699 0000283B E90401                  	JMP	ioctl_bad_fun  ; 10/08/2018
 17700                                  
 17701                                  ;--------------------------------------------------------------------------
 17702                                  ;
 17703                                  ; IOCTL: AL = 0,1
 17704                                  ;
 17705                                  ; ENTRY: DS = DOSDATA
 17706                                  ;
 17707                                  ;--------------------------------------------------------------------------
 17708                                  
 17709                                  	; 29/01/2024 - Retro DOS v5.0
 17710                                  ioctl_getset_data:
 17711                                  	; MSDOS 6.0
 17712 0000283E E8174B                  	call	SFFromHandle		; ES:DI -> SFT
 17713 00002841 7305                    	JNC	short ioctl_check_permissions ; have valid handle
 17714                                  ioctl_bad_handle:
 17715                                  	;mov	al,6
 17716 00002843 B006                    	mov	al,error_invalid_handle
 17717                                  ioctl_error:
 17718 00002845 E92DDE                  	jmp	SYS_RET_ERR
 17719                                  
 17720                                  ioctl_check_permissions:
 17721 00002848 3C00                    	CMP	AL,0
 17722                                  	;mov	al,[es:di+5]
 17723 0000284A 268A4505                	MOV	AL,[ES:DI+SF_ENTRY.sf_flags]; Get low byte of flags
 17724 0000284E 7419                    	JZ	short ioctl_read	; read the byte
 17725                                  
 17726 00002850 08F6                    	or	dh,dh
 17727 00002852 7404                    	JZ	short ioctl_check_device ; can I set with this data?
 17728                                  	;mov	al,0Dh
 17729 00002854 B00D                    	mov	al,error_invalid_data	; no DH <> 0
 17730                                  	;jmp	SYS_RET_ERR
 17731 00002856 EBED                    	jmp	short ioctl_error
 17732                                  
 17733                                  ioctl_check_device:
 17734 00002858 A880                    	test	AL,devid_device  ; 80h	; can I set this handle?
 17735 0000285A 74DF                    	jz	short ioctl_bad_funj2
 17736 0000285C 80CA80                  	OR	DL,devid_device 	; Make sure user doesn't turn off the
 17737                                  					;   device bit!! He can muck with the
 17738                                  					;   others at will.
 17739                                  	;MOV	byte [EXTERR_LOCUS],errLOC_SerDev ; 4
 17740                                  	; 29/01/2024
 17741                                  	;;;
 17742 0000285F E866EA                  	call	set_exerr_locus_ser ; (PCDOS 7.1 IBMDOS.COM)
 17743                                  	;;;
 17744 00002862 26885505                	MOV	BYTE [ES:DI+SF_ENTRY.sf_flags],DL  ;AC000;MS.; Set flags
 17745                                  ioctl_ok:
 17746 00002866 E902DE                  	jmp	SYS_RET_OK
 17747                                  
 17748                                  ioctl_read:
 17749                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Disk  ; 2
 17750                                  	; 29/01/2024
 17751                                  	;;;
 17752 00002869 E857EA                  	call	set_exerr_locus_disk ; (PCDOS 7.1 IBMDOS.COM)
 17753                                  	;;;
 17754 0000286C 30E4                    	XOR	AH,AH
 17755 0000286E A880                    	test	AL,devid_device 	; Should I set high byte
 17756 00002870 740B                    	JZ	short ioctl_no_high	; no
 17757                                  	;MOV	byte [EXTERR_LOCUS],errLOC_SerDev ; 4
 17758                                  	; 29/01/2024
 17759                                  	;;;
 17760 00002872 E853EA                  	call	set_exerr_locus_ser ; (PCDOS 7.1 IBMDOS.COM)
 17761                                  	;;;
 17762                                  	;les	di,[es:di+7]
 17763 00002875 26C47D07                	LES	DI,[ES:DI+SF_ENTRY.sf_devptr] ; Get device pointer
 17764                                  	;mov	ah,[es:di+5]
 17765 00002879 268A6505                	MOV	AH,[ES:DI+SYSDEV.ATT+1] ; Get high byte
 17766                                  ioctl_no_high:
 17767 0000287D 89C2                    	MOV	DX,AX
 17768                                  ioctl_set_dx:	; 16/12/2022
 17769 0000287F E8F5DB                  	call	Get_User_Stack
 17770                                  	;mov	[si+6],dx
 17771 00002882 895406                  	MOV	[SI+user_env.user_DX],DX
 17772                                  	;;jmp	SYS_RET_OK
 17773                                  	; 11/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 17774                                  ioctl_ok_j:
 17775                                  	; 16/12/2022
 17776 00002885 E9E6DD                  	jmp	SYS_RET_OK_clc	 ; (after 'Get_User_Stack') 
 17777                                  	;jmp	short ioctl_ok
 17778                                  	; 26/07/2019
 17779                                  	;jmp	SYS_RET_OK_clc
 17780                                  
 17781                                  ;--------------------------------------------------------------------------
 17782                                  ;
 17783                                  ; IOCTL: AL = 2,3
 17784                                  ;
 17785                                  ; ENTRY: DS = DOSDATA
 17786                                  ;	 SI = user's DS
 17787                                  ;
 17788                                  ;--------------------------------------------------------------------------
 17789                                  
 17790                                  	; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 17791                                  ioctl_control_string:
 17792 00002888 E8CD4A                  	call	SFFromHandle		; ES:DI -> SFT
 17793 0000288B 72B6                    	JC	short ioctl_bad_handle	; invalid handle
 17794                                  	; 07/12/2022
 17795                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device ; can I?
 17796                                  	;jz	short ioctl_bad_funj2			; No it is a file
 17797                                  	; MSDOS 5.0 & MSDOS 6.0
 17798 0000288D 26F6450580              	test	byte [ES:DI+SF_ENTRY.sf_flags],devid_device ; can I?
 17799 00002892 74A7                    	jz	short ioctl_bad_funj2			; No it is a file
 17800                                  	;MOV	byte [EXTERR_LOCUS],errLOC_SerDev ; 4
 17801                                  	; 29/01/2024
 17802                                  	;;;
 17803 00002894 E831EA                  	call	set_exerr_locus_ser ; (PCDOS 7.1 IBMDOS.COM)
 17804                                  	;;;
 17805 00002897 26C47D07                	LES	DI,[ES:DI+SF_ENTRY.sf_devptr] ; Get device pointer
 17806 0000289B 30DB                    	XOR	BL,BL			; Unit number of char dev = 0
 17807 0000289D E98801                  	JMP	ioctl_do_string
 17808                                  
 17809                                  ;--------------------------------------------------------------------------
 17810                                  ;
 17811                                  ; IOCTL: AL = 6,7
 17812                                  ;
 17813                                  ; ENTRY: DS = DOSDATA
 17814                                  ;
 17815                                  ;--------------------------------------------------------------------------
 17816                                  
 17817                                  ioctl_status:
 17818 000028A0 B401                    	MOV	AH,1
 17819 000028A2 2C06                    	SUB	AL,6			; 6=0,7=1
 17820 000028A4 7402                    	JZ	short ioctl_get_status
 17821 000028A6 B403                    	MOV	AH,3
 17822                                  ioctl_get_status:
 17823 000028A8 50                      	PUSH	AX
 17824 000028A9 E8EE14                  	call	GET_IO_SFT
 17825 000028AC 58                      	POP	AX
 17826                                  	;JNC	short DO_IOFUNC
 17827                                  	;JMP	short ioctl_bad_handle	; invalid SFT
 17828                                  	; 16/12/2022
 17829 000028AD 7294                    	jc	short ioctl_bad_handle
 17830                                  DO_IOFUNC:
 17831 000028AF E8F924                  	call	IOFUNC
 17832 000028B2 88C4                    	MOV	AH,AL
 17833 000028B4 B0FF                    	MOV	AL,0FFH
 17834                                  	;JNZ	short ioctl_status_ret
 17835                                  	; 29/01/2024
 17836 000028B6 75AE                    	jnz	short ioctl_ok
 17837 000028B8 FEC0                    	INC	AL
 17838                                  ioctl_status_ret:
 17839                                  	;jmp	SYS_RET_OK
 17840                                  	; 11/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 17841                                  	;jmp	short ioctl_ok_j
 17842                                  	; 16/12/2022
 17843 000028BA EBAA                    	jmp	short ioctl_ok
 17844                                  
 17845                                  ;--------------------------------------------------------------------------
 17846                                  ;
 17847                                  ; Generic IOCTL entry point. AL = C, D, 10h, 11h
 17848                                  ;
 17849                                  ;	here we invoke the Generic IOCTL using the IOCTL_Req structure.
 17850                                  ;	SI:DX -> Users Device Parameter Table
 17851                                  ;	IOCALL -> IOCTL_Req structure
 17852                                  ;
 17853                                  ; 	If on entry AL >= IOCTL_QUERY_HANDLE the function is a
 17854                                  ;	QueryIOCtlSupport call ELSE it's a standard generic IOCtl
 17855                                  ;	call.
 17856                                  ;
 17857                                  ; BUGBUG: Don't push anything on the stack between GENERIOCTL: and 
 17858                                  ;         the call to Check_If_Net because Check_If_Net gets our
 17859                                  ;         return address off the stack if the drive is invalid.
 17860                                  ;
 17861                                  ;--------------------------------------------------------------------------
 17862                                  
 17863                                  	; 29/01/2024 - Retro DOS v5.0
 17864                                  
 17865                                  query_handle_support:	; Entry point for handles
 17866                                  GENERICIOCTLHANDLE:
 17867 000028BC E8994A                  	call	SFFromHandle		; Get SFT for device.
 17868 000028BF 727E                    	jc	short ioctl_bad_handlej
 17869                                  
 17870                                  	;test	word [es:di+5],8000h
 17871                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet	; M031;
 17872                                  	;test	byte [es:di+6],80h
 17873 000028C1 26F6450680              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 17874 000028C6 757A                    	jnz	short ioctl_bad_fun	; Cannot do this over net.
 17875                                  
 17876                                  	;mov	byte [EXTERR_LOCUS],errLOC_SerDev ; 4
 17877                                  	; 29/01/2024
 17878                                  	;;;
 17879 000028C8 E8FDE9                  	call	set_exerr_locus_ser ; (PCDOS 7.1 IBMDOS.COM)
 17880                                  	;;;
 17881                                  
 17882                                  	;les	di,[es:di+7]
 17883 000028CB 26C47D07                	les	di,[es:di+SF_ENTRY.sf_devptr]	; Get pointer to device.
 17884                                  	;;;
 17885                                  	; 29/01/2024 - PCDOS 7.1 IBMDOS.COM
 17886 000028CF C606[B103]FF            	mov	byte [IOCTL_drvnum],0FFh	; invalidate drive number
 17887                                  					; (for extended -lock/unlock- functions)
 17888                                  	;;;
 17889 000028D4 EB16                    	jmp	short Do_GenIOCTL
 17890                                  
 17891                                  	; 29/01/2024 - Retro DOS v5.0
 17892                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:68DAh
 17893                                  	; (WINME IO.SYS - BIOSCODE:6612h)
 17894                                  
 17895                                  query_device_support:	; Entry point for devices:
 17896                                  GENERICIOCTL:
 17897                                  	;mov	byte [EXTERR_LOCUS],errLOC_Disk ; 2
 17898                                  	; 29/01/2024
 17899                                  	;;;
 17900 000028D6 E8EAE9                  	call	set_exerr_locus_disk
 17901 000028D9 80FD48                  	cmp	ch,48h			; category (extended, disk lock/unlock)
 17902 000028DC 7405                    	je      short GenIOCTL_chk_net	; extended (MSDOS/PCDOS 7)
 17903                                  	;;;
 17904                                  
 17905 000028DE 80FD08                  	cmp	ch,IOC_DC ; 8		; Only disk devices are allowed to use
 17906 000028E1 755F                    	jne	short ioctl_bad_fun	; no handles with Generic IOCTL.
 17907                                  
 17908                                  	; 29/01/2024 
 17909                                  	;;;
 17910                                  GenIOCTL_chk_net:
 17911 000028E3 881E[B103]              	mov	[IOCTL_drvnum],bl	; drive number
 17912                                  	;;;
 17913                                  
 17914 000028E7 E8C801                  	CALL	Check_If_Net		; ES:DI := Get_hdr_block of device in BL
 17915 000028EA 7556                    	JNZ	short ioctl_bad_fun	; There are no "net devices", and they
 17916                                  
 17917                                  Do_GenIOCTL:
 17918                                  	; 29/01/2024 - Retro DOS v5.0 
 17919                                  	;;;
 17920 000028EC 80FD48                  	cmp	ch,48h			; category code 48h for FAT32
 17921 000028EF 7456                    	je	short GenIOCTL_extended ; MSDOS/PCDOS 7 functions (lock/unlock)
 17922                                  	;cmp	ch,8
 17923 000028F1 80FD08                  	cmp	ch,IOC_DC ; 8          	; disk control
 17924 000028F4 7451                    	je	short GenIOCTL_extended
 17925                                  GenIOCTL_normal:			; MSDOS 5-6.22 functions
 17926                                  	;;;
 17927                                  
 17928                                  	;TEST	word [ES:DI+SYSDEV.ATT],DEV320 
 17929                                  					; Can device handle Generic IOCTL funcs
 17930                                  	; 09/09/2018
 17931                                  	;test	byte [es:di+4],40h
 17932 000028F6 26F6450440              	TEST	byte [ES:DI+SYSDEV.ATT],DEV320 ; 0040h
 17933 000028FB 7445                    	jz	short ioctl_bad_fun
 17934                                  
 17935                                  	; 17/05/2019 - Retro DOS v4.0
 17936                                  
 17937                                  	; MSDOS 6.0
 17938                                  	;mov	byte [IOCALL_REQFUNC],19 ; 13h
 17939 000028FD C606[7E03]13            	mov	byte [IOCALL_REQFUNC],GENIOCTL ; Assume real Request
 17940                                  	;cmp	al,10h
 17941 00002902 3C10                    	cmp	AL,IOCTL_QUERY_HANDLE	; See if this is just a query
 17942 00002904 7C0C                    	jl	short SetIOCtlBlock
 17943                                  	
 17944                                  	;TEST	word [ES:DI+SYSDEV.ATT],IOQUERY ; See if device supports a query
 17945                                  	;test	byte [es:di+4],80h 
 17946 00002906 26F6450480              	TEST	byte [ES:DI+SYSDEV.ATT],IOQUERY ; See if device supports a query
 17947 0000290B 7435                    	jz	short ioctl_bad_fun	; No support for query 
 17948                                  	;
 17949                                  	;mov	byte [IOCALL_REQFUNC],19h	
 17950 0000290D C606[7E03]19            	mov	byte [IOCALL_REQFUNC],IOCTL_QUERY ; Just a query (5.00)
 17951                                  
 17952                                  SetIOCtlBlock:
 17953 00002912 06                      	PUSH	ES			; DEVIOCALL2 expects Device header block
 17954 00002913 57                      	PUSH	DI			; in DS:SI
 17955                                  					; Setup Generic IOCTL Request Block
 17956                                  	;mov	byte [IOCALL_REQLEN],23
 17957 00002914 C606[7C03]17            	mov	byte [IOCALL_REQLEN],IOCTL_REQ.size
 17958                                  	; 07/09/2018 (MSDOS 3.3)
 17959                                  	;;mov	byte [IOCALL_REQFUNC],19
 17960                                  	;mov	byte [IOCALL_REQFUNC],GENIOCTL ; 07/09/2018
 17961                                  	;
 17962 00002919 881E[7D03]              	MOV	[IOCALL_REQUNIT],BL
 17963 0000291D 882E[8903]              	MOV	[IOCALL+IOCTL_REQ.MAJORFUNCTION],CH
 17964 00002921 880E[8A03]              	MOV	[IOCALL+IOCTL_REQ.MINORFUNCTION],CL
 17965 00002925 8936[8B03]              	MOV	[IOCALL+IOCTL_REQ.REG_SI],SI
 17966 00002929 893E[8D03]              	MOV	[IOCALL+IOCTL_REQ.REG_DI],DI
 17967 0000292D 8916[8F03]              	MOV	[IOCALL+IOCTL_REQ.GENERICIOCTL_PACKET],DX
 17968 00002931 8936[9103]              	MOV	[IOCALL+IOCTL_REQ.GENERICIOCTL_PACKET+2],SI
 17969                                  
 17970                                  ;hkn; IOCALL is in DOSDATA
 17971 00002935 BB[7C03]                	MOV	BX,IOCALL
 17972                                  
 17973 00002938 16                      	PUSH	SS
 17974 00002939 07                      	POP	ES
 17975                                  					; DS:SI -> Device header.
 17976 0000293A 5E                      	POP	SI
 17977 0000293B 1F                      	POP	DS
 17978                                  	; 10/08/2018
 17979 0000293C E92201                  	jmp	ioctl_do_IO		; Perform Call to device driver
 17980                                  	
 17981                                  ioctl_bad_handlej:
 17982 0000293F E901FF                  	jmp	ioctl_bad_handle
 17983                                  
 17984                                  	; 29/01/2024
 17985                                  ioctl_bad_fun:
 17986 00002942 B001                    	mov	al, error_invalid_function  ; 1
 17987 00002944 E92EDD                  	jmp	SYS_RET_ERR	
 17988                                  
 17989                                  	; 29/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 17990                                  GenIOCTL_extended:
 17991 00002947 80F96A                  	cmp	cl,6Ah			; UNLOCK LOGICAL VOLUME
 17992                                  	;je	short GenIOCTL_chk_lock
 17993 0000294A 740E                    	je	short GenIOCTL_lock_unlock
 17994 0000294C 80F94A                  	cmp	cl,4Ah			; LOCK LOGICAL VOLUME
 17995 0000294F 75A5                    	jne	short GenIOCTL_normal
 17996                                  ;GenIOCTL_chk_lock:
 17997                                  	;cmp	cl,4Ah			; LOCK LOGICAL VOLUME
 17998                                  	;jne	short GenIOCTL_lock_unlock
 17999 00002951 80FF04                  	cmp	bh,4			; lock level (0-4)
 18000 00002954 7404                    	je	short GenIOCTL_lock_unlock
 18001 00002956 08FF                    	or	bh,bh
 18002 00002958 75E8                    	jnz	short ioctl_bad_fun
 18003                                  GenIOCTL_lock_unlock:
 18004 0000295A 8A1E[B103]              	mov	bl,[IOCTL_drvnum]	; drive number (1=A:, 2=B: ..)
 18005 0000295E 30FF                    	xor	bh,bh
 18006 00002960 4B                      	dec	bx
 18007 00002961 80FB1A                  	cmp	bl,26			; logical disk number limit
 18008 00002964 73DC                    	jnb	short ioctl_bad_fun
 18009 00002966 80F96A                  	cmp	cl,6Ah			; UNLOCK LOGICAL VOLUME
 18010 00002969 7507                    	jne	short GenIOCTL_lock
 18011 0000296B 80A7[1412]7F            	and	byte [bx+drive_flags],7Fh ; UNLOCK
 18012 00002970 EB05                    	jmp	short GenIOCTL_OK
 18013                                  GenIOCTL_lock:
 18014 00002972 808F[1412]80            	or	byte [bx+drive_flags],80h ; LOCK
 18015                                  GenIOCTL_OK:
 18016 00002977 E9F1DC                  	jmp	SYS_RET_OK
 18017                                  
 18018                                  ;---------------------------------------------------------------------------
 18019                                  ;
 18020                                  ; IOCTL: AL = 8
 18021                                  ;
 18022                                  ; ENTRY: DS = DOSDATA
 18023                                  ;
 18024                                  ; BUGBUG: Don't push anything on the stack between ioctl_rem_media: and 
 18025                                  ;         the call to Check_If_Net because Check_If_Net gets our
 18026                                  ;         return address off the stack if the drive is invalid.
 18027                                  ;
 18028                                  ;-------------------------------------------------------------------------
 18029                                  
 18030                                  	; 30/01/2024
 18031                                  ioctl_rem_media:
 18032                                  	; MSDOS 3.3 (& MSDOS 6.0)
 18033 0000297A E83501                  	CALL	Check_If_Net
 18034 0000297D 75C3                    	JNZ	short ioctl_bad_fun	; There are no "net devices", and they
 18035                                  					;   certainly don't know how to do this
 18036                                  					;   call.
 18037                                  	;test	word [es:di+4],800h
 18038                                  	;TEST	word [ES:DI+SYSDEV.ATT],DEVOPCL ; See if device can
 18039                                  	;test	byte [es:di+5],8
 18040 0000297F 26F6450508              	TEST	byte [es:di+SYSDEV.ATT+1],(DEVOPCL>>8)
 18041 00002984 74BC                    	JZ	short ioctl_bad_fun		; NO
 18042                                  
 18043                                  ;hkn; SS override for IOCALL
 18044                                  	; 30/01/2024
 18045                                  	; ds = ss = DOSDATA segment ('Get_Driver_BL' in 'Check_If_Net')
 18046                                  	;MOV	byte [SS:IOCALL_REQFUNC],DEVRMD ; 15
 18047 00002986 C606[7E03]0F            	mov	byte [IOCALL_REQFUNC],DEVRMD ; 15
 18048 0000298B B00D                    	MOV	AL,REMHL  ; 13
 18049 0000298D 88DC                    	MOV	AH,BL			; Unit number
 18050                                  	;MOV	[SS:IOCALL_REQLEN],AX
 18051 0000298F A3[7C03]                	mov	[IOCALL_REQLEN],ax	
 18052 00002992 31C0                    	XOR	AX,AX
 18053                                  	;MOV	[SS:IOCALL_REQSTAT],AX
 18054 00002994 A3[7F03]                	mov	[IOCALL_REQSTAT],ax ; 0
 18055                                  	
 18056 00002997 06                      	PUSH	ES
 18057 00002998 1F                      	POP	DS
 18058 00002999 89FE                    	MOV	SI,DI			; DS:SI -> driver
 18059 0000299B 16                      	PUSH	SS
 18060 0000299C 07                      	POP	ES
 18061                                  
 18062                                  ;hkn; IOCALL is in DOSDATA (msconst.asm)
 18063                                  	; 30/01/2024
 18064                                  	; (ds <> ss, ss = DOSDATA segment)
 18065 0000299D BB[7C03]                	MOV	BX,IOCALL		; ES:BX -> Call header
 18066 000029A0 1E                      	push	ds
 18067 000029A1 56                      	push	si
 18068 000029A2 E8D325                  	call	DEVIOCALL2
 18069 000029A5 5E                      	pop	si
 18070 000029A6 1F                      	pop	ds
 18071                                  
 18072                                  ;hkn; SS override
 18073 000029A7 36A1[7F03]              	MOV	AX,[SS:IOCALL_REQSTAT]	; Get Status word
 18074                                  	;AND	AX,STBUI ; 200h		; Mask to busy bit
 18075                                  	; 29/01/2024
 18076 000029AB 80E402                  	and	ah,STBUI>>8 ; 2
 18077 000029AE B109                    	MOV	CL,9
 18078 000029B0 D3E8                    	SHR	AX,CL			; Busy bit to bit 0
 18079                                  ioctl_da_ok_j:	; 11/11/2022
 18080 000029B2 E9B6DC                  	jmp	SYS_RET_OK
 18081                                  
 18082                                  	; 29/01/2024
 18083                                  ;--------------------------------------------------------------------------
 18084                                  ;
 18085                                  ; IOCTL: AL = B
 18086                                  ;
 18087                                  ; ENTRY: DS = DOSDATA
 18088                                  ;
 18089                                  ;--------------------------------------------------------------------------
 18090                                  
 18091                                  Set_Retry_Parameters:
 18092                                  	; 09/09/2018
 18093 000029B5 890E[1C00]              	MOV	[RetryLoop],CX		; 0 retry loop count allowed
 18094 000029B9 09D2                    	OR	DX,DX			; zero retries not allowed
 18095 000029BB 7485                    	JZ	short ioctl_bad_fun
 18096                                  	; 29/01/2024
 18097                                  	;jnz	short set_new_retry_cnt
 18098                                  	;jmp	ioctl_bad_fun
 18099                                  ;set_new_retry_cnt:
 18100 000029BD 8916[1A00]              	MOV	[RetryCount],DX		; Set new retry count
 18101                                  doneok:
 18102                                  	;jmp	SYS_RET_OK		; Done
 18103                                  	; 11/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 18104                                  	;jmp	short ioctl_status_ret
 18105                                  	; 16/12/2022
 18106                                  	;jmp	short ioctl_ok	 ; jmp SYS_RET_OK
 18107                                  	; 29/01/2024
 18108 000029C1 EBEF                    	jmp	short ioctl_da_ok_j
 18109                                  
 18110                                  ;-------------------------------------------------------------------------
 18111                                  ;
 18112                                  ; IOCTL: AL = 9
 18113                                  ;
 18114                                  ; ENTRY: DS = DOSDATA
 18115                                  ;
 18116                                  ;-------------------------------------------------------------------------
 18117                                  
 18118                                  	; 30/01/2024 - Retro DOS v5.0
 18119                                  
 18120                                  ioctl_drive_attr:
 18121                                  	; MSDOS 3.3 (& MSDOS 6.0)
 18122 000029C3 88D8                    	mov	al,bl
 18123 000029C5 E84A4E                  	call	GETTHISDRV
 18124 000029C8 7243                    	jc	short ioctl_drv_err
 18125 000029CA E8BA00                  	call	Get_Driver_BL
 18126                                  	; MSDOS 6.0
 18127 000029CD 723E                    	JC	short ioctl_drv_err	; drive not valid
 18128                                  
 18129                                  	; 03/07/2024
 18130                                  	; jnz = net drive (current dir is net)
 18131                                  	; jz = local drive
 18132                                  
 18133                                  	; 03/07/2024
 18134                                  	; 30/01/2024 - Retro DOS v5.0
 18135                                  	; 30/01/2024 - PCDOS 7.1 IBMDOS.COM
 18136                                  	;;;
 18137 000029CF BA4209                  	mov	dx,942h		; 0942h -> Attribute word
 18138                                  				; bit 11 - open/close/remmedia calls supported
 18139                                  				; bit 8 - (new type driver)
 18140                                  				; bit 6 - Generic IOCTL call supported
 18141                                  				; bit 1 - driver supports 32-bit sector addressing
 18142 000029D2 7504                    	jnz     short ioctl_drive_attr2 ; NET device
 18143                                  			; 30/01/2024
 18144                                  			; NOTE: 'jnz' condition is correct for Windows ME
 18145                                  			; 'Get_Driver_BL ' because it tests bit 0 of [drive_flags]
 18146                                  			; but in PCDOS 7.1 'Get_Driver_BL', this flag
 18147                                  			;	 (remote or removable? disk flag) is not tested
 18148                                  			; the last test is net device test) ; (*!)
 18149                                  	;;;;
 18150                                  
 18151                                  	;mov	dx,[es:di+4]
 18152 000029D4 268B5504                	mov	dx,[es:di+SYSDEV.ATT]
 18153                                  				; get device attribute word
 18154                                  	; 26/06/2024
 18155                                  ioctl_drive_attr2: ; 30/01/2024
 18156 000029D8 88C3                    	MOV	BL,AL		; Phys letter to BL (A=0)
 18157                                  
 18158                                  ;hkn; SS override
 18159                                  	; 30/01/2024
 18160                                  	; (MSDOS 6.22 IO.SYS - DOSCODE:62B8h)
 18161                                  	; (PCDOS 7.1 IBMDOS.COM - DOSCODE:69DBh)
 18162                                  	;LES	DI,[SS:THISCDS]	; NOTE: PCDOS 7.1 has bug here,
 18163                                  				; ds must be same with ss here...
 18164                                  				; because there is 'les di, [ds:THISCDS]' in
 18165                                  				; Get_Driver_BL
 18166                                  				; and a second 'test byte ptr es:[di+44h],80h'
 18167                                  				; is not necessary; also its result (jnz)
 18168                                  				; overwrites DS. /// Erdogan Tan - 30/01/2024
 18169                                  	; 30/01/2024
 18170                                  	; Retro DOS v5.0
 18171                                  	; (Windows ME IO.SYS - BIOSCODE:67ABh)
 18172 000029DA C43E[A205]              	les	di,[THISCDS] 
 18173                                  
 18174                                  	;test	word [es:di+43h],8000h
 18175                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
 18176                                  	;test	byte [es:di+44h],80h
 18177 000029DE 26F6454480              	TEST	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8) ; (*!)
 18178 000029E3 7403                    	JZ	short IOCTLShare
 18179                                  
 18180                                  	;or	dx,1000h ; (MSDOS 3.3)
 18181                                  
 18182                                  ;	Net devices don't return a device attribute word.
 18183                                  ;	Bit 12 = 1, meaning net device, all others = 0.
 18184                                  
 18185 000029E5 BA0010                  	MOV	DX,1000h ; MSDOS 6.0
 18186                                  
 18187                                  IOCTLShare:
 18188                                  	; 30/01/2024
 18189                                  	; ds = ss = DOSDATA segment
 18190                                  	;push	ss
 18191                                  	;pop	ds
 18192                                  	
 18193 000029E8 BE[BE03]                	MOV	SI,OPENBUF
 18194 000029EB 80C341                  	ADD	BL,"A"	; 41h
 18195 000029EE 881C                    	MOV	[SI],BL
 18196 000029F0 C744013A00              	MOV	WORD [SI+1],003AH ; ":",0
 18197 000029F5 B80003                  	MOV	AX,0300h
 18198 000029F8 F8                      	CLC
 18199                                  	;INT	int_IBM
 18200 000029F9 CD2A                    	int     2Ah	; Microsoft Networks - CHECK DIRECT I/O
 18201                                  			; DS:SI -> ASCIZ disk device name 
 18202                                  			; (may be full path or only drive
 18203                                  			; specifier--must include the colon)
 18204                                  			; Return: CF clear if absolute disk access allowed
 18205 000029FB 7303                    	JNC	short IOCTLLocal	; Not shared
 18206                                  	;OR	DX,0200H		; Shared, bit 9
 18207                                  	; 17/12/2022
 18208 000029FD 80CE02                  	or	dh,02h
 18209                                  IOCTLLocal:
 18210                                  	;test	word [es:di+43h],1000h
 18211                                  	;TEST	word [ES:DI+curdir.flags],curdir_local
 18212                                  	;test	byte [es:di+44h],10h
 18213 00002A00 26F6454410              	TEST	byte [ES:DI+curdir.flags+1],(curdir_local>>8)
 18214                                  	;JZ	short ioctl_set_DX
 18215                                  	; 16/12/2022
 18216 00002A05 7403                    	jz	short _ioctl_set_DX
 18217                                  	;OR	DX,8000h
 18218                                  	; 17/12/2022
 18219 00002A07 80CE80                  	or	dh,80h
 18220                                  ;ioctl_set_DX:
 18221                                  _ioctl_set_DX:
 18222                                  	; 16/12/2022
 18223 00002A0A E972FE                  	jmp	ioctl_set_dx
 18224                                  ; 16/12/2022
 18225                                  %if 0	
 18226                                  	call	Get_User_Stack
 18227                                  	MOV	[SI+user_env.user_DX],DX
 18228                                  	;;jmp	SYS_RET_OK
 18229                                  	;; 25/06/2019
 18230                                  	;jmp	SYS_RET_OK_clc
 18231                                  	; 11/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 18232                                  ioctl_gd_ok_j:
 18233                                  	jmp	short ioctl_da_ok_j
 18234                                  %endif
 18235                                  
 18236                                  ioctl_drv_err:
 18237 00002A0D B00F                    	mov	al,error_invalid_drive ; 0Fh
 18238                                  ioctl_gd_err_j:	; 11/11/2022
 18239 00002A0F E963DC                  	jmp	SYS_RET_ERR
 18240                                  
 18241                                  ;--------------------------------------------------------------------------
 18242                                  ;
 18243                                  ; IOCTL: AL = A
 18244                                  ;
 18245                                  ; ENTRY: DS = DOSDATA
 18246                                  ;
 18247                                  ;--------------------------------------------------------------------------
 18248                                  
 18249                                  ioctl_handle_redir:
 18250 00002A12 E84349                  	call	SFFromHandle		; ES:DI -> SFT
 18251 00002A15 7303                    	JNC	short ioctl_got_sft	; have valid handle
 18252 00002A17 E929FE                  	jmp	ioctl_bad_handle ; 10/08/2018
 18253                                  
 18254                                  ioctl_got_sft:
 18255                                  	;mov	dx,[es:di+5]
 18256 00002A1A 268B5505                	MOV	DX,[ES:DI+SF_ENTRY.sf_flags] ; Get flags
 18257                                  	;JMP	short ioctl_set_DX	; pass dx to user and return
 18258                                  	; 16/12/2022
 18259 00002A1E EBEA                    	jmp	short _ioctl_set_DX
 18260                                  
 18261                                  	; 16/12/2022
 18262                                  ;ioctl_bad_funj:
 18263                                  	;JMP	ioctl_bad_fun
 18264                                  
 18265                                  ;--------------------------------------------------------------------------
 18266                                  ;
 18267                                  ; IOCTL: AL= 4,5
 18268                                  ;
 18269                                  ; ENTRY: DS = DOSDATA
 18270                                  ;	 SI = user's DS
 18271                                  ;
 18272                                  ;
 18273                                  ; BUGBUG: Don't push anything on the stack between ioctl_get_dev: and 
 18274                                  ;         the call to Check_If_Net because Check_If_Net gets our
 18275                                  ;         return address off the stack if the drive is invalid.
 18276                                  ;
 18277                                  ;-------------------------------------------------------------------------
 18278                                  
 18279                                  	; 30/01/2024 - Retro DOS v5.0
 18280                                  
 18281                                  ioctl_get_dev:
 18282 00002A20 E88F00                  	CALL	Check_If_Net
 18283                                  	;JNZ	short ioctl_bad_funj	; There are no "net devices", and they
 18284                                  					; certainly don't know how to do this
 18285                                  					; call.
 18286                                  	; 16/12/2022
 18287 00002A23 7403                    	jz	short ioctl_do_string
 18288                                  ioctl_bad_funj:
 18289 00002A25 E91AFF                  	JMP	ioctl_bad_fun
 18290                                  
 18291                                  ioctl_do_string:
 18292                                  	;test	word [es:di+4],4000h
 18293                                  	;TEST	word [ES:DI+SYSDEV.ATT],DEVIOCTL; See if device accepts control
 18294                                  	;test	byte [es:di+5],40h
 18295 00002A28 26F6450540              	TEST	byte [ES:DI+SYSDEV.ATT+1],(DEVIOCTL>>8)
 18296 00002A2D 74F6                    	JZ	short ioctl_bad_funj		; NO
 18297                                  					; assume IOCTL read
 18298 00002A2F C606[7E03]03            	MOV	byte [IOCALL_REQFUNC],DEVRDIOCTL ; 3
 18299                                  
 18300 00002A34 A801                    	TEST	AL,1			; is it func. 4/5 or 2/3
 18301 00002A36 7405                    	JZ	short ioctl_control_call ; it is read. goto ioctl_control_call
 18302                                  
 18303                                  					; it is an IOCTL write
 18304 00002A38 C606[7E03]0C            	MOV	byte [IOCALL_REQFUNC],DEVWRIOCTL ; 12
 18305                                  
 18306                                  ioctl_control_call:
 18307                                  	; 30/01/2024
 18308                                  	;MOV	AL,DRDWRHL ; 22	; MSDOS 6.22 MSDOS.SYS, Windows ME IO.SYS
 18309                                  	; 26/06/2024
 18310 00002A3D B014                    	mov	al,20 ; PCDOS 7.1 IBMDOS.COM
 18311                                  ioctl_setup_pkt:
 18312 00002A3F 88DC                    	MOV	AH,BL			; Unit number
 18313 00002A41 A3[7C03]                	MOV	[IOCALL_REQLEN],AX
 18314 00002A44 31C0                    	XOR	AX,AX
 18315 00002A46 A3[7F03]                	MOV	[IOCALL_REQSTAT],AX ; 0
 18316 00002A49 A2[8903]                	MOV	[IOMED],AL
 18317 00002A4C 890E[8E03]              	MOV	[IOSCNT],CX
 18318 00002A50 8916[8A03]              	MOV	[IOXAD],DX
 18319 00002A54 8936[8C03]              	MOV	[IOXAD+2],SI
 18320 00002A58 06                      	PUSH	ES
 18321 00002A59 1F                      	POP	DS
 18322 00002A5A 89FE                    	MOV	SI,DI			; DS:SI -> driver
 18323 00002A5C 16                      	PUSH	SS
 18324 00002A5D 07                      	POP	ES
 18325                                  
 18326 00002A5E BB[7C03]                	MOV	BX,IOCALL		; ES:BX -> Call header
 18327                                  ioctl_do_IO:
 18328 00002A61 E81425                  	call	DEVIOCALL2
 18329                                  
 18330                                  ;hkn; SS override for IOCALL
 18331                                  	;test	word [SS:IOCALL_REQSTAT],8000h
 18332                                  	;TEST	word [SS:IOCALL_REQSTAT],STERR ;Error?
 18333                                  	;test	byte [SS:IOCALL_REQSTAT+1],80h
 18334 00002A64 36F606[8003]80          	TEST	byte [SS:IOCALL_REQSTAT+1],(STERR>>8)
 18335 00002A6A 7507                    	JNZ	short ioctl_string_err
 18336                                  
 18337                                  ;hkn; SS override
 18338 00002A6C 36A1[8E03]              	MOV	AX,[SS:IOSCNT]		; Get actual bytes transferred
 18339                                  	; 16/12/2022
 18340 00002A70 E9F8DB                  	jmp	SYS_RET_OK
 18341                                  	; 11/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 18342                                  	;jmp	short ioctl_gd_ok_j
 18343                                  
 18344                                  ioctl_string_err:
 18345 00002A73 368B3E[7F03]            	MOV	DI,[SS:IOCALL_REQSTAT]	;Get Error
 18346                                  device_err:
 18347 00002A78 81E7FF00                	AND	DI,STECODE ; 00FFh	; mask out irrelevant bits
 18348 00002A7C 89F8                    	MOV	AX,DI
 18349 00002A7E E8B634                  	call	SET_I24_EXTENDED_ERROR
 18350                                  
 18351                                  ;hkn; use SS override
 18352                                  ;hkn;	mov	ax,[CS:EXTERR]
 18353 00002A81 36A1[2403]              	mov	ax,[SS:EXTERR]
 18354                                  	;jmp	SYS_RET_ERR
 18355                                  	; 11/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 18356 00002A85 EB88                    	jmp	short ioctl_gd_err_j
 18357                                  
 18358                                  ; 17/05/2019 - Retro DOS v4.0
 18359                                  
 18360                                  ;--------------------------------------------------------------------------
 18361                                  ; Proc name : Get_Driver_BL
 18362                                  ;
 18363                                  ;	DS is DOSDATA
 18364                                  ;	BL is drive number (0=default)
 18365                                  ;	Returns pointer to device in ES:DI, unit number in BL if carry clear
 18366                                  ;	No regs modified
 18367                                  ;
 18368                                  ;---------------------------------------------------------------------------
 18369                                  
 18370                                  	; 30/01/2024 - Retro DOS v5.0
 18371                                  
 18372                                  Get_Driver_BL:
 18373 00002A87 50                      	PUSH	AX
 18374 00002A88 88D8                    	MOV	AL,BL			; Drive
 18375 00002A8A E8854D                  	call	GETTHISDRV
 18376 00002A8D 7221                    	jc	short ioctl_bad_drv
 18377 00002A8F 30DB                    	XOR	BL,BL			; Unit zero on Net device
 18378 00002A91 C606[2303]03            	MOV	byte [EXTERR_LOCUS],errLOC_Net ; 3
 18379 00002A96 C43E[A205]              	LES	DI,[THISCDS]
 18380                                  	;test	word [es:di+43h],8000h
 18381                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
 18382                                  	;test	byte [es:di+44h],80h
 18383 00002A9A 26F6454480              	TEST	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8)
 18384                                  	;les	di,[es:di+45h]
 18385 00002A9F 26C47D45                	LES	DI,[ES:DI+curdir.devptr] ; ES:DI -> Dpb or net dev
 18386 00002AA3 750B                    	JNZ	short got_dev_ptr	 ; Is net
 18387                                  	;;;
 18388                                  	; 30/01/2024 - PCDOS 7.1 IBMDOS.COM
 18389                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Disk ; 2
 18390 00002AA5 E81BE8                  	call	set_exerr_locus_disk
 18391                                  	;;;
 18392                                  	;mov	bl,[es:di+1]
 18393 00002AA8 268A5D01                	MOV	BL,[ES:DI+DPB.UNIT]	; Unit number
 18394                                  	;les	di,[es:di+13h]
 18395 00002AAC 26C47D13                	LES	DI,[ES:DI+DPB.DRIVER_ADDR] ; Driver addr
 18396                                  got_dev_ptr:
 18397                                  	; 30/01/2024
 18398                                  	; cf=0
 18399                                  	;CLC
 18400                                  ioctl_bad_drv:
 18401 00002AB0 58                      	POP	AX
 18402 00002AB1 C3                      	retn
 18403                                  
 18404                                  ;-------------------------------------------------------------------------
 18405                                  ; Proc Name : Check_If_Net:
 18406                                  ;
 18407                                  ;
 18408                                  ; Checks if the device is over the net or not. Returns result in ZERO flag.
 18409                                  ; If no device is found, the return address is popped off the stack, and a
 18410                                  ; jump is made to ioctl_drv_err.
 18411                                  ;
 18412                                  ; On Entry:
 18413                                  ; Registers same as those for Get_Driver_BL
 18414                                  ;
 18415                                  ; On Exit:
 18416                                  ; ZERO flag	- set if not a net device
 18417                                  ;		- reset if net device
 18418                                  ; ES:DI -> the device
 18419                                  ;
 18420                                  ;
 18421                                  ; BUGBUG: This function assumes the following stack setup on entry
 18422                                  ;
 18423                                  ;	  SP+2 -> Error return address
 18424                                  ;	  SP   -> Normal return address
 18425                                  ;
 18426                                  ;-------------------------------------------------------------------------
 18427                                  
 18428                                  	; 30/01/2024 - Retro DOS v5.0
 18429                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:639Ch
 18430                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:6A91h
 18431                                  	; Windows ME IO.SYS - BIOSCODE:68E1h
 18432                                  
 18433                                  Check_If_Net:
 18434                                  	; MSDOS 3.3 (& MSDOS 6.0)
 18435 00002AB2 E8D2FF                  	CALL	Get_Driver_BL
 18436 00002AB5 7201                    	JC	short ioctl_drv_err_pop	; invalid drive letter
 18437                                  
 18438                                  ; 30/01/2024 ('Get_Driver_BL' returns with
 18439                                  ;	      'curdir_isnet' condition/ZF, no need to a second test)
 18440                                  %if 0
 18441                                  	;;;
 18442                                  	; (PCDOS 7.1 IBMDOS.COM, Windows ME IO.SYS)
 18443                                  	PUSH	ES
 18444                                  	PUSH	DI
 18445                                  	LES	DI,[THISCDS]
 18446                                  	;test	word [es:di+43h],8000h
 18447                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
 18448                                  	;test	byte [es:di+44h],80h
 18449                                  	TEST	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8)
 18450                                  	POP	DI
 18451                                  	POP	ES
 18452                                  	;;;
 18453                                  %endif
 18454 00002AB7 C3                      	retn
 18455                                  
 18456                                  ioctl_drv_err_pop:
 18457 00002AB8 58                      	pop	ax			; pop off return address
 18458 00002AB9 E951FF                  	jmp	ioctl_drv_err
 18459                                  
 18460                                  ioctl_bad_funj3:
 18461 00002ABC E983FE                  	jmp	ioctl_bad_fun
 18462                                  
 18463                                  ioctl_string_errj:
 18464 00002ABF EBB2                    	jmp	short ioctl_string_err  ; 25/05/2019
 18465                                  
 18466                                  ;--------------------------------------------------------------------------
 18467                                  ;
 18468                                  ; IOCTL: AL = E, F
 18469                                  ;
 18470                                  ; ENTRY: DS = DOSDATA
 18471                                  ;
 18472                                  ;
 18473                                  ; BUGBUG: Don't push anything on the stack between ioctl_drive_owner: and 
 18474                                  ;         the call to Check_If_Net because Check_If_Net gets our
 18475                                  ;         return address off the stack if the drive is invalid.
 18476                                  ;
 18477                                  ;--------------------------------------------------------------------------
 18478                                  
 18479                                  ioctl_drive_owner:
 18480                                  	; MSDOS 3.3 (& MSDOS 6.0)
 18481 00002AC1 E8EEFF                  	Call	Check_If_Net
 18482 00002AC4 75F6                    	JNZ	short ioctl_bad_funj3 	; There are no "net devices", and they
 18483                                  					;   certainly don't know how to do this
 18484                                  					;   call.
 18485                                  	;TEST	word [ES:DI+SYSDEV.ATT],DEV320	; See if device can handle this
 18486                                  	; 09/09/2018
 18487                                  	;test	byte [es:di+4],40h
 18488 00002AC6 26F6450440              	TEST	byte [ES:DI+SYSDEV.ATT],DEV320 ; 0040h
 18489 00002ACB 74EF                    	JZ	short ioctl_bad_funj3 	; NO
 18490                                  	;mov	byte [IOCALL_REQFUNC],23
 18491 00002ACD C606[7E03]17            	mov	byte [IOCALL_REQFUNC],DEVGETOWN	; default to get owner
 18492 00002AD2 3C0E                    	cmp	al,0Eh			; Get Owner ?
 18493 00002AD4 7405                    	jz	short GetOwner
 18494                                  SetOwner:
 18495 00002AD6 C606[7E03]18            	MOV	byte [IOCALL_REQFUNC],DEVSETOWN ; 24
 18496                                  GetOwner:
 18497 00002ADB B00D                    	MOV	AL,OWNHL ; 13
 18498 00002ADD 88DC                    	MOV	AH,BL			; Unit number
 18499 00002ADF A3[7C03]                	MOV	[IOCALL_REQLEN],AX
 18500 00002AE2 31C0                    	XOR	AX,AX
 18501 00002AE4 A3[7F03]                	MOV	[IOCALL_REQSTAT],AX
 18502 00002AE7 06                      	PUSH	ES
 18503 00002AE8 1F                      	POP	DS
 18504 00002AE9 89FE                    	MOV	SI,DI			; DS:SI -> driver
 18505 00002AEB 16                      	PUSH	SS
 18506 00002AEC 07                      	POP	ES
 18507 00002AED BB[7C03]                	MOV	BX,IOCALL		; ES:BX -> Call header
 18508 00002AF0 1E                      	push	ds
 18509 00002AF1 56                      	push	si
 18510 00002AF2 E88324                  	call	DEVIOCALL2
 18511 00002AF5 5E                      	pop	si
 18512 00002AF6 1F                      	pop	ds
 18513                                  ;hkn; SS override
 18514                                  	;TEST	word [SS:IOCALL_REQSTAT],STERR ;Error?
 18515                                  	;test	byte [SS:IOCALL_REQSTAT+1],80h
 18516 00002AF7 36F606[8003]80          	TEST	byte [SS:IOCALL_REQSTAT+1],(STERR>>8)
 18517 00002AFD 75C0                    	jnz	short ioctl_string_errj
 18518 00002AFF 36A0[7D03]              	MOV	AL,[SS:IOCALL_REQUNIT]	; Get owner returned by device
 18519                                  					; owner returned is 1-based.
 18520 00002B03 E965DB                  	jmp	SYS_RET_OK
 18521                                  
 18522                                  ;============================================================================
 18523                                  ; DELETE.ASM, MSDOS 6.0, 1991
 18524                                  ;============================================================================
 18525                                  ; 07/08/2018 - Retro DOS v3.0
 18526                                  ; 17/05/2019 - Retro DOS v4.0
 18527                                  
 18528                                  ;	TITLE	DOS_DELETE - Internal DELETE call for MS-DOS
 18529                                  ;	NAME	DOS_DELETE
 18530                                  
 18531                                  ;
 18532                                  ;	Microsoft Confidential
 18533                                  ;	Copyright (C) Microsoft Corporation 1991
 18534                                  ;	All Rights Reserved.
 18535                                  ;
 18536                                  
 18537                                  ;**	DELETE.ASM - Low level routine for deleting files
 18538                                  ;----------------------------------------------------------------------------
 18539                                  ;		DOS_DELETE
 18540                                  ;		REN_DEL_Check
 18541                                  ;		FastOpen_Delete	       ; DOS 3.3
 18542                                  ;		FastOpen_Update	       ; DOS 3.3
 18543                                  
 18544                                  ;   Revision history:
 18545                                  ;
 18546                                  ;   A000  version 4.00	Jan. 1988
 18547                                  ;   A001  Fastopen Rename fix	April 1989
 18548                                  
 18549                                  ;Installed = TRUE
 18550                                  
 18551                                  ;	i_need	NoSetDir,BYTE
 18552                                  ;	i_need	Creating,BYTE
 18553                                  ;	i_need	DELALL,BYTE
 18554                                  ;	i_need	THISDPB,DWORD
 18555                                  ;	i_need	THISSFT,DWORD
 18556                                  ;	i_need	THISCDS,DWORD
 18557                                  ;	i_need	CURBUF,DWORD
 18558                                  ;	i_need	ATTRIB,BYTE
 18559                                  ;	i_need	SATTRIB,BYTE
 18560                                  ;	i_need	WFP_START,WORD
 18561                                  ;	i_need	REN_WFP,WORD			 ;BN001
 18562                                  ;	i_need	NAME1,BYTE			 ;BN001
 18563                                  ;	i_need	FoundDel,BYTE
 18564                                  ;	i_need	AUXSTACK,BYTE
 18565                                  ;	i_need	VOLCHNG_FLAG,BYTE
 18566                                  ;	i_need	JShare,DWORD
 18567                                  ;	i_need	FastOpenTable,BYTE		  ; DOS 3.3
 18568                                  ;	i_need	FastTable,BYTE			  ; DOS 4.00
 18569                                  ;
 18570                                  ;	i_need	Del_ExtCluster,WORD		  ; DOS 4.00
 18571                                  ;
 18572                                  ;	i_need	SAVE_BX,WORD			  ; DOS 4.00
 18573                                  ;	i_need	DMAADD,DWORD
 18574                                  ;	i_need	RENAMEDMA,BYTE
 18575                                  
 18576                                  ;----------------------------------------------------------------------------
 18577                                  ;
 18578                                  ; Procedure Name : DOS_DELETE
 18579                                  ;
 18580                                  ; Inputs:
 18581                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 18582                                  ;		terminated)
 18583                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 18584                                  ;		( = -1 if current dir not involved, else
 18585                                  ;		 Points to first char after last "/" of current dir part)
 18586                                  ;	[THISCDS] Points to CDS being used
 18587                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 18588                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 18589                                  ; Function:
 18590                                  ;	Delete the specified file(s)
 18591                                  ; Outputs:
 18592                                  ;	CARRY CLEAR
 18593                                  ;		OK
 18594                                  ;	CARRY SET
 18595                                  ;	    AX is error code
 18596                                  ;		error_file_not_found
 18597                                  ;			Last element of path not found
 18598                                  ;		error_path_not_found
 18599                                  ;			Bad path (not in curr dir part if present)
 18600                                  ;		error_bad_curr_dir
 18601                                  ;			Bad path in current directory part of path
 18602                                  ;		error_access_denied
 18603                                  ;			Attempt to delete device or directory
 18604                                  ;		***error_sharing_violation***
 18605                                  ;			Deny both access required, generates an INT 24.
 18606                                  ;			This error is NOT returned. The INT 24H is generated,
 18607                                  ;			  and the file is ignored (not deleted). Delete will
 18608                                  ;			  simply continue on looking for more files.
 18609                                  ;			  Carry will NOT be set in this case.
 18610                                  ; DS preserved, others destroyed
 18611                                  ;
 18612                                  ;----------------------------------------------------------------------------
 18613                                  
 18614                                  FILEFOUND   equ 01h
 18615                                  FILEDELETED equ 10h
 18616                                  
 18617                                  	; 12/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 18618                                  	; DOSCODE:63E9h (MSDOS 5.0, MSDOS.SYS)
 18619                                  
 18620                                  	; 30/01/2024 - Retro DOS v5.0 (Modified MSDOS 5.0 IBMDOS.COM)
 18621                                  	; DOSCODE:6B11h (PCDOS 7.1, IBMDOS.COM)
 18622                                  
 18623                                  DOS_DELETE:
 18624                                  
 18625                                  ;hkn; DOS_Delete is called from file.asm and fcbio.asm. DS has been set up 
 18626                                  ;hkn; appropriately at this point.
 18627                                  
 18628 00002B06 E8FDEC                  	call	TestNet
 18629 00002B09 7306                    	JNC	short LOCAL_DELETE
 18630                                  
 18631                                  ;IF NOT Installed
 18632                                  ;	transfer NET_DELETE
 18633                                  ;ELSE
 18634                                  	;MOV	AX,(MultNET SHL 8) | 19
 18635                                  	;INT	2FH
 18636                                  	;return
 18637                                  
 18638 00002B0B B81311                  	mov	ax,1113h
 18639 00002B0E CD2F                    	int     2Fh 	; Multiplex - NETWORK REDIRECTOR - DELETE REMOTE FILE
 18640                                  			; SS = DS = DOS CS, SDA first filename pointer -> 
 18641                                  			;		fully-qualified filename in DOS CS
 18642                                  			; SDA CDS pointer -> current directory structure for drive with file
 18643                                  			; Return: CF set on error
 18644 00002B10 C3                      	retn
 18645                                  ;ENDIF
 18646                                  
 18647                                  LOCAL_DELETE:
 18648 00002B11 C606[6F05]00            	MOV	byte [FOUNDDEL],0	; No files found and no files deleted
 18649 00002B16 E86BED                  	call	ECritDisk
 18650                                  	;mov	word [CREATING],0E500h
 18651 00002B19 C706[7E05]00E5          	MOV	WORD [CREATING],DIRFREE*256+0 ; Assume not del *.*
 18652 00002B1F 8B36[B205]              	MOV	SI,[WFP_START]
 18653                                  SKPNUL:
 18654 00002B23 AC                      	LODSB
 18655 00002B24 08C0                    	OR	AL,AL
 18656 00002B26 75FB                    	JNZ	short SKPNUL		; go to end
 18657 00002B28 83EE04                  	SUB	SI,4			; Back over possible "*.*"
 18658 00002B2B 813C2A2E                	CMP	WORD [SI],2E2Ah ; "*."
 18659 00002B2F 7506                    	JNZ	short TEST_QUEST
 18660 00002B31 807C022A                	CMP	BYTE [SI+2],"*"
 18661 00002B35 741F                    	JZ	short CHECK_ATTS
 18662                                  TEST_QUEST:
 18663 00002B37 83EE09                  	SUB	SI,9		; Back over possible "????????.???"
 18664 00002B3A 87F7                    	XCHG	DI,SI
 18665                                  
 18666 00002B3C 16                      	push	ss
 18667                                  	;pop	ds ; ! Retro DOS v3.0 BUG !
 18668 00002B3D 07                      	pop	es ; 17/05/2019
 18669                                  
 18670 00002B3E B83F3F                  	MOV	AX,"??" ; 3F3Fh
 18671 00002B41 B90400                  	MOV	CX,4		; four sets of "??"
 18672 00002B44 F3AF                    	REPE	SCASW
 18673 00002B46 751C                    	JNZ	short NOT_ALL
 18674 00002B48 87F7                    	XCHG	DI,SI
 18675 00002B4A AD                      	LODSW
 18676 00002B4B 3D2E3F                  	CMP	AX,3F2Eh ; ".?"
 18677 00002B4E 7514                    	JNZ	short NOT_ALL
 18678 00002B50 AD                      	LODSW
 18679 00002B51 3D3F3F                  	CMP	AX,"??"
 18680 00002B54 750E                    	JNZ	short NOT_ALL
 18681                                  CHECK_ATTS:
 18682 00002B56 A0[6D05]                	MOV	AL,[SATTRIB]
 18683                                  	;and	al,1Fh
 18684 00002B59 241F                    	AND	AL,attr_hidden+attr_system+attr_directory+attr_volume_id+attr_read_only
 18685                                  					; Look only at hidden bits
 18686                                  	;cmp	al,1Fh
 18687 00002B5B 3C1F                    	CMP	AL,attr_hidden+attr_system+attr_directory+attr_volume_id+attr_read_only
 18688                                  					; All must be set
 18689 00002B5D 7505                    	JNZ	short NOT_ALL
 18690                                  
 18691                                  ; NOTE WARNING DANGER-----
 18692                                  ;    This DELALL stuff is not safe. It allows directories to be deleted.
 18693                                  ;	It should ONLY be used by FORMAT in the ROOT directory.
 18694                                  
 18695 00002B5F C606[7F05]00            	MOV	byte [DELALL],0		; DEL *.* - flag deleting all
 18696                                  NOT_ALL:
 18697 00002B64 C606[4C03]01            	MOV	byte [NoSetDir],1
 18698 00002B69 E85E1E                  	call	GetPathNoSet
 18699 00002B6C 7312                    	JNC	short Del_found
 18700 00002B6E 750B                    	JNZ	short _bad_path
 18701 00002B70 08C9                    	OR	CL,CL
 18702 00002B72 7407                    	JZ	short _bad_path
 18703                                  No_file:
 18704 00002B74 B80200                  	MOV	AX,error_file_not_found
 18705                                  ErrorReturn:
 18706 00002B77 F9                      	STC
 18707                                  	;call	LCritDisk
 18708                                  	;retn
 18709                                  	; 18/12/2022
 18710 00002B78 E936ED                  	jmp	LCritDisk
 18711                                  
 18712                                  _bad_path:
 18713 00002B7B B80300                  	MOV	AX,error_path_not_found
 18714 00002B7E EBF7                    	JMP	short ErrorReturn
 18715                                  
 18716                                  Del_found:
 18717 00002B80 750C                    	JNZ	short NOT_DIR		; Check for dir specified
 18718 00002B82 803E[7F05]00            	CMP	byte [DELALL],0		; DelAll = 0 allows delete of dir.
 18719 00002B87 7405                    	JZ	short NOT_DIR
 18720                                  Del_access_err:
 18721 00002B89 B80500                  	MOV	AX,error_access_denied
 18722 00002B8C EBE9                    	JMP	short ErrorReturn
 18723                                  
 18724                                  NOT_DIR:
 18725 00002B8E 08E4                    	OR	AH,AH			; Check if device name
 18726 00002B90 78F7                    	JS	short Del_access_err	; Can't delete I/O devices
 18727                                  
 18728                                  ; Main delete loop. CURBUF+2:BX points to a matching directory entry.
 18729                                  
 18730                                  DELFILE:
 18731 00002B92 800E[6F05]01            	OR	byte [FOUNDDEL],FILEFOUND ; file found, not deleted yet
 18732                                  
 18733                                  ; If we are deleting the Volume ID, then we set VOLUME_CHNG flag to make
 18734                                  ; DOS issue a build BPB call the next time this drive is accessed.
 18735                                  
 18736 00002B97 1E                      	PUSH	DS
 18737 00002B98 8A26[7F05]              	MOV	AH,[DELALL]
 18738 00002B9C C53E[E205]              	LDS	DI,[CURBUF]
 18739                                  	
 18740                                  ;hkn; SS override
 18741 00002BA0 36F606[6B05]01          	TEST	byte [SS:ATTRIB],attr_read_only ; are we deleting RO files too?
 18742 00002BA6 7509                    	JNZ	short DoDelete		; yes
 18743                                  
 18744 00002BA8 F6470B01                	TEST	byte [BX+dir_entry.dir_attr],attr_read_only
 18745 00002BAC 7403                    	JZ	short DoDelete		; not read only
 18746                                  
 18747                                  	; 30/01/2024 (PCDOS 7.1 IBMDOS.COM)
 18748                                  Skip_it:
 18749 00002BAE 1F                      	POP	DS
 18750 00002BAF EB54                    	JMP	SHORT DELNXT		; Skip it (Note ES:BP not set)
 18751                                  
 18752                                  DoDelete:
 18753 00002BB1 E8AC00                  	call	REN_DEL_Check		; Sets ES:BP = [THISDPB]
 18754                                  	;JNC	short DEL_SHARE_OK
 18755                                  	;POP	DS
 18756                                  	;JMP	SHORT DELNXT		; Skip it
 18757                                  	; 30/01/2024
 18758 00002BB4 72F8                    	jc	short Skip_it
 18759                                  
 18760                                  DEL_SHARE_OK:
 18761                                  	; 17/05/2019 - Retro DOS v4.0
 18762                                  	; MSDOS 6.0
 18763                                  	;test	byte [di+5],40h
 18764 00002BB6 F6450540                	TEST	byte [DI+BUFFINFO.buf_flags],buf_dirty
 18765                                  					;LB. if already dirty		  ;AN000;
 18766 00002BBA 7507                    	JNZ	short yesdirty		;LB.  don't increment dirty count ;AN000;
 18767 00002BBC E8B13C                  	call	INC_DIRTY_COUNT		;LB.				  ;AN000;
 18768                                  	;or	byte [di+5],40h
 18769 00002BBF 804D0540                	OR	byte [DI+BUFFINFO.buf_flags],buf_dirty
 18770                                  yesdirty:
 18771 00002BC3 8827                    	mov	[bx],ah 
 18772                                  	;MOV	[BX+dir_entry.dir_name],AH ; Put in E5H or 0
 18773                                  	;;;
 18774                                  	; 30/01/2024 - Retro DOS v5.0
 18775                                  	; (PCDOS 7.1 IBMDOS.COM)
 18776 00002BC5 31DB                    	xor	bx,bx ; 0
 18777                                  	;cmp	[es:bp+0Fh],bx
 18778 00002BC7 26395E0F                	cmp	[es:bp+DPB.FAT_SIZE],bx ; 0
 18779 00002BCB 7503                    	jnz     short yesdirty_fc_1	;  not FAT32
 18780 00002BCD 8B5CFA                  	mov     bx,[si-6]		;  high word of the first cluster (FAT32)
 18781                                  yesdirty_fc_1:
 18782                                  	;mov	[ss:CLUSTNUM_HW],bx 
 18783 00002BD0 89DA                    	mov	dx,bx ; * ; 30/01/2024 - Retro DOS v5.0
 18784                                  	;;;
 18785                                  
 18786 00002BD2 8B1C                    	MOV	BX,[SI] 		; Get firclus pointer
 18787 00002BD4 1F                      	POP	DS
 18788                                  	;;;
 18789 00002BD5 8916[E80A]              	mov	[CLUSTNUM_HW],dx ; * ; 30/01/2024 - Retro DOS v5.0
 18790                                  	;;;
 18791 00002BD9 800E[6F05]10            	OR	byte [FOUNDDEL],FILEDELETED ; 10h ; Deleted file
 18792                                  
 18793                                  	; 30/01/2024
 18794                                  	;CMP	BX,2
 18795                                  	;JB	short DELNXT		; File has invalid FIRCLUS (too small)
 18796                                  	;;;
 18797                                  	; 30/01/2024 - Retro DOS v5.0
 18798                                  	; (PCDOS 7.1 IBMDOS.COM)
 18799                                  	;cmp	word [CLUSTNUM_HW],0
 18800 00002BDE 21D2                    	and	dx,dx ; 30/01/2024 - Retro DOS v5.0
 18801 00002BE0 7505                    	jnz	short yesdirty_fc_2
 18802 00002BE2 83FB02                  	cmp	bx,2
 18803 00002BE5 721E                    	jb	short DELNXT		; File has invalid FIRCLUS (too small)
 18804                                  yesdirty_fc_2:
 18805                                  	;cmp	word [es:bp+0Fh],0
 18806 00002BE7 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 18807 00002BEC 750C                    	jnz     short yesdirty_fc_3	; not FAT32
 18808                                  	;push	bx
 18809                                  	;mov	bx,[CLUSTNUM_HW]
 18810                                  	;;cmp	bx,[es:bp+2Fh]
 18811                                  	;cmp	bx,[es:bp+DPB.LAST_CLUSTER+2]
 18812                                  	;30/01/2024 - Retro DOS v5.0
 18813                                  	;mov	dx,[CLUSTNUM_HW]
 18814                                  	; dx = [CLUSTNUM_HW] ; *
 18815 00002BEE 263B562F                	cmp	dx,[es:bp+DPB.LAST_CLUSTER+2]
 18816                                  	;pop	bx
 18817 00002BF2 750A                    	jne	short yesdirty_fc_4
 18818                                  	;cmp	bx,[es:bp+2Dh]
 18819 00002BF4 263B5E2D                	cmp	bx,[es:bp+DPB.LAST_CLUSTER]
 18820 00002BF8 EB04                    	jmp     short yesdirty_fc_4
 18821                                  yesdirty_fc_3:
 18822                                  	;;;
 18823                                  	;cmp	bx,[es:bp+0Dh]
 18824 00002BFA 263B5E0D                	CMP	BX,[ES:BP+DPB.MAX_CLUSTER]
 18825                                  yesdirty_fc_4:	; 30/01/2024
 18826 00002BFE 7705                    	JA	short DELNXT		; File has invalid FIRCLUS (too big)
 18827                                  
 18828 00002C00 E8732C                  	call	RELEASE 		; Free file data
 18829 00002C03 7255                    	JC	short No_fileJ
 18830                                  
 18831                                  ; DOS 3.3  FastOpen
 18832                                  
 18833                                  	; 03/03/2025 (MiniDOS)
 18834                                  	;CALL	FastOpen_Delete 	; delete the dir info in fastopen
 18835                                  
 18836                                  ; DOS 3.3  FastOpen
 18837                                  
 18838                                  DELNXT:
 18839 00002C05 C42E[8A05]              	LES	BP,[THISDPB]		; Possible to get here without this set
 18840 00002C09 E84B1B                  	call	GETENTRY		; Registers need to be reset
 18841 00002C0C 724C                    	JC	short No_fileJ
 18842 00002C0E E8421A                  	call	NEXTENT
 18843                                  	;JNC	short DELFILE
 18844                                  	; 30/01/2024
 18845 00002C11 7203                    	jc	short DELNXT2
 18846 00002C13 E97CFF                  	jmp	DELFILE
 18847                                  DELNXT2:
 18848 00002C16 C42E[8A05]              	LES	BP,[THISDPB]		; NEXTENT sets ES=DOSGROUP
 18849                                  	
 18850                                  	;;;
 18851                                  	; 30/01/2024 - Retro DOS v5.0
 18852                                  	; (PCDOS 7.1 IBMDOS.COM)
 18853                                  	;
 18854 00002C1A E86E07                  	call	update_fat32_fsinfo
 18855                                  	;;;
 18856                                  
 18857                                  	; 12/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 18858                                  	;MOV	AL,[ES:BP+DPB.DRIVE]
 18859                                  	;;mov	al,[es:bp+0]
 18860                                  	; 15/12/2022
 18861 00002C1D 268A4600                	MOV	AL,[ES:BP]
 18862 00002C21 E81A3B                  	call	FLUSHBUF
 18863 00002C24 7234                    	JC	short No_fileJ
 18864                                  ;
 18865                                  ; Now we need to test FoundDel for our flags. The cases to consider are:
 18866                                  ;
 18867                                  ;   not found not deleted		file not found
 18868                                  ;   not found	  deleted		*** impossible ***
 18869                                  ;	found not deleted		access denied (read-only)
 18870                                  ;	found	  deleted		no error
 18871                                  ;
 18872 00002C26 F606[6F05]10            	TEST	byte [FOUNDDEL],FILEDELETED ; did we delete a file?
 18873 00002C2B 7426                    	JZ	short DelError		; no, figure out what's wrong.
 18874                                  
 18875                                  ; We set VOLCHNG_FLAG to indicate that we have changed the volume label
 18876                                  ; and to force the DOS to issue a media check.
 18877                                  
 18878 00002C2D F606[6B05]08            	TEST	byte [ATTRIB],attr_volume_id ; 8
 18879 00002C32 741C                    	jz	short No_Set_Flag
 18880 00002C34 50                      	PUSH	AX
 18881 00002C35 06                      	PUSH	ES
 18882 00002C36 57                      	PUSH	DI
 18883 00002C37 C43E[A205]              	LES	DI,[THISCDS]
 18884 00002C3B 268A25                  	MOV	AH,[ES:DI]		; Get drive
 18885 00002C3E 80EC41                  	SUB	AH,'A'                  ; Convert to 0-based
 18886 00002C41 8826[A10A]              	mov	[VOLCHNG_FLAG],AH
 18887                                  	
 18888                                  	; MSDOS 6.0
 18889 00002C45 30FF                    	XOR	BH,BH			;>32mb delete volume id from boot record ;AN000;
 18890 00002C47 E87C04                  	call	Set_Media_ID		;>32mb set volume id to boot record	 ;AN000;
 18891                                  	 
 18892 00002C4A E8B435                  	call	FATREAD_CDS		; force media check
 18893 00002C4D 5F                      	POP	DI
 18894 00002C4E 07                      	POP	ES
 18895 00002C4F 58                      	POP	AX
 18896                                  No_Set_Flag:
 18897                                  	;call	LCritDisk		; carry is clear
 18898                                  	;retn
 18899                                  	; 18/12/2022
 18900 00002C50 E95EEC                  	jmp	LCritDisk
 18901                                  DelError:
 18902 00002C53 F606[6F05]01            	TEST	byte [FOUNDDEL],FILEFOUND ; not deleted. Did we find file?
 18903 00002C58 7503                    	JNZ	short Del_access_errJ 	; yes. Access denied
 18904                                  No_fileJ:
 18905 00002C5A E917FF                  	JMP	No_file ; 10/08/2018 		; Nope
 18906                                  Del_access_errJ:
 18907 00002C5D E929FF                  	JMP	Del_access_err ; 10/08/2018
 18908                                  
 18909                                  ; 08/08/2018 - Retro DOS v3.0
 18910                                  
 18911                                  ;Break	<REN_DEL_Check - check for access for rename and delete>
 18912                                  ;---------------------------------------------------------------------------
 18913                                  ; Procedure Name : REN_DEL_Check
 18914                                  ;
 18915                                  ; Inputs:
 18916                                  ;	[THISDPB] set
 18917                                  ;	[CURBUF+2]:BX points to entry
 18918                                  ;	[CURBUF+2]:SI points to firclus field of entry
 18919                                  ;	[WFP_Start] points to name
 18920                                  ; Function:
 18921                                  ;	Check for Exclusive access on given file.
 18922                                  ;	  Used by RENAME, SET_FILE_INFO, and DELETE.
 18923                                  ; Outputs:
 18924                                  ;	ES:BP = [THISDPB]
 18925                                  ;	NOTE: The WFP string pointed to by [WFP_Start] Will be Modified. The
 18926                                  ;		last element will be loaded from the directory entry. This is
 18927                                  ;		so the name given to the sharer doesn't have any meta chars in
 18928                                  ;		it.
 18929                                  ;	Carry set if sharing violation, INT 24H generated
 18930                                  ;	    NOTE THAT AX IS NOT error_sharing_violation.
 18931                                  ;		This is because input AX is preserved.
 18932                                  ;		Caller must set the error if needed.
 18933                                  ;	Carry clear
 18934                                  ;		OK
 18935                                  ; AX,DS,BX,SI,DI preserved
 18936                                  ;---------------------------------------------------------------------------
 18937                                  
 18938                                  	; 31/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 18939                                  	
 18940                                  REN_DEL_Check:
 18941                                  
 18942 00002C60 1E                      	PUSH	DS
 18943 00002C61 57                      	PUSH	DI
 18944 00002C62 50                      	PUSH	AX
 18945 00002C63 53                      	PUSH	BX
 18946 00002C64 56                      	PUSH	SI		; Save CURBUF pointers
 18947                                  	
 18948 00002C65 16                      	push	ss
 18949 00002C66 07                      	pop	es
 18950                                  
 18951                                  ;hkn; context ES will assume ES to DOSDATA
 18952                                  ;hkn; ASSUME	ES:DOSGROUP
 18953                                  
 18954                                  ;hkn; SS override
 18955 00002C67 368B3E[B205]            	MOV	DI,[SS:WFP_START] ; ES:DI -> WFP
 18956 00002C6C 89DE                    	MOV	SI,BX
 18957                                  
 18958                                  ;hkn; SS override
 18959 00002C6E 368E1E[E405]            	MOV	DS,[SS:CURBUF+2] ; DS:SI -> entry (FCB style name)
 18960 00002C73 89FB                    	MOV	BX,DI		; Set backup limit for skipback
 18961                                  	;ADD	BX,2		; Skip over d: to point to leading '\'
 18962                                  	; 31/01/2024
 18963 00002C75 43                      	inc	bx
 18964 00002C76 43                      	inc	bx
 18965 00002C77 E82CEB                  	call	StrLen		; CX is length of ES:DI including NUL
 18966 00002C7A 49                      	DEC	CX		; Don't include nul in count
 18967 00002C7B 01CF                    	ADD	DI,CX		; Point to NUL at end of string
 18968 00002C7D E8444E                  	call	SkipBack	; Back up one element
 18969 00002C80 47                      	INC	DI		; Point to start of last element
 18970                                  
 18971                                  	; 17/05/2019 - Retro DOS v4.0
 18972                                  ;hkn; SS override
 18973                                  	; MSDOS 6.0
 18974 00002C81 36893E[0106]            	MOV	[SS:SAVE_BX],DI	;IFS. save for DOS_RENAME   ;AN000;
 18975                                  	;
 18976 00002C86 E8C0F9                  	call	PackName	; Transfer name from entry to ASCIZ tail.
 18977 00002C89 5E                      	POP	SI		; Get back entry pointers
 18978 00002C8A 5B                      	POP	BX
 18979 00002C8B 53                      	PUSH	BX
 18980 00002C8C 56                      	PUSH	SI		; Back on stack
 18981                                  	
 18982 00002C8D 16                      	push	ss
 18983 00002C8E 1F                      	pop	ds
 18984                                  
 18985                                  ;hkn; context DS will assume ES to DOSDATA
 18986                                  ;hkn; ASSUME	DS:DOSGROUP
 18987                                  
 18988                                  	; 07/07/2024
 18989                                  	;push	es              ; (not necessary) ; 31/01/2024
 18990                                  	;push	di
 18991                                  
 18992                                  ; Close the file if possible by us.
 18993                                  ;
 18994                                  ;if installed
 18995 00002C8F FF1E[C400]              	Call	far [JShare+(13*4)] ; 13 = ShCloseFile
 18996                                  ;else
 18997                                  ;	Call	ShCloseFile
 18998                                  ;endif
 18999                                  	;;;
 19000                                  	; 31/01/2024 - Retro DOS v5.0
 19001                                  	; PCDOS 7.1 IBMDOS.COM
 19002 00002C93 803E[0303]FF            	cmp	byte [fShare],0FFh
 19003 00002C98 750A                    	jne	short rdc_1
 19004 00002C9A 8C06[A005]              	mov	[THISSFT+2],es
 19005 00002C9E 893E[9E05]              	mov	[THISSFT],di
 19006 00002CA2 EB0A                    	jmp	short rdc_2
 19007                                  rdc_1:
 19008                                  	;;;
 19009 00002CA4 8C1E[A005]              	MOV	[THISSFT+2],DS
 19010                                  
 19011                                  ;hkn; AUXSTACK is in DOSDATA
 19012 00002CA8 C706[9E05][6507]        	MOV	word [THISSFT],AUXSTACK-SF_ENTRY.size  ; RENAMEDMA+(384-59)
 19013                                  				; Scratch space
 19014                                  rdc_2:		; 30/01/2024
 19015                                  	; 07/07/2024
 19016                                  	;pop	di
 19017                                  	;pop	es
 19018                                  	;
 19019 00002CAE 30E4                    	XOR	AH,AH		; Indicate file to DOOPEN (high bit off)
 19020 00002CB0 E82226                  	call	DOOPEN		; Fill in SFT for share check
 19021 00002CB3 C43E[9E05]              	LES	DI,[THISSFT]
 19022                                  	;mov	word [es:di+2],10h
 19023 00002CB7 26C745021000            	MOV	word [ES:DI+SF_ENTRY.sf_mode],SHARING_DENY_BOTH ; 10h
 19024                                  				; requires exclusive access
 19025                                  	;MOV	word [ES:DI+SF_ENTRY.sf_ref_count],1 ; Pretend open
 19026 00002CBD 26C7050100              	mov	word [ES:DI],1
 19027 00002CC2 E84954                  	call	ShareEnter
 19028 00002CC5 720D                    	jc	short CheckDone
 19029 00002CC7 C43E[9E05]              	LES	DI,[THISSFT]
 19030                                  	;MOV	word [ES:DI+SF_ENTRY.sf_ref_count],0
 19031 00002CCB 26C7050000              	mov	word [ES:DI],0	; Pretend closed and free
 19032                                  	
 19033 00002CD0 E83654                  	call	ShareEnd	; Tell sharer we're done with THISSFT
 19034 00002CD3 F8                      	CLC
 19035                                  CheckDone:
 19036 00002CD4 C42E[8A05]              	LES	BP,[THISDPB]
 19037 00002CD8 5E                      	POP	SI
 19038 00002CD9 5B                      	POP	BX
 19039 00002CDA 58                      	POP	AX
 19040 00002CDB 5F                      	POP	DI
 19041 00002CDC 1F                      	POP	DS
 19042 00002CDD C3                      	retn
 19043                                  
 19044                                  ;============================================================================
 19045                                  ; RENAME.ASM, MSDOS 6.0, 1991
 19046                                  ;============================================================================
 19047                                  ; 08/08/2018 - Retro DOS v3.0
 19048                                  ; 17/05/2019 - Retro DOS v4.0
 19049                                  
 19050                                  ;	TITLE	DOS_RENAME - Internal RENAME call for MS-DOS
 19051                                  ;	NAME	DOS_RENAME
 19052                                  
 19053                                  ;**	Low level routine for renaming files
 19054                                  ;----------------------------------------------------------------------------
 19055                                  ;	DOS_RENAME
 19056                                  ;
 19057                                  ;	Modification history:
 19058                                  ;
 19059                                  ;	    Created: ARR 30 March 1983
 19060                                  
 19061                                  ;----------------------------------------------------------------------------
 19062                                  ;
 19063                                  ; Procedure Name : DOS_RENAME
 19064                                  ;
 19065                                  ; Inputs:
 19066                                  ;	[WFP_START] Points to SOURCE WFP string ("d:/" must be first 3
 19067                                  ;		chars, NUL terminated)
 19068                                  ;	[CURR_DIR_END] Points to end of Current dir part of string [SOURCE]
 19069                                  ;		( = -1 if current dir not involved, else
 19070                                  ;		 Points to first char after last "/" of current dir part)
 19071                                  ;	[REN_WFP] Points to DEST WFP string ("d:/" must be first 3
 19072                                  ;		chars, NUL terminated)
 19073                                  ;	[THISCDS] Points to CDS being used
 19074                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 19075                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 19076                                  ; Function:
 19077                                  ;	Rename the specified file(s)
 19078                                  ;	NOTE: This routine uses most of AUXSTACK as a temp buffer.
 19079                                  ; Outputs:
 19080                                  ;	CARRY CLEAR
 19081                                  ;	    OK
 19082                                  ;	CARRY SET
 19083                                  ;	    AX is error code
 19084                                  ;		error_file_not_found
 19085                                  ;			No match for source, or dest path invalid
 19086                                  ;		error_not_same_device
 19087                                  ;			Source and dest are on different devices
 19088                                  ;		error_access_denied
 19089                                  ;			Directory specified (not simple rename),
 19090                                  ;			Device name given, Destination exists.
 19091                                  ;			NOTE: In third case some renames may have
 19092                                  ;			 been done if metas.
 19093                                  ;		error_path_not_found
 19094                                  ;			Bad path (not in curr dir part if present)
 19095                                  ;			SOURCE ONLY
 19096                                  ;		error_bad_curr_dir
 19097                                  ;			Bad path in current directory part of path
 19098                                  ;			SOURCE ONLY
 19099                                  ;		error_sharing_violation
 19100                                  ;			Deny both access required, generates an INT 24.
 19101                                  ; DS preserved, others destroyed
 19102                                  ;
 19103                                  ;----------------------------------------------------------------------------
 19104                                  
 19105                                  	; 14/11/2022 Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 19106                                  	; 31/01/2024 Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 19107                                  
 19108                                  DOS_RENAME:
 19109                                  
 19110                                  ;hkn; DOS_RENAME is called from file.asm and fcbio.asm. DS has been set up
 19111                                  ;hkn; at this point to DOSDATA.
 19112                                  
 19113 00002CDE E825EB                  	call	TestNet
 19114 00002CE1 7306                    	JNC	short LOCAL_RENAME
 19115                                  
 19116                                  ;IF NOT Installed
 19117                                  ;	transfer NET_RENAME
 19118                                  ;ELSE
 19119                                  	;MOV	AX,(MultNET SHL 8) OR 17
 19120                                  	;INT	2FH
 19121                                  	;return
 19122                                  
 19123 00002CE3 B81111                  	mov     ax, 1111h
 19124 00002CE6 CD2F                    	int     2Fh 	; Multiplex - NETWORK REDIRECTOR - RENAME REMOTE FILE
 19125                                  			; SS = DS = DOS CS, 
 19126                                  			; SDA first filename pointer = offset of fully-qualified old name
 19127                                  			; SDA CDS pointer -> current directory
 19128                                  			; Return: CF set on error
 19129 00002CE8 C3                      	retn
 19130                                  ;ENDIF
 19131                                  
 19132                                  LOCAL_RENAME:
 19133 00002CE9 C606[2303]02            	MOV	byte [EXTERR_LOCUS],errLOC_Disk ; 2
 19134 00002CEE 8B36[B205]              	MOV	SI,[WFP_START]
 19135 00002CF2 8B3E[B405]              	MOV	DI,[REN_WFP]
 19136 00002CF6 8A04                    	MOV	AL,[SI]
 19137 00002CF8 8A25                    	MOV	AH,[DI]
 19138 00002CFA 0D2020                  	OR	AX,2020H		; Lower case
 19139 00002CFD 38E0                    	CMP	AL,AH
 19140 00002CFF 7405                    	JZ	short SAMEDRV
 19141 00002D01 B81100                  	MOV	AX,error_not_same_device ; 11h
 19142 00002D04 F9                      	STC
 19143 00002D05 C3                      	retn
 19144                                  
 19145                                  SAMEDRV:
 19146 00002D06 FF36[2E03]              	PUSH	WORD [DMAADD+2]
 19147 00002D0A FF36[2C03]              	PUSH	WORD [DMAADD]
 19148 00002D0E 8C1E[2E03]              	MOV	[DMAADD+2],DS
 19149                                  
 19150                                  ;hkn; RENAMEDMA is in DOSDATA
 19151 00002D12 C706[2C03][2006]        	MOV	WORD [DMAADD],RENAMEDMA
 19152 00002D18 C606[7005]00            	MOV	byte [FOUND_DEV],0	; Rename fails on DEVS, assume not a dev
 19153 00002D1D E864EB                  	call	ECritDisk
 19154 00002D20 E81A07                  	call	DOS_SEARCH_FIRST	; Sets [NoSetDir] to 1, [CURBUF+2]:BX
 19155                                  					;    points to entry
 19156 00002D23 7314                    	JNC	short Check_Dev
 19157 00002D25 83F812                  	CMP	AX,error_no_more_files ; 12h
 19158 00002D28 7503                    	JNZ	short GOTERR
 19159 00002D2A B80200                  	MOV	AX,error_file_not_found ; 2
 19160                                  GOTERR:
 19161 00002D2D F9                      	STC
 19162                                  RENAME_POP:
 19163 00002D2E 8F06[2C03]              	POP	WORD [DMAADD]
 19164 00002D32 8F06[2E03]              	POP	WORD [DMAADD+2]
 19165                                  	;call	LCritDisk
 19166                                  	;retn
 19167                                  	; 16/12/2022
 19168 00002D36 E978EB                  	jmp	LCritDisk
 19169                                  
 19170                                  Check_Dev:
 19171                                  	; 17/05/2019 - Retro DOS v4.0
 19172                                  	;mov	ax,5
 19173 00002D39 B80500                  	MOV	AX,error_access_denied	; Assume error
 19174                                  	
 19175                                  	; MSDOS 6.0
 19176 00002D3C 1E                      	PUSH	DS			      ;PTM.			    ;AN000;
 19177 00002D3D C536[2C03]              	LDS	SI,[DMAADD]		      ;PTM.  check if source a dir  ;AN000;
 19178                                  	;add	si,21
 19179 00002D41 83C615                  	ADD	SI,find_buf.attr	      ;PTM.			    ;AN000;
 19180                                  	;test	byte [si+11],10h
 19181 00002D44 F6440B10                	TEST	byte [SI+dir_entry.dir_attr],attr_directory ;PTM.	    ;AN000;
 19182 00002D48 7407                    	JZ	short notdir		      ;PTM.			    ;AN000;
 19183 00002D4A 8B36[B405]              	MOV	SI,[REN_WFP]		      ;PTM.  if yes, make sure path ;AN000;
 19184 00002D4E E8A5FA                  	call	Check_PathLen2		      ;PTM.   length < 67	    ;AN000;
 19185                                  notdir:
 19186 00002D51 1F                      	POP	DS			      ;PTM.			    ;AN000;
 19187 00002D52 77D9                    	JA	short GOTERR		      ;PTM.			    ;AN000;
 19188                                  
 19189                                  	; MSDOS 3.3 & MSDOS 6.0
 19190 00002D54 803E[7005]00            	CMP	byte [FOUND_DEV],0
 19191 00002D59 75D2                    	JNZ	short GOTERR
 19192                                  
 19193                                  ; At this point a source has been found. There is search continuation info (a
 19194                                  ; la DOS_SEARCH_NEXT) for the source at RENAMEDMA, together with the first
 19195                                  ; directory entry found.
 19196                                  ; [THISCDS], [THISDPB], and [THISDRV] are set and will remain correct
 19197                                  ; throughout the RENAME since it is known at this point that the source and
 19198                                  ; destination are both on the same device.
 19199                                  ; [SATTRIB] is also set.
 19200                                  
 19201 00002D5B 89DE                    	MOV	SI,BX
 19202                                  	;add	si,26
 19203 00002D5D 83C61A                  	ADD	SI,dir_entry.dir_first
 19204 00002D60 E8FDFE                  	call	REN_DEL_Check
 19205 00002D63 7305                    	JNC	short REN_OK1
 19206 00002D65 B82000                  	MOV	AX,error_sharing_violation  ; 20h
 19207 00002D68 EBC4                    	JMP	short RENAME_POP
 19208                                  
 19209                                  ;------------------------------------------------------------------------------
 19210                                  ; Check if the source is a file or directory. If file, delete the entry
 19211                                  ; from the Fastopen cache. If directory, rename it later
 19212                                  ;------------------------------------------------------------------------------
 19213                                  
 19214                                  REN_OK1:				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 19215                                  	; MSDOS 6.0
 19216                                  	; 31/01/2024 (PCDOS 7.1 IBMDOS.COM)
 19217                                  	;PUSH	SI
 19218 00002D6A C536[2C03]              	LDS	SI,[DMAADD]		;BN00X; PTM. check if source a dir ;AN000;
 19219                                  	;add	si,21
 19220 00002D6E 83C615                  	ADD	SI,find_buf.attr	;;BN00XPTM.P5520		;AN000;
 19221                                  	;test	byte [si+11],10h
 19222 00002D71 F6440B10                	TEST	byte [SI+dir_entry.dir_attr],attr_directory ;;BN00XPTM. ;AN000;
 19223                                  	;JZ	short NOT_DIR1		;;BN00XPTM.			;AN000;
 19224 00002D75 7500                    	jnz	short SWAP_SOURCE ; 31/01/2024
 19225                                  	;POP	SI			;BN00X
 19226                                  	;JMP	SHORT SWAP_SOURCE	;BN00X
 19227                                  ;NOT_DIR1:				;;BN00X it is a file, delete the entry
 19228                                  	;POP	SI
 19229                                  
 19230                                  	; 03/03/2025
 19231                                  	; MSDOS 3.3 (& MSDOS 6.0)
 19232                                  	;call	FastOpen_Delete 	; delete dir info in fastopen DOS 3.3
 19233                                  
 19234                                  SWAP_SOURCE:
 19235                                  	; MSDOS 3.3
 19236                                  	;MOV	SI,[REN_WFP]
 19237                                  	;MOV	[WFP_START],SI
 19238                                  	; MSDOS 6.0
 19239 00002D77 A1[B205]                	MOV	AX,[WFP_START]		; Swap source and destination
 19240 00002D7A 8B36[B405]              	MOV	SI,[REN_WFP]		; Swap source and destination
 19241 00002D7E 8936[B205]              	MOV	[WFP_START],SI		; WFP_START = Destination path
 19242 00002D82 A3[B405]                	MOV	[REN_WFP],AX		; REN_WFP   = Source path
 19243                                  	; MSDOS 3.3 (& MSDOS 6.0)
 19244 00002D85 C706[B605]FFFF          	MOV	word [CURR_DIR_END],-1	; No current dir on dest
 19245                                  	;mov	word [CREATING],0E5FFh
 19246 00002D8B C706[7E05]FFE5          	MOV	WORD [CREATING],DIRFREE*256+0FFh  ; Creating, not DEL *.*
 19247                                  					; A rename is like a CREATE_NEW as far
 19248                                  					; as the destination is concerned.
 19249 00002D91 E8361C                  	call	GetPathNoSet
 19250                                  
 19251                                  ;   If this GETPATH fails due to file not found, we know all renames will work
 19252                                  ;   since no files match the destination name. If it fails for any other
 19253                                  ;   reason, the rename fails on a path not found, or whatever (also fails if
 19254                                  ;   we find a device or directory). If the GETPATH succeeds, we aren't sure
 19255                                  ;   if the rename should fail because we haven't built an explicit name by
 19256                                  ;   substituting for the meta chars in it. In this case the destination file
 19257                                  ;   spec with metas is in [NAME1] and the explicit source name is at RENAMEDMA
 19258                                  ;   in the directory entry part.
 19259                                  	
 19260 00002D94 722A                    	JC	short NODEST
 19261                                  	
 19262                                  	; MSDOS 6.0
 19263                                  	;JZ	short BAD_ACC 		; Dest string is a directory	;AC000;
 19264                                  	; !! MSDOS 3.3 !!
 19265                                  	;JZ	short BAD_ACC ; !!	; Dest string is a directory
 19266                                  
 19267 00002D96 08E4                    	OR	AH,AH			; Device?
 19268 00002D98 7933                    	JNS	short SAVEDEST		; No, continue
 19269                                  BAD_ACC:
 19270 00002D9A B80500                  	MOV	AX,error_access_denied
 19271 00002D9D F9                      	STC
 19272                                  RENAME_CLEAN:
 19273 00002D9E 9C                      	PUSHF				; Save carry state
 19274 00002D9F 50                      	PUSH	AX			; and error code (if carry set)
 19275                                  	;;;
 19276                                  	; 31/01/2024 - Retro DOS v5.0
 19277                                  	; (PCDOS 7.1 IBMDOS.COM)
 19278 00002DA0 C42E[8A05]              	les	bp,[THISDPB]
 19279 00002DA4 E8E405                  	call	update_fat32_fsinfo
 19280                                  	;;;
 19281 00002DA7 A0[7605]                	MOV	AL,[THISDRV]
 19282 00002DAA E89139                  	call	FLUSHBUF
 19283 00002DAD 58                      	POP	AX
 19284 00002DAE 803E[4A03]00            	CMP	byte [FAILERR],0
 19285 00002DB3 7504                    	JNZ	short BAD_ERR		; User FAILed to I 24
 19286 00002DB5 9D                      	POPF
 19287 00002DB6 E975FF                  	JMP	RENAME_POP
 19288                                  
 19289                                  BAD_ERR:
 19290 00002DB9 58                      	POP	AX			; Saved flags
 19291                                  	; 16/12/202
 19292                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 19293                                  BAD_PATH: ; *
 19294 00002DBA B80300                  	MOV	AX,error_path_not_found
 19295 00002DBD E96DFF                  	JMP	GOTERR
 19296                                  
 19297                                  NODEST:
 19298 00002DC0 75F8                    	JNZ	short BAD_PATH
 19299 00002DC2 803E[4A03]00            	CMP	byte [FAILERR],0
 19300 00002DC7 75F1                    	JNZ	short BAD_PATH		; Search for dest failed 
 19301                                  					; because user FAILed on I 24
 19302                                  	; 14/11/2022
 19303 00002DC9 08C9                    	OR	CL,CL
 19304                                  	;JNZ	short SAVEDEST
 19305                                  	; 17/05/2019
 19306 00002DCB 74ED                    	jz	short BAD_PATH ; *
 19307                                  ;BAD_PATH: ; *
 19308                                  ;	MOV	AX,error_path_not_found
 19309                                  ;	;STC
 19310                                  ;	;JMP	RENAME_POP
 19311                                  ;	; 17/05/2019
 19312                                  ;	jmp	GOTERR 
 19313                                  
 19314                                  ; 16/12/2022
 19315                                  %if 0
 19316                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 19317                                  	or	cl,cl
 19318                                  	jnz	short SAVEDEST
 19319                                  	;jz	short BAD_PATH ; *
 19320                                  BAD_PATH: ; *
 19321                                  	;mov	ax,3
 19322                                  	mov	ax,error_path_not_found
 19323                                  	stc
 19324                                  	jmp	RENAME_POP
 19325                                  %endif
 19326                                  
 19327                                  SAVEDEST:
 19328 00002DCD 16                      	push	ss
 19329 00002DCE 07                      	pop	es
 19330                                  
 19331                                  ;hkn; NAME1 & NAME2 is in DOSDATA
 19332 00002DCF BF[5705]                	MOV	DI,NAME2
 19333 00002DD2 BE[4B05]                	MOV	SI,NAME1
 19334                                  
 19335 00002DD5 B90B00                  	MOV	CX,11
 19336 00002DD8 F3A4                    	REP	MOVSB			; Save dest with metas at NAME2
 19337                                  	;;;
 19338                                  	; 31/01/2024
 19339                                  	; (PCDOS 7.1 IBMDOS.COM)
 19340 00002DDA A1[DC0A]                	mov	ax,[DIRSTART_HW]
 19341 00002DDD A3[E60A]                	mov	[DESTSTART_HW],ax
 19342                                  	;;;
 19343 00002DE0 A1[C205]                	MOV	AX,[DIRSTART]
 19344 00002DE3 A3[6405]                	MOV	[DESTSTART],AX
 19345                                  BUILDDEST:
 19346                                  	; 31/01/2024
 19347                                  	;push	ss
 19348                                  	;pop	es			; needed due to JMP BUILDDEST below
 19349                                  
 19350                                  ;hkn; RENAMEDMA, NAME1, NAME2 in DOSDATA
 19351 00002DE6 BB[3506]                	MOV	BX,RENAMEDMA+21		; Source of replace chars
 19352 00002DE9 BF[4B05]                	MOV	DI,NAME1		; Real dest name goes here
 19353 00002DEC BE[5705]                	MOV	SI,NAME2		; Raw dest
 19354                                  
 19355 00002DEF B90B00                  	MOV	CX,11
 19356                                  
 19357                                  	; 17/05/2019 - Retro DOS v4.0
 19358                                  
 19359                                  	; MSDOS 6.0
 19360 00002DF2 E81401                  	CALL	NEW_RENAME		;IFS. replace ? chars	;AN000;
 19361                                  
 19362                                  	; MSDOS 3.3
 19363                                  
 19364                                  ; 08/08/2018 - Retro DOS v3.0
 19365                                  ; MSDOS 6.0 
 19366                                  ;---------------------------------------------------------------------------
 19367                                  ;Procedure: NEW_RENAME
 19368                                  ;
 19369                                  ;Input: DS:SI -> raw string with ?
 19370                                  ;	ES:DI -> destination string
 19371                                  ;	DS:BX -> source string
 19372                                  ;Function: replace ? chars of raw string with chars in source string and
 19373                                  ;	   put in destination string
 19374                                  ;Output: ES:DI-> new string
 19375                                  ;---------------------------------------------------------------------------
 19376                                  ;
 19377                                  ;NEW_RENAME:
 19378                                  ;NEWNAM:
 19379                                  ;	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 341Ah
 19380                                  ;	LODSB
 19381                                  ;	CMP	AL,"?"
 19382                                  ;	JNZ	short NOCHG
 19383                                  ;	MOV	AL,[BX] 		; Get replace char
 19384                                  ;NOCHG:
 19385                                  ;	STOSB
 19386                                  ;	INC	BX			; Next replace char
 19387                                  ;	LOOP	NEWNAM
 19388                                  ;	; MSDOS 6.0
 19389                                  ;	;retn
 19390                                  
 19391                                  	; MSDOS 3.3 & MSDOS 6.0
 19392                                  	;mov	byte [ATTRIB],16h
 19393 00002DF5 C606[6B05]16            	MOV	byte [ATTRIB],attr_all	; Stop duplicates with any attributes
 19394 00002DFA C606[7E05]FF            	MOV	byte [CREATING],0FFH
 19395 00002DFF E8F91D                  	call	DEVNAME 		; Check if we built a device name
 19396 00002E02 7396                    	JNC	short BAD_ACC
 19397                                  	;;;
 19398                                  	; 31/01/2024
 19399                                  	; (PCDOS 7.1 IBMDOS.COM)
 19400 00002E04 8B1E[E60A]              	mov	bx,[DESTSTART_HW]
 19401 00002E08 891E[EE0A]              	mov	[ROOTCLUST_HW],bx
 19402                                  	;;;
 19403 00002E0C 8B1E[6405]              	MOV	BX,[DESTSTART]
 19404 00002E10 C42E[8A05]              	LES	BP,[THISDPB]
 19405 00002E14 E8001A                  	call	SETDIRSRCH		; Reset search to start of dir
 19406 00002E17 7281                    	JC	short BAD_ACC 		; Screw up
 19407 00002E19 E8DD17                  	call	FINDENTRY		; See if new name already exists
 19408                                  	;JNC	short BAD_ACC 		; Error if found
 19409                                  	; 31/01/2024
 19410 00002E1C 7346                    	jnc	short BAD_ACCJ
 19411 00002E1E 803E[4A03]00            	CMP	byte [FAILERR],0
 19412 00002E23 753F                    	JNZ	short BAD_ACCJ		; Find failed because user FAILed to I 24
 19413 00002E25 A1[6405]                	MOV	AX,[DESTSTART]		; DIRSTART of dest
 19414                                  	;;;
 19415                                  	; 31/01/2024
 19416 00002E28 8B16[E60A]              	mov	dx,[DESTSTART_HW]
 19417 00002E2C C42E[8A05]              	les	bp,[THISDPB]
 19418 00002E30 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 19419                                  	;cmp	word [es:bp+0Fh],0
 19420 00002E35 7506                    	jnz	short builddst_1	; not FAT32
 19421 00002E37 3B16[3106]              	cmp	dx,[RENAMEDMA+17]	; DIRSTART_HW of source
 19422 00002E3B 7506                    	jne	short builddst_2
 19423                                  builddst_1:
 19424                                  	;;;
 19425 00002E3D 3B06[2F06]              	CMP	AX,[RENAMEDMA+15]	; DIRSTART of source
 19426 00002E41 7451                    	JZ	short SIMPLE_RENAME	; If =, just give new name
 19427                                  builddst_2:	; 31/01/2024
 19428                                  	;mov	al,[RENAMEDMA+32]
 19429 00002E43 A0[4006]                	MOV	AL,[RENAMEDMA+21+dir_entry.dir_attr]
 19430 00002E46 A810                    	TEST	AL,attr_directory ; 10h
 19431 00002E48 751A                    	JNZ	short BAD_ACCJ		; Can only do a simple rename on dirs,
 19432                                  					; otherwise the . and .. entries get
 19433                                  					; wiped.
 19434 00002E4A A2[6B05]                	MOV	[ATTRIB],AL
 19435 00002E4D 8C1E[A005]              	MOV	[THISSFT+2],DS
 19436                                  
 19437                                  ;hkn; AUXSTACK is in DOSDATA
 19438                                  	;mov	si,RENAMEDMA+145h
 19439 00002E51 BE[6507]                	MOV	SI,AUXSTACK-SF_ENTRY.size ; RENAMEDMA+325
 19440 00002E54 8936[9E05]              	MOV	[THISSFT],SI
 19441                                  	;mov	word [SI+2],2
 19442 00002E58 C744020200              	MOV	word [SI+SF_ENTRY.sf_mode],SHARING_COMPAT+open_for_both
 19443 00002E5D 31C9                    	XOR	CX,CX			; Set "device ID" for call into makenode
 19444 00002E5F E8EF22                  	call	RENAME_MAKE		; This is in mknode
 19445 00002E62 7303                    	JNC	short GOT_DEST
 19446                                  BAD_ACCJ:
 19447 00002E64 E933FF                  	JMP	BAD_ACC
 19448                                  
 19449                                  GOT_DEST:
 19450 00002E67 53                      	push	bx
 19451 00002E68 C43E[9E05]              	LES	DI,[THISSFT]		; RENAME_MAKE entered this into sharing
 19452 00002E6C E89A52                  	call	ShareEnd		; we need to remove it.
 19453 00002E6F 5B                      	pop	bx
 19454                                  
 19455                                  ; A zero length entry with the correct new name has now been made at
 19456                                  ;   [CURBUF+2]:BX.
 19457                                  
 19458 00002E70 C43E[E205]              	LES	DI,[CURBUF]
 19459                                  
 19460                                  ; 31/01/2024 - Retro DOS v5.0
 19461                                  %if 0
 19462                                  	; MSDOS 6.0
 19463                                  	;test	byte [es:di+5],40h
 19464                                  	TEST	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty  
 19465                                  					;LB. if already dirty		  ;AN000;
 19466                                  	JNZ	short yesdirty1		;LB.  don't increment dirty count ;AN000;
 19467                                  	call	INC_DIRTY_COUNT 	;LB.				  ;AN000;
 19468                                  	;or	byte [es:di+5],40h
 19469                                  	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 19470                                  yesdirty1:
 19471                                  %else
 19472                                  	; 31/01/2024 (PCDOS 7.1 IBMDOS.COM)
 19473 00002E74 E8ED39                  	call	SET_BUF_DIRTY
 19474                                  %endif
 19475 00002E77 89DF                    	MOV	DI,BX
 19476                                  	;add	di,11
 19477 00002E79 83C70B                  	ADD	DI,dir_entry.dir_attr	; Skip name
 19478                                  
 19479                                  ;hkn; RENAMEDMA is in DOSDATA
 19480                                  	;mov	si,RENAMEDMA+32 ; 05/07/2024
 19481 00002E7C BE[4006]                	MOV	SI,RENAMEDMA+21+dir_entry.dir_attr
 19482                                  	;mov	cx,21
 19483 00002E7F B91500                  	MOV	CX,dir_entry.size-dir_entry.dir_attr
 19484 00002E82 F3A4                    	REP	MOVSB
 19485 00002E84 E85C00                  	CALL	GET_SOURCE
 19486 00002E87 7257                    	JC	short RENAME_OVER
 19487 00002E89 89DF                    	MOV	DI,BX
 19488 00002E8B 8E06[E405]              	MOV	ES,[CURBUF+2]
 19489 00002E8F B0E5                    	MOV	AL,DIRFREE ; 0E5h
 19490 00002E91 AA                      	STOSB				; "free" the source
 19491 00002E92 EB13                    	JMP	SHORT DIRTY_IT
 19492                                  
 19493                                  SIMPLE_RENAME:
 19494 00002E94 E84C00                  	CALL	GET_SOURCE		; Get the source back
 19495 00002E97 7247                    	JC	short RENAME_OVER
 19496 00002E99 89DF                    	MOV	DI,BX
 19497 00002E9B 8E06[E405]              	MOV	ES,[CURBUF+2]
 19498                                  
 19499                                  ;hkn; NAME1 is in DOSDATA
 19500 00002E9F BE[4B05]                	MOV	SI,NAME1		; New Name
 19501 00002EA2 B90B00                  	MOV	CX,11
 19502 00002EA5 F3A4                    	REP	MOVSB
 19503                                  DIRTY_IT:
 19504 00002EA7 8B3E[E205]              	MOV	DI,[CURBUF]
 19505                                  
 19506                                  ; 31/01/2024 - Retro DOS v5.0
 19507                                  %if 0
 19508                                  	; MSDOS 6.0
 19509                                  	TEST	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty  
 19510                                  					;LB. if already dirty		  ;AN000;
 19511                                  	JNZ	short yesdirty2		;LB.  don't increment dirty count ;AN000;
 19512                                  	call	INC_DIRTY_COUNT 	;LB.				  ;AN000;
 19513                                  	
 19514                                  	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 19515                                  %else
 19516                                  	; 31/01/2024 (PCDOS 7.1 IBMDOS.COM)
 19517 00002EAB E8B639                  	call	SET_BUF_DIRTY
 19518                                  %endif
 19519                                  	
 19520                                  ;------------------------------------------------------------------------------
 19521                                  ; Check if the source is a directory of file. If directory rename it to the
 19522                                  ; the new name in the Fastopen cache buffer. If file name it has been
 19523                                  ; previously deleted.
 19524                                  ;------------------------------------------------------------------------------
 19525                                  
 19526                                  ;yesdirty2:	; 31/01/2024
 19527                                  	; MSDOS 6.0
 19528 00002EAE 56                      	PUSH	SI
 19529 00002EAF C536[2C03]              	LDS	SI,[DMAADD]		;;BN00XPTM. chek if source a dir ;AN000;
 19530                                  	;add	si,21
 19531 00002EB3 83C615                  	ADD	SI,find_buf.attr	;;BN00XPTM.P5520		;AN000;
 19532                                  	;test	byte [si+0Bh],10h
 19533 00002EB6 F6440B10                	TEST	byte [SI+dir_entry.dir_attr],attr_directory ;;BN00XPTM.	;AN000;
 19534 00002EBA 7400                    	JZ	short NOT_DIR2		;;BN00XPTM.			;AN000;
 19535                                  	
 19536                                  	; 03/03/2025 (MiniDOS)
 19537                                  	;call	FastOpen_Rename		;;BN00X rename dir entry in fastopen
 19538                                  	
 19539                                  	; 31/01/2024
 19540                                  	;POP	SI
 19541                                  	;JMP	SHORT NOT_DIRTY1
 19542                                  NOT_DIR2:				;;BN00X it is a file, delete the entry
 19543 00002EBC 5E                      	POP	SI
 19544                                  NOT_DIRTY1:				;;BN00X
 19545                                  NEXT_SOURCE:
 19546                                  ;hkn; RENAMEDMA is in DOSDATA
 19547 00002EBD BE[2106]                	MOV	SI,RENAMEDMA+1		;Name
 19548                                  
 19549                                  ; WARNING! Rename_Next leaves the disk critical section *ALWAYS*. We need
 19550                                  ; to enter it before going to RENAME_Next.
 19551                                  
 19552 00002EC0 E8C1E9                  	call	ECritDisk
 19553 00002EC3 C606[7E05]00            	MOV	byte [CREATING],0 ; Correct setting for search (we changed it
 19554                                  				  ;  to FF when we made the prev new file).
 19555 00002EC8 E88406                  	call	RENAME_NEXT
 19556                                  
 19557                                  ; Note, now, that we have exited the previous ENTER and so are back to where
 19558                                  ; we were before.
 19559                                  
 19560 00002ECB 7213                    	JC	short RENAME_OVER
 19561                                  
 19562                                  	;lea	si,[bx+26]
 19563 00002ECD 8D771A                  	LEA	SI,[BX+dir_entry.dir_first]
 19564 00002ED0 E88DFD                  	call	REN_DEL_Check
 19565 00002ED3 7306                    	JNC	short REN_OK2
 19566 00002ED5 B82000                  	MOV	AX,error_sharing_violation ; 20h
 19567                                  jmp_to_rename_clean: ; 28/12/2022
 19568 00002ED8 E9C3FE                  	JMP	RENAME_CLEAN ; 10/08/2018
 19569                                  
 19570                                  	; 03/03/2025 (MiniDOS)
 19571                                  REN_OK2:
 19572                                  ; 31/01/2024
 19573 00002EDB 16                      	push	ss
 19574 00002EDC 07                      	pop	es
 19575 00002EDD E906FF                  	JMP	BUILDDEST		;;BN00X
 19576                                  
 19577                                  RENAME_OVER:
 19578 00002EE0 F8                      	CLC
 19579                                  	;JMP	RENAME_CLEAN ; 10/08/2018
 19580                                  	; 28/12/2022
 19581 00002EE1 EBF5                    	jmp	short jmp_to_rename_clean
 19582                                  
 19583                                  ;----------------------------------------------------------------------------
 19584                                  ; Procedure: GET_SOURCE
 19585                                  ;
 19586                                  ; Inputs:
 19587                                  ;	RENAMEDMA has source info
 19588                                  ; Function:
 19589                                  ;	Re-find the source
 19590                                  ; Output:
 19591                                  ;	[CURBUF] set
 19592                                  ;	[CURBUF+2]:BX points to entry
 19593                                  ;	Carry set if error (currently user FAILed to I 24)
 19594                                  ; DS preserved, others destroyed
 19595                                  ;----------------------------------------------------------------------------
 19596                                  
 19597                                  GET_SOURCE:
 19598                                  	;;;
 19599                                  	; 01/02/2024 - Retro DOS v5.0
 19600                                  	; (PCDOS 7.1 IBMDOS.COM)
 19601 00002EE3 C42E[8A05]              	les	bp,[THISDPB]
 19602 00002EE7 31DB                    	xor	bx,bx ; 0
 19603                                  	;cmp	[es:bp+0Fh],bx
 19604 00002EE9 26395E0F                	cmp	[es:bp+DPB.FAT_SIZE],bx ; > 0 ?
 19605 00002EED 7504                    	jnz	short gs_cont		; yes, it is not FAT32
 19606 00002EEF 8B1E[3106]              	mov	bx,[RENAMEDMA+17]	; DirStart+2
 19607                                  gs_cont:
 19608 00002EF3 891E[EE0A]              	mov	[ROOTCLUST_HW],bx	; hw of cluster number
 19609                                  	;;;
 19610 00002EF7 8B1E[2F06]              	MOV	BX,[RENAMEDMA+15]	; DirStart
 19611                                  	; 01/02/2024
 19612                                  	;LES	BP,[THISDPB]
 19613 00002EFB E81919                  	call	SETDIRSRCH
 19614 00002EFE 7214                    	JC	short gs_ret_label	; retc
 19615 00002F00 E8D71C                  	call	STARTSRCH
 19616 00002F03 A1[2D06]                	MOV	AX,[RENAMEDMA+13]	; Lastent
 19617                                  	;call	GETENT
 19618                                  	; 18/12/2022
 19619 00002F06 E95118                  	jmp	GETENT
 19620                                  ;gs_ret_label:
 19621                                  	;retn
 19622                                  
 19623                                  ; MSDOS 6.0 
 19624                                  ;---------------------------------------------------------------------------
 19625                                  ;Procedure: NEW_RENAME
 19626                                  ;
 19627                                  ;Input: DS:SI -> raw string with ?
 19628                                  ;	ES:DI -> destination string
 19629                                  ;	DS:BX -> source string
 19630                                  ;Function: replace ? chars of raw string with chars in source string and
 19631                                  ;	   put in destination string
 19632                                  ;Output: ES:DI-> new string
 19633                                  ;---------------------------------------------------------------------------
 19634                                  
 19635                                  NEW_RENAME:
 19636                                  	; 17/05/2019 - Retro DOS v4.0
 19637                                  NEWNAM:
 19638                                  	; DOSCODE:680Eh (MSDOS 6.21, MSDOS.SYS)
 19639 00002F09 AC                      	LODSB
 19640 00002F0A 3C3F                    	CMP	AL,"?" ; 3Fh
 19641 00002F0C 7502                    	JNZ	short NOCHG
 19642 00002F0E 8A07                    	MOV	AL,[BX] 		; Get replace char
 19643                                  NOCHG:
 19644 00002F10 AA                      	STOSB
 19645 00002F11 43                      	INC	BX			; Next replace char
 19646 00002F12 E2F5                    	LOOP	NEWNAM
 19647                                  	; MSDOS 6.0
 19648                                  gs_ret_label:	; 18/12/2022
 19649 00002F14 C3                      	retn
 19650                                  
 19651                                  ;============================================================================
 19652                                  ; FINFO.ASM, MSDOS 6.0, 1991
 19653                                  ;============================================================================
 19654                                  ; 08/08/2018 - Retro DOS v3.0
 19655                                  ; 17/05/2019 - Retro DOS v4.0
 19656                                  
 19657                                  ;**	Low level routines for returning file information and setting file
 19658                                  ;	attributes
 19659                                  ;
 19660                                  ;	GET_FILE_INFO
 19661                                  ;	SET_FILE_ATTRIBUTE
 19662                                  ;
 19663                                  ;	Modification history:
 19664                                  ;
 19665                                  ;	    Created: ARR 30 March 1983
 19666                                  ;
 19667                                  ;	M025: Return access_denied if attempting to set
 19668                                  ;	      attribute of root directory.
 19669                                  ;
 19670                                  
 19671                                  ;SUBTTL GET_FILE_INFO -- Get File Information
 19672                                  
 19673                                  ;---------------------------------------------------------------------------
 19674                                  ; Procedure Name : GET_FILE_INFO
 19675                                  ;
 19676                                  ; Inputs:
 19677                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 19678                                  ;		terminated)
 19679                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 19680                                  ;		( = -1 if current dir not involved, else
 19681                                  ;		 Points to first char after last "/" of current dir part)
 19682                                  ;	[THISCDS] Points to CDS being used
 19683                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 19684                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 19685                                  ; Function:
 19686                                  ;	Get Information about a file
 19687                                  ; Returns:
 19688                                  ;	CARRY CLEAR
 19689                                  ;	    AX = Attribute of file
 19690                                  ;	    CX = Time stamp of file
 19691                                  ;	    DX = Date stamp of file
 19692                                  ;	    BX:DI = Size of file (32 bit)
 19693                                  ;	CARRY SET
 19694                                  ;	    AX is error code
 19695                                  ;		error_file_not_found
 19696                                  ;			Last element of path not found
 19697                                  ;		error_path_not_found
 19698                                  ;			Bad path (not in curr dir part if present)
 19699                                  ;		error_bad_curr_dir
 19700                                  ;			Bad path in current directory part of path
 19701                                  ; DS preserved, others destroyed
 19702                                  ;---------------------------------------------------------------------------
 19703                                  
 19704                                  	; 14/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 19705                                  
 19706                                  GET_FILE_INFO:
 19707                                  
 19708                                  ;hkn; get_file_info is called from file.asm and fcbio.asm. DS has been set 
 19709                                  ;hkn; to DOSDATA at this point. So DOSassume is OK.
 19710                                  
 19711 00002F15 E8EEE8                  	call	TestNet
 19712 00002F18 7306                    	JNC	short LOCAL_INFO
 19713                                  
 19714                                  ;IF NOT Installed
 19715                                  ;	transfer NET_GET_FILE_INFO
 19716                                  ;ELSE
 19717                                  ;	MOV	AX,(MultNET SHL 8) OR 15
 19718                                  ;	INT	2FH
 19719                                  ;	return
 19720                                  
 19721 00002F1A B80F11                  	mov     ax, 110Fh
 19722 00002F1D CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - GET REMOTE FILE'S ATTRIBUTES
 19723                                  			; SS = DOS CS, SDA first filename pointer -> fully-qualified name of file
 19724                                  			; SDA CDS pointer -> current directory
 19725                                  			; Return: CF set on error, AX = file attributes
 19726 00002F1F C3                      	retn
 19727                                  ;ENDIF
 19728                                  
 19729                                  LOCAL_INFO:
 19730 00002F20 E861E9                  	call	ECritDisk
 19731 00002F23 C606[4C03]01            	MOV	byte [NoSetDir],1	; if we find a dir, don't change to it
 19732                                  
 19733                                  	; 03/03/2025 (MiniDOS)
 19734                                  	; MSDOS 3.3
 19735 00002F28 E8991A                  	call	GETPATH
 19736                                  
 19737                                  	; 03/03/2025 (MiniDOS)
 19738                                  	; MSDOS 6.0
 19739                                  	;call	GET_FAST_PATH
 19740                                  
 19741                                  	; MSDOS 3.3 & MSDOS 6.0
 19742 00002F2B 7312                    	JNC	short info_check_dev
 19743                                  NO_PATH:
 19744 00002F2D 750B                    	JNZ	short bad_path1
 19745 00002F2F 08C9                    	OR	CL,CL
 19746 00002F31 7407                    	JZ	short bad_path1
 19747                                  info_no_file:
 19748 00002F33 B80200                  	MOV	AX,error_file_not_found
 19749                                  BadRet:
 19750 00002F36 F9                      	STC
 19751                                  JustRet:
 19752                                  	;call	LCritDisk
 19753                                  	;retn
 19754                                  	; 18/12/2022
 19755 00002F37 E977E9                  	jmp	LCritDisk
 19756                                  
 19757                                  bad_path1:
 19758 00002F3A B80300                  	MOV	AX,error_path_not_found
 19759 00002F3D EBF7                    	jmp	short BadRet
 19760                                  
 19761                                  info_check_dev:
 19762 00002F3F 08E4                    	OR	AH,AH
 19763 00002F41 78F0                    	JS	short info_no_file	; device
 19764                                  
 19765                                  	; MSDOS 6.0
 19766                                  ;SR;
 19767                                  ; If root dir then CurBuf == -1. Check for this case and return subdir attr
 19768                                  ;for a root dir
 19769                                  
 19770 00002F43 833E[E205]FF            	cmp	word [CURBUF],-1	;is it a root dir?
 19771 00002F48 7506                    	jne	short not_root		;no, CurBuf ptr is valid
 19772                                  
 19773 00002F4A 30E4                    	xor	ah,ah
 19774 00002F4C B010                    	mov	al,attr_directory ; 10h
 19775                                  	;clc
 19776                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 19777                                  	; (DOSCODE:683Eh)
 19778                                  	; 16/12/2022
 19779                                  	;clc
 19780 00002F4E EBE7                    	jmp	short JustRet
 19781                                  
 19782                                  not_root:
 19783                                  	; MSDOS 3.3 (& MSDOS 6.0)
 19784 00002F50 1E                      	PUSH	DS
 19785 00002F51 8E1E[E405]              	MOV	DS,[CURBUF+2]
 19786 00002F55 89DE                    	MOV	SI,BX
 19787 00002F57 31DB                    	XOR	BX,BX			; Assume size=0 (dir)
 19788 00002F59 89DF                    	MOV	DI,BX
 19789                                  	;mov	cx,[si+16h]
 19790 00002F5B 8B4C16                  	MOV	CX,[SI+dir_entry.dir_time]
 19791                                  	;mov	dx,[si+18h]
 19792 00002F5E 8B5418                  	MOV	DX,[SI+dir_entry.dir_date]
 19793 00002F61 30E4                    	XOR	AH,AH
 19794                                  	;mov	al,[si+0Bh]
 19795 00002F63 8A440B                  	MOV	AL,[SI+dir_entry.dir_attr]
 19796                                  	;test	al,10h
 19797 00002F66 A810                    	TEST	AL,attr_directory
 19798 00002F68 7506                    	JNZ	short NO_SIZE
 19799                                  	;mov	di,[si+1Ch]
 19800 00002F6A 8B7C1C                  	MOV	DI,[SI+dir_entry.dir_size_l]
 19801                                  	;mov	bx,[si+1Eh]
 19802 00002F6D 8B5C1E                  	MOV	BX,[SI+dir_entry.dir_size_h]
 19803                                  NO_SIZE:
 19804 00002F70 1F                      	POP	DS
 19805                                  	;CLC
 19806                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 19807                                  	; (DOSCODE:6864h)
 19808                                  	; 16/12/2022
 19809                                  	;clc
 19810 00002F71 EBC4                    	jmp	short JustRet
 19811                                  
 19812                                  ;Break	<SET_FILE_ATTRIBUTE -- Set File Attribute>
 19813                                  ;-------------------------------------------------------------------------------
 19814                                  ; Procedure Name : SET_FILE_ATTRIBUTE
 19815                                  ; Inputs:
 19816                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 19817                                  ;		terminated)
 19818                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 19819                                  ;		( = -1 if current dir not involved, else
 19820                                  ;		 Points to first char after last "/" of current dir part)
 19821                                  ;	[THISCDS] Points to CDS being used
 19822                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 19823                                  ;	[SATTRIB] is attribute of search (determines what files may be found)
 19824                                  ;	AX is new attributes to give to file
 19825                                  ; Function:
 19826                                  ;	Set File Attributes
 19827                                  ; Returns:
 19828                                  ;	CARRY CLEAR
 19829                                  ;	    No error
 19830                                  ;	CARRY SET
 19831                                  ;	    AX is error code
 19832                                  ;		error_file_not_found
 19833                                  ;			Last element of path not found
 19834                                  ;		error_path_not_found
 19835                                  ;			Bad path (not in curr dir part if present)
 19836                                  ;		error_bad_curr_dir
 19837                                  ;			Bad path in current directory part of path
 19838                                  ;		error_access_denied
 19839                                  ;			Attempt to set an attribute which cannot be set
 19840                                  ;			(attr_directory, attr_volume_ID)
 19841                                  ;		error_sharing_violation
 19842                                  ;			Sharing mode of file did not allow the change
 19843                                  ;			(this request requires exclusive write/read access)
 19844                                  ;			(INT 24H generated)
 19845                                  ; DS preserved, others destroyed
 19846                                  ;----------------------------------------------------------------------------
 19847                                  
 19848                                  	; 01/02/2024 - Retro DOS v5.0
 19849                                  
 19850                                  SET_FILE_ATTRIBUTE:
 19851                                  
 19852                                  ;hkn; set_file_attr is called from file.asm. DS has been set 
 19853                                  ;hkn; to DOSDATA at this point. So DOSassume is OK.
 19854                                  
 19855 00002F73 A9D8FF                  	TEST	AX,~attr_changeable ; 0FFD8h
 19856 00002F76 7412                    	JZ	short set_look
 19857                                  _BAD_ACC:
 19858                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Unk ; 1
 19859                                  	;;;
 19860                                  	; 01/02/2024 - Retro DOS v5.0
 19861                                  	; (PCDOS 7.1 IBMDOS.COM)
 19862 00002F78 E83FE3                  	call	set_exerr_locus_unk
 19863                                  	;;;
 19864 00002F7B C606[2703]07            	MOV	byte [EXTERR_CLASS],errCLASS_Apperr ; 7
 19865 00002F80 C606[2603]04            	MOV	byte [EXTERR_ACTION],errACT_Abort ; 4
 19866 00002F85 B80500                  	MOV	AX,error_access_denied ; 5
 19867 00002F88 F9                      	STC
 19868 00002F89 C3                      	retn
 19869                                  	
 19870                                  set_look:
 19871 00002F8A E879E8                  	call	TestNet
 19872 00002F8D 7308                    	JNC	short LOCAL_SET
 19873                                  
 19874                                  ;IF NOT Installed
 19875                                  ;	transfer NET_SEQ_SET_FILE_ATTRIBUTE
 19876                                  ;ELSE
 19877 00002F8F 50                      	PUSH	AX
 19878                                  	
 19879                                  	;MOV	AX,(MultNET SHL 8) OR 14
 19880                                  	;INT	2FH
 19881                                  
 19882 00002F90 B80E11                  	mov     ax, 110Eh
 19883 00002F93 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - SET REMOTE FILE'S ATTRIBUTES
 19884                                  			; SS = DOS CS, SDA first filename pointer -> fully-qualified name of file
 19885                                  			; SDA CDS pointer -> current directory
 19886                                  			; STACK: WORD new file attributes
 19887                                  			; Return: CF set on error
 19888                                  
 19889 00002F95 5B                      	POP	BX			; clean stack
 19890 00002F96 C3                      	retn
 19891                                  ;ENDIF
 19892                                  
 19893                                  LOCAL_SET:
 19894 00002F97 E8EAE8                  	call	ECritDisk
 19895 00002F9A 50                      	PUSH	AX			; Save new attributes
 19896 00002F9B C606[4C03]01            	MOV	byte [NoSetDir],1	; if we find a dir, don't change to it
 19897 00002FA0 E8211A                  	call	GETPATH 		; get path through fastopen if there	;AC000;
 19898 00002FA3 7308                    	JNC	short set_check_device
 19899 00002FA5 5B                      	POP	BX			; Clean stack (don't zap AX)
 19900 00002FA6 EB85                    	JMP	short NO_PATH
 19901                                  
 19902                                  	; MSDOS 6.0
 19903                                  cannot_set_root:			; M025:
 19904 00002FA8 B80500                  	mov	ax,error_access_denied	; M025: return error is attempting
 19905                                  	;stc				; M025: to set attr. of root
 19906                                  	;jmp	short OK_BYE		; M025:
 19907                                  	; 01/02/2024
 19908 00002FAB EB89                    	jmp	short BadRet
 19909                                  
 19910                                  set_check_device:
 19911 00002FAD 08E4                    	OR	AH,AH
 19912 00002FAF 7906                    	JNS	short set_check_share
 19913 00002FB1 58                      	POP	AX
 19914 00002FB2 E8FCE8                  	call	LCritDisk
 19915 00002FB5 EBC1                    	JMP	short _BAD_ACC 		; device
 19916                                  
 19917                                  set_check_share:
 19918 00002FB7 58                      	POP	AX			; Get new attributes
 19919                                  
 19920                                  	; MSDOS 6.0
 19921 00002FB8 833E[E205]FF            	cmp	word [CURBUF], -1	; M025: Q: is this the root dir
 19922 00002FBD 74E9                    	je	short cannot_set_root	; M025: Y: return error
 19923                                  
 19924                                  	; MSDOS 3.3 & MSDOS 6.0
 19925 00002FBF E89EFC                  	call	REN_DEL_Check
 19926 00002FC2 7305                    	JNC	short set_do
 19927 00002FC4 B82000                  	MOV	AX,error_sharing_violation ; 32
 19928 00002FC7 EB1B                    	jmp	short OK_BYE
 19929                                  
 19930                                  set_do:
 19931                                  	; MSDOS 3.3 & MSDOS 6.0
 19932 00002FC9 C43E[E205]              	LES	DI,[CURBUF]
 19933 00002FCD 2680670BD8              	AND	BYTE [ES:BX+dir_entry.dir_attr],~attr_changeable ; 0D8h
 19934 00002FD2 2608470B                	OR	BYTE [ES:BX+dir_entry.dir_attr],AL
 19935                                  
 19936                                  ; 01/02/2024 - Retro DOS v5.0
 19937                                  %if 0
 19938                                  	; MSDOS 6.0
 19939                                  	TEST	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty  
 19940                                  					;LB. if already dirty		  ;AN000;
 19941                                  	JNZ	short yesdirty3		;LB.  don't increment dirty count ;AN000;
 19942                                  	call	INC_DIRTY_COUNT 	;LB.				  ;AN000;
 19943                                  	
 19944                                  	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 19945                                  yesdirty3:
 19946                                  %else
 19947                                  	; 01/02/2024
 19948                                  	; (PCDOS 7.1 IBMDOS.COM)
 19949 00002FD6 E88B38                  	call	SET_BUF_DIRTY
 19950                                  %endif
 19951 00002FD9 A0[7605]                	MOV	AL,[THISDRV]
 19952                                  
 19953                                  ;;;; 10/1/86 F.C update fastopen cache
 19954                                  	; 03/03/2025 (MiniDOS)
 19955                                  	;PUSH	DX
 19956                                  	;PUSH	DI
 19957                                  	;MOV	AH,0		  ; dir entry update
 19958                                  	;MOV	DL,AL		  ; drive number A=0,B=1,,
 19959                                  	;MOV	DI,BX		  ; ES:DI -> dir entry
 19960                                  	;call	FastOpen_Update
 19961                                  	;POP	DI
 19962                                  	;POP	DX
 19963                                  ;;;; 9/11/86 F.C update fastopen cache
 19964                                  
 19965 00002FDC E85F37                  	call	FLUSHBUF
 19966 00002FDF 7303                    	JNC	short OK_BYE
 19967 00002FE1 B80200                  	MOV	AX,error_file_not_found
 19968                                  OK_BYE:
 19969                                  	;call	LCritDisk
 19970                                  	;retn
 19971                                  	; 16/12/2022
 19972 00002FE4 E9CAE8                  	jmp	LCritDisk
 19973                                  
 19974                                  ;============================================================================
 19975                                  ; DUP.ASM, MSDOS 6.0, 1991
 19976                                  ;============================================================================
 19977                                  ; 08/08/2018 - Retro DOS v3.0
 19978                                  ; 17/05/2019 - Retro DOS v4.0
 19979                                  
 19980                                  ;** 	Low level DUP routine for use by EXEC when creating a new process.
 19981                                  ;   	Exports the DUP to the server machine and increments the SFT ref count
 19982                                  ;
 19983                                  ;	DOS_DUP
 19984                                  ;
 19985                                  ;	Modification history:
 19986                                  ;
 19987                                  ;	  Created: ARR 30 March 1983
 19988                                  
 19989                                  ;BREAK <DOS_DUP -- DUP SFT across network>
 19990                                  ;---------------------------------------------------------------------------
 19991                                  ; Procedure Name : DOS_DUP
 19992                                  ;
 19993                                  ; Inputs:
 19994                                  ;	[THISSFT] set to the SFT for the file being DUPed
 19995                                  ;		(a non net SFT is OK, in this case the ref
 19996                                  ;		 count is simply incremented)
 19997                                  ; Function:
 19998                                  ;	Signal to the devices that a logical open is occurring
 19999                                  ; Returns:
 20000                                  ;	ES:DI point to SFT
 20001                                  ;    Carry clear
 20002                                  ;	SFT ref_count is incremented
 20003                                  ; Registers modified: None.
 20004                                  ; NOTE:
 20005                                  ;	This routine is called from $CREATE_PROCESS_DATA_BLOCK at DOSINIT
 20006                                  ;	time with SS NOT DOSGROUP. There will be no Network handles at
 20007                                  ;	that time.
 20008                                  ;---------------------------------------------------------------------------
 20009                                  
 20010                                  DOS_DUP:
 20011                                  	;LES	DI,[CS:THISSFT]  ; MSDOS 3.3
 20012                                  
 20013                                  	; MSDOS 6.0
 20014 00002FE7 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 20015 00002FEC 26C43E[9E05]            	les	di,[es:THISSFT]
 20016                                  
 20017                                  	;Entry	Dos_Dup_Direct
 20018                                  DOS_Dup_Direct:
 20019 00002FF1 E82BE8                  	call	IsSFTNet
 20020 00002FF4 7503                    	JNZ	short DO_INC
 20021 00002FF6 E8FE1E                  	call	DEV_OPEN_SFT
 20022                                  DO_INC:
 20023                                  	;INC	word [ES:DI+SF_ENTRY.sf_ref_count]
 20024 00002FF9 26FF05                  	inc	word [ES:DI]		; Clears carry (if this ever wraps
 20025                                  					;   we're in big trouble anyway)
 20026 00002FFC C3                      	retn
 20027                                  
 20028                                  ;============================================================================
 20029                                  ; CREATE.ASM, MSDOS 6.0, 1991
 20030                                  ;============================================================================
 20031                                  ; 08/08/2018 - Retro DOS v3.0
 20032                                  ; 18/05/2019 - Retro DOS v4.0
 20033                                  
 20034                                  ;TITLE	DOS_CREATE/DOS_CREATE_NEW - Internal CREATE calls for MS-DOS
 20035                                  ;NAME	DOS_CREATE
 20036                                  ;----------------------------------------------------------------------------
 20037                                  ;**	Internal Create and Create new to create a local or NET file and SFT.
 20038                                  ;
 20039                                  ;	DOS_CREATE
 20040                                  ;	DOS_CREATE_NEW
 20041                                  ;	SET_MKND_ERR
 20042                                  ;	SET_Media_ID
 20043                                  ;	SET_EXT_Mode
 20044                                  ;
 20045                                  ;	Revision history:
 20046                                  ;
 20047                                  ;	    A000 version 4.00	  Jan. 1988
 20048                                  ;	    A001  D490 -- Change IOCTL subfunctios from 63h,43h to 66h, 46h
 20049                                  
 20050                                  ;Installed = TRUE
 20051                                  
 20052                                  ;	i_need	THISSFT,DWORD
 20053                                  ;	i_need	THISCDS,DWORD
 20054                                  ;	I_need	EXTERR,WORD
 20055                                  ;	I_Need	ExtErr_locus,BYTE
 20056                                  ;	I_need	JShare,DWORD
 20057                                  ;	I_need	VOLCHNG_FLAG,BYTE
 20058                                  ;	I_need	SATTRIB,BYTE
 20059                                  ;	I_need	CALLVIDM,DWORD
 20060                                  ;	I_need	EXTOPEN_ON,BYTE 		  ;AN000; extended open
 20061                                  ;	I_need	NAME1,BYTE			  ;AN000;
 20062                                  ;	I_need	NO_NAME_ID,BYTE 		  ;AN000;
 20063                                  ;	I_need	Packet_Temp,WORD		  ;AN000;
 20064                                  ;	I_need	DOS34_FLAG,WORD 		  ;AN000;
 20065                                  ;	I_need	SAVE_BX,WORD			  ;AN000;
 20066                                  
 20067                                  ;***	DOS_CREATE - Create a File
 20068                                  ;----------------------------------------------------------------------------
 20069                                  ;	DOS_Create is called to create the specified file, truncating
 20070                                  ;	the old one if it exists.
 20071                                  ;
 20072                                  ;	ENTRY	AX is Attribute to create
 20073                                  ;		(ds) = DOSDATA
 20074                                  ;		[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 20075                                  ;			terminated)
 20076                                  ;		[CURR_DIR_END] Points to end of Current dir part of string
 20077                                  ;			( = -1 if current dir not involved, else
 20078                                  ;			 Points to first char after last "/" of current dir part)
 20079                                  ;		[THISCDS] Points to CDS being used
 20080                                  ;			(Low word = -1 if NUL CDS (Net direct request))
 20081                                  ;		[THISSFT] Points to SFT to fill in if file created
 20082                                  ;			(sf_mode field set so that FCB may be detected)
 20083                                  ;		[SATTRIB] Is attribute of search, determines what files can be found
 20084                                  ;
 20085                                  ;	EXIT	sf_ref_count is NOT altered
 20086                                  ;		CARRY CLEAR
 20087                                  ;		    THISSFT filled in.
 20088                                  ;			sf_mode = unchanged for FCB, sharing_compat + open_for_both
 20089                                  ;		CARRY SET
 20090                                  ;		    AX is error code
 20091                                  ;			error_path_not_found
 20092                                  ;				Bad path (not in curr dir part if present)
 20093                                  ;			error_bad_curr_dir
 20094                                  ;				Bad path in current directory part of path
 20095                                  ;			error_access_denied
 20096                                  ;				Attempt to re-create read only file , or
 20097                                  ;				create a second volume id or create a dir
 20098                                  ;			error_sharing_violation
 20099                                  ;				The sharing mode was correct but not allowed
 20100                                  ;				generates an INT 24
 20101                                  ;	USES	all but DS
 20102                                  ;----------------------------------------------------------------------------
 20103                                  
 20104                                  	; 14/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 20105                                  	; DOSCODE:6920h (MSDOS 5.0, MSDOS.SYS)
 20106                                  
 20107                                  	; 01/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 20108                                  	; DOSCODE:708Ah (PCDOS 7.1, IBMDOS.COM)
 20109                                  
 20110                                  DOS_CREATE:
 20111                                  	; 18/05/2019 - Retro DOS v4.0
 20112                                  	; DOSCODE:6934h (MSDOS 6.21, MSDOS.SYS)
 20113                                  
 20114                                  ;hkn; dispatched to from file.asm and fcbio.asm. DS set up to DOSDATA at 
 20115                                  ;hkn; this point.
 20116                                  
 20117 00002FFD 30E4                    	XOR	AH,AH		; Truncate is OK
 20118                                  
 20119                                  ;	Enter here from Dos_Create_New
 20120                                  ;
 20121                                  ;	(ah) = 0 iff truncate OK
 20122                                  
 20123                                  Create_inter:
 20124 00002FFF A8C0                    	TEST	AL,~(attr_all+attr_ignore+attr_volume_id) ; 80h
 20125                                  				; Mask out any meaningless bits
 20126 00003001 7511                    	JNZ	short AttErr
 20127 00003003 A808                    	TEST	AL,attr_volume_id
 20128 00003005 7407                    	JZ	short NoReset
 20129                                  	
 20130                                  	; MSDOS 6.0
 20131                                  	; 16/12/2022
 20132 00003007 800E[1106]80            	OR	byte [DOS34_FLAG],DBCS_VOLID ; 80h ;AN000;FOR dbcs volid
 20133                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 20134                                  	;or	word [DOS34_FLAG],DBCS_VOLID ; 80h 
 20135                                  	
 20136 0000300C B008                    	MOV	AL,attr_volume_id ; 8
 20137                                  NoReset:
 20138 0000300E 0C20                    	OR	AL,attr_archive ; File changed  ; 20h
 20139 00003010 A850                    	TEST	AL,attr_directory+attr_device ; 50h
 20140 00003012 7408                    	JZ	short ATT_OK
 20141                                  AttErr:
 20142 00003014 B80500                  	MOV	AX,5		; Attribute problem
 20143                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Unk ; 1
 20144                                  	; 01/02/2024
 20145 00003017 E8A0E2                  	call	set_exerr_locus_unk
 20146 0000301A EB62                    	JMP	SHORT SET_MKND_ERR ; Gotta use MKDIR to make dirs, NEVER allow
 20147                                  				   ;	attr_device to be set.
 20148                                  ATT_OK:
 20149 0000301C C43E[9E05]              	LES	DI,[THISSFT]
 20150 00003020 06                      	PUSH	ES
 20151 00003021 C436[A205]              	LES	SI,[THISCDS]
 20152 00003025 83FEFF                  	CMP	SI,-1
 20153 00003028 751B                    	JNE	short TEST_RE_NET
 20154                                  
 20155                                  ;	No CDS, it must be redirected.
 20156                                  
 20157 0000302A 07                      	POP	ES
 20158                                  
 20159                                  	; MSDOS 6.0
 20160                                  ;Extended open hooks
 20161                                  	;test	byte [EXTOPEN_ON],1
 20162 0000302B F606[F605]01            	TEST	byte [EXTOPEN_ON],EXT_OPEN_ON ;AN000;EO. from extended open
 20163 00003030 740D                    	JZ	short NOEXTOP 		    ;AN000;EO. no, do normal
 20164                                  IFS_extopen:				    ;AN000;EO.
 20165 00003032 50                      	PUSH	AX			    ;AN000;EO. pass create attr
 20166                                  	;MOV	AX,(MultNET SHL 8) OR 46    ;AN000;EO. issue extended open verb
 20167 00003033 B82E11                  	mov	ax,112Eh
 20168                                  NOEXTOP2:	; 01/02/2024 (PCDOS 7.1 IBMDOS.COM)
 20169 00003036 CD2F                    	INT	2FH			    ;AN000;EO.
 20170 00003038 5B                      	POP	BX			    ;AN000;EO. trash bx
 20171 00003039 C606[F605]00            	MOV	byte [EXTOPEN_ON],0	    ;AN000;EO.
 20172 0000303E C3                      	retn				    ;AN000;EO.
 20173                                  NOEXTOP:				    ;AN000;
 20174                                  ;Extended open hooks
 20175                                  
 20176                                  ;IF NOT Installed
 20177                                  ;	transfer NET_SEQ_CREATE
 20178                                  ;ELSE
 20179 0000303F 50                      	PUSH	AX
 20180                                  
 20181                                  	;MOV	AX,(MultNET SHL 8) OR 24
 20182                                  	;INT	2FH
 20183                                  
 20184 00003040 B81811                  	mov     ax,1118h
 20185                                  	; 01/02/2024
 20186                                  	;int     2Fh	; Multiplex - NETWORK REDIRECTOR - CREATE/TRUNCATE FILE
 20187                                  			; ES:DI -> uninitialized SFT, SS = DOS CS
 20188                                  			; SDA first filename pointer -> fully-qualified name of file
 20189                                  			; STACK: WORD file creation mode???
 20190                                  
 20191                                  	;POP	BX			; BX is trashed anyway
 20192                                  	;retn
 20193 00003043 EBF1                    	jmp	short NOEXTOP2 ; 01/02/2024
 20194                                  ;ENDIF
 20195                                  
 20196                                  ;	We have a CDS. See if it's network
 20197                                  
 20198                                  TEST_RE_NET:
 20199                                  	;;test	word [es:si+43h],8000h
 20200                                  	;TEST	word [ES:SI+curdir.flags],curdir_isnet
 20201                                  	; 07/12/2022
 20202                                  	;test	byte [es:si+44h],80h
 20203                                  	; 17/12/2022
 20204 00003045 26F6444480              	test	byte [ES:SI+curdir.flags+1],curdir_isnet>>8
 20205 0000304A 07                      	POP	ES
 20206 0000304B 7417                    	JZ	short LOCAL_CREATE
 20207                                  
 20208                                  	; MSDOS 6.0
 20209 0000304D E8C700                  	CALL	Set_EXT_mode		    ;AN000;EO.
 20210 00003050 7205                    	JC	SHORT dochk		    ;AN000;EO.
 20211                                  	;;or	word [es:di+2],2
 20212                                  	;OR	word [ES:DI+SF_ENTRY.sf_mode],SHARING_COMPAT+open_for_both ;IFS.
 20213                                  	; 17/12/2022
 20214 00003052 26804D0202              	or	byte [ES:DI+SF_ENTRY.sf_mode],SHARING_COMPAT+open_for_both ;IFS.
 20215                                  
 20216                                  ;Extended open hooks
 20217                                  dochk:
 20218 00003057 F606[F605]01            	TEST	byte [EXTOPEN_ON],EXT_OPEN_ON ;AN000;EO. from extended open
 20219 0000305C 75D4                    	JNZ	short IFS_extopen	    ;AN000;EO. yes, issue extended open
 20220                                  ;Extended open hooks
 20221                                  
 20222                                  ;IF NOT Installed
 20223                                  ;	transfer NET_CREATE
 20224                                  ;ELSE
 20225 0000305E 50                      	PUSH	AX
 20226                                  	
 20227                                  	;MOV	AX,(MultNET SHL 8) OR 23
 20228                                  	;INT	2FH
 20229                                  	
 20230 0000305F B81711                  	mov     ax,1117h
 20231                                  	
 20232                                  	; 01/02/2024
 20233                                  	;int     2Fh	; Multiplex - NETWORK REDIRECTOR - CREATE/TRUNCATE REMOTE FILE
 20234                                  			; ES:DI -> uninitialized SFT, SS = DOS CS
 20235                                  			; SDA first filename pointer -> fully-qualified name of file to open
 20236                                  			; SDA CDS pointer -> current directory
 20237                                  			; Return: CF set on error
 20238                                  
 20239                                  	;POP	BX			; BX is trashed anyway
 20240                                  ;nomore:
 20241                                  	;retn
 20242 00003062 EBD2                    	jmp	short NOEXTOP2 ; 01/02/2024
 20243                                  ;ENDIF
 20244                                  
 20245                                  ;**	It's a local create. We have a local CDS for it.
 20246                                  
 20247                                  LOCAL_CREATE:
 20248                                  	; MSDOS 6.0
 20249 00003064 E8B000                  	CALL	Set_EXT_mode	;AN000;EO. set mode if from extended open
 20250 00003067 7205                    	JC	short setdone	;AN000;EO.
 20251                                  	
 20252                                  	; MSDOS 3.3 & MSDOS 6.0
 20253                                  	; 17/12/2022
 20254                                  	;;or	word [es:di+2],2
 20255                                  	;OR	word [ES:DI+SF_ENTRY.sf_mode],SHARING_COMPAT+open_for_both
 20256                                  	;or	byte [es:di+2],2
 20257 00003069 26804D0202              	or	byte [ES:DI+SF_ENTRY.sf_mode],SHARING_COMPAT+open_for_both
 20258                                  setdone:
 20259 0000306E E813E8                  	call	ECritDisk
 20260 00003071 E8B920                  	call	MakeNode
 20261 00003074 7317                    	JNC	short Create_ok
 20262 00003076 C606[A10A]FF            	mov	byte [VOLCHNG_FLAG],-1	; indicate no change in volume label
 20263 0000307B E833E8                  	call	LCritDisk
 20264                                  
 20265                                  	;entry	SET_MKND_ERR
 20266                                  SET_MKND_ERR:
 20267                                  
 20268                                  ;	Looks up MakeNode errors and converts them. AL is MakeNode
 20269                                  ;	error, SI is GETPATH bad spot return if path_not_found error.
 20270                                  
 20271                                  ;hkn; CRTERRTAB is in TABLE seg (DOSCODE)
 20272 0000307E BB[8530]                	MOV     BX,CRTERRTAB
 20273                                  	;XLAT  ; MSDOS 3.3
 20274                                  	; 18/05/2019 - Retro DOS v4.0
 20275 00003081 2E                      	CS
 20276 00003082 D7                      	XLAT
 20277                                  CreatBadRet:
 20278 00003083 F9                      	STC
 20279 00003084 C3                      	retn
 20280                                  
 20281                                  ; 13/05/2019 - Retro DOS v4.0
 20282                                  ; DOSCODE:69C4h (MSDOS 6.21, MSDOS.SYS)
 20283                                  ; ---------------------------------------------------------------------------
 20284                                  
 20285                                  ;** Internal Create and Create new to create a local or NET file and SFT.
 20286                                  
 20287                                  ; 17/07/2018 - Retro DOS v3.0
 20288                                  ; Offset 12B1h of IBMDOS.COM (MSDOS 3.3), 1987
 20289                                  
 20290                                  ;CRTERRTAB: ; 19/07/2018 - MSDOS 3.3	
 20291                                  ;	db	0,5,52h,50h,3,5,20h
 20292                                  
 20293                                  ;CRTERRTAB: ; 18/05/2019 - MSDOS 6.0	
 20294                                  ;	db	0,5,52h,50h,3,5,20h,2
 20295                                  
 20296                                  ; 08/08/2018
 20297                                  
 20298                                  CRTERRTAB:	;LABEL BYTE	; Lookup table for MakeNode returns
 20299 00003085 00                      	DB	0			; none
 20300 00003086 05                      	DB	error_access_denied	; MakeNode error 1
 20301 00003087 52                      	DB	error_cannot_make	; MakeNode error 2
 20302 00003088 50                      	DB	error_file_exists	; MakeNode error 3
 20303 00003089 03                      	DB	error_path_not_found	; MakeNode error 4
 20304 0000308A 05                      	DB	error_access_denied	; MakeNode error 5
 20305 0000308B 20                      	DB	error_sharing_violation ; MakeNode error 6
 20306                                  	; MSDOS 6.0
 20307 0000308C 02                      	DB	error_file_not_found	; MakeNode error 7
 20308                                  
 20309                                  ; ---------------------------------------------------------------------------
 20310                                  
 20311                                  ; We have just created a new file. This results in the truncation of old
 20312                                  ; files. We must inform the sharer to slash all the open SFT's for this
 20313                                  ; file to the current size.
 20314                                  
 20315                                  ; If we created a volume id on the diskette, set the VOLCHNG_FLAG to logical
 20316                                  ; drive number to force a Build BPB after Media Check.
 20317                                  
 20318                                  ;;; FASTOPEN 8/29/86
 20319                                  Create_ok:
 20320                                  	; 03/03/2025 (MiniDOS)
 20321                                  	;call	FastOpen_Delete
 20322                                  ;;; FASTOPEN 8/29/86
 20323 0000308D A0[6D05]                	mov	al,[SATTRIB]
 20324 00003090 A808                    	test	al,attr_volume_id
 20325 00003092 741C                    	jz	short NoVolLabel
 20326 00003094 C43E[A205]              	LES	DI,[THISCDS]
 20327                                  	;mov	ah,[ES:DI+curdir.text]	; get drive letter
 20328 00003098 268A25                  	mov	ah,[ES:DI] ; 09/08/2018
 20329 0000309B 80EC41                  	sub	ah,'A'	; 41h		; convert to drive number
 20330 0000309E 8826[A10A]              	mov	[VOLCHNG_FLAG],ah	;Set flag to indicate volid change
 20331                                  	
 20332                                  	; 18/05/2019 - Retro DOS v4.0
 20333                                  
 20334                                  	; MSDOS 6.0
 20335 000030A2 B701                    	MOV	BH,1			;AN000;>32mb set volume id to boot record
 20336 000030A4 E81F00                  	CALL	Set_Media_ID		;AN000;>32mb
 20337                                  	
 20338 000030A7 E8DAE7                  	call	ECritDisk
 20339 000030AA E85431                  	call	FATREAD_CDS		; force a media check
 20340 000030AD E801E8                  	call	LCritDisk
 20341                                  
 20342                                  NoVolLabel:
 20343 000030B0 B80200                  	MOV	ax,2
 20344 000030B3 C43E[9E05]              	LES	DI,[THISSFT]
 20345                                  ;if installed
 20346                                  	;call	JShare + 14 * 4
 20347 000030B7 FF1E[C800]              	call	far [JShare+(14*4)] ; 14 = ShSU
 20348                                  ;else
 20349                                  ;	Call	ShSU
 20350                                  ;endif
 20351 000030BB E8F3E7                  	call	LCritDisk
 20352 000030BE E94501                  	jmp	SET_SFT_MODE
 20353                                  
 20354                                  ;---------------------------------------------------------------------------
 20355                                  ; Procedure Name : Dos_Create_New
 20356                                  ;
 20357                                  ; Inputs:
 20358                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 20359                                  ;		terminated)
 20360                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 20361                                  ;		( = -1 if current dir not involved, else
 20362                                  ;		 Points to first char after last "/" of current dir part)
 20363                                  ;	[THISCDS] Points to CDS being used
 20364                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 20365                                  ;	[THISSFT] Points to SFT to fill in if file created
 20366                                  ;		(sf_mode field set so that FCB may be detected)
 20367                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 20368                                  ;	AX is Attribute to create
 20369                                  ; Function:
 20370                                  ;	Try to create the specified file truncating an old one that exists
 20371                                  ; Outputs:
 20372                                  ;	sf_ref_count is NOT altered
 20373                                  ;	CARRY CLEAR
 20374                                  ;	    THISSFT filled in.
 20375                                  ;		sf_mode = sharing_compat + open_for_both for Non-FCB SFT
 20376                                  ;	CARRY SET
 20377                                  ;	    AX is error code
 20378                                  ;		error_path_not_found
 20379                                  ;			Bad path (not in curr dir part if present)
 20380                                  ;		error_bad_curr_dir
 20381                                  ;			Bad path in current directory part of path
 20382                                  ;		error_access_denied
 20383                                  ;			Create a second volume id or create a dir
 20384                                  ;		error_file_exists
 20385                                  ;			Already a file by this name
 20386                                  ; DS preserved, others destroyed
 20387                                  ;---------------------------------------------------------------------------
 20388                                  
 20389                                  DOS_Create_New:
 20390 000030C1 B401                    	MOV	AH,1		; Truncate is NOT OK
 20391 000030C3 E939FF                  	JMP	Create_inter
 20392                                  
 20393                                  ; MSDOS 6.0
 20394                                  ;---------------------------------------------------------------------------
 20395                                  ; Procedure Name : Set_Media_ID
 20396                                  ;
 20397                                  ; Inputs:
 20398                                  ;	NAME1= Volume ID
 20399                                  ;	BH= 0, delete volume id
 20400                                  ;	    1, set new volume id
 20401                                  ;	DS= DOSGROUP
 20402                                  ; Function:
 20403                                  ;	Set Volume ID to DOS 4.00 Boot record.
 20404                                  ; Outputs:
 20405                                  ;	CARRY CLEAR
 20406                                  ;	    volume id set
 20407                                  ;	CARRY SET
 20408                                  ;	    AX is error code
 20409                                  ;---------------------------------------------------------------------------
 20410                                  
 20411                                  	; 18/05/2019 - Retro DOS v4.0
 20412                                  	; 01/02/2024 - Retro DOS v5.0
 20413                                  Set_Media_ID:
 20414 000030C6 50                      	PUSH	AX		;AN000;;>32mb
 20415 000030C7 06                      	PUSH	ES		;AN000;;>32mb
 20416 000030C8 57                      	PUSH	DI		;AN000;;>32mb
 20417                                  
 20418 000030C9 FEC4                    	INC	AH		;AN000;;>32mb  bl=drive #
 20419 000030CB 88E3                    	MOV	BL,AH		;AN000;;>32mb  bl=drive # (A=1,B=2,,,)
 20420 000030CD B00D                    	MOV	AL,0DH		;AN000;;>32mb  generic IOCTL
 20421                                  	;MOV	CX,0866H	;AN001;;>32mb  get media id
 20422                                  	; 01/02/2024
 20423                                  	; (PCDOS 7.1 IBMDOS.COM)
 20424 000030CF B96648                  	mov	cx,4866h	; ch = FAT32 disk drive (CATEGORY CODE)
 20425                                  				; cl = minor code,
 20426                                  				;      get volume serial number (and name)
 20427                                  
 20428                                  ;hkn; PACKET_TEMP is in DOSDATA
 20429 000030D2 BA[A00D]                	MOV	DX,Packet_Temp	;AN000;>32mb
 20430                                  
 20431                                  Set_Media_ID_1:
 20432                                  	; 01/02/2024
 20433 000030D5 51                      	push	cx
 20434                                  
 20435 000030D6 53                      	PUSH	BX		;AN000;;>32mb
 20436 000030D7 52                      	PUSH	DX		;AN000;;>32mb
 20437 000030D8 30FF                    	XOR	BH,BH		;AN000;;>32mb
 20438                                  
 20439                                  	;invoke	$IOCTL		;AN000;;>32mb
 20440 000030DA E849F7                  	call	_$IOCTL	
 20441                                  
 20442 000030DD 5A                      	POP	DX		;AN000;;>32mb
 20443 000030DE 5B                      	POP	BX		;AN000;;>32mb
 20444                                  
 20445                                  	; 01/02/2024
 20446 000030DF 59                      	pop	cx
 20447                                  	;JC	short geterr	;AN000;;>32mb
 20448 000030E0 730A                    	jnc	short Set_Media_ID_2
 20449 000030E2 80FD48                  	cmp	ch,48h		; is it FAT32 disk drive request?
 20450 000030E5 F9                      	stc
 20451 000030E6 7529                    	jne	short geterr	; (ch=8 request failed!)
 20452 000030E8 B508                    	mov	ch,8		; set category code for (old) FAT disk drive
 20453                                  				; (except FAT32)
 20454 000030EA EBE9                    	jmp     short Set_Media_ID_1 ; and try again
 20455                                  
 20456                                  Set_Media_ID_2:
 20457 000030EC 08FF                    	OR	BH,BH		;AN000;;>32mb delete volume id
 20458 000030EE 7405                    	JZ	short NoName	;AN000;>32mb yes
 20459                                  
 20460                                  ;hkn; NAME1 is in DOSDATA
 20461 000030F0 BE[4B05]                	MOV	SI,NAME1	;AN000;>32mb
 20462                                  
 20463 000030F3 EB03                    	JMP	SHORT doset	;AN000;>32mb yes
 20464                                  NoName: 			;AN000;
 20465                                  
 20466                                  ;hkn; NO_NAME_ID is in DOSDATA
 20467 000030F5 BE[C10D]                	MOV	SI,NO_NAME_ID	;AN000;>32mb
 20468                                  
 20469                                  doset:				;AN000;
 20470 000030F8 89D7                    	MOV	DI,DX		;AN000;;>32mb
 20471                                  	;add	di,6
 20472 000030FA 83C706                  	ADD	DI,MEDIA_ID_INFO.MEDIA_Label ;AN000;;>32mb
 20473                                  
 20474                                  ;hkn; ES & DS must point to SS
 20475                                  ;hkn;	PUSH	CS		;AN000;;>32mb  move new volume id to packet
 20476 000030FD 16                      	PUSH	SS		;AN000;;>32mb  move new volume id to packet
 20477                                  
 20478 000030FE 1F                      	POP	DS		;AN000;;>32mb
 20479                                  
 20480                                  ;hkn;	PUSH	CS		;AN000;;>32mb
 20481 000030FF 16                      	PUSH	SS		;AN000;;>32mb
 20482                                  
 20483 00003100 07                      	POP	ES		;AN000;;>32mb
 20484                                  
 20485                                  	; 01/02/2024
 20486 00003101 51                      	push	cx
 20487                                  
 20488 00003102 B90B00                  	MOV	CX,11		;AN000;;>32mb
 20489 00003105 F3A4                    	REP	MOVSB		;AN000;;>32mb
 20490                                  
 20491                                  	;MOV	CX,0846H	;AN001;;>32mb
 20492                                  	; 01/02/2024
 20493 00003107 59                      	pop	cx
 20494 00003108 B146                    	mov	cl,46h		; set volume serial number (and name)
 20495                                  	;
 20496 0000310A B00D                    	MOV	AL,0DH		;AN000;;>32mb
 20497 0000310C 30FF                    	XOR	BH,BH		;AN000;;>32mb
 20498                                  	;invoke	$IOCTL		;AN000;;>32mb  set volume id
 20499 0000310E E815F7                  	call	_$IOCTL	
 20500                                  geterr: 			;AN000;
 20501                                  ;hkn;	PUSH	CS		;AN000;>32mb
 20502 00003111 16                      	PUSH	SS		;AN000;>32mb
 20503                                  
 20504 00003112 1F                      	POP	DS		;AN000;>32mb   ds= dosgroup
 20505                                  
 20506 00003113 5F                      	POP	DI		;AN000;;>32mb
 20507 00003114 07                      	POP	ES		;AN000;;>32mb
 20508 00003115 58                      	POP	AX		;AN000;;>32mb
 20509 00003116 C3                      	retn			;AN000;>32mb
 20510                                  
 20511                                  ; MSDOS 6.0
 20512                                  ;---------------------------------------------------------------------------
 20513                                  ; Procedure Name : Set_EXT_mode
 20514                                  ;
 20515                                  ; Inputs:
 20516                                  ;	[EXTOPEN_ON]= flag for extended open
 20517                                  ;	SAVE_BX= mode specified in Extended Open
 20518                                  ; Function:
 20519                                  ;	Set mode in ThisSFT
 20520                                  ; Outputs:
 20521                                  ;	carry set,mode is set if from Extended Open
 20522                                  ;	carry clear, mode not set yet
 20523                                  ;---------------------------------------------------------------------------
 20524                                  
 20525                                  ; 13/05/2019 - Retro DOS v4.0
 20526                                  
 20527                                  Set_EXT_mode:
 20528                                  
 20529                                  ;hkn; SS override
 20530 00003117 36F606[F605]01          	TEST	byte [ss:EXTOPEN_ON],EXT_OPEN_ON ;AN000;EO. from extended open
 20531 0000311D 740B                    	JZ	short NOTEX		    ;AN000;EO. no, do normal
 20532 0000311F 50                      	PUSH	AX			    ;AN000;EO.
 20533                                  
 20534                                  ;hkn; SS override
 20535 00003120 36A1[0106]              	MOV	AX,[ss:SAVE_BX]		    ;AN000;EO.
 20536                                  	;or	[es:di+2],ax
 20537 00003124 26094502                	OR	[ES:DI+SF_ENTRY.sf_mode],AX ;AN000;EO.
 20538 00003128 58                      	POP	AX			    ;AN000;EO.
 20539 00003129 F9                      	STC				    ;AN000;EO.
 20540                                  NOTEX:					    ;AN000;
 20541 0000312A C3                      	retn				    ;AN000;EO.
 20542                                  
 20543                                  ;============================================================================
 20544                                  ; OPEN.ASM, MSDOS 6.0, 1991
 20545                                  ;============================================================================
 20546                                  ; 08/08/2018 - Retro DOS v3.0
 20547                                  ; 18/05/2019 - Retro DOS v4.0
 20548                                  
 20549                                  ;	TITLE	DOS_OPEN - Internal OPEN call for MS-DOS
 20550                                  ;	NAME	DOS_OPEN
 20551                                  
 20552                                  ;**	OPEN.ASM - File Open
 20553                                  ;----------------------------------------------------------------------------
 20554                                  ;	Low level routines for openning a file from a file spec.
 20555                                  ;	Also misc routines for sharing errors
 20556                                  ;
 20557                                  ;	DOS_Open
 20558                                  ;	Check_Access_AX
 20559                                  ;	SHARE_ERROR
 20560                                  ;	SET_SFT_MODE
 20561                                  ;	Code_Page_Mismatched_Error		   ; DOS 4.00
 20562                                  ;
 20563                                  ;	Revision history:
 20564                                  ;
 20565                                  ;	    Created: ARR 30 March 1983
 20566                                  ;	    A000	version 4.00   Jan. 1988
 20567                                  ;
 20568                                  ;	M034 - The value in save_bx must be pushed on to the stack for
 20569                                  ; 	       remote extended opens and not save_cx.
 20570                                  ;
 20571                                  ;	M035 - if open made from exec then we must set the appropriate bits
 20572                                  ;	       on the stack before calling off to the redir.
 20573                                  ;	M042 - Bit 11 of DOS34_FLAG set indicates that the redir knows how 
 20574                                  ;	       to handle open from exec. In this case set the appropriate bit
 20575                                  ;	       else do not.
 20576                                  ;----------------------------------------------------------------------------	
 20577                                  
 20578                                  ;Installed = TRUE
 20579                                  
 20580                                  ;	i_need	NoSetDir,BYTE
 20581                                  ;	i_need	THISSFT,DWORD
 20582                                  ;	i_need	THISCDS,DWORD
 20583                                  ;	i_need	CURBUF,DWORD
 20584                                  ;	i_need	CurrentPDB,WORD
 20585                                  ;	i_need	CURR_DIR_END,WORD
 20586                                  ;	I_need	RetryCount,WORD
 20587                                  ;	I_need	Open_Access,BYTE
 20588                                  ;	I_need	fSharing,BYTE
 20589                                  ;	i_need	JShare,DWORD
 20590                                  ;	I_need	FastOpenFlg,byte
 20591                                  ;	I_need	EXTOPEN_ON,BYTE 		  ;AN000;; DOS 4.00
 20592                                  ;	I_need	ALLOWED,BYTE			  ;AN000;; DOS 4.00
 20593                                  ;	I_need	EXTERR,WORD			  ;AN000;; DOS 4.00
 20594                                  ;	I_need	EXTERR_LOCUS,BYTE		  ;AN000;; DOS 4.00
 20595                                  ;	I_need	EXTERR_ACTION,BYTE		  ;AN000;; DOS 4.00
 20596                                  ;	I_need	EXTERR_CLASS,BYTE		  ;AN000;; DOS 4.00
 20597                                  ;	I_need	CPSWFLAG,BYTE			  ;AN000;; DOS 4.00
 20598                                  ;	I_need	EXITHOLD,DWORD			  ;AN000;; DOS 4.00
 20599                                  ;	I_need	THISDPB,DWORD			  ;AN000;; DOS 4.00
 20600                                  ;	I_need	SAVE_CX,WORD			  ;AN000;; DOS 4.00
 20601                                  ;	I_need	SAVE_BX,WORD			  ;M034
 20602                                  ;
 20603                                  ;	I_need	DOS_FLAG,BYTE
 20604                                  ;	I_need	DOS34_FLAG,WORD			  ;M042
 20605                                  
 20606                                  ;Break	<DOS_Open - internal file access>
 20607                                  ;---------------------------------------------------------------------------
 20608                                  ; Procedure Name : DOS_Open
 20609                                  ;
 20610                                  ; Inputs:
 20611                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 20612                                  ;		terminated)
 20613                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 20614                                  ;		( = -1 if current dir not involved, else
 20615                                  ;		 Points to first char after last "/" of current dir part)
 20616                                  ;	[THISCDS] Points to CDS being used
 20617                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 20618                                  ;	[THISSFT] Points to SFT to fill in if file found
 20619                                  ;		(sf_mode field set so that FCB may be detected)
 20620                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 20621                                  ;	AX is Access and Sharing mode
 20622                                  ;	  High NIBBLE of AL (Sharing Mode)
 20623                                  ;		sharing_compat	   file is opened in compatibility mode
 20624                                  ;		sharing_deny_none  file is opened Multi reader, Multi writer
 20625                                  ;		sharing_deny_read  file is opened Only reader, Multi writer
 20626                                  ;		sharing_deny_write file is opened Multi reader, Only writer
 20627                                  ;		sharing_deny_both  file is opened Only reader, Only writer
 20628                                  ;	  Low NIBBLE of AL (Access Mode)
 20629                                  ;		open_for_read	file is opened for reading
 20630                                  ;		open_for_write	file is opened for writing
 20631                                  ;		open_for_both	file is opened for both reading and writing.
 20632                                  ;
 20633                                  ;	  For FCB SFTs AL should = sharing_compat + open_for_both
 20634                                  ;		(not checked)
 20635                                  ; Function:
 20636                                  ;	Try to open the specified file
 20637                                  ; Outputs:
 20638                                  ;	sf_ref_count is NOT altered
 20639                                  ;	CARRY CLEAR
 20640                                  ;	    THISSFT filled in.
 20641                                  ;	CARRY SET
 20642                                  ;	    AX is error code
 20643                                  ;		error_file_not_found
 20644                                  ;			Last element of path not found
 20645                                  ;		error_path_not_found
 20646                                  ;			Bad path (not in curr dir part if present)
 20647                                  ;		error_bad_curr_dir
 20648                                  ;			Bad path in current directory part of path
 20649                                  ;		error_invalid_access
 20650                                  ;			Bad sharing mode or bad access mode or bad combination
 20651                                  ;		error_access_denied
 20652                                  ;			Attempt to open read only file for writting, or
 20653                                  ;			open a directory
 20654                                  ;		error_sharing_violation
 20655                                  ;			The sharing mode was correct but not allowed
 20656                                  ;			generates an INT 24 on compatibility mode SFTs
 20657                                  ; DS preserved, others destroyed
 20658                                  ;----------------------------------------------------------------------------
 20659                                  
 20660                                  ; 18/05/2019 - Retro DOS v4.0
 20661                                  ; DOSCODE:6A60h (MSDOS 6.21, MSDOS.SYS)
 20662                                  ; 14/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 20663                                  ; DOSCODE:6A4Ch (MSDOS 5.0, MSDOS.SYS)
 20664                                  
 20665                                  ; 01/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 20666                                  ; DOSCODE:71BBh (PCDOS 7.1, IBMDOS.COM)
 20667                                  
 20668                                  DOS_OPEN:
 20669                                  	; DS has been set up to DOSDATA in file.asm and fcbio2.asm. 
 20670                                  
 20671 0000312B C606[4C03]00            	MOV	byte [NoSetDir],0
 20672 00003130 E82201                  	CALL	Check_Access_AX
 20673 00003133 722B                    	JC	short do_ret_label	    ; retc
 20674                                  
 20675 00003135 C43E[9E05]              	LES	DI,[THISSFT]
 20676 00003139 30E4                    	XOR	AH,AH
 20677                                  
 20678                                  	; sleaze! move only access/sharing mode in. Leave sf_isFCB unchanged
 20679                                  
 20680 0000313B 26884502                	MOV	[ES:DI+SF_ENTRY.sf_mode],AL ; For moment do this on FCBs too
 20681 0000313F 06                      	PUSH	ES
 20682 00003140 C436[A205]              	LES	SI,[THISCDS]
 20683                                  	; 18/08/2018
 20684 00003144 83FEFF                  	CMP	SI,-1 ; 0FFFFh
 20685 00003147 7530                    	JNZ	short TEST_RE_NET1
 20686 00003149 07                      	POP	ES
 20687                                  
 20688                                  	; MSDOS 6.0
 20689                                  ;Extended open hooks
 20690 0000314A F606[F605]01            	TEST	byte [EXTOPEN_ON],EXT_OPEN_ON ;FT. from extended open		;AN000;
 20691 0000314F 7410                    	JZ	short _NOEXTOP 		    ;FT. no, do normal			;AN000;
 20692                                  _IFS_extopen:									;AN000;
 20693 00003151 A0[0106]                	MOV	AL,[SAVE_BX]		    ; M034 - save_bx has original bx  
 20694                                  					    ; with which call was made. This
 20695                                  					    ; has the open access bits. 
 20696                                  	;;MOV	AL,[SAVE_CX]		    ; M034 - FT. al= create attribute
 20697                                  	
 20698 00003154 50                      	PUSH	AX			    ;FT. pass create attr to IFS	;AN000;
 20699                                  	;mov	ax,112Eh
 20700                                  	;MOV	AX,(MultNET SHL 8) OR 46    ;FT. issue extended open verb	;AN000;
 20701 00003155 B82E11                  	mov	ax,(MultNET*256)+46 
 20702 00003158 CD2F                    	INT	2FH			    ;FT.				;AN000;
 20703 0000315A 5B                      	POP	BX			    ;FT. trash bx			;AN000;
 20704 0000315B C606[F605]00            	MOV	byte [EXTOPEN_ON],0	    ;FT.				;AN000;
 20705                                  
 20706                                  do_ret_label:
 20707 00003160 C3                      	retn				    ;FT.				;AN000;
 20708                                  _NOEXTOP:
 20709                                  ;Extended open hooks
 20710                                  	;
 20711                                  ;IF NOT Installed
 20712                                  	;transfer NET_SEQ_OPEN
 20713                                  ;ELSE
 20714                                  	
 20715                                  do_net_int2f:
 20716 00003161 F606[8600]01            	test	byte [DOS_FLAG],EXECOPEN ; Q: was this open call made from exec
 20717 00003166 7409                    	jz	short not_exec_open	; N: just do net open
 20718                                  					; Y: check to see if redir is aware
 20719                                  					;    of this 
 20720                                  	
 20721                                  					; M042 - start
 20722                                  	;test	word [DOS34_FLAG],EXEC_AWARE_REDIR ; 800h
 20723 00003168 F606[1206]08            	test	byte [DOS34_FLAG+1],(EXEC_AWARE_REDIR>>8)
 20724                                  					; Q: does this redir know how to 
 20725                                  					;    this
 20726 0000316D 7402                    	jz	short not_exec_open	; N: just do net open
 20727                                  					; Y: set bit 3 of access byte and 
 20728                                  					;    set sharing mode to DENY_WRITE
 20729                                  					; M042 - end
 20730                                  	
 20731                                  	; NOTE: This specific mode has not been set for the code assembled
 20732                                  	; under the "NOT Installed" conditional. Currently Installed is 
 20733                                  	; always one.
 20734                                  					; M035 - set the bits on the stack
 20735                                  	;mov	al,23h
 20736 0000316F B023                    	mov	AL,SHARING_DENY_WRITE+EXEC_OPEN
 20737                                  	
 20738                                  not_exec_open:
 20739                                  	; MSDOS 3.3 & MSDOS 6.0
 20740 00003171 50                      	PUSH	AX
 20741                                  
 20742                                  	;MOV	AX,(MultNET SHL 8) OR 22
 20743                                  	;INT	2FH
 20744                                  
 20745 00003172 B81611                  	mov     ax,1116h
 20746 00003175 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - OPEN EXISTING REMOTE FILE
 20747                                  			; ES:DI -> uninitialized SFT, SS = DOS CS
 20748                                  			; SDA first filename pointer -> fully-qualified name of file to open
 20749                                  			; STACK: WORD file open mode
 20750                                  			; Return: CF set on error
 20751                                  
 20752 00003177 5B                      	POP	BX			; clean stack
 20753                                  ;do_ret_label: ; 09/08/2018
 20754 00003178 C3                      	retn
 20755                                  ;ENDIF
 20756                                  
 20757                                  TEST_RE_NET1:
 20758                                  	;TEST	word [ES:SI+curdir.flags],curdir_isnet
 20759                                  	; 17/12/2022
 20760 00003179 26F6444480              	test	byte [ES:SI+curdir.flags+1],curdir_isnet>>8
 20761 0000317E 07                      	POP	ES
 20762                                  	; 18/05/2019
 20763 0000317F 7409                    	JZ	short LOCAL_OPEN
 20764                                  
 20765                                  ;Extended open hooks
 20766                                  	; MSDOS 6.0
 20767 00003181 F606[F605]01            	TEST	byte [EXTOPEN_ON],EXT_OPEN_ON ;FT. from extended open	;AN000;
 20768 00003186 75C9                    	JNZ	short _IFS_extopen	      ;FT. issue extended open	;AN000;
 20769                                  ;Extended open hooks
 20770                                  
 20771                                  ;IF NOT Installed
 20772                                  ;	transfer NET_OPEN
 20773                                  ;ELSE
 20774 00003188 EBD7                    	jmp	short do_net_int2f
 20775                                  ;ENDIF
 20776                                  
 20777                                  LOCAL_OPEN:
 20778                                  	; MSDOS 3.3 & MSDOS 6.0
 20779 0000318A E8F7E6                  	call	ECritDisk
 20780                                  
 20781                                  ; DOS 3.3 FastOPen 6/16/86
 20782                                  
 20783                                  	; 03/03/2025 (MiniDOS)
 20784                                  	;;or	byte [FastOpenFlg],5
 20785                                  	;OR	byte [FastOpenFlg],FastOpen_Set+Special_Fill_Set ; only open can
 20786                                  
 20787 0000318D E83418                  	call	GETPATH
 20788                                  
 20789                                  ; DOS 3.3 FastOPen 6/16/86
 20790                                  
 20791 00003190 7317                    	JNC	short Open_found
 20792 00003192 750B                    	JNZ	short bad_path2
 20793 00003194 08C9                    	OR	CL,CL
 20794 00003196 7407                    	JZ	short bad_path2
 20795                                  OpenFNF:
 20796 00003198 B80200                  	MOV	AX,error_file_not_found	; 2
 20797                                  OpenBadRet:
 20798                                  ;hkn; FastOpenFlg is in DOSDATA use SS override
 20799                                  	; 12/08/2018
 20800                                  	;mov	byte [cs:FastOpenFlg],0 ; IBMDOS.COM (MSDOS 3.3) offset 36CAh
 20801                                  	; 03/03/2025 (MiniDOS)
 20802                                  	; MSDOS 6.0
 20803                                  	;AND	BYTE [SS:FastOpenFlg],Fast_yes    ;; DOS 3.3
 20804                                  	
 20805 0000319B F9                      	STC
 20806                                  	;call	LCritDisk
 20807                                  	; 16/12/2022
 20808 0000319C E912E7                  	jmp	LCritDisk
 20809                                  
 20810                                  bad_path2:
 20811 0000319F B80300                  	MOV	AX,error_path_not_found	; 3
 20812 000031A2 EBF7                    	JMP	short OpenBadRet
 20813                                  
 20814                                  Open_Bad_Access:
 20815 000031A4 B80500                  	MOV	AX,error_access_denied	; 5
 20816 000031A7 EBF2                    	JMP	short OpenBadRet
 20817                                  
 20818                                  Open_found:
 20819 000031A9 74F9                    	JZ	short Open_Bad_Access 	; test for directories
 20820 000031AB 08E4                    	OR	AH,AH
 20821 000031AD 783E                    	JS	short open_ok		; Devices don't have attributes
 20822 000031AF 8E06[E405]              	MOV	ES,[CURBUF+2]		; get buffer location
 20823                                  	;mov	al,[es:bx+0Bh]
 20824 000031B3 268A470B                	MOV	AL,[ES:BX+dir_entry.dir_attr]
 20825 000031B7 A808                    	TEST	AL,attr_volume_id	; can't open volume ids
 20826 000031B9 75E9                    	JNZ	short Open_Bad_Access
 20827 000031BB A801                    	TEST	AL,attr_read_only	; check write on read only
 20828 000031BD 742E                    	JZ	short open_ok
 20829                                  
 20830                                  ; The file is marked READ-ONLY. We verify that the open mode allows access to
 20831                                  ; the read-only file. Unfortunately, with FCB's and net-FCB's we cannot
 20832                                  ; determine at the OPEN time if such access is allowed. Thus, we defer such
 20833                                  ; processing until the actual write operation:
 20834                                  ;
 20835                                  ; If FCB, then we change the mode to be read_only.
 20836                                  ; If net_FCB, then we change the mode to be read_only.
 20837                                  ; If not open for read then error.
 20838                                  
 20839 000031BF 1E                      	push	ds
 20840 000031C0 56                      	push	si
 20841 000031C1 C536[9E05]              	LDS	SI,[THISSFT]
 20842                                  	;mov	cx,[si+2]
 20843 000031C5 8B4C02                  	MOV	CX,[SI+SF_ENTRY.sf_mode]
 20844                                  	; 17/12/2022
 20845                                  	;test	ch,80h
 20846 000031C8 F6C580                  	test	ch,sf_isFCB>>8
 20847                                  	;TEST	CX,sf_isFCB ; 8000h	; is it FCB?
 20848 000031CB 750A                    	JNZ	short ResetAccess	; yes, reset the access
 20849 000031CD 88CA                    	MOV	DL,CL
 20850 000031CF 80E2F0                  	AND	DL,SHARING_MASK	; 0F0h
 20851 000031D2 80FA70                  	CMP	DL,SHARING_NET_FCB ; 70h ; is it net FCB?
 20852 000031D5 7508                    	JNZ	short NormalOpen	; no
 20853                                  ResetAccess:
 20854                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)	
 20855                                  	;AND	CX,~access_mask	; 0FFF0h ; clear access
 20856                                  	; 16/12/2022
 20857                                  	;and	cl,0F0h ; 18/05/2019
 20858                                  	;;;
 20859                                  	; 01/02/2024 - Retro DOS v5.0
 20860                                  	; (PCDOS 7.1 IBMDOS.COM)
 20861                                  	;and	cx,0FFFCh
 20862 000031D7 80E1FC                  	and	cl,0FCh ; ~3 ; ~open_mode_mask ; clear access
 20863                                  	;;;
 20864                                  ;	OR	CX,open_for_read ; 0	; stick in open_for_read
 20865 000031DA 894C02                  	MOV	[SI+SF_ENTRY.sf_mode],CX
 20866 000031DD EB0C                    	JMP	SHORT FillSFT
 20867                                  
 20868                                  ; The SFT is normal. See if the requested access is open_for_read
 20869                                  
 20870                                  NormalOpen:
 20871                                  	;AND	CL,access_mask	; 0Fh	; remove extras
 20872                                  	;;;
 20873                                  	; 01/02/2024 - Retro DOS v5.0
 20874                                  	; (PCDOS 7.1 IBMDOS.COM)
 20875 000031DF 80E103                  	and     cl,3		; it was 'and cl,0Fh' in MSDOS 6.22
 20876                                  				; (and cl,access_mask)
 20877                                  				; this may be open_mode_mask
 20878                                  	;;;
 20879 000031E2 80F900                  	CMP	CL,open_for_read ; 0	; is it open for read?
 20880 000031E5 7404                    	JZ	short FillSFT	; yes
 20881 000031E7 5E                      	pop	si
 20882 000031E8 1F                      	pop	ds
 20883 000031E9 EBB9                    	JMP	short Open_Bad_Access
 20884                                  ;
 20885                                  ; All done, restore registers and fill the SFT.
 20886                                  ;
 20887                                  FillSFT:
 20888 000031EB 5E                      	pop	si
 20889 000031EC 1F                      	pop	ds
 20890                                  open_ok:
 20891 000031ED E8E520                  	call	DOOPEN			; Fill in SFT
 20892                                  
 20893                                  ;hkn; FastOpenFlg is in DOSDATA. use SS override
 20894                                  	; 18/05/2019
 20895                                  	;and	byte [ss:FastOpenFlag],80h
 20896                                  	; 03/03/2025 (MiniDOS)
 20897                                  	;AND	BYTE [SS:FastOpenFlg],Fast_yes	;; DOS 3.3
 20898                                  	; 12/08/2018
 20899                                  	;and	byte [FastOpenFlg],Fast_yes	
 20900                                  
 20901                                  	; MSDOS 6.0
 20902 000031F0 E84300                  	CALL	DO_SHARE_CHECK
 20903 000031F3 7303                    	JNC	short SHARE_OK
 20904                                  	;call	LCritDisk
 20905                                  	; 16/12/2022
 20906 000031F5 E9B9E6                  	jmp	LCritDisk
 20907                                  
 20908                                  SHARE_OK:
 20909                                  	; MSDOS 3.3 & MSDOS 6.0
 20910 000031F8 B80300                  	MOV	AX,3
 20911 000031FB C43E[9E05]              	LES	DI,[THISSFT]
 20912                                  ;if installed
 20913                                  	;call	JShare + 14 * 4
 20914 000031FF FF1E[C800]              	call	far [JShare+(14*4)]  ; 14 = ShSU
 20915                                  ;else
 20916                                  ;	Call	ShSU
 20917                                  ;endif
 20918 00003203 E8ABE6                  	call	LCritDisk
 20919                                  	
 20920                                  	;FallThru Set_SFT_Mode
 20921                                  
 20922                                  ;----------------------------------------------------------------------------
 20923                                  ; Procedure Name : SET_SFT_MODE
 20924                                  ;
 20925                                  ; Finish SFT initialization for new reference. Set the correct mode.
 20926                                  ;
 20927                                  ;   Inputs:
 20928                                  ;	ThisSFT points to SFT
 20929                                  ;
 20930                                  ;   Outputs:
 20931                                  ;	Carry clear
 20932                                  ;   Registers modified: AX.
 20933                                  ;---------------------------------------------------------------------------
 20934                                  
 20935                                  ;hkn; called from create. DS already set up to DOSDATA.
 20936                                  
 20937                                  SET_SFT_MODE:
 20938 00003206 C43E[9E05]              	LES	DI,[THISSFT]
 20939 0000320A E8EA1C                  	call	DEV_OPEN_SFT
 20940                                  	;test	word [es:di+2],8000h
 20941                                  	; 17/12/2022
 20942                                  	;test	byte [es:di+3],80h
 20943 0000320D 26F6450380              	test	byte [ES:DI+SF_ENTRY.sf_mode+1],sf_isFCB>>8
 20944                                  	;TEST	word [ES:DI+SF_ENTRY.sf_mode],sf_isFCB ; Clears carry
 20945 00003212 7407                    	JZ	short Clear_FastOpen	; sf_mode correct (retz)
 20946 00003214 A1[3003]                	MOV	AX,[CurrentPDB]
 20947                                  	;mov	[es:di+31h],ax
 20948 00003217 26894531                	MOV	[ES:DI+SF_ENTRY.sf_PID],AX ; For FCB sf_PID=PDB
 20949                                  
 20950                                  Clear_FastOpen:
 20951 0000321B C3                      	retn			       ;;;;; DOS 3.3
 20952                                  
 20953                                  ;----------------------------------------------------------------------------
 20954                                  ; Procedure Name : SHARE_ERROR
 20955                                  ;
 20956                                  ; Called on sharing violations. ES:DI points to SFT. AX has error code
 20957                                  ; If SFT is FCB or compatibility mode gens INT 24 error.
 20958                                  ; Returns carry set AX=error_sharing_violation if user says ignore (can't
 20959                                  ; really ignore). Carry clear if user wants a retry. ES, DI, DS preserved
 20960                                  ;---------------------------------------------------------------------------
 20961                                  
 20962                                  SHARE_ERROR:
 20963                                  	; 17/12/2022
 20964                                  	;test	byte [es:di+3],80h
 20965 0000321C 26F6450380              	test	byte [ES:DI+SF_ENTRY.sf_mode+1],sf_isFCB>>8 ; 80h
 20966                                  	;TEST	word [ES:DI+SF_ENTRY.sf_mode],sf_isFCB ; 8000h
 20967 00003221 7509                    	JNZ	short _HARD_ERR
 20968 00003223 268A4D02                	MOV	CL,[ES:DI+SF_ENTRY.sf_mode]
 20969 00003227 80E1F0                  	AND	CL,SHARING_MASK  ; 0F0h
 20970                                  	;CMP	CL,SHARING_COMPAT ; 0
 20971                                  	;JNE	short _NO_HARD_ERR
 20972                                  	; 21/09/2023
 20973 0000322A 7505                    	jnz	short _NO_HARD_ERR
 20974                                  _HARD_ERR:
 20975 0000322C E8A24E                  	call	SHARE_VIOLATION
 20976                                  	;retnc				; User wants retry
 20977 0000322F 73EA                    	jnc	short Clear_FastOpen
 20978                                  _NO_HARD_ERR:
 20979 00003231 B82000                  	MOV	AX,error_sharing_violation  ; 20h
 20980 00003234 F9                      	STC
 20981 00003235 C3                      	retn
 20982                                  
 20983                                  ; MSDOS 6.0
 20984                                  ;----------------------------------------------------------------------------
 20985                                  ; Procedure Name : DO_SHARE_CHECK
 20986                                  ;
 20987                                  ; Input: THISDPB, WFP_Start, THISSFT set
 20988                                  ; Functions: check file sharing mode is valid
 20989                                  ; Output: carry set, error
 20990                                  ;	  carry clear, share ok
 20991                                  ;----------------------------------------------------------------------------
 20992                                  
 20993                                  	; 18/05/2019 - Retro DOS v4.0
 20994                                  DO_SHARE_CHECK:
 20995 00003236 E84BE6                  	call	ECritDisk		; enter critical section
 20996                                  OPN_RETRY:
 20997 00003239 8B0E[1A00]              	MOV	CX,[RetryCount]		; Get # tries to do
 20998                                  OpenShareRetry:
 20999 0000323D 51                      	push	cx			; Save number left to do
 21000 0000323E E88B4E                  	call	SHARE_CHECK		; Final Check
 21001 00003241 59                      	pop	cx			; CX = # left
 21002 00003242 730E                    	JNC	short Share_Ok2		; No problem with access
 21003 00003244 E87AE5                  	call	Idle
 21004 00003247 E2F4                    	LOOP	OpenShareRetry		; One more retry used up
 21005                                  OpenShareFail:
 21006 00003249 C43E[9E05]              	LES	DI,[THISSFT]
 21007 0000324D E8CCFF                  	call	SHARE_ERROR
 21008 00003250 73E7                    	JNC	short OPN_RETRY		; User wants more retry
 21009                                  Share_Ok2:
 21010                                  	;call	LCritDisk		; leave critical section
 21011                                  	;retn
 21012                                  	; 18/12/2022
 21013 00003252 E95CE6                  	jmp	LCritDisk
 21014                                  
 21015                                  ;-----------------------------------------------------------------------------
 21016                                  ; Procedure Name : Check_Access
 21017                                  ;
 21018                                  ; Inputs:
 21019                                  ;	AX is mode
 21020                                  ;	  High NIBBLE of AL (Sharing Mode)
 21021                                  ;		sharing_compat	   file is opened in compatibility mode
 21022                                  ;		sharing_deny_none  file is opened Multi reader, Multi writer
 21023                                  ;		sharing_deny_read  file is opened Only reader, Multi writer
 21024                                  ;		sharing_deny_write file is opened Multi reader, Only writer
 21025                                  ;		sharing_deny_both  file is opened Only reader, Only writer
 21026                                  ;	  Low NIBBLE of AL (Access Mode)
 21027                                  ;		open_for_read	file is opened for reading
 21028                                  ;		open_for_write	file is opened for writing
 21029                                  ;		open_for_both	file is opened for both reading and writing.
 21030                                  ; Function:
 21031                                  ;	Check this access mode for correctness
 21032                                  ; Outputs:
 21033                                  ;	[open_access] = AL input
 21034                                  ;	Carry Clear
 21035                                  ;		Mode is correct
 21036                                  ;		AX unchanged
 21037                                  ;	Carry Set
 21038                                  ;		Mode is bad
 21039                                  ;		AX = error_invalid_access
 21040                                  ; No other registers effected
 21041                                  ;----------------------------------------------------------------------------
 21042                                  
 21043                                  	; 23/01/2024 - Retro DOS v5.0
 21044                                  Check_Access_AX:
 21045 00003255 A2[6E05]                	MOV	[OPEN_ACCESS],AL
 21046 00003258 53                      	PUSH	BX
 21047                                  
 21048                                  ;	If sharing, then test for special sharing mode for FCBs
 21049                                  
 21050 00003259 88C3                    	MOV	BL,AL
 21051 0000325B 80E3F0                  	AND	BL,SHARING_MASK ; 0F0h
 21052                                  
 21053                                  	;CMP	byte [FSHARING],-1
 21054                                  	;JNZ	short CheckShareMode	; not through server call, must be ok
 21055                                  	; 23/01/2024
 21056                                  	; PCDOS 7.1 IBMDOS.COM
 21057 0000325E 803E[7205]00            	cmp	byte [FSHARING],0
 21058 00003263 7405                    	jz	short CheckShareMode	; not through server call, must be ok
 21059                                  
 21060 00003265 80FB70                  	CMP	BL,SHARING_NET_FCB ; 70h
 21061 00003268 7405                    	JZ	short CheckAccessMode	; yes, we have an FCB
 21062                                  CheckShareMode:
 21063 0000326A 80FB40                  	CMP	BL,40h			; is this a good sharing mode?
 21064 0000326D 770D                    	JA	short Make_Bad_Access
 21065                                  CheckAccessMode:
 21066 0000326F 88C3                    	MOV	BL,AL
 21067                                  	; 23/01/2024
 21068 00003271 80E303                  	and	bl,3 ; PCDOS 7.1 IBMDOS.COM	
 21069                                  	;AND	BL,access_mask ; 0Fh
 21070 00003274 80FB02                  	CMP	BL,2
 21071 00003277 7703                    	JA	short Make_Bad_Access
 21072 00003279 5B                      	POP	BX
 21073 0000327A F8                      	CLC
 21074 0000327B C3                      	retn
 21075                                  
 21076                                  Make_Bad_Access:
 21077 0000327C B80C00                  	MOV	AX,error_invalid_access ; 0Ch
 21078 0000327F 5B                      	POP	BX
 21079 00003280 F9                      	STC
 21080 00003281 C3                      	retn
 21081                                  
 21082                                  ;============================================================================
 21083                                  ; DINFO.ASM, MSDOS 6.0, 1991
 21084                                  ;============================================================================
 21085                                  ; 08/08/2018 - Retro DOS v3.0
 21086                                  ; 18/05/2019 - Retro DOS v4.0
 21087                                  ; 02/02/2024 - Retro DOS v5.0
 21088                                  
 21089                                  ;**	Low level routine for returning disk drive information from a local
 21090                                  ;	  or NET device
 21091                                  ;
 21092                                  ;	DISK_INFO
 21093                                  ;
 21094                                  ;	  Modification history:
 21095                                  ;
 21096                                  ;		Created: ARR 30 March 1983
 21097                                  
 21098                                  ;	Break	<DISK_INFO -- Get Disk Drive Information>
 21099                                  ;---------------------------------------------------------------------------
 21100                                  ; Procedure Name : DISK_INFO
 21101                                  ;
 21102                                  ; Inputs:
 21103                                  ;	[THISCDS] Points to the Macro List Structure of interest
 21104                                  ;		(It MAY NOT be NUL, error not detected)
 21105                                  ; Function:
 21106                                  ;	Get Interesting Drive Information
 21107                                  ; Returns:
 21108                                  ;	DX = Number of free allocation units
 21109                                  ;	BX = Total Number of allocation units on disk
 21110                                  ;	CX = Sector size
 21111                                  ;	AL = Sectors per allocation unit
 21112                                  ;	AH = FAT ID BYTE
 21113                                  ;	Carry set if error (currently user FAILed to I 24)
 21114                                  ; Segs except ES preserved, others destroyed
 21115                                  ;----------------------------------------------------------------------------
 21116                                  
 21117                                  ;hkn; called from getset.asm and misc.asm. DS has already been set up to
 21118                                  ;hkn; DOSDATA. 
 21119                                  
 21120                                  	; 02/02/2024 - Retro DOS v5.0
 21121                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:732Bh
 21122                                  
 21123                                  DISK_INFO:
 21124                                  	; 08/08/2018 - Retro DOS v3.0
 21125                                  	; IBM DOS.COM (MSDOS 3.3, 1987) - Offset 37C5h
 21126                                  
 21127 00003282 E881E5                  	call	TestNet
 21128 00003285 7318                    	JNC	short LOCAL_DSK_INFO
 21129                                  
 21130                                  	;;;
 21131                                  	; 02/02/2024 (PCDOS 7.1 IBMDOS.COM)
 21132 00003287 31F6                    	xor     si,si	; free cluster count hw = 0
 21133 00003289 31FF                    	xor     di,di	; number of clusters hw = 0
 21134                                  	;;;
 21135                                  
 21136                                  ;IF NOT Installed
 21137                                  ;	transfer NET_DISK_INFO
 21138                                  ;ELSE
 21139                                  	;MOV	AX,(MultNET SHL 8) OR 12
 21140                                  	;INT	2FH
 21141                                  	;return
 21142                                  
 21143 0000328B B80C11                  	mov     ax,110Ch
 21144 0000328E CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - GET DISK SPACE
 21145                                  			; ES:DI -> current directory
 21146                                  			; Return: AL = sectors per cluster, BX = total clusters
 21147                                  			; CX = bytes per sector, DX = number of available clusters
 21148                                  	;;;
 21149                                  	; 02/02/2024 (PCDOS 7.1 IBMDOS.COM)
 21150 00003290 83FBFF                  	cmp	bx,0FFFFh
 21151 00003293 7502                    	jne	short dsk_info_1
 21152 00003295 89DF                    	mov	di,bx
 21153                                  dsk_info_1:
 21154 00003297 83FAFF                  	cmp	dx,0FFFFh
 21155 0000329A 7502                    	jne	short disk_info_retn
 21156 0000329C 89D6                    	mov	si,dx
 21157                                  disk_info_retn:
 21158                                  	;;;
 21159 0000329E C3                      	retn
 21160                                  ;ENDIF
 21161                                  
 21162                                  LOCAL_DSK_INFO:
 21163                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Disk
 21164                                  	;;;
 21165                                  	; 02/02/2024 (PCDOS 7.1 IBMDOS.COM)
 21166 0000329F E821E0                  	call	set_exerr_locus_disk
 21167                                  	;;;
 21168 000032A2 E8DFE5                  	call	ECritDisk
 21169 000032A5 E8592F                  	call	FATREAD_CDS		; perform media check.
 21170                                  	;JC	short CRIT_LEAVE
 21171                                  	;;; 02/02/2024
 21172 000032A8 720D                    	jc	short dsk_info_2
 21173 000032AA 31C0                    	xor	ax,ax
 21174 000032AC A3[E80A]                	mov	[CLUSTNUM_HW],ax ; 0	; clear high word of cluster number
 21175                                  	;;;
 21176 000032AF BB0200                  	MOV	BX,2
 21177 000032B2 E8D22C                  	call	UNPACK			; Get first FAT sector into CURBUF
 21178                                  	;JC	short CRIT_LEAVE
 21179                                  	;;;
 21180                                  	; 02/02/2024 - Retro DOS v5.0
 21181 000032B5 7303                    	jnc	short dsk_info_3
 21182                                  dsk_info_2:
 21183                                  	;jmp	CRIT_LEAVE
 21184 000032B7 E9F7E5                  	jmp	LCritDisk
 21185                                  dsk_info_3:
 21186                                  	;;;
 21187 000032BA C536[E205]              	LDS	SI,[CURBUF]
 21188                                  	; 02/02/2024
 21189                                  	;;mov	ah,[si+20]
 21190                                  	;mov	ah,[si+24] ; PCDOS 7.1 IBMDOS.COM
 21191 000032BE 8A6418                  	MOV	AH,[SI+BUFINSIZ]	; get FAT ID BYTE
 21192                                  
 21193                                  ;hkn; SS is DOSDATA
 21194 000032C1 16                      	push	ss
 21195 000032C2 1F                      	pop	ds
 21196                                  
 21197                                  ; 02/02/2024 - Retro DOS v5.0
 21198                                  %if 0
 21199                                  	;mov	cx,[es:bp+0Dh]
 21200                                  	MOV	CX,[ES:BP+DPB.MAX_CLUSTER]
 21201                                  
 21202                                  ; Examine the current free count. If it indicates that we have an invalid
 21203                                  ; count, do the expensive calculation.
 21204                                  
 21205                                  	;mov	dx,[es:bp+1Fh]
 21206                                  	MOV	DX,[ES:BP+DPB.FREE_CNT] ; get free count
 21207                                  	CMP	DX,-1			; is it valid?
 21208                                  	JZ	short DoScan
 21209                                  
 21210                                  ; Check to see if it is in a reasonable range. If so, trust it and return.
 21211                                  ; Otherwise, we need to blast out an internal error message and then recompute
 21212                                  ; the count.
 21213                                  
 21214                                  	CMP	DX,CX			; is it in a reasonable range?
 21215                                  	JB	short GotVal		; yes, trust it.
 21216                                  DoScan:
 21217                                  	XOR	DX,DX
 21218                                  	DEC	CX
 21219                                  SCANFREE:
 21220                                  	call	UNPACK
 21221                                  	JC	short CRIT_LEAVE
 21222                                  	JNZ	short NOTFREECLUS
 21223                                  	INC	DX			; A free one
 21224                                  NOTFREECLUS:
 21225                                  	INC	BX			; Next cluster
 21226                                  	LOOP	SCANFREE
 21227                                  	DEC	BX			; BX was next cluster. Convert to
 21228                                  ReturnVals:
 21229                                  	DEC	BX			; count
 21230                                  	;mov	al,[es:bp+4]
 21231                                  	MOV	AL,[ES:BP+DPB.CLUSTER_MASK]
 21232                                  	INC	AL			; Sectors/cluster
 21233                                  	;mov	cx,[es:bp+2]
 21234                                  	MOV	CX,[ES:BP+DPB.SECTOR_SIZE] ; Bytes/sector
 21235                                  	;mov	[es:bp+1Fh],dx
 21236                                  	MOV	[ES:BP+DPB.FREE_CNT],DX
 21237                                  	CLC
 21238                                  CRIT_LEAVE:
 21239                                  	;call	LCritDisk
 21240                                  	;retn
 21241                                  	; 17/12/2022
 21242                                  	jmp	LCritDisk
 21243                                  
 21244                                  ; We have correctly computed everything previously. Load up registers for
 21245                                  ; return.
 21246                                  
 21247                                  GotVal: 
 21248                                  	MOV	BX,CX			; get cluster count
 21249                                  	JMP	short ReturnVals
 21250                                  
 21251                                  %else
 21252                                  	; 02/02/2024 (PCDOS 7.1 IBMDOS.COM)
 21253 000032C3 31F6                    	xor	si,si	; 0
 21254 000032C5 89F7                    	mov	di,si	; 0
 21255                                  	;mov	dx,[es:bp+1Fh]
 21256 000032C7 268B561F                	mov	dx,[es:bp+DPB.FREE_CNT]	; get free count
 21257                                  	;cmp	[es:bp+0Fh],si
 21258 000032CB 2639760F                	cmp	[es:bp+DPB.FAT_SIZE],si ; FAT32 (16 bit FAT size = 0) ?
 21259 000032CF 7406                    	jz	short dsk_info_4	; yes
 21260                                  	;mov	cx,[es:bp+0Dh]
 21261 000032D1 268B4E0D                	mov	cx,[es:bp+DPB.MAX_CLUSTER]
 21262 000032D5 EB18                    	jmp	short dsk_info_5 ; zf=0, si=di=0
 21263                                  
 21264                                  dsk_info_4:
 21265                                  	;mov	di,[es:bp+2Fh]
 21266 000032D7 268B7E2F                	mov	di,[es:bp+DPB.LAST_CLUSTER+2]
 21267                                  	;mov	cx,[es:bp+2Dh]
 21268 000032DB 268B4E2D                	mov	cx,[es:bp+DPB.LAST_CLUSTER]
 21269                                  	;mov	si,[es:bp+21h]
 21270 000032DF 268B7621                	mov	si,[es:bp+DPB.FREE_CNT_HW] ; hw of free cluster count
 21271 000032E3 39F2                    	cmp	dx,si			; same (zero) ?
 21272                                  ;dsk_info_5:
 21273 000032E5 7504                    	jnz	short dsk_info_6	; not same (not zero)
 21274 000032E7 42                      	inc	dx
 21275 000032E8 740B                    	jz	short dsk_info_8	; 0FFFFh -> 0 (free count is invalid/initial)
 21276                                  					; free count calculation is needed
 21277 000032EA 4A                      	dec	dx
 21278                                  dsk_info_6:
 21279 000032EB 39FE                    	cmp	si,di			; same hw ?
 21280 000032ED 7502                    	jne	short dsk_info_7	; no
 21281                                  dsk_info_5:	; 02/02/2024 - Retro DOS v5.0 
 21282 000032EF 39CA                    	cmp	dx,cx			; same lw ?
 21283                                  dsk_info_7:
 21284 000032F1 7268                    	jb	short GotVal		; free cluster count < last cluster number
 21285 000032F3 31D2                    	xor	dx,dx	; 0
 21286                                  dsk_info_8:
 21287 000032F5 31F6                    	xor	si,si	; 0
 21288 000032F7 83E901                  	sub	cx,1			; last cluster number - 1 = number of clusters
 21289 000032FA 19F7                    	sbb	di,si
 21290                                  	;or	byte [es:bp+18h],1
 21291 000032FC 26804E1801              	or	byte [es:bp+DPB.FIRST_ACCESS],1 ; set first access bit 0
 21292                                  					; (Update flag for FSINFO sector)
 21293                                  SCANFREE:
 21294 00003301 56                      	push	si
 21295 00003302 FF36[EC0A]              	push	word [CCONTENT_HW]
 21296 00003306 57                      	push	di
 21297 00003307 E87D2C                  	call	UNPACK
 21298 0000330A 5F                      	pop	di
 21299 0000330B 8F06[EC0A]              	pop	word [CCONTENT_HW]
 21300 0000330F 5E                      	pop	si
 21301 00003310 7246                    	jc	short CRIT_LEAVE
 21302 00003312 7504                    	jnz	short NOTFREECLUS
 21303 00003314 42                      	inc	dx			; a free one
 21304 00003315 7501                    	jnz	short NOTFREECLUS
 21305 00003317 46                      	inc	si			; increase hw of free cluster count
 21306                                  
 21307                                  NOTFREECLUS:
 21308 00003318 43                      	inc	bx			; next cluster
 21309 00003319 7504                    	jnz	short NOTFREECLUS2
 21310 0000331B FF06[E80A]              	inc	word [CLUSTNUM_HW]	; increase hw of (next) cluster number
 21311                                  
 21312                                  NOTFREECLUS2:
 21313 0000331F 83E901                  	sub	cx,1			; decrease remain cluster count for calculation
 21314 00003322 83DF00                  	sbb	di,0
 21315 00003325 75DA                    	jnz	short SCANFREE
 21316 00003327 E302                    	jcxz	NOTFREECLUS3		; calculation completed
 21317 00003329 EBD6                    	jmp	short SCANFREE
 21318                                  
 21319                                  NOTFREECLUS3:
 21320 0000332B 8B3E[E80A]              	mov	di,[CLUSTNUM_HW]
 21321 0000332F 83EB01                  	sub	bx,1
 21322 00003332 83DF00                  	sbb	di,0			; di:bx = last cluster number
 21323                                  
 21324                                  ReturnVals:
 21325 00003335 31C9                    	xor	cx,cx
 21326 00003337 83EB01                  	sub	bx,1
 21327 0000333A 19CF                    	sbb	di,cx			; di:bx = number of clusters
 21328                                  	;mov	al,[es:bp+4]
 21329 0000333C 268A4604                	mov	al,[es:bp+DPB.CLUSTER_MASK] ; spc - 1
 21330 00003340 FEC0                    	inc	al			; sectors per cluster
 21331                                  	;mov	[es:bp+1Fh],dx		
 21332 00003342 2689561F                	mov	[es:bp+DPB.FREE_CNT],dx	; free cluster count,lw
 21333                                  	;cmp	[es:bp+0Fh],cx ; 0
 21334 00003346 26394E0F                	cmp	[es:bp+DPB.FAT_SIZE],cx ; 0 ; FAT32 (16 bit FAT size = 0) ?
 21335 0000334A 7507                    	jnz	short ReturnVals2	; no
 21336                                  	;mov	[es:bp+21h],si
 21337 0000334C 26897621                	mov	[es:bp+DPB.FREE_CNT_HW],si ; hw of free cluster count
 21338                                  
 21339 00003350 E83800                  	call	update_fat32_fsinfo
 21340                                  
 21341                                  ReturnVals2:
 21342                                  	;mov	cx,[es:bp+2]
 21343 00003353 268B4E02                	mov	cx,[es:bp+DPB.SECTOR_SIZE] ; bytes per sector
 21344 00003357 F8                      	clc
 21345                                  
 21346                                  CRIT_LEAVE:
 21347                                  	;call	LCritDisk
 21348                                  	;retn
 21349 00003358 E956E5                  	jmp	LCritDisk
 21350                                  
 21351                                  GotVal:
 21352 0000335B 89CB                    	mov	bx,cx
 21353 0000335D EBD6                    	jmp	short ReturnVals
 21354                                  
 21355                                  %endif
 21356                                  
 21357                                  ; =============== S U B R O U T I N E =======================================
 21358                                  
 21359                                  ; 03/02/2024 - Retro DOS v5.0
 21360                                  
 21361                                  modify_spc:
 21362 0000335F 50                      	push	ax			; ax = sectors per cluster
 21363 00003360 52                      	push	dx
 21364 00003361 F7E1                    	mul	cx			; bytes per sector
 21365                                  	;cmp	dx,0
 21366 00003363 21D2                    	and	dx,dx
 21367 00003365 7503                    	jnz	short mspc_1
 21368 00003367 3D0040                  	cmp	ax,16384		; 16 kilobytes (per cluster)
 21369                                  					; ***
 21370                                  					; actual disk size limit
 21371                                  					; without invalidating cluster counts is
 21372                                  					; 2 GB (512K clusters * 8 sectors per cluster)
 21373                                  					;      (128K clusters * 32 sectors per cluster)
 21374                                  mspc_1:
 21375 0000336A 5A                      	pop	dx
 21376 0000336B 58                      	pop	ax
 21377 0000336C 760E                    	jbe	short mspc_3		; bytes per cluster <= 16 KB
 21378                                                                          ; ***
 21379                                                                          ; bytes per cluster > 16 KB
 21380 0000336E 31FF                    	xor	di,di			; 0
 21381 00003370 BBFEFF                  	mov	bx,0FFFEh		; (invalidated)
 21382 00003373 09F6                    	or	si,si			; hw of free cluster count
 21383 00003375 7404                    	jz	short mspc_2		; si = 0
 21384 00003377 89FE                    	mov	si,di			; si = 0
 21385 00003379 89DA                    	mov	dx,bx			; dx = bx = 0FFFEh (invalidated)
 21386                                  mspc_2:
 21387 0000337B C3                      	retn
 21388                                  
 21389                                  mspc_3:
 21390 0000337C D1E0                    	shl	ax,1			; sectors per clust = sectors per clust * 2
 21391                                  					; (ax <= 32768) -modified spc limit-
 21392 0000337E D1EF                    	shr	di,1			; cluster count = cluster count /2
 21393                                  					; di:bx = modified value of total clusters
 21394                                  mspc_4:
 21395 00003380 D1DB                    	rcr	bx,1
 21396 00003382 D1EE                    	shr	si,1			; free clusters = free clusters / 2
 21397 00003384 D1DA                    	rcr	dx,1			; si:dx = modified value of free clusters
 21398                                  
 21399                                  ; ---------------------------------------------------------------------------
 21400                                  
 21401                                  	; 03/02/2024
 21402                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:7431h
 21403                                  
 21404                                  modify_cluster_count:
 21405 00003386 09FF                    	or	di,di			; hw of cluster count
 21406 00003388 75D5                    	jnz	short modify_spc
 21407 0000338A C3                      	retn
 21408                                  
 21409                                  ; =============== S U B R O U T I N E =======================================
 21410                                  
 21411                                  ; write FSINFO sector onto disk
 21412                                  
 21413                                  ; 03/02/2024 - Retro DOS v5.0
 21414                                  ; --------------------------------
 21415                                  ; FAT32 FSInfo Sector Structure
 21416                                  ; --------------------------------
 21417                                  ; ref: Microsoft FAT32 File System Specification (2000)
 21418                                  
 21419                                  struc FSINFO		; Offset ;
 21420 00000000 ????????                .LeadSig:	resb 4	  ; 0		; Value 0x41615252. Lead Signature.
 21421 00000004 <res 1E0h>              .Reserved1:	resb 480  ; 4		; Reserved. Must be 0. Never be used.
 21422 000001E4 ????????                .StrucSig:	resb 4	  ; 484		; Value 0x61417272. Fields Signature.
 21423 000001E8 ????????                .Free_Count:	resb 4	  ; 488		; Last known free cluster count. (*) 
 21424 000001EC ????????                .Nxt_Free:	resb 4	  ; 492		; Start clus for free clus srch. (**)
 21425 000001F0 <res Ch>                .Reserved2:	resb 12	  ; 496		; Reserved. Must be 0. Never be used.
 21426 000001FC ????????                .TrailSig:	resb 4	  ; 508		; Value 0xAA550000. Trail Signature.
 21427                                  .size:
 21428                                  endstruc
 21429                                  
 21430                                  ; (*) If the value is 0xFFFFFFFF, then the free count is unknown
 21431                                  ;     and must be computed.
 21432                                  ; (**) If the value is 0xFFFFFFFF, then free cluster search must be started
 21433                                  ;     from cluster 2.
 21434                                  ; Lead Signature, Fields (Structure) Signature and Trail Signature
 21435                                  ; are used to validate FSInfo sector.
 21436                                  
 21437                                  ; --------------------------------
 21438                                  
 21439                                  	; 03/02/2024 - Retro DOS v5.0
 21440                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:7436h
 21441                                  	; (Windows ME IO.SYS - BIOSCODE:7227h)
 21442                                  
 21443                                  update_fat32_fsinfo:
 21444 0000338B 51                      	push	cx
 21445 0000338C 52                      	push	dx
 21446 0000338D 31C9                    	xor	cx,cx
 21447                                  	;mov	dx,[es:bp+25h]
 21448 0000338F 268B5625                	mov	dx,[es:bp+DPB.FSINFO_SECTOR]
 21449                                  	;cmp	[es:bp+0Fh],cx
 21450 00003393 26394E0F                	cmp	[es:bp+DPB.FAT_SIZE],cx ; 0
 21451                                  				; (16bit FAT size field = 0 for FAT32 fs)
 21452 00003397 7505                    	jne	short u_fat32_inf_1
 21453 00003399 83FAFF                  	cmp	dx,0FFFFh ; -1
 21454 0000339C 7508                    	jne	short u_fat32_inf_2
 21455                                  
 21456                                  u_fat32_inf_1:
 21457 0000339E 5A                      	pop	dx
 21458 0000339F 59                      	pop	cx
 21459                                  	;and	byte [es:bp+18h],0F4h
 21460 000033A0 26806618F4              	and	byte [es:bp+DPB.FIRST_ACCESS],0F4h ; clear bit 0,1 and 3
 21461                                  					; bit 0 - FSINFO update (dirty) bit
 21462                                  					; bit 1 - BPB_RootClus update bit
 21463                                  					; bit 3 - BPB_ExtFlags update bit
 21464 000033A5 C3                      	retn
 21465                                  
 21466                                  u_fat32_inf_2:
 21467 000033A6 50                      	push	ax
 21468 000033A7 53                      	push	bx
 21469 000033A8 57                      	push	di
 21470 000033A9 56                      	push	si
 21471 000033AA 1E                      	push	ds
 21472 000033AB 36803E[7900]00          	cmp	byte [ss:BuffInHMA],0	; is buffers in HMA?
 21473 000033B1 740A                    	jz	short u_fat32_inf_3	; no
 21474 000033B3 36C53E[7A00]            	lds	di,[ss:LoMemBuff]	; read it into scratch buffer
 21475                                  	;sub	di,24
 21476 000033B8 83EF18                  	sub	di,BUFINSIZ		; space for buffer header
 21477                                  					; (buffer header size = 24)
 21478                                  	;clc
 21479 000033BB EB0E                    	jmp	short u_fat32_inf_4
 21480                                  
 21481                                  u_fat32_inf_3:
 21482 000033BD 06                      	push	es
 21483 000033BE 55                      	push	bp
 21484 000033BF E89D31                  	call	GETCURHEAD		; ds:di = first buffer in queue
 21485 000033C2 52                      	push	dx
 21486 000033C3 E8FC33                  	call	BUFWRITE		; BufWrite writes a buffer to the disk,
 21487                                  					;  if it's dirty.
 21488 000033C6 5A                      	pop	dx
 21489 000033C7 5D                      	pop	bp
 21490 000033C8 07                      	pop	es
 21491                                  ;u_fat32_inf_4:
 21492 000033C9 726A                    	jc	short u_fat32_inf_5
 21493                                  u_fat32_inf_4:
 21494 000033CB 31C9                    	xor	cx,cx
 21495                                  	;lea	bx,[di+24]
 21496 000033CD 8D5D18                  	lea	bx,[di+BUFINSIZ]	; buffer data address
 21497                                  	;mov	byte [ss:ALLOWED],18h
 21498 000033D0 36C606[4B03]18          	mov	byte [ss:ALLOWED],Allowed_FAIL+Allowed_RETRY
 21499 000033D6 36890E[0706]            	mov	[ss:HIGH_SECTOR],cx ; 0
 21500 000033DB 41                      	inc	cx			; cx = sector count = 1
 21501                                  					; es:bp = DPB
 21502 000033DC 53                      	push	bx			; ds:bx = buffer (data) address
 21503 000033DD 52                      	push	dx			; HIGH_SECTOR:dx = disk sector address
 21504 000033DE E8DE0A                  	call	DREAD		 	; read fs info sector
 21505 000033E1 5A                      	pop	dx
 21506 000033E2 5B                      	pop	bx
 21507 000033E3 7250                    	jc	short u_fat32_inf_5
 21508                                  
 21509                                  	;cmp	word [bx+FSINFO.LeadSig],5252h	
 21510 000033E5 813F5252                	cmp	word [bx],5252h		; 'RR'
 21511 000033E9 754A                    	jne	short u_fat32_inf_5
 21512                                  	;cmp	word [bx+2],4161h	; 'aA' ; (NASM syntax)
 21513 000033EB 817F026141              	cmp	word [bx+FSINFO.LeadSig+2],4161h
 21514 000033F0 7543                    	jne	short u_fat32_inf_5
 21515                                  	
 21516                                  	;cmp	word [bx+1E4h],7272h	; 'rr' at offset 484
 21517 000033F2 81BFE4017272            	cmp	word [bx+FSINFO.StrucSig],7272h
 21518 000033F8 753B                    	jne	short u_fat32_inf_5
 21519                                  
 21520                                  	;cmp	word [bx+1E6h],6141h	; 'Aa' at offset 486
 21521 000033FA 81BFE6014161            	cmp	word [bx+FSINFO.StrucSig+2],6141h
 21522 00003400 7533                    	jne	short u_fat32_inf_5
 21523                                  
 21524                                  	;cmp	word [bx+1FEh],0AA55h	; boot signature at offset 510
 21525 00003402 81BFFE0155AA            	cmp	word [bx+FSINFO.TrailSig+2],0AA55h
 21526 00003408 752B                    	jne	short u_fat32_inf_5
 21527                                  	
 21528                                  	;mov	ax,[es:bp+1Fh]
 21529 0000340A 268B461F                	mov	ax,[es:bp+DPB.FREE_CNT]
 21530                                  	;mov	[bx+1E8h],ax 
 21531 0000340E 8987E801                	mov	[bx+FSINFO.Free_Count],ax ; at offset 488
 21532                                  	;mov	ax,[es:bp+21h]
 21533 00003412 268B4621                	mov	ax,[es:bp+DPB.FREE_CNT+2]
 21534                                  	;mov	[bx+1EAh],ax
 21535 00003416 8987EA01                	mov	[bx+FSINFO.Free_Count+2],ax
 21536                                  
 21537                                  	;mov	ax,[es:bp+39h]
 21538 0000341A 268B4639                	mov	ax,[es:bp+DPB.FAT32_NXTFREE]
 21539                                  	;mov	[bx+1ECh],ax
 21540 0000341E 8987EC01                	mov	[bx+FSINFO.Nxt_Free],ax	; at offset 492
 21541                                  	;mov	ax,[es:bp+3Bh]
 21542 00003422 268B463B                	mov	ax,[es:bp+DPB.FAT32_NXTFREE+2]
 21543                                  	;mov	[bx+1EEh],ax
 21544 00003426 8987EE01                	mov	[bx+FSINFO.Nxt_Free+2],ax
 21545                                  
 21546 0000342A 31C9                    	xor	cx,cx
 21547 0000342C 36890E[0706]            	mov	[ss:HIGH_SECTOR],cx ; 0
 21548 00003431 41                      	inc	cx	; 1
 21549 00003432 E8EF0A                  	call	DWRITE
 21550                                  
 21551                                  u_fat32_inf_5:
 21552 00003435 1F                      	pop	ds
 21553 00003436 5E                      	pop	si
 21554 00003437 5F                      	pop	di
 21555 00003438 5B                      	pop	bx
 21556 00003439 58                      	pop	ax
 21557 0000343A E961FF                  	jmp	u_fat32_inf_1
 21558                                  
 21559                                  ;============================================================================
 21560                                  ; ISEARCH.ASM, MSDOS 6.0, 1991
 21561                                  ;============================================================================
 21562                                  ; 22/07/2018 - Retro DOS v3.0
 21563                                  
 21564                                  ;	TITLE	DOS_SEARCH - Internal SEARCH calls for MS-DOS
 21565                                  ;	NAME	DOS_SEARCH
 21566                                  
 21567                                  ;**	Low level routines for doing local and NET directory searches
 21568                                  ;
 21569                                  ;	DOS_SEARCH_FIRST
 21570                                  ;	DOS_SEARCH_NEXT
 21571                                  ;	RENAME_NEXT
 21572                                  ;
 21573                                  ;	Revision history:
 21574                                  ;
 21575                                  ;	    Created: ARR 30 March 1983
 21576                                  ;	    A000	version 4.00  Jan. 1988
 21577                                  ;	    A001	PTM 3564 -- search for fastopen
 21578                                  
 21579                                  ;Installed = TRUE
 21580                                  
 21581                                  ;--------------------------------------------------------------------------
 21582                                  ;
 21583                                  ; Procedure Name : DOS_SEARCH_FIRST
 21584                                  ;
 21585                                  ; Inputs:
 21586                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 21587                                  ;		terminated)
 21588                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 21589                                  ;		( = -1 if current dir not involved, else
 21590                                  ;		 Points to first char after last "/" of current dir part)
 21591                                  ;	[THISCDS] Points to CDS being used
 21592                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 21593                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 21594                                  ;	[DMAADD] Points to 53 byte buffer
 21595                                  ; Function:
 21596                                  ;	Initiate a search for the given file spec
 21597                                  ; Outputs:
 21598                                  ;	CARRY CLEAR
 21599                                  ;	    The 53 bytes ot DMAADD are filled in as follows:
 21600                                  ;
 21601                                  ;	LOCAL
 21602                                  ;	    Drive Byte (A=1, B=2, ...) High bit clear
 21603                                  ;		NEVER STORE DRIVE BYTE AFTER  found_it
 21604                                  ;	    11 byte search name with Meta chars in it
 21605                                  ;	    Search Attribute Byte, attribute of search
 21606                                  ;	    WORD LastEnt value
 21607                                  ;	    WORD DirStart
 21608                                  ;	    4 byte pad
 21609                                  ;	    32 bytes of the directory entry found
 21610                                  ;	NET
 21611                                  ;	    21 bytes First byte has high bit set
 21612                                  ;	    32 bytes of the directory entry found
 21613                                  ;
 21614                                  ;	CARRY SET
 21615                                  ;	    AX = error code
 21616                                  ;		error_no_more_files
 21617                                  ;			No match for this file
 21618                                  ;		error_path_not_found
 21619                                  ;			Bad path (not in curr dir part if present)
 21620                                  ;		error_bad_curr_dir
 21621                                  ;			Bad path in current directory part of path
 21622                                  ; DS preserved, others destroyed
 21623                                  ;---------------------------------------------------------------------------
 21624                                  
 21625                                  ; 03/03/2025 (MiniDOS)
 21626                                  ; 24/01/2024
 21627                                  %if 0
 21628                                  	; 17/05/2019 - Retro DOS v4.0
 21629                                  GET_FAST_SEARCH:
 21630                                  	; 22/07/2018
 21631                                  	; MSDOS 6.0
 21632                                  	; 17/12/2022
 21633                                  	OR	byte [ss:DOS34_FLAG+1],(SEARCH_FASTOPEN>>8)  ; 04h
 21634                                  	;OR	word [ss:DOS34_FLAG],SEARCH_FASTOPEN  ; 400h
 21635                                  					;FO.trigger fastopen ;AN000;
 21636                                  	;call	DOS_SEARCH_FIRST
 21637                                  	;retn
 21638                                  	; 24/01/2024
 21639                                  	; 17/12/2022
 21640                                  	;jmp	DOS_SEARCH_FIRST
 21641                                  %endif
 21642                                  
 21643                                  	; 14/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 21644                                  	; DOSCODE:6C22h (MSDOS 5.0, MSDOS.SYS)
 21645                                  
 21646                                  	; 03/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 21647                                  	; DOSCODE:74E9h (PCDOS 7.1, IBMDOS.COM)
 21648                                  
 21649                                  DOS_SEARCH_FIRST:
 21650                                  	; IBMDOS.COM (MSDOS 3.3 kernel) - Offset 3826h
 21651                                  
 21652 0000343D C43E[A205]              	LES	DI,[THISCDS]
 21653 00003441 83FFFF                  	CMP	DI,-1
 21654 00003444 7506                    	JNZ	short TEST_RE_NET2
 21655                                  
 21656                                  ;IF NOT Installed
 21657                                  ;	transfer NET_SEQ_SEARCH_FIRST
 21658                                  ;ELSE
 21659                                  	;mov	ax,1119h
 21660 00003446 B81911                  	MOV	AX,(MultNET<<8)|25
 21661 00003449 CD2F                    	INT	2Fh
 21662 0000344B C3                      	retn
 21663                                  ;ENDIF
 21664                                  
 21665                                  TEST_RE_NET2:
 21666                                  	;test	word [es:di+43h],8000h
 21667                                  	; 17/12/2022
 21668                                  	;test	byte [es:di+44h],80h
 21669                                  	; 28/12/2022
 21670 0000344C 26F6454480              	test	byte [ES:DI+curdir.flags+1],curdir_isnet>>8
 21671                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
 21672 00003451 7406                    	JZ	short LOCAL_SEARCH_FIRST
 21673                                  
 21674                                  ;IF NOT Installed
 21675                                  ;	transfer NET_SEARCH_FIRST
 21676                                  ;ELSE
 21677                                  	;mov	ax,111Bh
 21678 00003453 B81B11                  	MOV	AX,(MultNET<<8)|27
 21679 00003456 CD2F                    	INT	2FH
 21680 00003458 C3                      	retn
 21681                                  ;ENDIF
 21682                                  	; 18/05/2019 - Retro DOS v4.0
 21683                                  LOCAL_SEARCH_FIRST:
 21684 00003459 E828E4                  	call	ECritDisk
 21685                                  
 21686                                  	; 03/03/2025 (miniDOS)
 21687                                  	;; MSDOS 6.0
 21688                                  	;;;test	word [DOS34_FLAG],400h
 21689                                  	;; 17/12/2022
 21690                                  	;;test	byte [DOS34_FLAG+1],04h
 21691                                  	;test	byte [DOS34_FLAG+1],(SEARCH_FASTOPEN>>8)
 21692                                  	;;TEST	word [DOS34_FLAG],SEARCH_FASTOPEN ;AN000;
 21693                                  	;JZ	short NOFN			;AN000;
 21694                                  	;;or	byte [FastOpenFlg],1
 21695                                  	;OR	byte [FastOpenFlg],FastOpen_Set	;AN000;
 21696                                  
 21697                                  NOFN:						;AN000;
 21698 0000345C C606[4C03]01            	MOV	byte [NoSetDir],1	; if we find a dir, don't change to it
 21699                                  
 21700                                  ; 03/02/2024
 21701                                  %if 0
 21702                                  	; MSDOS 6.0
 21703                                  	CALL	CHECK_QUESTION		;AN000;;FO. is '?' in path
 21704                                  	JNC	short norm_GETPATH	;AN000;;FO. no
 21705                                  %else
 21706                                  	; 03/02/2024
 21707 00003461 16                      	push	ss
 21708 00003462 1F                      	pop	ds			;AN000;;FO. ds:si -> final path
 21709 00003463 8B36[B205]              	mov	si,[WFP_START]		;AN000;;FO.
 21710                                  getnext:				;AN000;
 21711 00003467 AC                      	lodsb				;AN000;;FO. get char
 21712 00003468 08C0                    	or	al,al			;AN000;;FO. is it null
 21713 0000346A 7404                    	jz	short NO_Question	;AN000;;FO. yes
 21714 0000346C 3C3F                    	cmp	al,'?'                  ;AN000;;FO. is '?'
 21715 0000346E 75F7                    	jne	short getnext 		;AN000;;FO. no
 21716                                  %endif
 21717                                  
 21718                                  	; 03/03/2025 (miniDOS)	
 21719                                  	;;and	byte [FastOpenFlg],80h
 21720                                  	;AND	byte [FastOpenFlg],Fast_yes ;AN000;;FO. reset fastopen
 21721                                  
 21722                                  NO_Question:	; 03/02/2024
 21723                                  norm_GETPATH:
 21724 00003470 E85115                  	call	GETPATH
 21725                                  	; BX = offset NAME1
 21726                                  ;_getdone:
 21727 00003473 7312                    	JNC	short find_check_dev
 21728 00003475 750B                    	JNZ	short bad_path3
 21729 00003477 08C9                    	OR	CL,CL
 21730 00003479 7407                    	JZ	short bad_path3
 21731                                  find_no_more:
 21732                                  	;mov	ax,12h
 21733 0000347B B81200                  	MOV	AX,error_no_more_files
 21734                                  BadBye:
 21735                                  	; 03/03/2025 (MiniDOS)
 21736                                  	; MSDOS 6.0
 21737                                  	;AND	byte [SS:FastOpenFlg],Fast_yes  ;AN000;;FO. reset fastopen
 21738                                  
 21739 0000347E F9                      	STC
 21740                                  	;call	LCritDisk
 21741                                  	;retn
 21742                                  	; 18/12/2022
 21743 0000347F E92FE4                  	jmp	LCritDisk
 21744                                  
 21745                                  bad_path3:
 21746                                  	;mov	ax,3
 21747 00003482 B80300                  	MOV	AX,error_path_not_found
 21748 00003485 EBF7                    	JMP	short BadBye
 21749                                  
 21750                                  find_check_dev:
 21751 00003487 08E4                    	OR	AH,AH
 21752 00003489 790A                    	JNS	short found_entry
 21753 0000348B C706[4803]FFFF          	MOV	word [LASTENT],-1	; Cause DOS_SEARCH_NEXT to fail
 21754 00003491 FE06[7005]              	INC	byte [FOUND_DEV]	; Tell DOS_RENAME we found a device
 21755                                  found_entry:
 21756                                  
 21757                                  ; We set the physical drive byte here Instead of after found_it; Doing
 21758                                  ; a search-next may not have wfp_start set correctly
 21759                                  
 21760 00003495 C43E[2C03]              	LES	DI,[DMAADD]
 21761 00003499 8B36[B205]              	MOV	SI,[WFP_START]		; get pointer to beginning
 21762 0000349D AC                      	LODSB
 21763 0000349E 2C40                    	SUB	AL,'A'-1                ; logical drive
 21764 000034A0 AA                      	STOSB				; High bit not set (local)
 21765                                  found_it:
 21766 000034A1 C43E[2C03]              	LES	DI,[DMAADD]
 21767 000034A5 47                      	INC	DI
 21768                                  
 21769                                  	; MSDOS 6.0
 21770 000034A6 1E                      	PUSH	DS				  ;FO.;AN001; save ds
 21771                                  	
 21772                                  	; 03/03/2025 (MiniDOS)
 21773                                  	;;test	byte [FastOpenFlg],10h
 21774                                  	;TEST	byte [FastOpenFlg],Set_For_Search ;FO.;AN001; from fastopen
 21775                                  	;JZ	short notfast			  ;FO.;AN001;
 21776                                  	;MOV	SI,BX				  ;FO.;AN001;
 21777                                  	;MOV	DS,[CURBUF+2]			  ;FO.;AN001;
 21778                                  	;JMP	SHORT movmov			  ;FO.;AN001;
 21779                                  
 21780                                  notfast:
 21781 000034A7 BE[4B05]                	MOV	SI,NAME1		; find_buf 2 = formatted name
 21782                                  movmov:
 21783                                  ; Special E5 code
 21784 000034AA A4                      	MOVSB
 21785 000034AB 26807DFF05              	CMP	BYTE [ES:DI-1],5
 21786 000034B0 7505                    	JNZ	short NOTKANJB
 21787 000034B2 26C645FFE5              	MOV	BYTE [ES:DI-1],0E5H
 21788                                  NOTKANJB:
 21789                                  	;MOV	CX,10
 21790                                  	;REP	MOVSB
 21791                                  	; 03/02/2024
 21792 000034B7 B90500                  	mov	cx,5
 21793 000034BA F3A5                    	rep	movsw
 21794                                  
 21795                                  	; 08/09/2018
 21796 000034BC 1F                      	POP	DS			;FO.;AN001; restore ds
 21797                                  
 21798 000034BD A0[6B05]                	MOV	AL,[ATTRIB]
 21799 000034C0 AA                      	STOSB
 21800 000034C1 50                      	PUSH	AX			; Save AH device info
 21801 000034C2 A1[4803]                	MOV	AX,[LASTENT]
 21802 000034C5 AB                      	STOSW
 21803 000034C6 A1[C205]                	MOV	AX,[DIRSTART]
 21804 000034C9 AB                      	STOSW
 21805                                  
 21806                                  	; 03/02/2024 - Retro DOS v5.0
 21807                                  	; PCDOS 7.1 IBMDOS.COM
 21808                                  	;;;
 21809 000034CA A1[DC0A]                	MOV	AX,[DIRSTART_HW]
 21810 000034CD AB                      	STOSW
 21811 000034CE 83C702                  	add	di,2
 21812                                  ; 4 bytes of 21 byte cont structure left for NET stuff
 21813                                  	;ADD	DI,4
 21814                                  	;;;
 21815                                  	
 21816 000034D1 58                      	POP	AX			; Recover AH device info
 21817 000034D2 08E4                    	OR	AH,AH
 21818 000034D4 7813                    	JS	short DOSREL		; Device entry is DOSGROUP relative
 21819 000034D6 833E[E205]FF            	CMP	WORD [CURBUF],-1
 21820 000034DB 7508                    	JNZ	short OKSTORE
 21821                                  
 21822                                  	; 03/03/2025 (MiniDOS)
 21823                                  	;; MSDOS 6.0
 21824                                  	;TEST	byte [FastOpenFlg],Set_For_Search
 21825                                  	;				;AN000;;FO. from fastopen and is good
 21826                                  	;JNZ	short OKSTORE		;AN000;;FO.
 21827                                  
 21828                                  	; The user has specified the root directory itself, rather than some
 21829                                  	; contents of it. We can't "find" that.
 21830                                  
 21831 000034DD 26C745F8FFFF            	MOV	WORD [ES:DI-8],-1	; Cause DOS_SEARCH_NEXT to fail by
 21832                                  					;   stuffing a -1 at Lastent
 21833 000034E3 EB96                    	JMP	find_no_more
 21834                                  
 21835                                  OKSTORE:
 21836 000034E5 8E1E[E405]              	MOV	DS,[CURBUF+2]
 21837                                  DOSREL:
 21838                                  	; BX = offset NAME1 (from GETPATH)
 21839 000034E9 89DE                    	MOV	SI,BX			; SI-> start of entry
 21840                                  
 21841                                  ; NOTE: DOS_RENAME depends on BX not being altered after this point
 21842                                  
 21843                                  	;;mov	cx,32
 21844                                  	;MOV	CX,dir_entry.size
 21845                                  	; 03/02/2024
 21846 000034EB B91000                  	mov	cx,dir_entry.size>>1
 21847                                  ;;;;; 7/29/86
 21848 000034EE 89F8                    	MOV	AX,DI			; save the 1st byte addr
 21849                                  	;REP	MOVSB
 21850 000034F0 F3A5                    	rep	movsw
 21851                                  	;
 21852 000034F2 89C7                    	MOV	DI,AX			; restore 1st byte addr
 21853 000034F4 26803D05                	CMP	BYTE [ES:DI],05H	; special char check
 21854 000034F8 7504                    	JNZ	short NO05
 21855 000034FA 26C605E5                	MOV	BYTE [ES:DI],0E5H	; convert it back to E5
 21856                                  NO05:
 21857                                  
 21858                                  ;;;;; 7/29/86
 21859                                  
 21860                                  ;hkn; FastOpenflg is in DOSDATA use SS
 21861                                  	; 16/12/2022
 21862                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 21863                                  	; MSDOS 6.0
 21864                                  	;AND	byte [SS:FastOpenFlg],Fast_yes ;AN000;;FO. reset fastopen
 21865                                  	; 18/05/2019 - Retro DOS v4.0
 21866 000034FE 16                      	push	ss
 21867 000034FF 1F                      	pop	ds
 21868                                  
 21869                                  	; 03/03/2025 (MiniDOS)
 21870                                  	; 16/12/2022
 21871                                  	;AND	byte [FastOpenFlg],Fast_yes ; 80h
 21872                                  
 21873                                  ;hkn; SS is DOSDATA
 21874                                  	;push	ss
 21875                                  	;pop	ds
 21876                                  	
 21877                                  	; 27/06/2024
 21878                                  	; cf=0
 21879                                  	;CLC
 21880                                  	
 21881                                  	;call	LCritDisk
 21882                                  	;retn
 21883                                  	; 16/12/2022
 21884 00003500 E9AEE3                  	jmp	LCritDisk
 21885                                  
 21886                                  ;BREAK <DOS_SEARCH_NEXT - scan for subsequent matches>
 21887                                  ;----------------------------------------------------------------------------
 21888                                  ;
 21889                                  ; Procedure Name : DOS_SEARCH_NEXT
 21890                                  ;
 21891                                  ; Inputs:
 21892                                  ;	[DMAADD] Points to 53 byte buffer returned by DOS_SEARCH_FIRST
 21893                                  ;	    (only first 21 bytes must have valid information)
 21894                                  ; Function:
 21895                                  ;	Look for subsequent matches
 21896                                  ; Outputs:
 21897                                  ;	CARRY CLEAR
 21898                                  ;	    The 53 bytes at DMAADD are updated for next call
 21899                                  ;		(see DOS_SEARCH_FIRST)
 21900                                  ;	CARRY SET
 21901                                  ;	    AX = error code
 21902                                  ;		error_no_more_files
 21903                                  ;			No more files to find
 21904                                  ; DS preserved, others destroyed
 21905                                  ;---------------------------------------------------------------------------
 21906                                  
 21907                                  ;hkn; called from search.asm. DS already set up at this point.
 21908                                  
 21909                                  	; 03/02/2024 - Retro DOS v5.0
 21910                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:75ECh
 21911                                  
 21912                                  DOS_SEARCH_NEXT:
 21913 00003503 C43E[2C03]              	LES	DI,[DMAADD]	; 24/01/2024 (Retro DOS v5-v4)
 21914 00003507 268A05                  	MOV	AL,[ES:DI]
 21915 0000350A A880                    	TEST	AL,80H			; Test for NET
 21916 0000350C 7406                    	JZ	short LOCAL_SEARCH_NEXT
 21917                                  ;IF NOT Installed
 21918                                  ;	transfer NET_SEARCH_NEXT
 21919                                  ;ELSE
 21920                                  	;mov	ax,111Ch
 21921 0000350E B81C11                  	MOV	AX,(MultNET<<8)|28
 21922 00003511 CD2F                    	INT	2FH  ; Multiplex - NETWORK REDIRECTOR - FINDNEXT
 21923                                  		     ; SS = DS = DOS CS, [DTA] = 21-byte findfirst search data
 21924                                  		     ; Return: CF set on error, AX = DOS error code
 21925                                  		     ; CF clear if successful
 21926 00003513 C3                      	retn
 21927                                  ;ENDIF
 21928                                  
 21929                                  LOCAL_SEARCH_NEXT:
 21930                                  	;AL is drive A=1
 21931                                  	;mov	byte [EXTERR_LOCUS],2
 21932 00003514 C606[2303]02            	MOV	byte [EXTERR_LOCUS],errLOC_Disk
 21933 00003519 E868E3                  	call	ECritDisk
 21934                                  
 21935                                  ;hkn; DummyCDS is in DOSDATA
 21936 0000351C C706[A205][F304]        	MOV     word [THISCDS],DUMMYCDS
 21937                                  ;hkn; Segment address is DOSDATA - use ds
 21938                                  ;hkn;	MOV     WORD [THISCDS+2],CS
 21939 00003522 8C1E[A405]              	mov	[THISCDS+2],DS
 21940                                  
 21941 00003526 0440                    	ADD	AL,'A'-1
 21942 00003528 E82F42                  	call	InitCDS
 21943                                  
 21944                                  ;	call	GETTHISDRV		; Set CDS pointer
 21945                                  
 21946 0000352B 7253                    	JC	short No_files		; Bogus drive letter
 21947 0000352D C43E[A205]              	LES	DI,[THISCDS]		; Get CDS pointer
 21948                                  	;les	bp,[es:di+45h]
 21949 00003531 26C46D45                	LES	BP,[ES:DI+curdir.devptr] ; Get DPB pointer
 21950 00003535 E82AD1                  	call	GOTDPB			; [THISDPB] = ES:BP
 21951                                  
 21952                                  	; 16/12/2022
 21953 00003538 268A4600                	mov	al,[ES:BP]
 21954                                  	; 14/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 21955                                  	;mov	AL,[ES:BP+DPB.DRIVE] ; mov al,[ES:BP+0]
 21956 0000353C A2[7605]                	mov	[THISDRV],AL
 21957                                  	;mov	word [CREATING],0E500h
 21958 0000353F C706[7E05]00E5          	MOV	WORD [CREATING],(DIRFREE*256)+0
 21959 00003545 C606[4C03]01            	MOV	byte [NoSetDir],1	; if we find a dir, don't change to it
 21960 0000354A C536[2C03]              	LDS	SI,[DMAADD]
 21961 0000354E AC                      	LODSB				; Drive Byte
 21962                                  
 21963                                  	;entry	RENAME_NEXT		; Entry used by DOS_RENAME
 21964                                  RENAME_NEXT:
 21965                                  	;context ES
 21966 0000354F 16                      	push	ss
 21967 00003550 07                      	pop	es			; THIS BLOWS ES:BP POINTER TO DPB
 21968                                  
 21969                                  ;hkn; NAME1 is in DOSDATA
 21970 00003551 BF[4B05]                	MOV	DI,NAME1
 21971                                  
 21972 00003554 B90B00                  	MOV	CX,11
 21973 00003557 F3A4                    	REP	MOVSB			; Search name
 21974 00003559 AC                      	LODSB				; Attribute
 21975                                  
 21976                                  ;hkn; SS override
 21977 0000355A 36A2[6B05]              	MOV	[SS:ATTRIB],AL
 21978 0000355E AD                      	LODSW				; LastEnt
 21979 0000355F 09C0                    	OR	AX,AX
 21980                                  	; 03/02/2024
 21981                                  	;JNS	short cont_load
 21982 00003561 781D                    	js	short No_files
 21983                                  ;No_files:
 21984                                  	;JMP	find_no_more
 21985                                  
 21986                                  cont_load:
 21987 00003563 50                      	PUSH	AX			; Save LastEnt
 21988 00003564 AD                      	LODSW				; DirStart
 21989 00003565 89C3                    	MOV	BX,AX
 21990                                  
 21991                                  	;;;
 21992                                  	; 03/02/2024 - Retro DOS v5.0
 21993                                  	; (PCDOS 7.1 IBMDOS.COM)
 21994 00003567 AD                      	lodsw				; DIRSTART_HW
 21995                                  	;;;
 21996                                  
 21997                                  ;hkn; SS is DOSDATA
 21998                                  	;context DS
 21999 00003568 16                      	push	ss
 22000 00003569 1F                      	pop	ds
 22001 0000356A C42E[8A05]              	LES	BP,[THISDPB]		; Recover ES:BP
 22002                                  
 22003                                  	;;;
 22004                                  	; 03/02/2024 - Retro DOS v5.0
 22005                                  	; (PCDOS 7.1 IBMDOS.COM)
 22006                                  	
 22007                                  	;cmp	word [es:bp+0Fh],0
 22008 0000356E 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 22009 00003573 7402                    	jz	short cont_load2 ; FAT32 fs
 22010 00003575 31C0                    	xor	ax,ax ; 0
 22011                                  cont_load2:
 22012 00003577 A3[EE0A]                	mov	[ROOTCLUST_HW],ax	; 0 or DIRSTART_HW
 22013                                  	;;;
 22014                                  
 22015                                  	;invoke	SetDirSrch
 22016 0000357A E89A12                  	call	SETDIRSRCH
 22017 0000357D 7304                    	JNC	short SEARCH_GOON
 22018 0000357F 58                      	POP	AX			; Clean stack
 22019                                  	;JMP	short No_files
 22020                                  	; 03/02/2024
 22021                                  No_files:
 22022 00003580 E9F8FE                  	JMP	find_no_more
 22023                                  
 22024                                  SEARCH_GOON:
 22025 00003583 E85416                  	call	STARTSRCH
 22026 00003586 58                      	POP	AX			; Restore LastEnt
 22027 00003587 E8D011                  	call	GETENT
 22028 0000358A 72F4                    	JC	short No_files
 22029 0000358C E8C410                  	call	NEXTENT
 22030 0000358F 72EF                    	JC	short No_files
 22031 00003591 30E4                    	XOR	AH,AH			; If Search_Next, can't be a DEV
 22032 00003593 E90BFF                  	JMP	found_it ; 10/08/2018
 22033                                  
 22034                                  ; MSDOS 6.0
 22035                                  ;---------------------------------------------------------------------------
 22036                                  ;
 22037                                  ; Procedure Name : CHECK_QUESTION
 22038                                  ;
 22039                                  ; Input: [WFP_START]= pointer to final path
 22040                                  ; Function: check '?' char
 22041                                  ; Output: carry clear, if no '?'
 22042                                  ;	 carry set, if '?' exists
 22043                                  ;---------------------------------------------------------------------------
 22044                                  
 22045                                  ; 03/02/2024
 22046                                  %if 0
 22047                                  	; 07/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 22048                                  CHECK_QUESTION:
 22049                                  ;hkn;	wfp_start is in DOSDATA;hkn;	MOV	WORD PTR ThisCDS+2,CS
 22050                                  ;hkn;	PUSH	CS			;AN000;;FO.
 22051                                  	push	ss
 22052                                  	POP	DS			;AN000;;FO. ds:si -> final path
 22053                                  	; 16/12/2022
 22054                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 22055                                  	MOV	SI,[WFP_START]		;AN000;;FO.
 22056                                  	;mov	si,[ss:WFP_START]
 22057                                  getnext:				;AN000;
 22058                                  	LODSB				;AN000;;FO. get char
 22059                                  	OR	AL,AL			;AN000;;FO. is it null
 22060                                  	JZ	short NO_Question	;AN000;;FO. yes
 22061                                  	CMP	AL,'?'                  ;AN000;;FO. is '?'
 22062                                  	JNZ	short getnext 		;AN000;;FO. no
 22063                                  	STC				;AN000;;FO.
 22064                                  NO_Question:				;AN000;
 22065                                  	retn				;AN000;;FO.
 22066                                  %endif
 22067                                  
 22068                                  ;============================================================================
 22069                                  ; ABORT.ASM, MSDOS 6.0, 1991
 22070                                  ;============================================================================
 22071                                  ; 23/07/2018 - Retro DOS v3.0
 22072                                  ; 18/05/2019 - Retro DOS v4.0
 22073                                  
 22074                                  ;**
 22075                                  ;
 22076                                  ; Internal Abort call closes all handles and FCBs associated with a process.
 22077                                  ;  If process has NET resources a close all is sent out over the net.
 22078                                  ;
 22079                                  ;   DOS_ABORT
 22080                                  ;
 22081                                  ;   Modification history:
 22082                                  ;
 22083                                  ;       Created: ARR 30 March 1983
 22084                                  ;
 22085                                  ;	M038	SR	10/16/90	Free SFT with the PSP of the process
 22086                                  ;				being terminated only if it is busy.
 22087                                  ;
 22088                                  
 22089                                  ;Break   <DOS_ABORT -- CLOSE all files for process>
 22090                                  ;--------------------------------------------------------------------------
 22091                                  ;
 22092                                  ; Procedure Name : DOS_ABORT
 22093                                  ;
 22094                                  ; Inputs:
 22095                                  ;       [CurrentPDB] set to PID of process aborting
 22096                                  ; Function:
 22097                                  ;       Close all files and free all SFTs for this PID
 22098                                  ; Returns:
 22099                                  ;       None
 22100                                  ; All destroyed except stack
 22101                                  ;---------------------------------------------------------------------------
 22102                                  
 22103                                  	; 03/02/2024 - Retro DOS v5.0
 22104                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:7685h
 22105                                  	; (Win ME IO.SYS - BIOSCODE:74F4h) 
 22106                                  
 22107                                  DOS_ABORT:
 22108 00003596 368E06[3003]            	MOV     ES,[SS:CurrentPDB]	; SS override
 22109 0000359B 268B0E3200              	MOV     CX,[ES:PDB.JFN_Length]  ; Number of JFNs
 22110                                  reset_free_jfn:
 22111 000035A0 89CB                    	MOV     BX,CX
 22112 000035A2 51                      	PUSH    CX
 22113 000035A3 4B                      	DEC     BX                      ; get jfn (start with last one)
 22114                                  
 22115 000035A4 E84B3E                  	CALL	_$CLOSE
 22116 000035A7 59                      	POP     CX
 22117 000035A8 E2F6                    	LOOP    reset_free_jfn          ; and do 'em all
 22118                                  
 22119                                  ; Note: We do need to explicitly close FCBs. Reasons are as follows: If we
 22120                                  ; are running in the no-sharing no-network environment, we are simulating the
 22121                                  ; 2.0 world and thus if the user doesn't close the file, that is his problem
 22122                                  ; BUT... the cache remains in a state with garbage that may be reused by the
 22123                                  ; next process. We scan the set and blast the ref counts of the FCBs we own.
 22124                                  ;
 22125                                  ; If sharing is loaded, then the following call to close process will
 22126                                  ; correctly close all FCBs. We will then need to walk the list AFTER here.
 22127                                  ;
 22128                                  ; Finally, the following call to NET_Abort will cause an EOP to be sent to all
 22129                                  ; known network resources. These resources are then responsible for cleaning
 22130                                  ; up after this process.
 22131                                  ;
 22132                                  ; Sleazy, eh?
 22133                                  
 22134                                  	;context DS			; SS is DOSDATA
 22135 000035AA 16                      	push	ss
 22136 000035AB 1F                      	pop	ds  ; 09/09/2018
 22137                                  
 22138                                  	;CallInstall Net_Abort, MultNET, 29
 22139 000035AC B81D11                  	mov	ax,111Dh
 22140 000035AF CD2F                    	int     2Fh 	; Multiplex - NETWORK REDIRECTOR 
 22141                                  			;	    - CLOSE ALL REMOTE FILES FOR PROCESS
 22142                                  			; DS???, SS = DOS CS
 22143                                  ;if installed
 22144 000035B1 FF1E[A000]              	call	far [JShare+(4*4)]	; 4 = MFTCloseP
 22145                                  ;else
 22146                                  ;	call 	MFTCloseP
 22147                                  ;endif
 22148                                  
 22149                                  ; Scan the FCB cache for guys that belong to this process and zap their ref
 22150                                  ; counts.
 22151                                  					; SS override
 22152 000035B5 36C43E[4000]            	les     di,[ss:SFTFCB]		; grab the pointer to the table
 22153                                  
 22154                                  	;;;
 22155                                  	; 03/02/2024 - Retro DOS v5.0
 22156                                  	; PCDOS 7.1 IBMDOS.COM
 22157                                  SFTFCB_check:
 22158 000035BA 8CC1                    	mov	cx,es
 22159 000035BC 09F9                    	or	cx,di
 22160 000035BE E325                    	jcxz	FCBScanDone
 22161 000035C0 57                      	push	di
 22162                                  SFTFCB_OK:
 22163                                  	;;;
 22164                                  	;mov	cx,[es:di+4]
 22165 000035C1 268B4D04                	mov     cx,[es:di+SFT.SFCount]
 22166                                  	;jcxz	FCBScanDone
 22167                                  	; 27/06/2024
 22168                                  	;;;
 22169 000035C5 E315                    	jcxz    SFTFCB_check2	
 22170                                  	;;;
 22171                                  	;lea	di,[di+6]
 22172 000035C7 8D7D06                  	LEA     DI,[DI+SFT.SFTable]	; point at table
 22173 000035CA 36A1[3C03]              	mov     ax,[SS:PROC_ID]		; SS override
 22174                                  FCBTest:
 22175                                  	;cmp	[es:di+31h],ax
 22176 000035CE 26394531                	cmp	[es:di+SF_ENTRY.sf_PID],ax ; is this one of ours
 22177 000035D2 7503                    	jnz	short FCBNext		; no, skip it
 22178                                  
 22179                                  ; 03/02/2024 - Retro DOS v5.0
 22180                                  %if 0
 22181                                  	mov	word [es:di],0
 22182                                  	;mov	word [es:di+SF_ENTRY.sf_ref_count],0 ; yes, blast ref count
 22183                                  %else
 22184                                  	; 03/02/2024
 22185                                  	; PCDOS 7.1 IBMDOS.COM
 22186 000035D4 E8C513                  	call    SFT_FREE
 22187                                  %endif
 22188                                  
 22189                                  FCBNext:
 22190 000035D7 83C73B                  	add     di,SF_ENTRY.size ; 59 (for MSDOS 6.0)
 22191 000035DA E2F2                    	loop    FCBTest
 22192                                  
 22193                                  	; 27/06/2024 (PCDOS 7.1 IBMDOS.COM)
 22194                                  	;;;
 22195                                  SFTFCB_check2:
 22196 000035DC 5F                      	pop	di
 22197 000035DD 26C43D                  	les	di,[es:di]
 22198 000035E0 83FFFF                  	cmp	di,0FFFFh
 22199 000035E3 75D5                    	jne	short SFTFCB_check
 22200                                  	;;;
 22201                                  
 22202                                  FCBScanDone:
 22203                                  
 22204                                  ; Walk the SFT to eliminate all busy SFT's for this process.
 22205                                  
 22206 000035E5 31DB                    	XOR     BX,BX
 22207                                  Scan:
 22208 000035E7 53                      	push    bx
 22209 000035E8 E8833D                  	call	SFFromSFN
 22210 000035EB 5B                      	pop     bx
 22211                                  	;jnc	short Scan1
 22212                                  	;retn
 22213                                  
 22214                                  	; 18/12/2022
 22215                                  	;jc	short NO_Question ; retn
 22216                                  	; 03/02/2024
 22217 000035EC 7232                    	jc	short RET2
 22218                                  
 22219                                  ;M038
 22220                                  ; Do what the comment above says, check for busy state
 22221                                  
 22222                                  Scan1:
 22223                                  	;cmp	word [es:di],0
 22224                                  	;jz	short scan_next  ; MSDOS 3.3
 22225                                  	; MSDOS 6.0
 22226 000035EE 26833DFF                	cmp	word [es:di],sf_busy ; -1
 22227                                  	;cmp	word [es:di+SF_ENTRY.sf_ref_count],sf_busy
 22228                                  				; Is Sft busy? ;M038
 22229 000035F2 7517                    	jnz	short scan_next ; no
 22230                                  ;
 22231                                  ; we have a SFT that is busy. See if it is for the current process
 22232                                  ;
 22233 000035F4 36A1[3C03]              	mov     ax,[SS:PROC_ID]		; SS override
 22234                                  	;cmp	[es:di+31h],ax
 22235 000035F8 26394531                	cmp	[es:di+SF_ENTRY.sf_PID],ax
 22236 000035FC 750D                    	jnz	short scan_next
 22237 000035FE 36A1[3E03]              	mov     ax,[SS:USER_ID]		; SS override
 22238                                  	;sub	ax,[es:di+2Fh] ; PCDOS 7.1 IBMDOS.COM ; 03/02/2024
 22239                                  	;cmp	[es:di+2Fh],ax
 22240 00003602 2639452F                	cmp	[es:di+SF_ENTRY.sf_UID],ax
 22241 00003606 7503                    	jnz	short scan_next
 22242                                  
 22243                                  ; This SFT is labelled as ours.
 22244                                  
 22245                                  ; 03/02/2024 - Retro DOS v5.0
 22246                                  %if 0
 22247                                  	mov	word [es:di],0
 22248                                  	;mov	word [es:di+SF_ENTRY.sf_ref_count],0
 22249                                  %else
 22250                                  	; 03/02/2024
 22251                                  	; PCDOS 7.1 IBMDOS.COM
 22252 00003608 E89113                  	call    SFT_FREE
 22253                                  %endif
 22254                                  
 22255                                  scan_next:
 22256 0000360B 43                      	inc     bx
 22257 0000360C EBD9                    	jmp     short Scan
 22258                                  
 22259                                  ;============================================================================
 22260                                  ; CLOSE.ASM, MSDOS 6.0, 1991
 22261                                  ;============================================================================
 22262                                  ; 23/07/2018 - Retro DOS v3.0
 22263                                  ; 18/05/2019 - Retro DOS v4.0
 22264                                  
 22265                                  ;**	Internal Close and Commit calls to close a local or NET SFT.
 22266                                  ;
 22267                                  ;	DOS_CLOSE
 22268                                  ;	DOS_COMMIT
 22269                                  ;	FREE_SFT
 22270                                  ;	SetSFTTimes
 22271                                  ;
 22272                                  ;	Revision history:
 22273                                  ;
 22274                                  ;	   AN000  version 4.00	Jan. 1988
 22275                                  ;	   A005   PTM 3718 --- lost clusters when fastopen installed
 22276                                  ;	   A011   PTM 4766 --- C2 fastopen problem
 22277                                  
 22278                                  ;Installed = TRUE
 22279                                  
 22280                                  ;Break <DOS_CLOSE -- CLOSE FILE from SFT>
 22281                                  ;---------------------------------------------------------------------------
 22282                                  ;
 22283                                  ; Procedure Name : DOS_CLOSE
 22284                                  ;
 22285                                  ; Inputs:
 22286                                  ;	[THISSFT] set to the SFT for the file being used
 22287                                  ; Function:
 22288                                  ;	Close the indicated file via the SFT
 22289                                  ; Returns:
 22290                                  ;	sf_ref_count decremented otherwise
 22291                                  ;	ES:DI point to SFT
 22292                                  ;	Carry set if error
 22293                                  ;	    AX has error code
 22294                                  ; DS preserved, others destroyed
 22295                                  ;---------------------------------------------------------------------------
 22296                                  
 22297                                  ;hkn; DOS_CLOSE called from fcbio.asm and handle.asm. DS alreday set up.
 22298                                  
 22299                                  ; 18/05/2019 - Retro DOS v4.0
 22300                                  ; DOSCODE:6E2Eh (MSDOS 6.21, MSDOS.SYS)
 22301                                  
 22302                                  ; 14/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 22303                                  ; DOSCODE:6E1Ah (MSDOS 5.0, MSDOS.SYS)
 22304                                  
 22305                                  ; 23/07/2018 - IBMDOS.COM (MSDOS 3.3), 1987 - Offset 39D0h
 22306                                  
 22307                                  	; 03/02/2024 - Retro DOS v5.0
 22308                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:76FEh
 22309                                  	; (Win ME IO.SYS - BIOSCODE:7579h) 
 22310                                  
 22311                                  DOS_CLOSE:
 22312 0000360E C43E[9E05]              	LES	DI,[THISSFT]
 22313                                  	;mov	bx,[ES:DI+5]
 22314 00003612 268B5D05                	MOV	BX,[ES:DI+SF_ENTRY.sf_flags]
 22315                                  
 22316                                  ; Network closes are handled entirely by the net code.
 22317                                  
 22318                                  	;;test	bx,8000h
 22319                                  	;TEST	BX,sf_isnet
 22320                                  	; 17/12/2022
 22321                                  	;test	bh,80h
 22322 00003616 F6C780                  	test	bh,(sf_isnet>>8)
 22323 00003619 7406                    	JZ	short LocalClose
 22324                                  
 22325                                  	;CallInstall Net_Close,MultNET,6
 22326 0000361B B80611                  	mov     ax,1106h
 22327 0000361E CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - CLOSE REMOTE FILE
 22328                                  			; ES:DI -> SFT
 22329                                  			; SFT DPB field -> DPB of drive containing file
 22330                                  			; Return: CF set on error, AX = DOS error code
 22331                                  			; CF clear if successful
 22332                                  RET2:		; 03/02/2024
 22333 00003620 C3                      	retn
 22334                                  
 22335                                  ; All closes release the sharing information.
 22336                                  ; No commit releases sharing information
 22337                                  ;
 22338                                  ; All closes decrement the ref count.
 22339                                  ; No commit decrements the ref count.
 22340                                  
 22341                                  LocalClose:
 22342 00003621 E860E2                  	call	ECritDisk
 22343 00003624 E8BE01                  	CALL	SetSFTTimes
 22344 00003627 E84101                  	CALL	FREE_SFT		; dec ref count or mark as busy
 22345                                  
 22346                                  ;hkn; SS is DOSDATA
 22347                                  	;Context DS
 22348 0000362A 16                      	push	ss
 22349 0000362B 1F                      	pop	ds
 22350                                  
 22351 0000362C 50                      	push	ax
 22352 0000362D 53                      	push	bx
 22353 0000362E E8D84A                  	call	ShareEnd
 22354 00003631 5B                      	pop	bx
 22355 00003632 58                      	pop	ax
 22356                                  
 22357                                  ; Commit enters here. AX from commit MUST be <> 1, BX is flags word
 22358                                  
 22359                                  CloseEntry:
 22360 00003633 50                      	PUSH	AX
 22361                                  
 22362                                  ; File clean or device does not get stamped nor disk looked at.
 22363                                  
 22364                                  	;test	bx,0C0h
 22365                                  	; 17/12/2022
 22366 00003634 F6C3C0                  	test	bl,devid_file_clean+devid_device
 22367                                  	;TEST	BX,devid_file_clean+devid_device
 22368 00003637 7403                    	JZ	short rdir
 22369                                  	; 14/11/2022
 22370 00003639 E9F600                  	JMP	FREE_SFT_OK		; either clean or device
 22371                                  	;jnz	short FREE_SFT_OK ; 24/07/2019	
 22372                                  
 22373                                  ; Retrieve the directory entry for the file
 22374                                  
 22375                                  rdir:
 22376 0000363C E83901                  	CALL	DirFromSFT
 22377                                  	;mov	al,5
 22378 0000363F B005                    	MOV	AL,error_access_denied
 22379                                  	
 22380                                  	; 03/02/2024
 22381                                  	;JNC	short clook
 22382                                  	;; 14/11/2022
 22383                                  	;JMP	CloseFinish		; pretend the close worked.
 22384                                  	;;jc	short CloseFinish ; 24/07/2019
 22385                                  	
 22386                                  	;;;
 22387                                  	; 03/02/2024 - Retro DOS v5.0
 22388                                  	; (PCDOS 7.1 IBMDOS.COM)
 22389 00003641 723D                    	jc	short jmp_to_CloseFinish ; pretend the close worked.
 22390                                  rdir2:
 22391                                  	;test	word [si+2],4
 22392 00003643 F6440204                	test	byte [si+SF_ENTRY.sf_mode],4 ; devid_device_null
 22393                                  					; bit 2 - null device
 22394 00003647 751C                    	jnz	short clook
 22395                                  
 22396 00003649 1E                      	push	ds
 22397 0000364A 53                      	push	bx
 22398                                  	; 27/06/2024
 22399                                  	;lds	bx,[si+7]
 22400 0000364B C55C07                  	lds	bx,[si+SF_ENTRY.sf_devptr] ; pointer to DPB
 22401                                  
 22402 0000364E 8A1F                    	mov	bl,[bx]			; DPB.DRIVE
 22403 00003650 30FF                    	xor	bh,bh  ; 0
 22404 00003652 36F687[1412]04          	test	byte [ss:bx+drive_flags],4
 22405                                  					; bit 2 - last access date/time flag?
 22406                                  					; or disk accessed flag !?
 22407 00003658 5B                       	pop	bx
 22408 00003659 7409                    	jz	short skip_upd_laccdt	; no support for last access date&time
 22409 0000365B 1F                      	pop	ds
 22410 0000365C 1E                      	push	ds
 22411 0000365D E8DDD4                  	call	DATE16
 22412                                  	;mov	[es:di+12h],ax
 22413 00003660 26894512                	mov	[es:di+dir_entry.dir_lstaccdate],ax
 22414                                  skip_upd_laccdt:
 22415 00003664 1F                      	pop	ds
 22416                                  	;;;
 22417                                  
 22418                                  clook:
 22419                                  
 22420                                  ; ES:DI points to entry
 22421                                  ; DS:SI points to SFT
 22422                                  ; ES:BX points to buffer header
 22423                                  
 22424 00003665 57                      	push	di
 22425 00003666 56                      	push	si
 22426                                  	;lea	si,[si+20h]
 22427 00003667 8D7420                  	LEA	SI,[SI+SF_ENTRY.sf_name]
 22428                                  
 22429                                  ; ES:DI point to directory entry
 22430                                  ; DS:SI point to unpacked name
 22431                                  
 22432 0000366A E84DE1                  	call	XCHGP
 22433                                  
 22434                                  ; ES:DI point to unpacked name
 22435                                  ; DS:SI point to directory entry
 22436                                  
 22437 0000366D E86110                  	call	MetaCompare
 22438 00003670 E847E1                  	call	XCHGP
 22439 00003673 5E                      	pop	si
 22440 00003674 5F                      	pop	di
 22441 00003675 740C                    	JZ	short CLOSE_GO		; Name OK
 22442                                  Bye:	
 22443 00003677 89F7                    	MOV	DI,SI
 22444 00003679 1E                      	PUSH	DS
 22445 0000367A 07                      	POP	ES			; ES:DI points to SFT
 22446 0000367B 16                      	PUSH	SS
 22447 0000367C 1F                      	POP	DS
 22448 0000367D F9                      	STC
 22449                                  	;mov	al,2
 22450 0000367E B002                    	MOV	AL,error_file_not_found
 22451                                  	
 22452                                  jmp_to_CloseFinish: ; 03/02/2024
 22453                                  	;JMP	CloseFinish ; 24/07/2019
 22454                                  	; 03/02/2024
 22455                                  	; (PCDOS 7.1 IBMDOS.COM)
 22456 00003680 E9D700                  	jmp	CloseFinish2
 22457                                  
 22458                                  	; 18/05/2019 - Retro DOS v4.0
 22459                                  CLOSE_GO:
 22460                                  	; 03/02/2024
 22461                                  	;mov	al,[si+4]
 22462 00003683 8A4404                  	mov	al,[si+SF_ENTRY.sf_attr]
 22463                                  	
 22464                                  	; MSDOS 6.0
 22465                                  	;test	word [si+2],8000h
 22466                                  	;TEST	word [SI+SF_ENTRY.sf_mode],sf_isFCB ; FCB ?
 22467                                  	; 17/12/2022
 22468                                  	;test	byte [si+3],80h
 22469 00003686 F6440380                	test	byte [SI+SF_ENTRY.sf_mode+1],(sf_isFCB>>8) ; FCB ?
 22470 0000368A 740A                    	JZ	short nofcb		; no, set dir attr, sf_attr
 22471                                  	; MSDOS 3.3 & MSDOS 6.0
 22472                                  	;mov	ch,[es:di+0Bh]
 22473 0000368C 268A6D0B                	MOV	CH,[ES:DI+dir_entry.dir_attr]
 22474                                  
 22475                                  	; 03/02/2024
 22476                                  	;;mov	al,[si+4]
 22477                                  	;MOV	AL,[SI+SF_ENTRY.sf_attr]
 22478                                  
 22479                                  ;hkn; SS override
 22480 00003690 36A2[6B05]              	MOV	[SS:ATTRIB],AL
 22481                                  	; MSDOS 3.3
 22482                                  	;;call	MatchAttributes
 22483                                  	;;JNZ	short Bye		; attributes do not match
 22484                                  	; 18/05/2019
 22485 00003694 EB04                    	JMP	SHORT setattr		;FT.
 22486                                  nofcb:
 22487                                  	; 03/02/2024
 22488                                  	; MSDOS 6.0
 22489                                  	;;mov	al,[si+4]
 22490                                  	;MOV	AL,[SI+SF_ENTRY.sf_attr] ;FT.		;AN000;
 22491                                  
 22492 00003696 2688450B                	MOV	[ES:DI+dir_entry.dir_attr],AL ;FT.	;AN000;
 22493                                  setattr:
 22494                                  	; MSDOS 3.3 (& MSDOS 6.0)
 22495                                  	;or	byte [es:di+0Bh],20h
 22496 0000369A 26804D0B20              	OR	BYTE [ES:DI+dir_entry.dir_attr],attr_archive ;Set archive
 22497                                  	; MSDOS 6.0
 22498                                  	;mov	ax,[es:di+1Ah]
 22499 0000369F 268B451A                	MOV	AX,[ES:DI+dir_entry.dir_first] ;AN011
 22500                                  					;F.O. save old first cluster
 22501                                  ;hkn; SS override
 22502 000036A3 36A3[BD0E]              	MOV	[SS:OLD_FIRSTCLUS],AX	;AN011;F.O. save old first cluster
 22503                                  
 22504                                  	;;;
 22505                                  	; 03/02/2024
 22506                                  	; PCDOS 7.1 IBMDOS.COM
 22507                                  	;mov	ax,[es:di+14h]
 22508 000036A7 268B4514                	mov	ax,[ES:DI+dir_entry.dir_fclus_hi] ; old first cluster, hw
 22509                                  	; 27/06/2024
 22510 000036AB 36A3[0E11]              	MOV	[ss:OLD_FIRSTCLUS_HW],ax
 22511                                  	;;;
 22512                                  
 22513                                  	;;mov	ax,[si+0Bh]
 22514                                  	;MOV	AX,[SI+SF_ENTRY.sf_firclus]
 22515                                  	;;;
 22516                                  	; 03/02/2024
 22517                                  	; PCDOS 7.1 IBMDOS.COM
 22518 000036AF 8B442B                  	mov     ax,[si+2Bh]	; mov ax,[si+SF_ENTRY.sf_chain]
 22519                                  				; first cluster (32 bit) low word !
 22520                                  	;;;	
 22521                                  	;mov	[es:di+1Ah],ax
 22522 000036B2 2689451A                	MOV	[ES:DI+dir_entry.dir_first],AX	;Set firclus pointer
 22523                                  	;;; 03/02/2024
 22524 000036B6 8B442D                  	mov     ax,[si+2Dh]	; mov ax,[si+SF_ENTRY.sf_chain+2]
 22525                                  				; first cluster (32 bit) high word !
 22526                                  	;mov	[es:di+14h],ax
 22527 000036B9 26894514                	mov	[es:di+dir_entry.dir_fclus_hi],ax
 22528                                  	;;;
 22529                                  
 22530                                  ; 03/02/2024
 22531                                  %if 0
 22532                                  	;mov	ax,[si+11h]
 22533                                  	MOV	AX,[SI+SF_ENTRY.sf_size]
 22534                                  	;mov	[es:di+1Ch],ax
 22535                                  	MOV	[ES:DI+dir_entry.dir_size_l],AX	;Set size
 22536                                  	;mov	ax,[si+13h]
 22537                                  	MOV	AX,[SI+SF_ENTRY.sf_size+2]
 22538                                  	;mov	[es:di+1Eh],ax
 22539                                  	MOV	[ES:DI+dir_entry.dir_size_h],AX
 22540                                  	;mov	ax,[si+0Fh]
 22541                                  	MOV	AX,[SI+SF_ENTRY.sf_date]
 22542                                  	;mov	[es:di+18h],ax
 22543                                  	MOV	[ES:DI+dir_entry.dir_date],AX	;Set date
 22544                                  	;mov	ax,[si+0Dh]
 22545                                  	MOV	AX,[SI+SF_ENTRY.sf_time]
 22546                                  	;mov	[es:di+16h],ax
 22547                                  	MOV	[ES:DI+dir_entry.dir_time],AX	;Set time
 22548                                  %else
 22549                                  	; 03/02/2024 - Retro DOS v5.0
 22550 000036BD 56                      	push	si
 22551 000036BE 83C60D                  	add	si,0Dh
 22552 000036C1 AD                      	lodsw	; [si+SF_ENTRY.sf_time]
 22553 000036C2 26894516                	mov	[es:di+dir_entry.dir_time],ax	; Set time
 22554 000036C6 AD                      	lodsw	; [si+SF_ENTRY.sf_date]
 22555 000036C7 26894518                	mov	[es:di+dir_entry.dir_date],ax	; Set date
 22556 000036CB AD                      	lodsw	; [si+SF_ENTRY.sf_size]
 22557 000036CC 2689451C                	mov	[es:di+dir_entry.dir_size_l],ax	; Set size
 22558 000036D0 AD                      	lodsw	; [si+SF_ENTRY.sf_size+2]
 22559 000036D1 2689451E                	mov	[es:di+dir_entry.dir_size_h],ax
 22560 000036D5 5E                      	pop	si
 22561                                  %endif
 22562                                  
 22563                                  	; MSDOS 6.0
 22564                                  ;; File Tagging
 22565 000036D6 26F6470540              	TEST	byte [ES:BX+BUFFINFO.buf_flags],buf_dirty
 22566                                  				  ;LB. if already dirty		    ;AN000;
 22567 000036DB 7508                    	JNZ	short yesdirty4	  ;LB.  don't increment dirty count ;AN000;
 22568                                  	; 02/06/2019
 22569 000036DD E89031                  	call	INC_DIRTY_COUNT   ;LB.				    ;AN000;
 22570                                  	; MSDOS 3.3 (& MSDOS 6.0)
 22571                                  	;or	byte [es:bx+5],40h
 22572 000036E0 26804F0540              	OR	byte [ES:BX+BUFFINFO.buf_flags],buf_dirty ;Buffer dirty
 22573                                  yesdirty4:
 22574 000036E5 1E                      	push	ds
 22575 000036E6 56                      	push	si
 22576                                  
 22577                                  ; 03/02/2024
 22578                                  %if 0
 22579                                  	; MSDOS 6.0
 22580                                  	;mov	cx,[si+0Bh]
 22581                                  	; 07/12/2022
 22582                                  	MOV	CX,[SI+SF_ENTRY.sf_firclus] ; do this for Fastopen
 22583                                  %else
 22584                                  	; 03/02/2024
 22585                                  	; PCDOS 7.1
 22586 000036E7 8B4C2B                  	mov	cx,[si+2Bh]		; [es:di+SF_ENTRY.sf_chain]
 22587                                  					; first cluster (32 bit) low word !?
 22588                                  %endif
 22589                                  
 22590                                  ;hkn; SS override
 22591 000036EA 36A0[7605]              	MOV	AL,[SS:THISDRV]
 22592                                  	; MSDOS 3.3 
 22593                                  	;push	ss
 22594                                  	;pop	ds
 22595                                  	;MOV	AL,[THISDRV]
 22596                                  ;;; 10/1/86  update fastopen cache
 22597                                  	; MSDOS 3.3 & MSDOS 6.0
 22598 000036EE 52                      	PUSH	DX
 22599 000036EF B400                    	MOV	AH,0			; dir entry update
 22600 000036F1 88C2                    	MOV	DL,AL			; drive number A=0, B=1,,,
 22601                                  	;;;
 22602                                  	; 03/02/2024 - Retro DOS v5.0
 22603                                  	; PCDOS 7.1
 22604 000036F3 53                      	push	bx ; *
 22605 000036F4 8B5C2D                  	mov	bx,[si+2Dh]		; [es:di+SF_ENTRY.sf_chain+2]
 22606                                  					; first cluster (32 bit) high word !?
 22607 000036F7 09DB                    	or	bx,bx
 22608 000036F9 7510                    	jnz	short do_update2
 22609                                  	;;;
 22610                                  	; MSDOS 6.0
 22611 000036FB 09C9                    	OR	CX,CX			;AN005; first cluster 0; may be truncated
 22612 000036FD 750C                    	JNZ	short do_update2	;AN005; no, do update
 22613 000036FF B403                    	MOV	AH,3			;AN005; do a delete cache entry
 22614                                  	; 27/06/2024
 22615                                  	;;;
 22616                                  	;;mov	di,[si+1Bh]
 22617                                  	;MOV	DI,[SI+SF_ENTRY.sf_dirsec] ;AN005; cx:di = dir sector
 22618                                  	;;mov	cx,[si+1Dh]
 22619                                  	;MOV	CX,[SI+SF_ENTRY.sf_dirsec+2] ;AN005;
 22620 00003701 C57C1B                  	lds	di,[si+SF_ENTRY.sf_dirsec]
 22621 00003704 8CD9                      	mov	cx,ds
 22622                                  	;;;
 22623                                  	;mov	dh,[si+1Fh]
 22624 00003706 8A741F                  	MOV	DH,[SI+SF_ENTRY.sf_dirpos] ;AN005; dh = dir pos
 22625 00003709 EB1A                    	JMP	SHORT do_update 	;AN011;F.O.
 22626                                  
 22627                                  do_update2:				;AN011;F.O.
 22628                                  	;;;
 22629                                  	; 03/02/2024
 22630                                  	; PCDOS 7.1
 22631 0000370B 363B1E[0E11]            	cmp	bx,[ss:OLD_FIRSTCLUS_HW] ; same as old first cluster?
 22632 00003710 7507                    	jnz	short do_update3 ; no
 22633                                  	;;;
 22634                                  
 22635                                  ;hkn; SS override fort OLD_FIRSTCLUS
 22636                                  	; 
 22637 00003712 363B0E[BD0E]            	CMP	CX,[SS:OLD_FIRSTCLUS]	;AN011;F.O. same as old first cluster?
 22638 00003717 740C                    	JZ	short do_update		;AN011;F.O. yes
 22639                                  do_update3:	; 03/02/2024
 22640 00003719 B402                    	MOV	AH,2			;AN011;F.O. delete the old entry
 22641 0000371B 368B0E[BD0E]            	MOV	CX,[SS:OLD_FIRSTCLUS]	;AN011;F.O.
 22642                                  	;;;
 22643                                  	; 03/02/2024
 22644                                  	; PCDOS 7.1
 22645 00003720 368B1E[0E11]            	mov	bx,[ss:OLD_FIRSTCLUS_HW]
 22646                                  	;;; 
 22647                                  do_update:				;AN005;
 22648                                  ;hkn; SS is DOSDATA
 22649                                  	;Context DS
 22650 00003725 16                      	push	ss
 22651 00003726 1F                      	pop	ds
 22652                                  	
 22653                                  	; 03/03/2025 (MiniDOS)
 22654                                  	;;;;
 22655                                  	;; 03/02/2024 - Retro DOS v5.0
 22656                                  	;xchg	bx,si	; PCDOS 7.1 IBMDOS.COM
 22657                                  	;;;;
 22658                                  	;; MSDOS 3.3 & MSDOS 6.0
 22659                                  	;call	FastOpen_Update 	; invoke fastopen
 22660                                  	;;;;
 22661                                  	;; 03/02/2024
 22662                                  	;xchg	bx,si	; PCDOS 7.1 IBMDOS.COM
 22663                                  	
 22664 00003727 5B                      	pop	bx ; *
 22665                                  	;;;
 22666 00003728 5A                      	POP	DX
 22667                                  
 22668                                  ;;; 10/1/86  update fastopen cache
 22669 00003729 E81230                  	call	FLUSHBUF		; flush all relevant buffers
 22670 0000372C 5F                      	pop	di
 22671 0000372D 07                      	pop	es
 22672                                  	;mov	al,5
 22673 0000372E B005                    	MOV	AL,error_access_denied
 22674 00003730 7215                    	JC	short CloseFinish
 22675                                  FREE_SFT_OK:
 22676                                  	; 03/02/2024
 22677                                  	;CLC				; signal no error.
 22678                                  	
 22679                                  	;;;
 22680                                  	; 03/02/2024 - Retro DOS v5.0
 22681                                  	; PCDOS 7.1 IBMDOS.COM
 22682                                  	;test	word [es:di+5],8080h
 22683 00003732 26F745058080            	test	word [es:di+SF_ENTRY.sf_flags],sf_isnet+devid_device
 22684 00003738 7520                    	jnz	short CloseFinish2
 22685 0000373A 06                      	push	es
 22686 0000373B 55                      	push	bp
 22687                                  	;les	bp,[es:di+7]
 22688 0000373C 26C46D07                	les	bp,[es:di+SF_ENTRY.sf_devptr] ; DPB
 22689 00003740 E848FC                  	call	update_fat32_fsinfo
 22690 00003743 5D                      	pop	bp
 22691 00003744 07                      	pop	es
 22692 00003745 EB13                    	jmp	short CloseFinish2
 22693                                  	
 22694                                  CloseFinish:	; 03/02/2024 - Retro DOS v5.0
 22695 00003747 1E                      	push    ds
 22696 00003748 53                      	push    bx
 22697 00003749 26C55D07                	lds     bx,[es:di+7]		; [es:di+SF_ENTRY.sf_devptr] ; DPB
 22698 0000374D 8A1F                    	mov     bl,[bx]			; DPB.DRIVE
 22699 0000374F 30FF                    	xor     bh,bh ; 0
 22700 00003751 3680A7[1412]FB          	and     byte [ss:bx+drive_flags],0FBh ; clear bit 2
 22701                                  					; bit 2 - last access date/time flag?
 22702                                  					; or disk accessed (successful) flag !?
 22703 00003757 5B                      	pop     bx
 22704 00003758 1F                      	pop     ds
 22705 00003759 F9                      	stc
 22706                                  	;;;
 22707                                  
 22708                                  CloseFinish2:	 ; 03/02/2024 - Retro DOS v5.0
 22709                                  ;Closefinish:
 22710                                  
 22711                                  ; Indicate to the device that the SFT is being closed.
 22712                                  
 22713                                  ;;;; 7/21/86
 22714 0000375A 9C                      	PUSHF				; save flag from DirFromSFT
 22715 0000375B E8A117                  	call	DEV_CLOSE_SFT
 22716 0000375E 9D                      	POPF
 22717                                  ;;;; 7/21/86
 22718                                  ;
 22719                                  ; See if the ref count indicates that we have busied the SFT. If so, mark the
 22720                                  ; SFT as being free. Note that we do NOT need to be in critSFT as we are ONLY
 22721                                  ; going to be moving from busy to free.
 22722                                  ;
 22723 0000375F 59                      	POP	CX			; get old ref count
 22724 00003760 9C                      	PUSHF
 22725                                  	; 03/02/2024
 22726                                  	;DEC	CX			; if cx != 1
 22727                                  	;JNZ	short NoFree		; then do NOT free SFT
 22728 00003761 E203                    	loop	NoFree ; PCDOS 7.1 IBMDOS.COM
 22729                                  
 22730                                  ; 03/02/2024 - Retro DOS v5.0
 22731                                  %if 0
 22732                                  	mov	[es:di],cx
 22733                                  	;MOV	[ES:DI+SF_ENTRY.sf_ref_Count],CX ; mov [es:di+0],cx
 22734                                  %else
 22735                                  	; 03/02/2024
 22736                                  	; PCDOS 7.1 IBMDOS.COM
 22737 00003763 E83612                  	call    SFT_FREE
 22738                                  %endif
 22739                                  
 22740                                  NoFree:
 22741 00003766 E848E1                  	call	LCritDisk
 22742 00003769 9D                      	POPF
 22743 0000376A C3                      	retn
 22744                                  
 22745                                  ;---------------------------------------------------------------------------
 22746                                  ;
 22747                                  ; Procedure Name : FREE_SFT
 22748                                  ;
 22749                                  ; ES:DI -> SFT. Decs sft_ref_count. If the count goes to 0, mark it as busy.
 22750                                  ; Flags preserved. Return old ref count in AX
 22751                                  ;
 22752                                  ; Note that busy is indicated by the SFT ref count being -1.
 22753                                  ;
 22754                                  ;---------------------------------------------------------------------------
 22755                                  
 22756                                  FREE_SFT:
 22757 0000376B 9C                      	PUSHF		; Save carry state
 22758 0000376C 268B05                  	mov	ax,[es:di]
 22759                                  	;MOV	AX,[ES:DI+SF_ENTRY.sf_ref_count]
 22760 0000376F 48                      	DEC	AX
 22761 00003770 7501                    	JNZ	short SetCount
 22762 00003772 48                      	DEC	AX
 22763                                  SetCount:
 22764 00003773 268705                  	xchg	ax,[es:di]
 22765                                  	;XCHG	AX,[ES:DI+SF_ENTRY.sf_ref_count]
 22766 00003776 9D                      	POPF
 22767 00003777 C3                      	retn
 22768                                  
 22769                                  	; 18/05/2019 - Retro DOS v4.0
 22770                                  
 22771                                  ;----------------------------------------------------------------------------
 22772                                  ;
 22773                                  ; Procedure Name : DirFromSFT
 22774                                  ;
 22775                                  ;   DirFromSFT - locate a directory entry given an SFT.
 22776                                  ;
 22777                                  ;   Inputs:	ES:DI point to SFT
 22778                                  ;		DS = DOSDATA
 22779                                  ;   Outputs:
 22780                                  ;		EXTERR_LOCUS = errLOC_Disk
 22781                                  ;		CurBuf points to buffer
 22782                                  ;		Carry Clear -> operation OK
 22783                                  ;		    ES:DI point to entry
 22784                                  ;		    ES:BX point to buffer
 22785                                  ;		    DS:SI point to SFT
 22786                                  ;		Carry SET   -> operation failed
 22787                                  ;		    registers trashified
 22788                                  ;   Registers modified: ALL
 22789                                  ;----------------------------------------------------------------------------
 22790                                  
 22791                                  	; 04/02/2024 - Retro DOS v5.0
 22792                                  	; PCDOS 7.1 IBMDOS.COM
 22793                                  
 22794                                  DirFromSFT:
 22795                                  	;;mov	byte [EXTERR_LOCUS],2
 22796                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Disk
 22797                                  	; 04/02/2024
 22798 00003778 E848DB                  	call	set_exerr_locus_disk
 22799                                  	;
 22800 0000377B 06                      	push	es
 22801 0000377C 57                      	push	di
 22802                                  	; MSDOS 3.3
 22803                                  	;;mov	dx,[es:di+1Dh]
 22804                                  	;MOV	dx,[ES:DI+SF_ENTRY.sf_dirsec]
 22805                                  	; MSDOS 6.0
 22806                                  	;mov	dx,[es:[di+1Dh]
 22807 0000377D 268B551D                	MOV	DX,[ES:DI+SF_ENTRY.sf_dirsec+2]  ;F.C. >32mb
 22808 00003781 8916[0706]              	MOV	[HIGH_SECTOR],DX		 ;F.C. >32mb
 22809                                  	; 04/02/2024
 22810 00003785 52                      	push	dx
 22811                                  	;mov	dx,[es:di+1Bh]
 22812 00003786 268B551B                	MOV	DX,[ES:DI+SF_ENTRY.sf_dirsec]
 22813                                  	; 04/02/2024
 22814                                  	; 19/05/2019
 22815                                  	;PUSH	word [HIGH_SECTOR]	;F.C. >32mb
 22816                                  	; MSDOS 3.3 & MSDOS 6.0
 22817 0000378A 52                      	PUSH	DX
 22818 0000378B E8622A                  	call	FATREAD_SFT		; ES:BP points to DPB, [THISDRV] set
 22819                                  					; [THISDPB] set
 22820 0000378E 5A                      	POP	DX
 22821 0000378F 8F06[0706]              	POP	word [HIGH_SECTOR]	;F.C. >32mb
 22822 00003793 721E                    	JC	short PopDone
 22823                                  	; 22/09/2023
 22824                                  	;XOR	AL,AL	; *		; Pre read
 22825                                  	;;mov	byte [ALLOWED],18h
 22826                                  	;MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY ; *
 22827                                  	;call	GETBUFFR
 22828                                  	; 22/09/2023
 22829 00003795 E8372E                  	call	GETBUFFER ; * 		; Pre read
 22830 00003798 7219                    	JC	short PopDone
 22831 0000379A 5E                      	pop	si
 22832 0000379B 1F                      	pop	ds			; Get back SFT pointer
 22833                                  
 22834                                  ;hkn; SS override
 22835 0000379C 36C43E[E205]            	LES	DI,[SS:CURBUF]
 22836                                  	;or	byte [es:di+5],4
 22837 000037A1 26804D0504              	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_isDIR
 22838 000037A6 89FB                    	MOV	BX,DI			; ES:BX point to buffer header
 22839                                  	;;;lea	di,[di+16] ; MSDOS 3.3
 22840                                  	;;lea	di,[di+20] ; MSDOS 6.0
 22841                                  	; 04/02/2024
 22842                                  	;lea	di,[di+24] ; MSDOS 7.1
 22843 000037A8 8D7D18                  	LEA	DI,[DI+BUFINSIZ] 	; Point to buffer
 22844                                  	;mov	al,32
 22845 000037AB B020                    	MOV	AL,dir_entry.size
 22846                                  	;mul	byte [si+1Fh] ; MSDOS 6.0
 22847 000037AD F6641F                  	MUL	byte [SI+SF_ENTRY.sf_dirpos]
 22848 000037B0 01C7                    	ADD	DI,AX			; Point at the entry
 22849 000037B2 C3                      	retn				; carry is clear
 22850                                  PopDone:
 22851 000037B3 5F                      	pop	di
 22852 000037B4 07                      	pop	es
 22853                                  PopDone_retn:
 22854 000037B5 C3                      	retn
 22855                                  
 22856                                  ;----------------------------------------------------------------------------
 22857                                  ;
 22858                                  ;**	DOS_Commit - UPdate Directory Entries
 22859                                  ;
 22860                                  ;	ENTRY	same as DOS_CLOSE (??? BUGBUG - update this jgl)
 22861                                  ;		(DS) = DOSGROUP
 22862                                  ;	EXIT	Same as DOS_CLOSE except ref_count field is not altered
 22863                                  ;	USES	all but DS
 22864                                  ;
 22865                                  ;----------------------------------------------------------------------------
 22866                                  
 22867                                  ; 14/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 22868                                  ; DOSCODE:6F72h (MSDOS 5.0, MSDOS.SYS)
 22869                                  
 22870                                  ; 04/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 22871                                  ; DOSCODE:78B8h (PCDOS 7.1 IBMDOS.COM)
 22872                                  
 22873                                  DOS_COMMIT:
 22874                                  	;hkn; called from srvcall. DS already set up.
 22875 000037B6 C43E[9E05]              	LES	DI,[THISSFT]
 22876                                  	;mov	bx,[es:di+5]
 22877 000037BA 268B5D05                	MOV	BX,[ES:DI+SF_ENTRY.sf_flags]
 22878                                  	;test	bx,0C0h
 22879                                  	; 17/12/2022
 22880 000037BE F6C3C0                  	test	bl,devid_file_clean+devid_device ;Clears carry
 22881                                  	;TEST	BX,devid_file_clean+devid_device ;Clears carry
 22882 000037C1 75F2                    	jnz	short PopDone_retn
 22883                                  	;test	bx,8000h
 22884                                  	; 17/12/2022
 22885                                  	;test	bh,80h
 22886 000037C3 F6C780                  	test	bh,(sf_isnet>>8) ; 80h
 22887                                  	;TEST	BX,sf_isnet ; 8000h
 22888 000037C6 7406                    	JZ	short LOCAL_COMMIT
 22889                                  
 22890                                  ;IF NOT Installed
 22891                                  ;	transfer NET_COMMIT
 22892                                  ;ELSE
 22893                                  	;mov	ax,1107h
 22894 000037C8 B80711                  	MOV	AX,(MultNET<<8)|7
 22895 000037CB CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - COMMIT REMOTE FILE
 22896                                  			; ES:DI -> SFT
 22897                                  			; SFT DPB field -> DPB of drive containing file
 22898                                  			; Return: CF set on error, AX = DOS error code
 22899                                  			; CF clear if successful
 22900                                  localcommit_retn: ; 18/12/2022	
 22901 000037CD C3                      	retn
 22902                                  ;ENDIF
 22903                                  
 22904                                  ; Perform local commit operation by doing a close but not releaseing the SFT.
 22905                                  ; There are three ways we can do this. One is to enter a critical section to
 22906                                  ; protect a potential free. The second is to increment the ref count to mask
 22907                                  ; the close decrementing.
 22908                                  ;
 22909                                  ; The proper way is to let the caller's of close decide if a decrement should
 22910                                  ; be done. We do this by providing another entry into close after the
 22911                                  ; decrement and after the share information release.
 22912                                  
 22913                                  ; DOSCODE:6FA0h (MSDOS 6.21, MSDOS.SYS)
 22914                                  ; DOSCODE:6F8Ch (MSDOS 5.0, MSDOS.SYS) 
 22915                                  
 22916                                  LOCAL_COMMIT:
 22917 000037CE E8B3E0                  	call	ECritDisk
 22918                                  	; MSDOS 6.0
 22919 000037D1 E8B0E0                  	call	ECritDisk	;PTM.
 22920 000037D4 E80E00                  	call	SetSFTTimes
 22921 000037D7 B8FFFF                  	MOV	AX,-1 ; 0FFFFh
 22922 000037DA E856FE                  	call	CloseEntry
 22923                                  	; MSDOS 6.0
 22924 000037DD 9C                      	PUSHF			;PTM.				;AN000;
 22925 000037DE E81617                  	call	DEV_OPEN_SFT	;PTM.  increment device count	;AN000;
 22926 000037E1 9D                      	POPF			;PTM.				;AN000;
 22927                                  	;call	LCritDisk	;PTM.				;AN000;
 22928                                  	; 18/12/2022
 22929 000037E2 E9CCE0                  	jmp	LCritDisk
 22930                                  ;localcommit_retn:
 22931                                  ;	retn
 22932                                  
 22933                                  ;Break	<SetSFTTimes - signal a change in the times for an SFT>
 22934                                  ;----------------------------------------------------------------------------
 22935                                  ;
 22936                                  ; Procedure Name : SetSFTTimes
 22937                                  ;
 22938                                  ;   SetSFTTimes - Examine the flags for a SFT and set the time appropriately.
 22939                                  ;   Reflect these times in other SFT's for the same file.
 22940                                  ;
 22941                                  ;   Inputs:	ES:DI point to SFT
 22942                                  ;		BX = sf_flags set appropriately
 22943                                  ;   Outputs:	Set sft times to current time if File & dirty & !nodate
 22944                                  ;   Registers modified: All except ES:DI, BX, AX
 22945                                  ;
 22946                                  ;----------------------------------------------------------------------------
 22947                                  
 22948                                  	; 04/02/2024 - Retro DOS v5.0
 22949                                  	; PCDOS 7.1 IBMDOS.COM 
 22950                                  
 22951                                  SetSFTTimes:
 22952                                  
 22953                                  ; 04/02/2024
 22954                                  %if 0
 22955                                  ;	File clean or device does not get stamped nor disk looked at.
 22956                                  	
 22957                                  	;test	bx,0C0h
 22958                                  	; 17/12/2022
 22959                                  	test	bl,devid_file_clean+devid_device
 22960                                  	;TEST	BX,devid_file_clean+devid_device
 22961                                  	;retnz				; clean or device => no timestamp
 22962                                  	jnz	short localcommit_retn
 22963                                  
 22964                                  ;	file and dirty. See if date is good
 22965                                  
 22966                                  	;test	bx,4000h
 22967                                  	; 17/12/2022
 22968                                  	;test	bh,40h
 22969                                  	test	bh,(sf_close_nodate>>8)
 22970                                  	;TEST	BX,sf_close_nodate
 22971                                  	;retnz				; nodate => no timestamp
 22972                                  	jnz	short localcommit_retn
 22973                                  %else
 22974                                  	; 04/02/2024
 22975                                  	; (PCDOS 7.1 IBMDOS.COM)
 22976                                  	;test	bx,40C0h
 22977 000037E5 F7C3C040                	test	bx,sf_close_nodate+devid_file_clean+devid_device
 22978 000037E9 75E2                    	jnz	short localcommit_retn
 22979                                  %endif
 22980                                  
 22981 000037EB 50                      	push	ax
 22982 000037EC 53                      	push	bx
 22983 000037ED E84DD3                  	call	DATE16			; Date/Time to AX/DX
 22984                                  	;mov	[es:di+0Fh],ax
 22985 000037F0 2689450F                	MOV	[ES:DI+SF_ENTRY.sf_date],AX
 22986                                  	;mov	[es:di+0Dh],dx
 22987 000037F4 2689550D                	MOV	[ES:DI+SF_ENTRY.sf_time],DX
 22988 000037F8 31C0                    	XOR	AX,AX
 22989                                  ;if installed
 22990                                  	;call	JShare + 14 * 4
 22991 000037FA FF1E[C800]              	call	far [JShare+(14*4)]	; 14 = ShSU
 22992                                  ;else
 22993                                  ;	call	ShSU
 22994                                  ;endif
 22995 000037FE 5B                      	pop	bx
 22996 000037FF 58                      	pop	ax
 22997 00003800 C3                      	retn
 22998                                  
 22999                                  ;============================================================================
 23000                                  ; DIRCALL.ASM, MSDOS 6.0, 1991
 23001                                  ;============================================================================
 23002                                  ; 23/07/2018 - Retro DOS v3.0
 23003                                  ; 18/05/2019 - Retro DOS v4.0
 23004                                  
 23005                                  ; DOSCODE:6FDAh (MSDOS 6.21, MSDOS.SYS)
 23006                                  
 23007                                  ;TITLE DIRCALL - Directory manipulation internal calls
 23008                                  ;NAME  DIRCALL
 23009                                  
 23010                                  ;**	Low level directory manipulation routines for making removing and
 23011                                  ;	  verifying local or NET directories
 23012                                  ;
 23013                                  ;	DOS_MKDIR
 23014                                  ;	DOS_CHDIR
 23015                                  ;	DOS_RMDIR
 23016                                  ;
 23017                                  ;	Modification history:
 23018                                  ;
 23019                                  ;		Created: ARR 30 March 1983
 23020                                  
 23021                                  ;BREAK <DOS_MkDir - Make a directory entry>
 23022                                  ;---------------------------------------------------------------------------
 23023                                  ;
 23024                                  ; Procedure Name : DOS_MkDir
 23025                                  ;
 23026                                  ; Inputs:
 23027                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 23028                                  ;		terminated)
 23029                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 23030                                  ;		( = -1 if current dir not involved, else
 23031                                  ;		 Points to first char after last "/" of current dir part)
 23032                                  ;	[THISCDS] Points to CDS being used
 23033                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 23034                                  ; Function:
 23035                                  ;	Make a new directory
 23036                                  ; Returns:
 23037                                  ;	Carry Clear
 23038                                  ;		No error
 23039                                  ;	Carry Set
 23040                                  ;	    AX is error code
 23041                                  ;		error_path_not_found
 23042                                  ;			Bad path (not in curr dir part if present)
 23043                                  ;		error_bad_curr_dir
 23044                                  ;			Bad path in current directory part of path
 23045                                  ;		error_access_denied
 23046                                  ;			Already exists, device name
 23047                                  ; DS preserved, Others destroyed
 23048                                  ;---------------------------------------------------------------------------
 23049                                  
 23050                                  ;hkn; called from path.asm. DS already set up.
 23051                                  
 23052                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 23053                                  ; DOSCODE:6FC6h (MSDOS 5.0, MSDOS.SYS)
 23054                                  
 23055                                  ; 04/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 23056                                  ; DOSCODE:78FFh (PCDOS 7.1, IBMDOS.COM)
 23057                                  
 23058                                  DOS_MKDIR:
 23059 00003801 E802E0                  	call	TestNet
 23060 00003804 7313                    	JNC	short LOCAL_MKDIR
 23061                                  
 23062                                  ;IF NOT Installed
 23063                                  ;	transfer NET_MKDIR
 23064                                  ;ELSE
 23065                                  	;mov	ax,1103h
 23066 00003806 B80311                  	MOV	AX,(MultNET<<8)|3
 23067 00003809 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - MAKE REMOTE DIRECTORY
 23068                                  			; SS = DOS CS
 23069                                  			; SDA first filename pointer -> fully-qualified directory name
 23070                                  			; SDA CDS pointer -> current directory
 23071                                  			; Return: CF set on error, AX = DOS error code
 23072                                  			; CF clear if successful
 23073 0000380B C3                      	retn
 23074                                  ;ENDIF
 23075                                  
 23076                                  NODEACCERRJ:
 23077                                  	;mov	ax,5
 23078 0000380C B80500                  	MOV	AX,error_access_denied
 23079                                  _BadRet:
 23080 0000380F F9                      	STC
 23081                                  	;call	LCritDisk
 23082                                  	;retn
 23083                                  	; 18/12/2022
 23084 00003810 E99EE0                  	jmp	LCritDisk
 23085                                  
 23086                                  PATHNFJ:
 23087 00003813 E89BE0                  	call	LCritDisk
 23088 00003816 E965F8                  	jmp	SET_MKND_ERR	; Map the MakeNode error and return
 23089                                  
 23090                                  LOCAL_MKDIR:
 23091 00003819 E868E0                  	call	ECritDisk
 23092                                  
 23093                                  ; MakeNode requires an SFT to fiddle with. We Use a temp spot (RENBUF)
 23094                                  
 23095 0000381C 8C16[A005]              	MOV	[THISSFT+2],SS
 23096                                  
 23097                                  ;hkn; DOSDATA
 23098 00003820 C706[9E05][3E04]        	MOV	WORD [THISSFT],RENBUF
 23099                                  
 23100                                  ;  NOTE: Need WORD PTR because MASM takes type of
 23101                                  ;   TempSFT (byte) instead of type of sf_mft (word).
 23102                                  
 23103                                  	;mov	word [RENBUF+33h],0 ; MSDOS 6.0
 23104 00003826 C706[7104]0000          	MOV	WORD [RENBUF+SF_ENTRY.sf_MFT],0
 23105                                  				; make sure SHARER won't complain.
 23106                                  	;mov	al,10h
 23107 0000382C B010                    	MOV	AL,attr_directory
 23108 0000382E E8FC18                  	call	MakeNode
 23109 00003831 72E0                    	JC	short PATHNFJ
 23110 00003833 83F803                  	CMP	AX,3
 23111 00003836 74D4                    	JZ	short NODEACCERRJ ; Can't make a device into a directory
 23112 00003838 C42E[8A05]              	LES	BP,[THISDPB]	; Makenode zaps this
 23113 0000383C C53E[E205]              	LDS	DI,[CURBUF]
 23114 00003840 29FE                    	SUB	SI,DI
 23115 00003842 56                      	PUSH	SI		; Pointer to dir_first
 23116                                  
 23117                                  ; 04/02/2024
 23118                                  %if 0
 23119                                  	; MSDOS 6.0
 23120                                  	;push	word [DI+8]
 23121                                  	PUSH	WORD [DI+BUFFINFO.buf_sector+2]	;F.C. >32mb
 23122                                  	; MSDOS 3.3 & MSDOS 6.0
 23123                                  	;push	word [di+6]
 23124                                  	PUSH	WORD [DI+BUFFINFO.buf_sector] ; Sector of new node
 23125                                  %else
 23126                                  	; 04/02/2024
 23127                                  	; (PCDOS 7.1 IBMDOS.COM)
 23128 00003843 C54506                  	lds	ax,[di+BUFFINFO.buf_sector] ; Sector of new node
 23129 00003846 1E                      	push	ds
 23130 00003847 50                      	push	ax
 23131                                  %endif
 23132                                  
 23133 00003848 16                      	push	ss
 23134 00003849 1F                      	pop	ds
 23135                                  
 23136                                  	; 04/02/2024
 23137                                  	;PUSH	word [DIRSTART]	; Parent for .. entry
 23138 0000384A 31C0                    	XOR	AX,AX
 23139                                  	;MOV	[DIRSTART],AX	; Null directory
 23140                                  	;;;
 23141                                  	; Retro DOS v5.0
 23142                                  	; PCDOS 7.1 IBMDOS.COM
 23143 0000384C 89C2                    	mov	dx,ax ; 0
 23144 0000384E 8716[DC0A]              	xchg	dx,[DIRSTART_HW] ; Null directory
 23145 00003852 8706[C205]              	xchg	ax,[DIRSTART]
 23146                                  	;
 23147                                  	;cmp	word [es:bp+0Fh],0
 23148 00003856 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 23149 0000385B 7510                    	jnz	short LOCAL_MKDIR_cont ; not FAT32
 23150                                  	;cmp	[es:bp+35h],ax
 23151 0000385D 26394635                	cmp	[es:bp+DPB.ROOT_CLUSTER],ax
 23152 00003861 750A                    	jne     short LOCAL_MKDIR_cont
 23153                                  	;cmp	[es:bp+37h],dx
 23154 00003863 26395637                	cmp	[es:bp+DPB.ROOT_CLUSTER+2],dx
 23155 00003867 7504                    	jne	short LOCAL_MKDIR_cont
 23156                                  	;
 23157 00003869 31D2                    	xor	dx,dx
 23158 0000386B 31C0                    	xor	ax,ax
 23159                                  		; dx:ax = 0 for root directory
 23160                                  LOCAL_MKDIR_cont:
 23161 0000386D 52                      	push	dx
 23162                                  	;;;
 23163 0000386E 50                      	push	ax
 23164                                  
 23165 0000386F E8DE17                  	call	NEWDIR
 23166 00003872 7278                    	JC	short NODEEXISTSPOPDEL ; No room
 23167 00003874 E8E30E                  	call	GETENT		; First entry
 23168 00003877 7273                    	JC	short NODEEXISTSPOPDEL ; Screw up
 23169 00003879 C43E[E205]              	LES	DI,[CURBUF]
 23170                                  
 23171                                  ; 04/02/2024
 23172                                  %if 0
 23173                                  	; MSDOS 6.0
 23174                                  	TEST	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 23175                                  				 ;LB. if already dirty		    ;AN000;
 23176                                  	JNZ	short yesdirty5	 ;LB.   don't increment dirty count ;AN000;
 23177                                  	call	INC_DIRTY_COUNT  ;LB.				    ;AN000;
 23178                                  	
 23179                                  	; MSDOS 3.3 & MSDOS 6.0
 23180                                  	;or	byte [es:di+5],40h  ; 07/12/2022
 23181                                  	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 23182                                  %else
 23183                                  	; 04/02/2024
 23184                                  	; (PCDOS 7.1 IBMDOS.COM)
 23185 0000387D E8E42F                  	call	SET_BUF_DIRTY
 23186                                  %endif
 23187                                  
 23188                                  yesdirty5:
 23189                                  	;;;add	di,16 ; MSDOS 3.3
 23190                                  	;;add	di,20 ; MSDOS 6.0
 23191                                  	; 04/02/2024
 23192                                  	;add	di,24 ; PCDOS 7.1	
 23193 00003880 83C718                  	ADD	DI,BUFINSIZ	; Point at buffer
 23194 00003883 B82E20                  	MOV	AX,202EH	; ". "
 23195                                  	;;;
 23196                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23197 00003886 8B16[DC0A]              	mov	dx,[DIRSTART_HW]
 23198 0000388A 8916[F20A]              	mov	[CLUSTERS_HW],dx
 23199                                  	;;;
 23200 0000388E 8B16[C205]              	MOV	DX,[DIRSTART]	; Point at itself
 23201 00003892 E87118                  	call	SETDOTENT
 23202 00003895 B82E2E                  	MOV	AX,2E2EH	; ".."
 23203 00003898 5A                      	POP	DX		; Parent
 23204                                  	;;;
 23205                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23206 00003899 8F06[F20A]              	pop	word [CLUSTERS_HW]
 23207                                  	;;;
 23208 0000389D E86618                  	call	SETDOTENT
 23209 000038A0 C42E[8A05]              	LES	BP,[THISDPB]
 23210                                  	; 22/09/2023
 23211                                  	;;mov	byte [ALLOWED],18h
 23212                                  	;MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY ; *
 23213 000038A4 5A                      	POP	DX		; Entry sector
 23214                                  	; MSDOS 6.0
 23215 000038A5 8F06[0706]              	POP	word [HIGH_SECTOR] ;F.C. >32mb
 23216                                  
 23217                                  	;XOR	AL,AL ; *	; Pre read
 23218                                  	;call	GETBUFFR
 23219                                  	; 22/09/2023
 23220 000038A9 E8232D                  	call	GETBUFFER ; *	; Pre read
 23221 000038AC 7265                    	JC	short NODEEXISTSP
 23222                                  	;;;
 23223                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23224 000038AE A1[DC0A]                	mov	ax,[DIRSTART_HW]
 23225                                  	;;;
 23226 000038B1 8B16[C205]              	MOV	DX,[DIRSTART]
 23227 000038B5 C53E[E205]              	LDS	DI,[CURBUF]
 23228                                  	;or	byte [di+5],4
 23229 000038B9 804D0504                	OR	byte [DI+BUFFINFO.buf_flags],buf_isDIR
 23230 000038BD 5E                      	POP	SI		; dir_first pointer
 23231 000038BE 01FE                    	ADD	SI,DI
 23232 000038C0 8914                    	MOV	[SI],DX		; dir_entry.dir_first
 23233                                  	;;;
 23234                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23235 000038C2 8944FA                  	mov	[si-6],ax	; dir_entry.dir_fclus_hi
 23236                                  	;;;
 23237                                  
 23238 000038C5 31D2                    	XOR	DX,DX
 23239 000038C7 895402                  	MOV	[SI+2],DX	; Zero size
 23240 000038CA 895404                  	MOV	[SI+4],DX
 23241                                  DIRUP:
 23242                                  	; MSDOS 6.0
 23243 000038CD F6450540                	TEST	byte [DI+BUFFINFO.buf_flags],buf_dirty  
 23244                                  	;			 ;LB. if already dirty 		   ;AN000;
 23245 000038D1 7507                    	JNZ	short yesdirty6	 ;LB.  don't increment dirty count ;AN000;
 23246 000038D3 E89A2F                  	call	INC_DIRTY_COUNT  ;LB.				   ;AN000;
 23247                                  	
 23248                                  	; MSDOS 3.3 & MSDOS 6.0
 23249                                  	;or	byte [di+5],40h
 23250 000038D6 804D0540                	OR	byte [DI+BUFFINFO.buf_flags],buf_dirty	; Dirty buffer
 23251                                  yesdirty6:
 23252 000038DA 16                      	push	ss
 23253 000038DB 1F                      	pop	ds
 23254                                  	;;;
 23255                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23256 000038DC E8ACFA                  	call	update_fat32_fsinfo
 23257                                  	;;;
 23258 000038DF 268A4600                	mov	al,[es:bp]
 23259                                  	;MOV	AL,[ES:BP+DPB.DRIVE]  ; mov al,[es:bp+0]
 23260 000038E3 E8582E                  	call	FLUSHBUF
 23261                                  	;mov	ax,5
 23262 000038E6 B80500                  	MOV	AX,error_access_denied
 23263                                  	;call	LCritDisk
 23264                                  	;retn
 23265                                  	; 18/12/2022
 23266 000038E9 E9C5DF                  	jmp	LCritDisk
 23267                                  
 23268                                  NODEEXISTSPOPDEL:
 23269                                  	;;;
 23270                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23271 000038EC 5A                      	pop	dx		; Parent
 23272                                  	;;;
 23273 000038ED 5A                      	POP	DX		; Parent
 23274 000038EE 5A                      	POP	DX		; Entry sector
 23275                                  	; MSDOS 6.0 
 23276 000038EF 8F06[0706]              	POP	word [HIGH_SECTOR] ; F.C. >32mb
 23277 000038F3 C42E[8A05]              	LES	BP,[THISDPB]
 23278                                  	; 22/09/2023
 23279                                  	;;mov	byte [ALLOWED],18h
 23280                                  	;MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY ; *
 23281                                  	;XOR	AL,AL ; *	; Pre read
 23282                                  	;call	GETBUFFR
 23283                                  	; 22/09/2023
 23284 000038F7 E8D52C                  	call	GETBUFFER ; *	; Pre read
 23285 000038FA 7217                    	JC	short NODEEXISTSP
 23286 000038FC C53E[E205]              	LDS	DI,[CURBUF]
 23287                                  	;or	byte [di+5],4
 23288 00003900 804D0504                	OR	byte [DI+BUFFINFO.buf_flags],buf_isDIR
 23289 00003904 5E                      	POP	SI		; dir_first pointer
 23290 00003905 01FE                    	ADD	SI,DI
 23291                                  	;sub	si,1Ah ; 26
 23292 00003907 83EE1A                  	SUB	SI,dir_entry.dir_first	;Point back to start of dir entry
 23293 0000390A C604E5                  	MOV	BYTE [SI],0E5H	; Free the entry
 23294 0000390D E8BDFF                  	CALL	DIRUP		; Error doesn't matter since erroring anyway
 23295                                  NODEEXISTS:
 23296 00003910 E9F9FE                  	JMP	NODEACCERRJ ; 10/08/2018
 23297                                  
 23298                                  NODEEXISTSP:
 23299 00003913 5E                      	POP	SI		; Clean stack
 23300 00003914 EBFA                    	JMP	short NODEEXISTS
 23301                                  
 23302                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 23303                                  
 23304                                  ;BREAK <DOS_ChDir -- Verify a directory>
 23305                                  ;----------------------------------------------------------------------------
 23306                                  ;
 23307                                  ; Procedure Name : DOS_ChDir
 23308                                  ;
 23309                                  ; Inputs:
 23310                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 23311                                  ;		terminated)
 23312                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 23313                                  ;		( = -1 if current dir not involved, else
 23314                                  ;		 Points to first char after last "/" of current dir part)
 23315                                  ;	[THISCDS] Points to CDS being used May not be NUL
 23316                                  ; Function:
 23317                                  ;	Validate the path for potential new current directory
 23318                                  ; Returns:
 23319                                  ;	NOTE:
 23320                                  ;	    [SATTRIB] is modified by this call
 23321                                  ;	Carry Clear
 23322                                  ;	    CX is cluster number of the DIR, LOCAL CDS ONLY
 23323                                  ;		Caller must NOT set ID fields on a NET CDS.
 23324                                  ;	Carry Set
 23325                                  ;	    AX is error code
 23326                                  ;		error_path_not_found
 23327                                  ;			Bad path
 23328                                  ;		error_access_denied
 23329                                  ;			device or file name
 23330                                  ; DS preserved, Others destroyed
 23331                                  ;----------------------------------------------------------------------------
 23332                                  
 23333                                  ;hkn; called from path.asm and dir2.asm. DS already set up.
 23334                                  
 23335                                  ; 18/05/2019 - Retro DOS v4.0
 23336                                  ; DOSCODE:70DAh (MSDOS 6.21, MSDOS.SYS)
 23337                                  
 23338                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 23339                                  ; DOSCODE:70C6h (MSDOS 5.0, MSDOS.SYS)
 23340                                  
 23341                                  ; 04/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 23342                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:7A23h
 23343                                  
 23344                                  ; (Windows ME IO.SYS - BIOSCODE:7839h)
 23345                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:70DAh)
 23346                                  
 23347                                  DOS_CHDIR:
 23348 00003916 E8EDDE                  	call	TestNet
 23349 00003919 7306                    	JNC	short LOCAL_CHDIR
 23350                                  
 23351                                  ;IF NOT Installed
 23352                                  ;	transfer NET_CHDIR
 23353                                  ;ELSE
 23354                                  	;mov	ax,1105h
 23355 0000391B B80511                  	MOV	AX,(MultNET<<8)|5
 23356 0000391E CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - CHDIR
 23357                                  			; SS = DOS CS
 23358                                  			; SDA first filename pointer -> fully-qualified directory name
 23359                                  			; SDA CDS pointer -> current directory
 23360                                  			; Return: CF set on error, AX = DOS error code
 23361                                  			; CF clear if successful
 23362 00003920 C3                      	retn
 23363                                  ;ENDIF
 23364                                  
 23365                                  LOCAL_CHDIR:
 23366 00003921 E860DF                  	call	ECritDisk
 23367                                  	; MSDOS 6.0
 23368                                  	;;test	word [es:di+43h],2000h
 23369                                  	;TEST	word [ES:DI+curdir.flags],curdir_splice ;PTM.
 23370                                  	; 17/12/2022
 23371                                  	;test	byte [es:di+44h],20h
 23372 00003924 26F6454420              	test	byte [ES:DI+curdir.flags+1],(curdir_splice>>8) ;PTM.
 23373 00003929 740C                    	JZ	short nojoin		   ;PTM.
 23374                                  	;mov	word [es:di+49h], 0FFFFh
 23375 0000392B 26C74549FFFF            	MOV	word [ES:DI+curdir.ID],0FFFFH ;PTM.
 23376                                  	;;;
 23377                                  	; 04/02/2024 (PCDOS 7.1 IBMDOS.COM)
 23378                                  	;mov	word [es:di+4Bh], 0FFFFh
 23379 00003931 26C7454BFFFF            	mov	word [es:di+curdir.ID+2],0FFFFh
 23380                                  	;;;
 23381                                  nojoin:
 23382                                  	; MSDOS 3.3 & MSDOS 6.0
 23383 00003937 C606[4C03]00            	MOV	byte [NoSetDir],0 ; FALSE
 23384                                  	;mov	byte [SATTRIB],16h
 23385 0000393C C606[6D05]16            	MOV	byte [SATTRIB],attr_directory+attr_system+attr_hidden
 23386                                  				; Dir calls can find these
 23387                                  ; DOS 3.3  6/24/86 FastOpen
 23388                                  	; 03/03/2025 (MiniDOS)
 23389                                  	;OR	byte [FastOpenFlg],FastOpen_Set	; set fastopen flag
 23390                                  	
 23391 00003941 E88010                  	call	GETPATH
 23392                                  
 23393                                  	; 03/03/2025 (MiniDOS)
 23394                                  	;; 04/02/2024
 23395                                  	;;PUSHF						;AN000;
 23396                                  	;lahf						
 23397                                  	;AND	byte [FastOpenFlg],Fast_yes ; clear it all ;AC000;
 23398                                  	;;POPF						;AN000;
 23399                                  	;sahf
 23400                                  
 23401                                  ; DOS 3.3  6/24/86 FastOpen
 23402                                  
 23403                                  	; MSDOS 3.3
 23404                                  	;mov	byte [FastOpenFlg],0
 23405                                  	
 23406                                  	;mov	ax,3
 23407 00003944 B80300                  	MOV	AX,error_path_not_found
 23408 00003947 7206                    	JC	short ChDirDone
 23409 00003949 7556                    	JNZ	short NOTDIRPATH	; Path not a DIR
 23410 0000394B 8B0E[C205]              	MOV	CX,[DIRSTART]		; Get cluster number
 23411                                  	; 27/06/2024
 23412                                  	;CLC
 23413                                  ChDirDone:
 23414                                  	;call	LCritDisk
 23415                                  	;retn
 23416                                  	; 18/12/2022
 23417 0000394F E95FDF                  	jmp	LCritDisk
 23418                                  
 23419                                  ;BREAK <DOS_RmDir -- Remove a directory>
 23420                                  ;----------------------------------------------------------------------------
 23421                                  ;
 23422                                  ; Procedure Name : DOS_RmDir
 23423                                  ;
 23424                                  ; Inputs:
 23425                                  ;	[WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 23426                                  ;		terminated)
 23427                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 23428                                  ;		( = -1 if current dir not involved, else
 23429                                  ;		 Points to first char after last "/" of current dir part)
 23430                                  ;	[THISCDS] Points to CDS being used
 23431                                  ;		(Low word = -1 if NUL CDS (Net direct request))
 23432                                  ; Function:
 23433                                  ;	Remove a directory
 23434                                  ;	NOTE: Attempt to remove current directory must be detected by caller
 23435                                  ; Returns:
 23436                                  ;	NOTE:
 23437                                  ;	    [SATTRIB] is modified by this call
 23438                                  ;	Carry Clear
 23439                                  ;		No error
 23440                                  ;	Carry Set
 23441                                  ;	    AX is error code
 23442                                  ;		error_path_not_found
 23443                                  ;			Bad path (not in curr dir part if present)
 23444                                  ;		error_bad_curr_dir
 23445                                  ;			Bad path in current directory part of path
 23446                                  ;		error_access_denied
 23447                                  ;			device or file name, root directory
 23448                                  ;			Bad directory ('.' '..' messed up)
 23449                                  ; DS preserved, Others destroyed
 23450                                  ;----------------------------------------------------------------------------
 23451                                  
 23452                                  ;hkn; called from path.asm. DS already set up.
 23453                                  
 23454                                  ; 18/05/2019 - Retro DOS v4.0
 23455                                  ; DOSCODE:711Fh (MSDOS 6.21, MSDOS.SYS)
 23456                                  
 23457                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 23458                                  ; DOSCODE:710Bh (MSDOS 5.0, MSDOS.SYS)
 23459                                  
 23460                                  ; 06/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 23461                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:7A6Bh
 23462                                  
 23463                                  DOS_RMDIR:
 23464 00003952 E8B1DE                  	call	TestNet
 23465 00003955 7306                    	JNC	short LOCAL_RMDIR
 23466                                  
 23467                                  ;IF NOT Installed
 23468                                  ;	transfer NET_RMDIR
 23469                                  ;ELSE
 23470                                  	;mov	ax,1101h
 23471 00003957 B80111                  	MOV	AX,(MultNET<<8)|1
 23472 0000395A CD2F                    	int	2Fh	; Multiplex - NETWORK REDIRECTOR - REMOVE REMOTE DIRECTORY
 23473                                  			; SS = DOS CS
 23474                                  			; SDA first filename pointer -> fully-qualified directory name
 23475                                  			; SDA CDS pointer -> current directory
 23476                                  			; Return: CF set on error, AX = DOS error code
 23477                                  			; CF clear if successful
 23478 0000395C C3                      	retn
 23479                                  ;ENDIF
 23480                                  
 23481                                  LOCAL_RMDIR:
 23482 0000395D E824DF                  	call	ECritDisk
 23483 00003960 C606[4C03]00            	MOV	byte [NoSetDir],0
 23484                                  	;mov	byte [SATTRIB],16h
 23485 00003965 C606[6D05]16            	MOV	byte [SATTRIB],attr_directory+attr_system+attr_hidden
 23486                                  					; Dir calls can find these
 23487 0000396A E85710                  	call	GETPATH
 23488 0000396D 7229                    	JC	short NOPATH		; Path not found
 23489 0000396F 7530                    	JNZ	short NOTDIRPATH	; Path not a DIR
 23490                                  
 23491                                  ; 06/04/2024
 23492                                  %if 0	
 23493                                  	MOV	DI,[DIRSTART]
 23494                                  	OR	DI,DI			; Root ?
 23495                                  	JNZ	short rmdir_get_buf	; No
 23496                                  	JMP	SHORT NOTDIRPATH
 23497                                  %else
 23498                                  	; 06/02/2024 - Retro DOS v5.0
 23499                                  	; PCDOS 7.1 IBMDOS.COM
 23500 00003971 8B3E[C205]              	mov	di,[DIRSTART]
 23501 00003975 09FF                    	or	di,di			; Root ?
 23502 00003977 7506                    	jnz	short LOCAL_RMDIR_cont	; No
 23503                                  	
 23504                                  	;cmp	word [DIRSTART_HW],0
 23505 00003979 393E[DC0A]              	cmp	[DIRSTART_HW],di ; 0
 23506 0000397D 7422                    	jz      short NOTDIRPATH ; root directory
 23507                                  
 23508                                  LOCAL_RMDIR_cont:
 23509                                  	;cmp	word [es:bp+0Fh],0
 23510 0000397F 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 23511 00003984 751E                    	jnz	short rmdir_get_buf	; not FAT32
 23512                                  	;cmp	di,[es:bp+35h]
 23513 00003986 263B7E35                	cmp	di,[es:bp+DPB.ROOT_CLUSTER]
 23514 0000398A 7518                    	jne	short rmdir_get_buf
 23515 0000398C 8B3E[DC0A]              	mov	di,[DIRSTART_HW]
 23516                                  	;cmp	di,[es:bp+37h]
 23517 00003990 263B7E37                	cmp	di,[es:bp+DPB.ROOT_CLUSTER+2]
 23518 00003994 750E                    	jne	short rmdir_get_buf
 23519 00003996 EB09                    	jmp	short NOTDIRPATH
 23520                                  %endif		
 23521                                  
 23522                                  NOPATH:
 23523                                  	;mov	ax,3
 23524 00003998 B80300                  	MOV	AX,error_path_not_found
 23525 0000399B E971FE                  	JMP	_BadRet
 23526                                  
 23527                                  NOTDIRPATHPOP:
 23528 0000399E 58                      	POP	AX  ; MSDOS 6.0		;F.C. >32mb
 23529 0000399F 58                      	POP	AX
 23530                                  NOTDIRPATHPOP2:
 23531 000039A0 58                      	POP	AX
 23532                                  NOTDIRPATH:
 23533 000039A1 E968FE                  	JMP	NODEACCERRJ
 23534                                  
 23535                                  rmdir_get_buf:
 23536 000039A4 C53E[E205]              	LDS	DI,[CURBUF]
 23537 000039A8 29FB                    	SUB	BX,DI		; Compute true offset
 23538 000039AA 53                      	PUSH	BX		; Save entry pointer
 23539                                  
 23540                                  ; 06/04/2024
 23541                                  %if 0		
 23542                                  	; MSDOS 6.0
 23543                                  	;push	word [di+8]
 23544                                  	PUSH	WORD [DI+BUFFINFO.buf_sector+2] ;F.C. >32mb
 23545                                  	
 23546                                  	; MSDOS 3.3 (& MSDOS 6.0)
 23547                                  	;push	word [di+6]
 23548                                  	PUSH	WORD [DI+BUFFINFO.buf_sector] ; Save sector number
 23549                                  %else
 23550                                  	; 06/02/2024 - Retro DOS v5.0
 23551                                  	; PCDOS 7.1 IBMDOS.COM
 23552                                  
 23553                                  	;les	di,[di+6]
 23554 000039AB C47D06                  	les	di,[di+BUFFINFO.buf_sector]
 23555 000039AE 06                      	push	es
 23556 000039AF 57                      	push	di
 23557                                  %endif
 23558                                  
 23559                                  ;hkn; SS is DOSDATA
 23560                                  	;context DS
 23561 000039B0 16                      	push	ss
 23562 000039B1 1F                      	pop	ds
 23563                                  	;context ES
 23564 000039B2 16                      	push	ss
 23565 000039B3 07                      	pop	es
 23566                                  
 23567                                  ;hkn; NAME1 is in DOSDATA
 23568 000039B4 BF[4B05]                	MOV	DI,NAME1
 23569                                  	;MOV	AL,'?' ; 3Fh
 23570                                  	;MOV	CX,11
 23571                                  	;REP	STOSB
 23572                                  	;XOR	AL,AL
 23573                                  	;STOSB				; Nul terminate it
 23574                                  	; 27/06/2024
 23575 000039B7 B83F00                  	mov	ax,3Fh
 23576 000039BA B90A00                  	mov	cx,10
 23577 000039BD F3AA                    	rep	stosb	; al = "?"
 23578 000039BF AB                      	stosw		; ah = 0
 23579                                  	;
 23580 000039C0 E81712                  	call	STARTSRCH		; Set search
 23581 000039C3 E8910D                  	call	GETENTRY		; Get start of directory
 23582 000039C6 72D6                    	JC	short NOTDIRPATHPOP	; Screw up
 23583 000039C8 8E1E[E405]              	MOV	DS,[CURBUF+2]
 23584 000039CC 89DE                    	MOV	SI,BX
 23585 000039CE AD                      	LODSW
 23586                                  	;CMP	AX,(' ' SHL 8) OR '.'   ; First entry '.'?
 23587 000039CF 3D2E20                  	cmp	ax,202Eh ; ". "
 23588 000039D2 75CA                    	JNZ	short NOTDIRPATHPOP	; Nope
 23589                                  	;add	si,30
 23590 000039D4 83C61E                  	ADD	SI,dir_entry.size-2 ; Next entry
 23591 000039D7 AD                      	LODSW
 23592                                  	;CMP	AX,('.' SHL 8) OR '.'   ; Second entry '..'?
 23593                                  	;cmp	ax, '..'
 23594 000039D8 3D2E2E                  	cmp	ax,2E2Eh
 23595 000039DB 75C1                    	JNZ	short NOTDIRPATHPOP	; Nope
 23596                                  
 23597                                  ;hkn; SS is DOSDATA
 23598                                  	;context DS
 23599 000039DD 16                      	push	ss
 23600 000039DE 1F                      	pop	ds
 23601 000039DF C706[4803]0200          	MOV	word [LASTENT],2	; Skip . and ..
 23602 000039E5 E86F0D                  	call	GETENTRY		; Get next entry
 23603 000039E8 72B4                    	JC	short NOTDIRPATHPOP	; Screw up
 23604                                  	;mov	byte [ATTRIB],16h
 23605 000039EA C606[6B05]16            	MOV	byte [ATTRIB],attr_directory+attr_hidden+attr_system
 23606 000039EF E81B0C                  	call	SRCH			; Do a search
 23607 000039F2 73AA                    	JNC	short NOTDIRPATHPOP	; Found another entry!
 23608 000039F4 803E[4A03]00            	CMP	byte [FAILERR],0
 23609 000039F9 75A3                    	JNZ	short NOTDIRPATHPOP	; Failure of search due to I 24 FAIL
 23610 000039FB C42E[8A05]              	LES	BP,[THISDPB]
 23611                                  	;;;
 23612                                  	; 06/02/2024 - Retro DOS v5.0
 23613                                  	; PCDOS 7.1 IBMDOS.COM
 23614 000039FF 8B1E[DC0A]              	mov	bx,[DIRSTART_HW]
 23615 00003A03 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 23616                                  	;;;
 23617 00003A07 8B1E[C205]              	MOV	BX,[DIRSTART]
 23618 00003A0B E8681E                  	call	RELEASE 		; Release data in sub dir
 23619 00003A0E 728E                    	JC	short NOTDIRPATHPOP	; Screw up
 23620                                  	;;;
 23621                                  	; 06/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 23622 00003A10 E878F9                  	call	update_fat32_fsinfo
 23623                                  	;;;
 23624 00003A13 5A                      	POP	DX			; Sector # of entry
 23625 00003A14 8F06[0706]              	POP	word [HIGH_SECTOR] ; MSDOS 6.0	; F.C. >32mb
 23626                                  	; 22/09/2023
 23627                                  	;;mov	byte [ALLOWED],18h
 23628                                  	;MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY ; *
 23629                                  	;XOR	AL,AL ; *		; Pre read
 23630                                  	;call	GETBUFFR		; Get sector back
 23631 00003A18 E8B42B                  	call	GETBUFFER ; *		; Pre Read
 23632 00003A1B 7283                    	JC	short NOTDIRPATHPOP2	; Screw up
 23633                                  
 23634                                  rmdir_fde:	; 06/02/2024
 23635 00003A1D C53E[E205]              	LDS	DI,[CURBUF]
 23636                                  	;or	byte [di+5],4
 23637 00003A21 804D0504                	OR	byte [DI+BUFFINFO.buf_flags],buf_isDIR
 23638 00003A25 5B                      	POP	BX			; Pointer to start of entry
 23639 00003A26 01FB                    	ADD	BX,DI			; Corrected
 23640 00003A28 C607E5                  	MOV	BYTE [BX],0E5H		; Free the entry
 23641                                  
 23642                                  ;DOS 3.3 FastOpen  6/16/86  F.C.
 23643                                  	; 03/03/2025
 23644                                  	;PUSH	DS
 23645                                  
 23646                                  ;hkn; SS is DOSDATA
 23647                                  	
 23648                                  	; 03/03/2025
 23649                                  	;context DS
 23650                                  	;push	ss
 23651                                  	;pop	ds
 23652                                  
 23653                                  	; 03/03/2025 (MiniDOS)
 23654                                  	; MSDOS 6.0
 23655                                  	;call	FastOpen_Delete 	; call fastopen to delete an entry
 23656                                  
 23657                                  	; 03/03/2025
 23658                                  	;POP	DS
 23659                                  ;DOS 3.3 FastOpen  6/16/86  F.C.
 23660                                  
 23661 00003A2B E99FFE                  	JMP	DIRUP			; In MKDIR, dirty buffer and flush
 23662                                  
 23663                                  ;============================================================================
 23664                                  ; DISK.ASM, MSDOS 6.0, 1991
 23665                                  ;============================================================================
 23666                                  ; 23/07/2018 - Retro DOS v3.0 
 23667                                  ; 04/05/2019 - Retro DOS v4.0
 23668                                  ; 06/02/2024 - Retro DOS v5.0
 23669                                  
 23670                                  ;	TITLE	DISK - Disk utility routines
 23671                                  ;	NAME	Disk
 23672                                  
 23673                                  ;**	Low level Read and write routines for local SFT I/O on files and devs
 23674                                  ;
 23675                                  ;	SWAPCON
 23676                                  ;	SWAPBACK
 23677                                  ;	DOS_READ
 23678                                  ;	DOS_WRITE
 23679                                  ;	get_io_sft
 23680                                  ;	DirRead
 23681                                  ;	FIRSTCLUSTER
 23682                                  ;	SET_BUF_AS_DIR
 23683                                  ;	FATSecRd
 23684                                  ;	DREAD
 23685                                  ;	CHECK_WRITE_LOCK
 23686                                  ;	CHECK_READ_LOCK
 23687                                  ;
 23688                                  ;	Revision history:
 23689                                  ;
 23690                                  ;		A000   version 4.00  Jan. 1988
 23691                                  ;
 23692                                  ;----------------------------------------------------------------------------
 23693                                  ;
 23694                                  ; M065 : B#5276. On raw read/write of a block of characters if a critical
 23695                                  ;		error happens, DOS retries the entire block assuming that
 23696                                  ;		zero characters were transferred. Modified the code to take
 23697                                  ;		into account the number of characters transfered before
 23698                                  ;		retrying the operation.
 23699                                  ;
 23700                                  ;----------------------------------------------------------------------------
 23701                                  ;
 23702                                  
 23703                                  ;Installed = TRUE
 23704                                  
 23705                                  ;Break	<SwapCon, Swap Back - Old-style I/O to files>
 23706                                  
 23707                                  ; **** Drivers for file input from devices ****
 23708                                  ;----------------------------------------------------------------------------
 23709                                  ;   Indicate that there is no more I/O occurring through another SFT outside
 23710                                  ;   of handles 0 and 1
 23711                                  ;
 23712                                  ;   Inputs:	DS is DOSDATA
 23713                                  ;   Outputs:	CONSWAP is set to false.
 23714                                  ;   Registers modified: none
 23715                                  ;----------------------------------------------------------------------------
 23716                                  
 23717                                  ; IBMDOS.COM (MSDOS 3.3) - Offset 3CF8h
 23718                                  
 23719                                  ; DOSCODE:71E3h (MSDOS 6.21, MSDOS.SYS)
 23720                                  ; 04/05/2019 - Retro DOS v4.0
 23721                                  
 23722                                  ; DOSCODE:71CFh (MSDOS 5.0, MSDOS.SYS)
 23723                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 23724                                  
 23725                                  SWAPBACK:
 23726 00003A2E C606[5703]00            	MOV	BYTE [CONSWAP],0	; signal no conswaps
 23727 00003A33 C3                      	retn
 23728                                  
 23729                                  ;----------------------------------------------------------------------------
 23730                                  ;
 23731                                  ; Procedure Name : SWAPCON
 23732                                  ;
 23733                                  ;   Copy ThisSFT to CONSFT for use by the 1-12 primitives.
 23734                                  ;
 23735                                  ;   Inputs:	ThisSFT as the sft of the desired file
 23736                                  ;		DS is DOSDATA
 23737                                  ;   Outputs:	CONSWAP is set.  CONSFT = ThisSFT.
 23738                                  ;   Registers modified: none
 23739                                  ;--------------------------------------------------------------------------
 23740                                  
 23741                                  SWAPCON:
 23742                                  	; MSDOS 3.3
 23743                                  	;push	es
 23744                                  	;push	di
 23745                                  	;mov	byte [CONSWAP],1
 23746                                  	;les	di,[THISSFT]
 23747                                  	;mov	word [CONSFT],di
 23748                                  	;mov	word [CONSFT+2],es
 23749                                  	;pop	di
 23750                                  	;pop	es
 23751                                  	;retn
 23752                                  
 23753                                  	; MSDOS 6.0
 23754 00003A34 C606[5703]01            	mov	byte [CONSWAP],1	; ConSwap = TRUE
 23755 00003A39 50                      	push	ax
 23756 00003A3A A1[9E05]                	mov	ax,[THISSFT]
 23757 00003A3D A3[E605]                	mov	[CONSFT],ax
 23758 00003A40 A1[A005]                	mov	ax,[THISSFT+2]
 23759 00003A43 A3[E805]                	mov	[CONSFT+2],ax
 23760 00003A46 58                      	pop	ax
 23761 00003A47 C3                      	retn
 23762                                  
 23763                                  ; DOSCODE:71FDh (MSDOS 6.21, MSDOS.SYS)
 23764                                  ; 04/05/2019 - Retro DOS v4.0
 23765                                  
 23766                                  ;Break	<DOS_READ -- MAIN READ ROUTINE AND DEVICE IN ROUTINES>
 23767                                  ;-----------------------------------------------------------------------------
 23768                                  ;
 23769                                  ; Inputs:
 23770                                  ;	ThisSFT set to the SFT for the file being used
 23771                                  ;	[DMAADD] contains transfer address
 23772                                  ;	CX = No. of bytes to read
 23773                                  ;	DS = DOSDATA
 23774                                  ; Function:
 23775                                  ;	Perform read operation
 23776                                  ; Outputs:
 23777                                  ;    Carry clear
 23778                                  ;	SFT Position and cluster pointers updated
 23779                                  ;	CX = No. of bytes read
 23780                                  ;	ES:DI point to SFT
 23781                                  ;    Carry set
 23782                                  ;	AX is error code
 23783                                  ;	CX = 0
 23784                                  ;	ES:DI point to SFT
 23785                                  ; DS preserved, all other registers destroyed
 23786                                  ;
 23787                                  ;-----------------------------------------------------------------------------
 23788                                  
 23789                                  ;hkn; called from fcbio.asm, handle.asm and dev.asm. DS is be set up.
 23790                                  
 23791                                  ; DOSCODE:71E9h (MSDOS 5.0, MSDOS.SYS)
 23792                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 23793                                  
 23794                                  ; 07/02/2024
 23795                                  ; 06/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 23796                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:7B76h
 23797                                  
 23798                                  ; (Windows ME IO.SYS - BIOSCODE:7997h)
 23799                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:71FDh)
 23800                                  
 23801                                  DOS_READ:
 23802 00003A48 C43E[9E05]              	LES	DI,[THISSFT]
 23803                                  
 23804                                  ; Verify that the sft has been opened in a mode that allows reading.
 23805                                  
 23806                                  	;mov	al,[es:di+2]
 23807 00003A4C 268A4502                	MOV	AL,[ES:DI+SF_ENTRY.sf_mode]
 23808                                  	;;and	al,0Fh	; (MSDOS 5.0 & 6.22)
 23809                                  	;AND	AL,access_mask
 23810                                  	; 06/02/2024 - Retro DOS v5.0
 23811                                  	; (PCDOS 7.1 & Win Me)
 23812 00003A50 2403                    	and	al,3	; open_mode_mask ?
 23813                                  
 23814                                  	;cmp	al,1
 23815 00003A52 3C01                    	CMP	AL,open_for_write
 23816 00003A54 7503                    	JNE	short READ_NO_MODE	; Is read or both
 23817 00003A56 E96406                  	jmp	SET_ACC_ERR
 23818                                  
 23819                                  READ_NO_MODE:
 23820 00003A59 E82405                  	call	SETUP
 23821 00003A5C E30B                    	JCXZ	NoIORet 		; no bytes to read - fast return
 23822 00003A5E E8BEDD                  	call	IsSFTNet
 23823 00003A61 7408                    	JZ	short LOCAL_READ
 23824                                  
 23825                                  ;IF NOT Installed
 23826                                  ;	transfer NET_READ
 23827                                  ;ELSE
 23828                                  	;mov	ax,1108h
 23829 00003A63 B80811                  	MOV	AX,(MultNET<<8)|8
 23830 00003A66 CD2F                    	int	2Fh	; Multiplex - NETWORK REDIRECTOR - READ FROM REMOTE FILE
 23831                                  			; ES:DI -> SFT
 23832                                  			; SFT DPB field -> DPB of drive containing file
 23833                                  			; CX = number of bytes, SS = DOS CS, SDA DTA field -> user buffer
 23834                                  			; Return: CF set on error, CX = bytes read
 23835 00003A68 C3                      	retn
 23836                                  ;ENDIF
 23837                                  
 23838                                  ; The user ended up requesting 0 bytes of input. We do nothing for this case
 23839                                  ; except return immediately.
 23840                                  
 23841                                  NoIORet:
 23842 00003A69 F8                      	CLC
 23843 00003A6A C3                      	retn
 23844                                  
 23845                                  LOCAL_READ:
 23846                                  	;test	word [es:di+5],80h
 23847                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device  ; Check for named device I/O
 23848 00003A6B 26F6450580              	test	byte [ES:DI+SF_ENTRY.sf_flags],devid_device ; 02/06/2019
 23849 00003A70 750E                    	JNZ	short READDEV
 23850                                  
 23851                                  	;mov	byte [EXTERR_LOCUS],2
 23852 00003A72 C606[2303]02            	MOV	byte [EXTERR_LOCUS],errLOC_Disk
 23853 00003A77 E80ADE                  	call	ECritDisk
 23854 00003A7A E8F705                  	call	DISKREAD
 23855                                  
 23856                                  critexit:
 23857                                  	;call	LCritDisk
 23858                                  	;retn
 23859                                  	; 16/12/2022
 23860 00003A7D E931DE                  	jmp	LCritDisk
 23861                                  
 23862                                  ; We are reading from a device. Examine the status of the device to see if we
 23863                                  ; can short-circuit the I/O. If the device in the EOF state or if it is the
 23864                                  ; null device, we can safely indicate no transfer.
 23865                                  
 23866                                  READDEV:
 23867                                  	;mov	byte [EXTERR_LOCUS],4
 23868 00003A80 C606[2303]04            	MOV	byte [EXTERR_LOCUS],errLOC_SerDev
 23869                                  	;mov	bl,[es:di+5]
 23870 00003A85 268A5D05                	MOV	BL,[ES:DI+SF_ENTRY.sf_flags]
 23871 00003A89 C43E[2C03]              	LES	DI,[DMAADD]
 23872                                  	;test	bl,40h
 23873 00003A8D F6C340                  	test	BL,devid_device_EOF	; End of file?
 23874 00003A90 7407                    	JZ	short ENDRDDEVJ3
 23875                                  	;test	bl,4
 23876 00003A92 F6C304                  	test	BL,devid_device_null	; NUL device?
 23877 00003A95 7405                    	JZ	short TESTRAW 		; NO
 23878 00003A97 30C0                    	XOR	AL,AL			; Indicate EOF by setting zero
 23879                                  ENDRDDEVJ3:
 23880                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility!)
 23881                                  	;JMP	short ENDRDDEVJ2
 23882                                  	; 16/12/2022
 23883 00003A99 E93F01                  	jmp	ENDRDDEV ; 04/05/2019
 23884                                  
 23885                                  ; We need to hit the device. Figure out if we do a raw read or we do the
 23886                                  ; bizarre std_con_string_input.
 23887                                  
 23888                                  TESTRAW:
 23889                                  	;test	bl,20h
 23890 00003A9C F6C320                  	test	BL,devid_device_raw	; Raw mode?
 23891 00003A9F 7508                    	JNZ	short DVRDRAW 		; Yes, let the device do all local editing
 23892                                  	;test	bl,1
 23893 00003AA1 F6C301                  	test	BL,devid_device_con_in	; Is it console device?
 23894 00003AA4 7458                    	JZ	short NOTRDCON
 23895 00003AA6 E96701                  	JMP	READCON
 23896                                  
 23897                                  DVRDRAW:
 23898 00003AA9 06                      	PUSH	ES
 23899 00003AAA 1F                      	POP	DS			; Xaddr to DS:DI
 23900                                  
 23901                                  	; 04/05/2019 - Retro DOS v4.0
 23902                                  
 23903                                  	; MSDOS 6.0
 23904                                  ;SR;
 23905                                  ;Check for win386 presence -- if present, do polled read of characters
 23906                                  
 23907 00003AAB 36F606[470F]01          	test	byte [ss:IsWin386],1 ; 19/05/2019
 23908 00003AB1 7408                    	jz	short ReadRawRetry	;not present
 23909 00003AB3 F6C301                  	test	bl,devid_device_con_in	;is it console device?
 23910 00003AB6 7403                    	jz	short ReadRawRetry	;no, do normal read
 23911 00003AB8 E9A800                  	jmp	do_polling		;yes, do win386 polling loop
 23912                                  
 23913                                  ReadRawRetry:
 23914                                  
 23915                                  ; 07/02/2024
 23916                                  %if 0
 23917                                  	MOV	BX,DI			; DS:BX transfer addr
 23918                                  	; 06/02/2024 ; *
 23919                                  	;XOR	AX,AX			; Media Byte, unit = 0
 23920                                  	;;MOV	DX,AX			; Start at 0
 23921                                  	;; 06/02/2024
 23922                                  	;cwd
 23923                                  	;call	SETREAD
 23924                                  	; 06/02/2024 ; *
 23925                                  	call	SETREAD_X
 23926                                  %else
 23927 00003ABB E82D15                  	call	SETREAD_XJ
 23928                                  %endif
 23929                                  
 23930 00003ABE 1E                      	PUSH	DS			; Save Seg part of Xaddr
 23931                                  
 23932                                  ;hkn; SS override
 23933 00003ABF 36C536[9E05]            	LDS	SI,[SS:THISSFT]
 23934 00003AC4 E8AE14                  	call	DEVIOCALL
 23935 00003AC7 89FA                    	MOV	DX,DI			; DS:DX is preserved by INT 24
 23936 00003AC9 B486                    	MOV	AH,86H			; Read error
 23937                                  
 23938                                  ;hkn; SS override
 23939 00003ACB 368B3E[5D03]            	MOV	DI,[SS:DEVCALL_REQSTAT]
 23940                                  	; MSDOS 3.3
 23941                                  	;test	di,8000h
 23942                                  	;jz	short CRDROK
 23943                                  	; MSDOS 6.0
 23944 00003AD0 09FF                    	or	di,di
 23945 00003AD2 7920                    	jns	short CRDROK		; no errors
 23946                                  	; MSDOS 3.3 (& MSDOS 6.0)
 23947 00003AD4 E8F221                  	call	CHARHARD
 23948                                  
 23949                                  ; 06/02/2024 - Retro DOS v5.0
 23950                                  %if 0
 23951                                  	MOV	DI,DX			; DS:DI is Xaddr
 23952                                  	; 04/05/2019
 23953                                  	; MSDOS 6.0
 23954                                  	add	di,[ss:CALLSCNT]	; update ptr and count to reflect the	M065
 23955                                  	sub	cx,[ss:CALLSCNT]	; number of chars xferred		M065
 23956                                  %else
 23957 00003AD7 368B3E[6C03]            	mov	di,[ss:CALLSCNT]
 23958 00003ADC 29F9                    	sub	cx,di			; update transfer count
 23959 00003ADE 01D7                    	add	di,dx			; update pointer
 23960                                  %endif
 23961                                  	; MSDOS 3.3 (& MSDOS 6.0)
 23962 00003AE0 08C0                    	OR	AL,AL
 23963 00003AE2 7410                    	JZ	short CRDROK		; Ignore
 23964 00003AE4 3C03                    	CMP	AL,3
 23965 00003AE6 7403                    	JZ	short CRDFERR 		; fail.
 23966 00003AE8 1F                      	POP	DS			; Recover saved seg part of Xaddr
 23967 00003AE9 EBD0                    	JMP	short ReadRawRetry	; Retry
 23968                                  
 23969                                  ; We have encountered a device-driver error. We have informed the user of it
 23970                                  ; and he has said for us to fail the system call.
 23971                                  
 23972                                  CRDFERR:
 23973 00003AEB 5F                      	POP	DI			; Clean stack
 23974                                  DEVIOFERR:
 23975                                  
 23976                                  ;hkn; SS override
 23977 00003AEC 36C43E[9E05]            	LES	DI,[SS:THISSFT]
 23978 00003AF1 E9C705                  	jmp	SET_ACC_ERR_DS
 23979                                  
 23980                                  CRDROK:
 23981 00003AF4 5F                      	POP	DI			; Chuck saved seg of Xaddr
 23982 00003AF5 89D7                    	MOV	DI,DX
 23983                                  
 23984                                  ;hkn; SS override
 23985 00003AF7 36033E[6C03]            	ADD	DI,[ss:CALLSCNT]	; Amount transferred
 23986                                  	;JMP	SHORT ENDRDDEVJ3
 23987                                  	; 16/12/2022
 23988 00003AFC EB63                    	jmp	short ENDRDDEVJ2
 23989                                  
 23990                                  ; We are going to do a cooked read on some character device. There is a
 23991                                  ; problem here, what does the data look like? Is it a terminal device, line
 23992                                  ; CR line CR line CR, or is it file data, line CR LF line CR LF? Does it have
 23993                                  ; a ^Z at the end which is data, or is the ^Z not data?  In any event we're
 23994                                  ; going to do this: Read in pieces up to CR (CRs included in data) or ^z (^z
 23995                                  ; included in data). this "simulates" the way con works in cooked mode
 23996                                  ; reading one line at a time. With file data, however, the lines will look
 23997                                  ; like, LF line CR. This is a little weird.
 23998                                  
 23999                                  NOTRDCON:
 24000                                  	;MOV	AX,ES
 24001                                  	;MOV	DS,AX
 24002                                  	; 07/02/2024
 24003 00003AFE 06                      	push	es
 24004 00003AFF 1F                      	pop	ds
 24005                                  
 24006                                  ; 07/02/2024
 24007                                  %if 0
 24008                                  	MOV	BX,DI
 24009                                  	; 06/02/2024 ; *
 24010                                  	;;XOR	DX,DX
 24011                                  	;;MOV	AX,DX
 24012                                  	;; 06/02/2024
 24013                                  	;xor	ax,ax
 24014                                  	;cwd
 24015                                  	PUSH	CX
 24016                                  	MOV	CX,1
 24017                                  	;call	SETREAD
 24018                                  	; 06/02/2024 ; *
 24019                                  	call	SETREAD_X
 24020                                  	POP	CX
 24021                                  %else
 24022 00003B00 51                      	push	cx
 24023 00003B01 B90100                  	mov	cx,1
 24024 00003B04 E8E414                  	call	SETREAD_XJ
 24025 00003B07 59                      	pop	cx
 24026                                  %endif
 24027                                  
 24028                                  ;hkn; SS override
 24029 00003B08 36C536[9E05]            	LDS	SI,[SS:THISSFT]
 24030                                  	;lds	si,[si+7]
 24031 00003B0D C57407                  	LDS	SI,[SI+SF_ENTRY.sf_devptr]
 24032                                  DVRDLP:
 24033 00003B10 E8961F                  	call	DSKSTATCHK
 24034 00003B13 E86214                  	call	DEVIOCALL2
 24035 00003B16 57                      	PUSH	DI			; Save "count" done
 24036 00003B17 B486                    	MOV	AH,86H
 24037                                  
 24038                                  ;hkn; SS override
 24039 00003B19 368B3E[5D03]            	MOV	DI,[SS:DEVCALL_REQSTAT]
 24040                                  	
 24041                                  	; MSDOS 3.3
 24042                                  	;test	di,8000h
 24043                                  	;jz	short CRDOK
 24044                                  	; MSDOS 6.0
 24045 00003B1E 09FF                    	or	di,di
 24046 00003B20 7917                    	jns	short CRDOK
 24047                                  	
 24048 00003B22 E8A421                  	call	CHARHARD
 24049 00003B25 5F                      	POP	DI
 24050                                  
 24051                                  ;hkn; SS override
 24052 00003B26 36C706[6C03]0100        	MOV	word [SS:CALLSCNT],1
 24053 00003B2D 3C01                    	CMP	AL,1
 24054 00003B2F 74DF                    	JZ	short DVRDLP		; Retry
 24055 00003B31 3C03                    	CMP	AL,3
 24056 00003B33 74B7                    	JZ	short DEVIOFERR		; FAIL
 24057 00003B35 30C0                    	XOR	AL,AL			; Ignore, Pick some random character
 24058 00003B37 EB12                    	JMP	SHORT DVRDIGN
 24059                                  
 24060                                  CRDOK:
 24061 00003B39 5F                      	POP	DI
 24062                                  
 24063                                  ;hkn; SS override
 24064 00003B3A 36833E[6C03]01          	CMP	word [SS:CALLSCNT],1
 24065                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility!)
 24066 00003B40 751F                    	JNZ	short ENDRDDEVJ2
 24067                                  	; 16/12/2022
 24068                                  	;jnz	short ENDRDDEV ; 24/07/2019
 24069                                  
 24070 00003B42 1E                      	PUSH	DS
 24071                                  
 24072                                  ;hkn; SS override
 24073 00003B43 368E1E[6A03]            	MOV	DS,[SS:CALLXAD+2]
 24074 00003B48 8A05                    	MOV	AL,[DI]			; Get the character we just read
 24075 00003B4A 1F                      	POP	DS
 24076                                  DVRDIGN:
 24077                                  
 24078                                  ;hkn; SS override
 24079 00003B4B 36FF06[6803]            	INC	WORD [SS:CALLXAD]	; Next character
 24080 00003B50 36C706[5D03]0000        	MOV	word [SS:DEVCALL_REQSTAT],0
 24081 00003B57 47                      	INC	DI			; Next character
 24082 00003B58 3C1A                    	CMP	AL,1Ah			; ^Z?
 24083                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility!)
 24084 00003B5A 7405                    	JZ	short ENDRDDEVJ2	; Yes, done zero set (EOF)
 24085                                  	; 16/12/2022
 24086                                  	;jz	short ENDRDDEV ; 24/07/2019	
 24087 00003B5C 3C0D                    	CMP	AL,c_CR  ; 0Dh		; CR?
 24088 00003B5E E0B0                    	LOOPNZ	DVRDLP			; Loop if no, else done
 24089 00003B60 40                      	INC	AX			; Resets zero flag so NOT EOF, unless
 24090                                  					;  AX=FFFF which is not likely
 24091                                  ENDRDDEVJ2:
 24092                                  	; 16/12/2022
 24093                                  	;JMP	short ENDRDDEV		; changed short to long for win386
 24094                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 24095 00003B61 EB78                    	jmp	ENDRDDEV
 24096                                  
 24097                                  	; 04/05/2019
 24098                                  
 24099                                  	; MSDOS 6.0
 24100                                  ;SR;
 24101                                  ;Polling code for raw read on CON when WIN386 is present
 24102                                  ;
 24103                                  ;At this point -- ds:di is transfer address
 24104                                  ;		  cx is count
 24105                                  
 24106                                  do_polling:
 24107                                  
 24108                                  ; 07/02/2024
 24109                                  %if 0
 24110                                  	mov	bx,di			;ds:bx is Xfer address
 24111                                  	; 06/02/2024 ; *
 24112                                  	;xor	ax,ax
 24113                                  	;;mov	dx,ax
 24114                                  	;; 06/02/2024
 24115                                  	;cwd
 24116                                  	;call	SETREAD			;prepare device packet
 24117                                  	; 06/02/2024 ; *
 24118                                  	call	SETREAD_X
 24119                                  %else
 24120 00003B63 E88514                  	call	SETREAD_XJ
 24121                                  %endif
 24122                                  
 24123                                  do_io:
 24124                                  ;Change read to a NON-DESTRUCTIVE READ, NO WAIT
 24125                                  
 24126 00003B66 26C6470205              	mov	byte [es:bx+2],DEVRDND ; 5 ;Change command code
 24127 00003B6B 1E                      	push	ds
 24128 00003B6C 36C536[9E05]            	lds	si,[ss:THISSFT]		;get device header
 24129 00003B71 E80114                  	call	DEVIOCALL		;call device driver
 24130 00003B74 1F                      	pop	ds
 24131                                  	
 24132                                  	;test	word [es:bx+3],8000h
 24133                                  	; 16/12/2022
 24134                                  	;test	byte [es:bx+4],80h
 24135 00003B75 26F6470480              	test	byte [es:bx+SRHEAD.REQSTAT+1],STERR>>8 
 24136                                  	;test	word [es:bx+SRHEAD.REQSTAT],STERR ;check if error
 24137 00003B7A 7413                    	jz	short check_busy	;no
 24138                                  
 24139 00003B7C 1E                      	push	ds
 24140 00003B7D 89FA                    	mov	dx,di
 24141                                  
 24142                                  invoke_charhard:	; 07/02/2024
 24143                                  	;invoke charhard		;invoke int 24h handler
 24144 00003B7F E84721                  	call	CHARHARD
 24145 00003B82 89D7                    	mov	di,dx
 24146 00003B84 08C0                    	or	al,al
 24147 00003B86 744D                    	jz	short pop_done_read	;ignore by user, assume read done
 24148 00003B88 3C03                    	cmp	al,3
 24149 00003B8A 7438                    	jz	short devrderr		;user asked to fail
 24150 00003B8C 1F                      	pop	ds
 24151 00003B8D EBD7                    	jmp	short do_io		;user asked to retry
 24152                                  
 24153                                  check_busy:
 24154                                  	;test	word [es:bx+3],200h
 24155                                  	; 16/12/2022
 24156 00003B8F 26F6470402              	test	byte [es:bx+SRHEAD.REQSTAT+1],02h
 24157                                  	;test	word [es:bx+SRHEAD.REQSTAT],0200h ;see if busy bit set
 24158 00003B94 7537                    	jnz	short no_char		;yes, no character available
 24159                                  
 24160                                  ;Character is available. Read in 1 character at a time until all characters
 24161                                  ;are read in or no character is available
 24162                                  
 24163 00003B96 26C6470204              	mov	byte [es:bx+2],DEVRD ; 4 ;command code is READ now
 24164 00003B9B 26C747120100            	mov	word [es:bx+18],1	;change count to 1 character
 24165 00003BA1 1E                      	push	ds
 24166 00003BA2 36C536[9E05]            	lds	si,[ss:THISSFT]
 24167 00003BA7 E8CB13                  	call	DEVIOCALL
 24168                                  
 24169 00003BAA 89FA                    	mov	dx,di
 24170 00003BAC B486                    	mov	ah,86h
 24171                                  	;mov	di,[es:bx+3]
 24172 00003BAE 268B7F03                	mov	di,[es:bx+SRHEAD.REQSTAT] ;get returned status
 24173 00003BB2 F7C70080                	test	di,STERR ; 8000h	;was there an error during read?
 24174                                  	;jz	short next_char		;no,read next character
 24175                                  	; 07/02/2024
 24176 00003BB6 75C7                    	jnz	short invoke_charhard
 24177                                  
 24178                                  ; 07/02/2024
 24179                                  %if 0
 24180                                  	;invoke	charhard		;invoke int 24h handler
 24181                                  	call	CHARHARD
 24182                                  	mov	di,dx			;restore di
 24183                                  	or	al,al			;
 24184                                  	jz	short pop_done_read	;ignore by user,assume read is done
 24185                                  	cmp	al,3
 24186                                  	jz	short devrderr		;user issued a 'fail',indicate error
 24187                                  	pop	ds
 24188                                  	jmp	short do_io		;user issued a retry
 24189                                  %endif
 24190                                  
 24191                                  next_char:
 24192 00003BB8 1F                      	pop	ds
 24193 00003BB9 89D7                    	mov	di,dx
 24194 00003BBB 49                      	dec	cx			;decrement count
 24195                                  	;jcxz	done_read		;all characters read in
 24196                                  	; 07/02/2024
 24197 00003BBC 7418                    	jz	short done_read
 24198 00003BBE 26FF470E                	inc	word [es:bx+14]		;update transfer address
 24199 00003BC2 EBA2                    	jmp	short do_io		;read next character in
 24200                                  
 24201                                  devrderr:
 24202 00003BC4 5F                      	pop	di			;discard segment address
 24203 00003BC5 36C43E[9E05]            	les	di,[ss:THISSFT]
 24204                                  	;transfer SET_ACC_ERR_DS	;indicate error
 24205 00003BCA E9EE04                  	jmp     SET_ACC_ERR_DS
 24206                                  
 24207                                  no_char:
 24208                                  ;Since no character is available, we let win386 switch the VM out
 24209                                  
 24210 00003BCD 50                      	push	ax
 24211 00003BCE B484                    	mov	ah,84h	; Microsoft Networks - KEYBOARD BUSY LOOP
 24212 00003BD0 CD2A                    	int	2Ah			;indicate idle to WIN386
 24213                                  
 24214                                  ;When control returns from WIN386, we continue the raw read
 24215                                  
 24216 00003BD2 58                      	pop	ax
 24217 00003BD3 EB91                    	jmp	short do_io	; 27/06/2024
 24218                                  
 24219                                  pop_done_read:
 24220 00003BD5 1F                      	pop	ds
 24221                                  done_read:
 24222 00003BD6 36033E[6C03]            	add	di,[ss:CALLSCNT] ; 19/05/2019
 24223                                  
 24224                                  	; 16/12/2022
 24225                                  
 24226                                  	;jmp	ENDRDDEVJ3	;jump back to normal DOS raw read exit
 24227                                  	;jmp	ENDRDDEV ; 04/05/2019
 24228                                  
 24229                                  	; 04/05/2019 - Retro DOS v4.0
 24230                                  ENDRDDEV:
 24231 00003BDB 16                      	push	ss
 24232 00003BDC 1F                      	pop	ds
 24233 00003BDD EB1F                    	jmp	short endrddev1
 24234                                  
 24235                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 24236                                  	;jmp	ENDRDDEVJ3	;jump back to normal DOS raw read exit
 24237                                  
 24238                                  TRANBUF:
 24239 00003BDF AC                      	LODSB
 24240 00003BE0 AA                      	STOSB
 24241 00003BE1 3C0D                    	CMP	AL,c_CR ; 0Dh	; Check for carriage return
 24242 00003BE3 7503                    	JNZ	short NORMCH
 24243 00003BE5 C6040A                  	MOV	BYTE [SI],c_LF ; 0Ah
 24244                                  NORMCH:
 24245 00003BE8 3C0A                    	CMP	AL,c_LF ; 0Ah
 24246 00003BEA E0F3                    	LOOPNZ	TRANBUF
 24247 00003BEC 7507                    	JNZ	short ENDRDCON
 24248 00003BEE 31F6                    	XOR	SI,SI		; Cause a new buffer to be read
 24249 00003BF0 E8E0DF                  	call	OUTT		; Transmit linefeed
 24250 00003BF3 0C01                    	OR	AL,1		; Clear zero flag--not end of file
 24251                                  ENDRDCON:
 24252                                  ;hkn; SS is DOSDATA
 24253 00003BF5 16                      	push	ss
 24254 00003BF6 1F                      	pop	ds
 24255 00003BF7 E834FE                  	CALL	SWAPBACK
 24256 00003BFA 8936[2200]              	MOV	[CONTPOS],SI
 24257                                  
 24258                                  	; 16/12/2022
 24259                                  ;ENDRDDEV:
 24260                                  ;;hkn; SS is DOSDATA
 24261                                  ;	push	ss
 24262                                  ;	pop	ds
 24263                                  endrddev1:	; 04/05/2019
 24264 00003BFE 893E[B805]              	MOV	[NEXTADD],DI
 24265 00003C02 7509                    	JNZ	short SETSFTC 	; Zero set if Ctrl-Z found in input
 24266 00003C04 C43E[9E05]              	LES	DI,[THISSFT]
 24267                                  	;and	byte [es:di+5],0BFh
 24268 00003C08 26806505BF              	AND	BYTE [ES:DI+SF_ENTRY.sf_flags],~devid_device_EOF
 24269                                  				; Mark as no more data available
 24270                                  SETSFTC:
 24271                                  	; 31/07/2019
 24272                                  	;call	SETSFT
 24273                                  	;retn
 24274 00003C0D E95A05                  	jmp	SETSFT
 24275                                  
 24276                                  ; 16/12/2022
 24277                                  %if 0
 24278                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 24279                                  ENDRDDEV:
 24280                                  ;hkn; SS is DOSDATA
 24281                                  	push	ss
 24282                                  	pop	ds
 24283                                  	MOV	[NEXTADD],DI
 24284                                  	JNZ	short SETSFTC 	; Zero set if Ctrl-Z found in input
 24285                                  	LES	DI,[THISSFT]
 24286                                  	;and	byte [es:di+5],0BFh
 24287                                  	AND	BYTE [ES:DI+SF_ENTRY.sf_flags],~devid_device_EOF
 24288                                  				; Mark as no more data available
 24289                                  SETSFTC:
 24290                                  	;call	SETSFT
 24291                                  	;retn
 24292                                  	jmp	SETSFT	
 24293                                  %endif
 24294                                  
 24295                                  READCON:
 24296 00003C10 E821FE                  	CALL	SWAPCON
 24297 00003C13 8B36[2200]              	MOV	SI,[CONTPOS]
 24298 00003C17 09F6                    	OR	SI,SI
 24299 00003C19 75C4                    	JNZ	short TRANBUF
 24300 00003C1B 803E[7B02]80            	CMP	BYTE [CONBUF],128 ; 80h
 24301 00003C20 7406                    	JZ	short GETBUF
 24302 00003C22 C706[7B02]80FF          	MOV	WORD [CONBUF],0FF80H ; Set up 128-byte buffer with no template
 24303                                  GETBUF:
 24304 00003C28 51                      	PUSH	CX
 24305 00003C29 06                      	PUSH	ES
 24306 00003C2A 57                      	PUSH	DI
 24307                                  
 24308                                  ;hkn; CONBUF is in DOSDATA
 24309 00003C2B BA[7B02]                	MOV	DX,CONBUF
 24310                                  
 24311 00003C2E E817DD                  	call	_$STD_CON_STRING_INPUT	; Get input buffer
 24312 00003C31 5F                      	POP	DI
 24313 00003C32 07                      	POP	ES
 24314 00003C33 59                      	POP	CX
 24315                                  
 24316                                  ;hkn; CONBUF is in DOSDATA
 24317 00003C34 BE[7D02]                	MOV	SI,CONBUF+2
 24318                                  
 24319 00003C37 803C1A                  	CMP	BYTE [SI],1AH	; Check for Ctrl-Z in first character
 24320 00003C3A 75A3                    	JNZ	short TRANBUF
 24321 00003C3C B01A                    	MOV	AL,1AH
 24322 00003C3E AA                      	STOSB
 24323 00003C3F 4F                      	DEC	DI
 24324 00003C40 B00A                    	MOV	AL,c_LF
 24325 00003C42 E88EDF                  	call	OUTT		; Send linefeed
 24326 00003C45 31F6                    	XOR	SI,SI
 24327 00003C47 EBAC                    	JMP	short ENDRDCON ; 04/05/2019
 24328                                  
 24329                                  ; 24/07/2018 - Retro DOS v3.0
 24330                                  
 24331                                  ;Break	<DOS_WRITE -- MAIN WRITE ROUTINE AND DEVICE OUT ROUTINES>
 24332                                  ;---------------------------------------------------------------------------
 24333                                  ;
 24334                                  ; Procedure Name : DOS_WRITE
 24335                                  ;
 24336                                  ; Inputs:
 24337                                  ;	ThisSFT set to the SFT for the file being used
 24338                                  ;	[DMAADD] contains transfer address
 24339                                  ;	CX = No. of bytes to write
 24340                                  ; Function:
 24341                                  ;	Perform write operation
 24342                                  ;	NOTE: If CX = 0 on input, file is truncated or grown
 24343                                  ;		to current sf_position
 24344                                  ; Outputs:
 24345                                  ;    Carry clear
 24346                                  ;	SFT Position and cluster pointers updated
 24347                                  ;	CX = No. of bytes written
 24348                                  ;	ES:DI point to SFT
 24349                                  ;    Carry set
 24350                                  ;	AX is error code
 24351                                  ;	CX = 0
 24352                                  ;	ES:DI point to SFT
 24353                                  ; DS preserved, all other registers destroyed
 24354                                  ;---------------------------------------------------------------------------
 24355                                  	
 24356                                  ; 04/05/2019 - Retro DOS v4.0
 24357                                  ; DOSCODE:742Ch (MSDOS 6.21, MSDOS.SYS)
 24358                                  
 24359                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 24360                                  ; DOSCODE:7418h (MSDOS 5.0, MSDOS.SYS)
 24361                                  
 24362                                  ; 08/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 24363                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:7D8Fh
 24364                                  
 24365                                  DOS_WRITE:
 24366 00003C49 C43E[9E05]              	LES	DI,[THISSFT]
 24367                                  	;mov	al,[ES:DI+2]
 24368 00003C4D 268A4502                	MOV	AL,[ES:DI+SF_ENTRY.sf_mode]
 24369                                  	;;and	al,0Fh
 24370                                  	;AND	AL,access_mask
 24371                                  	; 07/02/2024 - Retro DOS v5.0
 24372                                  	; (PCDOS 7.1 & Win Me)
 24373 00003C51 2403                    	and	al,3	; open_mode_mask ?
 24374                                  	;cmp	al,0
 24375 00003C53 3C00                    	CMP	AL,open_for_read
 24376 00003C55 7503                    	JNE	short Check_FCB_RO		 ;Is write or both
 24377                                  BadMode:
 24378 00003C57 E96304                  	jmp	SET_ACC_ERR
 24379                                  
 24380                                  ; NOTE: The following check for writting to a Read Only File is performed
 24381                                  ;	    ONLY on FCBs!!!!
 24382                                  ;	We ALLOW writes to Read Only files via handles to allow a CREATE
 24383                                  ;	    of a read only file which can then be written to.
 24384                                  ;	This is OK because we are NOT ALLOWED to OPEN a RO file via handles
 24385                                  ;	    for writting, or RE-CREATE an EXISTING RO file via handles. Thus,
 24386                                  ;	    CREATing a NEW RO file, or RE-CREATing an existing file which
 24387                                  ;	    is NOT RO to be RO, via handles are the only times we can write
 24388                                  ;	    to a read-only file.
 24389                                  
 24390                                  Check_FCB_RO:
 24391                                  	;;test	word [es:di+2],8000h
 24392                                  	;TEST	word [ES:DI+SF_ENTRY.sf_mode],sf_isFCB
 24393                                  	;JZ	short WRITE_NO_MODE	; Not an FCB
 24394                                  	
 24395                                  	;test	byte [es:di+3],80h
 24396 00003C5A 26F6450380              	TEST	byte [ES:DI+SF_ENTRY.sf_mode+1],(sf_isFCB>>8)
 24397 00003C5F 7407                    	JZ	short WRITE_NO_MODE	; Not an FCB
 24398                                  
 24399                                  	;test	byte [es:di+4],1
 24400 00003C61 26F6450401              	TEST	byte [ES:DI+SF_ENTRY.sf_attr],attr_read_only
 24401 00003C66 75EF                    	JNZ	short BadMode 		; Can't write to Read_Only files via FCB
 24402                                  WRITE_NO_MODE:
 24403 00003C68 E81503                  	call	SETUP
 24404 00003C6B E8B1DB                  	call	IsSFTNet
 24405 00003C6E 7406                    	JZ	short LOCAL_WRITE
 24406                                  
 24407                                  ;IF NOT Installed
 24408                                  ;	transfer NET_WRITE
 24409                                  ;ELSE
 24410                                  	;mov	ax,1109h
 24411 00003C70 B80911                  	MOV	AX,(MultNET<<8)|9
 24412 00003C73 CD2F                    	int	2Fh	; Multiplex - NETWORK REDIRECTOR - WRITE TO REMOTE FILE
 24413                                  			; ES:DI -> SFT
 24414                                  			; SFT DPB field -> DPB of drive containing file
 24415                                  			; CX = number of bytes, SS = DOS CS, SDA DTA field -> user buffer
 24416                                  			; Return: CF set on error, CX = bytes written
 24417 00003C75 C3                      	retn
 24418                                  ;ENDIF
 24419                                  
 24420                                  LOCAL_WRITE:
 24421                                  	;;test	word [es:di+5],80h
 24422                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device
 24423                                  	;jnz	short WRTDEV
 24424                                  
 24425                                  	;test	byte [es:di+5],80h
 24426 00003C76 26F6450580              	TEST	byte [ES:DI+SF_ENTRY.sf_flags],devid_device ; Check for named device I/O
 24427 00003C7B 756D                    	jnz	short WRTDEV
 24428                                  
 24429                                  	;mov	byte [EXTERR_LOCUS],2
 24430 00003C7D C606[2303]02            	MOV	byte [EXTERR_LOCUS],errLOC_Disk
 24431 00003C82 E8FFDB                  	call	ECritDisk
 24432                                  
 24433 00003C85 E8A805                  	call	DISKWRITE
 24434                                  
 24435                                  	; 04/05/2019 - Retro DOS v4.0
 24436                                  
 24437                                  	; MSDOS 6.0
 24438                                  ; Extended Open
 24439 00003C88 7210                    	JC	short nocommit
 24440                                  	
 24441 00003C8A C43E[9E05]              	LES	DI,[THISSFT]
 24442                                  	
 24443                                  	;;test	word [ES:DI+2],4000h
 24444                                  	;TEST	word [ES:DI+SF_ENTRY.sf_mode],AUTO_COMMIT_WRITE
 24445                                  	;JZ	short nocommit
 24446                                  	
 24447                                  	;test	byte [ES:DI+3],40h
 24448 00003C8E 26F6450340              	TEST	byte [ES:DI+SF_ENTRY.sf_mode+1],(AUTO_COMMIT_WRITE>>8)
 24449 00003C93 7405                    	JZ	short nocommit
 24450                                  	
 24451 00003C95 51                      	PUSH	CX
 24452 00003C96 E81DFB                  	call	DOS_COMMIT
 24453 00003C99 59                      	POP	CX
 24454                                  nocommit:
 24455                                  ; Extended Open
 24456                                  	;call	LCritDisk
 24457                                  	;retn
 24458                                  	; 18/12/2022
 24459 00003C9A E914DC                  	jmp	LCritDisk
 24460                                  
 24461                                  DVWRTRAW:
 24462 00003C9D 31C0                    	XOR	AX,AX			; Media Byte, unit = 0
 24463 00003C9F E88A13                  	call	SETWRITE
 24464 00003CA2 1E                      	PUSH	DS			; Save seg of transfer
 24465                                  
 24466                                  ;hkn; SS override
 24467 00003CA3 36C536[9E05]            	LDS	SI,[SS:THISSFT]
 24468 00003CA8 E8CA12                  	call	DEVIOCALL		; DS:SI -> DEVICE
 24469                                  
 24470 00003CAB 89FA                    	MOV	DX,DI			; Offset part of Xaddr saved in DX
 24471 00003CAD B487                    	MOV	AH,87H
 24472                                  
 24473                                  ;hkn; SS override
 24474 00003CAF 368B3E[5D03]            	MOV	DI,[SS:DEVCALL_REQSTAT]
 24475                                  
 24476                                  	; MSDOS 3.3
 24477                                  	;test	di,8000h
 24478                                  	;jz	short CWRTROK
 24479                                  
 24480                                  	; MSDOS 6.0
 24481 00003CB4 09FF                    	or	di,di
 24482 00003CB6 791F                    	jns	short CWRTROK
 24483                                  	
 24484                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24485 00003CB8 E80E20                  	call	CHARHARD
 24486                                  
 24487                                  	; 04/05/2019  - Retro DOS v4.0
 24488                                  
 24489                                  	; 08/02/2024
 24490 00003CBB 368B3E[6C03]            	mov	di,[ss:CALLSCNT]
 24491                                  	; MSDOS 6.0
 24492                                  	;sub	cx,[ss:CALLSCNT]	; update ptr & count to reflect	M065
 24493 00003CC0 29F9                    	sub	cx,di
 24494 00003CC2 89D3                    	mov	bx,dx			; number of chars xferred	M065
 24495                                  	;add	bx,[ss:CALLSCNT]	;				M065
 24496 00003CC4 01FB                    	add	bx,di
 24497 00003CC6 89DF                    	mov	di,bx			;				M065
 24498                                  	
 24499                                  	; MSDOS 3.3
 24500                                  	;MOV	BX,DX			; Recall transfer addr		M065
 24501                                  
 24502                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24503 00003CC8 08C0                    	OR	AL,AL
 24504 00003CCA 740B                    	JZ	short CWRTROK 		; Ignore
 24505 00003CCC 3C03                    	CMP	AL,3
 24506 00003CCE 7403                    	JZ	short CWRFERR
 24507 00003CD0 1F                      	POP	DS			; Recover saved seg of transfer
 24508 00003CD1 EBCA                    	JMP	short DVWRTRAW		; Try again
 24509                                  CWRFERR:
 24510 00003CD3 58                      	POP	AX			; Chuck saved seg of transfer
 24511 00003CD4 E914FE                  	JMP	CRDFERR 		; Will pop one more stack element
 24512                                  CWRTROK:
 24513 00003CD7 58                      	POP	AX			; Chuck saved seg of transfer
 24514 00003CD8 1F                      	POP	DS
 24515 00003CD9 A1[6C03]                	MOV	AX,[CALLSCNT]		; Get actual number of bytes transferred
 24516                                  ENDWRDEV:
 24517 00003CDC C43E[9E05]              	LES	DI,[THISSFT]
 24518 00003CE0 89C1                    	MOV	CX,AX
 24519                                  	;call	ADDREC
 24520                                  	;retn
 24521                                  	; 16/12/2022
 24522                                  	; 10/06/2019
 24523 00003CE2 E9B404                  	jmp	ADDREC
 24524                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 24525                                  	;call	ADDREC
 24526                                  	;retn
 24527                                  	
 24528                                  WRTNUL:
 24529 00003CE5 89CA                    	MOV	DX,CX			; Entire transfer done
 24530                                  WRTCOOKJ:
 24531 00003CE7 E98C00                  	JMP	WRTCOOKDONE
 24532                                  WRTDEV:
 24533                                  	;mov	byte [EXTERR_LOCUS],4
 24534 00003CEA C606[2303]04            	MOV	byte [EXTERR_LOCUS],errLOC_SerDev
 24535                                  	;or	byte [es:di+5],40h
 24536 00003CEF 26804D0540              	OR	BYTE [ES:DI+SF_ENTRY.sf_flags],devid_device_EOF
 24537                                  					; Reset EOF for input
 24538                                  	;mov	bl,[es:di+5]
 24539 00003CF4 268A5D05                	MOV	BL,[ES:DI+SF_ENTRY.sf_flags]
 24540 00003CF8 31C0                    	XOR	AX,AX
 24541 00003CFA E3E0                    	JCXZ	ENDWRDEV		; problem of creating on a device.
 24542 00003CFC 1E                      	PUSH	DS
 24543 00003CFD 88D8                    	MOV	AL,BL
 24544 00003CFF C51E[2C03]              	LDS	BX,[DMAADD]		; Xaddr to DS:BX
 24545 00003D03 89DF                    	MOV	DI,BX			; Xaddr to DS:DI
 24546                                  	; 27/06/2024 (PCDOS 7.1 IBMDOS.COM)
 24547                                  	; 08/02/2024
 24548 00003D05 99                      	cwd
 24549                                  	;XOR	DX,DX			; Set starting point
 24550                                  	;test	al,20h
 24551 00003D06 A820                    	test	AL,devid_device_raw	; Raw?
 24552                                  	;JZ	short TEST_DEV_CON
 24553                                  	;JMP	DVWRTRAW
 24554                                  	; 16/12/2022
 24555 00003D08 7593                    	jnz	short DVWRTRAW
 24556                                  	; 17/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 24557                                  	;JZ	short TEST_DEV_CON
 24558                                  	;JMP	short DVWRTRAW
 24559                                  
 24560                                  TEST_DEV_CON:
 24561                                  	;test	al,2
 24562 00003D0A A802                    	test	AL,devid_device_con_out ; Console output device?
 24563 00003D0C 756E                    	jnz	short WRITECON
 24564                                  	;test	al,4
 24565 00003D0E A804                    	test	AL,devid_device_null
 24566 00003D10 75D3                    	JNZ	short WRTNUL
 24567 00003D12 89D0                    	MOV	AX,DX
 24568 00003D14 803F1A                  	CMP	BYTE [BX],1Ah		; ^Z?
 24569 00003D17 74CE                    	JZ	short WRTCOOKJ		; Yes, transfer nothing
 24570 00003D19 51                      	PUSH	CX
 24571 00003D1A B90100                  	MOV	CX,1
 24572 00003D1D E80C13                  	call	SETWRITE
 24573 00003D20 59                      	POP	CX
 24574                                  
 24575                                  ;hkn; SS override
 24576 00003D21 36C536[9E05]            	LDS	SI,[SS:THISSFT]
 24577                                  ;
 24578                                  ;SR; Removed X25 support from here
 24579                                  ;
 24580                                  	;lds	si,[si+7]
 24581 00003D26 C57407                  	LDS	SI,[SI+SF_ENTRY.sf_devptr]
 24582                                  DVWRTLP:
 24583 00003D29 E87D1D                  	call	DSKSTATCHK
 24584 00003D2C E84912                  	call	DEVIOCALL2
 24585 00003D2F 57                      	PUSH	DI
 24586 00003D30 B487                    	MOV	AH,87H
 24587                                  
 24588                                  ;hkn; SS override
 24589 00003D32 368B3E[5D03]            	MOV	DI,[SS:DEVCALL_REQSTAT]
 24590                                  	
 24591                                  	; MSDOS 3.3
 24592                                  	;test	di,8000h
 24593                                  	;jz	short CWROK
 24594                                  
 24595                                  	; MSDOS 6.0
 24596 00003D37 09FF                    	or	di,di
 24597 00003D39 7916                    	jns	short CWROK
 24598                                  	
 24599                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24600 00003D3B E88B1F                  	call	CHARHARD
 24601 00003D3E 5F                      	POP	DI
 24602                                  
 24603                                  ;hkn; SS override
 24604 00003D3F 36C706[6C03]0100        	MOV	word [SS:CALLSCNT],1
 24605 00003D46 3C01                    	CMP	AL,1
 24606 00003D48 74DF                    	JZ	short DVWRTLP 	; Retry
 24607 00003D4A 08C0                    	OR	AL,AL
 24608 00003D4C 740C                    	JZ	short DVWRTIGN	; Ignore
 24609                                  	; 10/08/2018
 24610 00003D4E E99AFD                  	JMP	CRDFERR 	; Fail, pops one stack element
 24611                                  CWROK:
 24612 00003D51 5F                      	POP	DI
 24613                                  
 24614                                  ;hkn; SS override
 24615 00003D52 36833E[6C03]00          	CMP	word [SS:CALLSCNT],0
 24616 00003D58 741C                    	JZ	short WRTCOOKDONE
 24617                                  DVWRTIGN:
 24618 00003D5A 42                      	INC	DX
 24619                                  
 24620                                  ;hkn; SS override for CALLXAD
 24621 00003D5B 36FF06[6803]            	INC	WORD [SS:CALLXAD]
 24622 00003D60 47                      	INC	DI
 24623 00003D61 1E                      	PUSH	DS
 24624 00003D62 368E1E[6A03]            	MOV	DS,[SS:CALLXAD+2]
 24625 00003D67 803D1A                  	CMP	BYTE [DI],1Ah	; ^Z?
 24626 00003D6A 1F                      	POP	DS
 24627 00003D6B 7409                    	JZ	short WRTCOOKDONE
 24628                                  
 24629                                  ;hkn; SS override
 24630 00003D6D 36C706[5D03]0000        	MOV	word [SS:DEVCALL_REQSTAT],0
 24631 00003D74 E2B3                    	LOOP	DVWRTLP
 24632                                  WRTCOOKDONE:
 24633 00003D76 89D0                    	MOV	AX,DX
 24634 00003D78 1F                      	POP	DS
 24635 00003D79 E960FF                  	JMP	ENDWRDEV ; 10/08/2018
 24636                                  
 24637                                  WRITECON:
 24638 00003D7C 1E                      	PUSH	DS
 24639                                  
 24640                                  ;hkn; SS is DOSDATA
 24641 00003D7D 16                      	push	ss
 24642 00003D7E 1F                      	pop	ds
 24643 00003D7F E8B2FC                  	CALL	SWAPCON
 24644 00003D82 1F                      	POP	DS
 24645 00003D83 89DE                    	MOV	SI,BX
 24646 00003D85 51                      	PUSH	CX
 24647                                  WRCONLP:
 24648 00003D86 AC                      	LODSB
 24649 00003D87 3C1A                    	CMP	AL,1Ah		; ^Z?
 24650 00003D89 7405                    	JZ	short CONEOF
 24651 00003D8B E845DE                  	call	OUTT
 24652 00003D8E E2F6                    	LOOP	WRCONLP
 24653                                  CONEOF:
 24654 00003D90 58                      	POP	AX			; Count
 24655 00003D91 1F                      	POP	DS
 24656 00003D92 29C8                    	SUB	AX,CX			; Amount actually written
 24657 00003D94 E897FC                  	CALL	SWAPBACK
 24658 00003D97 E942FF                  	JMP	ENDWRDEV
 24659                                  
 24660                                  ;---------------------------------------------------------------------------
 24661                                  ;
 24662                                  ; Procedure Name : get_io_sft
 24663                                  ;
 24664                                  ;   Convert JFN number in BX to sf_entry in DS:SI We get the normal SFT if
 24665                                  ;   CONSWAP is FALSE or if the handle desired is 2 or more. Otherwise, we
 24666                                  ;   retrieve the sft from ConSFT which is set by SwapCon.
 24667                                  ;
 24668                                  ;---------------------------------------------------------------------------
 24669                                  
 24670                                  ; 04/05/2019 - Retro DOS v4.0
 24671                                  ; DOSCODE:7583h (MSDOS 6.21, MSDOS.SYS)
 24672                                  ; 17/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 24673                                  ; DOSCODE:756Fh (MSDOS 5.0, MSDOS.SYS)
 24674                                  
 24675                                  GET_IO_SFT:
 24676                                  	;test	byte [SS:CONSWAP],0FFh
 24677 00003D9A 36803E[5703]00          	cmp	byte [SS:CONSWAP],0			;smr;SS Override
 24678 00003DA0 7512                    	JNZ	short GetRedir
 24679                                  GetNormal:
 24680 00003DA2 16                      	push	ss
 24681 00003DA3 1F                      	pop	ds
 24682 00003DA4 06                      	PUSH	ES
 24683 00003DA5 57                      	PUSH	DI
 24684 00003DA6 E8AF35                  	call	SFFromHandle
 24685 00003DA9 7206                    	JC	short RET44P
 24686 00003DAB 8CC6                    	MOV	SI,ES
 24687 00003DAD 8EDE                    	MOV	DS,SI
 24688 00003DAF 89FE                    	MOV	SI,DI
 24689                                  RET44P:
 24690 00003DB1 5F                      	POP	DI
 24691 00003DB2 07                      	POP	ES
 24692 00003DB3 C3                      	retn
 24693                                  GetRedir:
 24694 00003DB4 83FB01                  	CMP	BX,1
 24695 00003DB7 77E9                    	JA	short GetNormal
 24696 00003DB9 36C536[E605]            	LDS	SI,[SS:CONSFT]
 24697 00003DBE F8                      	CLC
 24698                                  get_io_sft_retn:
 24699 00003DBF C3                      	retn
 24700                                  
 24701                                  ;Break	<DIRREAD -- READ A DIRECTORY SECTOR>
 24702                                  ;---------------------------------------------------------------------------
 24703                                  ;
 24704                                  ; Procedure Name : DIRREAD
 24705                                  ;
 24706                                  ; Inputs:
 24707                                  ;	AX = Directory block number (relative to first block of directory)
 24708                                  ;	ES:BP = Base of drive parameters
 24709                                  ;	[DIRSEC] = First sector of first cluster of directory
 24710                                  ;	[CLUSNUM] = Next cluster
 24711                                  ;	[CLUSFAC] = Sectors/Cluster
 24712                                  ; Function:
 24713                                  ;	Read the directory block into [CURBUF].
 24714                                  ; Outputs:
 24715                                  ;	[NXTCLUSNUM] = Next cluster (after the one skipped to)
 24716                                  ;	[SECCLUSPOS] Set
 24717                                  ;	ES:BP unchanged
 24718                                  ;	[CURBUF] Points to Buffer with dir sector
 24719                                  ;	Carry set if error (user said FAIL to I 24)
 24720                                  ; DS preserved, all other registers destroyed.
 24721                                  ;---------------------------------------------------------------------------
 24722                                  
 24723                                  ;hkn; called from dir.asm. DS already set up to DOSDATA.
 24724                                  
 24725                                  ; 08/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 24726                                  
 24727                                  DIRREAD:
 24728                                  
 24729                                  ; Note that ClusFac is the sectors per cluster. This is NOT necessarily
 24730                                  ; the same as what is in the DPB! In the case of the root directory, we have
 24731                                  ; ClusFac = # sectors in the root directory. The root directory is detected
 24732                                  ; by DIRStart = 0.
 24733                                  
 24734 00003DC0 31D2                    	XOR	DX,DX
 24735                                  	; 08/02/2024 (PCDOS 7.1)
 24736 00003DC2 3916[DC0A]              	cmp	[DIRSTART_HW],dx
 24737 00003DC6 7509                    	jnz	short SubDir
 24738                                  	;CMP	word [DIRSTART],0
 24739                                  	; 21/09/2023
 24740 00003DC8 3916[C205]              	cmp	[DIRSTART],dx ; 0
 24741 00003DCC 7503                    	jnz	short SubDir
 24742 00003DCE 92                      	XCHG	AX,DX
 24743 00003DCF EB0C                    	JMP	short DoRead
 24744                                  
 24745                                  ; Convert the sector number in AX into cluster and sector-within-cluster pair
 24746                                  
 24747                                  SubDir:
 24748 00003DD1 88C2                    	MOV	DL,AL
 24749                                  	;and	dl,[es:bp+4]
 24750 00003DD3 26225604                	AND	DL,[ES:BP+DPB.CLUSTER_MASK]
 24751                                  
 24752                                  ;	(DX) = sector-in-cluster
 24753                                  
 24754                                  	;mov	cl,[es:bp+5]
 24755 00003DD7 268A4E05                	MOV	CL,[ES:BP+DPB.CLUSTER_SHIFT]
 24756 00003DDB D3E8                    	SHR	AX,CL
 24757                                  
 24758                                  ;	(DX) = position in cluster
 24759                                  ;	(AX) = number of clusters to skip
 24760                                  
 24761                                  DoRead:
 24762 00003DDD 8816[7305]              	MOV	[SECCLUSPOS],DL
 24763 00003DE1 89C1                    	MOV	CX,AX
 24764 00003DE3 88D4                    	MOV	AH,DL
 24765                                  
 24766                                  ;	(CX) = number of clusters to skip.
 24767                                  ;	(AH) = remainder
 24768                                  
 24769                                  	; 04/05/2019 - Retro DOS v4.0
 24770                                  
 24771                                  ; 08/02/2024
 24772                                  %if 0
 24773                                  	; MSDOS 6.0
 24774                                  	;MOV	DX,[DIRSEC+2]	     	  ;>32mb
 24775                                  	;MOV	[HIGH_SECTOR],DX	  ;>32mb
 24776                                  	;MOV	DX,[DIRSEC]
 24777                                  	;ADD	DL,AH
 24778                                  	;ADC	DH,0
 24779                                  	;ADC	word [HIGH_SECTOR],0	  ;>32mb
 24780                                  	; 21/09/2023
 24781                                  	xor	bx,bx ; 0
 24782                                  	mov	dx,[DIRSEC]
 24783                                  	add	dl,ah
 24784                                  	adc	dh,bl ; 0
 24785                                  	adc	bx,[DIRSEC+2]
 24786                                  	mov	[HIGH_SECTOR],bx
 24787                                  
 24788                                  	MOV	BX,[CLUSNUM]
 24789                                  	MOV	[NXTCLUSNUM],BX
 24790                                  	JCXZ	FIRSTCLUSTER
 24791                                  %else
 24792                                  	; 08/02/2024 (PCDOS 7.1)
 24793 00003DE5 8B1E[DE0A]              	mov	bx,[CLUSNUM_HW]
 24794 00003DE9 891E[E00A]              	mov	[NXTCLUSNUM_HW],bx
 24795 00003DED 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 24796 00003DF1 8B16[C005]              	mov	dx,[DIRSEC+2]
 24797 00003DF5 8916[0706]              	mov	[HIGH_SECTOR],dx
 24798 00003DF9 8B16[BE05]              	mov	dx,[DIRSEC]
 24799 00003DFD 00E2                    	add	dl,ah
 24800 00003DFF 80D600                  	adc	dh,0
 24801 00003E02 8316[0706]00            	adc	word [HIGH_SECTOR],0
 24802 00003E07 8B1E[BC05]              	mov	bx,[CLUSNUM]
 24803 00003E0B 891E[DC05]              	mov	[NXTCLUSNUM],bx
 24804 00003E0F E339                    	jcxz	FIRSTCLUSTER
 24805                                  %endif
 24806                                  
 24807                                  SKPCLLP:
 24808 00003E11 E87321                  	call	UNPACK
 24809 00003E14 72A9                    	jc	short get_io_sft_retn
 24810                                  	;;;
 24811                                  	; 08/02/2024 (PCDOS 7.1)
 24812 00003E16 FF36[E80A]              	push	word [CLUSTNUM_HW]
 24813 00003E1A 8F06[F20A]              	pop	word [CLUSTERS_HW]
 24814 00003E1E FF36[EC0A]              	push	word [CCONTENT_HW]
 24815 00003E22 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 24816                                  	;;;
 24817 00003E26 87FB                    	XCHG	BX,DI
 24818 00003E28 E83321                  	call	IsEOF			; test for eof based on fat size
 24819 00003E2B 7302                    	JAE	short HAVESKIPPED
 24820 00003E2D E2E2                    	LOOP	SKPCLLP
 24821                                  HAVESKIPPED:
 24822 00003E2F 891E[DC05]              	MOV	[NXTCLUSNUM],BX
 24823                                  	;;;
 24824                                  	; 08/02/2024 (PCDOS 7.1)
 24825 00003E33 8B1E[E80A]              	mov	bx,[CLUSTNUM_HW]
 24826 00003E37 891E[E00A]              	mov	[NXTCLUSNUM_HW],bx
 24827                                  	;
 24828 00003E3B 8B1E[F20A]              	mov	bx,[CLUSTERS_HW]
 24829 00003E3F 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 24830                                  	;;;
 24831 00003E43 89FA                    	MOV	DX,DI
 24832 00003E45 88E3                    	MOV	BL,AH
 24833 00003E47 E80418                  	call	FIGREC
 24834                                  
 24835                                  	;entry	FIRSTCLUSTER
 24836                                  
 24837                                  FIRSTCLUSTER:
 24838                                  	; 22/09/2023
 24839                                  	;;mov	byte [ALLOWED],18h
 24840                                  	;MOV	byte [ALLOWED],Allowed_RETRY+Allowed_FAIL ; *
 24841                                  	;XOR	AL,AL ; *	; Indicate pre-read
 24842                                  	;call	GETBUFFR
 24843 00003E4A E88227                  	call	GETBUFFER ; *	; pre-read
 24844                                  	;jc	short get_io_sft_retn
 24845                                  	; 08/02/2024
 24846 00003E4D 720C                    	jc	short dirread_retn
 24847                                  
 24848                                  	;entry	SET_BUF_AS_DIR
 24849                                  
 24850                                  SET_BUF_AS_DIR:
 24851                                  
 24852                                  ;	Set the type of CURBUF to be a directory sector.
 24853                                  ;	Only flags are modified.
 24854                                  
 24855 00003E4F 1E                      	PUSH	DS
 24856 00003E50 56                      	PUSH	SI
 24857 00003E51 C536[E205]              	LDS	SI,[CURBUF]
 24858                                  	;or	byte [si+5],4
 24859 00003E55 804C0504                	OR	byte [SI+BUFFINFO.buf_flags],buf_isDIR	; Clears carry
 24860 00003E59 5E                      	POP	SI
 24861 00003E5A 1F                      	POP	DS
 24862                                  dirread_retn:
 24863 00003E5B C3                      	retn
 24864                                  
 24865                                  ;Break	<FATSECRD -- READ A FAT SECTOR>
 24866                                  ;----------------------------------------------------------------------------
 24867                                  ;
 24868                                  ; Procedure Name : FATSECRD
 24869                                  ; Inputs:
 24870                                  ;	Same as DREAD
 24871                                  ;	DS:BX = Transfer address
 24872                                  ;	CX = Number of sectors
 24873                                  ;	DX = Absolute record number
 24874                                  ;	ES:BP = Base of drive parameters
 24875                                  ; Function:
 24876                                  ;	Calls BIOS to perform FAT read.
 24877                                  ; Outputs:
 24878                                  ;	Same as DREAD
 24879                                  ;---------------------------------------------------------------------------
 24880                                  
 24881                                  	; 04/05/2019 - Retro DOS v4.0
 24882                                  	; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 24883                                  
 24884                                  	; 09/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 24885                                  
 24886                                  FATSECRD:
 24887                                  ;hkn; SS override
 24888                                  	;mov	byte [ss:ALLOWED],18h
 24889 00003E5C 36C606[4B03]18          	MOV	byte [SS:ALLOWED],Allowed_RETRY+Allowed_FAIL
 24890 00003E62 89CF                    	MOV	DI,CX
 24891                                  	;mov	cl,[es:bp+8]
 24892 00003E64 268A4E08                	MOV	CL,[ES:BP+DPB.FAT_COUNT]
 24893                                  	; MSDOS 3.3
 24894                                  	;;mov	al,[es:bp+0Fh]
 24895                                  	;MOV	AL,[ES:BP+DPB.FAT_SIZE]
 24896                                  	;XOR	AH,AH
 24897                                  	; MSDOS 6.0
 24898                                  	;mov	ax,[es:bp+0Fh]
 24899 00003E68 268B460F                	MOV	AX,[ES:BP+DPB.FAT_SIZE] ;>32mb
 24900 00003E6C 30ED                    	XOR	CH,CH
 24901                                  	;;;
 24902                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 24903 00003E6E 09C0                    	or	ax,ax
 24904 00003E70 7509                    	jnz	short FATSECRD_cont	; not FAT32
 24905                                  	;test	byte [es:bp+23h],80h
 24906 00003E72 26F6462380              	test	byte [es:bp+DPB.EXT_FLAGS],80h ; (FAT32 bs extd flags bit 7)
 24907 00003E77 7402                    	jz      short FATSECRD_cont
 24908                                  	;mov	cx,1           		; only one FAT is active
 24909 00003E79 B101                    	mov	cl,1
 24910                                  FATSECRD_cont:
 24911 00003E7B 36FF36[0706]            	push	word [ss:HIGH_SECTOR]
 24912                                  	;;;
 24913 00003E80 52                      	PUSH	DX
 24914                                  NXTFAT:
 24915                                  	; MSDOS 6.0
 24916                                  ;hkn; SS override
 24917                                  	; 09/02/2024 (PCDOS 7.1)
 24918                                  	;MOV	word [SS:HIGH_SECTOR],0	;>32mb FAT sectors cannot exceed
 24919 00003E81 51                      	PUSH	CX			;32mb
 24920 00003E82 50                      	PUSH	AX
 24921                                  	;;;
 24922                                  	; 08/02/2024 (PCDOS 7.1 IBMDOS.COM)
 24923 00003E83 36FF36[0706]            	push	word [ss:HIGH_SECTOR]
 24924 00003E88 52                      	push	dx
 24925                                  	;;;
 24926 00003E89 89F9                    	MOV	CX,DI
 24927 00003E8B E88600                  	call	DSKREAD
 24928                                  	;;;
 24929                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 24930 00003E8E 5A                      	pop	dx
 24931 00003E8F 368F06[0706]            	pop	word [ss:HIGH_SECTOR]
 24932                                  	;;;
 24933 00003E94 58                      	POP	AX
 24934 00003E95 59                      	POP	CX
 24935 00003E96 7440                    	JZ	short RET41P		; Carry clear
 24936                                  	;;;
 24937                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 24938 00003E98 09C0                    	or	ax,ax
 24939 00003E9A 7511                    	jnz	short NXTFAT2	; not FAT32
 24940                                  	;add	dx,[es:bp+31h]
 24941 00003E9C 26035631                	add	dx,[es:bp+DPB.FAT32_SIZE]
 24942 00003EA0 50                      	push	ax
 24943                                  	;mov	ax,[es:bp+33h]
 24944 00003EA1 268B4633                	mov	ax,[es:bp+DPB.FAT32_SIZE+2]
 24945 00003EA5 361106[0706]            	adc	[ss:HIGH_SECTOR],ax
 24946 00003EAA 58                      	pop	ax
 24947 00003EAB EB08                    	jmp	short NXTFAT3
 24948                                  NXTFAT2:
 24949                                  	;;;
 24950 00003EAD 01C2                    	ADD	DX,AX
 24951                                  	;;;
 24952                                  	; 09/02/2024 (PCDOS 7.1)
 24953 00003EAF 368316[0706]00          	adc	word [ss:HIGH_SECTOR],0
 24954                                  NXTFAT3:
 24955                                  	;;;
 24956 00003EB5 E2CA                    	LOOP	NXTFAT
 24957 00003EB7 5A                      	POP	DX
 24958                                  	;;;
 24959                                  	; 09/02/2024 (PCDOS 7.1)
 24960 00003EB8 368F06[0706]            	pop	word [ss:HIGH_SECTOR]
 24961                                  	;;;
 24962 00003EBD 89F9                    	MOV	CX,DI
 24963                                  
 24964                                  ; NOTE FALL THROUGH
 24965                                  
 24966                                  ;Break	<DREAD -- DO A DISK READ>
 24967                                  ;---------------------------------------------------------------------------
 24968                                  ;
 24969                                  ; Procedure Name : DREAD
 24970                                  ;
 24971                                  ; Inputs:
 24972                                  ;	DS:BX = Transfer address
 24973                                  ;	CX = Number of sectors
 24974                                  ;	DX = Absolute record number	      (LOW)
 24975                                  ;	[HIGH_SECTOR] = Absolute record number (HIGH)
 24976                                  ;	ES:BP = Base of drive parameters
 24977                                  ;	[ALLOWED] must be set in case call to HARDERR needed
 24978                                  ; Function:
 24979                                  ;	Calls BIOS to perform disk read. If BIOS reports
 24980                                  ;	errors, will call HARDERRRW for further action.
 24981                                  ; Outputs:
 24982                                  ;	Carry set if error (currently user FAILED to INT 24)
 24983                                  ; DS,ES:BP preserved. All other registers destroyed.
 24984                                  ;---------------------------------------------------------------------------
 24985                                  
 24986                                  	;entry	DREAD
 24987                                  DREAD:
 24988 00003EBF E85200                  	call	DSKREAD
 24989 00003EC2 7497                    	jz	short dirread_retn	; Carry clear
 24990                                  ;hkn; SS override
 24991 00003EC4 36C606[7505]00          	MOV	BYTE [SS:READOP],0	; Read
 24992 00003ECA E89A00                  	call	HARDERRRW
 24993 00003ECD 3C01                    	CMP	AL,1			; Check for retry
 24994 00003ECF 74EE                    	JZ	short DREAD
 24995                                  
 24996                                  fail_ignore:	; 09/02/2024
 24997 00003ED1 3C03                    	CMP	AL,3			; Check for FAIL
 24998 00003ED3 F8                      	CLC
 24999 00003ED4 7501                    	JNZ	short NO_CAR		; Ignore
 25000 00003ED6 F9                      	STC
 25001                                  NO_CAR:
 25002 00003ED7 C3                      	retn
 25003                                  
 25004                                  	; 09/02/2024 - Retro DOS v5.0
 25005                                  RET41P: 
 25006 00003ED8 5A                      	POP	DX
 25007                                  	;;;
 25008                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25009 00003ED9 368F06[0706]            	pop	word [ss:HIGH_SECTOR]
 25010                                  	;;;
 25011 00003EDE C3                      	retn
 25012                                  
 25013                                  ; 24/07/2018 - Retro DOS v3.0
 25014                                  
 25015                                  ;Break	<CHECK_WRITE_LOCK>
 25016                                  ;---------------------------------------------------------------------------
 25017                                  ;
 25018                                  ; Procedure Name : CHECK_WRITE_LOCK
 25019                                  ;
 25020                                  ; Inputs:
 25021                                  ;	output of SETUP
 25022                                  ;	ES:DI -> SFT
 25023                                  ; Function:
 25024                                  ;	check write lock
 25025                                  ; Outputs:
 25026                                  ;	Carry set if error
 25027                                  ;	Carry clear if ok
 25028                                  ;
 25029                                  ;----------------------------------------------------------------------------
 25030                                  
 25031                                  	; 04/05/2019 - Retro DOS v4.0
 25032                                  	; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 25033                                  
 25034                                  CHECK_WRITE_LOCK:
 25035                                  	; MSDOS 6.0
 25036                                  	;test	byte [es:di+4],8
 25037 00003EDF 26F6450408              	TEST	byte [ES:DI+SF_ENTRY.sf_attr],attr_volume_id ;volume id
 25038                                  	;JZ	short write_cont			     ;no
 25039                                  	;;call	SET_ACC_ERR_DS
 25040                                  	;;retn
 25041                                  	;;jnz	SET_ACC_ERR_DS
 25042                                  	; 19/08/2018
 25043                                  	;jz	short write_cont
 25044                                  	;jmp	SET_ACC_ERR_DS
 25045                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 25046 00003EE4 7403                    	JZ	short write_cont
 25047                                  	;call	SET_ACC_ERR_DS
 25048                                  	;retn
 25049                                  	; 16/12/2022
 25050 00003EE6 E9D201                  	jmp	SET_ACC_ERR_DS
 25051                                  
 25052                                  write_cont:				;
 25053 00003EE9 51                      	PUSH	CX			;save reg
 25054 00003EEA 09C9                    	OR	CX,CX			;
 25055 00003EEC 7501                    	JNZ	short Not_Truncate	;
 25056 00003EEE 49                      	dec	cx			;(cx) = -1; check for lock on whole file
 25057                                  Not_Truncate:				;
 25058 00003EEF B080                    	MOV	AL,80H			;check write access
 25059 00003EF1 E87541                  	call	LOCK_CHECK		;check lock
 25060 00003EF4 59                      	POP	CX			;restore reg
 25061 00003EF5 7305                    	JNC	short WRITE_OK		;lock ok
 25062 00003EF7 E87301                  	call	WRITE_LOCK_VIOLATION	;issue I24
 25063 00003EFA 73ED                    	JNC	short write_cont	;retry
 25064                                  WRITE_OK:				;
 25065 00003EFC C3                      	retn				;
 25066                                  
 25067                                  ;Break	<CHECK_READ_LOCK>
 25068                                  ;---------------------------------------------------------------------------
 25069                                  ;
 25070                                  ; Procedure Name : CHECK_READ_LOC
 25071                                  ;
 25072                                  ; Inputs:
 25073                                  ;	ES:DI -> SFT
 25074                                  ;	output of SETUP
 25075                                  ; Function:
 25076                                  ;	check read lock
 25077                                  ; Outputs:
 25078                                  ;	Carry set if error
 25079                                  ;	Carry clear if ok
 25080                                  ;----------------------------------------------------------------------------
 25081                                  
 25082                                  CHECK_READ_LOCK:
 25083                                  	; MSDOS 6.0
 25084                                  	;test	byte [es:di+4],8
 25085 00003EFD 26F6450408              	TEST	byte [ES:DI+SF_ENTRY.sf_attr],attr_volume_id ;volume id
 25086                                  	;JZ	short do_retry			   	     ; no
 25087                                  	;;call	SET_ACC_ERR
 25088                                  	;;retn
 25089                                  	;;jnz	SET_ACC_ERR
 25090                                  	; 16/12/2022
 25091                                  	; 28/07/2019
 25092 00003F02 7403                    	jz	short do_retry
 25093 00003F04 E9B601                  	jmp	SET_ACC_ERR
 25094                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 25095                                  	;JZ	short do_retry
 25096                                  	;call	SET_ACC_ERR
 25097                                  	;retn
 25098                                  do_retry:				;
 25099 00003F07 30C0                    	xor	al,al			;check read access
 25100 00003F09 E85D41                  	call	LOCK_CHECK		;check lock
 25101 00003F0C 7305                    	JNC	short READLOCK_OK 	;lock ok
 25102 00003F0E E83C01                  	call	READ_LOCK_VIOLATION	;issue I24
 25103 00003F11 73F4                    	JNC	short do_retry		;retry
 25104                                  READLOCK_OK:				;
 25105                                  dw_ret_label:	; 09/02/2024
 25106 00003F13 C3                      	retn				;
 25107                                  
 25108                                  ;============================================================================
 25109                                  ; DISK2.ASM, MSDOS 6.0, 1991
 25110                                  ;============================================================================
 25111                                  ; 24/07/2018 - Retro DOS v3.0
 25112                                  ; 04/05/2019 - Retro DOS v4.0
 25113                                  
 25114                                  ;	TITLE	DISK2 - Disk utility routines
 25115                                  ;	NAME	Disk2
 25116                                  
 25117                                  ;**	Low level Read and write routines for local SFT I/O on files and devs
 25118                                  ;
 25119                                  ;	DskRead
 25120                                  ;	DWRITE
 25121                                  ;	DSKWRITE
 25122                                  ;	HarderrRW
 25123                                  ;	SETUP
 25124                                  ;	BREAKDOWN
 25125                                  ;	READ_LOCK_VIOLATION
 25126                                  ;	WRITE_LOCK_VIOLATION
 25127                                  ;	DISKREAD
 25128                                  ;	SET_ACC_ERR_DS
 25129                                  ;	SET_ACC_ERR
 25130                                  ;	SETSFT
 25131                                  ;	SETCLUS
 25132                                  ;	AddRec
 25133                                  ;
 25134                                  ;	Revision history:
 25135                                  ;
 25136                                  ;		AN000 version 4.00 Jan. 1988
 25137                                  ;		M039 DB 10/17/90 - Disk read/write optimization
 25138                                  
 25139                                  ; 04/05/2019 - Retro DOS v4.0
 25140                                  ; DOSCODE:7699h (MSDOS 6.21, MSDOS.SYS)
 25141                                  ; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 25142                                  ; DOSCODE:7685h (MSDOS 5.0, MSDOS.SYS)
 25143                                  
 25144                                  ;Break	<DSKREAD -- PHYSICAL DISK READ>
 25145                                  ;---------------------------------------------------------------------------
 25146                                  ;
 25147                                  ; Procedure Name : DSKREAD
 25148                                  ;
 25149                                  ; Inputs:
 25150                                  ;	DS:BX = Transfer addr
 25151                                  ;	CX = Number of sectors
 25152                                  ;	[HIGH_SECTOR] = Absolute record number (HIGH)
 25153                                  ;	DX = Absolute record number	       (LOW)
 25154                                  ;	ES:BP = Base of drive parameters
 25155                                  ; Function:
 25156                                  ;	Call BIOS to perform disk read
 25157                                  ; Outputs:
 25158                                  ;	DI = CX on entry
 25159                                  ;	CX = Number of sectors unsuccessfully transfered
 25160                                  ;	AX = Status word as returned by BIOS (error code in AL if error)
 25161                                  ;	Zero set if OK (from BIOS) (carry clear)
 25162                                  ;	Zero clear if error (carry clear)
 25163                                  ; SI Destroyed, others preserved
 25164                                  ;---------------------------------------------------------------------------
 25165                                  
 25166                                  DSKREAD:
 25167 00003F14 51                      	PUSH	CX
 25168                                  	;mov	ah,[es:bp+17h] ; 04/05/2019
 25169 00003F15 268A6617                	MOV	AH,[ES:BP+DPB.MEDIA]
 25170                                  	;mov	al,[es:bp+1]
 25171 00003F19 268A4601                	MOV	AL,[ES:BP+DPB.UNIT]
 25172 00003F1D 53                      	PUSH	BX
 25173 00003F1E 06                      	PUSH	ES
 25174 00003F1F E8D710                  	call	SETREAD
 25175 00003F22 EB22                    	JMP	short DODSKOP
 25176                                  
 25177                                  ;Break	<DWRITE -- SEE ABOUT WRITING>
 25178                                  ;--------------------------------------------------------------------------
 25179                                  ;
 25180                                  ; Procedure Name : DWRITE
 25181                                  ;
 25182                                  ; Inputs:
 25183                                  ;	DS:BX = Transfer address
 25184                                  ;	CX = Number of sectors
 25185                                  ;	[HIGH_SECTOR] = Absolute record number (HIGH)
 25186                                  ;	DX = Absolute record number	       (LOW)
 25187                                  ;	ES:BP = Base of drive parameters
 25188                                  ;	[ALLOWED] must be set in case HARDERR called
 25189                                  ; Function:
 25190                                  ;	Calls BIOS to perform disk write. If BIOS reports
 25191                                  ;	errors, will call HARDERRRW for further action.
 25192                                  ; Output:
 25193                                  ;	Carry set if error (currently, user FAILed to I 24)
 25194                                  ; BP preserved. All other registers destroyed.
 25195                                  ;----------------------------------------------------------------------------
 25196                                  
 25197                                  	;entry	DWRITE
 25198                                  DWRITE:
 25199 00003F24 E81100                  	CALL	DSKWRITE
 25200 00003F27 74EA                    	jz	short dw_ret_label	; Carry clear (retz)
 25201                                  
 25202                                  ;hkn; SS override
 25203 00003F29 36C606[7505]01          	MOV	BYTE [SS:READOP],1	; Write
 25204 00003F2F E83500                  	call	HARDERRRW
 25205 00003F32 3C01                    	CMP	AL,1			; Check for retry
 25206 00003F34 74EE                    	JZ	short DWRITE
 25207                                  
 25208                                  ; 09/02/2024
 25209                                  %if 0
 25210                                  	CMP	AL,3			; Check for FAIL
 25211                                  	CLC
 25212                                  	JNZ	short NO_CAR2 		; Ignore
 25213                                  	STC
 25214                                  NO_CAR2:
 25215                                  dw_ret_label:
 25216                                  	retn
 25217                                  %else
 25218                                  	; 09/02/2024 - Retro DOS v5.0
 25219 00003F36 EB99                    	jmp	short fail_ignore
 25220                                  %endif
 25221                                  
 25222                                  ;Break	<DSKWRITE -- PHYSICAL DISK WRITE>
 25223                                  ;---------------------------------------------------------------------------
 25224                                  ;
 25225                                  ; Procedure Name : DSKWRITE
 25226                                  ;
 25227                                  ; Inputs:
 25228                                  ;	DS:BX = Transfer addr
 25229                                  ;	CX = Number of sectors
 25230                                  ;	DX = Absolute record number	       (LOW)
 25231                                  ;	[HIGH_SECTOR] = Absolute record number (HIGH)
 25232                                  ;	ES:BP = Base of drive parameters
 25233                                  ; Function:
 25234                                  ;	Call BIOS to perform disk read
 25235                                  ; Outputs:
 25236                                  ;	DI = CX on entry
 25237                                  ;	CX = Number of sectors unsuccessfully transfered
 25238                                  ;	AX = Status word as returned by BIOS (error code in AL if error)
 25239                                  ;	Zero set if OK (from BIOS) (carry clear)
 25240                                  ;	Zero clear if error (carry clear)
 25241                                  ; SI Destroyed, others preserved
 25242                                  ;
 25243                                  ;----------------------------------------------------------------------------
 25244                                  
 25245                                  	;entry	DSKWRITE
 25246                                  DSKWRITE:
 25247 00003F38 51                      	PUSH	CX
 25248                                  	;mov	ah,[es:bp+17h] ; 04/05/2019
 25249 00003F39 268A6617                	MOV	AH,[ES:BP+DPB.MEDIA]
 25250                                  	;mov	al,[es:bp+1]
 25251 00003F3D 268A4601                	MOV	AL,[ES:BP+DPB.UNIT]
 25252 00003F41 53                      	PUSH	BX
 25253 00003F42 06                      	PUSH	ES
 25254 00003F43 E8E610                  	call	SETWRITE
 25255                                  DODSKOP:
 25256 00003F46 8CD9                    	MOV	CX,DS		; Save DS
 25257 00003F48 1F                      	POP	DS		; DS:BP points to DPB
 25258 00003F49 1E                      	PUSH	DS
 25259                                  
 25260                                  	;lds	si,[ds:bp+13h] ; 04/05/2019
 25261 00003F4A 3EC57613                	LDS	SI,[ds:BP+DPB.DRIVER_ADDR] ; 07/09/2018
 25262 00003F4E E82710                  	call	DEVIOCALL2
 25263                                  
 25264 00003F51 8ED9                    	MOV	DS,CX		; Restore DS
 25265 00003F53 07                      	POP	ES		; Restore ES
 25266 00003F54 5B                      	POP	BX
 25267                                  
 25268                                  ;hkn; SS override
 25269 00003F55 368B0E[6C03]            	MOV	CX,[SS:CALLSCNT] ; Number of sectors transferred
 25270 00003F5A 5F                      	POP	DI
 25271 00003F5B 29F9                    	SUB	CX,DI
 25272 00003F5D F7D9                    	NEG	CX		; Number of sectors not transferred
 25273                                  
 25274                                  ;hkn; SS override
 25275 00003F5F 36A1[5D03]              	MOV	AX,[SS:DEVCALL_REQSTAT]
 25276                                  	;test	ax,8000h
 25277                                  	; 17/12/2022
 25278                                  	;test	ah,80h
 25279 00003F63 F6C480                  	test	ah,(STERR>>8)
 25280                                  	;test	AX,STERR
 25281 00003F66 C3                      	retn
 25282                                  
 25283                                  ;Break	<HardErrRW - map extended errors and call harderr>
 25284                                  ;---------------------------------------------------------------------------
 25285                                  ;
 25286                                  ; Procedure Name : HardErrRW
 25287                                  ;
 25288                                  ; Inputs:
 25289                                  ;	AX is error code from read or write
 25290                                  ;	Other registers set as per HARDERR
 25291                                  ; Function:
 25292                                  ;	Checks the error code for special extended
 25293                                  ;	errors and maps them if needed. Then invokes
 25294                                  ;	Harderr
 25295                                  ; Outputs:
 25296                                  ;	Of HARDERR
 25297                                  ; AX may be modified prior to call to HARDERR.
 25298                                  ; No other registers altered.
 25299                                  ;
 25300                                  ;---------------------------------------------------------------------------
 25301                                  
 25302                                  	; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 25303                                  HARDERRRW:
 25304                                  	;cmp	al,0Fh
 25305 00003F67 3C0F                    	CMP	AL,error_I24_wrong_disk
 25306 00003F69 7512                    	JNZ	short DO_ERR			; Nothing to do
 25307                                  
 25308                                  	; MSDOS 3.3
 25309                                  	;push	ds
 25310                                  	;push	si
 25311                                  	;lds	si,[ss:CALLVIDRW]
 25312                                  	;mov	[ss:EXTERRPT+2], ds
 25313                                  	;mov	[ss:EXTERRPT], si
 25314                                  	;pop	si
 25315                                  	;pop	ds
 25316                                  
 25317                                  	; MSDOS 6.0
 25318 00003F6B 50                      	push	ax
 25319 00003F6C 36A1[7003]              	mov	ax,[SS:CALLVIDRW]		; get ptr lo  ;smr;SS Override
 25320 00003F70 36A3[2803]              	mov	[ss:EXTERRPT],ax		; set ext err ptr lo
 25321 00003F74 36A1[7203]              	mov	ax,[SS:CALLVIDRW+2]		; get ptr hi from dev
 25322 00003F78 36A3[2A03]              	mov	[ss:EXTERRPT+2],ax		; set ext err ptr hi
 25323 00003F7C 58                      	pop	ax
 25324                                  DO_ERR:
 25325                                  	;;call	HARDERR
 25326                                  	;;retn
 25327                                  	; 16/12/2022
 25328                                  	; 10/06/2019
 25329 00003F7D E97A1D                  	jmp	HARDERR	
 25330                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 25331                                  	;call	HARDERR
 25332                                  	;retn
 25333                                  
 25334                                  ; 24/07/2018 - Retro DOS v3.0
 25335                                  
 25336                                  ;Break	<SETUP -- SETUP A DISK READ OR WRITE FROM USER>
 25337                                  ;----------------------------------------------------------------------------
 25338                                  ;
 25339                                  ; Procedure Name : SETUP
 25340                                  ;
 25341                                  ; Inputs:
 25342                                  ;	ES:DI point to SFT (value also in THISSFT)
 25343                                  ;	DMAAdd contains transfer address
 25344                                  ;	CX = Byte count
 25345                                  ;	DS = DOSDATA
 25346                                  ;   WARNING Stack must be clean, two ret addrs on stack, 1st of caller,
 25347                                  ;		2nd of caller of caller.
 25348                                  ; Outputs:
 25349                                  ;	    CX = byte count
 25350                                  ;	    [THISDPB] = Base of drive parameters if file
 25351                                  ;		      = Pointer to device header if device or NET
 25352                                  ;	    ES:DI Points to SFT
 25353                                  ;	    [NEXTADD] = Displacement of disk transfer within segment
 25354                                  ;	    [TRANS] = 0 (No transfers yet)
 25355                                  ;	    BytPos = Byte position in file
 25356                                  ;
 25357                                  ;	The following fields are relevant to local files (not devices) only:
 25358                                  ;
 25359                                  ;	    SecPos = Position of first sector (local files only)
 25360                                  ;	    [BYTSECPOS] = Byte position in first sector (local files only)
 25361                                  ;	    [CLUSNUM] = First cluster (local files only)
 25362                                  ;	    [SECCLUSPOS] = Sector within first cluster (local files only)
 25363                                  ;	    [THISDRV] = Physical unit number (local files only)
 25364                                  ;
 25365                                  ;      RETURNS ONE LEVEL UP WITH:
 25366                                  ;	   CX = 0
 25367                                  ;	   CARRY = Clear
 25368                                  ;	IF AN ERROR IS DETECTED
 25369                                  ; All other registers destroyed
 25370                                  ;----------------------------------------------------------------------------
 25371                                  
 25372                                  ;hkn; called from disk.asm. DS has been set up to DOSDATA.
 25373                                  
 25374                                  ; DOSCODE:770Bh (MSDOS 6.21, MSDOS.SYS)
 25375                                  
 25376                                  ; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 25377                                  ; DOSCODE:76F7h (MSDOS 5.0, MSDOS.SYS)
 25378                                  
 25379                                  ; 09/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 25380                                  ; DOSCODE:80D8h (PCDOS 7.1, IBMDOS.COM)
 25381                                  
 25382                                  SETUP:
 25383                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 411Bh
 25384                                  
 25385                                  	;lds 	si,[es:di+7]
 25386 00003F80 26C57507                	LDS	SI,[ES:DI+SF_ENTRY.sf_devptr]
 25387                                  
 25388                                  ;hkn; SS override
 25389 00003F84 368C1E[8C05]            	MOV	[SS:THISDPB+2],DS
 25390                                  
 25391                                  ;hkn; SS is DOSDATA
 25392 00003F89 16                      	push	ss
 25393 00003F8A 1F                      	pop	ds
 25394                                  
 25395 00003F8B 8936[8A05]              	MOV	[THISDPB],SI
 25396                                  
 25397 00003F8F 8B1E[2C03]              	MOV	BX,[DMAADD]
 25398 00003F93 891E[B805]              	MOV	[NEXTADD],BX		;Set NEXTADD to start of Xaddr
 25399 00003F97 C606[7405]00            	MOV	BYTE [TRANS],0		;No transferes
 25400                                  	;mov	ax,[es:di+15h]
 25401 00003F9C 268B4515                	MOV	AX,[ES:DI+SF_ENTRY.sf_position]
 25402                                  	;mov	dx,[es:di+17h]
 25403 00003FA0 268B5517                	MOV	DX,[ES:DI+SF_ENTRY.sf_position+2]
 25404 00003FA4 8916[D005]              	MOV	[BYTPOS+2],DX		;Set it
 25405 00003FA8 A3[CE05]                	MOV	[BYTPOS],AX
 25406                                  	;test	word [es:di+5],8080h
 25407 00003FAB 26F745058080            	TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet+devid_device
 25408 00003FB1 7555                    	JNZ	short NOSETSTUFF	;Following not done on devs or NET
 25409 00003FB3 06                      	PUSH	ES
 25410 00003FB4 C42E[8A05]              	LES	BP,[THISDPB]		;Point at the DPB
 25411                                  
 25412                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 25413                                  	;;mov	bl,[es:bp+0]
 25414                                  	;MOV	BL,[ES:BP+DPB.DRIVE]
 25415                                  	; 05/12/2022
 25416 00003FB8 268A5E00                	mov	bl,[es:bp]
 25417                                  	
 25418 00003FBC 881E[7605]              	MOV	[THISDRV],BL		;Set THISDRV
 25419                                  	;mov	bx,[es:bp+2]
 25420 00003FC0 268B5E02                	MOV	BX,[ES:BP+DPB.SECTOR_SIZE]
 25421                                  
 25422                                  	;; MSDOS 3.3
 25423                                  	;cmp	dx,bx
 25424                                  	;jnb	short EOFERR
 25425                                  	;div	bx
 25426                                  	;mov	[SECPOS],ax
 25427                                  	;mov	[BYTSECPOS],dx
 25428                                  	;mov	dx,ax
 25429                                  	;;and	al,[es:bp+4]
 25430                                  	;AND	AL,[ES:BP+DPB.CLUSTER_MASK]
 25431                                  	;mov	[SECCLUSPOS],al
 25432                                  	;mov	ax,cx
 25433                                  	;;mov	cl,[es:bp+5]
 25434                                  	;MOV	CL,[ES:BP+DPB.CLUSTER_SHIFT]
 25435                                  	;shr	dx,cl
 25436                                  	;mov	[CLUSNUM],dx
 25437                                  	;pop	es
 25438                                  	;mov	cx,ax
 25439                                  
 25440                                  	; 04/05/2019 - Retro DOS v4.0
 25441                                  
 25442                                  	; MSDOS 6.0
 25443                                  ;M039: Optimized this section.
 25444 00003FC4 51                              PUSH    CX			;SHR32 and DIV32 use CX.
 25445 00003FC5 E8FB05                  	call	DIV32			;DX:AX/BX = CX:AX + DX (rem)
 25446 00003FC8 8916[CC05]              	MOV	[BYTSECPOS],DX
 25447 00003FCC A3[C405]                	MOV	[SECPOS],AX
 25448 00003FCF 890E[C605]              	MOV	[SECPOS+2],CX
 25449 00003FD3 89CA                    	MOV	DX,CX
 25450                                  
 25451 00003FD5 89C3                    	MOV	BX,AX
 25452                                  	;and	bl,[es:bp+4]
 25453 00003FD7 26225E04                	AND	BL,[ES:BP+DPB.CLUSTER_MASK]
 25454 00003FDB 881E[7305]              	MOV	[SECCLUSPOS],BL
 25455                                  
 25456 00003FDF E80806                  	call	SHR32			;(DX:AX SHR dpb_cluster_shift)
 25457 00003FE2 59                      	POP	CX			;CX = byte count.
 25458                                  
 25459                                  	; 09/02/2024 (PCDOS7.1 IBMDOS.COM)
 25460                                  	;JNZ	short EOFERR		;cluster number above 64k
 25461                                  	;;;
 25462                                  	;cmp	word [es:bp+0Fh],0
 25463 00003FE3 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 25464 00003FE8 750C                    	jnz	short setup_1		; not FAT32 fs
 25465                                  	;cmp	dx,[es:bp+2Fh]
 25466 00003FEA 263B562F                	cmp	dx,[es:bp+DPB.LAST_CLUSTER+2]
 25467 00003FEE 750E                    	jne	short setup_2
 25468                                  	;cmp	ax,[es:bp+2Dh]
 25469 00003FF0 263B462D                	cmp	ax,[es:bp+DPB.LAST_CLUSTER]
 25470 00003FF4 EB08                    	jmp	short setup_2
 25471                                  setup_1:	; FAT12 or FAT16 fs
 25472 00003FF6 09D2                    	or	dx,dx
 25473 00003FF8 7523                    	jnz	short EOFERR
 25474                                  	;cmp	ax,[es:bp+0Dh]
 25475 00003FFA 263B460D                	cmp	ax,[es:bp+DPB.MAX_CLUSTER]
 25476                                  setup_2:
 25477 00003FFE 771D                    	ja	short EOFERR
 25478 00004000 8916[DE0A]              	mov	[CLUSNUM_HW],dx
 25479                                  	;;;
 25480                                  
 25481                                  	;;cmp	ax,[es:bp+0Dh]
 25482                                  	;CMP	AX,[ES:BP+DPB.MAX_CLUSTER] ;>32mb  if > disk size ;AN000;
 25483                                  	;JA	short EOFERR		   ;>32mb  then EOF       ;AN000;
 25484                                  
 25485 00004004 A3[BC05]                	MOV	[CLUSNUM],AX
 25486 00004007 07                      	POP	ES			; ES:DI point to SFT
 25487                                  ;M039
 25488                                  
 25489                                  NOSETSTUFF:
 25490 00004008 89C8                    	MOV	AX,CX		; AX = Byte count.
 25491 0000400A 0306[2C03]              	ADD	AX,[DMAADD]	; See if it will fit in one segment
 25492 0000400E 730C                    	JNC	short setup_OK	; Must be less than 64K
 25493 00004010 A1[2C03]                	MOV	AX,[DMAADD]
 25494 00004013 F7D8                    	NEG	AX		; Amount of room left in segment (know
 25495                                  				;    less than 64K since max value of CX
 25496                                  				;    is FFFF).
 25497 00004015 7501                    	JNZ	short NoDec
 25498 00004017 48                      	DEC	AX
 25499                                  NoDec:
 25500 00004018 89C1                    	MOV	CX,AX		; Can do this much
 25501 0000401A E304                    	JCXZ	NOROOM		; Silly user gave Xaddr of FFFF in segment
 25502                                  setup_OK:
 25503 0000401C C3                      	retn
 25504                                  
 25505                                  EOFERR:
 25506 0000401D 07                      	POP	ES		; ES:DI point to SFT
 25507 0000401E 31C9                    	XOR	CX,CX		; No bytes read
 25508                                  ;;;;;;;;;;; 7/18/86
 25509                                  	; MSDOS 3.3
 25510                                  	;MOV	BYTE [DISK_FULL],1 ; set disk full flag
 25511                                  ;;;;;;;;;;;
 25512                                  NOROOM:
 25513 00004020 5B                      	POP	BX		; Kill return address
 25514 00004021 F8                      	CLC
 25515 00004022 C3                      	retn			; RETURN TO CALLER OF CALLER
 25516                                  
 25517                                  ;Break	<BREAKDOWN -- CUT A USER READ OR WRITE INTO PIECES>
 25518                                  ;---------------------------------------------------------------------------
 25519                                  ;
 25520                                  ; Procedure Name : BREAKDOWN
 25521                                  ;
 25522                                  ; Inputs:
 25523                                  ;	CX = Length of disk transfer in bytes
 25524                                  ;	ES:BP = Base of drive parameters
 25525                                  ;	[BYTSECPOS] = Byte position within first sector
 25526                                  ;	DS = DOSDATA
 25527                                  ; Outputs:
 25528                                  ;	[BYTCNT1] = Bytes to transfer in first sector
 25529                                  ;	[SECCNT] = No. of whole sectors to transfer
 25530                                  ;	[BYTCNT2] = Bytes to transfer in last sector
 25531                                  ; AX, BX, DX destroyed. No other registers affected.
 25532                                  ;---------------------------------------------------------------------------
 25533                                  
 25534                                  BREAKDOWN:
 25535 00004023 A1[CC05]                	MOV	AX,[BYTSECPOS]
 25536 00004026 89CB                    	MOV	BX,CX
 25537 00004028 09C0                    	OR	AX,AX
 25538 0000402A 740E                    	JZ	short SAVFIR	; Partial first sector?
 25539                                  	;sub	ax,[es:bp+2]
 25540 0000402C 262B4602                	SUB	AX,[ES:BP+DPB.SECTOR_SIZE]
 25541 00004030 F7D8                    	NEG	AX		; Max number of bytes left in first sector
 25542 00004032 29C3                    	SUB	BX,AX		; Subtract from total length
 25543 00004034 7304                    	JAE	short SAVFIR
 25544 00004036 01D8                    	ADD	AX,BX		; Don't use all of the rest of the sector
 25545 00004038 31DB                    	XOR	BX,BX		; And no bytes are left
 25546                                  SAVFIR:
 25547 0000403A A3[D205]                	MOV	[BYTCNT1],AX
 25548 0000403D 89D8                    	MOV	AX,BX
 25549 0000403F 31D2                    	XOR	DX,DX
 25550                                  	;div	word [ES:BP+2]
 25551 00004041 26F77602                	DIV	word [ES:BP+DPB.SECTOR_SIZE]  ; How many whole sectors?
 25552 00004045 A3[D605]                	MOV	[SECCNT],AX
 25553 00004048 8916[D405]              	MOV	[BYTCNT2],DX	; Bytes remaining for last sector
 25554                                  	; MSDOS 3.3
 25555                                  	;OR	DX,[BYTCNT1]	; SMR ONESECTORFIX BUGBUG
 25556                                  	;retnz			; NOT (BYTCNT1 = BYTCNT2 = 0)
 25557                                  	;CMP	AX,1
 25558                                  	;retnz
 25559                                  	;MOV	AX,[ES:BP+DPB.SECTOR_SIZE] ; Buffer EXACT one sector I/O
 25560                                  	;MOV	[BYTCNT2],AX
 25561                                  	;MOV	[SECCNT],DX	; DX = 0
 25562                                  _RET45:
 25563 0000404C C3                      	retn
 25564                                  
 25565                                  ; DOSCODE:77BFh (MSDOS 6.21, MSDOS.SYS)
 25566                                  
 25567                                  ;----------------------------------------------------------------------------
 25568                                  ;
 25569                                  ; Procedure Name : READ_LOCK_VIOLATION
 25570                                  ;
 25571                                  ; ES:DI points to SFT. This entry used by NET_READ
 25572                                  ; Carry set if to return error (CX=0,AX=error_sharing_violation).
 25573                                  ; Else do retrys.
 25574                                  ; ES:DI,DS,CX preserved
 25575                                  ;
 25576                                  ;----------------------------------------------------------------------------
 25577                                  
 25578                                  READ_LOCK_VIOLATION:
 25579 0000404D C606[7505]00            	MOV	byte [READOP],0
 25580                                  ERR_ON_CHECK:
 25581                                  	;;test	word [es:di+2],8000h
 25582                                  	;TEST	word [ES:DI+SF_ENTRY.sf_mode],sf_isFCB
 25583                                  	;JNZ	short HARD_ERR
 25584                                  
 25585                                  	; 04/05/2019
 25586                                  	;test	byte [es:di+3],80h
 25587 00004052 26F6450380              	TEST	byte [ES:DI+SF_ENTRY.sf_mode+1],(sf_isFCB>>8)
 25588 00004057 7508                    	JNZ	short HARD_ERR
 25589                                  
 25590                                  	;PUSH	CX
 25591                                  	;;mov	cl,[es:di+2]
 25592                                  	;MOV	CL,[ES:DI+SF_ENTRY.sf_mode]
 25593                                  	;;and	cl,0F0h
 25594                                  	;AND	CL,SHARING_MASK
 25595                                  	;;cmp	cl,0
 25596                                  	;CMP	CL,SHARING_COMPAT
 25597                                  	;POP	CX
 25598                                  	;JNE	short NO_HARD_ERR
 25599                                  	; 21/09/2023
 25600 00004059 268A4502                	mov	al,[ES:DI+SF_ENTRY.sf_mode]
 25601 0000405D 24F0                    	and	al,SHARING_MASK
 25602                                  	;cmp	al,SHARING_COMPAT
 25603                                  	;jne	short NO_HARD_ERR
 25604 0000405F 7505                    	jnz	short NO_HARD_ERR
 25605                                  HARD_ERR:
 25606 00004061 E81B40                  	call	LOCK_VIOLATION
 25607 00004064 73E6                    	jnc	short _RET45		; User wants Retrys
 25608                                  NO_HARD_ERR:
 25609 00004066 31C9                    	XOR	CX,CX			;No bytes transferred
 25610                                  	;mov	ax,21h
 25611 00004068 B82100                  	MOV	AX,error_lock_violation
 25612 0000406B F9                      	STC
 25613                                  RET3:		; 06/02/2024
 25614 0000406C C3                      	retn
 25615                                  
 25616                                  ;----------------------------------------------------------------------------
 25617                                  ;
 25618                                  ; Procedure Name : WRITE_LOCK_VIOLATION
 25619                                  ;
 25620                                  ; Same as READ_LOCK_VIOLATION except for READOP.
 25621                                  ; This entry used by NET_WRITE
 25622                                  ;
 25623                                  ;----------------------------------------------------------------------------
 25624                                  
 25625                                  WRITE_LOCK_VIOLATION:
 25626 0000406D C606[7505]01            	MOV	byte [READOP],1
 25627 00004072 EBDE                    	JMP	short ERR_ON_CHECK
 25628                                  
 25629                                  ; 04/05/2019 - Retro DOS v4.0
 25630                                  
 25631                                  ; DOSCODE:77ECh (MSDOS 6.21, MSDOS.SYS)
 25632                                  
 25633                                  ;Break	<DISKREAD -- PERFORM USER DISK READ>
 25634                                  ;----------------------------------------------------------------------------
 25635                                  ;
 25636                                  ; Procedure Name : DISKREAD
 25637                                  ;
 25638                                  ; Inputs:
 25639                                  ;	Outputs of SETUP
 25640                                  ; Function:
 25641                                  ;	Perform disk read
 25642                                  ; Outputs:
 25643                                  ;    Carry clear
 25644                                  ;	CX = No. of bytes read
 25645                                  ;	ES:DI point to SFT
 25646                                  ;	SFT offset and cluster pointers updated
 25647                                  ;    Carry set
 25648                                  ;	CX = 0
 25649                                  ;	ES:DI point to SFT
 25650                                  ;	AX has error code
 25651                                  ;----------------------------------------------------------------------------
 25652                                  
 25653                                  ;hkn; called from disk.asm. DS already set up.
 25654                                  
 25655                                  ; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 25656                                  ; DOSCODE:77D8h (MSDOS 5.0, MSDOS.SYS)
 25657                                  
 25658                                  ; 09/02/2024
 25659                                  ; 06/02/2024 - Retro DOS v5.0
 25660                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:81D5h
 25661                                  
 25662                                  DISKREAD:
 25663                                  	;mov	ax,[es:di+11h]
 25664 00004074 268B4511                	MOV	AX,[ES:DI+SF_ENTRY.sf_size]
 25665                                  	;mov	bx,[es:di+13h]
 25666 00004078 268B5D13                	MOV	BX,[ES:DI+SF_ENTRY.sf_size+2]
 25667 0000407C 2B06[CE05]              	SUB	AX,[BYTPOS]
 25668 00004080 1B1E[D005]              	SBB	BX,[BYTPOS+2]
 25669 00004084 7226                    	JB	short RDERR		;Read starts past EOF
 25670 00004086 750A                    	JNZ	short ENUF		;More than 64k to EOF
 25671 00004088 09C0                    	OR	AX,AX
 25672 0000408A 7420                    	JZ	short RDERR		;Read starts at EOF
 25673 0000408C 39C8                    	CMP	AX,CX
 25674 0000408E 7302                    	JAE	short ENUF		;I/O fits
 25675 00004090 89C1                    	MOV	CX,AX			;Limit read to up til EOF
 25676                                  ENUF:
 25677                                  	; MSDOS 3.3
 25678                                  	;test	byte [es:di+4],8
 25679                                  	;TEST	byte [ES:DI+SF_ENTRY.sf_attr],attr_volume_id
 25680                                  	;jnz	short SET_ACC_ERR
 25681                                  	;call	LOCK_CHECK
 25682                                  	;jnb	short _READ_OK
 25683                                  	;call	READ_LOCK_VIOLATION
 25684                                  	;jnb	short ENUF
 25685                                  	;retn
 25686                                  
 25687                                  	; MSDOS 6.0
 25688 00004092 E868FE                  	call	CHECK_READ_LOCK		;IFS. check read lock	;AN000;
 25689                                  	;JNC	short _READ_OK 		; There are no locks
 25690                                  	;retn
 25691                                  	; 06/02/2024
 25692 00004095 72D5                    	jc	short RET3
 25693                                  
 25694                                  _READ_OK:
 25695 00004097 C42E[8A05]              	LES	BP,[THISDPB]
 25696 0000409B E885FF                  	CALL	BREAKDOWN
 25697                                  
 25698                                  ; 10/02/2024
 25699                                  %if 0
 25700                                  	MOV	CX,[CLUSNUM] ; *
 25701                                  	;;;
 25702                                  	; 06/02/2023 (PCDOS 7.1 IBMDOS.COM)
 25703                                  	mov	dx,[CLUSNUM_HW] ; *
 25704                                  	;;;
 25705                                  	call	FNDCLUS
 25706                                       	; MSDOS 6.0			;M022 conditional removed here
 25707                                  	JC	short SET_ACC_ERR_DS	; fix to take care of I24 fail
 25708                                  					; migrated from 330a - HKN
 25709                                  %else
 25710                                  	; 10/02/2024 - Retro DOS v5.0
 25711 0000409E E84D13                  	call	FNDCLUS_X ; *
 25712 000040A1 721A                    	jc	short SET_ACC_ERR ; ds=ss
 25713                                  %endif
 25714                                  	;;;
 25715                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25716 000040A3 833E[F80A]00            	cmp	word [CLSKIP_HW],0
 25717 000040A8 7502                    	jnz	short RDERR
 25718                                  	;;;
 25719                                  
 25720                                  	;OR	CX,CX
 25721                                  	;JZ	short SKIPERR
 25722                                  	; 06/02/2024
 25723 000040AA E318                    	jcxz	SKIPERR
 25724                                  
 25725                                  RDERR:
 25726 000040AC B40E                    	MOV	AH,0EH			;MS. read/data/fail ;AN000;
 25727 000040AE E97202                  	jmp	WRTERR22
 25728                                  
 25729                                  ;RDLASTJ: 
 25730                                  	;JMP	RDLAST                  ;M039
 25731                                  
 25732                                  SETSFTJ2: 
 25733 000040B1 E9B600                  	JMP	SETSFT
 25734                                  
 25735                                  CANOT_READ:
 25736                                  	; MSDOS 3.3
 25737                                  	;POP	CX		;M039.
 25738                                  	; MSDOS 3.3 & MSDOS 6.0
 25739 000040B4 59                      	POP	CX              ;Clean stack.
 25740 000040B5 5B                      	POP	BX
 25741                                  	;;;
 25742                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25743                                  	;pop	word [CCONTENT_HW] ; PCDOS 7.1 BUG!?
 25744                                  			; I think, this would be 'pop word [ss:CCONTENT_HW]'
 25745                                  			; because ds<>ss while jumping here.
 25746                                  			; Erdogan Tan - 09/02/2024
 25747 000040B6 368F06[EC0A]            	pop	word [ss:CCONTENT_HW] ; *
 25748                                  	;;;
 25749                                  
 25750                                  	;entry	SET_ACC_ERR_DS
 25751                                  SET_ACC_ERR_DS:
 25752                                  
 25753                                  ;hkn; SS is DOSDATA
 25754                                  	;Context DS
 25755 000040BB 16                      	push	ss
 25756 000040BC 1F                      	pop	ds
 25757                                  
 25758                                  	;entry	SET_ACC_ERR
 25759                                  SET_ACC_ERR:
 25760 000040BD 31C9                    	XOR	CX,CX
 25761                                  	;mov	ax,5
 25762 000040BF B80500                  	MOV	AX,error_access_denied
 25763 000040C2 F9                      	STC
 25764 000040C3 C3                      	retn
 25765                                  
 25766                                  SKIPERR:
 25767 000040C4 8916[BA05]              	MOV	[LASTPOS],DX
 25768 000040C8 891E[BC05]              	MOV	[CLUSNUM],BX
 25769                                  	;;;
 25770                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25771 000040CC 8B1E[E80A]              	mov	bx,[CLUSTNUM_HW]
 25772 000040D0 891E[DE0A]              	mov	[CLUSNUM_HW],bx
 25773                                  	;;;
 25774 000040D4 833E[D205]00            	CMP	word [BYTCNT1],0
 25775 000040D9 7405                    	JZ	short RDMID
 25776                                  
 25777 000040DB E80614                  	call	BUFRD
 25778                                  	;JC	short SET_ACC_ERR_DS ; ds<>ss ; 10/02/2024
 25779                                  	; 10/02/2024
 25780                                  	; ds=ss
 25781 000040DE 72DD                    	jc	short SET_ACC_ERR
 25782                                  
 25783                                  RDMID:
 25784 000040E0 833E[D605]00            	CMP	word [SECCNT],0
 25785                                  	;JZ	RDLAST ; 10/08/2018
 25786 000040E5 7466                    	jz	short RDLAST
 25787                                  
 25788 000040E7 E88E14                  	call	NEXTSEC
 25789 000040EA 72C5                    	JC	short SETSFTJ2
 25790                                  
 25791 000040EC C606[7405]01            	MOV	BYTE [TRANS],1		; A transfer is taking place
 25792                                  ONSEC:
 25793 000040F1 8A16[7305]              	MOV	DL,[SECCLUSPOS]	; (dx/DL = Extent start) ((dh = ?))
 25794 000040F5 8B0E[D605]              	MOV	CX,[SECCNT]
 25795                                  	;;;
 25796                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25797 000040F9 8B1E[DE0A]              	mov	bx,[CLUSNUM_HW]
 25798 000040FD 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 25799                                  	;;;
 25800 00004101 8B1E[BC05]              	MOV	BX,[CLUSNUM]
 25801                                  RDLP:
 25802 00004105 E8B714                  	call	OPTIMIZE
 25803                                  	;JC	short SET_ACC_ERR_DS ; ds<>ss ; 10/02/2024
 25804                                  	; 10/02/2024
 25805                                  	; ds=ss
 25806 00004108 72B3                    	jc	short SET_ACC_ERR
 25807                                  	;;;
 25808                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25809 0000410A FF36[EC0A]              	push	word [CCONTENT_HW]	; (Next physical cluster, hw)
 25810                                  	;;;
 25811 0000410E 57                      	PUSH	DI                      ;DI = Next physical cluster.
 25812 0000410F 50                      	PUSH	AX                      ;AX = # of sectors remaining.
 25813 00004110 53                      	PUSH	BX			;[DMAADD+2]:BX = Transfer address.
 25814                                  	;mov	byte [ALLOWED],38h
 25815 00004111 C606[4B03]38            	MOV	byte [ALLOWED],Allowed_RETRY+Allowed_FAIL+Allowed_IGNORE
 25816 00004116 8E1E[2E03]              	MOV	DS,[DMAADD+2]
 25817                                  
 25818 0000411A 52                      	PUSH	DX                      ;[HIGH_SECTOR]:DX = phys. sector #.
 25819 0000411B 51                      	PUSH	CX                      ;CX = # of contiguous sectors to read.
 25820                                  
 25821                                  	; 04/05/2019 - Retro DOS v4.0
 25822                                  
 25823                                  	; 09/02/2024 - Retro DOS v5.0
 25824                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:8284h
 25825                                  	; Windows ME IO.SYS - BIOSCODE:0B69Eh
 25826                                  	; MSDOS 6.22 IO.SYS - DOSCODE:787Bh
 25827                                  
 25828                                  	; NOTE: Secondary Buffer Cache is not used in PCDOS 7.1 IBMDOS.COM.
 25829                                  
 25830                                  	;call	nul_sub		; PCDOS 7.1 (nul_sub: retn)
 25831                                  	;			; 'nul_sub:' at DOSCODE:AD57h
 25832                                  	
 25833                                  	; MSDOS 6.0 (& Windows ME)
 25834                                  	;call	SET_RQ_SC_PARMS		;LB. do this for SC ;AN000;
 25835                                  
 25836                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25837 0000411C E8A0FD                  	call	DREAD
 25838                                  
 25839                                  	; 10/02/2024
 25840                                  	; ds<>ss
 25841                                  
 25842                                  	; MSDOS 3.3 
 25843                                  	;pop	bx
 25844                                  	;pop	dx
 25845                                  	;jc	short CANOT_READ
 25846                                  	;add	bx,dx	; (bx = Extent end)
 25847                                  	;mov	al,[es:bp] ; mov al,[es:bp+0]
 25848                                  	;;mov	al,[ES:BP+DPB.DRIVE] 
 25849                                  	;call	SETVISIT
 25850                                  	; ->***
 25851                                  ;M039
 25852                                  	; MSDOS 6.0 
 25853 0000411F 59                      	pop	cx
 25854 00004120 5A                      	pop	dx
 25855 00004121 368F06[0C06]            	pop	WORD [ss:TEMP_VAR]
 25856 00004126 728C                    	jc	short CANOT_READ ; * 09/02/2024
 25857                                  
 25858 00004128 368C1E[0E06]            	mov	[ss:TEMP_VAR2],ds
 25859                                  
 25860                                  ;       CX = # of contiguous sectors read. (These constitute a block of
 25861                                  ;            sectors, also termed an "Extent".)
 25862                                  ;       [HIGH_SECTOR]:DX = physical sector # of first sector in extent.
 25863                                  ;       [TEMP_VAR2]:[TEMP_VAR] = Transfer address (destination data address).
 25864                                  ;       ES:BP -> Drive Parameter Block (DPB).
 25865                                  ;
 25866                                  ;	The Buffer Queue must now be scanned: the contents of any dirty
 25867                                  ;	buffers must be "read" into the transfer memory block, so that the
 25868                                  ;       transfer memory reflects the most recent data.
 25869                                  
 25870 0000412D E87600                  	call	DskRdBufScan
 25871                                  
 25872                                  	;Context DS
 25873 00004130 16                      	push	ss
 25874 00004131 1F                      	pop	ds
 25875                                          
 25876 00004132 59                      	pop	cx
 25877 00004133 5B                              pop	bx
 25878                                  
 25879                                  ;       CX = # of sector remaining.
 25880                                  ;       BX = Next physical cluster.
 25881                                  
 25882                                  	;;;
 25883                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25884 00004134 8F06[E80A]              	pop	word [CLUSTNUM_HW]	; (Next physical cluster, hw)
 25885                                  	;;;
 25886                                  
 25887                                  ;M039
 25888                                  
 25889                                  ;;;;;;;;
 25890                                  ;	; 25/07/2018 - Retro DOS v3.0
 25891                                  ;	; ***->
 25892                                  ;	; MSDOS 3.3
 25893                                  ;	; IBMDOS.COM (1987) - Offset 42BDh
 25894                                  ;bufq:
 25895                                  ;;	DX = Extent start.
 25896                                  ;;	BX = Extent end.
 25897                                  ;;	 AL = Drive #.
 25898                                  ;;     DS:DI-> 1st buffer in queue.
 25899                                  ;
 25900                                  ;	;or	byte [di+5],20h
 25901                                  ;	or	byte [DI+BUFFINFO.buf_flags],buf_visit ; Bit 5 = reserved
 25902                                  ;	;cmp	al,[di+4]	
 25903                                  ;	cmp	al,[DI+BUFFINFO.buf_ID]
 25904                                  ;	jnz	short bufq3
 25905                                  ;	;cmp	[di+6],dx
 25906                                  ;	cmp	[DI+BUFFINFO.buf_sector],dx
 25907                                  ;	jb	short bufq3	; Jump if Extent start > buffer sector.
 25908                                  ;	;cmp	[di+6],bx
 25909                                  ;	cmp	[DI+BUFFINFO.buf_sector],bx
 25910                                  ;	jnb	short bufq3	; Jump if Extent end >= buffer sector.
 25911                                  ;	
 25912                                  ;	; Buffer sector is in the Extent (contiguous sectors to read)
 25913                                  ;
 25914                                  ;;      Buffer's sector is in Extent: if it is dirty, copy its contents to
 25915                                  ;;      transfer memory; otherwise, just re-position it in the buffer queue
 25916                                  ;;      as MRU (Most Recently Used).
 25917                                  ;
 25918                                  ;	;test	byte [di+5],40h
 25919                                  ;	test	byte [DI+BUFFINFO.buf_flags],buf_dirty ; Bit 6 = dirty flag
 25920                                  ;	jz	short bufq2	; clear buffer, check the next buff sec
 25921                                  ;	pop	ax ; transfer address
 25922                                  ;	push	ax
 25923                                  ;	push	di
 25924                                  ;	push	dx
 25925                                  ;	;sub	dx,[di+6]
 25926                                  ;	sub	dx,[DI+BUFFINFO.buf_sector]
 25927                                  ;	neg	dx
 25928                                  ;
 25929                                  ;;      DX = offset (in sectors) of buffer sector within Transfer memory
 25930                                  ;;           block.
 25931                                  ;
 25932                                  ;	mov	si,di
 25933                                  ;	mov	di,ax
 25934                                  ;	mov	ax,dx
 25935                                  ;	;mov	cx,[es:bp+6]
 25936                                  ;	mov     cx,[ES:BP+DPB.SECTOR_SIZE] ; CX = sector size (in bytes).
 25937                                  ;	mul	cx
 25938                                  ;	add	di,ax
 25939                                  ;
 25940                                  ;	lea	si,[si+16]
 25941                                  ;	lea	si,[SI+BUFINSIZ] ;DS:SI -> buffer data.
 25942                                  ;	shr	cx,1
 25943                                  ;	push	es
 25944                                  ;	mov	es,[SS:DMAADD+2]
 25945                                  ;
 25946                                  ;;      CX = sector size (in WORDs) ; CF=1 if odd # of bytes.
 25947                                  ;;      DS:SI-> Buffer sector data.
 25948                                  ;;      ES:DI-> Destination within Transfer memory block.
 25949                                  ;
 25950                                  ;	rep	movsw			;Copy buffer sector to Transfer memory
 25951                                  ;	;adc	cx,0                    ;CX=1 if odd # of bytes, else CX=0.
 25952                                  ;	;rep	movsb                   ;Copy last byte.
 25953                                  ;	jnc	short bufq1
 25954                                  ;	movsb
 25955                                  ;bufq1:
 25956                                  ;	pop	es
 25957                                  ;	pop	dx
 25958                                  ;	pop	di
 25959                                  ;	mov	al,[es:bp]  ; mov al,[es:bp+0]
 25960                                  ;	;mov	al,[ES:BP+DPB.DRIVE]
 25961                                  ;bufq2:
 25962                                  ;	call	SCANPLACE
 25963                                  ;bufq3:
 25964                                  ;	call	SKIPVISIT
 25965                                  ;	jnz	short bufq
 25966                                  ;	
 25967                                  ;	push	ss
 25968                                  ;	pop	ds
 25969                                  ;	pop	cx
 25970                                  ;	pop	cx
 25971                                  ;	pop	bx
 25972                                  ;bufq4:
 25973                                  ;;;;;;;
 25974                                  	
 25975 00004138 E313                    	JCXZ	RDLAST
 25976                                  
 25977 0000413A E8211E                  	call	IsEOF			; test for eof on fat size
 25978 0000413D 732B                    	JAE	short SETSFT
 25979                                  
 25980 0000413F B200                    	MOV	DL,0
 25981                                  	;INC	word [LASTPOS]		; We'll be using next cluster
 25982                                  	;;;
 25983                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 25984                                  	;;add	word [LASTPOS],1
 25985                                  	;adc	word [LASTPOS_HW],0
 25986                                  	; 09/02/2024 - Retro DOS v5.0
 25987 00004141 FF06[BA05]              	inc	word [LASTPOS]
 25988 00004145 75BE                    	jnz	short RDLP
 25989 00004147 FF06[E20A]              	inc	word [LASTPOS_HW]
 25990                                  	;;;
 25991 0000414B EBB8                    	JMP	short RDLP ; 19/05/2019
 25992                                  
 25993                                  RDLAST:
 25994 0000414D A1[D405]                	MOV	AX,[BYTCNT2]
 25995 00004150 09C0                    	OR	AX,AX
 25996 00004152 7416                    	JZ	short SETSFT
 25997 00004154 A3[D205]                	MOV	[BYTCNT1],AX
 25998                                  
 25999 00004157 E81E14                  	call	NEXTSEC
 26000 0000415A 720E                    	JC	short SETSFT
 26001                                  
 26002 0000415C C706[CC05]0000          	MOV	word [BYTSECPOS],0
 26003 00004162 E87F13                  	call	BUFRD
 26004                                  	; 10/08/2018
 26005 00004165 7303                    	JNC	short SETSFT
 26006                                  	;JMP	SET_ACC_ERR_DS
 26007                                  	; 10/02/2024
 26008                                  	; ds=ss
 26009 00004167 E953FF                  	jmp	SET_ACC_ERR
 26010                                  
 26011                                  ;------------------------------------------------------------------------------
 26012                                  ;
 26013                                  ; Procedure Name : SETSFT
 26014                                  ; Inputs:
 26015                                  ;	[NEXTADD],[CLUSNUM],[LASTPOS] set to determine transfer size
 26016                                  ;		and set cluster fields
 26017                                  ; Function:
 26018                                  ;	Update [THISSFT] based on the transfer
 26019                                  ; Outputs:
 26020                                  ;	sf_position, sf_lstclus, and sf_cluspos updated
 26021                                  ;	ES:DI points to [THISSFT]
 26022                                  ;	CX No. of bytes transferred
 26023                                  ;	Carry clear
 26024                                  ;
 26025                                  ;----------------------------------------------------------------------------
 26026                                  
 26027                                  	;entry	SETSFT
 26028                                  
 26029                                  ; 26/07/2018 - Retro DOS v3.0
 26030                                  
 26031                                  	; 09/02/2024 - Retro DOS v5.0
 26032                                  	; (PCDOS 7.1 IBMDOS.COM)
 26033                                  
 26034                                  SETSFT:
 26035 0000416A C43E[9E05]              	LES	DI,[THISSFT]
 26036                                  
 26037                                  ; Same as SETSFT except ES:DI already points to SFT
 26038                                  	;entry	SETCLUS
 26039                                  SETCLUS:	
 26040 0000416E 8B0E[B805]              	MOV	CX,[NEXTADD]
 26041 00004172 2B0E[2C03]              	SUB	CX,[DMAADD]		; Number of bytes transfered
 26042                                  	;;test	word [es:di+5],80h
 26043                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device
 26044                                  	;JNZ	short ADDREC		; don't set clusters if device
 26045                                  
 26046                                  	; 04/05/2019 - Retro DOS v4.0
 26047                                  	;test	byte [es:di+5],80h
 26048 00004176 26F6450580              	TEST	byte [ES:DI+SF_ENTRY.sf_flags],devid_device
 26049 0000417B 751C                    	JNZ	short ADDREC		; don't set clusters if device
 26050                                  	
 26051                                  	;;;
 26052                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26053 0000417D A1[DE0A]                	mov	ax,[CLUSNUM_HW]
 26054 00004180 26894537                	mov	[es:di+37h],ax
 26055                                  	;mov	[es:di+SF_ENTRY.sf_lstclus+2],ax
 26056 00004184 A1[E20A]                	mov	ax,[LASTPOS_HW]
 26057 00004187 2689450B                	mov	[es:di+0Bh],ax
 26058                                  	;mov	[es:di+SF_ENTRY.sf_cluspos_hw],ax ; PCDOS 7.1 & Win ME
 26059                                  	;;mov	[es:di+SF_ENTRY.sf_firclus],ax ; MSDOS 5.0-6.22
 26060                                  	;;;
 26061                                  
 26062 0000418B A1[BC05]                	MOV	AX,[CLUSNUM]
 26063                                  	;;mov	[es:di+1Bh],ax ; MSDOS 3.3
 26064                                  	;mov	[es:di+35h],ax ; MSDOS 6.0 (& MSDOS 6.21)
 26065 0000418E 26894535                	MOV	[ES:DI+SF_ENTRY.sf_lstclus],AX
 26066 00004192 A1[BA05]                	MOV	AX,[LASTPOS]
 26067                                  	;mov	[es:di+19h],ax
 26068 00004195 26894519                	MOV	[ES:DI+SF_ENTRY.sf_cluspos],AX
 26069                                  
 26070                                  ;----------------------------------------------------------------------------
 26071                                  ;
 26072                                  ; Procedure : AddRec
 26073                                  ; Inputs:
 26074                                  ;	ES:DI points to SFT
 26075                                  ;	CX is No. Bytes transferred
 26076                                  ; Function:
 26077                                  ;	Update the SFT offset based on the transfer
 26078                                  ; Outputs:
 26079                                  ;	sf_position updated to point to first byte after transfer
 26080                                  ;	ES:DI points to SFT
 26081                                  ;	CX No. of bytes transferred
 26082                                  ;	Carry clear
 26083                                  ;----------------------------------------------------------------------------
 26084                                  
 26085                                  	;entry	AddRec
 26086                                  ADDREC:
 26087 00004199 E309                    	JCXZ	RET28		; If no records read, don't change position
 26088                                  	;add	[es:di+15h],cx
 26089 0000419B 26014D15                	ADD	[ES:DI+SF_ENTRY.sf_position],CX  ; Update current position
 26090                                  	;adc	word [es:di+17h], 0
 26091 0000419F 2683551700              	ADC	WORD [ES:DI+SF_ENTRY.sf_position+2],0
 26092                                  RET28:	
 26093 000041A4 F8                      	CLC
 26094 000041A5 C3                      	retn
 26095                                  
 26096                                  ; 25/07/2018
 26097                                  ; MSDOS 6.0
 26098                                  ;Break   <DskRdBufScan -- Disk Read Buffer Scan>
 26099                                  ;----------------------------------------------------------------------------
 26100                                  ;
 26101                                  ; Procedure Name : DskRdBufScan
 26102                                  ;
 26103                                  ; Inputs:
 26104                                  ;       CX = # of contiguous sectors read. (These constitute a block of
 26105                                  ;            sectors, also termed an "Extent".)
 26106                                  ;       [HIGH_SECTOR]:DX = physical sector # of first sector in extent.
 26107                                  ;       [TEMP_VAR2]:[TEMP_VAR] = Transfer address (destination data address).
 26108                                  ;       ES:BP -> Drive Parameter Block (DPB).
 26109                                  ;
 26110                                  ; Function:
 26111                                  ;	The Buffer Queue is scanned: the contents of any dirty buffers are
 26112                                  ;	"read" into the transfer memory block, so that the transfer memory
 26113                                  ;	reflects the most recent data.
 26114                                  ;
 26115                                  ; Outputs:
 26116                                  ;       Transfer memory updated as required.
 26117                                  ;
 26118                                  ; Uses:
 26119                                  ;       DS,AX,BX,CX,SI,DI destroyed.
 26120                                  ;       SS override for all global variables.
 26121                                  ;
 26122                                  ; Notes:
 26123                                  ;       FIRST_BUFF_ADDR is set-up to contain the LAST buffer to check, rather
 26124                                  ;	than the FIRST.
 26125                                  ;----------------------------------------------------------------------------
 26126                                  ;M039: Created
 26127                                  
 26128                                  ; 04/05/2019 - Retro DOS v4.0
 26129                                  ; DOSCODE:78F0h (MSDOS 6.21, MSDOS.SYS)
 26130                                  
 26131                                  ; 18/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 26132                                  ; DOSCODE:78DCh (MSDOS 5.0, MSDOS.SYS)
 26133                                  
 26134                                  ; 09/02/2024 - Retro DOS v5.0
 26135                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8313h
 26136                                  
 26137                                  ;procedure DskRdBufScan,NEAR
 26138                                  ;
 26139                                  ;ASSUME  DS:NOTHING
 26140                                  
 26141                                  DskRdBufScan:
 26142 000041A6 36833E[7100]00          	cmp	word [ss:DirtyBufferCount],0 ; Any dirty buffers?
 26143 000041AC 743C                    	je	short bufx		     ; -no, skip all work.
 26144                                  
 26145 000041AE 368B1E[0706]            	mov     bx,[ss:HIGH_SECTOR]
 26146 000041B3 89DE                    	mov     si,bx
 26147 000041B5 01D1                    	add     cx,dx
 26148 000041B7 83D600                  	adc     si,0
 26149                                  
 26150 000041BA E8A223                  	call	GETCURHEAD		;DS:DI -> 1st buf in queue.
 26151                                  	;mov	ax,[di+2]
 26152 000041BD 8B4502                  	mov     ax,[di+BUFFINFO.buf_prev]
 26153 000041C0 36A3[1B11]              	mov     [ss:FIRST_BUFF_ADDR],ax
 26154                                  		
 26155                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26156                                  	;;mov	al,[es:bp+0]
 26157                                  	;mov	al,[es:bp+DPB.DRIVE]
 26158                                  	; 15/12/2022
 26159 000041C4 268A4600                	mov	al,[es:bp]
 26160                                  
 26161                                  ;       BX:DX = Extent start.
 26162                                  ;       SI:CX = Extent end + 1.
 26163                                  ;          AL = Drive #.
 26164                                  ;       DS:DI-> 1st buffer in queue.
 26165                                  ;[FIRST_BUFF_ADDR] = Address offset of last buffer in queue.
 26166                                  
 26167                                  bufq:	
 26168                                  	;cmp	al,[di+4]
 26169 000041C8 3A4504                  	cmp     al,[di+BUFFINFO.buf_ID] ;Same drive?
 26170 000041CB 7514                    	jne	short bufq1        	;  -no, jump.
 26171                                  
 26172                                  ;       Cmp32   bx,dx,<WORD PTR [di.buf_sector+2]>,<WORD PTR [di.buf_sector]>
 26173                                  ;       ja	short bufq1		;Jump if Extent start > buffer sector.
 26174                                  
 26175                                  	;cmp	bx,[di+8]
 26176 000041CD 3B5D08                  	cmp	bx,[di+BUFFINFO.buf_sector+2]
 26177 000041D0 7503                    	jne	short bufq01
 26178                                  	;cmp	dx,[di+6]
 26179 000041D2 3B5506                  	cmp	dx,[di+BUFFINFO.buf_sector]
 26180                                  bufq01:
 26181 000041D5 770A                    	ja	short bufq1
 26182                                  
 26183                                  ;       Cmp32   si,cx,<WORD PTR [di.buf_sector+2]>,<WORD PTR [di.buf_sector]>
 26184                                  ;       ja	short bufq2		;Jump if Extent end >= buffer sector.
 26185                                  
 26186                                  	;cmp	si,[di+8]
 26187 000041D7 3B7508                  	cmp	si,[di+BUFFINFO.buf_sector+2]
 26188 000041DA 7503                    	jne	short bufq02
 26189                                  	;cmp	cx,[di+6]
 26190 000041DC 3B4D06                  	cmp	cx,[di+BUFFINFO.buf_sector]
 26191                                  bufq02:
 26192 000041DF 770A                    	ja	short bufq2
 26193                                  bufq1:	
 26194 000041E1 363B3E[1B11]            	cmp     di,[ss:FIRST_BUFF_ADDR]	;Scanned entire buffer queue?
 26195 000041E6 8B3D                    	mov	di,[di]
 26196                                  	;mov	di,[di+BUFFINFO.buf_next] ; Set-up for next buffer.
 26197 000041E8 75DE                    	jne	short bufq		; -no, do next buffer
 26198                                  bufx:
 26199 000041EA C3                      	retn				;Exit.
 26200                                  
 26201                                  ;       Buffer's sector is in Extent: if it is dirty, copy its contents to
 26202                                  ;	transfer memory; otherwise, just re-position it in the buffer queue
 26203                                  ;       as MRU (Most Recently Used).
 26204                                  
 26205                                  bufq2:	
 26206 000041EB 50                      	push	ax
 26207                                  	;test	byte [di+5],40h
 26208 000041EC F6450540                	test	byte [di+BUFFINFO.buf_flags],buf_dirty ;Buffer dirty?
 26209 000041F0 7430                    	jz	short bufq3                    ; -no, jump.
 26210                                  
 26211                                  ;       SaveReg <cx,dx,si,di,es>
 26212 000041F2 51                      	push	cx
 26213 000041F3 52                      	push	dx
 26214 000041F4 56                      	push	si
 26215 000041F5 57                      	push	di
 26216 000041F6 06                      	push	es
 26217                                  
 26218 000041F7 89D0                    	mov     ax,dx
 26219                                  	;sub	ax,[di+6]
 26220 000041F9 2B4506                  	sub	ax,[di+BUFFINFO.buf_sector]
 26221 000041FC F7D8                    	neg	ax
 26222                                  
 26223                                  ;       AX = offset (in sectors) of buffer sector within Transfer memory
 26224                                  ;            block. (Note: the upper word of the sector # may be ignored
 26225                                  ;	     since no more than 64k bytes will ever be read. This 64k limit
 26226                                  ;            is imposed by the input parameters of the disk read operation.)
 26227                                  
 26228                                  	;lea	si,[di+20]
 26229 000041FE 8D7518                  	lea	si,[di+BUFINSIZ]	;DS:SI -> buffer data.
 26230                                  	;mov	cx,[es:bp+2]
 26231 00004201 268B4E02                	mov     cx,[es:bp+DPB.SECTOR_SIZE] ;CX = sector size (in bytes).
 26232 00004205 F7E1                    	mul     cx			;AX = offset (in bytes) of buf. sector
 26233                                  	;mov	di,[ss:TEMP_VAR]
 26234                                  	; 09/02/2024
 26235 00004207 36C43E[0C06]            	les	di,[ss:TEMP_VAR]
 26236 0000420C 01C7                    	add	di,ax
 26237                                  	;mov	es,[ss:TEMP_VAR2]
 26238 0000420E D1E9                    	shr	cx,1
 26239                                  
 26240                                  ;	   CX = sector size (in WORDs) ; CF=1 if odd # of bytes.
 26241                                  ;       DS:SI-> Buffer sector data.
 26242                                  ;       ES:DI-> Destination within Transfer memory block.
 26243                                  
 26244                                  ; 09/02/2024 - Retro DOS v5.0
 26245                                  %if 0
 26246                                  	rep	movsw			;Copy buffer sector to Transfer memory
 26247                                  	;; 04/05/2019
 26248                                  	;;adc	cx,0                    ;CX=1 if odd # of bytes, else CX=0.
 26249                                  	;;rep	movsb                   ;Copy last byte.
 26250                                  	;jnc	short bufq03
 26251                                  	;movsb
 26252                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26253                                  	;adc	cx,0
 26254                                  	;rep	movsb
 26255                                  	; 22/09/2023
 26256                                  	jnc	short bufq03
 26257                                  	movsb
 26258                                  %else
 26259                                  	;;;
 26260                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26261 00004210 36803E[6A00]00          	cmp	byte [ss:DDMOVE],0
 26262                                  	;jz	short bufq03+1 ; rep movsw (skip 32bit prefix)
 26263                                  	; 06/04/2024 
 26264 00004216 7403                    	jz	short bufq03
 26265 00004218 D1E9                    	shr	cx,1
 26266                                  ;bufq03:
 26267                                  	;rep	movsd
 26268                                  	; 06/04/2024
 26269 0000421A 66                      	db	66h	; 32bit prefix
 26270                                  bufq03:
 26271 0000421B F3A5                    	rep	movsw
 26272                                  	;;;
 26273                                  %endif
 26274                                  
 26275                                  ;bufq03:	; 09/02/2024
 26276                                  	;RestoreReg <es,di,si,dx,cx>
 26277 0000421D 07                      	pop	es
 26278 0000421E 5F                      	pop	di
 26279 0000421F 5E                      	pop	si
 26280 00004220 5A                      	pop	dx
 26281 00004221 59                      	pop	cx
 26282                                  
 26283                                  ;       DS:DI -> current buffer.
 26284                                  bufq3:	
 26285 00004222 89F8                    	mov     ax,di			;DS:AX -> Current buffer.
 26286                                          ;invoke SCANPLACE
 26287 00004224 E84A23                  	call	SCANPLACE
 26288 00004227 363B06[1B11]            	cmp	ax,[ss:FIRST_BUFF_ADDR] ;Last buffer?
 26289 0000422C 58                      	pop	ax
 26290                                  	;jne	short bufq		; -no, jump.
 26291                                  	;;jmp	short bufx		; -yes, exit.
 26292                                  	;; 12/06/2019
 26293                                  	;retn
 26294                                  	; 18/11/2022 (MSDOS 5.0 MSDOS.SYS compability)
 26295 0000422D 7599                    	jne	short bufq
 26296                                  	;jmp	short bufx
 26297                                  	; 09/02/2024
 26298 0000422F C3                      	retn	; Exit
 26299                                  
 26300                                  ;EndProc DskRdBufScan
 26301                                  
 26302                                  ;============================================================================
 26303                                  ; DISK3.ASM, MSDOS 6.0, 1991
 26304                                  ;============================================================================
 26305                                  ; 04/05/2019 - Retro DOS v4.0
 26306                                  ; 24/07/2018 - Retro DOS v3.0
 26307                                  
 26308                                  ;Break   <DISKWRITE -- PERFORM USER DISK WRITE>
 26309                                  ;----------------------------------------------------------------------------
 26310                                  ;
 26311                                  ; Procedure Name : DISKWRITE
 26312                                  ;
 26313                                  ; Inputs:
 26314                                  ;       Outputs of SETUP
 26315                                  ; Function:
 26316                                  ;       Perform disk write
 26317                                  ; Outputs:
 26318                                  ;    Carry clear
 26319                                  ;       CX = No. of bytes written
 26320                                  ;       ES:DI point to SFT
 26321                                  ;       SFT offset and cluster pointers updated
 26322                                  ;    Carry set
 26323                                  ;       CX = 0
 26324                                  ;       ES:DI point to SFT
 26325                                  ;       AX has error code
 26326                                  ;----------------------------------------------------------------------------
 26327                                  
 26328                                  ; DOSCODE:797Ah (MSDOS 6.21, MSDOS.SYS)
 26329                                  
 26330                                  ; 20/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 26331                                  ; DOSCODE:7966h (MSDOS 5.0, MSDOS.SYS)
 26332                                  
 26333                                  ; 10/02/2024
 26334                                  ; 09/02/2024 - Retro DOS v5.0
 26335                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:83A3h
 26336                                  
 26337                                  ; (Windows ME IO.SYS - BIOSCODE:0B7B2h)
 26338                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:797Ah)
 26339                                  
 26340                                  DISKWRITE:
 26341                                  	; MSDOS 3.3
 26342                                  	; IBMDOS.COM - Offset 436Dh
 26343                                  	;;test	byte [es:di+4],8
 26344                                  	;TEST	byte [ES:DI+SF_ENTRY.sf_attr],attr_volume_id
 26345                                  	;jz	short write_cont
 26346                                  	;jmp	SET_ACC_ERR_DS
 26347                                  ;write_cont:
 26348                                  	;push	cx
 26349                                  	;or	cx,cx
 26350                                  	;jnz	short Not_Truncate
 26351                                  	;;mov	cx,-1
 26352                                  	;dec	cx
 26353                                  ;Not_Truncate:
 26354                                  	;call	LOCK_CHECK
 26355                                  	;pop	cx
 26356                                  	;jnb	short _WRITE_OK
 26357                                  	;call	WRITE_LOCK_VIOLATION
 26358                                  	;jnb	short DISKWRITE
 26359                                  	;retn
 26360                                  
 26361                                  	; MSDOS 6.0
 26362 00004230 E8ACFC                  	call	CHECK_WRITE_LOCK	;IFS. check write lock	;AN000;
 26363                                  	; 19/08/2018
 26364 00004233 7304                    	JNC	short _WRITE_OK		;IFS. lock check ok	;AN000;
 26365 00004235 C3                      	retn
 26366                                  
 26367                                  WRTEOFJ:
 26368 00004236 E95602                  	JMP	WRTEOF
 26369                                  
 26370                                  _WRITE_OK:
 26371                                   	; 27/07/2018
 26372                                  	; IBMDOS.COM - Offset 438Eh
 26373                                  	
 26374                                  	; MSDOS 3.3 (& MSDOS 6.0)
 26375                                  	;and	word [es:di+5],0BFBFh
 26376 00004239 26816505BFBF            	AND     word [ES:DI+SF_ENTRY.sf_flags],~(sf_close_nodate|devid_file_clean)
 26377                                  				; Mark file as dirty, clear no date on close
 26378                                  ; 10/02/2024
 26379                                  %if 0
 26380                                  	; 04/05/2019 - Retro DOS v4.0
 26381                                  
 26382                                  	; MSDOS 6.0
 26383                                  	;mov 	ax,[es:di+11h]
 26384                                  	MOV	AX,[ES:DI+SF_ENTRY.sf_size]		;M039
 26385                                          MOV	[TEMP_VAR],AX                           ;M039
 26386                                  	;mov	ax,[es:di+13h]
 26387                                  	MOV	AX,[ES:DI+SF_ENTRY.sf_size+2]		;M039
 26388                                          MOV	[TEMP_VAR2],AX                          ;M039
 26389                                  %else
 26390                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS COM)
 26391                                  	;les	ax,[es:di+11h]
 26392 0000423F 26C44511                	les	ax,[es:di+SF_ENTRY.sf_size]
 26393 00004243 8C06[0E06]              	mov	[TEMP_VAR2],es
 26394 00004247 A3[0C06]                	mov	[TEMP_VAR],ax
 26395                                  %endif
 26396                                  
 26397                                  ;	TEMP_VAR2:TEMP_VAR = Current file size (sf_size);M039
 26398                                  
 26399                                  	; MSDOS 3.3 (& MSDOS 6.0)
 26400 0000424A C42E[8A05]              	LES     BP,[THISDPB]
 26401                                  
 26402 0000424E E8D2FD                  	call	BREAKDOWN
 26403                                  
 26404 00004251 A1[CE05]                	MOV     AX,[BYTPOS]
 26405 00004254 8B16[D005]              	MOV     DX,[BYTPOS+2]
 26406 00004258 E3DC                    	JCXZ    WRTEOFJ                 ;Make the file length = sf_position
 26407 0000425A 01C8                    	ADD     AX,CX
 26408 0000425C 83D200                  	ADC     DX,0                    ;DX:AX = last byte to write + 1.
 26409                                  	
 26410                                  	;;;
 26411                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26412 0000425F 7303                    	jnc	short dskwrt_1
 26413                                  ACC_ERRWJ2:
 26414                                  	;;jmp	SET_ACC_ERRW
 26415                                  	;jmp	SET_ACC_ERR_DS ; ds<>ss ; 10/02/2024
 26416                                  	; 10/02/2024
 26417                                  	; ds=ss
 26418 00004261 E959FE                  	jmp	SET_ACC_ERR
 26419                                  
 26420                                  dskwrt_1:
 26421                                  	;test	byte [es:di+3],10h
 26422 00004264 26F6450310              	test	byte [es:di+SF_ENTRY.sf_mode+1],10h
 26423 00004269 750B                    	jnz	short dskwrt_3		; > 2GB file size (up to 4GB) allowed
 26424 0000426B 81FAFF7F                	cmp	dx,7FFFh		; check for 2GB file size limit
 26425 0000426F 7503                    	jne	short dskwrt_2
 26426 00004271 83F8FF                  	cmp	ax,0FFFFh
 26427                                  dskwrt_2:
 26428 00004274 77EB                    	ja	short ACC_ERRWJ2 ; error,
 26429                                  					; file position/pointer overs 2GB limit!
 26430                                  dskwrt_3:
 26431                                  	;;;
 26432                                  
 26433                                  	;mov	bx,[es:bp+2]
 26434 00004276 268B5E02                	MOV     BX,[ES:BP+DPB.SECTOR_SIZE]
 26435                                  
 26436                                  	; MSDOS 3.3
 26437                                  	;cmp	dx,bx
 26438                                  	;jnb	short WRTERR33
 26439                                  	;div	bx
 26440                                  	;mov	bx,ax
 26441                                  	;OR	DX,DX
 26442                                  	;JNZ	short CALCLUS
 26443                                  	;dec	ax
 26444                                  ;CALCLUS:
 26445                                  	; MSDOS 3.3
 26446                                  	;mov	cl,[es:bp+5]
 26447                                  	;MOV	CL,[ES:BP+DPB.CLUSTER_SHIFT]
 26448                                  	;shr	ax,cl
 26449                                  	;push	ax
 26450                                  	;push	dx
 26451                                  	;push	es
 26452                                  	;les	di,[THISSFT]
 26453                                  	;;mov	ax,[es:di+11h]
 26454                                  	;;mov	dx,[es:di+13h]
 26455                                  	;mov	ax,[ES:DI+SF_ENTRY.sf_size]
 26456                                  	;mov	dx,[ES:DI+SF_ENTRY.sf_size+2]
 26457                                  	;pop	es
 26458                                  	;;DX:AX = current file size (in bytes).
 26459                                  	;;div	word [es:bp+2]
 26460                                  	;div	word [ES:BP+DPB.SECTOR_SIZE]
 26461                                  	;mov	cx,ax
 26462                                  	;or	dx,dx
 26463                                  	;jz	short NORND
 26464                                  	;inc	ax
 26465                                  ;NORND:
 26466                                  	; MSDOS 6.0
 26467 0000427A E84603                  	CALL	DIV32                   ;DX:AX/BX = CX:AX + DX (rem.).
 26468 0000427D 89C6                    	MOV	SI,AX
 26469 0000427F 890E[0706]                      MOV	[HIGH_SECTOR],CX
 26470                                  
 26471                                  ;       [HIGH_SECTOR]:SI = Last full sector to write.
 26472                                  
 26473 00004283 09D2                    	OR	DX,DX
 26474 00004285 52                      	PUSH	DX			;M039: Free DX for use by SHR32
 26475 00004286 89CA                    	MOV	DX,CX			;M039
 26476 00004288 7506                    	JNZ	short CALCLUS
 26477 0000428A 83E801                  	SUB	AX,1                    ;AX must be zero base indexed	;AC000;
 26478 0000428D 83DA00                  	SBB	DX,0			;M039 ;F.C. >32mb		;AN000;
 26479                                  
 26480                                  CALCLUS:
 26481                                  	; MSDOS 6.0
 26482 00004290 E85703                  	CALL	SHR32                   ;F.C. >32mb			;AN000;
 26483                                  	;POP	DX
 26484                                  	;;;
 26485                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26486 00004293 59                      	pop	cx
 26487 00004294 87D1                    	xchg	cx,dx
 26488 00004296 51                      	push	cx ; **!
 26489                                  	; cx:ax = Last cluster to write
 26490                                  	;;;
 26491                                  
 26492                                  ;       AX = Last cluster to write.
 26493                                  ;       DX = # of bytes in last sector to write (the "tail").
 26494                                  ;       BX = [ES:BP+DPB.SECTOR_SIZE]
 26495                                  
 26496 00004297 50                      	PUSH	AX ; *!
 26497 00004298 52                      	PUSH	DX
 26498                                  ;M039
 26499 00004299 8B16[0E06]              	mov	dx,[TEMP_VAR2]
 26500 0000429D A1[0C06]                	mov	ax,[TEMP_VAR]           ;DX:AX = current file size (in bytes).
 26501 000042A0 E82003                  	call	DIV32           	;DX:AX/BX = CX:AX + DX (rem.)
 26502 000042A3 890E[0E06]              	mov	[TEMP_VAR2],cx
 26503 000042A7 890E[CA05]              	mov	[VALSEC+2],cx
 26504 000042AB 89C1                    	mov	cx,ax
 26505 000042AD 89F3                    	mov	bx,si
 26506                                  
 26507                                  ;       [HIGH_SECTOR]:BX = Last full sector to write.
 26508                                  ;          [VALSEC+2]:CX = Last full sector of current file.
 26509                                  ;         [TEMP_VAR2]:CX = Last full sector of current file.
 26510                                  ;                     DX = # of bytes in last sector of current file.
 26511                                  ;M039
 26512 000042AF 09D2                    	OR	DX,DX
 26513 000042B1 7407                    	JZ	short NORND
 26514                                  	;ADD	AX,1            	;Round up if any remainder	;AC000;
 26515                                  	;ADC	word [VALSEC+2],0
 26516                                  	; 22/09/2023
 26517 000042B3 40                      	inc	ax  ; 0FFFFh -> 0
 26518 000042B4 7504                    	jnz	short NORND
 26519 000042B6 FF06[CA05]              	inc	word [VALSEC+2]
 26520                                  NORND:	
 26521                                  	; MSDOS 3.3 & MSDOS 6.0
 26522 000042BA A3[C805]                	MOV     [VALSEC],AX
 26523                                  
 26524                                  ;       [VALSEC] = Last sector of current file.
 26525                                  
 26526 000042BD 31C0                    	XOR     AX,AX
 26527 000042BF A3[DE05]                	MOV     [GROWCNT],AX
 26528 000042C2 A3[E005]                	MOV     [GROWCNT+2],AX
 26529 000042C5 58                      	POP     AX		; # of bytes in last sector to write (the "tail").
 26530                                  
 26531                                  	; MSDOS 6.0
 26532 000042C6 8B3E[0706]              	MOV	DI,[HIGH_SECTOR]        ;F.C. >32mb			;AN000;
 26533 000042CA 3B3E[0E06]              	CMP	DI,[TEMP_VAR2]		;M039; F.C. >32mb		;AN000;
 26534 000042CE 726C                    	JB	short NOGROW		;F.C. >32mb                     ;AN000;
 26535 000042D0 7408                    	JZ	short lowsec		;F.C. >32mb                     ;AN000;
 26536 000042D2 29CB                    	SUB	BX,CX                   ;F.C. >32mb                     ;AN000;
 26537 000042D4 1B3E[0E06]              	SBB	DI,[TEMP_VAR2]   	;M039; F.C. >32mb di:bx no. of sectors ;AN000;
 26538 000042D8 EB08                    	JMP	short yesgrow           ;F.C. >32mb                     ;AN000;
 26539                                  lowsec:
 26540                                  	;MOV	DI,0			;F.C. >32mb
 26541                                  	; 22/09/2023
 26542 000042DA 31FF                    	xor	di,di
 26543                                  	; MSDOS 3.3 & MSDOS 6.0
 26544 000042DC 29CB                    	SUB	BX,CX			; Number of full sectors
 26545 000042DE 725C                    	JB	short NOGROW
 26546 000042E0 744D                    	JZ	short TESTTAIL
 26547                                  yesgrow:
 26548                                  	; MSDOS 3.3 (& MSDOS 6.0)
 26549 000042E2 89D1                    	MOV     CX,DX
 26550 000042E4 93                      	XCHG    AX,BX
 26551                                  	;mul	word [es:bp+2]
 26552 000042E5 26F76602                	MUL	word [ES:BP+DPB.SECTOR_SIZE] ; Bytes of full sector growth
 26553                                  	
 26554                                  	; MSDOS 6.0
 26555 000042E9 8916[0706]              	MOV	[HIGH_SECTOR],DX	;F.C. >32mb save dx		;AN000;
 26556 000042ED A3[0E06]                	MOV	[TEMP_VAR2],AX		;M039; F.C. >32mb save ax	;AN000;
 26557 000042F0 89F8                    	MOV	AX,DI			;F.C. >32mb			;AN000;
 26558                                  	;mul	word [es:bp+2]
 26559 000042F2 26F76602                	MUL	word [ES:BP+DPB.SECTOR_SIZE] ;F.C. >32mb do higher word multiply ;AN000;
 26560                                  	
 26561 000042F6 0306[0706]              	ADD	AX,[HIGH_SECTOR]	;F.C. >32mb add lower value	;AN000;
 26562                                  	;MOV	DX,AX			;F.C. >32mb DX:AX is the result of ;AN000;
 26563                                  	; 09/02/2024
 26564 000042FA 92                      	xchg	ax,dx
 26565 000042FB A1[0E06]                	MOV	AX,[TEMP_VAR2]		;M039; F.C. >32mb a 32 bit multiply ;AN000;
 26566                                  
 26567                                  	; MSDOS 3.3 (& MSDOS 6.0)
 26568 000042FE 29C8                    	SUB     AX,CX			; Take off current "tail"
 26569 00004300 83DA00                  	SBB     DX,0			; 32-bit extension
 26570 00004303 01D8                    	ADD     AX,BX			; Add on new "tail"
 26571 00004305 83D200                  	ADC     DX,0			; ripple tim's head off
 26572 00004308 EB2B                    	JMP     SHORT SETGRW
 26573                                  
 26574                                  HAVSTART:
 26575                                  	;int 3
 26576                                  	;;;
 26577                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26578 0000430A 8936[F80A]              	mov	[CLSKIP_HW],si
 26579                                  	;;;
 26580 0000430E 89C1                    	MOV     CX,AX
 26581 00004310 E84011                  	call	SKPCLP
 26582                                  	;;;
 26583                                  	; 09/02/2024
 26584 00004313 A1[F80A]                	mov     ax,[CLSKIP_HW]
 26585 00004316 39C8                    	cmp     ax,cx
 26586 00004318 7502                    	jne     short HAVSTART_cont
 26587                                  	;;;
 26588                                  	; 10/02/2024
 26589 0000431A E311                    	JCXZ	DOWRTJ
 26590                                  	; 16/12/2022
 26591                                  	;jcxz	DOWRT
 26592                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26593                                  	;jcxz	DOWRTJ
 26594                                  	;;;
 26595                                  	; 09/02/2024
 26596                                  HAVSTART_cont:
 26597                                  	;mov	[CCOUNT_HW],ax
 26598                                  	;call	ALLOCATE
 26599                                  	; 07/07/2024
 26600 0000431C E86713                  	call	ALLOCATE_X
 26601                                  	; 10/02/2024
 26602 0000431F 730C                    	JNC	short DOWRTJ
 26603                                  	; 16/12/2022
 26604                                  	;jnc	short DOWRT
 26605                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26606                                  	;jnc	short DOWRTJ
 26607                                  
 26608                                  	; 10/02/2024
 26609                                  	;entry   WRTERR
 26610                                  WRTERR:
 26611 00004321 B40F                    	MOV     AH,0FH			;MS. write/data/fail/abort	;AN000;
 26612                                  
 26613                                  	;entry WRTERR22
 26614                                  WRTERR22:
 26615 00004323 A0[7605]                	MOV     AL,[THISDRV]		;MS.				;AN000;
 26616                                  
 26617                                  	; 27/07/2018
 26618                                  WRTERR33:
 26619                                  	;MOV	CX,0			;No bytes transferred
 26620 00004326 31C9                    	XOR     CX,CX
 26621                                  
 26622 00004328 C43E[9E05]              	LES     DI,[THISSFT]
 26623                                  	;CLC ; 19/05/2019
 26624                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26625                                  	; 16/12/2022
 26626                                  	;clc
 26627 0000432C C3                      	retn
 26628                                  
 26629                                  	; 10/02/2024
 26630                                  	; 16/12/2022
 26631                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26632                                  DOWRTJ:
 26633 0000432D EB79                    	JMP	short DOWRT
 26634                                  
 26635                                  TESTTAIL:
 26636 0000432F 29D0                    	SUB	AX,DX
 26637 00004331 7609                    	JBE	short NOGROW
 26638 00004333 31D2                    	XOR	DX,DX
 26639                                  SETGRW:
 26640 00004335 A3[DE05]                	MOV	[GROWCNT],AX
 26641 00004338 8916[E005]              	MOV	[GROWCNT+2],DX
 26642                                  NOGROW:
 26643                                  	; 09/02/2024
 26644                                  	;POP	AX ; *!
 26645                                  
 26646                                  ; 10/02/2024
 26647                                  %if 0
 26648                                  	MOV     CX,[CLUSNUM] ; *+ ; First cluster accessed
 26649                                  	;;;
 26650                                  	; 09/02/2024
 26651                                  	mov	dx,[CLUSNUM_HW] ; *+
 26652                                  	;;;
 26653                                  	call	FNDCLUS
 26654                                  %else
 26655                                  	; 10/02/2024 - Retro DOS v5.0
 26656 0000433C E8AF10                  	call	FNDCLUS_X ; *+
 26657                                  %endif
 26658                                  	;;;
 26659                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26660 0000433F 58                      	pop	ax ; *!
 26661 00004340 5E                      	pop	si ; **!	; si:ax = Last cluster
 26662                                  	;;;
 26663 00004341 7279                    	JC	short ACC_ERRWJ ; ds=ss
 26664 00004343 891E[BC05]              	MOV	[CLUSNUM],BX
 26665 00004347 8916[BA05]              	MOV	[LASTPOS],DX
 26666                                  
 26667 0000434B 29D0                    	SUB	AX,DX           ; Last cluster minus current cluster
 26668                                  	; 09/02/2024
 26669                                  	;JZ	short DOWRT	; If we have last clus, we must have first
 26670                                  	;;;
 26671                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26672 0000434D 1B36[E20A]              	sbb	si,[LASTPOS_HW]
 26673 00004351 8B16[E80A]              	mov	dx,[CLUSTNUM_HW]
 26674 00004355 8916[DE0A]              	mov	[CLUSNUM_HW],dx
 26675 00004359 7504                    	jnz	short NOGROW2
 26676 0000435B 09C0                    	or	ax,ax
 26677 0000435D 7449                    	jz	short DOWRT
 26678                                  NOGROW2:
 26679 0000435F 3B0E[F80A]              	cmp	cx,[CLSKIP_HW]
 26680 00004363 7502                    	jne	short dskwrt_4
 26681                                  	;;;
 26682 00004365 E3A3                    	JCXZ	HAVSTART        ; See if no more data
 26683                                  dskwrt_4:	; 09/02/2024
 26684 00004367 51                      	PUSH	CX              ; No. of clusters short of first
 26685                                  	;;;
 26686                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26687 00004368 FF36[F80A]              	push	word [CLSKIP_HW]
 26688 0000436C 8936[F00A]              	mov	[CCOUNT_HW],si
 26689                                  	;;;
 26690 00004370 89C1                    	MOV	CX,AX
 26691 00004372 E81413                  	call	ALLOCATE
 26692                                  	;;;
 26693                                  	; 09/02/2024
 26694 00004375 8F06[F80A]              	pop	word [CLSKIP_HW]
 26695                                  	;;;
 26696 00004379 59                      	POP	CX
 26697 0000437A 72A5                    	JC	short WRTERR
 26698 0000437C 8B16[BA05]              	MOV	DX,[LASTPOS]
 26699                                  
 26700                                  ; 09/02/2024
 26701                                  %if 0
 26702                                  	INC	DX
 26703                                  	DEC	CX
 26704                                  	JZ	short NOSKIP
 26705                                  %else
 26706                                  	;;;
 26707                                  	; 09/02/2024 Retro DOS v5.0
 26708                                  	; (PCDOS 7.1 IBMDOS.COM)
 26709                                  	;add	dx,1
 26710                                  	;adc	word [LASTPOS_HW],0
 26711 00004380 42                      	inc	dx
 26712 00004381 7504                    	jnz	short dskwrt_10
 26713 00004383 FF06[E20A]              	inc	word [LASTPOS_HW]
 26714                                  dskwrt_10:
 26715 00004387 83E901                  	sub	cx,1
 26716 0000438A 831E[F80A]00            	sbb	word [CLSKIP_HW],0
 26717 0000438F 7504                    	jnz	short dskwrt_5
 26718 00004391 09C9                    	or	cx,cx
 26719 00004393 7405                    	jz	short NOSKIP
 26720                                  dskwrt_5:
 26721                                  	;;;
 26722                                  %endif
 26723 00004395 E8BB10                  	call	SKPCLP
 26724 00004398 7222                    	JC	short ACC_ERRWJ ; ds=ss ; 10/02/2024
 26725                                  
 26726                                  NOSKIP:
 26727 0000439A 891E[BC05]              	MOV	[CLUSNUM],BX
 26728                                  	;;;
 26729                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26730 0000439E A1[E80A]                	mov	ax,[CLUSTNUM_HW]
 26731 000043A1 A3[DE0A]                	mov	[CLUSNUM_HW],ax
 26732                                  	;;;
 26733 000043A4 8916[BA05]              	MOV	[LASTPOS],DX
 26734                                  DOWRT:
 26735 000043A8 833E[D205]00            	CMP	word [BYTCNT1],0
 26736 000043AD 7410                    	JZ	short WRTMID
 26737                                  	;;;
 26738                                  	; 09/02/2024
 26739 000043AF 8B1E[DE0A]              	mov	bx,[CLUSNUM_HW]
 26740 000043B3 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 26741                                  	;;;
 26742                                  	; 09/02/2024
 26743                                  	;MOV	BX,[CLUSNUM]	 ; (not used in 'BUFWRT') ; 09/02/2024
 26744 000043B7 E86311                  	call	BUFWRT
 26745                                  	;JC	short ACC_ERRWJ
 26746                                  	; 09/02/2024
 26747 000043BA 7303                    	jnc	short WRTMID
 26748                                  
 26749                                  	; 09/02/2024
 26750                                  ACC_ERRWJ:
 26751                                  	; 10/08/2018
 26752                                  	;;JMP	SET_ACC_ERRW
 26753                                  	; 16/12/2022
 26754                                  	;jmp	SET_ACC_ERR_DS ; ds<>ss ; 10/02/2024
 26755                                  	; 10/02/2024
 26756                                  	; ds=ss
 26757 000043BC E9FEFC                  	jmp	SET_ACC_ERR
 26758                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 26759                                  	;;jmp	SET_ACC_ERRW
 26760                                  
 26761                                  WRTMID:
 26762 000043BF A1[D605]                	MOV	AX,[SECCNT]
 26763 000043C2 09C0                    	OR	AX,AX
 26764                                  	; 20/11/2022
 26765                                  	;JZ	short WRTLAST	; 24/07/2019	;M039
 26766                                  	; 10/02/2024
 26767 000043C4 7503                    	jnz	short WRTMID2
 26768 000043C6 E98600                  	jmp     WRTLAST
 26769                                  WRTMID2:
 26770 000043C9 0106[C405]              	ADD	[SECPOS],AX
 26771                                  	; 19/05/2019
 26772                                  	; MSDOS 6.0
 26773 000043CD 8316[C605]00            	ADC	WORD [SECPOS+2],0	;F.C. >32mb 	;AN000;
 26774 000043D2 E8A311                  	call	NEXTSEC
 26775                                  	; 16/12/2022
 26776 000043D5 72E5                    	JC	short ACC_ERRWJ
 26777                                  	;JC	short SET_ACC_ERRW	;M039
 26778 000043D7 C606[7405]01            	MOV	BYTE [TRANS],1		; A transfer is taking place
 26779 000043DC 8A16[7305]              	MOV	DL,[SECCLUSPOS] 	; (dx/DL = Extent start) ((dh = ?))
 26780                                  	;;;
 26781                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26782 000043E0 8B1E[DE0A]              	mov	bx,[CLUSNUM_HW]
 26783 000043E4 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 26784                                  	;;;
 26785 000043E8 8B1E[BC05]              	MOV	BX,[CLUSNUM]
 26786 000043EC 8B0E[D605]              	MOV	CX,[SECCNT]
 26787                                  WRTLP:
 26788 000043F0 E8CC11                  	call	OPTIMIZE
 26789                                  	; 09/02/2024
 26790                                  	;JC	short SET_ACC_ERRW
 26791                                  	; 16/12/2022
 26792 000043F3 72C7                    	JC	short ACC_ERRWJ  ; ds=ss ; 10/02/2024
 26793                                  
 26794                                  ;M039
 26795                                  ;       DI = Next physical cluster.
 26796                                  ;       AX = # sectors remaining.
 26797                                  ;       [DMAADD+2]:BX = transfer address (source data address).
 26798                                  ;       CX = # of contiguous sectors to write. (These constitute a block of
 26799                                  ;	     sectors, also termed an "Extent".)
 26800                                  ;       [HIGH_SECTOR]:DX = physical sector # of first sector in extent.
 26801                                  ;       ES:BP -> Drive Parameter Block (DPB).
 26802                                  ;
 26803                                  ;       Purge the Buffer Queue and the Secondary Cache of any buffers which
 26804                                  ;	are in Extent; they are being over-written.
 26805                                  
 26806                                  	;;;
 26807                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26808 000043F5 FF36[EC0A]              	push    word [CCONTENT_HW]
 26809                                  	;;;
 26810                                  
 26811 000043F9 57                      	push    di		; CCONTENT_HW:DI = Next physical cluster
 26812 000043FA 50                      	push    ax		; AX = # sectors remaining
 26813                                  
 26814                                  	; MSDOS 3.3
 26815                                  	; IBMDOS.COM (1987) - Offset 4497h
 26816                                  	;push	dx
 26817                                  	;push	bx
 26818                                  	;mov	al,[es:bp]
 26819                                  	;;mov	AL,[ES:BP+DPB.DRIVE] ; mov al,[es:bp+0]
 26820                                  	;mov	bx,cx
 26821                                  	;add	bx,dx	; (bx = Extent end)
 26822                                  
 26823                                  ;	DX = Extent start.
 26824                                  ;	BX = Extent end.
 26825                                  ;	AL = Drive #.
 26826                                  
 26827                                  	;call	SETVISIT
 26828                                  
 26829                                  ;wbufq1:
 26830                                  	;;or	byte [di+5],20h
 26831                                  	;or	byte [DI+BUFFINFO.buf_flags],buf_visit ; Bit 5 = reserved
 26832                                  	;;cmp	al,[di+4]	
 26833                                  	;cmp	al,[DI+BUFFINFO.buf_ID]
 26834                                  	;jnz	short wbufq2	; Jump if Extent start > buffer sector.
 26835                                  	;;cmp	[di+6],dx
 26836                                  	;cmp	[DI+BUFFINFO.buf_sector],dx
 26837                                  	;jb	short wbufq2
 26838                                  	;;cmp	[di+6],bx
 26839                                  	;cmp	[DI+BUFFINFO.buf_sector],bx
 26840                                  	;jnb	short wbufq2	; Jump if Extent end >= buffer sector.
 26841                                  
 26842                                  	;; Buffer sector is in the Extent
 26843                                  
 26844                                  	;;mov	word [di+4],20FFh
 26845                                  	;mov	word [DI+BUFFINFO.buf_ID],20FFh
 26846                                  	;				; .buf_ID,    AL = FFh (Free buffer)
 26847                                  	;				; .buf_flags, AH = 0, reset/clear
 26848                                  	;call	SCANPLACE
 26849                                  ;wbufq2:
 26850                                  	;call	SKIPVISIT
 26851                                  	;jnz	short wbufq1
 26852                                  	;pop	bx
 26853                                  	;pop	dx
 26854                                  
 26855                                          ; MSDOS 6.0
 26856 000043FB E87801                  	call	DskWrtBufPurge		;DS trashed.
 26857                                  
 26858                                  ;ASSUME DS:NOTHING
 26859                                  ;M039
 26860                                  	; MSDOS 3.3 & MSDOS 6.0
 26861                                  ;hkn; SS override for DMAADD and ALLOWED
 26862 000043FE 368E1E[2E03]            	MOV     DS,[SS:DMAADD+2]
 26863                                  	;mov	byte [ss:ALLOWED],38h
 26864 00004403 36C606[4B03]38          	MOV	byte [SS:ALLOWED],Allowed_RETRY+Allowed_FAIL+Allowed_IGNORE
 26865                                  
 26866                                  ;	put logic from DWRITE in-line here so we can modify it
 26867                                  ;	for DISK FULL conditions.
 26868                                  
 26869                                  	; 20/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 26870                                  	; DOSCODE:7AD8h (MSDOS 5.0 MSDOS.SYS)
 26871                                  
 26872                                  	; 16/12/2022
 26873                                  	; MSDOS 3.3 (& MSDOS 5.0)
 26874                                  	;call	DWRITE
 26875                                  
 26876                                  ;DWRITE_OKAY:
 26877                                  
 26878                                  	; 16/12/2022
 26879                                  	; MSDOS 5.0 (& MSDOS 3.3)
 26880                                  	;pop	cx
 26881                                  	;pop	bx
 26882                                  	;push	ss
 26883                                  	;pop	ds
 26884                                  	;jc	short SET_ACC_ERRW
 26885                                  	;jcxz	WRTLAST
 26886                                  	;mov	dl,0
 26887                                  	;inc	word [LASTPOS]
 26888                                  	;jmp	short WRTLP
 26889                                  
 26890                                  	; 16/12/2022
 26891                                  	; 20/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 26892                                  DWRITE_LUP:
 26893                                  	; 23/07/2019 - Retro DOS v3.2
 26894                                  
 26895                                  	; MSDOS 6.0
 26896 00004409 E82CFB                  	call	DSKWRITE
 26897 0000440C 7417                    	jz	short DWRITE_OKAY ; ds<>ss
 26898                                  
 26899                                  ;;	int	3
 26900                                  
 26901 0000440E 3C27                    	cmp	al,error_handle_Disk_Full	; compressed volume full?
 26902 00004410 742D                    	jz	short DWRITE_DISK_FULL
 26903                                  
 26904                                  	; 16/12/2022
 26905                                  
 26906                                  ;;hkn; SS override
 26907 00004412 36C606[7505]01          	MOV	BYTE [SS:READOP],1
 26908 00004418 E84CFB                  	call	HARDERRRW
 26909 0000441B 3C01                    	CMP	AL,1		; Check for retry
 26910 0000441D 74EA                    	JZ	short DWRITE_LUP
 26911                                  
 26912                                  	; 16/12/2022
 26913                                  	; 23/07/2019
 26914                                  	;POP	CX ; *4*
 26915                                  	;POP	BX ; *5*
 26916                                  	;
 26917                                  	;push	ss
 26918                                  	;pop	ds
 26919                                  	;
 26920                                  
 26921                                  	; 20/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 26922                                  
 26923                                  	; 16/12/2022
 26924 0000441F 3C03                    	CMP	AL,3		; Check for FAIL
 26925 00004421 F8                      	CLC
 26926 00004422 7501                    	JNZ	short DWRITE_OKAY ; Ignore
 26927 00004424 F9                      	STC
 26928                                  
 26929                                  DWRITE_OKAY:
 26930                                  	; 16/12/2022
 26931                                  	; 23/07/2019
 26932                                  	; MSDOS 3.3 (& MSDOS 6.0)
 26933 00004425 59                      	POP	CX ; *4*
 26934 00004426 5B                      	POP	BX ; *5*
 26935                                  
 26936                                  ;       CX = # sectors remaining.
 26937                                  ;       BX = Next physical cluster.
 26938                                  
 26939                                  ;hkn; SS override
 26940                                          ;Context DS
 26941                                  	; 16/12/2022
 26942                                  	;push	ss
 26943                                  	;pop	ds
 26944                                  
 26945                                  	; 09/02/2024 - Retro DOS v5.0
 26946                                  	; 16/12/2022
 26947                                  	;jc	short SET_ACC_ERRW
 26948                                  
 26949                                  	; 16/12/2022
 26950 00004427 16                      	push	ss
 26951 00004428 1F                      	pop	ds
 26952                                  
 26953                                  	;;;
 26954                                  	; 09/02/2024 - Retro DOS v5.0
 26955                                  	; (PCDOS 7.1 IBMDOS.COM)
 26956 00004429 8F06[E80A]              	pop	word [CLUSTNUM_HW] ; CLUSTNUM_HW:BX = Next physical cluster
 26957 0000442D 725D                    	jc	short SET_ACC_ERRW ; ds=ss
 26958                                  	;;;
 26959                                  
 26960 0000442F E31E                    	JCXZ    WRTLAST
 26961                                  
 26962                                  	; 10/02/2024
 26963 00004431 B200                    	MOV	DL,0
 26964                                  	;xor	dl,dl ; 23/07/2019
 26965 00004433 FF06[BA05]              	INC     word [LASTPOS]	; We'll be using next cluster
 26966                                  	;;;
 26967                                  	; 09/02/2024 - Retro DOS v5.0
 26968                                  	; (PCDOS 7.1 IBMDOS.COM)
 26969 00004437 75B7                    	jnz	short WRTLP
 26970 00004439 FF06[E20A]              	inc	word [LASTPOS_HW]
 26971                                  	;;;
 26972 0000443D EBB1                    	JMP     short WRTLP
 26973                                  
 26974                                  	; 23/07/2019 - Retro DOS v3.2
 26975                                  	; 09/08/2018
 26976                                  	; MSDOS 6.0
 26977                                  DWRITE_DISK_FULL:
 26978                                  	;Context DS		;SQ 3-5-93 DS must be setup on return!
 26979                                  	; 16/12/2022
 26980 0000443F 16                      	push	ss
 26981 00004440 1F                      	pop	ds
 26982 00004441 59                      	pop	cx		; unjunk stack
 26983 00004442 5B                      	pop	bx
 26984                                  	;;;
 26985                                  	; 09/02/2024 (PCDOS 7.1 IBMDOS.COM)
 26986 00004443 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 26987                                  	;;;
 26988 00004447 C606[0B06]01            	mov	byte [DISK_FULL],1
 26989                                  	;stc
 26990 0000444C E9D2FE                  	jmp	WRTERR ; 24/07/2019 ; go to disk full exit
 26991                                  
 26992                                  WRTLAST:
 26993 0000444F A1[D405]                	MOV     AX,[BYTCNT2]
 26994 00004452 09C0                    	OR      AX,AX
 26995 00004454 7413                    	JZ	short FINWRT
 26996 00004456 A3[D205]                	MOV     [BYTCNT1],AX
 26997 00004459 E81C11                  	call	NEXTSEC
 26998 0000445C 722E                    	JC	short SET_ACC_ERRW
 26999 0000445E C706[CC05]0000          	MOV     word [BYTSECPOS],0
 27000 00004464 E8B610                  	call	BUFWRT
 27001 00004467 7223                    	JC	short SET_ACC_ERRW
 27002                                  
 27003                                  FINWRT:
 27004 00004469 C43E[9E05]              	LES     DI,[THISSFT]
 27005 0000446D A1[DE05]                	MOV     AX,[GROWCNT]
 27006 00004470 8B0E[E005]              	MOV     CX,[GROWCNT+2]
 27007 00004474 09C0                    	OR      AX,AX
 27008 00004476 7502                    	JNZ	short UPDATE_size
 27009 00004478 E30F                    	JCXZ    SAMSIZ
 27010                                  UPDATE_size:
 27011                                  	;add	[es:di+11h],ax
 27012 0000447A 26014511                	ADD     [ES:DI+SF_ENTRY.sf_size],AX
 27013                                  	;adc	[es:di+13h],cx
 27014 0000447E 26114D13                	ADC     [ES:DI+SF_ENTRY.sf_size+2],CX
 27015                                  
 27016                                  ; Make sure that all other SFT's see this growth also.
 27017                                  
 27018 00004482 B80100                  	MOV     AX,1
 27019                                  ;if installed
 27020                                  	;Call	JShare + 14 * 4
 27021 00004485 FF1E[C800]              	call    far [JShare+(14*4)]	; 14 = ShSU
 27022                                  ;else
 27023                                  ;	Call    ShSU
 27024                                  ;endif
 27025                                  
 27026                                  SAMSIZ:
 27027 00004489 E9E2FC                  	jmp	SETCLUS	; ES:DI already points to SFT
 27028                                  
 27029                                  	; 16/12/2022
 27030                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27031                                  SET_ACC_ERRW:
 27032                                  	;jmp	SET_ACC_ERR_DS ; ds<>ss ; 10/02/2024
 27033                                  	; 10/02/2024
 27034                                  	; ds=ss
 27035 0000448C E92EFC                  	jmp	SET_ACC_ERR
 27036                                  
 27037                                  WRTEOF:
 27038 0000448F 89C1                    	MOV     CX,AX
 27039 00004491 09D1                    	OR      CX,DX
 27040                                  	;JZ	short KILLFIL
 27041                                  	; 10/02/2024
 27042 00004493 7503                    	jnz	short WRTEOF1
 27043 00004495 E9A600                  	jmp	KILLFIL
 27044                                  
 27045                                  	;;;
 27046                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27047                                  WRTEOF1:
 27048 00004498 81FAFF7F                	cmp	dx,7FFFh       ; 2GB file size limit
 27049 0000449C 7503                    	jne	short WRTEOF2
 27050 0000449E 83F8FF                  	cmp	ax,0FFFFh
 27051                                  WRTEOF2:
 27052 000044A1 760D                    	jna	short WRTEOF3
 27053                                  	;
 27054 000044A3 06                      	push	es
 27055                                  	;les	di,ds:THISSFT
 27056                                  	; 27/06/2024
 27057 000044A4 C43E[9E05]              	les	di,[THISSFT]
 27058                                  	;test	byte [es:di+3],10h
 27059 000044A8 26F6450310              	test	byte [es:di+SF_ENTRY.sf_mode+1],10h
 27060 000044AD 07                      	pop	es
 27061 000044AE 74DC                    	jz	short SET_ACC_ERRW ; > 2GB file size not allowed
 27062                                  WRTEOF3:
 27063                                  	;;;
 27064                                  
 27065 000044B0 83E801                  	SUB     AX,1
 27066 000044B3 83DA00                  	SBB     DX,0
 27067                                  
 27068                                  	; MSDOS 3.3
 27069                                  	;;div	word [es:bp+2]
 27070                                  	;div	word [ES:BP+DPB.SECTOR_SIZE]
 27071                                  	;;mov	cl,[es:bp+5]
 27072                                  	;mov	cl,[ES:BP+DPB.CLUSTER_SHIFT]
 27073                                  	;shr	ax,cl
 27074                                  
 27075                                  	; MSDOS 6.0
 27076 000044B6 53                      	PUSH	BX
 27077                                  	;mov	bx,[es:bp+2]
 27078 000044B7 268B5E02                	MOV	BX,[ES:BP+DPB.SECTOR_SIZE]    ;F.C. >32mb                       ;AN000;
 27079 000044BB E80501                  	CALL	DIV32                         ;F.C. >32mb                       ;AN000;
 27080 000044BE 5B                      	POP	BX			      ;F.C. >32mb			;AN000;
 27081 000044BF 89CA                    	MOV	DX,CX			      ;M039
 27082 000044C1 890E[0706]                      MOV	[HIGH_SECTOR],CX              ;M039: Probably extraneous, but not sure.
 27083 000044C5 E82201                  	CALL	SHR32                         ;F.C. >32mb                       ;AN000;
 27084                                  
 27085 000044C8 89C1                    	MOV     CX,AX
 27086 000044CA E8290F                  	call	FNDCLUS
 27087                                  SET_ACC_ERRWJ2:
 27088 000044CD 72BD                    	JC	short SET_ACC_ERRW
 27089                                  	;;;
 27090                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27091 000044CF A1[F80A]                	mov	ax,[CLSKIP_HW]
 27092 000044D2 39C8                    	cmp	ax,cx
 27093 000044D4 7502                    	jne	short dskwrt_6
 27094                                  	;;;
 27095                                  	
 27096 000044D6 E324                    	JCXZ    RELFILE
 27097                                  	
 27098                                  	;;;
 27099                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27100                                  dskwrt_6:
 27101                                  	;mov	[CCOUNT_HW],ax
 27102                                  	;;;;
 27103                                  	;
 27104                                  	;call	ALLOCATE
 27105                                  	; 07/07/2024
 27106 000044D8 E8AB11                  	call	ALLOCATE_X
 27107                                  	;JC	short WRTERRJ              ;;;;;;;;; disk full
 27108                                  	; 16/12/2022
 27109 000044DB 7303                    	jnc	short UPDATE
 27110 000044DD E941FE                  	JMP	WRTERR
 27111                                  UPDATE:
 27112 000044E0 C43E[9E05]              	LES	DI,[THISSFT]
 27113 000044E4 A1[CE05]                	MOV	AX,[BYTPOS]
 27114                                  	;mov	[es:di+11h],ax
 27115 000044E7 26894511                	MOV	[ES:DI+SF_ENTRY.sf_size],AX
 27116 000044EB A1[D005]                	MOV	AX,[BYTPOS+2]
 27117                                  	;mov	[es:di+13h],ax
 27118 000044EE 26894513                	MOV	[ES:DI+SF_ENTRY.sf_size+2],AX
 27119                                  ;
 27120                                  ; Make sure that all other SFT's see this growth also.
 27121                                  ;
 27122 000044F2 B80200                  	MOV     AX,2
 27123                                  ;if installed
 27124                                  	;Call	JShare + 14 * 4
 27125 000044F5 FF1E[C800]              	call    far [JShare+(14*4)]	; 14 = ShSU
 27126                                  ;else
 27127                                  ;	Call    ShSU
 27128                                  ;endif
 27129 000044F9 31C9                    	XOR     CX,CX ; 0
 27130                                  	;jmp	ADDREC
 27131                                  	; 08/02/2024
 27132 000044FB C3                      	retn
 27133                                  
 27134                                  	; 16/12/2022
 27135                                  ;WRTERRJ: 
 27136                                  	;JMP	WRTERR
 27137                                  
 27138                                  ;;;;;;;;;;;;;;;; 7/18/86
 27139                                  ;;;;;;;;;;;;;;;;
 27140                                  
 27141                                  RELFILE:
 27142                                  	; MSDOS 6.0
 27143 000044FC 06                      	PUSH	ES			;AN002; BL Reset Lstclus and cluspos to
 27144 000044FD C43E[9E05]              	LES	DI,[THISSFT]		;AN002; BL beginning of file if current
 27145                                  	;;;
 27146                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27147 00004501 50                      	push	ax			; cluspos is past EOF.
 27148 00004502 A1[E20A]                	mov	ax,[LASTPOS_HW]
 27149 00004505 263B450B                	cmp	ax,[es:di+0Bh]		; [ES:DI+SF_ENTRY.sf_firclus]
 27150                                  	;cmp	ax,[es:di+SF_ENTRY.sf_cluspos_hw]
 27151 00004509 58                      	pop	ax
 27152 0000450A 7504                    	jne	short dskwrt_7
 27153                                  	;;;
 27154                                  	;cmp	dx,[es:di+19h]
 27155 0000450C 263B5519                	CMP	DX,[ES:DI+SF_ENTRY.sf_cluspos]	;AN002; BL cluspos is past EOF.
 27156                                  dskwrt_7:	; 10/02/2024
 27157 00004510 731C                    	JAE	short SKIPRESET			;AN002; BL
 27158                                  	;;;
 27159                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27160 00004512 268B552B                	mov     dx,[es:di+2Bh]		; [ES:DI+SF_ENTRY.sf_chain]
 27161                                  	;mov	dx,[es:di+SF_ENTRY_sf_fcluster]	; first cluster (32 bit) lw !?
 27162                                  	;;;
 27163                                  	;mov	[es:di+19h],0
 27164 00004516 26C745190000            	MOV	word [ES:DI+SF_ENTRY.sf_cluspos],0 ;AN002; BL
 27165                                  ; 10/02/2024
 27166                                  %if 0
 27167                                  	;mov	dx,[es:di+0Bh]
 27168                                  	MOV	DX,[ES:DI+SF_ENTRY.sf_firclus]	;AN002; BL
 27169                                  %else
 27170                                  	;;;
 27171                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27172 0000451C 26C7450B0000            	mov     word [es:di+0Bh],0
 27173                                  	;mov	word [es:di+SF_ENTRY.sf_cluspos_hw],0
 27174                                  	;;;
 27175                                  %endif
 27176                                  	;mov	[es:di+35h],dx
 27177 00004522 26895535                	MOV	[ES:DI+SF_ENTRY.sf_lstclus],DX	;AN002; BL
 27178                                  	;;;
 27179                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27180 00004526 268B552D                	mov	dx,[es:di+2Dh]		; [ES:DI+SF_ENTRY.sf_chain]
 27181                                  	;mov	di,[es:di+SF_ENTRY_sf_fcluster+2] ; first clust (32 bit) hw !?
 27182 0000452A 26895537                	mov	[es:di+37h],dx	
 27183                                  	;mov	[es:di+SF_ENTRY.sf_lstclus+2],dx
 27184                                  	;;;
 27185                                  
 27186                                  SKIPRESET:                            		;AN002; BL
 27187 0000452E 07                      	POP     ES                    		;AN002; BL
 27188                                  ;
 27189                                  ; 10/02/2024
 27190                                  %if 0
 27191                                  	MOV     DX,0FFFFH
 27192                                  %else
 27193                                  	;;;
 27194                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27195 0000452F 31D2                    	xor	dx,dx
 27196 00004531 4A                      	dec	dx
 27197 00004532 8916[EA0A]              	mov	[CLUSDATA_HW],dx ; 0FFFFh
 27198                                  	;;;
 27199                                  %endif
 27200 00004536 E84313                  	call	RELBLKS
 27201                                  	; 16/12/2022
 27202                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27203                                  dskwrt_8:	; 10/02/2024
 27204 00004539 73A5                    	jnc	short UPDATE
 27205                                  SET_ACC_ERRWJ:
 27206                                  	;JC	short SET_ACC_ERRWJ2
 27207                                  	;JMP	SHORT UPDATE
 27208                                  	; 16/12/2022
 27209                                  	;jmp	SET_ACC_ERR_DS ; ds<>ss
 27210                                  	; 10/02/2024
 27211                                  	; ds=ss
 27212 0000453B E97FFB                  	jmp	SET_ACC_ERR
 27213                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27214                                  	;JC	short SET_ACC_ERRWJ2
 27215                                  	;JMP	SHORT UPDATE
 27216                                  
 27217                                  KILLFIL:
 27218 0000453E 31DB                    	XOR     BX,BX
 27219 00004540 06                      	PUSH    ES
 27220 00004541 C43E[9E05]              	LES     DI,[THISSFT]
 27221                                  
 27222                                  ; 10/02/2024
 27223                                  %if 0
 27224                                  	;mov	[es:di+19h],bx
 27225                                  	MOV	[ES:DI+SF_ENTRY.sf_cluspos],BX
 27226                                  	;mov	[es:di+35h],bx ; 04/05/2019
 27227                                  	MOV	[ES:DI+SF_ENTRY.sf_lstclus],BX
 27228                                  	;xchg	bx,[es:di+0Bh]
 27229                                  	XCHG    BX,[ES:DI+SF_ENTRY.sf_firclus]
 27230                                  %else
 27231                                  	;;;
 27232                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27233 00004545 26875D2D                	xchg	bx,[es:di+2Dh]	; [ES:DI+SF_ENTRY.sf_chain+2]
 27234                                  	;xchg	bx,[es:di+SF_ENTRY.sf_fcluster+2] ; first clust (32 bit) hw !?
 27235 00004549 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 27236 0000454D 31DB                    	xor	bx,bx	; 0
 27237 0000454F 26895D0B                	mov	[es:di+0Bh],bx	; [ES:DI+SF_ENTRY.sf_firclus]
 27238                                  	;mov	[es:di+SF_ENTRY.sf_cluspos_hw],bx
 27239 00004553 26895D37                	mov	[es:di+37h],bx
 27240                                  	;mov	[es:di+SF_ENTRY.sf_lstclus+2],bx
 27241                                  	;mov	[es:di+19h],bx
 27242 00004557 26895D19                	mov	[es:di+SF_ENTRY.sf_cluspos],bx
 27243                                  	;mov	[es:di+35h],bx
 27244 0000455B 26895D35                	mov	[es:di+SF_ENTRY.sf_lstclus],bx
 27245 0000455F 26875D2B                	xchg	bx,[es:di+2Bh]	; [ES:DI+SF_ENTRY.sf_chain]
 27246                                  	;xchg	bx,[es:di+SF_ENTRY.sf_fcluster]	; first cluster (32 bit) lw !?
 27247                                  	;;;
 27248                                  %endif
 27249                                  
 27250 00004563 07                      	POP	ES
 27251                                  
 27252                                  	;;;
 27253                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27254 00004564 3B1E[E80A]              	cmp	bx,[CLUSTNUM_HW]
 27255 00004568 7507                    	jnz	short dskwrt_9
 27256                                  	;;;
 27257                                  
 27258 0000456A 09DB                    	OR	BX,BX
 27259                                  	;JZ	short UPDATEJ
 27260                                  	; 16/12/2022
 27261                                  	;jz	short UPDATE
 27262                                  	; 10/12/2024
 27263 0000456C 7503                    	jnz	short dskwrt_9
 27264 0000456E E96FFF                  	jmp	UPDATE
 27265                                  
 27266                                  	; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27267                                  	;jz	short UPDATEJ
 27268                                  
 27269                                  dskwrt_9:	; 10/02/2024
 27270                                  
 27271                                  ;; 10/23/86 FastOpen update
 27272                                  	; 03/03/2025 (MiniDOS)
 27273                                  	;PUSH	ES			; since first cluster # is 0
 27274                                  	;PUSH	BP			; we must delete the old cache entry
 27275                                  	;PUSH	AX
 27276                                  	;PUSH	CX
 27277                                  	;PUSH	DX
 27278                                  	;LES	BP,[THISDPB]		; get current DPB
 27279                                  	;; 15/12/2022
 27280                                  	;mov	dl,[ES:BP] ; mov dl,[es:bp+0]
 27281                                  	;; 20/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27282                                  	;;MOV	DL,[ES:BP+DPB.DRIVE]	; get current drive
 27283                                  	;MOV	CX,BX			; first cluster #
 27284                                  	;MOV	AH,2			; delete cache entry by drive:firclus
 27285                                  	;call	FastOpen_Update		; call fastopen
 27286                                  	;POP	DX
 27287                                  	;POP	CX
 27288                                  	;POP	AX
 27289                                  	;POP	BP
 27290                                  	;POP	ES
 27291                                  ;; 10/23/86 FastOpen update
 27292                                  
 27293 00004571 E80213                  	call	RELEASE
 27294                                  	;JC	short SET_ACC_ERRWJ
 27295                                  ;UPDATEJ:
 27296                                  	; 20/11/2022
 27297                                  	;JMP	short UPDATE ; 10/08/2018
 27298                                  	; 10/02/2024
 27299 00004574 EBC3                    	jmp	short dskwrt_8
 27300                                  
 27301                                  ;Break   <DskWrtBufPurge -- Disk Write Buffer Purge>
 27302                                  ;----------------------------------------------------------------------------
 27303                                  ;
 27304                                  ; Procedure Name : DskWrtBufPurge
 27305                                  ;
 27306                                  ; Inputs:
 27307                                  ;       CX = # of contiguous sectors to write. (These constitute a block of
 27308                                  ;	     sectors, also termed an "Extent".)
 27309                                  ;       [HIGH_SECTOR]:DX = physical sector # of first sector in extent.
 27310                                  ;       ES:BP -> Drive Parameter Block (DPB).
 27311                                  ;
 27312                                  ; Function:
 27313                                  ;       Purge the Buffer Queue and the Secondary Cache of any buffers which
 27314                                  ;	are in Extent; they are being over-written.
 27315                                  ;
 27316                                  ; Outputs:
 27317                                  ;       (Same as Input.)
 27318                                  ; Uses:
 27319                                  ;       All registers except DS,AX,SI,DI preserved.
 27320                                  ;       SS override for all global variables.
 27321                                  ;----------------------------------------------------------------------------
 27322                                  ;M039: Created
 27323                                  
 27324                                  ;procedure   DskWrtBufPurge,NEAR
 27325                                  ;
 27326                                  ;ASSUME  DS:NOTHING
 27327                                  
 27328                                  ; 04/05/2019 - Retro DOS v4.0
 27329                                  ; DOSCODE:7C0Eh (MSDOS 6.21, MSDOS.SYS)
 27330                                  
 27331                                  ; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27332                                  ; DOSCODE:7BD4h (MSDOS 5.0, MSDOS.SYS)
 27333                                  
 27334                                  ; 10/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 27335                                  ; DOSCODE:8714h (PCDOS 7.1, IBMDOS.COM)
 27336                                  
 27337                                  ; NOTE: Secondary (Buffer) Cache is not used in PCDOS 7.1 IBMDOS.COM
 27338                                  
 27339                                  ; (Win ME IO.SYS - BIOSCODE:BB93h)
 27340                                  ; (MSDOS 6.22 IO.SYS - DOSCODE:7C0Eh)
 27341                                  
 27342                                  DskWrtBufPurge:
 27343                                  	;SaveReg <bx,cx>
 27344 00004576 53                      	push	bx
 27345 00004577 51                      	push	cx
 27346                                  
 27347 00004578 368B1E[0706]            	mov	bx,[ss:HIGH_SECTOR]	;BX:DX = Extent start (sector #).
 27348 0000457D 89DE                    	mov	si,bx
 27349 0000457F 01D1                    	add	cx,dx
 27350 00004581 83D600                  	adc	si,0                    ;SI:CX = Extent end + 1.
 27351                                  
 27352                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27353                                  	;;mov	al,[es:bp+0]
 27354                                  	;mov	al,[es:bp+DPB.DRIVE]
 27355                                  	; 15/12/2022
 27356 00004584 268A4600                	mov	al,[es:bp]
 27357                                  
 27358                                  ; 10/02/2024 - Retro DOS v5.0
 27359                                  ; PCDOS 7.1 IBMDOS.COM
 27360                                  %if 0
 27361                                  
 27362                                  ;	BX:DX = Extent start.
 27363                                  ;	SI:CX = Extent end + 1.
 27364                                  ;	AL = Drive #
 27365                                  
 27366                                  	cmp	word [ss:SC_CACHE_COUNT],0 ;Secondary cache in-use?
 27367                                  	je	short nosc		; -no, jump.
 27368                                  
 27369                                  ;	If any of the sectors to be written are in the secondary cache (SC),
 27370                                  ;	invalidate the entire SC. (This is an optimization; we really only
 27371                                  ;	need to invalidate those sectors which intersect, but that's slower.)
 27372                                  
 27373                                  	cmp	al,[ss:CurSC_DRIVE]	;Same drive?
 27374                                  	jne	short nosc		; -no, jump.
 27375                                  
 27376                                  	push    ax
 27377                                  	mov     ax,[ss:CurSC_SECTOR]
 27378                                  	mov     di,[ss:CurSC_SECTOR+2]	;DI:AX = SC start.
 27379                                  
 27380                                  	;Cmp32	si,cx,di,ax		;Extent end < SC start?
 27381                                  	;jbe	short sc5		; -yes, jump.
 27382                                  
 27383                                  	cmp	si,di
 27384                                  	jne	short sc01
 27385                                  	cmp	cx,ax
 27386                                  sc01: 
 27387                                  	jbe	short sc5
 27388                                  
 27389                                  	add	ax,[ss:SC_CACHE_COUNT]
 27390                                  	adc	di,0                    ;DI:AX = SC end + 1.
 27391                                  	
 27392                                  	;Cmp32	bx,dx,di,ax             ;Extent start > SC end?
 27393                                  	;jae	short sc5		; -yes, jump.
 27394                                  
 27395                                  	cmp	bx,di
 27396                                  	jne	short sc02
 27397                                  	cmp	dx,ax
 27398                                  sc02:
 27399                                  	jnb	short sc5
 27400                                  
 27401                                  	mov	word [ss:SC_STATUS],0	;Extent intersects SC: invalidate SC.
 27402                                  sc5:	
 27403                                  	pop     ax
 27404                                  
 27405                                  %endif
 27406                                  
 27407                                  ;	Free any buffered sectors which are in Extent; they are being over-
 27408                                  ;	written.
 27409                                  
 27410                                  nosc:	
 27411 00004588 E8D41F                  	call	GETCURHEAD		;DS:DI -> first buffer in queue.
 27412                                  
 27413                                  _bufq:	
 27414                                  	;cmpo	al,[di+4]
 27415 0000458B 3A4504                  	cmp     al,[di+BUFFINFO.buf_ID] ;Same drive?
 27416 0000458E 7527                    	jne	short bufq5		; -no, jump.
 27417                                  
 27418                                  ;       Cmp32   bx,dx,<WORD PTR [di.buf_sector+2]>,<WORD PTR [di.buf_sector]>
 27419                                  ;       ja	short bufq5		;Jump if Extent start > buffer sector.
 27420                                  
 27421                                  	;cmp	bx,[di+8]
 27422 00004590 3B5D08                  	cmp	bx,[di+BUFFINFO.buf_sector+2]
 27423 00004593 7503                    	jne	short bufq04
 27424                                  	;cmp	dx,[di+6]
 27425 00004595 3B5506                  	cmp	dx,[di+BUFFINFO.buf_sector]
 27426                                  bufq04:
 27427 00004598 771D                    	ja	short bufq5
 27428                                  
 27429                                  ;       Cmp32   si,cx,<WORD PTR [di.buf_sector+2]>,<WORD PTR [di.buf_sector]>
 27430                                  ;       jbe	short bufq5		;Jump if Extent end < buffer sector.
 27431                                  
 27432                                  	;cmp	si,[di+8]
 27433 0000459A 3B7508                  	cmp	si,[di+BUFFINFO.buf_sector+2]
 27434 0000459D 7503                    	jne	short bufq05
 27435                                  	;cmp	cx,[di+6]
 27436 0000459F 3B4D06                  	cmp	cx,[di+BUFFINFO.buf_sector]
 27437                                  bufq05:
 27438 000045A2 7613                    	jbe	short bufq5
 27439                                  
 27440                                  ;	Buffer's sector is in Extent, so free it; it is being over-written.
 27441                                  
 27442                                  	;test	byte [di+5],40h
 27443 000045A4 F6450540                	test	byte [di+BUFFINFO.buf_flags],buf_dirty ;Buffer dirty?
 27444 000045A8 7403                    	jz	short bufq4		; -no, jump.
 27445 000045AA E8C922                  	call	DEC_DIRTY_COUNT		; -yes, decrement dirty count.
 27446                                  bufq4:
 27447                                  	;mov	word [di+4],20FFh
 27448 000045AD C74504FF20              	mov     word [di+BUFFINFO.buf_ID],((buf_visit<<8)|0FFh)
 27449                                  
 27450 000045B2 E8BC1F                  	call	SCANPLACE
 27451 000045B5 EB02                    	jmp     short bufq6
 27452                                  bufq5: 
 27453 000045B7 8B3D                    	mov     di,[di]
 27454                                  	;mov	di,[di+BUFFINFO.buf_next]
 27455                                  bufq6: 
 27456 000045B9 363B3E[1B11]            	cmp	di,[ss:FIRST_BUFF_ADDR]	;Scanned entire buffer queue?
 27457 000045BE 75CB                    	jne	short _bufq		; --no, go do next buffer.
 27458                                  	
 27459                                  	;RestoreReg <cx,bx>
 27460 000045C0 59                      	pop	cx
 27461 000045C1 5B                      	pop	bx
 27462 000045C2 C3                      	retn
 27463                                  
 27464                                  ;EndProc DskWrtBufPurge
 27465                                  
 27466                                  ;Break   <DIV32 -- PERFORM 32 BIT DIVIDE>
 27467                                  ;----------------------------------------------------------------------------
 27468                                  ;
 27469                                  ; Procedure Name : DIV32
 27470                                  ;
 27471                                  ; Inputs:
 27472                                  ;       DX:AX = 32 bit dividend   BX= divisor
 27473                                  ; Function:
 27474                                  ;       Perform 32 bit division:  DX:AX/BX = CX:AX + DX (rem.)
 27475                                  ; Outputs:
 27476                                  ;       CX:AX = quotient , DX= remainder
 27477                                  ; Uses:
 27478                                  ;       All registers except AX,CX,DX preserved.
 27479                                  ;----------------------------------------------------------------------------
 27480                                  ;M039: DIV32 optimized for divisor of 512 (common sector size).
 27481                                  
 27482                                  ; 04/05/2019 - Retro DOS v4.0
 27483                                  ; DOSCODE:7C94h (MSDOS 6.21, MSDOS.SYS)
 27484                                  
 27485                                  ; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27486                                  ; DOSCODE:7C5Ah (MSDOS 5.0, MSDOS.SYS) 
 27487                                  
 27488                                  DIV32:
 27489 000045C3 81FB0002                	cmp	bx,512
 27490 000045C7 7515                    	jne	short div5
 27491                                  
 27492 000045C9 89D1                    	mov	cx,dx
 27493 000045CB 89C2                    	mov	dx,ax           ; CX:AX = Dividend
 27494 000045CD 81E2FF01                	and	dx,(512-1)      ; DX = Remainder
 27495 000045D1 88E0                    	mov	al,ah
 27496 000045D3 88CC                    	mov	ah,cl
 27497 000045D5 88E9                    	mov	cl,ch
 27498 000045D7 30ED                    	xor	ch,ch
 27499 000045D9 D1E9                    	shr	cx,1
 27500 000045DB D1D8                    	rcr	ax,1
 27501 000045DD C3                      	retn
 27502                                  div5:	
 27503 000045DE 89C1                    	mov	cx,ax
 27504 000045E0 89D0                    	mov	ax,dx
 27505 000045E2 31D2                    	xor	dx,dx
 27506 000045E4 F7F3                    	div	bx              ; 0:AX/BX
 27507 000045E6 91                      	xchg	cx,ax
 27508 000045E7 F7F3                    	div	bx              ; DX:AX/BX
 27509 000045E9 C3                      	retn
 27510                                  
 27511                                  ;Break   <SHR32 -- PERFORM 32 BIT SHIFT RIGHT>
 27512                                  ;----------------------------------------------------------------------------
 27513                                  ;
 27514                                  ; Procedure Name : SHR32
 27515                                  ;
 27516                                  ; Inputs:
 27517                                  ;	DX:AX = 32 bit sector number
 27518                                  ; Function:
 27519                                  ;       Perform 32 bit shift right
 27520                                  ; Outputs:
 27521                                  ;	AX = cluster number
 27522                                  ;	ZF = 1 if no error
 27523                                  ;	   = 0 if error (cluster number > 64k)
 27524                                  ; Uses:
 27525                                  ;       DX,CX
 27526                                  ;---------------------------------------------------------------------------
 27527                                  ; M017	- SHR32 rewritten for better performance
 27528                                  ; M039	- Additional optimization
 27529                                  
 27530                                  ; 04/05/2019 - Retro DOS v4.0
 27531                                  ; DOSCODE:7CBBh (MSDOS 6.21, MSDOS.SYS)
 27532                                  ; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27533                                  ; DOSCODE:7C81h (MSDOS 5.0, MSDOS.SYS) 
 27534                                  
 27535                                  SHR32:
 27536                                  	;mov	cl,[es:bp+5]
 27537 000045EA 268A4E05                	mov	cl,[ES:BP+DPB.CLUSTER_SHIFT]
 27538 000045EE 30ED                    	xor	ch,ch	    ;ZF=1
 27539 000045F0 E306                    	jcxz	norota
 27540                                  rotashft2:
 27541 000045F2 D1EA                    	shr	dx,1	    ;ZF reflects state of DX.
 27542 000045F4 D1D8                    	rcr	ax,1	    ;ZF not affected.
 27543 000045F6 E2FA                    	loop	rotashft2
 27544                                  norota:
 27545 000045F8 C3                      	retn
 27546                                  
 27547                                  ;============================================================================
 27548                                  ; DIR.ASM, MSDOS 6.0, 1991
 27549                                  ;============================================================================
 27550                                  ; 27/07/2018 - Retro DOS v3.0
 27551                                  ; 19/05/2019 - Retro DOS v4.0
 27552                                  
 27553                                  ;	TITLE	DIR - Directory and path cracking
 27554                                  ;	NAME	Dir
 27555                                  
 27556                                  ;Break	<FINDENTRY -- LOOK FOR AN ENTRY>
 27557                                  ;---------------------------------------------------------------------------
 27558                                  ;
 27559                                  ; Procedure Name : FINDENTRY,SEARCH
 27560                                  ;
 27561                                  ; Inputs:
 27562                                  ;	[THISDPB] set
 27563                                  ;	[SECCLUSPOS] = 0
 27564                                  ;	[DIRSEC] = Starting directory sector number
 27565                                  ;	[CLUSNUM] = Next cluster of directory
 27566                                  ;	[CLUSFAC] = Sectors/Cluster
 27567                                  ;	[NAME1] = Name to look for
 27568                                  ; Function:
 27569                                  ;	Find file name in disk directory.
 27570                                  ;	"?" matches any character.
 27571                                  ; Outputs:
 27572                                  ;	Carry set if name not found
 27573                                  ;	ELSE
 27574                                  ;	Zero set if attributes match (always except when creating)
 27575                                  ;	AH = Device ID (bit 7 set if not disk)
 27576                                  ;	[THISDPB] = Base of drive parameters
 27577                                  ;	DS = DOSGROUP
 27578                                  ;	ES = DOSGROUP
 27579                                  ;	[CURBUF+2]:BX = Pointer into directory buffer
 27580                                  ;	[CURBUF+2]:SI = Pointer to First Cluster field in directory entry
 27581                                  ;	[CURBUF] has directory record with match
 27582                                  ;	[NAME1] has file name
 27583                                  ;	[LASTENT] is entry number of the entry
 27584                                  ; All other registers destroyed.
 27585                                  ;----------------------------------------------------------------------------
 27586                                  
 27587                                  ;hkn; called from rename.asm and dir2.asm. DS must be already set up at
 27588                                  ;hkn; this point.
 27589                                  
 27590                                  SEARCH:
 27591                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27592                                  	; DOSCODE:7C90h (MSDOS 5.0, MSDOS.SYS)
 27593                                  
 27594                                  	; 19/05/2019 - Retro DOS v4.0
 27595                                  	; DOSCODE:7CCAh (MSDOS 6.21, MSDOS.SYS)
 27596                                  
 27597                                  	; 27/07/2018 - Retro DOS v3.0
 27598                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 45B3h
 27599                                  	; 15/03/2018 - Retro DOS v2.0
 27600                                  
 27601                                  	; 24/01/2024
 27602                                  
 27603                                  	; 13/02/2024 - Retro DOS v5.0
 27604                                  	; DOSCODE:8797h (PCDOS 7.1, IBMDOS.COM)
 27605                                  
 27606                                  	;entry	FindEntry
 27607                                  FINDENTRY:
 27608 000045F9 E8DE05                  	call	STARTSRCH
 27609 000045FC A0[6B05]                	MOV	AL,[ATTRIB]
 27610                                  	;and	al,9Eh
 27611 000045FF 24DE                    	AND	AL,~attr_ignore		; Ignore useless bits
 27612                                  	;cmp	al,8
 27613 00004601 3C08                    	CMP	AL,attr_volume_id	; Looking for vol ID only ?
 27614 00004603 7503                    	JNZ	short NOTVOLSRCH	; No
 27615 00004605 E83402                  	CALL	SETROOTSRCH		; Yes force search of root
 27616                                  NOTVOLSRCH:
 27617 00004608 E84C01                  	CALL	GETENTRY
 27618                                  	;JNC	short SRCH
 27619                                  	;JMP	SETESRET
 27620                                  	; 24/01/2024
 27621 0000460B 724F                    	jc	short SETESRET
 27622                                  
 27623                                  	;entry	Srch
 27624                                  SRCH:
 27625                                  	;;;
 27626                                  	; 13/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27627 0000460D C706[A50A]0000          	mov     word [LNE_COUNT],0	; reset long name entry count
 27628                                  SRCH2:
 27629                                  	;;;
 27630                                  
 27631 00004613 1E                      	PUSH	DS
 27632 00004614 8E1E[E405]              	MOV	DS,[CURBUF+2]
 27633                                  
 27634                                  ;	(DS:BX) = directory entry address
 27635                                  
 27636 00004618 8A27                    	mov	ah,[BX]
 27637                                  	;MOV	AH,[BX+dir_entry.dir_name] ; mov ah,[bx+0]
 27638 0000461A 08E4                    	OR	AH,AH			; End of directory?
 27639 0000461C 7461                    	JZ	short FREE
 27640                                  
 27641                                  	;;;
 27642                                  	; 13/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27643 0000461E 50                      	push	ax
 27644 0000461F 8A470B                  	mov	al,[bx+0Bh]		; [BX+dir_entry.dir_attr]
 27645 00004622 E89A03                  	call	check_longname
 27646 00004625 58                      	pop	ax
 27647 00004626 7447                    	jz	short NEXTENT2
 27648                                  	;;;
 27649                                  
 27650                                  ;hkn; SS override
 27651 00004628 363A26[7F05]            	CMP	AH,[SS:DELALL]		; Free entry?
 27652 0000462D 7450                    	JZ	short FREE
 27653                                  	;test	byte [bx+0Bh],8
 27654 0000462F F6470B08                	TEST	byte [BX+dir_entry.dir_attr],attr_volume_id
 27655                                  					; Volume ID file?
 27656 00004633 7405                    	JZ	short CHKFNAM 		; NO
 27657                                  
 27658                                  ;hkn; SS override
 27659 00004635 36FE06[7B05]            	INC	BYTE [SS:VOLID]
 27660                                  CHKFNAM:
 27661                                  ;	Context ES
 27662 0000463A 8CD6                    	MOV	SI,SS
 27663 0000463C 8EC6                    	MOV	ES,SI
 27664 0000463E 89DE                    	MOV	SI,BX
 27665                                  
 27666                                  ;hkn; NAME1 is in DOSDATA
 27667 00004640 BF[4B05]                	MOV	DI,NAME1
 27668                                  ;;;;; 7/29/86
 27669                                  
 27670                                  ;hkn; SS override for NAME1
 27671                                  	;CMP	BYTE [SS:NAME1],0E5H	; special char check
 27672                                  	;JNZ	short NO_E5
 27673                                  	;MOV	BYTE [SS:NAME1],05H
 27674                                  	; 22/09/2023
 27675 00004643 26803DE5                	cmp	byte [es:di],0E5h
 27676 00004647 7504                    	jnz	short NO_E5
 27677 00004649 26C60505                	mov	byte [es:di],05h
 27678                                  NO_E5:
 27679                                  ;;;;; 7/29/86
 27680 0000464D E88100                  	CALL	MetaCompare
 27681 00004650 7449                    	JZ	short FOUND
 27682 00004652 1F                      	POP	DS
 27683                                  
 27684                                  	;entry	NEXTENT
 27685                                  NEXTENT:
 27686 00004653 C42E[8A05]              	LES	BP,[THISDPB]
 27687 00004657 E88600                  	CALL	NEXTENTRY
 27688 0000465A 73B1                    	JNC	short SRCH
 27689                                  	;JMP	SHORT SETESRET
 27690                                  	; 24/01/2024
 27691                                  SETESRET:
 27692 0000465C 16                      	PUSH	SS
 27693 0000465D 07                      	POP	ES
 27694                                  
 27695                                  	;;;
 27696                                  	; 13/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27697 0000465E FF36[DA05]              	push	word [ENTLAST]
 27698 00004662 8F06[B50A]              	pop	word [ENTLAST_PREV]	; previous ENTLAST
 27699 00004666 7306                    	jnc	short SETESRETN
 27700 00004668 C706[A50A]0000          	mov	word [LNE_COUNT],0	; reset long name entry count
 27701                                  SETESRETN:
 27702                                  	;;;
 27703                                  
 27704 0000466E C3                      	retn
 27705                                  
 27706                                  	;;;
 27707                                  	; 13/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27708                                  NEXTENT2:
 27709 0000466F 1F                      	pop	ds
 27710 00004670 FF06[A50A]              	inc	word [LNE_COUNT]	; Long Name entry count
 27711                                  NEXTENT3:
 27712 00004674 C42E[8A05]              	les	bp,[THISDPB]
 27713 00004678 E86500                  	call	NEXTENTRY
 27714 0000467B 7396                    	jnc	short SRCH2
 27715 0000467D EBDD                    	jmp	short SETESRET
 27716                                  	;;;
 27717                                  
 27718                                  FREE:
 27719 0000467F 1F                      	POP	DS
 27720 00004680 8B0E[4803]              	MOV	CX,[LASTENT]
 27721 00004684 3B0E[D805]              	CMP	CX,[ENTFREE]
 27722 00004688 7304                    	JAE	short TSTALL
 27723 0000468A 890E[D805]              	MOV	[ENTFREE],CX
 27724                                  TSTALL:
 27725 0000468E 3A26[7F05]              	CMP	AH,[DELALL]		; At end of directory?
 27726                                  NEXTENTJ:
 27727                                  	;je	short NEXTENT 		; No - continue search
 27728                                  	;;;
 27729                                  	; 13/02/2024
 27730 00004692 74E0                    	je	short NEXTENT3		; No - continue search
 27731                                  	;;;
 27732 00004694 890E[DA05]              	MOV	[ENTLAST],CX
 27733 00004698 F9                      	STC
 27734 00004699 EBC1                    	JMP	SHORT SETESRET
 27735                                  
 27736                                  FOUND:
 27737                                  ; We have a file with a matching name. We must now consider the attributes:
 27738                                  ; ATTRIB	Action
 27739                                  ; ------	------
 27740                                  ; Volume_ID	Is Volume_ID in test?
 27741                                  ; Otherwise	If no create then Is ATTRIB+extra superset of test?
 27742                                  ;		If create then Is ATTRIB equal to test?
 27743                                  
 27744 0000469B 8A2C                    	MOV	CH,[SI] 		; Attributes of file
 27745 0000469D 1F                      	POP	DS
 27746 0000469E 8A26[6B05]              	MOV	AH,[ATTRIB]		; Attributes of search
 27747                                  	;and	ah,9Eh
 27748 000046A2 80E4DE                  	AND	AH,~attr_ignore
 27749                                  	;lea	si,[si+15]
 27750 000046A5 8D740F                  	LEA	SI,[SI+dir_entry.dir_first-dir_entry.dir_attr]
 27751                                  					; point to first cluster field
 27752                                  	;test	ch,8
 27753 000046A8 F6C508                  	TEST	CH,attr_volume_id	; Volume ID file?
 27754 000046AB 7409                    	JZ	short check_one_volume_id ; Nope check other attributes
 27755                                  	;test	ah,8
 27756 000046AD F6C408                  	TEST	AH,attr_volume_id	; Can we find Volume ID?
 27757                                  	;JZ	short NEXTENTJ		; Nope, (not even $FCB_CREATE)
 27758                                  	; 16/12/2022
 27759 000046B0 74A1                    	jz	short NEXTENT ; 19/05/2019
 27760                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27761                                  	;JZ	short NEXTENTJ
 27762 000046B2 30E4                    	XOR	AH,AH			; Set zero flag for $FCB_CREATE
 27763 000046B4 EB11                    	JMP	SHORT RETFF		; Found Volume ID
 27764                                  check_one_volume_id:
 27765                                  	;CMP	ah,8
 27766 000046B6 80FC08                  	CMP	AH,attr_volume_id	; Looking only for Volume ID?
 27767                                  	;JZ	short NEXTENTJ		; Yes, continue search
 27768                                  	; 16/12/2022
 27769 000046B9 7498                    	je	short NEXTENT ; 19/05/2019
 27770                                  	;JZ	short NEXTENTJ
 27771 000046BB E83005                  	CALL	MatchAttributes
 27772 000046BE 7407                    	JZ	SHORT RETFF
 27773 000046C0 F606[7E05]FF            	TEST	BYTE [CREATING],-1	; Pass back mismatch if creating
 27774                                  	; 16/12/2022
 27775                                  	;JZ	short NEXTENTJ		; Otherwise continue searching
 27776 000046C5 748C                    	jz	short NEXTENT ; 19/05/2019
 27777                                  RETFF:
 27778 000046C7 C42E[8A05]              	LES	BP,[THISDPB]
 27779                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27780                                  	;MOV	AH,[ES:BP+DPB.DRIVE]  ; mov ah,[es:bp+0]
 27781                                  	; 15/12/2022
 27782 000046CB 268A6600                	MOV	AH,[ES:BP]
 27783                                  ;SETESRET:
 27784                                  	;PUSH	SS
 27785                                  	;POP	ES
 27786                                  	;retn
 27787                                  	; 24/01/2024
 27788 000046CF EB8B                    	jmp	short SETESRET
 27789                                  
 27790                                  ;----------------------------------------------------------------------------
 27791                                  ;
 27792                                  ; Procedure Name : MetaCompare
 27793                                  ;
 27794                                  ; Inputs:
 27795                                  ;	DS:SI -> 11 character FCB style name NO '?'
 27796                                  ;	    Typically this is a directory entry. It MUST be in upper case
 27797                                  ;	ES:DI -> 11 character FCB style name with possible '?'
 27798                                  ;	    Typically this is a FCB or SFT. It MUST be in upper case
 27799                                  ; Function:
 27800                                  ;	Compare FCB style names allowing for ? match to any char
 27801                                  ; Outputs:
 27802                                  ;	Zero if match else NZ
 27803                                  ; Destroys CX,SI,DI all others preserved
 27804                                  ;----------------------------------------------------------------------------
 27805                                  
 27806                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27807                                  	; DOSCODE:7D3Fh (MSDOS 5.0, MSDOS.SYS) 
 27808                                  
 27809                                  MetaCompare:
 27810 000046D1 B90B00                  	MOV	CX,11
 27811                                  WILDCRD:
 27812 000046D4 F3A6                    	REPE	CMPSB
 27813 000046D6 7407                    	JZ	short MetaRet 		; most of the time we will fail.
 27814                                  CHECK_META:
 27815 000046D8 26807DFF3F              	CMP	BYTE [ES:DI-1],"?"
 27816 000046DD 74F5                    	JZ	short WILDCRD
 27817                                  MetaRet:
 27818 000046DF C3                       	retn				; Zero set, Match
 27819                                  
 27820                                  ;Break	<NEXTENTRY -- STEP THROUGH DIRECTORY>
 27821                                  ;----------------------------------------------------------------------------
 27822                                  ;
 27823                                  ; Procedure Name : NEXTENTRY
 27824                                  ;
 27825                                  ; Inputs:
 27826                                  ;	Same as outputs of GETENTRY, above
 27827                                  ; Function:
 27828                                  ;	Update BX, and [LASTENT] for next directory entry.
 27829                                  ;	Carry set if no more.
 27830                                  ;----------------------------------------------------------------------------
 27831                                  
 27832                                  NEXTENTRY:
 27833                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27834                                  	; DOSCODE:7D4Eh (MSDOS 5.0, MSDOS.SYS) 
 27835                                  
 27836                                  	; 19/05/2019 - Retro DOS v4.0
 27837                                  	; DOSCODE:7D88h (MSDOS 6.21, MSDOS.SYS)
 27838                                  
 27839                                  	; 27/07/2018 - Retro DOS v3.0
 27840                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 4671h 
 27841                                  	; 15/03/2018 - Retro DOS v2.0
 27842                                  
 27843                                  	; 14/02/2024 - Retro DOS v5.0
 27844                                  	; DOSCODE:8884h (PCDOS 7.1, IBMDOS.COM)
 27845                                  
 27846 000046E0 A1[4803]                	MOV	AX,[LASTENT]
 27847 000046E3 3B06[DA05]              	CMP	AX,[ENTLAST]
 27848 000046E7 741C                    	JZ	short NONE
 27849 000046E9 40                      	INC	AX
 27850                                  	;ADD	BX,32
 27851 000046EA 8D5F20                  	LEA	BX,[BX+32]
 27852 000046ED 39D3                    	CMP	BX,DX
 27853                                  	; 21/11/2022 - MSDOS 5.0 MSDOS.SYS (DOSCODE:7D5Dh)
 27854                                  	;JB	short HAVIT ; MSDOS 6.0 src (dir.asm)
 27855                                  	; 16/12/2022
 27856 000046EF 7540                    	jne	short HAVIT ; MSDOS 6.21 (DOSCODE:7D97h)
 27857                                  
 27858                                  	;;;
 27859                                  	; 14/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27860 000046F1 833E[C205]00            	cmp	word [DIRSTART],0
 27861 000046F6 750F                    	jnz	short nextentry_cont
 27862 000046F8 833E[DC0A]00            	cmp	word [DIRSTART_HW],0
 27863 000046FD 7508                    	jnz	short nextentry_cont
 27864                                  	;cmp	ax,[es:bp+9]
 27865 000046FF 263B4609                	cmp	ax,[es:bp+DPB.ROOT_ENTRIES] ; Number of root dir entries
 27866                                  	;jnb	short NONE
 27867                                  	;jmp	short GETENT
 27868 00004703 7255                    	jb	short GETENT
 27869                                  NONE:		; 14/02/2024
 27870 00004705 F9                      	stc
 27871 00004706 C3                      	retn
 27872                                  	
 27873                                  nextentry_cont:
 27874                                  	;;;
 27875                                  
 27876 00004707 8A1E[7305]              	MOV	BL,[SECCLUSPOS]
 27877 0000470B FEC3                    	INC	BL
 27878 0000470D 3A1E[7705]              	CMP	BL,[CLUSFAC]
 27879 00004711 7223                    	JB	short SAMECLUS
 27880                                  	;;;
 27881                                  	; 14/02/2024 (PCDOS 7.1 IBMDOS.COM)
 27882 00004713 8B1E[E00A]              	mov	bx,[NXTCLUSNUM_HW]
 27883 00004717 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 27884                                  	;;;
 27885 0000471B 8B1E[DC05]              	MOV	BX,[NXTCLUSNUM]
 27886 0000471F E83C18                  	call	IsEOF
 27887 00004722 73E1                    	JAE	short NONE
 27888                                  	;;;
 27889                                  	; 14/02/2024
 27890 00004724 833E[E80A]00            	cmp	word [CLUSTNUM_HW],0
 27891 00004729 752F                    	jnz	short GETENT
 27892                                  	;;;
 27893                                  	; 23/07/2019
 27894 0000472B 83FB02                  	CMP	BX,2
 27895                                  	;JB	short NONE
 27896                                  	;JMP	short GETENT
 27897                                  	; 16/12/2022
 27898 0000472E 732A                    	jnb	short GETENT
 27899                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 27900                                  	;JB	short NONE
 27901                                  	;JMP	short GETENT
 27902                                  	; 14/02/2024 - Retro DOS v5.0
 27903                                  ;NONE:
 27904                                  	;STC
 27905 00004730 C3                      	retn
 27906                                  HAVIT:
 27907 00004731 A3[4803]                	MOV	[LASTENT],AX
 27908 00004734 F8                      	CLC
 27909                                  nextentry_retn:
 27910 00004735 C3                      	retn
 27911                                  
 27912                                  SAMECLUS:
 27913 00004736 881E[7305]              	MOV	[SECCLUSPOS],BL
 27914 0000473A A3[4803]                	MOV	[LASTENT],AX
 27915 0000473D 1E                      	PUSH	DS
 27916 0000473E C53E[E205]              	LDS	DI,[CURBUF]
 27917                                  	; 19/05/2019
 27918                                  	; MSDOS 6.0
 27919                                  	;;mov	dx,[di+8]
 27920                                  	; 23/09/2023
 27921                                  	;MOV	DX,[DI+BUFFINFO.buf_sector+2]	;AN000; >32mb
 27922                                  ;hkn; SS override
 27923                                  	;MOV	[SS:HIGH_SECTOR],DX 		;AN000; >32mb
 27924                                  
 27925                                  ; 14/02/2024
 27926                                  %if 0
 27927                                  	; 23/09/2023
 27928                                  	mov	si,[di+BUFFINFO.buf_sector+2]
 27929                                  	
 27930                                  	;mov	dx,[di+6]
 27931                                  	MOV	DX,[DI+BUFFINFO.buf_sector]	;AN000; >32mb
 27932                                  
 27933                                  	;inc	dx ; MSDOS 3.3
 27934                                  	; MSDOS 6.0
 27935                                  	;ADD	DX,1				;AN000; >32mb
 27936                                  	;ADC	word [SS:HIGH_SECTOR],0 	;AN000; >32mb
 27937                                  	; 23/09/2023
 27938                                  	inc	dx
 27939                                  	jnz	short nextexntry_fc
 27940                                  	inc	si
 27941                                  	;inc	word [SS:HIGH_SECTOR]
 27942                                  nextexntry_fc:
 27943                                  	; 23/09/2023
 27944                                  	mov	[SS:HIGH_SECTOR],si
 27945                                  	; MSDOS 3.3 & MSDOS 6.0
 27946                                  	POP	DS
 27947                                  %else
 27948                                  	; 14/02/2024 - Retro DOS v5.0
 27949 00004742 C55506                  	lds	dx,[di+BUFFINFO.buf_sector]
 27950 00004745 8CDE                    	mov	si,ds
 27951 00004747 1F                      	pop	ds
 27952 00004748 42                      	inc	dx
 27953 00004749 7501                    	jnz	short nextexntry_fc
 27954 0000474B 46                      	inc	si
 27955                                  nextexntry_fc:
 27956 0000474C 8936[0706]              	mov	[HIGH_SECTOR],si
 27957                                  %endif
 27958                                  
 27959 00004750 E8F7F6                  	call	FIRSTCLUSTER
 27960 00004753 31DB                    	XOR	BX,BX
 27961 00004755 EB21                    	JMP	short SETENTRY
 27962                                  
 27963                                  ;----------------------------------------------------------------------------
 27964                                  ;
 27965                                  ; Procedure Name : GETENTRY
 27966                                  ;
 27967                                  ; Inputs:
 27968                                  ;	[LASTENT] has directory entry
 27969                                  ;	ES:BP points to drive parameters
 27970                                  ;	[DIRSEC],[CLUSNUM],[CLUSFAC],[ENTLAST] set for DIR involved
 27971                                  ; Function:
 27972                                  ;	Locates directory entry in preparation for search
 27973                                  ;	GETENT provides entry for passing desired entry in AX
 27974                                  ; Outputs:
 27975                                  ;	[CURBUF+2]:BX = Pointer to next directory entry in CURBUF
 27976                                  ;	[CURBUF+2]:DX = Pointer to first byte after end of CURBUF
 27977                                  ;	[LASTENT] = New directory entry number
 27978                                  ;	[NXTCLUSNUM],[SECCLUSPOS] set via DIRREAD
 27979                                  ;	Carry set if error (currently user FAILed to I 24)
 27980                                  ;----------------------------------------------------------------------------
 27981                                  
 27982                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 27983                                  GETENTRY:
 27984                                  	; 27/07/2018 - Retro DOS v3.0
 27985 00004757 A1[4803]                	MOV	AX,[LASTENT]
 27986                                  
 27987                                  	;entry	GETENT
 27988                                  GETENT:
 27989 0000475A A3[4803]                	MOV	[LASTENT],AX
 27990                                  ;
 27991                                  ; Convert the entry number in AX into a byte offset from the beginning of the
 27992                                  ; directory.
 27993                                  ;
 27994 0000475D B105                    	mov	cl,5			; shift left by 5 = mult by 32
 27995 0000475F D3C0                    	rol	ax,cl			; keep hight order bits
 27996 00004761 89C2                    	mov	dx,ax
 27997                                  	; 19/05/2019 - Retro DOS v4.0
 27998                                  	;and	ax,0FFE0h
 27999                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 28000                                  	;and	ax,~(32-1)		; mask off high order bits
 28001                                  	; 16/12/2022
 28002 00004763 24E0                    	and	al,0E0h ; ~31
 28003 00004765 83E21F                  	and	dx,1Fh
 28004                                  	;and	dx,32-1			; mask off low order bits
 28005                                  ;
 28006                                  ; DX:AX contain the byte offset of the required directory entry from the
 28007                                  ; beginning of the directory. Convert this to a sector number. Round the
 28008                                  ; sector size down to a multiple of 32.
 28009                                  ;
 28010                                  	;mov	bx,[es:bp+2]
 28011 00004768 268B5E02                	MOV	BX,[ES:BP+DPB.SECTOR_SIZE]
 28012 0000476C 80E3E0                  	and	bl,0E0h
 28013                                  	;AND	BL,255-31		; Must be multiple of 32
 28014 0000476F F7F3                    	DIV	BX
 28015                                  	; 14/02/2024
 28016                                  	;MOV	BX,DX			; Position within sector
 28017                                  				; NOTE: This BX value is not used in DIRREAD
 28018                                  				; Erdogan Tan - 14/02/2024
 28019                                  	;PUSH	BX
 28020 00004771 52                      	push	dx
 28021                                  	;
 28022 00004772 E84BF6                  	call	DIRREAD
 28023 00004775 5B                      	POP	BX
 28024                                  	;retc
 28025 00004776 72BD                    	jc	short nextentry_retn
 28026                                  SETENTRY:
 28027 00004778 8B16[E205]              	MOV	DX,[CURBUF]
 28028                                  	;;;add	dx,16 ; MSDOS 3.3
 28029                                  	;;add	dx,20 ; MSDOS 6.0 
 28030                                  	;add	dx,24 ; PCDOS 7.1 ; 14/02/2024	
 28031 0000477C 83C218                  	ADD	DX,BUFINSIZ
 28032 0000477F 01D3                    	ADD	BX,DX
 28033                                  	;add	dx,[es:bp+2]
 28034 00004781 26035602                	ADD	DX,[ES:BP+DPB.SECTOR_SIZE]  ; Always clears carry
 28035                                  	; 29/12/2022
 28036                                  	; MSDOS 6.21 MSDOS.SYS contains a 'CLC' here, at DOSCODE:7E15h
 28037                                  	; 27/06/2024
 28038                                  	; PCDOS 7.1 IBMDOS.COM contains 'CLC' here, at DOSCODE:8931h
 28039 00004785 F8                      	clc
 28040 00004786 C3                      	retn
 28041                                  
 28042                                  ;----------------------------------------------------------------------------
 28043                                  
 28044                                  ; 23/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28045                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8933h
 28046                                  
 28047                                  sft_fcb_table:
 28048 00004787 00<rep 14h>             	times 20 db 0
 28049                                  sftfcb.cluster:
 28050 0000479B 00000000                	dd	0
 28051                                  sftfcb.direntry:
 28052 0000479F 0000                    	dw	0
 28053                                  sftfcb_entry_size equ $ - sftfcb.cluster ; = 6
 28054                                  
 28055 000047A1 00<rep 72h>             	times 114 db 0	; 6*20 = 120 ; entry size = 6 bytes 
 28056                                  
 28057                                  SRCH_CLUSTER:
 28058 00004813 0000                    	dw	0
 28059                                  SRCH_CLUSTER_HW:
 28060 00004815 0000                    	dw	0
 28061                                  
 28062                                  ;----------------------------------------------------------------------------
 28063                                  
 28064                                  ;Break	<SETDIRSRCH SETROOTSRCH -- Set Search environments>
 28065                                  ;----------------------------------------------------------------------------
 28066                                  ;
 28067                                  ; Procedure Name : SETDIRSRCH,SETROOTSRCH
 28068                                  ;
 28069                                  ; Inputs:
 28070                                  ;	BX cluster number of start of directory
 28071                                  ;	ES:BP Points to DPB
 28072                                  ;	DI next cluster number from fastopen extended info. DOS 3.3 only
 28073                                  ; Function:
 28074                                  ;	Set up a directory search
 28075                                  ; Outputs:
 28076                                  ;	[DIRSTART] = BX
 28077                                  ;	[CLUSFAC],[CLUSNUM],[SECCLUSPOS],[DIRSEC] set
 28078                                  ;	Carry set if error (currently user FAILed to I 24)
 28079                                  ; destroys AX,DX,BX
 28080                                  ;----------------------------------------------------------------------------
 28081                                  
 28082                                  	;;;
 28083                                  	; 23/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28084                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:89C3h
 28085                                  	;;;
 28086                                  SETDIRSRCH:
 28087 00004817 A1[EE0A]                	mov	ax,[ROOTCLUST_HW]
 28088                                  	;cmp	word [ROOTCLUST_HW],0
 28089 0000481A 21C0                    	and	ax,ax	
 28090 0000481C 7504                    	jnz	short SETDIRSRCH_FAT32
 28091                                  	
 28092 0000481E 09DB                    	or	bx,bx
 28093                                  	;jz	short SETROOTSRCH
 28094 00004820 741C                    	jz	short SETROOTSRCH2 ; ax = 0
 28095                                  SETDIRSRCH_FAT32:
 28096                                  	;mov	ax,[ROOTCLUST_HW]
 28097 00004822 A3[DC0A]                	mov	[DIRSTART_HW],ax
 28098 00004825 A3[E80A]                	mov	[CLUSTNUM_HW],ax
 28099                                  
 28100 00004828 891E[C205]              	mov	[DIRSTART],bx
 28101                                  	;mov	al,[es:bp+4]
 28102 0000482C 268A4604                	mov	al,[es:bp+DPB.CLUSTER_MASK]
 28103                                  	;inc	al
 28104 00004830 40                      	inc	ax
 28105 00004831 A2[7705]                	mov	[CLUSFAC],al
 28106                                  
 28107 00004834 56                      	push	si
 28108                                  
 28109                                  	; 03/03/2025 (MiniDOS)
 28110                                  	;;test	byte [FastOpenFlg],2
 28111                                  	;test	byte [FastOpenFlg],Lookup_Success
 28112                                  	;jnz	short UNP_OK
 28113                                  
 28114 00004835 E84F17                  	call	UNPACK
 28115 00004838 732F                    	jnc	short UNP_OK
 28116                                  
 28117 0000483A 5E                      	pop	si
 28118 0000483B C3                      	retn
 28119                                  
 28120                                  SETROOTSRCH:
 28121 0000483C 31C0                    	xor	ax,ax ; 0
 28122                                  SETROOTSRCH2:
 28123 0000483E A3[EE0A]                	mov	[ROOTCLUST_HW],ax ;0
 28124                                  	;cmp	word [es:bp+0Fh],0
 28125 00004841 2639460F                	cmp	[es:bp+DPB.FAT_SIZE],ax ; 0
 28126 00004845 7556                    	jnz	short SETROOTSRCH_FAT ; not FAT32
 28127                                  SETROOTSRCH_FAT32:
 28128                                  	;;mov	bx,[es:bp+37h]
 28129                                  	;mov	bx,[es:bp+DPB.ROOT_CLUSTER+2]
 28130                                  	;mov	[ROOTCLUST_HW],bx
 28131                                  	;;cmp	bx,[es:bp+2Fh]
 28132                                  	;cmp	bx,[es:bp+DPB.LAST_CLUSTER+2]
 28133                                  	; 27/06/2024 - Retro DOS v5.0
 28134 00004847 268B4637                	mov	ax,[es:bp+DPB.ROOT_CLUSTER+2]
 28135 0000484B A3[EE0A]                	mov	[ROOTCLUST_HW],ax
 28136 0000484E 263B462F                	cmp	ax,[es:bp+DPB.LAST_CLUSTER+2]
 28137                                  	;mov	bx,[es:bp+35h]
 28138 00004852 268B5E35                	mov	bx,[es:bp+DPB.ROOT_CLUSTER]
 28139 00004856 7504                    	jne	short sdsrch_fat32_1
 28140                                  	;cmp	bx,[es:bp+2Dh]
 28141 00004858 263B5E2D                	cmp	bx,[es:bp+DPB.LAST_CLUSTER]
 28142                                  sdsrch_fat32_1:
 28143 0000485C 7709                    	ja	short sdsrch_fat32_3 ; **
 28144                                  	; 27/06/2024
 28145 0000485E 21C0                    	and	ax,ax ; [ROOTCLUST_HW]
 28146                                  	;cmp	word [ROOTCLUST_HW],0
 28147                                  	;jnz	short sdsrtch_fat32_2
 28148 00004860 75C0                    	jnz	short SETDIRSRCH_FAT32
 28149 00004862 83FB02                  	cmp	bx,2
 28150                                  	;jb	short sdsrch_fat32_3
 28151                                  sdsrch_fat32_2:
 28152                                  	;jmp	SETDIRSRCH_FAT32
 28153 00004865 73BB                    	jnb	short SETDIRSRCH_FAT32
 28154                                  
 28155                                  sdsrch_fat32_3:
 28156 00004867 F9                      	stc	; **
 28157                                  	;jmp	short setdirsrch_retn
 28158 00004868 C3                      	retn
 28159                                  
 28160                                  UNP_OK:
 28161                                  	; CCONTENT_HW:DI = Contents of FAT for given cluster
 28162                                  	;			(from UNPACK)
 28163 00004869 893E[BC05]              	mov	[CLUSNUM],di
 28164 0000486D 8B16[EC0A]              	mov	dx,[CCONTENT_HW]
 28165 00004871 8916[DE0A]              	mov	[CLUSNUM_HW],dx
 28166 00004875 2E891E[1348]            	mov	[cs:SRCH_CLUSTER],bx ; Directory start cluster number
 28167                                  				; for searching/locating (directory entry)
 28168 0000487A 8B16[E80A]              	mov	dx,[CLUSTNUM_HW]
 28169 0000487E 2E8916[1548]            	mov	[cs:SRCH_CLUSTER_HW],dx
 28170                                  
 28171 00004883 89DA                    	mov	dx,bx
 28172 00004885 30DB                    	xor	bl,bl
 28173 00004887 881E[7305]              	mov	[SECCLUSPOS],bl
 28174                                  
 28175                                  	;CLUSTNUM_HW:DX = Physical cluster number (to FIGREC)
 28176                                  
 28177 0000488B E8C00D                  	call	FIGREC
 28178                                  
 28179 0000488E 8B36[0706]              	mov	si,[HIGH_SECTOR]
 28180 00004892 8936[C005]              	mov	[DIRSEC+2],si
 28181 00004896 5E                      	pop	si
 28182                                  SETROOTSRCH3:
 28183 00004897 8916[BE05]              	mov	[DIRSEC],dx ; *
 28184                                  	
 28185                                  	;pop	si
 28186 0000489B F8                      	clc	; (this may not be needed,
 28187                                  		; FIGREC clears cf except an abnormal sector calc overflow)
 28188 0000489C C3                      	retn
 28189                                  
 28190                                  SETROOTSRCH_FAT:
 28191                                  	;xor	ax,ax
 28192 0000489D A3[C005]                	mov	[DIRSEC+2],ax ; 0
 28193 000048A0 A3[C205]                	mov	[DIRSTART],ax ; 0
 28194 000048A3 A3[DC0A]                	mov	[DIRSTART_HW],ax ; 0
 28195 000048A6 2EA3[1548]              	mov	[cs:SRCH_CLUSTER_HW],ax ; 0
 28196 000048AA 40                      	inc	ax		; search start dir cluster num = 1
 28197                                  				; (root directory)
 28198 000048AB 2EA3[1348]              	mov	[cs:SRCH_CLUSTER],ax ; 1 ; FAT root directory (<2)
 28199 000048AF 48                      	dec	ax ; 0
 28200 000048B0 A2[7305]                	mov	[SECCLUSPOS],al
 28201 000048B3 48                      	dec	ax ; -1
 28202 000048B4 A3[BC05]                	mov	[CLUSNUM],ax ; 0FFFFh
 28203 000048B7 A3[DE0A]                	mov	[CLUSNUM_HW],ax ; 0FFFFh
 28204                                  
 28205                                  	;mov	ax,[es:bp+0Bh]
 28206 000048BA 268B460B                	mov	ax,[es:bp+DPB.FIRST_SECTOR]
 28207                                  	;mov	dx,[es:bp+11h]
 28208 000048BE 268B5611                	mov	dx,[es:bp+DPB.DIR_SECTOR]
 28209 000048C2 29D0                    	sub	ax,dx
 28210 000048C4 A2[7705]                	mov	[CLUSFAC],al
 28211                                  	;mov	[DIRSEC],dx ; *
 28212                                  	;clc
 28213                                  ;setdirsrch_retn:
 28214                                  	;retn
 28215 000048C7 EBCE                    	jmp	short SETROOTSRCH3
 28216                                  	;;;
 28217                                  
 28218                                  ;----------------------------------------------------------------------------
 28219                                  
 28220                                  ; 23/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28221                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8A90h
 28222                                  
 28223                                  ; set SFT number and entry in the new internal table (only for FCB calls)
 28224                                  
 28225                                  set_sftfcb_entry:
 28226 000048C9 50                      	push	ax
 28227 000048CA 51                      	push	cx
 28228 000048CB 52                      	push	dx
 28229 000048CC 53                      	push	bx
 28230                                  
 28231                                  	;push	bp
 28232                                  	;push	si
 28233                                  	;push	di              ; ES:DI = SFT entry
 28234                                  
 28235 000048CD E84B00                  	call	find_sft_entry_number
 28236                                  				; ax = SFT entry index number
 28237                                  				;      of the last SFT entry
 28238 000048D0 31DB                    	xor	bx,bx
 28239 000048D2 B91400                  	mov	cx,20		; find empty entry (slot) in the table
 28240                                  	; Retro DOS v5.0
 28241 000048D5 31D2                    	xor	dx,dx ; *
 28242                                  set_sftfcbe_1:
 28243                                  	;;cmp	cs:(sftfcb_cluster+2)[bx],0
 28244                                  	;cmp	word [cs:bx+sftfcb.cluster+2],0
 28245                                  				; directory (search) starting cluster, hw
 28246 000048D7 2E3997[9D47]            	cmp	[cs:bx+sftfcb.cluster+2],dx ; 0
 28247                                  	;jnz	short set_sftfcbe_2
 28248                                  	; 27/06/2024
 28249 000048DC 7533                    	jnz	short set_sftfcbe_3
 28250                                  
 28251                                  	;;cmp	cs:sftfcb_cluster[bx], 
 28252                                  	;cmp	word [cs:bx+sftfcb.cluster],0
 28253                                  				; directory (search) starting cluster, lw
 28254 000048DE 2E3997[9B47]            	cmp	[cs:bx+sftfcb.cluster],dx ; 0
 28255                                  set_sftfcbe_2:
 28256 000048E3 752C                    	jnz	short set_sftfcbe_3
 28257                                  				; not empty (sfcb table) entry
 28258                                  	; Retro DOS v5.0
 28259                                  	;push	cx
 28260                                  
 28261 000048E5 2E8B0E[1348]            	mov	cx,[cs:SRCH_CLUSTER]
 28262                                  				; search start dir cluster number
 28263                                  	;mov	cs:sftfcb_cluster[bx],cx
 28264 000048EA 2E898F[9B47]            	mov	[cs:bx+sftfcb.cluster],cx
 28265                                  				; directory start cluster
 28266 000048EF 2E8B0E[1548]            	mov     cx,[cs:SRCH_CLUSTER_HW]
 28267                                  	
 28268                                  	; PCDOS 7.1 BUG! (This would be '[cs:bx:sftfcb.cluster+2],cx')
 28269                                  	; Erdogan Tan - 23/01/2024
 28270                                  	;mov	cs:sftfcb_cluster[bx],cx
 28271                                  	;mov	[cs:bx:sftfcb.cluster],cx ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8ABFh
 28272                                  	; Retro DOS v5.0
 28273 000048F4 2E898F[9D47]            	mov	[cs:bx+sftfcb.cluster+2],cx
 28274                                  
 28275                                  	;pop	cx
 28276                                  
 28277                                  	;mov	dx,[ss:LASTENT]	; LAST (found) entry in the directory
 28278                                  	;;mov	cs:sftfcb_direntry[bx],dx
 28279                                  	;mov	[cs:bx+sftfcb.direntry],dx
 28280                                  				; directory entry number
 28281 000048F9 368B0E[4803]            	mov	cx,[ss:LASTENT]
 28282 000048FE 2E898F[9F47]            	mov	[cs:bx+sftfcb.direntry],cx
 28283                                  
 28284 00004903 93                      	xchg	ax,bx
 28285                                  	;xor	dx,dx ; *
 28286                                  	; dx = 0
 28287 00004904 B90600                  	mov	cx,6		; sftfcb table has 6 byte entries
 28288 00004907 F7F1                    	div	cx
 28289 00004909 93                      	xchg	ax,bx
 28290 0000490A 2E8887[8747]            	mov	[cs:bx+sft_fcb_table],al
 28291                                  				; put SFT entry number in SFT-FCB
 28292                                  				; table (offset is FCB index number 0 to 19)
 28293 0000490F EB05                    	jmp     short set_setfcbe_4
 28294                                  set_sftfcbe_3:
 28295                                  	;add	bx,6
 28296 00004911 83C306                  	add	bx,sftfcb_entry_size ; 6
 28297 00004914 E2C1                    	loop	set_sftfcbe_1
 28298                                  
 28299                                  set_setfcbe_4:
 28300                                  	;pop	di
 28301                                  	;pop	si
 28302                                  	;pop	bp
 28303                                  	
 28304 00004916 5B                      	pop	bx
 28305 00004917 5A                      	pop	dx
 28306 00004918 59                      	pop	cx
 28307 00004919 58                      	pop	ax
 28308 0000491A C3                      	retn
 28309                                  
 28310                                  ;----------------------------------------------------------------------------
 28311                                  
 28312                                  ; 24/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28313                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8AECh
 28314                                  
 28315                                  	; 14/02/2024
 28316                                  find_sft_entry_number:
 28317 0000491B 06                      	push	es		; es:di = SFT entry
 28318 0000491C 31C9                    	xor	cx,cx
 28319 0000491E 8CC2                    	mov	dx,es
 28320 00004920 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 28321 00004925 26C41E[2A00]            	les	bx,[es:SFT_ADDR] ; address of the first SFT
 28322                                  f_sfte_1:
 28323 0000492A 8CC0                    	mov	ax,es
 28324 0000492C 39D0                    	cmp	ax,dx		; same SFT segment ?
 28325 0000492E 7512                    	jne	short f_sfte_2	; no
 28326 00004930 89F8                    	mov	ax,di
 28327 00004932 29D8                    	sub	ax,bx		; ax = entry offset
 28328                                  	;sub	ax,6		; ax = offset from start of the SFT table
 28329 00004934 83E806                  	sub	ax,SFT.SFTable
 28330                                  	;mov	bx,59
 28331 00004937 BB3B00                  	mov	bx,SF_ENTRY.size ; (SFT entry size)
 28332 0000493A 31D2                    	xor	dx,dx
 28333 0000493C F7F3                    	div	bx		; ax = SFT entry index in the table
 28334 0000493E 01C8                    	add	ax,cx		; ax = SFT index number (for requested SFT entry)
 28335 00004940 07                      	pop	es
 28336 00004941 C3                      	retn
 28337                                  f_sfte_2:
 28338 00004942 26034F04                	add	cx,[es:bx+4]	; SFT.SFCount ; number of entries in the table
 28339 00004946 26C41F                  	les	bx,[es:bx]	; SFT.SFLink
 28340 00004949 83FBFF                  	cmp	bx,0FFFFh ; -1	; the last SFT
 28341 0000494C 75DC                    	jnz	short f_sfte_1
 28342 0000494E F9                      	stc			; (not found)
 28343 0000494F 07                      	pop	es
 28344 00004950 C3                      	retn
 28345                                  
 28346                                  ;----------------------------------------------------------------------------
 28347                                  
 28348                                  ; 24/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28349                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8B22h
 28350                                  
 28351                                  	; 14/02/2024
 28352                                  int_2Fh_1230h:		; Windows95 - FIND SFT ENTRY IN INTERNAL FILE TABLES
 28353 00004951 E8C7FF                  	call	find_sft_entry_number
 28354 00004954 7242                    	jc	short find_sfte_i_error
 28355 00004956 06                      	push	es	; ax = SFT enty index number (of the requested SFT entry)
 28356 00004957 57                      	push	di
 28357 00004958 0E                      	push	cs
 28358 00004959 07                      	pop	es
 28359 0000495A B91400                  	mov	cx,20		; statically allocated with 20 entries,
 28360                                  				; and used only for FCB calls
 28361 0000495D BF[8747]                	mov	di,sft_fcb_table ; new file system (internal) table
 28362                                  				;  only for fcb calls
 28363                                  scan_next_sftfcb:
 28364 00004960 F2AE                    	repne scasb
 28365 00004962 F9                      	stc
 28366 00004963 7531                    	jnz	short sfte_i_notfound ; not found (cf=1)
 28367 00004965 8D5DFF                  	lea	bx,[di-1]	; offset of the entry in the table
 28368 00004968 81EB[8747]              	sub	bx,sft_fcb_table ; index into new file system table
 28369 0000496C 89DA                    	mov	dx,bx
 28370 0000496E 01DB                    	add	bx,bx		; 2*bx
 28371 00004970 01D3                    	add	bx,dx		; 3*bx
 28372 00004972 01DB                    	add	bx,bx		; bx = 6*bx  ; entry size = 6 bytes
 28373 00004974 268BB7[9D47]            	mov	si,[es:bx+sftfcb.cluster+2] ; dir start cluster number, hw
 28374 00004979 268B97[9F47]            	mov	dx,[es:bx+sftfcb.direntry] ; directory entry number
 28375 0000497E 51                      	push	cx
 28376 0000497F 268B8F[9B47]            	mov	cx,[es:bx+sftfcb.cluster] ; dir start cluster number, lw
 28377 00004984 09C9                    	or	cx,cx
 28378 00004986 750C                    	jnz	short sfte_i_found
 28379 00004988 09F6                    	or	si,si
 28380 0000498A 7508                    	jnz	short sfte_i_found
 28381 0000498C 59                      	pop	cx
 28382 0000498D 09C9                    	or	cx,cx
 28383 0000498F 75CF                    	jnz	short scan_next_sftfcb
 28384 00004991 F9                      	stc			; not found (cf=1)
 28385 00004992 EB02                    	jmp	short sfte_i_notfound
 28386                                  
 28387                                  sfte_i_found:
 28388 00004994 58                      	pop	ax		; clear stack
 28389 00004995 F8                      	clc			; found (cf=0)
 28390                                  sfte_i_notfound:
 28391 00004996 5F                      	pop	di
 28392 00004997 07                      	pop	es
 28393                                  find_sfte_i_error:
 28394 00004998 B80000                  	mov	ax,0
 28395 0000499B C3                      	retn
 28396                                  
 28397                                  ;----------------------------------------------------------------------------
 28398                                  
 28399                                  ; 24/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28400                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8B6Dh
 28401                                  
 28402                                  	; 14/02/2024
 28403                                  SFT_FREE:
 28404 0000499C 50                      	push	ax
 28405 0000499D 51                      	push	cx
 28406 0000499E 52                      	push	dx
 28407 0000499F 53                      	push	bx
 28408                                  	;push	bp	; 14/02/2024 - Retro DOS v5.0
 28409 000049A0 56                      	push	si
 28410                                  	;push	di
 28411 000049A1 26C7050000              	mov     word [es:di],0 ; [ES:DI+SF_ENTRY.sf_ref_Count]
 28412 000049A6 E8A8FF                  	call    int_2Fh_1230h
 28413 000049A9 720E                    	jc      short sftf_1
 28414 000049AB 2EC787[9D47]0000        	mov	word [cs:bx+sftfcb.cluster+2],0 ; clear directory start cluster
 28415                                  						;  in the new (sftfcb) table
 28416 000049B2 2EC787[9B47]0000        	mov	word [cs:bx+sftfcb.cluster],0	; ((empty entry))
 28417                                  sftf_1:
 28418                                  	;pop	di
 28419 000049B9 5E                      	pop	si
 28420                                  	;pop	bp
 28421 000049BA 5B                      	pop	bx
 28422 000049BB 5A                      	pop	dx
 28423 000049BC 59                      	pop	cx
 28424 000049BD 58                      	pop	ax
 28425 000049BE C3                      	retn
 28426                                  
 28427                                  ; =============== S U B R O U T I N E =======================================
 28428                                  
 28429                                  ; 13/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28430                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:8B94h
 28431                                  
 28432                                  check_longname:
 28433 000049BF 240F                    	and     al,0Fh
 28434 000049C1 3C0F                    	cmp     al,0Fh
 28435 000049C3 C3                      	retn
 28436                                  
 28437                                  ;----------------------------------------------------------------------------
 28438                                  
 28439                                  ;============================================================================
 28440                                  ; DIR2.ASM, MSDOS 6.0, 1991
 28441                                  ;============================================================================
 28442                                  ; 27/07/2018 - Retro DOS v3.0
 28443                                  ; 19/05/2019 - Retro DOS v4.0
 28444                                  ; 14/02/2024 - Retro DOS v5.0
 28445                                  
 28446                                  ;	TITLE	DIR2 - Directory and path cracking
 28447                                  ;	NAME	Dir2
 28448                                  
 28449                                  ;Break	<GETPATH -- PARSE A WFP>
 28450                                  ;----------------------------------------------------------------------------
 28451                                  ;
 28452                                  ; Procedure Name : GETPATH
 28453                                  ;
 28454                                  ; Inputs:
 28455                                  ;	[WFP_START] Points to WFP string ("d:\" must be first 3 chars, NUL
 28456                                  ;		terminated; d:/ (note forward slash) indicates a real device).
 28457                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 28458                                  ;		( = -1 if current dir not involved, else
 28459                                  ;		 Points to first char after last "/" of current dir part)
 28460                                  ;	[THISCDS] Points to CDS being used
 28461                                  ;	[SATTRIB] Is attribute of search, determines what files can be found
 28462                                  ;	[NoSetDir] set
 28463                                  ;	[THISDPB] set to DPB if disk otherwise garbage.
 28464                                  ; Function:
 28465                                  ;	Crack the path
 28466                                  ; Outputs:
 28467                                  ;	Sets EXTERR_LOCUS = errLOC_Disk if disk file
 28468                                  ;	Sets EXTERR_LOCUS = errLOC_Unk if char device
 28469                                  ;	ID1 field of [THISCDS] updated appropriately
 28470                                  ;	[ATTRIB] = [SATTRIB]
 28471                                  ;	ES:BP Points to DPB
 28472                                  ;	Carry set if bad path
 28473                                  ;	   SI Points to path element causing failure
 28474                                  ;	   Zero set
 28475                                  ;	      [DIRSTART],[DIRSEC],[CLUSNUM], and [CLUSFAC] are set up to
 28476                                  ;	      start a search on the last directory
 28477                                  ;	      CL is zero if there is a bad name in the path
 28478                                  ;	      CL is non-zero if the name was simply not found
 28479                                  ;		 [ENTFREE] may have free spot in directory
 28480                                  ;		 [NAME1] is the name.
 28481                                  ;		 CL = 81H if '*'s or '?' in NAME1, 80H otherwise
 28482                                  ;	   Zero reset
 28483                                  ;	      File in middle of path or bad name in path or attribute mismatch
 28484                                  ;		or path too long or malformed path
 28485                                  ;	ELSE
 28486                                  ;	   [CurBuf] = -1 if root directory
 28487                                  ;	   [CURBUF] contains directory record with match
 28488                                  ;	   [CURBUF+2]:BX Points into [CURBUF] to start of entry
 28489                                  ;	   [CURBUF+2]:SI Points into [CURBUF] to dir_first field for entry
 28490                                  ;	   AH = device ID
 28491                                  ;	      bit 7 of AH set if device SI and BX
 28492                                  ;	      will point DOSGROUP relative The firclus
 28493                                  ;	      field of the device entry contains the device pointer
 28494                                  ;	   [NAME1] Has name looked for
 28495                                  ;	   If last element is a directory zero is set and:
 28496                                  ;	      [DIRSTART],[SECCLUSPOS],[DIRSEC],[CLUSNUM], and [CLUSFAC]
 28497                                  ;	      are set up to start a search on it.
 28498                                  ;	      unless [NoSetDir] is non zero in which case the return is
 28499                                  ;	      like that for a file (except for zero flag)
 28500                                  ;	   If last element is a file zero is reset
 28501                                  ;	      [DIRSEC],[CLUSNUM],[CLUSFAC],[NXTCLUSNUM],[SECCLUSPOS],
 28502                                  ;	      [LASTENT], [ENTLAST] are set to continue search of last
 28503                                  ;	      directory for furthur matches on NAME1 via the NEXTENT
 28504                                  ;	      entry point in FindEntry (or GETENT entry in GETENTRY in
 28505                                  ;	      which case [NXTCLUSNUM] and [SECCLUSPOS] need not be valid)
 28506                                  ; DS preserved, Others destroyed
 28507                                  ;---------------------------------------------------------------------------
 28508                                  
 28509                                  ;hkn; called from delete.asm, finfo.asm, mknode.asm and rename.asm.
 28510                                  ;hkn; DS already set up at this point.
 28511                                  
 28512                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 28513                                  
 28514                                  	; 15/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28515                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:8B99h
 28516                                  
 28517                                  GETPATH:
 28518                                  	;mov	word [CREATING],0E500h
 28519 000049C4 C706[7E05]00E5          	MOV	WORD [CREATING],DIRFREE*256+0 ; Not Creating, not DEL *.*
 28520                                  
 28521                                  ; Same as GetPath only CREATING and DELALL already set
 28522                                  
 28523                                  	;entry	GetPathNoSet
 28524                                  GetPathNoSet:
 28525                                  	;;mov	byte [EXTERR_LOCUS],2
 28526                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Disk
 28527                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 28528 000049CA E8F6C8                  	call	set_exerr_locus_disk
 28529                                  	;
 28530 000049CD C706[E205]FFFF          	MOV	word [CURBUF],-1	; initial setting
 28531                                  
 28532                                  ; See if the input indicates a device that has already been detected. If so,
 28533                                  ; go build the guy quickly. Otherwise, let findpath find the device.
 28534                                  
 28535 000049D3 8B3E[B205]              	MOV	DI,[WFP_START]		; point to the beginning of the name
 28536                                  	;cmp	word [DI+1],5C3Ah
 28537                                  	;CMP	WORD [DI+1],'\' << 8 + ':'
 28538 000049D7 817D013A5C              	cmp	word [DI+1],':\'
 28539 000049DC 7435                    	JZ	short CrackIt
 28540                                  
 28541                                  ; Let ChkDev find it in the device list
 28542                                  
 28543 000049DE 83C703                  	ADD	DI,3
 28544                                  	; 18/08/2018
 28545                                  	;MOV	SI,DI			; let CHKDEV see the original name
 28546                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 28547                                  	; 16/12/2022
 28548                                  	;mov	si,di ; not required ! (it is written in CHKDEV proc already!)
 28549 000049E1 E87300                  	CALL	CHKDEV
 28550 000049E4 722B                    	JC	short InternalError
 28551                                  
 28552                                  Build_devJ:
 28553 000049E6 A0[6D05]                	MOV	AL,[SATTRIB]
 28554 000049E9 A2[6B05]                	MOV	[ATTRIB],AL
 28555                                  	; 15/02/2024
 28556                                  	;;mov	byte [EXTERR_LOCUS],1
 28557                                  	;MOV	byte [EXTERR_LOCUS],errLOC_Unk ; In the particular case of
 28558                                  					; "finding" a char device
 28559                                  					; set LOCUS to Unknown. This makes
 28560                                  					; certain idiotic problems reported
 28561                                  					; by a certain 3 letter OEM go away.
 28562                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 28563 000049EC E8CBC8                  	call	set_exerr_locus_unk
 28564                                  
 28565                                  ; Take name in name1 and pack it back into where wfp_start points. This
 28566                                  ; guarantees wfp_start pointing to a canonical representation of a device.
 28567                                  ; We are allowed to do this as GetPath is *ALWAYS* called before entering a
 28568                                  ; wfp into the share set.
 28569                                  ;
 28570                                  ; We copy chars from name1 to wfp_start remembering the position of the last
 28571                                  ; non-space seen +1.  This position is kept in DX.
 28572                                  
 28573                                  ;hkn; SS is DOSDATA
 28574 000049EF 16                      	push	ss
 28575 000049F0 07                      	pop	es
 28576                                  
 28577                                  ;hkn; NAME1 is in DOSDATA
 28578 000049F1 BE[4B05]                	mov	si,NAME1
 28579 000049F4 8B3E[B205]              	mov	di,[WFP_START]
 28580 000049F8 89FA                    	mov	dx,di
 28581 000049FA B90800                  	mov	cx,8			; 8 chars in device name
 28582                                  MoveLoop:
 28583 000049FD AC                      	lodsb
 28584 000049FE AA                      	stosb
 28585 000049FF 3C20                    	cmp	al," "
 28586 00004A01 7402                    	jz	short NoSave
 28587                                  
 28588 00004A03 89FA                    	mov	dx,di
 28589                                  NoSave:
 28590 00004A05 E2F6                    	loop	MoveLoop
 28591                                  
 28592                                  ; DX is the position of the last seen non-space + 1. We terminate the name
 28593                                  ; at this point.
 28594                                  
 28595 00004A07 89D7                    	mov	di,dx
 28596                                  	;mov	byte [di],0		; end of string
 28597                                  	; 15/02/2024
 28598 00004A09 880D                    	mov	[di],cl ; 0
 28599 00004A0B E84B02                  	call	Build_device_ent	; Clears carry sets zero
 28600 00004A0E FEC0                    	INC	AL			; reset zero
 28601 00004A10 C3                      	retn
 28602                                  
 28603                                  InternalError:
 28604                                  InternalError_loop:
 28605 00004A11 EBFE                    	JMP	short InternalError_loop ; freeze
 28606                                  
 28607                                  ; Start off at the correct spot. Optimize if the current dir part is valid.
 28608                                  
 28609                                  CrackIt:
 28610                                  ; 15/02/2024
 28611                                  %if 0
 28612                                  	MOV	SI,[CURR_DIR_END]	; get current directory pointer
 28613                                  	CMP	SI,-1			; valid?
 28614                                  	JNZ	short LOOK_SING		; Yes, use it.
 28615                                  	LEA	SI,[DI+3]		; skip D:\.
 28616                                  LOOK_SING:
 28617                                  %endif
 28618                                  	;mov	byte [ATTRIB],16h
 28619 00004A13 C606[6B05]16            	MOV	byte [ATTRIB],attr_directory+attr_system+attr_hidden
 28620                                  					; Attributes to search through Dirs
 28621 00004A18 C43E[A205]              	LES	DI,[THISCDS]
 28622 00004A1C B8FFFF                  	MOV	AX,-1 ; 0FFFFh
 28623                                  	;;;
 28624                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 28625                                  	;mov	bx,[es:di+4Bh]
 28626 00004A1F 268B5D4B                	mov	bx,[es:di+curdir.ID+2]
 28627 00004A23 891E[EE0A]              	mov	[ROOTCLUST_HW],bx
 28628                                  	;;;
 28629                                  	;mov	bx,[es:di+73]
 28630 00004A27 268B5D49                	MOV	BX,[ES:DI+curdir.ID]
 28631 00004A2B 8B36[B605]              	MOV	SI,[CURR_DIR_END]
 28632                                  
 28633                                  ; AX = -1
 28634                                  ; BX = cluster number of current directory. This number is -1 if the media
 28635                                  ;      has been uncertainly changed.
 28636                                  ; SI = offset in DOSGroup into path to end of current directory text. This
 28637                                  ;      may be -1 if no current directory part has been used.
 28638                                  
 28639 00004A2F 39C6                    	CMP	SI,AX			; if Current directory is not part
 28640 00004A31 740A                    	JZ	short NO_CURR_D		; then we must crack from root
 28641                                  	;;;
 28642                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 28643 00004A33 3906[EE0A]              	cmp	[ROOTCLUST_HW],ax ; 0FFFFh
 28644                                  	;jnz	short CrackIt2
 28645                                  	; 03/03/2025 (MiniDOS)
 28646 00004A37 7511                    	jne	short GOT_SEARCH_CLUSTER
 28647                                  	;;;
 28648 00004A39 39C3                    	CMP	BX,AX			; is the current directory cluster valid
 28649                                  
 28650                                  ; DOS 3.3  6/25/86
 28651                                  	;JZ	short NO_CURR_D		; no, crack from the root
 28652                                  	; 03/03/2025 (MiniDOS)
 28653 00004A3B 750D                    	jne	short GOT_SEARCH_CLUSTER
 28654                                  
 28655                                  ; 03/03/2025 (MiniDOS)
 28656                                  %if 0
 28657                                  
 28658                                  CrackIt2:	; 15/02/2024 - Retro DOS v5.0
 28659                                  
 28660                                  	;test	byte [FastOpenFlg],1
 28661                                  	TEST	byte [FastOpenFlg],FastOpen_Set ; for fastopen ?
 28662                                  	JZ	short GOT_SEARCH_CLUSTER	; no
 28663                                  
 28664                                  	PUSH	ES			; save registers
 28665                                  	PUSH	DI
 28666                                  	PUSH	CX
 28667                                  	PUSH	word [SI-1]		; save \ and 1st char of next element
 28668                                  	PUSH	SI
 28669                                  	PUSH	BX
 28670                                  	;;; 15/02/2024
 28671                                  	push	word [ROOTCLUST_HW]
 28672                                  	;;;
 28673                                  	MOV	BYTE [SI-1],0		; call fastopen to look up cur dir info
 28674                                  	MOV	SI,[WFP_START]
 28675                                  
 28676                                  ;hkn; FastOpenTable, Dir_Info_Buff & FastOpen_Ext_Info are in DOSDATA
 28677                                  	MOV	BX,FastOpenTable
 28678                                  	MOV	DI,Dir_Info_Buff
 28679                                  	MOV	CX,FastOpen_Ext_Info
 28680                                  	;mov	al,1
 28681                                  	MOV	AL,FONC_Look_up
 28682                                  	PUSH	DS
 28683                                  	POP	ES
 28684                                  	;call	far [BX+2]
 28685                                  	CALL	far [BX+fastopen_entry.name_caching]
 28686                                  	JC	short GO_Chk_end1 	;fastopen not installed, or wrong drive.
 28687                                  					; Go to Got_Srch_cluster
 28688                                  	; 29/12/2022
 28689                                  	;CMP	BYTE [SI],0		;fastopen has current dir info?
 28690                                  	;JE	short GO_Chk_end	;yes. Go to got_search_cluster
 28691                                  	;stc
 28692                                  	;jmp	short GO_Chk_end	;Go to No_Curr_D
 28693                                  
 28694                                  	cmp	byte [si],1
 28695                                  GO_Chk_end1:	; 29/12/2022
 28696                                  	cmc 
 28697                                  	; [si] = 0 -> cf = 0
 28698                                  	; [si] > 0 -> cf = 1
 28699                                  
 28700                                  ;GO_Chk_end1:
 28701                                  	; 29/12/2022
 28702                                  	;clc
 28703                                  
 28704                                  GO_Chk_end:				; restore registers
 28705                                  	;;; 15/02/2024
 28706                                  	pop	word [ROOTCLUST_HW]
 28707                                  	;;;
 28708                                  	POP	BX
 28709                                  	POP	SI
 28710                                  	POP	word [SI-1]
 28711                                  	POP	CX
 28712                                  	POP	DI
 28713                                  	POP	ES
 28714                                  	JNC	short GOT_SEARCH_CLUSTER ; crack based on cur dir
 28715                                  %endif
 28716                                  
 28717                                  ; DOS 3.3  6/25/86
 28718                                  ;
 28719                                  ; We must cract the path beginning at the root. Advance pointer to beginning
 28720                                  ; of path and go crack from root.
 28721                                  
 28722                                  NO_CURR_D:
 28723 00004A3D 8B36[B205]              	MOV	SI,[WFP_START]
 28724                                  	;LEA	SI,[SI+3]		; Skip "d:/"
 28725                                  	; 15/02/2024
 28726 00004A41 83C603                  	add	si,3
 28727 00004A44 C42E[8A05]              	LES	BP,[THISDPB]		; Get ES:BP
 28728 00004A48 EB37                    	JMP	short ROOTPATH
 28729                                  
 28730                                  ; We are able to crack from the current directory part. Go set up for search
 28731                                  ; of specified cluster.
 28732                                  
 28733                                  GOT_SEARCH_CLUSTER:
 28734 00004A4A C42E[8A05]              	LES	BP,[THISDPB]		; Get ES:BP
 28735 00004A4E E8C6FD                  	call	SETDIRSRCH
 28736                                  	;JC	short SETFERR
 28737                                  	;JMP	short FINDPATH
 28738                                  	; 16/12/2022
 28739 00004A51 733E                    	jnc	short FINDPATH ; 17/08/2018
 28740                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 28741                                  	;JC	short SETFERR
 28742                                  	;JMP	short FINDPATH
 28743                                  SETFERR:
 28744 00004A53 30C9                    	XOR	CL,CL			; set zero
 28745 00004A55 F9                      	STC
 28746 00004A56 C3                      	retn
 28747                                  
 28748                                  ;---------------------------------------------------------------------------
 28749                                  ;
 28750                                  ; Procedure Name : ChkDev
 28751                                  ;
 28752                                  ; Check to see if the name at DS:DI is a device. Returns carry set if not a
 28753                                  ;   device.
 28754                                  ; Blasts CX,SI,DI,AX,BX
 28755                                  ;---------------------------------------------------------------------------
 28756                                  
 28757                                  CHKDEV:
 28758 00004A57 89FE                    	MOV	SI,DI
 28759                                  	;MOV	DI,SS
 28760                                  	;MOV	ES,DI
 28761                                  	; 27/06/2024
 28762 00004A59 16                      	push	ss
 28763 00004A5A 07                      	pop	es
 28764                                  
 28765 00004A5B BF[4B05]                	MOV	DI,NAME1
 28766 00004A5E B90900                  	MOV	CX,9
 28767                                  TESTLOOP:
 28768 00004A61 E8D80F                  	call	GETLET
 28769                                  
 28770 00004A64 3C2E                    	CMP	AL,'.'
 28771 00004A66 740E                    	JZ	short TESTDEVICE
 28772 00004A68 E82510                  	call	PATHCHRCMP
 28773 00004A6B 7407                    	JZ	short NOTDEV
 28774 00004A6D 08C0                    	OR	AL,AL
 28775 00004A6F 7405                    	JZ	short TESTDEVICE
 28776                                  
 28777 00004A71 AA                      	STOSB
 28778 00004A72 E2ED                    	LOOP	TESTLOOP
 28779                                  NOTDEV:
 28780 00004A74 F9                      	STC
 28781 00004A75 C3                      	retn
 28782                                  
 28783                                  TESTDEVICE:
 28784                                  	;ADD	CX,2
 28785                                  	; 24/09/2023
 28786 00004A76 41                      	inc	cx
 28787 00004A77 41                      	inc	cx
 28788 00004A78 B020                    	MOV	AL,' '
 28789 00004A7A F3AA                    	REP	STOSB
 28790                                  	;MOV	AX,SS
 28791                                  	;MOV	DS,AX
 28792                                  	; 27/06/2024
 28793 00004A7C 16                      	push	ss
 28794 00004A7D 1F                      	pop	ds
 28795                                  	;call	DEVNAME
 28796                                  	;retn
 28797                                  	; 18/12/2022
 28798 00004A7E E97A01                  	jmp	DEVNAME
 28799                                  
 28800                                  ;Break	<ROOTPATH, FINDPATH -- PARSE A PATH>
 28801                                  ;----------------------------------------------------------------------------
 28802                                  ;
 28803                                  ; Procedure Name : ROOTPATH,FINDPATH
 28804                                  ;
 28805                                  ; Inputs:
 28806                                  ;	Same as FINDPATH but,
 28807                                  ;	SI Points to asciz string of path which is assumed to start at
 28808                                  ;		the root (no leading '/').
 28809                                  ; Function:
 28810                                  ;	Search from root for path
 28811                                  ; Outputs:
 28812                                  ;	Same as FINDPATH but:
 28813                                  ;	If root directory specified, [CURBUF] and [NAME1] are NOT set, and
 28814                                  ;	[NoSetDir] is ignored.
 28815                                  ;----------------------------------------------------------------------------
 28816                                  
 28817                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 28818                                  	; DOSCODE:7F47h (MSDOS 5.0, MSDOS.SYS)
 28819                                  
 28820                                  	; 15/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28821                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:8C9Dh
 28822                                  
 28823                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:7F82h)
 28824                                  	; (Windows ME IO.SYS - BIOSCODE:829Eh)
 28825                                  
 28826                                  ROOTPATH:
 28827 00004A81 E8B8FD                  	call	SETROOTSRCH
 28828                                  	; 24/09/2023
 28829 00004A84 30E4                    	xor	ah,ah
 28830                                  	;CMP	BYTE [SI],0
 28831 00004A86 3824                    	cmp	[si],ah ; 0
 28832 00004A88 7507                    	JNZ	short FINDPATH
 28833                                  
 28834                                  	;;;
 28835                                  	;; 15/02/2024
 28836                                  	; Windows ME IO.SYS - BIOSCODE:82A6h
 28837                                  	;mov	word [CURBUF],0FFFFh
 28838                                  	;;;
 28839                                  
 28840                                  ; Root dir specified
 28841 00004A8A A0[6D05]                	MOV	AL,[SATTRIB]
 28842 00004A8D A2[6B05]                	MOV	[ATTRIB],AL
 28843                                  	; 24/09/2023
 28844                                  	;XOR	AH,AH			; Sets "device ID" byte, sets zero
 28845                                  					; (dir), clears carry.
 28846 00004A90 C3                      	retn
 28847                                  
 28848                                  ; Inputs:
 28849                                  ;	[ATTRIB] Set to get through directories
 28850                                  ;	[SATTRIB] Set to find last element
 28851                                  ;	ES:BP Points to DPB
 28852                                  ;	SI Points to asciz string of path (no leading '/').
 28853                                  ;	[SECCLUSPOS] = 0
 28854                                  ;	[DIRSEC] = Phys sec # of first sector of directory
 28855                                  ;	[CLUSNUM] = Cluster # of next cluster
 28856                                  ;	[CLUSFAC] = Sectors per cluster
 28857                                  ;	[NoSetDir] set
 28858                                  ;	[CURR_DIR_END] Points to end of Current dir part of string
 28859                                  ;		( = -1 if current dir not involved, else
 28860                                  ;		 Points to first char after last "/" of current dir part)
 28861                                  ;	[THISCDS] Points to CDS being used
 28862                                  ;	[CREATING] and [DELALL] set
 28863                                  ; Function:
 28864                                  ;	Parse path name
 28865                                  ; Outputs:
 28866                                  ;	ID1 field of [THISCDS] updated appropriately
 28867                                  ;	[ATTRIB] = [SATTRIB]
 28868                                  ;	ES:BP Points to DPB
 28869                                  ;	[THISDPB] = ES:BP
 28870                                  ;	Carry set if bad path
 28871                                  ;	   SI Points to path element causing failure
 28872                                  ;	   Zero set
 28873                                  ;	      [DIRSTART],[DIRSEC],[CLUSNUM], and [CLUSFAC] are set up to
 28874                                  ;	      start a search on the last directory
 28875                                  ;	      CL is zero if there is a bad name in the path
 28876                                  ;	      CL is non-zero if the name was simply not found
 28877                                  ;		 [ENTFREE] may have free spot in directory
 28878                                  ;		 [NAME1] is the name.
 28879                                  ;		 CL = 81H if '*'s or '?' in NAME1, 80H otherwise
 28880                                  ;	   Zero reset
 28881                                  ;	      File in middle of path or bad name in path
 28882                                  ;		or path too long or malformed path
 28883                                  ;	ELSE
 28884                                  ;	   [CURBUF] contains directory record with match
 28885                                  ;	   [CURBUF+2]:BX Points into [CURBUF] to start of entry
 28886                                  ;	   [CURBUF+2]:SI Points to fcb_FIRCLUS field for entry
 28887                                  ;	   [NAME1] Has name looked for
 28888                                  ;	   AH = device ID
 28889                                  ;	      bit 7 of AH set if device SI and BX
 28890                                  ;	      will point DOSGROUP relative The firclus
 28891                                  ;	      field of the device entry contains the device pointer
 28892                                  ;	   If last element is a directory zero is set and:
 28893                                  ;	      [DIRSTART],[SECCLUSPOS],[DIRSEC],[CLUSNUM], and [CLUSFAC]
 28894                                  ;	      are set up to start a search on it,
 28895                                  ;	      unless [NoSetDir] is non zero in which case the return is
 28896                                  ;	      like that for a file (except for zero flag)
 28897                                  ;	   If last element is a file zero is reset
 28898                                  ;	      [DIRSEC],[CLUSNUM],[CLUSFAC],[NXTCLUSNUM],[SECCLUSPOS],
 28899                                  ;	      [LASTENT], [ENTLAST] are set to continue search of last
 28900                                  ;	      directory for furthur matches on NAME1 via the NEXTENT
 28901                                  ;	      entry point in FindEntry (or GETENT entry in GETENTRY in
 28902                                  ;	      which case [NXTCLUSNUM] and [SECCLUSPOS] need not be valid)
 28903                                  ; Destroys all other registers
 28904                                  
 28905                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 28906                                  	; DOSCODE:7F58h (MSDOS 5.0, MSDOS.SYS)
 28907                                  
 28908                                  	; 15/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 28909                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:8CAEh
 28910                                  
 28911                                      	;entry	FINDPATH
 28912                                  FINDPATH:
 28913 00004A91 06                      	PUSH	ES			; Save ES:BP
 28914 00004A92 56                      	PUSH	SI
 28915 00004A93 89F7                    	MOV	DI,SI
 28916 00004A95 8B0E[C205]              	MOV	CX,[DIRSTART]		; Get start clus of dir being searched
 28917 00004A99 833E[B605]FF            	CMP	word [CURR_DIR_END],-1
 28918 00004A9E 7415                    	JZ	short NOIDS		; No current dir part
 28919 00004AA0 3B3E[B605]              	CMP	DI,[CURR_DIR_END]
 28920 00004AA4 750F                    	JNZ	short NOIDS		; Not to current dir end yet
 28921 00004AA6 C43E[A205]              	LES	DI,[THISCDS]
 28922                                  	;;;
 28923                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 28924 00004AAA A1[DC0A]                	mov	ax,[DIRSTART_HW]
 28925                                  	;mov	[es:di+4Bh],ax
 28926 00004AAD 2689454B                	mov	[es:di+curdir.ID+2],ax
 28927                                  	;;;
 28928                                  	;mov	[es:di+73],cx
 28929 00004AB1 26894D49                	MOV	[ES:DI+curdir.ID],CX	; Set current directory cluster
 28930                                  NOIDS:
 28931                                  
 28932                                  ; Parse the name off of DS:SI into NAME1. AL = 1 if there was a meta
 28933                                  ; character in the string. CX,DI may be destroyed.
 28934                                  ;
 28935                                  ;	invoke	NAMETRANS
 28936                                  ;	MOV	CL,AL
 28937                                  ;
 28938                                  ; The above is the slow method. The name has *already* been munged by
 28939                                  ; TransPath so no special casing needs to be done. All we do is try to copy
 28940                                  ; the name until ., \ or 0 is hit.
 28941                                  
 28942                                  	;MOV	AX,SS
 28943                                  	;MOV	ES,AX
 28944                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 28945 00004AB5 16                      	push	ss
 28946 00004AB6 07                      	pop	es
 28947                                  
 28948                                  ;hkn; Name1 is in DOSDATA
 28949 00004AB7 BF[4B05]                	MOV	DI,NAME1
 28950 00004ABA B82020                  	MOV	AX,'  ' ; 2020h
 28951 00004ABD AA                      	STOSB
 28952 00004ABE AB                      	STOSW
 28953 00004ABF AB                      	STOSW
 28954 00004AC0 AB                      	STOSW
 28955 00004AC1 AB                      	STOSW
 28956 00004AC2 AB                      	STOSW
 28957                                  
 28958                                  ;hkn; Name1 is in DOSDATA
 28959 00004AC3 BF[4B05]                	MOV	DI,NAME1
 28960 00004AC6 30E4                    	XOR	AH,AH			; bits for CL
 28961                                  GetNam:
 28962                                  	; 19/05/2019 - Retro DOS v4.0
 28963                                  	;INC	CL ; ?*! ; MSDOS 6.0	;AN000; KK increment volid count
 28964                                  
 28965                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 28966                                  	; 16/12/2022
 28967                                  	;inc	cl ; not required !
 28968                                  	
 28969 00004AC8 AC                      	LODSB
 28970 00004AC9 3C2E                    	CMP	AL,'.'	; 2Eh
 28971 00004ACB 7412                    	JZ	short _SetExt
 28972 00004ACD 08C0                    	OR	AL,AL
 28973 00004ACF 7424                    	JZ	short _GetDone
 28974 00004AD1 3C5C                    	CMP	AL,'\'	; 5Ch
 28975 00004AD3 7420                    	JZ	short _GetDone
 28976 00004AD5 3C3F                    	CMP	AL,'?'	; 3Fh
 28977 00004AD7 7503                    	JNZ	short StoNam
 28978 00004AD9 80CC01                  	OR	AH,1
 28979                                  StoNam: 
 28980 00004ADC AA                      	STOSB
 28981 00004ADD EBE9                    	JMP	short GetNam
 28982                                  _SetExt:
 28983 00004ADF BF[5305]                	MOV	DI,NAME1+8
 28984                                  GetExt:
 28985 00004AE2 AC                      	LODSB
 28986 00004AE3 08C0                    	OR	AL,AL
 28987 00004AE5 740E                    	JZ	short _GetDone
 28988 00004AE7 3C5C                    	CMP	AL,'\'
 28989 00004AE9 740A                    	JZ	short _GetDone
 28990 00004AEB 3C3F                    	CMP	AL,'?'
 28991 00004AED 7503                    	JNZ	short StoExt
 28992 00004AEF 80CC01                  	OR	AH,1
 28993                                  StoExt: 
 28994 00004AF2 AA                      	STOSB
 28995 00004AF3 EBED                    	JMP	short GetExt
 28996                                  _GetDone:
 28997 00004AF5 4E                      	DEC	SI
 28998 00004AF6 88E1                    	MOV	CL,AH  ; 0 or 1 ; 29/12/2022
 28999 00004AF8 80C980                  	OR	CL,80H
 29000 00004AFB 5F                      	POP	DI			; Start of this element
 29001 00004AFC 07                      	POP	ES			; Restore ES:BP
 29002 00004AFD 39FE                    	CMP	SI,DI
 29003 00004AFF 7503                    	JNZ	short check_device
 29004 00004B01 E9B700                  	JMP	_BADPATH		; NUL parse (two delims most likely)
 29005                                  check_device:
 29006 00004B04 56                      	PUSH	SI			; Start of next element
 29007                                  	;MOV	AL,[SI]
 29008                                  	; 15/02/2024
 29009 00004B05 08C0                    	OR	AL,AL
 29010                                  	; 23/09/2023
 29011                                  	;cmp	byte [si],0
 29012 00004B07 7508                    	JNZ	short NOT_LAST
 29013                                  
 29014                                  ; for last element of the path switch to the correct search attributes
 29015                                  
 29016 00004B09 8A3E[6D05]              	MOV	BH,[SATTRIB]
 29017 00004B0D 883E[6B05]              	MOV	[ATTRIB],BH
 29018                                  
 29019                                  NOT_LAST:
 29020                                  
 29021                                  ; check name1 to see if we have a device...
 29022                                  
 29023 00004B11 06                      	PUSH	ES			; Save ES:BP
 29024                                  
 29025                                  ;hkn; SS is DOSDATA
 29026                                  	;context ES
 29027 00004B12 16                      	push	ss
 29028 00004B13 07                      	pop	es
 29029 00004B14 E8E400                  	call	DEVNAME 		; blast BX
 29030 00004B17 07                      	POP	ES			; Restore ES:BP
 29031 00004B18 7208                    	JC	short FindFile		; Not a device
 29032 00004B1A 08C0                    	OR	AL,AL			; Test next char again
 29033                                  	;JZ	short GO_BDEV
 29034                                  	;JMP	FILEINPATH		; Device name in middle of path
 29035                                  	; 27/06/2024
 29036 00004B1C 7528                    	jnz	short FILEINPATH_j
 29037                                  
 29038                                  GO_BDEV:
 29039 00004B1E 5E                      	POP	SI			; Points to NUL at end of path
 29040 00004B1F E9C4FE                  	JMP	Build_devJ
 29041                                  
 29042                                  FindFile:
 29043                                  ;;;; 7/28/86
 29044 00004B22 803E[4B05]E5            	CMP	BYTE [NAME1],0E5H	; if 1st char = E5
 29045 00004B27 7505                    	JNZ	short NOE5		; no
 29046 00004B29 C606[4B05]05            	MOV	BYTE [NAME1],05H	; change it to 05
 29047                                  NOE5:
 29048                                  ;;;; 7/28/86
 29049 00004B2E 57                      	PUSH	DI			; Start of this element
 29050 00004B2F 06                      	PUSH	ES			; Save ES:BP
 29051 00004B30 51                      	PUSH	CX			; CL return from NameTrans
 29052                                  ;DOS 3.3 FastOPen 6/12/86 F.C.
 29053                                  
 29054                                  	; 03/03/2025 (MiniDOS)
 29055                                  	;CALL	LookupPath		; call fastopen to get dir entry
 29056                                  	;JNC	short DIR_FOUND		; found dir entry
 29057                                  
 29058                                  ;DOS 3.3 FastOPen 6/12/86 F.C.
 29059 00004B31 E8C5FA                  	call	FINDENTRY
 29060                                  DIR_FOUND:
 29061 00004B34 59                      	POP	CX
 29062 00004B35 07                      	POP	ES
 29063 00004B36 5F                      	POP	DI
 29064 00004B37 7303                    	JNC	short LOAD_BUF
 29065 00004B39 E98F00                  	JMP	BADPATHPOP
 29066                                  
 29067                                  LOAD_BUF:
 29068 00004B3C C53E[E205]              	LDS	DI,[CURBUF]
 29069                                  	;test	byte [bx+0Bh],10h
 29070 00004B40 F6470B10                	TEST	BYTE [BX+dir_entry.dir_attr],attr_directory
 29071 00004B44 7503                    	JNZ	short GO_NEXT 		; DOS 3.3
 29072                                  FILEINPATH_j:	; 27/06/2024
 29073 00004B46 EB77                    	JMP	FILEINPATH		; Error or end of path
 29074                                  
 29075                                  	; 03/03/2025
 29076                                  _SETRET:
 29077 00004B48 C3                      	retn
 29078                                  
 29079                                  ; if we are not setting the directory, then check for end of string
 29080                                  
 29081                                  GO_NEXT:
 29082                                  ;hkn; SS override
 29083 00004B49 36803E[4C03]00          	CMP	BYTE [SS:NoSetDir],0
 29084 00004B4F 7411                    	JZ	short SetDir
 29085 00004B51 89FA                    	MOV	DX,DI			; Save pointer to entry
 29086 00004B53 8CD9                    	MOV	CX,DS
 29087                                  
 29088                                  ;hkn; SS is DOSDATA
 29089                                  	;context DS
 29090 00004B55 16                      	push	ss
 29091 00004B56 1F                      	pop	ds
 29092 00004B57 5F                      	POP	DI			; Start of next element
 29093                                  	
 29094                                  	; 03/03/2025 (MiniDos)
 29095                                  	;; 19/05/2019 - Retro DOS v4.0
 29096                                  	;; MSDOS 6.0
 29097                                  	;TEST	byte [FastOpenFlg],FastOpen_Set ;only DOSOPEN can take advantage of
 29098                                  	;JZ	short _nofast			; the FastOpen
 29099                                  	;TEST	byte [FastOpenFlg],Lookup_Success ; Lookup just happened
 29100                                  	;JZ	short _nofast			; no
 29101                                  	;MOV	DI,[Next_Element_Start]	; no need to insert it again
 29102                                  ;_nofast:
 29103 00004B58 803D00                  	CMP	BYTE [DI],0
 29104                                  	;;JNZ	short NEXT_ONE		; DOS 3.3
 29105                                  	;;JMP	_SETRET  ; retn		; Got it
 29106                                  	;retn	; 05/09/2018
 29107                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 29108                                  	;jmp	_SETRET
 29109                                  	; 16/12/2022
 29110 00004B5B 74EB                    	jz	short _SETRET
 29111                                  
 29112                                  NEXT_ONE:
 29113 00004B5D 57                      	PUSH	DI			; Put start of next element back on stack
 29114 00004B5E 89D7                    	MOV	DI,DX
 29115 00004B60 8ED9                    	MOV	DS,CX			; Get back pointer to entry
 29116                                  SetDir:
 29117                                  	;;;
 29118                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29119 00004B62 31D2                    	xor	dx,dx ; 0
 29120                                  	;cmp	[es:bp+0Fh],dx
 29121 00004B64 2639560F                	cmp	[es:bp+DPB.FAT_SIZE],dx ; 0
 29122 00004B68 7503                    	jnz     short SetDir2 ; not FAT32
 29123 00004B6A 8B54FA                  	mov     dx,[si-6]		; dir_entry.dir_fclus_hi
 29124                                  SetDir2:
 29125 00004B6D 368916[EE0A]            	mov	[ss:ROOTCLUST_HW],dx ; 0
 29126                                  	;;;
 29127 00004B72 8B14                    	MOV	DX,[SI] 		; dir_entry.dir_first
 29128                                  
 29129                                  ;DOS 3.3 FastOPen 6/12/86 F.C.
 29130                                  	; 03/03/2025 (MiniDOS)
 29131                                  	;PUSH	DS		      ; save [curbuf+2]
 29132                                  ;hkn; SS is DOSDATA
 29133                                  	;push	ss
 29134                                  	;pop	ds		      ; set DS Dosgroup
 29135                                  	;;test	byte [FastOpenFlg],2
 29136                                  	;TEST	byte [FastOpenFlg],Lookup_Success
 29137                                  	;JZ	short DO_NORMAL	      ; fastopen not in memory or path not
 29138                                  	;MOV	BX,DX		      ; not found
 29139                                  	;MOV	DI,[CLUSNUM]	      ; clusnum was set in LookupPath
 29140                                  	;PUSH	AX		      ; save device id (AH)
 29141                                  	;call	SETDIRSRCH
 29142                                  	;POP	AX		      ; restore device id (AH)
 29143                                  	;ADD	SP,2		      ; pop ds in stack
 29144                                  	;JMP	short FAST_OPEN_SKIP
 29145                                  
 29146                                  	; 16/12/2022
 29147                                  ;_SETRET:
 29148                                  	;retn
 29149                                  
 29150                                  DO_NORMAL:
 29151                                  	;POP	DS			; DS = [curbuf + 2]
 29152                                  ;DOS 3.3 FastOPen 6/12/86 F.C.
 29153                                  
 29154 00004B74 29FB                    	SUB	BX,DI			; Offset into sector of start of entry
 29155 00004B76 29FE                    	SUB	SI,DI			; Offset into sector of dir_first
 29156 00004B78 53                      	PUSH	BX
 29157 00004B79 50                      	PUSH	AX
 29158 00004B7A 56                      	PUSH	SI
 29159 00004B7B 51                      	PUSH	CX
 29160                                  
 29161                                  	; 15/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29162                                  	;lds	bx,[di+6]
 29163 00004B7C C55D06                  	lds	bx,[di+BUFFINFO.buf_sector]
 29164 00004B7F 53                      	push	bx
 29165 00004B80 1E                      	push	ds
 29166                                  
 29167 00004B81 89D3                    	MOV	BX,DX
 29168                                  
 29169                                  ;hkn; SS is DOSDATA
 29170                                  	;context DS
 29171 00004B83 16                      	push	ss
 29172 00004B84 1F                      	pop	ds
 29173                                  	;invoke	SETDIRSRCH		; This uses UNPACK which might blow
 29174 00004B85 E88FFC                  	call	SETDIRSRCH		; the entry sector buffer
 29175                                  	; 19/05/2019
 29176                                  	; MSDOS 6.0
 29177 00004B88 8F06[0706]              	POP	word [HIGH_SECTOR]
 29178 00004B8C 5A                      	POP	DX
 29179 00004B8D 7203                    	JC	short SKIP_GETB
 29180                                  	; 22/09/2023
 29181                                  	;;mov	byte [ALLOWED],18h
 29182                                  	;MOV	byte [ALLOWED],Allowed_RETRY+Allowed_FAIL ; *
 29183                                  	;XOR	AL,AL ; *
 29184                                  	;;invoke GETBUFFR		; Get the entry buffer back
 29185                                  	;call	GETBUFFR
 29186 00004B8F E83D1A                  	call	GETBUFFER ; * ; pre-read
 29187                                  SKIP_GETB:
 29188 00004B92 59                      	POP	CX
 29189 00004B93 5E                      	POP	SI
 29190 00004B94 58                      	POP	AX
 29191 00004B95 5B                      	POP	BX
 29192 00004B96 7305                    	JNC	short SET_THE_BUF
 29193 00004B98 5F                      	POP	DI			; Start of next element
 29194 00004B99 89FE                    	MOV	SI,DI			; Point with SI
 29195 00004B9B EB1E                    	JMP	SHORT _BADPATH
 29196                                  
 29197                                  SET_THE_BUF:
 29198 00004B9D E8AFF2                  	call	SET_BUF_AS_DIR
 29199 00004BA0 8B3E[E205]              	MOV	DI,[CURBUF]
 29200 00004BA4 01FE                    	ADD	SI,DI			; Get the offsets back
 29201 00004BA6 01FB                    	ADD	BX,DI
 29202                                  ; DOS 3.3 FastOpen 6/12/86  F.C.
 29203                                  FAST_OPEN_SKIP:
 29204 00004BA8 5F                      	POP	DI			; Start of next element
 29205                                  
 29206                                  	; 03/03/2025 (MiniDOS)
 29207                                  	;CALL	InsertPath		; insert dir entry info
 29208                                  ; DOS 3.3 FastOpen 6/12/86  F.C.
 29209                                  
 29210 00004BA9 8A05                    	MOV	AL,[DI]
 29211 00004BAB 08C0                    	OR	AL,AL
 29212 00004BAD 7499                    	JZ	short _SETRET		; At end
 29213 00004BAF 47                      	INC	DI			; Skip over "/"
 29214 00004BB0 89FE                    	MOV	SI,DI			; Point with SI
 29215 00004BB2 E8DB0E                  	call	PATHCHRCMP
 29216 00004BB5 7503                    	JNZ	short find_bad_name	; oops
 29217 00004BB7 E9D7FE                  	JMP	FINDPATH		; Next element
 29218                                  
 29219                                  find_bad_name:
 29220 00004BBA 4E                      	DEC	SI			; Undo above INC to get failure point
 29221                                  _BADPATH:
 29222 00004BBB 30C9                    	XOR	CL,CL			; Set zero
 29223 00004BBD EB13                    	JMP	SHORT BADPRET
 29224                                  
 29225                                  FILEINPATH:
 29226 00004BBF 5F                      	POP	DI			; Start of next element
 29227                                  
 29228                                  ;hkn; SS is DOSDATA
 29229                                  	;context DS			; Got to from one place with DS gone
 29230 00004BC0 16                      	push	ss
 29231 00004BC1 1F                      	pop	ds
 29232                                  
 29233                                  ; DOS 3.3 FastOpen
 29234                                  	; 03/03/2025 (MiniDOS)
 29235                                  	;;test	byte [FastOpenFlg],1
 29236                                  	;TEST	byte [FastOpenFlg],FastOpen_Set  ; do this here is we don't want to
 29237                                  	;JZ	short NO_FAST		; device info to fastopen
 29238                                  	;;test	byte [FastOpenFlg],2
 29239                                  	;TEST	byte [FastOpenFlg],Lookup_Success
 29240                                  	;JZ	short NO_FAST
 29241                                  	;MOV	DI,[Next_Element_Start]  ; This takes care of one time lookup
 29242                                  					 ; success
 29243                                  ;NO_FAST:
 29244                                  ; DOS 3.3 FastOpen
 29245                                  
 29246 00004BC2 8A05                    	MOV	AL,[DI]
 29247 00004BC4 08C0                    	OR	AL,AL
 29248                                  	;JZ	short INCRET
 29249                                  	;MOV	SI,DI			; Path too long
 29250                                  	;JMP	SHORT BADPRET
 29251                                  	; 27/06/2024
 29252 00004BC6 7508                    	jnz 	short BADPRET_X
 29253                                  
 29254                                  INCRET:
 29255                                  ; DOS 3.3 FastOpen 6/12/86  F.C.
 29256                                  
 29257                                  	; 03/03/2025 (MiniDOS)
 29258                                  	;CALL	InsertPath		; insert dir entry info
 29259                                  
 29260                                  ; DOS 3.3 FastOpen 6/12/86  F.C.
 29261 00004BC8 FEC0                    	INC	AL			; Reset zero
 29262                                  	; 16/12/2022	
 29263                                  ;_SETRET:
 29264 00004BCA C3                      	retn
 29265                                  
 29266                                  BADPATHPOP:
 29267 00004BCB 5E                      	POP	SI			; Start of next element
 29268 00004BCC 8A04                    	MOV	AL,[SI]
 29269                                  	; 27/06/2024
 29270                                  	;MOV	SI,DI			; Start of bad element
 29271 00004BCE 08C0                    	OR	AL,AL			; zero if bad element is last, non-zero if path too long
 29272                                  BADPRET_X:	; 27/06/2024
 29273 00004BD0 89FE                    	mov	si,di
 29274                                  BADPRET:
 29275 00004BD2 A0[6D05]                	MOV	AL,[SATTRIB]
 29276 00004BD5 A2[6B05]                	MOV	[ATTRIB],AL		; Make sure return correct
 29277 00004BD8 F9                      	STC
 29278 00004BD9 C3                      	retn
 29279                                  
 29280                                  ;Break	<STARTSRCH -- INITIATE DIRECTORY SEARCH>
 29281                                  ;---------------------------------------------------------------------------
 29282                                  ;
 29283                                  ; Procedure Name : STARTSRCH
 29284                                  ;
 29285                                  ; Inputs:
 29286                                  ;	[THISDPB] Set
 29287                                  ; Function:
 29288                                  ;	Set up a search for GETENTRY and NEXTENTRY
 29289                                  ; Outputs:
 29290                                  ;	ES:BP = Drive parameters
 29291                                  ;	Sets up LASTENT, ENTFREE=ENTLAST=-1, VOLID=0
 29292                                  ; Destroys ES,BP,AX
 29293                                  ;--------------------------------------------------------------------------
 29294                                  
 29295                                  STARTSRCH:
 29296 00004BDA C42E[8A05]              	LES	BP,[THISDPB]
 29297 00004BDE 31C0                    	XOR	AX,AX
 29298 00004BE0 A3[4803]                	MOV	[LASTENT],AX
 29299 00004BE3 A2[7B05]                	MOV	[VOLID],AL		; No volume ID found
 29300 00004BE6 48                      	DEC	AX
 29301 00004BE7 A3[D805]                	MOV	[ENTFREE],AX
 29302 00004BEA A3[DA05]                	MOV	[ENTLAST],AX
 29303 00004BED C3                      	retn
 29304                                  
 29305                                  ;BREAK <MatchAttributes - the final check for attribute matching>
 29306                                  ;----------------------------------------------------------------------------
 29307                                  ; Procedure Name : MatchAttributes
 29308                                  ;
 29309                                  ; Input:    [Attrib] = attribute to search for
 29310                                  ;	    CH = found attribute
 29311                                  ; Output:   JZ <match>
 29312                                  ;	    JNZ <nomatch>
 29313                                  ; Registers modified: noneski
 29314                                  ;----------------------------------------------------------------------------
 29315                                  
 29316                                  MatchAttributes:
 29317 00004BEE 50                      	PUSH	AX
 29318                                  
 29319                                  ;hkn; SS override
 29320 00004BEF 36A0[6B05]              	MOV	AL,[ss:ATTRIB]		; AL <- SearchSet
 29321 00004BF3 F6D0                    	NOT	AL			; AL <- SearchSet'
 29322 00004BF5 20E8                    	AND	AL,CH			; AL <- SearchSet' and FoundSet
 29323                                  	;and	al,16h
 29324 00004BF7 2416                    	AND	AL,attr_all	; AL <- SearchSet' and FoundSet and Important
 29325                                  ;
 29326                                  ; the result is non-zero if an attribute is not in the search set
 29327                                  ; and in the found set and in the important set. This means that we do not
 29328                                  ; have a match. Do a JNZ <nomatch> or JZ <match>
 29329                                  ;
 29330 00004BF9 58                      	POP	AX
 29331 00004BFA C3                      	retn
 29332                                  
 29333                                  ; 19/05/2019 - Retro DOS v4.0
 29334                                  ; DOSCODE:8148h (MSDOS 6.21, MSDOS.SYS)
 29335                                  
 29336                                  ; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 29337                                  ; DOSCODE:810Dh (MSDOS 5.0, MSDOS.SYS)
 29338                                  
 29339                                  ; 16/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 29340                                  ; DOSCODE:8E74h (PCDOS 7.1, IBMDOS.COM)
 29341                                  
 29342                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8148h)
 29343                                  ; (Windows ME IO.SYS - BIOSCODE:843Ch)
 29344                                  
 29345                                  ;Break <DevName - Look for name of device>
 29346                                  ;---------------------------------------------------------------------------
 29347                                  ;
 29348                                  ; Procedure Name : DevName
 29349                                  ;
 29350                                  ; Inputs:
 29351                                  ;	DS,ES:DOSDATA
 29352                                  ;	Filename in NAME1
 29353                                  ;	ATTRIB set so that we can error out if looking for Volume IDs
 29354                                  ; Function:
 29355                                  ;	Determine if file is in list of I/O drivers
 29356                                  ; Outputs:
 29357                                  ;	Carry set if not a device
 29358                                  ;	ELSE
 29359                                  ;	Zero flag set
 29360                                  ;	BH = Bit 7,6 = 1, bit 5 = 0 (cooked mode)
 29361                                  ;	     bits 0-4 set from low byte of attribute word
 29362                                  ;	DEVPT = DWORD pointer to Device header of device
 29363                                  ; BX destroyed, others preserved
 29364                                  ;---------------------------------------------------------------------------
 29365                                  
 29366                                  DEVNAME:
 29367                                  	; 28/07/2018 - Retro DOS v3.0
 29368                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 49FBh
 29369                                  
 29370 00004BFB 56                      	PUSH	SI
 29371 00004BFC 57                      	PUSH	DI
 29372 00004BFD 51                      	PUSH	CX
 29373 00004BFE 50                      	PUSH	AX
 29374                                  
 29375                                  ; E5 special code
 29376 00004BFF FF36[4B05]              	PUSH	WORD [NAME1]
 29377 00004C03 803E[4B05]05            	CMP	byte [NAME1],5
 29378 00004C08 7505                    	JNZ	short NOKTR
 29379 00004C0A C606[4B05]E5            	MOV	byte [NAME1],0E5h
 29380                                  NOKTR:
 29381                                  	;test	byte [ATTRIB],8
 29382 00004C0F F606[6B05]08            	TEST	byte [ATTRIB],attr_volume_id
 29383                                  					; If looking for VOL id don't find devs
 29384 00004C14 7520                    	JNZ	short RET31
 29385                                  
 29386                                  ;hkn; NULDEV is in DOSDATA
 29387 00004C16 BE[4800]                	MOV	SI,NULDEV
 29388                                  LOOKIO:
 29389                                  	; 21/11/2022
 29390                                  	;test	byte [SI+SYSDEV.ATT+1],80h
 29391                                  	; 17/12/2022
 29392                                  	;test	byte [si+5],80h
 29393 00004C19 F6440580                	test	byte [SI+SYSDEV.ATT+1],(DEVTYP>>8)
 29394                                  	;;test	word [si+4],8000h
 29395                                  	;TEST	word [SI+SYSDEV.ATT],DEVTYP
 29396 00004C1D 7410                    	JZ	short SKIPDEV 		; Skip block devices (NET and LOCAL)
 29397 00004C1F 89F0                    	MOV	AX,SI
 29398                                  	;add	si,10
 29399 00004C21 83C60A                  	ADD	SI,SYSDEV.NAME
 29400                                  
 29401                                  ;hkn; NAME1 is in DOSDATA
 29402 00004C24 BF[4B05]                	MOV	DI,NAME1
 29403 00004C27 B90400                  	MOV	CX,4			; All devices are 8 letters
 29404 00004C2A F3A7                    	REPE	CMPSW			; Check for name in list
 29405                                  	;MOV	SI,AX
 29406                                  	; 27/06/2024
 29407 00004C2C 96                      	xchg	ax,si
 29408 00004C2D 7415                    	JZ	short IOCHK		; Found it?
 29409                                  SKIPDEV:
 29410 00004C2F C534                    	LDS	SI,[SI]			; Get address of next device
 29411 00004C31 83FEFF                  	CMP	SI,-1			; At end of list?
 29412 00004C34 75E3                    	JNZ	short LOOKIO
 29413                                  RET31:	
 29414 00004C36 F9                      	STC				; Not found
 29415                                  RETNV:	
 29416 00004C37 8CD1                    	MOV	CX,SS
 29417 00004C39 8ED9                    	MOV	DS,CX
 29418                                  
 29419 00004C3B 8F06[4B05]              	POP	WORD [NAME1]
 29420 00004C3F 58                      	POP	AX
 29421 00004C40 59                      	POP	CX
 29422 00004C41 5F                      	POP	DI
 29423 00004C42 5E                      	POP	SI
 29424 00004C43 C3                      	RETN
 29425                                  
 29426                                  IOCHK:
 29427                                  ;hkn; SS override for DEVPT
 29428 00004C44 368C1E[9C05]            	MOV	[SS:DEVPT+2],DS		; Save pointer to device
 29429                                  	;mov	bh,[si+4]
 29430 00004C49 8A7C04                  	MOV	BH,[SI+SYSDEV.ATT]
 29431 00004C4C 80CFC0                  	OR	BH,0C0h
 29432 00004C4F 80E7DF                  	and	bh,0DFh
 29433                                  	;AND	BH,~(020h)		; Clears Carry
 29434 00004C52 368936[9A05]            	MOV	[SS:DEVPT],SI
 29435 00004C57 EBDE                    	JMP	short RETNV
 29436                                  
 29437                                  ;BREAK <Build_device_ent - Make a Directory entry>
 29438                                  ;---------------------------------------------------------------------------
 29439                                  ; Procedure Name : Build_device_ent
 29440                                  ;
 29441                                  ; Inputs:
 29442                                  ;	[NAME1] has name
 29443                                  ;	BH is attribute field (supplied by DEVNAME)
 29444                                  ;	[DEVPT] points to device header (supplied by DEVNAME)
 29445                                  ; Function:
 29446                                  ;	Build a directory entry for a device at DEVFCB
 29447                                  ; Outputs:
 29448                                  ;	BX points to DEVFCB
 29449                                  ;	SI points to dir_first field
 29450                                  ;	AH = input BH
 29451                                  ;	AL = 0
 29452                                  ;	dir_first = DEVPT
 29453                                  ;	Zero Set, Carry Clear
 29454                                  ; DS,ES,BP preserved, others destroyed
 29455                                  ;--------------------------------------------------------------------------
 29456                                  
 29457                                  Build_device_ent:
 29458 00004C59 B82020                  	MOV	AX,"  " ; 2020h
 29459                                  
 29460                                  ;hkn; DEVFCB is in DOSDATA
 29461 00004C5C BF[5305]                	MOV	DI,DEVFCB+8		; Point to extent field
 29462                                  
 29463                                  ;	Fill dir_ext  BUGBUG - use ERRNZs for this stuff!
 29464                                  
 29465 00004C5F AB                      	STOSW
 29466 00004C60 AA                      	STOSB				; Blank out extent field
 29467                                  	;mov	al,40h
 29468 00004C61 B040                    	MOV	AL,attr_device
 29469                                  
 29470                                  ;	Fill Dir_attr
 29471                                  
 29472 00004C63 AA                      	STOSB				; Set attribute field
 29473 00004C64 31C0                    	XOR	AX,AX
 29474 00004C66 B90A00                  	MOV	CX,10
 29475                                  
 29476                                  ; Fill dir_pad
 29477                                  
 29478 00004C69 F3AB                    	REP	STOSW			; Fill rest with zeros
 29479 00004C6B E8CFBE                  	call	DATE16
 29480                                  
 29481                                  ;hkn; DEVFCB is in DOSDATA
 29482 00004C6E BF[6105]                	MOV	DI,DEVFCB+dir_entry.dir_time ; 09/08/2018
 29483 00004C71 92                      	XCHG	AX,DX
 29484                                  
 29485                                  ; Fill dir_time
 29486                                  
 29487 00004C72 AB                      	STOSW
 29488 00004C73 92                      	XCHG	AX,DX
 29489                                  
 29490                                  ; Fill dir_date
 29491                                  
 29492 00004C74 AB                      	STOSW
 29493 00004C75 89FE                    	MOV	SI,DI			; SI points to dir_first field
 29494 00004C77 A1[9A05]                	MOV	AX,[DEVPT]
 29495                                  
 29496                                  ; Fill dir_first
 29497                                  
 29498 00004C7A AB                      	STOSW				; Dir_first points to device
 29499 00004C7B A1[9C05]                	MOV	AX,[DEVPT+2]
 29500                                  ;
 29501                                  ; Fill dir_size_l
 29502                                  ;
 29503 00004C7E AB                      	STOSW
 29504 00004C7F 88FC                    	MOV	AH,BH			; Put device atts in AH
 29505                                  
 29506                                  ;hkn; DEVFCB is in DOSDATA
 29507 00004C81 BB[4B05]                	MOV	BX,DEVFCB
 29508 00004C84 30C0                    	XOR	AL,AL			; Set zero, clear carry
 29509 00004C86 C3                      	retn
 29510                                  
 29511                                  ;Break	<ValidateCDS - given a CDS, validate the media and the current directory>
 29512                                  ;----------------------------------------------------------------------------
 29513                                  ;
 29514                                  ;   ValidateCDS - Get current CDS. Splice it. Call FatReadCDS to check
 29515                                  ;   media. If media has been changed, do DOS_Chdir to validate path.
 29516                                  ;   If invalid, reset original CDS to root.
 29517                                  ;
 29518                                  ;   Inputs:	ThisCDS points to CDS of interest
 29519                                  ;		SS:DI points to temp buffer
 29520                                  ;   Outputs:	The current directory string is validated on the appropriate
 29521                                  ;		    drive
 29522                                  ;		ThisDPB changed
 29523                                  ;		ES:DI point to CDS
 29524                                  ;		Carry set if error (currently user FAILed to I 24)
 29525                                  ;   Registers modified: all
 29526                                  ;----------------------------------------------------------------------------
 29527                                  
 29528                                  	; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 29529                                  	; DOSCODE:819Bh (MSDOS 5.0, MSDOS.SYS)
 29530                                  
 29531                                  	; 16/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 29532                                  	; DOSCODE:8F01h (PCDOS 7.1, IBMDOS.COM)
 29533                                  
 29534                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:81D6h)
 29535                                  	; (Windows ME IO.SYS - BIOSCODE:84CBh)
 29536                                  
 29537                                  ValidateCDS:
 29538                                  	; 19/05/2019 - Retro DOS v4.0
 29539                                  	; 28/07/2018 - Retro DOS v3.0
 29540                                  
 29541                                     %define  Temp	[bp-2]	; word
 29542                                     %define  SaveCDS	[bp-6]	; dword
 29543                                     %define  SaveCDSL	[bp-6]	; word
 29544                                     %define  SaveCDSH	[bp-4]	; word
 29545                                  
 29546                                  	;Enter
 29547 00004C87 55                      	push	bp
 29548 00004C88 89E5                    	mov	bp,sp
 29549 00004C8A 83EC06                  	sub	sp,6
 29550                                  
 29551 00004C8D 897EFE                  	MOV	Temp,DI
 29552                                  
 29553                                  ;hkn; SS override
 29554 00004C90 36C536[A205]            	LDS	SI,[SS:THISCDS]
 29555 00004C95 8976FA                  	MOV	SaveCDSL,SI
 29556 00004C98 8C5EFC                  	MOV	SaveCDSH,DS
 29557                                  	;EnterCrit critDisk
 29558 00004C9B E8E6CB                  	call	ECritDisk
 29559                                  	; 21/11/2022
 29560                                  	;test	byte [SI+curdir.flags+1],80h
 29561                                  	;test	word [si+67],8000h
 29562                                  	; 17/12/2022
 29563                                  	;test	byte [SI+68],80h
 29564 00004C9E F6444480                	test	byte [SI+curdir.flags+1],(curdir_isnet>>8)
 29565                                  	;TEST	word [SI+curdir.flags],curdir_isnet	; Clears carry
 29566 00004CA2 7403                    	JZ	short _DoSplice
 29567 00004CA4 E9A300                  	JMP	FatFail
 29568                                  _DoSplice:
 29569 00004CA7 30D2                    	XOR	DL,DL
 29570 00004CA9 368616[4C03]            	XCHG	DL,[SS:NoSetDir]
 29571                                  
 29572                                  ;hkn; SS is DOSDATA
 29573                                  	;Context ES
 29574 00004CAE 16                      	push	ss
 29575 00004CAF 07                      	pop	es
 29576                                  	;Invoke	FStrcpy
 29577 00004CB0 E8EACA                  	call	FStrCpy
 29578 00004CB3 8B76FE                  	MOV	SI,Temp
 29579                                  
 29580                                  ;hkn; SS is DOSDATA
 29581                                  	;Context DS
 29582 00004CB6 16                      	push	ss
 29583 00004CB7 1F                      	pop	ds	
 29584                                  	;Invoke	Splice
 29585 00004CB8 E8A82E                  	call	Splice
 29586                                  
 29587                                   ;hkn; SS is DOSDATA
 29588                                  	;Context DS			;   FatReadCDS (ThisCDS);
 29589 00004CBB 16                      	push	ss
 29590 00004CBC 1F                      	pop	ds
 29591 00004CBD 8816[4C03]              	MOV	[NoSetDir],DL
 29592 00004CC1 C43E[A205]              	LES	DI,[THISCDS]
 29593                                  	;SAVE	<BP>
 29594 00004CC5 55                      	push	bp
 29595                                  	;Invoke	FATREAD_CDS
 29596 00004CC6 E83815                  	call	FATREAD_CDS	
 29597                                  	;RESTORE <BP>
 29598 00004CC9 5D                      	pop	bp
 29599 00004CCA 727E                    	JC	short FatFail
 29600                                  
 29601 00004CCC C536[A205]              	LDS	SI,[THISCDS]		;   if (ThisCDS->ID == -1) {
 29602                                  
 29603                                  	;;;
 29604                                  	; 16/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29605                                  	;cmp	word [si+4Bh],0FFFFh
 29606 00004CD0 837C4BFF                	cmp	word [si+curdir.ID+2],-1
 29607 00004CD4 7566                    	jnz	short RestoreCDS
 29608                                  	;;;
 29609                                  	
 29610                                  	;cmp	word [si+73],-1
 29611 00004CD6 837C49FF                	CMP	word [SI+curdir.ID],-1
 29612 00004CDA 7560                    	JNZ	short RestoreCDS
 29613                                  
 29614                                  ;hkn; SS is DOSDATA
 29615                                  	;Context ES
 29616 00004CDC 16                      	push	ss
 29617 00004CDD 07                      	pop	es
 29618                                  
 29619                                  ;hkn; SS override
 29620                                  	;SAVE	<wfp_Start>		;	t = wfp_Start;
 29621 00004CDE 36FF36[B205]            	push	word [SS:WFP_START]
 29622                                  	;cmp	si,[bp-6]
 29623 00004CE3 3B76FA                  	CMP	SI,SaveCDSL		; if not spliced
 29624 00004CE6 750B                    	JNZ	short DoChdir
 29625                                  	;mov	di,[bp-2]
 29626 00004CE8 8B7EFE                  	MOV	DI,Temp
 29627                                  
 29628                                  ;hkn; SS override
 29629 00004CEB 36893E[B205]            	MOV	[SS:WFP_START],DI	;	wfp_start = d;
 29630                                  	;Invoke	FStrCpy 		;	strcpy (d, ThisCDS->Text);
 29631 00004CF0 E8AACA                  	call	FStrCpy
 29632                                  DoChdir:
 29633                                  ;hkn; SS is DOSDATA
 29634                                  	;Context DS
 29635 00004CF3 16                      	push	ss
 29636 00004CF4 1F                      	pop	ds
 29637                                  	;SAVE	<<WORD PTR SAttrib>,BP> ;	c = DOSChDir ();
 29638 00004CF5 FF36[6D05]              	push	word [SATTRIB]
 29639 00004CF9 55                      	push	bp
 29640                                  	;Invoke	DOS_ChDir
 29641 00004CFA E819EC                  	call	DOS_CHDIR
 29642                                  	;RESTORE <BP,BX,wfp_start>	;	wfp_Start = t;
 29643 00004CFD 5D                      	pop	bp
 29644 00004CFE 5B                      	pop	bx
 29645 00004CFF 8F06[B205]              	pop	word [WFP_START]
 29646 00004D03 881E[6D05]              	MOV	[SATTRIB],BL
 29647                                  	;;;
 29648                                  	; 16/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29649 00004D07 8B3E[DC0A]              	mov	di,[DIRSTART_HW]
 29650                                  	;;;
 29651 00004D0B C576FA                  	LDS	SI,SaveCDS
 29652 00004D0E 7311                    	JNC	short SetCluster	;	if (c == -1) {
 29653                                  
 29654                                  ;hkn; SS override for THISCDS
 29655 00004D10 368936[A205]            	MOV	[SS:THISCDS],SI		;	    ThisCDS = TmpCDS;
 29656 00004D15 368C1E[A405]            	MOV	[SS:THISCDS+2],DS
 29657 00004D1A 31C9                    	XOR	CX,CX			;	    TmpCDS->text[3] = c = 0;
 29658                                  	;;;
 29659                                  	; 16/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29660 00004D1C 31FF                    	xor	di,di
 29661                                  	;;;
 29662 00004D1E 884C03                  	MOV	[SI+3],CL		;	    }
 29663                                  SetCluster:
 29664                                  	; 16/02/2024
 29665                                  	;;mov	word [si+73],0FFFFh
 29666                                  	;MOV	word [SI+curdir.ID],-1	;	TmpCDS->ID = -1;
 29667                                  	;
 29668 00004D21 36C536[A205]            	LDS	SI,[SS:THISCDS]		;	ThisCDS->ID = c;
 29669                                  	; 21/11/2022
 29670                                  	;test	byte [si+curdir.flags+1],20h
 29671                                  	; 19/05/2019
 29672                                  	; MSDOS 6.0
 29673                                  	; 17/12/2022
 29674                                  	;test	byte [si+68],20h
 29675 00004D26 F6444420                	test	byte [SI+curdir.flags+1],(curdir_splice>>8)	
 29676                                  	;;test	word [si+67],2000h
 29677                                  	;TEST	word [SI+curdir.flags],curdir_splice ;AN000;;MS. for Join and Subst
 29678 00004D2A 7405                    	JZ	short _setdirclus		     ;AN000;;MS.
 29679 00004D2C B9FFFF                  	MOV	CX,-1	; 0FFFFh		     ;AN000;;MS.
 29680                                  	;;;
 29681                                  	; 16/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29682 00004D2F 89CF                    	mov	di,cx
 29683                                  	;;;
 29684                                  _setdirclus:
 29685                                  	;;;
 29686                                  	; 16/02/2024 (PCDOS 7.1 IBMDOS.COM)
 29687 00004D31 36893E[DC0A]            	mov	[ss:DIRSTART_HW],di
 29688                                  	;mov	[si+4Bh],di
 29689 00004D36 897C4B                  	mov	[si+curdir.ID+2],di
 29690                                  	;;;
 29691                                  	;mov	[si+73],cx
 29692 00004D39 894C49                  	MOV	[SI+curdir.ID],CX	;	}
 29693                                  RestoreCDS:
 29694 00004D3C C47EFA                  	LES	DI,SaveCDS
 29695 00004D3F 36893E[A205]            	MOV	[SS:THISCDS],DI
 29696 00004D44 368C06[A405]            	MOV	[SS:THISCDS+2],ES
 29697 00004D49 F8                      	CLC
 29698                                  FatFail:
 29699                                  	;LeaveCrit critDisk
 29700 00004D4A E864CB                  	call	LCritDisk
 29701                                  
 29702                                  	;les	di,[bp-6]
 29703 00004D4D C47EFA                  	LES	DI,SaveCDS
 29704                                  	;Leave
 29705 00004D50 89EC                    	mov	sp,bp
 29706 00004D52 5D                      	pop	bp
 29707 00004D53 C3                      	retn
 29708                                  
 29709                                  ; 28/07/2018 - Retro DOS v3.0
 29710                                  ; IBMDOS.COM (MSDOS 3.3, 1987) - offset 43BDh
 29711                                  
 29712                                  ;Break	<CheckThisDevice - Check for being a device>
 29713                                  ;---------------------------------------------------------------------------
 29714                                  ;
 29715                                  ;   CheckThisDevice - Examine the area at DS:SI to see if there is a valid
 29716                                  ;   device specified. We will return carry if there is a device present. 
 29717                                  ;   The forms of devices we will recognize are:
 29718                                  ;
 29719                                  ;	[path]device
 29720                                  ;
 29721                                  ;   Note that the drive letter has *already* been removed. All other forms
 29722                                  ;   are not considered to be devices. If such a device is found we change
 29723                                  ;   the source pointer to point to the device component.
 29724                                  ;
 29725                                  ;   Inputs:	ES is DOSDATA
 29726                                  ;		DS:SI contains name
 29727                                  ;   Outputs:	ES is DOSDATA
 29728                                  ;		DS:SI point to name or device
 29729                                  ;		Carry flag set if device was found
 29730                                  ;		Carry flag reset otherwise
 29731                                  ;   Registers Modified: all except ES:DI, DS
 29732                                  ;----------------------------------------------------------------------------
 29733                                  
 29734                                  CheckThisDevice:
 29735 00004D54 57                      	push	di
 29736 00004D55 56                      	push	si
 29737 00004D56 89F7                    	MOV	DI,SI
 29738                                  
 29739                                  ; Check for presence of \dev\ (Dam multiplan!)
 29740                                  
 29741 00004D58 8A04                    	MOV	AL,[SI]
 29742 00004D5A E8330D                  	call	PATHCHRCMP		; is it a path char?
 29743 00004D5D 7517                    	JNZ	short ParseDev		; no, go attempt to parse device
 29744 00004D5F 46                      	INC	SI			; simulate LODSB
 29745                                  
 29746                                  ; We have the leading path separator. Look for DEV part.
 29747                                  
 29748 00004D60 AD                      	LODSW
 29749 00004D61 0D2020                  	OR	AX,2020h
 29750 00004D64 3D6465                  	cmp	ax,"de"
 29751                                  	;CMP	AX,"e"<< 8 + "d"
 29752 00004D67 752D                    	JNZ	short NotDevice		; not "de", assume not device
 29753 00004D69 AC                      	LODSB
 29754 00004D6A 0C20                    	OR	AL,20h
 29755 00004D6C 3C76                    	CMP	AL,"v"                  ; Not "v", assume not device
 29756 00004D6E 7526                    	JNZ	short NotDevice
 29757 00004D70 AC                      	LODSB
 29758 00004D71 E81C0D                  	call	PATHCHRCMP		; do we have the last path separator?
 29759 00004D74 7520                    	JNZ	short NotDevice		; no. go for it.
 29760                                  
 29761                                  ; DS:SI now points to a potential drive. Preserve them as NameTrans advances
 29762                                  ; SI and DevName may destroy DS.
 29763                                  
 29764                                  ParseDev:
 29765 00004D76 1E                      	push	ds
 29766 00004D77 56                      	push	si			; preserve the source pointer
 29767 00004D78 E8590C                  	call	NameTrans		; advance DS:SI
 29768 00004D7B 803C00                  	CMP	BYTE [SI],0		; parse entire string?
 29769 00004D7E F9                      	STC				; simulate a Carry return from DevName
 29770 00004D7F 750B                    	JNZ	short SkipSearch	; no parse. simulate a file return.
 29771                                  
 29772                                  ;hkn; SS is DOSDATA
 29773 00004D81 16                      	push	ss
 29774 00004D82 1F                      	pop	ds
 29775                                  
 29776                                  ; M026 - start - fix ported from ROMDOS2 for bug # 2849
 29777                                  ;
 29778                                  ; SR;
 29779                                  ; We have to set Attrib before invoking DevName. Otherwise, the value from
 29780                                  ; a previous DOS call is used and DevName thinks it is not a device if the
 29781                                  ; old call set the volume attribute bit.
 29782                                  
 29783 00004D83 A0[6D05]                	mov	al,[SATTRIB]
 29784 00004D86 A2[6B05]                	mov	[ATTRIB],al		;set Attrib for DevName
 29785                                  
 29786                                  ; M026 - end
 29787                                  
 29788 00004D89 E86FFE                  	call	DEVNAME
 29789                                  
 29790                                  SkipSearch:
 29791 00004D8C 5E                      	pop	si
 29792 00004D8D 1F                      	pop	ds
 29793                                  
 29794                                  ; SI points to the beginning of the potential device. If we have a device
 29795                                  ; then we do not change SI. If we have a file, then we reset SI back to the
 29796                                  ; original value. At this point Carry set indicates FILE.
 29797                                  
 29798                                  CheckReturn:
 29799 00004D8E 5F                      	pop	di			; get original SI
 29800 00004D8F 7302                    	JNC	short Check_Done	; if device then do not reset pointer
 29801 00004D91 89FE                    	MOV	SI,DI
 29802                                  Check_Done:
 29803 00004D93 5F                      	pop	di
 29804 00004D94 F5                      	CMC				; invert carry. Carry => device
 29805 00004D95 C3                      	retn
 29806                                  NotDevice:
 29807 00004D96 F9                      	STC
 29808 00004D97 EBF5                    	JMP	short CheckReturn
 29809                                  
 29810                                  ;============================================================================
 29811                                  ; DEV.ASM (MSDOS 6.0, 1991)
 29812                                  ;============================================================================
 29813                                  ; 17/07/2018 - Retro DOS v3.0
 29814                                  ; 30/04/2019 - Retro DOS v4.0
 29815                                  ; 21/02/2024 - Retro DOS v5.0
 29816                                  
 29817                                  ;**	Misc Routines to do 1-12 low level I/O and call devices
 29818                                  
 29819                                  ; Offset 12B8h of IBMDOS.COM (MSDOS 3.3), 1987
 29820                                  
 29821                                  ;DOSCODE:8401h (MSDOS 6.21 & 6.22, MSDOS.SYS) ; 21/02/2024
 29822                                  ;BIOSCODE:8608h (Windows ME, IO.SYS) ; 21/02/2024
 29823                                  
 29824                                  ;DOSCODE:9163h (PCDOS 7.1, IBMDOS.COM) ; 21/02/2024
 29825                                  
 29826                                  ;Public DEV001S, DEV001E 		; Pathgen labels
 29827                                  ;DEV001s:
 29828                                  ;		length of packets
 29829 00004D99 160E160D0D0E            LenTab:	 DB	DRDWRHL, DRDNDHL, DRDWRHL, DSTATHL, DFLSHL, DRDNDHL
 29830                                  ; 21/02/2024
 29831                                  ;;LenTab: db	22,14,22,13,15,14 ; MSDOS 5.0-6.22 & Windows ME
 29832                                  ;LenTab: db	22,14,22,13,13,14 ; PCDOS 7.1
 29833                                  
 29834                                  ;	Error Function
 29835                                  
 29836                                  CmdTab:
 29837 00004D9F 8604                    	DB	86h, DEVRD	; 0 input
 29838 00004DA1 8605                    	DB	86h, DEVRDND	; 1 input status
 29839 00004DA3 8708                    	DB	87h, DEVWRT	; 2 output
 29840 00004DA5 870A                    	DB	87h, DEVOST	; 3 output status
 29841 00004DA7 8607                    	DB	86h, DEVIFL	; 4 input flush
 29842 00004DA9 8605                    	DB	86h, DEVRDND	; 5 input status with system WAIT
 29843                                  
 29844                                  ; Offset 12BEh of IBMDOS.COM (MSDOS 3.3), 1987
 29845                                  
 29846                                  ;CmdTab:
 29847                                  ;	db	86h, 4
 29848                                  ;	db	86h, 5
 29849                                  ;	db	87h, 8
 29850                                  ;	db	87h, 10
 29851                                  ;	db	86h, 7
 29852                                  ;	db	86h, 5
 29853                                  
 29854                                  ;DEV001E:
 29855                                  
 29856                                  ; 30/04/2019 - Retro DOS v4.0
 29857                                  ; DOSCODE:8413h (MSDOS 6.21, MSDOS.SYS)
 29858                                  
 29859                                  ;Break	<IOFUNC -- DO FUNCTION 1-12 I/O>
 29860                                  ;----------------------------------------------------------------------------
 29861                                  ;
 29862                                  ; Procedure Name : IOFUNC
 29863                                  ;
 29864                                  ; Inputs:
 29865                                  ;	DS:SI Points to SFT
 29866                                  ;	AH is function code
 29867                                  ;		= 0 Input
 29868                                  ;		= 1 Input Status
 29869                                  ;		= 2 Output
 29870                                  ;		= 3 Output Status
 29871                                  ;		= 4 Flush
 29872                                  ;		= 5 Input Status - System WAIT invoked for K09 if no char
 29873                                  ;				   present.
 29874                                  ;	AL = character if output
 29875                                  ; Function:
 29876                                  ;	Perform indicated I/O to device or file
 29877                                  ; Outputs:
 29878                                  ;	AL is character if input
 29879                                  ;	If a status call
 29880                                  ;		zero set if not ready
 29881                                  ;		zero reset if ready (character in AL for input status)
 29882                                  ; For regular files:
 29883                                  ;	Input Status
 29884                                  ;		Gets character but restores position
 29885                                  ;		Zero set on EOF
 29886                                  ;	Input
 29887                                  ;		Gets character advances position
 29888                                  ;		Returns ^Z on EOF
 29889                                  ;	Output Status
 29890                                  ;		Always ready
 29891                                  ; AX altered, all other registers preserved
 29892                                  ;----------------------------------------------------------------------------
 29893                                  
 29894                                  ; 21/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 29895                                  ; DOSCODE:83D8h (MSDOS 5.0, MSDOS.SYS)
 29896                                  
 29897                                  ; 21/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 29898                                  ; DOSCODE:9175h (PCDOS 7.1, IBMDOS.COM)
 29899                                  
 29900                                  ; DOSCODE:8413h (MSDOS 6.22, MSDOS.SYS)
 29901                                  ; BIOSCODE:861Ah (Windows ME, IO.SYS)
 29902                                  
 29903                                  IOFUNC:
 29904 00004DAB 368C16[8C03]            	MOV	[SS:IOXAD+2],SS		; SS override for IOXAD, IOSCNT, 
 29905                                  					; DEVIOBUF
 29906 00004DB0 36C706[8A03][BC03]      	MOV	WORD [SS:IOXAD],DEVIOBUF
 29907 00004DB7 36C706[8E03]0100        	MOV	WORD [SS:IOSCNT],1
 29908 00004DBE 36A3[BC03]              	MOV	WORD [SS:DEVIOBUF],AX
 29909                                  	;test	byte [si+6],80h
 29910                                  	;TEST	word [SI+SF_ENTRY.sf_flags],sf_isnet ; 8000h
 29911 00004DC2 F6440680                	test	byte [SI+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 29912 00004DC6 7403                    	JZ	short IOTO22		;AN000;
 29913 00004DC8 E9A300                  	JMP	IOTOFILE		;AN000;
 29914                                  IOTO22:
 29915                                  	;test	word [si+5],80h
 29916                                  	;TEST	word [SI+SF_ENTRY.sf_flags],devid_device 
 29917 00004DCB F6440580                	test	byte [SI+SF_ENTRY.sf_flags],devid_device	
 29918 00004DCF 7503                    	JNZ	short IOTO33		;AN000;
 29919 00004DD1 E99A00                  	JMP	IOTOFILE		;AN000;
 29920                                  IOTO33:
 29921 00004DD4 06                      	push	es ; * (MSDOS 6.21)
 29922 00004DD5 E880B6                  	call	save_world
 29923 00004DD8 8CDA                    	MOV	DX,DS
 29924 00004DDA 8CD3                    	MOV	BX,SS
 29925 00004DDC 8EDB                    	MOV	DS,BX
 29926 00004DDE 8EC3                    	MOV	ES,BX
 29927 00004DE0 31DB                    	XOR	BX,BX
 29928 00004DE2 80FC05                  	cmp	ah,5		    ; system wait enabled?
 29929 00004DE5 7502                    	jnz	short _no_sys_wait
 29930                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 29931                                  	; 16/12/2022
 29932                                  	;or	bh,04h
 29933                                  	;;or	bx,0400H	    ; Set bit 10 in status word for driver
 29934                                  				    ; It is up to device driver to carry out
 29935                                  				    ; appropriate action.
 29936                                  	; 04/07/2024
 29937 00004DE7 B704                    	mov	bh,4
 29938                                  _no_sys_wait:
 29939 00004DE9 891E[7F03]              	MOV	[IOCALL_REQSTAT],BX
 29940 00004DED 31DB                    	XOR	BX,BX
 29941 00004DEF 881E[8903]              	MOV	[IOMED],BL
 29942                                  
 29943 00004DF3 88E3                    	MOV	BL,AH		 	; get function
 29944 00004DF5 2E8AA7[994D]            	MOV	AH,[cs:BX+LenTab]
 29945 00004DFA D1E3                    	SHL	BX,1
 29946 00004DFC 2E8B8F[9F4D]            	MOV	CX,[cs:BX+CmdTab]
 29947 00004E01 BB[7C03]                	MOV	BX,IOCALL ; DOSDATA:037Ch
 29948 00004E04 8826[7C03]              	MOV	[IOCALL_REQLEN],AH
 29949 00004E08 882E[7E03]              	MOV	[IOCALL_REQFUNC],CH
 29950                                  
 29951 00004E0C 8EDA                    	MOV	DS,DX
 29952 00004E0E E86401                  	CALL	DEVIOCALL
 29953 00004E11 368B3E[7F03]            	MOV	DI,[SS:IOCALL_REQSTAT]	; SS override
 29954 00004E16 21FF                    	and	di,di
 29955 00004E18 7833                    	js	short DevErr
 29956                                  OKDevIO:
 29957 00004E1A 8CD0                    	MOV	AX,SS
 29958 00004E1C 8ED8                    	MOV	DS,AX
 29959                                  
 29960                                  	;cmp	ch,5
 29961 00004E1E 80FD05                  	CMP	CH,DEVRDND
 29962 00004E21 7506                    	JNZ	short DNODRD
 29963 00004E23 A0[8903]                	MOV	AL,[IORCHR]
 29964 00004E26 A2[BC03]                	MOV	[DEVIOBUF],AL
 29965                                  
 29966                                  DNODRD: 
 29967 00004E29 8A26[8003]              	MOV	AH,[IOCALL_REQSTAT+1]
 29968 00004E2D F6D4                    	NOT	AH			; Zero = busy, not zero = ready
 29969                                  	;and	ah,2
 29970 00004E2F 80E402                  	AND	AH,STBUI>>8
 29971                                  
 29972                                  QuickReturn:				;AN000; 2/13/KK
 29973 00004E32 E80CB6                  	call	restore_world
 29974 00004E35 07                      	pop	es ; * (MSDOS 6.21)
 29975                                  
 29976                                  	; SR;
 29977                                  	; We return ax = -1 if the user failed on I24. This is the case if 
 29978                                  	; IoStatFail = -1 (set after return from the I24)
 29979                                  
 29980                                  	; MSDOS 6.0
 29981 00004E36 9C                      	pushf
 29982 00004E37 36A0[8300]              	mov	al,[ss:IoStatFail]	;assume fail error
 29983 00004E3B 98                      	cbw				;sign extend to word
 29984                                  
 29985                                  ; 21/02/2024
 29986                                  %if 0
 29987                                  	; PCDOS 7.1 IBMDOS.COM
 29988                                  	; cbw
 29989                                  	inc	ax		; 21/02/2024 - Erdogan Tan
 29990                                  				; this may be a BUG
 29991                                  				; MSDOS 6.22 MSDOS.SYS & Win ME IO.SYS code is
 29992                                  				;  cbw
 29993                                  				;  cmp  ax,-1
 29994                                  				;  jne  short not_fail_ret
 29995                                  				;  inc  byte [ss:IoStatFail]
 29996                                  				;  popf
 29997                                  				;  retn
 29998                                  	jnz	short not_fail_ret
 29999                                  	dec	ax	
 30000                                  	jnz	short not_fail_ret ; jns ?
 30001                                  %else
 30002                                  	;;cbw
 30003                                  	;cmp	ax,-1		; (MSDOS 6.22 & Windows ME)
 30004                                  	;jne	short not_fail_ret
 30005                                  	; 27/06/2024
 30006 00004E3C 3CFF                    	cmp	al,0FFh ; -1
 30007 00004E3E 7507                    	jne	short not_fail_ret 
 30008                                  %endif
 30009                                  
 30010 00004E40 36FE06[8300]            	inc	byte [ss:IoStatFail]
 30011 00004E45 9D                      	popf
 30012 00004E46 C3                      	retn
 30013                                  
 30014                                  not_fail_ret:
 30015 00004E47 36A1[BC03]              	mov	ax,[ss:DEVIOBUF]	;ss override
 30016 00004E4B 9D                      	popf
 30017 00004E4C C3                      	retn
 30018                                  
 30019                                  DevErr:
 30020 00004E4D 88CC                    	MOV	AH,CL
 30021 00004E4F E8770E                  	call	CHARHARD
 30022 00004E52 3C01                    	CMP	AL,1
 30023 00004E54 7507                    	JNZ	short NO_RETRY
 30024 00004E56 E8E8B5                  	call	restore_world
 30025                                  	; 12/05/2019
 30026 00004E59 07                      	pop	es ; * (MSDOS 6.21)		
 30027 00004E5A E94EFF                  	JMP	IOFUNC	; 10/08/2018
 30028                                  
 30029                                  NO_RETRY:
 30030                                  	; Know user must have wanted Ignore OR Fail. Make sure device shows ready
 30031                                  	; ready so that DOS doesn't get caught in a status loop when user 
 30032                                  	; simply wants to ignore the error.
 30033                                  	;
 30034                                  	; SR; If fail wanted by user set ax to special value (ax = -1). This 
 30035                                  	; should be checked by the caller on return
 30036                                  
 30037                                  					; SS override
 30038 00004E5D 368026[8003]FD          	and	byte [SS:IOCALL_REQSTAT+1],0FDh
 30039                                  	;AND	BYTE [SS:IOCALL_REQSTAT+1],~(STBUI>>8)
 30040                                  
 30041                                  	; SR;
 30042                                  	; Check if user failed
 30043                                  
 30044                                  	; MSDOS 6.0
 30045 00004E63 3C03                    	cmp	al,3
 30046 00004E65 7505                    	jnz	short not_fail
 30047 00004E67 36FE0E[8300]            	dec	byte [ss:IoStatFail]	;set flag indicating fail on I24
 30048                                  not_fail:
 30049 00004E6C EBAC                    	JMP	short OKDevIO
 30050                                  
 30051                                  IOTOFILE:
 30052 00004E6E 08E4                    	OR	AH,AH
 30053 00004E70 7421                    	JZ	short IOIN
 30054 00004E72 FECC                    	DEC	AH
 30055 00004E74 7405                    	JZ	short IOIST
 30056 00004E76 FECC                    	DEC	AH
 30057 00004E78 7411                    	JZ	short IOUT
 30058                                  IOUT_retn:	; 18/12/2022
 30059 00004E7A C3                      	retn				; NON ZERO FLAG FOR OUTPUT STATUS
 30060                                  IOIST:
 30061                                  	;push	word [si+15h]
 30062 00004E7B FF7415                  	PUSH	WORD [SI+SF_ENTRY.sf_position]   ; Save position
 30063                                  	;push	word [si+17h]
 30064 00004E7E FF7417                  	PUSH	WORD [SI+SF_ENTRY.sf_position+2]
 30065 00004E81 E80F00                  	CALL	IOIN
 30066                                  	;pop	word [si+17h]
 30067 00004E84 8F4417                  	POP	WORD [SI+SF_ENTRY.sf_position+2] ; Restore position
 30068                                  	;pop	word [si+15h]
 30069 00004E87 8F4415                  	POP	WORD [SI+SF_ENTRY.sf_position]
 30070 00004E8A C3                      	retn
 30071                                  IOUT:
 30072 00004E8B E82500                  	CALL	SETXADDR
 30073 00004E8E E8B8ED                  	call	DOS_WRITE
 30074                                  	;CALL	RESTXADDR	; If you change this into a jmp don't
 30075                                  	; 18/12/2022
 30076 00004E91 EB4F                    	jmp	RESTXADDR
 30077                                  ;IOUT_retn:
 30078                                  	;retn			; come crying to me when things don't
 30079                                  				; work ARR
 30080                                  IOIN:
 30081 00004E93 E81D00                  	CALL	SETXADDR
 30082                                  					; SS override for DOS34_FLAG
 30083                                  	;OR	word [SS:DOS34_FLAG],Disable_EOF_I24	;AN000;
 30084                                  	;or	word [ss:DOS34_FLAG],40h
 30085                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 30086                                  	; 16/12/2022
 30087 00004E96 36800E[1106]40          	or	byte [ss:DOS34_FLAG],40h 
 30088 00004E9C E8A9EB                  	CALL	DOS_READ
 30089                                  	;AND	word [SS:DOS34_FLAG],NO_Disable_EOF_I24 ;AN000;
 30090                                  	;and	word [SS:DOS34_FLAG],0FFBFh
 30091                                  	; 21/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 30092                                  	; 16/12/2022
 30093 00004E9F 368026[1106]BF          	and	byte [SS:DOS34_FLAG],0BFh ; 07/12/2022
 30094 00004EA5 09C9                    	OR	CX,CX			; Check EOF
 30095 00004EA7 E83800                  	CALL	RESTXADDR
 30096                                  					; SS override
 30097 00004EAA 36A0[BC03]              	MOV	AL,[SS:DEVIOBUF]	; Get byte from trans addr
 30098 00004EAE 75CA                    	jnz	short IOUT_retn	
 30099 00004EB0 B01A                    	MOV	AL,1AH			; ^Z if no bytes
 30100 00004EB2 C3                      	retn
 30101                                  
 30102                                  SETXADDR:
 30103                                  					; SS override
 30104 00004EB3 368F06[6C03]            	POP	WORD [SS:CALLSCNT]	; Return address
 30105                                  
 30106 00004EB8 06                      	push	es ; * (MSDOS 6.21)
 30107                                  
 30108 00004EB9 E89CB5                  	call	save_world
 30109                                  					; SS override for DMAADD and THISSFT
 30110                                  	; 24/09/2023
 30111                                  	;PUSH	WORD [SS:DMAADD]	; Save Disk trans addr
 30112                                  	;PUSH	WORD [SS:DMAADD+2]
 30113 00004EBC 368C1E[A005]            	MOV	[SS:THISSFT+2],DS
 30114                                  
 30115                                  ; 22/02/2024
 30116                                  %if 0
 30117                                  	push	ss
 30118                                  	pop	ds
 30119                                  
 30120                                  	; 24/09/2023
 30121                                  	push	word [DMAADD]
 30122                                  	push	word [DMAADD+2]
 30123                                  
 30124                                  	MOV	[THISSFT],SI		; Finish setting SFT pointer
 30125                                  	MOV	CX,[IOXAD+2]
 30126                                  	MOV	[DMAADD+2],CX
 30127                                  	MOV	CX,[IOXAD]
 30128                                  	MOV	[DMAADD],CX		; Set byte trans addr
 30129                                  %else
 30130                                  	; 22/02/2024
 30131                                  	; PCDOS 7.1 IBMDOS.COM
 30132                                  	
 30133 00004EC1 36C50E[2C03]            	lds	cx,[ss:DMAADD]		; Save Disk transfer address
 30134 00004EC6 51                      	push	cx
 30135 00004EC7 1E                      	push	ds
 30136 00004EC8 36C50E[8A03]            	lds	cx,[ss:IOXAD]		; Set byte trans address
 30137 00004ECD 368C1E[2E03]            	mov	[ss:DMAADD+2],ds
 30138 00004ED2 16                      	push	ss
 30139 00004ED3 1F                      	pop	ds
 30140 00004ED4 890E[2C03]              	mov	[DMAADD],cx
 30141 00004ED8 8936[9E05]              	mov	[THISSFT],si
 30142                                  %endif
 30143 00004EDC 8B0E[8E03]              	MOV	CX,[IOSCNT]		; ioscnt specifies length of buffer
 30144 00004EE0 EB10                    	JMP	SHORT RESTRET		; RETURN ADDRESS
 30145                                  
 30146                                  RESTXADDR:
 30147 00004EE2 8F06[6C03]              	POP	WORD [CALLSCNT]		; Return address
 30148 00004EE6 8F06[2E03]              	POP	WORD [DMAADD+2]		; Restore Disk trans addr
 30149 00004EEA 8F06[2C03]              	POP	WORD [DMAADD]
 30150                                  
 30151 00004EEE E850B5                  	call	restore_world
 30152                                  
 30153 00004EF1 07                      	pop	es ; * (MSDOS 6.21)
 30154                                  					; SS override
 30155                                  RESTRET:
 30156 00004EF2 36FF26[6C03]            	JMP	WORD [SS:CALLSCNT]	; Return address
 30157                                  
 30158                                  ; DOSCODE:8569h (MSDOS 6.21, MSDOS.SYS)
 30159                                  ; 21/11/2022
 30160                                  ; DOSCODE:852Eh (MSDOS 5.0, MSDOS.SYS)
 30161                                  
 30162                                  ; 22/02/2024 - Retro DOS v5.0
 30163                                  ; DOSCODE:92CAh (PCDOS 7.1, IBMDOS.COM)
 30164                                  
 30165                                  ;Break <DEV_OPEN_SFT, DEV_CLOSE_SFT - OPEN or CLOSE A DEVICE>
 30166                                  
 30167                                  ;----------------------------------------------------------------------------
 30168                                  ;**	Dev_Open_SFT - Open the Device for an SFT
 30169                                  ;
 30170                                  ;	Dev_Open_SFT issues an open call to the device associated with
 30171                                  ;	the SFT.
 30172                                  ;
 30173                                  ;	ENTRY	(ES:DI) = SFT
 30174                                  ;	EXIT	none
 30175                                  ;	USES	all
 30176                                  ;----------------------------------------------------------------------------
 30177                                  
 30178                                  DEV_OPEN_SFT:
 30179 00004EF7 06                      	push	es ; * (MSDOS 6.21)
 30180 00004EF8 E85DB5                  	call	save_world
 30181                                  	;mov	al,0Dh	
 30182 00004EFB B00D                    	MOV	AL,DEVOPN
 30183 00004EFD EB06                    	JMP	SHORT DO_OPCLS
 30184                                  
 30185                                  ;----------------------------------------------------------------------------
 30186                                  ; Procedure Name : DEV_CLOSE_SFT
 30187                                  ;
 30188                                  ; Inputs:
 30189                                  ;	ES:DI Points to SFT
 30190                                  ; Function:
 30191                                  ;	Issue a CLOSE call to the correct device
 30192                                  ; Outputs:
 30193                                  ;	None
 30194                                  ; ALL preserved
 30195                                  ;----------------------------------------------------------------------------
 30196                                  
 30197                                  DEV_CLOSE_SFT:
 30198 00004EFF 06                      	push	es ; * (MSDOS 6.21)
 30199 00004F00 E855B5                  	call	save_world
 30200                                  	;mov	al,0Eh	
 30201 00004F03 B00E                    	MOV	AL,DEVCLS
 30202                                  
 30203                                  	; Main entry for device open and close. AL contains the function 
 30204                                  	; requested. Subtlety: if Sharing is NOT loaded then we do NOT issue 
 30205                                  	; open/close to block devices. This allows networks to function but 
 30206                                  	; does NOT hang up with bogus change-line code.
 30207                                  
 30208                                  	;entry	DO_OPCLS
 30209                                  DO_OPCLS:
 30210                                  	; Is the SFT for the net? If so, no action necessary.
 30211                                  
 30212                                  	; MSDOS 6.0
 30213                                  	;test	word [es:di+5],8000h
 30214                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 30215 00004F05 26F6450680              	test	byte [es:di+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 30216 00004F0A 7564                    	jnz	short OPCLS_DONE	; NOP on net SFTs
 30217 00004F0C 30E4                    	XOR	AH,AH			; Unit
 30218                                  	;test	byte [es:di+5],80h
 30219 00004F0E 26F6450580              	TEST	byte [ES:DI+SF_ENTRY.sf_flags],devid_device
 30220                                  	;les	di,[es:di+7]
 30221 00004F13 26C47D07                	LES	DI,[ES:DI+SF_ENTRY.sf_devptr] ; Get DPB or device
 30222 00004F17 7511                    	JNZ	short GOT_DEV_ADDR
 30223                                  
 30224                                  	; We are about to call device open/close on a block driver. If no 
 30225                                  	; sharing then just short circuit to done.
 30226                                  	
 30227                                  	; MSDOS 6.0
 30228                                  					; SS override
 30229 00004F19 36803E[0303]01          	CMP	byte [ss:fShare],1	;AN010; /NC or no SHARE
 30230 00004F1F 764F                    	JBE	short OPCLS_DONE	;AN010; yes
 30231                                  
 30232                                  ; 22/02/2024
 30233                                  %if 0
 30234                                  	; MSDOS 3.3 (& MSDOS 6.0)
 30235                                  	;mov	ah,[es:di+1]
 30236                                  	MOV	AH,[ES:DI+DPB.UNIT]	; (ah) = unit
 30237                                  	mov	cl,[es:di]
 30238                                  	;MOV	CL,[ES:DI+DPB.DRIVE]	; (cl) = drive
 30239                                  %else
 30240                                  	; 22/02/2024 - Retro DOS v5.0
 30241                                  	;mov	cx,[es:di+DPB.DRIVE]
 30242 00004F21 268B0D                  	mov	cx,[es:di]
 30243 00004F24 88EC                    	mov	ah,ch			; AH = unit
 30244                                  					; CL = drive
 30245                                  %endif
 30246                                  	;;les	di,[es:di+12h] ; MSDOS 3.3
 30247                                  	;les	di,[es:di+13h] ; MSDOS 6.0
 30248 00004F26 26C47D13                	LES	DI,[ES:DI+DPB.DRIVER_ADDR] ; Get device
 30249                                  GOT_DEV_ADDR:				; ES:DI -> device
 30250                                  	;test	word [es:di+4],800h
 30251                                  	;TEST	word [ES:DI+SYSDEV.ATT],DEVOPCL
 30252 00004F2A 26F6450508              	test	byte [ES:DI+SYSDEV.ATT+1],(DEVOPCL>>8)
 30253 00004F2F 743F                    	JZ	short OPCLS_DONE	; Device can't
 30254 00004F31 06                      	PUSH	ES
 30255 00004F32 1F                      	POP	DS
 30256 00004F33 89FE                    	MOV	SI,DI			; DS:SI -> device
 30257                                  
 30258                                  OPCLS_RETRY:
 30259                                  	;Context ES
 30260 00004F35 16                      	push	ss
 30261 00004F36 07                      	pop	es
 30262                                  					; DEVCALL is in DOSDATA
 30263 00004F37 BF[5A03]                	MOV	DI,DEVCALL
 30264                                  
 30265 00004F3A 89FB                    	MOV	BX,DI
 30266 00004F3C 50                      	PUSH	AX
 30267                                  	;mov	al,13
 30268 00004F3D B00D                    	MOV	AL,DOPCLHL
 30269 00004F3F AA                      	STOSB				; Length
 30270 00004F40 58                      	POP	AX
 30271                                  
 30272 00004F41 86C4                    	XCHG	AH,AL
 30273                                  	;STOSB				; Unit
 30274                                  	; 22/02/2024 (PCDOS 7.1 IBMDOS.COM)
 30275 00004F43 AB                      	stosw				; Unit, Command
 30276 00004F44 86C4                    	XCHG	AH,AL
 30277                                  	;STOSB				; Command
 30278                                  
 30279 00004F46 26C7050000              	MOV	WORD [ES:DI],0		; Status
 30280 00004F4B 50                      	PUSH	AX			; Save Unit,Command
 30281                                  	;invoke	DEVIOCALL2
 30282 00004F4C E82900                  	call	DEVIOCALL2
 30283                                  
 30284                                  	;mov	di,[es:bx+3]
 30285 00004F4F 268B7F03                	MOV	DI,[ES:BX+SRHEAD.REQSTAT]
 30286                                  	;test	di,8000h
 30287                                  	;jz	short OPCLS_DONEP
 30288 00004F53 21FF                    	and	di,di
 30289 00004F55 7918                    	jns	short OPCLS_DONEP	; No error
 30290                                  	; 21/11/2022
 30291                                  	;test	word [si+4],8000h
 30292                                  	;TEST	word [SI+SYSDEV.ATT],DEVTYP
 30293                                  	;test	word [si+5],80h
 30294 00004F57 F6440580                	test	byte [SI+SYSDEV.ATT+1],(DEVTYP>>8)
 30295 00004F5B 7404                    	JZ	short BLKDEV
 30296 00004F5D B486                    	MOV	AH,86H			; Read error in data, Char dev
 30297 00004F5F EB04                    	JMP	SHORT HRDERR
 30298                                  BLKDEV:
 30299 00004F61 88C8                    	MOV	AL,CL			; Drive # in AL
 30300 00004F63 B406                    	MOV	AH,6			; Read error in data, Blk dev
 30301                                  HRDERR:
 30302                                  	;invoke	CHARHARD
 30303 00004F65 E8610D                  	call	CHARHARD
 30304 00004F68 3C01                    	cmp	al,1
 30305 00004F6A 7503                    	jne	short OPCLS_DONEP	; IGNORE or FAIL
 30306                                  					;  Note that FAIL is essentually IGNORED
 30307 00004F6C 58                      	POP	AX			; Get back Unit, Command
 30308 00004F6D EBC6                    	JMP	short OPCLS_RETRY
 30309                                  OPCLS_DONEP:
 30310 00004F6F 58                      	POP	AX			; Clean stack
 30311                                  OPCLS_DONE:
 30312 00004F70 E8CEB4                  	call	restore_world
 30313 00004F73 07                      	pop	es ; * (MSDOS 6.21)
 30314 00004F74 C3                      	retn
 30315                                  
 30316                                  ; 30/04/2019 - Retro DOS v4.0
 30317                                  ; DOSCODE:85EAh (MSDOS 6.21, MSDOS.SYS)
 30318                                  
 30319                                  ; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 30320                                  ; DOSCODE:85AFh (MSDOS 5.0, MSDOS.SYS)
 30321                                  
 30322                                  ; 22/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 30323                                  ; DOSCODE:9348h (PCDOS 7.1, IBMDOS.COM)
 30324                                  
 30325                                  ;Break	<DEVIOCALL, DEVIOCALL2 - CALL A DEVICE>
 30326                                  ;----------------------------------------------------------------------------
 30327                                  ;**	DevIoCall  - Call Device
 30328                                  ;
 30329                                  ;	ENTRY	DS:SI Points to device SFT
 30330                                  ;		ES:BX Points to request data
 30331                                  ;	EXIT	DS:SI -> Device driver
 30332                                  ;	USES	DS:SI,AX
 30333                                  ;----------------------------------------------------------------------------
 30334                                  ;**	DevIoCall2 - Call Device
 30335                                  ;
 30336                                  ;	ENTRY	DS:SI Points to DPB
 30337                                  ;		ES:BX Points to request data
 30338                                  ;	EXIT	DS:SI -> Device driver
 30339                                  ;	USES	DS:SI,AX
 30340                                  ;----------------------------------------------------------------------------
 30341                                  
 30342                                  DEVIOCALL:
 30343                                  					; SS override for CALLSSEC, 
 30344                                  	;lds	si,[si+7]		; CALLNEWSC, HIGH_SECTOR & CALLDEVAD
 30345 00004F75 C57407                  	LDS	SI,[SI+SF_ENTRY.sf_devptr]
 30346                                  
 30347                                  	;entry	DEVIOCALL2
 30348                                  DEVIOCALL2:
 30349                                  	;EnterCrit critDevice
 30350 00004F78 E847C9                  	call	ECritDevice
 30351                                  
 30352                                  	; MSDOS 6.0
 30353                                  	;TEST	word [SI+SYSDEV.ATT],DEVTYP ;AN000; >32mb block device ?
 30354                                  	;test	byte [si+5],80h
 30355 00004F7B F6440580                	test	byte [si+SYSDEV.ATT+1],(DEVTYP>>8)
 30356 00004F7F 7540                    	jnz	short chardev2		;AN000; >32mb no
 30357                                  
 30358                                  	; 16/12/2022
 30359                                  	; 22/11/2022
 30360 00004F81 268A4702                	mov	al,[ES:BX+SRHEAD.REQFUNC] ; [es:bx+2]
 30361 00004F85 3C04                    	cmp	al,DEVRD	; 4
 30362 00004F87 7408                    	je	short chkext	
 30363 00004F89 3C08                    	cmp	al,DEVWRT	; 8
 30364 00004F8B 7404                    	je	short chkext
 30365 00004F8D 3C09                    	cmp	al,DEVWRTV	; 9
 30366 00004F8F 7530                    	jne	short chardev2
 30367                                  
 30368                                  	; 16/12/2022
 30369                                  	; 22/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 30370                                  	;;cmp	byte [es:bx+2],4
 30371                                  	;CMP	byte [ES:BX+SRHEAD.REQFUNC],DEVRD  ;AN000; >32mb read ?
 30372                                  	;JZ	short chkext		;AN000; >32mb   yes
 30373                                  	;;cmp	byte [es:bx+2],8
 30374                                  	;CMP	byte [ES:BX+SRHEAD.REQFUNC],DEVWRT ;AN000; >32mb write ?
 30375                                  	;JZ	short chkext		;AN000; >32mb   yes
 30376                                  	;;cmp	byte [es:bx+2],9
 30377                                  	;CMP	byte [ES:BX+SRHEAD.REQFUNC],DEVWRTV
 30378                                  	;				;AN000; >32mb write/verify ?
 30379                                  	;JNZ	short chardev2		;AN000; >32mb no
 30380                                  
 30381                                  chkext:
 30382                                  
 30383                                  ; 22/02/2024 - Retro DOS v5.0 (PCDOS 7.1)
 30384                                  %if 0
 30385                                  	CALL	RW_SC			;AN000;LB. use secondary cache if there
 30386                                  	JC	short dev_exit		;AN000;LB. done
 30387                                  %endif
 30388                                  
 30389                                  	;test	byte [si+4],2
 30390 00004F91 F6440402                	TEST	byte [SI+SYSDEV.ATT],EXTDRVR ;AN000;>32mb extended driver?
 30391 00004F95 741A                    	JZ	short chksector		;AN000;>32mb   no
 30392 00004F97 26800708                	ADD	BYTE [ES:BX],8		;AN000;>32mb   make length to 30
 30393                                  
 30394                                  	;MOV	AX,[SS:CALLSSEC]	;AN000;>32mb
 30395                                  	;MOV	word [SS:CALLSSEC],-1	;AN000;>32mb   old sector  =-1
 30396                                  	; 22/02/2024
 30397 00004F9B B8FFFF                  	mov	ax,-1 ; 0FFFFh
 30398 00004F9E 368706[6E03]            	xchg    ax,[ss:CALLSSEC]
 30399                                  	
 30400 00004FA3 36A3[7403]              	MOV	[SS:CALLNEWSC],AX	;AN000;>32mb   new sector  =
 30401 00004FA7 36A1[0706]              	MOV	AX,[SS:HIGH_SECTOR]	;AN000; >32mb  low sector,high sector
 30402 00004FAB 36A3[7603]              	MOV	[SS:CALLNEWSC+2],AX	;AN000; >32mb
 30403 00004FAF EB10                    	JMP	short chardev2		;AN000; >32mb
 30404                                  
 30405                                  chksector:				;AN000; >32mb
 30406 00004FB1 36833E[0706]00          	CMP	word [SS:HIGH_SECTOR],0	;AN000; >32mb   if >32mb
 30407 00004FB7 7408                    	JZ	short chardev2		;AN000; >32mb   then fake error
 30408                                  	;mov	word [es:bx+3],8107h
 30409 00004FB9 26C747030781            	MOV	word [ES:BX+SRHEAD.REQSTAT],STERR+STDON+error_I24_not_DOS_disk 
 30410                                  					;AN000; >32mb
 30411 00004FBF EB27                    	JMP	SHORT dev_exit		;AN000; >32mb
 30412                                  
 30413                                  chardev2:				;AN000;
 30414                                  	; As above only DS:SI points to device header on entry, and DS:SI is 
 30415                                  	; preserved
 30416                                  
 30417                                  	;;;
 30418                                  	; 22/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 30419 00004FC1 36FE06[C511]            	inc	byte [ss:DEVIO_IN_PROGRESS] ; lock (deviocall in progress)
 30420                                  	;;;	
 30421                                  
 30422                                  	;mov	ax,[si+6]
 30423 00004FC6 8B4406                  	MOV	AX,[SI+SYSDEV.STRAT]
 30424 00004FC9 36A3[7803]              	MOV	[SS:CALLDEVAD],AX
 30425 00004FCD 368C1E[7A03]            	MOV	[SS:CALLDEVAD+2],DS
 30426 00004FD2 36FF1E[7803]            	CALL	far [SS:CALLDEVAD]
 30427                                  
 30428                                  	;mov	ax,[si+8]
 30429 00004FD7 8B4408                  	MOV	AX,[SI+SYSDEV.INT]
 30430 00004FDA 36A3[7803]              	MOV	[SS:CALLDEVAD],AX
 30431 00004FDE 36FF1E[7803]            	CALL	far [SS:CALLDEVAD]
 30432                                  
 30433                                  	;;;
 30434                                  	; 22/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 30435 00004FE3 36FE0E[C511]            	dec	byte [ss:DEVIO_IN_PROGRESS] ; unlock (deviocall completed)
 30436                                  	;;;
 30437                                  
 30438                                  ; 22/02/2024 - Retro DOS v5.0 (PCDOS 7.1)
 30439                                  %if 0
 30440                                  	; MSDOS 6.0
 30441                                  	CALL	VIRREAD 		;AN000;LB. move data from SC to buffer
 30442                                  	JC	short chardev2		;AN000;LB. bad sector or exceeds max sec
 30443                                  %endif
 30444                                  
 30445                                  dev_exit:
 30446                                  	;LeaveCrit critDevice
 30447                                  	;call	LCritDevice
 30448                                  	;retn
 30449                                  	; 18/12/2022
 30450 00004FE8 E9E8C8                  	jmp	LCritDevice
 30451                                  
 30452                                  ; DOSCODE:8669h (MSDOS 6.21, MSDOS.SYS)
 30453                                  ; 22/11/2022
 30454                                  ; DOSCODE:862Eh (MSDOS 5.0, MSDOS.SYS)
 30455                                  
 30456                                  ;Break	<SETREAD, SETWRITE -- SET UP HEADER BLOCK>
 30457                                  ;---------------------------------------------------------------------------
 30458                                  ;
 30459                                  ; Procedure Name : SETREAD, SETWRITE
 30460                                  ;
 30461                                  ; Inputs:
 30462                                  ;	DS:BX = Transfer Address
 30463                                  ;	CX = Record Count
 30464                                  ;	DX = Starting Record
 30465                                  ;	AH = Media Byte
 30466                                  ;	AL = Unit Code
 30467                                  ; Function:
 30468                                  ;	Set up the device call header at DEVCALL
 30469                                  ; Output:
 30470                                  ;	ES:BX Points to DEVCALL
 30471                                  ; No other registers effected
 30472                                  ;
 30473                                  ;---------------------------------------------------------------------------
 30474                                  
 30475                                  SETREAD_XJ:
 30476                                  	;;;
 30477                                  	; 07/02/2024 - Retro DOS v5.0
 30478 00004FEB 89FB                    	mov	bx,di
 30479 00004FED EB07                    	jmp	short SETREAD_X
 30480                                  	;;;
 30481                                  
 30482                                  SETREAD_XT:
 30483                                  	;;;
 30484                                  	; 07/02/2024 - Retro DOS v5.0
 30485 00004FEF BB[B603]                	mov	bx,TIMEBUF
 30486 00004FF2 53                      	push	bx
 30487                                  SETREAD_XTC:
 30488 00004FF3 B90600                  	mov	cx,6
 30489                                  	;;;
 30490                                  SETREAD_X:
 30491                                  	;;;
 30492                                  	; 06/02/2024 - Retro DOS v5.0
 30493 00004FF6 31C0                    	xor	ax,ax
 30494                                  	;mov	dx,ax ; 0
 30495 00004FF8 99                      	cwd
 30496                                  	;;;
 30497                                  
 30498                                  ; ------------------------------------
 30499                                  
 30500                                  SETREAD:
 30501 00004FF9 57                      	PUSH	DI
 30502 00004FFA 51                      	PUSH	CX
 30503 00004FFB 50                      	PUSH	AX
 30504 00004FFC B104                    	MOV	CL,DEVRD ; mov cl,4
 30505                                  SETCALLHEAD:
 30506 00004FFE B016                    	MOV	AL,DRDWRHL ; mov al,16h
 30507 00005000 16                      	PUSH	SS
 30508 00005001 07                      	POP	ES
 30509                                  					; DEVCALL is in DOSDATA
 30510 00005002 BF[5A03]                	MOV	DI,DEVCALL
 30511                                  
 30512 00005005 AA                      	STOSB				; length
 30513 00005006 58                      	POP	AX			; 
 30514 00005007 AA                      	STOSB				; Unit
 30515 00005008 50                      	PUSH	AX
 30516 00005009 88C8                    	MOV	AL,CL
 30517 0000500B AA                      	STOSB				; Command code
 30518 0000500C 31C0                    	XOR	AX,AX
 30519 0000500E AB                      	STOSW				; Status
 30520 0000500F 83C708                  	ADD	DI,8			; Skip link fields
 30521 00005012 58                      	POP	AX
 30522 00005013 86C4                    	XCHG	AH,AL
 30523 00005015 AA                      	STOSB				; Media byte
 30524 00005016 86E0                    	XCHG	AL,AH
 30525 00005018 50                      	PUSH	AX
 30526 00005019 89D8                    	MOV	AX,BX
 30527 0000501B AB                      	STOSW
 30528                                  
 30529 0000501C 8CD8                    	MOV	AX,DS
 30530 0000501E AB                      	STOSW				; Transfer addr
 30531                                  
 30532 0000501F 59                      	POP	CX			; Real AX
 30533 00005020 58                      	POP	AX			; Real CX
 30534 00005021 AB                      	STOSW				; Count
 30535                                  
 30536 00005022 92                      	XCHG	AX,DX			; AX=Real DX, DX=real CX, CX=real AX
 30537 00005023 AB                      	STOSW				; Start
 30538 00005024 91                      	XCHG	AX,CX
 30539 00005025 87CA                    	XCHG	DX,CX
 30540 00005027 5F                      	POP	DI
 30541                                  					; DEVCALL is in DOSDATA
 30542 00005028 BB[5A03]                	MOV	BX,DEVCALL
 30543 0000502B C3                      	retn
 30544                                  
 30545                                  	;entry	SETWRITE
 30546                                  SETWRITE:
 30547                                  
 30548                                  ; Inputs:
 30549                                  ;	DS:BX = Transfer Address
 30550                                  ;	CX = Record Count
 30551                                  ;	DX = Starting Record
 30552                                  ;	AH = Media Byte
 30553                                  ;	AL = Unit Code
 30554                                  ; Function:
 30555                                  ;	Set up the device call header at DEVCALL
 30556                                  ; Output:
 30557                                  ;	ES:BX Points to DEVCALL
 30558                                  ; No other registers effected
 30559                                  
 30560 0000502C 57                      	PUSH	DI
 30561 0000502D 51                      	PUSH	CX
 30562 0000502E 50                      	PUSH	AX
 30563 0000502F B108                    	MOV	CL,DEVWRT ; mov cl,8
 30564 00005031 36020E[FF02]            	ADD	CL,[SS:VERFLG]		; SS override
 30565 00005036 EBC6                    	JMP	SHORT SETCALLHEAD
 30566                                  
 30567                                  ; 22/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 30568                                  %if 0	; SC
 30569                                  
 30570                                  ; 30/04/2019 - Retro DOS v4.0
 30571                                  ; DOSCODE:86A8h (MSDOS 6.21, MSDOS.SYS)
 30572                                  ; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 30573                                  ; DOSCODE:866Dh (MSDOS 5.0, MSDOS.SYS)
 30574                                  
 30575                                  ;Break	<RW_SC -- Read Write Secondary Cache>
 30576                                  ;---------------------------------------------------------------------------
 30577                                  ;
 30578                                  ; Procedure Name : RW_SC
 30579                                  ;
 30580                                  ; Inputs:
 30581                                  ;	 [SC_CACHE_COUNT]= secondary cache count
 30582                                  ;	 [SC_STATUS]= SC validity status
 30583                                  ;	 [SEQ_SECTOR]= last sector read
 30584                                  ; Function:
 30585                                  ;	Read from or write through secondary cache
 30586                                  ; Output:
 30587                                  ;	ES:BX Points to DEVCALL
 30588                                  ;	carry clear, I/O is not done
 30589                                  ;		     [SC_FLAG]=1 if continuos sectors will be read
 30590                                  ;	carry set, I/O is done
 30591                                  ;
 30592                                  ;----------------------------------------------------------------------------
 30593                                  
 30594                                  RW_SC:
 30595                                  	; SS override for all variables used.
 30596                                  	
 30597                                  	CMP	word [ss:SC_CACHE_COUNT],0  ;AN000;LB. secondary cache exists?
 30598                                  	JZ	short scexit4		    ;AN000;LB. no, do nothing
 30599                                  	CMP	word [ss:CALLSCNT],1	    ;AN000;LB. sector count = 1 (buffer I/O)
 30600                                  	JNZ	short scexit4 		    ;AN000;LB. no, do nothing
 30601                                  	PUSH	CX			    ;AN000;LB.
 30602                                  	PUSH	DX			    ;AN000;LB. yes
 30603                                  	PUSH	DS			    ;AN000;LB. save registers
 30604                                  	PUSH	SI			    ;AN000;LB.
 30605                                  	PUSH	ES			    ;AN000;LB.
 30606                                  	PUSH	DI			    ;AN000;LB.
 30607                                  
 30608                                  	MOV	DX,[ss:CALLSSEC]	    ;AN000;LB. starting sector
 30609                                  	CMP	BYTE [ss:DEVCALL_REQFUNC],DEVRD ;AN000;LB. read ?
 30610                                  	JZ	short doread		    ;AN000;LB. yes
 30611                                  	CALL	INVALIDATE_SC		    ;AN000;LB. invalidate SC
 30612                                  	JMP	scexit2 		    ;AN000;LB. back to normal
 30613                                  scexit4:				    ;AN000;
 30614                                  	CLC				    ;AN000;LB. I/O not done yet
 30615                                  	retn				    ;AN000;LB.
 30616                                  doread: 				    ;AN000;
 30617                                  	CALL	SC2BUF			    ;AN000;LB. check if in SC
 30618                                  	JC	short readSC		    ;AN000;LB.
 30619                                  	MOV	word [ss:DEVCALL_REQSTAT],STDON ;AN000;LB. fake done and ok
 30620                                  	STC				    ;AN000;LB. set carry
 30621                                  	JMP	short saveseq 		    ;AN000;LB. save seq. sector #
 30622                                  readSC: 				    ;AN000;
 30623                                  	MOV	AX,[ss:HIGH_SECTOR]   	    ;AN000;LB. subtract sector num from
 30624                                  	MOV	CX,[ss:CALLSSEC]	    ;AN000;LB. saved sequential sector
 30625                                  	SUB	CX,[ss:SEQ_SECTOR]    	    ;AN000;LB. number
 30626                                  	SBB	AX,[ss:SEQ_SECTOR+2]  	    ;AN000;LB.
 30627                                  	; 24/09/2023
 30628                                  	;CMP	AX,0			    ;AN000;LB. greater than 64K
 30629                                  	JNZ	short saveseq2		    ;AN000;LB. yes,save seq. sector #
 30630                                  chklow: 						
 30631                                  	CMP	CX,1			    ;AN000;LB. <= 1
 30632                                  	JA	short saveseq2		    ;AN000;LB. no, not sequential
 30633                                  	MOV	word [ss:SC_STATUS],-1	    ;AN000;LB. presume all SC valid
 30634                                  	MOV	AX,[ss:SC_CACHE_COUNT]	    ;AN000;LB. yes, sequential
 30635                                  	MOV	[ss:CALLSCNT],AX	    ;AN000;LB. read continuous sectors
 30636                                  readsr:
 30637                                  	MOV	AX,[ss:CALLXAD+2]	    ;AN000;LB. save buffer addr
 30638                                  	MOV	[ss:TEMP_VAR2],AX	    ;AN000;LB. in temp vars
 30639                                  	MOV	AX,[ss:CALLXAD]	    	    ;AN000;LB.
 30640                                  	MOV	[ss:TEMP_VAR],AX	    ;AN000;LB.
 30641                                  
 30642                                  	MOV	AX,[ss:SC_CACHE_PTR]	    ;AN000;LB. use SC cache addr as
 30643                                  	MOV	[ss:CALLXAD],AX		    ;AN000;LB. transfer addr
 30644                                  	MOV	AX,[ss:SC_CACHE_PTR+2]	    ;AN000;LB.
 30645                                  	MOV	[ss:CALLXAD+2],AX	    ;AN000;LB.
 30646                                  	MOV	byte [ss:SC_FLAG],1	    ;AN000;LB. flag it for later;
 30647                                  	MOV	AL,[ss:SC_DRIVE]	    ;AN000;LB. current drive
 30648                                  	MOV	[ss:CurSC_DRIVE],AL	    ;AN000;LB. set current drive
 30649                                  	MOV	AX,[ss:CALLSSEC]	    ;AN000;LB. current sector
 30650                                  	MOV	[ss:CurSC_SECTOR],AX	    ;AN000;LB. set current sector
 30651                                  	MOV	AX,[ss:HIGH_SECTOR]	    ;AN000;LB.
 30652                                  	MOV	[ss:CurSC_SECTOR+2],AX	    ;AN000;LB.
 30653                                  saveseq2:				    ;AN000;
 30654                                  	CLC				    ;AN000;LB. clear carry
 30655                                  saveseq:				    ;AN000;	
 30656                                  	MOV	AX,[ss:HIGH_SECTOR]	    ;AN000;LB. save current sector #
 30657                                  	MOV	[ss:SEQ_SECTOR+2],AX	    ;AN000;LB. for access mode ref.
 30658                                  	MOV	AX,[ss:CALLSSEC]	    ;AN000;LB.	
 30659                                  	MOV	[ss:SEQ_SECTOR],AX 	    ;AN000;LB.	
 30660                                  	JMP	short scexit 		    ;AN000;LB.	
 30661                                  scexit2:				    ;AN000;LB.
 30662                                  	CLC				    ;AN000;LB.	clear carry
 30663                                  scexit: 				    ;AN000;		
 30664                                  	POP	DI			    ;AN000;LB.
 30665                                  	POP	ES			    ;AN000;LB. restore registers
 30666                                  	POP	SI			    ;AN000;LB.
 30667                                  	POP	DS			    ;AN000;LB.
 30668                                  	POP	DX			    ;AN000;LB.
 30669                                  	POP	CX			    ;AN000;LB.
 30670                                  	retn				    ;AN000;LB.
 30671                                  
 30672                                  ;Break	<IN_SC -- check if in secondary cache>
 30673                                  ;--------------------------------------------------------------------------
 30674                                  ;
 30675                                  ; Procedure Name : IN_SC
 30676                                  ;
 30677                                  ; Inputs:  [SC_DRIVE]= requesting drive
 30678                                  ;	   [CURSC_DRIVE]= current SC drive
 30679                                  ;	   [CURSC_SECTOR]= starting scetor # of SC
 30680                                  ;	   [SC_CACHE_COUNT]= SC count
 30681                                  ;	   [HIGH_SECTOR]:DX= sector number
 30682                                  ; Function:
 30683                                  ;	Check if the sector is in secondary cache
 30684                                  ; Output:
 30685                                  ;	carry clear, in SC
 30686                                  ;	   CX= the index in the secondary cache
 30687                                  ;	carry set, not in SC
 30688                                  ;
 30689                                  ;---------------------------------------------------------------------------
 30690                                  
 30691                                  	; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 30692                                  IN_SC:
 30693                                  	; SS override for all variables used
 30694                                  	MOV	AL,[ss:SC_DRIVE]	    ;AN000;;LB. current drive
 30695                                  	CMP	AL,[ss:CurSC_DRIVE]	    ;AN000;;LB. same as SC drive
 30696                                  	JNZ	short outrange2		    ;AN000;;LB. no
 30697                                  	MOV	AX,[ss:HIGH_SECTOR]	    ;AN000;;LB. subtract sector num from
 30698                                  	MOV	CX,DX			    ;AN000;;LB. secondary starting sector
 30699                                  	SUB	CX,[ss:CurSC_SECTOR]        ;AN000;;LB. number
 30700                                  	SBB	AX,[ss:CurSC_SECTOR+2]      ;AN000;;LB.
 30701                                  	; 24/09/2023
 30702                                  	;CMP	AX,0			    ;AN000;;LB. greater than 64K
 30703                                  	JNZ	short outrange2		    ;AN000;;LB. yes
 30704                                  	CMP	CX,[ss:SC_CACHE_COUNT]	    ;AN000;;LB. greater than SC count
 30705                                  	JAE	short outrange2		    ;AN000;;LB. yes
 30706                                  	CLC				    ;AN000;;LB. clear carry
 30707                                  	;JMP	short inexit		    ;AN000;;LB. in SC
 30708                                  	; 16/12/2022
 30709                                  	retn	; 30/04/2019
 30710                                  	; 22/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 30711                                  	;jmp	short inexit
 30712                                  
 30713                                  outrange2:				    ;AN000;;LB. set carry
 30714                                  	STC				    ;AN000;;LB.
 30715                                  inexit: 				    ;AN000;;LB.
 30716                                  	retn				    ;AN000;;LB.
 30717                                  
 30718                                  ;Break	<INVALIDATE_SC - invalide secondary cache>
 30719                                  ;---------------------------------------------------------------------------
 30720                                  ;
 30721                                  ; Procedure Name : Invalidate_Sc
 30722                                  ;
 30723                                  ; Inputs:  [SC_DRIVE]= requesting drive
 30724                                  ;	   [CURSC_DRIVE]= current SC drive
 30725                                  ;	   [CURSC_SECTOR]= starting scetor # of SC
 30726                                  ;	   [SC_CACHE_COUNT]= SC count
 30727                                  ;	   [SC_STATUS]= SC status word
 30728                                  ;	   [HIGH_SECTOR]:DX= sector number
 30729                                  ;
 30730                                  ; Function:
 30731                                  ;	invalidate secondary cache if in there
 30732                                  ; Output:
 30733                                  ;	[SC_STATUS] is updated
 30734                                  ;---------------------------------------------------------------------------
 30735                                  
 30736                                  INVALIDATE_SC:
 30737                                  	; SS override for all variables used
 30738                                  
 30739                                  	CALL	IN_SC			    ;AN000;;LB. in secondary cache
 30740                                  	JC	short outrange		    ;AN000;;LB. no
 30741                                  	MOV	AX,1			    ;AN000;;LB. invalidate the sector
 30742                                  	SHL	AX,CL			    ;AN000;;LB. in the secondary cache
 30743                                  	NOT	AX			    ;AN000;;LB.
 30744                                  	AND	[ss:SC_STATUS],AX	    ;AN000;;LB. save the status
 30745                                  outrange:				    ;AN000;;LB.
 30746                                  	retn				    ;AN000;;LB.
 30747                                  
 30748                                  ; DOSCODE:87A5h (MSDOS 6.21, MSDOS.SYS)
 30749                                  ; 22/11/2022
 30750                                  ; DOSCODE:876Ah (MSDOS 5.0, MSDOS.SYS)
 30751                                  
 30752                                  ;Break	<VIRREAD- virtually read data into buffer>
 30753                                  ;--------------------------------------------------------------------------
 30754                                  ;
 30755                                  ; Procedure Name : SC_FLAG
 30756                                  ;
 30757                                  ; Inputs:  SC_FLAG = 0, no sectors were read into SC
 30758                                  ;		     1, continuous sectors were read into SC
 30759                                  ; Function:
 30760                                  ;	   Move data from SC to buffer
 30761                                  ; Output:
 30762                                  ;	 carry clear, data is moved to buffer
 30763                                  ;	 carry set, bad sector or exceeds maximum sector
 30764                                  ;	   SC_FLAG =0
 30765                                  ;	   CALLSCNT=1
 30766                                  ;	   SC_STATUS= -1 if succeeded
 30767                                  ;     
 30768                                  ;		       0 if failed
 30769                                  ;--------------------------------------------------------------------------
 30770                                  
 30771                                  VIRREAD:
 30772                                  	; SS override for all variables used
 30773                                  
 30774                                  	CMP	byte [ss:SC_FLAG],0	    ;AN000;;LB. from SC fill
 30775                                  	JZ	short sc2end		    ;AN000;;LB. no
 30776                                  	MOV	AX,[ss:TEMP_VAR2]	    ;AN000;;LB. restore buffer addr
 30777                                  	MOV	[ss:CALLXAD+2],AX	    ;AN000;;LB.
 30778                                  	MOV	AX,[ss:TEMP_VAR]	    ;AN000;;LB.
 30779                                  	MOV	[ss:CALLXAD],AX		    ;AN000;;LB.
 30780                                  	MOV	byte [ss:SC_FLAG],0	    ;AN000;;LB. reset sc_flag
 30781                                  	MOV	word [ss:CALLSCNT],1	    ;AN000;;LB. one sector transferred
 30782                                  
 30783                                  	;TEST	word [SS:DEVCALL_REQSTAT],STERR ;AN000;;LB. error?
 30784                                  	test	byte [ss:DEVCALL_REQSTAT+1],(STERR>>8) ; 80h
 30785                                  	JNZ	short scerror 		    ;AN000;;LB. yes
 30786                                  	PUSH	DS			    ;AN000;;LB.
 30787                                  	PUSH	SI			    ;AN000;;LB.
 30788                                  	PUSH	ES			    ;AN000;;LB.
 30789                                  	PUSH	DI			    ;AN000;;LB.
 30790                                  	PUSH	DX			    ;AN000;;LB.
 30791                                  	PUSH	CX			    ;AN000;;LB.
 30792                                  	XOR	CX,CX			    ;AN000;;LB. we want first sector in SC
 30793                                  	CALL	SC2BUF2 		    ;AN000;;LB. move data from SC to buf
 30794                                  	POP	CX
 30795                                  	POP	DX			    ;AN000;;LB.
 30796                                  	POP	DI			    ;AN000;;LB.
 30797                                  	POP	ES			    ;AN000;;LB.
 30798                                  	POP	SI			    ;AN000;;LB.
 30799                                  	POP	DS			    ;AN000;;LB.
 30800                                  	JMP	SHORT sc2end		    ;AN000;;LB. return
 30801                                  scerror:				    ;AN000;
 30802                                  	MOV	word [ss:CALLSCNT],1	    ;AN000;;LB. reset sector count to 1
 30803                                  	MOV	word [ss:SC_STATUS],0	    ;AN000;;LB. invalidate all SC sectors
 30804                                  	MOV	byte [ss:CurSC_DRIVE],-1    ;AN000;;LB. invalidate drive
 30805                                  	STC				    ;AN000;;LB. carry set
 30806                                  	retn				    ;AN000;;LB.
 30807                                  sc2end: 				    ;AN000;
 30808                                  	CLC				    ;AN000;;LB. carry clear
 30809                                  	retn				    ;AN000;;LB.
 30810                                  
 30811                                  ; 30/04/2019 - Retro  DOS v4.0
 30812                                  ; DOSCODE:87FDh (MSDOS 6.21, MSDOS.SYS)
 30813                                  ; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 30814                                  ; DOSCODE:87C2h (MSDOS 5.0, MSDOS.SYS)
 30815                                  
 30816                                  ;Break	<SC2BUF- move data from SC to buffer>
 30817                                  ;----------------------------------------------------------------------------
 30818                                  ;
 30819                                  ; Procedure Name : SC2BUF
 30820                                  ;
 30821                                  ; Inputs:  [SC_STATUS] = SC validity status
 30822                                  ;	   [SC_SECTOR_SIZE] = request sector size
 30823                                  ;	   [SC_CACHE_PTR] = pointer to SC
 30824                                  ; Function:
 30825                                  ;	   Move data from SC to buffer
 30826                                  ; Output:
 30827                                  ;	   carry clear, in SC  and data is moved
 30828                                  ;	   carry set, not in SC and data is not moved
 30829                                  ;---------------------------------------------------------------------------
 30830                                  
 30831                                  SC2BUF:
 30832                                  	; SS override for all variables used
 30833                                  	CALL	IN_SC			    ;AN000;LB. in secondary cache
 30834                                  	;JC	short noSC		    ;AN000;LB. no
 30835                                  	; 24/09/2023
 30836                                  	jc	short sexit
 30837                                  	MOV	AX,1			    ;AN000;LB. check if valid sector
 30838                                  	SHL	AX,CL			    ;AN000;LB. in the secondary cache
 30839                                  	TEST	[ss:SC_STATUS],AX	    ;AN000;LB.
 30840                                  	JZ	short noSC		    ;AN000;LB. invalid
 30841                                  ;entry SC2BUF2
 30842                                  SC2BUF2:				    ;AN000;
 30843                                  	;MOV	AX,CX			    ;AN000;LB. times index with
 30844                                  	;MUL	word [ss:SC_SECTOR_SIZE]    ;AN000;LB. sector size
 30845                                  	; 24/09/2023
 30846                                  	mov	ax,[ss:SC_SECTOR_SIZE]
 30847                                  	xchg	ax,cx ; cx = [ss:SC_SECTOR_SIZE]
 30848                                  	mul	cx
 30849                                  	ADD	AX,[ss:SC_CACHE_PTR]	    ;AN000;LB. add SC starting addr
 30850                                  	ADC	DX,[ss:SC_CACHE_PTR+2]	    ;AN000;LB.
 30851                                  	MOV	DS,DX			    ;AN000;LB. DS:SI-> SC sector addr
 30852                                  	MOV	SI,AX			    ;AN000;LB.
 30853                                  	MOV	ES,[ss:CALLXAD+2]		    ;AN000;LB. ES:DI-> buffer addr
 30854                                  	MOV	DI,[ss:CALLXAD]		    ;AN000;LB.
 30855                                  	; 24/09/2023
 30856                                  	;MOV	CX,[ss:SC_SECTOR_SIZE]	    ;AN000;LB. count= sector size
 30857                                  	SHR	CX,1			    ;AN000;LB. may use DWORD move for 386
 30858                                  ;entry MOVWORDS
 30859                                  MOVWORDS:				    ;AN000;
 30860                                  	CMP	byte [ss:DDMOVE],0	    ;AN000;LB. 386 ?
 30861                                  	JZ	short nodd		    ;AN000;LB. no
 30862                                  	SHR	CX,1			    ;AN000;LB. words/2
 30863                                  	DB	66H			    ;AN000;LB. use double word move
 30864                                  nodd:
 30865                                  	REP	MOVSW			    ;AN000;LB. move to buffer
 30866                                  	CLC				    ;AN000;LB. clear carry
 30867                                  	retn				    ;AN000;LB. exit
 30868                                  noSC:					    ;AN000;
 30869                                  	STC				    ;AN000;LB. set carry
 30870                                  sexit:					    ;AN000;
 30871                                  	retn				    ;AN000;LB.
 30872                                  
 30873                                  %endif	; SC
 30874                                  
 30875                                  ;============================================================================
 30876                                  ; MKNODE.ASM, MSDOS 6.0, 1991
 30877                                  ;============================================================================
 30878                                  ; 29/07/2018 - Retro DOS v3.0
 30879                                  ; 19/05/2019 - Retro DOS v4.0
 30880                                  ; 22/02/2024 - Retro DOS v5.0
 30881                                  
 30882                                  ;	TITLE	MKNODE - Node maker
 30883                                  ;	NAME	MKNODE
 30884                                  
 30885                                  ;**	MKNODE.ASM
 30886                                  ;----------------------------------------------------------------------------
 30887                                  ;	Low level routines for making a new local file system node
 30888                                  ;	and filling in an SFT from a directory entry
 30889                                  ;
 30890                                  ;	BUILDDIR
 30891                                  ;	SETDOTENT
 30892                                  ;	MakeNode
 30893                                  ;	NEWENTRY
 30894                                  ;	FREEENT
 30895                                  ;	NEWDIR
 30896                                  ;	DOOPEN
 30897                                  ;	RENAME_MAKE
 30898                                  ;	CHECK_VIRT_OPEN
 30899                                  ;
 30900                                  ;	Revision history:
 30901                                  ;
 30902                                  ;	 AN000	version 4.0  Jan. 1988
 30903                                  ;	 A004	PTM 3680  --- Make SFT NAME field offset same as 3.30
 30904                                  
 30905                                  ;Break   <BUILDDIR,NEWDIR -- ALLOCATE DIRECTORIES>
 30906                                  ;----------------------------------------------------------------------------
 30907                                  ;
 30908                                  ; Procedure Name : BUILDDIR,NEWDIR
 30909                                  ;
 30910                                  ; Inputs:
 30911                                  ;       ES:BP Points to DPB
 30912                                  ;       [THISSFT] Set if using NEWDIR entry point
 30913                                  ;               (used by ALLOCATE)
 30914                                  ;       [LASTENT] current last valid entry number in directory if no free
 30915                                  ;               entries
 30916                                  ;       [DIRSTART] Points to first cluster of dir (0 means root)
 30917                                  ; Function:
 30918                                  ;       Grow directory if no free entries and not root
 30919                                  ; Outputs:
 30920                                  ;       CARRY SET IF FAILURE
 30921                                  ;       ELSE
 30922                                  ;          AX entry number of new entry
 30923                                  ;          If a new dir [DIRSTART],[CLUSFAC],[CLUSNUM],[DIRSEC] set
 30924                                  ;               AX = first entry of new dir
 30925                                  ;       GETENT should be called to set [LASTENT]
 30926                                  ;
 30927                                  ;----------------------------------------------------------------------------
 30928                                  
 30929                                  ; 19/05/2019 - Retro DOS v4.0
 30930                                  ; DOSCODE:8845h (MSDOS 6.21, MSDOS.SYS)
 30931                                  ; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 30932                                  ; DOSCODE:880Ah (MSDOS 6.21, MSDOS.SYS)
 30933                                  
 30934                                  ; 24/09/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 MSDOS.SYS)
 30935                                  ; DOSCODE:8845h (MSDOS 6.22, MSDOS.SYS)
 30936                                  
 30937                                  ; 23/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 30938                                  ; DOSCODE:940Ah (PCDOS 7.1, IBMDOS.COM)
 30939                                  
 30940                                  ; (Windows ME IO.SYS - BIOSCODE:890Ch)
 30941                                  
 30942                                  BUILDDIR:
 30943                                  	; 29/07/2018 - Retro DOS v3.0
 30944                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 4E66h
 30945                                  
 30946 00005038 A1[D805]                	MOV	AX,[ENTFREE]
 30947 0000503B 83F8FF                  	CMP	AX,-1 ; 0FFFFh
 30948                                  	;JZ	short CHECK_IF_ROOT
 30949                                  	;CLC
 30950                                  	;retn
 30951                                  	; 24/09/2023
 30952 0000503E 750E                    	jne	short builddir_cmc_retn  ; cf=1 (will be 0)
 30953                                  
 30954                                  CHECK_IF_ROOT:
 30955                                  	; 23/02/2024 (PCDOS 7.1 IBMDOS.COM)
 30956                                  	;;;
 30957 00005040 833E[DC0A]00            	cmp	word [DIRSTART_HW],0
 30958 00005045 7509                    	jnz	short NEWDIR 
 30959                                  	;;;
 30960 00005047 833E[C205]00            	CMP	word [DIRSTART],0
 30961 0000504C 7502                    	JNZ	short NEWDIR
 30962                                  	;STC				; Can't grow root
 30963                                  	; 24/09/2023
 30964                                  	; [DIRSTART]=0, cf=0, zf=1 (cf will be 1 after cmc instruction)
 30965                                  builddir_cmc_retn:
 30966                                  	; 24/09/2023
 30967 0000504E F5                      	cmc	; cf=1 <-> cf=0
 30968                                  builddir_retn:
 30969 0000504F C3                      	retn
 30970                                  
 30971                                  	;entry   NEWDIR
 30972                                  NEWDIR: 
 30973                                  	; 23/02/2024
 30974                                  	;;;
 30975 00005050 8B1E[DC0A]              	mov	bx,[DIRSTART_HW]
 30976 00005054 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 30977 00005058 09DB                    	or	bx,bx
 30978                                  	;;;
 30979 0000505A 8B1E[C205]              	MOV	BX,[DIRSTART]
 30980                                  	;;;
 30981 0000505E 7504                    	jnz	short NEWDIR2 ; 23/02/2024
 30982                                  	;;;
 30983 00005060 09DB                    	OR	BX,BX
 30984 00005062 7405                    	JZ	short NULLDIR
 30985                                  NEWDIR2:
 30986 00005064 E87A08                  	call	GETEOF
 30987 00005067 72E6                    	jc	short builddir_retn	; Screw up
 30988                                  NULLDIR:
 30989                                  	;MOV	CX,1
 30990                                  	; 23/02/2024
 30991                                  	;;;
 30992 00005069 31C9                    	xor	cx,cx
 30993 0000506B 890E[F00A]              	mov	[CCOUNT_HW],cx ; 0
 30994 0000506F 41                      	inc	cx ; 1
 30995                                  	;;;
 30996 00005070 E81606                  	call	ALLOCATE
 30997 00005073 72DA                    	jc	short builddir_retn
 30998 00005075 8B16[C205]              	MOV	DX,[DIRSTART]
 30999                                  	; 23/02/2024
 31000                                  	;;;
 31001 00005079 3B16[DC0A]              	cmp	dx,[DIRSTART_HW]
 31002 0000507D 7519                    	jnz	short ADDINGDIR
 31003                                  	;;;
 31004 0000507F 09D2                    	OR	DX,DX
 31005 00005081 7515                    	JNZ	short ADDINGDIR
 31006                                  	; 23/02/2024
 31007                                  	;;;
 31008 00005083 FF36[E80A]              	push	word [CLUSTNUM_HW]
 31009 00005087 8F06[EE0A]              	pop	word [ROOTCLUST_HW]
 31010                                  	;;;
 31011 0000508B E889F7                  	call	SETDIRSRCH
 31012 0000508E 72BF                    	jc	short builddir_retn
 31013 00005090 C706[4803]FFFF          	MOV	word [LASTENT],-1
 31014 00005096 EB2E                    	JMP	SHORT GOTDIRREC
 31015                                  ADDINGDIR:
 31016 00005098 53                      	PUSH    BX
 31017                                  	; 23/02/2024
 31018                                  	;;;
 31019 00005099 FF36[E80A]              	push	word [CLUSTNUM_HW]
 31020                                  	;
 31021 0000509D 8B1E[DE0A]              	mov	bx,[CLUSNUM_HW]
 31022 000050A1 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 31023                                  	;;;
 31024 000050A5 8B1E[BC05]              	MOV	BX,[CLUSNUM]
 31025 000050A9 E8B20E                  	call	IsEOF
 31026                                  	;;;
 31027 000050AC 8F06[E80A]              	pop	word [CLUSTNUM_HW] ; 23/02/2024
 31028                                  	;;;
 31029 000050B0 5B                      	POP	BX
 31030 000050B1 720C                    	JB	short NOTFIRSTGROW
 31031                                  ;;;; 10/17/86 update CLUSNUM in the fastopen cache
 31032 000050B3 891E[BC05]              	MOV	[CLUSNUM],BX
 31033                                  
 31034                                  ; 03/03/2025 (MiniDOS)
 31035                                  %if 0
 31036                                  
 31037                                  	; 24/09/2023
 31038                                  	;PUSH	CX ; (not necessary)
 31039                                  	PUSH	AX
 31040                                  	PUSH	BP
 31041                                  	; 23/02/2024
 31042                                  	;;;
 31043                                  	mov	ax,[CLUSTNUM_HW]
 31044                                  	mov	[CLUSNUM_HW],ax
 31045                                  	;;;
 31046                                  	MOV	AH,1			; CLUSNUM update
 31047                                  	; 15/12/2022
 31048                                  	mov	dl,[ES:BP] ; 09/09/2018
 31049                                  	; 22/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 31050                                  	;;mov	dl,[es:bp+0]
 31051                                  	;MOV	DL,[ES:BP+DPB.DRIVE]	; drive #
 31052                                  	MOV	CX,[DIRSTART]		; first cluster #
 31053                                  	MOV	BP,BX 			; CLUSNUM
 31054                                  	call	FastOpen_Update
 31055                                  	POP	BP
 31056                                  	POP	AX
 31057                                  	; 24/09/2023
 31058                                  	;POP	CX
 31059                                  
 31060                                  %endif
 31061                                  	; 03/03/2025 (MiniDOS)
 31062 000050B7 8B16[E80A]              	mov	dx,[CLUSTNUM_HW]
 31063 000050BB 8916[DE0A]              	mov	[CLUSNUM_HW],dx
 31064                                  
 31065                                  ;;;; 10/17/86 update CLUSNUM in the fastopen cache
 31066                                  NOTFIRSTGROW:
 31067 000050BF 89DA                    	MOV	DX,BX
 31068 000050C1 30DB                    	XOR	BL,BL
 31069 000050C3 E88805                  	call	FIGREC
 31070                                  GOTDIRREC:
 31071                                  	;mov	cl,[es:bp+4]
 31072 000050C6 268A4E04                	MOV	CL,[ES:BP+DPB.CLUSTER_MASK]
 31073                                  	;INC	CL
 31074                                  	; 27/06/2024
 31075 000050CA 41                      	inc	cx
 31076 000050CB 30ED                    	XOR	CH,CH
 31077                                  ZERODIR:
 31078 000050CD 51                      	PUSH    CX
 31079                                  	; 22/09/2023
 31080                                  	;;mov	byte [ALLOWED],18h
 31081                                  	;MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY ; *
 31082 000050CE B0FF                    	MOV	AL,0FFH
 31083                                  	;call	GETBUFFR
 31084 000050D0 E8FE14                  	call	GETBUFFRD ; *
 31085 000050D3 7302                    	JNC	short GET_SSIZE
 31086 000050D5 59                      	POP	CX
 31087 000050D6 C3                      	retn
 31088                                  
 31089                                  GET_SSIZE:
 31090                                  	;mov	cx,[es:bp+2]
 31091 000050D7 268B4E02                	MOV	CX,[ES:BP+DPB.SECTOR_SIZE]
 31092 000050DB 06                      	PUSH    ES
 31093 000050DC C43E[E205]              	LES	DI,[CURBUF]
 31094                                  	;or	byte [es:di+5],4
 31095 000050E0 26804D0504              	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_isDIR
 31096 000050E5 57                      	PUSH    DI
 31097                                  	;;;add	di,16	; MSDOS 3.3
 31098                                  	;;add	di,20	; MSDOS 6.0	
 31099                                  	;add	di,24	; PCDOS 7.1 ; 23/02/2024
 31100 000050E6 83C718                  	ADD	DI,BUFINSIZ
 31101 000050E9 31C0                    	XOR	AX,AX
 31102 000050EB D1E9                    	SHR	CX,1
 31103 000050ED F3AB                    	REP	STOSW
 31104 000050EF 7301                    	JNC	short EVENZ
 31105 000050F1 AA                      	STOSB
 31106                                  EVENZ:
 31107 000050F2 5F                      	POP	DI
 31108                                  
 31109                                  ; 23/02/2024
 31110                                  %if 0
 31111                                  	; MSDOS 6.0
 31112                                  	TEST	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 31113                                  					;LB. if already dirty		  ;AN000;
 31114                                  	JNZ	short yesdirty7		;LB.  don't increment dirty count ;AN000;
 31115                                  	call	INC_DIRTY_COUNT		;LB. 				  ;AN000;
 31116                                  	
 31117                                  	;or	byte [es:di+5],40h
 31118                                  	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 31119                                  %else
 31120                                  	; 23/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 31121 000050F3 E86E17                  	call	SET_BUF_DIRTY
 31122                                  %endif
 31123                                  
 31124                                  yesdirty7:
 31125 000050F6 07                      	POP	ES
 31126 000050F7 59                      	POP	CX
 31127                                  
 31128                                  	; 19/05/2019 - Retro DOS v4.0
 31129                                  
 31130                                  	; MSDOS 3.3
 31131                                  	;INC	DX
 31132                                  
 31133                                  	; MSDOS 6.0
 31134                                  	; 24/09/2023
 31135                                  	;add	dx,1
 31136                                  	;;adc	word [HIGH_SECTOR],0
 31137                                  	;; 24/09/2023
 31138                                  	;; ax=0
 31139                                  	;adc	[HIGH_SECTOR],ax ; 0
 31140                                  	; 24/09/2023
 31141 000050F8 42                      	inc	dx
 31142 000050F9 7504                    	jnz	short loop_zerodir
 31143 000050FB FF06[0706]              	inc	word [HIGH_SECTOR]
 31144                                  loop_zerodir:
 31145 000050FF E2CC                    	LOOP	ZERODIR
 31146                                  
 31147 00005101 A1[4803]                	MOV	AX,[LASTENT]
 31148 00005104 40                      	INC	AX
 31149                                  	; 24/09/2023
 31150                                  	; cf=0
 31151                                  	;CLC
 31152 00005105 C3                      	retn
 31153                                  
 31154                                  ;--------------------------------------------------------------------------
 31155                                  ;
 31156                                  ; Procedure Name : SETDOTENT
 31157                                  ;
 31158                                  ; set up a . or .. directory entry for a directory.
 31159                                  ;
 31160                                  ;   Inputs:     ES:DI point to the beginning of a directory entry.
 31161                                  ;               AX contains ". " or ".."
 31162                                  ;               DX contains first cluster of entry
 31163                                  ;
 31164                                  ;----------------------------------------------------------------------------
 31165                                  
 31166                                  	; 23/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 31167                                  
 31168                                  SETDOTENT:
 31169                                  ;	Fill in name field
 31170 00005106 AB                      	STOSW
 31171 00005107 B90400                  	MOV	CX,4
 31172 0000510A B82020                  	MOV	AX,"  " ; 2020h
 31173 0000510D F3AB                    	REP	STOSW
 31174 0000510F AA                      	STOSB
 31175                                  
 31176                                  ;	Set up attribute
 31177                                  	;mov	al, 10h
 31178 00005110 B010                    	MOV	AL,attr_directory
 31179 00005112 AA                      	STOSB
 31180                                  
 31181                                  ;	Initialize time and date of creation
 31182                                  	;ADD	DI,10
 31183                                  	; 23/04/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 31184                                  	;;;
 31185 00005113 83C708                  	add	di,8
 31186 00005116 A1[F20A]                	mov	ax,[CLUSTERS_HW]
 31187 00005119 AB                      	stosw		; Set up first cluster field (hw)
 31188                                  	;;;	
 31189 0000511A 8B36[9E05]              	MOV	SI,[THISSFT]
 31190                                  	;mov	ax,[si+0Dh]
 31191 0000511E 8B440D                  	MOV	AX,[SI+SF_ENTRY.sf_time]
 31192 00005121 AB                      	STOSW
 31193                                  	;mov	ax,[si+0Fh]
 31194 00005122 8B440F                  	MOV	AX,[SI+SF_ENTRY.sf_date]
 31195 00005125 AB                      	STOSW
 31196                                  
 31197                                  ;	Set up first cluster field (lw)
 31198 00005126 89D0                    	MOV	AX,DX
 31199 00005128 AB                      	STOSW
 31200                                  
 31201                                  ;	0 file size
 31202                                  	;XOR	AX,AX
 31203 00005129 91                      	xchg	ax,cx ; 23/02/2024
 31204 0000512A AB                      	STOSW
 31205 0000512B AB                      	STOSW
 31206 0000512C C3                      	retn
 31207                                  
 31208                                  ;Break   <MAKENODE -- CREATE A NEW NODE>
 31209                                  ;---------------------------------------------------------------------------
 31210                                  ;
 31211                                  ; Procedure Name : MakeNode
 31212                                  ;
 31213                                  ; Inputs:
 31214                                  ;       AL - attribute to create
 31215                                  ;       AH = 0 if it is ok to truncate a file already by this name
 31216                                  ;	AH != 0 if truncation not allowed (prexisting file is an error)
 31217                                  ;               (AH ignored on dirs and devices)
 31218                                  ;
 31219                                  ;        NOTE: When making a DIR or volume ID, AH need not be set since
 31220                                  ;               a name already existant is ALWAYS an error in these cases.
 31221                                  ;
 31222                                  ;       [WFP_START] Points to WFP string ("d:/" must be first 3 chars, NUL
 31223                                  ;               terminated)
 31224                                  ;       [CURR_DIR_END] Points to end of Current dir part of string
 31225                                  ;               ( = -1 if current dir not involved, else
 31226                                  ;                Points to first char after last "/" of current dir part)
 31227                                  ;       [THISCDS] Points to CDS being used
 31228                                  ;       [THISSFT] Points to an empty SFT. EXCEPT sf_mode filled in.
 31229                                  ; Function:
 31230                                  ;       Make a new node
 31231                                  ; Outputs:
 31232                                  ;       Sets EXTERR_LOCUS = errLOC_Disk or errLOC_Unk via GetPathNoset
 31233                                  ;       CARRY SET IF ERROR
 31234                                  ;          AX = 1 A node by this name exists and is a directory
 31235                                  ;          AX = 2 A new node could not be created
 31236                                  ;          AX = 3 A node by this name exists and is a disk file
 31237                                  ;               (AH was NZ on input)
 31238                                  ;          AX = 4 Bad Path
 31239                                  ;               SI return from GetPath maintained
 31240                                  ;          AX = 5 Attribute mismatch
 31241                                  ;          AX = 6 Sharing Violation
 31242                                  ;               (INT 24 generated ALWAYS since create is always compat mode
 31243                                  ;          AX = 7 file not found for Extended Open (not exists and fails)
 31244                                  ;       ELSE
 31245                                  ;          AX = 0 Disk Node
 31246                                  ;          AX = 3 Device Node (error in some cases)
 31247                                  ;          [DIRSTART],[DIRSEC],[CLUSFAC],[CLUSNUM] set to directory
 31248                                  ;               containing new node.
 31249                                  ;          [CURBUF+2]:BX Points to entry
 31250                                  ;          [CURBUF+2]:SI Points to entry.dir_first
 31251                                  ;          [THISSFT] is filled in
 31252                                  ;               sf_mode = unchanged.
 31253                                  ;          Attribute byte in entry is input AL
 31254                                  ; DS preserved, others destroyed
 31255                                  ;
 31256                                  ;-------------------------------------------------------------------------
 31257                                  
 31258                                  ; 19/05/2019 - Retro DOS v4.0
 31259                                  ; DOSCODE:8925h (MSDOS 6.21, MSDOS.SYS)
 31260                                  
 31261                                  ; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 31262                                  ; DOSCODE:88EAh (MSDOS 5.0, MSDOS.SYS)
 31263                                  
 31264                                  ; 23/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 31265                                  ; DOSCODE:951Ah (PCDOS 7.1, IBMDOS.COM)
 31266                                  
 31267                                  MakeNode:
 31268                                  	;mov	word [CREATING],0E5FFh
 31269 0000512D C706[7E05]FFE5          	MOV	WORD [CREATING],DIRFREE*256 + 0FFh ; Creating, not DEL *.*
 31270 00005133 50                      	PUSH	AX 		; Save AH value
 31271 00005134 C606[4C03]00            	MOV	byte [NoSetDir],0
 31272 00005139 A2[6D05]                	MOV	[SATTRIB],AL
 31273 0000513C E88BF8                  	call	GetPathNoSet
 31274 0000513F 88CA                    	MOV	DL,CL		; Save CL info
 31275                                  	;MOV	CX,AX		; Device ID to CH
 31276                                  	; 23/02/2024
 31277 00005141 91                      	xchg	ax,cx
 31278 00005142 58                      	POP	AX		; Get back AH
 31279 00005143 732D                    	JNC	short make_exists ; File existed
 31280 00005145 7505                    	JNZ	short make_err_4 ; Path bad
 31281 00005147 80FA80                  	CMP	DL,80h		; Check "CL" return from GETPATH
 31282 0000514A 7405                    	JZ	short make_type	; Name simply not found, and no metas
 31283                                  make_err_4:
 31284 0000514C B004                    	MOV	AL,4		; case 1 bad path
 31285                                  make_err_ret:
 31286                                  	;XOR	AH,AH
 31287                                  	; 23/02/2024
 31288 0000514E 98                      	cbw
 31289 0000514F F9                      	STC
 31290                                  ;make_retn:	; 22/11/2022
 31291 00005150 C3                      	retn
 31292                                  
 31293                                  	;entry	RENAME_MAKE	; Used by DOS_RENAME to "copy" a node
 31294                                  RENAME_MAKE:
 31295                                  make_type:
 31296                                  ;Extended Open hooks
 31297                                  	; MSDOS 6.0
 31298                                  	;TESTB	EXTOPEN_ON,EXT_OPEN_ON	;FT. from extended open		;AN000;
 31299 00005151 F606[F605]01            	test	byte [EXTOPEN_ON],EXT_OPEN_ON ; 1
 31300 00005156 7411                    	JZ	short make_type2	;FT. no				;AN000;
 31301 00005158 800E[F605]04            	OR	byte [EXTOPEN_ON],EXT_FILE_NOT_EXISTS ; 4
 31302                                  					;FT. set for extended open ;AN000;
 31303                                  	;TESTB	EXTOPEN_FLAG,0F0H	;FT. not exists and fails	;AN000;
 31304 0000515D F606[F405]F0            	test	byte [EXTOPEN_FLAG],0F0h
 31305 00005162 7505                    	JNZ	short make_type2	;FT. no				;AN000;
 31306 00005164 F9                      	STC				;FT. set carry			;AN000;
 31307 00005165 B80700                  	MOV    AX,7			;FT. file not found		;AN000;
 31308                                  	; 22/11/2022
 31309                                  make_retn:
 31310                                  	;return
 31311 00005168 C3                      	retn				;FT.				;AN000;
 31312                                  
 31313                                  ;	Extended Open hooks
 31314                                  
 31315                                  make_type2:
 31316 00005169 C43E[9E05]              	LES	DI,[THISSFT]
 31317 0000516D 31C0                    	XOR	AX,AX		; nothing exists Disk Node
 31318 0000516F F9                      	STC			; Not found
 31319 00005170 EB59                    	JMP	short make_new
 31320                                  
 31321                                  ; The node exists. It may be either a device, directory or file:
 31322                                  ;   Zero set => directory
 31323                                  ;   High bit of CH on => device
 31324                                  ;   else => file
 31325                                  
 31326                                  make_exists:
 31327 00005172 7447                    	JZ	short make_exists_dir
 31328 00005174 B003                    	MOV	AL,3		; file exists type 3  (error or device node)
 31329                                  	;test	byte [ATTRIB],18h
 31330 00005176 F606[6B05]18            	TEST	byte [ATTRIB],attr_volume_id+attr_directory
 31331 0000517B 753A                    	JNZ	short make_err_ret_5
 31332                                  				; Cannot already exist as Disk or Device Node
 31333                                  				;  if making DIR or Volume ID
 31334 0000517D 08ED                    	OR	CH,CH
 31335 0000517F 781A                    	JS	short make_share ; No further checks on attributes if device
 31336 00005181 08E4                    	OR	AH,AH
 31337 00005183 75C9                    	JNZ	short make_err_ret ; truncating NOT OK (AL = 3)
 31338 00005185 51                      	PUSH	CX		; Save device ID
 31339 00005186 8E06[E405]              	MOV	ES,[CURBUF+2]
 31340                                  	;mov	ch,[es:bx+0Bh]
 31341 0000518A 268A6F0B                	MOV	CH,[ES:BX+dir_entry.dir_attr] ; Get file attributes
 31342                                  	;test	ch,1
 31343 0000518E F6C501                  	test	CH,attr_read_only
 31344 00005191 7523                    	JNZ	short make_err_ret_5P ; Cannot create on read only files
 31345 00005193 E858FA                  	call	MatchAttributes
 31346 00005196 59                      	POP	CX		; Devid back in CH
 31347 00005197 751E                    	JNZ	short make_err_ret_5 ; Attributes not ok
 31348 00005199 30C0                    	XOR	AL,AL		; AL = 0, Disk Node
 31349                                  make_share:
 31350                                  	;XOR	AH,AH
 31351                                  	; 23/02/2024
 31352 0000519B 98                      	cbw
 31353 0000519C 50                      	PUSH	AX		; Save Disk or Device node
 31354 0000519D 51                      	PUSH	CX		; Save Device ID
 31355 0000519E 88EC                    	MOV	AH,CH		; Device ID to AH
 31356 000051A0 E83201                  	CALL	DOOPEN		; Fill in SFT for share check
 31357 000051A3 C43E[9E05]              	LES	DI,[THISSFT]
 31358 000051A7 56                      	push	si
 31359 000051A8 53                      	push	bx		; Save CURBUF pointers
 31360 000051A9 E8622F                  	call	ShareEnter
 31361 000051AC 734E                    	jnc	short MakeEndShare
 31362                                  
 31363                                  ; User failed request.
 31364 000051AE 5B                      	pop	bx
 31365 000051AF 5E                      	pop	si
 31366 000051B0 59                      	pop	cx
 31367 000051B1 58                      	pop	ax
 31368                                  
 31369                                  Make_Share_ret:
 31370 000051B2 B006                    	MOV	AL,6
 31371 000051B4 EB98                    	JMP	short make_err_ret
 31372                                  
 31373                                  make_err_ret_5P:
 31374 000051B6 59                      	POP	CX		; Get back device ID
 31375                                  make_err_ret_5:
 31376 000051B7 B005                    	MOV     AL,5		; Attribute mismatch
 31377                                          ; 22/11/2022
 31378 000051B9 EB93                    	JMP	short make_err_ret
 31379                                  
 31380                                  make_exists_dir:
 31381 000051BB B001                    	MOV	AL,1		; exists as directory, always an error
 31382                                  	; 22/11/2022
 31383 000051BD EB8F                    	JMP	short make_err_ret
 31384                                  
 31385                                  make_save:
 31386 000051BF 50                      	PUSH	AX		; Save whether Disk or File
 31387 000051C0 89C8                    	MOV	AX,CX		; Device ID to AH
 31388 000051C2 E86800                  	CALL	NEWENTRY
 31389 000051C5 58                      	POP	AX		; 0 if Disk, 3 if File
 31390 000051C6 73A0                    	jnc	short make_retn
 31391 000051C8 B002                    	MOV	AL,2		; create failed case 2
 31392                                  make_save_retn:
 31393 000051CA C3                      	retn
 31394                                  
 31395                                  make_new:
 31396 000051CB E8F1FF                  	call	make_save
 31397 000051CE 72FA                    	jc	short make_save_retn	; case 2 fail
 31398                                  	;test	byte [ATTRIB],10h
 31399 000051D0 F606[6B05]10            	test	BYTE [ATTRIB],attr_directory
 31400 000051D5 75F3                    	jnz	short make_save_retn	; Don't "open" directories,
 31401                                  					; so don't tell the sharer about them
 31402 000051D7 50                      	push	ax
 31403 000051D8 53                      	push	bx
 31404 000051D9 56                      	push	si
 31405 000051DA E8312F                  	call	ShareEnter
 31406 000051DD 5E                      	pop	si
 31407 000051DE 5B                      	pop	bx
 31408 000051DF 58                      	pop	ax
 31409 000051E0 73E8                    	jnc	short make_save_retn
 31410                                  
 31411                                  ; We get here by having the user FAIL a share problem. Typically a failure of
 31412                                  ; this nature is an out-of-space or an internal error. We clean up as best as
 31413                                  ; possible: delete the newly created directory entry and return share_error.
 31414                                  
 31415 000051E2 50                      	PUSH	AX
 31416 000051E3 C43E[E205]              	LES	DI,[CURBUF]
 31417                                  	;mov	byte [es:bx],0E5h
 31418 000051E7 26C607E5                	MOV	BYTE [ES:BX],DIRFREE	; nuke newly created entry.
 31419                                  
 31420                                  ; 23/02/2024
 31421                                  %if 0	
 31422                                  	; MSDOS 6.0
 31423                                  	;test	byte [es:di+5],40h
 31424                                  	TEST	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty
 31425                                  					;LB. if already dirty		  ;AN000;
 31426                                  	JNZ	short yesdirty8		;LB.  don't increment dirty count ;AN000;
 31427                                  	; 22/11/2022
 31428                                  	call	INC_DIRTY_COUNT		;LB.				  ;AN000;
 31429                                  	;or	byte [es:di+5],40h
 31430                                  	OR	byte [ES:DI+BUFFINFO.buf_flags],buf_dirty ; flag buffer as dirty
 31431                                  yesdirty8:
 31432                                  %else
 31433                                  	; 23/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 31434 000051EB E87616                  	call	SET_BUF_DIRTY
 31435                                  %endif
 31436 000051EE C42E[8A05]              	LES	BP,[THISDPB]
 31437                                  	; 15/12/2022
 31438 000051F2 268A4600                	mov	al,[ES:BP]
 31439                                  	; 22/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 31440                                  	;;mov	al,[es:bp+0]
 31441                                  	;MOV	AL,[ES:BP+DPB.DRIVE]	; get drive for flush
 31442 000051F6 E84515                  	call	FLUSHBUF		; write out buffer.
 31443 000051F9 58                      	POP	AX
 31444 000051FA EBB6                    	jmp	short Make_Share_ret
 31445                                  
 31446                                  ; We have found an existing file. We have also entered it into the share set.
 31447                                  ; At this point we need to call newentry to correctly address the problem of
 31448                                  ; getting rid of old data (create an existing file) or creating a new
 31449                                  ; directory entry (create a new file). Unfortunately, this operation may
 31450                                  ; result in an INT 24 that the user doesn't return from, thus locking the file
 31451                                  ; irretrievably into the share set. The correct solution is for us to LEAVE
 31452                                  ; the share set now, do the operation and then reassert the share access.
 31453                                  ;
 31454                                  ; We are allowed to do this! There is no window! After all, we are in
 31455                                  ; critDisk here and for someone else to get in, they must enter critDisk also.
 31456                                  
 31457                                  	; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 31458                                  	; DOSCODE:89C8h (MSDOS 5.0, MSDOS.SYS)
 31459                                  
 31460                                  MakeEndShare:
 31461 000051FC C43E[9E05]              	LES	DI,[THISSFT]		; grab SFT
 31462 00005200 31C0                    	XOR	AX,AX
 31463 00005202 E87FC6                  	call	ECritSFT
 31464 00005205 268705                  	xchg	AX,[ES:DI]
 31465                                  	;XCHG	AX,[ES:DI+SF_ENTRY.sf_ref_count]
 31466 00005208 50                      	push	ax
 31467 00005209 57                      	push	di
 31468 0000520A 06                      	push	es
 31469 0000520B 9C                      	PUSHF
 31470 0000520C E8FA2E                  	call	ShareEnd		; remove sharing
 31471 0000520F 9D                      	POPF
 31472 00005210 07                      	pop	es
 31473 00005211 5F                      	pop	di
 31474 00005212 268F05                  	pop	word [ES:DI]
 31475                                  	;pop	word [ES:DI+SF_ENTRY.sf_ref_count]
 31476 00005215 E899C6                  	call	LCritSFT
 31477                                  	; 22/11/2022
 31478                                  	; DOSCODE:89E4h (MSDOS 5.0, MSDOS.SYS)
 31479 00005218 5B                      	pop	bx
 31480 00005219 5E                      	pop	si
 31481 0000521A 59                      	pop	cx
 31482 0000521B 58                      	pop	ax
 31483 0000521C E8A0FF                  	CALL	make_save
 31484                                  
 31485                                  ; If the user failed, we do not reenter into the sharing set.
 31486                                  
 31487 0000521F 72A9                    	jc	short make_save_retn	; bye if error
 31488 00005221 50                      	push	ax
 31489 00005222 53                      	push	bx
 31490 00005223 56                      	push	si
 31491 00005224 9C                      	PUSHF
 31492 00005225 E8E62E                  	call	ShareEnter
 31493 00005228 9D                      	POPF
 31494 00005229 5E                      	pop	si
 31495 0000522A 5B                      	pop	bx
 31496 0000522B 58                      	pop	ax
 31497                                  
 31498                                  ; If Share_check fails, then we have an internal ERROR!!!!!
 31499                                  
 31500                                  makeendshare_retn:
 31501 0000522C C3                      	retn
 31502                                  
 31503                                  ;---------------------------------------------------------------------------
 31504                                  ;
 31505                                  ; Procedure Name : NEWENTRY
 31506                                  ;
 31507                                  ; Inputs:
 31508                                  ;	  [THISSFT] set
 31509                                  ;	  [THISDPB] set
 31510                                  ;	  [LASTENT] current last valid entry number in directory if no free
 31511                                  ;		  entries
 31512                                  ;	  [VOLID] set if a volume ID was found during search
 31513                                  ;	Attrib Contains attributes for new file
 31514                                  ;	  [DIRSTART] Points to first cluster of dir (0 means root)
 31515                                  ;	  CARRY FLAG INDICATES STATUS OF SEARCH FOR FILE
 31516                                  ;		  NC means file existed (device)
 31517                                  ;		  C  means file did not exist
 31518                                  ;	  AH = Device ID byte
 31519                                  ;	  If FILE
 31520                                  ;	  [CURBUF+2]:BX points to start of directory entry
 31521                                  ;	  [CURBUF+2]:SI points to dir_first of directory entry
 31522                                  ;	  If device
 31523                                  ;	  DS:BX points to start of "fake" directory entry
 31524                                  ;	  DS:SI points to dir_first of "fake" directory entry
 31525                                  ;		  (has DWORD pointer to device header)
 31526                                  ; Function:
 31527                                  ;	  Make a new directory entry
 31528                                  ;	  If an old one existed it is truncated first
 31529                                  ; Outputs:
 31530                                  ;	  Carry set if error
 31531                                  ;		  Can't grow dir, atts didn't match, attempt to make 2nd
 31532                                  ;		  vol ID, user FAILed to I 24
 31533                                  ;	  else
 31534                                  ;		  outputs of DOOPEN
 31535                                  ; DS, BX, SI preserved (meaning on SI BX, not value), others destroyed
 31536                                  ;
 31537                                  ;----------------------------------------------------------------------------
 31538                                  
 31539                                  	; 22/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 31540                                  	; DOSCODE:89F9h (MSDOS 5.0, MSDOS.SYS)
 31541                                  
 31542                                  	; 23/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 31543                                  	; DOSCODE:961Ah (PCDOS 7.1, IBMDOS.COM)
 31544                                  
 31545                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8A34h)
 31546                                  	; (Windows ME IO.SYS - BIOSCODE:8B7Dh)
 31547                                  
 31548                                  NEWENTRY:
 31549 0000522D C42E[8A05]              	LES	BP,[THISDPB]
 31550 00005231 7315                    	JNC	short EXISTENT	
 31551 00005233 803E[4A03]00            	CMP	byte [FAILERR],0
 31552                                  	;STC
 31553                                  	;jnz	short makeendshare_retn	; User FAILed, node might exist
 31554                                  	; 24/09/2023
 31555 00005238 750C                    	jnz	short ERRRET3
 31556 0000523A E8FBFD                  	CALL	BUILDDIR	; Try to build dir
 31557 0000523D 72ED                    	jc	short makeendshare_retn	; Failed
 31558 0000523F E818F5                  	call	GETENT		; Point at that free entry
 31559 00005242 72E8                    	jc	short makeendshare_retn	; Failed
 31560 00005244 EB0E                    	JMP	SHORT FREESPOT
 31561                                  
 31562                                  ERRRET3:
 31563 00005246 F9                      	STC
 31564                                  newentry_retn:
 31565 00005247 C3                      	retn
 31566                                  
 31567                                  EXISTENT:
 31568 00005248 08E4                    	OR	AH,AH		; Check if file is I/O device
 31569 0000524A 7903                    	JNS	short NOT_DEV1
 31570 0000524C E98600                  	JMP	DOOPEN		; If so, proceed with open
 31571                                  
 31572                                  NOT_DEV1:
 31573 0000524F E83201                  	call	FREEENT	; Free cluster chain
 31574 00005252 72F3                    	jc	short newentry_retn ; Failed
 31575                                  FREESPOT:
 31576                                  	;test	byte [ATTRIB],8
 31577 00005254 F606[6B05]08            	test	BYTE [ATTRIB],attr_volume_id
 31578 00005259 7407                    	JZ	short NOTVOLID
 31579 0000525B 803E[7B05]00            	CMP	BYTE [VOLID],0
 31580 00005260 75E4                    	JNZ	short ERRRET3	; Can't create a second volume ID
 31581                                  NOTVOLID:
 31582 00005262 8E06[E405]              	MOV	ES,[CURBUF+2]
 31583 00005266 89DF                    	MOV	DI,BX
 31584                                  
 31585 00005268 BE[4B05]                	MOV	SI,NAME1
 31586                                  
 31587 0000526B B90500                  	MOV	CX,5
 31588 0000526E F3A5                    	REP	MOVSW
 31589 00005270 A4                      	MOVSB			; Move name into dir entry
 31590 00005271 A0[6B05]                	MOV	AL,[ATTRIB]
 31591 00005274 AA                      	STOSB			; Attributes
 31592                                  
 31593                                  ;; File Tagging for Create DOS 4.00
 31594 00005275 B105                    	MOV	CL,5		;FT. assume normal FBUGBUG	;AN000;
 31595                                  ;; File Tagging for Create DOS 4.00
 31596                                  
 31597 00005277 31C0                    	XOR	AX,AX
 31598 00005279 F3AB                    	REP	STOSW		; Zero pad
 31599 0000527B E8BFB8                  	call	DATE16
 31600 0000527E 92                      	XCHG	AX,DX
 31601 0000527F AB                      	STOSW			; dir_time
 31602 00005280 92                      	XCHG	AX,DX
 31603                                  	; 23/02/2024 (PCDOS 7.1 IBMDOS.COM)
 31604                                  	;;;
 31605 00005281 268945FA                	mov	[es:di-6],ax	; last access date
 31606                                  	;;;
 31607 00005285 AB                      	STOSW			; dir_date
 31608 00005286 31C0                    	XOR	AX,AX
 31609 00005288 57                      	PUSH	DI		; Correct SI input value
 31610                                  				; (recomputed for new buffer)
 31611 00005289 AB                      	STOSW			; Zero dir_first and size
 31612 0000528A AB                      	STOSW
 31613 0000528B AB                      	STOSW
 31614                                  updnxt:
 31615 0000528C 8B36[E205]              	MOV	SI,[CURBUF]
 31616                                  
 31617                                  	; 19/05/2019 - Retro DOS v4.0
 31618                                  
 31619                                  	; MSDOS 6.0
 31620 00005290 26F6440540              	TEST	byte [ES:SI+BUFFINFO.buf_flags],buf_dirty
 31621                                  				;LB. if already dirty		  ;AN000;
 31622 00005295 7508                    	JNZ	short yesdirty9	;LB.  don't increment dirty count ;AN000;
 31623 00005297 E8D615                  	call	INC_DIRTY_COUNT	;LB.				  ;AN000;
 31624                                  	
 31625                                  	;or	byte [es:si+5],40h
 31626 0000529A 26804C0540              	OR	byte [ES:SI+BUFFINFO.buf_flags],buf_dirty
 31627                                  yesdirty9:
 31628 0000529F C42E[8A05]              	LES	BP,[THISDPB]
 31629                                  	; 15/12/2022
 31630 000052A3 268A4600                	MOV	AL,[ES:BP]
 31631                                  	; 22/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 31632                                  	;;mov	al,[es:bp+0]
 31633                                  	;MOV	AL,[ES:BP+DPB.DRIVE] ; Sets AH value again (in AL)
 31634 000052A7 50                      	PUSH	AX
 31635 000052A8 53                      	PUSH	BX
 31636                                  
 31637                                  ; If we have a file, we need to increment the open ref. count so that
 31638                                  ; we have some protection against invalid media changes if an Int 24
 31639                                  ; error occurs.
 31640                                  ; Do nothing for a device.
 31641                                  
 31642 000052A9 06                      	push	es
 31643 000052AA 57                      	push	di
 31644 000052AB C43E[9E05]              	LES	DI,[THISSFT]
 31645                                  	;test	word [es:di+5],80h
 31646                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],devid_device
 31647 000052AF 26F6450580              	test	byte [ES:DI+SF_ENTRY.sf_flags],devid_device
 31648 000052B4 7512                    	jnz	short GotADevice
 31649 000052B6 1E                      	push	ds
 31650 000052B7 53                      	push	bx
 31651 000052B8 C51E[8A05]              	LDS	BX,[THISDPB]
 31652                                  	;mov	[es:di+7],bx
 31653 000052BC 26895D07                	MOV	[ES:DI+SF_ENTRY.sf_devptr],BX
 31654 000052C0 8CDB                    	MOV	BX,DS
 31655                                  	;mov	[es:di+9],bx
 31656 000052C2 26895D09                	MOV	[ES:DI+SF_ENTRY.sf_devptr+2],BX
 31657 000052C6 5B                      	pop	bx
 31658 000052C7 1F                      	pop	ds ; need to use DS for segment later on
 31659                                  
 31660                                  ; 23/02/2024 Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 31661                                  %if 0
 31662                                  	call	DEV_OPEN_SFT	; increment ref. count
 31663                                  	mov	byte [VIRTUAL_OPEN],1; set flag
 31664                                  %endif
 31665                                  
 31666                                  GotADevice:
 31667 000052C8 5F                      	pop	di
 31668 000052C9 07                      	pop	es
 31669                                  
 31670 000052CA E87114                  	call	FLUSHBUF
 31671                                  
 31672                                  ; 23/02/2024 Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 31673                                  %if 0
 31674                                  	Call	CHECK_VIRT_OPEN	; decrement ref. count	;AN000;
 31675                                  %endif
 31676 000052CD 5B                      	POP	BX
 31677 000052CE 58                      	POP	AX
 31678 000052CF 5E                      	POP	SI		; Get SI input back
 31679 000052D0 88C4                    	MOV	AH,AL		; Get I/O driver number back
 31680 000052D2 7301                    	jnc	short DOOPEN	
 31681 000052D4 C3                      	retn			; Failed
 31682                                  	
 31683                                  ;NOTE FALL THROUGH
 31684                                  
 31685                                  ; DOSCODE:8AE4h (MSDOS 6.21, MSDOS.SYS)
 31686                                  
 31687                                  ; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 31688                                  ; DOSCODE:8AA9h (MSDOS 5.0, MSDOS.SYS)
 31689                                  
 31690                                  ; DOOPEN
 31691                                  ;----------------------------------------------------------------------------
 31692                                  ;
 31693                                  ; Inputs:
 31694                                  ;	  [THISDPB] points to DPB if file
 31695                                  ;	  [THISSFT] points to SFT being used
 31696                                  ;	  AH = Device ID byte
 31697                                  ;	  If FILE
 31698                                  ;	  [CURBUF+2]:BX points to start of directory entry
 31699                                  ;	  [CURBUF+2]:SI points to dir_first of directory entry
 31700                                  ;	  If device
 31701                                  ;	  DS:BX points to start of "fake" directory entry
 31702                                  ;	  DS:SI points to dir_first of "fake" directory entry
 31703                                  ;		  (has DWORD pointer to device header)
 31704                                  ; Function:
 31705                                  ;	  Fill in SFT from dir entry
 31706                                  ; Outputs:
 31707                                  ;	  CARRY CLEAR
 31708                                  ;	  sf_ref_count and sf_mode fields not altered
 31709                                  ;	  sf_flags high byte = 0
 31710                                  ;	  sf_flags low byte = AH except
 31711                                  ;	  sf_flags Bit 6 set (not dirty or not EOF)
 31712                                  ;	  sf_attr sf_date sf_time sf_name set from entry
 31713                                  ;	  sf_position = 0
 31714                                  ;	  If device
 31715                                  ;	  sf_devptr = dword at dir_first (pointer to device header)
 31716                                  ;	  sf_size = 0
 31717                                  ;	  If file
 31718                                  ;	  sf_firclus sf_size set from entry
 31719                                  ;	  sf_devptr = [THISDPB]
 31720                                  ;	  sf_cluspos = 0
 31721                                  ;	  sf_lstclus = sf_firclus
 31722                                  ;	  sf_dirsec sf_dirpos set
 31723                                  ; DS,SI,BX preserved, others destroyed
 31724                                  ;
 31725                                  ;----------------------------------------------------------------------------
 31726                                  
 31727                                  	; 23/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 31728                                  	; DOSCODE:96C3h (PCDOS 7.1, IBMDOS.COM)
 31729                                  
 31730                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8AE4h)
 31731                                  	; (Windows ME IO.SYS - BIOSCODE:8C4Ch)
 31732                                  
 31733                                  	;entry	DOOPEN
 31734                                  DOOPEN:
 31735                                  ;	Generate and store attribute
 31736                                  
 31737 000052D5 88E6                    	MOV	DH,AH	  	; AH to different place
 31738                                  	; 23/02/2024 (PCDOS 7.1 IBMDOS.COM)
 31739                                  	;;;
 31740 000052D7 30D2                    	xor	dl,dl ; 0
 31741 000052D9 08E4                    	or	ah,ah
 31742 000052DB 780D                    	js	short DEV_SFT0
 31743 000052DD C43E[8A05]              	les	di,[THISDPB]
 31744                                  	;cmp	word [es:di+0Fh],0
 31745 000052E1 26837D0F00              	cmp	word [es:di+DPB.FAT_SIZE],0
 31746 000052E6 7402                    	jz	short DEV_SFT0 ; FAT32
 31747 000052E8 FEC2                    	inc	dl ; 1	
 31748                                  DEV_SFT0:
 31749                                  	;;;
 31750 000052EA C43E[9E05]              	LES	DI,[THISSFT]
 31751                                  	;add	di,4
 31752 000052EE 83C704                  	ADD	DI,SF_ENTRY.sf_attr ; Skip ref_count and mode fields
 31753                                  	; 24/09/2023
 31754 000052F1 31C0                    	xor	ax,ax
 31755                                  	;XOR	AL,AL		; Assume it's a device, devices have an
 31756                                  				;  attribute of 0 (for R/O testing etc).
 31757 000052F3 08F6                    	OR	DH,DH		; See if our assumption good.
 31758 000052F5 7807                    	JS	short DEV_SFT1	; If device DS=DOSGROUP
 31759 000052F7 8E1E[E405]              	MOV	DS,[CURBUF+2]
 31760                                  	;mov	al,[BX+0Bh]
 31761 000052FB 8A470B                  	MOV	AL,[BX+dir_entry.dir_attr]
 31762                                  				; If file, get attrib from dir entry
 31763                                  DEV_SFT1:
 31764 000052FE AA                      	STOSB			; sf_attr, ES:DI -> sf_flags
 31765                                  
 31766                                  ;	Generate and store flags word
 31767                                  
 31768                                  	; 24/09/2023
 31769                                  	;XOR	AX,AX
 31770                                  	; ah=0
 31771 000052FF 88F0                    	MOV	AL,DH
 31772                                  	;or	al,40h
 31773 00005301 0C40                    	OR	AL,devid_file_clean
 31774 00005303 AB                      	STOSW			; sf_flags, ES:DI -> sf_devptr
 31775                                  
 31776                                  ;	Generate and store device pointer
 31777                                  
 31778 00005304 1E                      	PUSH	DS
 31779                                  	;lds	ax,[bx+1Ah]
 31780 00005305 C5471A                  	LDS	AX,[BX+dir_entry.dir_first] ; Assume device
 31781 00005308 08F6                    	OR	DH,DH
 31782 0000530A 7805                    	JS	short DEV_SFT2
 31783                                  
 31784                                  ;hkn; SS override
 31785 0000530C 36C506[8A05]            	LDS	AX,[SS:THISDPB]	; Was file
 31786                                  DEV_SFT2:
 31787 00005311 AB                      	STOSW			; store offset
 31788 00005312 8CD8                    	MOV	AX,DS
 31789 00005314 1F                      	POP	DS
 31790 00005315 AB                      	STOSW			; store segment
 31791                                  				; ES:DI -> sf_firclus
 31792                                  
 31793                                  ;	Generate pointer to, generate and store first cluster
 31794                                  ;	(irrelevant for devices)
 31795                                  
 31796 00005316 56                      	PUSH	SI		; Save pointer to dir_first
 31797                                  
 31798                                  ; 23/02/2024
 31799                                  %if 0
 31800                                  
 31801                                  	MOVSW			; dir_first -> sf_firclus
 31802                                  				; DS:SI -> dir_size_l, ES:DI -> sf_time
 31803                                  
 31804                                  ;	Copy time/date of last modification
 31805                                  
 31806                                  	;sub	si,6
 31807                                  	SUB	SI,dir_entry.dir_size_l - dir_entry.dir_time
 31808                                  %else
 31809                                  	; 23/02/2024 - Retro DOS v5.0
 31810                                  	; (PCDOS 7.1 IBMDOS.COM)
 31811                                  	;;;
 31812 00005317 83C720                  	add	di,32		; SF_ENTRY.sf_chain ; first cluster (32 bit) !?
 31813 0000531A A5                      	movsw			; first cluster, lw
 31814                                  	;add	si,0FFF8h
 31815 0000531B 83C6F8                  	add	si,-8
 31816 0000531E AD                      	lodsw	; 27/06/2024	; first cluster, hw
 31817                                  	;
 31818 0000531F 08D2                    	or	dl,dl
 31819 00005321 7402                    	jz	short FILE_SFT0 ; FAT32
 31820 00005323 31C0                    	xor	ax,ax ; 0	; clear hw of first cluster (invalid)
 31821                                  FILE_SFT0:
 31822 00005325 AB                      	stosw
 31823                                  	;add	di,0FFDEh
 31824 00005326 83C7DE                  	add	di,-34		; SF_ENTRY.sf_time
 31825                                  	;;;	
 31826                                  %endif
 31827                                  				; DS:SI->dir_time
 31828 00005329 A5                      	MOVSW			; dir_time -> sf_time
 31829                                  				; DS:SI -> dir_date, ES:DI -> sf_date
 31830 0000532A A5                      	MOVSW			; dir_date -> sf_date
 31831                                  				; DS:SI -> dir_first, ES:DI -> sf_size
 31832                                  
 31833                                  ;	Generate and store file size (0 for devices)
 31834                                  
 31835 0000532B AD                      	LODSW			; skip dir_first, DS:SI -> dir_size_l
 31836 0000532C AD                      	LODSW			; dir_size_l in AX, DS:SI -> dir_size_h
 31837                                  	;MOV	CX,AX		; dir_size_l in CX
 31838                                  	; 23/02/2024
 31839 0000532D 91                      	xchg	ax,cx
 31840 0000532E AD                      	LODSW			; dir_size_h (size AX:CX), DS:SI -> ????
 31841 0000532F 08F6                    	OR	DH,DH
 31842 00005331 7904                    	JNS	short FILE_SFT1
 31843 00005333 31C0                    	XOR	AX,AX
 31844 00005335 89C1                    	MOV	CX,AX		; Devices are open ended
 31845                                  FILE_SFT1:
 31846 00005337 91                      	XCHG	AX,CX
 31847 00005338 AB                      	STOSW			; Low word of sf_size
 31848 00005339 91                      	XCHG	AX,CX
 31849 0000533A AB                      	STOSW			; High word of sf_size
 31850                                  				; ES:DI -> sf_position
 31851                                  ; Initialize position to 0
 31852                                  
 31853 0000533B 31C0                    	XOR	AX,AX
 31854 0000533D AB                      	STOSW
 31855 0000533E AB                      	STOSW			; sf_position
 31856                                  				; ES:DI -> sf_cluspos
 31857                                  
 31858                                  ; Generate cluster optimizations for files
 31859                                  
 31860 0000533F 08F6                    	OR	DH,DH
 31861 00005341 7833                    	JS	short DEV_SFT3
 31862 00005343 AB                      	STOSW			; sf_cluspos ; 19h
 31863                                  
 31864                                  ; 23/02/2024
 31865                                  %if 0
 31866                                  	;mov	ax,[bx+1Ah]
 31867                                  	MOV	AX,[BX+dir_entry.dir_first]
 31868                                  	; 19/05/2019
 31869                                  	; MSDOS 3.3
 31870                                  	;STOSW			; sf_lstclus ; 1Bh
 31871                                  	; MSDOS 6.0
 31872                                  	PUSH	DI		;AN004; save dirsec offset
 31873                                  	;sub	di,1Bh
 31874                                  	SUB	DI,SF_ENTRY.sf_dirsec	;AN004; es:di -> SFT
 31875                                  	;mov	[es:di+35h],ax
 31876                                  	MOV	[ES:DI+SF_ENTRY.sf_lstclus],AX	;AN004; save it
 31877                                  	POP	DI		;AN004; restore dirsec offset
 31878                                  %else
 31879                                  	; 23/02/2024 - Retro DOS v5.0
 31880                                  	; (PCDOS 7.1 IBMDOS.COM)
 31881                                  	;;;
 31882                                  	;add	di,0FFF0h
 31883 00005344 83C7F0                  	add	di,-16
 31884 00005347 AB                      	stosw			; sf_cluspos_h (sf_firclus in MSDOS 5.0-6.22)
 31885                                  	;add	di,SF_ENTRY.sf_dirsec
 31886 00005348 83C70E                  	add	di,14		; sf_dirsec ; 27
 31887 0000534B 268B4510                	mov	ax,[es:di+10h]	; [ES:DI+SF_ENTRY.sf_chain] ; 43
 31888                                  				; first cluster (32 bit)
 31889 0000534F 2689451A                	mov	[es:di+1Ah],ax
 31890                                  	;mov	[es:di+SF_ENTRY.sf_lstclus-SF_ENTRY.sf_dirsec],ax ; 53
 31891 00005353 268B4512                	mov	ax,[es:di+12h]	; [ES:DI+SF_ENTRY.sf_chain+2] ; 45
 31892 00005357 2689451C                	mov	[es:di+1Ch],ax
 31893                                  	;mov	[es:di+SF_ENTRY.sf_lstclus+2-SF_ENTRY.sf_dirsec],ax ; 55
 31894                                  	;;;
 31895                                  %endif
 31896                                  
 31897                                  ; DOS 3.3  FastOpen  6/13/86
 31898                                  
 31899                                  ; 03/03/2025 (MiniDOS)
 31900                                  %if 0
 31901                                  	PUSH	DS
 31902                                  
 31903                                  ;hkn; SS is DOSDATA
 31904                                  	push	ss
 31905                                  	pop	ds
 31906                                  	;test	byte [FastOpenFlg],4
 31907                                  	TEST	byte [FastOpenFlg],Special_Fill_Set
 31908                                  	JZ	short Not_FastOpen
 31909                                  
 31910                                  ;hkn; FastOpen_Ext_Info is in DOSDATA
 31911                                  	MOV	SI,FastOpen_Ext_Info
 31912                                  
 31913                                  	;mov	ax,[si+1]
 31914                                  	MOV	AX,[SI+FEI.dirsec]
 31915                                  	STOSW		  	; sf_dirsec
 31916                                  	; MSDOS 6.0
 31917                                  	;mov	ax,[si+3]
 31918                                  	MOV	AX,[SI+FEI.dirsec+2]
 31919                                  		;;; changed for >32mb
 31920                                  	STOSW		  	; sf_dirsec
 31921                                  	; 19/08//2018
 31922                                  	mov	al,[SI]
 31923                                  	;MOV	AL,[SI+FEI.dirpos] ; mov al,[SI+0]
 31924                                  	STOSB		  	; sf_dirpos
 31925                                  	POP	DS
 31926                                  	;JMP	short Next_Name
 31927                                  	; 24/09/2023
 31928                                  	jmp	short FILE_SFT2	; cf=0 (after 'test' instruction)
 31929                                  
 31930                                  ; DOS 3.3  FastOpen  6/13/86
 31931                                  
 31932                                  Not_FastOpen:
 31933                                  	;POP	DS		; normal path
 31934                                  
 31935                                  ;hkn; SS override
 31936                                  	;MOV	SI,[SS:CURBUF]	; DS:SI->buffer header
 31937                                  	; 16/12/2022
 31938                                  	; 28/07/2019
 31939                                  	mov	si,[CURBUF]
 31940                                  	pop	ds
 31941                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 31942                                  	;pop	ds
 31943                                  %endif
 31944                                  	; 03/03/2025;(MiniDOS)
 31945 0000535B 368B36[E205]            	mov	si,[ss:CURBUF]
 31946                                  	
 31947                                  	;mov	ax,[si+6]
 31948 00005360 8B4406                  	MOV	AX,[SI+BUFFINFO.buf_sector]	;F.C. >32mb ;AN000;
 31949 00005363 AB                      	STOSW		  	; sf_dirsec	;F.C. >32mb ;AN000;
 31950                                  	; 19/05/2019	
 31951                                  	; MSDOS 6.0
 31952                                  	;mov	ax,[si+8]
 31953 00005364 8B4408                  	MOV	AX,[SI+BUFFINFO.buf_sector+2]	;F.C. >32mb ;AN000;
 31954 00005367 AB                      	STOSW		  	; sf_dirsec	;F.C. >32mb ;AN000;
 31955                                  	
 31956 00005368 89D8                    	MOV	AX,BX
 31957                                  	;;;add	si,16	; MSDOS 3.3
 31958                                  	;;add	si,20	; MSDOS 6.0
 31959                                  	;add	si,24	; PCDOS 7.1 ; 23/02/2024
 31960 0000536A 83C618                  	ADD	SI,BUFINSIZ	; DS:SI-> start of data in buffer
 31961 0000536D 29F0                    	SUB	AX,SI		; AX = BX relative to start of sector
 31962                                  	;mov	cl,32
 31963 0000536F B120                    	MOV	CL,dir_entry.size
 31964 00005371 F6F1                    	DIV	CL
 31965 00005373 AA                      	STOSB		  	; sf_dirpos
 31966                                  Next_Name:
 31967 00005374 EB03                    	JMP	SHORT FILE_SFT2
 31968                                  
 31969                                  	; 24/09/2023
 31970                                  	; cf=0 (after 'or' instruction)
 31971                                  DEV_SFT3:
 31972                                  	;add	di,7
 31973 00005376 83C707                  	ADD	DI,SF_ENTRY.sf_name-SF_ENTRY.sf_cluspos
 31974                                  FILE_SFT2:
 31975                                  
 31976                                  ; Copy in the object's name
 31977                                  
 31978 00005379 89DE                    	MOV	SI,BX		; DS:SI points to dir_name
 31979 0000537B B90B00                  	MOV	CX,11
 31980 0000537E F3A4                    	REP	MOVSB		; sf_name
 31981 00005380 5E                      	POP	SI		; recover DS:SI -> dir_first
 31982                                  
 31983                                  ;hkn; SS is DOSDATA
 31984 00005381 16                      	push	ss
 31985 00005382 1F                      	pop	ds
 31986                                  	; 24/09/2023
 31987                                  	; cf=0
 31988                                  	;CLC
 31989 00005383 C3                      	retn
 31990                                  
 31991                                  ;---------------------------------------------------------------------------
 31992                                  ;
 31993                                  ; Procedure Name : FREEENT
 31994                                  ;
 31995                                  ; Inputs:
 31996                                  ;	  ES:BP -> DPB
 31997                                  ;	  [CURBUF] Set
 31998                                  ;	  [CURBUF+2]:BX points to directory entry
 31999                                  ;	  [CURBUF+2]:SI points to above dir_first
 32000                                  ; Function:
 32001                                  ;	  Free the cluster chain for the entry if present
 32002                                  ; Outputs:
 32003                                  ;	  Carry set if error (currently user FAILed to I 24)
 32004                                  ;	  (NOTE dir_firclus and dir_size_l/h are wrong)
 32005                                  ; DS BX SI ES BP preserved (BX,SI in meaning, not value) others destroyed
 32006                                  ;---------------------------------------------------------------------------
 32007                                  
 32008                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 32009                                  	; 24/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32010                                  
 32011                                  FREEENT:
 32012 00005384 1E                      	PUSH	DS
 32013 00005385 C53E[E205]              	LDS	DI,[CURBUF]
 32014 00005389 8B0C                    	MOV	CX,[SI]		; Get pointer to clusters
 32015                                  	; 24/02/2023 (PCDOS 7.1 IBMDOS.COM)
 32016                                  	;;;
 32017 0000538B 8B44FA                  	mov	ax,[si-6]	; hw of first cluster (dir_first)
 32018                                  	;;;
 32019                                  	; 19/05/2019 - Retro DOS v4.0
 32020                                  	; MSDOS 6.0
 32021                                  	;mov	dx,[di+8] ; 24/02/2024
 32022 0000538E 8B5508                  	MOV	DX,[DI+BUFFINFO.buf_sector+2] ;F.C. >32mb  ;AN000;
 32023                                  ;hkn; SS override
 32024 00005391 368916[0706]            	MOV	[SS:HIGH_SECTOR],DX	      ;F.C. >32mb  ;AN000;
 32025                                  	;mov	dx,[di+6] ; 24/02/2024
 32026 00005396 8B5506                  	MOV	DX,[DI+BUFFINFO.buf_sector]
 32027 00005399 1F                      	POP	DS
 32028                                  
 32029                                  	; 24/02/2023 (PCDOS 7.1 IBMDOS.COM)
 32030                                  	;;;
 32031                                  	;cmp	word [bp+0Fh],0
 32032 0000539A 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 32033 0000539F 7515                    	jnz	short freeent2	; not FAT32
 32034                                  	;cmp	ax,0
 32035 000053A1 09C0                    	or	ax,ax
 32036 000053A3 7505                    	jnz	short freeent1
 32037                                  	;
 32038 000053A5 83F902                  	cmp	cx,2
 32039 000053A8 7242                    	jb	short RET1	; Was 0 length file (or mucked Firclus if AX:CX=1)
 32040                                  freeent1:
 32041                                  	;cmp	ax,[es:bp+2Fh]
 32042 000053AA 263B462F                	cmp	ax,[es:bp+DPB.LAST_CLUSTER+2]
 32043 000053AE 7511                    	jne	short freeent3
 32044                                  	;cmp	cx,[es:bp+2Dh]
 32045 000053B0 263B4E2D                	cmp	cx,[es:bp+DPB.LAST_CLUSTER]
 32046 000053B4 EB0B                    	jmp	short freeent3
 32047                                  freeent2:
 32048 000053B6 31C0                    	xor	ax,ax
 32049                                  	;;;
 32050                                  
 32051 000053B8 83F902                  	CMP	CX,2
 32052 000053BB 722F                    	JB	short RET1	; Was 0 length file (or mucked Firclus if CX=1)
 32053                                  
 32054                                  	;cmp	cx,[es:bp+0Dh]
 32055 000053BD 263B4E0D                	CMP	CX,[ES:BP+DPB.MAX_CLUSTER]
 32056                                  freeent3:	; 24/02/2024
 32057                                  	;JA	short RET1	; Treat like zero length file (firclus mucked)
 32058 000053C1 7718                    	ja	short freeent_retn ; 24/02/2024
 32059 000053C3 29FB                    	SUB	BX,DI
 32060 000053C5 53                      	PUSH	BX		; Save offset
 32061 000053C6 FF36[0706]              	PUSH	word [HIGH_SECTOR] ;F.C. >32mb	;AN000;
 32062 000053CA 52                      	PUSH	DX		; Save sector number
 32063 000053CB 89CB                    	MOV	BX,CX
 32064                                  	; 24/02/2023 (PCDOS 7.1 IBMDOS.COM)
 32065                                  	;;;
 32066 000053CD A3[E80A]                	mov	[CLUSTNUM_HW],ax
 32067                                  	;;;
 32068 000053D0 E8A304                  	call	RELEASE		; Free any data allocated
 32069 000053D3 5A                      	POP	DX
 32070 000053D4 8F06[0706]              	POP	word [HIGH_SECTOR] ;F.C. >32mb	;AN000;
 32071 000053D8 7302                    	JNC	short GET_BUF_BACK
 32072 000053DA 5B                      	POP	BX
 32073                                  freeent_retn:
 32074 000053DB C3                      	retn			; Screw up
 32075                                  
 32076                                  GET_BUF_BACK:
 32077                                  	; 22/09/2023
 32078                                  	;;mov	byte [ALLOWED],18h
 32079                                  	;MOV	byte [ALLOWED],Allowed_RETRY+Allowed_FAIL ; *
 32080                                  	;XOR	AL,AL ; *
 32081                                  	;call	GETBUFFR	; Get sector back
 32082 000053DC E8F011                  	call	GETBUFFER ; *	; pre read
 32083                                  
 32084 000053DF 5B                      	POP	BX		; Get offset back
 32085 000053E0 72F9                    	jc	short freeent_retn
 32086 000053E2 E86AEA                  	call	SET_BUF_AS_DIR
 32087 000053E5 031E[E205]              	ADD	BX,[CURBUF]	; Correct it for new buffer
 32088                                  
 32089                                  	;MOV	SI,BX
 32090                                  	;;add	si,1Ah
 32091                                  	;ADD	SI,dir_entry.dir_first	; Get corrected SI
 32092                                  	; 24/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32093                                  	;lea	si,[bx+1Ah]
 32094 000053E9 8D771A                  	lea	si,[bx+dir_entry.dir_first]
 32095                                  RET1:
 32096 000053EC F8                      	CLC
 32097 000053ED C3                      	retn
 32098                                  
 32099                                  ; 23/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32100                                  %if 0
 32101                                  
 32102                                  ;---------------------------------------------------------------------------
 32103                                  ;
 32104                                  ; Procedure Name : CHECK_VIRT_OPEN
 32105                                  ;
 32106                                  ; CHECK_VIRT_OPEN checks to see if we had performed a "virtual open" (by
 32107                                  ; examining the flag [VIRTUAL_OPEN] to see if it is 1). If we did, then
 32108                                  ; it calls Dev_Close_SFT to decrement the ref. count. It also resets the
 32109                                  ; flag [VIRTUAL_OPEN].
 32110                                  ; No registers affected (including flags).
 32111                                  ; On input, [THISSFT] points to current SFT.
 32112                                  ;
 32113                                  ;---------------------------------------------------------------------------
 32114                                  
 32115                                  CHECK_VIRT_OPEN:
 32116                                  	PUSH	AX
 32117                                  	lahf			; preserve flags
 32118                                  	CMP	byte [VIRTUAL_OPEN],0
 32119                                  	JZ	short ALL_CLOSED
 32120                                  	mov	byte [VIRTUAL_OPEN],0 ; reset flag
 32121                                  	push	es
 32122                                  	push	di
 32123                                  	LES	DI,[THISSFT]
 32124                                  	call	DEV_CLOSE_SFT
 32125                                  	pop	di
 32126                                  	pop	es
 32127                                  
 32128                                  ALL_CLOSED:
 32129                                  	sahf			; restore flags
 32130                                  	POP	AX
 32131                                  	retn
 32132                                  
 32133                                  %endif
 32134                                  
 32135                                  ;============================================================================
 32136                                  ; ROM.ASM, MSDOS 6.0, 1991
 32137                                  ;============================================================================
 32138                                  ; 29/07/2018 - Retro DOS v3.0
 32139                                  ; 20/05/2019 - Retro DOS v4.0
 32140                                  ; 10/02/2024 - Retro DOS v5.0
 32141                                  
 32142                                  ;	TITLE	ROM - Miscellaneous routines
 32143                                  ;	NAME	ROM
 32144                                  
 32145                                  ;**	Misc Low level routines for doing simple FCB computations, Cache
 32146                                  ;       reads and writes, I/O optimization, and FAT allocation/deallocation
 32147                                  ;
 32148                                  ;	SKPCLP
 32149                                  ;	FNDCLUS
 32150                                  ;	BUFSEC
 32151                                  ;	BUFRD
 32152                                  ;	BUFWRT
 32153                                  ;	NEXTSEC
 32154                                  ;	OPTIMIZE
 32155                                  ;	FIGREC
 32156                                  ;	ALLOCATE
 32157                                  ;	RESTFATBYT
 32158                                  ;	RELEASE
 32159                                  ;	RELBLKS
 32160                                  ;	GETEOF
 32161                                  ;
 32162                                  ;	Modification history:
 32163                                  ;
 32164                                  ;		Created: ARR 30 March 1983
 32165                                  ;               M039: DB 10/25/90 - Disk read/write optimization.
 32166                                  
 32167                                  ;Break   <FNDCLUS -- Skip over allocation units>
 32168                                  ;--------------------------------------------------------------------------
 32169                                  ;
 32170                                  ; Procedure Name : FNDCLUS
 32171                                  ;
 32172                                  ; Inputs:
 32173                                  ;       CX = No. of clusters to skip
 32174                                  ;       ES:BP = Base of drive parameters
 32175                                  ;       [THISSFT] point to SFT
 32176                                  ; Outputs:
 32177                                  ;       BX = Last cluster skipped to
 32178                                  ;       CX = No. of clusters remaining (0 unless EOF)
 32179                                  ;       DX = Position of last cluster
 32180                                  ;       Carry set if error (currently user FAILed to I 24)
 32181                                  ; DI destroyed. No other registers affected.
 32182                                  ;--------------------------------------------------------------------------
 32183                                  
 32184                                  	;;;
 32185                                  	; 10/02/2024 - Retro DOS v5.0
 32186                                  	; (PCDOS 7.1 IBMDOS.COM)
 32187                                  FNDCLUS_X:
 32188 000053EE 8B0E[BC05]              	mov	cx,[CLUSNUM]
 32189 000053F2 8B16[DE0A]              	mov	dx,[CLUSNUM_HW]
 32190                                  	;;;
 32191                                  
 32192                                  ; 20/05/2019 - Retro DOS v4.0
 32193                                  ; DOSCODE:8BF2h (MSDOS 6.21, MSDOS.SYS)
 32194                                  ; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 32195                                  ; DOSCODE:8BB7h (MSDOS 5.0, MSDOS.SYS)
 32196                                  
 32197                                  ; 25/02/2024
 32198                                  ; 10/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32199                                  ; DOSCODE:9801h (PCDOS 7.1 IBMDOS.COM)
 32200                                  
 32201                                  FNDCLUS:
 32202 000053F6 06                      	PUSH	ES
 32203 000053F7 C43E[9E05]                      LES     DI,[THISSFT]		; setup addressability to SFT
 32204                                  
 32205                                  	;;;
 32206                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32207 000053FB 8916[F80A]              	mov	[CLSKIP_HW],dx
 32208                                  	;mov	bx,[es:di+37h]
 32209 000053FF 268B5D37                	mov	bx,[es:di+SF_ENTRY.sf_lstclus+2] ; 24/02/2024
 32210 00005403 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 32211 00005407 09DB                    	or	bx,bx ; *
 32212 00005409 268B550B                	mov	dx,[es:di+0Bh] ; [ES:DI+SF_ENTRY.sf_firclus] ; MSDOS 5.0-6.22
 32213                                          ;mov	dx,[es:di+SF_ENTRY.sf_cluspos_hw] ; PCDOS 7.1
 32214 0000540D 8916[E20A]              	mov	[LASTPOS_HW],dx
 32215                                  	;;;
 32216                                  	
 32217                                  	;;mov	bx,[es:di+1Bh] ; MSDOS 3.3
 32218                                  	;mov	bx,[es:di+35h] ; MSDOS 6.0
 32219 00005411 268B5D35                	MOV	BX,[ES:DI+SF_ENTRY.sf_lstclus]
 32220                                  	;mov	dx,[es:di+19h]
 32221 00005415 268B5519                        MOV     DX,[ES:DI+SF_ENTRY.sf_cluspos]
 32222                                  	; 10/02/2024
 32223                                  	;OR	BX,BX
 32224                                  	;JZ	short NOCLUS
 32225                                  	;;;
 32226                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32227 00005419 7506                    	jnz	short fndclus_1 ; *
 32228 0000541B 09DB                    	or	bx,bx
 32229 0000541D 7502                    	jnz	short fndclus_1
 32230 0000541F EB6A                    	jmp	NOCLUS
 32231                                  
 32232                                  fndclus_1:
 32233                                  	;;;
 32234                                  
 32235                                  ; 10/02/2024
 32236                                  %if 0	
 32237                                          SUB	CX,DX
 32238                                          JNB	short FINDIT
 32239                                  	ADD	CX,DX
 32240                                  	XOR	DX,DX
 32241                                  	;mov	bx,[es:di+0Bh]
 32242                                  	MOV	BX,[ES:DI+SF_ENTRY.sf_firclus]
 32243                                  FINDIT:
 32244                                          POP	ES
 32245                                  	JCXZ	RET9
 32246                                  %else
 32247                                  	;;;
 32248                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32249 00005421 29D1                    	sub	cx,dx
 32250 00005423 50                      	push	ax
 32251 00005424 A1[E20A]                	mov	ax,[LASTPOS_HW]
 32252 00005427 1906[F80A]              	sbb	[CLSKIP_HW],ax
 32253 0000542B 58                      	pop	ax
 32254 0000542C 731C                    	jnb	short FINDIT
 32255 0000542E 8B1E[E20A]              	mov	bx,[LASTPOS_HW]
 32256 00005432 01D1                    	add	cx,dx
 32257 00005434 111E[F80A]              	adc	[CLSKIP_HW],bx
 32258 00005438 31D2                    	xor	dx,dx
 32259 0000543A 8916[E20A]              	mov	[LASTPOS_HW],dx ; 0
 32260 0000543E 268B5D2D                	mov	bx,[es:di+2Dh]	; [ES:DI+SF_ENTRY.sf_chain+2] ; MSDOS 5.0-6.22
 32261                                  				; [ES:DI+SF_ENTRY.sf_fcluster+2] ; PCDOS 7.1
 32262 00005442 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 32263 00005446 268B5D2B                	mov	bx,[es:di+2Bh]	; [ES:DI+SF_ENTRY.sf_chain] ; MSDOS 5.0-6.22
 32264                                  				; [ES:DI+SF_ENTRY.sf_fcluster] ; PCDOS 7.1
 32265                                  FINDIT:
 32266 0000544A 07                      	pop	es
 32267 0000544B 3B0E[F80A]              	cmp	cx,[CLSKIP_HW]
 32268 0000544F 7502                    	jnz	short SKPCLP
 32269 00005451 E337                    	jcxz	RET9	 ; cf=0
 32270                                  	;;;
 32271                                  %endif
 32272                                  
 32273                                  	;entry	SKPCLP
 32274                                  SKPCLP:
 32275                                  
 32276                                  ; 10/02/2024
 32277                                  %if 0
 32278                                  	call	UNPACK
 32279                                          jc	short fndclus_retn	; retc
 32280                                  
 32281                                  	; 09/09/2018
 32282                                  
 32283                                  	; MSDOS 3.3
 32284                                  	;push	bx
 32285                                  	;mov	bx,di
 32286                                  	;call	IsEOF
 32287                                  	;pop	bx	
 32288                                  	;jae	short RET9
 32289                                  
 32290                                  	; 20/05/2019 - Retro DOS v4.0
 32291                                  
 32292                                  	; MSDOS 6.0
 32293                                  	xchg	bx,di
 32294                                  	call	IsEOF
 32295                                  	xchg	bx,di
 32296                                  	jae	short RET9
 32297                                  
 32298                                          XCHG    BX,DI
 32299                                          INC     DX
 32300                                  
 32301                                  	LOOP	SKPCLP			; RMFS
 32302                                  %else
 32303                                  	;;;
 32304                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32305                                  
 32306                                  	;push	word [LASTPOS_HW]
 32307                                  	;push	dx
 32308                                  	;push	word [CLSKIP_HW]
 32309                                  	;push	cx
 32310                                  
 32311 00005453 E8310B                  	call	UNPACK
 32312                                  
 32313                                  	;pop	cx
 32314                                  	;pop	word [CLSKIP_HW]
 32315                                  	;pop	dx
 32316                                  	;pop	word [LASTPOS_HW]
 32317                                  	
 32318 00005456 7242                    	jc	short fndclus_retn
 32319                                  
 32320 00005458 FF36[E80A]              	push	word [CLUSTNUM_HW]
 32321 0000545C 53                      	push	bx
 32322 0000545D 89FB                    	mov	bx,di
 32323 0000545F 8B3E[EC0A]              	mov	di,[CCONTENT_HW]
 32324 00005463 893E[E80A]              	mov	[CLUSTNUM_HW],di
 32325 00005467 E8F40A                  	call	IsEOF
 32326 0000546A 7206                    	jc	short SKPCLP2
 32327 0000546C 5B                      	pop	bx
 32328 0000546D 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 32329                                  	;jmp	short RET9
 32330                                  	; 25/02/2024
 32331 00005471 C3                      	retn
 32332                                  
 32333                                  SKPCLP2:
 32334 00005472 83C404                  	add	sp,4
 32335 00005475 42                      	inc	dx
 32336 00005476 7504                    	jnz	short SKPCLP3
 32337 00005478 FF06[E20A]              	inc	word [LASTPOS_HW]
 32338                                  SKPCLP3:
 32339 0000547C 83E901                  	sub	cx,1
 32340 0000547F 831E[F80A]00            	sbb	word [CLSKIP_HW],0
 32341 00005484 75CD                    	jnz	short SKPCLP		; loop
 32342 00005486 09C9                    	or	cx,cx
 32343 00005488 75C9                    	jnz	short SKPCLP		; loop
 32344                                  	;;;
 32345                                  %endif
 32346                                  
 32347                                  RET9:	
 32348                                  	;CLC
 32349                                  	; 25/02/2024
 32350                                  	; cf=0
 32351 0000548A C3                      	retn
 32352                                  
 32353                                  NOCLUS:
 32354 0000548B 07                              POP	ES
 32355                                  
 32356                                  ; 10/02/2024
 32357                                  %if 0
 32358                                          INC	CX
 32359                                          DEC	DX
 32360                                  %else
 32361                                  	;;;
 32362                                  	; 10/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32363                                  	;push	di
 32364                                  	;xor	di,di ; 0
 32365                                  	;add	cx,1
 32366                                  	;adc	[CLSKIP_HW],di	; CLSKIP_HW:BX = Last cluster skipped to
 32367                                  	;sub	dx,1
 32368                                  	;sbb	[LASTPOS_HW],di	; LASTPOS_HW:DX = Position of last cluster
 32369                                  	;pop	di
 32370                                  	;;;
 32371                                  	; 25/02/2024 - Retro DOS v5.0
 32372 0000548C 4A                      	dec	dx
 32373 0000548D 7904                    	jns	short noclus1
 32374 0000548F FF0E[E20A]              	dec	word [LASTPOS_HW]
 32375                                  noclus1:
 32376 00005493 41                      	inc	cx
 32377 00005494 7504                    	jnz	short fndclus_retn
 32378 00005496 FF06[F80A]              	inc	word [CLSKIP_HW]
 32379                                  %endif
 32380                                  	; 25/02/2024
 32381                                  	; cf=0
 32382                                          ;CLC
 32383                                  
 32384                                  fndclus_retn:
 32385 0000549A C3                              retn
 32386                                  
 32387                                  ;Break  <BUFSEC -- BUFFER A SECTOR AND SET UP A TRANSFER>
 32388                                  ;--------------------------------------------------------------------------
 32389                                  ;
 32390                                  ; Procedure Name : BUFSEC
 32391                                  ;
 32392                                  ; Inputs:
 32393                                  ;       AH = priority of buffer
 32394                                  ;       AL = 0 if buffer must be read, 1 if no pre-read needed
 32395                                  ;       ES:BP = Base of drive parameters
 32396                                  ;       [CLUSNUM] = Physical cluster number
 32397                                  ;       [SECCLUSPOS] = Sector position of transfer within cluster
 32398                                  ;       [BYTCNT1] = Size of transfer
 32399                                  ; Function:
 32400                                  ;       Insure specified sector is in buffer, flushing buffer before
 32401                                  ;       read if necessary.
 32402                                  ; Outputs:
 32403                                  ;       ES:DI = Pointer to buffer
 32404                                  ;       SI = Pointer to transfer address
 32405                                  ;       CX = Number of bytes
 32406                                  ;       [NEXTADD] updated
 32407                                  ;       [TRANS] set to indicate a transfer will occur
 32408                                  ;       Carry set if error (user FAILed to I 24)
 32409                                  ;--------------------------------------------------------------------------
 32410                                  
 32411                                  	; 25/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32412                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:98C2h
 32413                                  
 32414                                  	; (MSDOS 5.0 MSDOS.SYS - DOSCODE:8BF1h) - Retro DOS v4.0 (& v4.1)
 32415                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8C2Ch) - Retro DOS v4.2
 32416                                  	; (Windows ME IO.SYS - BIOSCODE:0BE33h)
 32417                                  
 32418                                  BUFSEC:
 32419                                  	; 25/02/2024
 32420                                  	;;;
 32421                                  	;push	word [CLUSTNUM_HW]
 32422 0000549B 8B16[DE0A]              	mov	dx,[CLUSNUM_HW]
 32423                                  	;mov	[CLUSTNUM_HW],dx
 32424 0000549F 8716[E80A]              	xchg	dx,[CLUSTNUM_HW]
 32425 000054A3 52                      	push	dx	; [CLUSTNUM_HW]
 32426                                  	;;;
 32427 000054A4 8B16[BC05]                      MOV     DX,[CLUSNUM]
 32428 000054A8 8A1E[7305]                      MOV     BL,[SECCLUSPOS]
 32429                                  	;mov	byte [ALLOWED],38h
 32430 000054AC C606[4B03]38                    MOV     byte [ALLOWED],Allowed_FAIL+Allowed_RETRY+Allowed_IGNORE
 32431 000054B1 E89A01                          CALL    FIGREC
 32432 000054B4 E81F11                  	call	GETBUFFR
 32433                                  	; 25/02/2024
 32434                                  	;;;
 32435 000054B7 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 32436                                  	;;;
 32437 000054BB 72DD                            jc	short fndclus_retn
 32438                                  
 32439 000054BD C606[7405]01                    MOV     BYTE [TRANS],1	; A transfer is taking place
 32440 000054C2 8B36[B805]                      MOV     SI,[NEXTADD]
 32441 000054C6 89F7                            MOV     DI,SI
 32442 000054C8 8B0E[D205]                      MOV     CX,[BYTCNT1]
 32443 000054CC 01CF                            ADD     DI,CX
 32444 000054CE 893E[B805]                      MOV     [NEXTADD],DI
 32445 000054D2 C43E[E205]                      LES     DI,[CURBUF]
 32446                                  	;or	byte [es:di+5],8
 32447 000054D6 26804D0508                      OR      byte [ES:DI+BUFFINFO.buf_flags],buf_isDATA
 32448                                  	;;;lea	di,[di+16] ; MSDOS 3.3 
 32449                                  	;;lea	di,[di+20] ; MSDOS 6.0
 32450                                          ;lea	di,[di+24] ; PCDOS 7.1  ; 25/02/2024
 32451 000054DB 8D7D18                  	LEA     DI,[DI+BUFINSIZ]        ; Point to buffer
 32452 000054DE 033E[CC05]                      ADD     DI,[BYTSECPOS]
 32453 000054E2 F8                              CLC	; (not necessary!?) ; 25/02/2024
 32454 000054E3 C3                              retn
 32455                                  
 32456                                  ;Break   <BUFRD, BUFWRT -- PERFORM BUFFERED READ AND WRITE>
 32457                                  
 32458                                  ;---------------------------------------------------------------------------
 32459                                  ;
 32460                                  ; Procedure Name : BUFRD
 32461                                  ;
 32462                                  ; Do a partial sector read via one of the system buffers
 32463                                  ; ES:BP Points to DPB
 32464                                  ; Carry set if error (currently user FAILed to I 24)
 32465                                  ;
 32466                                  ; DS - set to DOSDATA
 32467                                  ;
 32468                                  ;----------------------------------------------------------------------------
 32469                                  
 32470                                  	; 25/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32471                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 32472                                  	; 20/05/2019 - Retro DOS v4.0
 32473                                  BUFRD:
 32474 000054E4 06                              PUSH	ES
 32475 000054E5 31C0                            xor	ax,ax			; pre-read sector
 32476 000054E7 E8B1FF                          CALL    BUFSEC
 32477 000054EA 7303                            JNC	short BUF_OK ; ds=ss
 32478                                  
 32479                                  BUF_IO_FAIL:				; this label used by BUFWRT also
 32480 000054EC 07                              POP	ES
 32481 000054ED EB2D                            JMP     SHORT RBUFPLACED ; ds=ss
 32482                                  
 32483                                  BUF_OK:
 32484 000054EF 8CC3                            MOV     BX,ES
 32485 000054F1 8E06[2E03]                      MOV     ES,[DMAADD+2]
 32486 000054F5 8EDB                            MOV     DS,BX
 32487 000054F7 87F7                    	XCHG    DI,SI
 32488 000054F9 D1E9                            SHR     CX,1
 32489                                  ;M039
 32490                                  	; MSDOS 3.3
 32491                                  	;JNC	short EVENRD
 32492                                  	;MOVSB
 32493                                  ;EVENRD:
 32494                                  	;REP     MOVSW
 32495                                  
 32496                                  ;	CX = # of whole WORDs ; CF=1 if odd # of bytes.
 32497                                  ;       DS:SI-> Source within Buffer.
 32498                                  ;       ES:DI-> Destination within Transfer memory block.
 32499                                  
 32500                                  	; MSDOS 6.0
 32501 000054FB F3A5                    	rep	movsw			;Copy Buffer to Transfer memory.
 32502                                  	;adc	cx,0                    ;CX=1 if odd # of bytes, else CX=0.
 32503                                  	;rep	movsb                   ;Copy last byte.
 32504                                  	; 16/12/2022
 32505 000054FD 7301                    	jnc	short EVENRD ; **** 20/05/2019
 32506 000054FF A4                      	movsb ; ****
 32507                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 32508                                  	;adc	cx,0
 32509                                  	;rep	movsb
 32510                                  ;M039
 32511                                  EVENRD: ; ****
 32512 00005500 07                              POP	ES
 32513                                  ;hkn; SS override
 32514 00005501 36C53E[E205]                    LDS     DI,[SS:CURBUF]
 32515                                  	;;;lea	bx,[di+16]
 32516                                  	;;lea	bx,[di+20] ; MSDOS 6.0
 32517                                  	;lea	bx,[di+24] ; PCDOS 7.1	; 25/02/2024
 32518 00005506 8D5D18                  	LEA     BX,[DI+BUFINSIZ]
 32519 00005509 29DE                            SUB     SI,BX                   ; Position in buffer
 32520 0000550B E86A10                          call	PLACEBUF
 32521                                  	;cmp	si,[es:bp+2]
 32522 0000550E 263B7602                	CMP	SI,[ES:BP+DPB.SECTOR_SIZE] ; Read Last byte?
 32523 00005512 7205                            JB	short RBUFPLACEDC ; ds<>ss ; No, leave buf where it is
 32524                                  ;M039
 32525                                  	; MSDOS 3.3
 32526                                  	;call	PLACEHEAD               ; Make it prime candidate for chucking
 32527                                                                          ;  even though it is MRU.
 32528                                          ; MSDOS 6.0
 32529 00005514 36893E[6D00]            	MOV	[ss:BufferQueue],DI	; Make it prime candidate for
 32530                                  ;M039					; chucking even though it is MRU.
 32531                                  
 32532                                  RBUFPLACEDC:
 32533 00005519 F8                              CLC
 32534                                  ;RBUFPLACED:
 32535 0000551A 16                      	push	ss
 32536 0000551B 1F                      	pop	ds
 32537                                  RBUFPLACED:	; 25/02/2024 (ds=ss)
 32538 0000551C C3                              retn
 32539                                  
 32540                                  ;----------------------------------------------------------------------------
 32541                                  ;
 32542                                  ; Procedure : BUFWRT
 32543                                  ;
 32544                                  ; Do a partial sector write via one of the system buffers
 32545                                  ; ES:BP Points to DPB
 32546                                  ; Carry set if error (currently user FAILed to I 24)
 32547                                  ;
 32548                                  ; DS - set to DOSDATA
 32549                                  ;
 32550                                  ;----------------------------------------------------------------------------
 32551                                  
 32552                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 32553                                  	; 20/05/2019 - Retro DOS v4.0
 32554                                  BUFWRT:
 32555                                  	;MOV	AX,[SECPOS]
 32556                                  	; MSDOS 6.0
 32557                                  	;ADD	AX,1			; Set for next sector
 32558                                  	;MOV	[SECPOS],AX 		;F.C. >32mb	;AN000;
 32559                                  	;ADC	word [SECPOS+2],0	;F.C. >32mb	;AN000;
 32560                                  	; 24/09/2023
 32561 0000551D FF06[C405]              	inc	word [SECPOS]
 32562 00005521 7504                    	jnz	short bufw_secpos
 32563 00005523 FF06[C605]              	inc	word [SECPOS+2]
 32564                                  bufw_secpos:
 32565 00005527 A1[C605]                	MOV	AX,[SECPOS+2]		;F.C. >32mb	;AN000;
 32566 0000552A 3B06[CA05]              	CMP	AX,[VALSEC+2]		;F.C. >32mb	;AN000;
 32567 0000552E B001                    	MOV	AL,1			;F.C. >32mb	;AN000;
 32568 00005530 770F                    	JA	short NOREAD		;F.C. >32mb	;AN000;
 32569 00005532 720B                    	JB	short _doread		;F.C. >32mb	;AN000;
 32570 00005534 A1[C405]                	MOV	AX,[SECPOS]		;F.C. >32mb	;AN000;
 32571                                  
 32572                                  	; MSDOS 3.3
 32573                                  	;INC	AX
 32574                                  	;MOV	[SECPOS],AX ; 09/09/2018
 32575                                  
 32576                                  	; 20/05/2019
 32577                                  	; MSDOS 3.3 & MSDOS 6.0
 32578 00005537 3B06[C805]              	CMP	AX,[VALSEC]		; Has sector been written before?
 32579 0000553B B001                    	MOV	AL,1
 32580 0000553D 7702                    	JA	short NOREAD		; Skip preread if SECPOS>VALSEC
 32581                                  _doread:
 32582 0000553F 30C0                    	XOR	AL,AL
 32583                                  NOREAD:
 32584 00005541 06                      	PUSH	ES
 32585 00005542 E856FF                  	CALL	BUFSEC
 32586 00005545 72A5                    	JC	short BUF_IO_FAIL
 32587 00005547 8E1E[2E03]              	MOV	DS,[DMAADD+2]
 32588 0000554B D1E9                    	SHR	CX,1
 32589                                  ;M039
 32590                                  	; MSDOS 3.3
 32591                                  	;JNC	short EVENWRT ; 09/09/2018
 32592                                  	;MOVSB
 32593                                  ;EVENWRT:
 32594                                  	;REP	MOVSW
 32595                                  
 32596                                  ;	CX = # of whole WORDs; CF=1 if odd # of bytes.
 32597                                  ;	DS:SI-> Source within Transfer memory block.
 32598                                  ;	ES:DI-> Destination within Buffer.
 32599                                  
 32600                                  	; MSDOS 6.0
 32601 0000554D F3A5                    	rep	movsw			;Copy Transfer memory to Buffer.
 32602                                  	;adc	cx,0			;CX=1 if odd # of bytes, else CX=0.
 32603                                  	;rep	movsb		  	;Copy last byte.
 32604                                  	; 16/12/2022
 32605 0000554F 7301                    	jnc	short EVENWRT ; **** 20/05/2019
 32606 00005551 A4                      	movsb ; ****
 32607                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 32608                                  	;adc	cx,0
 32609                                  	;rep	movsb
 32610                                  ;M039
 32611                                  EVENWRT: ; ****
 32612 00005552 07                      	POP	ES
 32613                                  
 32614                                  ;hkn; SS override
 32615 00005553 36C51E[E205]            	LDS	BX,[SS:CURBUF]
 32616                                  
 32617                                  	; MSDOS 6.0
 32618 00005558 F6470540                	TEST	byte [BX+BUFFINFO.buf_flags],buf_dirty
 32619                                  					;LB. if already dirty		 ;AN000;
 32620 0000555C 7507                    	JNZ	short yesdirty10	;LB. don't increment dirty count ;AN000;
 32621 0000555E E80F13                  	call	INC_DIRTY_COUNT		;LB.				 ;AN000;
 32622                                  	
 32623                                  	;or	byte [bx+5],40h
 32624 00005561 804F0540                	OR	byte [BX+BUFFINFO.buf_flags],buf_dirty
 32625                                  yesdirty10:
 32626                                  	;;;lea	si,[bx+16]
 32627                                  	;;lea	si,[bx+20] ; MSDOS 6.0
 32628                                  	;lea	si,[bx+24] ; PCDOS 7.1	; 25/02/2024
 32629 00005565 8D7718                  	LEA	SI,[BX+BUFINSIZ]
 32630 00005568 29F7                    	SUB	DI,SI		  	; Position in buffer
 32631                                  ;M039
 32632                                  	; MSDOS 3.3
 32633                                  	;MOV	SI,DI
 32634                                  	;MOV	DI,BX
 32635                                  	;call	PLACEBUF
 32636                                  	;;cmp	si,[es:bp+2]
 32637                                  	;CMP	SI,[ES:BP+DPB.SECTOR_SIZE] ; Written last byte?
 32638                                  	;JB	short WBUFPLACED	; No, leave buf where it is
 32639                                  	;call	PLACEHEAD		; Make it prime candidate for chucking
 32640                                  					;  even though it is MRU.
 32641                                  	; 10/02/2024
 32642 0000556A 16                      	push	ss
 32643 0000556B 1F                      	pop	ds
 32644                                  
 32645                                  	; MSDOS 6.0
 32646                                  	;cmp	di,[es:bp+2]
 32647 0000556C 263B7E02                	CMP	di,[ES:BP+DPB.SECTOR_SIZE] ; Written last byte?
 32648 00005570 7204                    	JB	short WBUFPLACED	; No, leave buf where it is
 32649                                  
 32650                                  	; 10/02/2024
 32651                                  	;MOV	[ss:BufferQueue],BX	; Make it prime candidate for
 32652                                  					; chucking even though it is MRU.
 32653 00005572 891E[6D00]              	mov	[BufferQueue],bx
 32654                                  ;M039
 32655                                  
 32656                                  WBUFPLACED:
 32657 00005576 F8                      	CLC
 32658                                  	; 10/02/2024
 32659                                  	;push	ss
 32660                                  	;pop	ds
 32661 00005577 C3                      	retn
 32662                                  
 32663                                  ;Break   <NEXTSEC -- Compute next sector to read or write>
 32664                                  ;---------------------------------------------------------------------------
 32665                                  ;
 32666                                  ; Procedure Name : NEXTSEC
 32667                                  ;
 32668                                  ; Compute the next sector to read or write
 32669                                  ; ES:BP Points to DPB
 32670                                  ;
 32671                                  ;---------------------------------------------------------------------------
 32672                                  
 32673                                  	; 29/02/2024
 32674                                  	; 26/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32675                                  
 32676                                  NEXTSEC:
 32677 00005578 F606[7405]FF            	test	byte [TRANS],0FFh ; -1 
 32678                                  	;JZ	short CLRET
 32679                                  	; 29/02/2024
 32680 0000557D 743D                    	jz	short CLRET2
 32681                                  
 32682 0000557F A0[7305]                	MOV	AL,[SECCLUSPOS]
 32683 00005582 FEC0                    	INC	AL
 32684                                  	;cmp	al,[es:bp+4]
 32685 00005584 263A4604                	CMP	AL,[ES:BP+DPB.CLUSTER_MASK]
 32686 00005588 762E                    	JBE	short SAVPOS
 32687                                  	
 32688                                  	; 26/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32689                                  	;;;
 32690 0000558A 8B1E[DE0A]              	mov     bx,[CLUSNUM_HW]
 32691 0000558E 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 32692                                  	;;;
 32693                                  
 32694 00005592 8B1E[BC05]              	MOV	BX,[CLUSNUM]
 32695 00005596 E8C509                  	call	IsEOF
 32696 00005599 7322                    	JAE	short NONEXT
 32697                                  
 32698 0000559B E8E909                  	call	UNPACK
 32699                                  	;JC	short NONEXT
 32700                                  	; 26/02/2024
 32701 0000559E 721E                    	jc	short NONEXT2
 32702                                  clusgot:
 32703                                  	; 26/02/2024 - Retro DOS v5.0
 32704                                  	;;;
 32705                                  	;push	di
 32706                                  	;mov	di,[CCONTENT_HW]
 32707                                  	;mov	[CLUSNUM_HW],di
 32708                                  	;pop	di
 32709 000055A0 FF36[EC0A]              	push	word [CCONTENT_HW]
 32710 000055A4 8F06[DE0A]              	pop	word [CLUSNUM_HW]
 32711                                  	;;;
 32712 000055A8 893E[BC05]              	MOV	[CLUSNUM],DI
 32713 000055AC FF06[BA05]              	INC	word [LASTPOS]
 32714                                  	; 26/02/2024 - Retro DOS v5.0
 32715                                  	;;;
 32716 000055B0 7504                    	jnz	short clusgot1
 32717 000055B2 FF06[E20A]              	inc	word [LASTPOS_HW]
 32718                                  clusgot1:		
 32719                                  	;;;
 32720 000055B6 B000                    	MOV	AL,0
 32721                                  SAVPOS:
 32722 000055B8 A2[7305]                	MOV	[SECCLUSPOS],AL
 32723                                  CLRET:
 32724 000055BB F8                      	CLC
 32725                                  CLRET2:		; 29/02/2024
 32726 000055BC C3                      	retn
 32727                                  NONEXT:
 32728 000055BD F9                      	STC
 32729                                  NONEXT2:	; 26/02/2024
 32730 000055BE C3                      	retn
 32731                                  
 32732                                  ;Break	<OPTIMIZE -- DO A USER DISK REQUEST WELL>
 32733                                  ;----------------------------------------------------------------------------
 32734                                  ;
 32735                                  ; Procedure Name : OPTIMIZE
 32736                                  ;
 32737                                  ; Inputs:
 32738                                  ;	  BX = Physical cluster
 32739                                  ;	  CX = No. of records
 32740                                  ;	  DL = sector within cluster
 32741                                  ;	  ES:BP = Base of drive parameters
 32742                                  ;	  [NEXTADD] = transfer address
 32743                                  ; Outputs:
 32744                                  ;	  AX = No. of records remaining
 32745                                  ;	  BX = Transfer address
 32746                                  ;	  CX = No. or records to be transferred
 32747                                  ;	  DX = Physical sector address (LOW)
 32748                                  ;	  [HIGH_SECTOR] = Physical sector address (HIGH)
 32749                                  ;	  DI = Next cluster
 32750                                  ;	  [CLUSNUM] = Last cluster accessed
 32751                                  ;	  [NEXTADD] updated
 32752                                  ;	  Carry set if error (currently user FAILed to I 24)
 32753                                  ; ES:BP unchanged. Note that segment of transfer not set.
 32754                                  ;
 32755                                  ;---------------------------------------------------------------------------
 32756                                  
 32757                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 32758                                  	; 27/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32759                                  
 32760                                  OPTIMIZE:
 32761 000055BF 52                      	PUSH	DX
 32762                                  	; 27/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32763                                  	;;;
 32764 000055C0 FF36[E80A]              	push	word [CLUSTNUM_HW]
 32765                                  	;;;
 32766 000055C4 53                      	PUSH	BX
 32767                                  	;mov	al,[es:bp+4]
 32768 000055C5 268A4604                	MOV	AL,[ES:BP+DPB.CLUSTER_MASK]
 32769 000055C9 FEC0                    	INC	AL		; Number of sectors per cluster
 32770 000055CB 88C4                    	MOV	AH,AL
 32771 000055CD 28D0                    	SUB	AL,DL		; AL = Num of sectors left in first cluster
 32772 000055CF 89CA                    	MOV	DX,CX
 32773                                  	;MOV	CX,0
 32774                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 32775                                  	; 16/12/2022
 32776 000055D1 31C9                    	xor	cx,cx	; sub cx,cx
 32777                                  OPTCLUS:
 32778                                  ; AL has number of sectors available in current cluster
 32779                                  ; AH has number of sectors available in next cluster
 32780                                  ; BX has current physical cluster
 32781                                  ; CX has number of sequential sectors found so far
 32782                                  ; DX has number of sectors left to transfer
 32783                                  ; ES:BP Points to DPB
 32784                                  ; ES:SI has FAT pointer
 32785                                  
 32786                                  do_norm3:
 32787 000055D3 E8B109                  	call	UNPACK
 32788 000055D6 7263                    	JC	short OP_ERR	; ds=ss ; 27/02/2024
 32789                                  ;clusgot2:
 32790 000055D8 00C1                    	ADD	CL,AL
 32791 000055DA 80D500                  	ADC	CH,0
 32792 000055DD 39D1                    	CMP	CX,DX
 32793 000055DF 735F                    	JAE	short BLKDON
 32794 000055E1 88E0                    	MOV	AL,AH
 32795                                  	;INC	BX
 32796                                  	; 27/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 32797                                  	;;;
 32798                                  	; 28/06/2024
 32799 000055E3 57                      	push	di
 32800                                  	;xor	di,di
 32801                                  	;add	bx,1
 32802                                  	;adc	[CLUSTNUM_HW],di
 32803                                  	;
 32804 000055E4 43                      	inc	bx
 32805 000055E5 7504                    	jnz	short clusgot2
 32806 000055E7 FF06[E80A]              	inc	word [CLUSTNUM_HW]
 32807                                  clusgot2:
 32808 000055EB 8B3E[EC0A]              	mov	di,[CCONTENT_HW]
 32809 000055EF 3B3E[E80A]              	cmp	di,[CLUSTNUM_HW]
 32810                                  	; 28/06/2024
 32811 000055F3 5F                      	pop	di
 32812 000055F4 7504                    	jne	short clusgot3
 32813 000055F6 39DF                    	cmp	di,bx
 32814 000055F8 74D9                    	je	short OPTCLUS
 32815                                  clusgot3:
 32816                                  	;;;	
 32817                                  	;CMP	DI,BX
 32818                                  	;JZ	short OPTCLUS
 32819                                  	;DEC	BX
 32820                                  	; 27/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 32821                                  	;;;
 32822                                  	;sub	bx,1
 32823                                  	;sbb	word [CLUSTNUM_HW],0
 32824                                  	;
 32825 000055FA 4B                      	dec	bx
 32826 000055FB 7904                    	jns	short FINCLUS
 32827 000055FD FF0E[E80A]              	dec	word [CLUSTNUM_HW]
 32828                                  	;;;
 32829                                  FINCLUS:
 32830                                  	;MOV	[CLUSNUM],BX	; Last cluster accessed
 32831                                  	; 27/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 32832                                  	;;;
 32833                                  	;push	bx
 32834                                  	;add	[LASTPOS],bx
 32835                                  	;mov	bx,[CLUSTNUM_HW]
 32836                                  	;adc	[LASTPOS_HW],bx
 32837                                  	;mov	[CLUSNUM_HW],bx
 32838                                  	;pop	word [CLUSNUM]
 32839                                  	;
 32840 00005601 891E[BC05]              	mov	[CLUSNUM],bx
 32841 00005605 011E[BA05]              	add	[LASTPOS],bx
 32842 00005609 A1[E80A]                	mov	ax,[CLUSTNUM_HW]
 32843 0000560C 1106[E20A]              	adc	[LASTPOS_HW],ax
 32844 00005610 A3[DE0A]                	mov	[CLUSNUM_HW],ax
 32845                                  	;;;
 32846 00005613 29CA                    	SUB	DX,CX		; Number of sectors still needed
 32847 00005615 52                      	PUSH	DX
 32848 00005616 89C8                    	MOV	AX,CX
 32849                                  	;mul	word[ES:BP+2]
 32850 00005618 26F76602                	MUL	word [ES:BP+DPB.SECTOR_SIZE] 
 32851                                  				; Number of sectors times sector size
 32852 0000561C 8B36[B805]              	MOV	SI,[NEXTADD]
 32853 00005620 01F0                    	ADD	AX,SI		; Adjust by size of transfer
 32854 00005622 A3[B805]                	MOV	[NEXTADD],AX
 32855 00005625 58                      	POP	AX		; Number of sectors still needed
 32856 00005626 5A                      	POP	DX		; Starting cluster
 32857                                  	; 27/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32858                                  	;SUB	BX,DX		; Number of new clusters accessed
 32859                                  	;ADD	[LASTPOS],BX
 32860                                  	;;;
 32861 00005627 5B                      	pop	bx		; Starting cluster, hw
 32862 00005628 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 32863 0000562C 2916[BA05]              	sub	[LASTPOS],dx
 32864 00005630 191E[E20A]              	sbb	[LASTPOS_HW],bx
 32865                                  	;;;
 32866 00005634 5B                      	POP	BX		; BL = sector position within cluster
 32867 00005635 E81600                  	call	FIGREC
 32868 00005638 89F3                    	MOV	BX,SI
 32869                                  	; 24/09/2023
 32870                                  	; cf=0 (at the return of FIGREC)
 32871                                  	;CLC
 32872 0000563A C3                      	retn
 32873                                  OP_ERR:
 32874                                  	;ADD	SP,4
 32875                                  	; 27/02/2024 (PCDOS 7.1 IBMDOS.COM)
 32876                                  	;;;
 32877 0000563B 83C406                  	add	sp,6
 32878                                  	;;;
 32879 0000563E F9                      	STC
 32880 0000563F C3                      	retn
 32881                                  BLKDON:
 32882 00005640 29D1                    	SUB	CX,DX	  	; Number of sectors in cluster we don't want
 32883 00005642 28CC                    	SUB	AH,CL	  	; Number of sectors in cluster we accepted
 32884 00005644 FECC                    	DEC	AH		; Adjust to mean position within cluster
 32885 00005646 8826[7305]              	MOV	[SECCLUSPOS],AH
 32886 0000564A 89D1                    	MOV	CX,DX		; Anyway, make the total equal to the request
 32887 0000564C EBB3                    	JMP	SHORT FINCLUS
 32888                                  
 32889                                  ;Break	<FIGREC -- Figure sector in allocation unit>
 32890                                  ;---------------------------------------------------------------------------
 32891                                  ;
 32892                                  ; Procedure Name : FIGREC
 32893                                  ;
 32894                                  ; Inputs:
 32895                                  ;	  DX = Physical cluster number
 32896                                  ;	  BL = Sector position within cluster
 32897                                  ;	  ES:BP = Base of drive parameters
 32898                                  ; Outputs:
 32899                                  ;	  DX = physical sector number (LOW)
 32900                                  ;	  [HIGH_SECTOR] Physical sector address (HIGH)
 32901                                  ; No other registers affected.
 32902                                  ;
 32903                                  ;---------------------------------------------------------------------------
 32904                                  
 32905                                  	; 10/06/2019
 32906                                  	; 20/05/2019 - Retro DOS v4.0
 32907                                  	; DOSCODE:8D96h (MSDOS 6.21, MSDOS.SYS)
 32908                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 32909                                  	; DOSCODE:8D5Bh (MSDOS 5.0, MSDOS.SYS)
 32910                                  
 32911                                  	; 27/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 32912                                  	; DOSCODE:9A89h (PCDOS 7.1, IBMDOS.COM)	
 32913                                  FIGREC:
 32914 0000564E 51                      	PUSH	CX
 32915                                  	; 27/02/2024
 32916                                  	;;;
 32917 0000564F 50                      	push	ax
 32918 00005650 31C9                    	xor	cx,cx
 32919                                  	;;;
 32920                                  	;mov	cl,[es:bp+5]
 32921 00005652 268A4E05                	MOV	CL,[ES:BP+DPB.CLUSTER_SHIFT]
 32922                                  	;DEC	DX
 32923                                  	;DEC	DX
 32924                                  	; 27/02/2024
 32925                                  	;;;
 32926                                  	;mov	ax,[ss:CLUSTNUM_HW]
 32927                                  	; ds = ss ; Retro DOS v5.0	
 32928 00005656 A1[E80A]                	mov	ax,[CLUSTNUM_HW]
 32929 00005659 83EA02                  	sub	dx,2
 32930 0000565C 83D800                  	sbb	ax,0
 32931 0000565F E307                    	jcxz	noshift
 32932                                  	;;;
 32933                                  
 32934                                  ; 27/02/2024
 32935                                  %if 0
 32936                                  	; MSDOS 3.3
 32937                                  	;SHL	DX,CL
 32938                                  
 32939                                  ;hkn; SS override HIGH_SECTOR
 32940                                  	; MSDOS 6.0
 32941                                  	MOV	word [SS:HIGH_SECTOR],0		;F.C. >32mb
 32942                                  	; 24/09/2023
 32943                                  	xor	ch,ch				;F.C. >32mb
 32944                                  	OR	CL,CL				;F.C. >32mb
 32945                                  	JZ	short noshift			;F.C. >32mb
 32946                                  	; 27/02/2024
 32947                                  	;XOR	CH,CH				;F.C. >32mb
 32948                                  rotleft:					;F.C. >32mb
 32949                                  	CLC					;F.C. >32mb
 32950                                  	RCL	DX,1				;F.C. >32mb
 32951                                  	; 10/06/2019
 32952                                  	RCL	word [ss:HIGH_SECTOR],1		;F.C. >32mb
 32953                                  	LOOP	rotleft				;F.C. >32mb
 32954                                  %else
 32955                                  	; 27/02/2024 - Retro DOS v5.0
 32956                                  	; (PCDOS 7.1 IBMDOS.COM)
 32957                                  rotleft:
 32958 00005661 F8                      	clc
 32959 00005662 D1D2                    	rcl	dx,1
 32960 00005664 D1D0                    	rcl	ax,1
 32961 00005666 E2F9                    	loop	rotleft
 32962                                  %endif
 32963                                  
 32964                                  noshift:
 32965                                  	; MSDOS 3.3 & MSDOS 6.0
 32966 00005668 08DA                    	OR	DL,BL
 32967                                  	
 32968                                  	; 27/02/2024 - Retro DOS v5.0
 32969                                  	;;;
 32970                                  	;cmp	word [es:bp+0Fh],0
 32971 0000566A 26394E0F                	cmp	word [es:bp+DPB.FAT_SIZE],cx ; 0
 32972 0000566E 750A                    	jnz	short noshift1  ; not FAT32
 32973                                  	;add	dx,[es:bp+29h]
 32974 00005670 26035629                	add	dx,[es:bp+DPB.FCLUS_FSECTOR]
 32975                                  	;adc	ax,[es:bp+2Bh]
 32976 00005674 2613462B                	adc	ax,[es:bp+DPB.FCLUS_FSECTOR+2]
 32977 00005678 EB06                    	jmp	short noshift2
 32978                                  noshift1:
 32979                                  	;;;
 32980                                  
 32981                                  	;add	dx,[es:bp+0Bh]
 32982 0000567A 2603560B                	ADD	DX,[ES:BP+DPB.FIRST_SECTOR]
 32983                                  	; MSDOS 6.0
 32984                                  	; 10/06/2019
 32985                                  	;ADC	word [ss:HIGH_SECTOR],0		;F.C. >32mb
 32986                                  	; 24/09/2023
 32987                                  	; cx=0
 32988                                  	;ADC	word [ss:HIGH_SECTOR],cx ; 0
 32989                                  	; 27/02/2024 - Retro DOS v5.0
 32990                                  	;;;
 32991 0000567E 11C8                    	adc	ax,cx ; adc ax,0
 32992                                  noshift2:	
 32993                                  	;mov	[ss:HIGH_SECTOR],ax
 32994 00005680 A3[0706]                	mov	[HIGH_SECTOR],ax
 32995                                  	;
 32996 00005683 58                      	pop	ax
 32997                                  	;;;
 32998                                  
 32999                                  	; MSDOS 3.3 & MSDOS 6.0
 33000 00005684 59                      	POP	CX
 33001                                  figrec_retn:
 33002 00005685 C3                      	retn
 33003                                  
 33004                                  ; 20/05/2019 - Retro DOS v4.0
 33005                                  ; DOSCODE:8DC2h (MSDOS 6.21, MSDOS.SYS)
 33006                                  
 33007                                  ; 30/07/2018 - Retro DOS v3.0
 33008                                  ; IBMDOS.COM (MSDOS 3.3, 1987) - Offset
 33009                                  
 33010                                  ;Break   <ALLOCATE -- Assign disk space>
 33011                                  ;---------------------------------------------------------------------------
 33012                                  ;
 33013                                  ; Procedure Name : ALLOCATE - Allocate Disk Space
 33014                                  ;
 33015                                  ;   ALLOCATE is called to allocate disk clusters. The new clusters are
 33016                                  ;   FAT-chained onto the end of the existing file.
 33017                                  ;
 33018                                  ;   The DPB contains the cluster # of the last free cluster allocated
 33019                                  ;   (dpb_next_free). We start at this cluster and scan towards higher
 33020                                  ;   numbered clusters, looking for the necessary free blocks.
 33021                                  ;
 33022                                  ;   Once again, fancy terminology gets in the way of correct coding. When
 33023                                  ;   using next_free, start scanning AT THAT POINT and not the one following it.
 33024                                  ;   This fixes the boundary condition bug when only free = next_free = 2.
 33025                                  ;
 33026                                  ;       If we get to the end of the disk without satisfaction:
 33027                                  ;
 33028                                  ;           if (dpb_next_free == 2) then we've scanned the whole disk.
 33029                                  ;               return (insufficient_disk_space)
 33030                                  ;           ELSE
 33031                                  ;               dpb_next_free = 2; start scan over from the beginning.
 33032                                  ;
 33033                                  ;   Note that there is no multitasking interlock. There is no race when
 33034                                  ;   examining the entrys in an in-core FAT block since there will be no
 33035                                  ;   context switch. When UNPACK context switches while waiting for a FAT read
 33036                                  ;   we are done with any in-core FAT blocks, so again there is no race. The
 33037                                  ;   only special concern is that V2 and V3 MSDOS left the last allocated
 33038                                  ;   cluster as "00"; marking it EOF only when the entire alloc request was
 33039                                  ;   satisfied. We can't allow another activation to think this cluster is
 33040                                  ;   free, so we give it a special temporary mark to show that it is, indeed,
 33041                                  ;   allocated.
 33042                                  ;
 33043                                  ;   Note that when we run out of space this algorithem will scan from
 33044                                  ;   dpb_next_free to the end, then scan from cluster 2 through the end,
 33045                                  ;   redundantly scanning the later part of the disk. This only happens when
 33046                                  ;   we run out of space, so sue me.
 33047                                  ;
 33048                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
 33049                                  ;            C  A  V  E  A  T     P  A  T  T  E  R  S  O  N                ;
 33050                                  ;                                                                          ;
 33051                                  ;   The use of FATBYT and RESTFATBYT is somewhat mysterious. Here is the
 33052                                  ;   explanation:
 33053                                  ;
 33054                                  ;   In the NUL file case (sf_firclus currently 0) ALLOCATE is called with
 33055                                  ;   entry BX = 0. What needs to be done in this case is to stuff the cluster
 33056                                  ;   number of the first cluster allocated in sf_firclus when the ALLOCATE is
 33057                                  ;   complete. THIS VALUE IS SAVED TEMPORARILY IN CLUSTER 0, HENCE THE CURRENT
 33058                                  ;   VALUE IN CLUSTER 0 MUST BE SAVED AND RESTORED. This is a side effect of
 33059                                  ;   the fact that PACK and UNPACK don't treat requests for clusters 0 and 1 as
 33060                                  ;   errors. This "stuff" is done by the call to PACK which is right before
 33061                                  ;   the
 33062                                  ;           LOOP   findfre         ; alloc more if needed
 33063                                  ;   instruction when the first cluster is allocated to the nul file. The
 33064                                  ;   value is recalled from cluster 0 and stored at sf_firclus at ads4:
 33065                                  ;
 33066                                  ;   This method is obviously useless (because it is non-reentrant) for
 33067                                  ;   multitasking, and will have to be changed. Storing the required value on
 33068                                  ;   the stack is recommended. Setting sf_firclus at the PACK of cluster 0
 33069                                  ;   (instead of actually doing the PACK) is BAD because it doesn't handle
 33070                                  ;   problems with INT 24 well.
 33071                                  ;
 33072                                  ;            C  A  V  E  A  T     P  A  T  T  E  R  S  O  N                ;
 33073                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
 33074                                  ;                                                                          ;
 33075                                  ;       ENTRY   BX = Last cluster of file (0 if null file)
 33076                                  ;               CX = No. of clusters to allocate
 33077                                  ;               ES:BP = Base of drive parameters
 33078                                  ;               [THISSFT] = Points to SFT
 33079                                  ;
 33080                                  ;       EXIT   'C' set if insufficient space
 33081                                  ;                [FAILERR] can be tested to see the reason for failure
 33082                                  ;                CX = max. no. of clusters that could be added to file
 33083                                  ;              'C' clear if space allocated
 33084                                  ;                BX = First cluster allocated
 33085                                  ;                FAT is fully updated
 33086                                  ;                sf_FIRCLUS field of SFT set if file was null
 33087                                  ;
 33088                                  ;       USES    ALL but SI, BP
 33089                                  
 33090                                  ;callmagic  proc near
 33091                                  ;       push    ds                             ;push segment of routine 
 33092                                  ;       push    Offset MagicPatch              ;push offset for routine
 33093                                  ;       retf                                   ;simulate jmp far
 33094                                  ;                                              ;far return address is on
 33095                                  ;                                              ;stack, so far return from
 33096                                  ;                                              ;call will return this routine
 33097                                  ;callmagic  endp
 33098                                  
 33099                                  ; 27/02/2024 - Retro DOS v5.0
 33100                                  ;PCDOS 7.1 IBMDOS.COM - DOSCODE:9AC5h
 33101                                  
 33102                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8DC2h)
 33103                                  ; (Windows ME IO.SYS - BIOSCODE:0C078h)
 33104                                  
 33105                                  ; 07/03/2025
 33106                                  ; 25/09/2023
 33107                                  %if 0	; 27/02/2024
 33108                                  callmagic:
 33109                                  	push	ds
 33110                                  	push	word [ss:OffsetMagicPatch]
 33111                                  	retf	
 33112                                  %endif
 33113                                  
 33114                                  ; 10/02/2024 - Retro DOS v5.0
 33115                                  %if 1
 33116                                  ALLOCATE_X:
 33117 00005686 A3[F00A]                	mov	[CCOUNT_HW],ax
 33118                                  	;jmp	short ALLOCATE
 33119                                  %endif
 33120                                  
 33121                                  	; 27/02/2024 - Retro DOS v5.0
 33122                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9ACFh
 33123                                  
 33124                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8DC9h)
 33125                                  	; (Windows ME IO.SYS - BIOSCODE:0C07Fh)
 33126                                  
 33127                                  ALLOCATE:
 33128                                  	; 10/09/2018
 33129                                  ;BEGIN MAGICDRV MODIFICATIONS
 33130                                  ;
 33131                                  ;7/5/92 scottq
 33132                                  ;
 33133                                  ;This is the disk compression patch location which allows
 33134                                  ;the disk compression software to fail allocations if the
 33135                                  ;FAT would allows allocation, but the free space for compressed
 33136                                  ;data would not.
 33137                                  ;        
 33138                                  ;;;	call    far ptr MAGICPATCH
 33139                                  ;;; We cannot do a far call since we cannot have fix-ups[romdos,hidos],
 33140                                  ;;; but we do know the segment and offset of the routine
 33141                                  ;;; so simulate a far call to dosdata:magicpatch
 33142                                  ;;; note dosassume above, so DS -> dosdata
 33143                                  
 33144                                  	; MSDOS 6.0
 33145                                          ;clc				;clear carry so we fall through
 33146                                  	;				;if no patch is present
 33147                                  	;push	cs			;push segment for far return
 33148                                          ;call	callmagic		;this is a near call
 33149                                          ;jnc	short Regular_Allocate_Path
 33150                                  	;jmp	Disk_Full_Return
 33151                                  
 33152                                  ; 27/02/2024 - Retro DOS v5.0
 33153                                  ; DOSCODE:9ACFh (PCDOS 7.1, IBMDOS.COM)
 33154                                  
 33155                                  ; 07/03/2025
 33156                                  ; 25/09/2023
 33157                                  %if 0	; 27/02/2024 - Retro DOS v5.0
 33158                                  	clc		; COUNT_HW:CX = Number of clusters to allocate
 33159                                  	push	cs
 33160                                  	call	callmagic
 33161                                  	jnc	short Regular_Allocate_Path
 33162                                  	jmp	Disk_Full_Return
 33163                                  Regular_Allocate_Path:
 33164                                  %endif
 33165                                  
 33166                                  	; 20/05/2019 - Retro DOS v4.0
 33167                                  ;END MAGICDRV MODIFICATIONS
 33168                                  
 33169                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 33170                                  	; DOSCODE:8D87h (MSDOS 5.0, MSDOS.SYS)
 33171                                  
 33172                                  	; 27/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 33173                                  	; DOSCODE:9AD6h (PCDOS 7.1, IBMDOS.COM)
 33174                                  
 33175 00005689 53                              PUSH    BX                      ; save (bx)
 33176 0000568A 31DB                            XOR     BX,BX
 33177                                  
 33178                                  	; 27/02/2024
 33179                                  	;;;
 33180 0000568C FF36[E80A]              	push	word [CLUSTNUM_HW]
 33181 00005690 891E[E80A]              	mov	[CLUSTNUM_HW],bx ; cluster 0
 33182                                  	;;;
 33183                                  
 33184 00005694 E8F008                  	call	UNPACK
 33185 00005697 893E[9605]                      MOV     [FATBYT],DI             ; save correct cluster 0 value
 33186                                  
 33187                                  	; 27/02/2024
 33188                                  	;;;		; CCONTENT_HW:DI = content of FAT (for cluster 0)
 33189 0000569B 8B1E[EC0A]              	mov	bx,[CCONTENT_HW]
 33190 0000569F 891E[E40A]              	mov	[FATBYT_HW],bx
 33191 000056A3 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 33192                                  	;;;
 33193                                  
 33194 000056A7 5B                              POP     BX
 33195 000056A8 72DB                            jc	short figrec_retn	; abort if error [INTERR?]
 33196                                  
 33197                                  ; 27/02/2024
 33198                                  %if 0
 33199                                          PUSH    CX
 33200                                          PUSH    BX
 33201                                  
 33202                                          MOV     DX,BX
 33203                                  	;;mov	bx,[es:bp+1Ch]  ; MSDOS 3.3
 33204                                  	;mov	bx,[es:bp+1Dh]	; MSDOS 6.0
 33205                                          mov     bx,[ES:BP+DPB.NEXT_FREE]
 33206                                          cmp     bx,2
 33207                                          ja	short FINDFRE
 33208                                  
 33209                                  ;   couldn't find enough free space beyond dpb_next_free, or dpb_next_free is
 33210                                  ;   <2 or >dpb_max_clus. Reset it and restart the scan
 33211                                  
 33212                                  ads1:
 33213                                  	;;mov	word [es:bp+1Ch],2 ; MSDOS 3.3
 33214                                  	;mov	word [es:bp+1Dh],2 ; MSDOS 6.0
 33215                                          mov     word [ES:BP+DPB.NEXT_FREE],2
 33216                                          mov     bx,1                    ; Counter next instruction so first
 33217                                                                          ;       cluster examined is 2
 33218                                  %else
 33219                                  	; 27/02/2024 - Retro DOS v5.0
 33220                                  	; (PCDOS 7.1 IBMDOS.COM)
 33221                                  	;;;
 33222 000056AA FF36[F00A]              	push	word [CCOUNT_HW]
 33223 000056AE 51                      	push	cx
 33224 000056AF FF36[E80A]              	push	word [CLUSTNUM_HW]
 33225 000056B3 53                      	push	bx
 33226                                  
 33227 000056B4 89DA                    	mov	dx,bx
 33228                                  
 33229 000056B6 31DB                    	xor	bx,bx ; 0
 33230                                  	;cmp	[es:bp+0Fh],bx ; 0
 33231 000056B8 26395E0F                	cmp	[es:bp+DPB.FAT_SIZE],bx ; 0
 33232 000056BC 871E[E80A]              	xchg	bx,[CLUSTNUM_HW]
 33233 000056C0 891E[EA0A]              	mov	[CLUSDATA_HW],bx
 33234                                  	;mov	bx,[es:bp+1Dh]
 33235 000056C4 268B5E1D                	mov	bx,[es:bp+DPB.NEXT_FREE]
 33236 000056C8 7510                    	jnz	short ads1		; not FAT32
 33237                                  
 33238                                  	;mov	bx,[es:bp+3Bh]
 33239 000056CA 268B5E3B                	mov	bx,[es:bp+DPB.FAT32_NXTFREE+2]
 33240 000056CE 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 33241                                  	;cmp	bx,0
 33242 000056D2 09DB                    	or	bx,bx
 33243                                  	;mov	bx,[es:bp+39h]
 33244 000056D4 268B5E39                	mov	bx,[es:bp+DPB.FAT32_NXTFREE]
 33245 000056D8 7526                    	jnz	short FINDFRE
 33246                                  ads1:
 33247 000056DA 83FB02                  	cmp	bx,2
 33248 000056DD 7721                    	ja	short FINDFRE
 33249                                  ads2:
 33250 000056DF 31DB                    	xor	bx,bx ; 0
 33251                                  	;cmp	[es:bp+0Fh],bx
 33252 000056E1 26395E0F                	cmp	[es:bp+DPB.FAT_SIZE],bx ; 0
 33253 000056E5 750A                    	jnz	short ads3		; not FAT32
 33254                                  
 33255                                  	;mov	word [es:bp+39h],2
 33256 000056E7 26C746390200            	mov	word [es:bp+DPB.FAT32_NXTFREE],2
 33257                                  	;mov	[es:bp+3Bh],bx
 33258 000056ED 26895E3B                	mov	[es:bp+DPB.FAT32_NXTFREE+2],bx ; 0
 33259                                  ads3:
 33260 000056F1 891E[E80A]              	mov	[CLUSTNUM_HW],bx ; 0
 33261                                  	;mov	word [es:bp+1Dh],2	
 33262 000056F5 26C7461D0200            	mov	word [es:bp+DPB.NEXT_FREE],2
 33263 000056FB 43                      	inc	bx ; 1
 33264                                  	;or	[es:bp+18h],bl
 33265 000056FC 26085E18                	or	[es:bp+DPB.FIRST_ACCESS],bl ; 1	
 33266                                  	;;;
 33267                                  %endif
 33268                                  
 33269                                  ;   Scanning both forwards and backwards for a free cluster
 33270                                  ;
 33271                                  ;       (BX) = forwards scan pointer
 33272                                  ;       (CX) = clusters remaining to be allocated
 33273                                  ;       (DX) = current last cluster in file
 33274                                  ;       (TOS) = last cluster of file
 33275                                  
 33276                                  FINDFRE:
 33277                                  %if 0
 33278                                          INC     BX
 33279                                  	;cmp	bx,[es:bp+0Dh]
 33280                                          CMP	BX,[ES:BP+DPB.MAX_CLUSTER]
 33281                                  	ja	short ads7	; at end of disk
 33282                                          call	UNPACK          ; check out this cluster
 33283                                          jc	short ads4	; FAT error             [INTERR?]
 33284                                          jnz	short FINDFRE	; not free, keep on truckin
 33285                                  
 33286                                  ;   Have found a free cluster. Chain it to the file
 33287                                  ;
 33288                                  ;       (BX) = found free cluster #
 33289                                  ;       (DX) = current last cluster in file
 33290                                  
 33291                                  	;;mov	[es:bp+1Ch],bx
 33292                                  	;mov	[es:bp+1Dh],bx ; MSDOS 6.0
 33293                                          mov	[ES:BP+DPB.NEXT_FREE],bx ; next time start search here
 33294                                          xchg    ax,dx           ; save (dx) in ax
 33295                                          mov     dx,1            ; mark this free guy as "1"
 33296                                  	call	PACK            ; set special "temporary" mark
 33297                                          jc	short ads4	; FAT error             [INTERR?]
 33298                                  	;;cmp	word [es:bp+1Eh],-1
 33299                                          ;cmp	word [es:bp+1Fh],-1 ; MSDOS 6.0
 33300                                  	CMP	word [ES:BP+DPB.FREE_CNT],-1 ; Free count valid?
 33301                                          JZ	short NO_ALLOC	; No
 33302                                  	;;dec	word [es:bp+1Eh]
 33303                                          ;dec	word [es:bp+1Fh] ; MSDOS 6.0
 33304                                          DEC     word [ES:BP+DPB.FREE_CNT] ; Reduce free count by 1
 33305                                  NO_ALLOC:
 33306                                          xchg    ax,dx           ; (dx) = current last cluster in file
 33307                                          XCHG    BX,DX
 33308                                          MOV     AX,DX
 33309                                  	call	PACK            ; link free cluster onto file
 33310                                                                  ;  CAVEAT.. On Nul file, first pass stuffs
 33311                                                                  ;    cluster 0 with FIRCLUS value.
 33312                                          jc	short ads4	; FAT error [INTERR?]
 33313                                          xchg    BX,AX           ; (BX) = last one we looked at
 33314                                          mov     dx,bx           ; (dx) = current end of file
 33315                                          LOOP    FINDFRE         ; alloc more if needed
 33316                                  %else
 33317                                  	; 27/02/2024 - Retro DOS v5.0
 33318                                  	; (PCDOS 7.1 IBMDOS.COM)
 33319                                  	;;;
 33320                                  	;add	bx,1
 33321                                  	;adc	word [CLUSTNUM_HW],0
 33322 00005700 43                      	inc	bx
 33323 00005701 7504                    	jnz	short FINDFRE2
 33324 00005703 FF06[E80A]              	inc	word [CLUSTNUM_HW]
 33325                                  FINDFRE2:
 33326                                  	;cmp	word [es:bp+0Fh],0
 33327 00005707 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 33328 0000570C 7512                    	jnz	short ads4 ; not FAT32
 33329                                  	; FAT32
 33330 0000570E 53                      	push	bx
 33331 0000570F 8B1E[E80A]              	mov	bx,[CLUSTNUM_HW]
 33332                                  	;cmp	bx,[es:bp+2Fh]
 33333 00005713 263B5E2F                	cmp	bx,[es:bp+DPB.LAST_CLUSTER+2]
 33334 00005717 5B                      	pop	bx
 33335 00005718 750A                    	jne	short ads5
 33336                                  	;cmp	bx,[es:bp+2Dh]
 33337 0000571A 263B5E2D                	cmp	bx,[es:bp+DPB.LAST_CLUSTER]
 33338 0000571E EB04                    	jmp	short ads5
 33339                                  ads4:
 33340                                  	;cmp	bx,[es:bp+0Dh]
 33341 00005720 263B5E0D                	cmp	bx,[es:bp+DPB.MAX_CLUSTER]
 33342                                  ads5:
 33343 00005724 7603                    	jbe	short ads6 ; jna short ads6
 33344 00005726 E9ED00                  	jmp	ads15
 33345                                  ads6:
 33346                                  	; 27/02/2024 - Retro DOS v5.0
 33347                                  	;push	cx
 33348                                  	;push	word [CCOUNT_HW]
 33349                                  	;push	bx
 33350                                  	;push	word [CLUSTNUM_HW]
 33351                                  	;push	dx
 33352                                  	;push	word [CLUSDATA_HW]
 33353                                  
 33354 00005729 E85B08                  	call	UNPACK
 33355                                  
 33356                                  	; 27/02/2024 - Retro DOS v5.0
 33357                                  	;pop	word [CLUSDATA_HW]
 33358                                  	;pop	dx
 33359                                  	;pop	word [CLUSTNUM_HW]
 33360                                  	;pop	bx
 33361                                  	;pop	word [CCOUNT_HW]
 33362                                  	;pop	cx
 33363                                  	
 33364 0000572C 7303                    	jnc	short ads7
 33365                                  	
 33366 0000572E E9A200                  	jmp	ads13
 33367                                  ads7:
 33368 00005731 75CD                    	jnz	short FINDFRE
 33369                                  
 33370                                  	;mov	[es:bp+1Dh],bx
 33371 00005733 26895E1D                	mov	[es:bp+DPB.NEXT_FREE],bx
 33372                                  
 33373                                  	;cmp	word [es:bp+0Fh],0
 33374 00005737 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 33375 0000573C 750E                    	jnz	short ads8 ; not FAT32
 33376                                  	; FAT32
 33377 0000573E 53                      	push	bx
 33378 0000573F 8B1E[E80A]              	mov	bx,[CLUSTNUM_HW]
 33379                                  	;mov	[es:bp+3Bh],bx
 33380 00005743 26895E3B                	mov	[es:bp+DPB.FAT32_NXTFREE+2],bx
 33381 00005747 5B                      	pop	bx
 33382                                  	;mov	[es:bp+39h],bx
 33383 00005748 26895E39                	mov	[es:bp+DPB.FAT32_NXTFREE],bx
 33384                                  ads8:
 33385                                  	;or	byte [es:bp+18h],1
 33386 0000574C 26804E1801              	or	byte [es:bp+DPB.FIRST_ACCESS],1
 33387                                  
 33388                                  	; 27/02/2024 - Retro DOS v5.0
 33389                                  	;push	cx
 33390                                  	;push	word [CCOUNT_HW]
 33391                                  	
 33392 00005751 53                      	push	bx
 33393 00005752 FF36[E80A]              	push	word [CLUSTNUM_HW]
 33394                                  	
 33395 00005756 52                      	push	dx
 33396 00005757 FF36[EA0A]              	push	word [CLUSDATA_HW]
 33397                                  
 33398 0000575B 31D2                    	xor	dx,dx	; 0
 33399 0000575D 8916[EA0A]              	mov	[CLUSDATA_HW],dx ; 0
 33400 00005761 42                      	inc	dx	; 1	; mark this free guy as "1"
 33401 00005762 E8D108                  	call	PACK		; set special "temporary" mark
 33402                                  
 33403 00005765 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 33404 00005769 5B                      	pop	bx
 33405 0000576A 8F06[EA0A]              	pop	word [CLUSDATA_HW]
 33406 0000576E 5A                      	pop	dx
 33407                                  
 33408                                  	; 27/02/2024 - Retro DOS v5.0
 33409                                  	;pop	word [CCOUNT_HW]
 33410                                  	;pop	cx
 33411                                  
 33412 0000576F 7262                    	jc	short ads13
 33413                                  
 33414 00005771 50                      	push	ax
 33415 00005772 31C0                    	xor	ax,ax ; 0
 33416                                  	;cmp	[es:bp+0Fh],ax ; 0
 33417 00005774 2639460F                	cmp	[es:bp+DPB.FAT_SIZE],ax ; 0
 33418 00005778 7517                    	jnz	short ads10 ; not FAT32
 33419                                  	; FAT32
 33420 0000577A 48                      	dec	ax ; 0FFFFh ; -1
 33421                                  	;cmp	[es:bp+21h],ax
 33422 0000577B 26394621                	cmp	[es:bp+DPB.FREE_CNT+2],ax ; 0FFFFh
 33423 0000577F 7506                    	jnz	short ads9
 33424                                  	;cmp	[es:bp+1Fh],ax
 33425 00005781 2639461F                	cmp	[es:bp+DPB.FREE_CNT],ax ; 0FFFFh
 33426                                  ;ads9:
 33427 00005785 7415                    	jz	short NO_ALLOC	; Free count not valid
 33428                                  ads9:	
 33429                                  	; Reduce free count by 1
 33430                                  	;add	[es:bp+1Fh],ax
 33431 00005787 2601461F                	add	[es:bp+DPB.FREE_CNT],ax ; -1
 33432                                  	;adc	[es:bp+21h],ax
 33433 0000578B 26114621                	adc	[es:bp+DPB.FREE_CNT+2],ax ; -1
 33434 0000578F EB0B                    	jmp	short NO_ALLOC
 33435                                  ads10:
 33436 00005791 48                      	dec	ax ; 0FFFFh ; -1
 33437                                  	;cmp	[es:bp+1Fh],ax
 33438 00005792 2639461F                	cmp	[es:bp+DPB.FREE_CNT],ax ; 0FFFFh
 33439 00005796 7404                    	jz	short NO_ALLOC	; Free count not valid
 33440                                  	;dec	word [es:bp+1Fh]
 33441 00005798 26FF4E1F                	dec	word [es:bp+DPB.FREE_CNT] ; Reduce free count by 1
 33442                                  NO_ALLOC:
 33443 0000579C 58                      	pop	ax
 33444                                  
 33445                                  	; 27/02/2024 - Retro DOS v5.0
 33446                                  	;push	cx
 33447                                  	;push	word [CCOUNT_HW]
 33448                                  
 33449 0000579D 52                      	push	dx
 33450 0000579E FF36[EA0A]              	push	word [CLUSDATA_HW]
 33451                                  
 33452 000057A2 E89108                  	call	PACK
 33453                                  
 33454 000057A5 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 33455 000057A9 5B                      	pop	bx
 33456                                  
 33457                                  	; 27/02/2024 - Retro DOS v5.0
 33458                                  	;pop	word [CCOUNT_HW]
 33459                                  	;pop	cx
 33460                                  	
 33461 000057AA 7227                    	jc	short ads13
 33462                                  	
 33463 000057AC 8B16[E80A]              	mov	dx,[CLUSTNUM_HW]
 33464 000057B0 8916[EA0A]              	mov	[CLUSDATA_HW],dx
 33465 000057B4 89DA                    	mov	dx,bx
 33466                                  
 33467 000057B6 83E901                  	sub	cx,1
 33468 000057B9 831E[F00A]00            	sbb	word [CCOUNT_HW],0
 33469                                  
 33470 000057BE 3B0E[F00A]              	cmp	cx,[CCOUNT_HW]
 33471 000057C2 7502                    	jne	short ads11
 33472 000057C4 E303                    	jcxz	ads12
 33473                                  ads11:
 33474 000057C6 E937FF                  	jmp	FINDFRE
 33475                                  	;;;
 33476                                  %endif
 33477                                  
 33478                                  
 33479                                  ;   We've successfully extended the file. Clean up and exit
 33480                                  ;
 33481                                  ;       (BX) = last cluster in file
 33482                                  
 33483                                  ads12:		; 27/02/2024
 33484 000057C9 BAFFFF                          MOV     DX,0FFFFH
 33485                                  	;;;
 33486 000057CC 8916[EA0A]              	mov	[CLUSDATA_HW],dx
 33487                                  	;;;
 33488 000057D0 E86308                  	call	PACK            ; mark last cluster EOF
 33489                                  
 33490                                  ;   Note that FAT errors jump here to clean the stack and exit. This saves us
 33491                                  ;   2 whole bytes. Hope its worth it...
 33492                                  ;
 33493                                  ;       'C' set if error
 33494                                  ;       calling (BX) and (CX) pushed on stack
 33495                                  
 33496                                  ; 27/02/2024
 33497                                  %if 0
 33498                                  
 33499                                  ads4:   
 33500                                  	POP     BX
 33501                                          POP     CX              ; Don't need this stuff since we're successful
 33502                                          jc	short figrec_retn
 33503                                          call	UNPACK          ; Get first cluster allocated for return
 33504                                                                  ; CAVEAT... In nul file case, UNPACKs cluster 0.
 33505                                          jc	short figrec_retn
 33506                                  	call	RESTFATBYT      ; Restore correct cluster 0 value
 33507                                          jc	short figrec_retn
 33508                                          XCHG    BX,DI           ; (DI) = last cluster in file upon our entry
 33509                                          OR      DI,DI           ; clear 'C'
 33510                                  	jnz	short figrec_retn ; we were extending an existing file
 33511                                  %else
 33512                                  	; 27/02/2024 - Retro DOS v5.0
 33513                                  	; (PCDOS 7.1 IBMDOS.COM)
 33514                                  	;;;
 33515                                  ads13:
 33516 000057D3 5B                      	pop	bx
 33517 000057D4 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 33518 000057D8 59                      	pop	cx
 33519 000057D9 8F06[F00A]              	pop	word [CCOUNT_HW]
 33520 000057DD 7301                    	jnc	short ads14
 33521                                  ads_ret:
 33522 000057DF C3                      	retn
 33523                                  ads14:
 33524 000057E0 E8A407                  	call	UNPACK		; Get first cluster allocated for return
 33525 000057E3 72FA                    	jc	short ads_ret
 33526 000057E5 E87200                  	call    RESTFATBYT      ; Restore correct cluster 0 value
 33527 000057E8 72F5                    	jc	short ads_ret
 33528 000057EA 50                      	push	ax
 33529 000057EB A1[EC0A]                	mov	ax,[CCONTENT_HW]
 33530 000057EE 8706[E80A]              	xchg	ax,[CLUSTNUM_HW]
 33531 000057F2 87FB                    	xchg	bx,di		; CLUSTNUM_HW:DI = last cluster in file upon our entry
 33532 000057F4 09F8                    	or	ax,di
 33533 000057F6 58                      	pop	ax
 33534 000057F7 75E6                    	jnz	short ads_ret	; we were extending an existing file
 33535                                  	;;;
 33536                                  %endif
 33537                                  
 33538                                  ;   We were doing the first allocation for a new file. Update the SFT cluster
 33539                                  ;   info
 33540                                  dofastk:
 33541                                  ; 27/02/2024
 33542                                  %if 0
 33543                                  	; 20/05/2019
 33544                                  	; MSDOS 6.0
 33545                                  	;push	dx ; * MSDOS 6.0
 33546                                  	;;mov	dl,[es:bp+0]
 33547                                  	;;MOV	DL,[ES:BP+DPB.DRIVE]	; get drive #
 33548                                  	;mov	dl,[es:bp]
 33549                                  
 33550                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 33551                                  	; DOSCODE:8DF9h (MSDOS 5.0, MSDOS.SYS)
 33552                                  	
 33553                                  	; 16/12/2022
 33554                                  	;push	dx ; *
 33555                                  	;mov	dl,[ES:BP+DPB.DRIVE] 
 33556                                  	; 15/12/2022
 33557                                  	;mov	dl,[es:bp]
 33558                                  
 33559                                  	; MSDOS 3.3 & MSDOS 6.0
 33560                                  	PUSH	ES
 33561                                  	LES     DI,[THISSFT]
 33562                                  	;mov	[es:di+0Bh],bx
 33563                                  	MOV     [ES:DI+SF_ENTRY.sf_firclus],BX
 33564                                  	;;mov	[es:di+1Bh],bx ; MSDOS 3.3
 33565                                  	;mov	[es:di+35h],bx ; MSDOS 6.0
 33566                                  	MOV     [ES:DI+SF_ENTRY.sf_lstclus],BX
 33567                                  	POP	ES
 33568                                  	;retn
 33569                                  
 33570                                  	;pop	dx ; * MSDOS 6.0
 33571                                  
 33572                                  	; 16/12/2022
 33573                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 33574                                  	;pop	dx ; *
 33575                                  %else
 33576                                  	; 27/02/2024 - Retro DOS v5.0
 33577                                  	; (PCDOS 7.1 IBMDOS.COM)
 33578                                  	;;;
 33579 000057F9 52                      	push	dx
 33580 000057FA 06                      	push	es
 33581 000057FB C43E[9E05]              	les	di,[THISSFT]
 33582 000057FF 8B16[E80A]              	mov	dx,[CLUSTNUM_HW]
 33583 00005803 26895D2B                	mov	[es:di+2Bh],bx	; [es:di+SF_ENTRYT.sf_chain]
 33584                                  				; 32 bit first cluster, lw
 33585 00005807 2689552D                	mov	[es:di+2Dh],dx	; [es:di+SF_ENTRYT.sf_chain+2]
 33586                                  				; 32 bit first cluster, hw
 33587 0000580B 26895D35                	mov	[es:di+35h],bx	; [es:di+SF_ENTRYT.sf_lstclus]
 33588                                  				; 32 bit last cluster, lw
 33589 0000580F 26895537                	mov	[es:di+37h],dx	; [es:di+SF_ENTRYT.sf_lstclus+2]
 33590                                  				; 32 bit last cluster, hw
 33591 00005813 07                      	pop	es
 33592 00005814 5A                      	pop	dx
 33593                                  	;;;
 33594                                  %endif	
 33595                                  
 33596 00005815 C3                      	retn
 33597                                  
 33598                                  ;** we're at the end of the disk, and not satisfied. See if we've scanned ALL
 33599                                  ;   of the disk...
 33600                                  
 33601                                  ; 27/02/2024
 33602                                  %if 0
 33603                                  ads7:
 33604                                  	;cmp	word [es:bp+1Dh],2   
 33605                                  	cmp	word [ES:BP+DPB.NEXT_FREE],2
 33606                                  	jnz	short ads1	; start scan from front of disk
 33607                                  %else	
 33608                                  	; 27/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 33609                                  	;;;
 33610                                  ads15:
 33611                                  	;cmp	word [es:bp+0Fh],0
 33612 00005816 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 33613 0000581B 7407                    	jz	short ads16 ; FAT32
 33614                                  	; FAT
 33615                                  	;cmp	word [es:bp+1Dh],2
 33616 0000581D 26837E1D02              	cmp	word [es:bp+DPB.NEXT_FREE],2
 33617 00005822 EB0C                    	jmp	short ads17
 33618                                  ads16:
 33619                                  	;cmp	word [es:bp+3Bh],0
 33620 00005824 26837E3B00              	cmp	word [es:bp+DPB.FAT32_NXTFREE+2],0
 33621                                  	;jnz	short ads17
 33622 00005829 7507                    	jnz	short ads19 ; 27/02/2024
 33623                                  	;cmp	word [es:bp+39h],2
 33624 0000582B 26837E3902              	cmp	word [es:bp+DPB.FAT32_NXTFREE],2
 33625                                  ads17:
 33626 00005830 7403                    	jz	short ads18
 33627                                  ads19:
 33628 00005832 E9AAFE                  	jmp	ads2		; start scan from front of disk
 33629                                  	;;;
 33630                                  %endif
 33631                                  
 33632                                  ;   Sorry, we've gone over the whole disk, with insufficient luck. Lets give
 33633                                  ;   the space back to the free list and tell the caller how much he could have
 33634                                  ;   had.  We have to make sure we remove the "special mark" we put on the last
 33635                                  ;   cluster we were able to allocate, so it doesn't become orphaned.
 33636                                  ;
 33637                                  ;       (CX) = clusters remaining to be allocated
 33638                                  ;       (TOS) = last cluster of file (before call to ALLOCATE)
 33639                                  ;       (TOS+1) = # of clusters wanted to allocate
 33640                                  
 33641                                  ads18:		; 27/02/2024
 33642 00005835 5B                              POP     BX              ; (BX) = last cluster of file
 33643 00005836 BAFFFF                          MOV     DX,0FFFFH
 33644                                  
 33645                                  	; 27/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 33646                                  	;;;
 33647 00005839 8916[EA0A]              	mov	[CLUSDATA_HW],dx
 33648 0000583D 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 33649                                  	;;;
 33650                                  
 33651 00005841 E83800                  	call	RELBLKS         ; give back any clusters just alloced
 33652 00005844 58                              POP     AX              ; No. of clusters requested
 33653                                                                  ; Don't "retc". We are setting Carry anyway,
 33654                                                                  ;   Alloc failed, so proceed with return CX
 33655                                                                  ;   setup.
 33656                                  	;;;	; 27/02/2024
 33657 00005845 8F06[F20A]              	pop	word [CLUSTERS_HW]
 33658                                  	;;;
 33659                                  
 33660 00005849 29C8                            SUB     AX,CX           ; AX=No. of clusters allocated
 33661                                  
 33662                                  	;;;	; 27/02/2024
 33663 0000584B 831E[F20A]00            	sbb	word [CLUSTERS_HW],0
 33664                                  	;;;
 33665                                  
 33666 00005850 E80700                  	call	RESTFATBYT      ; Don't "retc". We are setting Carry anyway,
 33667                                                                  ;   Alloc failed.
 33668                                  Disk_Full_Return:               ;label added for magic patch 8-6-92 scottq
 33669                                          ; MSDOS 6.0
 33670 00005853 C606[0B06]01            	MOV	byte [DISK_FULL],1 ;MS. indicating disk full
 33671 00005858 F9                              STC
 33672 00005859 C3                              retn
 33673                                  
 33674                                  ;-----------------------------------------------------------------------
 33675                                  ;
 33676                                  ; Procedure Name : RESTFATBYT
 33677                                  ;
 33678                                  ; SEE ALLOCATE CAVEAT
 33679                                  ;       Carry set if error (currently user FAILed to I 24)
 33680                                  ;-----------------------------------------------------------------------
 33681                                  	; 27/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 33682                                  
 33683                                  RESTFATBYT:
 33684 0000585A 53                              PUSH    BX
 33685 0000585B 52                              PUSH    DX
 33686 0000585C 57                              PUSH    DI
 33687                                  
 33688 0000585D 31DB                            XOR     BX,BX
 33689                                  
 33690                                  	; 27/02/2024 - Retro DOS v5.0
 33691                                  	; (PCDOS 7.1 IBMDOS.COM)
 33692                                  	;;;
 33693                                  	;push	word [CLUSTNUM_HW]
 33694                                  	;push	word [CLUSDATA_HW]
 33695                                  	;push	word [CCONTENT_HW]  ; (*) (not necessary ?)
 33696 0000585F 891E[E80A]              	mov	[CLUSTNUM_HW],bx ; 0
 33697 00005863 8B16[E40A]              	mov	dx,[FATBYT_HW]
 33698 00005867 8916[EA0A]              	mov	[CLUSDATA_HW],dx
 33699                                  	;;;
 33700                                  
 33701 0000586B 8B16[9605]                      MOV     DX,[FATBYT]
 33702                                  
 33703 0000586F E8C407                  	call	PACK
 33704                                  
 33705                                  	; 27/02/2024 - Retro DOS v5.0
 33706                                  	; (PCDOS 7.1 IBMDOS.COM)
 33707                                  	;;;
 33708                                  	; 28/06/2024 ; (*)
 33709                                  	;pop	word [CCONTENT_HW]
 33710                                  	;pop	word [CLUSDATA_HW]
 33711                                  	;pop	word [CLUSTNUM_HW]
 33712                                  	;;;
 33713                                  
 33714 00005872 5F                              POP     DI
 33715 00005873 5A                              POP     DX
 33716 00005874 5B                              POP     BX
 33717                                  
 33718                                  ; 16/12/2022
 33719                                  ; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 33720                                  ;RELEASE_flush:
 33721 00005875 C3                      	retn
 33722                                  
 33723                                  ;Break	<RELEASE -- DEASSIGN DISK SPACE>
 33724                                  ;---------------------------------------------------------------------------
 33725                                  ;
 33726                                  ; Procedure Name : RELEASE
 33727                                  ;
 33728                                  ; Inputs:
 33729                                  ;       BX = Cluster in file
 33730                                  ;       ES:BP = Base of drive parameters
 33731                                  ; Function:
 33732                                  ;       Frees cluster chain starting with [BX]
 33733                                  ;       Carry set if error (currently user FAILed to I 24)
 33734                                  ; AX,BX,DX,DI all destroyed. Other registers unchanged.
 33735                                  ;
 33736                                  ;-----------------------------------------------------------------------------
 33737                                  
 33738                                  	; 28/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 33739                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9D13h
 33740                                  
 33741                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8E86h)
 33742                                  	; (Windows ME IO.SYS - BIOSCODE:0C27Fh)
 33743                                  
 33744                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 33745                                  	; 20/05/2019 - Retro DOS v4.0
 33746                                  RELEASE:
 33747 00005876 31D2                            XOR     DX,DX
 33748                                  	
 33749                                  	; 28/02/2024 - Retro DOS v5.0
 33750                                  	; (PCDOS 7.1 IBMDOS.COM)
 33751                                  	;;;
 33752 00005878 8916[EA0A]              	mov	[CLUSDATA_HW],dx ; (dx = 0, release)
 33753                                  	;;;
 33754                                  
 33755                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9D19h
 33756                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8E88h)
 33757                                  	; (Windows ME IO.SYS - BIOSCODE:0C285h)
 33758                                  
 33759                                  	;entry	RELBLKS
 33760                                  RELBLKS:
 33761                                  
 33762                                  ;   Enter here with DX=0FFFFH to put an end-of-file mark in the first cluster
 33763                                  ;   and free the rest in the chain.
 33764                                  
 33765 0000587C E80807                  	call	UNPACK
 33766                                  	;jc	short RELEASE_flush
 33767                                  	;jz	short RELEASE_flush
 33768                                  	; 28/12/2024 (PCDOS 7.1 IBMDOS.COM)
 33769 0000587F 7652                            jbe	short RET12 ; jna short RET12
 33770                                  				; CCONTENT_HW:DI= Content of FAT
 33771                                   				; for given cluster (next cluster)
 33772 00005881 89F8                    	MOV     AX,DI
 33773 00005883 52                              PUSH    DX
 33774                                  
 33775                                  	;;; 28/12/2024 - Retro DOS v5.0
 33776                                  	;push	ax
 33777                                  	;;;
 33778                                  
 33779 00005884 E8AF07                  	call	PACK
 33780                                  
 33781                                  	;;; 28/12/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 33782                                  	;pop	ax
 33783 00005887 8B16[EC0A]              	mov	dx,[CCONTENT_HW]
 33784 0000588B 8916[E80A]              	mov	[CLUSTNUM_HW],dx ; next cluster (hw) to be released
 33785 0000588F 89C3                    	mov	bx,ax		 ; next cluster (lw) to be released
 33786                                  	;;;
 33787                                          
 33788 00005891 5A                      	POP     DX
 33789                                  	;jc	short RELEASE_flush
 33790                                  	; 28/12/2024 (PCDOS 7.1 IBMDOS.COM)
 33791 00005892 723F                    	jc	short RET12
 33792                                          
 33793 00005894 09D2                    	OR      DX,DX
 33794 00005896 751F                            JNZ	short NO_DEALLOC	; Was putting EOF mark
 33795                                  
 33796                                  ; 28/02/2024
 33797                                  %if 0
 33798                                  	;;cmp	word [es:bp+1Eh],-1 ; MSDOS 3.3
 33799                                  	;cmp	word [es:bp+1Fh],-1 ; MSDOS 6.0
 33800                                  	CMP     word [ES:BP+DPB.FREE_CNT],-1 ; Free count valid?
 33801                                          JZ	short NO_DEALLOC	; No
 33802                                          INC	word [ES:BP+DPB.FREE_CNT] ; Increase free count by 1
 33803                                  NO_DEALLOC:
 33804                                          MOV     BX,AX
 33805                                          dec     ax              	; check for "1"
 33806                                  	jz	short RELEASE_flush	; is last cluster of incomplete chain
 33807                                  %else
 33808                                  	; 28/02/2024 - Retro DOS v5.0
 33809                                  	; (PCDOS 7.1 IBMDOS.COM)
 33810                                  	;;;
 33811 00005898 3B16[EA0A]              	cmp	dx,[CLUSDATA_HW]	; > 0 ? (delete, release)
 33812 0000589C 7519                    	jnz	short NO_DEALLOC	; no, EOF (allocate, -1), (dx = 0)
 33813                                  	;cmp	word [es:bp+1Fh],0FFFFh
 33814 0000589E 26837E1FFF              	cmp	word [es:bp+DPB.FREE_CNT],0FFFFh ; -1
 33815                                  					; Free count valid?
 33816 000058A3 7412                    	jz	short NO_DEALLOC	; No (dx = 0)
 33817                                  relblks_ifc:
 33818                                  	;inc	word ptr es:[bp+1Fh]
 33819 000058A5 26FF461F                	inc	word [ES:BP+DPB.FREE_CNT] ; Increase free count by 1
 33820 000058A9 7519                    	jnz	short NO_DEALLOC2
 33821                                  
 33822                                  	;cmp	[es:bp+0Fh],dx
 33823 000058AB 2639560F                	cmp	[es:bp+DPB.FAT_SIZE],dx
 33824 000058AF 7513                    	jnz	short NO_DEALLOC2	; not FAT32
 33825                                  
 33826                                  	;inc	word [es:bp+21h]
 33827 000058B1 26FF4621                	inc	word [es:bp+DPB.FREE_CNT+2]
 33828 000058B5 EB0D                    	jmp	short NO_DEALLOC2
 33829                                  NO_DEALLOC:
 33830                                  	;cmp	[es:bp+0Fh],dx
 33831 000058B7 2639560F                	cmp	[es:bp+DPB.FAT_SIZE],dx	; dx is -1 or 0
 33832                                  					; (valid 16 bit fat size is another number)
 33833 000058BB 7507                    	jnz	short NO_DEALLOC2 ; FAT (FAT16 or FAT12)
 33834                                  					; dx = 0, FAT32
 33835                                  	;cmp	word [es:bp+21h],0FFFFh
 33836 000058BD 26837E21FF              	cmp	word [es:bp+DPB.FREE_CNT+2],0FFFFh
 33837 000058C2 75E1                    	jnz	short relblks_ifc
 33838                                  NO_DEALLOC2:
 33839 000058C4 833E[E80A]00            	cmp	word [CLUSTNUM_HW],0
 33840 000058C9 7503                    	jnz	short NO_DEALLOC3
 33841 000058CB 48                      	dec	ax			; check for "1"	
 33842 000058CC 7405                    	jz	short RET12		; is last cluster of incomplete chain
 33843                                  NO_DEALLOC3:
 33844                                  	;;;
 33845                                  %endif
 33846                                  
 33847 000058CE E88D06                  	call	IsEOF
 33848 000058D1 72A3                            JB	short RELEASE	; Carry clear if JMP not taken
 33849                                  
 33850                                  	; 16/12/2022
 33851                                  ; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 33852                                  ; 28/02/2024 (PCDOS 7.1 IBMDOS.COM)
 33853                                  %if 0
 33854                                  RELEASE_flush:
 33855                                  	; MSDOS 6.0
 33856                                  	mov	al,[es:bp]
 33857                                  	;MOV	AL,[ES:BP+DPB.DRIVE]
 33858                                  	push	si		; FLUSHBUF may trash these and we guarantee
 33859                                  	push	cx		;  them to be preserved.
 33860                                  	push	es
 33861                                  	push	bp
 33862                                  	call	FLUSHBUF	; commit buffers for this drive
 33863                                  	pop	bp
 33864                                  	pop	es
 33865                                  	pop	cx
 33866                                  	pop	si
 33867                                  %endif		; 28/02/2024
 33868                                  
 33869                                  RET12:
 33870 000058D3 C3                      	retn
 33871                                  
 33872                                  ;Break	<GETEOF -- Find the end of a file>
 33873                                  ;------------------------------------------------------------------------
 33874                                  ;
 33875                                  ; Procedure Name : GETEOF
 33876                                  ;
 33877                                  ; Inputs:
 33878                                  ;       ES:BP Points to DPB
 33879                                  ;       BX = Cluster in a file
 33880                                  ;       DS = CS
 33881                                  ; Outputs:
 33882                                  ;       BX = Last cluster in the file
 33883                                  ;       Carry set if error (currently user FAILed to I 24)
 33884                                  ; DI destroyed. No other registers affected.
 33885                                  ;
 33886                                  ;--------------------------------------------------------------------------
 33887                                  
 33888                                  	; 28/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 33889                                  %if 0
 33890                                  GETEOF:
 33891                                  	call	UNPACK
 33892                                          jc	short RET12
 33893                                          PUSH    BX
 33894                                          MOV     BX,DI
 33895                                  	call	IsEOF
 33896                                          POP     BX
 33897                                          JAE     short RET12
 33898                                          MOV     BX,DI
 33899                                          JMP     short GETEOF
 33900                                  %else
 33901                                  	; 28/02/2024 - Retro DOS v5.0
 33902                                  	;;;
 33903                                  GETEOF4:	; **
 33904 000058D4 8F06[E80A]              	pop	word [CLUSTNUM_HW] ; * ; 28/02/2024
 33905                                  GETEOF1:
 33906 000058D8 89C7                    	mov	di,ax
 33907 000058DA 8916[F20A]              	mov	[CLUSTERS_HW],dx ; CLUSTERS_HW:DI = Cluster Count
 33908 000058DE 58                      	pop	ax
 33909 000058DF 5A                      	pop	dx
 33910 000058E0 C3                      	retn
 33911                                  
 33912                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9D7Ch
 33913                                  GETEOF:
 33914 000058E1 52                      	push	dx
 33915 000058E2 50                      	push	ax
 33916 000058E3 31D2                    	xor	dx,dx ; 0	; cluster count = 0
 33917 000058E5 31C0                    	xor	ax,ax ; 0
 33918                                  GETEOF2:
 33919 000058E7 E89D06                  	call	UNPACK
 33920 000058EA 72EC                    	jc	short GETEOF1
 33921                                  		; CCONTENT_HW:DI = next cluster (cluster content)
 33922 000058EC 40                      	inc	ax
 33923 000058ED 7501                    	jnz	short GETEOF3
 33924 000058EF 42                      	inc	dx
 33925                                  GETEOF3:
 33926 000058F0 FF36[E80A]              	push	word [CLUSTNUM_HW] ; * ; 28/02/2024
 33927 000058F4 53                      	push    bx
 33928                                  	;push	word [CLUSTNUM_HW]
 33929 000058F5 8B1E[EC0A]              	mov	bx,[CCONTENT_HW]
 33930 000058F9 891E[E80A]              	mov	[CLUSTNUM_HW],bx
 33931 000058FD 89FB                    	mov	bx,di
 33932 000058FF E85C06                  	call	IsEOF
 33933                                  	;pop	word [CLUSTNUM_HW] ; * ; 28/02/2024
 33934 00005902 5B                      	pop	bx
 33935                                  	;jae	short GETEOF1   ; EOF
 33936 00005903 73CF                    	jae	short GETEOF4 ; ** ; 28/02/2024
 33937                                  	;mov	bx,[CCONTENT_HW] ; not EOF
 33938                                  	;mov	[CLUSTNUM_HW],bx
 33939 00005905 5B                      	pop	bx	; * ; 28/02/2024
 33940 00005906 89FB                    	mov	bx,di
 33941 00005908 EBDD                    	jmp	short GETEOF2   ; get next cluster
 33942                                  	;;;
 33943                                  %endif
 33944                                  
 33945                                  ;============================================================================
 33946                                  ; FCB.ASM, MSDOS 6.0, 1991
 33947                                  ;============================================================================
 33948                                  ; 30/07/2018 - Retro DOS v3.0
 33949                                  ; 20/05/2019 - Retro DOS v4.0
 33950                                  ; 29/02/2024 - Retro DOS v5.0
 33951                                  
 33952                                  ;	TITLE	FCB - FCB parse calls for MSDOS
 33953                                  ;	NAME	FCB
 33954                                  
 33955                                  ;**	FCB.ASM - Low level routines for parsing names into FCBs and analyzing
 33956                                  ;		  filename characters
 33957                                  ;
 33958                                  ;	MakeFcb
 33959                                  ;	NameTrans
 33960                                  ;	PATHCHRCMP
 33961                                  ;	GetLet
 33962                                  ;	UCase
 33963                                  ;	GetLet3
 33964                                  ;	GetCharType
 33965                                  ;	TESTKANJ
 33966                                  ;	NORMSCAN
 33967                                  ;	DELIM
 33968                                  ;
 33969                                  ;	Revision history:
 33970                                  ;
 33971                                  ;		A000  version 4.00  Jan. 1988
 33972                                  ;	
 33973                                  ;	M048 - access FILE_UCASE_TAB using DS rather than SS.
 33974                                  
 33975                                  TableLook	EQU	-1
 33976                                  
 33977                                  SCANSEPARATOR	EQU	1
 33978                                  DRVBIT		EQU	2
 33979                                  NAMBIT		EQU	4
 33980                                  EXTBIT		EQU	8
 33981                                  
 33982                                  ;----------------------------------------------------------------------------
 33983                                  ;
 33984                                  ; Procedure : MakeFcb
 33985                                  ;
 33986                                  ;----------------------------------------------------------------------------
 33987                                  
 33988                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 33989                                  	; DOSCODE:8E77h (MSDOS 5.0, MSDOS.SYS)
 33990                                  
 33991                                  	; 29/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 33992                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9DB0h
 33993                                  
 33994                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:8ED3h)
 33995                                  	; (Windows ME IO.SYS - BIOSCODE:8D92h)
 33996                                  
 33997                                  MAKEFCB:
 33998                                  ;hkn; SS override
 33999                                  	;MOV	BYTE [SS:SpaceFlag],0
 34000 0000590A 30D2                    	XOR	DL,DL		; Flag--not ambiguous file name
 34001                                  	; 29/02/2024
 34002 0000590C 368816[4E03]            	mov	[ss:SpaceFlag],dl ; 0
 34003                                  	;test	al,2
 34004 00005911 A802                    	test	AL,DRVBIT	; Use current drive field if default?
 34005 00005913 7503                    	JNZ	short DEFDRV
 34006                                  	;MOV	BYTE [ES:DI],0	; No - use default drive
 34007                                  	; 29/02/2024
 34008 00005915 268815                  	mov	[es:di],dl ; 0
 34009                                  DEFDRV:
 34010 00005918 47                      	INC	DI
 34011 00005919 B90800                  	MOV	CX,8
 34012                                  	;test	al,4
 34013 0000591C A804                    	test	AL,NAMBIT	; Use current name fields as default?
 34014 0000591E 93                      	XCHG	AX,BX		; Save bits in BX
 34015 0000591F B020                    	MOV	AL," "
 34016 00005921 7404                    	JZ	short FILLB	; If not, go fill with blanks
 34017 00005923 01CF                    	ADD	DI,CX
 34018 00005925 31C9                    	XOR	CX,CX		; Don't fill any
 34019                                  FILLB:
 34020 00005927 F3AA                    	REP	STOSB
 34021 00005929 B103                    	MOV	CL,3
 34022 0000592B F6C308                  	test	BL,EXTBIT	; Use current extension as default
 34023 0000592E 7404                    	JZ	short FILLB2
 34024 00005930 01CF                    	ADD	DI,CX
 34025 00005932 31C9                    	XOR	CX,CX
 34026                                  FILLB2:
 34027 00005934 F3AA                    	REP	STOSB
 34028 00005936 91                      	XCHG	AX,CX		; Put zero in AX
 34029 00005937 AB                      	STOSW
 34030 00005938 AB                      	STOSW			; Initialize two words after to zero
 34031 00005939 83EF10                  	SUB	DI,16		; Point back at start
 34032                                  	;test	bl,1
 34033 0000593C F6C301                  	test	BL,SCANSEPARATOR; Scan off separators if not zero
 34034 0000593F 7409                    	JZ	short SKPSPC
 34035 00005941 E88800                  	CALL	SCANB		; Peel off blanks and tabs
 34036 00005944 E81E01                  	CALL	DELIM		; Is it a one-time-only delimiter?
 34037 00005947 7504                    	JNZ	short NOSCAN
 34038 00005949 46                      	INC	SI		; Skip over the delimiter
 34039                                  SKPSPC:
 34040 0000594A E87F00                  	CALL	SCANB		; Always kill preceding blanks and tabs
 34041                                  NOSCAN:
 34042 0000594D E8EC00                  	CALL	GETLET
 34043 00005950 761E                    	JBE	short NODRV	; Quit if termination character
 34044 00005952 803C3A                  	CMP	BYTE [SI],":"	; Check for potential drive specifier
 34045 00005955 7519                    	JNZ	short NODRV
 34046 00005957 46                      	INC	SI		; Skip over colon
 34047 00005958 2C40                    	SUB	AL,"@"          ; Convert drive letter to drive number (A=1)
 34048 0000595A 760F                    	JBE	short BADDRV	; Drive letter out of range
 34049                                  
 34050 0000595C 50                      	PUSH	AX
 34051 0000595D E8961E                  	call	GetVisDrv
 34052 00005960 58                      	POP	AX
 34053 00005961 730A                    	JNC	short HAVDRV
 34054                                  
 34055                                  	; 20/05/2019 - Retro DOS v4.0
 34056                                  	; MSDOS 6.0
 34057                                  ;hkn; SS override
 34058 00005963 36803E[1006]1A          	CMP	byte [SS:DrvErr],error_not_DOS_disk ; 1Ah
 34059                                  					; if not FAT drive ;AN000;
 34060 00005969 7402                    	JZ	short HAVDRV		; assume ok	   ;AN000;
 34061                                  BADDRV:
 34062 0000596B B2FF                    	MOV	DL,-1
 34063                                  HAVDRV:
 34064 0000596D AA                      	STOSB			; Put drive specifier in first byte
 34065 0000596E 46                      	INC	SI
 34066 0000596F 4F                      	DEC	DI		; Counteract next two instructions
 34067                                  NODRV:
 34068 00005970 4E                      	DEC	SI		; Back up
 34069 00005971 47                      	INC	DI		; Skip drive byte
 34070                                  
 34071                                  	;entry	NORMSCAN
 34072                                  NORMSCAN:
 34073 00005972 B90800                  	MOV	CX,8
 34074 00005975 E82200                  	CALL	GETWORD 	; Get 8-letter file name
 34075 00005978 803C2E                  	CMP	BYTE [SI],"."
 34076 0000597B 7510                    	JNZ	short NODOT
 34077 0000597D 46                      	INC	SI		; Skip over dot if present
 34078                                  
 34079                                  	; 24/09/2023
 34080                                  	;mov	cx,3
 34081 0000597E B103                    	mov	cl,3	; ch=0
 34082                                  
 34083                                  	; MSDOS 6.0
 34084                                  ;hkn; SS override
 34085                                  	;TEST	word [SS:DOS34_FLAG],DBCS_VOLID2 ; 100h ;AN000;
 34086                                  	; 10/06/2019
 34087 00005980 36F606[1206]01          	test	byte [SS:DOS34_FLAG+1],(DBCS_VOLID2>>8) ; 1
 34088 00005986 7402                    	JZ	short VOLOK				;AN000;
 34089 00005988 A4                      	MOVSB			; 2nd byte of DBCS	;AN000;
 34090                                  	; 24/09/2023
 34091                                  	;MOV	CX,2					;AN000;
 34092 00005989 49                      	dec	cx  ; cx=2
 34093                                  	;JMP	SHORT contvol				;AN000;
 34094                                  VOLOK:
 34095                                  	;MOV	CX,3		; Get 3-letter extension
 34096                                  contvol:
 34097 0000598A E81300                  	CALL	MUSTGETWORD
 34098                                  NODOT:
 34099 0000598D 88D0                    	MOV	AL,DL
 34100                                  
 34101                                  	; MSDOS 6.0
 34102                                  	;and	word [ss:DOS34_FLAG],0FEFFh
 34103                                  	; 18/12/2022
 34104 0000598F 368026[1206]FE          	and	byte [ss:DOS34_FLAG+1],0FEh ; (~DBCS_VOLID2)>>8
 34105                                  	;and	word [ss:DOS34_FLAG],~DBCS_VOLID2 ; ### BUG FIX ###
 34106                                  
 34107 00005995 C3                      	retn
 34108                                  
 34109                                  NONAM:
 34110 00005996 01CF                    	ADD	DI,CX
 34111 00005998 4E                      	DEC	SI
 34112 00005999 C3                      	retn
 34113                                  
 34114                                  GETWORD:
 34115 0000599A E89F00                  	CALL	GETLET		
 34116 0000599D 76F7                    	JBE	short NONAM	; Exit if invalid character
 34117 0000599F 4E                      	DEC	SI
 34118                                  
 34119                                  ;	UGH!!! Horrible bug here that should be fixed at some point:
 34120                                  ;	If the name we are scanning is longer than CX, we keep on reading!
 34121                                  
 34122                                  MUSTGETWORD:
 34123 000059A0 E89900                  	CALL	GETLET
 34124                                  
 34125                                  ;	If spaceFlag is set then we allow spaces in a pathname
 34126                                  
 34127                                  ;IF NOT TABLELOOK
 34128                                  ;	JB	short FILLNAM  ; MSDOS 3.3
 34129                                  ;ENDIF
 34130 000059A3 750C                    	JNZ	short MustCheckCX
 34131                                  
 34132                                  ;hkn; SS override
 34133 000059A5 36F606[4E03]FF          	test	BYTE [SS:SpaceFlag],0FFh
 34134 000059AB 7419                    	JZ	short FILLNAM
 34135 000059AD 3C20                    	CMP	AL," "
 34136 000059AF 7515                    	JNZ	short FILLNAM
 34137                                  
 34138                                  MustCheckCX:
 34139 000059B1 E3ED                    	JCXZ	MUSTGETWORD
 34140 000059B3 49                      	DEC	CX
 34141 000059B4 3C2A                    	CMP	AL,"*"          ; Check for ambiguous file specifier
 34142 000059B6 7504                    	JNZ	short NOSTAR
 34143 000059B8 B03F                    	MOV	AL,"?"
 34144 000059BA F3AA                    	REP	STOSB
 34145                                  NOSTAR:
 34146 000059BC AA                      	STOSB
 34147 000059BD 3C3F                    	CMP	AL,"?"
 34148 000059BF 75DF                    	JNZ	short MUSTGETWORD
 34149 000059C1 80CA01                  	OR	DL,1		; Flag ambiguous file name
 34150 000059C4 EBDA                    	JMP	short MUSTGETWORD
 34151                                  FILLNAM:
 34152 000059C6 B020                    	MOV	AL," "
 34153 000059C8 F3AA                    	REP	STOSB
 34154 000059CA 4E                      	DEC	SI
 34155 000059CB C3                      	retn
 34156                                  
 34157                                  SCANB:
 34158 000059CC AC                      	LODSB
 34159 000059CD E89D00                  	CALL	SPCHK
 34160 000059D0 74FA                    	JZ	short SCANB
 34161 000059D2 4E                      	DEC	SI
 34162                                  scanb_retn:
 34163 000059D3 C3                      	retn
 34164                                  
 34165                                  ;----------------------------------------------------------------------------
 34166                                  ;
 34167                                  ; Procedure Name : NameTrans
 34168                                  ;
 34169                                  ; NameTrans is used by FindPath to scan off an element of a path. We must
 34170                                  ; allow spaces in pathnames
 34171                                  ;
 34172                                  ;   Inputs:	DS:SI points to start of path element
 34173                                  ;   Outputs:	Name1 has unpacked name, uppercased
 34174                                  ;		ES = DOSGroup
 34175                                  ;		DS:SI advanced after name
 34176                                  ;   Registers modified: DI,AX,DX,CX
 34177                                  ;
 34178                                  ;----------------------------------------------------------------------------
 34179                                  
 34180                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 34181                                  	; 20/05/2019 - Retro DOS v4.0
 34182                                  
 34183                                  	; 29/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 34184                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9E7Ch
 34185                                  
 34186                                  NameTrans:
 34187                                  ;hkn; SS override
 34188 000059D4 36C606[4E03]01          	MOV	BYTE [SS:SpaceFlag],1
 34189 000059DA 16                      	push	ss
 34190 000059DB 07                      	pop	es
 34191                                  
 34192                                  ;hkn; NAME1 is in DOSDATA
 34193 000059DC BF[4B05]                	MOV	DI,NAME1
 34194 000059DF 57                      	PUSH	DI
 34195                                  
 34196                                  ; 29/02/2024
 34197                                  %if 0
 34198                                  	MOV	AX,'  '	; 2020h
 34199                                  	MOV	CX,5
 34200                                  	STOSB
 34201                                  	REP	STOSW		; Fill "FCB" at NAME1 with spaces
 34202                                  	XOR	AL,AL		; Set stuff for NORMSCAN
 34203                                  	MOV	DL,AL
 34204                                  %else
 34205                                  	; 29/02/2024
 34206                                  	; (PCDOS 7.1 IBMDOS.COM)
 34207                                  	;;;
 34208 000059E0 B020                    	mov     al, 20h ; ' '
 34209 000059E2 B90B00                  	mov     cx, 11
 34210 000059E5 F3AA                    	rep stosb               ; Fill "FCB" at NAME1 with spaces
 34211 000059E7 91                      	xchg    ax, cx
 34212 000059E8 99                      	cwd
 34213                                  	;;;
 34214                                  %endif
 34215                                  
 34216 000059E9 AA                      	STOSB
 34217 000059EA 5F                      	POP	DI
 34218                                  
 34219 000059EB E884FF                  	CALL	NORMSCAN
 34220                                  
 34221                                  ;hkn; SS override for NAME1
 34222 000059EE 36803E[4B05]E5          	CMP	byte [SS:NAME1],0E5H
 34223 000059F4 75DD                    	jnz	short scanb_retn
 34224 000059F6 36C606[4B05]05          	MOV	byte [SS:NAME1],5 ; Magic name translation
 34225 000059FC C3                      	retn
 34226                                  
 34227                                  ;Break	<GETLET, DELIM -- CHECK CHARACTERS AND CONVERT>
 34228                                  ;============================================================================
 34229                                  
 34230                                  ; 20/05/2019 - Retro DOS v4.0
 34231                                  ; DOSCODE:8FD2h (MSDOS 6.21, MSDOS.SYS)
 34232                                  
 34233                                  ;If TableLook
 34234                                  
 34235                                  ;hkn; Table	SEGMENT
 34236                                  ;	PUBLIC	CharType
 34237                                  ;----------------------------------------------------------------------------
 34238                                  
 34239                                  ; Character type table for file name scanning
 34240                                  ; Table provides a mapping of characters to validity bits.
 34241                                  ; Four bits are provided for each character. Values 7Dh and above
 34242                                  ; have all bits set, so that part of the table is chopped off, and
 34243                                  ; the translation routine is responsible for screening these values.
 34244                                  ; The bit values are defined in DOSSYM.INC
 34245                                  
 34246                                  ;	      ; ^A and NUL
 34247                                  ;CharType:
 34248                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34249                                  ;	      ; ^C and ^B
 34250                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34251                                  ;	      ; ^E and ^D
 34252                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34253                                  ;	      ; ^G and ^F
 34254                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34255                                  ;	      ; TAB and BS
 34256                                  ;	 db   LOW ((NOT FFCB+FCHK+FDELIM+FSPCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34257                                  ;	      ; ^K and ^J
 34258                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34259                                  ;	      ; ^M and ^L
 34260                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34261                                  ;	      ; ^O and ^N
 34262                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34263                                  ;	      ; ^Q and ^P
 34264                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34265                                  ;	      ; ^S and ^R
 34266                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34267                                  ;	      ; ^U and ^T
 34268                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34269                                  ;	      ; ^W and ^V
 34270                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34271                                  ;	      ; ^Y and ^X
 34272                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34273                                  ;	      ; ESC and ^Z
 34274                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34275                                  ;	      ; ^] and ^;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34277                                  ;	      ; ^_ and ^^
 34278                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34279                                  ;	      ; ! and SPACE
 34280                                  ;	 db   LOW (NOT FCHK+FDELIM+FSPCHK)
 34281                                  ;	      ; # and "
 34282                                  ;	 db   LOW (NOT FFCB+FCHK)
 34283                                  ;	      ; $ - )
 34284                                  ;	 db   3 dup (0FFh)
 34285                                  ;	      ; + and *
 34286                                  ;	 db   LOW ((NOT FFCB+FCHK+FDELIM) SHL 4) OR 0Fh
 34287                                  ;	      ; - and '
 34288                                  ;	 db   NOT (FFCB+FCHK+FDELIM)
 34289                                  ;	      ; / and .
 34290                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FCHK) AND 0Fh
 34291                                  ;	      ; 0 - 9
 34292                                  ;	 db   5 dup (0FFh)
 34293                                  ;	      ; ; and :
 34294                                  ;	 db   LOW ((NOT FFCB+FCHK+FDELIM) SHL 4) OR LOW (NOT FFCB+FCHK+FDELIM) AND 0Fh
 34295                                  ;	      ; = and <
 34296                                  ;	 db   LOW ((NOT FFCB+FCHK+FDELIM) SHL 4) OR LOW (NOT FFCB+FCHK+FDELIM) AND 0Fh
 34297                                  ;	      ; ? and >
 34298                                  ;	 db   NOT FFCB+FCHK+FDELIM
 34299                                  ;	      ; A - Z
 34300                                  ;	 db   13 dup (0FFh)
 34301                                  ;	      ; \ and [
 34302                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR 0Fh
 34303                                  ;	      ; ^ and ]
 34304                                  ;	 db   LOW ((NOT FFCB+FCHK) SHL 4) OR LOW (NOT FFCB+FCHK) AND 0Fh
 34305                                  ;	      ; _ - {
 34306                                  ;	 db   15 dup (0FFh)
 34307                                  ;	      ; } and |
 34308                                  ;	 db   NOT FFCB+FCHK+FDELIM
 34309                                  
 34310                                  ;CharType_last equ ($ - CharType) * 2	; This is the value of the last
 34311                                  ;					; character in the table
 34312                                  
 34313                                  ;FCHK	equ 1		; normal name char, no chks needed
 34314                                  ;FDELIM	equ 2		; is a delimiter
 34315                                  ;FSPCHK	equ 4		; set if character is not a space or equivalent
 34316                                  ;FFCB	equ 8		; is valid in an FCB
 34317                                  
 34318                                  ; DOSCODE:8FD2h (MSDOS 6.21, MSDOS.SYS)
 34319                                  ;----------------------------------------------------------------------------
 34320                                  ; DOSCODE:8F76h (MSDOS 5.0, MSDOS.SYS)
 34321                                  
 34322                                  CharType: ; 63 bytes
 34323 000059FD 6666666606666666                db  66h, 66h, 66h, 66h, 06h, 66h, 66h, 66h ; 0-7
 34324 00005A05 6666666666666666        	db  66h, 66h, 66h, 66h, 66h, 66h, 66h, 66h ; 8-15
 34325 00005A0D F8F6FFFFFF4FF46E        	db 0F8h,0F6h,0FFh,0FFh,0FFh, 4Fh,0F4h, 6Eh ; 16-23
 34326 00005A15 FFFFFFFFFF4444F4        	db 0FFh,0FFh,0FFh,0FFh,0FFh, 44h, 44h,0F4h ; 24-31
 34327 00005A1D FFFFFFFFFFFFFFFF        	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh ; 32-39
 34328 00005A25 FFFFFFFFFF6F66FF        	db 0FFh,0FFh,0FFh,0FFh,0FFh, 6Fh, 66h,0FFh ; 40-47
 34329 00005A2D FFFFFFFFFFFFFFFF        	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh ; 48-55
 34330 00005A35 FFFFFFFFFFFFF4          	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0F4h	   ; 56-62
 34331                                  
 34332                                  CharType_last equ ($ - CharType) * 2
 34333                                  
 34334                                  ; Offset 12CAh of IBMDOS.COM (MSDOS 3.3), 1987
 34335                                  ;----------------------------------------------------------------------------
 34336                                  ;CharType:
 34337                                  ;       db 0F6h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h
 34338                                  ;	db 0F6h,0F0h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h
 34339                                  ;	db 0F6h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h
 34340                                  ;	db 0F6h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h,0F6h
 34341                                  ;	db 0F8h,0FFh,0F6h,0FFh,0FFh,0FFh,0FFh,0FFh
 34342                                  ;	db 0FFh,0FFh,0FFh,0F4h,0F4h,0FFh,0FEh,0F6h
 34343                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34344                                  ;	db 0FFh,0FFh,0F4h,0F4h,0F4h,0F4h,0F4h,0FFh
 34345                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34346                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34347                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34348                                  ;	db 0FFh,0FFh,0FFh,0F6h,0F6h,0F6h,0FFh,0FFh
 34349                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34350                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34351                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34352                                  ;	db 0FFh,0FFh,0FFh,0FFh,0F4h,0FFh,0FFh,0FFh
 34353                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34354                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34355                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34356                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34357                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34358                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34359                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34360                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34361                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34362                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34363                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34364                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34365                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34366                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34367                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34368                                  ;	db 0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
 34369                                  
 34370                                  ;hkn; Table	ENDS
 34371                                  
 34372                                  ;ENDIF
 34373                                  
 34374                                  ; 20/05/2019 - Retro DOS v4.0
 34375                                  ; DOSCODE:9011h (MSDOS 6.21, MSDOS.SYS)
 34376                                  
 34377                                  ; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 34378                                  ; DOSCODE:8FB5h (MSDOS 5.0, MSDOS.SYS)
 34379                                  
 34380                                  ;----------------------------------------------------------------------------
 34381                                  ;
 34382                                  ; Procedure Names : GetLet, UCase, GetLet3
 34383                                  ;
 34384                                  ; These routines take a character, convert it to upper case, and check
 34385                                  ; for delimiters.  Three different entry points:
 34386                                  ;	GetLet -  DS:[SI] = character to convert
 34387                                  ;	UCase  -  AL = character to convert
 34388                                  ;	GetLet3 - AL = character
 34389                                  ;		  [BX] = translation table to use
 34390                                  ;
 34391                                  ;	Exit (in all cases) : AL = upper case character
 34392                                  ;			      CY set if char is control char other than TAB
 34393                                  ;			      ZF set if char is a delimiter
 34394                                  ;	Uses : AX, flags
 34395                                  ;
 34396                                  ; NOTE: This routine exists in a fast table lookup version, and a slow
 34397                                  ; inline version.  Return with carry set is only possible in the inline
 34398                                  ; version. The table lookup version is the one in use.
 34399                                  ;
 34400                                  ;----------------------------------------------------------------------------
 34401                                  
 34402                                  ; This entry point has character at [SI]
 34403                                  
 34404                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5517h
 34405                                  GETLET:	
 34406 00005A3C AC                      	LODSB
 34407                                  
 34408                                  ; This entry point has character in AL
 34409                                  
 34410                                  	;entry	UCase
 34411                                  UCase:	
 34412                                  	; 09/08/2018
 34413                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5518h
 34414                                  _UCase:
 34415 00005A3D 53                      	PUSH	BX
 34416 00005A3E BB[7E0B]                	MOV	BX,FILE_UCASE_TAB+2
 34417                                  
 34418                                  ; Convert the character in AL to upper case
 34419                                  
 34420                                  gl_0:
 34421 00005A41 3C61                    	CMP	AL,"a"
 34422 00005A43 7214                    	JB	short gl_2	; Already upper case, go check type
 34423 00005A45 3C7A                    	CMP	AL,"z"
 34424 00005A47 7702                    	JA	short gl_1
 34425 00005A49 2C20                    	SUB	AL,20H		; Convert to upper case
 34426                                  
 34427                                  ; Map European character to upper case
 34428                                  
 34429                                  gl_1:
 34430 00005A4B 3C80                    	CMP	AL,80H
 34431 00005A4D 720A                    	JB	short gl_2	; Not EuroChar, go check type
 34432 00005A4F 2C80                    	SUB	AL,80H		; translate to upper case with this index
 34433                                  
 34434                                  	; M048 - Start 
 34435                                  	; Lantastic call Ucase thru int 2f without setting SS to DOSDATA.
 34436                                  	; So we shall set up DS and to access FILE_UCASE_TAB in BX and also 
 34437                                  	; preserve it.
 34438                                  
 34439                                  	; 09/08/2018 - Retro DOS v3.0
 34440                                  	; MSDOS 3.3
 34441                                  	;;XLAT	BYTE [CS:BX]	; ds as file_ucase_tab is in DOSDATA
 34442                                  	;CS	XLAT
 34443                                  
 34444                                  	; 20/05/2019 - Retro DOS v4.0
 34445                                  
 34446                                  	; MSDOS 6.0
 34447 00005A51 1E                      	push	ds
 34448                                  	;getdseg <ds>
 34449 00005A52 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 34450 00005A57 D7                      	XLAT			; ds as file_ucase_tab is in DOSDATA
 34451 00005A58 1F                      	pop	ds
 34452                                  
 34453                                  	; M048 - End
 34454                                  
 34455                                  ; Now check the type
 34456                                  
 34457                                  ;If TableLook
 34458                                  gl_2:
 34459                                  	; 20/05/2019 - Retro DOS v4.0
 34460 00005A59 50                      	PUSH	AX
 34461                                  
 34462                                  	; MSDOS 3.3
 34463                                  	;mov	bx,CharType
 34464                                  	;; 09/08/2018
 34465                                  	;;xlat	byte [cs:bx]
 34466                                  	;cs	xlat	
 34467                                  	
 34468                                  	; MSDOS 6.0
 34469 00005A5A E81800                  	CALL	GetCharType	; returns type flags in AL
 34470                                  	
 34471                                  	;test	al,1	
 34472 00005A5D A801                    	TEST	AL,FCHK 	; test for normal character
 34473 00005A5F 58                      	POP	AX
 34474                                  
 34475 00005A60 5B                      	POP	BX
 34476 00005A61 C3                      	RETN
 34477                                  
 34478                                  ; This entry has character in AL and lookup table in BX
 34479                                  
 34480                                  	; MSDOS 6.0
 34481                                  ;	;entry GetLet3
 34482                                  GETLET3: ; 10/08/2018
 34483 00005A62 53                      	PUSH	BX
 34484 00005A63 EBDC                    	JMP	short gl_0
 34485                                  ;ELSE
 34486                                  ;
 34487                                  ;gl_2:
 34488                                  ;	POP	BX
 34489                                  ;	CMP	AL,"."
 34490                                  ;	retz
 34491                                  ;	CMP	AL,'"'
 34492                                  ;	retz
 34493                                  ;	CALL	PATHCHRCMP
 34494                                  ;	retz
 34495                                  ;	CMP	AL,"["
 34496                                  ;	retz
 34497                                  ;	CMP	AL,"]"
 34498                                  ;	retz
 34499                                  ;ENDIF
 34500                                  
 34501                                  ;---------------------------------------------------------------------
 34502                                  ;
 34503                                  ; DELIM - check if character is a delimiter
 34504                                  ;	Entry : AX = character to check
 34505                                  ;	Exit  : ZF set if character is not a delimiter
 34506                                  ;	Uses  : Flags
 34507                                  ;
 34508                                  ;--------------------------------------------------------------------
 34509                                  
 34510                                  	;entry	DELIM
 34511                                  DELIM:
 34512                                  ;IF TableLook
 34513                                  	; 20/05/2019 - Retro DOS v4.0
 34514 00005A65 50                      	PUSH	AX
 34515                                  
 34516                                  	; MSDOS 3.3
 34517                                  	;push	bx
 34518                                  	;mov	bx,CharType
 34519                                  	;;09/08/2018
 34520                                  	;;xlat	byte [cs:bx]
 34521                                  	;cs	xlat
 34522                                  	;pop	bx
 34523                                  
 34524                                  	; MSDOS 6.0
 34525 00005A66 E80C00                  	CALL	GetCharType
 34526                                  	
 34527                                  	;test	al,2
 34528 00005A69 A802                    	TEST	AL,FDELIM
 34529 00005A6B 58                      	POP	AX
 34530 00005A6C C3                      	RETN
 34531                                  ;ELSE
 34532                                  ;	CMP	AL,":"
 34533                                  ;	retz
 34534                                  ;
 34535                                  ;	CMP	AL,"<"
 34536                                  ;	retz
 34537                                  ;	CMP	AL,"|"
 34538                                  ;	retz
 34539                                  ;	CMP	AL,">"
 34540                                  ;	retz
 34541                                  ;
 34542                                  ;	CMP	AL,"+"
 34543                                  ;	retz
 34544                                  ;	CMP	AL,"="
 34545                                  ;	retz
 34546                                  ;	CMP	AL,";"
 34547                                  ;	retz
 34548                                  ;	CMP	AL,","
 34549                                  ;	retz
 34550                                  ;ENDIF
 34551                                  
 34552                                  ;-------------------------------------------------------------------------
 34553                                  ;
 34554                                  ;  SPCHK - checks to see if a character is a space or equivalent
 34555                                  ;	Entry : AL = character to check
 34556                                  ;	Exit  : ZF set if character is a space
 34557                                  ;	Uses  : flags
 34558                                  ;
 34559                                  ;-------------------------------------------------------------------------
 34560                                  
 34561                                  	;entry SPCHK
 34562                                  SPCHK:
 34563                                  ;IF TableLook
 34564                                  	; 20/05/2019 - Retro DOS v4.0
 34565 00005A6D 50                      	PUSH	AX
 34566                                  
 34567                                  	; MSDOS 3.3
 34568                                  	;push	bx
 34569                                  	;mov	bx,CharType
 34570                                  	;; 09/08/2018
 34571                                  	;;xlat	byte [cs:bx]
 34572                                  	;cs	xlat
 34573                                  	;pop	bx
 34574                                  
 34575                                  	; MSDOS 6.0
 34576 00005A6E E80400                  	CALL	GetCharType
 34577                                  	
 34578                                  	;test	al,4
 34579 00005A71 A804                    	TEST	AL,FSPCHK
 34580 00005A73 58                      	POP	AX
 34581 00005A74 C3                      	RETN
 34582                                  ;ELSE
 34583                                  ;	CMP	AL,9		; Filter out tabs too
 34584                                  ;	retz
 34585                                  ;; WARNING! " " MUST be the last compare
 34586                                  ;	CMP	AL," "
 34587                                  ;	return
 34588                                  ;ENDIF
 34589                                  
 34590                                  ;-------------------------------------------------------------------------
 34591                                  ;
 34592                                  ;  GetCharType - return flag bits indicating character type
 34593                                  ;	Bits are defined in DOSSYM.INC. Uses lookup table
 34594                                  ;	defined above at label CharType.
 34595                                  ;
 34596                                  ;	Entry : AL = character to return type flags for
 34597                                  ;	Exit  : AL = type flags
 34598                                  ;	Uses  : AL, flags
 34599                                  ;
 34600                                  ;-------------------------------------------------------------------------
 34601                                  
 34602                                  	; 29/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 34603                                  
 34604                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 34605                                  
 34606                                  	; 20/05/2019 - Retro DOS v4.0
 34607                                  	; MSDOS 6.0
 34608                                  
 34609                                  GetCharType:
 34610                                  	;cmp	al,7Eh
 34611 00005A75 3C7E                    	cmp	al,CharType_last 	; beyond end of table?
 34612 00005A77 7314                    	jae	short gct_90		; return standard value
 34613                                  
 34614 00005A79 53                      	push	bx
 34615 00005A7A BB[FD59]                	mov	bx,CharType		; load lookup table
 34616 00005A7D D0E8                    	shr	al,1			; adjust for half-byte table entry size
 34617                                  	;xlat	cs:[bx] 		; get flags
 34618 00005A7F 2ED7                    	cs	xlat	
 34619 00005A81 5B                      	pop	bx
 34620                                  
 34621                                  ; carry clear from previous shift means we want the low nibble.  Otherwise
 34622                                  ; we have to shift the flags down to the low nibble
 34623                                  
 34624 00005A82 7306                    	jnc	short gct_80		; carry clear, no shift needed
 34625                                  
 34626                                  ; 29/02/2024
 34627                                  %if 0
 34628                                  	shr	al,1			; we want high nibble, shift it down
 34629                                  	shr	al,1
 34630                                  	shr	al,1
 34631                                  	shr	al,1
 34632                                  %else
 34633                                  	; 29/02/2024 (PCDOS 7.1 IBMDOS.COM)
 34634                                  	;;;
 34635 00005A84 51                      	push	cx
 34636 00005A85 B104                    	mov	cl,4			; we want high nibble, shift it down
 34637 00005A87 D2E8                    	shr	al,cl
 34638 00005A89 59                      	pop	cx
 34639                                  	;;;
 34640                                  %endif
 34641                                  
 34642                                  gct_80:
 34643 00005A8A 240F                    	and	al,0Fh			; clear the unused nibble
 34644 00005A8C C3                      	retn
 34645                                  gct_90:
 34646 00005A8D B00F                    	mov	al,0Fh			; set all flags
 34647 00005A8F C3                      	retn
 34648                                  
 34649                                  ;----------------------------------------------------------------------------
 34650                                  ;
 34651                                  ; Procedure : PATHCHRCMP
 34652                                  ;
 34653                                  ;----------------------------------------------------------------------------
 34654                                  
 34655                                  PATHCHRCMP:
 34656 00005A90 3C2F                    	CMP	AL,'/'
 34657 00005A92 7606                    	JBE	short PathRet
 34658 00005A94 3C5C                    	CMP	AL,'\'
 34659 00005A96 C3                      	retn
 34660                                  GotFor:
 34661 00005A97 B05C                    	MOV	AL,'\'
 34662 00005A99 C3                      	retn
 34663                                  PathRet:
 34664 00005A9A 74FB                    	JZ	short GotFor
 34665 00005A9C C3                      	retn
 34666                                  
 34667                                  ;============================================================================
 34668                                  ; MSCRTLC.ASM, MSDOS 6.0, 1991
 34669                                  ;============================================================================
 34670                                  ; 30/07/2018 - Retro DOS v3.0
 34671                                  ; 29/04/2019 - Retro DOS v4.0
 34672                                  ; 29/02/2024 - Retro DOS v5.0
 34673                                  
 34674                                  ; 15/03/2018 - Retro DOS v2.0 (MSDOS 2.11, CTRLC.ASM, 1983)
 34675                                  
 34676                                  ;**	MSCTRLC.ASM - ^C and error handler for MSDOS
 34677                                  
 34678                                  ;	TITLE	Control C detection, Hard error and EXIT routines
 34679                                  ;	NAME	IBMCTRLC
 34680                                  
 34681                                  ;**	Low level routines for detecting special characters on CON input,
 34682                                  ;	the ^C exit/int code, the Hard error INT 24 code, the
 34683                                  ;	process termination code, and the INT 0 divide overflow handler.
 34684                                  ;
 34685                                  ;	FATAL
 34686                                  ;	FATAL1
 34687                                  ;	reset_environment
 34688                                  ;	DSKSTATCHK
 34689                                  ;	SPOOLINT
 34690                                  ;	STATCHK
 34691                                  ;	CNTCHAND
 34692                                  ;	DIVOV
 34693                                  ;	CHARHARD
 34694                                  ;	HardErr
 34695                                  ;
 34696                                  ;	Revision history:
 34697                                  ;
 34698                                  ;	    AN000	version 4.0   Jan 1988
 34699                                  ;	    A002	PTM    -- dir >lpt3 hangs
 34700                                  ;	    A003	PTM 3957- fake version for IBMCAHE.COM
 34701                                  ;
 34702                                  ; 	M011: NEC's 8086 clone chip uses Intel's undocumented bit number in
 34703                                  ;	      flags register. In order to return to user normally DOS used to
 34704                                  ;	      move F202 into flags, which sets bit number 1 in flags uncondit-
 34705                                  ;	      ionally. Now it is modified to maintain the state of bit 1.
 34706                                  ;
 34707                                  ; 	M024: suppressed fail and ignore options if not in the middle of int 
 34708                                  ;	      24 and if Ctrl P or ctrl printscrn is pressed in routine 
 34709                                  ;	      charhard.
 34710                                  
 34711                                  ; 29/04/2019 - Retro DOS v4.0
 34712                                  	; MSDOS 6.0
 34713                                  ;		public	LowInt23Addr		
 34714                                  LowInt23Addr: ;	LABEL	DWORD
 34715 00005A9D [CA0F]0000              	DW	LowInt23, 0
 34716                                  
 34717                                  ;		public	LowInt24Addr
 34718                                  LowInt24Addr: ;	LABEL	DWORD
 34719 00005AA1 [DE0F]0000              	DW	LowInt24, 0
 34720                                  
 34721                                  ;		public	LowInt28Addr
 34722                                  LowInt28Addr: ;	LABEL	DWORD
 34723 00005AA5 [F20F]0000              	DW	LowInt28, 0
 34724                                  
 34725                                  ;Break	<Checks for ^C in CON I/O>
 34726                                  
 34727                                  ; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 34728                                  ; 05/05/2019 - Retro DOS v4.0
 34729                                  
 34730                                  ;---------------------------------------------------------------------------
 34731                                  ;
 34732                                  ; Procedure Name : DSKSTATCHK
 34733                                  ;
 34734                                  ; Check for ^C if only one level in
 34735                                  ;
 34736                                  ;---------------------------------------------------------------------------
 34737                                  
 34738                                          ;procedure DSKSTATCHK,NEAR ; Check for ^C if only one level in
 34739                                  
 34740                                  	; 29/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 34741                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:9F51h
 34742                                  
 34743                                  DSKSTATCHK:        
 34744 00005AA9 36803E[2103]01                          cmp     byte [ss:INDOS], 1
 34745 00005AAF 7401                                    jz      short dskstatchk1
 34746 00005AB1 C3                                      retn
 34747                                  dskstatchk1:                            ; ...
 34748 00005AB2 51                                      push    cx
 34749 00005AB3 06                                      push    es
 34750 00005AB4 53                                      push    bx
 34751 00005AB5 1E                                      push    ds
 34752 00005AB6 56                                      push    si
 34753 00005AB7 8CD3                                    mov     bx, ss
 34754 00005AB9 8EC3                                    mov     es, bx
 34755 00005ABB 8EDB                                    mov     ds, bx
 34756 00005ABD C606[9403]05                            mov     byte [DSKSTCOM], 5  ; DEVRDND
 34757 00005AC2 C606[9203]0E                            mov     byte [DSKSTCALL], 14 ; DRDNDHL
 34758 00005AC7 C606[9503]00                            mov     byte [DSKSTST], 0
 34759 00005ACC BB[9203]                                mov     bx, DSKSTCALL
 34760 00005ACF C536[3200]                              lds     si, [BCON]
 34761 00005AD3 E8A2F4                                  call    DEVIOCALL2
 34762 00005AD6 1E                                      push    ds
 34763 00005AD7 16                                      push    ss
 34764 00005AD8 1F                                      pop     ds
 34765 00005AD9 F606[9603]02                            test    byte [DSKSTST+1], 2
 34766 00005ADE 7409                                    jz      short _GotCh
 34767 00005AE0 30C0                                    xor     al, al
 34768                                  
 34769                                  RET36:                                  ; ...
 34770 00005AE2 5E                                      pop     si
 34771 00005AE3 5E                                      pop     si
 34772 00005AE4 1F                                      pop     ds
 34773 00005AE5 5B                                      pop     bx
 34774 00005AE6 07                                      pop     es
 34775 00005AE7 59                                      pop     cx
 34776 00005AE8 C3                                      retn
 34777                                  _GotCh:
 34778 00005AE9 A0[9F03]                                mov     al, [DSKCHRET]
 34779 00005AEC 3C03                                    cmp     al, 3           ; "C"-"@"
 34780 00005AEE 75F2                                    jnz     short RET36
 34781 00005AF0 C606[9403]04                            mov     byte [DSKSTCOM], 4  ; DEVRD
 34782 00005AF5 C606[9203]16                            mov     byte [DSKSTCALL], 16h ; DRDWRHL
 34783 00005AFA 880E[9F03]                              mov     [DSKCHRET], cl
 34784 00005AFE C706[9503]0000                          mov     word [DSKSTST], 0
 34785 00005B04 C706[A403]0100                          mov     word [DSKSTCNT], 1
 34786 00005B0A 1F                                      pop     ds
 34787 00005B0B E86AF4                                  call    DEVIOCALL2      ; Eat the ^C
 34788 00005B0E 5E                                      pop     si
 34789 00005B0F 1F                                      pop     ds
 34790 00005B10 5B                                      pop     bx
 34791 00005B11 07                                      pop     es
 34792 00005B12 59                                      pop     cx
 34793 00005B13 E9CF00                                  jmp     CNTCHAND
 34794                                  
 34795                                  	; 05/05/2019
 34796                                  NOSTOP:
 34797                                  	; MSDOS 6.0
 34798 00005B16 3C10                    	CMP	AL,"P"-"@"
 34799 00005B18 7509                    	JNZ	short check_next
 34800                                  				    	; SS override
 34801 00005B1A 36803E[BC0D]00          	CMP	BYTE [SS:SCAN_FLAG],0	; ALT_Q ?
 34802 00005B20 7405                    	JZ	short INCHKJ		; no
 34803                                  check_end:	; 24/09/2023
 34804 00005B22 C3                      	retn
 34805                                  check_next:
 34806                                  	;IF	NOT TOGLPRN
 34807                                  	;CMP	AL,"N"-"@"
 34808                                  	;JZ	short INCHKJ
 34809                                  	;ENDIF
 34810                                  
 34811 00005B23 3C03                    	CMP	AL,"C"-"@"
 34812                                  	; 24/09/2023
 34813                                  	;JZ	short INCHKJ
 34814                                  ;check_end:
 34815                                  	;retn
 34816 00005B25 75FB                    	jnz	short check_end
 34817                                  
 34818                                  	; 24/09/2023
 34819                                  	; 08/09/2018
 34820                                  INCHKJ:	; 10/08/2018
 34821 00005B27 E9A500                  	jmp	INCHK
 34822                                  
 34823                                  	; MSDOS 3.3
 34824                                          ;CMP	AL,"P"-"@"  ; cmp al,16
 34825                                          ;JZ	short INCHKJ
 34826                                  
 34827                                  	; 15/04/2018
 34828                                          ;;IF	NOT TOGLPRN
 34829                                          ;CMP	AL,"N"-"@"
 34830                                          ;JZ	SHORT INCHKJ
 34831                                          ;;ENDIF
 34832                                  	
 34833                                  	;CMP	AL,"C"-"@"  ; cmp al,3
 34834                                          ;JZ	short INCHKJ
 34835                                  	;RETN
 34836                                  
 34837                                  ;	; 08/09/2018
 34838                                  ;INCHKJ:; 10/08/2018
 34839                                  ;	JMP	INCHK
 34840                                  
 34841                                  ;----------------------------------------------------------------------------
 34842                                  ;
 34843                                  ; Procedure Name : SpoolInt
 34844                                  ;
 34845                                  ; SpoolInt - signal processes that the DOS is truly idle. We are allowed to
 34846                                  ; do this ONLY if we are working on a 1-12 system call AND if we are not in
 34847                                  ; the middle of an INT 24.
 34848                                  ;
 34849                                  ;----------------------------------------------------------------------------
 34850                                  
 34851                                  SPOOLINT:
 34852 00005B2A 9C                      	PUSHF
 34853                                  	; 15/03/2018
 34854 00005B2B 36803E[5803]00          	CMP	BYTE [SS:IDLEINT],0	; SS override
 34855 00005B31 7423                    	JZ	SHORT POPFRET
 34856 00005B33 36803E[2003]00          	CMP	BYTE [SS:ERRORMODE],0
 34857 00005B39 751B                    	JNZ	SHORT POPFRET		; No spool ints in error mode
 34858                                  
 34859                                  	; 30/07/2018
 34860                                  
 34861                                  	; Note that we are going to allow an external program to issue system 
 34862                                  	; calls at this time. We MUST preserve IdleInt across this.
 34863                                  
 34864 00005B3B 36FF36[5803]            	PUSH	WORD [SS:IDLEINT]
 34865                                  
 34866                                  	; 05/05/2019 - Retro DOS v4.0
 34867                                   
 34868                                  	; MSDOS 6.0
 34869 00005B40 36803E[660D]00          	cmp	byte [SS:DosHasHMA],0	; Q: is dos running in HMA (M021)
 34870 00005B46 7504                    	jne	short do_low_int28	; Y: the int must be done from low mem
 34871 00005B48 CD28                    	INT	int_spooler  ; int 28h	; N: Execute user int 28 handler
 34872 00005B4A EB05                    	jmp	short spool_ret_addr
 34873                                  
 34874                                  do_low_int28:
 34875                                  	;call	far [ss:LowInt28Addr]
 34876 00005B4C 2EFF1E[A55A]            	call	far [cs:LowInt28Addr]	; 05/05/2019
 34877                                  
 34878                                  spool_ret_addr:
 34879                                  	;INT	int_spooler		; INT 28h
 34880                                  
 34881 00005B51 368F06[5803]            	POP	WORD [SS:IDLEINT]
 34882                                  POPFRET:
 34883 00005B56 9D                      	POPF
 34884                                  _RET18:  
 34885 00005B57 C3                      	RETN
 34886                                  
 34887                                  ; 05/05/2019 - Retro DOS v4.0
 34888                                  ; DOSCODE:9137h (MSDOS 6.21, MSDOS.SYS)
 34889                                  ; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 34890                                  ; DOSCODE:90DBh (MSDOS 5.0, MSDOS.SYS)
 34891                                  
 34892                                  ;----------------------------------------------------------------------------
 34893                                  ;
 34894                                  ; Procedure Name : STATCHK
 34895                                  ;
 34896                                  ;----------------------------------------------------------------------------
 34897                                  
 34898                                  STATCHK:
 34899 00005B58 E84EFF                          CALL	DSKSTATCHK              ; Allows ^C to be detected under
 34900                                                                          ; input redirection
 34901 00005B5B 53                              PUSH    BX
 34902 00005B5C 31DB                            XOR     BX,BX
 34903 00005B5E E839E2                          CALL	GET_IO_SFT
 34904 00005B61 5B                              POP     BX
 34905 00005B62 72F3                            JC      SHORT _RET18
 34906                                  
 34907 00005B64 B401                            MOV     AH,1
 34908 00005B66 E842F2                          CALL	IOFUNC
 34909 00005B69 74BF                            JZ      SHORT SPOOLINT
 34910 00005B6B 3C13                            CMP     AL,'S'-'@'
 34911 00005B6D 75A7                            JNZ     SHORT NOSTOP
 34912                                  
 34913                                  	; 05/05/2019
 34914                                  	; MSDOS 6.0			; SS override
 34915 00005B6F 36803E[BC0D]00          	CMP	BYTE [SS:SCAN_FLAG],0	; AN000; ALT_R ?
 34916 00005B75 75AB                    	JNZ	short check_end		; AN000; yes
 34917                                  
 34918 00005B77 30E4                            XOR     AH,AH
 34919 00005B79 E82FF2                          CALL	IOFUNC                  ; Eat Cntrl-S
 34920 00005B7C EB4A                            JMP     SHORT PAUSOSTRT
 34921                                  PRINTOFF:
 34922                                  PRINTON:
 34923 00005B7E 36F616[FE02]            	NOT	BYTE [SS:PFLAG] ; 14/03/2018
 34924                                  
 34925                                  	; 30/07/2018 - Retro DOS v3.0
 34926 00005B83 53                      	PUSH	BX
 34927 00005B84 BB0400                  	MOV	BX,4
 34928 00005B87 E810E2                  	call	GET_IO_SFT
 34929 00005B8A 5B                      	POP	BX
 34930 00005B8B 72CA                    	jc	short _RET18
 34931 00005B8D 06                      	PUSH	ES
 34932 00005B8E 57                      	PUSH	DI
 34933 00005B8F 1E                      	PUSH	DS
 34934 00005B90 07                      	POP	ES
 34935 00005B91 89F7                    	MOV	DI,SI			; ES:DI -> SFT
 34936                                  	;test	word [es:di+5],800h
 34937                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_net_spool
 34938                                  	; 05/05/2019
 34939 00005B93 26F6450608              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_net_spool>>8)
 34940 00005B98 7418                    	JZ	short NORM_PR 		; Not redirected, echo is OK
 34941                                  
 34942                                  	;Callinstall NetSpoolEchoCheck,MultNet,38,<AX>,<AX> 
 34943                                  					; See if allowed
 34944 00005B9A 50                      	push	ax
 34945 00005B9B B82611                  	mov	ax,1126h
 34946 00005B9E CD2F                    	int	2Fh	; Multiplex - NETWORK REDIRECTOR - ???
 34947                                  			; Return: CF set on error, AX = error code
 34948                                  			; STACK unchanged
 34949 00005BA0 58                      	pop	ax
 34950                                  
 34951 00005BA1 730F                    	JNC	short NORM_PR 		; Echo is OK
 34952                                  
 34953                                  					; SS override
 34954 00005BA3 36C606[FE02]00          	MOV	BYTE [SS:PFLAG],0	; If not allowed, disable echo
 34955                                  
 34956                                  	;Callinstall NetSpoolClose,MultNet,36,<AX>,<AX> ; and close
 34957                                  
 34958 00005BA9 50                      	push    ax
 34959 00005BAA B82411                  	mov     ax,1124h
 34960 00005BAD CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - ???
 34961                                  			; ES:DI -> SFT, SS = DOS CS
 34962 00005BAF 58                      	pop     ax
 34963                                  
 34964 00005BB0 EB10                    	JMP	SHORT RETP6
 34965                                  NORM_PR:
 34966 00005BB2 36803E[FE02]00          	CMP	BYTE [SS:PFLAG],0	; SS override
 34967 00005BB8 7505                    	JNZ	short PRNOPN
 34968 00005BBA E842F3                  	call	DEV_CLOSE_SFT
 34969 00005BBD EB03                    	JMP	SHORT RETP6
 34970                                  PRNOPN:
 34971 00005BBF E835F3                  	call	DEV_OPEN_SFT
 34972                                  RETP6:
 34973 00005BC2 5F                      	POP	DI
 34974 00005BC3 07                      	POP	ES
 34975                                  STATCHK_RETN:
 34976 00005BC4 C3                              RETN
 34977                                  PAUSOLP:
 34978 00005BC5 E862FF                          CALL    SPOOLINT
 34979                                  PAUSOSTRT:
 34980 00005BC8 B401                            MOV     AH,1
 34981 00005BCA E8DEF1                          CALL	IOFUNC
 34982 00005BCD 74F6                            JZ      SHORT PAUSOLP
 34983                                  INCHK:
 34984 00005BCF 53                              PUSH    BX
 34985 00005BD0 31DB                            XOR     BX,BX
 34986 00005BD2 E8C5E1                          CALL	GET_IO_SFT
 34987 00005BD5 5B                              POP     BX
 34988 00005BD6 72EC                            JC      SHORT STATCHK_RETN ; 30/07/2018
 34989 00005BD8 30E4                            XOR     AH,AH
 34990 00005BDA E8CEF1                          CALL	IOFUNC
 34991                                  	; 30/07/2018
 34992                                  	; MSDOS 3.3
 34993                                          ;CMP	AL,'P'-'@' ;cmp al,16
 34994                                          ;JNZ	SHORT NOPRINT
 34995                                  
 34996                                  	;cmp	byte [SS:SCAN_FLAG],0
 34997                                  	;JZ	SHORT PRINTON	
 34998                                  	;mov	byte [ss:SCAN_FLAG],0
 34999                                  
 35000                                  	; 05/05/2019
 35001                                  	; MSDOS 6.0
 35002 00005BDD 3C10                    	CMP	AL,"P"-"@"
 35003                                  	;;;;  7/14/86	ALT_Q key fix
 35004 00005BDF 749D                    	JZ	short PRINTON		; no! must be CTRL_P
 35005                                  ;NOPRINT:	
 35006                                  	;IF	NOT TOGLPRN
 35007                                  	;CMP	AL,"N"-"@"
 35008                                  	;JZ	short PRINTOFF
 35009                                  	;ENDIF
 35010 00005BE1 3C03                    	CMP	AL,"C"-"@" ; cmp al,3 
 35011                                  	;retnz
 35012 00005BE3 75DF                    	jnz	short STATCHK_RETN
 35013                                  
 35014                                  	; !! NOTE: FALL THROUGH !!
 35015                                  
 35016                                  ;---------------------------------------------------------------------------
 35017                                  ;
 35018                                  ; Procedure Name : CNTHAND ( CTRLC_C HANDLER )
 35019                                  ;
 35020                                  ; "^C" and CR/LF is printed. Then the user registers are restored and the
 35021                                  ; user CTRL-C handler is executed. At this point the top of the stack has 1)
 35022                                  ; the interrupt return address should the user CTRL-C handler wish to allow
 35023                                  ; processing to continue; 2) the original interrupt return address to the code
 35024                                  ; that performed the function call in the first place. If the user CTRL-C
 35025                                  ; handler wishes to continue, it must leave all registers unchanged and RET
 35026                                  ; (not IRET) with carry CLEAR. If carry is SET then an terminate system call
 35027                                  ; is simulated.
 35028                                  ;
 35029                                  ;---------------------------------------------------------------------------
 35030                                  
 35031                                  	; 29/02/2024 - Retro DOS v5.0
 35032                                  
 35033                                  CNTCHAND:
 35034                                  	; MSDOS 6.0			; SS override
 35035                                  					; AN002; from RAWOUT
 35036                                  	;TEST	word [SS:DOS34_FLAG],CTRL_BREAK_FLAG  
 35037                                  	;JNZ	short around_deadlock 	; AN002;
 35038                                  
 35039                                  	; 05/05/2019 - Retro DOS v4.0
 35040                                  	; (MSDOS 6.21 MSDOS.SYS DOSCODE:91C4h, 29/12/2022)
 35041 00005BE5 36F606[1206]02          	TEST	byte [SS:DOS34_FLAG+1],(CTRL_BREAK_FLAG>>8)  ; 2 
 35042 00005BEB 7508                    	JNZ	short around_deadlock 	; AN002;
 35043                                  
 35044 00005BED B003                            MOV     AL,3			; Display "^C"
 35045 00005BEF E875C0                          CALL	BUFOUT
 35046 00005BF2 E80ABF                          CALL	CRLF
 35047                                  around_deadlock:
 35048 00005BF5 16                              PUSH    SS
 35049 00005BF6 1F                              POP     DS
 35050 00005BF7 803E[5703]00                    CMP     BYTE [CONSWAP],0
 35051 00005BFC 7403                            JZ      SHORT NOSWAP
 35052 00005BFE E82DDE                          CALL	SWAPBACK
 35053                                  NOSWAP:
 35054 00005C01 FA                      	CLI				; Prepare to play with stack
 35055 00005C02 8E16[8605]              	MOV	SS,[USER_SS]		; User stack now restored
 35056 00005C06 8B26[8405]              	MOV	SP,[USER_SP]
 35057 00005C0A E834A8                          CALL	restore_world       ; User registers now restored
 35058                                  
 35059                                  	; 30/07/2018 - Retro DOS v3.0 
 35060                                  	; MSDOS 3.3 (IBMDOS.COM - Offset 56ACh)
 35061                                          ; 14/03/2018 - Retro DOS v2.0
 35062                                  	;MOV	BYTE [CS:INDOS],0	
 35063                                          ;MOV	BYTE [CS:ERRORMODE],0
 35064                                          ;MOV	[CS:ConC_Spsave],SP
 35065                                  	;clc	;30/07/2018
 35066                                          ;INT	int_ctrl_c ; 23h    ; Execute user Ctrl-C handler
 35067                                  	;;int	23h	; DOS - CONTROL "C" EXIT ADDRESS
 35068                                  			; Return: return via RETF 2 with CF set
 35069                                  			; DOS will abort program with errorlevel 0
 35070                                  			; else
 35071                                  			; interrupted DOS call continues
 35072                                  
 35073                                  	; 05/05/2019 - Retro DOS v4.0
 35074                                  	; MSDOS 6.0 (MSDOS 6.21, MSDOS.SYS,91ECh) 
 35075                                  
 35076                                  	; CS was used to address these variables. We have to use DOSDATA
 35077                                  	
 35078 00005C0D 07                      	pop	es ; *	; MSDOS 6.21 (MSDOS.SYS, DOSCODE:91ECh)
 35079                                  			; (pop es, after 'call restore_world')	
 35080 00005C0E 1E                      	push	ds
 35081                                  	;getdseg <ds>			; ds -> dosdata
 35082 00005C0F 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 35083 00005C14 C606[2103]00            	mov	byte [INDOS],0		; Go to known state
 35084                                  	; 29/02/2024 (PCDOS 7.1 IBMDOS.COM)
 35085                                  	;;;
 35086 00005C19 C606[C411]00            	mov	byte [INDOS_FLAG],0	; 2nd 'in dos' flag (what for?)
 35087                                  	;;;
 35088 00005C1E C606[2003]00            	mov	byte [ERRORMODE],0
 35089 00005C23 8926[3203]              	mov	[ConC_Spsave],SP	; save his SP
 35090                                  	; User SP has changed because of push. Adjust for it
 35091 00005C27 8306[3203]02            	add	word [ConC_Spsave],2
 35092                                  
 35093 00005C2C 803E[660D]00            	cmp	byte [DosHasHMA],0	; Q: is dos running in HMA (M021)
 35094 00005C31 1F                       	pop	ds	; restore ds
 35095 00005C32 7505                    	jne	short do_low_int23	; Y: the int must be done from low mem
 35096 00005C34 F8                      	CLC				
 35097 00005C35 CD23                    	INT	int_ctrl_c  ; int 23h	; N: Execute user Ctrl-C handler
 35098 00005C37 EB06                    	jmp	short ctrlc_ret_addr
 35099                                  
 35100                                  	; 05/05/2019
 35101                                  do_low_int23:
 35102 00005C39 F8                      	clc
 35103 00005C3A 2EFF1E[9D5A]            	call	far [cs:LowInt23Addr]
 35104                                  
 35105                                  	; 30/07/2018 
 35106                                  
 35107                                  	; MSDOS 3.3 (IBMDOS.COM - Offset 56C0h)
 35108                                  
 35109                                  ; The user has returned to us. The circumstances we allow are:
 35110                                  ;
 35111                                  ;   IRET	We retry the operation by redispatching the system call
 35112                                  ;   CLC/RETF	POP the stack and retry
 35113                                  ;   ... 	Exit the current process with ^C exit
 35114                                  ;
 35115                                  ; User's may RETURN to us and leave interrupts on. 
 35116                                  ; Turn 'em off just to be sure
 35117                                  
 35118                                  ctrlc_ret_addr: ; 05/05/2019
 35119                                  
 35120 00005C3F FA                      	CLI
 35121                                  
 35122                                  	; MSDOS 3.3 
 35123                                  	;MOV	[CS:USER_IN_AX],ax	; save the AX
 35124                                  	;PUSHF				; and the flags (maybe new call)
 35125                                  	;POP	AX
 35126                                  
 35127                                  	; 05/05/2019
 35128                                  	; MSDOS 6.0
 35129                                  
 35130                                  	; We have to use DOSDATA for these variables. Previously CS was used 
 35131                                  
 35132 00005C40 50                      	push	ax
 35133 00005C41 8CD8                    	mov	ax,ds
 35134                                  	;getdseg <ds>			; ds -> dosdata
 35135 00005C43 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 35136 00005C48 A3[630D]                	mov	[TEMPSEG],ax
 35137 00005C4B 58                      	pop	ax
 35138 00005C4C A3[3A03]                	MOV	[USER_IN_AX],ax		; save the AX
 35139 00005C4F 9C                      	pushf				; and the flags (maybe new call)
 35140 00005C50 58                      	pop	ax
 35141                                  
 35142                                  ; See if the input stack is identical to the output stack
 35143                                  
 35144                                  	; MSDOS 3.3
 35145                                  	;CMP	SP,[CS:ConC_Spsave]
 35146                                  	;JNZ	SHORT ctrlc_try_new	; current SP not the same as saved SP
 35147                                  
 35148                                  	; MSDOS 6.0
 35149 00005C51 3B26[3203]              	CMP	SP,[ConC_Spsave]
 35150 00005C55 750A                    	JNZ	SHORT ctrlc_try_new	; current SP not the same as saved SP
 35151                                  
 35152                                  ; Repeat the operation by redispatching the system call.
 35153                                  
 35154                                  ctrlc_repeat:
 35155                                  	; MSDOS 3.3
 35156                                  	;MOV	AX,[CS:USER_IN_AX]
 35157                                  	; 05/05/2019
 35158                                  	; MSDOS 6.0
 35159 00005C57 A1[3A03]                	mov	ax,[USER_IN_AX]
 35160 00005C5A 8E1E[630D]              	mov	ds,[TEMPSEG]		; restore ds and original sp
 35161                                  	; MSDOS 3.3 & MSDOS 6.0 
 35162                                  	;transfer COMMAND
 35163                                  COMMANDJ:
 35164 00005C5E E990A6                  	JMP	COMMAND
 35165                                  
 35166                                  ; The current SP is NOT the same as the input SP. Presume that he 
 35167                                  ; RETF'd leaving some flags on the stack and examine the input
 35168                                  
 35169                                  ctrlc_try_new:
 35170                                  	; 29/02/2024
 35171                                  	;ADD	SP,2			; pop those flags
 35172                                  	;
 35173                                  	;;test	ax,1
 35174                                  	;TEST	AX,f_Carry		; did he return with carry?
 35175 00005C61 A801                    	test	al,f_Carry ; test al,1
 35176                                  	;
 35177                                  	; 29/02/2024
 35178 00005C63 58                      	pop	ax  ;  (PCDOS 7.1 IBMDOS.COM)
 35179                                  	;
 35180 00005C64 74F1                    	JZ	short ctrlc_repeat	; no carry set, just retry
 35181                                  
 35182                                  	; MSDOS 6.0
 35183 00005C66 8E1E[630D]              	mov	ds,[TEMPSEG]		; restore ds
 35184                                  
 35185                                  	; Well...  time to abort the user.  
 35186                                  	; Signal a ^C exit and use the EXIT system call..
 35187                                  
 35188                                  ctrlc_abort:
 35189                                  	; MSDOS 3.3
 35190                                          ;;MOV	AX,(EXIT SHL 8) + 0
 35191                                          ;MOV	AX,(EXIT*256) + 0  ; 4C00h
 35192                                  	;mov	byte [CS:DidCTRLC],0FFh ; 14/03/2018
 35193                                          ;transfer COMMAND	    ; give up by faking $EXIT
 35194                                  	;;JMP	SHORT COMMANDJ
 35195                                  	;JMP	COMMAND
 35196                                  
 35197                                  	; 05/05/2019 - Retro DOS v4.0
 35198                                  	; MSDOS 6.0
 35199 00005C6A B8004C                  	MOV	AX,(EXIT<<8)+0 ; 4C00h
 35200 00005C6D 1E                      	push	ds
 35201                                  	;getdseg <ds>			; ds -> dosdata
 35202 00005C6E 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]	
 35203 00005C73 C606[4D03]FF            	MOV	byte [DidCTRLC],-1 ; 0FFh
 35204 00005C78 1F                      	pop	ds
 35205                                  	;transfer COMMAND		; give up by faking $EXIT
 35206 00005C79 EBE3                    	JMP	SHORT COMMANDJ
 35207                                  	;JMP	COMMAND
 35208                                  
 35209                                  ;Break	<DIVISION OVERFLOW INTERRUPT>
 35210                                  ;----------------------------------------------------------------------------
 35211                                  ;
 35212                                  ; Procedure Name : DIVOV
 35213                                  ;
 35214                                  ; Default handler for division overflow trap
 35215                                  ;
 35216                                  ;----------------------------------------------------------------------------
 35217                                  
 35218                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 35219                                  DIVOV: 
 35220                                  	; 05/05/2019 - Retro DOS v4.0
 35221                                  	; 30/07/2018
 35222                                  	; 07/07/2018 - Retro DOS v3.0
 35223 00005C7B BE[F809]                	mov	si,DIVMES
 35224 00005C7E 2E8B1E[0B0A]            	mov	bx,[cs:DivMesLen]
 35225                                  	;mov	ax,cs
 35226                                  	;mov	ss,ax
 35227                                  	; 05/05/2019
 35228                                  	;getdseg <ss>		; we are in an ISR, flag is CLI
 35229 00005C83 2E8E16[0700]            	mov	ss,[cs:DosDSeg]
 35230 00005C88 BC[A007]                	mov     sp,AUXSTACK
 35231                                  	;call	RealDivOv ; MSDOS 3.3
 35232 00005C8B E80200                  	call	_OUTMES ; MSDOS 6.0
 35233 00005C8E EBDA                    	jmp	short ctrlc_abort  ; Use Ctrl-C abort on divide overflow
 35234                                  
 35235                                  ; 30/07/2018
 35236                                  
 35237                                  ; MSDOS 6.0
 35238                                  ;---------------------------------------------------------------------------
 35239                                  ;
 35240                                  ; Procedure Name : OutMes
 35241                                  ;
 35242                                  ;
 35243                                  ; OutMes: perform message output
 35244                                  ; Inputs:   SS:SI points to message
 35245                                  ;	    BX has message length
 35246                                  ; Outputs:  message to BCON
 35247                                  ;
 35248                                  ;Actually, cs:si points to the message now. The segment address is filled in
 35249                                  ;at init. time ([dskchret+2]). This will be temporarily changed to DOSCODE. 
 35250                                  ;NB. This procedure is called only from DIVOV. -SR
 35251                                  ;
 35252                                  ;---------------------------------------------------------------------------
 35253                                  
 35254                                  ;MSDOS 3.3
 35255                                  ;---------------------------------------------------------------------------
 35256                                  ; RealDivOv: perform actual divide overflow stuff.
 35257                                  ; Inputs:   none
 35258                                  ; Outputs:  message to BCON
 35259                                  ;---------------------------------------------------------------------------
 35260                                  
 35261                                  	; 05/05/2019 - Retro DOS v4.0
 35262                                  	; DOSCODE:926Ch (MSDOS 6.21, MSDOS.SYS)
 35263                                  
 35264                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 35265                                  	; DOSCODE:9210h (MSDOS 5.0, MSDOS.SYS)
 35266                                  
 35267                                  ;---------------------------------------------------------------------------
 35268                                  ;
 35269                                  ; Procedure Name : OutMes
 35270                                  ;
 35271                                  ; OutMes: perform message output
 35272                                  ; Inputs:   SS:SI points to message
 35273                                  ;	    BX has message length
 35274                                  ; Outputs:  message to BCON
 35275                                  ;
 35276                                  ;Actually, cs:si points to the message now. The segment address is filled in
 35277                                  ;at init. time ([dskchret+2]). This will be temporarily changed to DOSCODE. 
 35278                                  ;NB. This procedure is called only from DIVOV. -SR
 35279                                  ;
 35280                                  ;---------------------------------------------------------------------------
 35281                                  
 35282                                  	; 30/07/2018
 35283                                  	; MSDOS 6.0
 35284                                  _OUTMES:
 35285                                  	; MSDOS 3.3
 35286                                  ;RealDivOv:
 35287                                  	; 07/07/2018 - Retro DOS v3.0
 35288                                          ;Context ES
 35289 00005C90 16                      	push	ss ; 05/05/2019
 35290                                  	;PUSH	CS ; 30/07/2018		; get ES addressability
 35291 00005C91 07                      	POP	ES
 35292                                          ;Context DS
 35293 00005C92 16                      	push	ss ; 05/05/2019	
 35294                                  	;PUSH	CS ; 30/07/2018		; get DS addressability
 35295 00005C93 1F                      	POP	DS
 35296 00005C94 C606[9403]08                    MOV     BYTE [DSKSTCOM],DEVWRT
 35297 00005C99 C606[9203]16                    MOV     BYTE [DSKSTCALL],DRDWRHL
 35298 00005C9E C706[9503]0000                  MOV     WORD [DSKSTST],0
 35299                                  	; BX = [DivMesLen] = 19
 35300 00005CA4 891E[A403]                      MOV     [DSKSTCNT],BX
 35301 00005CA8 BB[9203]                        MOV     BX,DSKSTCALL
 35302 00005CAB 8936[A003]                      MOV     [DSKCHRET+1],SI		; transfer address (need an EQU)
 35303                                  	; 08/09/2018
 35304                                  	;mov	[DEVIOBUF_PTR],si
 35305                                  	; MSDOS 6.0
 35306                                  					; CS is used for string, fill in 
 35307                                  					; segment address
 35308                                  	;mov	[DOSSEG_INIT],cs ; 29/02/2024 
 35309 00005CAF 8C0E[A203]              	MOV	[DSKCHRET+3],CS
 35310                                  
 35311 00005CB3 C536[3200]                      LDS     SI,[BCON]
 35312 00005CB7 E8BEF2                          CALL	DEVIOCALL2
 35313                                  
 35314                                  	;; 14/03/2018
 35315                                          ;;MOV	WORD [CS:DSKCHRET+1],DEVIOBUF
 35316                                  	;; 08/09/2018
 35317                                  	;mov	word [CS:DEVIOBUF_PTR],DEVIOBUF
 35318                                          ;MOV	WORD [CS:DSKSTCNT],1
 35319                                          
 35320                                  	; 05/05/2019 - Retro DOS v4.0 (MSDOS 6.0, MSDOS 6.21)
 35321                                  
 35322                                  	; ES still points to DOSDATA. ES is
 35323                                  					; not destroyed by deviocall2. So use
 35324                                  					; ES override.
 35325                                  
 35326 00005CBA 26C706[A003][BC03]      	MOV	WORD [ES:DSKCHRET+1],DEVIOBUF
 35327 00005CC1 26C706[A403]0100        	MOV	WORD [ES:DSKSTCNT],1
 35328                                  
 35329 00005CC8 C3                      	RETN
 35330                                  
 35331                                  ;Break	<CHARHRD,HARDERR,ERROR -- HANDLE DISK ERRORS AND RETURN TO USER>
 35332                                  ;---------------------------------------------------------------------------
 35333                                  ;
 35334                                  ; Procedure Name : CHARHARD
 35335                                  ;
 35336                                  ;
 35337                                  ; Character device error handler
 35338                                  ; Same function as HARDERR
 35339                                  ;
 35340                                  ;---------------------------------------------------------------------------
 35341                                  
 35342                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 35343                                  CHARHARD:
 35344                                  	; 05/05/2019 - Retro DOS v4.0
 35345                                  	; 30/07/2018
 35346                                  	; 08/07/2018 - Retro DOS v3.0
 35347                                  
 35348                                  	; MSDOS 6.0
 35349                                  		   			; M024 - start
 35350 00005CC9 36803E[2003]00          	cmp	byte [SS:ERRORMODE], 0	; Q: are we in the middle of int 24
 35351                                  	;jne	short @f		; Y: allow fail
 35352 00005CCF 750B                    	jne	short chard1
 35353                                  
 35354 00005CD1 80CC10                  	OR	AH,Allowed_RETRY ; 10h	; assume ctrl p
 35355                                  
 35356 00005CD4 36F606[FE02]FF          	test	byte [ss:PFLAG],-1	; Q: has ctrl p been pressed
 35357 00005CDA 7503                    	jnz	short ctrlp		; Y: 
 35358                                  ;@@:
 35359                                  chard1:					; M024 - end
 35360                                  	; MSDOS 6.0 & MSDOS 3.3
 35361                                  
 35362                                  ; Character device error handler
 35363                                  ; Same function as HARDERR
 35364                                  
 35365                                  	;or	ah,38h
 35366 00005CDC 80CC38                  	or	ah,Allowed_IGNORE+Allowed_RETRY+Allowed_FAIL
 35367                                  ctrlp:			; SS override for Allowed and EXITHOLD
 35368 00005CDF 368826[4B03]            	mov	[SS:ALLOWED],ah
 35369                                  
 35370                                  	; 15/03/2018
 35371 00005CE4 368C06[8205]                    MOV     [SS:EXITHOLD+2],ES
 35372 00005CE9 36892E[8005]                    MOV     [SS:EXITHOLD],BP
 35373 00005CEE 56                              PUSH    SI
 35374                                  	;and	di,0FFh
 35375 00005CEF 81E7FF00                        AND     DI,STECODE
 35376 00005CF3 8CDD                            MOV     BP,DS                   ;Device pointer is BP:SI
 35377 00005CF5 E89D00                          CALL    FATALC
 35378 00005CF8 5E                              POP     SI
 35379                                  	;return
 35380 00005CF9 C3                              RETN
 35381                                  
 35382                                  ;---------------------------------------------------------------------------
 35383                                  ;
 35384                                  ; Procedure Name : HardErr
 35385                                  ;
 35386                                  ; Hard disk error handler. Entry conditions:
 35387                                  ;	DS:BX = Original disk transfer address
 35388                                  ;	DX = Original logical sector number
 35389                                  ;	CX = Number of sectors to go (first one gave the error)
 35390                                  ;	AX = Hardware error code
 35391                                  ;	DI = Original sector transfer count	
 35392                                  ;	ES:BP = Base of drive parameters
 35393                                  ;	[READOP] = 0 for read, 1 for write
 35394                                  ;	Allowed Set with allowed responses to this error (other bits MUST BE 0)
 35395                                  ; Output:
 35396                                  ;	[FAILERR] will be set if user responded FAIL
 35397                                  ;
 35398                                  ;--------------------------------------------------------------------------
 35399                                  
 35400                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 35401                                  	; 29/02/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 35402                                  HARDERR:
 35403                                  	; 05/05/2019 - Retro DOS v4.0
 35404                                  	; 30/07/2018
 35405                                  	; 08/07/2018 - Retro DOS v3.0
 35406 00005CFA 97                      	XCHG	AX,DI		  	; Error code in DI, count in AX
 35407                                  	;and	di,0FFh
 35408 00005CFB 81E7FF00                	AND	DI,STECODE		; And off status bits
 35409                                  	;CMP	DI,WRECODE		; Write Protect Error?
 35410                                  	;cmp	di,0
 35411 00005CFF 83FF00                  	cmp	DI,error_I24_write_protect ; Write Protect Error?
 35412 00005D02 750A                    	JNZ	short NOSETWRPERR
 35413 00005D04 50                      	PUSH	AX
 35414                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 35415                                  	;MOV	AL,[ES:BP+DPB.DRIVE]
 35416                                  	;;MOV	AL,[ES:BP+0]
 35417                                  	; 15/12/2022
 35418 00005D05 268A4600                	mov	al,[ES:BP]
 35419                                  		; 15/03/2018
 35420 00005D09 36A2[2203]              	MOV	[SS:WPERR],AL		; Flag drive with WP error
 35421 00005D0D 58                      	POP	AX
 35422                                  NOSETWRPERR:
 35423 00005D0E 29C8                    	SUB	AX,CX		  ; Number of sectors successfully transferred
 35424 00005D10 01C2                    	ADD	DX,AX		  ; First sector number to retry
 35425                                  	; 29/02/2024 (PCDOS 7.1 IBMDOS.COM)
 35426                                  	;;;
 35427 00005D12 368316[0706]00          	adc	word [ss:HIGH_SECTOR],0
 35428                                  	;;;
 35429 00005D18 52                      	PUSH	DX
 35430                                  	; 08/07/2018
 35431                                  	;MUL	word [ES:BP+2] 		; Number of bytes transferred
 35432 00005D19 26F76602                	MUL	word [ES:BP+DPB.SECTOR_SIZE]
 35433 00005D1D 5A                      	POP	DX
 35434 00005D1E 01C3                    	ADD	BX,AX		  	; First address for retry
 35435                                  	;XOR	AH,AH ; *	  	; Flag disk section in error
 35436                                  	; 29/02/2024 (PCDOS 7.1 IBMDOS.COM)
 35437                                  	;;;
 35438 00005D20 31C0                    	xor	ax,ax ; * ; 29/02/2024 - Retro DOS v5.0
 35439                                  	;cmp	word [ss:HIGH_SECTOR],0
 35440 00005D22 363906[0706]            	cmp	[ss:HIGH_SECTOR],ax ; 0 ; *
 35441 00005D27 7506                    	jnz	short TESTDIR
 35442                                  	;;;
 35443                                  	;CMP	DX,[ES:BP+6] 		; In reserved area?
 35444 00005D29 263B5606                	CMP	DX,[ES:BP+DPB.FIRST_FAT]
 35445 00005D2D 7246                    	JB	SHORT ERRINT
 35446                                  
 35447                                  TESTDIR:	; 29/02/2024	
 35448 00005D2F FEC4                    	INC	AH			; Flag for FAT
 35449                                  
 35450                                  	; 29/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 35451                                  	;;;
 35452                                  	;cmp	word [es:bp+0Fh],0
 35453 00005D31 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 35454 00005D36 7525                    	jnz	short TESTDIR3 ; not FAT32
 35455 00005D38 52                      	push	dx
 35456 00005D39 368B16[0706]            	mov	dx,[ss:HIGH_SECTOR]
 35457                                  	;cmp	dx,[es:bp+2Bh]
 35458 00005D3E 263B562B                	cmp	dx,[es:bp+DPB.FCLUS_FSECTOR+2]
 35459 00005D42 5A                      	pop	dx
 35460 00005D43 7504                    	jnz	short TESTDIR1	; Err in FAT must force recomp of freespace
 35461                                  	;cmp	dx,[es:bp+29h]
 35462 00005D45 263B5629                	cmp	dx,[es:bp+DPB.FCLUS_FSECTOR]
 35463                                  TESTDIR1:
 35464 00005D49 730E                    	jnb	short TESTDIR2
 35465                                  	;mov	word [es:bp+1Fh],0FFFFh ; -1
 35466 00005D4B 26C7461FFFFF            	mov	word [es:bp+DPB.FREE_CNT],0FFFFh
 35467                                  	;mov	word [es:bp+21h],0FFFFh ; -1
 35468 00005D51 26C74621FFFF            	mov	word [es:bp+DPB.FREE_CNT+2],0FFFFh
 35469 00005D57 EB1C                    	jmp	short ERRINT
 35470                                  TESTDIR2:  
 35471 00005D59 FEC4                    	inc	ah
 35472                                  	;inc	ah
 35473                                  	;jmp	short ERRINT
 35474                                  	; 29/02/2024 - Retro DOS v5.0
 35475 00005D5B EB16                    	jmp	short ERRINT2
 35476                                  TESTDIR3:
 35477                                  	;;;
 35478                                  
 35479                                  	;CMP	DX,[ES:BP+10H] ; MSDOS 3.3
 35480                                  	;cmp	dx,[ES:BP+11h] ; MSDOS 6.0 - 05/05/2019
 35481 00005D5D 263B5611                	CMP	DX,[ES:BP+DPB.DIR_SECTOR] ; In FAT?  
 35482                                  	;JAE	short TESTDIR 		; No
 35483 00005D61 7308                    	jae	short TESTDIR4 ; 29/02/2024
 35484                                  
 35485                                  		; Err in FAT must force recomp of freespace
 35486                                  	;mov	word [ES:BP+1Eh],-1 ; MSDOS 3.3
 35487                                  	;mov	word [ES:BP+1Fh],-1 ; MSDOS 6.0 - 05/05/2019 
 35488 00005D63 26C7461FFFFF            	MOV	word [ES:BP+DPB.FREE_CNT],-1
 35489                                  
 35490 00005D69 EB0A                    	JMP	SHORT ERRINT
 35491                                  ;TESTDIR:
 35492                                  TESTDIR4:	; 29/02/2024
 35493 00005D6B FEC4                    	INC	AH
 35494                                  	;CMP	DX,[ES:BP+0BH]		; In directory?
 35495 00005D6D 263B560B                	CMP	DX,[ES:BP+DPB.FIRST_SECTOR]
 35496 00005D71 7202                    	JB	SHORT ERRINT
 35497                                  ERRINT2:	; 29/02/2024
 35498 00005D73 FEC4                    	INC	AH			; Must be in data area
 35499                                  ERRINT:
 35500 00005D75 D0E4                    	SHL	AH,1			; Make room for read/write bit
 35501 00005D77 360A26[7505]            	OR	AH,[SS:READOP] ; 15/03/2018
 35502                                  
 35503                                  	; 15/08/2018
 35504                                  					; SS override for allowed and EXITHOLD
 35505 00005D7C 360A26[4B03]            	OR	AH,[SS:ALLOWED]		; Set the allowed_ bits
 35506                                  
 35507                                  	;entry   FATAL
 35508                                  FATAL:
 35509                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 35510                                  	;MOV	AL,[ES:BP+DPB.DRIVE]
 35511                                  	;;MOV	AL,[ES:BP+0]		; Get drive number
 35512                                  	; 15/12/2022
 35513 00005D81 268A4600                	MOV	AL,[ES:BP]	
 35514                                  
 35515                                  	;entry   FATAL1
 35516                                  FATAL1:  
 35517                                  	; 15/03/2018	
 35518 00005D85 368C06[8205]            	MOV	[SS:EXITHOLD+2],ES
 35519 00005D8A 36892E[8005]            	MOV	[SS:EXITHOLD],BP	; The only things we preserve
 35520                                  	;LES	SI,[ES:BP+12H] ; MSDOS 3.3
 35521                                  	;LES	SI,[ES:BP+13H] ; MSDOS 6.0 - 05/05/2019
 35522 00005D8F 26C47613                	LES	SI,[ES:BP+DPB.DRIVER_ADDR]
 35523 00005D93 8CC5                    	MOV	BP,ES			; BP:SI points to the device involved
 35524                                  
 35525                                  	; DI has the INT-24-style extended error. We now map the error code
 35526                                  	; for this into the normalized get extended error set by using the
 35527                                  	; ErrMap24 table as a translate table. Note that we translate ONLY
 35528                                  	; the device returned codes and leave all others beyond the look up
 35529                                  	; table alone.
 35530                                  
 35531                                  	; 08/07/2018 - Retro DOS v3.0
 35532                                  FATALC:
 35533 00005D95 E89F01                  	call	SET_I24_EXTENDED_ERROR
 35534                                  	;cmp	di,0Ch
 35535 00005D98 83FF0C                  	CMP	DI,error_I24_gen_failure
 35536 00005D9B 7603                    	JBE	short GOT_RIGHT_CODE	; Error codes above gen_failure get
 35537 00005D9D BF0C00                  	MOV	DI,error_I24_gen_failure; mapped to gen_failure. Real codes
 35538                                  					;  Only come via GetExtendedError
 35539                                  
 35540                                  ;** ----------------------------------------------------------------
 35541                                  ;
 35542                                  ; Entry point used by REDIRector on Network I 24 errors.
 35543                                  ;
 35544                                  ;	ASSUME	DS:NOTHING,ES:NOTHING,SS:DOSDATA
 35545                                  ;
 35546                                  ; ALL I 24 regs set up. ALL Extended error info SET. ALLOWED Set.
 35547                                  ;	EXITHOLD set for restore of ES:BP.
 35548                                  ; ------------------------------------------------------------------
 35549                                  	;entry	NET_I24_ENTRY
 35550                                  NET_I24_ENTRY:
 35551                                  GOT_RIGHT_CODE:
 35552 00005DA0 36803E[2003]00          	CMP	BYTE [SS:ERRORMODE],0	; No INT 24s if already INT 24
 35553 00005DA6 7404                    	JZ	SHORT NoSetFail
 35554 00005DA8 B003                    	MOV	AL,3
 35555 00005DAA EB74                    	JMP	short FailRet
 35556                                  NoSetFail:
 35557 00005DAC 368926[8805]            	MOV	[SS:CONTSTK],SP		; SS override
 35558 00005DB1 16                      	PUSH	SS
 35559 00005DB2 07                      	POP	ES
 35560                                      
 35561                                  	; Wango!!! We may need to free some user state info... In 
 35562                                  	; particular, we may have locked down a JFN for a user and he may
 35563                                  	; NEVER return to us. Thus,we need to free it here and then
 35564                                  	; reallocate it when we come back.
 35565                                  
 35566 00005DB3 36833E[AA05]FF          	CMP	word [SS:SFN],-1 ; 0FFFFh
 35567 00005DB9 740C                    	JZ	short _NoFree
 35568 00005DBB 1E                      	push	ds
 35569 00005DBC 56                      	push	si
 35570 00005DBD 36C536[AE05]            	LDS	SI,[SS:PJFN]
 35571 00005DC2 C604FF                  	MOV	BYTE [SI],0FFH
 35572 00005DC5 5E                      	pop	si
 35573 00005DC6 1F                      	pop	ds
 35574                                  
 35575                                  _NoFree:
 35576 00005DC7 FA                      	CLI
 35577                                  					; Prepare to play with stack
 35578 00005DC8 36FE06[2003]            	INC	BYTE [SS:ERRORMODE]	; Flag INT 24 in progress
 35579 00005DCD 36FE0E[2103]            	DEC	BYTE [SS:INDOS]		; INT 24 handler might not return
 35580                                  
 35581                                  	; 29/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 35582                                  	;;;
 35583 00005DD2 36FE0E[C411]            	dec	byte [ss:INDOS_FLAG]	; 2nd 'in dos' flag (what for?)
 35584                                  	;;;
 35585                                  
 35586                                  	; 05/05/2019 - Retro DOS v4.0 (MSDOS 6.0, MSDOS 6.21)
 35587                                  
 35588                                  	;; Extended Open hooks
 35589                                  					; AN000;IFS.I24 error disabled
 35590                                  	;test	byte [ss:EXTOPEN_ON],2
 35591 00005DD7 36F606[F605]02          	TEST	byte [ss:EXTOPEN_ON],EXT_OPEN_I24_OFF
 35592 00005DDD 7404                    	JZ	short i24yes		; AN000;IFS.no
 35593                                  faili24:				; AN000;
 35594 00005DDF B003                    	MOV	AL,3			; AN000;IFS.fake fail
 35595 00005DE1 EB27                    	JMP	short passi24 		; AN000;IFS.exit
 35596                                  i24yes: 				; AN000;
 35597                                  	;; Extended Open hooks
 35598                                  
 35599 00005DE3 368E16[8605]            	MOV	SS,[SS:USER_SS]
 35600 00005DE8 268B26[8405]            	MOV	SP,[ES:USER_SP]	; User stack pointer restored
 35601                                  
 35602                                  	;;int	24h	
 35603                                  	;IN	int_fatal_abort		; Fatal error interrupt vector,
 35604                                  					; must preserve ES
 35605                                  	; 05/05/2019
 35606 00005DED 26803E[660D]00          	cmp	byte [es:DosHasHMA],0	; Q: is dos running in HMA (M021)
 35607 00005DF3 7504                    	jne	short do_low_int24	; Y: the int must be done from low mem
 35608 00005DF5 CD24                    	INT	int_fatal_abort 	; Fatal error interrupt vector,
 35609                                  					; must preserve ES
 35610 00005DF7 EB05                    	jmp	short criterr_ret_addr
 35611                                  
 35612                                  do_low_int24:
 35613                                  	; 05/05/2019
 35614                                  	; MSDOS 6.0
 35615 00005DF9 2EFF1E[A15A]            	call    far [cs:LowInt24Addr]
 35616                                  criterr_ret_addr:
 35617 00005DFE 268926[8405]            	MOV	[ES:USER_SP],SP	; restore our stack
 35618 00005E03 268C16[8605]            	MOV	[ES:USER_SS],SS
 35619                                  	;MOV	BP,ES
 35620                                  	;MOV	SS,BP
 35621                                  	; 30/06/2024
 35622 00005E08 06                      	push	es
 35623 00005E09 17                      	pop	ss
 35624                                  passi24:
 35625 00005E0A 368B26[8805]            	MOV	SP,[SS:CONTSTK]
 35626 00005E0F 36FE06[2103]            	INC	BYTE [SS:INDOS]		; Back in the DOS
 35627                                  
 35628                                  	; 29/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 35629                                  	;;;
 35630 00005E14 36FE06[C411]            	inc	byte [ss:INDOS_FLAG]
 35631                                  	;;;
 35632                                  
 35633 00005E19 36C606[2003]00          	MOV	BYTE [SS:ERRORMODE],0	; Back from INT 24
 35634 00005E1F FB                      	STI
 35635                                  FailRet:
 35636 00005E20 36C42E[8005]            	LES	BP,[SS:EXITHOLD]
 35637                                  	
 35638                                  	; 08/07/2018
 35639                                  
 35640                                  	; Triage the user's reply.
 35641                                  
 35642 00005E25 3C01                    	CMP	AL,1
 35643 00005E27 723D                    	JB	short CheckIgnore	; 0 => ignore
 35644 00005E29 7445                    	JZ	short CheckRetry	; 1 => retry
 35645 00005E2B 3C03                    	CMP	AL,3			; 3 => fail
 35646 00005E2D 7549                    	JNZ	short DoAbort 		; 2, invalid => abort
 35647                                  
 35648                                  	; The reply was fail. See if we are allowed to fail.
 35649                                  
 35650                                  					; SS override for ALLOWED, EXTOPEN_ON,
 35651                                  					; ALLOWED, FAILERR, WPERR, SFN, pJFN
 35652                                  	;test	byte [ss:ALLOWED],8
 35653 00005E2F 36F606[4B03]08          	test	byte [ss:ALLOWED],Allowed_FAIL ; Can we?
 35654 00005E35 7441                    	jz	short DoAbort		; No, do abort
 35655                                  DoFail:
 35656 00005E37 B003                    	MOV	AL,3			; just in case...
 35657                                  					; AN000;EO. I24 error disabled
 35658                                  	; 05/05/2019
 35659                                  	;(MSDOS 6.0, MSCTRLC.ASM, 1991)
 35660 00005E39 36F606[F605]02          	test	byte [ss:EXTOPEN_ON],EXT_OPEN_I24_OFF ; 2
 35661 00005E3F 7505                    	jnz	short CleanUp 		; AN000;EO. no
 35662                                  	
 35663 00005E41 36FE06[4A03]            	inc	byte [SS:FAILERR]	; Tell everybody
 35664                                  CleanUp:
 35665 00005E46 36C606[2203]FF          	MOV	byte [SS:WPERR],-1
 35666 00005E4C 36833E[AA05]FF          	CMP	word [SS:SFN],-1
 35667                                  	; 25/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 35668                                  	;jnz	short CleanUp2
 35669                                  	;retn
 35670                                  	; 17/12/2022
 35671 00005E52 7411                    	jz	short Cleanup_retn ; 08/07/2018 - Retro DOS v3.0
 35672                                  CleanUp2:
 35673 00005E54 1E                      	push	ds
 35674 00005E55 56                      	push	si
 35675 00005E56 50                      	push	ax
 35676 00005E57 36A1[AA05]              	MOV	AX,[ss:SFN]
 35677 00005E5B 36C536[AE05]            	LDS	SI,[ss:PJFN]
 35678 00005E60 8804                    	MOV	[SI],AL
 35679 00005E62 58                      	pop	ax
 35680 00005E63 5E                      	pop	si
 35681 00005E64 1F                      	pop	ds
 35682                                  Cleanup_retn:
 35683 00005E65 C3                      	retn
 35684                                  
 35685                                  	; The reply was IGNORE. See if we are allowed to ignore.
 35686                                  
 35687                                  CheckIgnore:
 35688                                  	;test	byte [ss:ALLOWED],20h
 35689 00005E66 36F606[4B03]20          	test	byte [ss:ALLOWED],Allowed_IGNORE ; Can we?
 35690                                  CheckRI:	; 29/02/2024
 35691 00005E6C 74C9                    	jz	short DoFail			; No, do fail
 35692 00005E6E EBD6                    	jmp	short CleanUp
 35693                                  
 35694                                  	; The reply was RETRY. See if we are allowed to retry.
 35695                                  
 35696                                  CheckRetry:
 35697                                  	;test	byte [ss:ALLOWED],10h
 35698 00005E70 36F606[4B03]10          	test	byte [ss:ALLOWED],Allowed_RETRY	; Can we?
 35699                                  	;jz	short DoFail			; No, do fail
 35700                                  	;JMP	short CleanUp
 35701                                  	; 29/02/2024 (PCDOS 7.1 IBMDOS.COM)
 35702 00005E76 EBF4                    	jmp	short CheckRI
 35703                                  	
 35704                                  	; The reply was ABORT.
 35705                                  DoAbort:
 35706 00005E78 16                      	push	ss
 35707 00005E79 1F                      	pop	ds
 35708                                  
 35709 00005E7A 803E[5703]00            	CMP	byte [CONSWAP],0
 35710 00005E7F 7403                    	JZ	short NOSWAP2
 35711 00005E81 E8AADB                  	call	SWAPBACK
 35712                                  NOSWAP2:
 35713                                  	; See if we are to truly abort. If we are in the process of aborting, 
 35714                                  	; turn this abort into a fail.
 35715                                  
 35716                                  	;test	[fAborting],0FFh
 35717                                  	;jnz	short DoFail
 35718                                  
 35719 00005E84 803E[5903]00            	cmp	byte [fAborting],0
 35720 00005E89 75AC                    	JNZ	short DoFail
 35721                                  
 35722                                  	; Set return code
 35723                                  
 35724 00005E8B C606[7C05]02            	MOV	BYTE [EXIT_TYPE],EXIT_HARD_ERROR ; 2
 35725 00005E90 30C0                    	XOR	AL,AL
 35726                                  
 35727                                  	; we are truly aborting the process. Go restore information from 
 35728                                  	; the PDB as necessary.
 35729                                  
 35730 00005E92 E95410                  	jmp	exit_inner
 35731                                  
 35732                                  ;** --------------------------------------------------------------------------
 35733                                  ;
 35734                                  ; reset_environment checks the DS value against the CurrentPDB. If they are
 35735                                  ; different, then an old-style return is performed. If they are the same,
 35736                                  ; then we release jfns and restore to parent. We still use the PDB at DS:0 as
 35737                                  ; the source of the terminate addresses.
 35738                                  ;
 35739                                  ; Some subtlety: We are about to issue a bunch of calls that *may* generate
 35740                                  ; INT 24s. We *cannot* allow the user to restart the abort process; we may
 35741                                  ; end up aborting the wrong process or turn a terminate/stay/resident into a
 35742                                  ; normal abort and leave interrupt handlers around. What we do is to set a
 35743                                  ; flag that will indicate that if any abort code is seen, we just continue the
 35744                                  ; operation. In essence, we dis-allow the abort response.
 35745                                  ;
 35746                                  ; output:   none.
 35747                                  ; ----------------------------------------------------------------------------
 35748                                  
 35749                                  	;entry	reset_environment
 35750                                  	
 35751                                  reset_environment:
 35752                                  	; 30/07/2018 - Retro DOS v3.0
 35753                                  	; IBMDOS.COM (MSDOS 3.3) - Offset 588Ah 
 35754                                  
 35755                                  ;***	invoke	Reset_Version		; AN007 ;MS. reset version number
 35756                                  
 35757 00005E95 1E                      	PUSH	DS			; save PDB of process
 35758                                  
 35759                                  	; There are no critical sections in force. Although we may enter
 35760                                  	; here with critical sections locked down, they are no longer 
 35761                                  	; relevant. We may safely free all allocated resources.
 35762                                  
 35763 00005E96 B482                    	MOV	AH,82h
 35764                                  		; Microsoft Networks - END DOS CRITICAL SECTIONS 0 THROUGH 7
 35765                                  	;int	2Ah 	
 35766 00005E98 CD2A                    	INT	int_IBM
 35767                                  
 35768                                  					; SS override
 35769 00005E9A 36C606[5903]FF          	MOV	byte [SS:fAborting],-1	; signal abort in progress
 35770                                  
 35771                                  					; DOS 4.00 doesn't need it
 35772                                  	;CallInstall NetResetEnvironment, MultNET, 34  
 35773                                  					; Allow REDIR to clear some stuff
 35774                                  					; On process exit.
 35775 00005EA0 B82211                  	mov	ax, 1122h
 35776 00005EA3 CD2F                    	int	2Fh	; Multiplex - NETWORK REDIRECTOR - PROCESS TERMINATION HOOK
 35777                                  			; SS = DOS CS
 35778                                  	;mov	al,22h	
 35779 00005EA5 B022                    	MOV	AL,int_terminate
 35780 00005EA7 E89CB0                  	call	_$GET_INTERRUPT_VECTOR	; and who to go to
 35781                                  
 35782 00005EAA 59                      	POP	CX			; get ThisPDB
 35783 00005EAB 06                      	push	es
 35784 00005EAC 53                      	push	bx			; save return address
 35785                                  
 35786 00005EAD 368B1E[3003]            	MOV	BX,[SS:CurrentPDB] 	; get currentPDB
 35787 00005EB2 8EDB                    	MOV	DS,BX
 35788 00005EB4 A11600                  	MOV	AX,[PDB.PARENT_PID]	; get parentPDB
 35789                                  
 35790                                  	; AX = parentPDB, BX = CurrentPDB, CX = ThisPDB
 35791                                  	; Only free handles if AX <> BX and BX = CX and [exit_code].upper
 35792                                  	; is not Exit_keep_process
 35793                                  	
 35794 00005EB7 39D8                    	CMP	AX,BX
 35795 00005EB9 7418                    	JZ	short reset_return	; parentPDB = CurrentPDB
 35796 00005EBB 39CB                    	CMP	BX,CX
 35797 00005EBD 7514                    	JNZ	short reset_return	; CurrentPDB <> ThisPDB
 35798 00005EBF 50                      	PUSH	AX			; save parent
 35799                                  
 35800                                  					; SS override
 35801                                  	;cmp	byte [SS:EXIT_TYPE],3
 35802 00005EC0 36803E[7C05]03          	CMP	BYTE [SS:EXIT_TYPE],EXIT_KEEP_PROCESS ; 15/08/2018
 35803 00005EC6 7406                    	JZ	short reset_to_parent 	; keeping this process
 35804                                  
 35805                                  	; We are truly removing a process. Free all allocation blocks
 35806                                  	; belonging to this PDB
 35807                                  
 35808                                  	;invoke	arena_free_process
 35809 00005EC8 E85D10                  	call	arena_free_process
 35810                                  
 35811                                  	; Kill off remainder of this process. Close file handles and signal
 35812                                  	; to relevant network folks that this process is dead. Remember that
 35813                                  	; CurrentPDB is STILL the current process!
 35814                                  
 35815                                  	;invoke	DOS_ABORT
 35816 00005ECB E8C8D6                  	call	DOS_ABORT
 35817                                  
 35818                                  reset_to_parent:
 35819                                  					; SS override
 35820 00005ECE 368F06[3003]            	POP	word [SS:CurrentPDB]	; set up process as parent
 35821                                  
 35822                                  reset_return:				; come here for normal return
 35823                                  	;Context DS			; DS is used to refer to DOSDATA
 35824 00005ED3 16                      	push	ss
 35825 00005ED4 1F                      	pop	ds	
 35826                                  
 35827 00005ED5 B0FF                    	MOV	AL,-1
 35828                                  
 35829                                  	; make sure that everything is clean In this case ignore any errors,
 35830                                  	; we cannot "FAIL" the abort, the program being aborted is dead.
 35831                                  
 35832                                  	;EnterCrit critDisk
 35833 00005ED7 E8AAB9                  	call	ECritDisk
 35834                                  	;invoke	FLUSHBUF
 35835 00005EDA E86108                  	call	FLUSHBUF
 35836                                  	;LeaveCrit critDisk
 35837 00005EDD E8D1B9                  	call	LCritDisk
 35838                                  
 35839                                  ; 29/02/2024 - Retrto DOS v5.0
 35840                                  ; PCDOS 7.1 IBMDOS.COM
 35841                                  %if 0
 35842                                  	; Decrement open ref. count if we had done a virtual open earlier.
 35843                                  
 35844                                  	call	CHECK_VIRT_OPEN
 35845                                  %endif
 35846                                  
 35847 00005EE0 FA                      	CLI
 35848 00005EE1 C606[2103]00            	MOV	BYTE [INDOS],0		; Go to known state
 35849                                  
 35850                                  	; 29/02/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 35851                                  	;;;
 35852 00005EE6 C606[C411]00            	mov	byte [INDOS_FLAG],0
 35853                                  	;;;
 35854                                  
 35855 00005EEB C606[2203]FF            	MOV	BYTE [WPERR],-1		; Forget about WP error
 35856 00005EF0 C606[5903]00            	MOV	byte [fAborting],0	; let aborts occur
 35857 00005EF5 8F06[8005]              	POP	WORD [EXITHOLD]
 35858 00005EF9 8F06[8205]              	POP	WORD [EXITHOLD+2]
 35859                                  
 35860                                  	; Snake into multitasking... Get stack from CurrentPDB person
 35861                                  
 35862 00005EFD 8E1E[3003]              	MOV	DS,[CurrentPDB]
 35863 00005F01 8E163000                	MOV	SS,[PDB.USER_STACK+2]
 35864 00005F05 8B262E00                	MOV	SP,[PDB.USER_STACK]
 35865                                  
 35866 00005F09 E835A5                  	call	restore_world
 35867                                  
 35868                                  	; 05/05/2019
 35869 00005F0C 07                      	pop	es ; * ; MSDOS 6.21 (DOSCODE:94A8h, MSDOS.SYS)
 35870                                  
 35871                                  	; MSDOS 6.0
 35872 00005F0D 50                      	push	ax			; set up ds, but save ds in TEMPSEG
 35873 00005F0E 8CD8                    	mov	ax,ds			; and not on stack.
 35874                                  	;getdseg <ds>			; ds -> dosdata
 35875 00005F10 2E8E1E[0700]            	mov	ds,[cs:DosDSeg] 
 35876 00005F15 A3[630D]                	mov	[TEMPSEG],ax
 35877 00005F18 58                      	pop	ax
 35878                                  					; set up ds to DOSDATA
 35879                                  	;MOV	[CS:USER_SP],AX ; MSDOS 3.3
 35880 00005F19 A3[8405]                	mov	[USER_SP],ax
 35881                                  
 35882 00005F1C 58                      	POP	AX			; suck off CS:IP of interrupt...
 35883 00005F1D 58                      	POP	AX
 35884 00005F1E 58                      	POP	AX
 35885                                  
 35886                                  ; M011 : BEGIN
 35887                                  
 35888                                  	; MSDOS 3.3
 35889                                  ;	MOV	AX,0F202h	; STI
 35890                                  
 35891                                  	; MSDOS 6.0
 35892 00005F1F 9F                      	LAHF
 35893 00005F20 86C4                    	XCHG	AH,AL
 35894 00005F22 2402                    	AND	AL,2
 35895 00005F24 B4F2                    	MOV	AH,0F2h
 35896                                  
 35897                                  ; M011 : END
 35898                                  
 35899                                  	; MSDOS 3.3 (& MSDOS 6.0)
 35900 00005F26 50                      	PUSH	AX
 35901                                   
 35902                                  	;PUSH	word [CS:EXITHOLD+2]
 35903                                  	;PUSH	word [CS:EXITHOLD]
 35904                                  	
 35905                                  	; MSDOS 6.0
 35906 00005F27 FF36[8205]              	PUSH	word [EXITHOLD+2]
 35907 00005F2B FF36[8005]              	PUSH	word [EXITHOLD]
 35908                                  
 35909                                  	;MOV	AX,[CS:USER_SP]
 35910                                  
 35911                                  	; MSDOS 6.0
 35912 00005F2F A1[8405]                	MOV	AX,[USER_SP]
 35913 00005F32 8E1E[630D]              	mov	ds,[TEMPSEG]	; restore ds
 35914                                  
 35915 00005F36 CF                      	IRET			; Long return back to user terminate address
 35916                                  
 35917                                  ;---------------------------------------------------------------------------
 35918                                  ;
 35919                                  ; Procedure Name : SET_I24_EXTENDED_ERROR
 35920                                  ;
 35921                                  ; This routine handles extended error codes.
 35922                                  ; Input : DI = error code from device
 35923                                  ; Output: All EXTERR fields are set
 35924                                  ;
 35925                                  ;--------------------------------------------------------------------------
 35926                                  
 35927                                  SET_I24_EXTENDED_ERROR:
 35928 00005F37 50                      	PUSH	AX
 35929                                  					; ErrMap24End is in DOSDATA
 35930 00005F38 B8[BB0E]                	MOV	AX,ErrMap24End
 35931 00005F3B 2D[AB0E]                	SUB	AX,ErrMap24
 35932                                  					; Change to dosdata to access
 35933                                  					; ErrMap24 and EXTERR -SR
 35934                                  	; 05/05/2019 - Retro DOS v4.0
 35935                                  	
 35936                                  	; MSDOS 6.0
 35937 00005F3E 1E                      	push	ds
 35938                                  	;getdseg <ds>			; ds ->dosdata
 35939 00005F3F 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 35940                                  
 35941                                  	; AX is the index of the first unavailable error. Do not translate
 35942                                  	; if greater or equal to AX.
 35943                                  
 35944 00005F44 39C7                    	CMP	DI,AX
 35945 00005F46 89F8                    	MOV	AX,DI
 35946 00005F48 7306                    	JAE	short NoTrans
 35947                                  
 35948                                  	;MOV	AL,[CS:DI+ErrMap24]  ; MSDOS 3.3
 35949 00005F4A 8A85[AB0E]              	mov	al,[ErrMap24+di] ; MSDOS 6.0
 35950 00005F4E 30E4                    	XOR	AH,AH
 35951                                  NoTrans:
 35952                                  	;MOV	[CS:EXTERR],AX
 35953 00005F50 A3[2403]                	mov	[EXTERR],AX
 35954 00005F53 1F                      	pop	ds
 35955                                  	;assume	ds:nothing
 35956 00005F54 58                      	POP	AX
 35957                                  
 35958                                  	; Now Extended error is set correctly. Translate it to get correct
 35959                                  	; error locus class and recommended action.
 35960                                  
 35961 00005F55 56                      	PUSH	SI
 35962                                  					; ERR_TABLE_24 is in DOSCODE 
 35963 00005F56 BE[5B0E]                	MOV	SI,ERR_TABLE_24
 35964 00005F59 E852A7                  	call	CAL_LK			; Set other extended error fields
 35965 00005F5C 5E                      	POP	SI
 35966 00005F5D C3                      	retn
 35967                                  
 35968                                  ;============================================================================
 35969                                  ; FAT.ASM, MSDOS 6.0, 1991
 35970                                  ;============================================================================
 35971                                  ; 30/07/2018 - Retro DOS v3.0
 35972                                  ; 20/05/2019 - Retro DOS v4.0
 35973                                  ; 02/03/2024 - Retro DOS v5.0
 35974                                  
 35975                                  ;	TITLE	FAT - FAT maintenance routines
 35976                                  ;	NAME	FAT
 35977                                  
 35978                                  ;**	FAT.ASM
 35979                                  ;----------------------------------------------------------------------------
 35980                                  ;	Low level local device routines for performing disk change sequence,
 35981                                  ;	setting cluster validity, and manipulating the FAT
 35982                                  ;
 35983                                  ;	IsEof
 35984                                  ;	UNPACK
 35985                                  ;	PACK
 35986                                  ;	MAPCLUSTER
 35987                                  ;	FATREAD_SFT
 35988                                  ;	FATREAD_CDS
 35989                                  ;	FAT_operation
 35990                                  ;
 35991                                  ;	Revision history:
 35992                                  ;
 35993                                  ;	  AN000  version Jan. 1988
 35994                                  ;	   A001  PTM	      -- disk changed for look ahead buffers
 35995                                  ;
 35996                                  ;	M014 - if a request for pack\unpack cluster 0 is made we write\read
 35997                                  ;	       from CL0FATENTRY rather than disk.
 35998                                  
 35999                                  ; DOSCODE:94FAh (MSDOS 6.21, MSDOS.SYS)
 36000                                  
 36001                                  ; 02/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 36002                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:A40Ch
 36003                                  
 36004                                  ;Break <IsEOF - check the quantity in BX for EOF>
 36005                                  ;----------------------------------------------------------------------------
 36006                                  ;
 36007                                  ; Procedure Name : IsEOF
 36008                                  ;
 36009                                  ; IsEOF - check the fat value in BX for eof.
 36010                                  ;
 36011                                  ;   Inputs:	ES:BP point to DPB
 36012                                  ;		BX has fat value
 36013                                  ;   Outputs:	JAE eof
 36014                                  ;   Registers modified: none
 36015                                  ;
 36016                                  ;---------------------------------------------------------------------------
 36017                                  
 36018                                  IsEOF:
 36019                                  	; 02/03/2024 - Retro DOS v5.0
 36020                                  	; PCDOS 7.1 IBMDOS.COM
 36021                                  	;;;
 36022 00005F5E E89801                  	call	IsFAT32			; is it FAT32 drive ?
 36023 00005F61 730D                    	jnc	short IsEOF_FAT		; no, it has 12 or 16 bit FAT
 36024                                  
 36025                                  	; FAT32 fs
 36026 00005F63 36813E[E80A]FF0F        	cmp	word [ss:CLUSTNUM_HW],0FFFh
 36027 00005F6A 7503                    	jnz     short IsEOF_other1	; not EOF
 36028 00005F6C 83FBF8                  	cmp     bx,0FFF8h		; 32 bit compare
 36029                                  IsEOF_other1:
 36030 00005F6F C3                      	retn 				; cf=0 -> EOF, cf=1 -> not EOF
 36031                                  
 36032                                  IsEOF_FAT:
 36033                                  	;;;
 36034                                  
 36035                                  	;cmp	word [es:bp+0Dh],0FF6h
 36036 00005F70 26817E0DF60F            	CMP	word [ES:BP+DPB.MAX_CLUSTER],4096-10 ; is this 16 bit fat?
 36037 00005F76 730B                    	JAE	short EOF16			; yes, check for eof there
 36038                                  
 36039                                  ;J.K. 8/27/86
 36040                                  ;Modified to accept 0FF0h as an eof. This is to handle the diskfull case
 36041                                  ;of any media that has "F0"(Other) as a MediaByte.
 36042                                  ;Hopely, this does not create any side effect for those who may use any value
 36043                                  ;other than "FF8-FFF" as an EOF for their own file.
 36044                                  
 36045 00005F78 81FBF00F                	cmp	bx,0FF0h
 36046 00005F7C 7404                    	je	short IsEOF_other
 36047                                  
 36048 00005F7E 81FBF80F                	CMP	BX,0FF8h		; do the 12 bit compare
 36049                                  IsEOF_other:
 36050 00005F82 C3                      	retn
 36051                                  EOF16:
 36052 00005F83 83FBF8                  	CMP	BX,0FFF8h		; 16 bit compare
 36053 00005F86 C3                      	retn				; cf=0 -> EOF, cf=1 -> not EOF
 36054                                  
 36055                                  ; DOSCODE:9511h (MSDOS 6.21, MSDOS.SYS)
 36056                                  
 36057                                  ;Break	<UNPACK -- UNPACK FAT ENTRIES>
 36058                                  ;---------------------------------------------------------------------------
 36059                                  ;
 36060                                  ; Procedure Name : UNPACK
 36061                                  ;
 36062                                  ; Inputs:
 36063                                  ;	BX = Cluster number (may be full 16-bit quantity)
 36064                                  ;	ES:BP = Base of drive parameters
 36065                                  ; Outputs:
 36066                                  ;	DI = Contents of FAT for given cluster (may be full 16-bit quantity)
 36067                                  ;	Zero set means DI=0 (free cluster)
 36068                                  ;	Carry set means error (currently user FAILed to I 24)
 36069                                  ; SI Destroyed, No other registers affected. Fatal error if cluster too big.
 36070                                  ;
 36071                                  ; NOTE: if BX = 0 then DI = contents of CL0FATENTRY
 36072                                  ;
 36073                                  ;----------------------------------------------------------------------------
 36074                                  
 36075                                  	; 02/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 36076                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A44Eh
 36077                                  	;
 36078                                  	; (MSDOS 6.22 MSDOS .SYS - DOSCODE:9511h)
 36079                                  	; (Windows ME IO.SYS - BIOSCODE:0C368h)
 36080                                  
 36081                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 36082                                  	; DOSCODE:94B5h (MSDOS 5.0, MSDOS.SYS)
 36083                                  
 36084                                  	; 20/05/2019 - Retro DOS v4.0
 36085                                  UNPACK:
 36086                                  	; MSDOS 6.0			; M014 - Start
 36087 00005F87 09DB                    	or	bx,bx			; Q: are we unpacking cluster 0
 36088 00005F89 7519                    	jnz	short up_cont		; N: proceed with normal unpack
 36089                                  
 36090                                  ; 02/03/2024
 36091                                  %if 0
 36092                                  	mov	di,[CL0FATENTRY]	; Y: return value in CL0FATENTRY
 36093                                  	or	di,di 			; return z if di=0
 36094                                  	retn				; done
 36095                                  %else
 36096                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:A435h
 36097                                  	;;;
 36098                                  up_1:
 36099 00005F8B 391E[E80A]              	cmp	[CLUSTNUM_HW],bx ; 0
 36100 00005F8F 7513                    	jne	short up_cont
 36101 00005F91 8B3E[370F]              	mov	di,[CL0FATENTRY_HW]
 36102 00005F95 09FF                    	or	di,di
 36103 00005F97 893E[EC0A]              	mov	[CCONTENT_HW],di
 36104 00005F9B 8B3E[8100]              	mov	di,[CL0FATENTRY]
 36105 00005F9F 7502                    	jnz	short unpack_retn
 36106 00005FA1 09FF                    	or	di,di
 36107                                  unpack_retn:
 36108 00005FA3 C3                      	retn	; [CCONTENT_HW]:DI = contents of CL0FATENTRY
 36109                                  	;;;	
 36110                                  
 36111                                  %endif
 36112                                  
 36113                                  up_cont:				; M014 - End
 36114                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36115                                  	;;;
 36116                                  	;cmp	word [es:bp+0Fh],0
 36117 00005FA4 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 36118 00005FA9 7510                    	jnz	short up_fat		; not FAT32
 36119                                  	; FAT32
 36120                                  	;mov	si,[es:bp+2Fh]
 36121 00005FAB 268B762F                	mov	si,[es:bp+DPB.LAST_CLUSTER+2]
 36122 00005FAF 3936[E80A]              	cmp	[CLUSTNUM_HW],si
 36123 00005FB3 750A                    	jne	short up_2
 36124                                  	;cmp	bx,[es:bp+2Dh]
 36125 00005FB5 263B5E2D                	cmp	bx,[es:bp+DPB.LAST_CLUSTER]
 36126 00005FB9 EB04                    	jmp	short up_2
 36127                                  up_fat:
 36128                                  	;;;
 36129                                  
 36130                                  	; MSDOS 3.3 & MSDOS 6.0
 36131                                  	;cmp	bx,[es:bp+0Dh]
 36132 00005FBB 263B5E0D                	CMP	BX,[es:bp+DPB.MAX_CLUSTER]
 36133                                  up_2:		; 02/03/2024
 36134 00005FBF 7748                    	JA	short HURTFAT
 36135 00005FC1 E84A01                  	CALL	MAPCLUSTER
 36136 00005FC4 7240                    	jc	short _DoContext
 36137                                  
 36138                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36139                                  	;;;
 36140 00005FC6 FF7502                  	push	word [di+2]		; offset CLUSSAVE+2
 36141 00005FC9 368F06[EC0A]            	pop	word [ss:CCONTENT_HW]	; high word of cluster number
 36142                                  	;;;
 36143                                  
 36144 00005FCE 8B3D                    	MOV	DI,[DI]
 36145 00005FD0 7521                    	JNZ	short High12		; MZ if high 12 bits, go get 'em
 36146                                  
 36147                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36148                                  	;;;
 36149 00005FD2 E82401                  	call	IsFAT32
 36150 00005FD5 7211                    	jc	short up_fat32		; FAT32 volume (drive)
 36151 00005FD7 36C706[EC0A]0000        	mov	word [ss:CCONTENT_HW],0
 36152                                  	;;;
 36153                                  
 36154 00005FDE 268B760D                	MOV	SI,[ES:BP+DPB.MAX_CLUSTER] ; MZ is this 16-bit fat?
 36155 00005FE2 81FEF60F                	CMP	SI,4096-10 ; 0FF6h
 36156 00005FE6 721A                    	JB	short Unpack12		; MZ No, go 'AND' off bits
 36157                                  
 36158                                  ; 02/03/2024
 36159                                  %if 0
 36160                                  	OR	DI,DI			; MZ set zero condition code, clears carry
 36161                                  	JMP	SHORT _DoContext 	; MZ go do context
 36162                                  High12:
 36163                                  	SHR	DI,1
 36164                                  	SHR	DI,1
 36165                                  	SHR	DI,1
 36166                                  	SHR	DI,1
 36167                                  %else
 36168                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36169                                  	;;;
 36170                                  up_fat32:
 36171 00005FE8 09FF                    	or	di,di			; set zero condition code, clears carry
 36172                                  	;mov	si,ss
 36173                                  	;mov	ds,si
 36174 00005FEA 16                      	push	ss
 36175 00005FEB 1F                      	pop	ds
 36176 00005FEC 7504                    	jnz	short up_retn
 36177 00005FEE 093E[EC0A]              	or	[CCONTENT_HW],di	; [CCONTENT_HW]:DI = 0 -> zf = 1
 36178                                  up_retn:
 36179 00005FF2 C3                      	retn
 36180                                  
 36181                                  High12:
 36182 00005FF3 36C706[EC0A]0000        	mov	word [ss:CCONTENT_HW],0
 36183 00005FFA D1EF                    	shr     di,1
 36184 00005FFC D1EF                    	shr     di,1
 36185 00005FFE D1EF                    	shr     di,1
 36186 00006000 D1EF                    	shr     di,1
 36187                                  	;;;
 36188                                  %endif
 36189                                  
 36190                                  Unpack12:
 36191 00006002 81E7FF0F                	AND	DI,0FFFh		; Clears carry
 36192                                  _DoContext:
 36193 00006006 16                      	PUSH	SS
 36194 00006007 1F                      	POP	DS
 36195 00006008 C3                      	retn
 36196                                  
 36197                                  HURTFAT:
 36198                                  
 36199                                  ; 02/03/2024
 36200                                  %if 0
 36201                                  	;;mov	word [es:bp+1Eh],0FFFFh
 36202                                  	;mov	word [es:bp+1Fh],0FFFFh  ; MSDOS 6.0
 36203                                  	MOV	word [ES:BP+DPB.FREE_CNT],-1 ; Err in FAT must force recomp of freespace
 36204                                  %else
 36205                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36206                                  	;;;
 36207 00006009 E84C02                  	call	chk_set_first_access
 36208                                  	;;;
 36209                                  %endif
 36210                                  
 36211 0000600C 50                      	PUSH	AX
 36212 0000600D B488                    	MOV	AH,Allowed_FAIL+80h ; 88h
 36213                                  
 36214                                  ; 02/03/2024
 36215                                  %if 0
 36216                                  
 36217                                  ;hkn; SS override
 36218                                  	MOV	byte [SS:ALLOWED],Allowed_FAIL ; 8
 36219                                  ;
 36220                                  ; Signal Bad FAT to INT int_fatal_abort handler. We have an invalid cluster.
 36221                                  ;
 36222                                  	MOV	DI,0FFFh		; In case INT int_fatal_abort returns (it shouldn't)
 36223                                  	call	FATAL
 36224                                  %else
 36225                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36226                                  	;;;
 36227                                  	;mov	byte [ss:ALLOWED],8
 36228 0000600F 36C606[4B03]08          	mov	byte [ss:ALLOWED],Allowed_FAIL
 36229                                  	;
 36230                                  	; 02/03/2024 - Retro DOS v5.0
 36231 00006015 31FF                    	xor	di,di
 36232 00006017 4F                      	dec	di	; 0FFFFh
 36233 00006018 57                      	push	di
 36234                                  		; NOTE: DI would be 0FFFFh here (or 0FFFh as in MSDOS 6.?)
 36235                                  		; because, in SET_I24_EXTENDED_ERROR in FATAL,
 36236                                  		; DI is compared with error code
 36237                                  		; ;
 36238                                  		; xor di,di
 36239                                  		; dec di ; 0FFFFh
 36240                                  		; push di
 36241                                  		; call FATAL
 36242                                  		; pop di
 36243                                  		; mov word [ss:CCONTENT_HW], di
 36244                                  		; ;
 36245                                  		; Erdogan Tan - 02/03/2024 - 01/07/2024
 36246                                  	;
 36247 00006019 36FF36[E80A]            	push	word [ss:CLUSTNUM_HW] ; (necessary!?)
 36248 0000601E 53                      	push	bx	; (necessary!?)
 36249 0000601F E85FFD                  	call	FATAL
 36250 00006022 5B                      	pop	bx
 36251 00006023 368F06[E80A]            	pop	word [ss:CLUSTNUM_HW]
 36252                                  	;xor	di,di
 36253                                  	;dec	di	; 0FFFFh
 36254                                  	;mov	word [ss:CCONTENT_HW],di
 36255                                  	; 02/03/2024 - Retro DOS v5.0
 36256                                  	;pop	word [ss:CCONTENT_HW]
 36257                                  	; 01/07/2024
 36258 00006028 5F                      	pop	di
 36259 00006029 36893E[EC0A]            	mov	[ss:CCONTENT_HW], di
 36260                                  	;;;
 36261                                  %endif
 36262 0000602E 3C03                    	CMP	AL,3
 36263 00006030 F8                      	CLC
 36264 00006031 7501                    	JNZ	short OKU_RET 		; Try to ignore bad FAT
 36265 00006033 F9                      	STC				; User said FAIL
 36266                                  OKU_RET:
 36267 00006034 58                      	POP	AX
 36268                                  hurtfat_retn:
 36269 00006035 C3                      	retn
 36270                                  
 36271                                  ; DOSCODE:9565h (MSDOS 6.21, MSDOS.SYS)
 36272                                  
 36273                                  ;Break	<PACK -- PACK FAT ENTRIES>
 36274                                  ;----------------------------------------------------------------------------
 36275                                  ;
 36276                                  ; Procedure Name : PACK
 36277                                  ;
 36278                                  ; Inputs:
 36279                                  ;	BX = Cluster number
 36280                                  ;	DX = Data
 36281                                  ;	ES:BP = Pointer to drive DPB
 36282                                  ; Outputs:
 36283                                  ;	The data is stored in the FAT at the given cluster.
 36284                                  ;	SI,DX,DI all destroyed
 36285                                  ;	Carry set means error (currently user FAILed to I 24)
 36286                                  ;	No other registers affected
 36287                                  ;
 36288                                  ; NOTE: if BX = 0 then data in DX is stored in CL0FATENTRY.
 36289                                  ;
 36290                                  ;---------------------------------------------------------------------------
 36291                                  
 36292                                  	; 02/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 36293                                  
 36294                                  	; INPUT:
 36295                                  	;  [CLUSDATA_HW]:DX = cluster data/content
 36296                                  	;  [CLUSTNUM_HW]:BX = cluster number (to be updated)
 36297                                  	;  ES:BP = pointer to DPB
 36298                                  
 36299                                  	; 25/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 36300                                  	; 20/05/2019 - Retro DOS v4.0
 36301                                  PACK:
 36302                                  	; MSDOS 6.0			; M014 - start
 36303 00006036 09DB                    	or	bx,bx			; Q: are we packing cluster 0
 36304 00006038 7513                    	jnz	short p_cont		; N: proceed with normal pack
 36305                                  
 36306                                  ; 02/03/2024
 36307                                  %if 0
 36308                                  	mov	[CL0FATENTRY],dx	; Y: place value in CL0FATENTRY
 36309                                  	retn				; done
 36310                                  %else
 36311                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36312                                  	;;;
 36313 0000603A 391E[E80A]              	cmp	[CLUSTNUM_HW],bx ; 0
 36314 0000603E 750D                    	jnz	short p_cont
 36315                                  
 36316                                  	;push	ax
 36317                                  	;mov	ax,[CLUSDATA_HW]	; Cluster Data/Content (High Word)
 36318                                  	;mov	[CL0FATENTRY_HW],ax
 36319                                  	;pop	ax
 36320 00006040 FF36[EA0A]              	push	word [CLUSDATA_HW]
 36321 00006044 8F06[370F]              	pop	word [CL0FATENTRY_HW]
 36322                                  
 36323 00006048 8916[8100]              	mov	[CL0FATENTRY],dx
 36324 0000604C C3                      	retn
 36325                                  	;;;
 36326                                  %endif
 36327                                  
 36328                                  p_cont:					; M014 - end
 36329                                  	; MSDOS 3.3 & MSDOS 6.0
 36330 0000604D E8BE00                  	CALL	MAPCLUSTER
 36331 00006050 72B4                    	JC	short _DoContext
 36332 00006052 8B35                    	MOV	SI,[DI]
 36333 00006054 740B                    	JZ	short ALIGNED 		; byte (not nibble) aligned
 36334 00006056 51                      	PUSH	CX			; move data to upper 12 bits
 36335 00006057 B104                    	MOV	CL,4
 36336 00006059 D3E2                    	SHL	DX,CL
 36337 0000605B 59                      	POP	CX
 36338 0000605C 83E60F                  	AND	SI,0FH			; leave in original low 4 bits
 36339 0000605F EB2B                    	JMP	SHORT PACKIN
 36340                                  
 36341                                  ALIGNED:
 36342                                  
 36343                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36344                                  	;;;
 36345 00006061 E89500                  	call	IsFAT32
 36346 00006064 7313                    	jnb	short p_fat
 36347                                  
 36348 00006066 368B36[EA0A]            	mov	si,[ss:CLUSDATA_HW]
 36349 0000606B 337502                  	xor	si,[di+2]		; hw of cluster number
 36350                                  					; offset CLUSSAVE+2
 36351 0000606E 81E6FF0F                	and	si,0FFFh
 36352 00006072 317502                  	xor	[di+2],si
 36353 00006075 8915                    	mov	[di],dx
 36354 00006077 EB17                    	jmp	short PACKIN2
 36355                                  p_fat:
 36356                                  	;;;
 36357                                  
 36358                                  	;cmp	word [es:bp+0Dh],0FF6h
 36359 00006079 26817E0DF60F            	CMP	word [ES:BP+DPB.MAX_CLUSTER],4096-10 ; MZ 16 bit fats?
 36360 0000607F 7309                    	JAE	short Pack16		; MZ yes, go clobber original data
 36361 00006081 81E600F0                	AND	SI,0F000h		; MZ leave in upper 4 bits of original
 36362                                  	;AND	DX,0FFFh		; MZ store only 12 bits
 36363                                  	; 01/07/2024
 36364 00006085 80E60F                  	and	dh,0Fh
 36365 00006088 EB02                    	JMP	SHORT PACKIN		; MZ go store
 36366                                  Pack16:
 36367 0000608A 31F6                    	XOR	SI,SI			; MZ no original data
 36368                                  PACKIN:
 36369 0000608C 09D6                    	OR	SI,DX
 36370 0000608E 8935                    	MOV	[DI],SI
 36371                                  
 36372                                  PACKIN2:	; 02/03/2024
 36373                                  
 36374                                  ;hkn; SS override
 36375 00006090 36C536[E205]            	LDS	SI,[SS:CURBUF]
 36376                                  	; MSDOS 6.0
 36377 00006095 F6440540                	TEST	byte [SI+BUFFINFO.buf_flags],buf_dirty
 36378                                  					;LB. if already dirty		  ;AN000;
 36379 00006099 7507                    	JNZ	short yesdirty11	;LB.  don't increment dirty count ;AN000;
 36380                                  	; 10/06/2019
 36381 0000609B E8D207                  	call	INC_DIRTY_COUNT		;LB.				  ;AN000;
 36382                                  	
 36383                                  	;or	byte [si+5],40h
 36384 0000609E 804C0540                	OR	byte [SI+BUFFINFO.buf_flags],buf_dirty
 36385                                  yesdirty11:				;LB.				;AN000;
 36386                                  ;hkn; SS override
 36387 000060A2 36803E[7805]00          	CMP	BYTE [SS:CLUSSPLIT],0	; 15/08/2018
 36388                                  ;hkn; SS is DOSDATA
 36389 000060A8 16                      	push	ss
 36390 000060A9 1F                      	pop	ds
 36391 000060AA 7489                    	jz	short hurtfat_retn	; Carry clear
 36392 000060AC 50                      	PUSH	AX
 36393                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36394                                  	;;;
 36395 000060AD FF36[E80A]              	push	word [CLUSTNUM_HW]
 36396                                  	;;;
 36397 000060B1 53                      	PUSH	BX
 36398 000060B2 51                      	PUSH	CX
 36399 000060B3 A1[8E05]                	MOV	AX,[CLUSSAVE]
 36400 000060B6 8E1E[E405]              	MOV	DS,[CURBUF+2]
 36401                                  	;;;add	si,16 ; MSDOS 3.3
 36402                                  	;;add	si,20 ; MSDOS 6.0
 36403                                  	; 02/01/2024
 36404                                  	;add	si,24 ; PCDOS 7.1 
 36405 000060BA 83C618                  	ADD	SI,BUFINSIZ
 36406 000060BD 8824                    	MOV	[SI],AH
 36407                                  ;hkn; SS is DOSDATA
 36408                                  	;Context DS
 36409 000060BF 16                      	push	ss
 36410 000060C0 1F                      	pop	ds
 36411                                  	
 36412 000060C1 50                      	PUSH	AX
 36413                                  	
 36414                                  	; MSDOS 6.0
 36415 000060C2 8B16[9205]              	MOV	DX,[CLUSSEC+2]		;F.C. >32mb			;AN000;
 36416 000060C6 8916[0706]              	MOV	[HIGH_SECTOR],DX	;F.C. >32mb			;AN000;
 36417                                  
 36418                                  	; MSDOS 3.3 & MSDOS 6.0
 36419 000060CA 8B16[9005]              	MOV	DX,[CLUSSEC]
 36420                                  
 36421                                  	;MOV	SI,1	  ; *
 36422                                  	;XOR	AL,AL     ; *
 36423                                  	;call	GETBUFFRB ; *
 36424                                  	; 22/09/2023
 36425 000060CE E8F704                  	call	GETBUFFRA ; *
 36426                                  
 36427 000060D1 58                      	POP	AX
 36428 000060D2 721B                    	JC	short POPP_RET
 36429 000060D4 C53E[E205]              	LDS	DI,[CURBUF]
 36430                                  	
 36431                                  	; MSDOS 6.0
 36432 000060D8 F6450540                	TEST	byte [DI+BUFFINFO.buf_flags],buf_dirty  
 36433                                  					;LB. if already dirty		  ;AN000;
 36434 000060DC 7507                    	JNZ	short yesdirty12	;LB.  don't increment dirty count ;AN000;
 36435 000060DE E88F07                  	call	INC_DIRTY_COUNT 	;LB.				  ;AN000;
 36436                                  	
 36437                                  	;or	byte [di+5],40h
 36438 000060E1 804D0540                	OR	byte [DI+BUFFINFO.buf_flags],buf_dirty 
 36439                                  yesdirty12:
 36440                                  	;;;add	di,16
 36441                                  	;;add	di,20 ; MSDOS 6.0
 36442                                  	;ADD	DI,BUFINSIZ
 36443                                  	;DEC	DI
 36444                                  	; 02/01/2024 - Retro DOS v5.0
 36445                                  	;add	di,23 ; PCDOS 7.1
 36446 000060E5 83C717                  	add	di,BUFINSIZ-1 ; 23 ; PCDOS 7.1 IBMDOS.COM
 36447                                  	
 36448                                  	;add	di,[es:bp+2]
 36449 000060E8 26037E02                	ADD	DI,[ES:BP+DPB.SECTOR_SIZE]
 36450 000060EC 8805                    	MOV	[DI],AL
 36451 000060EE F8                      	CLC
 36452                                  POPP_RET:
 36453                                  	; 02/03/2024
 36454 000060EF 16                      	PUSH	SS
 36455 000060F0 1F                      	POP	DS
 36456 000060F1 59                      	POP	CX
 36457 000060F2 5B                      	POP	BX
 36458                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36459                                  	;;;
 36460                                  	;pop	word [ss:CLUSTNUM_HW]
 36461                                  	; 01/07/2024
 36462                                  	; ds = ss
 36463 000060F3 8F06[E80A]              	pop	word [CLUSTNUM_HW]
 36464                                  	;;;
 36465 000060F7 58                      	POP	AX
 36466 000060F8 C3                      	retn
 36467                                  
 36468                                  ; =============== S U B R O U T I N E =======================================
 36469                                  	
 36470                                  	; 02/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 36471                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A5B9h
 36472                                  IsFAT32:
 36473                                  	;cmp	word [es:bp+0Fh],1
 36474 000060F9 26837E0F01              	cmp	word [es:bp+DPB.FAT_SIZE],1
 36475 000060FE 730D                    	jnb	short isfat32eof_2	; not FAT32
 36476                                  
 36477                                  	;cmp	word [es:bp+2Fh],0
 36478 00006100 26837E2F00              	cmp	word [es:bp+DPB.LAST_CLUSTER+2],0
 36479 00006105 7505                    	jnz	short isfat32eof_1	; FAT32
 36480                                  
 36481                                  	;cmp	word [es:bp+2Dh],0FFF6h
 36482 00006107 26837E2DF6              	cmp	word [es:bp+DPB.LAST_CLUSTER],0FFF6h
 36483                                  isfat32eof_1:
 36484 0000610C F5                      	cmc	; cf=1 -> FAT32
 36485                                  isfat32eof_2:
 36486 0000610D C3                      	retn
 36487                                  
 36488                                  ;----------------------------------------------------------------------------
 36489                                  
 36490                                  ; 31/07/2018 - Retro DOS v3.0
 36491                                  
 36492                                  ;Break	<MAPCLUSTER - BUFFER A FAT SECTOR>
 36493                                  ;---------------------------------------------------------------------------
 36494                                  ;
 36495                                  ; Procedure Name : MAPCLUSTER
 36496                                  ;
 36497                                  ; Inputs:
 36498                                  ;	ES:BP Points to DPB
 36499                                  ;	BX Is cluster number
 36500                                  ; Function:
 36501                                  ;	Get a pointer to the cluster
 36502                                  ; Outputs:
 36503                                  ;	DS:DI Points to contents of FAT for given cluster
 36504                                  ;	DS:SI Points to start of buffer
 36505                                  ;	Zero Not set if cluster data is in high 12 bits of word
 36506                                  ;	Zero set if cluster data is in low 12 or 16 bits
 36507                                  ;	Carry set if failed.
 36508                                  ; SI is destroyed.
 36509                                  ;
 36510                                  ;---------------------------------------------------------------------------
 36511                                  
 36512                                  	; 20/05/2019 - Retro DOS v4.0
 36513                                  	; DOSCODE:9601h (MSDOS 6.21, MSDOS.SYS)
 36514                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 36515                                  	; DOSCODE:95A5h (MSDOS 5.0, MSDOS.SYS)
 36516                                  
 36517                                  	; 02/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 36518                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A5D7h
 36519                                  
 36520                                  MAPCLUSTER:
 36521                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5A15h
 36522 0000610E C606[7805]00            	MOV	BYTE [CLUSSPLIT],0
 36523                                  	;SAVE	<AX,BX,CX,DX>
 36524 00006113 50                      	push	ax
 36525 00006114 53                      	push	bx
 36526 00006115 51                      	push	cx
 36527 00006116 52                      	push	dx
 36528                                  	; 02/03/2024
 36529                                  	;MOV	AX,BX			; AX = BX
 36530                                  
 36531                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36532                                  	;;;
 36533                                  	;push	word [CLUSTNUM_HW]
 36534 00006117 89D8                    	mov	ax,bx
 36535 00006119 8B16[E80A]              	mov	dx,[CLUSTNUM_HW]
 36536                                  	;
 36537 0000611D 52                      	push	dx ; 02/03/2024 - Retro DOS v5.0
 36538                                  	;
 36539 0000611E 31FF                    	xor	di,di
 36540 00006120 E8D6FF                  	call	IsFAT32
 36541 00006123 730E                    	jnc	short mapcl1 ; not FAT32
 36542                                  	; FAT32
 36543 00006125 D1E0                    	shl	ax,1
 36544 00006127 D1D2                    	rcl	dx,1
 36545 00006129 D1D7                    	rcl	di,1
 36546 0000612B D1E0                    	shl	ax,1
 36547 0000612D D1D2                    	rcl	dx,1
 36548 0000612F D1D7                    	rcl	di,1
 36549                                  	; DI:DX:AX = 4*(DX:AX)
 36550 00006131 EB14                    	jmp	short Map16		; 32 bit FAT	
 36551                                  mapcl1:
 36552                                  	;;;
 36553 00006133 26817E0DF60F            	CMP	word [ES:BP+DPB.MAX_CLUSTER],4096-10  ; MZ 16 bit fat?
 36554                                  	; 02/03/2024 - Retro DOS v5.0
 36555                                  	;JAE	short Map16		; MZ yes, do 16 bit algorithm
 36556                                  	;SHR	AX,1			; AX = BX/2
 36557                                  	;
 36558                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36559                                  	;;;
 36560 00006139 7304                    	jae	short mapcl2		; 16 bit FAT
 36561                                  	; 12 bit FAT
 36562 0000613B D1EA                    	shr	dx,1
 36563 0000613D D1D8                    	rcr     ax,1
 36564                                  mapcl2:
 36565 0000613F 01D8                    	add     ax,bx
 36566 00006141 1316[E80A]              	adc     dx,[CLUSTNUM_HW]
 36567 00006145 11FF                    	adc	di,di
 36568                                  	;;;
 36569                                  Map16:	
 36570                                  
 36571                                  ; 02/04/2024 - Retro DOS v5.0
 36572                                  ; (PCDOS 7.1 IBMDOS.COM)
 36573                                  %if 0
 36574                                  	; MSDOS 6.0			; MZ skip prev => AX=2*BX
 36575                                  	XOR	DI,DI ; *		; >32mb fat ;AN000;
 36576                                  	
 36577                                  	; MSDOS 3.3 (& MSDOS 6.0)
 36578                                  	ADD	AX,BX			; AX = 1.5*fat = byte offset in fat
 36579                                  	ADC	DI,DI ; * MSDOS 6.0	; >32mb fat ;DI is zero before op;AN000;
 36580                                  %endif
 36581                                  
 36582 00006147 268B4E02                	MOV	CX,[ES:BP+DPB.SECTOR_SIZE]
 36583                                  
 36584                                  ;IF FastDiv
 36585                                  ;
 36586                                  ; Gross hack: 99% of all disks have 512 bytes per sector. We test for this
 36587                                  ; case and apply a really fast algorithm to get the desired results
 36588                                  ;
 36589                                  ; Divide method takes 157+4*4=173 (MOV and DIV)
 36590                                  ; Fast method takes 39+20*4=119
 36591                                  ;
 36592                                  ; This saves a bunch.
 36593                                  
 36594 0000614B 81F90002                	CMP	CX,512			; 4  Is this 512 byte sector?
 36595 0000614F 751C                    	jne	short _DoDiv		; 4  for no jump
 36596                                  
 36597                                  ; 02/04/2024
 36598                                  %if 0
 36599                                  	MOV	DX,AX			; 2  get set for remainder
 36600                                  	AND	DX,512-1		; 4  Form remainder
 36601                                  	MOV	AL,AH			; 2  Quotient in formation in AL
 36602                                  	; MDOS 3.3
 36603                                  	;shr	al,1
 36604                                  	; MDOS 6.0
 36605                                  	shr	di,1			; 2
 36606                                  	rcr	al,1			; 2
 36607                                  	; MDOS 3.3 (& MSDOS 6.0)
 36608                                  	xor	ah,ah			; 3
 36609                                  %else
 36610                                  	; 02/04/2024 - Retro DOS v5.0
 36611                                  	; (PCDOS 7.1 IBMDOS.COM)
 36612                                  	;;;
 36613 00006151 50                      	push	ax
 36614 00006152 D1EF                    	shr	di,1
 36615 00006154 D1DA                    	rcr	dx,1
 36616 00006156 D1D8                    	rcr	ax,1
 36617 00006158 88E0                    	mov	al,ah			; 9 bit shift to right
 36618 0000615A 88D4                    	mov	ah,dl
 36619 0000615C 88F2                    	mov	dl,dh
 36620 0000615E 30F6                    	xor	dh,dh
 36621 00006160 D1EF                    	shr	di,1
 36622 00006162 10F6                    	adc	dh,dh
 36623 00006164 87FA                    	xchg	dx,di		; DI:AX = sector contains requested cluster data
 36624 00006166 5A                      	pop	dx
 36625 00006167 81E2FF01                	and	dx,1FFh			; offset in sector
 36626                                  	;;;
 36627                                  %endif
 36628 0000616B EB07                    	jmp	short DivDone		; 16
 36629                                  
 36630                                  _DoDiv:
 36631                                  ;ENDIF
 36632                                  
 36633                                  ; 02/04/2024
 36634                                  %if 0
 36635                                  	; MSDOS 3.3
 36636                                  	;xor	dx,dx
 36637                                  	; MSDOS 6.0
 36638                                  	mov	dx,di			; 2
 36639                                  	; MSDOS 3.3 (& MSDOS 6.0)
 36640                                  	DIV	CX			; 155 AX is FAT sector # DX is sector index
 36641                                  %else
 36642                                  	; 02/04/2024 - Retro DOS v5.0
 36643                                  	; (PCDOS 7.1 IBMDOS.COM)
 36644                                  	;;;
 36645 0000616D 97                      	xchg	ax,di
 36646 0000616E 92                      	xchg	ax,dx
 36647 0000616F F7F1                    	div	cx
 36648 00006171 97                      	xchg	ax,di
 36649 00006172 F7F1                    	div	cx
 36650                                  	;jmp	short DivDone
 36651                                  	;;;
 36652                                  %endif
 36653                                  
 36654                                  ;IF FastDiv
 36655                                  DivDone:
 36656                                  ;ENDIF
 36657                                  	;add	ax,[es:bp+6]
 36658 00006174 26034606                	ADD	AX,[ES:BP+DPB.FIRST_FAT]
 36659                                  	
 36660                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36661                                  	;;;
 36662 00006178 83D700                  	adc	di,0
 36663                                  	;;;
 36664                                  
 36665 0000617B 49                      	DEC	CX			; CX is sector size - 1
 36666                                  
 36667                                  	;SAVE	<AX,DX,CX>
 36668                                  
 36669                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36670                                  	;;;
 36671 0000617C 57                      	push	di ; 4*
 36672                                  	;;;
 36673 0000617D 50                      	push	ax ; 3*
 36674 0000617E 52                      	push	dx ; 2*
 36675 0000617F 51                      	push	cx ; 1*
 36676                                  
 36677 00006180 89C2                    	MOV	DX,AX
 36678                                  
 36679                                  	; 02/03/2024 - Retro DOS v5.0
 36680                                  	; mov [HIGH_SECTOR],di ; *!* ; PCDOS 7.1 IBMDOS.COM
 36681 00006182 89FB                    	mov	bx,di
 36682                                  	;
 36683                                  
 36684                                  	; MSDOS 6.0
 36685                                  	; 22/09/2023
 36686                                  	;MOV	word [HIGH_SECTOR],0 ; *! ;F.C. >32mb  low sector #
 36687                                  	;
 36688                                  	; MDOS 3.3 (& MSDOS 6.0)
 36689                                  	;XOR	AL,AL	   ; *
 36690                                  	;MOV	SI,1	   ; *
 36691                                  	;;invoke GETBUFFRB ; *
 36692                                  	;call	GETBUFFRB  ; *
 36693                                  	; 22/09/2023
 36694 00006184 E83D04                  	call	GETBUFFRC  ; *! ; *!* ; 02/03/2024 - Retro DOS v5.0
 36695                                  
 36696                                  	;RESTORE <CX,AX,DX>		; CX is sec siz-1, AX is offset in sec
 36697 00006187 59                      	pop	cx ; 1*
 36698 00006188 58                      	pop	ax ; 2*
 36699 00006189 5A                      	pop	dx ; 3*
 36700                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36701                                  	;;;
 36702 0000618A 5B                      	pop	bx ; 4*
 36703                                  	;;;
 36704                                  
 36705 0000618B 725A                    	JC	short MAP_POP
 36706                                  
 36707 0000618D C536[E205]              	LDS	SI,[CURBUF]
 36708                                  	;;;lea	di,[si+16]
 36709                                  	;;lea	di,[si+20] ; MSDOS 6.0
 36710                                  	;lea	di,[si+24] ; PCDOS 7.1	; 02/03/2024
 36711 00006191 8D7C18                  	LEA	DI,[SI+BUFINSIZ]
 36712 00006194 01C7                    	ADD	DI,AX
 36713 00006196 39C8                    	CMP	AX,CX
 36714 00006198 7530                    	JNZ	short MAPRET	; ds<>ss
 36715 0000619A 8A05                    	MOV	AL,[DI]
 36716                                  	;Context DS		 	;hkn; SS is DOSDATA
 36717 0000619C 16                      	push	ss
 36718 0000619D 1F                      	pop	ds	
 36719 0000619E FE06[7805]              	INC	BYTE [CLUSSPLIT]
 36720 000061A2 A2[8E05]                	MOV	[CLUSSAVE],AL
 36721 000061A5 8916[9005]              	MOV	[CLUSSEC],DX
 36722                                  	
 36723                                  	; MSDOS 6.0
 36724                                  	;MOV	WORD [CLUSSEC+2],0      ;F.C. >32mb	;AN000;
 36725                                  	;INC	DX
 36726                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36727                                  	;;;
 36728 000061A9 31C0                    	xor     ax,ax ; 0
 36729 000061AB 83C201                  	add     dx,1
 36730 000061AE 891E[9205]              	mov	word [CLUSSEC+2],bx
 36731 000061B2 11C3                    	adc	bx,ax
 36732                                  	;mov	[HIGH_SECTOR],bx ; *!*
 36733                                  	;;;
 36734                                  
 36735                                  	; 22/09/2023
 36736                                  	;MOV	word [HIGH_SECTOR],0 ; *! ;F.C. >32mb FAT sector <32mb ;AN000;
 36737                                  	;
 36738                                  	; MDOS 3.3 (& MSDOS 6.0)
 36739                                  	;XOR	AL,AL	   ; *
 36740                                  	;MOV	SI,1	   ; *
 36741                                  	;;invoke GETBUFFRB ; *
 36742                                  	;call	GETBUFFRB  ; *
 36743                                  	; 22/09/2023
 36744 000061B4 E80D04                  	call	GETBUFFRC  ; *! ; *!* ; 02/03/2024 - Retro DOS v5.0
 36745 000061B7 722E                    	JC	short MAP_POP
 36746                                  
 36747 000061B9 C536[E205]              	LDS	SI,[CURBUF]
 36748 000061BD 8D7C18                  	LEA	DI,[SI+BUFINSIZ]
 36749 000061C0 8A05                    	MOV	AL,[DI]
 36750                                  	;Context DS			;hkn; SS is DOSDATA
 36751 000061C2 16                      	push	ss
 36752 000061C3 1F                      	pop	ds
 36753 000061C4 A2[8F05]                	MOV	[CLUSSAVE+1],AL
 36754                                  
 36755                                  ;hkn; CLUSSAVE is in DOSDATA
 36756 000061C7 BF[8E05]                	MOV	DI,CLUSSAVE
 36757                                  MAPRET:
 36758                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36759                                  	;;;
 36760 000061CA 368F06[E80A]            	pop	word [ss:CLUSTNUM_HW]	; (ds<>ss)
 36761                                  	;;;
 36762                                  	;RESTORE <DX,CX,BX>
 36763 000061CF 5A                      	pop	dx
 36764 000061D0 59                      	pop	cx
 36765 000061D1 5B                      	pop	bx
 36766                                  
 36767 000061D2 31C0                    	XOR	AX,AX			; MZ allow shift to clear carry
 36768                                  
 36769                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36770                                  	;;;
 36771 000061D4 E822FF                  	call	IsFAT32
 36772 000061D7 720A                    	jc	short MapSet	; FAT32 fs
 36773                                  	;;;
 36774                                  
 36775 000061D9 26817E0DF60F            	CMP	word [ES:BP+DPB.MAX_CLUSTER],4096-10 ; MZ is this 16-bit fat?
 36776 000061DF 7302                    	JAE	short MapSet		; MZ no, set flags
 36777 000061E1 89D8                    	MOV	AX,BX
 36778                                  MapSet:
 36779 000061E3 A801                    	TEST	AL,1			; set zero flag if not on boundary
 36780                                  	;RESTORE <AX>
 36781 000061E5 58                      	pop	ax
 36782 000061E6 C3                      	retn
 36783                                  
 36784                                  MAP_POP:
 36785                                  	; 02/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36786                                  	;;;
 36787                                  	;pop	word [ss:CLUSTNUM_HW]
 36788                                  	; 02/03/2024 - Retro DOS v5.0
 36789 000061E7 8F06[E80A]              	pop	word [CLUSTNUM_HW] ; (ds=ss)
 36790                                  	;;;
 36791                                  	;RESTORE <DX,CX,BX,AX>
 36792 000061EB 5A                      	pop	dx
 36793 000061EC 59                      	pop	cx
 36794 000061ED 5B                      	pop	bx
 36795 000061EE 58                      	pop	ax
 36796                                  fatread_sft_retn: ; 17/12/2022
 36797 000061EF C3                      	retn
 36798                                  
 36799                                  ; 20/05/2019 - Retro DOS v4.0
 36800                                  ; DOSCODE:96B3h (MSDOS 6.21, MSDOS.SYS)
 36801                                  ; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 36802                                  ; DOSCODE:9657h (MSDOS 5.0, MSDOS.SYS)
 36803                                  
 36804                                  ; 03/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 36805                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A6C6h
 36806                                  
 36807                                  ;Break	<FATREAD_SFT/FATREAD_CDS -- CHECK DRIVE GET FAT>
 36808                                  ;----------------------------------------------------------------------------
 36809                                  ;
 36810                                  ; Procedure Name : FATREAD_SFT
 36811                                  ;
 36812                                  ; Inputs:
 36813                                  ;	ES:DI points to an SFT for the drive of interest (local only,
 36814                                  ;		giving a NET SFT will produce system crashing results).
 36815                                  ;	DS DOSDATA
 36816                                  ; Function:
 36817                                  ;	Can be used by an SFT routine (like CLOSE) to invalidate buffers
 36818                                  ;	if disk changed.
 36819                                  ;	In other respects, same as FATREAD_CDS.
 36820                                  ;	(note ES:DI destroyed!)
 36821                                  ; Outputs:
 36822                                  ;	Carry set if error (currently user FAILed to I 24)
 36823                                  ; NOTE: This routine may cause FATREAD_CDS to "miss" a disk change
 36824                                  ;	as far as invalidating curdir_ID is concerned.
 36825                                  ;	Since getting a true disk changed on this call is a screw up
 36826                                  ;	anyway, that's the way it goes.
 36827                                  ;
 36828                                  ;---------------------------------------------------------------------------
 36829                                  
 36830                                  FATREAD_SFT:
 36831 000061F0 26C46D07                	LES	BP,[ES:DI+SF_ENTRY.sf_devptr]
 36832                                  
 36833                                  fatread_gotdpb:	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36834                                  	; 27/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 36835                                  	;MOV	AL,[ES:BP+DPB.DRIVE] ; [es:bp+0]
 36836                                  	; 15/12/2022
 36837 000061F4 268A4600                	mov	AL,[ES:BP]
 36838 000061F8 A2[7605]                	MOV	[THISDRV],AL
 36839 000061FB E864A4                  	call	GOTDPB			; Set THISDPB
 36840                                  	;CALL	FAT_GOT_DPB
 36841                                  	; 17/12/2022
 36842 000061FE E99C00                  	jmp	FAT_GOT_DPB
 36843                                  ;fatread_sft_retn:
 36844                                  	;retn
 36845                                  
 36846                                  ;----------------------------------------------------------------------------
 36847                                  ;
 36848                                  ; Procedure Name : FATREAD_CDS
 36849                                  ;
 36850                                  ; Inputs:
 36851                                  ;	DS:DOSDATA
 36852                                  ;	ES:DI points to an CDS for the drive of interest (local only,
 36853                                  ;		giving a NET or NUL CDS will produce system crashing results).
 36854                                  ; Function:
 36855                                  ;	If disk may have been changed, media is determined and buffers are
 36856                                  ;	flagged invalid. If not, no action is taken.
 36857                                  ; Outputs:
 36858                                  ;	ES:BP = Drive parameter block
 36859                                  ;	THISDPB = ES:BP
 36860                                  ;	THISDRV set
 36861                                  ;	Carry set if error (currently user FAILed to I 24)
 36862                                  ; DS preserved , all other registers destroyed
 36863                                  ;
 36864                                  ;---------------------------------------------------------------------------
 36865                                  
 36866                                  	; 20/05/2019 - Retro DOS v4.0
 36867                                  	; DOSCODE:96C5h (MSDOS 6.21, MSDOS.SYS)
 36868                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 36869                                  	; DOSCODE:9669h (MSDOS 5.0, MSDOS.SYS)
 36870                                  
 36871                                  	; 03/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 36872                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A6D8h
 36873                                  	; (Windows ME IO.SYS - BIOSCODE:0C644h)
 36874                                  
 36875                                  FATREAD_CDS:
 36876 00006201 06                      	PUSH	ES
 36877 00006202 57                      	PUSH	DI
 36878                                  
 36879                                  	;les	bp,[es:di+45h]
 36880 00006203 26C46D45                	LES	BP,[ES:DI+curdir.devptr]
 36881                                  
 36882                                  ; 03/03/2024
 36883                                  %if 0
 36884                                  	; 27/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 36885                                  	;MOV	AL,[ES:BP+DPB.DRIVE] ; [es:bp+0]
 36886                                  	; 15/12/2022
 36887                                  	mov	AL,[ES:BP]
 36888                                  	MOV	[THISDRV],AL
 36889                                  	call	GOTDPB			;Set THISDPB
 36890                                  	CALL	FAT_GOT_DPB
 36891                                  %else
 36892                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36893                                  	;;;
 36894 00006207 E8EAFF                  	call	fatread_gotdpb
 36895                                  	;;;
 36896                                  %endif
 36897 0000620A 5F                      	POP	DI			;Get back CDS pointer
 36898 0000620B 07                      	POP	ES
 36899 0000620C 72E1                    	jc	short fatread_sft_retn
 36900 0000620E 7542                    	JNZ	short NO_CHANGE		;Media NOT changed
 36901                                  
 36902                                  ;	Media changed. We now need to find all CDS structures which use this
 36903                                  ;	DPB and invalidate their ID pointers.
 36904                                  
 36905                                  MED_CHANGE:
 36906                                  	;XOR	AX,AX
 36907                                  	;DEC	AX			; AX = -1
 36908                                  	; 03/03/2024
 36909 00006210 B8FFFF                  	mov	ax,0FFFFh ; -1
 36910                                  	
 36911 00006213 1E                      	PUSH	DS
 36912 00006214 8A0E[4700]              	MOV	CL,[CDSCOUNT]
 36913 00006218 30ED                    	XOR	CH,CH			; CX is number of structures
 36914                                  	;lds	si,[es:di+45h]
 36915 0000621A 26C57545                	LDS	SI,[ES:DI+curdir.devptr] ; Find all CDS with this devptr
 36916                                  
 36917                                  ;hkn; SS override
 36918                                  
 36919                                  ;	Find all CDSs with this DevPtr
 36920                                  ;
 36921                                  ;	(ax) = -1
 36922                                  ;	(ds:si) = DevPtr
 36923                                  
 36924 0000621E 36C43E[3C00]            	LES	DI,[SS:CDSADDR]		; (es:di) = CDS pointer
 36925                                  frcd20: 
 36926                                  	;;test	word [es:di+43h],8000h
 36927                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet
 36928 00006223 26F6454480              	TEST	byte [ES:DI+curdir.flags+1],(curdir_isnet>>8)
 36929 00006228 7522                    	JNZ	short frcd25		; Leave NET guys alone!!
 36930                                  
 36931                                  	; MSDOS 3.3
 36932                                  	;push	es
 36933                                  	;push	di
 36934                                  	;les	di,[es:di+45h]
 36935                                  	;;les	di,[ES:DI+curdir.devptr]
 36936                                  	;call	POINTCOMP
 36937                                  	;pop	di
 36938                                  	;pop	es
 36939                                  	;jnz	short frcd25
 36940                                  
 36941                                  	; MSDOS 6.0
 36942 0000622A 263B7545                	cmp	si,[ES:DI+curdir.devptr]
 36943 0000622E 751C                    	jne	short frcd25		; no match
 36944 00006230 8CDB                    	mov	bx,ds
 36945 00006232 263B5D47                	cmp	bx,[ES:DI+curdir.devptr+2]
 36946 00006236 7514                    	jne	short frcd25		; CDS not for this drive
 36947                                  
 36948                                  	; MSDOS 3.3 (& MSDOS 6.0)
 36949                                  	;test	[es:di+49h],ax	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A70Fh
 36950 00006238 26854549                	test	[ES:DI+curdir.ID],AX
 36951                                  	;JZ	short frcd25 ; = 0	; If root (0), leave root
 36952                                  		; !!! test es:[di+49h],ax
 36953                                  		; !!! jz short frcd25	
 36954                                  		; PCDOS 7.1 IBMDOS.COM bug (!?) ; Erdogan Tan - 03/03/2024
 36955                                  		; test dword ptr es:[di+49h],-1 ; Win ME - BIOSCODE:0C694h
 36956                                  		; jz short frcd25
 36957                                  		;
 36958                                  	; 03/03/2024 - Retro DOS v5.0
 36959 0000623C 7506                    	jnz	short frcd24
 36960                                  
 36961                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36962                                  	;;;
 36963                                  	;test	[es:di+4Bh],ax
 36964 0000623E 2685454B                	test	[es:di+curdir.ID+2],AX
 36965 00006242 7408                    	jz	short frcd25 ; = 0
 36966                                  frcd24:		; 03/03/2024
 36967                                  	;;;
 36968                                  	;mov	[es:di+49h],ax
 36969 00006244 26894549                	MOV	[ES:DI+curdir.ID],AX	; else invalid
 36970                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 36971                                  	;;;
 36972                                  	;mov	[es:di+4Bh],ax
 36973 00006248 2689454B                	mov	[es:di+curdir.ID+2],ax ; -1
 36974                                  	;;;
 36975                                  frcd25:	
 36976                                  	;;add	di,81  ; MSDOS 3.3
 36977                                  	;add	di,88  ; MSDOS 6.0	 
 36978 0000624C 83C758                  	ADD	DI,curdir.size		; Point to next CDS
 36979 0000624F E2D2                    	LOOP	frcd20
 36980 00006251 1F                      	POP	DS
 36981                                  NO_CHANGE:
 36982 00006252 C42E[8A05]              	LES	BP,[THISDPB]
 36983 00006256 F8                      	CLC
 36984 00006257 C3                      	retn
 36985                                  
 36986                                  ; =============== S U B R O U T I N E =======================================
 36987                                  ; 05/01/2024 - Retro DOS 5.0
 36988                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0A7Fh
 36989                                  ;;;
 36990                                  chk_set_first_access:
 36991                                  	;cmp	word [es:bp+0Fh],0
 36992 00006258 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 36993 0000625D 750D                    	jnz	short chk_set_fa_1	; FAT (FAT12 or FAT16)
 36994                                  	; FAT32
 36995                                  	;cmp	word [es:bp+21h],0FFFFh
 36996 0000625F 26837E21FF              	cmp	word [es:bp+DPB.FREE_CNT_HW],0FFFFh ; -1
 36997                                  	;mov	word [es:bp+21h],0FFFFh	; High word of free cluster count
 36998 00006264 26C74621FFFF            	mov	word [es:bp+DPB.FREE_CNT_HW],0FFFFh ; -1
 36999 0000626A 7505                    	jne	short chk_set_fa_2
 37000                                  chk_set_fa_1:
 37001                                  	;cmp	word [es:bp+1Fh],0FFFFh
 37002 0000626C 26837E1FFF              	cmp	word [es:bp+DPB.FREE_CNT],0FFFFh ; -1
 37003                                  chk_set_fa_2:
 37004                                  	;mov	word [es:bp+1Fh],0FFFFh	; Count of free clusters, -1 if unknown
 37005 00006271 26C7461FFFFF            	mov	word [es:bp+DPB.FREE_CNT],0FFFFh ; -1
 37006 00006277 7405                    	je	short chk_set_fa_3
 37007                                  	;or	byte [es:bp+18h],1
 37008 00006279 26804E1801              	or	byte [es:bp+DPB.FIRST_ACCESS],1
 37009                                  chk_set_fa_3:
 37010 0000627E C3                      	retn
 37011                                  ;;;
 37012                                  ;----------------------------------------------------------------------------
 37013                                  
 37014                                  
 37015                                  ;Break	<Fat_Operation - miscellaneous fat stuff>
 37016                                  ;----------------------------------------------------------------------------
 37017                                  ;
 37018                                  ; Procedure Name : FAT_operation
 37019                                  ;
 37020                                  ;----------------------------------------------------------------------------
 37021                                  
 37022                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 37023                                  
 37024                                  	; 04/03/2024
 37025                                  	; 03/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 37026                                  
 37027                                  FAT_operation:
 37028                                  	; 31/07/2018 - Retro DOS v3.0
 37029                                  FATERR:
 37030                                  
 37031                                  ; 03/03/2024
 37032                                  %if 0
 37033                                  	;mov	word [es:bp+1Eh],-1
 37034                                  	;mov	word [es:bp+1Fh],-1 ; MSDOS 6.0
 37035                                  	MOV	word [ES:BP+DPB.FREE_CNT],-1 
 37036                                  					; Err in FAT must force recomp of freespace
 37037                                  %else
 37038                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37039                                  	;;;
 37040 0000627F E8D6FF                  	call    chk_set_first_access
 37041                                  	;;;
 37042                                  %endif
 37043                                  	;and	di,0FFh
 37044 00006282 81E7FF00                	AND	DI,STECODE		; Put error code in DI
 37045                                  	;mov	byte [ALLOWED],18h
 37046 00006286 C606[4B03]18            	MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY
 37047                                  	;mov	ah,1Ah
 37048 0000628B B41A                    	MOV	AH,2+Allowed_FAIL+Allowed_RETRY ; While trying to read FAT
 37049 0000628D A0[7605]                	MOV	AL,[THISDRV]		; Tell which drive
 37050 00006290 E8F2FA                  	call	FATAL1
 37051 00006293 C42E[8A05]              	LES	BP,[THISDPB]
 37052 00006297 3C03                    	CMP	AL,3
 37053 00006299 7502                    	JNZ	short FAT_GOT_DPB	; User said retry
 37054                                  
 37055                                  FATERR_fail:	; 03/03/2024
 37056 0000629B F9                      	STC				; User said FAIL
 37057 0000629C C3                      	retn
 37058                                  
 37059                                  FAT_GOT_DPB:
 37060                                  	;Context DS			;hkn; SS is DOSDATA
 37061 0000629D 16                      	push	ss
 37062 0000629E 1F                      	pop	ds
 37063                                  
 37064                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37065                                  	;;;
 37066 0000629F 8CC0                    	mov	ax,es
 37067 000062A1 09E8                    	or	ax,bp
 37068 000062A3 74F6                    	jz	short FATERR_fail
 37069                                  	;;;
 37070                                  
 37071                                  	;;mov	al,0Fh
 37072                                  	;MOV	AL,DMEDHL
 37073                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37074                                  	;;;
 37075 000062A5 B013                    	mov	al,19
 37076                                  	;;;
 37077                                  
 37078                                  	;mov	ah,[es:bp+1]
 37079 000062A7 268A6601                	MOV	AH,[ES:BP+DPB.UNIT]
 37080 000062AB A3[5A03]                	MOV	[DEVCALL_REQLEN],AX ; 09/09/2018 
 37081 000062AE C606[5C03]01            	MOV	BYTE [DEVCALL_REQFUNC],DEVMDCH
 37082 000062B3 C706[5D03]0000          	MOV	word [DEVCALL_REQSTAT],0
 37083                                  	;;mov	al,[es:bp+16h]
 37084                                  	;mov	al,[es:bp+17h] ; MSDOS 6.0
 37085 000062B9 268A4617                	MOV	AL,[ES:BP+DPB.MEDIA]
 37086 000062BD A2[6703]                	MOV	[CALLMED],AL
 37087 000062C0 06                      	PUSH	ES
 37088 000062C1 1E                      	PUSH	DS
 37089                                  
 37090                                  ;hkn; DEVCALL is in DOSDATA
 37091 000062C2 BB[5A03]                	MOV	BX,DEVCALL
 37092                                  	;;lds	si,[es:bp+12h]
 37093                                  	;lds	si,[es:bp+13h] ; MSDOS 6.0
 37094 000062C5 26C57613                	LDS	SI,[ES:BP+DPB.DRIVER_ADDR] ; DS:SI Points to device header
 37095 000062C9 07                      	POP	ES			; ES:BX Points to call header
 37096 000062CA E8ABEC                  	call	DEVIOCALL2
 37097                                  	;Context DS		 	;hkn; SS is DOSDATA
 37098 000062CD 16                      	push	ss
 37099 000062CE 1F                      	pop	ds
 37100 000062CF 07                      	POP	ES			; Restore ES:BP
 37101 000062D0 8B3E[5D03]              	MOV	DI,[DEVCALL_REQSTAT]
 37102                                  	;test	di,8000h
 37103                                  	;jnz	short FATERR
 37104 000062D4 09FF                    	or	di,di
 37105 000062D6 78A7                    	js	short FATERR		; have error
 37106                                  
 37107                                  ; 03/03/2024
 37108                                  %if 0
 37109                                  	XOR	AH,AH
 37110                                  	;xchg	ah,[es:bp+17h] ; MSDOS 3.3
 37111                                  	;xchg	ah,[es:bp+18h] ; MSDOS 6.0
 37112                                  	XCHG	AH,[ES:BP+DPB.FIRST_ACCESS] ; Reset dpb_first_access
 37113                                  %else
 37114                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37115                                  	;;;
 37116                                  	;mov	ah,[es:bp+18h]
 37117 000062D8 268A6618                	mov	ah,[es:bp+DPB.FIRST_ACCESS]
 37118 000062DC 80E480                  	and	ah,80h		; izolate (FAT) first access bit
 37119                                  	;and	byte [es:bp+18h],7Fh
 37120 000062DF 268066187F              	and	byte [es:bp+DPB.FIRST_ACCESS],7Fh
 37121                                  				; clear first access (FAT) bit 7
 37122                                  	;;; 
 37123                                  %endif
 37124                                  
 37125 000062E4 A0[7605]                	MOV	AL,[THISDRV]		; Use physical unit number
 37126                                  ; See if we had changed volume id by creating one on the diskette
 37127 000062E7 3806[A10A]              	cmp	[VOLCHNG_FLAG],AL
 37128 000062EB 7508                    	jnz	short CHECK_BYT
 37129 000062ED C606[A10A]FF            	mov	byte [VOLCHNG_FLAG],-1 ; 0FFh
 37130 000062F2 E9B000                  	jmp	GOGETBPB		; Need to get device driver to read in
 37131                                  					; new volume label.
 37132                                  CHECK_BYT:
 37133 000062F5 0A26[6803]              	OR	AH,[CALLRBYT]
 37134                                  	;JNS	short CHECK_ZR		; ns = 0 or 1
 37135                                  	;JMP	short NEWDSK
 37136                                  	; 17/12/2022
 37137 000062F9 785E                    	js	short NEWDSK
 37138                                  	; 27/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 37139                                  	;JNS	short CHECK_ZR		; ns = 0 or 1
 37140                                  	;JMP	short NEWDSK
 37141                                  
 37142                                  CHECK_ZR:
 37143 000062FB 743B                    	JZ	short CHKBUFFDIRT	; jump if I don't know
 37144                                  	; 24/09/2023
 37145                                  	; cf=0 (after 'or' instruction)
 37146                                  	;CLC
 37147 000062FD C3                      	retn				; If Media not changed (NZ)
 37148                                  
 37149                                  DISK_CHNG_ERR:
 37150 000062FE 06                      	PUSH	ES
 37151 000062FF 55                      	PUSH	BP
 37152                                  	;;les	bp,[es:bp+12h]
 37153                                  	;les	bp,[es:bp+13h] ; MSDOS 6.0
 37154 00006300 26C46E13                	LES	BP,[ES:BP+DPB.DRIVER_ADDR] ; Get device pointer
 37155                                  	;;test	word [es:bp+4],800h
 37156                                  	;TEST	word [ES:BP+SYSDEV.ATT],DEVOPCL ; Did it set vol id?
 37157 00006304 26F6460508              	test	byte [es:bp+SYSDEV.ATT+1],(DEVOPCL>>8)
 37158 00006309 5D                      	POP	BP
 37159 0000630A 07                      	POP	ES
 37160                                  	;JZ	short FAIL_OPJ2		; Nope, FAIL
 37161                                  	; 03/03/2024
 37162 0000630B 7477                    	jz	short FAIL_OP
 37163 0000630D 1E                      	PUSH	DS			; Save buffer pointer for ignore
 37164 0000630E 57                      	PUSH	DI
 37165 0000630F 16                      	push	ss			;hkn; SS is DOSDATA
 37166 00006310 1F                      	pop	ds
 37167                                  	;mov	byte [ALLOWED],18h
 37168 00006311 C606[4B03]18            	MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY
 37169 00006316 06                      	PUSH	ES
 37170 00006317 C43E[6903]              	LES	DI,[CALLVIDM]		; Get volume ID pointer
 37171 0000631B 8C06[2A03]              	MOV	[EXTERRPT+2],ES
 37172 0000631F 07                      	POP	ES
 37173 00006320 893E[2803]              	MOV	[EXTERRPT],DI
 37174                                  	;mov	ax,0Fh
 37175 00006324 B80F00                  	MOV	AX,error_I24_wrong_disk
 37176 00006327 C606[7505]01            	MOV	byte [READOP],1		; Write
 37177                                  	;invoke	HARDERR
 37178 0000632C E8CBF9                  	call	HARDERR
 37179 0000632F 5F                      	POP	DI			; Get back buffer for ignore
 37180 00006330 1F                      	POP	DS
 37181 00006331 3C03                    	CMP	AL,3
 37182                                  FAIL_OPJ2:
 37183 00006333 744F                    	JZ	short FAIL_OP
 37184 00006335 E965FF                  	JMP	FAT_GOT_DPB		; Retry
 37185                                  
 37186                                  CHKBUFFDIRT:
 37187                                  	; 20/05/2019 - Retro DOS v4.0
 37188                                  
 37189                                  	; MSDOS 3.3
 37190                                  	;lds	di,[BUFFHEAD]
 37191                                  
 37192                                  	; MSDOS 6.0
 37193                                  	;cmp	word [ss:DirtyBufferCount],0	; any dirty buffers ? ;hkn;
 37194                                  	; 03/03/2024 - Retro DOS v5.0
 37195                                  	; ds=ss
 37196                                  	;;;
 37197 00006338 833E[7100]00            	cmp	word [DirtyBufferCount],0 ; (Win ME IO.SYS - BIOSCODE:0C7A7h)
 37198                                  	;;;
 37199 0000633D 741A                    	je	short NEWDSK			; no, skip the check
 37200 0000633F E81D02                  	call	GETCURHEAD			; get pointer to first buffer
 37201                                  nbuffer:
 37202                                  	;cmp	al,[di+4]
 37203 00006342 384504                  	cmp	[di+BUFFINFO.buf_ID],al	; Unit OK ?
 37204 00006345 7509                    	jne	short lfnxt			; no, go for next buffer
 37205                                  	;test   byte [di+5],40h
 37206 00006347 F6450540                	TEST	byte [di+BUFFINFO.buf_flags],buf_dirty	; is the buffer dirty ?
 37207 0000634B 7403                    	jz	short lfnxt			; no, go for next buffer
 37208                                  
 37209                                  FAIL_OP2:	; 03/03/2024
 37210                                  	;Context DS
 37211 0000634D 16                      	push	ss
 37212 0000634E 1F                      	pop	ds
 37213                                  	; 24/09/2023
 37214                                  	; cf=0 (after 'test' instruction)
 37215                                  	;clc
 37216 0000634F C3                      	retn
 37217                                  
 37218                                  lfnxt:
 37219                                  	; 15/08/2018 - Retro DOS v3.0
 37220                                  	; MSDOS 3.3
 37221                                  	;lds	di,[di]
 37222                                  
 37223                                  	; 20/05/2019 - Retro DOS v4.0
 37224 00006350 8B3D                    	mov	di,[di]
 37225                                  	;;mov	di,[di+BUFFINFO.buf_next]	; get next buffer
 37226                                  	
 37227                                  	; MSDOS 3.3
 37228                                  	;cmp	di,-1
 37229                                  	;jne	short nbuffer
 37230                                  	
 37231                                  	; MSDOS 6.0
 37232 00006352 36393E[1B11]            	cmp	[ss:FIRST_BUFF_ADDR],di		; is this where we started ?;hkn;
 37233 00006357 75E9                    	jne	short nbuffer			; no, check this guy also
 37234                                  
 37235                                  ; If no dirty buffers, assume Media changed
 37236                                  NEWDSK:
 37237                                  	;;mov	word [es:bp+1Eh],0FFFFh  ; MSDOS 3.3
 37238                                  	;mov	word [es:bp+1Fh],0FFFFh  ; MSDOS 6.0
 37239 00006359 26C7461FFFFF            	mov	word [ES:BP+DPB.FREE_CNT],-1	; Media changed, must
 37240                                  						;  recompute
 37241                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37242                                  	;;;
 37243                                  	;cmp	word [es:bp+0Fh],0
 37244 0000635F 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0 ; = 0 for FAT32 fs
 37245 00006364 7506                    	jnz	short newdsk2	 ; not FAT32
 37246                                  	;mov	word [es:bp+21h],0FFFFh
 37247 00006366 26C74621FFFF            	mov	word [ES:BP+DPB.FREE_CNT_HW],0FFFFh ; -1
 37248                                  newdsk2:
 37249                                  	;;;
 37250                                  
 37251                                  	; MSDOS 3.3
 37252                                  	;call	SETVISIT
 37253                                  	; MSDOS 6.0
 37254 0000636C E8F001                  	call	 GETCURHEAD
 37255                                  nxbuffer:
 37256                                  	; MSDOS 3.3
 37257                                  	;or 	byte [di+5],20h
 37258                                  	; MSDOS 3.3 & MSDOS 6.0
 37259                                  	;cmp	[di+4],al
 37260 0000636F 384504                  	cmp	[DI+BUFFINFO.buf_ID],al		; This drive ?
 37261 00006372 7513                    	jne	short lfnxt2
 37262                                  	;test	byte [di+5],40h
 37263 00006374 F6450540                	TEST	byte [DI+BUFFINFO.buf_flags],buf_dirty
 37264 00006378 7584                    	jnz	short DISK_CHNG_ERR
 37265                                  	;mov	word [di+4],20FFh
 37266 0000637A C74504FF20              	mov	word [DI+BUFFINFO.buf_ID],(buf_visit*256)+0FFh ; free up
 37267 0000637F E8EF01                  	call	SCANPLACE
 37268                                  	; MSDOS 6.0
 37269 00006382 EB05                    	jmp	short skpbuff
 37270                                  
 37271                                  	; 03/03/2024 - Retro DOS v5.0
 37272                                  FAIL_OP:					; This label & code is here
 37273                                  	;Context DS				;  for reachability
 37274                                  	;push	ss
 37275                                  	;pop	ds
 37276 00006384 F9                      	STC
 37277                                  	; 03/03/2024
 37278                                  	;retn
 37279                                  FAIL_OP2J:	; 03/03/2024
 37280 00006385 EBC6                    	jmp	short FAIL_OP2 ; cf=1
 37281                                  
 37282                                  lfnxt2:
 37283 00006387 8B3D                    	mov	di,[di]
 37284                                  	;mov	di,[di+BUFFINFO.buf_next]
 37285                                  skpbuff:
 37286                                  	; MSDOS 6.0
 37287 00006389 363B3E[1B11]            	cmp	di,[ss:FIRST_BUFF_ADDR]					;hkn;
 37288 0000638E 75DF                    	jne	short nxbuffer
 37289                                  
 37290 00006390 36833E[7700]00          	CMP	word [ss:SC_CACHE_COUNT],0 ;LB.  look ahead buffers ?	;AN001;
 37291 00006396 740D                    	JZ	short GOGETBPB		;LB.  no			;AN001;
 37292 00006398 363A06[1211]            	CMP	AL,[ss:CurSC_DRIVE]	;LB.  same as changed drive	;AN001;
 37293 0000639D 7506                    	JNZ	short GOGETBPB		;LB.  no			;AN001;
 37294 0000639F 36C606[1211]FF          	MOV	byte [ss:CurSC_DRIVE],-1 ;LB.  invalidate look ahead buffers ;AN000;
 37295                                  ;lfnxt2:
 37296                                  	; MSDOS 3.3
 37297                                  	;call	SKIPVISIT
 37298                                  	;jnz	short nxbuffer
 37299                                  GOGETBPB:
 37300                                  	; MSDOS 3.3 & MSDOS 6.0
 37301                                  	;;lds	di,[es:bp+12h]
 37302                                  	;lds	di,[es:bp+13h] ; MSDOS 6.0	
 37303 000063A5 26C57E13                	LDS	DI,[ES:BP+DPB.DRIVER_ADDR]
 37304                                  	; 20/05/2019
 37305                                  	;test	word [di+4],2000h
 37306                                  	;TEST	word [DI+SYSDEV.ATT],ISFATBYDEV
 37307 000063A9 F6450520                	TEST	byte [DI+SYSDEV.ATT+1],(ISFATBYDEV>>8)
 37308 000063AD 7533                    	JNZ	short GETFREEBUF
 37309                                  	;context DS	    		;hkn; SS is DOSDATA
 37310 000063AF 16                      	push	ss
 37311 000063B0 1F                      	pop	ds
 37312                                  
 37313                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37314                                  	;;;
 37315                                   	;mov	word [es:bp+2],200h
 37316 000063B1 26C746020002            	mov	word [es:bp+DPB.SECTOR_SIZE],512 ; bytes per sector
 37317                                  	;mov	word [es:bp+6],1
 37318 000063B7 26C746060100            	mov	word [es:bp+DPB.FIRST_FAT],1	; starting sector of FATs
 37319                                  	;mov	byte [es:bp+8],1
 37320 000063BD 26C6460801              	mov	byte [es:bp+DPB.FAT_COUNT],1	; number of FATs
 37321                                  	;mov	word [es:bp+0Dh],3
 37322 000063C2 26C7460D0300            	mov	word [es:bp+DPB.MAX_CLUSTER],3	; cluster count + 1
 37323                                  	;mov	word [es:bp+0Fh],1
 37324 000063C8 26C7460F0100            	mov	word [es:bp+DPB.FAT_SIZE],1	; FAT sectors (16 bit)
 37325 000063CE C706[E80A]0000          	mov     word [CLUSTNUM_HW],0	; high word of cluster number (for UNPACK)
 37326                                  	;;;
 37327                                  
 37328 000063D4 BB0200                  	MOV	BX,2
 37329 000063D7 E8ADFB                  	CALL	UNPACK			; Read the first FAT sector into CURBUF
 37330                                  FAIL_OPJ:
 37331                                  	;JC	short FAIL_OP
 37332                                  	; 03/03/2024
 37333 000063DA 72A9                    	jc	short FAIL_OP2J ; cf=1
 37334 000063DC C53E[E205]              	LDS	DI,[CURBUF]
 37335 000063E0 EB22                    	JMP	SHORT GOTGETBUF
 37336                                  
 37337                                  GETFREEBUF:
 37338                                  	; 03/03/2024 (PCDOS 7.1 IBMDOS.COM)
 37339                                  	;;;
 37340 000063E2 31D2                    	xor	dx,dx ; 0 ; *
 37341 000063E4 36C53E[7A00]            	lds	di,[ss:LoMemBuff]
 37342                                  	;sub	di,24
 37343 000063E9 83EF18                  	sub	di,BUFINSIZ
 37344 000063EC 363816[7900]            	cmp	[ss:BuffInHMA],dl ; 0
 37345 000063F1 7511                    	jnz	short GOTGETBUF		; buffer is in HMA
 37346                                  					; use [LowMemBuff] to transfer at first
 37347                                  	;;;
 37348                                  
 37349 000063F3 06                      	PUSH	ES			; Get a free buffer for BIOS to use
 37350 000063F4 55                      	PUSH	BP
 37351                                  	; MSDOS 3.3
 37352                                  	;LDS	DI,[SS:BUFFHEAD] ; 15/08/2018
 37353                                  	; 03/03/2024  ; *
 37354                                  	; MSDOS 6.0
 37355                                  	;XOR	DX,DX ; *		;LB.  fake to get 1st	  ;AN000;
 37356                                  ;hkn; SS override
 37357 000063F5 368916[0706]            	MOV	[SS:HIGH_SECTOR],DX ; 0	;LB.  buffer addr	  ;AN000;
 37358 000063FA E86201                  	call	GETCURHEAD		;LB.			  ;AN000;
 37359                                  	; MSDOS 3.3 & MSDOS 6.0
 37360 000063FD E8C203                  	call	BUFWRITE
 37361 00006400 5D                      	POP	BP
 37362 00006401 07                      	POP	ES
 37363                                  	;;JC	short FAIL_OPJ
 37364                                  	;jc	short FAIL_OP
 37365                                  	; 03/03/2024 - Retro DOS v5.0
 37366 00006402 7281                    	jc	short FAIL_OP2J ; cf=1
 37367                                  
 37368                                  GOTGETBUF:
 37369                                  	;;;add	di,16
 37370                                  	;;add	di,20 ; MSDOS 6.0
 37371                                  	;add	di,24 ; PCDOS 7.1 ; 03/03/2024  
 37372 00006404 83C718                  	ADD	DI,BUFINSIZ
 37373                                  
 37374                                  ;hkn; SS override
 37375 00006407 368C1E[6A03]            	MOV	[SS:CALLXAD+2],DS
 37376                                  	;Context DS			;hkn; SS is DOSDATA
 37377 0000640C 16                      	push	ss
 37378 0000640D 1F                      	pop	ds
 37379 0000640E 893E[6803]              	MOV	[CALLXAD],DI
 37380                                  	;mov	al,16h
 37381 00006412 B016                    	MOV	AL,DBPBHL ; 22
 37382                                  	;mov	ah,[es:bp+1]
 37383 00006414 268A6601                	MOV	AH,[ES:BP+DPB.UNIT]
 37384 00006418 A3[5A03]                	MOV	[DEVCALL_REQLEN],AX ; 09/09/2018
 37385 0000641B C606[5C03]02            	MOV	BYTE [DEVCALL_REQFUNC],DEVBPB ; 2
 37386 00006420 C706[5D03]0000          	MOV	word [DEVCALL_REQSTAT],0
 37387                                  	;;mov	al,[es:bp+16h]
 37388                                  	;mov	al,[es:bp+17h]
 37389 00006426 268A4617                	MOV	AL,[ES:BP+DPB.MEDIA]
 37390 0000642A A2[6703]                	MOV	[CALLMED],AL
 37391 0000642D 06                      	PUSH	ES
 37392 0000642E 1E                      	PUSH	DS
 37393                                  
 37394                                  ; 04/03/2024
 37395                                  %if 0
 37396                                  	;;push	word [es:bp+14h]
 37397                                  	;push	word [es:bp+15h] ; MSDOS 6.0
 37398                                  	PUSH	WORD [ES:BP+DPB.DRIVER_ADDR+2]
 37399                                  	;;push	word [es:bp+12h]
 37400                                  	;push	word [es:bp+13h] ; MSDOS 6.0
 37401                                  	PUSH	WORD [ES:BP+DPB.DRIVER_ADDR]
 37402                                  
 37403                                  ;hkn; DEVCALL is in DOSDATA
 37404                                  	MOV	BX,DEVCALL
 37405                                  	POP	SI
 37406                                  	POP	DS			; DS:SI Points to device header
 37407                                  %else
 37408                                  	; 04/03/2024 - Retro DOS v5.0
 37409                                  	; PCDOS 7.1 IBMDOS.COM
 37410 0000642F BB[5A03]                	mov	bx,DEVCALL
 37411                                  	;lds	si,[es:bp+13h]
 37412 00006432 26C57613                	lds	si,[es:bp+DPB.DRIVER_ADDR] ; DS:SI Points to device header
 37413                                  %endif
 37414                                  
 37415 00006436 07                      	POP	ES			; ES:BX Points to call header
 37416                                  	;invoke	DEVIOCALL2
 37417 00006437 E83EEB                  	call	DEVIOCALL2
 37418 0000643A 07                      	POP	ES			; Restore ES:BP
 37419                                  	;Context DS
 37420 0000643B 16                      	push	ss		 	;hkn; SS is DOSDATA
 37421 0000643C 1F                      	pop	ds
 37422 0000643D 8B3E[5D03]              	MOV	DI,[DEVCALL_REQSTAT]
 37423                                  
 37424                                  ; 04/03/2024
 37425                                  %if 0
 37426                                  	; MSDOS 3.3
 37427                                  	;test	di,8000h
 37428                                  	;jnz	short FATERRJ
 37429                                  	; MSDOS 6.0
 37430                                  	or	di,di
 37431                                  	js	short FATERRJ 		; have error
 37432                                  
 37433                                  	; 04/03/2024
 37434                                  	;;;mov	al,[es:bp+16h]
 37435                                  	;;mov	al,[es:bp+17h]  ; MSDOS 6.0
 37436                                  	;MOV	AL,[ES:BP+DPB.MEDIA]
 37437                                  
 37438                                  	LDS	SI,[CALLBPB]
 37439                                  	;;mov	word [es:bp+1Ch],0
 37440                                  	;mov	word [es:bp+1Dh],0 ; MSDOS 6.0
 37441                                  	MOV	word [ES:BP+DPB.NEXT_FREE],0 ; recycle scanning pointer
 37442                                  
 37443                                  	;invoke	$SETDPB
 37444                                  	call	_$SETDPB
 37445                                  
 37446                                  ;hkn; SS override
 37447                                  	LDS	DI,[SS:CALLXAD]		; Get back buffer pointer
 37448                                  	
 37449                                  	;mov	al,[es:bp+8]
 37450                                  	MOV	AL,[ES:BP+DPB.FAT_COUNT]
 37451                                  
 37452                                  	; MSDOS 3.3
 37453                                  	;;mov	ah,[es:bp+0Fh]
 37454                                  	;MOV	AH,[ES:BP+DPB.FAT_SIZE]
 37455                                  	;;mov	[DI-8],ax
 37456                                  	;MOV	[DI+BUFFINFO.buf_wrtcnt-BUFINSIZ],AX
 37457                                  
 37458                                  	; MSDOS 6.0
 37459                                  	;mov	[di-0Ah],al
 37460                                  	MOV	[DI+BUFFINFO.buf_wrtcnt-BUFINSIZ],AL 
 37461                                  						;>32mb		;AN000;
 37462                                  	;mov	ax,[es:bp+0Fh]
 37463                                  	MOV	AX,[ES:BP+DPB.FAT_SIZE]		;>32mb
 37464                                  	;mov	[di-09h],ax					;AC000;
 37465                                  	MOV	[DI+BUFFINFO.buf_wrtcntinc-BUFINSIZ],AX 
 37466                                  					;>32mb Correct buffer info ;AC000;
 37467                                  	;Context DS			;hkn; SS is DOSDATA
 37468                                  	push	ss
 37469                                  	pop	ds
 37470                                  	XOR	AL,AL			;Media changed (Z), Carry clear
 37471                                  	retn
 37472                                  
 37473                                  FATERRJ: 
 37474                                  	JMP	FATERR
 37475                                  
 37476                                  %else
 37477                                  	; 04/03/2024 - Retro DOS v5.0
 37478                                  	; PCDOS 7.1 IBMDOS.COM
 37479                                  	;;;
 37480 00006441 09FF                    	or	di,di
 37481 00006443 790C                    	jns	short gotgetbuf2
 37482                                  	; error
 37483 00006445 C53E[6803]              	lds     di,[CALLXAD] ; Buffer (data) address
 37484                                  	;mov	word [di-20],0FFh 
 37485 00006449 C745ECFF00              	mov	word [di+BUFFINFO.buf_ID-BUFINSIZ],0FFh
 37486                                  				; byte BUFFINFO.buf_ID = 0FFh ; FREE
 37487                                  				; byte BUFFINFO.buf_flags = 0
 37488 0000644E E92EFE                  	jmp	FATERR
 37489                                  	
 37490                                  gotgetbuf2:
 37491 00006451 C536[6C03]              	lds	si,[CALLBPB]	; Address of the BPB (DEVCALL offset 18)
 37492                                  
 37493 00006455 31C9                    	xor	cx,cx	; 0
 37494                                  	;mov	[es:bp+1Dh],cx	; [ES:BP+DPB.NEXT_FREE] = 0
 37495                                  	; 01/07/2024
 37496 00006457 26894E1D                	mov	[es:bp+DPB.NEXT_FREE],cx ; 0
 37497                                  				; recycle scanning pointer
 37498                                  
 37499 0000645B BA5241                  	mov	dx,4152h	; 'RA' ; FAT32 extended BPB/DPB signature
 37500                                  
 37501                                  	;cmp	[si+0Bh],cx	; BPB.fatsecs ; 16 bit FAT size = 0 for FAT32 fs
 37502 0000645E 394C0B                  	cmp	[si+A_BPB.SECTORSPERFAT],cx ; 0
 37503 00006461 7514                    	jnz	short gotgetbuf3 ; not FAT32
 37504                                  
 37505                                  	;mov	[es:bp+39h],cx
 37506 00006463 26894E39                	mov	[es:bp+DPB.FAT32_NXTFREE],cx ; 0
 37507                                  	;mov	[es:bp+3Bh],cx
 37508 00006467 26894E3B                	mov	[es:bp+DPB.FAT32_NXTFREE+2],cx ; 0
 37509 0000646B 49                      	dec	cx	; -1
 37510                                  	;mov	[es:bp+1Fh],cx	; (DPB.FREE_CNT) set free count to -1 (unknown)
 37511 0000646C 26894E1F                	mov	[es:bp+DPB.FREE_CNT],cx ; 0FFFFh
 37512                                  	;mov	[es:bp+21h],cx
 37513 00006470 26894E21                	mov	[es:bp+DPB.FREE_CNT_HW],cx ; 0FFFFh
 37514                                  	;
 37515 00006474 B95845                  	mov	cx,4558h	; 'XE' ; FAT32 extended BPB/DPB signature
 37516                                  gotgetbuf3:
 37517                                  
 37518                                  	;invoke	$SETDPB
 37519 00006477 E8C8AF                  	call	_$SETDPB
 37520                                  
 37521                                  ;hkn; SS override
 37522 0000647A 36C53E[6803]            	LDS	DI,[SS:CALLXAD]		; Get back buffer pointer
 37523                                  	
 37524                                  	;mov	dx,[es:bp+25h]
 37525 0000647F 268B5625                	mov	dx,[es:bp+DPB.FSINFO_SECTOR]
 37526 00006483 31C9                    	xor	cx,cx	; 0
 37527                                  	;cmp	[es:bp+0Fh],cx
 37528 00006485 26394E0F                	cmp	[es:bp+DPB.FAT_SIZE],cx	; 16 bit FAT size field
 37529 00006489 7403                    	jz	short gotgetbuf4 ; FAT32 fs
 37530 0000648B E99400                  	jmp	gotgetbuf12	; FAT fs
 37531                                  
 37532                                  gotgetbuf4:
 37533 0000648E 83FAFF                  	cmp	dx,0FFFFh		; invalid ?
 37534 00006491 7503                    	jnz	short gotgetbuf5	; no
 37535 00006493 E98C00                  	jmp	gotgetbuf12		; skip reading FSINFO sector
 37536                                  
 37537                                  gotgetbuf5:
 37538 00006496 36890E[0706]            	mov	[ss:HIGH_SECTOR],cx ; 0
 37539 0000649B 89FB                    	mov	bx,di
 37540                                  
 37541                                  	;cmp	byte [ss:BuffInHMA],0
 37542 0000649D 36380E[7900]            	cmp	[ss:BuffInHMA],cl ; 0
 37543 000064A2 7405                    	jz	short gotgetbuf6	; buffer is in conventional (<=640KB) memory
 37544 000064A4 36C51E[7A00]            	lds	bx,[ss:LoMemBuff]	; use a buffer in conventional memory
 37545                                  	;mov	di,bx
 37546                                  gotgetbuf6:
 37547 000064A9 36C606[4B03]18          	mov	byte [ss:ALLOWED],Allowed_FAIL+Allowed_RETRY ; 18h
 37548 000064AF 41                      	inc	cx
 37549                                  	;push	di
 37550 000064B0 53                      	push	bx
 37551 000064B1 E80BDA                  	call	DREAD
 37552 000064B4 5B                      	pop	bx
 37553                                  	;pop	di
 37554 000064B5 89DF                    	mov	di,bx ; Retro DOS v5.0
 37555 000064B7 725F                    	jc	short gotgetbuf11	; ds:di = (FSINFO sector) buffer
 37556                                  
 37557                                  	; FSI_HeadSig = 41615252h
 37558                                  
 37559 000064B9 813D5252                	cmp	word [di],5252h		; 'RR' ; check if it is a valid FSINFO sector
 37560                                  	;cmp	word [di+FSINFO.LeadSig],5252
 37561 000064BD 7559                    	jnz	short gotgetbuf11	; not valid
 37562                                  	;cmp	word [di+2],4161h	; 'aA' ; (NASM syntax)
 37563 000064BF 817D026141              	cmp	word [di+FSINFO.LeadSig+2],4161h
 37564 000064C4 7552                    	jnz	short gotgetbuf11
 37565                                  	;cmp	word [di+484],7272h	; 'rr' ; FSI_StrucSig = 61417272h
 37566 000064C6 81BDE4017272            	cmp	word [di+FSINFO.StrucSig],7272h
 37567 000064CC 754A                    	jnz	short gotgetbuf11
 37568                                  	;cmp	word [di+486],6141h	; 'Aa'
 37569 000064CE 81BDE6014161            	cmp	word [di+FSINFO.StrucSig+2],6141h
 37570 000064D4 7542                    	jnz	short gotgetbuf11	; not valid
 37571                                  
 37572                                  	; valid
 37573 000064D6 52                      	push	dx
 37574 000064D7 53                      	push	bx
 37575 000064D8 51                      	push	cx
 37576                                  
 37577                                  	;mov	bx,[es:bp+2Fh]
 37578 000064D9 268B5E2F                	mov	bx,[es:bp+DPB.LAST_CLUSTER+2]
 37579                                  	;mov	cx,[es:bp+2Dh]
 37580 000064DD 268B4E2D                	mov	cx,[es:bp+DPB.LAST_CLUSTER]
 37581                                  
 37582                                  	;mov	ax,[di+488]		; FSI_FreeCount ; bx:cx = number of clusters + 1
 37583 000064E1 8B85E801                	mov	ax,[di+FSINFO.Free_Count]
 37584                                  	;mov	dx,[di+490]		; FSI_FreeCount+2
 37585 000064E5 8B95EA01                	mov	dx,[di+FSINFO.Free_Count+2]
 37586                                  
 37587 000064E9 39DA                    	cmp	dx,bx			; is Free Count >= (Number of Clusters + 1) ?
 37588 000064EB 7502                    	jne	short gotgetbuf7	; if yes, it is invalid value (must be 0FFFFFFFFh)
 37589 000064ED 39C8                    	cmp	ax,cx
 37590                                  gotgetbuf7:
 37591 000064EF 7308                    	jnb	short gotgetbuf8	; yes, invalid value (must be 0FFFFFFFFh)
 37592                                  	
 37593                                  	;mov	[es:bp+1Fh],ax		; no,valid free count
 37594 000064F1 2689461F                	mov	[es:bp+DPB.FREE_CNT],ax ; save free count into [es:bp+DPB.FREE_CNT]
 37595                                  	;mov	[es:bp+21h],dx
 37596 000064F5 26895621                	mov	[es:bp+DPB.FREE_CNT+2],dx
 37597                                  
 37598                                  gotgetbuf8:
 37599                                  	;mov	ax,[di+492]		; FSI_Nxt_Free
 37600 000064F9 8B85EC01                	mov	ax,[di+FSINFO.Nxt_Free]
 37601                                  	;mov	dx,[di+494]
 37602 000064FD 8B95EE01                	mov	dx,[di+FSINFO.Nxt_Free+2]
 37603                                  
 37604 00006501 39DA                    	cmp	dx,bx			; is the next free clust num >= (num of clusters + 1) ?
 37605 00006503 7502                    	jne	short gotgetbuf9	; invalid (if dx > bx)
 37606 00006505 39C8                    	cmp	ax,cx
 37607                                  gotgetbuf9:
 37608 00006507 730C                    	jnb	short gotgetbuf10 ; invalid
 37609                                  
 37610                                  	;mov	[es:bp+39h],ax		; save next free (search) cluster number
 37611 00006509 26894639                	mov	[es:bp+DPB.FAT32_NXTFREE],ax ; into [es:bp+DPB.FAT32_NXTFREE]
 37612                                  	;mov	[es:bp+3Bh],dx
 37613 0000650D 2689563B                	mov	[es:bp+DPB.FAT32_NXTFREE+2],dx
 37614                                  	;mov	[es:bp+1Dh],ax		; and into [es:bp+DPB.NEXT_FREE] ; low word
 37615 00006511 2689461D                	mov	[es:bp+DPB.NEXT_FREE],ax
 37616                                  
 37617                                  gotgetbuf10:
 37618 00006515 59                      	pop	cx
 37619 00006516 5B                      	pop	bx
 37620 00006517 5A                      	pop	dx
 37621                                  
 37622                                  gotgetbuf11:
 37623 00006518 36803E[7900]00          	cmp	byte [ss:BuffInHMA],0	; is buffer in HMA ?
 37624                                  	;jnz	short gotgetbuf12	; yes
 37625 0000651E 753A                    	jnz	short gotgetbuf16 ; 04/03/2024
 37626                                  
 37627                                  	;mov	word [di-20],0FFh	; invalidate buffer (set it as free buffer)
 37628                                  	; 04/03/2024 - Retro DOS v5.0
 37629 00006520 EB0F                    	jmp	short gotgetbuf17
 37630                                  
 37631                                  gotgetbuf12:
 37632 00006522 36803E[7900]00          	cmp	byte [ss:BuffInHMA],0
 37633 00006528 7530                    	jnz	short gotgetbuf16
 37634                                  
 37635                                  	;cmp	word [es:bp+6],1
 37636 0000652A 26837E0601              	cmp	word [es:bp+DPB.FIRST_FAT],1 ; 1st FAT start sector
 37637 0000652F 7405                    	jz	short gotgetbuf13
 37638                                  
 37639                                  gotgetbuf17:	; 04/03/2024
 37640                                  	;mov	word [di-20],0FFh	; invalidate buffer (set it as free buffer)
 37641                                  			  		; di = buffer header + 4 (BUFINFO.buf_ID)
 37642 00006531 C745ECFF00              	mov	word [di+BUFFINFO.buf_ID-BUFINSIZ],0FFh
 37643                                  
 37644                                  gotgetbuf13:
 37645                                  	;mov	al,[es:bp+8]
 37646 00006536 268A4608                	mov	al,[es:bp+DPB.FAT_COUNT]
 37647                                  	;mov	[di-14],al		; buffer header address + 10
 37648 0000653A 8845F2                  	mov	[di+BUFFINFO.buf_wrtcnt-BUFINSIZ],al
 37649                                  
 37650                                  	;mov	ax,[es:bp+0Fh]
 37651 0000653D 268B460F                	mov	ax,[es:bp+DPB.FAT_SIZE]	; 16 bit FAT size field
 37652 00006541 09C0                    	or	ax,ax
 37653 00006543 750D                    	jnz	short gotgetbuf14 ; FAT (FAT12 or FAT16) fs
 37654                                  	
 37655                                  	; FAT32 fs
 37656                                  	;mov	ax,[es:bp+31h]		; FAT sectors (per one FAT)
 37657 00006545 268B4631                	mov	ax,[es:bp+DPB.FAT32_SIZE] 
 37658                                  	;mov	[di-13],ax 	; BUFFINFO.buf_wrtcntinc ; # sectors between each write
 37659 00006549 8945F3                  	mov	[di+BUFFINFO.buf_wrtcntinc-BUFINSIZ],ax
 37660                                  	;mov	ax,[es:bp+33h]
 37661 0000654C 268B4633                	mov	ax,[es:bp+DPB.FAT32_SIZE+2]
 37662 00006550 EB05                    	jmp	short gotgetbuf15
 37663                                  
 37664                                  gotgetbuf14:
 37665                                  	;mov	[di-13],ax		; BUFFINFO.buf_wrtcntinc
 37666 00006552 8945F3                  	mov	[di+BUFFINFO.buf_wrtcntinc-BUFINSIZ],ax
 37667                                  
 37668                                  	;xor	ax,ax			; 0
 37669 00006555 29C0                    	sub	ax,ax ; 0
 37670                                  
 37671                                  gotgetbuf15:
 37672                                  	;;mov	[di-15],ax		; BUFFINFO.buf_wrtcntinc+2 ; hw of sectors per FAT
 37673                                  					; PCDOS 7.1 BUG !? This would be 'mov [di-11],ax'
 37674                                  					; Erdogan Tan - 03/03/2024
 37675                                  	;mov	[di-11],ax
 37676 00006557 8945F5                  	mov	[di+BUFFINFO.buf_wrtcntinc+2-BUFINSIZ],ax
 37677                                  
 37678                                  gotgetbuf16:
 37679                                  	;mov	ax,ss			; SS is DOSDATA
 37680                                  	;mov	ds,ax
 37681 0000655A 16                      	push	ss
 37682 0000655B 1F                      	pop	ds
 37683                                  	;xor	al,al			; Media changed (Z),Carry clear
 37684 0000655C 31C0                    	xor	ax,ax
 37685 0000655E C3                      	retn
 37686                                  
 37687                                  	;;;
 37688                                  %endif
 37689                                  
 37690                                  ;============================================================================
 37691                                  ; STDBUF.ASM
 37692                                  ;============================================================================
 37693                                  ; Retro DOS v2.0 - 12/03/2018
 37694                                  
 37695                                  ;
 37696                                  ; Standard buffer management for MSDOS
 37697                                  ;
 37698                                  
 37699                                  ;.xlist
 37700                                  ;.xcref
 37701                                  ;INCLUDE STDSW.ASM
 37702                                  ;.cref
 37703                                  ;.list
 37704                                  
 37705                                  ;TITLE	STDBUF - MSDOS buffer management
 37706                                  ;NAME	STDBUF
 37707                                  
 37708                                  ;INCLUDE BUF.ASM
 37709                                  
 37710                                  ;============================================================================
 37711                                  ; BUF.ASM
 37712                                  ;============================================================================
 37713                                  ; 31/07/2018 - Retro DOS v3.0
 37714                                  ; Retro DOS v2.0 - 12/03/2018
 37715                                  ;
 37716                                  ; buffer management for MSDOS
 37717                                  ;
 37718                                  ;CODE	SEGMENT BYTE PUBLIC  'CODE'
 37719                                  ;       ASSUME  SS:DOSGROUP,CS:DOSGROUP
 37720                                  ;
 37721                                  ;SUBTTL SETVISIT,SKIPVISIT -- MANAGE BUFFER SCANS
 37722                                  ;
 37723                                  ;SETVISIT:
 37724                                  ;	; 31/07/2018 - Retro DOS v3.0
 37725                                  ;	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5CAFh
 37726                                  ;; Inputs:
 37727                                  ;;      None
 37728                                  ;; Function:
 37729                                  ;;      Set up a scan of I/O buffers
 37730                                  ;; Outputs:
 37731                                  ;;      All visit flags = 0
 37732                                  ;;              NOTE: This pre-scan is needed because a hard disk error
 37733                                  ;;                    may cause a scan to stop in the middle leaving some
 37734                                  ;;                    visit flags set, and some not set.
 37735                                  ;;      DS:DI Points to [BUFFHEAD]
 37736                                  ;; No other registers altered
 37737                                  ;
 37738                                  ;       LDS     DI,[SS:BUFFHEAD] ; 15/03/2018
 37739                                  ;	PUSH    AX
 37740                                  ;       ;;XOR	AX,AX	  ;; MSDOS 2.11
 37741                                  ;	;mov	al,0DFh
 37742                                  ;	mov	al,~buf_visit
 37743                                  ;SETLOOP:
 37744                                  ;       ;;MOV	[DI+7],AL ;; MSDOS 2.11
 37745                                  ;	;and	[DI+5],al
 37746                                  ;	AND	[DI+BUFFINFO.buf_flags],AL
 37747                                  ;       LDS     DI,[DI]
 37748                                  ;       CMP     DI,-1
 37749                                  ;       JNZ     SHORT SETLOOP
 37750                                  ;       POP     AX ; 09/09/2018
 37751                                  ;	LDS     DI,[SS:BUFFHEAD] ; 15/03/2018
 37752                                  ;SVISIT_RETN:
 37753                                  ;       RETN
 37754                                  ;
 37755                                  ;SKIPVISIT:
 37756                                  ;	; 31/07/2018 - Retro DOS v3.0
 37757                                  ;	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5CC8h
 37758                                  ;
 37759                                  ;; Inputs:
 37760                                  ;;      DS:DI Points to a buffer
 37761                                  ;; Function:
 37762                                  ;;      Skip visited buffers
 37763                                  ;; Outputs:
 37764                                  ;;      DS:DI Points to next unvisited buffer
 37765                                  ;;      Zero is set if skip to LAST buffer
 37766                                  ;; No other registers altered
 37767                                  ;
 37768                                  ;       CMP     DI,-1
 37769                                  ;       ;retz
 37770                                  ;       JZ	SHORT SVISIT_RETN
 37771                                  ;
 37772                                  ;	;;CMP	BYTE [DI+7],1 ;; MSDOS 2.11
 37773                                  ;       ;;;retnz
 37774                                  ;       ;;JNZ	SHORT SVISIT_RETN
 37775                                  ;
 37776                                  ;	;test	byte [di+5],20h
 37777                                  ;	TEST	byte [DI+BUFFINFO.buf_flags],buf_visit	
 37778                                  ;	JNZ	short SKIPLOOP
 37779                                  ;	
 37780                                  ;	push	ax
 37781                                  ;	or	al,1
 37782                                  ;	pop	ax
 37783                                  ;	retn	
 37784                                  ;
 37785                                  ;SKIPLOOP:
 37786                                  ;	LDS     DI,[DI]
 37787                                  ;       JMP     SHORT SKIPVISIT
 37788                                  
 37789                                  ;============================================================================
 37790                                  ; BUF.ASM, MSDOS 6.0, 1991
 37791                                  ;============================================================================
 37792                                  ; 31/07/2018 - Retro DOS v3.0
 37793                                  ; 04/05/2019 - Retro DOS v4.0
 37794                                  ; 06/03/2024 - Retro DOS v5.0
 37795                                  
 37796                                  ;	TITLE	BUF - MSDOS buffer management
 37797                                  ;	NAME	BUF
 37798                                  
 37799                                  ;**	BUF.ASM - Low level routines for buffer cache management
 37800                                  ;
 37801                                  ;	GETCURHEAD
 37802                                  ;	ScanPlace
 37803                                  ;	PLACEBUF
 37804                                  ;	PLACEHEAD
 37805                                  ;	PointComp
 37806                                  ;	GETBUFFR
 37807                                  ;	GETBUFFRB
 37808                                  ;	FlushBuf
 37809                                  ;	BufWrite
 37810                                  ;	SET_RQ_SC_PARMS
 37811                                  ;
 37812                                  ;	Revision history:
 37813                                  ;
 37814                                  ;		AN000  version 4.00  Jan. 1988
 37815                                  ;		A004   PTM 3765 -- Disk reset failed
 37816                                  ;		M039 DB 10/17/90 - Disk write optimization
 37817                                  ;		I001   5.0 PTR 722211 - Preserve CY when in buffer in HMA
 37818                                  
 37819                                  ;Break	<GETCURHEAD -- Get current buffer header>
 37820                                  ;----------------------------------------------------------------------------
 37821                                  ; Procedure Name : GetCurHead
 37822                                  ; Inputs:
 37823                                  ;	 No Inputs
 37824                                  ; Function:
 37825                                  ;	Returns the pointer to the first buffer in Queue
 37826                                  ;	and updates FIRST_BUFF_ADDR
 37827                                  ;       and invalidates LASTBUFFER (recency pointer)
 37828                                  ; Outputs:
 37829                                  ;	DS:DI = pointer to the first buffer in Queue
 37830                                  ;	FIRST_BUFF_ADDR = offset ( DI ) of First buffer in Queue
 37831                                  ;       LASTBUFFER = -1
 37832                                  ; No other registers altered
 37833                                  ;----------------------------------------------------------------------------
 37834                                  
 37835                                  ; 04/05/2019 - Retro DOS v4.0
 37836                                  ; DOSCODE:98D2h (MSDOS 6.21, MSDOS.SYS)
 37837                                  ; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 37838                                  ; DOSCODE:9876h (MSDOS 5.0, MSDOS.SYS)
 37839                                  
 37840                                  ; 06/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 37841                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0AA4Bh
 37842                                  
 37843                                  GETCURHEAD:
 37844 0000655F 36C53E[6D00]            	lds	di,[ss:BufferQueue]	; Pointer to the first buffer
 37845 00006564 36C706[1E00]FFFF        	mov	word [ss:LastBuffer],-1	; invalidate last buffer
 37846 0000656B 36893E[1B11]            	mov	[ss:FIRST_BUFF_ADDR],di	; save first buffer address
 37847 00006570 C3                      	retn
 37848                                  
 37849                                  ;Break	<SCANPLACE, PLACEBUF -- PUT A BUFFER BACK IN THE POOL>
 37850                                  ;----------------------------------------------------------------------------
 37851                                  ; Procedure Name : ScanPlace
 37852                                  ; Inputs:
 37853                                  ;	Same as PLACEBUF
 37854                                  ; Function:
 37855                                  ;	Save scan location and call PLACEBUF
 37856                                  ; Outputs:
 37857                                  ;	DS:DI Points to saved scan location
 37858                                  ; All registers, except DS:DI, preserved.
 37859                                  ;----------------------------------------------------------------------------
 37860                                  ;M039: Rewritten to preserve registers.
 37861                                  
 37862                                  ;SCANPLACE:
 37863                                  ;	; 31/07/2018 - Retro DOS v3.0
 37864                                  ;	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5DDCh
 37865                                  ;	push	es
 37866                                  ;	les	si,[di]
 37867                                  ;	;les	si,[DI+BUFFINFO.buf_link]
 37868                                  ;	call	PLACEBUF
 37869                                  ;	push	es
 37870                                  ;	pop	ds
 37871                                  ;	mov	di,si
 37872                                  ;	pop	es
 37873                                  ;scanplace_retn:
 37874                                  ;	retn	
 37875                                  	
 37876                                  	; MSDOS 6.0
 37877                                  SCANPLACE:
 37878 00006571 FF35                    	push	word [di]
 37879                                  	;push	word [di+BUFFINFO.buf_next] ;Save scan location
 37880 00006573 E80200                  	call	PLACEBUF
 37881 00006576 5F                      	pop	di
 37882 00006577 C3                      	retn
 37883                                  
 37884                                  ;----------------------------------------------------------------------------
 37885                                  ; Procedure Name : PlaceBuf
 37886                                  ; Input:
 37887                                  ;	DS:DI points to buffer (DS->BUFFINFO array, DI=offset in array)
 37888                                  ; Function:
 37889                                  ;	Remove buffer from queue and re-insert it in proper place.
 37890                                  ; NO registers altered
 37891                                  ;----------------------------------------------------------------------------
 37892                                  
 37893                                  ;procedure PLACEBUF,NEAR
 37894                                  
 37895                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 37896                                  	; 20/05/2019 - Retro DOS v4.0
 37897                                  PLACEBUF:
 37898                                  	; 31/07/2018 - Retro DOS v3.0
 37899                                  
 37900                                  	; MSDOS 6.0
 37901 00006578 50                      	push	AX			;Save only regs we modify	;AN000;
 37902 00006579 53                      	push	BX							;AN000;
 37903                                  	; 23/09/2023
 37904                                  	;push	SI							;AN000;
 37905                                  	
 37906 0000657A 8B05                    	mov	ax,[di]
 37907                                  	;mov	ax,[di+BUFFINFO.buf_next]
 37908 0000657C 368B1E[6D00]            	mov	bx,[ss:BufferQueue]	; bx = offset of head of list;smr;SS Override
 37909                                  	
 37910 00006581 39D8                    	cmp	ax,bx				;Buf = last?		;AN000;
 37911 00006583 7422                    	je	short nret			;Yes, special case	;AN000;
 37912 00006585 39DF                    	cmp	di,bx				;Buf = first?		;AN000;
 37913 00006587 7506                    	jne	short not_first 		;Yes, special case	;AN000;
 37914 00006589 36A3[6D00]              	mov	[ss:BufferQueue],ax		;smr;SS Override
 37915 0000658D EB18                    	jmp	short nret 			;Continue with repositioning;AN000;
 37916                                  not_first:
 37917                                  	; 23/09/2023
 37918 0000658F 56                      	push	si
 37919                                  	;mov	si,[di+2]
 37920 00006590 8B7502                  	mov	SI,[DI+BUFFINFO.buf_prev]	;No, SI = prior Buf	;AN000;
 37921 00006593 8904                    	mov	[si],ax
 37922                                  	;mov	[SI+BUFFINFO.buf_next],AX	; ax has di->buf_next	;AN000;
 37923 00006595 96                      	xchg	si,ax
 37924                                  	;mov	[si+2],ax
 37925 00006596 894402                  	mov	[SI+BUFFINFO.buf_prev],AX	;			;AN000;
 37926                                  	
 37927 00006599 8B7702                  	mov	SI,[BX+BUFFINFO.buf_prev]	;SI-> last buffer	;AN000;
 37928 0000659C 893C                    	mov	[si],di
 37929                                  	;mov	[SI+BUFFINFO.buf_next],DI	;Add Buf to end of list ;AN000;
 37930 0000659E 897F02                  	mov	[BX+BUFFINFO.buf_prev],DI				;AN000;
 37931 000065A1 897502                  	mov	[DI+BUFFINFO.buf_prev],SI	;Update link in Buf too	;AN000;
 37932 000065A4 891D                    	mov	[di],bx
 37933                                  	;mov	[DI+BUFFINFO.buf_next],BX				;AN000;
 37934                                  	; 23/09/2023
 37935 000065A6 5E                      	pop	si
 37936                                  nret:	
 37937                                  	; 23/09/2023							;AN000;
 37938                                  	;pop	SI							;AN000;
 37939 000065A7 5B                      	pop	BX							;AN000;
 37940 000065A8 58                      	pop	AX							;AN000;
 37941                                  									;AN000;
 37942                                  	;cmp	byte [di+4],0FFh
 37943 000065A9 807D04FF                	cmp	byte [di+BUFFINFO.buf_ID],-1	; Buffer FREE?		;AN000;
 37944 000065AD 7505                            jne	short pbx			; M039: -no, jump.
 37945 000065AF 36893E[6D00]            	mov	[ss:BufferQueue],di		; M039: -yes, make it LRU.
 37946                                  pbx:	
 37947 000065B4 C3                      	retn								;AN000;
 37948                                  
 37949                                  	; 31/07/2018 - Retro DOS v3.0
 37950                                  
 37951                                  	; MSDOS 3.3
 37952                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5DDCh
 37953                                  
 37954                                  ;PLACEBUF:
 37955                                  ;	; 15/03/2018 - Retro DOS v2.0 (MSDOS 2.11)
 37956                                  ;	
 37957                                  ;       CALL	save_world
 37958                                  ;       LES     CX,[DI]
 37959                                  ;       CMP     CX,-1           	; Buf is LAST?
 37960                                  ;       JZ      SHORT NRET		; Buffer already last
 37961                                  ;       MOV     BP,ES           	; Pointsave = Buf.nextbuf
 37962                                  ;       PUSH    DS
 37963                                  ;       POP     ES              	; Buf is ES:DI
 37964                                  ;	; 15/03/2018
 37965                                  ;       LDS     SI,[SS:BUFFHEAD] 	; Curbuf = HEAD
 37966                                  ;       CALL    POINTCOMP       	; Buf == HEAD?
 37967                                  ;       JNZ     SHORT BUFLOOP
 37968                                  ;       MOV     [SS:BUFFHEAD],CX
 37969                                  ;       MOV     [SS:BUFFHEAD+2],BP	; HEAD = Pointsave
 37970                                  ;       JMP     SHORT LOOKEND
 37971                                  ;BUFLOOP:
 37972                                  ;	; 31/07/2018
 37973                                  ;	mov	ax,ds
 37974                                  ;	mov	bx,si
 37975                                  ;	;lds	si,[SI+BUFFINFO.buf_link]
 37976                                  ;       LDS     SI,[SI]
 37977                                  ;       CALL    POINTCOMP
 37978                                  ;       jnz	short BUFLOOP
 37979                                  ;	;
 37980                                  ;	mov	ds,ax
 37981                                  ;	mov	si,bx
 37982                                  ;	mov	[SI],cx
 37983                                  ;	;mov	[SI+BUFFINFO.buf_link],cx   ; If Curbuf.nextbuf == buf
 37984                                  ;	mov	[SI+2],bp
 37985                                  ;	;mov	[BX+BUFFINFO.buf_link+2],bp ; Curbuf.nextbuf = Pointsave
 37986                                  ;LOOKEND:
 37987                                  ;	mov	ax,ds
 37988                                  ;	mov	bx,si
 37989                                  ;       LDS     SI,[SI]
 37990                                  ;       CMP     SI,-1
 37991                                  ;       jnz     short LOOKEND
 37992                                  ;GOTHEEND:
 37993                                  ;       mov	ds,ax
 37994                                  ;	mov	[BX],di
 37995                                  ;	MOV     [BX+2],ES 		; Curbuf.nextbuf = Buf
 37996                                  ;       MOV     WORD [ES:DI],-1
 37997                                  ;	;mov	word [ES:DI+BUFFINFO.buf_link],-1
 37998                                  ;       MOV     WORD [ES:DI+2],-1 	; Buf is LAST
 37999                                  ;	;mov	word [ES:DI+BUFFINFO.buf_link+2],-1
 38000                                  ;NRET:
 38001                                  ;       CALL	restore_world
 38002                                  ;	
 38003                                  ;	;cmp	byte [di+4],-1
 38004                                  ;	cmp	byte [DI+BUFFINFO.buf_ID],-1  ; Free buffer ?
 38005                                  ;	jnz     short scanplace_retn
 38006                                  ;	call    PLACEHEAD
 38007                                  ;	retn
 38008                                  
 38009                                  ;EndProc PLACEBUF
 38010                                  
 38011                                  ;M039 - Removed PLACEHEAD.
 38012                                  ;----------------------------------------------------------------------------
 38013                                  ; places buffer at head
 38014                                  ;  NOTE:::::: ASSUMES THAT BUFFER IS CURRENTLY THE LAST
 38015                                  ;	ONE IN THE LIST!!!!!!!
 38016                                  ; BUGBUG ---- this routine can be removed because it has only
 38017                                  ; BUGBUG ---- one instruction. This routine is called from
 38018                                  ; BUGBUG ---- 3 places. ( Size = 3*3+6 = 15 bytes )
 38019                                  ; BUGBUG ---- if coded in line = 3 * 5 = 15 bytes
 38020                                  ; BUGBUG ---- But kept as it is for modularity
 38021                                  ;----------------------------------------------------------------------------
 38022                                  ;procedure   PLACEHEAD,NEAR
 38023                                  ;	mov	word ptr [BufferQueue], di
 38024                                  ;	ret
 38025                                  ;EndProc PLACEHEAD
 38026                                  ;M039
 38027                                  
 38028                                  ;----------------------------------------------------------------------------
 38029                                  ; Procedure Name : PLACEHEAD
 38030                                  ;
 38031                                  ; SAME AS PLACEBUF except places buffer at head
 38032                                  ;----------------------------------------------------------------------------
 38033                                  
 38034                                  	; MSDOS 3.3 (Retro DOS v3.0)
 38035                                  	; 05/09/2018
 38036                                  	; MSDOS 2.11 (Retro DOS v2.0)
 38037                                  ;PLACEHEAD:
 38038                                  ;	; 31/07/2018 - Retro DOS v3.0
 38039                                  ;	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5D4Ah
 38040                                  ;
 38041                                  ;       CALL	save_world
 38042                                  ;       PUSH	DS
 38043                                  ;       POP	ES
 38044                                  ;	; 15/03/2018 - Retro DOS v2.0 (MSDOS 2.11)
 38045                                  ;       LDS     SI,[SS:BUFFHEAD]
 38046                                  ;	; 31/07/2018 - Retro DOS v3.0 (MSDOS 3.3)
 38047                                  ;	CALL    POINTCOMP
 38048                                  ;       JZ      SHORT GOTHEEND2
 38049                                  ;	MOV	[ES:DI],SI
 38050                                  ;	;mov	[ES:DI+BUFFINFO.buf_link],si
 38051                                  ;       MOV	[ES:DI+2],DS
 38052                                  ;	;mov	[ES:DI+BUFFINFO.buf_link+2],ds
 38053                                  ;       MOV	[SS:BUFFHEAD],DI
 38054                                  ;       MOV	[SS:BUFFHEAD+2],ES
 38055                                  ;LOOKEND2:
 38056                                  ;       mov	ax,ds
 38057                                  ;	mov	bx,si
 38058                                  ;	;lds	si,[SI+BUFFINFO.buf_link]
 38059                                  ;       LDS     SI,[SI]
 38060                                  ;       CALL    POINTCOMP
 38061                                  ;       JNZ	SHORT LOOKEND2 ; 05/09/2018
 38062                                  ;       mov	ds,ax
 38063                                  ;	mov	word [bx],-1
 38064                                  ;	;mov	word [BX+BUFFINFO.buf_link],-1
 38065                                  ;	mov	word [bx+2],-1
 38066                                  ;	;mov	word [BX+BUFFINFO.buf_link+2],-1
 38067                                  ;GOTHEEND2:
 38068                                  ;      	call	restore_world
 38069                                  ;placehead_retn:
 38070                                  ;	retn
 38071                                  
 38072                                  ; 20/05/2019 - Retro DOS v4.0
 38073                                  ; DOSCODE:9928h (MSDOS 6.21, MSDOS.SYS)
 38074                                  
 38075                                  ;Break	<POINTCOMP -- 20 BIT POINTER COMPARE>
 38076                                  ;----------------------------------------------------------------------------
 38077                                  ;
 38078                                  ; Procedure Name : PointComp
 38079                                  ; Inputs:
 38080                                  ;         DS:SI & ES:DI
 38081                                  ; Function:
 38082                                  ;          Checks for ((SI==DI) && (ES==DS))
 38083                                  ;	   Assumes that pointers are normalized for the
 38084                                  ;	   same segment
 38085                                  ;
 38086                                  ; Compare DS:SI to ES:DI (or DS:DI to ES:SI) for equality
 38087                                  ; DO NOT USE FOR < or >
 38088                                  ; No Registers altered
 38089                                  ;
 38090                                  ;----------------------------------------------------------------------------
 38091                                  
 38092                                  POINTCOMP:
 38093                                  	; 31/07/2018 - Retro DOS v3.0
 38094                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5D84h
 38095 000065B5 39FE                    	CMP	SI,DI
 38096 000065B7 750A                    	jnz	short _ret_label	; return if nz
 38097                                  	;jnz	short placehead_retn 
 38098 000065B9 51                      	PUSH	CX
 38099 000065BA 52                      	PUSH	DX
 38100 000065BB 8CD9                    	MOV	CX,DS
 38101 000065BD 8CC2                    	MOV	DX,ES
 38102 000065BF 39D1                    	CMP	CX,DX
 38103 000065C1 5A                      	POP	DX
 38104 000065C2 59                      	POP	CX
 38105                                  _ret_label:
 38106 000065C3 C3                      	retn
 38107                                  
 38108                                  ; 01/08/2018 - Retro DOS v3.0
 38109                                  ; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5D93h 
 38110                                  
 38111                                  ;Break	<GETBUFFR, GETBUFFRB -- GET A SECTOR INTO A BUFFER>
 38112                                  
 38113                                  ;**	GetBuffr - Get a non-FAT Sector into a Buffer
 38114                                  ;----------------------------------------------------------------------------
 38115                                  ;	GetBuffr does normal ( non-FAT ) sector buffering
 38116                                  ;	It gets the specified local sector into one of the I/O buffers
 38117                                  ;	and shuffles the queue
 38118                                  ; 
 38119                                  ;	ENTRY	(AL) = 0 means sector must be pre-read
 38120                                  ;		       ELSE no pre-read
 38121                                  ;		(DX) = Desired physical sector number	      (LOW)
 38122                                  ;		HIGH_SECTOR = Desired physical sector number (HIGH)
 38123                                  ;		(ES:BP) = Pointer to drive parameters
 38124                                  ;		ALLOWED set in case of INT 24
 38125                                  ;	EXIT	'C' set if error (user FAIL response to INT24)
 38126                                  ;		'C' clear if OK
 38127                                  ;		CURBUF Points to the Buffer for the sector
 38128                                  ;		    the buffer type bits OF buf_flags = 0, caller must set it
 38129                                  ;	USES	AX, BX, CX, SI, DI, Flags
 38130                                  ;----------------------------------------------------------------------------
 38131                                  
 38132                                  ;**	GetBuffrb - Get a FAT Sector into a Buffer
 38133                                  ;----------------------------------------------------------------------------
 38134                                  ;	GetBuffrb reads a sector from the FAT file system's FAT table.
 38135                                  ;	It gets the specified sector into one of the I/O buffers
 38136                                  ;	and shuffles the queue. We need a special entry point so that
 38137                                  ;	we can read the alternate FAT sector if the first read fails, also
 38138                                  ;	so we can mark the buffer as a FAT sector.
 38139                                  ; 
 38140                                  ;	ENTRY	(AL) = 0 means sector must be pre-read
 38141                                  ;		       ELSE no pre-read
 38142                                  ;		(DX) = Desired physical sector number	     (LOW)
 38143                                  ;		(SI) != 0
 38144                                  ;		HIGH_SECTOR = Desired physical sector number (HIGH)
 38145                                  ;		(ES:BP) = Pointer to drive parameters
 38146                                  ;		ALLOWED set in case of INT 24
 38147                                  ;	EXIT	'C' set if error (user FAIL response to INT24)
 38148                                  ;		'C' clear if OK
 38149                                  ;		CUR ddBUF Points to the Buffer for the sector
 38150                                  ;		    the buffer type bits OF buf_flags = 0, caller must set it
 38151                                  ;	USES	AX, BX, CX, SI, DI, Flags
 38152                                  ;----------------------------------------------------------------------------
 38153                                  
 38154                                  	; 22/09/2023 - RetroDOS v4.2 MSDOS.SYS (optimization)
 38155                                  GETBUFFRC:
 38156                                  	;mov	word [HIGH_SECTOR],0
 38157                                  	; 02/03/2024 - Retro DOS v5.0
 38158 000065C4 891E[0706]              	mov	[HIGH_SECTOR],bx
 38159                                  GETBUFFRA:
 38160 000065C8 30C0                    	xor	al,al
 38161 000065CA BE0100                  	mov	si,1
 38162 000065CD EB09                    	jmp	short GETBUFFRB
 38163                                  
 38164                                  	; 22/09/2023
 38165                                  GETBUFFER:
 38166 000065CF 30C0                    	xor	al,al
 38167                                  GETBUFFRD:
 38168                                  	;mov	byte [ALLOWED],18h
 38169 000065D1 C606[4B03]18            	mov	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY
 38170                                  
 38171                                  	; 20/05/2019 - Retro DOS v4.0
 38172                                  	; DOSCODE:9937h (MSDOS 6.21, MSDOS.SYS)
 38173                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 38174                                  	; DOSCODE:98DBh (MSDOS 5.0, MSDOS.SYS)
 38175                                  
 38176                                  	; 07/07/2024
 38177                                  	; 06/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 38178                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0AAB0h
 38179                                  
 38180                                  	; (Windows Me IO.SYS - BIOSCODE:0CA3Dh)
 38181                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:9937h)
 38182                                  
 38183                                  GETBUFFR:
 38184 000065D6 31F6                    	XOR	SI,SI
 38185                                  
 38186                                  ;	This entry point is called for FAT buffering with SI != 0
 38187                                  
 38188                                  GETBUFFRB:
 38189 000065D8 A3[9405]                	MOV	[PREREAD],AX			; save pre-read flag
 38190                                  
 38191                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38192                                  	;;;
 38193 000065DB 09F6                    	or	si,si
 38194 000065DD 7429                    	jz      short getb1
 38195                                  
 38196                                  	;cmp	word [es:bp+0Fh],0
 38197 000065DF 26837E0F00              	cmp	word [es:bp+DPB.FAT_SIZE],0
 38198 000065E4 7522                    	jnz	short getb1	; not FAT32
 38199                                  
 38200                                  	;mov	ax,[es:bp+23h]
 38201 000065E6 268B4623                	mov	ax,[es:bp+DPB.EXT_FLAGS]
 38202 000065EA A880                    	test	al,80h		; bit 7 -- 1 means only one FAT is active
 38203 000065EC 741A                    	jz	short getb1
 38204 000065EE 83E00F                  	and	ax,0Fh		; Active FAT is the one referenced in bits 0-3
 38205 000065F1 7415                    	jz	short getb1
 38206                                  
 38207 000065F3 52                      	push	dx
 38208 000065F4 89C1                    	mov	cx,ax			; Zero based number of active FAT.
 38209                                  					; (Only valid if mirroring is disabled.)	
 38210                                  	;mul	word [es:bp+33h]
 38211 000065F6 26F76633                	mul	word [es:bp+DPB.FAT32_SIZE+2]
 38212 000065FA 91                      	xchg	ax,cx
 38213                                  	;mul	word [es:bp+31h]
 38214 000065FB 26F76631                	mul	word [es:bp+DPB.FAT32_SIZE]
 38215 000065FF 01D1                    	add	cx,dx
 38216 00006601 5A                      	pop	dx
 38217 00006602 01C2                    	add	dx,ax
 38218 00006604 110E[0706]              	adc	[HIGH_SECTOR],cx
 38219                                  getb1:
 38220                                  	;;;
 38221                                  
 38222                                  	; 15/12/2022
 38223 00006608 268A4600                	mov	al,[ES:BP]
 38224                                  	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 38225                                  	;MOV	AL,[ES:BP+DPB.DRIVE] ; mov al,[es:bp+0]
 38226 0000660C C53E[1E00]              	LDS	DI,[LastBuffer]			; Get the recency pointer
 38227                                  
 38228                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38229                                  	;;;
 38230 00006610 BBFFFF                  	mov	bx,-1 ; 0FFFFh
 38231                                  	;;;
 38232                                  
 38233                                  	; MSDOS 6.0
 38234                                  ;hkn; SS override
 38235 00006613 368B0E[0706]            	MOV	CX,[SS:HIGH_SECTOR]		; F.C. >32mb	;AN000;
 38236                                  
 38237                                  ;	See if this is the buffer that was most recently returned.
 38238                                  ;	A big performance win if it is.
 38239                                  
 38240                                  	;CMP	DI,-1				; Recency pointer valid?
 38241                                  	; 06/03/2024 - Retro DOS v5.0	
 38242 00006618 39DF                    	cmp	di,bx ; -1
 38243 0000661A 7412                    	je	short getb5			; No
 38244                                  
 38245                                  	;cmp	dx,[di+6]
 38246 0000661C 3B5506                  	CMP	DX,[DI+BUFFINFO.buf_sector]
 38247 0000661F 750D                    	JNZ	short getb5			; Wrong sector
 38248                                  	
 38249                                  	; MSDOS 6.0
 38250                                  	;cmp	cx,[di+8]
 38251 00006621 3B4D08                  	CMP	CX,[DI+BUFFINFO.buf_sector+2]	; F.C. >32mb	;AN000;
 38252 00006624 7508                    	JNZ	short getb5			; F.C. >32mb	;AN000;
 38253                                  	
 38254                                  	;cmp	al,[di+4]
 38255 00006626 3A4504                  	CMP	AL,[DI+BUFFINFO.buf_ID]
 38256                                  	;JZ	getb35				; Just asked for same buffer
 38257 00006629 7503                    	jnz	short getb5
 38258                                  	;jmp	getb35
 38259                                  	; 17/12/2022
 38260                                  	; 28/07/2019
 38261 0000662B E90301                  	jmp	getb35x
 38262                                  	; 07/12/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 38263                                  	;jmp	getb35
 38264                                  
 38265                                  ;	It's not the buffer most recently returned. See if it's in the
 38266                                  ;	cache.
 38267                                  ;
 38268                                  ;	(cx:dx) = sector #
 38269                                  ;	(al) = drive #
 38270                                  ;	(si) = 0 iff non fat sector, != 0 if FAT sector read
 38271                                  ;	??? list may be incomplete ???
 38272                                  
 38273                                  getb5:	
 38274                                  	; MSDOS 3.3
 38275                                  	;lds	di,[SS:BUFFHEAD]
 38276                                  	; MSDOS 6.0
 38277 0000662E E82EFF                  	CALL	GETCURHEAD			; get Q Head
 38278                                  getb10:	
 38279                                  	;cmp	dx,[di+6]
 38280 00006631 3B5506                  	CMP	DX,[DI+BUFFINFO.buf_sector]
 38281                                  	;jne	short getb12			; wrong sector lo
 38282                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38283                                  	;;;
 38284 00006634 750D                    	jne	short getb11
 38285                                  	;;;
 38286                                  
 38287                                  	; MSDOS 6.0
 38288                                  	;cmp	cx,[di+8]
 38289 00006636 3B4D08                  	CMP	CX,[DI+BUFFINFO.buf_sector+2]
 38290                                  	;jne	short getb12			; wrong sector hi
 38291                                  	; 06/03/2024
 38292                                  	;;;
 38293 00006639 7508                    	jne	short getb11
 38294                                  	;;;
 38295                                  	
 38296                                  	;cmp	al,[di+4]
 38297 0000663B 3A4504                  	CMP	AL,[DI+BUFFINFO.buf_ID]
 38298                                  	;;je	short getb25 ; 05/09/2018	; Found the requested sector
 38299                                  	;jne	short getb12
 38300                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38301                                  	;;;
 38302 0000663E 7503                    	jne	short getb11
 38303                                  	;;;
 38304 00006640 E9A400                  	jmp	getb25
 38305                                  
 38306                                  getb11:
 38307                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38308                                  	;;;
 38309                                  	;cmp	byte [di+4],0FFh
 38310 00006643 807D04FF                	cmp	byte [di+BUFFINFO.buf_ID],0FFh	; Free buffer ?
 38311 00006647 7502                    	jne	short getb12			; no
 38312 00006649 89FB                    	mov	bx,di				; save buffer (offset) addr
 38313                                  	;;;
 38314                                  
 38315                                  getb12:	
 38316                                  	; MSDOS 3.3
 38317                                  	;;mov	di,[DI]
 38318                                  	;;;mov	di,[DI+BUFFINFO.buf_link]
 38319                                  	;
 38320                                  	; 15/08/2018
 38321                                  	;lds	di,[di]
 38322                                  
 38323                                  	;cmp	di,-1 ; 0FFFFh
 38324                                  	;jne	short getb10
 38325                                  	;lds	di,[SS:BUFFHEAD]
 38326                                  
 38327                                  	; MSDOS 6.0
 38328 0000664B 8B3D                    	mov	di,[di]
 38329                                  	;mov	DI,[DI+BUFFINFO.BUF_NEXT]
 38330 0000664D 363B3E[1B11]            	cmp	DI,[SS:FIRST_BUFF_ADDR]		; back at the front again?
 38331 00006652 75DD                    	jne	short getb10			; no, continue looking
 38332                                  
 38333                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38334                                  	;;;
 38335 00006654 83FBFF                  	cmp	bx,0FFFFh	; -1 ; invalid (not a free buffer address)
 38336 00006657 7404                    	je	short getb12x
 38337 00006659 89DF                    	mov	di,bx		; restore free buffer (header offset) address
 38338 0000665B EB16                    	jmp	short getb13
 38339                                  getb12x:
 38340                                  	;;;
 38341                                  
 38342                                  ;	The requested sector is not available in the buffers. DS:DI now points
 38343                                  ;	to the first buffer in the Queue. Flush the first buffer & read in the
 38344                                  ;	new sector into it.
 38345                                  ;
 38346                                  ;	BUGBUG - what goes on here? Isn't the first guy the most recently
 38347                                  ;	used guy? Shuld be for fast lookup. If he is, we shouldn't take
 38348                                  ;	him, we should take LRU. And the above lookup shouldn't be
 38349                                  ;	down a chain, but should be hashed.
 38350                                  ;
 38351                                  ;	(DS:DI) = first buffer in the queue
 38352                                  ;	(CX:DX) = sector # we want
 38353                                  ;	(si) = 0 iff non fat sector, != 0 if FAT sector read
 38354                                  
 38355                                  	; MSDOS 3.3 & MSDOS 6.0
 38356                                  ;hkn; SS override
 38357 0000665D 51                      	PUSH	CX  ; MSDOS 6.0
 38358 0000665E 56                      	push	si
 38359 0000665F 52                      	push	dx
 38360 00006660 55                      	push	bp
 38361 00006661 06                      	push	es
 38362 00006662 E85D01                  	CALL	BUFWRITE			; Write out the dirty buffer
 38363 00006665 07                      	pop	es
 38364 00006666 5D                      	pop	bp
 38365 00006667 5A                      	pop	dx
 38366 00006668 5E                      	pop	si
 38367 00006669 368F06[0706]            	POP	word [SS:HIGH_SECTOR]  ; MSDOS 6.0
 38368                                  	;jc	short getbx			; if got hard error
 38369 0000666E 7303                    	jnc	short getb13
 38370 00006670 E9C800                  	jmp	getbx
 38371                                  
 38372                                  getb13:
 38373                                  
 38374                                  ; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38375                                  %if 0
 38376                                  	; MSDOS 6.0
 38377                                  	CALL	SET_RQ_SC_PARMS 		; set parms for secondary cache
 38378                                  %endif
 38379                                  
 38380                                  ;	We're ready to read in the buffer, if need be. If the caller
 38381                                  ;	wanted to just *write* the buffer then we'll skip reading it in.
 38382                                  
 38383 00006673 30E4                    	XOR	AH,AH				; initial flags
 38384                                  ;hkn; SS override
 38385                                  	;test	byte [ss:PREREAD],0FFh
 38386                                  	;jnz	short getb20
 38387 00006675 363826[9405]            	CMP	[SS:PREREAD],ah ; 0		; am to Read in the new sector?
 38388 0000667A 7553                    	JNZ	short getb20			; no, we're done
 38389                                  	;;;lea	bx,[di+16] ; MSDOS 3.3
 38390                                  	;;lea	bx,[di+20] ; MSDOS 6.0
 38391                                  	;lea	bx,[di+24] ; PCDOS 7.1	; 06/03/2024
 38392 0000667C 8D5D18                  	LEA	BX,[DI+BUFINSIZ] 		; (ds:bx) = data address
 38393                                  	;MOV	CX,1
 38394                                  	; 22/09/2023
 38395 0000667F 29C9                    	sub	cx,cx ; 0
 38396 00006681 56                      	push	si
 38397 00006682 57                      	push	di
 38398 00006683 52                      	push	dx
 38399                                  	; MSDOS 6.0
 38400 00006684 06                      	push	es ; ***
 38401                                  
 38402                                  ; Note: As far as I can tell, all disk reads into buffers go through
 38403                                  ;	this point. -mrw 10/88
 38404                                  	
 38405                                  	;cmp	byte [ss:BuffInHMA],0	; is buffers in HMA?
 38406                                  	; 22/09/2023
 38407 00006685 36380E[7900]            	cmp	[ss:BuffInHMA],cl ; 0
 38408 0000668A 7407                    	jz	short getb14
 38409 0000668C 1E                      	push	ds ; **
 38410 0000668D 53                      	push	bx ; *
 38411 0000668E 36C51E[7A00]            	lds	bx,[ss:LoMemBuff]	; Then let's read it into scratch buff
 38412                                  getb14:
 38413                                  ;M039: Eliminated redundant HMA code.
 38414                                  
 38415                                  	; 22/09/2023
 38416 00006693 41                      	inc	cx ; cx = 1
 38417                                  
 38418                                  	; MSDOS 3.3 (& MSDOS 6.0)
 38419 00006694 09F6                    	OR	SI,SI			; FAT sector ?
 38420 00006696 7407                    	JZ	short getb15		; no
 38421                                  
 38422 00006698 E8C1D7                  	call	FATSECRD
 38423                                  	;mov	ah,2
 38424 0000669B B402                    	MOV	AH,buf_isFAT		; Set buf_flags
 38425                                  
 38426 0000669D EB05                    	JMP	SHORT getb17		; Buffer is marked free if read barfs
 38427                                  
 38428                                  getb15:
 38429 0000669F E81DD8                  	call	DREAD			; Buffer is marked free if read barfs
 38430 000066A2 B400                    	MOV	AH,0			; Set buf_flags to no type, DO NOT XOR!
 38431                                  getb17:
 38432                                  
 38433                                  ; 06/03/2024 - Retro DOS v5.0
 38434                                  %if 0
 38435                                  	; 17/12/2022
 38436                                  ; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 38437                                  ;;if 0
 38438                                  	; MSDOS 6.0							  ;I001
 38439                                  	pushf								  ;I001
 38440                                  	cmp	byte [SS:BuffInHMA],0	; did we read into scratch buff ? ;I001
 38441                                  	jz	short not_in_hma	; no				  ;I001
 38442                                  	;mov	cx,[es:bp+2]
 38443                                  	mov	cx,[ES:BP+DPB.SECTOR_SIZE]				  ;I001
 38444                                  	shr	cx,1							  ;I001
 38445                                  	popf				; Retrieve possible CY from DREAD ;I001
 38446                                  	mov	si,bx							  ;I001
 38447                                  	pop	di ; *							  ;I001
 38448                                  	pop	es ; **							  ;I001
 38449                                  	cld								  ;I001
 38450                                  	pushf				; Preserve possible CY from DREAD ;I001
 38451                                  	rep	movsw			; move the contents of scratch buf;I001
 38452                                  	push	es							  ;I001
 38453                                  	pop	ds							  ;I001
 38454                                  ;;endif
 38455                                  
 38456                                  ;; 17/12/2022
 38457                                  ;%if 0
 38458                                  ;	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 38459                                  ;	; MSDOS 5.0
 38460                                  ;	pushf
 38461                                  ;	cmp	byte [SS:BuffInHMA],0	; did we read into scratch buff ?
 38462                                  ;	jz	short not_in_hma	; no
 38463                                  ;	popf
 38464                                  ;	mov	cx,[ES:BP+DPB.SECTOR_SIZE]
 38465                                  ;	shr	cx,1
 38466                                  ;	mov	si,bx
 38467                                  ;	pop	di ; *
 38468                                  ;	pop	es ; **
 38469                                  ;	cld
 38470                                  ;	rep	movsw
 38471                                  ;	push	es
 38472                                  ;	pop	ds
 38473                                  ;	jmp	short getb19 ; 27/11/2022
 38474                                  ;%endif
 38475                                  
 38476                                  not_in_hma:								  ;I001
 38477                                  	popf							 	  ;I001
 38478                                  
 38479                                  %else
 38480                                  	; 06/03/2024
 38481                                  	; PCDOS 7.1 IBMDOS.COM
 38482                                  	;;;
 38483 000066A4 B500                    	mov	ch,0
 38484 000066A6 368A0E[7900]            	mov	cl,[ss:BuffInHMA] ; did we read into scratch buff ?
 38485 000066AB E31C                    	jcxz	getb19		  ; no
 38486                                  	;mov	cx,[es:bp+2]
 38487 000066AD 268B4E02                	mov	cx,[es:bp+DPB.SECTOR_SIZE]
 38488 000066B1 89DE                    	mov	si,bx
 38489 000066B3 5F                      	pop	di
 38490 000066B4 07                      	pop	es
 38491 000066B5 9C                      	pushf
 38492 000066B6 D1E9                    	shr	cx,1
 38493 000066B8 FC                      	cld
 38494 000066B9 36803E[6A00]00          	cmp	byte [ss:DDMOVE],0
 38495                                  	;jz	short getb18+1	; rep movsw (skip 32bit prefix)
 38496 000066BF 7403                    	jz	short getb18
 38497 000066C1 D1E9                    	shr	cx,1
 38498                                  ;getb18:
 38499                                  	;rep	movsd		; move the contents of scratch buffer
 38500 000066C3 66                      	db	66h	; 32bit prefix
 38501                                  getb18:
 38502 000066C4 F3A5                    	rep	movsw
 38503                                  
 38504                                  	;mov	dx,es
 38505                                  	;mov	ds,dx
 38506 000066C6 06                      	push	es
 38507 000066C7 1F                      	pop	ds
 38508 000066C8 9D                      	popf			; Retrieve possible CY from DREAD
 38509                                  	;;;
 38510                                  %endif
 38511                                  
 38512                                  getb19:
 38513 000066C9 07                      	pop	es ; ***
 38514 000066CA 5A                      	pop	dx
 38515 000066CB 5F                      	pop	di
 38516 000066CC 5E                      	pop	si
 38517 000066CD 726C                    	JC	short getbx
 38518                                  
 38519                                  ;	The buffer has the data setup in it (if we were to read)
 38520                                  ;	Setup the various buffer fields
 38521                                  ;
 38522                                  ;	(ds:di) = buffer address
 38523                                  ;	(es:bp) = DPB address
 38524                                  ;	(HIGH_SECTOR:DX) = sector #
 38525                                  ;	(ah) = BUF_FLAGS value
 38526                                  ;	(si) = 0 if non fat sector, != 0 if FAT sector read
 38527                                  
 38528                                  ;hkn; SS override
 38529                                  getb20:	; MSDOS 6.0
 38530 000066CF 368B0E[0706]            	MOV	CX,[SS:HIGH_SECTOR]
 38531                                  	;mov	[di+8],cx
 38532 000066D4 894D08                  	MOV	[DI+BUFFINFO.buf_sector+2],CX
 38533                                  	; MSDOS 3.3 (& MSDOS 6.0)
 38534                                   	;mov	[di+6],dx
 38535 000066D7 895506                  	MOV	[DI+BUFFINFO.buf_sector],DX
 38536                                  	;;;mov	[di+0Ah],bp  ; MSDOS 3.3
 38537                                  	;;mov	[di+0Dh],bp  ; MSDOS 6.0
 38538                                  	;mov	[di+0Fh],bp  ; PCDOS 7.1 ; 06/03/2024
 38539 000066DA 896D0F                  	MOV	[DI+BUFFINFO.buf_DPB],BP
 38540                                  	;;;mov	[di+0Ch],es
 38541                                  	;;mov	[di+0Fh],es  ; MSDOS 6.0
 38542                                  	;mov	[di+11h],es  ; PCDOS 7.1 ; 06/03/2024
 38543 000066DD 8C4511                  	MOV	[DI+BUFFINFO.buf_DPB+2],ES
 38544                                  	; 15/12/2022
 38545 000066E0 268A4600                	mov	al,[es:bp]
 38546                                  	;mov	al,[es:bp+0]
 38547                                  	; 27/11/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 38548                                  	;MOV	AL,[ES:BP+DPB.DRIVE]
 38549                                  	;mov	[di+4],ax
 38550 000066E4 894504                  	MOV	[DI+BUFFINFO.buf_ID],AX		; Set ID and Flags
 38551                                  getb25:	
 38552                                  	; MSDOS 3.3
 38553                                  	;mov     ax,1
 38554                                  
 38555                                  	; MSDOS 6.0
 38556                                  	;mov	byte [di+0Ah],1
 38557 000066E7 C6450A01                	MOV	byte [DI+BUFFINFO.buf_wrtcnt],1	; Default to not a FAT sector ;AC000;
 38558 000066EB 31C0                    	XOR	AX,AX
 38559                                  
 38560                                  	; 07/07/2024 (PCDOS 7.1)
 38561                                  	;mov	[di+0Dh],ax ; 0
 38562 000066ED 89450D                  	mov	[di+BUFFINFO.buf_wrtcntinc+2],ax ; 0
 38563                                  
 38564                                  	; MSDOS 3.3 (& MSDOS 6.0)
 38565 000066F0 09F6                    	OR	SI,SI				; FAT sector ?
 38566 000066F2 742C                    	JZ	short getb30			; no
 38567                                  
 38568                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38569                                  	;;;
 38570                                  	;;cmp	word [es:bp+0Fh],0
 38571                                  	;cmp	word [es:bp+DPB.FAT_SIZE],0
 38572 000066F4 2639460F                	cmp	[es:bp+DPB.FAT_SIZE],ax ; 0
 38573 000066F8 751B                    	jnz	short getb27	; not FAT32
 38574                                  
 38575                                  	; FAT32
 38576                                  	;;test	word [es:bp+23h],80h
 38577                                  	;test	byte [es:bp+23h],80h
 38578 000066FA 26F6462380              	test	byte [es:bp+DPB.EXT_FLAGS],80h
 38579 000066FF 7507                    	jnz	short getb26		; bit 7 -- 1 means only one FAT is active
 38580                                  	;mov	al,[es:bp+8]
 38581 00006701 268A4608                	mov	al,[es:bp+DPB.FAT_COUNT]
 38582                                  	;mov	[di+0Ah],al
 38583 00006705 88450A                  	mov	[di+BUFFINFO.buf_wrtcnt],al
 38584                                  getb26:
 38585                                  	;mov	ax,[es:bp+33h]
 38586 00006708 268B4633                	mov	ax,[es:bp+DPB.FAT32_SIZE+2]
 38587                                  	;mov	[di+0Dh],ax
 38588 0000670C 89450D                  	mov	[di+BUFFINFO.buf_wrtcntinc+2],ax
 38589                                  	;mov	ax,[es:bp+31h]
 38590 0000670F 268B4631                	mov	ax,[es:bp+DPB.FAT32_SIZE]
 38591 00006713 EB0B                    	jmp	short getb30
 38592                                  getb27: 
 38593                                  	;;;
 38594                                  
 38595                                  	;mov	al,[es:bp+8]
 38596 00006715 268A4608                	MOV	AL,[ES:BP+DPB.FAT_COUNT]	; update number of copies of
 38597                                  	
 38598                                  	; MSDOS 6.0
 38599 00006719 88450A                  	MOV	[DI+BUFFINFO.buf_wrtcnt],AL	;  this sector present on disk
 38600                                  	;mov	ax,[es:bp+0Fh]
 38601 0000671C 268B460F                	MOV	AX,[ES:BP+DPB.FAT_SIZE]		; offset of identical FAT
 38602                                  						;  sectors
 38603                                  	; MSDOS 3.3
 38604                                  	;;mov	ah,[es:bp+0Fh]
 38605                                  	;MOV	AH,[ES:BP+DPB.FAT_SIZE]
 38606                                  
 38607                                  ;	BUGBUG - dos 6 can clean this up by not setting wrtcntinc unless wrtcnt
 38608                                  ;		is set
 38609                                  
 38610                                  getb30:	
 38611                                  	; MSDOS 6.0
 38612                                  	;mov	[di+0Bh],ax
 38613 00006720 89450B                  	MOV	[DI+BUFFINFO.buf_wrtcntinc],AX
 38614                                  
 38615                                  	; MSDOS 3.3
 38616                                  	;;mov	[di+8],ax ; 15/08/2018	
 38617                                  	;MOV	[DI+BUFFINFO.buf_wrtcnt],AX
 38618                                  
 38619 00006723 E852FE                  	CALL	PLACEBUF
 38620                                  
 38621                                  ;hkn; SS override for next 4
 38622                                  getb35: 
 38623                                  	; 17/12/2022
 38624                                  	; 07/12/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 38625                                  	; MSDOS 3.3 & MSDOS 5.0 & MSDOS 6.0
 38626                                  	;MOV	[SS:CURBUF+2],DS
 38627                                  	;MOV	[SS:LastBuffer+2],DS
 38628                                  	;MOV	[SS:CURBUF],DI
 38629                                  	;MOV	[SS:LastBuffer],DI
 38630                                  	;CLC
 38631                                  
 38632                                  	; 17/12/2022
 38633                                  	; 07/12/2022
 38634                                  	; Retro DOS v4.0
 38635 00006726 368C1E[2000]            	mov	[ss:LastBuffer+2],ds
 38636 0000672B 36893E[1E00]            	mov	[ss:LastBuffer],di
 38637 00006730 F8                      	clc
 38638                                  getb35x: ; 28/07/2019
 38639 00006731 368C1E[E405]            	MOV	[ss:CURBUF+2],ds
 38640 00006736 36893E[E205]            	MOV	[ss:CURBUF],di
 38641                                  
 38642                                  ;	Return with 'C' set appropriately
 38643                                  ;	(dx) = caller's original value
 38644                                  
 38645                                  getbx:	
 38646 0000673B 16                      	push	ss
 38647 0000673C 1F                      	pop	ds
 38648                                  	;retn
 38649                                  	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 38650                                  getbuffrb_retn:
 38651                                  ;flushbuf_retn:	; 17/12/2022
 38652 0000673D C3                      	retn
 38653                                  
 38654                                  ;Break	<FLUSHBUF -- WRITE OUT DIRTY BUFFERS>
 38655                                  ;----------------------------------------------------------------------------
 38656                                  ; Input:
 38657                                  ;	DS = DOSGROUP
 38658                                  ;	AL = Physical unit number local buffers only
 38659                                  ;	   = -1 for all units and all remote buffers
 38660                                  ; Function:
 38661                                  ;	Write out all dirty buffers for unit, and flag them as clean
 38662                                  ;	Carry set if error (user FAILed to I 24)
 38663                                  ;	    Flush operation completed.
 38664                                  ; DS Preserved, all others destroyed (ES too)
 38665                                  ;----------------------------------------------------------------------------
 38666                                  
 38667                                  	; 20/05/2019 - Retro DOS v4.0
 38668                                  	; DOSCODE:9A35h (MSDOS 6.21, MSDOS.SYS)
 38669                                  
 38670                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 38671                                  	; DOSCODE:99DAh (MSDOS 5.0, MSDOS.SYS)
 38672                                  
 38673                                  	; 06/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 38674                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0AC2Bh
 38675                                  
 38676                                  FLUSHBUF:
 38677                                  	; MSDOS 3.3
 38678                                  	;;mov	ah,-1 ; 01/08/2018 - Retro DOS v3.0
 38679                                  	;lds	di,[BUFFHEAD]
 38680                                  
 38681                                  	; 06/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38682                                  	;;;
 38683 0000673E 3CFF                    	cmp     al,0FFh        ; -1
 38684 00006740 750C                    	jne     short flshbuf_2
 38685 00006742 BB1A00                  	mov     bx,26
 38686                                  flshbuf_1:
 38687                                  	;and	ss:drv_flags_1[bx],0F7h
 38688 00006745 3680A7[1312]F7          	and	byte [ss:bx+drive_flags-1],0F7h ; clear bit 3
 38689 0000674B 4B                      	dec     bx              ; backward
 38690 0000674C 75F7                    	jnz     short flshbuf_1
 38691                                  flshbuf_2:
 38692                                  	;;;
 38693                                  
 38694                                  	; MSDOS 6.0
 38695 0000674E E80EFE                  	call	GETCURHEAD
 38696                                  	;TEST	word [ss:DOS34_FLAG],FROM_DISK_RESET ; from disk reset ? ;hkn;
 38697 00006751 36F606[1106]04          	TEST	byte [ss:DOS34_FLAG],FROM_DISK_RESET ; 4
 38698 00006757 7508                    	jnz	short scan_buf_queue
 38699 00006759 36833E[7100]00          	cmp	word [ss:DirtyBufferCount],0			;hkn;
 38700 0000675F 7423                    	je	short end_scan
 38701                                  	
 38702                                  scan_buf_queue:
 38703 00006761 E82900                  	call	CHECKFLUSH
 38704                                  	;push	ax  ; MSDOS 3.3
 38705                                  	; MSDOS 6.0
 38706                                  	;mov	ah,[di+4]
 38707 00006764 8A6504                  	mov	ah,[DI+BUFFINFO.buf_ID]
 38708 00006767 363826[2203]            	cmp	[SS:WPERR],ah					;hkn;
 38709 0000676C 7408                    	je	short free_the_buf
 38710                                  	;TEST	word [ss:DOS34_FLAG],FROM_DISK_RESET ; from disk reset ? ;hkn;
 38711 0000676E 36F606[1106]04          	TEST	byte [ss:DOS34_FLAG],FROM_DISK_RESET ; 4
 38712 00006774 7405                    	jz	short dont_free_the_buf
 38713                                  	; MSDOS 3.3
 38714                                  	;;mov	al,[di+4]
 38715                                  	;mov	al,[DI+BUFFINFO.buf_ID]
 38716                                  	;cmp	[SS:WPERR],al					;hkn;
 38717                                  	; 15/08/2018
 38718                                  	;jne	short dont_free_the_buf	
 38719                                  free_the_buf:
 38720                                  	; MSDOS 6.0 (& MSDOS 3.3)
 38721 00006776 C74504FF00              	mov	word [DI+BUFFINFO.buf_ID],00FFh
 38722                                  dont_free_the_buf:
 38723                                  	;pop	ax  ; MSDOS 3.3 	   	
 38724                                  
 38725                                  	; MSDOS 3.3
 38726                                  	;mov	di,[DI]
 38727                                  	;;mov	di,[DI+BUFFINFO.buf_link] ; .buf_next
 38728                                  	;
 38729                                  	; 15/08/2018
 38730                                  	;lds	di,[di]
 38731                                  	;
 38732                                  	;cmp	di,-1 ; 0FFFFh
 38733                                  	;jnz	short scan_buf_queue 
 38734                                  	
 38735                                  	; MSDOS 6.0
 38736 0000677B 8B3D                    	mov	di,[di]
 38737                                  	;mov	di,[DI+BUFFINFO.buf_next] ; .buf_link
 38738 0000677D 363B3E[1B11]            	cmp	di,[SS:FIRST_BUFF_ADDR]				;hkn;
 38739 00006782 75DD                    	jne	short scan_buf_queue
 38740                                  
 38741                                  end_scan:
 38742 00006784 16                      	push	ss
 38743 00006785 1F                      	pop	ds
 38744                                  	; 01/08/2018 - Retro DOS v3.0
 38745                                  	;cmp	byte [FAILERR],0
 38746                                  	;jne	short bad_flush
 38747                                  	;retn
 38748                                  ;bad_flush:
 38749                                  	;stc
 38750                                  	;retn
 38751                                  
 38752                                  	; 17/12/2022
 38753                                  	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 38754                                  	; 01/08/2018 - Retro DOS v3.0
 38755 00006786 803E[4A03]01            	cmp	byte [FAILERR],1
 38756 0000678B F5                      	cmc
 38757                                  flushbuf_retn:
 38758 0000678C C3                      	retn
 38759                                  	
 38760                                  	; 17/12/2022
 38761                                  	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 38762                                  	;cmp	byte [FAILERR],0
 38763                                  	;jne	short bad_flush
 38764                                  	;retn
 38765                                  ;bad_flush:
 38766                                  	;stc
 38767                                  	;retn
 38768                                  
 38769                                  ;----------------------------------------------------------------------------
 38770                                  ;
 38771                                  ; Procedure Name : CHECKFLUSH
 38772                                  ;
 38773                                  ; Inputs : AL - Drive number, -1 means do not check for drive
 38774                                  ;	   DS:DI - pointer to buffer
 38775                                  ;
 38776                                  ; Function : Write out a buffer if it is dirty
 38777                                  ;
 38778                                  ; Carry set if problem (currently user FAILed to I 24)
 38779                                  ;
 38780                                  ;----------------------------------------------------------------------------
 38781                                  
 38782                                  	; 07/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 38783                                  
 38784                                  CHECKFLUSH:
 38785                                  	; MSDOS 6.0
 38786 0000678D B4FF                    	mov	ah,-1	; 01/08/2018 Retro DOS v3.0
 38787                                  	;cmp	[di+4],ah
 38788 0000678F 386504                  	CMP	[DI+BUFFINFO.buf_ID],AH
 38789 00006792 74F8                    	jz	short flushbuf_retn	; Skip free buffer, carry clear
 38790 00006794 38C4                    	CMP	AH,AL			; 
 38791 00006796 7412                    	JZ	short DOBUFFER		; do this buffer
 38792                                  	;cmp	al,[di+4]
 38793 00006798 3A4504                  	CMP	AL,[DI+BUFFINFO.buf_ID]
 38794 0000679B F8                      	CLC
 38795 0000679C 75EE                    	jnz	short flushbuf_retn	; Buffer not for this unit or SFT
 38796                                  
 38797                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38798                                  	;;;
 38799 0000679E 31DB                    	xor	bx,bx
 38800 000067A0 88C3                    	mov	bl,al
 38801                                  	;test	ss:drive_flags[bx],8 
 38802 000067A2 36F687[1412]08          	test	byte [ss:bx+drive_flags],8 ; bit 3
 38803 000067A8 75E2                    	jnz	short flushbuf_retn
 38804                                  	;;;
 38805                                  
 38806                                  DOBUFFER:
 38807                                  	;test	byte [di+5],40h
 38808 000067AA F6450540                	TEST	byte [DI+BUFFINFO.buf_flags],buf_dirty
 38809 000067AE 74DC                    	jz	short flushbuf_retn	; Buffer not dirty, carry clear by TEST
 38810 000067B0 50                      	PUSH	AX
 38811                                  	;push	word [di+4]
 38812 000067B1 FF7504                  	PUSH	WORD [DI+BUFFINFO.buf_ID]
 38813 000067B4 E80B00                  	CALL	BUFWRITE
 38814 000067B7 58                      	POP	AX
 38815 000067B8 7206                    	JC	short LEAVE_BUF		; Leave buffer marked free (lost).
 38816                                  	;and	ah,0BFh
 38817 000067BA 80E4BF                  	AND	AH,~buf_dirty		; Buffer is clean, clears carry
 38818                                  	;mov	[di+4],ax
 38819 000067BD 894504                  	MOV	[DI+BUFFINFO.buf_ID],AX
 38820                                  LEAVE_BUF:
 38821 000067C0 58                      	POP	AX			; Search info
 38822                                  checkflush_retn:
 38823 000067C1 C3                      	retn
 38824                                  
 38825                                  ;Break	<BUFWRITE -- WRITE OUT A BUFFER IF DIRTY>
 38826                                  ;----------------------------------------------------------------------------
 38827                                  ;
 38828                                  ;	BufWrite writes a buffer to the disk, if it's dirty.
 38829                                  ;
 38830                                  ;	ENTRY	DS:DI Points to the buffer
 38831                                  ;
 38832                                  ;	EXIT	Buffer marked free
 38833                                  ;		Carry set if error (currently user FAILed to I 24)
 38834                                  ;
 38835                                  ;	USES	All buf DS:DI
 38836                                  ;		HIGH_SECTOR
 38837                                  ;----------------------------------------------------------------------------
 38838                                  
 38839                                  	; 20/05/2019 - Retro DOS v4.0
 38840                                  	; DOSCODE:9AA0h (MSDOS 6.21, MSDOS.SYS)
 38841                                  
 38842                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 38843                                  	; DOSCODE:9A45h (MSDOS 5.0, MSDOS.SYS)
 38844                                  
 38845                                  	; 07/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 38846                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0ACB1h
 38847                                  
 38848                                  BUFWRITE:
 38849                                  	; 10/09/2018
 38850                                  	; 01/08/2018 - Retro DOS v3.0
 38851                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5E94h
 38852 000067C2 B8FF00                  	MOV	AX,00FFH
 38853                                  	;xchg	ax,[di+4]
 38854 000067C5 874504                  	XCHG	AX,[DI+BUFFINFO.buf_ID]	; Free, in case write barfs
 38855 000067C8 3CFF                    	CMP	AL,0FFH
 38856 000067CA 74F5                    	jz      short checkflush_retn	; Buffer is free, carry clear.
 38857                                  	;test	ah,40h
 38858 000067CC F6C440                  	test	AH,buf_dirty
 38859 000067CF 74F0                    	jz      short checkflush_retn	; Buffer is clean, carry clear.
 38860                                  	; MSDOS 6.0
 38861 000067D1 E8A200                  	call	DEC_DIRTY_COUNT 	; LB. decrement dirty count
 38862                                  
 38863                                  ;hkn; SS override
 38864 000067D4 363A06[2203]            	CMP	AL,[SS:WPERR]
 38865 000067D9 74E6                    	jz      short checkflush_retn	; If in WP error zap buffer
 38866                                  
 38867                                  ; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38868                                  %if 0
 38869                                  ;hkn; SS override
 38870                                  	; MSDOS 6.0
 38871                                  	MOV	[SS:SC_DRIVE],AL	;LB. set it for invalidation ;AN000;
 38872                                  %endif
 38873                                  	; 07/03/2024
 38874                                  	;;;;les	bp,[di+10] ; MSDOS 3.3
 38875                                  	;;;les	bp,[di+13] ; MSDOS 6.0
 38876                                  	;;les	bp,[di+15] ; PCDOS 7.1 ; 07/03/2024
 38877                                  	;LES	BP,[DI+BUFFINFO.buf_DPB]
 38878                                  
 38879                                  	;;;lea	bx,[di+16]
 38880                                  	;;lea	bx,[di+20] ; MSDOS 6.0
 38881                                  	;lea	bx,[di+24] ; PCDOS 7.1 ; 07/03/2024
 38882 000067DB 8D5D18                  	LEA	BX,[DI+BUFINSIZ]	; Point at buffer
 38883                                  
 38884                                  ; 07/03/2024
 38885                                  %if 0
 38886                                  	;mov	dx,[di+6]
 38887                                  	MOV	DX,[DI+BUFFINFO.buf_sector] ;F.C. >32mb		;AN000;
 38888                                  	
 38889                                  	; MSDOS 6.0
 38890                                  	;mov	cx,[di+8]
 38891                                  	MOV	CX,[DI+BUFFINFO.buf_sector+2] ;F.C. >32mb	;AN000;
 38892                                  
 38893                                  ;hkn; SS override
 38894                                  	MOV	[SS:HIGH_SECTOR],CX	;F.C. >32mb		;AN000;
 38895                                  %else
 38896                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38897                                  	;;;
 38898                                  	;les	dx,[di+6]
 38899 000067DE C45506                  	les	dx,[di+BUFFINFO.buf_sector]
 38900 000067E1 368C06[0706]            	mov	[ss:HIGH_SECTOR],es
 38901                                  
 38902                                  	;;;les	bp,[di+10] ; MSDOS 3.3
 38903                                  	;;les	bp,[di+13] ; MSDOS 6.0
 38904                                  	;les	bp,[di+15] ; PCDOS 7.1 ; 07/03/2024
 38905 000067E6 C46D0F                  	les	bp,[di+BUFFINFO.buf_DPB]
 38906                                  	;;;
 38907                                  %endif
 38908                                  	;mov	cl,[di+10] ; MSDOS 6.0 & PCDOS 7.1
 38909 000067E9 8A4D0A                  	MOV	CL,[DI+BUFFINFO.buf_wrtcnt] ;>32mb		;AC000;
 38910                                  	; MSDOS 3.3
 38911                                  	;; mov	cx,[DI+8]
 38912                                  	;mov	cx,[DI+BUFFINFO.buf_wrtcnt]
 38913                                  	;MOV	AL,CH			; [DI+BUFFINFO.buf_wrtcntinc]
 38914 000067EC 30ED                    	XOR	CH,CH
 38915                                  	;;mov	ah,ch ; MSDOS 3.3
 38916                                  
 38917                                  ;hkn; SS override for ALLOWED
 38918                                  	;mov	byte [SS:ALLOWED],18h
 38919 000067EE 36C606[4B03]18          	MOV	byte [SS:ALLOWED],Allowed_RETRY+Allowed_FAIL
 38920                                  	;test	byte [di+5],8
 38921                                  	; MSDOS 6.0 (& Retro DOS 3.0)
 38922                                  	;test	ah,8
 38923 000067F4 F6C408                  	test	AH,buf_isDATA
 38924 000067F7 7406                    	JZ	short NO_IGNORE
 38925                                  	;or	byte [SS:ALLOWED],20h
 38926 000067F9 36800E[4B03]20          	OR	byte [SS:ALLOWED],Allowed_IGNORE
 38927                                  NO_IGNORE:
 38928                                  	;xor	ah,ah ; 10/09/2018 (MSDOS 3.3, Retro DOS v3.0)
 38929                                  	; MSDOS 6.0
 38930                                  	;mov	ax,[di+11]
 38931 000067FF 8B450B                  	MOV	AX,[DI+BUFFINFO.buf_wrtcntinc]	;>32mb		;AC000;
 38932                                  
 38933                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38934                                  	;;;
 38935                                  	;mov	si,[di+13]
 38936 00006802 8B750D                  	mov	si,[di+BUFFINFO.buf_wrtcntinc+2]
 38937                                  	;;;
 38938                                  	
 38939 00006805 57                      	PUSH	DI		; Save buffer pointer
 38940 00006806 31FF                    	XOR	DI,DI		; Indicate failure
 38941                                  
 38942 00006808 1E                      	push	ds ; *
 38943 00006809 53                      	push	bx ; **
 38944                                  WRTAGAIN:
 38945                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 38946                                  	;;;
 38947 0000680A 56                      	push	si		; SI:AX = FAT size (in sectors)
 38948 0000680B 36FF36[0706]            	push	word [ss:HIGH_SECTOR]
 38949                                  	;;;
 38950 00006810 57                      	push	di ; ***
 38951 00006811 51                      	push	cx ; ****
 38952 00006812 50                      	push	ax ; *****
 38953                                  	;MOV	CX,1
 38954                                  	; 17/12/2022
 38955                                  	; ch = 0
 38956 00006813 B101                    	mov	cl,1 ; 24/07/2019
 38957                                  	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 38958                                  	;mov	cx,1
 38959 00006815 53                      	push	bx ; ******
 38960 00006816 52                      	push	dx ; *******
 38961 00006817 1E                      	push	ds ; ********
 38962                                  
 38963                                  ; Note: As far as I can tell, all disk reads into buffers go through this point. -mrw 10/88
 38964                                  
 38965                                  	; MSDOS 6.0
 38966                                  	;cmp	byte [ss:BuffInHMA],0 ; 10/06/2019
 38967                                  	; 22/09/2023
 38968 00006818 36382E[7900]            	cmp	[ss:BuffInHMA],ch ; 0
 38969 0000681D 7423                    	jz	short NBUFFINHMA
 38970 0000681F 51                      	push	cx
 38971 00006820 06                      	push	es
 38972 00006821 89DE                    	mov	si,bx
 38973 00006823 268B4E02                	mov	cx,[es:bp+DPB.SECTOR_SIZE]
 38974 00006827 D1E9                    	shr	cx,1
 38975 00006829 36C43E[7A00]            	les	di,[ss:LoMemBuff] ; 10/06/2019
 38976 0000682E 89FB                    	mov	bx,di
 38977 00006830 FC                      	cld
 38978                                  	;rep	movsw
 38979                                  	; 07/03/2024 - Retro DOS v5.0
 38980                                  	; (PCDOS 7.1 IBMDOS.COM)
 38981                                  	;;;
 38982 00006831 36803E[6A00]00          	cmp	byte [ss:DDMOVE],0
 38983 00006837 7403                    	jz      short bufwr_movsw ; skip 32bit prefix
 38984 00006839 D1E9                    	shr     cx,1
 38985 0000683B 66                      	db	66h	; 32bit op prefix (rep movsd)
 38986                                  bufwr_movsw:	
 38987 0000683C F3A5                    	rep	movsw
 38988                                  	;;;
 38989 0000683E 06                      	push	es
 38990 0000683F 1F                      	pop	ds
 38991 00006840 07                      	pop	es
 38992 00006841 59                      	pop	cx
 38993                                  NBUFFINHMA:
 38994 00006842 E8DFD6                  	call	DWRITE		; Write out the dirty buffer
 38995 00006845 1F                      	pop	ds ; ********
 38996 00006846 5A                      	pop	dx ; *******
 38997 00006847 5B                      	pop	bx ; ******
 38998 00006848 58                      	pop	ax ; *****
 38999 00006849 59                      	pop	cx ; ****
 39000 0000684A 5F                      	pop	di ; ***
 39001                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39002                                  	;;;
 39003 0000684B 368F06[0706]            	pop	word [ss:HIGH_SECTOR]
 39004 00006850 5E                      	pop	si
 39005                                  	;;;
 39006 00006851 7201                    	JC	short NOSET
 39007                                  	; 05/07/2024 (PCDOS 7.1)
 39008                                  	;mov	di,1
 39009 00006853 47                      	INC	DI		; If at least ONE write succeedes,
 39010                                  NOSET:				;    the operation succeedes.
 39011 00006854 01C2                    	ADD	DX,AX
 39012                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39013                                  	;;;
 39014 00006856 361136[0706]            	adc	[ss:HIGH_SECTOR],si
 39015                                  	;;;
 39016 0000685B E2AD                    	LOOP	WRTAGAIN
 39017 0000685D 5B                      	pop	bx ; **
 39018 0000685E 1F                      	pop	ds ; *
 39019                                  	;OR	DI,DI		; Clears carry
 39020                                  	;JNZ	short BWROK	; At least one write worked
 39021                                  	;STC			; DI never got INCed, all writes failed.
 39022                                  	; 05/07/2024 (PCDOS 7.1)
 39023                                  	;sub	di,1
 39024                                  	; 22/09/2023
 39025 0000685F 83FF01                  	cmp	di,1
 39026                                  BWROK:	
 39027 00006862 5F                      	POP	DI
 39028 00006863 C3                      	retn
 39029                                  
 39030                                  ; 07/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 39031                                  %if 0
 39032                                  ; NOTE: Secondary Buffer Cache is not used in PCDOS 7.1 IBMDOS.COM.
 39033                                  
 39034                                  ;**	Set_RQ_SC_Parms - Set Secondary Cache Parameters
 39035                                  ;----------------------------------------------------------------------------
 39036                                  ;	Set_RQ_SC_Parms sets the sector size and drive number value
 39037                                  ;	for the secondary cache. This updates SC_SECTOR_SIZE &
 39038                                  ;	SC_DRIVE even if SC is disabled to save the testing
 39039                                  ;	code and time
 39040                                  ;
 39041                                  ;	ENTRY	ES:BP = drive parameter block
 39042                                  ;
 39043                                  ;	EXIT	[SC_SECTOR_SIZE]= drive sector size
 39044                                  ;		[SC_DRIVE]= drive #
 39045                                  ;
 39046                                  ;	USES	Flags
 39047                                  ;----------------------------------------------------------------------------
 39048                                  
 39049                                  ; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 39050                                  ; 04/05/2019 - Retro DOS v4.0
 39051                                  
 39052                                  SET_RQ_SC_PARMS:
 39053                                  ;hkn; SS override for all variables used in this procedure.
 39054                                  	push	ax
 39055                                  	;mov	ax,[es:bp+2]
 39056                                  	MOV	ax,[ES:BP+DPB.SECTOR_SIZE]	; save sector size
 39057                                  	MOV	[ss:SC_SECTOR_SIZE],ax
 39058                                  	;;mov	al,[es:bp+0]
 39059                                  	; 27/11/2022 MSDOS 5.0 MSDOS.SYS compatibility)
 39060                                  	;MOV	al,[ES:BP+DPB.DRIVE]		; save drive #
 39061                                  	; 15/12/2022
 39062                                  	mov	al,[ES:BP]
 39063                                  	MOV	[ss:SC_DRIVE],al
 39064                                  	pop	ax
 39065                                  srspx:	
 39066                                  	retn					;LB. return
 39067                                  
 39068                                  %endif
 39069                                  
 39070                                  ; 07/03/2024 -Retro DOS v5.0
 39071                                  ; (PCDOS 7.1 IBMDOS.COM - DOSCODE:0AD57h)
 39072                                  %if 0
 39073                                  null_sub:
 39074                                  SET_RQ_SC_PARMS:
 39075                                  	retn
 39076                                  %endif
 39077                                  
 39078                                  ; 01/02/2024 - Retro DOS v5.0
 39079                                  ;----------------------------------------------------------------------------
 39080                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:AD58h
 39081                                  
 39082                                  SET_BUF_DIRTY:                          ; ...
 39083                                  	;test	byte [es:di+5],40h
 39084 00006864 26F6450540              	test	byte [es:di+BUFFINFO.buf_flags],buf_dirty
 39085 00006869 750A                    	jnz	short yesdirty2
 39086                                  	;or	byte [es:di+5],40h
 39087 0000686B 26804D0540              	or	byte [es:di+BUFFINFO.buf_flags],buf_dirty
 39088                                  
 39089                                  ;INC_DIRTY_COUNT:
 39090                                  ;	inc     word [ss:DirtyBufferCount]
 39091                                  ;yesdirty2:
 39092                                  ;	retn
 39093                                  
 39094                                  ;Break	<INC_DIRTY_COUNT-increment dirty count>
 39095                                  ;----------------------------------------------------------------------------
 39096                                  ; Input:
 39097                                  ;	none
 39098                                  ; Function:
 39099                                  ;	increment dirty buffers count
 39100                                  ; Output:
 39101                                  ;	dirty buffers count is incremented
 39102                                  ;
 39103                                  ; All registers preserved
 39104                                  ;----------------------------------------------------------------------------
 39105                                  
 39106                                  INC_DIRTY_COUNT:
 39107                                  ;; BUGBUG  ---- remove this routine
 39108                                  ;; BUGBUG ---- only one instruction is needed (speed win, space loose)
 39109 00006870 36FF06[7100]            	inc	word [ss:DirtyBufferCount]	;hkn;
 39110                                  yesdirty2:	; 01/02/2024
 39111 00006875 C3                      	retn
 39112                                  
 39113                                  ;Break	<DEC_DIRTY_COUNT-decrement dirty count>
 39114                                  ;----------------------------------------------------------------------------
 39115                                  ; Input:
 39116                                  ;	none
 39117                                  ; Function:
 39118                                  ;	decrement dirty buffers count
 39119                                  ; Output:
 39120                                  ;	dirty buffers count is decremented
 39121                                  ;
 39122                                  ; All registers preserved
 39123                                  ;----------------------------------------------------------------------------
 39124                                  
 39125                                  DEC_DIRTY_COUNT:
 39126 00006876 36833E[7100]00          	cmp	word [ss:DirtyBufferCount],0 ;hkn;
 39127 0000687C 7405                    	jz	short ddcx		; BUGBUG - shouldn't it be an
 39128 0000687E 36FF0E[7100]            	dec	word [ss:DirtyBufferCount] 
 39129                                  					; error condition to underflow here? ;hkn;
 39130                                  ddcx:	
 39131 00006883 C3                      	retn
 39132                                  
 39133                                  ;============================================================================
 39134                                  ; MSPROC.ASM, MSDOS 6.0, 1992
 39135                                  ;============================================================================
 39136                                  ; 02/08/2018 - Retro DOS v3.0
 39137                                  ; 29/04/2019 - Retro DOS v4.0
 39138                                  ; 07/03/2024 - Retro DOS v5.0
 39139                                  
 39140                                  ; (15/04/2018 - RetrO DOS v2.0, MSDOS 2.11 - PROC.ASM - 1983)
 39141                                  
 39142                                  ; Pseudo EXEC system call for DOS
 39143                                  
 39144                                  ;	TITLE	MSPROC - process maintenance
 39145                                  ;	NAME	MSPROC
 39146                                  
 39147                                  ; =========================================================================
 39148                                  ;**	Process related system calls and low level routines for DOS 2.X.
 39149                                  ;	I/O specs are defined in DISPATCH.
 39150                                  ;
 39151                                  ;	$WAIT
 39152                                  ;	$EXEC
 39153                                  ;	$Keep_process
 39154                                  ;	Stay_resident
 39155                                  ;	$EXIT
 39156                                  ;	$ABORT
 39157                                  ;	abort_inner
 39158                                  ;
 39159                                  ;	Modification history:
 39160                                  ;
 39161                                  ;		Created: ARR 30 March 1983
 39162                                  ;		AN000	version 4.0 jan. 1988
 39163                                  ;		A007	PTM 3957 - fake vesrion for IBMCACHE.COM
 39164                                  ;		A008	PTM 4070 - fake version for MS WINDOWS
 39165                                  ;
 39166                                  ;		M000	added support for loading programs into UMBs 7/9/90
 39167                                  ;
 39168                                  ;		M004 - MS PASCAL 3.2 support. Please see under tag M003 in 
 39169                                  ;		       dossym.inc. 7/30/90
 39170                                  ;		M005 - Support for EXE programs with out STACK segment and 
 39171                                  ;		       with resident size < 64K - 256 bytes. A 256 byte 
 39172                                  ;		       stack is provided at the end of the program. Note that
 39173                                  ;		       only SP is changed.
 39174                                  ;		M020 - Fix for Rational bug for details see exepatch.asm
 39175                                  ;
 39176                                  ;		M028 - 4b04 implementation
 39177                                  ;
 39178                                  ;		M029 - Support for EXEs without stack rewritten. If EXE is
 39179                                  ;			in memory block >= 64K, sp = 0. If memory block
 39180                                  ;			obtained is <64K, point sp at the end of the memory
 39181                                  ;			block. For EXEs smaller than 64K, 256 bytes are still
 39182                                  ;			added for a stack segment which may be needed if it
 39183                                  ;			is loaded in low memory situations.
 39184                                  ;
 39185                                  ;		M030 - Fixing bug in EXEPACPATCH & changing 4b04 to 4b05
 39186                                  ;
 39187                                  ;		M040 - Bug #3052. The environment sizing code would flag a
 39188                                  ;			a bad environment if it reached 32767 bytes. Changed
 39189                                  ;			to allow 32768 bytes of environment.
 39190                                  ;
 39191                                  ;		M047 - Release the allocated UMB when we failed to load a 
 39192                                  ;		       COM file high. Also ensure that if the biggest block
 39193                                  ;		       into which we load the com file is less than 64K then
 39194                                  ;		       we provide atleast 256 bytes of stack to the user.
 39195                                  ;
 39196                                  ;		M050 - Made Lie table search CASE insensitive
 39197                                  ;
 39198                                  ;		M060 - Removed special version table from the kernal and
 39199                                  ;                      put it in a device drive which puts the address
 39200                                  ;                      in the DOS DATA area location UU_IFS_DOS_CALL
 39201                                  ;		       as a DWORD.
 39202                                  ;
 39203                                  ;		M063 - Modified UMB support. If the HIGH_ONLY bit is set on
 39204                                  ;		       entry do not try to load low if there is no space in
 39205                                  ;		       UMBs.
 39206                                  ;
 39207                                  ;		M068 - Support for copy protect apps. Call ChkCopyProt to 
 39208                                  ;		       set a20off_count. Set bit EXECA20BIT in DOS_FLAG. Also
 39209                                  ;		       change return address to LeaveDos if AL=5.
 39210                                  ;
 39211                                  ;               20-Jul-1992 bens  Added ifdef RESTRICTED_BUILD code that
 39212                                  ;                      controls building a version of MSDOS.SYS that only
 39213                                  ;                      runs programs from a fixed list (defined in the
 39214                                  ;                      file RESTRICT.INC).  Search for "RESTRICTED_BUILD"
 39215                                  ;                      for details.  This feature is used to build a
 39216                                  ;                      "special" version of DOS that can be handed out to
 39217                                  ;                      OEM/ISV customers as part of a "service" disk.
 39218                                  ;
 39219                                  ; =========================================================================
 39220                                  
 39221                                  ;SAVEXIT  EQU  10
 39222                                  
 39223                                  ;BREAK	<$WAIT - return previous process error code>
 39224                                  ; =========================================================================
 39225                                  ;	$WAIT - Return previous process error code.
 39226                                  ;
 39227                                  ;	Assembler usage:
 39228                                  ;
 39229                                  ;	    MOV     AH, WaitProcess
 39230                                  ;	    INT     int_command
 39231                                  ;
 39232                                  ;	ENTRY	none
 39233                                  ;	EXIT	(ax) = exit code
 39234                                  ;	USES	all
 39235                                  ; =========================================================================
 39236                                  
 39237                                  	; 20/05/2019 - Retro DOS v4.0
 39238                                  	; DOSCODE:9B55h (MSDOS 6.21, MSDOS.SYS)
 39239                                  
 39240                                  	; 27/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 39241                                  	; DOSCODE:9A5Ah (MSDOS 5.0, MSDOS.SYS)
 39242                                  
 39243                                  	; 07/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 39244                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0AD78h	
 39245                                  
 39246                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:9B55h)
 39247                                  	; (Windows ME IO.SYS - BIOSCODE:944Ch)
 39248                                  
 39249                                  _$WAIT:
 39250                                  	; 02/08/2018 - Retro DOS v3.0
 39251                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5E1h
 39252                                  
 39253 00006884 31C0                    	xor	AX,AX
 39254 00006886 368706[3403]            	xchg	AX,[ss:exit_code]
 39255 0000688B E9DD9D                  	jmp	SYS_RET_OK
 39256                                  
 39257                                  ; =========================================================================
 39258                                  ;BREAK <$exec - load/go a program>
 39259                                  ;	EXEC.ASM - EXEC System Call
 39260                                  ;
 39261                                  ;
 39262                                  ; Assembler usage:
 39263                                  ;	    lds     DX, Name
 39264                                  ;	    les     BX, Blk
 39265                                  ;	    mov     AH, Exec
 39266                                  ;	    mov     AL, FUNC
 39267                                  ;	    int     INT_COMMAND
 39268                                  ;
 39269                                  ;	AL  Function
 39270                                  ;	--  --------
 39271                                  ;	 0  Load and execute the program.
 39272                                  ;	 1  Load, create the program header but do not
 39273                                  ;	    begin execution.
 39274                                  ;	 3  Load overlay. No header created.
 39275                                  ;
 39276                                  ;	    AL = 0 -> load/execute program
 39277                                  ;
 39278                                  ;	    +---------------------------+
 39279                                  ;	    | WORD segment address of	|
 39280                                  ;	    | environment.		|
 39281                                  ;	    +---------------------------+
 39282                                  ;	    | DWORD pointer to ASCIZ	|
 39283                                  ;	    | command line at 80h	|
 39284                                  ;	    +---------------------------+
 39285                                  ;	    | DWORD pointer to default	|
 39286                                  ;	    | FCB to be passed at 5Ch	|
 39287                                  ;	    +---------------------------+
 39288                                  ;	    | DWORD pointer to default	|
 39289                                  ;	    | FCB to be passed at 6Ch	|
 39290                                  ;	    +---------------------------+
 39291                                  ;
 39292                                  ;	    AL = 1 -> load program
 39293                                  ;
 39294                                  ;	    +---------------------------+
 39295                                  ;	    | WORD segment address of	|
 39296                                  ;	    | environment.		|
 39297                                  ;	    +---------------------------+
 39298                                  ;	    | DWORD pointer to ASCIZ	|
 39299                                  ;	    | command line at 80h	|
 39300                                  ;	    +---------------------------+
 39301                                  ;	    | DWORD pointer to default	|
 39302                                  ;	    | FCB to be passed at 5Ch	|
 39303                                  ;	    +---------------------------+
 39304                                  ;	    | DWORD pointer to default	|
 39305                                  ;	    | FCB to be passed at 6Ch	|
 39306                                  ;	    +---------------------------+
 39307                                  ;	    | DWORD returned value of	|
 39308                                  ;	    | CS:IP			|
 39309                                  ;	    +---------------------------+
 39310                                  ;	    | DWORD returned value of	|
 39311                                  ;	    | SS:IP			|
 39312                                  ;	    +---------------------------+
 39313                                  ;
 39314                                  ;	    AL = 3 -> load overlay
 39315                                  ;
 39316                                  ;	    +---------------------------+
 39317                                  ;	    | WORD segment address where|
 39318                                  ;	    | file will be loaded.	|
 39319                                  ;	    +---------------------------+
 39320                                  ;	    | WORD relocation factor to |
 39321                                  ;	    | be applied to the image.	|
 39322                                  ;	    +---------------------------+
 39323                                  ;
 39324                                  ; Returns:
 39325                                  ;	    AX = error_invalid_function
 39326                                  ;	       = error_bad_format
 39327                                  ;	       = error_bad_environment
 39328                                  ;	       = error_not_enough_memory
 39329                                  ;	       = error_file_not_found
 39330                                  ; =========================================================================
 39331                                  ;
 39332                                  ;   Revision history:
 39333                                  ;
 39334                                  ;	 A000	version 4.00  Jan. 1988
 39335                                  ;
 39336                                  ; =========================================================================
 39337                                  
 39338                                  Exec_Internal_Buffer		EQU	OPENBUF
 39339                                  Exec_Internal_Buffer_Size	EQU	(128+128+53+curdirLen)
 39340                                  
 39341                                  ; =========================================================================
 39342                                  
 39343                                  ;IF1		; warning message on buffers
 39344                                  ;%out	Please make sure that the following are contiguous and of the
 39345                                  ;%out	following sizes:
 39346                                  ;%out
 39347                                  ;%out	OpenBuf     128
 39348                                  ;%out	RenBuf	    128
 39349                                  ;%out	SearchBuf    53
 39350                                  ;%out	DummyCDS    curdirLen
 39351                                  ;ENDIF
 39352                                  
 39353                                  ; =========================================================================
 39354                                  
 39355                                  ; =========================================================================
 39356                                  ;
 39357                                  ; =========================================================================
 39358                                  
 39359                                  	; 20/05/2019 - Retro DOS v4.0
 39360                                  	; DOSCODE:9B5Fh (MSDOS 6.21, MSDOS.SYS)
 39361                                  
 39362                                  	; 30/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 39363                                  	; DOSCODE:9B04h (MSDOS 5.0, MSDOS.SYS)
 39364                                  
 39365                                  	; 08/03/2024
 39366                                  	; 07/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 39367                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0AD82h
 39368                                  
 39369                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:9B5Fh)
 39370                                  	; (Windows ME IO.SYS - BIOSCODE:946Fh)
 39371                                  
 39372                                  _$EXEC:
 39373                                  	; 02/08/2018 - Retro DOS v3.0
 39374                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 5EF1h
 39375                                  
 39376                                  EXEC001S:
 39377                                  	;LocalVar    Exec_Blk		,DWORD
 39378                                  	;LocalVar    Exec_Func		,BYTE
 39379                                  	;LocalVar    Exec_Load_High	,BYTE
 39380                                  	;LocalVar    Exec_FH		,WORD
 39381                                  	;LocalVar    Exec_Rel_Fac	,WORD
 39382                                  	;LocalVar    Exec_Res_Len_Para	,WORD
 39383                                  	;LocalVar    Exec_Environ	,WORD
 39384                                  	;LocalVar    Exec_Size		,WORD
 39385                                  	;LocalVar    Exec_Load_Block	,WORD
 39386                                  	;LocalVar    Exec_DMA		,WORD
 39387                                  	;LocalVar    ExecNameLen 	,WORD
 39388                                  	;LocalVar    ExecName		,DWORD
 39389                                  	;
 39390                                  	;LocalVar    Exec_DMA_Save	,WORD
 39391                                  	;LocalVar    Exec_NoStack	,BYTE
 39392                                  
 39393                                  	; MSDOS 3.3 (& MSDOS 6.0)
 39394                                  	;%define	Exec_Blk	dword [bp-4]
 39395                                  	%define		Exec_Blk	[bp-4] ; 09/08/2018
 39396                                  	%define		Exec_BlkL	word [bp-4]
 39397                                  	%define		Exec_BlkH	word [bp-2]
 39398                                  	%define		Exec_Func	byte [bp-5]
 39399                                  	%define		Exec_Load_High	byte [bp-6]
 39400                                  	%define		Exec_FH		word [bp-8]
 39401                                  	%define		Exec_Rel_Fac	word [bp-10]
 39402                                  	%define		Exec_Res_Len_Para word [bp-12]
 39403                                  	%define		Exec_Environ	word [bp-14]
 39404                                  	%define		Exec_Size	word [bp-16]
 39405                                  	%define		Exec_Load_Block	word [bp-18]
 39406                                  	%define		Exec_DMA	word [bp-20]
 39407                                  	%define		ExecNameLen	word [bp-22]
 39408                                  	;%define	ExecName	dword [bp-26]
 39409                                  	%define		ExecName	[bp-26] ; 09/08/2018
 39410                                  	%define		ExecNameL	word [bp-26]
 39411                                  	%define		ExecNameH	word [bp-24]
 39412                                  	; MSDOS 6.0
 39413                                  	%define		Exec_DMA_Save	word [bp-28]
 39414                                  	%define		Exec_NoStack	byte [bp-29]
 39415                                  	
 39416                                  	; ==================================================================
 39417                                  	; validate function
 39418                                  	; ==================================================================
 39419                                  		      	
 39420                                  	; M068 - Start
 39421                                  	;
 39422                                  	; Reset the A20OFF_COUNT to 0. This is done as there is a
 39423                                  	; possibility that the count may not be decremented all the way to
 39424                                  	; 0. A typical case is if the program for which we intended to keep
 39425                                  	; the A20 off for a sufficiently long time (A20OFF_COUNT int 21 
 39426                                  	; calls), exits pre-maturely due to error conditions.
 39427                                  
 39428                                  	; MSDOS 6.0
 39429 0000688E 36C606[8500]00          	mov	byte [SS:A20OFF_COUNT], 0
 39430                                  
 39431                                  	; If al=5 (ExecReady) we'll change the return address on the stack
 39432                                  	; to be LeaveDos in msdisp.asm. This ensures that the EXECA20OFF
 39433                                  	; bit set in DOS_FLAG by ExecReady is not cleared in msdisp.asm
 39434                                  
 39435 00006894 3C05                    	cmp	al,5			; Q: is this ExecReady call
 39436                                  	;jne	short @f
 39437 00006896 7505                    	jne	short Exec_@f		; N: continue
 39438                                  					; Y: change ret addr. to LeaveDos.
 39439 00006898 59                      	pop	cx			; Note CX is not input to ExecReady
 39440 00006899 B9[F603]                	mov	cx,LeaveDOS
 39441 0000689C 51                      	push	cx
 39442                                  ;@@:
 39443                                  Exec_@f:
 39444                                  	; M068 - End
 39445                                  	
 39446                                  	;Enter
 39447                                  
 39448 0000689D 55                      	push	bp
 39449 0000689E 89E5                    	mov	bp,sp
 39450                                  	;;sub	sp,26	; MSDOS 3.3
 39451                                  	; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)
 39452                                  	;sub	sp,29	; MSDOS 6.0 & MSDOS 6.22 & PCDOS 7.1 ; 07/03/2024
 39453                                  	; 17/12/2022
 39454                                  	; 20/05/2019
 39455 000068A0 83EC1E                  	sub	sp,30	; Retro DOS v4.0
 39456                                  
 39457                                  	; MSDOS 6.0
 39458 000068A3 3C05                    	cmp	AL,5			; only 0, 1, 3 or 5 are allowed ;M028
 39459                                  					; M030
 39460 000068A5 7611                    	jna	short Exec_Check_2
 39461                                  
 39462                                  	; MSDOS 3.3
 39463                                  	;cmp	AL,3
 39464                                  	;jna	short Exec_Check_2
 39465                                  
 39466                                  Exec_Bad_Fun:
 39467                                  	;mov	byte [ss:EXTERR_LOCUS],errLOC_Unk ; 1
 39468                                  					; Extended Error Locus	;smr;SS Override
 39469                                  	; 01/07/2024
 39470 000068A7 E810AA                  	call	set_exerr_locus_unk
 39471                                  
 39472                                  	;mov	al,1
 39473 000068AA B001                    	mov	al,error_invalid_function
 39474                                  
 39475                                  Exec_Ret_Err:
 39476                                  	;Leave
 39477 000068AC 89EC                    	mov	sp,bp
 39478 000068AE 5D                      	pop	bp
 39479                                  	;transfer SYS_RET_ERR
 39480 000068AF E9C39D                  	jmp	SYS_RET_ERR
 39481                                  
 39482                                  	; MSDOS 6.0
 39483                                  ExecReadyJ:
 39484 000068B2 E87B18                  	call	ExecReady		; M028
 39485 000068B5 E9F103                  	jmp	norm_ovl		; do a Leave & xfer sysret_OK ; M028
 39486                                  
 39487                                  Exec_Check_2:
 39488 000068B8 3C02                    	cmp	AL,2
 39489 000068BA 74EB                    	je	short Exec_Bad_Fun
 39490                                  
 39491                                  	; MSDOS 6.0
 39492 000068BC 3C04                    	cmp	al,4			; 2 & 4 are not allowed
 39493 000068BE 74E7                    	je	short Exec_Bad_Fun
 39494                                  	
 39495 000068C0 3C05                    	cmp	al,5			; M028 ; M030
 39496 000068C2 74EE                    	je	short ExecReadyJ	; M028
 39497                                  
 39498                                  	;mov	[bp-4],bx
 39499 000068C4 895EFC                  	mov	Exec_BlkL,BX		; stash args
 39500                                  	;mov	[bp-2],es
 39501 000068C7 8C46FE                  	mov	Exec_BlkH,ES
 39502                                  	;mov	[bp-5],al
 39503 000068CA 8846FB                  	mov	Exec_Func,AL
 39504                                  	;mov	byte [bp-6],0
 39505 000068CD C646FA00                	mov	Exec_Load_High,0
 39506                                  
 39507                                  	;mov	[bp-26],dx
 39508 000068D1 8956E6                  	mov	ExecNameL,DX		; set up length of exec name
 39509                                  	;mov	[bp-24],ds
 39510 000068D4 8C5EE8                  	mov	ExecNameH,DS
 39511 000068D7 89D6                    	mov	SI,DX			; move pointer to convenient place
 39512                                  	;invoke	DStrLen
 39513 000068D9 E8D8AE                  	call	DStrLen
 39514                                  	;mov	[bp-22],cx
 39515 000068DC 894EEA                  	mov	ExecNameLen,CX		; save length
 39516                                  
 39517                                  	; MSDOS 6.0
 39518 000068DF 36A0[0203]              	mov	al,[ss:AllocMethod]	; M063: save alloc method in 
 39519 000068E3 36A2[8400]              	mov	[ss:ALLOCMSAVE],al	; M063: AllocMsave
 39520                                  
 39521                                  	;xor	AL,AL			; open for reading
 39522                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39523                                  	;;;
 39524 000068E7 B0A0                    	mov	al,0A0h			; Access mode bits: (0 to 2)
 39525                                  					; 000  read access
 39526                                  
 39527                                  					; Sharing mode bits: (4 to 6)
 39528                                  					; 010  deny others write access
 39529                                  
 39530                                  					; bit 7 - private
 39531                                  	;;;
 39532                                  
 39533 000068E9 55                      	push	BP
 39534                                  
 39535                                  	; MSDOS 6.0
 39536                                  	;or	byte [ss:DOS_FLAG],1
 39537 000068EA 36800E[8600]01          	or	byte [ss:DOS_FLAG],EXECOPEN ; this flag is set to indicate to 
 39538                                  					; the redir that this open call is
 39539                                  					; due to an exec.
 39540                                  	
 39541                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39542                                  	;;;
 39543 000068F0 1E                      	push	ds
 39544 000068F1 52                      	push	dx
 39545                                  	;;;
 39546                                  
 39547                                  	;invoke	$OPEN			; is the file there?
 39548 000068F2 E85913                  	call	_$OPEN
 39549                                  
 39550                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39551                                  	;;;
 39552 000068F5 5A                      	pop	dx
 39553 000068F6 1F                      	pop	ds
 39554 000068F7 7305                    	jnc	short Exec_Open_Ok
 39555                                  
 39556 000068F9 30C0                    	xor	al,al			; open for reading
 39557 000068FB E85013                  	call	_$OPEN
 39558                                  
 39559                                  Exec_Open_Ok:
 39560                                  	;;;
 39561                                  
 39562                                  	; MSDOS 6.0
 39563 000068FE 9C                      	pushf
 39564                                  	; 02/06/2019
 39565                                  	;and	byte [ss:DOS_FLAG],0FEh
 39566 000068FF 368026[8600]FE          	and	byte [ss:DOS_FLAG],~EXECOPEN ; reset flag
 39567 00006905 9D                      	popf
 39568                                  
 39569 00006906 5D                      	pop	BP
 39570                                  
 39571                                  	; MSDOS 3.3 & MSDOS 6.0
 39572 00006907 72A3                    	jc	short Exec_Ret_Err
 39573                                  
 39574                                  	;mov	[bp-8],ax
 39575 00006909 8946F8                  	mov	Exec_FH,AX
 39576 0000690C 89C3                    	mov	BX,AX
 39577 0000690E 30C0                    	xor	AL,AL
 39578                                  	;invoke	$Ioctl
 39579 00006910 E813BF                  	call	_$IOCTL
 39580 00006913 7207                    	jc	short Exec_BombJ
 39581                                  
 39582                                  	;test	dl,80h
 39583 00006915 F6C280                  	test	DL,devid_ISDEV
 39584 00006918 740A                    	jz	short Exec_Check_Environ
 39585                                  
 39586                                  	;mov	al,2
 39587 0000691A B002                    	mov	AL,error_file_not_found
 39588                                  Exec_BombJ:
 39589 0000691C E9C800                  	jmp	Exec_Bomb
 39590                                  
 39591                                  BadEnv:
 39592                                  	;mov	al,0Ah
 39593 0000691F B00A                    	mov	AL,error_bad_environment
 39594 00006921 E9C300                  	jmp	Exec_Bomb
 39595                                  
 39596                                  Exec_Check_Environ:
 39597                                  	;mov	word [bp-18],0
 39598 00006924 C746EE0000              	mov	Exec_Load_Block,0
 39599                                  	;mov	word [bp-14],0
 39600 00006929 C746F20000              	mov	Exec_Environ,0
 39601                                  					; overlays... no environment
 39602                                  	;test	byte [bp-5],2
 39603 0000692E F646FB02                	test	Exec_Func,exec_func_overlay
 39604 00006932 7552                    	jnz	short Exec_Read_Header
 39605                                  
 39606                                  	;lds	si,[bp-4]
 39607 00006934 C576FC                  	lds	SI,Exec_Blk		; get block
 39608 00006937 8B04                    	mov	ax,[SI]
 39609                                  	;mov	AX,[SI+EXEC1.ENVIRON]	; address of environ
 39610 00006939 09C0                    	or	AX,AX
 39611 0000693B 750C                    	jnz	short Exec_Scan_Env
 39612                                  
 39613 0000693D 368E1E[3003]            	mov	DS,[SS:CurrentPDB]	;smr;SS Override
 39614                                  	;mov	ax,[44]
 39615 00006942 A12C00                  	mov	AX,[PDB.ENVIRON]
 39616                                  
 39617                                  ; MSDOS 6.0
 39618                                  ;---------------------------------------------BUG 92 4/30/90-----------------
 39619                                  ;
 39620                                  ; Exec_environ is being correctly initialized after the environment has been
 39621                                  ; allocated and copied form the parent's env. It must not be initialized here.
 39622                                  ; Because if the call to $alloc below fails Exec_dealloc will deallocate the
 39623                                  ; parent's environment.
 39624                                  ;	mov	Exec_Environ,AX
 39625                                  ;
 39626                                  ;----------------------------------------------------------------------------
 39627                                  
 39628                                  	;mov	[bp-14],ax
 39629                                  	;mov	Exec_Environ,ax
 39630                                  
 39631 00006945 09C0                    	or	AX,AX
 39632 00006947 743D                    	jz	short Exec_Read_Header
 39633                                  
 39634                                  Exec_Scan_Env:
 39635 00006949 8EC0                    	mov	ES,AX
 39636 0000694B 31FF                    	xor	DI,DI
 39637                                  	;mov	cx,7FFFh ; MSDOS 3.3
 39638 0000694D B90080                  	mov	CX,8000h ; MSDOS 6.0	; at most 32k of environment ;M040
 39639 00006950 30C0                    	xor	AL,AL
 39640                                  
 39641                                  Exec_Get_Environ_Len:
 39642 00006952 F2AE                    	repnz	scasb			; find that nul byte
 39643 00006954 75C9                    	jnz	short BadEnv
 39644                                  
 39645 00006956 49                      	dec	CX			; Dec CX for the next nul byte test
 39646 00006957 78C6                    	js	short BadEnv		; gone beyond the end of the environment
 39647                                  
 39648 00006959 AE                      	scasb				; is there another nul byte?
 39649 0000695A 75F6                    	jnz	short Exec_Get_Environ_Len ; no, scan some more
 39650                                  
 39651 0000695C 57                      	push	DI
 39652                                  	;lea	bx,[DI+11h]
 39653 0000695D 8D5D11                  	lea	BX,[DI+0Fh+2]
 39654                                  	;add	bx,[bp-22]
 39655 00006960 035EEA                  	add	BX,ExecNameLen		; BX <- length of environment
 39656                                  					; remember argv[0] length
 39657                                  					; round up and remember argc
 39658 00006963 B104                    	mov	CL,4
 39659 00006965 D3EB                    	shr	BX,CL			; number of paragraphs needed
 39660 00006967 06                      	push	ES
 39661                                  	;invoke	$Alloc			; can we get the space?
 39662 00006968 E82806                  	call	_$ALLOC
 39663 0000696B 1F                      	pop	DS
 39664 0000696C 59                      	pop	CX
 39665                                  
 39666                                  	;jnc	short Exec_Save_Environ
 39667                                  	;jmp	SHORT Exec_No_Mem	; nope... cry and sob
 39668                                  	; 17/12/2022
 39669 0000696D 7272                    	jc	short Exec_No_Mem ; 02/06/2019
 39670                                  	; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)
 39671                                  	;jnc	short Exec_Save_Environ
 39672                                  	;jmp	SHORT Exec_No_Mem
 39673                                  
 39674                                  Exec_Save_Environ:
 39675 0000696F 8EC0                    	mov	ES,AX
 39676                                  	;mov	[bp-14],ax
 39677 00006971 8946F2                  	mov	Exec_Environ,AX 	; save him for a rainy day
 39678 00006974 31F6                    	xor	SI,SI
 39679 00006976 89F7                    	mov	DI,SI
 39680 00006978 F3A4                    	rep	movsb			; copy the environment
 39681 0000697A B80100                  	mov	AX,1
 39682 0000697D AB                      	stosw
 39683                                  	;lds	si,[bp-26]
 39684 0000697E C576E6                  	lds	SI,ExecName
 39685                                  	;mov	cx,[bp-22]
 39686 00006981 8B4EEA                  	mov	CX,ExecNameLen
 39687 00006984 F3A4                    	rep	movsb
 39688                                  
 39689                                  Exec_Read_Header:
 39690                                  	; We read in the program header into the above data area and
 39691                                  	; determine where in this memory the image will be located.
 39692                                  
 39693                                  	;Context DS
 39694 00006986 16                      	push	ss
 39695 00006987 1F                      	pop	ds
 39696                                  	;mov	cx,26
 39697 00006988 B91A00                  	mov	CX,exec_header_len	; header size
 39698 0000698B BA[C70E]                	mov	DX,exec_signature
 39699 0000698E 06                      	push	ES
 39700 0000698F 1E                      	push	DS
 39701 00006990 E86104                  	call	ExecRead
 39702 00006993 1F                      	pop	DS
 39703 00006994 07                      	pop	ES
 39704 00006995 724E                    	jc	short Exec_Bad_File
 39705                                  
 39706 00006997 09C0                    	or	AX,AX
 39707 00006999 744A                    	jz	short Exec_Bad_File
 39708                                  	;cmp	ax,26
 39709 0000699B 83F81A                  	cmp	AX,exec_header_len	; did we read the right number?
 39710 0000699E 7519                    	jnz	short Exec_Com_Filej	; yep... continue
 39711                                  
 39712 000069A0 F706[D30E]FFFF          	test	word [exec_max_BSS],-1 	; indicate load high?
 39713 000069A6 7504                    	jnz	short Exec_Check_Sig
 39714                                  
 39715                                  	;mov	byte [bp-6],0FFh
 39716 000069A8 C646FAFF                	mov	Exec_Load_High,-1
 39717                                  
 39718                                  Exec_Check_Sig:
 39719 000069AC A1[C70E]                	mov	AX,[exec_signature]	; rms;NSS
 39720                                  	;cmp	ax,5A4Dh ; 'MZ'
 39721 000069AF 3D4D5A                  	cmp	AX,exe_valid_signature	; zibo arises!
 39722 000069B2 7408                    	jz	short Exec_Save_Start 	; assume com file if no signature
 39723                                  
 39724                                  	;cmp	ax,4D5Ah ; 'ZM'
 39725 000069B4 3D5A4D                  	cmp	AX,exe_valid_old_signature ; zibo arises!
 39726 000069B7 7403                    	jz	short Exec_Save_Start 	; assume com file if no signature
 39727                                  
 39728                                  Exec_Com_Filej:
 39729 000069B9 E9D001                  	jmp	Exec_Com_File
 39730                                  
 39731                                  	; We have the program header... determine memory requirements
 39732                                  
 39733                                  Exec_Save_Start:
 39734 000069BC A1[CB0E]                	mov	AX,[exec_pages]		; get 512-byte pages	;rms;NSS
 39735 000069BF B105                    	mov	CL,5			; convert to paragraphs
 39736 000069C1 D3E0                    	shl	AX,CL
 39737 000069C3 2B06[CF0E]              	sub	AX,[exec_par_dir] 	; AX = size in paragraphs ;rms;NSS
 39738                                  	;mov	[bp-12],ax
 39739 000069C7 8946F4                  	mov	Exec_Res_Len_Para,AX
 39740                                  
 39741                                  		; Do we need to allocate memory?
 39742                                  		; Yes if function is not load-overlay
 39743                                  
 39744                                  	;test	byte [bp-5],2
 39745 000069CA F646FB02                	test	Exec_Func,exec_func_overlay
 39746 000069CE 7443                    	jz	short Exec_Allocate	; allocation of space
 39747                                  
 39748                                  		; get load address from block
 39749                                  
 39750                                  	;les	di,[bp-4]
 39751 000069D0 C47EFC                  	les	DI,Exec_Blk
 39752                                  
 39753                                  ; 07/03/2024
 39754                                  %if 0
 39755                                  	mov	ax,[es:di]
 39756                                  	;mov	AX,[ES:DI+EXEC3.load_addr]
 39757                                  	;mov	[bp-20],ax
 39758                                  	mov	Exec_DMA,AX
 39759                                  
 39760                                  	; 17/12/2022
 39761                                  	;;mov	ax,[es:di+2]
 39762                                  	;mov	AX,[ES:DI+EXEC3.reloc_fac]
 39763                                  	;;mov	[bp-10],ax
 39764                                  	;mov	Exec_Rel_Fac,AX
 39765                                  
 39766                                  	; 17/12/2022
 39767                                  	; 30/11/2022 (!most proper code!)
 39768                                  	;mov	dx,[es:di+2]
 39769                                  	mov	dx,[ES:DI+EXEC3.reloc_fac]
 39770                                  	;mov	[bp-10],dx
 39771                                  	mov	Exec_Rel_Fac,dx
 39772                                  %else
 39773                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 39774                                  	;;;
 39775 000069D3 06                      	push	es
 39776 000069D4 26C405                  	les	ax,[es:di]
 39777                                  	;les	ax,[ES:DI+EXEC3.load_addr]
 39778                                  	;mov	[bp-20],ax
 39779 000069D7 8946EC                  	mov	Exec_DMA,ax
 39780                                  	;mov	[bp-10],es
 39781 000069DA 8C46F6                  	mov	Exec_Rel_Fac,es
 39782 000069DD 07                      	pop	es
 39783                                  	;;;
 39784                                  %endif
 39785                                  	; ax = Exec_DMA
 39786 000069DE E9DE00                  	jmp	Exec_Find_Res
 39787                                  
 39788                                  ; 17/12/2022
 39789                                  ; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)
 39790                                  ; 27/09/2023
 39791                                  %if 0
 39792                                  	; 02/06/2019 - Retro DOS v4.0
 39793                                  	;mov	ax,[bp-20]  ; *+*
 39794                                  	mov	AX,Exec_DMA ; *+*
 39795                                  	; 10/08/2018
 39796                                  	jmp	Exec_Find_Res		; M000
 39797                                  %endif
 39798                                  
 39799                                  Exec_No_Mem:
 39800                                  	;mov	al,8
 39801 000069E1 B008                    	mov	AL,error_not_enough_memory
 39802 000069E3 EB02                    	jmp	short Exec_Bomb
 39803                                  
 39804                                  Exec_Bad_File:
 39805                                  	;mov	al,0Bh
 39806 000069E5 B00B                    	mov	AL,error_bad_format
 39807                                  
 39808                                  Exec_Bomb:
 39809                                  	;mov	bx,[bp-8]
 39810 000069E7 8B5EF8                  	mov	BX,Exec_FH
 39811 000069EA E82004                  	call	Exec_Dealloc
 39812                                  	;LeaveCrit CritMem
 39813 000069ED E8C1AE                  	call	LCritMEM
 39814                                  	;save	<AX,BP>
 39815 000069F0 50                      	push	ax
 39816 000069F1 55                      	push	bp
 39817                                  	;invoke	$CLOSE
 39818 000069F2 E8FD09                  	call	_$CLOSE
 39819                                  	;restore <BP,AX>
 39820 000069F5 5D                      	pop	bp
 39821 000069F6 58                      	pop	ax
 39822 000069F7 E9B2FE                  	jmp	Exec_Ret_Err
 39823                                  
 39824                                  Exec_Chk_Mem: 
 39825                                  	; 24/09/2023
 39826                                  	; ds = DOSDATA
 39827                                  ; 17/12/2022
 39828                                  ; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)
 39829                                  ;%if 0
 39830                                  	; MSDOS 6.0    			; M063 - Start
 39831                                  	;mov	al,[ss:AllocMethod]	; save current alloc method in ax
 39832                                  	; 10/06/2019
 39833 000069FA A0[0203]                	mov	al,[AllocMethod]
 39834                                  	;mov	bl,[ss:ALLOCMSAVE]
 39835 000069FD 8A1E[8400]              	mov	bl,[ALLOCMSAVE]
 39836                                  	;mov	[ss:AllocMethod],bl	; restore original allocmethod
 39837 00006A01 881E[0203]              	mov	[AllocMethod],bl
 39838                                  	
 39839 00006A05 F6C340                  	test	bl,HIGH_ONLY ; 40h	; Q: was the HIGH_ONLY bit already set
 39840 00006A08 75D7                    	jnz	short Exec_No_Mem	; Y: no space in UMBs. Quit
 39841                                  	;				; N: continue
 39842                                  	;
 39843 00006A0A A840                    	test	al,HIGH_ONLY		; Q: did we set the HIGH_ONLY bit
 39844 00006A0C 74D3                    	jz	short Exec_No_Mem	; N: no memory
 39845                                  	; 02/06/2019
 39846                                  	;mov	ax,[ss:SAVE_AX]		; Y: restore ax and
 39847 00006A0E A1[8A00]                	mov	ax,[SAVE_AX]
 39848                                  	;jmp	short Exec_Norm_Alloc	;    Try again
 39849                                  					; M063 - End
 39850 00006A11 EB2B                    	jmp	short Exec_Norm_Alloc1
 39851                                  ;%endif
 39852                                  
 39853                                  ; 17/12/2022
 39854                                  %if 0
 39855                                  	; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)
 39856                                  	; MSDOS 6.0    			; M063 - Start
 39857                                  	mov	al,[ss:AllocMethod]	; save current alloc method in ax
 39858                                  	mov	bl,[ss:ALLOCMSAVE]
 39859                                  	mov	[ss:AllocMethod],bl	; restore original allocmethod
 39860                                  
 39861                                  	test	bl,HIGH_ONLY ; 40h	; Q: was the HIGH_ONLY bit already set
 39862                                  	jnz	short Exec_No_Mem	; Y: no space in UMBs. Quit
 39863                                  	;				; N: continue
 39864                                  	;
 39865                                  	test	al,HIGH_ONLY		; Q: did we set the HIGH_ONLY bit
 39866                                  	jz	short Exec_No_Mem	; N: no memory
 39867                                  
 39868                                  	mov	ax,[ss:SAVE_AX]		; Y: restore ax and
 39869                                  	jmp	short Exec_Norm_Alloc	;    Try again
 39870                                  					; M063 - End
 39871                                  %endif
 39872                                  
 39873                                  Exec_Allocate:
 39874                                  	; 09/09/2018
 39875                                  
 39876                                  	; M005 - START
 39877                                  	; If there is no STACK segment for this exe file and if this
 39878                                  	; not an overlay and the resident size is less than 64K - 
 39879                                  	; 256 bytes we shall add 256 bytes to the programs 
 39880                                  	; resident memory requirement and set Exec_SP to this value.
 39881                                  	
 39882                                  	; 17/12/2022
 39883 00006A13 29DB                    	sub	bx,bx ; 0
 39884                                  
 39885                                  	; MSDOS 6.0
 39886                                  	;;mov	byte [bp-29],0
 39887                                  	;mov	Exec_NoStack,0
 39888                                  	; 17/12/2022
 39889 00006A15 885EE3                  	mov	Exec_NoStack,bl ; 0
 39890 00006A18 391E[D50E]              	cmp	[exec_SS],bx ; 0
 39891                                  	;cmp	word [exec_SS],0	; Q: is there a stack seg
 39892 00006A1C 7511                    	jne	short ea1		; Y: continue normal processing
 39893 00006A1E 391E[D70E]              	cmp	[exec_SP],bx ; 0
 39894                                  	;cmp	word [exec_SP],0	; Q: is there a stack ptr
 39895 00006A22 750B                    	jne	short ea1		; Y: continue normal processing
 39896                                  
 39897                                  	;inc	byte [bp-29]
 39898 00006A24 FE46E3                  	inc	Exec_NoStack
 39899 00006A27 3DF00F                  	cmp	ax,1000h-10h ; 0FF0h	; Q: is this >= 64K-256 bytes
 39900 00006A2A 7303                    	jae	short ea1		; Y: don't set Exec_SP
 39901                                  
 39902 00006A2C 83C010                  	add	ax,10h			; add 10h paras to mem requirement
 39903                                  ea1:
 39904                                  	; M005 - END
 39905                                  
 39906                                  	; MSDOS 6.0			; M000 - start
 39907                                  	; 20/05/2019
 39908                                  	; (ds = ss = DOSDATA)
 39909 00006A2F F606[0203]80            	test	byte [AllocMethod],HIGH_FIRST ; 80h
 39910                                  					; Q: is the alloc strat high_first
 39911 00006A34 7405                    	jz	short Exec_Norm_Alloc	; N: normal allocate
 39912                                  					; Y: set high_only bit
 39913 00006A36 800E[0203]40            	or	byte [AllocMethod],HIGH_ONLY ; 40h
 39914                                  					; M000 - end
 39915                                  Exec_Norm_Alloc:
 39916 00006A3B A3[8A00]                	mov	[SAVE_AX],ax		; M000: save ax for possible 2nd
 39917                                  Exec_Norm_Alloc1:	; 02/06/2019
 39918                                  					; M000: attempt at allocating memory
 39919                                  	; MSDOS 3.3
 39920                                  	;push	ax			; M000
 39921                                  
 39922 00006A3E BBFFFF                  	mov	BX,0FFFFh		; see how much room in arena
 39923 00006A41 1E                      	push	DS
 39924                                  	;invoke	$Alloc			; should have carry set and BX has max
 39925 00006A42 E84E05                  	call	_$ALLOC
 39926 00006A45 1F                      	pop	DS
 39927                                  
 39928                                  	; MSDOS 6.0
 39929 00006A46 A1[8A00]                	mov	AX,[SAVE_AX]		; M000
 39930                                  	; MSDOS 3.3
 39931                                  	;pop	ax			; M000
 39932                                  
 39933 00006A49 83C010                  	add	AX,10h			; room for header
 39934 00006A4C 83FB11                  	cmp	BX,11h			; enough room for a header
 39935                                  	; MSDOS 6.0
 39936 00006A4F 72A9                    	jb	short Exec_Chk_Mem	; M000
 39937                                  	; MSDOS 3.3	
 39938                                  	;jb	short Exec_No_Mem
 39939                                  
 39940 00006A51 39D8                    	cmp	AX,BX			; is there enough for bare image?
 39941                                  	; MSDOS 6.0
 39942 00006A53 77A5                    	ja	short Exec_Chk_Mem	; M000
 39943                                  	; MSDOS 3.3
 39944                                  	;ja	short Exec_No_Mem
 39945                                  
 39946                                  	;test	byte [bp-6],0FFh
 39947 00006A55 F646FAFF                	test	Exec_Load_High,-1	; if load high, use max
 39948 00006A59 7518                    	jnz	short Exec_BX_Max	; use max
 39949                                  
 39950                                  	; 09/09/2018
 39951                                  
 39952 00006A5B 0306[D10E]              	add	AX,[exec_min_BSS] 	; go for min allocation;rms;NSS
 39953                                  	; MSDOS 6.0
 39954 00006A5F 7299                    	jc	short Exec_Chk_Mem	; M000
 39955                                  	; MSDOS 3.3
 39956                                  	;jc	short Exec_No_Mem
 39957                                  
 39958 00006A61 39D8                    	cmp	AX,BX			; enough space?
 39959                                  	; MSDOS 6.0
 39960 00006A63 7795                    	ja	short Exec_Chk_Mem	; M000: nope...
 39961                                  	; MSDOS 3.3
 39962                                  	;ja	short Exec_No_Mem
 39963                                  
 39964 00006A65 2B06[D10E]              	sub	AX,[exec_min_BSS] 	; rms;NSS
 39965 00006A69 0306[D30E]              	add	AX,[exec_max_BSS] 	; go for the MAX
 39966 00006A6D 7204                    	jc	short Exec_BX_Max
 39967                                  
 39968 00006A6F 39D8                    	cmp	AX,BX
 39969 00006A71 7602                    	jbe	short Exec_Got_Block
 39970                                  
 39971                                  Exec_BX_Max:
 39972 00006A73 89D8                    	mov	AX,BX
 39973                                  
 39974                                  Exec_Got_Block:
 39975                                  	; 03/08/2018 - Retro DOS v3.0
 39976                                  
 39977 00006A75 1E                      	push	DS
 39978 00006A76 89C3                    	mov	BX,AX
 39979                                  	;mov	[bp-16],bx
 39980 00006A78 895EF0                  	mov	Exec_Size,BX
 39981                                  	;invoke	$Alloc			; get the space
 39982 00006A7B E81505                  	call	_$ALLOC
 39983 00006A7E 1F                      	pop	DS
 39984                                  	; MSDOS 6.0
 39985                                  	;jc	short Exec_Chk_Mem	; M000
 39986                                  	; MSDOS 3.3
 39987                                  	;;jc	short Exec_No_Mem
 39988                                  	; 20/05/2019
 39989 00006A7F 7303                    	jnc	short ea0
 39990 00006A81 E976FF                  	jmp	Exec_Chk_Mem
 39991                                  ea0:
 39992                                  	; MSDOS 6.0
 39993 00006A84 8A0E[8400]              	mov	cl,[ALLOCMSAVE]		; M063: 
 39994 00006A88 880E[0203]              	mov	[AllocMethod],cl	; M063: restore allocmethod
 39995                                  
 39996                                  ;M029; Begin changes
 39997                                  ; This code does special handling for programs with no stack segment. If so,
 39998                                  ;check if the current block is larger than 64K. If so, we do not modify
 39999                                  ;Exec_SP. If smaller than 64K, we make Exec_SP = top of block. In either
 40000                                  ;case Exec_SS is not changed.
 40001                                  
 40002                                  	; MSDOS 6.0
 40003                                  	;cmp	byte [bp-29],0
 40004 00006A8C 807EE300                	cmp	Exec_NoStack,0
 40005                                  	;je	@f
 40006 00006A90 7412                    	je	short ea2
 40007                                  
 40008 00006A92 81FB0010                	cmp	bx,1000h		; Q: >= 64K memory block
 40009                                  	;jae	@f			; Y: Exec_SP = 0
 40010 00006A96 730C                    	jae	short ea2
 40011                                  
 40012                                  ;Make Exec_SP point at the top of the memory block
 40013                                  
 40014 00006A98 B104                    	mov	cl,4
 40015 00006A9A D3E3                    	shl	bx,cl			; get byte offset
 40016 00006A9C 81EB0001                	sub	bx,100h			; take care of PSP
 40017 00006AA0 891E[D70E]              	mov	[exec_SP],bx		; Exec_SP = top of block
 40018                                  ea2:
 40019                                  ;@@:
 40020                                  ;M029; end changes
 40021                                  
 40022                                  	;mov	[bp-18],ax
 40023 00006AA4 8946EE                  	mov	Exec_Load_Block,AX
 40024 00006AA7 83C010                  	add	AX,10h
 40025                                  	;test	byte [bp-6],0FFh
 40026 00006AAA F646FAFF                	test	Exec_Load_High,-1
 40027 00006AAE 7409                    	jz	short Exec_Use_AX	; use ax for load info
 40028                                  
 40029                                  	;add	ax,[bp-16]
 40030 00006AB0 0346F0                  	add	AX,Exec_Size		; go to end
 40031                                  	;sub	ax,[bp-12]
 40032 00006AB3 2B46F4                  	sub	AX,Exec_Res_Len_Para	; drop off header
 40033 00006AB6 83E810                  	sub	AX,10h			; drop off pdb
 40034                                  
 40035                                  Exec_Use_AX:
 40036                                  	;mov	[bp-10],ax
 40037 00006AB9 8946F6                  	mov	Exec_Rel_Fac,AX 	; new segment
 40038                                  	;mov	[bp-20],ax
 40039 00006ABC 8946EC                  	mov	Exec_DMA,AX ; *+*	; beginning of dma
 40040                                  
 40041                                  	; Determine the location in the file of the beginning of
 40042                                  	; the resident
 40043                                  
 40044                                  ; 17/12/2022
 40045                                  ; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)
 40046                                  ;%if 0
 40047                                  
 40048                                  Exec_Find_Res:
 40049                                  	; MSDOS 6.0
 40050                                  	;;mov	dx,[bp-20]
 40051                                  	;mov	DX,Exec_DMA ; *+*
 40052                                  	;;mov	[bp-28],dx
 40053                                  	;mov	Exec_DMA_Save,DX
 40054                                  
 40055                                  	; 17/12/2022
 40056                                  	; AX = Exec_DMA
 40057                                  
 40058                                  	; 02/06/2019 - Retro DOS v4.0
 40059                                  	;mov	[bp-28],ax ; *+*
 40060 00006ABF 8946E4                  	mov	Exec_DMA_Save,AX ; *+*
 40061                                  
 40062                                  ;%endif
 40063                                  
 40064                                  ; 17/12/2022
 40065                                  %if 0
 40066                                  	; 30/11/2022 (MSDOS 5.0, MSDOS.SYS compatibility)
 40067                                  Exec_Find_Res:
 40068                                  	;mov	dx,[bp-20]
 40069                                  	mov	DX,Exec_DMA ; *+*
 40070                                  	;mov	[bp-28],dx
 40071                                  	mov	Exec_DMA_Save,DX
 40072                                  %endif
 40073                                  
 40074                                  	; MSDOS 3.3 (& MSDOS 6.0)
 40075 00006AC2 8B16[CF0E]              	mov	DX,[exec_par_dir]
 40076 00006AC6 52                      	push	DX
 40077 00006AC7 B104                    	mov	CL,4
 40078 00006AC9 D3E2                    	shl	DX,CL			; low word of location
 40079 00006ACB 58                      	pop	AX
 40080 00006ACC B10C                    	mov	CL,12
 40081 00006ACE D3E8                    	shr	AX,CL			; high word of location
 40082 00006AD0 89C1                    	mov	CX,AX			; CX <- high
 40083                                  
 40084                                  		; Read in the resident image (first, seek to it)
 40085                                  	;mov	bx,[bp-8]
 40086 00006AD2 8B5EF8                  	mov	BX,Exec_FH
 40087 00006AD5 1E                      	push	DS
 40088 00006AD6 30C0                    	xor	AL,AL
 40089                                  	;invoke	$Lseek			; Seek to resident
 40090 00006AD8 E8800A                  	call	_$LSEEK
 40091 00006ADB 1F                      	pop	DS
 40092 00006ADC 7303                    	jnc	short Exec_Big_Read
 40093                                  
 40094 00006ADE E906FF                  	jmp	Exec_Bomb
 40095                                  
 40096                                  Exec_Big_Read:				; Read resident into memory
 40097                                  	;mov	bx,[bp-12]
 40098 00006AE1 8B5EF4                  	mov	BX,Exec_Res_Len_Para
 40099 00006AE4 81FB0010                	cmp	BX,1000h		; Too many bytes to read?
 40100 00006AE8 7203                    	jb	short Exec_Read_OK
 40101                                  
 40102 00006AEA BBE00F                  	mov	BX,0FE0h		; Max in one chunk FE00 bytes
 40103                                  
 40104                                  Exec_Read_OK:
 40105                                  	;sub	[bp-12],bx
 40106 00006AED 295EF4                  	sub	Exec_Res_Len_Para,BX	; We read (soon) this many
 40107 00006AF0 53                      	push	BX
 40108 00006AF1 B104                    	mov	CL,4
 40109 00006AF3 D3E3                    	shl	BX,CL			; Get count in bytes from paras
 40110 00006AF5 89D9                    	mov	CX,BX			; Count in correct register
 40111 00006AF7 1E                      	push	DS
 40112                                  	;mov	ds,[bp-20]
 40113 00006AF8 8E5EEC                  	mov	DS,Exec_DMA		; Set up read buffer
 40114                                  
 40115 00006AFB 31D2                    	xor	DX,DX
 40116 00006AFD 51                      	push	CX			; Save our count
 40117 00006AFE E8F302                  	call	ExecRead
 40118 00006B01 59                      	pop	CX			; Get old count to verify
 40119 00006B02 1F                      	pop	DS
 40120 00006B03 7248                    	jc	short Exec_Bad_FileJ
 40121                                  
 40122 00006B05 39C1                    	cmp	CX,AX			; Did we read enough?
 40123 00006B07 5B                      	pop	BX			; Get paragraph count back
 40124 00006B08 7408                    	jz	short ExecCheckEnd	; and do reloc if no more to read
 40125                                  
 40126                                  	; The read did not match the request. If we are off by 512
 40127                                  	; bytes or more then the header lied and we have an error.
 40128                                  
 40129 00006B0A 29C1                    	sub	CX,AX
 40130 00006B0C 81F90002                	cmp	CX,512
 40131 00006B10 733B                    	jae	short Exec_Bad_FileJ
 40132                                  
 40133                                  	; We've read in CX bytes... bump DTA location
 40134                                  
 40135                                  ExecCheckEnd:
 40136                                  	;add	[bp-20],bx
 40137 00006B12 015EEC                  	add	Exec_DMA,BX		; Bump dma address
 40138                                  	;test	word [bp-12],0FFFFh
 40139 00006B15 F746F4FFFF              	test	Exec_Res_Len_Para,-1
 40140 00006B1A 75C5                    	jnz	short Exec_Big_Read
 40141                                  
 40142                                  	; The image has now been read in. We must perform relocation
 40143                                  	; to the current location.
 40144                                  
 40145                                  exec_do_reloc:
 40146                                  	;mov	cx,[bp-10]
 40147 00006B1C 8B4EF6                  	mov	CX,Exec_Rel_Fac
 40148 00006B1F A1[D50E]                	mov	AX,[exec_SS]		; get initial SS ;rms;NSS
 40149 00006B22 01C8                    	add	AX,CX			; and relocate him
 40150 00006B24 A3[C10E]                	mov	[exec_init_SS],AX 	; rms;NSS
 40151                                  
 40152 00006B27 A1[D70E]                	mov	AX,[exec_SP]		; initial SP ;rms;NSS
 40153 00006B2A A3[BF0E]                	mov	[exec_init_SP],AX 	; rms;NSS
 40154                                  
 40155 00006B2D C406[DB0E]              	les	AX,[exec_IP]		; rms;NSS
 40156 00006B31 A3[C30E]                	mov	[exec_init_IP],AX 	; rms;NSS
 40157 00006B34 8CC0                    	mov	AX,ES			; rms;NSS
 40158 00006B36 01C8                    	add	AX,CX			; relocated...
 40159 00006B38 A3[C50E]                	mov	[exec_init_CS],AX 	; rms;NSS
 40160                                  
 40161 00006B3B 31C9                    	xor	CX,CX
 40162 00006B3D 8B16[DF0E]              	mov	DX,[exec_rle_table]	; rms;NSS
 40163                                  	;mov	bx,[bp-8]
 40164 00006B41 8B5EF8                  	mov	BX,Exec_FH
 40165 00006B44 1E                      	push	DS
 40166 00006B45 31C0                    	xor	AX,AX
 40167                                  	;invoke	$Lseek
 40168 00006B47 E8110A                  	call	_$LSEEK
 40169 00006B4A 1F                      	pop	DS
 40170 00006B4B 7303                    	jnc	short exec_get_entries
 40171                                  
 40172                                  Exec_Bad_FileJ:
 40173 00006B4D E995FE                  	jmp	Exec_Bad_File
 40174                                  
 40175                                  exec_get_entries:
 40176 00006B50 8B16[CD0E]              	mov	DX,[exec_rle_count]	; Number of entries left ;rms;NSS
 40177                                  
 40178                                  exec_read_reloc:
 40179 00006B54 52                      	push	DX
 40180                                  	;mov	dx,OPENBUF
 40181 00006B55 BA[BE03]                	mov	DX,Exec_Internal_Buffer
 40182                                  	;;mov	cx,388 ; MSDOS 3.3 ; (390>>2)<<2
 40183                                  	;mov	cx,396 ; MSDOS 6.0	; PCDOS 7.1 (08/03/2024)
 40184 00006B58 B98C01                  	mov	CX,((Exec_Internal_Buffer_Size)/4)*4 ; (397>>2)<<2
 40185 00006B5B 1E                      	push	DS
 40186 00006B5C E89502                  	call	ExecRead
 40187 00006B5F 07                      	pop	ES
 40188 00006B60 5A                      	pop	DX
 40189 00006B61 72EA                    	jc	short Exec_Bad_FileJ
 40190                                  
 40191                                  	;;mov	cx,97 ;  MSDOS 3.3 ; (390>>2)
 40192                                  	;mov	cx,99 ; MSDOS 6.0	; PCDOS 7.1 (08/03/2024)
 40193 00006B63 B96300                  	mov	CX,(Exec_Internal_Buffer_Size)/4 ; (397>>2)
 40194                                  					; Pointer to byte location in header
 40195                                  	;mov	di,OPENBUF
 40196 00006B66 BF[BE03]                	mov	DI,Exec_Internal_Buffer
 40197                                  	;mov	si,[bp-10]
 40198 00006B69 8B76F6                  	mov	SI,Exec_Rel_Fac 	; Relocate a single address
 40199                                  
 40200                                  exec_reloc_one:
 40201 00006B6C 09D2                    	or	DX,DX			; Any more entries?
 40202                                  	;jz	short Exec_Set_PDBJ
 40203                                  	; 07/03/2025 (miniDOS)
 40204 00006B6E 7503                    	jnz	short exec_get_addr
 40205 00006B70 E9EE00                  	jmp	Exec_Set_PDB
 40206                                  
 40207                                  exec_get_addr:
 40208 00006B73 26C51D                  	lds	BX,[ES:DI]		; Get ra/sa of entry
 40209 00006B76 8CD8                    	mov	AX,DS			; Relocate address of item
 40210                                  
 40211                                  	; MSDOS 6.0
 40212                                  ;;;;;;	add	AX,SI  ; MSDOS 3.3
 40213                                  	;add	ax,[bp-28]
 40214 00006B78 0346E4                  	add	AX,Exec_DMA_Save
 40215                                  
 40216 00006B7B 8ED8                    	mov	DS,AX
 40217 00006B7D 0137                    	add	[BX],SI
 40218 00006B7F 83C704                  	add	DI,4
 40219 00006B82 4A                      	dec	DX
 40220 00006B83 E2E7                    	loop	exec_reloc_one		; End of internal buffer?
 40221                                  
 40222                                  	; We've exhausted a single buffer's worth. Read in the next
 40223                                  	; piece of the relocation table.
 40224                                  
 40225 00006B85 06                      	push	ES
 40226 00006B86 1F                      	pop	DS
 40227 00006B87 EBCB                    	jmp	short exec_read_reloc
 40228                                  
 40229                                  
 40230                                  ; 07/03/2025
 40231                                  %if 0
 40232                                  
 40233                                  Exec_Set_PDBJ:
 40234                                  	; MSDOS 6.0
 40235                                  	
 40236                                  	; We now determine if this is a buggy exe packed file and if
 40237                                  	; so we patch in the right code. Note that fixexepatch will
 40238                                  	; point to a ret if dos loads low. The load segment as
 40239                                  	; determined above will be in exec_dma_save
 40240                                  	
 40241                                  	push	es
 40242                                  	push	ax			; M030
 40243                                  	push	cx			; M030
 40244                                  	;mov	es,[bp-28]
 40245                                  	mov	es,Exec_DMA_Save
 40246                                  	mov	ax,[ss:exec_init_CS]	; M030
 40247                                  	mov	cx,[ss:exec_init_IP]	; M030
 40248                                  	call	word [ss:FixExePatch]
 40249                                  	
 40250                                  	; 30/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 40251                                  	; (MSDOS 5.0 MSDOS.SYS does not contain 'Rational386Patch')
 40252                                  	;call	word [ss:Rational386PatchPtr]
 40253                                  	
 40254                                  	; 08/03/2024 - Retro DOS v5.0
 40255                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:9E6Fh)
 40256                                  	; (PCDOS 7.1 IBMDOS.COM - DOSCODE:0B096h) 
 40257                                  	call	word [ss:Rational386PatchPtr]
 40258                                  
 40259                                  	; 08/03/2024
 40260                                  	; (Windows ME IO.SYS - BIOSCODE:976Fh)
 40261                                  	;call	Rational386Patch
 40262                                  
 40263                                  	pop	cx			; M030
 40264                                  	pop	ax			; M030
 40265                                  	pop	es
 40266                                  
 40267                                  	jmp	Exec_Set_PDB
 40268                                  %endif
 40269                                  
 40270                                  Exec_No_Memj:
 40271 00006B89 E955FE                  	jmp	Exec_No_Mem
 40272                                  
 40273                                  	; we have a .COM file. First, determine if we are merely
 40274                                  	; loading an overlay.
 40275                                  
 40276                                  Exec_Com_File:
 40277                                  	;test	byte [bp-5],2
 40278 00006B8C F646FB02                	test	Exec_Func,exec_func_overlay
 40279 00006B90 742D                    	jz	short Exec_Alloc_Com_File
 40280                                  	;lds	si,[bp-4]
 40281 00006B92 C576FC                  	lds	SI,Exec_Blk		; get arg block
 40282 00006B95 AD                      	lodsw				; get load address
 40283                                  	;mov	[bp-20],ax
 40284 00006B96 8946EC                  	mov	Exec_DMA,AX
 40285 00006B99 B8FFFF                  	mov	AX,0FFFFh
 40286 00006B9C EB63                    	jmp	short Exec_Read_Block	; read it all!
 40287                                  
 40288                                  Exec_Chk_Com_Mem:
 40289                                  	; MSDOS 6.0	     		; M063 - Start
 40290 00006B9E 36A0[0203]              	mov	al,[ss:AllocMethod]	; save current alloc method in ax
 40291 00006BA2 368A1E[8400]            	mov	bl,[ss:ALLOCMSAVE]
 40292 00006BA7 36881E[0203]            	mov	[ss:AllocMethod],bl	; restore original allocmethod
 40293 00006BAC F6C340                  	test	bl,HIGH_ONLY ; 40h	; Q: was the HIGH_ONLY bit already set
 40294 00006BAF 75D8                    	jnz	short Exec_No_Memj	; Y: no space in UMBs. Quit
 40295                                  					; N: continue
 40296                                  	
 40297 00006BB1 A840                    	test	al,HIGH_ONLY		; Q: did we set the HIGH_ONLY bit
 40298 00006BB3 74D4                    	jz	short Exec_No_Memj	; N: no memory
 40299                                  	
 40300                                  	;mov	ax,[bp-18]
 40301 00006BB5 8B46EE                  	mov	ax,Exec_Load_Block	; M047: ax = block we just allocated
 40302 00006BB8 31DB                    	xor	bx,bx			; M047: bx => free arena
 40303 00006BBA E86C02                  	call	ChangeOwner		; M047: free this block
 40304                                  	
 40305 00006BBD EB0E                    	jmp	short Exec_Norm_Com_Alloc
 40306                                  					; M063 - End
 40307                                  	
 40308                                  	; We must allocate the max possible size block (ick!)
 40309                                  	; and set up CS=DS=ES=SS=PDB pointer, IP=100, SP=max
 40310                                  	; size of block.
 40311                                  
 40312                                  Exec_Alloc_Com_File:
 40313                                  	; MSDOS 6.0			; M000 -start
 40314 00006BBF 36F606[0203]80          	test	byte [ss:AllocMethod],HIGH_FIRST ; 80h
 40315                                  					; Q: is the alloc strat high_first
 40316 00006BC5 7406                    	jz	short Exec_Norm_Com_Alloc ; N: normal allocate
 40317                                  					; Y: set high_only bit
 40318 00006BC7 36800E[0203]40          	or	byte [ss:AllocMethod],HIGH_ONLY ; 40h
 40319                                  					; M000 - end
 40320                                  Exec_Norm_Com_Alloc:			; M000
 40321                                  	; MSDOS 3.3 (& MSDOS 6.0)
 40322 00006BCD BBFFFF                  	mov	BX,0FFFFh
 40323                                  	;invoke	$Alloc			; largest piece available as error
 40324 00006BD0 E8C003                  	call	_$ALLOC
 40325 00006BD3 09DB                    	or	BX,BX
 40326                                  	; MSDOS 6.0
 40327 00006BD5 74C7                    	jz	short Exec_Chk_Com_Mem	; M000
 40328                                  	; MSDOS 3.3
 40329                                  	;jz	short Exec_No_Memj
 40330                                  
 40331                                  	;mov	[bp-16],bx
 40332 00006BD7 895EF0                  	mov	Exec_Size,BX		; save size of allocation block
 40333 00006BDA 53                      	push	BX
 40334                                  	;invoke	$ALLOC			; largest piece available
 40335 00006BDB E8B503                  	call	_$ALLOC
 40336 00006BDE 5B                      	pop	BX			; get size of block...
 40337                                  	;mov	[bp-18],ax
 40338 00006BDF 8946EE                  	mov	Exec_Load_Block,AX
 40339                                  
 40340 00006BE2 83C010                  	add	AX,10h			; increment for header
 40341                                  	;mov	[bp-20],ax
 40342 00006BE5 8946EC                  	mov	Exec_DMA,AX
 40343                                  
 40344 00006BE8 31C0                    	xor	AX,AX			; presume 64K read...
 40345 00006BEA 81FB0010                	cmp	BX,1000h		; 64k or more in block?
 40346 00006BEE 730E                    	jae	short Exec_Read_Com	; yes, read only 64k
 40347                                  
 40348 00006BF0 89D8                    	mov	AX,BX			; convert size to bytes
 40349 00006BF2 B104                    	mov	CL,4
 40350 00006BF4 D3E0                    	shl	AX,CL
 40351                                  	; 17/12/2022
 40352                                  	; 30/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 40353                                  	;			(MSDOS 5.0, MSDOS.SYS compatibility)
 40354                                  	; MSDOS 5.0
 40355                                  	;cmp	AX,100h
 40356                                  	; 02/06/2019 - Retro DOS v4.0
 40357                                  	; MSDOS 6.0
 40358                                          ; 17/12/2022
 40359 00006BF6 3D0002                  	cmp	AX,200h                 ; enough memory for PSP and stack?
 40360 00006BF9 76A3                    	jbe	short Exec_Chk_Com_Mem	; M000: jump if not
 40361                                  	;;jbe	short Exec_No_Memj	; M000: jump if not
 40362                                  	;; Retro DOS v3.0 modification (on MSDOS 6.0 code) -03/08/2018-
 40363                                  	;;jbe	short Exec_Chk_Com_Mem	; M000: jump if not
 40364                                  	;jbe	short Exec_No_Memj	; M000: jump if not
 40365                                  
 40366                                  					; M047: size of the block is < 64K
 40367 00006BFB 2D0001                  	sub	ax,100h			; M047: reserve 256 bytes for stack
 40368                                  
 40369                                  Exec_Read_Com:
 40370                                  	; MSDOS 3.3 (& MSDOS 6.0)
 40371 00006BFE 2D0001                  	sub	AX,100h 		; remember size of psp
 40372                                  Exec_Read_Block:
 40373 00006C01 50                      	push	AX			; save number to read
 40374                                  	;mov	bx,[bp-8]
 40375 00006C02 8B5EF8                  	mov	BX,Exec_FH		; of com file
 40376 00006C05 31C9                    	xor	CX,CX			; but seek to 0:0
 40377 00006C07 31C0                    	xor	AX,AX			; seek relative to beginning
 40378                                  	;mov	DX,CX
 40379                                  	; 08/03/2024
 40380 00006C09 99                      	cwd
 40381                                  	;invoke	$Lseek			; back to beginning of file
 40382 00006C0A E84E09                  	call	_$LSEEK
 40383 00006C0D 59                      	pop	CX			; number to read
 40384                                  	;mov	ds,[bp-20]
 40385 00006C0E 8E5EEC                  	mov	DS,Exec_DMA
 40386 00006C11 31D2                    	xor	DX,DX
 40387 00006C13 51                      	push	CX
 40388 00006C14 E8DD01                  	call	ExecRead
 40389 00006C17 5E                      	pop	SI			; get number of bytes to read
 40390 00006C18 7303                    	jnc	short OkRead
 40391 00006C1A E9C8FD                  	jmp	Exec_Bad_File
 40392                                  
 40393                                  	; 10/09/2018
 40394                                  OkRead:
 40395 00006C1D 39F0                    	cmp	AX,SI			; did we read them all?
 40396                                  	; MSDOS 6.0
 40397                                  	;jz	short Exec_Chk_Com_Mem	; M00: exactly the wrong number...no
 40398                                  	; MSDOS 3.3
 40399                                  	;;jz	short Exec_No_Memj	; M00: exactly the wrong number...
 40400 00006C1F 7503                    	jne	short OkRead2
 40401 00006C21 E97AFF                  	jmp	Exec_Chk_Com_Mem
 40402                                  
 40403                                  OkRead2:
 40404                                  	; MSDOS 6.0
 40405 00006C24 368A1E[8400]            	mov	bl,[ss:ALLOCMSAVE]	; M063
 40406 00006C29 36881E[0203]            	mov	[ss:AllocMethod],bl	; M063: restore alloc method
 40407                                  
 40408                                  	; MSDOS 3.3 (& MSDOS 6.0)
 40409                                  	;test	byte [bp-5],2
 40410 00006C2E F646FB02                	test	Exec_Func,exec_func_overlay
 40411 00006C32 752D                    	jnz	short Exec_Set_PDB	; no starto, chumo!
 40412                                  
 40413                                  	;mov	ax,[bp-20]
 40414 00006C34 8B46EC                  	mov	AX,Exec_DMA
 40415 00006C37 83E810                  	sub	AX,10h
 40416 00006C3A 36A3[C50E]              	mov	[SS:exec_init_CS],AX
 40417 00006C3E 36C706[C30E]0001        	mov	word [SS:exec_init_IP],100h ; initial IP is 100h
 40418                                  
 40419                                  	; SI is AT MOST FF00h. Add FE to account for PSP - word
 40420                                  	; of 0 on stack.
 40421                                  
 40422 00006C45 81C6FE00                	add	SI,0FEh 		; make room for stack
 40423                                  
 40424                                  	; MSDOS 6.0
 40425 00006C49 83FEFE                  	cmp	si,0FFFEh		; M047: Q: was there >= 64K available
 40426 00006C4C 7404                    	je	short Exec_St_Ok	; M047: Y: stack is fine
 40427 00006C4E 81C60001                	add	si,100h			; M047: N: add the xtra 100h for stack
 40428                                  
 40429                                  Exec_St_Ok:
 40430                                  	; MSDOS 3.3 (& MSDOS 6.0)
 40431 00006C52 368936[BF0E]            	mov	[SS:exec_init_SP],SI 	; max value for read is also SP!;smr;SS Override
 40432 00006C57 36A3[C10E]              	mov	[SS:exec_init_SS],AX 					;smr;SS Override
 40433 00006C5B 8ED8                    	mov	DS,AX
 40434 00006C5D C7040000                	mov	WORD [SI],0		; 0 for return
 40435                                  
 40436                                  	; MSDOS 6.0
 40437                                  
 40438                                  	; M068
 40439                                  	;
 40440                                  	; We now determine if this is a Copy Protected App. If so the
 40441                                  	; A20OFF_COUNT is set to 6. Note that ChkCopyProt will point to
 40442                                  	; a ret if DOS is loaded low. Also DS contains the load segment.
 40443                                  
 40444                                  	; 07/03/2025 (MiniDOS 1.0)
 40445                                  	;call	word [ss:ChkCopyProt]
 40446                                  
 40447                                  Exec_Set_PDB:
 40448                                  	; MSDOS 3.3 (& MSDOS 6.0)
 40449                                  	;mov	bx,[bp-8]
 40450 00006C61 8B5EF8                  	mov	BX,Exec_FH		; we are finished with the file.
 40451 00006C64 E8A601                  	call	Exec_Dealloc
 40452 00006C67 55                      	push	BP
 40453                                  	;invoke	$Close			; release the jfn
 40454 00006C68 E88707                  	call	_$CLOSE
 40455 00006C6B 5D                      	pop	BP
 40456 00006C6C E89001                  	call	Exec_Alloc
 40457                                  	;test	byte [bp-5],2
 40458 00006C6F F646FB02                	test	Exec_Func,exec_func_overlay
 40459 00006C73 743A                    	jz	short Exec_Build_Header
 40460                                  
 40461                                  	; MSDOS 6.0
 40462 00006C75 E8BF01                  	call	Scan_Execname
 40463 00006C78 E8D301                  	call	Scan_Special_Entries
 40464                                  ;SR;
 40465                                  ;The current lie strategy uses the PSP to store the lie version. However,
 40466                                  ;device drivers are loaded as overlays and have no PSP. To handle them, we
 40467                                  ;use the Sysinit flag provided by the BIOS as part of a structure pointed at
 40468                                  ;by BiosDataPtr. If this flag is set, the overlay call has been issued from
 40469                                  ;Sysinit and therefore must be a device driver load. We then get the lie 
 40470                                  ;version for this driver and put it into the Sysinit PSP. When the driver
 40471                                  ;issues the version check, it gets the lie version until the next overlay
 40472                                  ;call is issued.
 40473                                  
 40474 00006C7B 36803E[2E12]00          	cmp	byte [ss:DriverLoad],0	;was Sysinit processing done?
 40475 00006C81 7426                    	je	short norm_ovl		;yes, no special handling
 40476 00006C83 56                      	push	si
 40477 00006C84 06                      	push	es
 40478 00006C85 36C436[2F12]            	les	si,[ss:BiosDataPtr]	;get ptr to BIOS data block
 40479                                  	 
 40480                                  	; (es:si points to 'SysinitPresent' address/flag in retrodos4.s)
 40481 00006C8A 26803C00                	cmp	byte [es:si],0		;in Sysinit?
 40482 00006C8E 7411                    	je	short sysinit_done	;no, Sysinit is finished
 40483                                  	
 40484 00006C90 368E06[3003]            	mov	es,[ss:CurrentPDB]	;es = current PSP (Sysinit PSP)
 40485 00006C95 36FF36[BB0E]            	push	word [ss:SPECIAL_VERSION]
 40486                                  	;pop	word [es:40h]	; 08/03/2024
 40487 00006C9A 268F064000              	pop	word [es:PDB.Version]	;store lie version in Sysinit PSP
 40488                                  		;;; PDB.VERSION
 40489 00006C9F EB06                    	jmp	short setver_done
 40490                                  sysinit_done:
 40491 00006CA1 36C606[2E12]00          	mov	byte [ss:DriverLoad],0	;Sysinit done,special handling off
 40492                                  setver_done:
 40493 00006CA7 07                      	pop	es
 40494 00006CA8 5E                      	pop	si
 40495                                  norm_ovl:
 40496                                  	;leave
 40497 00006CA9 89EC                    	mov	sp,bp
 40498 00006CAB 5D                      	pop	bp
 40499                                  
 40500                                  	;transfer SYS_RET_OK		; overlay load -> done
 40501 00006CAC E9BC99                  	jmp	SYS_RET_OK
 40502                                  
 40503                                  Exec_Build_Header:
 40504                                  	;mov	dx,[bp-18]
 40505 00006CAF 8B56EE                  	mov	DX,Exec_Load_Block
 40506                                  					; assign the space to the process
 40507                                  	;mov	si,1
 40508 00006CB2 BE0100                  	mov	SI,ARENA.OWNER		; pointer to owner field
 40509                                  	;mov	ax,[bp-14]
 40510 00006CB5 8B46F2                  	mov	AX,Exec_Environ 	; get environ pointer
 40511 00006CB8 09C0                    	or	AX,AX
 40512 00006CBA 7405                    	jz	short No_Owner		; no environment
 40513                                  
 40514 00006CBC 48                      	dec	AX			; point to header
 40515 00006CBD 8ED8                    	mov	DS,AX
 40516 00006CBF 8914                    	mov	[SI],DX 		; assign ownership
 40517                                  No_Owner:
 40518                                  	;mov	ax,[bp-18]
 40519                                  	;mov	AX,Exec_Load_Block	; get load block pointer
 40520                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 40521                                  	; 17/12/2022
 40522 00006CC1 89D0                    	mov	ax,dx ; 06/06/2019
 40523                                  	;mov	ax,Exec_Load_Block	; get load block pointer
 40524                                  	
 40525 00006CC3 48                      	dec	AX
 40526 00006CC4 8ED8                    	mov	DS,AX			; point to header
 40527 00006CC6 8914                    	mov	[SI],DX 		; assign ownership
 40528                                  
 40529                                  	; MSDOS 6.0
 40530 00006CC8 1E                      	push	DS			;AN000;MS. make ES=DS
 40531 00006CC9 07                      	pop	ES			;AN000;MS.
 40532                                  	;mov	di,8
 40533 00006CCA BF0800                  	mov	DI,ARENA.NAME		;AN000;MS. ES:DI points to destination
 40534 00006CCD E86701                  	call	Scan_Execname		;AN007;MS. parse execname
 40535                                  					;	   ds:si->name, cx=name length
 40536 00006CD0 51                      	push	CX			;AN007;;MS. save for fake version
 40537 00006CD1 56                      	push	SI			;AN007;;MS. save for fake version
 40538                                  
 40539                                  MoveName:				;AN000;
 40540 00006CD2 AC                      	lodsb				;AN000;;MS. get char
 40541 00006CD3 3C2E                    	cmp	AL,'.'			;AN000;;MS. is '.', may be name.exe
 40542 00006CD5 7408                    	jz	short Mem_Done		;AN000;;MS. no, move to header
 40543                                  					;AN000;
 40544 00006CD7 AA                      	stosb				;AN000;;MS. move char
 40545                                  					; MSKK bug fix - limit length copied
 40546 00006CD8 83FF10                  	cmp	di,16 ; ARENAHEADERSIZE	; end of memory arena block?
 40547 00006CDB 7302                    	jae	short Mem_Done		; jump if so
 40548                                  	;
 40549 00006CDD E2F3                    	loop	MoveName		;AN000;;MS. continue
 40550                                  Mem_Done:				;AN000;
 40551 00006CDF 30C0                    	xor	AL,AL			;AN000;;MS. make ASCIIZ
 40552                                  	;cmp	di,16
 40553 00006CE1 83FF10                  	cmp	DI,ARENAHEADERSIZE ; 16 ;AN000;MS. if not all filled
 40554 00006CE4 7301                    	jae	short Fill8		;AN000;MS.
 40555                                  	
 40556 00006CE6 AA                      	stosb				;AN000;MS.
 40557                                  	
 40558                                  Fill8:					;AN000;
 40559 00006CE7 5E                      	pop	SI			;AN007;MS. ds:si -> file name
 40560 00006CE8 59                      	pop	CX			;AN007;MS.
 40561                                  	
 40562 00006CE9 E86201                  	call	Scan_Special_Entries	;AN007;MS.
 40563                                  
 40564                                  	; MSDOS 3.3 (& MSDOS 6.0)
 40565 00006CEC 52                      	push	DX
 40566                                  	;mov	si,[bp-16]
 40567 00006CED 8B76F0                  	mov	SI,Exec_Size
 40568 00006CF0 01D6                    	add	SI,DX
 40569                                  	;Invoke	$Dup_PDB		; ES is now PDB
 40570 00006CF2 E826A9                  	call	_$DUP_PDB
 40571 00006CF5 5A                      	pop	DX
 40572                                  
 40573                                  	;push	word [bp-14]
 40574 00006CF6 FF76F2                  	push	Exec_Environ
 40575                                  	;pop	WORD [ES:2Ch]
 40576 00006CF9 268F062C00              	pop	word [ES:PDB.ENVIRON]
 40577                                  
 40578                                  	; MSDOS 6.0			; *** Added for DOS 5.00
 40579                                  					; version number in PSP
 40580 00006CFE 36FF36[BB0E]             	push	word [ss:SPECIAL_VERSION] ; Set the DOS version number to
 40581 00006D03 268F064000              	pop	word [ES:PDB.Version]	; to be used for this application
 40582                                  		; PDB.VERSION
 40583                                  
 40584                                  	; MSDOS 3.3 (& MSDOS 6.0)	; set up proper command line stuff
 40585                                  	;lds	si,[bp-4]
 40586 00006D08 C576FC                  	lds	SI,Exec_Blk		; get the block
 40587 00006D0B 1E                      	push	DS			; save its location
 40588 00006D0C 56                      	push	SI
 40589                                  	;lds	si,[si+6]
 40590 00006D0D C57406                  	lds	SI,[SI+EXEC0.5C_FCB]	; get the 5c fcb
 40591                                  
 40592                                  	; DS points to user space 5C FCB
 40593                                  
 40594 00006D10 B90C00                  	mov	CX,12			; copy drive, name and ext
 40595 00006D13 51                      	push	CX
 40596 00006D14 BF5C00                  	mov	DI,5Ch
 40597 00006D17 8A1C                    	mov	BL,[SI]
 40598 00006D19 F3A4                    	rep	movsb
 40599                                  
 40600                                  	; DI = 5Ch + 12 = 5Ch + 0Ch = 68h
 40601                                  
 40602                                  	;xor	AX,AX			; zero extent, etc for CPM
 40603 00006D1B 91                      	xchg	ax,cx	; 08/03/2024
 40604 00006D1C AB                      	stosw
 40605 00006D1D AB                      	stosw
 40606                                  
 40607                                  	; DI = 5Ch + 12 + 4 = 5Ch + 10h = 6Ch
 40608                                  
 40609 00006D1E 59                      	pop	CX
 40610 00006D1F 5E                      	pop	SI			; get block
 40611 00006D20 1F                      	pop	DS
 40612 00006D21 1E                      	push	DS			; save (again)
 40613 00006D22 56                      	push	SI
 40614                                  	;lds	si,[si+0Ah]
 40615 00006D23 C5740A                  	lds	SI,[SI+EXEC0.6C_FCB]	; get 6C FCB
 40616                                  
 40617                                  	; DS points to user space 6C FCB
 40618                                  
 40619 00006D26 8A3C                    	mov	BH,[SI] 		; do same as above
 40620 00006D28 F3A4                    	rep	movsb
 40621 00006D2A AB                      	stosw
 40622 00006D2B AB                      	stosw
 40623 00006D2C 5E                      	pop	SI			; get block (last time)
 40624 00006D2D 1F                      	pop	DS
 40625                                  	;ld	si,[si+2]
 40626 00006D2E C57402                  	lds	SI,[SI+EXEC0.COM_LINE]	; command line
 40627                                  
 40628                                  	; DS points to user space 80 command line
 40629                                  
 40630 00006D31 80C980                  	or	CL,80h
 40631 00006D34 89CF                    	mov	DI,CX
 40632 00006D36 F3A4                    	rep	movsb			; Wham!
 40633                                  
 40634                                  	; Process BX into default AX (validity of drive specs on args).
 40635                                  	; We no longer care about DS:SI.
 40636                                  
 40637 00006D38 FEC9                    	dec	CL			; get 0FFh in CL
 40638 00006D3A 88F8                    	mov	AL,BH
 40639 00006D3C 30FF                    	xor	BH,BH
 40640                                  	;invoke	GetVisDrv
 40641 00006D3E E8B50A                  	call	GetVisDrv
 40642 00006D41 7302                    	jnc	short Exec_BL
 40643                                  
 40644 00006D43 88CF                    	mov	BH,CL
 40645                                  
 40646                                  Exec_BL:
 40647 00006D45 88D8                    	mov	AL,BL
 40648 00006D47 30DB                    	xor	BL,BL
 40649                                  	;invoke	GetVisDrv
 40650 00006D49 E8AA0A                  	call	GetVisDrv
 40651 00006D4C 7302                    	jnc	short Exec_Set_Return
 40652                                  
 40653 00006D4E 88CB                    	mov	BL,CL
 40654                                  
 40655                                  Exec_Set_Return:
 40656                                  	;invoke	Get_User_Stack			; get his return address
 40657 00006D50 E82497                  	call	Get_User_Stack
 40658                                  
 40659                                  ; 08/03/2024
 40660                                  %if 0
 40661                                  	;push	word [si+14h]
 40662                                  	push	word [SI+user_env.user_CS]	; suck out the CS and IP
 40663                                  	;push	word [si+12h]
 40664                                  	push	word [SI+user_env.user_IP]
 40665                                  	;push	word [si+14h]
 40666                                  	push	word [SI+user_env.user_CS]	; suck out the CS and IP
 40667                                  	;push	word [si+12h]
 40668                                  	push	word [SI+user_env.user_IP]
 40669                                  	;pop	word [ES:0Ah]
 40670                                  	pop	WORD [ES:PDB.EXIT]
 40671                                  	;pop	word [ES:0Ch]
 40672                                  	pop	WORD [ES:PDB.EXIT+2]
 40673                                  %else
 40674                                  	; 07/03/2024 (PCDOS 7.1 IBMDOS.COM)
 40675                                  	;;;
 40676                                  	;lds	ax,[si+12h]
 40677 00006D53 C54412                  	lds	ax,[SI+user_env.user_IP] ; suck out the CS and IP
 40678 00006D56 1E                      	push	ds              
 40679 00006D57 50                      	push	ax
 40680                                  	;mov	[es:0Ah],ax
 40681 00006D58 26A30A00                	mov	[ES:PDB.EXIT],ax
 40682                                  	;mov	[es:0Ch],ds
 40683 00006D5C 268C1E0C00              	mov	[ES:PDB.EXIT+2],ds
 40684                                  	;;;
 40685                                  %endif
 40686                                  	
 40687 00006D61 31C0                    	xor	AX,AX
 40688 00006D63 8ED8                    	mov	DS,AX
 40689                                  					; save them where we can get them
 40690                                  					; later when the child exits.
 40691                                  	;pop	word [88h]
 40692 00006D65 8F068800                	pop	word [addr_int_terminate] ; 22h*4
 40693                                  	;pop	word [90h]
 40694 00006D69 8F068A00                	pop	word [addr_int_terminate+2] ; (22h*4)+2
 40695                                  
 40696 00006D6D 36C706[2C03]8000        	mov	WORD [SS:DMAADD],80h	; SS Override
 40697 00006D74 368E1E[3003]            	mov	DS,[SS:CurrentPDB]	; SS Override
 40698 00006D79 368C1E[2E03]            	mov	[SS:DMAADD+2],DS	; SS Override
 40699                                  
 40700                                  	;test	byte [bp-5],1
 40701 00006D7E F646FB01                	test	Exec_Func,exec_func_no_execute
 40702 00006D82 7427                    	jz	short exec_go
 40703                                  
 40704 00006D84 36C536[BF0E]            	lds	SI,[SS:exec_init_SP]	; get stack SS Override
 40705                                  	;les	di,[bp-4]
 40706 00006D89 C47EFC                  	les	DI,Exec_Blk		; and block for return
 40707                                  	;mov	[es:di+10h],ds
 40708 00006D8C 268C5D10                	mov	[ES:DI+EXEC1.SS],DS	; return SS
 40709                                  
 40710 00006D90 4E                      	dec	SI			; 'push' default AX
 40711 00006D91 4E                      	dec	SI
 40712 00006D92 891C                    	mov	[SI],BX 		; save default AX reg
 40713                                  	;mov	[es:di+0Eh], si
 40714 00006D94 2689750E                	mov	[ES:DI+EXEC1.SP],SI	; return 'SP'
 40715                                  
 40716 00006D98 36C506[C30E]            	lds	AX,[SS:exec_init_IP]	; SS Override
 40717                                  	;mov	[es:di+14h],ds
 40718 00006D9D 268C5D14                	mov	[ES:DI+EXEC1.CS],DS	; initial entry stuff
 40719                                  	;mov	[es:di+12h],ax
 40720 00006DA1 26894512                	mov	[ES:DI+EXEC1.IP],AX
 40721                                  	
 40722                                  	;leave
 40723 00006DA5 89EC                    	mov	sp,bp
 40724 00006DA7 5D                      	pop	bp
 40725                                  
 40726                                  	;transfer SYS_RET_OK
 40727 00006DA8 E9C098                  	jmp	SYS_RET_OK
 40728                                  
 40729                                  exec_go:
 40730 00006DAB 36C536[C30E]            	lds	SI,[SS:exec_init_IP]	; get entry point SS Override
 40731 00006DB0 36C43E[BF0E]            	les	DI,[SS:exec_init_SP]	; new stack SS Override
 40732 00006DB5 8CC0                    	mov	AX,ES
 40733                                  
 40734                                  	; MSDOS 6.0
 40735 00006DB7 36803E[660D]00          	cmp	byte [SS:DosHasHMA],0	; Q: is dos in HMA (M021)
 40736 00006DBD 741A                    	je	short Xfer_To_User	; N: transfer control to user
 40737                                  
 40738 00006DBF 1E                      	push	ds			; Y: control must go to low mem stub
 40739                                  		
 40740 00006DC0 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]		;  where we disable a20 and Xfer 
 40741                                  					;  control to user 
 40742 00006DC5 800E[8600]04            	or	byte [DOS_FLAG],EXECA20OFF ; M068:
 40743                                  					; M004: Set bit to signal int 21
 40744                                  					; ah = 25 & ah= 49. See dossym.inc 
 40745                                  					; under TAG M003 & M009 for 
 40746                                  					; explanation
 40747 00006DCA 8916[6300]              	mov	[A20OFF_PSP],dx		; M068: set the PSP for which A20 is
 40748                                  					; M068: going to be turned OFF.
 40749                                  	
 40750 00006DCE 8CD8                    	mov	ax,ds			; ax = segment of low mem stub
 40751 00006DD0 1F                      	pop	ds
 40752                                  	
 40753 00006DD1 50                      	push	ax			; ret far into the low mem stub
 40754 00006DD2 B8[F80F]                	mov	ax,disa20_xfer
 40755 00006DD5 50                      	push	ax
 40756 00006DD6 8CC0                    	mov	AX,ES			; restore ax
 40757 00006DD8 CB                      	retf
 40758                                  
 40759                                  Xfer_To_User:
 40760                                  	; DS:SI points to entry point
 40761                                  	; AX:DI points to initial stack
 40762                                  	; DX has PDB pointer
 40763                                  	; BX has initial AX value
 40764                                  
 40765 00006DD9 FA                      	cli
 40766                                  	; 15/08/2018
 40767 00006DDA 36C606[2103]00          	mov	BYTE [SS:INDOS],0	; SS Override
 40768                                  	; 01/07/2024
 40769 00006DE0 36C606[C411]00          	mov	byte [ss:INDOS_FLAG],0
 40770                                  
 40771 00006DE6 8ED0                    	mov	SS,AX			; set up user's stack
 40772 00006DE8 89FC                    	mov	SP,DI			; and SP
 40773 00006DEA FB                      	sti
 40774                                  
 40775 00006DEB 1E                      	push	DS			; fake long call to entry
 40776 00006DEC 56                      	push	SI
 40777 00006DED 8EC2                    	mov	ES,DX			; set up proper seg registers
 40778 00006DEF 8EDA                    	mov	DS,DX
 40779 00006DF1 89D8                    	mov	AX,BX			; set up proper AX
 40780                                  
 40781 00006DF3 CB                      	retf
 40782                                  
 40783                                  ; 04/08/2018 - Retro DOS v3.0
 40784                                  
 40785                                  ;----------------------------------------------------------------------------
 40786                                  ;
 40787                                  ;----------------------------------------------------------------------------
 40788                                  
 40789                                  ExecRead:
 40790 00006DF4 E81600                  	CALL	Exec_Dealloc
 40791                                  	;mov	bx,[bp-8]
 40792 00006DF7 8B5EF8                  	MOV	bx,Exec_FH
 40793                                  
 40794 00006DFA 55                      	PUSH	BP
 40795 00006DFB E8FB06                  	call	_$READ
 40796 00006DFE 5D                      	POP	BP
 40797                                  
 40798                                  	;CALL	Exec_Alloc
 40799                                  	;retn
 40800                                  	; 18/12/2022
 40801                                  	;jmp	short Exec_Alloc
 40802                                  
 40803                                  ; 18/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS) 
 40804                                  
 40805                                  ;----------------------------------------------------------------------------
 40806                                  ;
 40807                                  ;----------------------------------------------------------------------------
 40808                                  
 40809                                  Exec_Alloc:
 40810 00006DFF 53                      	push	BX
 40811                                  	;mov	BX,[CS:CurrentPDB]  ; MSDOS 3.3
 40812                                  	; 20/05/2019 - Retro DOS v4.0
 40813                                  	; MSDOS 6.0
 40814 00006E00 368B1E[3003]            	mov	bx,[SS:CurrentPDB]  ; SS Override
 40815 00006E05 E81000                  	call	ChangeOwners
 40816 00006E08 E8A6AA                  	call	LCritMEM
 40817 00006E0B 5B                      	pop	BX
 40818 00006E0C C3                      	retn
 40819                                  
 40820                                  ;----------------------------------------------------------------------------
 40821                                  ;
 40822                                  ;----------------------------------------------------------------------------
 40823                                  
 40824                                  Exec_Dealloc:
 40825 00006E0D 53                      	push	BX
 40826                                  	;mov	bx,0
 40827 00006E0E 29DB                    	sub	BX,BX		; (bx) = ARENA_OWNER_SYSTEM
 40828 00006E10 E871AA                  	call	ECritMEM
 40829 00006E13 E80200                  	call	ChangeOwners
 40830 00006E16 5B                      	pop	BX
 40831 00006E17 C3                      	retn
 40832                                  
 40833                                  ; 18/12/2022
 40834                                  %if 0
 40835                                  ;----------------------------------------------------------------------------
 40836                                  ;
 40837                                  ;----------------------------------------------------------------------------
 40838                                  
 40839                                  Exec_Alloc:
 40840                                  	push	BX
 40841                                  	;mov	BX,[CS:CurrentPDB]  ; MSDOS 3.3
 40842                                  	; 20/05/2019 - Retro DOS v4.0
 40843                                  	; MSDOS 6.0
 40844                                  	mov	bx,[SS:CurrentPDB]  ; SS Override
 40845                                  	call	ChangeOwners
 40846                                  	call	LCritMEM
 40847                                  	pop	BX
 40848                                  	retn
 40849                                  
 40850                                  %endif
 40851                                  
 40852                                  ;----------------------------------------------------------------------------
 40853                                  ;
 40854                                  ;----------------------------------------------------------------------------
 40855                                  
 40856                                  ChangeOwners:
 40857 00006E18 9C                      	pushf
 40858 00006E19 50                      	push	AX
 40859                                  	;mov	ax,[bp-14]
 40860 00006E1A 8B46F2                  	mov	AX,Exec_Environ
 40861 00006E1D E80900                  	call	ChangeOwner
 40862                                  	;mov	ax,[bp-18]
 40863 00006E20 8B46EE                  	mov	AX,Exec_Load_Block
 40864 00006E23 E80300                  	call	ChangeOwner
 40865 00006E26 58                      	pop	AX
 40866 00006E27 9D                      	popf
 40867                                  chgown_retn:
 40868 00006E28 C3                      	retn
 40869                                  
 40870                                  ;----------------------------------------------------------------------------
 40871                                  ;
 40872                                  ;----------------------------------------------------------------------------
 40873                                  
 40874                                  ChangeOwner:
 40875 00006E29 09C0                    	or	AX,AX			; is area allocated?
 40876 00006E2B 74FB                    	jz	short chgown_retn	; no, do nothing
 40877 00006E2D 48                      	dec	AX
 40878 00006E2E 1E                      	push	DS
 40879 00006E2F 8ED8                    	mov	DS,AX
 40880 00006E31 891E0100                	mov	[ARENA.OWNER],BX
 40881 00006E35 1F                      	pop	DS
 40882 00006E36 C3                      	retn
 40883                                  
 40884                                  ;----------------------------------------------------------------------------
 40885                                  ;
 40886                                  ;----------------------------------------------------------------------------
 40887                                  
 40888                                  ; 20/05/2019 - Retro DOS v4.0
 40889                                  
 40890                                  	; MSDOS 6.0
 40891                                  Scan_Execname:
 40892                                  	;lds	si,[bp-26] ; 08/03/2024
 40893 00006E37 C576E6                  	lds	SI,ExecName		; DS:SI points to name
 40894                                  Scan_Execname1:				; M028
 40895                                  Save_Begin:				;
 40896 00006E3A 89F1                    	mov	CX,SI			; CX= starting addr
 40897                                  Scan0:					;
 40898 00006E3C AC                      	lodsb				; get char
 40899                                  
 40900 00006E3D 3C3A                    	cmp	AL,':'			; is ':' , may be A:name
 40901 00006E3F 74F9                    	jz	short Save_Begin	; yes, save si
 40902 00006E41 3C5C                    	cmp	AL,'\'                  ; is '\', may be A:\name
 40903 00006E43 74F5                    	jz	short Save_Begin	; yes, save si
 40904 00006E45 3C00                    	cmp	AL,0			; is end of name
 40905 00006E47 75F3                    	jnz	short Scan0		; no, continue scanning
 40906 00006E49 29CE                    	sub	SI,CX			; get name's length
 40907 00006E4B 87CE                    	xchg	SI,CX			; cx= length, si= starting addr
 40908                                  
 40909 00006E4D C3                      	retn
 40910                                  
 40911                                  ;----------------------------------------------------------------------------
 40912                                  ;
 40913                                  ;----------------------------------------------------------------------------
 40914                                  
 40915                                  ; 20/05/2019 - Retro DOS v4.0
 40916                                  
 40917                                  ; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 40918                                  ; DOSCODE:A0EDh (MSDOS 5.0, MSDOS.SYS)
 40919                                  
 40920                                  ; 09/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 40921                                  ; DOSCODE:B370h (PCDOS 7.1, IBMDOS.COM)
 40922                                  
 40923                                  	; MSDOS 6.0
 40924                                  
 40925                                  Scan_Special_Entries:
 40926                                  
 40927 00006E4E 49                      	dec	CX			; cx= name length
 40928                                  ;M060	mov	DI,[Special_Entries]	; es:di -> addr of special entries
 40929                                  					;reset to current version
 40930                                  	;mov	word [ss:SPECIAL_VERSION],1406h 
 40931                                  				; (MSDOS 6.21, MSDOS.SYS, DOSCODE:A14Eh)
 40932                                  	;mov	word [ss:SPECIAL_VERSION],5
 40933                                  				; (MSDOS 5.0, MSDOS.SYS, DOSCODE:A0EEh)
 40934                                  
 40935                                  				; 5 for Retro DOS 4.0 (01/12/2022, MSDOS 5.0)
 40936 00006E4F 36C706[BB0E]070A        	mov	word [ss:SPECIAL_VERSION],(MINOR_VERSION<<8)+MAJOR_VERSION
 40937                                  				; 0005h for Retro DOS v4.1 (MSDOS 5.0)
 40938                                  				; 24/09/2023
 40939                                  				; 1606h for Retro DOS v4.2 (MSDOS 6.22)
 40940                                  
 40941                                  				; 09/03/2024
 40942                                  				; 0A07h	for Retro DOS v5.0 (PCDOS 7.1)
 40943                                  				; (0008h for Windows ME)
 40944                                  				
 40945                                  ;***	call	Reset_Version
 40946                                  
 40947                                  ;M060	push	SS
 40948                                  ;M060	pop	ES
 40949                                  
 40950 00006E56 36C43E[5D00]            	les	DI,[SS:UU_IFS_DOS_CALL]	;M060; ES:DI --> Table in SETVER.SYS
 40951 00006E5B 8CC0                    	mov	AX,ES			;M060; First do a NULL ptr check to
 40952 00006E5D 09F8                    	or	AX,DI			;M060; be sure the table exists
 40953 00006E5F 7427                    	jz	short End_List		;M060; If ZR then no table
 40954                                  
 40955                                  GetEntries:
 40956 00006E61 268A05                  	mov	AL,[ES:DI]		; end of list
 40957 00006E64 08C0                    	or	AL,AL
 40958 00006E66 7420                    	jz	short End_List		; yes
 40959                                  
 40960 00006E68 36893E[0E06]            	mov	[ss:TEMP_VAR2],DI	; save di
 40961 00006E6D 38C8                    	cmp	AL,CL			; same length ?
 40962 00006E6F 751B                    	jnz	short SkipOne 		; no
 40963                                  
 40964 00006E71 47                      	inc	DI			; es:di -> special name
 40965 00006E72 51                      	push	CX			; save length and name addr
 40966 00006E73 56                      	push	SI
 40967                                  
 40968                                  ; M050 - BEGIN
 40969                                  
 40970 00006E74 50                      	push	ax			; save len
 40971                                  sse_next_char:
 40972 00006E75 AC                      	lodsb
 40973 00006E76 E8C4EB                  	call	UCase
 40974 00006E79 AE                      	scasb
 40975 00006E7A 750D                    	jne	short Not_Matched
 40976 00006E7C E2F7                    	loop	sse_next_char
 40977                                  	
 40978                                  ;	repz	cmpsb			; same name ?
 40979                                  ;	jnz	short Not_Matched	; no
 40980                                  
 40981                                  	; 09/03/2024 - PCDOS 7.1 IBMDOS.COM
 40982                                  	;pop	ax			; take len off the stack
 40983                                  
 40984                                  ; M050 - END
 40985                                  
 40986 00006E7E 268B05                  	mov	AX,[ES:DI]		; get special version
 40987 00006E81 36A3[BB0E]              	mov	[ss:SPECIAL_VERSION],AX	; save it
 40988                                  
 40989                                  ;***	mov	AL,[ES:DI+2]		; get fake count
 40990                                  ;***	mov	[ss:FAKE_COUNT],AL 	; save it
 40991                                  
 40992                                  	; 09/03/2024 - PCDOS 7.1 IBMDOS.COM
 40993 00006E85 58                      	pop	ax			; take len off the stack
 40994                                  
 40995 00006E86 5E                      	pop	SI
 40996 00006E87 59                      	pop	CX
 40997                                  	; 18/12/2022
 40998                                  	;jmp	SHORT End_List
 40999                                  
 41000                                  	; 18/12/2022
 41001                                  End_List:
 41002 00006E88 C3                      	retn
 41003                                  
 41004                                  Not_Matched:
 41005 00006E89 58                      	pop	ax			; get len from stack ; M050
 41006 00006E8A 5E                      	pop	SI			; restore si,cx
 41007 00006E8B 59                      	pop	CX
 41008                                  
 41009                                  SkipOne:
 41010 00006E8C 368B3E[0E06]            	mov	DI,[ss:TEMP_VAR2]	; restore old di use SS Override
 41011 00006E91 30E4                    	xor	AH,AH			; position to next entry
 41012 00006E93 01C7                    	add	DI,AX
 41013                                  
 41014 00006E95 83C703                  	add	DI,3			; DI -> next entry length
 41015                                  ;***	add	DI,4			; DI -> next entry length
 41016                                  
 41017 00006E98 EBC7                    	jmp	short GetEntries
 41018                                  
 41019                                  	; 18/12/2022
 41020                                  ;End_List:
 41021                                  	;retn
 41022                                  
 41023                                  ; 04/08/2018 - Retro DOS v3.0
 41024                                  ; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 633Dh
 41025                                  
 41026                                  ;----------------------------------------------------------------------------
 41027                                  ;SUBTTL Terminate and stay resident handler
 41028                                  ;
 41029                                  ; Input:    DX is an offset from CurrentPDB at which to
 41030                                  ;	    truncate the current block.
 41031                                  ;
 41032                                  ; output:   The current block is truncated (expanded) to be [DX+15]/16
 41033                                  ;	    paragraphs long. An exit is simulated via resetting CurrentPDB
 41034                                  ;	    and restoring the vectors.
 41035                                  ;
 41036                                  ;----------------------------------------------------------------------------
 41037                                  
 41038                                  	; 20/05/2019 - Retro DOS v4.0
 41039                                  	; DOSCODE:A19Bh (MSDOS 6.21, MSDOS.SYS)
 41040                                  
 41041                                  	; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS5.0 MSDOS.SYS)
 41042                                  	; DOSCODE:A13Bh (MSDOS 5.0, MSDOS.SYS)
 41043                                  
 41044                                  	; 09/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 41045                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B3BCh
 41046                                  
 41047                                  _$KEEP_PROCESS:
 41048 00006E9A 50                      	push	AX			; keep exit code around
 41049                                  	;mov	byte [SS:EXIT_TYPE],3
 41050 00006E9B 36C606[7C05]03          	mov	BYTE [SS:EXIT_TYPE],EXIT_KEEP_PROCESS
 41051 00006EA1 368E06[3003]            	mov	ES,[SS:CurrentPDB]
 41052 00006EA6 83FA06                  	cmp	DX,6h			; keep enough space around for system
 41053 00006EA9 7303                    	jae	short Keep_Shrink	; info
 41054                                  
 41055 00006EAB BA0600                  	mov	DX,6h
 41056                                  
 41057                                  Keep_Shrink:
 41058 00006EAE 89D3                    	mov	BX,DX
 41059 00006EB0 53                      	push	BX
 41060 00006EB1 06                      	push	ES
 41061 00006EB2 E82F02                  	call	_$SETBLOCK		; ignore return codes.
 41062 00006EB5 1F                      	pop	DS
 41063 00006EB6 5B                      	pop	BX
 41064 00006EB7 7207                    	jc	short Keep_Done		; failed on modification
 41065                                  
 41066 00006EB9 8CD8                    	mov	AX,DS
 41067 00006EBB 01D8                    	add	AX,BX
 41068                                  	;mov	[2],ax
 41069 00006EBD A30200                  	mov	[PDB.BLOCK_LEN],AX	;PBUGBUG
 41070                                  
 41071                                  Keep_Done:
 41072 00006EC0 58                      	pop	AX
 41073 00006EC1 EB26                    	jmp	SHORT exit_inner	; and let abort take care of the rest
 41074                                  
 41075                                  ;----------------------------------------------------------------------------
 41076                                  ;
 41077                                  ;----------------------------------------------------------------------------
 41078                                  
 41079                                  STAY_RESIDENT:
 41080                                  	;mov	ax,3100h
 41081 00006EC3 B80031                  	mov	AX,(KEEP_PROCESS<<8)+0 ; Lower part is return code;PBUGBUG
 41082 00006EC6 83C20F                  	add	DX,15
 41083 00006EC9 D1DA                    	rcr	DX,1
 41084 00006ECB B103                    	mov	CL,3
 41085 00006ECD D3EA                    	shr	DX,CL
 41086                                  
 41087 00006ECF E91F94                  	jmp	COMMAND
 41088                                  
 41089                                  ;----------------------------------------------------------------------------
 41090                                  ;SUBTTL $EXIT - return to parent process
 41091                                  ;   Assembler usage:
 41092                                  ;	    MOV     AL, code
 41093                                  ;	    MOV     AH, Exit
 41094                                  ;	    INT     int_command
 41095                                  ;   Error return:
 41096                                  ;	    None.
 41097                                  ;
 41098                                  ;----------------------------------------------------------------------------
 41099                                  
 41100                                  	; 20/05/2019 - Retro DOS v4.0
 41101                                  	; DOSCODE:A1D3h (MSDOS 6.21, MSDOS.SYS)
 41102                                  
 41103                                  	; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS5.0 MSDOS.SYS)
 41104                                  	; DOSCODE:A173h (MSDOS 5.0, MSDOS.SYS)
 41105                                  
 41106                                  	; 09/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 41107                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B3F4h
 41108                                  _$EXIT:
 41109                                  	; 04/08/2018 - Retro DOS v3.0
 41110                                  	; IBMDOSDOS.COM (MSDOS 3.3, 1987) - Offset 6375h
 41111 00006ED2 30E4                    	xor	AH,AH
 41112 00006ED4 368626[4D03]            	xchg	AH,[SS:DidCTRLC]
 41113 00006ED9 08E4                    	or	AH,AH
 41114                                  	;mov	BYTE [SS:EXIT_TYPE],0
 41115 00006EDB 36C606[7C05]00          	mov	BYTE [SS:EXIT_TYPE],EXIT_TERMINATE
 41116 00006EE1 7406                    	jz	short exit_inner
 41117                                  	;mov	BYTE [SS:EXIT_TYPE],1
 41118 00006EE3 36C606[7C05]01          	mov	BYTE [SS:EXIT_TYPE],EXIT_CTRL_C
 41119                                  
 41120                                  	;entry	Exit_inner
 41121                                  exit_inner:
 41122 00006EE9 E88B95                  	call	Get_User_Stack		;PBUGBUG
 41123                                  
 41124 00006EEC 36FF36[3003]            	push	word [ss:CurrentPDB]
 41125                                  	;pop	word [si+14h]
 41126 00006EF1 8F4414                  	pop	word [SI+user_env.user_CS] ;PBUGBUG
 41127 00006EF4 EB08                    	jmp	short abort_inner
 41128                                  
 41129                                  ;BREAK <$ABORT -- Terminate a process>
 41130                                  ;----------------------------------------------------------------------------
 41131                                  ; Inputs:
 41132                                  ;	user_CS:00 must point to valid program header block
 41133                                  ; Function:
 41134                                  ;	Restore terminate and Cntrl-C addresses, flush buffers and transfer
 41135                                  ;	to the terminate address
 41136                                  ; Returns:
 41137                                  ;	TO THE TERMINATE ADDRESS
 41138                                  ;----------------------------------------------------------------------------
 41139                                  
 41140                                  _$ABORT:
 41141 00006EF6 30C0                    	xor	AL,AL
 41142                                  	;mov	byte [SS:EXIT_TYPE],0
 41143                                  	;mov	byte [SS:EXIT_TYPE],AL ; = 0
 41144 00006EF8 36C606[7C05]00          	mov	byte [SS:EXIT_TYPE],EXIT_ABORT
 41145                                  
 41146                                  	; abort_inner must have AL set as the exit code! The exit type
 41147                                  	; is retrieved from exit_type. Also, the PDB at user_CS needs
 41148                                  	; to be correct as the one that is terminating.
 41149                                  
 41150                                  abort_inner:
 41151 00006EFE 368A26[7C05]            	mov	AH,[SS:EXIT_TYPE]
 41152 00006F03 36A3[3403]              	mov	[SS:exit_code],AX
 41153 00006F07 E86D95                  	call	Get_User_Stack
 41154                                  
 41155                                  	;mov	ds,[si+14h]
 41156 00006F0A 8E5C14                  	mov	DS,[SI+user_env.user_CS] ; set up old interrupts ;PBUGBUG
 41157 00006F0D 31C0                    	xor	AX,AX
 41158 00006F0F 8EC0                    	mov	ES,AX
 41159                                  	;mov	si,10
 41160 00006F11 BE0A00                  	mov	SI,SAVEXIT
 41161                                  	;mov	di,88h
 41162 00006F14 BF8800                  	mov	DI,addr_int_terminate
 41163 00006F17 A5                      	movsw
 41164 00006F18 A5                      	movsw
 41165 00006F19 A5                      	movsw
 41166 00006F1A A5                      	movsw
 41167 00006F1B A5                      	movsw
 41168 00006F1C A5                      	movsw
 41169 00006F1D E975EF                  	jmp	reset_environment
 41170                                  
 41171                                  ;----------------------------------------------------------------------------
 41172                                  ;
 41173                                  ; fixexepatch will point to this is DOS loads low. 
 41174                                  ;
 41175                                  ;----------------------------------------------------------------------------
 41176                                  ; MSDOS 6.0
 41177                                  
 41178                                  ; 29/04/2019 - Retro DOS v4.0
 41179                                  ; DOSCODE:A221h (MSDOS 6.21, MSDOS.SYS)
 41180                                  
 41181                                  ; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS5.0 MSDOS.SYS)
 41182                                  ; DOSCODE:A1C1h (MSDOS 5.0, MSDOS.SYS)
 41183                                  
 41184                                  	; 09/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 41185                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B442h
 41186                                  
 41187                                  RetExePatch: ; proc near
 41188                                  	
 41189 00006F20 C3                      	retn
 41190                                  
 41191                                  ;============================================================================
 41192                                  ; ALLOC.ASM, MSDOS 6.0, 1991
 41193                                  ;============================================================================
 41194                                  ; 04/08/2018 - Retro DOS v3.0
 41195                                  ; 14/05/2019 - Retro DOS v4.0
 41196                                  ; 10/03/2024 - Retro DOS v5.0
 41197                                  
 41198                                  ;	TITLE ALLOC.ASM - memory arena manager	NAME Alloc
 41199                                  
 41200                                  ;**
 41201                                  ;	Microsoft Confidential
 41202                                  ;	Copyright (C) Microsoft Corporation 1991
 41203                                  ;	All Rights Reserved.
 41204                                  ;
 41205                                  ;	Memory related system calls and low level routines for MSDOS 2.X.
 41206                                  ;	I/O specs are defined in DISPATCH.
 41207                                  ;
 41208                                  ;	$ALLOC
 41209                                  ;	$SETBLOCK
 41210                                  ;	$DEALLOC
 41211                                  ;	$AllocOper
 41212                                  ;	arena_free_process
 41213                                  ;	arena_next
 41214                                  ;	check_signature
 41215                                  ;	Coalesce
 41216                                  ;
 41217                                  ;	Modification history:
 41218                                  ;
 41219                                  ;	    Created: ARR 30 March 1983
 41220                                  ;
 41221                                  ;	    Revision: M000 - added support for allocing UMBs. 7/9/90
 41222                                  ;		      M003 - added support for link/unlink UMBs from
 41223                                  ;			     DOS arena chain. 7/18/90
 41224                                  ;		      M009 - Added error returns invalid function and 
 41225                                  ;			     arena trashed in set link state call.
 41226                                  ;		      M010 - Release UMB arenas allocated to current PDB
 41227                                  ;			     if UMB_HEAD is initialized.
 41228                                  ;
 41229                                  ;		      M016 - MACE utilities mkeyrate.com version 1.0 
 41230                                  ;			     support. Please see under M009 in 
 41231                                  ;			     ..\inc\dossym.inc. 8/31/90.
 41232                                  ;
 41233                                  ;		      M061 - In GetLastArena, if linking in UMBs check to make
 41234                                  ;			     sure that umb_head arena is valid and also make
 41235                                  ;			     sure that the previous arena is pointing to 
 41236                                  ;			     umb_head.
 41237                                  ;
 41238                                  ;		      M064 - allow HIGH_ONLY bit to be set by a call to 
 41239                                  ;			     set allloc strategy.
 41240                                  ;			     use STRAT_MASK to mask out bits 6 & 7 of 
 41241                                  ;			     bx in AllocSetStrat.
 41242                                  ;
 41243                                  ;		      M068 - use a count value (A20OFF_COUNT) rather than
 41244                                  ;			     a bit to indicate to dos dispatcher to turn
 41245                                  ;			     a20 off before iret. See M016.
 41246                                  ;
 41247                                  
 41248                                  ;	BREAK	<memory allocation utility routines>
 41249                                  
 41250                                  
 41251                                  ; 15/04/2018 - Retro DOS v2.0
 41252                                  ;----------------------------------------------------------------------------
 41253                                  ; xenix memory calls for MSDOS
 41254                                  ;
 41255                                  ; CAUTION: The following routines rely on the fact that arena_signature and
 41256                                  ; arena_owner_system are all equal to zero and are contained in DI.
 41257                                  ;
 41258                                  ;INCLUDE DOSSEG.ASM
 41259                                  
 41260                                  ;CODE	SEGMENT BYTE PUBLIC  'CODE'
 41261                                  ;       ASSUME  SS:DOSGROUP,CS:DOSGROUP
 41262                                  
 41263                                  ;.xlist
 41264                                  ;.xcref
 41265                                  ;INCLUDE DOSSYM.ASM
 41266                                  ;INCLUDE DEVSYM.ASM
 41267                                  ;.cref
 41268                                  ;.list
 41269                                  
 41270                                  ;TITLE ALLOC.ASM - memory arena manager
 41271                                  ;NAME Alloc
 41272                                  
 41273                                  ;SUBTTL memory allocation utility routines
 41274                                  ;PAGE
 41275                                  ;
 41276                                  ; arena data
 41277                                  ;
 41278                                  ;       i_need  arena_head,WORD         ; seg address of start of arena
 41279                                  ;       i_need  CurrentPDB,WORD         ; current process data block addr
 41280                                  ;       i_need  FirstArena,WORD         ; first free block found
 41281                                  ;       i_need  BestArena,WORD          ; best free block found
 41282                                  ;       i_need  LastArena,WORD          ; last free block found
 41283                                  ;       i_need  AllocMethod,BYTE        ; how to alloc first(best)last
 41284                                  
 41285                                  ;----------------------------------------------------------------------------
 41286                                  
 41287                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 41288                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B443h
 41289                                  	;;;
 41290                                  test_umb_flag:
 41291 00006F21 36F606[8900]01          	test	byte [ss:UMBFLAG],LINKSTATE ; 1 ; Q: are umb's linked
 41292 00006F27 C3                      	retn                    ; ZF=1 -> N: scan from arena_head
 41293                                  				; ZF=0 -> Y: start_arena = umb_head
 41294                                  	;;;
 41295                                  
 41296                                  ;**	Arena_Free_Process
 41297                                  ;----------------------------------------------------------------------------
 41298                                  ;	Free all arena blocks allocated to a process
 41299                                  ;
 41300                                  ;	ENTRY	(bx) = PID of process
 41301                                  ;	EXIT	none
 41302                                  ;	USES	????? BUGBUG
 41303                                  ;----------------------------------------------------------------------------
 41304                                  
 41305                                  	; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS5.0 MSDOS.SYS)
 41306                                  	; DOSCODE:A1C2h (MSDOS 5.0, MSDOS.SYS)
 41307                                  
 41308                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 41309                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B44Ah
 41310                                  
 41311                                  arena_free_process:
 41312                                  	; 14/05/2019 - Retro DOS v4.0
 41313                                  	; 04/08/2018 - Retro DOS v3.0
 41314 00006F28 36A1[2400]                      MOV	AX,[SS:arena_head]
 41315                                  arena_free_process_start:
 41316 00006F2C BF0000                  	MOV     DI,ARENA.SIGNATURE ; 0
 41317                                  	;MOV	AX,[SS:arena_head] ; 15/04/2018  
 41318 00006F2F E82F00                          CALL	check_signature         ; ES <- AX, check for valid block
 41319                                  
 41320                                  arena_free_process_loop:
 41321                                          ;retc
 41322 00006F32 7225                            JC	SHORT AFP_RETN	; Retro DOS v2.0 - 05/03/2018
 41323 00006F34 06                      	PUSH    ES
 41324 00006F35 1F                              POP     DS
 41325                                  	;cmp	[1],bx 
 41326 00006F36 391E0100                        CMP     [ARENA.OWNER],BX	; is block owned by pid?
 41327 00006F3A 7504                            JNZ     SHORT arena_free_next	; no, skip to next
 41328                                  	;mov	[1],di
 41329 00006F3C 893E0100                        MOV     [ARENA.OWNER],DI	; yes... free him
 41330                                  
 41331                                  arena_free_next:
 41332                                  	;cmp	byte [di],5Ah ;'Z'
 41333 00006F40 803D5A                          CMP     BYTE [DI],arena_signature_end
 41334                                                                          ; end of road, Jack?
 41335                                          ;retz				; never come back no more
 41336                                  	;JZ	SHORT AFP_RETN  ; MSDOS 3.3 (& MSDOS 2.11)
 41337                                  	; 14/05/2019
 41338                                  	; MSDOS 6.0
 41339 00006F43 7405                    	jz	short arena_chk_umbs
 41340                                          
 41341 00006F45 E81200                  	CALL    arena_next              ; next item in ES/AX carry set if trash
 41342 00006F48 EBE8                            JMP     SHORT arena_free_process_loop
 41343                                  
 41344                                  	; MSDOS 6.0
 41345                                  arena_chk_umbs:				; M010 - Start
 41346                                  	; 20/05/2019
 41347 00006F4A 36A1[8C00]              	mov	ax,[ss:UMB_HEAD]	; ax = umb_head
 41348 00006F4E 83F8FF                  	cmp	ax,0FFFFh		; Q: is umb_head initialized
 41349 00006F51 741D                    	je	short ret_label		; N: we're done
 41350                                  	
 41351 00006F53 8CDF                    	mov	di,ds			; di = last arena
 41352 00006F55 39C7                    	cmp	di,ax			; Q: is last arena above umb_head
 41353                                  	;jae	short ret_label		; Y: we've scanned umbs also. done.
 41354                                  	;jmp	short arena_free_process_start
 41355                                  					; M010 - End
 41356                                  	; 10/03/2024 (PCDOS 7.1 IBMDOS.COM)
 41357 00006F57 72D3                    	jb	short arena_free_process_start
 41358                                  
 41359                                  	; 10/03/2024
 41360                                  AFP_RETN:
 41361 00006F59 C3                      	RETN
 41362                                  
 41363                                  ;	BREAK	<Arena Helper Routines>
 41364                                  
 41365                                  ;**	Arena_Next - Find Next item in Arena
 41366                                  ;----------------------------------------------------------------------------
 41367                                  ;	ENTRY	DS - pointer to block head
 41368                                  ;		(di) = 0
 41369                                  ;	EXIT	AX,ES - pointers to next head
 41370                                  ;		'C' set iff arena damaged
 41371                                  ;----------------------------------------------------------------------------
 41372                                  
 41373                                  arena_next:
 41374 00006F5A 8CD8                            MOV     AX,DS                   ; AX <- current block
 41375 00006F5C 03060300                        ADD     AX,[ARENA.SIZE]		; AX <- AX + current block length
 41376 00006F60 40                              INC     AX                      ; remember that header!
 41377                                  
 41378                                  ;       fall into check_signature and return
 41379                                  ;
 41380                                  ;       CALL    check_signature         ; ES <- AX, carry set if error
 41381                                  ;       RETN
 41382                                  
 41383                                  ;**	Check_Signature - Check Memory Block Signature
 41384                                  ;----------------------------------------------------------------------------
 41385                                  ;	ENTRY	(AX) = address of block header
 41386                                  ;		(di) = 0
 41387                                  ;	EXIT	 ES = AX
 41388                                  ;		'C' clear if signature good
 41389                                  ;		'C' set if signature bad
 41390                                  ;	USES	ES, Flags
 41391                                  ;----------------------------------------------------------------------------
 41392                                  
 41393                                  check_signature:        
 41394                                  
 41395 00006F61 8EC0                    	MOV     ES,AX                   ; ES <- AX
 41396                                  	;cmp	byte [es:di],4Dh ; 'M'
 41397 00006F63 26803D4D                        CMP     BYTE [ES:DI],arena_signature_normal
 41398                                                                          ; IF next signature = not_end THEN
 41399 00006F67 7407                            JZ      SHORT check_signature_ok ;   GOTO ok
 41400                                  	;cmp 	byte [es:di],5Ah ; 'Z'
 41401 00006F69 26803D5A                        CMP     BYTE [ES:DI],arena_signature_end
 41402                                                                          ; IF next signature = end then
 41403 00006F6D 7401                            JZ      SHORT check_signature_ok ;   GOTO ok
 41404 00006F6F F9                              STC                             ; set error
 41405                                  ret_label: ; MSDOS 6.0
 41406                                  ;AFP_RETN:	; 10/03/2024
 41407                                   	; Retro DOS v2.0 - 05/03/2018
 41408                                  check_signature_ok:
 41409                                  COALESCE_RETN:
 41410 00006F70 C3                      	RETN
 41411                                  
 41412                                  ;**	Coalesce - Combine free blocks ahead with current block
 41413                                  ;----------------------------------------------------------------------------
 41414                                  ;	Coalesce adds the block following the argument to the argument block,
 41415                                  ;	iff it's free.  Coalesce is usually used to join free blocks, but
 41416                                  ;	some callers (such as $setblock) use it to join a free block to it's
 41417                                  ;	preceeding allocated block.
 41418                                  ;
 41419                                  ;	ENTRY	(ds) = pointer to the head of a free block
 41420                                  ;		(di) = 0
 41421                                  ;	EXIT	'C' clear if OK
 41422                                  ;		  (ds) unchanged, this block updated
 41423                                  ;		  (ax) = address of next block, IFF not at end
 41424                                  ;		'C' set if arena trashed
 41425                                  ;	USES	(cx)
 41426                                  ;----------------------------------------------------------------------------
 41427                                          
 41428                                  Coalesce:
 41429                                  	;cmp	byte [di],5Ah ; 'Z'
 41430 00006F71 803D5A                  	CMP     BYTE [DI],arena_signature_end
 41431                                                                          ; IF current signature = END THEN
 41432                                          ;retz				;   GOTO ok
 41433 00006F74 74FA                            jz	short COALESCE_RETN
 41434 00006F76 E8E1FF                  	CALL    arena_next              ; ES, AX <- next block, Carry set if error
 41435                                          ;retc				; IF no error THEN GOTO check
 41436 00006F79 72F5                    	jc	short COALESCE_RETN
 41437                                  
 41438                                  coalesce_check:
 41439                                  	;cmp	[es:1],di
 41440 00006F7B 26393E0100                      CMP     [ES:ARENA.OWNER],DI
 41441                                          ;retnz				; IF next block isnt free THEN return
 41442 00006F80 75EE                            JNZ	SHORT COALESCE_RETN
 41443                                  	;mov	cx,[ES:3]
 41444 00006F82 268B0E0300              	MOV     CX,[ES:ARENA.SIZE]	; CX <- next block size
 41445 00006F87 41                              INC     CX                      ; CX <- CX + 1 (for header size)
 41446                                          ;ADD	[3],CX
 41447 00006F88 010E0300                	ADD     [ARENA.SIZE],CX		; current size <- current size + CX
 41448 00006F8C 268A0D                          MOV     CL,[ES:DI]              ; move up signature
 41449 00006F8F 880D                            MOV     [DI],CL
 41450 00006F91 EBDE                            JMP     SHORT Coalesce		; try again
 41451                                  
 41452                                  ; 04/08/2018 - Retro DOS v3.0
 41453                                  ; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 641Fh
 41454                                  
 41455                                  ;	BREAK  <$Alloc - allocate space in memory>
 41456                                  
 41457                                  ; MSDOS 6.0
 41458                                  ;----------------------------------------------------------------------------
 41459                                  ;**	$Alloc - Allocate Memory Space
 41460                                  ;
 41461                                  ;	$Alloc services the INT21 that allocates memory space to a program.
 41462                                  ;	Alloc returns a pointer to a free block of memory that
 41463                                  ;	has the requested size in paragraphs.
 41464                                  ;
 41465                                  ;	If the allocation strategy is HIGH_FIRST or HIGH_ONLY memory is 
 41466                                  ;	scanned from umb_head if not from arena_head. If the strategy is
 41467                                  ; 	HIGH_FIRST the scan is continued from arena_head if a block of 
 41468                                  ;	appropriate size is not found in the UMBs. If the strategy is 
 41469                                  ;	HIGH_FIRST+HIGH_ONLY only the UMBs are scanned for memory.
 41470                                  ;
 41471                                  ;	In either case if bit 0 of UmbFlag is not initialized then the scan
 41472                                  ;	starts from arena_head.
 41473                                  ;
 41474                                  ;	Assembler usage:
 41475                                  ;           MOV     BX,size
 41476                                  ;           MOV     AH,Alloc
 41477                                  ;           INT     21h
 41478                                  ;
 41479                                  ;	BUGBUG - a lot can be done to improve performance. We can set marks
 41480                                  ;	so that we start searching the arena at it's first non-trivial free
 41481                                  ;	block, we can peephole the code, etc. (We can move some subr calls
 41482                                  ;	inline, etc.) I assume that this is called rarely and that the arena
 41483                                  ;	doesn't have too many memory objects in it beyond the first free one.
 41484                                  ;	verify that this is true; if so, this can stay as is
 41485                                  ;
 41486                                  ;	ENTRY	(bx) = requested size, in bytes
 41487                                  ;		(DS) = (ES) = DOSGROUP
 41488                                  ;	EXIT	'C' clear if memory allocated
 41489                                  ;		  (ax:0) = address of requested memory
 41490                                  ;		'C' set if request failed
 41491                                  ;		  (AX) = error_not_enough_memory
 41492                                  ;		    (bx) = max size we could have allocated
 41493                                  ;		  (ax) = error_arena_trashed
 41494                                  ;	USES	All
 41495                                  ;----------------------------------------------------------------------------
 41496                                  
 41497                                  ; MSDOS 2.11 (& MSDOS 3.3)
 41498                                  ;----------------------------------------------------------------------------
 41499                                  ;SUBTTL $Alloc - allocate space in memory
 41500                                  ;
 41501                                  ;   Assembler usage:
 41502                                  ;           MOV     BX,size
 41503                                  ;           MOV     AH,Alloc
 41504                                  ;           INT     21h
 41505                                  ;         AX:0 is pointer to allocated memory
 41506                                  ;         BX is max size if not enough memory
 41507                                  ;
 41508                                  ;   Description:
 41509                                  ;           Alloc returns  a  pointer  to  a  free  block of
 41510                                  ;       memory that has the requested  size  in  paragraphs.
 41511                                  ;
 41512                                  ;   Error return:
 41513                                  ;           AX = error_not_enough_memory
 41514                                  ;              = error_arena_trashed
 41515                                  ;----------------------------------------------------------------------------
 41516                                  
 41517                                  ; DOSCODE:A28Eh (MSDOS 6.21, MSDOS.SYS)
 41518                                  
 41519                                  ; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS5.0 MSDOS.SYS)
 41520                                  ; DOSCODE:A22Eh (MSDOS 5.0, MSDOS.SYS)
 41521                                  
 41522                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 41523                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B4B5h
 41524                                  
 41525                                  _$ALLOC:
 41526                                  	; 25/05/2019 (Procedure has been checked and confirmed)
 41527                                  	; 14/05/2019 - Retro DOS v4.0
 41528                                  	; 04/08/2018 - Retro DOS v3.0
 41529                                  	;EnterCrit critMem
 41530 00006F93 E8EEA8                  	call	ECritMEM ; MSDOS 3.3 & MSDOS 6.0
 41531                                  
 41532                                  ; 17/12/2022
 41533                                  ; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 41534                                  ;%if 0
 41535                                  	; 14/05/2019
 41536 00006F96 16                      	push	ss
 41537 00006F97 1F                      	pop	ds
 41538                                  
 41539                                  	; MSDOS 6.0
 41540                                  	;mov	ax,[ss:arena_head]
 41541                                  	;mov	[ss:START_ARENA],ax	; assume LOW_FIRST
 41542                                  
 41543 00006F98 A1[2400]                	mov	ax,[arena_head]
 41544 00006F9B A3[8E00]                	mov	[START_ARENA],ax
 41545                                  	
 41546                                  	;test	byte [ss:AllocMethod],HIGH_FIRST+HIGH_ONLY
 41547 00006F9E F606[0203]C0            	test	byte [AllocMethod],HIGH_FIRST+HIGH_ONLY
 41548                                  					; Q: should we start scanning from
 41549                                  					;    UMB's
 41550 00006FA3 740B                    	jz	short norm_alloc	; N: scan from arena_head
 41551                                  
 41552                                  ; 10/03/2024
 41553                                  %if 0
 41554                                  	;;cmp	word [ss:UMB_HEAD],-1	; Q: Has umb_head been initialized
 41555                                  	;cmp	word [UMB_HEAD],-1
 41556                                  	;je	short norm_alloc	; N: scan from arena_head
 41557                                  
 41558                                  	;test	byte [ss:UMBFLAG],LINKSTATE ; Q: are umb's linked
 41559                                  	test	byte [UMBFLAG],LINKSTATE ; 1
 41560                                  	jz	short norm_alloc	; N: scan from arena_head
 41561                                  %else
 41562                                  	; 10/03/2024 (PCDOS 7.1 IBMDOS.COM)
 41563                                  	;;;
 41564 00006FA5 E879FF                  	call	test_umb_flag
 41565 00006FA8 7406                    	jz      short norm_alloc
 41566                                  	;;;
 41567                                  %endif
 41568                                  
 41569                                  	;mov	ax,[ss:UMB_HEAD]
 41570                                  	;mov	[ss:START_ARENA],ax	; start_arena = umb_head
 41571 00006FAA A1[8C00]                	mov	ax,[UMB_HEAD]
 41572 00006FAD A3[8E00]                	mov	[START_ARENA],ax
 41573                                  					; M000 - end
 41574                                  norm_alloc:
 41575 00006FB0 31C0                            XOR     AX,AX
 41576 00006FB2 89C7                            MOV     DI,AX
 41577                                  	; 15/03/2018
 41578                                          ;MOV	[SS:FirstArena],AX	; init the options
 41579                                          ;MOV	[SS:BestArena],AX
 41580                                          ;MOV	[SS:LastArena],AX
 41581                                  	; 14/05/2019
 41582 00006FB4 A3[4003]                	MOV	[FirstArena],AX		; init the options
 41583 00006FB7 A3[4203]                        MOV	[BestArena],AX
 41584 00006FBA A3[4403]                        MOV	[LastArena],AX
 41585 00006FBD 50                              PUSH    AX                      ; alloc_max <- 0
 41586                                  	; 04/08/2018
 41587                                  start_scan:
 41588                                  	;MOV	AX,[SS:arena_head]	; AX <- beginning of arena
 41589                                  	;MOV	AX,[arena_head]
 41590                                  
 41591                                  	; 14/05/2019	
 41592                                  	; MSDOS 6.0
 41593                                  	;mov	ax,[SS:START_ARENA]	; M000: AX <- beginning of arena
 41594 00006FBE A1[8E00]                	mov	ax,[START_ARENA]
 41595                                  
 41596                                  	; 27/09/2023 (BugFix) (*)
 41597                                  	; ( jump from 'alloc_chk' (ds<>ss, ax = [SS:START_ARENA]))
 41598                                  start_scan_x:
 41599                                  
 41600 00006FC1 E89DFF                  	CALL    check_signature         ; ES <- AX, carry set if error
 41601 00006FC4 7233                            JC      SHORT alloc_err		; IF error THEN GOTO err
 41602                                  
 41603                                  ;%endif
 41604                                  
 41605                                  ; 17/12/2022
 41606                                  %if 0
 41607                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 41608                                  
 41609                                  	; MSDOS 6.0
 41610                                  	mov	ax,[ss:arena_head]
 41611                                  	mov	[ss:START_ARENA],ax	; assume LOW_FIRST
 41612                                  
 41613                                  	test	byte [ss:AllocMethod],HIGH_FIRST+HIGH_ONLY
 41614                                  					; Q: should we start scanning from
 41615                                  					;    UMB's
 41616                                  	jz	short norm_alloc	; N: scan from arena_head
 41617                                  		
 41618                                  	;cmp	word [ss:UMB_HEAD],-1	; Q: Has umb_head been initialized
 41619                                  	;je	short norm_alloc	; N: scan from arena_head
 41620                                  
 41621                                  	test	byte [ss:UMBFLAG],LINKSTATE ; Q: are umb's linked
 41622                                  	jz	short norm_alloc	; N: scan from arena_head
 41623                                  	
 41624                                  	mov	ax,[ss:UMB_HEAD]
 41625                                  	mov	[ss:START_ARENA],ax	; start_arena = umb_head
 41626                                  					; M000 - end
 41627                                  norm_alloc:
 41628                                          XOR     AX,AX
 41629                                          MOV     DI,AX
 41630                                  	; 15/03/2018
 41631                                  	MOV	[SS:FirstArena],AX	; init the options
 41632                                  	MOV	[SS:BestArena],AX
 41633                                  	MOV	[SS:LastArena],AX
 41634                                          PUSH    AX                      ; alloc_max <- 0
 41635                                  	; 04/08/2018
 41636                                  start_scan:
 41637                                  	;MOV	AX,[SS:arena_head]	; AX <- beginning of arena
 41638                                  	; 14/05/2019	
 41639                                  	; MSDOS 6.0
 41640                                  	mov	ax,[SS:START_ARENA]	; M000: AX <- beginning of arena
 41641                                  	CALL    check_signature         ; ES <- AX, carry set if error
 41642                                          JC      SHORT alloc_err		; IF error THEN GOTO err
 41643                                  %endif
 41644                                  
 41645                                  alloc_scan:
 41646 00006FC6 06                              PUSH    ES
 41647 00006FC7 1F                              POP     DS                      ; DS <- ES
 41648 00006FC8 393E0100                        CMP     [ARENA.OWNER],DI ; 0
 41649 00006FCC 7466                            JZ      SHORT alloc_free	; IF current block is free THEN examine
 41650                                  
 41651                                  alloc_next:
 41652                                  
 41653                                  ; 10/03/2024
 41654                                  %if 0
 41655                                  	; MSDOS 6.0			; M000 - start
 41656                                  	test	byte [ss:UMBFLAG],LINKSTATE ; Q: are umb's linked
 41657                                  	jz	short norm_strat	; N: see if we reached last arena
 41658                                  %else
 41659                                  	; 10/03/2024 (PCDOS 7.1 IBMDOS.COM)
 41660                                  	;;;
 41661 00006FCE E850FF                  	call	test_umb_flag
 41662 00006FD1 741C                    	jz      short norm_strat
 41663                                  	;;;
 41664                                  %endif
 41665 00006FD3 36F606[0203]80          	test	byte [ss:AllocMethod],HIGH_FIRST
 41666                                  					; Q: is alloc strategy high_first
 41667 00006FD9 7414                    	jz	short norm_strat	; N: see if we reached last arena
 41668 00006FDB 36A1[8E00]              	mov	ax,[ss:START_ARENA]
 41669 00006FDF 363B06[2400]            	cmp	ax,[ss:arena_head]	; Q: did we start scan from
 41670                                  					;    arena_head
 41671 00006FE4 7509                    	jne	short norm_strat	; N: see if we reached last arena
 41672 00006FE6 8CD8                    	mov	ax,ds			; ax = current block
 41673 00006FE8 363B06[8C00]            	cmp	ax,[ss:UMB_HEAD]	; Q: check against umb_head 
 41674 00006FED EB03                    	jmp	short alloc_chk_end
 41675                                  
 41676                                  norm_strat:
 41677                                  	;cmp	byte [di],5Ah ; 'Z'
 41678 00006FEF 803D5A                          CMP     BYTE [DI],arena_signature_end
 41679                                                                          ; IF current block is last THEN
 41680                                  alloc_chk_end:
 41681 00006FF2 740E                            JZ      SHORT alloc_end		;   GOTO end
 41682 00006FF4 E863FF                          CALL    arena_next              ; AX, ES <- next block, Carry set if error
 41683 00006FF7 73CD                            JNC     SHORT alloc_scan	; IF no error THEN GOTO scan
 41684                                  
 41685                                  alloc_err:
 41686 00006FF9 58                              POP     AX
 41687                                  
 41688                                  alloc_trashed:
 41689                                  	;LeaveCrit critMem
 41690 00006FFA E8B4A8                  	call    LCritMEM ; MSDOS 3.3 & MSDOS 6.0
 41691                                  
 41692                                  alloc_trashed2:	; 10/03/2024 - Retro DOS v5.0 (PCDOS 7.1) -jmp from GetLastArena-
 41693                                  	;error	error_arena_trashed
 41694                                  	;mov	al,7
 41695 00006FFD B007                    	MOV	AL,error_arena_trashed
 41696                                  alloc_errj:
 41697 00006FFF E97396                  	JMP	SYS_RET_ERR
 41698                                  
 41699                                  alloc_end:
 41700                                  	; 18/05/2019
 41701 00007002 36833E[4003]00                  CMP	WORD [SS:FirstArena],0
 41702 00007008 7403                    	jz	short alloc_chk 
 41703 0000700A E98400                  	jmp	alloc_do_split
 41704                                  
 41705                                  alloc_chk:
 41706                                  	; MSDOS 6.0
 41707 0000700D 36A1[2400]              	mov	ax,[ss:arena_head]
 41708 00007011 363B06[8E00]            	cmp	ax,[ss:START_ARENA]	; Q: started scanning from arena_head
 41709 00007016 740E                    	je	short alloc_fail	; Y: not enough memory
 41710                                  					; N:
 41711                                  					; Q: is the alloc strat HIGH_ONLY
 41712 00007018 36F606[0203]40          	test 	byte [ss:AllocMethod],HIGH_ONLY
 41713 0000701E 7506                    	jnz	short alloc_fail	; Y: return size of largest UMB
 41714                                  	
 41715 00007020 36A3[8E00]              	mov	[ss:START_ARENA],ax	; N: start scanning from arena_head
 41716                                  	; 27/09/2023 (*)
 41717 00007024 EB9B                    	jmp	short start_scan_x ; (*) ; (BugFix)
 41718                                  	;jmp	short start_scan
 41719                                  					; M000 - end
 41720                                  alloc_fail:
 41721                                          ;invoke Get_User_Stack
 41722 00007026 E84E94                          CALL	Get_User_Stack
 41723 00007029 5B                      	POP     BX
 41724                                          ;MOV	[SI].user_BX,BX
 41725                                  	;MOV	[SI+2],BX
 41726 0000702A 895C02                  	mov	[SI+user_env.user_BX],bx
 41727                                  	;LeaveCrit critMem
 41728 0000702D E881A8                  	call    LCritMEM ; MSDOS 3.3 & MSDOS 6.0
 41729                                  	;error	error_not_enough_memory
 41730                                  	;mov	al,8
 41731 00007030 B008                    	MOV	AL,error_not_enough_memory
 41732                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 41733 00007032 EBCB                    	jmp	short alloc_errj
 41734                                  	;JMP	SYS_RET_ERR
 41735                                  
 41736                                  alloc_free:
 41737 00007034 E83AFF                          CALL    Coalesce		; add following free block to current
 41738 00007037 72C0                            JC	SHORT alloc_err		; IF error THEN GOTO err
 41739 00007039 8B0E0300                        MOV     CX,[ARENA.SIZE]
 41740 0000703D 5A                              POP     DX                      ; check for max found size
 41741 0000703E 39D1                            CMP     CX,DX
 41742 00007040 7602                            JNA     SHORT alloc_test
 41743 00007042 89CA                            MOV     DX,CX
 41744                                  
 41745                                  alloc_test:
 41746 00007044 52                              PUSH    DX
 41747 00007045 39CB                            CMP     BX,CX                   ; IF BX > size of current block THEN
 41748 00007047 7785                    	JA      SHORT alloc_next	;   GOTO next
 41749                                  
 41750                                  	; 15/03/2018
 41751 00007049 36833E[4003]00                  CMP     WORD [SS:FirstArena],0
 41752 0000704F 7505                    	JNZ	SHORT alloc_best
 41753 00007051 368C1E[4003]                    MOV     [SS:FirstArena],DS	; save first one found
 41754                                  alloc_best:
 41755 00007056 36833E[4203]00                  CMP     WORD [SS:BestArena],0
 41756 0000705C 740E                            JZ      SHORT alloc_make_best	; initial best
 41757 0000705E 06                              PUSH	ES
 41758 0000705F 368E06[4203]                    MOV     ES,[SS:BestArena]
 41759 00007064 26390E0300                      CMP     [ES:ARENA.SIZE],CX	; is size of best larger than found?
 41760 00007069 07                              POP	ES
 41761 0000706A 7605                            JBE     SHORT alloc_last
 41762                                  alloc_make_best:
 41763 0000706C 368C1E[4203]                    MOV     [SS:BestArena],DS	; assign best
 41764                                  alloc_last:
 41765 00007071 368C1E[4403]                    MOV     [SS:LastArena],DS 	; assign last
 41766 00007076 E955FF                          JMP     alloc_next
 41767                                  ;
 41768                                  ; split the block high
 41769                                  ;
 41770                                  alloc_do_split_high:
 41771 00007079 368E1E[4403]                    MOV     DS,[SS:LastArena]
 41772 0000707E 8B0E0300                        MOV     CX,[ARENA.SIZE]
 41773 00007082 29D9                            SUB     CX,BX
 41774 00007084 8CDA                            MOV     DX,DS
 41775 00007086 7449                            JE      SHORT alloc_set_owner	; sizes are equal, no split
 41776 00007088 01CA                            ADD     DX,CX                   ; point to next block
 41777 0000708A 8EC2                            MOV     ES,DX                   ; no decrement!
 41778 0000708C 49                              DEC     CX
 41779 0000708D 87CB                            XCHG    BX,CX                   ; bx has size of lower block
 41780 0000708F EB2B                            JMP     SHORT alloc_set_sizes	; cx has upper (requested) size
 41781                                  ;
 41782                                  ; we have scanned memory and have found all appropriate blocks
 41783                                  ; check for the type of allocation desired; first and best are identical
 41784                                  ; last must be split high
 41785                                  ;
 41786                                  alloc_do_split:
 41787                                  
 41788                                  ; 17/12/2022
 41789                                  ; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 41790                                  ;%if 0
 41791                                  	; 14/05/2019
 41792                                  	; MSDOS 6.0			; M000 - start
 41793                                  	;xor	cx,cx
 41794 00007091 368A0E[0203]            	mov	cl,[ss:AllocMethod]
 41795                                  	;and	cx,STRAT_MASK ; 0FF3Fh	; mask off bit 7
 41796 00007096 80E13F                  	and	cl,3Fh
 41797                                  	;cmp	cx,BEST_FIT ; 1		; Q; is the alloc strategy best_fit
 41798 00007099 80F901                  	cmp	cl,BEST_FIT
 41799 0000709C 77DB                    	ja	short alloc_do_split_high
 41800                                  ;%endif
 41801                                  
 41802                                  	; 17/12/2022
 41803                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 41804                                  	; MSDOS 6.0 & MSDOS 5.0
 41805                                  	;xor	cx,cx
 41806                                  	;mov	cl,[ss:AllocMethod]
 41807                                  	;and	cx,STRAT_MASK ; 0FF3Fh	; mask off bit 7
 41808                                  	;cmp	cx,BEST_FIT ; 1		; Q; is the alloc strategy best_fit
 41809                                  	;ja	short alloc_do_split_high
 41810                                  
 41811                                  	; 15/03/2018
 41812                                          ;;CMP	BYTE [SS:AllocMethod], 1
 41813                                  	; 04/08/2018
 41814                                  	;CMP	BYTE [SS:AllocMethod],BEST_FIT
 41815                                          ;JA	SHORT alloc_do_split_high
 41816                                          
 41817 0000709E 368E1E[4003]            	MOV     DS,[SS:FirstArena]
 41818 000070A3 7205                    	JB      SHORT alloc_get_size
 41819 000070A5 368E1E[4203]            	MOV     DS,[SS:BestArena]
 41820                                  
 41821                                  alloc_get_size:
 41822 000070AA 8B0E0300                        MOV     CX,[ARENA.SIZE]
 41823 000070AE 29D9                            SUB     CX,BX                   ; get room left over
 41824 000070B0 8CD8                            MOV     AX,DS
 41825 000070B2 89C2                            MOV     DX,AX                   ; save for owner setting
 41826 000070B4 741B                            JE      SHORT alloc_set_owner	; IF BX = size THEN (don't split)
 41827 000070B6 01D8                            ADD     AX,BX
 41828 000070B8 40                              INC     AX                      ; remember the header
 41829 000070B9 8EC0                            MOV     ES,AX                   ; ES <- DS + BX (new header location)
 41830 000070BB 49                              DEC     CX                      ; CX <- size of split block
 41831                                  alloc_set_sizes:
 41832 000070BC 891E0300                        MOV     [ARENA.SIZE],BX		; current size <- BX
 41833 000070C0 26890E0300                      MOV     [ES:ARENA.SIZE],CX      ; split size <- CX
 41834                                  	;mov	bl,4Dh ; 'M'
 41835 000070C5 B34D                            MOV     BL,arena_signature_normal
 41836 000070C7 861D                            XCHG    BL,[DI]			; current signature <- 4D
 41837 000070C9 26881D                          MOV     [ES:DI],BL		; new block sig <- old block sig
 41838 000070CC 26893E0100                      MOV     [ES:ARENA.OWNER],DI
 41839                                  
 41840                                  alloc_set_owner:
 41841 000070D1 8EDA                            MOV     DS,DX
 41842 000070D3 36A1[3003]                      MOV     AX,[SS:CurrentPDB] ; 15/03/2018
 41843 000070D7 A30100                          MOV     [ARENA.OWNER],AX
 41844 000070DA 8CD8                            MOV     AX,DS
 41845 000070DC 40                              INC     AX
 41846 000070DD 5B                              POP     BX
 41847                                  	;LeaveCrit critMem
 41848 000070DE E8D0A7                  	call    LCritMEM ; MSDOS 3.3 & MSDOS 6.0
 41849                                  	
 41850                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 41851                                  alloc_ok:
 41852                                          ;transfer SYS_RET_OK
 41853 000070E1 E98795                  	JMP	SYS_RET_OK
 41854                                  
 41855                                  ;	BREAK $SETBLOCK - change size of an allocated block (if possible)
 41856                                  
 41857                                  ; MSDOS 6.0
 41858                                  ;----------------------------------------------------------------------------
 41859                                  ;**	$SETBLOCK - Change size of an Allocated Block
 41860                                  ;
 41861                                  ;	Setblock changes the size of an allocated block. First, we coalesce
 41862                                  ;	any following free space onto this block; then we try to trim the
 41863                                  ;	block down to the size requested.
 41864                                  ;
 41865                                  ;	Note that if the guy wants to grow the block but that growth fails,
 41866                                  ;	we still go ahead and coalesce any trailing free blocks onto it.
 41867                                  ;	Thus the maximum-size-possible value that we return has already
 41868                                  ;	been allocated! This is a bug, dare we fix it? BUGBUG
 41869                                  ;
 41870                                  ;	NOTE - $SETBLOCK is in bed with $ALLOC and jumps into $ALLOC to
 41871                                  ;		finish it's work. For this reason we build the allocsf
 41872                                  ;		structure on the frame, to make us compatible with $ALLOCs
 41873                                  ;		code.
 41874                                  ;
 41875                                  ;	ENTRY	(es) = segment of old block
 41876                                  ;		(bx) = newsize
 41877                                  ;		(ah) = SETBLOCK
 41878                                  ;
 41879                                  ;	EXIT	'C' clear if OK
 41880                                  ;		'C' set if error
 41881                                  ;		  (ax) = error_invalid_block
 41882                                  ;		       = error_arena_trashed
 41883                                  ;		       = error_not_enough_memory
 41884                                  ;		       = error_invalid_function
 41885                                  ;		  (bx) = maximum size possible, iff (ax) = error_not_enough_memory
 41886                                  ;	USES	???? BUGBUG
 41887                                  ;----------------------------------------------------------------------------
 41888                                  
 41889                                  ; MSDOS 2.11 (& MSDOS 3.3)
 41890                                  ;----------------------------------------------------------------------------
 41891                                  ;SUBTTL $SETBLOCK - change size of an allocated block (if possible)
 41892                                  ;
 41893                                  ;   Assembler usage:
 41894                                  ;           MOV     ES,block
 41895                                  ;           MOV     BX,newsize
 41896                                  ;           MOV     AH,setblock
 41897                                  ;           INT     21h
 41898                                  ;         if setblock fails for growing, BX will have the maximum
 41899                                  ;         size possible
 41900                                  ;   Error return:
 41901                                  ;           AX = error_invalid_block
 41902                                  ;              = error_arena_trashed
 41903                                  ;              = error_not_enough_memory
 41904                                  ;              = error_invalid_function
 41905                                  ;----------------------------------------------------------------------------
 41906                                  
 41907                                  _$SETBLOCK:        
 41908                                  	; 04/08/2018 - Retro DOS v3.0
 41909                                  	;EnterCrit   critMem
 41910 000070E4 E89DA7                  	call	ECritMEM ; MSDOS 3.3 & MSDOS 6.0
 41911                                  
 41912 000070E7 BF0000                  	MOV     DI,ARENA.SIGNATURE
 41913 000070EA 8CC0                            MOV     AX,ES
 41914 000070EC 48                              DEC     AX
 41915 000070ED E871FE                          CALL    check_signature
 41916 000070F0 7303                            JNC     SHORT setblock_grab
 41917                                  
 41918                                  setblock_bad:
 41919 000070F2 E905FF                          JMP     alloc_trashed
 41920                                  
 41921                                  setblock_grab:
 41922 000070F5 8ED8                            MOV     DS,AX
 41923 000070F7 E877FE                          CALL    Coalesce
 41924 000070FA 72F6                            JC      SHORT setblock_bad
 41925 000070FC 8B0E0300                        MOV     CX,[ARENA.SIZE]
 41926 00007100 51                              PUSH    CX
 41927 00007101 39CB                            CMP     BX,CX
 41928 00007103 76A5                            JBE     SHORT alloc_get_size
 41929 00007105 E91EFF                          JMP     alloc_fail
 41930                                  
 41931                                  ;	BREAK $DEALLOC - free previously allocated piece of memory
 41932                                  
 41933                                  ; MSDOS 6.0
 41934                                  ;----------------------------------------------------------------------------
 41935                                  ;**	$DEALLOC - Free Heap Memory
 41936                                  ;
 41937                                  ;	ENTRY	(es) = address of item
 41938                                  ;
 41939                                  ;	EXIT	'C' clear of OK
 41940                                  ;		'C' set if error
 41941                                  ;		  (AX) = error_invalid_block
 41942                                  ;	USES	???? BUGBUG
 41943                                  
 41944                                  ; MSDOS 2.11 (& MSDOS 3.3)
 41945                                  ;----------------------------------------------------------------------------
 41946                                  ;SUBTTL $DEALLOC - free previously allocated piece of memory
 41947                                  ;
 41948                                  ;   Assembler usage:
 41949                                  ;           MOV     ES,block
 41950                                  ;           MOV     AH,dealloc
 41951                                  ;           INT     21h
 41952                                  ;
 41953                                  ;   Error return:
 41954                                  ;           AX = error_invalid_block
 41955                                  ;              = error_arena_trashed
 41956                                  ;---------------------------------------------------------------------------- 
 41957                                  
 41958                                  	; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 41959                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 41960                                  _$DEALLOC:
 41961                                  	; 14/05/2019 - Retro DOS v4.0    
 41962                                  	; 04/08/2018 - Retro DOS v3.0
 41963                                  	;EnterCrit   critMem
 41964 00007108 E879A7                  	call	ECritMEM ; MSDOS 3.3 & MSDOS 6.0
 41965                                  
 41966                                  	; MSDOS 6.0			; M016, M068 - Start
 41967 0000710B 36F606[8600]04          	test	byte [ss:DOS_FLAG],EXECA20OFF
 41968                                  					; Q: was the previous call an int 21
 41969                                  					;    exec call
 41970 00007111 740D                    	jz	short deallocate	; N: continue
 41971 00007113 36803E[8500]00          	cmp	byte [ss:A20OFF_COUNT], 0 ; Q: is count 0
 41972 00007119 7505                    	jne	short deallocate	; N: continue
 41973                                  	;mov	byte [ss:A20OFF_COUNT], 1 ; Y: set count to 1
 41974                                  	; 25/09/2023
 41975 0000711B 36FE06[8500]            	inc	byte [ss:A20OFF_COUNT]
 41976                                  deallocate:				; M016, M068 - End
 41977 00007120 BF0000                  	MOV     DI,ARENA.SIGNATURE ; = 0
 41978 00007123 8CC0                            MOV     AX,ES
 41979 00007125 48                              DEC     AX
 41980 00007126 E838FE                          CALL    check_signature
 41981 00007129 720A                            JC      SHORT dealloc_err
 41982 0000712B 26893E0100                      MOV     [ES:ARENA.OWNER],DI
 41983                                  	;LeaveCrit critMem
 41984 00007130 E87EA7                  	call    LCritMEM ; MSDOS 3.3 & MSDOS 6.0
 41985                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 41986                                          ;transfer SYS_RET_OK
 41987                                  dealloc_ok:
 41988 00007133 EBAC                    	jmp	short alloc_ok
 41989                                  	;JMP	SYS_RET_OK
 41990                                  
 41991                                  dealloc_err:
 41992                                  	;LeaveCrit critMem
 41993 00007135 E879A7                  	call    LCritMEM ; MSDOS 3.3 & MSDOS 6.0
 41994                                          ;error	error_invalid_block
 41995                                  	;mov	al,9
 41996 00007138 B009                    	MOV	AL,error_invalid_block
 41997                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 41998                                  dealloc_errj:
 41999                                  AllocOperErrj:	; 17/12/2022
 42000 0000713A E93895                  	JMP	SYS_RET_ERR
 42001                                  
 42002                                  ;	BREAK $AllocOper - get/set allocation mechanism
 42003                                  
 42004                                  ; MSDOS 6.0
 42005                                  ;----------------------------------------------------------------------------
 42006                                  ;**	$AllocOper - Get/Set Allocation Mechanism
 42007                                  ;
 42008                                  ;	Assembler usage:
 42009                                  ;           MOV     AH,AllocOper
 42010                                  ;           MOV     BX,method
 42011                                  ;           MOV     AL,func
 42012                                  ;           INT     21h
 42013                                  ;
 42014                                  ;	ENTRY	
 42015                                  ;		(al) = 0
 42016                                  ;		  Get allocation Strategy in (ax)
 42017                                  ;
 42018                                  ;		(al) = 1, (bx) = method = zw0000xy
 42019                                  ;		  Set allocation strategy.
 42020                                  ;		   w  = 1  => HIGH_ONLY
 42021                                  ;		   z  = 1  => HIGH_FIRST
 42022                                  ;		   xy = 00 => FIRST_FIT
 42023                                  ;		      = 01 => BEST_FIT
 42024                                  ;		      = 10 => LAST_FIT
 42025                                  ;
 42026                                  ;		(al) = 2
 42027                                  ;		  Get UMB link state in (al)
 42028                                  ;
 42029                                  ;		(al) = 3
 42030                                  ;		  Set UMB link state
 42031                                  ;		   (bx) = 0 => Unlink UMBs
 42032                                  ;		   (bx) = 1 => Link UMBs
 42033                                  ;
 42034                                  ;
 42035                                  ;	EXIT	'C' clear if OK
 42036                                  ;
 42037                                  ;		 if (al) = 0
 42038                                  ;		  (ax) = existing method
 42039                                  ;		 if (al) = 1
 42040                                  ;		  Sets allocation strategy
 42041                                  ;		 if (al) = 2
 42042                                  ;		  (al) = 0 => UMBs not linked
 42043                                  ;		  (al) = 1 => UMBs linked in
 42044                                  ;		 if (al) = 3
 42045                                  ;		  Links/Unlinks the UMBs into DOS chain
 42046                                  ;
 42047                                  ;		'C' set if error
 42048                                  ;		  AX = error_invalid_function
 42049                                  ;
 42050                                  ;	Rev. M000 - added support for HIGH_FIRST in (al) = 1. 7/9/90
 42051                                  ; 	Rev. M003 - added functions (al) = 2 and (al) = 3. 7/18/90
 42052                                  ;	Rev. M009 - (al) = 3 will return 'invalid function' in ax if
 42053                                  ;		    umbhead has'nt been initialized by sysinit and 'trashed
 42054                                  ;		    arena' if an arena sig is damaged.
 42055                                  ;----------------------------------------------------------------------------
 42056                                  
 42057                                  ; MSDOS 2.11 (& MSDOS 3.3)
 42058                                  ;----------------------------------------------------------------------------
 42059                                  ;SUBTTL $AllocOper - get/set allocation mechanism
 42060                                  ;
 42061                                  ;   Assembler usage:
 42062                                  ;           MOV     AH,AllocOper
 42063                                  ;           MOV     BX,method
 42064                                  ;           MOV     AL,func
 42065                                  ;           INT     21h
 42066                                  ;
 42067                                  ;   Error return:
 42068                                  ;           AX = error_invalid_function
 42069                                  ;----------------------------------------------------------------------------
 42070                                  
 42071                                  	; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 42072                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 42073                                  _$ALLOCOPER:
 42074                                  	; 14/05/2019 - Retro DOS v4.0
 42075                                  	; MSDOS 6.0
 42076 0000713D 08C0                    	or	al,al ; 0
 42077 0000713F 7411                    	jz	short AllocGetStrat
 42078                                  	; 17/12/2022
 42079                                  	;cmp	al,1
 42080                                  	;jz	short AllocSetStrat
 42081                                  
 42082                                  	; 01/12/2022
 42083                                  	;cmp	al, 2
 42084                                  	;jb	short AllocSetStrat
 42085                                  	;ja	short AllocSetLink
 42086                                  	;;jmp	short AllocGetLink
 42087                                  ;AllocGetLink:
 42088                                  	; MSDOS 6.0
 42089                                  	;mov	al,[ss:UMBFLAG]		; return link state in al
 42090                                  	;and 	al,LINKSTATE
 42091                                  	;;transfer SYS_RET_OK
 42092                                  	;jmp	SYS_RET_OK
 42093                                  
 42094 00007141 3C02                    	cmp	al,2
 42095                                  	; 17/12/2022
 42096 00007143 7216                    	jb	short AllocSetStrat ; al = 1
 42097 00007145 7425                    	je	short AllocGetLink
 42098                                  
 42099                                  	;cmp	al,2
 42100                                  	;jz	short AllocGetLink
 42101 00007147 3C03                    	cmp	al,3
 42102 00007149 7429                    	jz	short AllocSetLink
 42103                                  
 42104                                  	; 15/04/2018
 42105                                  	;CMP	AL,1
 42106                                          ;JB	SHORT AllocOperGet
 42107                                          ;JZ	SHORT AllocOperSet
 42108                                  
 42109                                  AllocOperError:
 42110                                  
 42111                                  ; 10/03/2024
 42112                                  %if 0
 42113                                  	; 04/08/2018 - Retro DOS v3.0
 42114                                  	; MSDOS 3.3 (& MSDOS 6.0)	; Extended Error Locus
 42115                                  	;mov	byte [ss:EXTERR_LOCUS],5
 42116                                          MOV     byte [SS:EXTERR_LOCUS],errLOC_Mem
 42117                                  	;error	error_invalid_function
 42118                                  %else
 42119                                  	; 10/03/2024 - Retro DOS v5.0 
 42120                                  	; (PCDOS 7.1 IBMDOS.COM)
 42121                                  	;;;
 42122 0000714B E87FA1                  	call	set_exerr_locus_mem
 42123                                  	;;;
 42124                                  %endif
 42125                                  	;mov	al,1
 42126 0000714E B001                    	MOV	AL,error_invalid_function
 42127                                  	; 17/12/2022
 42128                                  ;AllocOperErrj:
 42129                                  	;JMP	SYS_RET_ERR
 42130                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42131                                  	;jmp	short dealloc_errj
 42132                                  	; 17/12/2022
 42133 00007150 EBE8                    	jmp	short AllocOperErrj
 42134                                  
 42135                                  ; 10/03/2024 - Retro DOS v5.0 
 42136                                  ; (PCDOS 7.1 IBMDOS.COM)
 42137                                  %if 0
 42138                                  AllocArenaError:
 42139                                  	; MSDOS 6.0
 42140                                  	MOV     byte [SS:EXTERR_LOCUS],errLOC_Mem
 42141                                  					; M009: Extended Error Locus
 42142                                  	;error	error_arena_trashed	; M009:
 42143                                  	;mov	al,7
 42144                                  	MOV	AL,error_arena_trashed
 42145                                  	;JMP	SYS_RET_ERR
 42146                                  	jmp	short AllocOperErrj ; 17/12/2022
 42147                                  %endif
 42148                                  
 42149                                  AllocGetStrat: 
 42150                                  	; MSDOS 6.0
 42151                                  AllocOperGet:
 42152 00007152 36A0[0203]                      MOV     AL,[SS:AllocMethod]
 42153 00007156 30E4                            XOR     AH,AH
 42154                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42155                                  	;transfer SYS_RET_OK
 42156                                  AllocOperOk:
 42157                                  	; 17/12/2022
 42158                                  	;jmp	short dealloc_ok
 42159 00007158 E91095                  	JMP	SYS_RET_OK
 42160                                  
 42161                                  AllocSetStrat: 
 42162                                  	; 14/05/2019
 42163                                  	; MSDOS 6.0
 42164 0000715B 53                      	push	bx			; M000 - start
 42165                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42166                                  	;and	bx,STRAT_MASK ; 0FF3Fh	; M064: mask off bit 6 & 7
 42167                                  	; 17/12/2022
 42168 0000715C 80E33F                  	and	bl,3Fh
 42169 0000715F 83FB02                  	cmp	bx,2			; BX must be 0-2
 42170                                  	;cmp	bl,2
 42171 00007162 5B                      	pop	bx			; M000 - end
 42172 00007163 77E6                    	ja	short AllocOperError
 42173                                  
 42174                                  AllocOperSet:
 42175 00007165 36881E[0203]                    MOV     [SS:AllocMethod],BL
 42176                                    	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42177                                  	;transfer SYS_RET_OK
 42178                                  AllocOperOkj:
 42179 0000716A EBEC                    	jmp	short AllocOperOk
 42180                                  	;JMP	SYS_RET_OK
 42181                                  
 42182                                  AllocGetLink:
 42183                                  	; MSDOS 6.0
 42184 0000716C 36A0[8900]              	mov	al,[ss:UMBFLAG]		; return link state in al
 42185                                  	;and	al,1
 42186 00007170 2401                    	and 	al,LINKSTATE
 42187                                   	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42188                                  	;transfer SYS_RET_OK
 42189                                  AllocOperOkj2:
 42190                                  	; 17/12/2022
 42191 00007172 EBE4                    	jmp	short AllocOperOk
 42192                                  	;jmp	short AllocOperOkj
 42193                                  	;;JMP	SYS_RET_OK
 42194                                  
 42195                                  AllocSetLink:
 42196                                  	; MSDOS 6.0			; M009 - start
 42197 00007174 368B0E[8C00]            	mov	cx,[ss:UMB_HEAD]	; cx = umb_head
 42198                                  
 42199                                  ; 10/03/2024
 42200                                  %if 0
 42201                                  	cmp	cx,0FFFFh		; Q: has umb_head been initialized
 42202                                  	je	short AllocOperError	; N: error
 42203                                  					; Y: continue
 42204                                  					; M009 - end
 42205                                  	cmp	bx,1
 42206                                  	jb	short UnlinkUmbs ; 0
 42207                                  	jz	short LinkUmbs   ; 1
 42208                                  %else
 42209                                  	; 10/03/2024 - Retro DOS v5.0
 42210                                  	; (PCDOS 7.1 IBMDOS.COM)
 42211                                  	;;;
 42212 00007179 41                      	inc	cx 			; Q: has umb_head been initialized
 42213 0000717A 74CF                    	jz	short AllocOperError	; -1 ; N: error
 42214 0000717C 49                      	dec	cx
 42215 0000717D 4B                      	dec	bx
 42216 0000717E 7418                    	jz	short LinkUmbs ; 1
 42217 00007180 43                      	inc	bx
 42218                                  	;jz	short UnlinkUmbs ; 0
 42219                                  	;;;
 42220                                  %endif
 42221                                  	;jmp	short AllocOperError
 42222                                  	; 10/03/2024
 42223 00007181 75C8                    	jnz	short AllocOperError ; > 1
 42224                                  	
 42225                                  UnlinkUmbs:
 42226                                  
 42227                                  ; 10/03/2024
 42228                                  %if 0
 42229                                  	;test	byte [ss:UMBFLAG],1
 42230                                  	test	byte [ss:UMBFLAG],LINKSTATE ; Q: umbs unlinked?
 42231                                  	jz	short unlinked		; Y: return 
 42232                                  	
 42233                                  	call	GetLastArena		; get arena before umb_head in DS
 42234                                  	jc	short AllocArenaError	; M009: arena trashed
 42235                                  %else
 42236                                  	; 10/03/2024 - Retro DOS v5.0
 42237                                  	; (PCDOS 7.1 IBMDOS.COM)
 42238                                  	;;;
 42239 00007183 E89BFD                  	call	test_umb_flag	; test byte [ss:UMBFLAG],LINKSTATE
 42240                                  				; Q: umbs unlinked?
 42241 00007186 740E                    	jz	short unlinked	; Y: return
 42242 00007188 E82200                  	call	GetLastArena	; get arena before umb_head in DS
 42243                                  	;;;
 42244                                  %endif
 42245                                  					; make it last
 42246 0000718B C60600005A              	mov	byte [0],arena_signature_end
 42247                                  	
 42248                                  	;and	byte [ss:UMBFLAG],0FEh
 42249 00007190 368026[8900]FE          	and	byte [ss:UMBFLAG],~LINKSTATE ; indicate unlink'd state in umbflag
 42250                                  	
 42251                                  unlinked:
 42252                                   	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42253                                  	;transfer SYS_RET_OK
 42254                                  	; 17/12/2022
 42255 00007196 EBC0                    	jmp	short AllocOperOk
 42256                                  	;jmp	short AllocOperOkj2
 42257                                  	;;JMP	SYS_RET_OK
 42258                                  
 42259                                  LinkUmbs:
 42260                                  
 42261                                  ; 10/03/2024
 42262                                  %if 0
 42263                                  	test	byte [ss:UMBFLAG],LINKSTATE ; Q: umbs linked?
 42264                                  	jnz	short linked		; Y: return
 42265                                  	
 42266                                  	call	GetLastArena		; get arena before umb_head
 42267                                  	jc	short AllocArenaError	; M009: arena trashed
 42268                                  	
 42269                                  					; make it normal. M061: ds points to
 42270                                  %else					; arena before umb_head
 42271                                  	; 10/03/2024 - Retro DOS v5.0
 42272                                  	; (PCDOS 7.1 IBMDOS.COM)
 42273                                  	;;;
 42274 00007198 E886FD                  	call	test_umb_flag	; Q: umbs linked?
 42275 0000719B 750E                    	jnz	short linked	; Y: return
 42276 0000719D E80D00                  	call	GetLastArena	; get arena before umb_head
 42277                                  	;;;
 42278                                  %endif
 42279 000071A0 C60600004D              	mov	byte [0],arena_signature_normal
 42280                                  
 42281 000071A5 36800E[8900]01          	or	byte [ss:UMBFLAG],LINKSTATE ; indicate link'd state in umbflag
 42282                                  linked:
 42283                                   	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42284                                  	;transfer SYS_RET_OK
 42285                                  	; 17/12/2022
 42286 000071AB EBAB                    	jmp	short AllocOperOk
 42287                                  	;jmp	short unlinked
 42288                                  	;;JMP	SYS_RET_OK
 42289                                  
 42290                                  ; MSDOS 6.0
 42291                                  ;--------------------------------------------------------------------------
 42292                                  ; Procedure Name : GetLastArena		-  M003
 42293                                  ;
 42294                                  ; Inputs	 : cx = umb_head
 42295                                  ;
 42296                                  ;
 42297                                  ; Outputs	 : If UMBs are linked
 42298                                  ;			ES = umb_head
 42299                                  ;			DS = arena before umb_head
 42300                                  ;		   else
 42301                                  ;			DS = last arena
 42302                                  ;			ES = next arena. will be umb_head if NC.
 42303                                  ;
 42304                                  ;		   CY if error
 42305                                  ;
 42306                                  ; Uses		 : DS, ES, DI, BX
 42307                                  ;--------------------------------------------------------------------------
 42308                                  
 42309                                  ; 14/05/2019 - Retro DOS v4.0
 42310                                  ; DOSCODE:A4D6h (MSDOS 6.21, MSDOS.SYS)
 42311                                  
 42312                                  ; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 42313                                  ; DOSCODE:A476h (MSDOS 5.0, MSDOS.SYS)
 42314                                  
 42315                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 42316                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B6D9h
 42317                                  
 42318                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0A4D6h)
 42319                                  	; (Windows ME IO.SYS - BIOSCODE:9F25h)
 42320                                  
 42321                                  GetLastArena:
 42322 000071AD 50                      	push	ax			; save ax
 42323                                  
 42324 000071AE 36A1[2400]              	mov	ax,[ss:arena_head]
 42325 000071B2 8EC0                    	mov	es,ax			; es = arena_head
 42326 000071B4 31FF                    	xor	di,di
 42327                                  
 42328 000071B6 26803D5A                	cmp     byte [es:di],arena_signature_end
 42329                                  					; Q: is this the last arena
 42330 000071BA 7416                    	je	short GLA_done		; Y: return last arena in ES
 42331                                  
 42332                                  GLA_next:
 42333 000071BC 8ED8                    	mov	ds,ax
 42334 000071BE E899FD                  	call	arena_next		; ax, es -> next arena
 42335                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42336                                  	;jc	short GLA_err
 42337                                  	; 17/12/2022
 42338 000071C1 7222                    	jc	short GLA_err2
 42339                                  
 42340                                  ; 10/03/2024
 42341                                  %if 0
 42342                                  	test	byte [ss:UMBFLAG],LINKSTATE ; Q: are UMBs linked
 42343                                  	jnz	short GLA_chkumb	; Y: terminating condition is
 42344                                  					;    umb_head
 42345                                  					; N: terminating condition is 05Ah
 42346                                  %else
 42347                                  	; 10/03/2024 (PCDOS 7.1 IBMDOS.COM)
 42348                                  	;;;
 42349 000071C3 E85BFD                  	call	test_umb_flag
 42350 000071C6 7506                    	jnz	short GLA_chkumb
 42351                                  	;;;
 42352                                  %endif
 42353 000071C8 26803D5A                	cmp     byte [es:di],arena_signature_end
 42354                                  					; Q: is this the last arena
 42355 000071CC EB02                    	jmp	short GLA_@f
 42356                                  GLA_chkumb:
 42357 000071CE 39C8                    	cmp	ax,cx			; Q: is this umb_head
 42358                                  GLA_@f:
 42359 000071D0 75EA                    	jne	short GLA_next		; N: get next arena
 42360                                  
 42361                                  GLA_done:
 42362                                  
 42363                                  ; 10/03/2024
 42364                                  %if 0
 42365                                  					; M061 - Start
 42366                                  	test	byte [ss:UMBFLAG],LINKSTATE ; Q: are UMBs linked
 42367                                  	jnz	short GLA_ret		; Y: we're done
 42368                                  					; N: let us confirm that the next
 42369                                  					;    arena is umb_head
 42370                                  %else
 42371                                  	; 10/03/2024 (PCDOS 7.1 IBMDOS.COM)
 42372                                  	;;;
 42373 000071D2 E84CFD                  	call	test_umb_flag
 42374 000071D5 750B                    	jnz	short GLA_ret ; cf=0
 42375                                  	;;;
 42376                                  %endif
 42377 000071D7 8ED8                    	mov	ds,ax
 42378 000071D9 E87EFD                  	call	arena_next		; ax, es -> next arena
 42379                                  	;jc	short GLA_err
 42380 000071DC 7207                    	jc	short GLA_err2
 42381 000071DE 39C8                    	cmp	ax,cx			; Q: is this umb_head
 42382 000071E0 7502                    	jne	short GLA_err		; N: error
 42383                                  					; M061 - End
 42384                                  GLA_ret:
 42385                                  	; 17/12/2022
 42386                                  	;clc
 42387                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42388                                  	;clc
 42389 000071E2 58                      	pop	ax			; M061
 42390 000071E3 C3                      	retn				; M061
 42391                                  
 42392                                  GLA_err:
 42393 000071E4 F9                      	stc				; M061
 42394                                  GLA_err2:
 42395 000071E5 58                      	pop	ax
 42396                                  
 42397                                  	; 10/03/2024 - Retro DOS v5.0 
 42398                                  	; (PCDOS 7.1 IBMDOS.COM)
 42399                                  	;;;
 42400 000071E6 58                      	pop	ax	; return address to _$ALLOCOPER (the caller)
 42401 000071E7 E8E3A0                  	call	set_exerr_locus_mem
 42402 000071EA E910FE                  	jmp	alloc_trashed2	; (error return from _$ALLOCOPER)
 42403                                  	;;;
 42404                                  
 42405                                  	; 10/03/2024
 42406                                  	;retn
 42407                                  
 42408                                  ;============================================================================
 42409                                  ; SRVCALL.ASM, MSDOS 6.0, 1991
 42410                                  ;============================================================================
 42411                                  ; 04/08/2018 - Retro DOS v3.0
 42412                                  
 42413                                  ;	TITLE SRVCALL - Server DOS call
 42414                                  ;	NAME  SRVCALL
 42415                                  
 42416                                  ;**	SRVCALL.ASM - Server DOS call functions
 42417                                  ;
 42418                                  ;
 42419                                  ;	$ServerCall
 42420                                  ;
 42421                                  ;	Modification history:
 42422                                  ;
 42423                                  ;	    Created: ARR 08 August 1983
 42424                                  
 42425                                  ;AsmVars <Installed>
 42426                                  
 42427                                  ;include dpl.asm
 42428                                  
 42429                                  ;Installed = TRUE
 42430                                  
 42431                                  ; 29/04/2019 - Retro DOS v4.0 (MSDOS 6.0, MSDOS 6.21)
 42432                                  ; ---------------------------------------------------------------------------
 42433                                  ; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 42434                                  
 42435                                  ;BREAK <ServerCall -- Server DOS call>
 42436                                  
 42437                                  ; DOSCODE:A517h (MSDOS 6.21, MSDOS.SYS)
 42438                                  ; DOSCODE:A4B7h (MSDOS 5.0, MSDOS.SYS)
 42439                                  
 42440                                  ; 10/03/2024
 42441                                  ; DOSCODE:B71Ah (PCDOS 7.1, IBMDOS.COM) ; Retro DOS v5.0
 42442                                  ; DOSCODE:A517h (MSDOS 6.22, MSDOS.SYS) ; Retro DOS v4.2
 42443                                  ; BIOSCODE:9F66h (Windows ME, IO.SYS)
 42444                                  
 42445                                  ;hkn; TABLE	SEGMENT
 42446                                  ;Public SRVC001S,SRVC001E
 42447                                  ;SRVC001S label byte
 42448                                  
 42449                                  SRVC001S:
 42450                                  
 42451 000071ED [F171]                  SERVERTAB:	dw	SERVER_DISP
 42452 000071EF [4072]                  SERVERLEAVE:	dw	SERVERRETURN
 42453 000071F1 0B                      SERVER_DISP:	db	(SERVER_DISP_END-SERVER_DISP-1)/2 ; = 11
 42454 000071F2 [A672]                  		dw	SRV_CALL	; 0
 42455 000071F4 [4172]                  		dw	COMMIT_ALL	; 1
 42456 000071F6 [7772]                  		dw	CLOSE_NAME	; 2
 42457 000071F8 [8072]                  		dw	CLOSE_UID	; 3
 42458 000071FA [8772]                  		dw	CLOSE_UID_PID	; 4
 42459 000071FC [8E72]                  		dw	GET_LIST	; 5
 42460 000071FE [E772]                  		dw	GET_DOS_DATA	; 6
 42461 00007200 [0B73]                  		dw	SPOOL_OPER	; 7
 42462 00007202 [0B73]                  		dw	SPOOL_OPER	; 8
 42463 00007204 [0B73]                  		dw	SPOOL_OPER	; 9
 42464 00007206 [1773]                  		dw	_$SetExtendedError  ; 10
 42465                                  
 42466                                  SERVER_DISP_END:  ;  LABEL BYTE
 42467                                  
 42468                                  ;SRVC001E label byte
 42469                                  
 42470                                  SRVC001E:
 42471                                  
 42472                                  ;hkn; TABLE	ENDS
 42473                                  
 42474                                  ;----------------------------------------------------------------------------
 42475                                  ;
 42476                                  ; Procedure Name : $ServerCall
 42477                                  ;
 42478                                  ; Inputs:
 42479                                  ;	DS:DX -> DPL  (except calls 7,8,9)
 42480                                  ; Function:
 42481                                  ;	AL=0	Server DOS call
 42482                                  ;	AL=1	Commit All files
 42483                                  ;	AL=2	Close file by name (SHARING LOADED ONLY) DS:DX in DPL -> name
 42484                                  ;	AL=3	Close all files for DPL_UID
 42485                                  ;	AL=4	Close all files for DPL_UID/PID_PID
 42486                                  ;	AL=5	Get open file list entry
 42487                                  ;		    IN: BX File Index
 42488                                  ;			CX User Index
 42489                                  ;		    OUT:ES:DI -> Name
 42490                                  ;			BX = UID
 42491                                  ;		    CX = # locked blocks held by this UID
 42492                                  ;	AL=6	Get DOS data area
 42493                                  ;		    OUT: DS:SI -> Start
 42494                                  ;			CX size in bytes of swap if indos
 42495                                  ;			DX size in bytes of swap always
 42496                                  ;	AL=7	Get truncate flag
 42497                                  ;	AL=8	Set truncate flag
 42498                                  ;	AL=9	Close all spool files
 42499                                  ;	AL=10	SetExtendedError
 42500                                  ;
 42501                                  ;----------------------------------------------------------------------------
 42502                                  
 42503                                  	; 10/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 42504                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B735h
 42505                                  
 42506                                  _$ServerCall:
 42507                                  	; 13/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 42508                                  	; DOSCODE:A4D2h (MSDOS 5.0 MSDOS.SYS)		
 42509                                  	; 10/06/2019
 42510                                  	; 29/04/2019 - Retro DOS v4.0
 42511                                  	; DOSCODE:A532h (MSDOS 6.21 MSDOS.SYS)
 42512                                  
 42513                                  	; 05/08/2018 - Retro DOS v3.0
 42514                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 657Bh
 42515 00007208 3C07                    	CMP	AL,7
 42516 0000720A 7204                    	JB	short SET_STUFF
 42517 0000720C 3C09                    	CMP	AL,9
 42518 0000720E 761A                    	JBE	short NO_SET_ID		; No DPL on calls 7,8,9
 42519                                  SET_STUFF:
 42520 00007210 89D6                    	MOV	SI,DX			; Point to DPL with DS:SI
 42521                                  	;mov	bx,[si+12h]
 42522 00007212 8B5C12                  	MOV	BX,[SI+DPL.UID]
 42523                                  
 42524                                  	; MSDOS 6.0
 42525                                  ;SR;
 42526                                  ; WIN386 updates the USER_ID itself. If WIN386 is present we skip the updating
 42527                                  ; of USER_ID
 42528                                  
 42529 00007215 36F606[470F]01          	test	byte [SS:IsWin386],1
 42530 0000721B 7505                    	jnz	short skip_win386
 42531                                  
 42532                                  ;hkn; SS override for user_id and proc_id
 42533                                  	; 15/08/2018
 42534 0000721D 36891E[3E03]            	MOV	[SS:USER_ID],BX		; Set UID
 42535                                  
 42536                                  skip_win386:
 42537 00007222 8B5C14                  	MOV	BX,[SI+DPL.PID]
 42538 00007225 36891E[3C03]            	MOV	[SS:PROC_ID],BX		; Set process ID
 42539                                  NO_SET_ID:
 42540                                  	; 10/06/2019 - Retro DOS v4.0
 42541 0000722A 2EFF36[EF71]            	PUSH	word [cs:SERVERLEAVE]	; push return address
 42542 0000722F 2EFF36[ED71]            	PUSH	word [cs:SERVERTAB]	; push table address
 42543 00007234 50                      	PUSH	AX
 42544 00007235 E8A3A5                  	call	TableDispatch
 42545                                  
 42546                                  ;hkn; SS override
 42547                                  	;;mov 	byte [SS:EXETERR_LOCUS],1
 42548                                  	;MOV	byte [SS:EXTERR_LOCUS],errLOC_Unk ; Extended Error Locus
 42549                                  	; 01/07/2024
 42550 00007238 E87FA0                  	call	set_exerr_locus_unk
 42551                                  
 42552                                  	;error	error_invalid_function
 42553                                  	;mov	al,1
 42554 0000723B B001                    	MOV	AL,error_invalid_function
 42555                                  servercall_error:
 42556 0000723D E93594                  	JMP	SYS_RET_ERR
 42557                                  
 42558                                  SERVERRETURN:
 42559 00007240 C3                      	retn
 42560                                  
 42561                                  ; Commit - iterate through the open file list and make sure that the
 42562                                  ; directory entries are correctly updated.
 42563                                  
 42564                                  	; 01/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 42565                                  COMMIT_ALL:
 42566 00007241 31DB                    	XOR	BX,BX			; for (i=0; ThisSFT=getSFT(i); i++)
 42567 00007243 16                      	push	ss
 42568 00007244 1F                      	pop	ds
 42569 00007245 E83CA6                  	call	ECritSFT		; Gonna scan SFT cache, lock it down
 42570                                  CommitLoop:
 42571 00007248 53                      	push	bx
 42572 00007249 E82201                  	call	SFFromSFN
 42573 0000724C 7222                    	JC	short CommitDone
 42574 0000724E 26833D00                	cmp	word [es:di],0
 42575                                  	;CMP	word [ES:DI+SF_ENTRY.sf_Ref_Count],0
 42576                                  					; if (ThisSFT->refcount != 0)
 42577 00007252 7418                    	JZ	short CommitNext
 42578                                  	;cmp	word [es:di],0FFFFh ; -1
 42579 00007254 26833DFF                	cmp	word [ES:DI],sf_busy
 42580                                  	;CMP	word [ES:DI+SF_ENTRY.sf_Ref_Count],sf_busy  
 42581                                  					; BUSY SFTs have god knows what
 42582 00007258 7412                    	JZ	short CommitNext	;   in them.
 42583                                  	; 17/12/2022
 42584 0000725A 26F6450680              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_isnet>>8) ; 80h
 42585                                  	;TEST	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet ; 8000h
 42586 0000725F 750B                    	JNZ	short CommitNext	; Skip Network SFTs so the SERVER
 42587                                  					;      doesn't deadlock
 42588 00007261 893E[9E05]              	MOV	[THISSFT],DI
 42589 00007265 8C06[A005]              	MOV	[THISSFT+2],ES
 42590 00007269 E84AC5                  	call	DOS_COMMIT		; DOSCommit ();
 42591                                  CommitNext:
 42592 0000726C 5B                      	pop	bx
 42593 0000726D 43                      	INC	BX
 42594 0000726E EBD8                    	JMP	short CommitLoop
 42595                                  CommitDone:
 42596 00007270 E83EA6                  	call	LCritSFT
 42597 00007273 5B                      	pop	bx
 42598                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42599                                  Commit_Ok:
 42600 00007274 E9F493                  	jmp	SYS_RET_OK
 42601                                  	
 42602                                  CLOSE_NAME:
 42603                                  
 42604                                  ;if installed
 42605                                  
 42606                                  ;hkn; SS override
 42607                                  	;call	far [ss:MFTcloN]
 42608 00007277 36FF1E[A400]            	Call	far [SS:JShare+(5*4)] ; 5 = MFTcloN
 42609                                  ;else
 42610                                  ;	Call	MFTcloN
 42611                                  ;endif
 42612                                  
 42613                                  CheckReturns:
 42614                                  
 42615                                  ; 10/03/2024
 42616                                  %if 0
 42617                                  	JC	short func_err
 42618                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42619                                  	;transfer SYS_RET_OK
 42620                                  Commit_Okj:
 42621                                  	jmp	short Commit_Ok
 42622                                  	;jmp	SYS_RET_OK
 42623                                  %else
 42624 0000727C 73F6                    	jnc	short Commit_Ok
 42625                                  %endif
 42626                                  
 42627                                  func_err:
 42628                                  	;transfer SYS_RET_ERR
 42629                                  	;jmp	SYS_RET_ERR
 42630 0000727E EBBD                    	jmp	short servercall_error
 42631                                  
 42632                                  CLOSE_UID:
 42633                                  
 42634                                  ;if installed
 42635                                  ;hkn; SS override
 42636                                  	;call	far [ss:MFTclU]
 42637 00007280 36FF1E[9C00]            	Call	far [SS:JShare+(3*4)] ; 3 = MTFTclu
 42638                                  ;else
 42639                                  ;	Call	MFTclU
 42640                                  ;endif
 42641 00007285 EBF5                    	JMP	short CheckReturns
 42642                                  
 42643                                  CLOSE_UID_PID:
 42644                                  
 42645                                  ;if installed
 42646                                  ;hkn; SS override
 42647                                  	;call	far [ss:MFTCloseP]
 42648 00007287 36FF1E[A000]            	Call	far [SS:JShare+(4*4)] ; 4 = MFTCloseP
 42649                                  ;else
 42650                                  ;	Call	MFTCloseP
 42651                                  ;endif
 42652 0000728C EBEE                    	JMP	short CheckReturns
 42653                                  
 42654                                  GET_LIST:
 42655                                  
 42656                                  ;if installed
 42657                                  ;hkn; SS override
 42658                                  	;call	far [ss:MFT_get]
 42659 0000728E 36FF1E[B400]            	Call	far [SS:JShare+(9*4)] ; 9 = MFT_get
 42660                                  ;else
 42661                                  ;	Call	MFT_get
 42662                                  ;endif
 42663 00007293 72E9                    	JC	short func_err
 42664 00007295 E8DF91                  	call	Get_User_Stack
 42665                                  	;mov	[si+2],bx
 42666 00007298 895C02                  	MOV	[SI+user_env.user_BX],BX
 42667                                  	;mov	[si+10],di
 42668 0000729B 897C0A                  	MOV	[SI+user_env.user_DI],DI
 42669                                  	;mov	[si+16],es
 42670 0000729E 8C4410                  	MOV	[SI+user_env.user_ES],ES
 42671                                  SetCXOK:
 42672                                  	;mov	[si+4],cx
 42673 000072A1 894C04                  	MOV	[SI+user_env.user_CX],CX
 42674                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42675                                  	;transfer SYS_RET_OK
 42676                                  Commit_Okj2:
 42677                                  	; 17/12/2022
 42678 000072A4 EBCE                    	jmp	short Commit_Ok
 42679                                  	;jmp	short Commit_Okj
 42680                                  	;;jmp	SYS_RET_OK
 42681                                  
 42682                                  SRV_CALL:
 42683 000072A6 58                      	POP	AX			; get rid of call to $srvcall
 42684 000072A7 1E                      	push	ds
 42685 000072A8 56                      	push	si
 42686 000072A9 E8CB91                  	call	Get_User_Stack
 42687 000072AC 5F                      	pop	di
 42688 000072AD 07                      	pop	es
 42689                                  
 42690                                  ; DS:SI point to stack
 42691                                  ; ES:DI point to DPL
 42692                                  
 42693 000072AE E809A5                  	call	XCHGP
 42694                                  
 42695                                  ; DS:SI point to DPL
 42696                                  ; ES:DI point to stack
 42697                                  ;
 42698                                  ; We now copy the registers from DPL to save stack
 42699                                  
 42700 000072B1 56                      	push	si
 42701 000072B2 B90600                  	MOV	CX,6
 42702 000072B5 F3A5                    	REP	MOVSW			; Put in AX,BX,CX,DX,SI,DI
 42703 000072B7 47                      	INC	DI
 42704 000072B8 47                      	INC	DI			; Skip user_BP
 42705 000072B9 A5                      	MOVSW				; DS
 42706 000072BA A5                      	MOVSW				; ES
 42707 000072BB 5E                      	pop	si			; DS:SI -> DPL
 42708 000072BC 8B04                    	mov	ax,[SI]
 42709                                  	;MOV	AX,[SI+DPL.AX]
 42710                                  	;mov	bx,[si+2]
 42711 000072BE 8B5C02                  	MOV	BX,[SI+DPL.BX]
 42712                                  	;mov	cx,[si+4]
 42713 000072C1 8B4C04                  	MOV	CX,[SI+DPL.CX]
 42714                                  	;mov	dx,[si+6]
 42715 000072C4 8B5406                  	MOV	DX,[SI+DPL.DX]
 42716                                  	;mov	di,[si+10]
 42717 000072C7 8B7C0A                  	MOV	DI,[SI+DPL.DI]
 42718                                  	;mov	es,[si+14]
 42719 000072CA 8E440E                  	MOV	ES,[SI+DPL.ES]
 42720                                  	;push	word [si+8]
 42721 000072CD FF7408                  	PUSH	word [SI+DPL.SI]
 42722                                  	;mov	ds,[si+12]
 42723 000072D0 8E5C0C                  	MOV	DS,[SI+DPL.DS]
 42724 000072D3 5E                      	POP	SI
 42725                                  
 42726                                  ;hkn; SS override for next 3
 42727 000072D4 368C1E[EC05]            	MOV	[SS:SAVEDS],DS
 42728 000072D9 36891E[EA05]            	MOV	[SS:SAVEBX],BX
 42729 000072DE 36C606[7205]FF          	MOV	byte [SS:FSHARING],-1	; set no redirect flag
 42730 000072E4 E98E90                  	jmp	REDISP
 42731                                  
 42732                                  GET_DOS_DATA:
 42733 000072E7 16                      	push	ss
 42734 000072E8 07                      	pop	es
 42735 000072E9 BF[2003]                	MOV     DI,SWAP_START
 42736 000072EC B9[FA0A]                	MOV     CX,SWAP_END
 42737 000072EF BA[3A03]                	MOV     DX,SWAP_ALWAYS
 42738 000072F2 29F9                    	SUB     CX,DI
 42739 000072F4 29FA                    	SUB     DX,DI
 42740 000072F6 D1E9                    	SHR     CX,1                    ; div by 2, remainder in carry
 42741 000072F8 83D100                  	ADC     CX,0                    ; div by 2 + round up
 42742 000072FB D1E1                    	SHL     CX,1                    ; round up to 2 boundary.
 42743 000072FD E87791                  	call	Get_User_Stack
 42744                                  	;mov	[si+14],es
 42745 00007300 8C440E                  	MOV     [SI+user_env.user_DS],ES
 42746                                  	;mov	[si+8],di
 42747 00007303 897C08                  	MOV     [SI+user_env.user_SI],DI
 42748                                  	;mov	[si+6],dx
 42749 00007306 895406                  	MOV     [SI+user_env.user_DX],DX
 42750 00007309 EB96                    	JMP	short SetCXOK
 42751                                  
 42752                                  SPOOL_OPER:
 42753                                  	;CallInstall NETSpoolOper,MultNET,37,AX,BX
 42754                                  
 42755 0000730B 50                      	push    ax
 42756 0000730C B82511                  	mov     ax,1125h
 42757 0000730F CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - REDIRECTED PRINTER MODE
 42758                                  			; STACK: WORD subfunction
 42759                                  			; Return: CF set on error, AX = error code
 42760                                  			; STACK unchanged
 42761 00007311 5B                      	pop	bx
 42762                                  	; 17/12/2022
 42763                                  	;JC	short func_err2
 42764 00007312 7390                    	jnc	short Commit_Okj2
 42765                                  	; 01/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42766                                  	;;jmp	SYS_RET_OK
 42767                                  	;jmp	short Commit_Okj2
 42768                                  	
 42769                                  func_err2:
 42770 00007314 E95E93                  	jmp	SYS_RET_ERR
 42771                                  
 42772                                  ;Break	<$SetExtendedError - set extended error for later retrieval>
 42773                                  ;--------------------------------------------------------------------------
 42774                                  ;
 42775                                  ; Procedure Name : $SetExtendedError
 42776                                  ;
 42777                                  ; $SetExtendedError takes extended error information and loads it up for the
 42778                                  ; next extended error call. This is used by interrupt-level proccessors to
 42779                                  ; mask their actions.
 42780                                  ;
 42781                                  ;   Inputs: DS:SI points to DPL which contains all registers
 42782                                  ;   Outputs: none
 42783                                  ;
 42784                                  ;---------------------------------------------------------------------------
 42785                                  
 42786                                  _$SetExtendedError:
 42787                                  
 42788                                  ;hkn; SS override for all variables used
 42789                                  
 42790 00007317 8B04                    	mov	ax,[si]
 42791                                  	;MOV	AX,[SI+DPL.AX]
 42792 00007319 36A3[2403]              	MOV	[SS:EXTERR],AX
 42793                                  	;mov	ax,[si+10]
 42794 0000731D 8B440A                  	MOV	AX,[SI+DPL.DI]
 42795 00007320 36A3[2803]              	MOV	[SS:EXTERRPT],AX
 42796                                  	;mov	ax,[si+14]
 42797 00007324 8B440E                  	MOV	AX,[SI+DPL.ES]
 42798 00007327 36A3[2A03]              	MOV	[SS:EXTERRPT+2],AX
 42799                                  	;mov	ax,[si+2]
 42800 0000732B 8B4402                  	MOV	AX,[SI+DPL.BX]
 42801 0000732E 36A3[2603]              	MOV	[SS:EXTERR_ACTION],AX
 42802                                  	;mov	ax,[si+4]
 42803 00007332 8B4404                  	MOV	AX,[SI+DPL.CX]
 42804 00007335 368826[2303]            	MOV	[SS:EXTERR_LOCUS],AH
 42805 0000733A C3                      	retn
 42806                                  
 42807                                  ;============================================================================
 42808                                  ; UTIL.ASM, MSDOS 6.0, 1991
 42809                                  ;============================================================================
 42810                                  ; 05/08/2018 - Retro DOS v3.0
 42811                                  ; 05/05/2019 - Retro DOS v4.0
 42812                                  ; 11/03/2024 - Retro DOS v5.0
 42813                                  
 42814                                  ;**	Handle related utilities for MSDOS 2.X.
 42815                                  ;----------------------------------------------------------------------------
 42816                                  ;	pJFNFromHandle	written
 42817                                  ;	SFFromHandle	written
 42818                                  ;	SFFromSFN	written
 42819                                  ;	JFNFree 	written
 42820                                  ;	SFNFree 	written
 42821                                  ;
 42822                                  ;	Modification history:
 42823                                  ;
 42824                                  ;	    Created: MZ 1 April 1983
 42825                                  ;----------------------------------------------------------------------------
 42826                                  
 42827                                  ;	BREAK	<pJFNFromHandle - return pointer to JFN table entry>
 42828                                  
 42829                                  ;**	pJFNFromHandle - Translate Handle to Pointer to JFN
 42830                                  ;----------------------------------------------------------------------------
 42831                                  ;	pJFNFromHandle takes a file handle and turns that into a pointer to
 42832                                  ;	the JFN entry (i.e., to a byte holding the internal file handle #)
 42833                                  ;
 42834                                  ;	NOTE:
 42835                                  ;	  This routine is called from $CREATE_PROCESS_DATA_BLOCK which is called
 42836                                  ;	  at DOSINIT time with SS NOT DOSGROUP
 42837                                  ;
 42838                                  ;	ENTRY	(bx) = handle
 42839                                  ;	EXIT	'C' clear if ok
 42840                                  ;		  (es:di) = address of JFN value
 42841                                  ;		'C' set if error
 42842                                  ;		  (ax) = error code
 42843                                  ;	USES	AX, DI, ES, Flags
 42844                                  ;----------------------------------------------------------------------------
 42845                                  
 42846                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 42847                                  	; 11/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 42848                                  
 42849                                  pJFNFromHandle:
 42850                                  	; 05/05/2019 - Retro DOS v4.0
 42851                                  	;getdseg <es>			; es -> dosdata
 42852 0000733B 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 42853                                  	
 42854                                  	;MOV	ES,[cs:CurrentPDB]	; get user process data block
 42855 00007340 268E06[3003]            	mov	es,[es:CurrentPDB]
 42856                                  
 42857                                  	;cmp	bx,[ES:32h]
 42858 00007345 263B1E3200              	CMP	BX,[ES:PDB.JFN_Length]	; is handle greater than allocated
 42859 0000734A 7204                    	JB	short pjfn10		; no, get offset
 42860                                  ReturnCarry_inv_hndl: ; 05/08/2018 - Retro DOS v3.0
 42861                                  	;mov	al,6
 42862 0000734C B006                    	MOV     AL,error_invalid_handle ; appropriate error
 42863                                  ReturnCarry:
 42864 0000734E F9                      	STC                             ; signal error
 42865 0000734F C3                      	retn				; go back
 42866                                  pjfn10: 
 42867                                  	;les	di,[es:34h]
 42868 00007350 26C43E3400              	LES	DI,[ES:PDB.JFN_Pointer]	; get pointer to beginning of table
 42869 00007355 01DF                    	ADD	DI,BX			; add in offset, clear 'C'
 42870                                  	;clc
 42871                                  pJFNFromHandle_error:
 42872 00007357 C3                      	retn
 42873                                  
 42874                                  ;BREAK <SFFromHandle - return pointer (or error) to SF entry from handle>
 42875                                  ;----------------------------------------------------------------------------
 42876                                  ;
 42877                                  ; Procedure Name : SFFromHandle
 42878                                  ;
 42879                                  ; SFFromHandle - Given a handle, get JFN and then index into SF table
 42880                                  ;
 42881                                  ;   Input:      BX has handle
 42882                                  ;   Output:     Carry Set
 42883                                  ;                   AX has error code
 42884                                  ;               Carry Reset
 42885                                  ;                   ES:DI has pointer to SF entry
 42886                                  ;   Registers modified: If error, AX,ES, else ES:DI
 42887                                  ; NOTE:
 42888                                  ;   This routine is called from $CREATE_PROCESS_DATA_BLOCK which is called
 42889                                  ;       at DOSINIT time with SS NOT DOSGROUP
 42890                                  ;
 42891                                  ;----------------------------------------------------------------------------
 42892                                  
 42893                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 42894                                  	; 11/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 42895                                  
 42896                                  SFFromHandle:
 42897 00007358 E8E0FF                  	CALL	pJFNFromHandle		; get jfn pointer
 42898                                  	;retc				; return if error
 42899 0000735B 72FA                    	jc	short pJFNFromHandle_error
 42900 0000735D 26803DFF                	CMP     BYTE [ES:DI],-1		; unused handle
 42901                                  	;JNZ	short GetSF		; nope, suck out SF
 42902                                  	;;mov	al,6
 42903                                  	;MOV	AL,error_invalid_handle ; appropriate error
 42904                                  	;jmp	short ReturnCarry	; signal it
 42905                                  	; 17/12/2022
 42906                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42907 00007361 74E9                    	jz	short ReturnCarry_inv_hndl ; Retro DOS v3.0 modification
 42908                                  	;JNZ	short GetSF		; nope, suck out SF
 42909                                  	;;mov	al,6
 42910                                  	;MOV	AL,error_invalid_handle ; appropriate error
 42911                                  	;jmp	short ReturnCarry	; signal it
 42912                                  GetSF:
 42913 00007363 53                      	push	bx			; save handle
 42914 00007364 268A1D                  	MOV     BL,[ES:DI]		; get SFN
 42915 00007367 30FF                    	XOR     BH,BH                   ; ignore upper half
 42916 00007369 E80200                  	CALL    SFFromSFN               ; get real sf spot
 42917 0000736C 5B                      	pop	bx			; restore
 42918 0000736D C3                      	retn                        	; say goodbye
 42919                                  
 42920                                  ;BREAK <SFFromSFN - index into SF table for SFN>
 42921                                  
 42922                                  ;**	SFFromSFN - Get an SF Table entry from an SFN
 42923                                  ;----------------------------------------------------------------------------
 42924                                  ;	SFFromSfn uses an SFN to index an entry into the SF table. This
 42925                                  ;	is more than just a simple index instruction because the SF table
 42926                                  ;	can be made up of multiple pieces chained together. We follow the
 42927                                  ;	chain to the right piece and then do the index operation.
 42928                                  ;
 42929                                  ;   NOTE:
 42930                                  ;	This routine is called from SFFromHandle which is called
 42931                                  ;       at DOSINIT time with SS NOT DOSGROUP
 42932                                  ;
 42933                                  ;	ENTRY	BX has SF index
 42934                                  ;	EXIT	'C' clear if OK
 42935                                  ;		  ES:DI points to SF entry
 42936                                  ;		'C' set if index too large
 42937                                  ;	USES	BX, DI, ES
 42938                                  ;----------------------------------------------------------------------------
 42939                                  
 42940                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 42941                                  	; 11/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 42942                                  
 42943                                  SFFromSFN:
 42944                                  	; 05/05/2019 - Retro DOS v4.0
 42945                                  	;getdseg <es>			; es -> dosdata
 42946 0000736E 2E8E06[0700]            	mov	es,[cs:DosDSeg]
 42947                                  
 42948                                  	;LES	DI,[CS:SFT_ADDR]	; (es:di) = start of SFT table
 42949 00007373 26C43E[2A00]            	les	di,[es:SFT_ADDR]
 42950                                  sfsfn5:	
 42951                                  	;cmp	bx,[es:di+4]
 42952 00007378 263B5D04                	CMP	BX,[ES:DI+SFT.SFCount]	; is handle in this table?
 42953 0000737C 720E                    	JB	short sfsfn7		; yes, go grab it
 42954                                  	;sub	bx,[es:di+4]
 42955 0000737E 262B5D04                	SUB     BX,[ES:DI+SFT.SFCount]
 42956 00007382 26C43D                  	les	di,[es:di] ; 14/08/2018
 42957                                  	;LES	DI,[ES:DI+SFT.SFLink]	; get next table segment
 42958 00007385 83FFFF                  	CMP     DI,-1                   ; end of tables?
 42959 00007388 75EE                    	JNZ	short sfsfn5		; no, try again
 42960 0000738A F9                      	STC
 42961 0000738B C3                      	retn				; return with error, not found
 42962                                  sfsfn7:
 42963 0000738C 50                      	push	ax
 42964                                  	;;mov	ax,53 ; MSDOS 3.3
 42965                                  	;mov	ax,59 ; MSDOS 5.0 to PCDOS 7.1 (to Win ME) ; 11/03/2024
 42966                                  	;MOV	AX,SF_ENTRY.size	; put it in a nice place
 42967                                  	
 42968                                  	; 17/12/2022
 42969 0000738D B03B                    	mov	al,SF_ENTRY.size ; 28/05/2019
 42970                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 42971                                  	;mov	ax,SF_ENTRY.size ; 59
 42972                                  	
 42973 0000738F F6E3                    	MUL	BL			; (ax) = offset into this SF block
 42974 00007391 01C7                    	ADD	DI,AX			; add base of SF block
 42975 00007393 58                      	pop	ax
 42976                                  	;add	di,6
 42977 00007394 83C706                  	ADD	DI,SFT.SFTable		; offset into structure, 'C' cleared
 42978 00007397 C3                      	retn				; return with 'C' clear
 42979                                  
 42980                                  ;	BREAK <JFNFree - return a jfn pointer if one is free>
 42981                                  
 42982                                  ;**	JFNFree - Find a Free JFN Slot
 42983                                  ;----------------------------------------------------------------------------
 42984                                  ;	JFNFree scansthrough the JFN table and returnsa pointer to a free slot
 42985                                  ;
 42986                                  ;	ENTRY	(ss) = DOSDATA
 42987                                  ;	EXIT	'C' clear if OK
 42988                                  ;		  (bx) = new handle
 42989                                  ;		  (es:di) = pointer to JFN slot
 42990                                  ;		'C' set if error
 42991                                  ;		  (al) = error code
 42992                                  ;	USES	bx, di, es, flags
 42993                                  ;----------------------------------------------------------------------------
 42994                                  
 42995                                  JFNFree:
 42996 00007398 31DB                    	XOR	BX,BX			; (bx) = initial JFN to try
 42997                                  jfnf1:	
 42998 0000739A E89EFF                  	CALL	pJFNFromHandle		; get the appropriate handle
 42999 0000739D 7209                    	JC	short jfnf5		; no more handles
 43000 0000739F 26803DFF                	CMP     BYTE [ES:DI],-1		; free?
 43001 000073A3 7405                    	je	short jfnfx		; yes, carry is clear
 43002 000073A5 43                      	INC     BX                      ; no, next handle
 43003 000073A6 EBF2                    	JMP	short jfnf1		; and try again
 43004                                  
 43005                                  	; Error. 'C' set
 43006                                  jfnf5:	
 43007                                  	;mov	al,4
 43008 000073A8 B004                    	MOV	AL,error_too_many_open_files
 43009                                  jfnfx:	
 43010 000073AA C3                      	retn				; bye
 43011                                  
 43012                                  ;	BREAK <SFNFree - Allocate a free SFN>
 43013                                  
 43014                                  ;**	SFNFree - Allocate a Free SFN/SFT
 43015                                  ;----------------------------------------------------------------------------
 43016                                  ;	SFNFree scans through the sf table looking for a free entry
 43017                                  ;	If it finds one it partially allocates it by setting SFT_REF_COUNT = -1
 43018                                  ;
 43019                                  ;	The problem is that we want to mark the SFT busy so that other threads
 43020                                  ;	can't allocate the SFT before we're finished marking it up.  However,
 43021                                  ;	we can't just mark it busy because we may get blown out of our open
 43022                                  ;	by INT24 and leave the thing orphaned.	To solve this we mark it
 43023                                  ;	"allocation in progress" by setting SFT_REF_COUNT = -1.  If we see
 43024                                  ;	an SFT with this value we look to see if it belongs to this user
 43025                                  ;	and process.  If it does belong to us then it must be an orphan
 43026                                  ;	and we reclaim it.
 43027                                  ;
 43028                                  ;	BUGBUG - improve the performance. I guess it's smaller to call SFFromSFN
 43029                                  ;		over and over, but we could at least set a high water mark...
 43030                                  ;		cause an N^2 loop calling slow SFFromSFN is real slow, too slow
 43031                                  ;		even though this is not a frequently called routine - jgl
 43032                                  ;
 43033                                  ;	ENTRY	(ss) = DOSDATA
 43034                                  ;	EXIT	'C' clear if no error
 43035                                  ;		  (bx) = SFN
 43036                                  ;		  (es:di) = pointer to SFT
 43037                                  ;		  es:[di].SFT_REF_COUNT = -1
 43038                                  ;		'C' set if error
 43039                                  ;		  (al) = error code
 43040                                  ;	USES	bx, di, es, Flags
 43041                                  ;----------------------------------------------------------------------------
 43042                                  
 43043                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43044                                  	; DOSCODE:A682h (MSDOS 5.0 MSDOS.SYS)
 43045                                  
 43046                                  	; 11/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43047                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B8DEh
 43048                                  
 43049                                  SFNFree:
 43050                                  	; 12/08/2018
 43051                                  	; 05/08/2018 - Retro DOS v3.0
 43052                                  	;
 43053                                  	; MSDOS 6.0
 43054 000073AB 50                      	push	ax
 43055 000073AC 31DB                    	xor	bx,bx			; (bx) = SFN to consider
 43056                                  sfnf5:	
 43057 000073AE 53                      	push	bx
 43058 000073AF E8BCFF                  	call	SFFromSFN		; get the potential handle
 43059 000073B2 5B                      	pop	bx
 43060 000073B3 723A                    	jc	short sfnf95		; no more free SFNs
 43061 000073B5 26833D00                	cmp	word [ES:DI],0
 43062                                  	;cmp	word [ES:DI+SF_ENTRY.sf_Ref_Count],0 ; free?
 43063 000073B9 741D                    	je	short sfnf20			; yep, got one
 43064                                  	
 43065                                  	;cmp	word [es:di],0FFFFh ; -1
 43066 000073BB 26833DFF                	cmp	word [ES:DI],sf_busy
 43067                                  	;cmp	word [ES:DI+SF_ENTRY.sf_ref_count],sf_busy
 43068 000073BF 7403                    	je	short sfnf10		; special busy mark
 43069                                  sfnf7:	
 43070 000073C1 43                      	inc	bx			; try the next one
 43071 000073C2 EBEA                    	jmp	short sfnf5
 43072                                  
 43073                                  ;	The SFT has the special "busy" mark; if it belongs to us then
 43074                                  ;	it was abandoned during a earlier call and we can use it.
 43075                                  ;
 43076                                  ;	(bx)	= SFN
 43077                                  ;	(es:di) = pointer to SFT
 43078                                  ;	(TOS)	= caller's (ax)
 43079                                  
 43080                                  sfnf10:	
 43081 000073C4 36A1[3E03]              	mov	ax,[SS:USER_ID]
 43082                                  	;cmp	[es:di+2Fh],ax
 43083 000073C8 2639452F                	cmp	[ES:DI+SF_ENTRY.sf_UID],ax
 43084 000073CC 75F3                    	jnz	short sfnf7		; not ours
 43085 000073CE 36A1[3C03]              	mov	ax,[SS:PROC_ID]
 43086                                  	;cmp	[es:di+31h],ax
 43087 000073D2 26394531                	cmp	[ES:DI+SF_ENTRY.sf_PID],ax
 43088 000073D6 75E9                    	jnz	short sfnf7		; can't use this one, try the next
 43089                                  
 43090                                  ;	We have an SFT to allocate
 43091                                  ;
 43092                                  ;	(bx)	= SFN
 43093                                  ;	(es:di) = pointer to SFT
 43094                                  ;	(TOS)	= caller's (ax)
 43095                                  
 43096                                  sfnf20:
 43097                                  	; cf = 0 ;; Retro DOS v3.0
 43098                                  
 43099                                  	;mov	word [es:di],0FFFFh
 43100 000073D8 26C705FFFF              	mov	word [ES:DI],sf_busy
 43101                                  					; make sure that this is allocated
 43102                                  	;mov	word [ES:DI+SF_ENTRY.sf_ref_count],sf_busy
 43103                                  
 43104 000073DD 36A1[3E03]              	mov	ax,[SS:USER_ID]
 43105                                  	;mov	[es:di+2Fh],ax
 43106 000073E1 2689452F                	mov	[ES:DI+SF_ENTRY.sf_UID],ax
 43107 000073E5 36A1[3C03]              	mov	ax,[SS:PROC_ID]
 43108                                  	;mov	[es:di+31h],ax
 43109 000073E9 26894531                	mov	[ES:DI+SF_ENTRY.sf_PID],ax
 43110                                  sfnf21: ;; Retro DOS v3.0
 43111                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43112                                  	;pop	ax
 43113                                  	;;clc
 43114                                  	;retn				; return with no error
 43115                                  	; 17/12/2022
 43116 000073ED 58                      	pop	ax
 43117                                  	;clc
 43118 000073EE C3                      	retn
 43119                                  
 43120                                  ;**	Error - no more free SFNs
 43121                                  ;
 43122                                  ;	'C' set
 43123                                  ;	(TOS) = saved ax
 43124                                  
 43125                                  sfnf95: 
 43126 000073EF 58                      	pop	ax
 43127                                  
 43128                                  ; 11/03/2024
 43129                                  %if 0
 43130                                  	;mov	al,4
 43131                                  	mov	al,error_too_many_open_files
 43132                                  	retn				; return with 'C' and error
 43133                                  %else
 43134                                  	; 11/03/2024 (PCDOS 7.1 IBMDOS.COM)
 43135                                  	;;;
 43136 000073F0 EBB6                    	jmp	short jfnf5
 43137                                  	;;;
 43138                                  %endif
 43139                                  
 43140                                  ;============================================================================
 43141                                  ; HANDLE.ASM, MSDOS 6.0, 1991
 43142                                  ;============================================================================
 43143                                  ; 13/07/2018 - Retro DOS v3.0
 43144                                  ; 20/05/2019 - Retro DOS v4.0
 43145                                  ; 11/03/2024 - Retro DOS v5.0
 43146                                  
 43147                                  ; DOSCODE:A72Bh (MSDOS 6.21, MSDOS.SYS)
 43148                                  
 43149                                  ;	BREAK <$Close - return a handle to the system>
 43150                                  ;----------------------------------------------------------------------------
 43151                                  ;
 43152                                  ;**	$Close - Close a file Handle
 43153                                  ;
 43154                                  ;	BUGBUG - close gets called a LOT with invalid handles - sizzle that
 43155                                  ;		path
 43156                                  ;
 43157                                  ;	Assembler usage:
 43158                                  ;	    MOV     BX, handle
 43159                                  ;	    MOV     AH, Close
 43160                                  ;	    INT     int_command
 43161                                  ;
 43162                                  ;	ENTRY	(bx) = handle
 43163                                  ;	EXIT	<normal INT21 return convention>
 43164                                  ;	USES	all
 43165                                  ;
 43166                                  ;----------------------------------------------------------------------------
 43167                                  
 43168                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43169                                  ; DOSCODE:A6CBh (MSDOS 5.0 MSDOS.SYS)
 43170                                  
 43171                                  ; 11/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43172                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0B926h
 43173                                  
 43174                                  ; (Windows ME IO.SYS - BIOSCODE:0A145h)
 43175                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0A72Bh)
 43176                                  
 43177                                  _$CLOSE:
 43178                                  ;	Grab the SFT pointer from the JFN.
 43179                                  
 43180 000073F2 E8F602                  	call	CheckOwner		; get system file entry
 43181 000073F5 722B                    	jc	short CloseError	; error return
 43182 000073F7 16                      	push	ss
 43183 000073F8 1F                      	pop	ds			; For DOS_CLOSE
 43184 000073F9 893E[9E05]              	MOV	[THISSFT],DI		; save offset of pointer
 43185 000073FD 8C06[A005]              	MOV	[THISSFT+2],ES		; save segment value
 43186                                  
 43187                                  ; DS:SI point to JFN table entry.
 43188                                  ; ES:DI point to SFT
 43189                                  ;
 43190                                  ; We now examine the user's JFN entry; If the file was a 70-mode file (network
 43191                                  ; FCB, we examine the ref count on the SFT; if it was 1, we free the JFN.
 43192                                  ; If the file was not a net FCB, we free the JFN too.
 43193                                  
 43194                                  	;CMP	word [ES:DI+SF_ENTRY.sf_ref_count],1
 43195 00007401 26833D01                	cmp	word [ES:DI],1		; will the SFT become free?
 43196 00007405 740A                    	jz	short FreeJFN 		; yes, free JFN anyway.
 43197                                  	;mov	al,[ES:DI+2]
 43198 00007407 268A4502                	MOV	AL,[ES:DI+SF_ENTRY.sf_mode]
 43199                                  	;and	al,0F0h
 43200 0000740B 24F0                    	AND	AL,SHARING_MASK
 43201                                  	;cmp	al,70h
 43202 0000740D 3C70                    	CMP	AL,SHARING_NET_FCB
 43203 0000740F 7407                    	JZ	short PostFree		; 70-mode and big ref count => free it
 43204                                  
 43205                                  ; The JFN must be freed. Get the pointer to it and replace the contents with
 43206                                  ; -1.
 43207                                  
 43208                                  FreeJFN:
 43209 00007411 E827FF                  	call	pJFNFromHandle		; d = pJFN (handle);
 43210 00007414 26C605FF                	MOV	BYTE [ES:DI],0FFh	; release the JFN
 43211                                  PostFree:
 43212                                  
 43213                                  ; ThisSFT is correctly set, we have DS = DOSDATA. Looks OK for a DOS_CLOSE!
 43214                                  
 43215 00007418 E8F3C1                  	call	DOS_CLOSE
 43216                                  
 43217                                  ; DOS_Close may return an error. If we see such an error, we report it but
 43218                                  ; the JFN stays closed because DOS_Close always frees the SFT!
 43219                                  
 43220 0000741B 7205                    	JC	short CloseError
 43221                                  	;mov	ah,3Eh
 43222 0000741D B43E                    	MOV	AH,CLOSE		; MZ Bogus multiplan fix
 43223                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43224                                  CloseOk:
 43225 0000741F E94992                  	jmp	SYS_RET_OK
 43226                                  CloseError:
 43227                                  CommitError:	; 11/03/2024
 43228 00007422 E95092                  	jmp	SYS_RET_ERR
 43229                                  
 43230                                  ;	BREAK <$Commit - commit the file>
 43231                                  ;----------------------------------------------------------------------------
 43232                                  ;
 43233                                  ;**	$Commit - Commit a File
 43234                                  ;
 43235                                  ;	$Commit "commits" a file to disk - all of it's buffers are
 43236                                  ;	flushed out. BUGBUG - I'm pretty sure that $Commit doesn't update
 43237                                  ;	the directory entry, etc., so this commit is pretty useless. check
 43238                                  ;	and fix this!! jgl
 43239                                  ;
 43240                                  ;	Assembler usage:
 43241                                  ;	    MOV     BX, handle
 43242                                  ;	    MOV     AH, Commit
 43243                                  ;	    INT     int_command
 43244                                  ;
 43245                                  ;	ENTRY	(bx) = handle
 43246                                  ;	EXIT	none
 43247                                  ;	USES	all
 43248                                  ;;----------------------------------------------------------------------------
 43249                                  
 43250                                  _$COMMIT:
 43251                                  ;	Grab the SFT pointer from the JFN.
 43252                                  
 43253 00007425 E8C302                  	call	CheckOwner		; get system file entry
 43254                                  	;JC	short CommitError	; error return
 43255                                  	; 11/03/2024
 43256 00007428 72F8                    	jc	short CommitError
 43257                                  
 43258 0000742A 16                      	push	ss
 43259 0000742B 1F                      	pop	ds			; For DOS_COMMIT
 43260 0000742C 893E[9E05]              	MOV	[THISSFT],DI		; save offset of pointer
 43261 00007430 8C06[A005]              	MOV	[THISSFT+2],ES		; save segment value
 43262                                  
 43263                                  ;	ThisSFT is correctly set, we have DS = DOSDATA. Looks OK for a DOS_COMMIT
 43264                                  ;
 43265                                  ;	ES:DI point to SFT
 43266                                  
 43267 00007434 E87FC3                  	call	DOS_COMMIT
 43268 00007437 72E9                    	JC	short CommitError
 43269                                  	; 07/12/2022
 43270                                  	;jc	short CloseError
 43271                                  	;mov	ah,68h
 43272 00007439 B468                    	MOV	AH,COMMIT
 43273                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43274                                  	;jmp	SYS_RET_OK
 43275                                  CommitOk:
 43276 0000743B EBE2                    	jmp	short CloseOk
 43277                                  
 43278                                  ; 11/03/2024
 43279                                  ;CommitError:
 43280                                  ;	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43281                                  ;	;jmp	SYS_RET_ERR
 43282                                  ;	jmp	short CloseError
 43283                                  
 43284                                  ;	BREAK <$ExtHandle - extend handle count>
 43285                                  
 43286                                  ;**	$ExtHandle - Extend Handle Count
 43287                                  ;----------------------------------------------------------------------------
 43288                                  ;	Assembler usage:
 43289                                  ;	    MOV     BX, Number of Opens Allowed (MAX=65534;66535 is
 43290                                  ;	    MOV     AX, 6700H			 reserved to mark SFT
 43291                                  ;	    INT     int_command 		 busy )
 43292                                  ;
 43293                                  ;	ENTRY	(bx) = new number of handles
 43294                                  ;	EXIT	'C' clear if OK
 43295                                  ;		'C' set iff err
 43296                                  ;		  (ax) = error code
 43297                                  ;			 AX = error_not_enough_memory
 43298                                  ;			      error_too_many_open_files
 43299                                  ;	USES	all
 43300                                  ;----------------------------------------------------------------------------
 43301                                  
 43302                                  	; 11/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43303                                  
 43304                                  _$ExtHandle:
 43305 0000743D 31ED                    	XOR	BP,BP			; 0: enlarge  1: shrink  2:psp
 43306                                  	;cmp	bx,20
 43307 0000743F 83FB14                  	CMP	BX,FILPERPROC
 43308 00007442 7303                    	JAE	short exth2		; Don't set less than FilPerProc no
 43309 00007444 BB1400                  	MOV	BX,FILPERPROC
 43310                                  exth2:	
 43311 00007447 368E06[3003]            	MOV	ES,[ss:CurrentPDB]	; get user process data block;smr;SS Override
 43312                                  	;mov	cx,[ES:32h]
 43313 0000744C 268B0E3200              	MOV	CX,[ES:PDB.JFN_Length]	; get number of handle allowed
 43314 00007451 39CB                    	CMP	BX,CX			; the requested == current
 43315                                  	;JE	short ok_done 		; yes and exit
 43316                                  	; 11/03/2024
 43317 00007453 74CA                    	je	short CloseOk
 43318 00007455 771E                    	JA	short larger		; go allocate new table
 43319                                  
 43320                                  ;	We're going to shrink the # of handles available
 43321                                  
 43322                                  	;MOV	BP,1			; shrink
 43323                                  	; 11/03/2024
 43324 00007457 45                      	inc	bp
 43325                                  
 43326                                  	;mov	ds,[ES:36h]
 43327 00007458 268E1E3600              	MOV	DS,[ES:PDB.JFN_Pointer+2] ;
 43328 0000745D 89DE                    	MOV	SI,BX			;
 43329 0000745F 29D9                    	SUB	CX,BX			; get difference
 43330                                  
 43331                                  ;	BUGBUG - code a SCASB here, should be a bit smaller
 43332                                  chck_handles:
 43333 00007461 803CFF                  	CMP	BYTE [SI],-1		; scan through handles to ensure close
 43334 00007464 7539                    	JNZ	short too_many_files	; status
 43335 00007466 46                      	INC	SI
 43336 00007467 E2F8                    	LOOP	chck_handles
 43337                                  
 43338 00007469 83FB14                  	CMP	BX,FILPERPROC		; = 20
 43339 0000746C 7707                    	JA	short larger		; no
 43340                                  
 43341                                  	;MOV	BP,2			; psp
 43342                                  	; 11/03/2024
 43343 0000746E 45                      	inc	bp	
 43344                                  	;mov	di,24
 43345 0000746F BF1800                  	MOV	DI,PDB.JFN_TABLE	; es:di -> jfn table in psp
 43346 00007472 53                      	PUSH	BX
 43347 00007473 EB1B                    	JMP	short movhandl
 43348                                  
 43349                                  larger:
 43350                                  	;CMP	BX,-1			; 65535 is not allowed
 43351                                  	;JZ	short invalid_func	; 10/08/2018
 43352                                  	; 11/03/2024 (PCDOS 7.1 IBMDOS.COM)
 43353                                  	;;;
 43354 00007475 43                      	inc	bx
 43355 00007476 747D                    	jz	short invalid_func
 43356 00007478 4B                      	dec	bx
 43357                                  	;;;
 43358 00007479 F8                      	CLC
 43359 0000747A 53                      	PUSH	BX			; save requested number
 43360 0000747B 83C30F                  	ADD	BX,0FH			; adjust to paragraph boundary
 43361 0000747E B104                    	MOV	CL,4
 43362                                  	;ror	bx,cl			; MSDOS 3.3
 43363 00007480 D3DB                    	RCR	BX,CL			; DOS 4.00 fix		;AC000;
 43364                                  	;AND	BX,1FFFH		; clear most 3 bits
 43365                                  	; 01/07/2024
 43366 00007482 80E71F                  	and	bh,1Fh
 43367                                  
 43368 00007485 55                      	PUSH	BP
 43369 00007486 E80AFB                  	call	_$ALLOC			; allocate memory
 43370 00007489 5D                      	POP	BP
 43371 0000748A 7264                    	JC	short no_memory		; not enough memory
 43372                                  
 43373 0000748C 8EC0                    	MOV	ES,AX			; es:di points to new table memory
 43374 0000748E 31FF                    	XOR	DI,DI
 43375                                  movhandl:
 43376 00007490 368E1E[3003]            	MOV	DS,[ss:CurrentPDB] 	; get user PDB address	;smr;SS Override
 43377                                  
 43378 00007495 F7C50300                	test	BP,3			; enlarge ?
 43379 00007499 7409                    	JZ	short enlarge 		; yes
 43380 0000749B 59                      	POP	CX			; cx = the amount you shrink
 43381 0000749C 51                      	PUSH	CX
 43382 0000749D EB09                    	JMP	short copy_hand
 43383                                  
 43384                                  ;	Done.  'C' clear
 43385                                  
 43386                                  ; 17/12/2022
 43387                                  ;ok_done:
 43388                                  ;	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43389                                  ;	;jmp	short CommitOk
 43390                                  ;	; 17/12/2022
 43391                                  ;	jmp	SYS_RET_OK
 43392                                  
 43393                                  too_many_files:
 43394                                  	;mov	al,4
 43395 0000749F B004                    	MOV	AL,error_too_many_open_files
 43396                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43397                                  	;jmp	SYS_RET_ERR
 43398                                  CommitErrorj:
 43399                                  	;jmp	short CommitError
 43400                                  	; 17/12/2022
 43401 000074A1 E9D191                  	jmp	SYS_RET_ERR
 43402                                  
 43403                                  ; 11/03/2024
 43404                                  ; 17/12/2022
 43405                                  ;ok_done:
 43406                                  ;	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43407                                  ;	;jmp	short CommitOk
 43408                                  ;	; 17/12/2022
 43409                                  ;	jmp	SYS_RET_OK
 43410                                  
 43411                                  enlarge:
 43412                                  	;mov	cx,[32h]
 43413 000074A4 8B0E3200                	MOV	CX,[PDB.JFN_Length]	; get number of old handles
 43414                                  copy_hand:
 43415 000074A8 89CA                    	MOV	DX,CX
 43416                                  	;lds	si,[34h]
 43417 000074AA C5363400                	LDS	SI,[PDB.JFN_Pointer]	; get old table pointer
 43418 000074AE F3A4                    	REP	MOVSB			; copy information to new table
 43419 000074B0 59                      	POP	CX			; get new number of handles
 43420 000074B1 51                      	PUSH	CX			; save it again
 43421 000074B2 29D1                    	SUB	CX,DX			; get the difference
 43422 000074B4 B0FF                    	MOV	AL,-1			; set availability to handles
 43423 000074B6 F3AA                    	REP	STOSB
 43424 000074B8 368E1E[3003]            	MOV	DS,[ss:CurrentPDB] 	; get user process data block;smr;SS Override
 43425                                  	;cmp	word [34h],0
 43426 000074BD 833E340000              	CMP	WORD [PDB.JFN_Pointer],0 ; check if original table pointer
 43427 000074C2 750D                    	JNZ	short update_info	; yes, go update PDB entries
 43428 000074C4 55                      	PUSH	BP
 43429 000074C5 1E                      	PUSH	DS			; save old table segment
 43430 000074C6 06                      	PUSH	ES			; save new table segment
 43431 000074C7 8E063600                	MOV	ES,[PDB.JFN_Pointer+2]	; get old table segment
 43432 000074CB E83AFC                  	call	_$DEALLOC		; deallocate old table memory
 43433 000074CE 07                      	POP	ES			; restore new table segment
 43434 000074CF 1F                      	POP	DS			; restore old table segment
 43435 000074D0 5D                      	POP	BP
 43436                                  
 43437                                  update_info:
 43438 000074D1 F7C50200                	test	BP,2			; psp?
 43439 000074D5 7408                    	JZ	short non_psp 		; no
 43440                                  	;mov	word [34h],18h ; 24
 43441 000074D7 C70634001800            	MOV	WORD [PDB.JFN_Pointer],PDB.JFN_TABLE ; restore
 43442 000074DD EB06                    	JMP	short final
 43443                                  non_psp:
 43444                                  	;mov	word [34h],0
 43445 000074DF C70634000000            	MOV	WORD [PDB.JFN_Pointer],0 ; new table pointer offset always 0
 43446                                  final:
 43447                                  	;mov	[36h],es	
 43448 000074E5 8C063600                	MOV	[PDB.JFN_Pointer+2],ES	; update table pointer segment
 43449                                  	;pop	word [32h]
 43450 000074E9 8F063200                	POP	word [PDB.JFN_Length]	; restore new number of handles
 43451                                  	; 11/03/2024
 43452                                  ok_done:
 43453                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43454 000074ED E97B91                  	jmp	SYS_RET_OK
 43455                                  ;ok_done_j:
 43456                                  ;	jmp	short ok_done
 43457                                  
 43458                                  no_memory:
 43459 000074F0 5B                      	POP	BX			; clean stack
 43460                                  	;mov	al,8
 43461 000074F1 B008                    	MOV	AL,error_not_enough_memory
 43462                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43463                                  	;jmp	SYS_RET_ERR
 43464                                  CommitErrorj2:
 43465 000074F3 EBAC                    	jmp	short CommitErrorj
 43466                                  
 43467                                  invalid_func:
 43468                                  	;mov	al,1
 43469 000074F5 B001                    	MOV	AL,error_invalid_function
 43470                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43471                                  	;jmp	SYS_RET_ERR
 43472                                  CommitErrorj3:
 43473                                  	;jmp	short CommitErrorj2
 43474                                  	; 17/12/2022
 43475 000074F7 EBA8                    	jmp	short CommitErrorj
 43476                                  
 43477                                  ; 20/05/2019 - Retro DOS v4.0
 43478                                  ; DOSCODE:A83Ah (MSDOS 6.21, MSDOS.SYS)
 43479                                  
 43480                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43481                                  ; DOSCODE:A7DAh (MSDOS 5.0 MSDOS.SYS)
 43482                                  
 43483                                  ;	BREAK <$READ - Read from a file handle>
 43484                                  ;----------------------------------------------------------------------------
 43485                                  ;
 43486                                  ;**	$Read - Read from a File Handle
 43487                                  ;
 43488                                  ;   Assembler usage:
 43489                                  ;
 43490                                  ;	LDS	DX, buf
 43491                                  ;	MOV	CX, count
 43492                                  ;	MOV	BX, handle
 43493                                  ;	MOV	AH, Read
 43494                                  ;	INT	int_command
 43495                                  ;	  AX has number of bytes read
 43496                                  ;
 43497                                  ;	ENTRY	(bx) = file handle
 43498                                  ;		(cx) = byte count
 43499                                  ;		(ds:dx) = buffer address
 43500                                  ;	EXIT	Through system call return so that to user:
 43501                                  ;		  'C' clear if OK
 43502                                  ;		    (ax) = bytes read
 43503                                  ;		  'C' set if error
 43504                                  ;		    (ax) = error code
 43505                                  ;
 43506                                  ;----------------------------------------------------------------------------
 43507                                  
 43508                                  	; 12/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43509                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BA2Eh
 43510                                  
 43511                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0A83Ah)
 43512                                  	; (Windows ME IO.SYS - BIOSCODE:0A256h)
 43513                                  
 43514                                  _$READ:
 43515 000074F9 BE[483A]                	MOV	SI,DOS_READ
 43516                                  ReadDo:
 43517 000074FC E83CFE                  	call	pJFNFromHandle
 43518 000074FF 7208                    	JC	short ReadError
 43519                                  
 43520 00007501 268A05                  	MOV	AL,[ES:DI]
 43521 00007504 E8E401                  	call	CheckOwner		; get the handle
 43522 00007507 7303                    	JNC	short ReadSetup		; no errors do the operation
 43523                                  
 43524                                  ;	Have an error. 'C' set
 43525                                  
 43526                                  ReadError:
 43527                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43528                                  	;;jmp	SYS_RET_ERR		; go to error traps
 43529                                  	;jmp	short CommitErrorj3
 43530                                  	; 17/12/2022
 43531 00007509 E96991                  	jmp	SYS_RET_ERR
 43532                                  
 43533                                  ReadSetup:
 43534 0000750C 36893E[9E05]            	MOV	[ss:THISSFT],DI		; save offset of pointer;smr;SS Override
 43535 00007511 368C06[A005]            	MOV	[ss:THISSFT+2],ES	; save segment value	;smr;SS Override
 43536                                  	; 20/05/2019 - Retro DOS v4.0
 43537                                  	; MSDOS 6.0 
 43538                                  ;; Extended Open
 43539                                  	;test	byte [es:di+3],20h
 43540 00007516 26F6450320              	test	byte [ES:DI+SF_ENTRY.sf_mode+1],(INT_24_ERROR>>8)
 43541                                  						 ;AN000;;EO. need i24
 43542 0000751B 7406                    	JZ	short needi24 		     	 ;AN000;;EO. yes
 43543 0000751D 36800E[F605]02          	OR	byte [ss:EXTOPEN_ON],EXT_OPEN_I24_OFF ; 2
 43544                                  					;AN000;;EO. set it off;smr;SS Override
 43545                                  needi24:				;AN000;
 43546                                  
 43547                                  ; 12/03/2024
 43548                                  %if 0
 43549                                  
 43550                                  ;; Extended Open
 43551                                  	push	word [SS:DMAADD]
 43552                                  	push	word [SS:DMAADD+2]	;smr;SS Override
 43553                                  
 43554                                  ;;;;;	BAD SPOT FOR 286!!! SEGMENT ARITHMETIC!!!
 43555                                  
 43556                                  	; 26/07/2019
 43557                                  
 43558                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43559                                  	;
 43560                                  	; (It is not necessary to call 'Align_Buffer' proc here/below because
 43561                                  	; there is not another caller; it is better to put the code in this proc
 43562                                   	; here instead of calling it as a subroutine; but I have modified code
 43563                                  	; here for MSDOS 5.0 MSDOS.SYS address compatibility)
 43564                                  
 43565                                  	; MSDOS 6.0
 43566                                  	CALL	Align_Buffer		;AN000;MS. align user's buffer
 43567                                  	
 43568                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43569                                  	; MSDOS 3.3
 43570                                  	;MOV	BX,DX			; copy offset
 43571                                  	;push	cx			; don't stomp on count
 43572                                  	;MOV	CL,4			; bits to shift bytes->para
 43573                                  	;SHR	BX,CL			; get number of paragraphs
 43574                                  	;pop	cx			; get count back
 43575                                  	;MOV	AX,DS			; get original segment
 43576                                  	;ADD	AX,BX			; get new segment
 43577                                  	;MOV	DS,AX			; in seg register
 43578                                  	;AND	DX,0Fh			; normalize offset
 43579                                  	;MOV	[ss:DMAADD],DX		; use user DX as offset	;smr;SS Override
 43580                                  	;MOV	[ss:DMAADD+2],DS 	; use user DS as segment for DMA
 43581                                  						;smr;SS Override
 43582                                  %else
 43583                                  	; 12/03/2024 (PCDOS 7.1 IBMDOS.COM)
 43584                                  	;;;
 43585 00007523 8CD8                    	mov	ax,ds			; original segment
 43586 00007525 36C51E[2C03]            	lds	bx,[ss:DMAADD]
 43587 0000752A 53                      	push	bx
 43588 0000752B 1E                      	push	ds
 43589 0000752C 89D3                    	mov	bx,dx
 43590 0000752E D1EB                    	shr	bx,1
 43591 00007530 D1EB                    	shr 	bx,1
 43592 00007532 D1EB                    	shr	bx,1
 43593 00007534 D1EB                    	shr	bx,1
 43594 00007536 01D8                    	add	ax,bx			; new segment
 43595 00007538 83E20F                  	and	dx,0Fh			; normalize offset
 43596                                  	;mov	[ss:DMAADD],dx		; use user DX as offset
 43597                                  	; 23/03/2024
 43598 0000753B 36A3[2E03]              	mov	[ss:DMAADD+2],ax 	; use user DS as segment for DMA
 43599                                  	;;;
 43600                                  
 43601                                  %endif
 43602                                  
 43603                                  ;;;;;	END BAD SPOT FOR 286!!! SEGMENT ARITHMETIC!!!
 43604                                  	
 43605 0000753F 16                      	push	ss			; go for DOS addressability
 43606 00007540 1F                      	pop	ds
 43607                                  
 43608                                  	; 12/03/2024 - Retro DOS v5.0
 43609                                  	;;;
 43610 00007541 8916[2C03]              	mov	[DMAADD],dx	
 43611                                  	;;;
 43612                                  
 43613 00007545 FFD6                    	CALL	SI ; DOS_READ		; indirect call to operation
 43614                                  
 43615 00007547 8F06[2E03]              	pop	word [DMAADD+2]
 43616 0000754B 8F06[2C03]              	pop	word [DMAADD]
 43617                                  	;JNC	short READ_OK		;AN002;
 43618                                  	;JMP	short ReadError		;AN002; if error, say bye bye
 43619                                  	; 17/12/2022
 43620 0000754F 72B8                    	jc	short ReadError
 43621                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43622                                  	;jnc	short READ_OK		;AN002;
 43623                                  	;jmp	short ReadError
 43624                                  
 43625                                  READ_OK:
 43626 00007551 89C8                    	MOV	AX,CX			; get correct return in correct reg
 43627                                  Read_Okj:
 43628                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43629                                  	;;jmp	SYS_RET_OK		; successful return
 43630                                  	;jmp	short ok_done_j
 43631                                  	; 17/12/2022
 43632 00007553 E91591                  	jmp	SYS_RET_OK
 43633                                  
 43634                                  ; 13/07/2018 - Retro DOS v3.0
 43635                                  
 43636                                  ;----------------------------------------------------------------------------
 43637                                  
 43638                                  ;   Input: DS:DX points to user's buffer addr
 43639                                  ;   Function: rearrange segment and offset for READ/WRITE buffer
 43640                                  ;   Output: [DMAADD] set
 43641                                  
 43642                                  
 43643                                  ; 12/03/2024
 43644                                  %if 0
 43645                                  
 43646                                  ; 20/05/2019 - Retro DOS v4.0
 43647                                  ; 26/07/2019
 43648                                  ;	; MSDOS 6.0
 43649                                  ;Align_Buffer:
 43650                                  ;	MOV	BX,DX			; copy offset
 43651                                  ;	push	cx			; don't stomp on count
 43652                                  ;	MOV	CL,4			; bits to shift bytes->para
 43653                                  ;	SHR	BX,CL			; get number of paragraphs
 43654                                  ;	pop	cx			; get count back
 43655                                  ;	MOV	AX,DS			; get original segment
 43656                                  ;	ADD	AX,BX			; get new segment
 43657                                  ;	MOV	DS,AX			; in seg register
 43658                                  ;	AND	DX,0Fh			; normalize offset
 43659                                  ;	MOV	[ss:DMAADD],DX		; use user DX as offset	;smr;SS Override
 43660                                  ;	MOV	[ss:DMAADD+2],DS 	; use user DS as segment for DMA
 43661                                  ;						;smr;SS Override
 43662                                  ;	retn
 43663                                  
 43664                                  ; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43665                                  Align_Buffer:
 43666                                  	MOV	BX,DX			; copy offset
 43667                                  	push	cx			; don't stomp on count
 43668                                  	MOV	CL,4			; bits to shift bytes->para
 43669                                  	SHR	BX,CL			; get number of paragraphs
 43670                                  	pop	cx			; get count back
 43671                                  	MOV	AX,DS			; get original segment
 43672                                  	ADD	AX,BX			; get new segment
 43673                                  	MOV	DS,AX			; in seg register
 43674                                  	AND	DX,0Fh			; normalize offset
 43675                                  	MOV	[ss:DMAADD],DX		; use user DX as offset	;smr;SS Override
 43676                                  	MOV	[ss:DMAADD+2],DS 	; use user DS as segment for DMA
 43677                                  						;smr;SS Override
 43678                                  	retn
 43679                                  
 43680                                  %endif
 43681                                  
 43682                                  ; 20/05/2019 - Retro DOS v4.0
 43683                                  ; DOSCODE:A8A0h (MSDOS 6.21, MSDOS.SYS)
 43684                                  
 43685                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43686                                  ; DOSCODE:A840h (MSDOS 5.0 MSDOS.SYS)
 43687                                  
 43688                                  ; 12/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43689                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BA8Ch)
 43690                                  
 43691                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0A8A0h)
 43692                                  ; (Windows ME IO.SYS - BIOSCODE:0A2B9h)
 43693                                  
 43694                                  ;BREAK <$WRITE - write to a file handle>
 43695                                  ;----------------------------------------------------------------------------
 43696                                  ;
 43697                                  ;   Assembler usage:
 43698                                  ;	    LDS     DX, buf
 43699                                  ;	    MOV     CX, count
 43700                                  ;	    MOV     BX, handle
 43701                                  ;	    MOV     AH, Write
 43702                                  ;	    INT     int_command
 43703                                  ;	  AX has number of bytes written
 43704                                  ;   Errors:
 43705                                  ;	    AX = write_invalid_handle
 43706                                  ;	       = write_access_denied
 43707                                  ;
 43708                                  ;   Returns in register AX
 43709                                  ;
 43710                                  ;----------------------------------------------------------------------------
 43711                                  
 43712                                  _$WRITE:
 43713 00007556 BE[493C]                	MOV	SI,DOS_WRITE
 43714 00007559 EBA1                    	JMP	short ReadDo
 43715                                  
 43716                                  ;BREAK <$LSEEK - move r/w pointer>
 43717                                  ;----------------------------------------------------------------------------
 43718                                  ;
 43719                                  ;   Assembler usage:
 43720                                  ;	    MOV     DX, offsetlow
 43721                                  ;	    MOV     CX, offsethigh
 43722                                  ;	    MOV     BX, handle
 43723                                  ;	    MOV     AL, method
 43724                                  ;	    MOV     AH, LSeek
 43725                                  ;	    INT     int_command
 43726                                  ;	  DX:AX has the new location of the pointer
 43727                                  ;   Error returns:
 43728                                  ;	    AX = error_invalid_handle
 43729                                  ;	       = error_invalid_function
 43730                                  ;   Returns in registers DX:AX
 43731                                  ;
 43732                                  ;----------------------------------------------------------------------------
 43733                                  
 43734                                  ; 21/05/2019 - Retro DOS v4.0
 43735                                  ; DOSCODE:A8A5h (MSDOS 6.21, MSDOS.SYS)
 43736                                  
 43737                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43738                                  ; DOSCODE:A845h (MSDOS 5.0 MSDOS.SYS)
 43739                                  
 43740                                  	; 12/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43741                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BA91h
 43742                                  
 43743                                  _$LSEEK:
 43744 0000755B E88D01                  	call	CheckOwner		; get system file entry
 43745                                  
 43746                                  	; 17/12/2022
 43747                                  ;LSeekError:
 43748                                  	;JNC	short CHKOWN_OK		;AN002;
 43749                                  	;JMP	short ReadError		;AN002; error return
 43750                                  	; 17/12/2022
 43751                                  	; 02/06/2019
 43752 0000755E 72A9                    	jc	short ReadError
 43753                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43754                                  	;JNC	short CHKOWN_OK		;AN002;
 43755                                  	;JMP	short ReadError		;AN002; error return
 43756                                  
 43757                                  CHKOWN_OK:
 43758                                  					;AN002;
 43759 00007560 3C02                    	CMP	AL,2			; is the seek value correct?
 43760 00007562 7607                    	JBE	short LSeekDisp		; yes, go dispatch
 43761                                  
 43762                                  ; 12/03/2024
 43763                                  %if 0
 43764                                  	;mov	byte [ss:EXTERR_LOCUS],1 
 43765                                  	MOV	byte [ss:EXTERR_LOCUS],errLOC_Unk ; Extended Error Locus
 43766                                  					;smr;SS Override
 43767                                  %else
 43768                                  	; 12/03/2024 (PCDOS 7.1 IBMDOS.COM)
 43769                                  	;;;
 43770 00007564 E8539D                  	call	set_exerr_locus_unk	; Extended Error Locus
 43771                                  	;;;
 43772                                  %endif
 43773                                  	;mov	al,1
 43774 00007567 B001                    	mov	al,error_invalid_function ; invalid method
 43775                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43776                                  LSeekError2:
 43777 00007569 EB9E                    	jmp	short ReadError
 43778                                  
 43779                                  LSeekDisp:
 43780 0000756B 3C01                    	CMP	AL,1			; best way to dispatch; check middle
 43781 0000756D 720A                    	JB	short LSeekStore	; just store CX:DX
 43782 0000756F 771B                    	JA	short LSeekEOF		; seek from end of file
 43783                                  	;add	dx,[es:di+21]
 43784 00007571 26035515                	ADD	DX,[ES:DI+SF_ENTRY.sf_position]
 43785                                  	;adc	cx,[es:di+23]
 43786 00007575 26134D17                	ADC	CX,[ES:DI+SF_ENTRY.sf_position+2]
 43787                                  LSeekStore:
 43788 00007579 89C8                    	MOV	AX,CX			; AX:DX
 43789 0000757B 92                      	XCHG	AX,DX			; DX:AX is the correct value
 43790                                  LSeekSetpos:
 43791                                  	;mov	[es:di+21],ax
 43792 0000757C 26894515                	MOV	[ES:DI+SF_ENTRY.sf_position],AX
 43793                                  	;mov	[es:di+23],dx
 43794 00007580 26895517                	MOV	[ES:DI+SF_ENTRY.sf_position+2],DX
 43795 00007584 E8F08E                  	call	Get_User_Stack
 43796                                  	;mov	[si+6],dx
 43797 00007587 895406                  	MOV	[SI+user_env.user_DX],DX ; return DX:AX
 43798                                  	;jmp	SYS_RET_OK		; successful return
 43799                                  	; 25/06/2019
 43800                                  	;jmp	SYS_RET_OK_clc
 43801                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43802                                  	;jmp	SYS_RET_OK_clc
 43803                                  LSeekOk:
 43804 0000758A EBC7                    	jmp     short Read_Okj
 43805                                  
 43806                                  LSeekEOF:
 43807                                  	;;test	word [es:di+5],8000h
 43808                                  	;test	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 43809                                  	; 21/05/2019 - Retro DOS v4.0
 43810 0000758C 26F6450680              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 43811 00007591 750A                    	JNZ	short Check_LSeek_Mode	; Is Net
 43812                                  LOCAL_LSeek:
 43813                                  	;add	dx,[es:di+17]
 43814 00007593 26035511                	ADD	DX,[ES:DI+SF_ENTRY.sf_size]
 43815                                  	;adc	cx,[es:di+19]
 43816 00007597 26134D13                	ADC	CX,[ES:DI+SF_ENTRY.sf_size+2]
 43817 0000759B EBDC                    	JMP	short LSeekStore	; go and set the position
 43818                                  
 43819                                  Check_LSeek_Mode:
 43820                                  	;;test	word [es:di+2],8000h
 43821                                  	;test	word [ES:DI+SF_ENTRY.sf_mode],sf_isFCB
 43822                                  	; 21/05/2019
 43823 0000759D 26F6450380              	test	byte [ES:DI+SF_ENTRY.sf_mode+1],(sf_isFCB>>8)
 43824 000075A2 75EF                    	JNZ	short LOCAL_LSeek	; FCB treated like local file
 43825                                  	;mov	ax,[es:di+2]
 43826 000075A4 268B4502                	MOV	AX,[ES:DI+SF_ENTRY.sf_mode]
 43827                                  	;and	ax,0F0h
 43828 000075A8 25F000                  	AND	AX,SHARING_MASK
 43829                                  	;cmp	ax,40h
 43830 000075AB 83F840                  	CMP	AX,SHARING_DENY_NONE
 43831 000075AE 7405                    	JZ	short NET_LSEEK		; LSEEK exported in this mode
 43832                                  	;cmp	ax,30h
 43833 000075B0 83F830                  	CMP	AX,SHARING_DENY_READ
 43834 000075B3 75DE                    	JNZ	short LOCAL_LSeek	; Treated like local Lseek
 43835                                  NET_LSEEK:
 43836                                  ;	JMP	short LOCAL_LSeek
 43837                                  ; REMOVE ABOVE INSTRUCTION TO ENABLE DCR 142
 43838                                  	;CallInstall Net_Lseek,MultNET,33
 43839                                  	;JNC	short LSeekSetPos
 43840                                  
 43841 000075B5 B82111                  	mov     ax,1121h
 43842 000075B8 CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - SEEK FROM END OF REMOTE FILE
 43843                                  			; CX:DX = offset (in bytes) from end
 43844                                  			; ES:DI -> SFT, SFT DPB field -> DPB of drive with file
 43845                                  			; SS = DOS CS
 43846                                  			; Return: CF set on error
 43847                                  			; CF clear if successful, DX:AX = new file position
 43848 000075BA 73C0                    	jnb     short LSeekSetpos
 43849                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43850                                  	;jmp	SYS_RET_ERR
 43851                                  ;LSeekError3:
 43852                                  	; 17/12/2022
 43853                                  LSeekError:
 43854                                  	;jmp	short LSeekError2
 43855                                  DupErr: ; 17/12/2022
 43856 000075BC E9B690                  	jmp	SYS_RET_ERR
 43857                                  
 43858                                  ; 21/05/2019 - Retro DOS v4.0
 43859                                  ; DOSCODE:A95Bh (MSDOS 6.21, MSDOS.SYS)
 43860                                  
 43861                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43862                                  ; DOSCODE:A8FBh (MSDOS 5.0 MSDOS.SYS)
 43863                                  
 43864                                  ;BREAK <$DUP - duplicate a jfn>
 43865                                  ;----------------------------------------------------------------------------
 43866                                  ;
 43867                                  ;   Assembler usage:
 43868                                  ;	    MOV     BX, fh
 43869                                  ;	    MOV     AH, Dup
 43870                                  ;	    INT     int_command
 43871                                  ;	  AX has the returned handle
 43872                                  ;   Errors:
 43873                                  ;	    AX = dup_invalid_handle
 43874                                  ;	       = dup_too_many_open_files
 43875                                  ;
 43876                                  ;----------------------------------------------------------------------------
 43877                                  
 43878                                  	; 12/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43879                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BBEBh
 43880                                  
 43881                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0A95Bh)
 43882                                  	; (Windows ME IO.SYS - BIOSCODE:0A3EFh)
 43883                                  
 43884                                  _$DUP:
 43885 000075BF 89D8                    	MOV	AX,BX			; save away old handle in AX
 43886 000075C1 E8D4FD                  	call	JFNFree 		; free handle? into ES:DI, new in BX
 43887                                  DupErrorCheck:
 43888 000075C4 72F6                    	JC	short DupErr		; nope, bye
 43889 000075C6 06                      	push	es
 43890 000075C7 57                      	push	di			; save away SFT
 43891 000075C8 5E                      	pop	si			; into convenient place DS:SI
 43892 000075C9 1F                      	pop	ds
 43893 000075CA 93                      	XCHG	AX,BX			; get back old handle
 43894 000075CB E81D01                  	call	CheckOwner		; get sft in ES:DI
 43895 000075CE 72EC                    	JC	short DupErr		; errors go home
 43896 000075D0 E81EBA                  	call	DOS_Dup_Direct
 43897 000075D3 E865FD                  	call	pJFNFromHandle		; get pointer
 43898 000075D6 268A1D                  	MOV	BL,[ES:DI]		; get SFT number
 43899 000075D9 881C                    	MOV	[SI],BL			; stuff in new SFT
 43900                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43901                                  	;jmp	SYS_RET_OK		; and go home
 43902 000075DB EB5A                    	jmp	short ok_ret
 43903                                  
 43904                                  	; 17/12/2022
 43905                                  ;DupErr:
 43906                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 43907                                  	;;jmp	SYS_RET_ERR
 43908                                  	;jmp	short ft_error
 43909                                  
 43910                                  ;BREAK <$DUP2 - force a dup on a particular jfn>
 43911                                  ;----------------------------------------------------------------------------
 43912                                  ;
 43913                                  ;   Assembler usage:
 43914                                  ;	    MOV     BX, fh
 43915                                  ;	    MOV     CX, newfh
 43916                                  ;	    MOV     AH, Dup2
 43917                                  ;	    INT     int_command
 43918                                  ;   Error returns:
 43919                                  ;	    AX = error_invalid_handle
 43920                                  ;
 43921                                  ;----------------------------------------------------------------------------
 43922                                  
 43923                                  _$DUP2:
 43924 000075DD 53                      	push	bx
 43925 000075DE 51                      	push	cx			; save source
 43926 000075DF 89CB                    	MOV	BX,CX			; get one to close
 43927 000075E1 E80EFE                  	call	_$CLOSE			; close destination handle
 43928 000075E4 5B                      	pop	bx
 43929 000075E5 58                      	pop	ax			; old in AX, new in BX
 43930 000075E6 E852FD                  	call	pJFNFromHandle		; get pointer
 43931 000075E9 EBD9                    	JMP	short DupErrorCheck	; check error and do dup
 43932                                  
 43933                                  ;BREAK <FileTimes - modify write times on a handle>
 43934                                  ;----------------------------------------------------------------------------
 43935                                  ;
 43936                                  ;   Assembler usage:
 43937                                  ;	    MOV AH, FileTimes (57H)
 43938                                  ;	    MOV AL, func
 43939                                  ;	    MOV BX, handle
 43940                                  ;	; if AL = 1 then then next two are mandatory
 43941                                  ;	    MOV CX, time
 43942                                  ;	    MOV DX, date
 43943                                  ;	    INT 21h
 43944                                  ;	; if AL = 0 then CX/DX has the last write time/date
 43945                                  ;	; for the handle.
 43946                                  ;
 43947                                  ;	AL=02		 get extended attributes
 43948                                  ;	   BX=handle
 43949                                  ;	   CX=size of buffer (0, return max size )
 43950                                  ;	   DS:SI query list (si=-1, selects all EA)
 43951                                  ;	   ES:DI buffer to hold EA list
 43952                                  ;
 43953                                  ;	AL=03		 get EA name list
 43954                                  ;	   BX=handle
 43955                                  ;	   CX=size of buffer (0, return max size )
 43956                                  ;	   ES:DI buffer to hold name list
 43957                                  ;
 43958                                  ;	AL=04		 set extended attributes
 43959                                  ;	   BX=handle
 43960                                  ;	   ES:DI buffer of EA list
 43961                                  ;
 43962                                  ;
 43963                                  ;   Error returns:
 43964                                  ;	    AX = error_invalid_function
 43965                                  ;	       = error_invalid_handle
 43966                                  ;
 43967                                  ;----------------------------------------------------------------------------
 43968                                  
 43969                                  ; 21/05/2019 - Retro DOS v4.0
 43970                                  ; DOSCODE:A90Dh (MSDOS 6.21, MSDOS.SYS)
 43971                                  
 43972                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 43973                                  ; DOSCODE:A8ADh (MSDOS 5.0 MSDOS.SYS)
 43974                                  
 43975                                  	; 12/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 43976                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BAF5h
 43977                                  
 43978                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0A90Dh)
 43979                                  	; (Windows ME IO.SYS - BIOSCODE:0A327h)
 43980                                  
 43981                                  _$FILE_TIMES:
 43982                                  
 43983                                  ; 12/03/2024
 43984                                  %if 0
 43985                                  	; 13/07/2018 - Retro DOS v3.0
 43986                                  
 43987                                  	; MSDOS 3.3
 43988                                  	;cmp	al,2			; correct subfunction ?
 43989                                  	;jb	short ft1
 43990                                  
 43991                                  	;;mov	byte [ss:EXTERR_LOCUS], 1
 43992                                  	;mov	byte [ss:EXTERR_LOCUS],errLOC_Unk ; Extended Error Locus
 43993                                  						;SS Overr
 43994                                  	;;mov	al,1
 43995                                  	;mov	al,error_invalid_function ; give bad return
 43996                                  	;jmp	SYS_RET_ERR
 43997                                  
 43998                                  	; MSDOS 6.0
 43999                                  	cmp	al,2			; correct subfunction ?
 44000                                  	jae	short inval_func
 44001                                  ;ft1:
 44002                                  	call	CheckOwner		; get sft
 44003                                  	; 17/12/2022
 44004                                  	jc	short LSeekError	; bad handle
 44005                                  
 44006                                  	or	al,al			; get time/date ?
 44007                                  	jnz	short ft_set_time
 44008                                  
 44009                                  ;------ here we get the time & date from the sft for the user
 44010                                  
 44011                                  	cli				; is this cli/sti reqd ? BUGBUG
 44012                                  	;mov	cx,[es:di+13]
 44013                                  	mov	cx,[es:di+SF_ENTRY.sf_time] ; get the time
 44014                                  	;mov	dx,[es:di+15]
 44015                                  	mov	dx,[es:di+SF_ENTRY.sf_date] ;  & date
 44016                                  	sti
 44017                                  	call	Get_User_Stack
 44018                                  	;mov	[si+4],cx
 44019                                  	mov	[si+user_env.user_CX],cx
 44020                                  	;mov	[si+6],dx
 44021                                  	mov	[si+user_env.user_DX],dx
 44022                                  	jmp	short ok_ret
 44023                                  
 44024                                  ;------ here we set the time in sft
 44025                                  
 44026                                  ft_set_time:
 44027                                  	call    ECritSFT
 44028                                  	;mov	[es:di+13],cx
 44029                                  	mov	[es:di+SF_ENTRY.sf_time],cx ; drop in new time
 44030                                  	;mov	[es:di+15],dx
 44031                                  	mov	[es:di+SF_ENTRY.sf_date],dx ;  and date	
 44032                                  
 44033                                  	xor	ax, ax
 44034                                  	call	far [ss:JShare+(14*4)] ; 14 = ShSU	; SS Override
 44035                                  
 44036                                  ;------ set the flags in SFT entry
 44037                                  	;and	word [es:di+5],0FFBFh
 44038                                  	; 18/12/2022
 44039                                  	;and	byte [es:di+5],0BFh
 44040                                  	and	byte [es:di+SF_ENTRY.sf_flags],~devid_file_clean
 44041                                  	;and	word [es:di+SF_ENTRY.sf_flags],~devid_file_clean 
 44042                                  							; mark file as dirty
 44043                                  	;or	word [es:di+5],4000h
 44044                                  	; 17/12/2022
 44045                                  	;or	byte [es:di+6],40h
 44046                                  	or	byte [es:di+SF_ENTRY.sf_flags+1],(sf_close_nodate>>8)
 44047                                  	;or	word [es:di+SF_ENTRY.sf_flags],sf_close_nodate
 44048                                  							; ask close not to
 44049                                  							;   bother about date
 44050                                  							;   and time
 44051                                  	call	LCritSFT
 44052                                  
 44053                                  ok_ret:
 44054                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44055                                  	; 17/12/2022
 44056                                  	jmp	SYS_RET_OK
 44057                                  	;jmp	short LSeekOk
 44058                                  
 44059                                  inval_func:
 44060                                  	;mov	byte [ss:EXTERR_LOCUS],1
 44061                                  	mov	byte [ss:EXTERR_LOCUS],errLOC_Unk ; Extended Error Locus
 44062                                  						;SS Overr
 44063                                  	;mov	al,1
 44064                                  	mov	al,error_invalid_function ; give bad return
 44065                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44066                                  ft_error:
 44067                                  	;;jmp	SYS_RET_ERR
 44068                                  	;jmp	short LSeekError3
 44069                                  	; 17/12/2022
 44070                                  	jmp	short LSeekError
 44071                                  
 44072                                  %else
 44073                                  	; 12/03/2024 - Retro DOS v5.0
 44074                                  	; PCDOS 7.1 IBMDOS.COM
 44075                                  	;;;			; ((Ref: Ralf Brown's Intterupt List))
 44076 000075EB 3C07                    	cmp	al,7		; SET CREATION DATE AND TIME
 44077                                  			 	; 6 = GET CREATION DATE AND TIME
 44078                                  			 	; 5 = SET LAST ACCESS DATE AND TIME
 44079                                  	;jnb	short LSeekError1
 44080                                  	; 12/03/2024
 44081 000075ED 737B                    	jnb	short inval_func
 44082 000075EF 3C04                    	cmp	al,4		; GET LAST ACCESS DATE AND TIME
 44083 000075F1 7304                    	jnb	short ft1
 44084 000075F3 3C02                    	cmp	al,2		; 0 = GET FILE'S LAST-WRITTEN DATE AND TIME
 44085                                  			 	; 1 = SET FILE'S LAST-WRITTEN DATE AND TIME
 44086                                  	;jnb	short LSeekError1 ; 2,3 -> invalid
 44087                                  	; 12/03/2024
 44088 000075F5 7373                    	jnb	short inval_func
 44089                                  ft1:
 44090 000075F7 E8F100                  	call	CheckOwner	; get sft
 44091 000075FA 72C0                    	jc	short LSeekError ; bad handle
 44092                                  
 44093 000075FC 3C01                    	cmp	al,1
 44094 000075FE 773A                    	ja	short ft2	; PCDOS 7.1 (MSDOS 7) sub function
 44095                                  
 44096 00007600 08C0                    	or	al,al		; get time/date ?
 44097 00007602 7514                    	jnz	short ft_set_time ; no,set
 44098                                  
 44099                                  	;lds	cx,[es:di+0Dh]
 44100 00007604 26C54D0D                	lds	cx,[es:di+SF_ENTRY.sf_time] 
 44101                                  				; get the time
 44102 00007608 8CDA                    	mov	dx,ds		; & date ; [es:di+SF_ENTRY.sf_date]
 44103 0000760A E86A8E                  	call	Get_User_Stack
 44104                                  	;mov	[si+4],cx
 44105 0000760D 894C04                  	mov	[si+user_env.user_CX],cx
 44106 00007610 895406                  	mov	[si+6],dx
 44107 00007613 895406                  	mov	[si+user_env.user_DX],dx
 44108                                  
 44109 00007616 EB1F                    	jmp	short ft_ok
 44110                                  
 44111                                  ft_set_time:
 44112 00007618 E869A2                  	call	ECritSFT
 44113                                  	
 44114                                  	;mov	[es:di+0Dh],cx
 44115 0000761B 26894D0D                	mov	[es:di+SF_ENTRY.sf_time],cx ; drop in new time
 44116                                  	;mov	[es:di+0Fh],dx
 44117 0000761F 2689550F                	mov	[es:di+SF_ENTRY.sf_date],dx ; and date
 44118                                  	
 44119 00007623 31C0                    	xor	ax,ax ; 0
 44120                                  	;call	ss:ShSU
 44121 00007625 36FF1E[C800]            	call	far [ss:JShare+(14*4)] ; 14 = ShSU
 44122                                  	
 44123                                  	;;and	word [es:di+5],0FFBFh
 44124                                  	;and	word [es:di+SF_ENTRY.sf_flags],~devid_file_clean
 44125 0000762A 26806505BF              	and	byte [es:di+SF_ENTRY.sf_flags],~devid_file_clean ; 0BFh	
 44126                                  
 44127                                  	;;or	word [es:di+5],4000h
 44128                                  	;or	word [es:di+SF_ENTRY.sf_flags],sf_close_nodate
 44129 0000762F 26804D0640              	or	byte [es:di+SF_ENTRY.sf_flags+1],(sf_close_nodate>>8) ; 40h	
 44130                                  
 44131 00007634 E87AA2                  	call	LCritSFT
 44132                                  ft_ok:
 44133                                  ok_ret:		; 12/03/2024
 44134 00007637 E93190                  	jmp	SYS_RET_OK
 44135                                  
 44136                                  ft2:
 44137                                  	;test	byte [es:di+5],80h
 44138 0000763A 26F6450580              	test	byte [es:di+SF_ENTRY.sf_flags],devid_device
 44139 0000763F 7505                    	jnz	short ft3	; device
 44140                                  
 44141 00007641 E8DBA1                  	call	IsSFTNet
 44142                                  ;ft3:
 44143 00007644 7415                    	jz	short ft5	; local file
 44144                                  ft3:		; 12/03/2024
 44145 00007646 A801                    	test	al,1		; 0 = GET, 1 = SET
 44146 00007648 750F                    	jnz	short ft_okj	; SET
 44147                                  
 44148                                  	;mov	dx,[es:di+0Fh]
 44149 0000764A 268B550F                	mov	dx,[es:di+SF_ENTRY.sf_date]
 44150                                  	;;;;
 44151                                  ft7:
 44152                                  	; 12/03/2024
 44153 0000764E 29C9                    	sub	cx,cx ; 0 ; Retro DOS v5.0
 44154                                  				; (Windows ME IO.SYS BIOSCODE:A348h)
 44155                                  	;;;;
 44156                                  ft4:
 44157 00007650 E8248E                  	call	Get_User_Stack
 44158                                  	;mov	[si+4],cx
 44159 00007653 894C04                  	mov	[si+user_env.user_CX],cx ; time
 44160                                  	;mov	[si+6],dx
 44161 00007656 895406                  	mov	[si+user_env.user_DX],dx ; date
 44162                                  ft_okj:
 44163 00007659 EBDC                    	jmp	short ft_ok
 44164                                  
 44165                                  ft5:
 44166 0000765B 16                      	push	ss		; Retrieve the directory entry for the file
 44167 0000765C 1F                      	pop	ds
 44168 0000765D 50                      	push	ax
 44169 0000765E 52                      	push	dx
 44170 0000765F 51                      	push	cx		; ES:DI point to SFT
 44171 00007660 E815C1                  	call	DirFromSFT	; locate a directory entry given an SFT
 44172 00007663 59                      	pop	cx
 44173 00007664 5A                      	pop	dx
 44174 00007665 730B                    	jnc	short ft6	; ES:DI point to entry
 44175                                  			 	; (DS:SI point to SFT)
 44176                                  			 	; (ES:BX point to buffer header)
 44177 00007667 59                      	pop	cx
 44178                                  ;ft_error:
 44179                                  	;jmp	short LSeekError2
 44180                                  	; 12/03/2024
 44181                                  	;jmp	short LseekError
 44182 00007668 EB05                    	jmp	short ft_error
 44183                                  
 44184                                  	;;;;
 44185                                  	; 12/03/2024 - Retro DOS v5.0
 44186                                  inval_func:
 44187 0000766A E84D9C                  	call    set_exerr_locus_unk ; Extended Error Locus
 44188                                  
 44189                                  	;mov	al,1
 44190 0000766D B001                    	mov	al,error_invalid_function ; give bad return
 44191                                  ft_error:
 44192                                  	;jmp	short LSeekError
 44193                                  	; 12/03/2024
 44194 0000766F E90390                  	jmp	SYS_RET_ERR
 44195                                  	;;;;
 44196                                  ft6:
 44197 00007672 58                      	pop	ax
 44198 00007673 A801                    	test	al,1		; SET ?
 44199 00007675 7512                    	jnz	short ft8	; yes
 44200                                  
 44201                                  	; 12/03/2024 (ft7:, cx=0)
 44202                                  	;xor	cx,cx	; 0	; (always) last access time = 0
 44203                                  	
 44204                                  	;mov	dx,[es:di+12h]
 44205 00007677 268B5512                	mov	dx,[es:di+dir_entry.dir_lstaccdate]
 44206                                  
 44207 0000767B 3C06                    	cmp	al,6		; GET CREATION DATE AND TIME ?
 44208 0000767D 75CF                    	jne	short ft7	; no,GET LAST ACCESS DATE AND TIME
 44209                                  
 44210                                  	;mov	cx,[es:di+0Eh]
 44211 0000767F 268B4D0E                	mov	cx,[es:di+dir_entry.dir_crttime]
 44212                                  	;mov	dx,[es:di+10h]
 44213 00007683 268B5510                	mov	dx,[es:di+dir_entry.dir_crtdate]
 44214                                  ;ft7:
 44215 00007687 EBC7                    	jmp	short ft4
 44216                                  
 44217                                  ft8:		; check date (set) values
 44218 00007689 F6C21F                  	test	dl,1Fh	  	; DAY (1 to 31) > 0 ?
 44219 0000768C 7504                    	jnz	short ft9	; yes,valid
 44220                                  
 44221                                  ft_err_invd:
 44222                                  	;mov	al,0Dh
 44223 0000768E B00D                    	mov	al,error_invalid_data
 44224                                  ft_errj:
 44225 00007690 EBDD                    	jmp	short ft_error
 44226                                  
 44227                                  ft9:
 44228 00007692 F7C2E001                	test	dx,1E0h		; MONTH (1 to 12) > 0 ?
 44229 00007696 74F6                    	jz	short ft_err_invd ; no,invalid
 44230 00007698 52                      	push	dx
 44231 00007699 81E2E001                	and	dx,1E0h		; isolate MONTH
 44232 0000769D 81FA8001                	cmp	dx,180h		; > 12 ?
 44233 000076A1 5A                      	pop	dx
 44234 000076A2 77EA                    	ja	short ft_err_invd ; yes,invalid
 44235 000076A4 3C05                    	cmp	al,5		; SET LAST ACCESS DATE AND TIME ?
 44236 000076A6 7506                    	jnz	short ft10	; no,SET CREATION DATE AND TIME
 44237                                  
 44238                                  	;mov	[es:di+12h],dx
 44239 000076A8 26895512                	mov	[es:di+dir_entry.dir_lstaccdate],dx
 44240 000076AC EB20                    	jmp	short ft11
 44241                                  
 44242                                  ft10:		; check time (set) values
 44243 000076AE 89C8                    	mov	ax,cx
 44244 000076B0 251FF8                  	and	ax,0F81Fh	; isolate seconds/2 and hour
 44245 000076B3 80FCB8                  	cmp	ah,0B8h		; HOUR > 23 ?
 44246 000076B6 77D6                    	ja	short ft_err_invd ; yes,invalid
 44247 000076B8 3C1D                    	cmp	al,1Dh		; SECONDS/2 > 29 (count of 2 seconds)
 44248 000076BA 77D2                    	ja	short ft_err_invd ; yes,invalid
 44249 000076BC 89C8                    	mov	ax,cx
 44250 000076BE 25E007                  	and	ax,7E0h		; isolate MINUTE
 44251 000076C1 3D6007                  	cmp	ax,760h		; MINUTE > 59 ?
 44252 000076C4 77C8                    	ja	short ft_err_invd ; yes,invalid
 44253                                  
 44254                                  	;mov	[es:di+10h],dx
 44255 000076C6 26895510                	mov	[es:di+dir_entry.dir_crtdate],dx
 44256                                  	;mov	[es:di+0Eh],cx
 44257 000076CA 26894D0E                	mov	[es:di+dir_entry.dir_crttime],cx
 44258                                  ft11:
 44259                                  	;test	byte [es:bx+5],40h
 44260 000076CE 26F6470540              	test	byte [es:bx+BUFFINFO.buf_flags],buf_dirty
 44261 000076D3 7508                    	jnz	short ft12
 44262                                  
 44263 000076D5 E898F1                  	call	INC_DIRTY_COUNT
 44264                                  
 44265                                  	;or	byte [es:bx+5],40h 
 44266 000076D8 26804F0540              	or	byte [es:bx+BUFFINFO.buf_flags],buf_dirty
 44267                                  ft12:
 44268 000076DD 06                      	push	es
 44269 000076DE 1F                      	pop	ds
 44270 000076DF 89DF                    	mov	di,bx		; DS:DI - pointer to buffer
 44271 000076E1 B0FF                    	mov	al,0FFh		; Drive number
 44272                                  				; -1 means do not check for drive
 44273 000076E3 E8A7F0                  	call	CHECKFLUSH
 44274 000076E6 7287                    	jc	short ft_error
 44275                                  ;ok_ret:	; 12/03/2024
 44276 000076E8 E9808F                  	jmp	SYS_RET_OK
 44277                                  	;;;
 44278                                  %endif
 44279                                  
 44280                                  ;Break	<CheckOwner - verify ownership of handles from server>
 44281                                  ;----------------------------------------------------------------------------
 44282                                  ;   CheckOwner - Due to the ability of the server to close file handles for a
 44283                                  ;   process without the process knowing it (delete/rename of open files, for
 44284                                  ;   example), it is possible for the redirector to issue a call to a handle
 44285                                  ;   that it does not rightfully own. We check here to make sure that the
 44286                                  ;   issuing process is the owner of the SFT. At the same time, we do a
 44287                                  ;   SFFromHandle to really make sure that the SFT is good.
 44288                                  ;
 44289                                  ;	ENTRY	BX has the handle
 44290                                  ;		User_ID is the current user
 44291                                  ;	EXIT	Carry Clear => ES:DI points to SFT
 44292                                  ;		Carry Set => AX has error code
 44293                                  ;	USES	none
 44294                                  ;----------------------------------------------------------------------------
 44295                                  
 44296                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 44297                                  	; 21/05/2019 - Retro DOS v4.0
 44298                                  CheckOwner:
 44299                                  	; 13/07/2018 - Retro DOS v3.0
 44300                                  
 44301 000076EB E86AFC                  	call	SFFromHandle
 44302 000076EE 721B                    	jc	short co_ret_label	; retc
 44303                                  
 44304 000076F0 50                      	push	ax
 44305                                  
 44306                                  	; MSDOS 6.0
 44307                                  
 44308                                  ;SR; WIN386 patch - Do not check for USER_ID for using handles since these 
 44309                                  ;SR; are shared across multiple VMs in win386.
 44310                                  
 44311 000076F1 36F606[470F]01          	test	byte [ss:IsWin386],1 ; 02/06/2019
 44312 000076F7 7404                    	jz	short no_win386		;win386 is not present
 44313 000076F9 31C0                    	xor	ax,ax			;set the zero flag
 44314 000076FB EB08                    	jmp	short _skip_win386	
 44315                                  
 44316                                  no_win386:
 44317 000076FD 36A1[3E03]              	mov	ax,[SS:USER_ID]		;smr;SS Override
 44318                                  	;cmp	ax,[es:di+47]
 44319 00007701 263B452F                	cmp	ax,[es:di+SF_ENTRY.sf_UID]
 44320                                  
 44321                                  _skip_win386:
 44322 00007705 58                      	pop	ax
 44323                                  	
 44324                                  	; 17/12/2022
 44325 00007706 7403                    	jz	short co_ret_label
 44326                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44327                                  	;jnz	short CheckOwner_err
 44328                                  	;retn
 44329                                  	
 44330                                  CheckOwner_err:
 44331                                  	;mov	al,6
 44332 00007708 B006                    	mov	al,error_invalid_handle
 44333 0000770A F9                      	stc
 44334                                  
 44335                                  co_ret_label:
 44336 0000770B C3                      	retn
 44337                                  
 44338                                  ;============================================================================
 44339                                  ; MACRO.ASM, MSDOS 6.0, 1991
 44340                                  ;============================================================================
 44341                                  ; Retro	DOS v3.0 - 11/07/2018
 44342                                  ; 21/05/2019 - Retro DOS v4.0
 44343                                  ; 13/03/2024 - Retro DOS v5.0
 44344                                  
 44345                                  ;	TITLE	MACRO - Pathname and macro related internal routines
 44346                                  ;	NAME	MACRO
 44347                                  
 44348                                  ;	Microsoft Confidential
 44349                                  ;	Copyright (C) Microsoft Corporation 1991
 44350                                  ;	All Rights Reserved.
 44351                                  
 44352                                  ;**	MACRO.ASM
 44353                                  ;
 44354                                  ;	$AssignOper
 44355                                  ;	FIND_DPB
 44356                                  ;	InitCDS
 44357                                  ;	$UserOper
 44358                                  ;	GetVisDrv
 44359                                  ;	GetThisDrv
 44360                                  ;	GetCDSFromDrv
 44361                                  ;
 44362                                  ;   Revision history:
 44363                                  ;
 44364                                  ;	Created: MZ 4 April 1983
 44365                                  ;		 MZ 18 April 1983   Make TransFCB handle extended FCBs
 44366                                  ;		 AR 2 June 1983     Define/Delete macro for NET redir.
 44367                                  ;		 MZ 3 Nov 83	    Fix InitCDS to reset length to 2
 44368                                  ;		 MZ 4 Nov 83	    Fix NetAssign to use STRLEN only
 44369                                  ;		 MZ 18 Nov 83	    Rewrite string processing for subtree
 44370                                  ;				    aliasing.
 44371                                  ;
 44372                                  ;   MSDOS performs several types of name translation. First, we maintain for
 44373                                  ;   each valid drive letter the text of the current directory on that drive.
 44374                                  ;   For invalid drive letters, there is no current directory so we pretend to
 44375                                  ;   be at the root. A current directory is either the raw local directory
 44376                                  ;   (consisting of drive:\path) or a local network directory (consisting of
 44377                                  ;   \\machine\path. There is a limit on the point to which a .. is allowed.
 44378                                  ;
 44379                                  ;   Given a path, MSDOS will transform this into a real from-the-root path
 44380                                  ;   without . or .. entries. Any component that is > 8.3 is truncated to
 44381                                  ;   this and all * are expanded into ?'s.
 44382                                  ;
 44383                                  ;   The second part of name translation involves subtree aliasing. A list of
 44384                                  ;   subtree pairs is maintained by the external utility SUBST. The results of
 44385                                  ;   the previous 'canonicalization' are then examined to see if any of the
 44386                                  ;   subtree pairs is a prefix of the user path. If so, then this prefix is
 44387                                  ;   replaced with the other subtree in the pair.
 44388                                  ;
 44389                                  ;   A third part involves mapping this "real" path into a "physical" path.  A
 44390                                  ;   list of drive/subtree pairs are maintained by the external utility JOIN.
 44391                                  ;   The output of the previous translation is examined to see if any of the
 44392                                  ;   subtrees in this list are a prefix of the string. If so, then the prefix
 44393                                  ;   is replaced by the appropriate drive letter. In this manner, we can
 44394                                  ;   'mount' one device under another.
 44395                                  ;
 44396                                  ;   The final form of name translation involves the mapping of a user's
 44397                                  ;   logical drive number into the internal physical drive. This is
 44398                                  ;   accomplished by converting the drive number into letter:CON, performing
 44399                                  ;   the above translation and then converting the character back into a drive
 44400                                  ;   number.
 44401                                  ;
 44402                                  ;   There are two main entry points: TransPath and TransFCB. TransPath will
 44403                                  ;   take a path and form the real text of the pathname with all . and ..
 44404                                  ;   removed. TransFCB will translate an FCB into a path and then invoke
 44405                                  ;   TransPath.
 44406                                  ;
 44407                                  ;	A000	version 4.00  Jan. 1988
 44408                                  
 44409                                  ;Installed = TRUE
 44410                                  
 44411                                  ;	I_need	ThisCDS,DWORD		; pointer to CDS used
 44412                                  ;	I_need	CDSAddr,DWORD		; pointer to CDS table
 44413                                  ;	I_need	CDSCount,BYTE		; number of CDS entries
 44414                                  ;	I_need	CurDrv,BYTE		; current macro assignment (old
 44415                                  ;					; current drive)
 44416                                  ;	I_need	NUMIO,BYTE		; Number of physical drives
 44417                                  ;	I_need	fSharing,BYTE		; TRUE => no redirection allowed
 44418                                  ;	I_need	DummyCDS,80h		; buffer for dummy cds
 44419                                  ;	I_need	DIFFNAM,BYTE		; flag for MyName being set
 44420                                  ;	I_need	MYNAME,16		; machine name
 44421                                  ;	I_need	MYNUM,WORD		; machine number
 44422                                  ;	I_need	DPBHEAD,DWORD		; beginning of DPB chain
 44423                                  ;	I_need	EXTERR_LOCUS,BYTE	; Extended Error Locus
 44424                                  ;	I_need	DrvErr,BYTE		; drive error
 44425                                  
 44426                                  ;BREAK <$AssignOper -- Set up a Macro>
 44427                                  ;----------------------------------------------------------------------------
 44428                                  ; Inputs:
 44429                                  ;	AL = 00 get assign mode 		    (ReturnMode)
 44430                                  ;	AL = 01 set assign mode 		    (SetMode)
 44431                                  ;	AL = 02 get attach list entry		    (GetAsgList)
 44432                                  ;	AL = 03 Define Macro (attch start)
 44433                                  ;	    BL = Macro type
 44434                                  ;	       = 0 alias
 44435                                  ;	       = 1 file/device
 44436                                  ;	       = 2 drive
 44437                                  ;	       = 3 Char device -> network
 44438                                  ;	       = 4 File device -> network
 44439                                  ;	    DS:SI -> ASCIZ source name
 44440                                  ;	    ES:DI -> ASCIZ destination name
 44441                                  ;	AL = 04 Cancel Macro
 44442                                  ;	    DS:SI -> ASCIZ source name
 44443                                  ;	AL = 05 Modified get attach list entry
 44444                                  ;	AL = 06 Get ifsfunc item
 44445                                  ;	AL = 07 set in_use of a drive's CDS
 44446                                  ;	     DL = drive number, 0=default  0=A,,
 44447                                  ;	AL = 08 reset in_use of a drive's CDS
 44448                                  ;	     DL = drive number, 0=A, 1=B,,,
 44449                                  ; Function:
 44450                                  ;	Do macro stuff
 44451                                  ; Returns:
 44452                                  ;	Std Xenix style error return
 44453                                  ;----------------------------------------------------------------------------
 44454                                  
 44455                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 44456                                  	; 21/05/2019 - Retro DOS v4.0
 44457                                  
 44458                                  _$AssignOper:
 44459                                  	; MSDOS 6.0
 44460 0000770C 3C07                    	CMP	AL,7			      ; set in_use ?		;AN000;
 44461 0000770E 7525                    	JNZ	short chk08		      ; no			;AN000;
 44462                                  srinuse:								;AN000;
 44463 00007710 50                      	PUSH	AX			      ; save al 		;AN000;
 44464 00007711 88D0                    	MOV	AL,DL			      ; AL= drive id		;AN000;
 44465 00007713 E84B01                  	CALL	GetCDSFromDrv		      ; ds:si -> cds		;AN000;
 44466 00007716 58                      	POP	AX			      ; 			;AN000;
 44467 00007717 7216                    	JC	short baddrv		      ; bad drive		;AN000;
 44468                                  	;cmp	word [si+45h],0
 44469 00007719 837C4500                	CMP	WORD [SI+curdir.devptr],0     ; dpb ptr =0 ?		;AN000;
 44470 0000771D 7410                    	JZ	short baddrv		      ;     no			;AN000;
 44471 0000771F 3C07                    	CMP	AL,7			      ; set ?			;AN000;
 44472 00007721 7506                    	JNZ	short resetdrv		      ; no			;AN000;
 44473                                  	;or	word [si+43h],4000h
 44474                                  	; 17/12/2022
 44475                                  	;or	byte [si+44h],40h
 44476 00007723 804C4440                	or	byte [SI+curdir.flags+1],(curdir_inuse>>8)
 44477                                  	;OR	word [SI+curdir.flags],curdir_inuse ; set in_use	;AN000;
 44478 00007727 EB19                    	JMP	SHORT okdone		      ; 			;AN000;
 44479                                  resetdrv:
 44480                                  	;and	word [si+43h],0BFFFh					;AN000;
 44481                                  	; 18/12/2022
 44482 00007729 806444BF                	and	byte [SI+curdir.flags+1],0BFh ; (~curdir_inuse)>>8
 44483                                  	;AND	word [SI+curdir.flags],~curdir_inuse ; reset in_use	;AN000;
 44484 0000772D EB13                    	JMP	SHORT okdone		      ; 			;AN000;
 44485                                  
 44486                                  	; 17/12/2022
 44487                                  baddrv: 								;AN000;
 44488 0000772F B80F00                  	MOV	AX,error_invalid_drive	      ; error			;AN000;
 44489                                  
 44490                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44491                                  	;JMP	SHORT ASS_ERR		      ; 			;AN000;
 44492                                  	; 17/12/2022
 44493                                  	; 21/05/2019
 44494                                  ASS_ERR:
 44495 00007732 E9408F                  	jmp	SYS_RET_ERR
 44496                                  
 44497                                  chk08:									;AN000;
 44498 00007735 3C08                    	CMP	AL,8			      ; reset inuse ?		;AN000;
 44499 00007737 74D7                    	JZ	short srinuse 		      ; yes			;AN000;
 44500                                  
 44501                                    ;IF	NOT INSTALLED
 44502                                  	;transfer NET_ASSOPER
 44503                                    ;ELSE
 44504                                  	; MSDOS 3.3 (& MSDOS 6.0)
 44505 00007739 50                      	PUSH	AX
 44506                                  	;mov	ax,111Eh
 44507                                  	;MOV	AX,(MultNET SHL 8) OR 30
 44508 0000773A B81E11                  	mov	ax,(MultNET*256)+30
 44509 0000773D CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - DO REDIRECTION
 44510                                  			; SS = DOS CS
 44511                                  			; STACK: WORD function to execute
 44512                                  			; Return: CF set on error, AX = error code
 44513                                  			; STACK unchanged
 44514 0000773F 5B                      	POP	BX			; Don't zap error code in AX
 44515 00007740 72F0                    	JC	short ASS_ERR
 44516                                  okdone:
 44517 00007742 E9268F                  	jmp	SYS_RET_OK
 44518                                  
 44519                                  	; 17/12/2022
 44520                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44521                                  ;ASS_ERR:
 44522                                  	;jmp	SYS_RET_ERR
 44523                                  
 44524                                    ;ENDIF
 44525                                  
 44526                                  ;Break <FIND_DPB - Find a DPB from a drive number>
 44527                                  ;----------------------------------------------------------------------------
 44528                                  ;**	FIND_DPB - Find a DPB from a Drive #
 44529                                  ;
 44530                                  ;	ENTRY	AL has drive number A = 0
 44531                                  ;	EXIT	'C' set
 44532                                  ;		    No DPB for this drive number
 44533                                  ;		'C' clear
 44534                                  ;		    DS:SI points to DPB for drive
 44535                                  ;	USES	SI, DS, Flags
 44536                                  ;----------------------------------------------------------------------------
 44537                                  
 44538                                  	; 21/05/2019 - Retro DOS v4.0
 44539                                  FIND_DPB:
 44540 00007745 36C536[2600]            	LDS	SI,[SS:DPBHEAD]		;smr;SS Override
 44541                                  fdpb5:	
 44542 0000774A 83FEFF                  	CMP	SI,-1
 44543 0000774D 7409                    	JZ	short fdpb10
 44544 0000774F 3A04                    	cmp	al,[si]
 44545                                  	;CMP	AL,[SI+DPB.DRIVE]
 44546 00007751 7406                    	jz	short ret_label15	; Carry clear (retz)
 44547                                  	;;lds	si,[si+18h] ; MSDOS 3.3
 44548                                  	;lds	si,[si+19h] ; MSDOS 6.0
 44549 00007753 C57419                  	LDS	SI,[SI+DPB.NEXT_DPB]
 44550 00007756 EBF2                    	JMP	short fdpb5
 44551                                  fdpb10:	
 44552 00007758 F9                      	STC
 44553                                  ret_label15:
 44554 00007759 C3                      	retn
 44555                                  
 44556                                  ;	Break <InitCDS - set up an empty CDS>
 44557                                  ;----------------------------------------------------------------------------
 44558                                  ;**	InitCDS - Setup an Empty CDS
 44559                                  ;
 44560                                  ;	ENTRY	ThisCDS points to CDS
 44561                                  ;		AL has uppercase drive letter
 44562                                  ;	EXIT	ThisCDS is now empty
 44563                                  ;		(ES:DI) = CDS
 44564                                  ;		'C' set if no DPB associated with drive
 44565                                  ;	USES	AH,ES,DI, Flags
 44566                                  ;----------------------------------------------------------------------------
 44567                                  
 44568                                  ; 21/05/2019 - Retro DOS v4.0
 44569                                  ; DOSCODE:A9FDh (MSDOS 6.21, MSDOS.SYS)
 44570                                  
 44571                                  ; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 44572                                  ; DOSCODE:A99Dh (MSDOS 5.0, MSDOS.SYS)
 44573                                  
 44574                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 44575                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BC91h
 44576                                  
 44577                                  InitCDS:
 44578                                  	; 19/08/2018
 44579                                  	; 05/08/2018 - Retro DOS v3.0
 44580                                  	; MSDOS 6.0
 44581 0000775A 50                      	push	ax			; save (AL) for caller
 44582 0000775B 36C43E[A205]            	LES	DI,[SS:THISCDS]		; (es:di) = CDS address
 44583                                  	;mov	word [es:di+67],0
 44584 00007760 26C745430000            	MOV	word [ES:DI+curdir.flags],0 ; "free" CDS
 44585 00007766 2C40                    	SUB	AL,"A"-1                ; A = 1
 44586 00007768 363806[4600]            	CMP	[SS:NUMIO],AL		;smr;SS Override
 44587 0000776D 7236                    	JC	short icdsx		; Drive does not map a physical drive
 44588 0000776F 48                      	dec	ax			; (AL) = 0 if A, 1 if B, etc.
 44589 00007770 50                      	PUSH	AX			; save drive number for later
 44590 00007771 0441                    	add	al,"A"
 44591 00007773 B43A                    	MOV	AH,':'
 44592 00007775 268905                  	mov	[ES:DI],ax
 44593                                  	;MOV	[ES:DI+curdir.text],AX 	; set "x:"
 44594                                  	;mov	ax,"\"
 44595                                  	;mov	[es:di+2],ax
 44596                                  	;MOV	word [ES:DI+curdir.text+2],"\"	; NUL terminate
 44597 00007778 26C745025C00            	mov	word [ES:DI+curdir.text+2],005Ch ; 19/08/2018
 44598                                  	;or	word [es:di+67],4000h
 44599                                  	;or	byte [es:di+68],40h
 44600 0000777E 26804D4440              	OR	byte [ES:DI+curdir.flags+1],(curdir_inuse>>8)
 44601 00007783 29C0                    	sub	ax,ax
 44602                                  	;MOV	[es:di+73],ax ; 0
 44603 00007785 26894549                	MOV	[ES:DI+curdir.ID],ax
 44604                                  	;mov	[es:di+75],ax ; 0
 44605 00007789 2689454B                	MOV	[ES:DI+curdir.ID+2],ax
 44606 0000778D B002                    	mov	al,2
 44607                                  	;mov	[es:di+79],aX ; 2
 44608 0000778F 2689454F                	MOV	[ES:DI+curdir.end],ax
 44609 00007793 58                      	POP	AX			; (al) = drive number
 44610 00007794 1E                      	push	ds
 44611 00007795 56                      	push	si
 44612 00007796 E8ACFF                  	call	FIND_DPB
 44613 00007799 7208                    	JC	short icds5		; OOOOPPPPPSSSS!!!!
 44614                                  	;mov	[es:di+69],si
 44615 0000779B 26897545                	MOV	[ES:DI+curdir.devptr],SI
 44616                                  	;mov	[es:di+71],ds
 44617 0000779F 268C5D47                	MOV	[ES:DI+curdir.devptr+2],DS
 44618                                  icds5:	
 44619 000077A3 5E                      	pop	si
 44620 000077A4 1F                      	pop	ds
 44621                                  icdsx:	
 44622 000077A5 58                      	pop	ax
 44623                                  RET45:
 44624 000077A6 C3                      	retn
 44625                                  
 44626                                  ;Break <$UserOper - get/set current user ID (for net)>
 44627                                  ;----------------------------------------------------------------------------
 44628                                  ;   $UserOper - retrieve or initiate a user id string.	MSDOS will only
 44629                                  ;	maintain this string and do no verifications.
 44630                                  ;
 44631                                  ;   Inputs:	AL has function type (0-get 1-set 2-printer-set 3-printer-get
 44632                                  ;				      4-printer-set-flags,5-printer-get-flags)
 44633                                  ;		DS:DX is user string pointer (calls 1,2)
 44634                                  ;		ES:DI is user buffer (call 3)
 44635                                  ;		BX is assign index (calls 2,3,4,5)
 44636                                  ;		CX is user number (call 1)
 44637                                  ;		DX is flag word (call 4)
 44638                                  ;   Outputs:	If AL = 0 then the current user string is written to DS:DX
 44639                                  ;			and user CX is set to the user number
 44640                                  ;		If AL = 3 then CX bytes have been put at input ES:DI
 44641                                  ;		If AL = 5 then DX is flag word
 44642                                  ;----------------------------------------------------------------------------
 44643                                  
 44644                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 44645                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 44646                                  	; 21/05/2019 - Retro DOS v4.0
 44647                                  _$UserOper:
 44648                                  	; 05/08/2018 - Retro DOS v3.0
 44649                                  	; MSDOS 6.0 (& MSDOS 3.3)
 44650                                  	;PUSH	AX
 44651                                  	;SUB	AL,1			; quick dispatch on 0,1
 44652                                  	;POP	AX
 44653                                  	; 01/07/2024
 44654 000077A7 3C01                    	cmp	al,1
 44655 000077A9 720E                    	JB	short UserGet 		; return to user the string
 44656 000077AB 742B                    	JZ	short UserSet 		; set the current user
 44657 000077AD 3C05                    	CMP	AL,5			; test for 2,3,4 or 5
 44658 000077AF 763A                    	JBE	short UserPrint		; yep
 44659                                  
 44660                                  ; 13/03/2024
 44661                                  %if 0
 44662                                  	;mov	byte [ss:EXTERR_LOCUS],1
 44663                                  	MOV	byte [SS:EXTERR_LOCUS],errLOC_Unk ;smr;SS Override 
 44664                                  					; Extended Error Locus
 44665                                  %else
 44666                                  	; 13/03/2024 (PCDOS 7.1 IBMDOS.COM)
 44667                                  	;;;
 44668 000077B1 E8069B                  	call	set_exerr_locus_unk	; Extended Error Locus
 44669                                  	;;;
 44670                                  %endif					
 44671                                  	;error	error_invalid_function	; not 0,1,2,3
 44672                                  	;mov	al,1
 44673 000077B4 B001                    	MOV	AL,error_invalid_function
 44674                                  useroper_error:
 44675                                  	; 17/12/2022
 44676                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44677 000077B6 E9BC8E                  	JMP	SYS_RET_ERR
 44678                                  	;jmp	short ASS_ERR
 44679                                  
 44680                                  UserGet:
 44681                                  ; Transfer MYNAME to DS:DX
 44682                                  ; Set Return CX to MYNUM
 44683 000077B9 1E                      	PUSH	DS			; switch registers
 44684 000077BA 07                      	POP	ES
 44685 000077BB 89D7                    	MOV	DI,DX			; destination
 44686 000077BD 368B0E[0E00]            	MOV	CX,[SS:MYNUM]		; Get number	;smr;SS Override
 44687 000077C2 E8B28C                  	call	Get_User_Stack
 44688                                  	;mov	[si+4],cx
 44689 000077C5 894C04                  	MOV	[SI+user_env.user_CX],CX ; Set number return
 44690 000077C8 16                      	push	ss			; point to DOSDATA
 44691 000077C9 1F                      	pop	ds
 44692 000077CA BE[0503]                	MOV	SI,MYNAME		; point source to user string
 44693                                  UserMove:
 44694 000077CD B90F00                  	MOV	CX,15
 44695 000077D0 F3A4                    	REP	MOVSB			; blam.
 44696 000077D2 31C0                    	XOR	AX,AX			; 16th byte is 0
 44697 000077D4 AA                      	STOSB
 44698                                  UserBye:
 44699 000077D5 E9938E                  	jmp	SYS_RET_OK		; no errors here
 44700                                  
 44701                                  UserSet:
 44702                                  ; Transfer DS:DX to MYNAME
 44703                                  ; CX to MYNUM
 44704 000077D8 36890E[0E00]            	MOV	[SS:MYNUM],CX				;smr;SS Override
 44705 000077DD 89D6                    	MOV	SI,DX			; user space has source
 44706 000077DF 16                      	push	ss
 44707 000077E0 07                      	pop	es
 44708 000077E1 BF[0503]                	MOV	DI,MYNAME		; point dest to user string
 44709 000077E4 36FE06[0403]            	INC	byte [SS:DIFFNAM]	; signal change ;smr;SS Override
 44710 000077E9 EBE2                    	JMP	short UserMove
 44711                                  
 44712                                  UserPrint:
 44713                                  
 44714                                    ;IF NOT Installed
 44715                                    ;	transfer PRINTER_GETSET_STRING
 44716                                    ;ELSE
 44717 000077EB 50                      	PUSH	AX
 44718                                  	;mov	ax,111Fh
 44719                                  	;MOV	AX,(MultNET SHL 8) OR 31
 44720 000077EC B81F11                  	mov	ax,(MultNET<<8)|31
 44721 000077EF CD2F                    	int     2Fh	; Multiplex - NETWORK REDIRECTOR - PRINTER SETUP
 44722                                  			; STACK: WORD function
 44723                                  			; Return: CF set on error, AX = error code
 44724                                  			; STACK unchanged
 44725 000077F1 5A                      	POP	DX			; Clean stack
 44726                                  	;JNC	short OKPA
 44727 000077F2 73E1                    	jnc	short UserBye ; 21/05/2019
 44728                                  	; 17/12/2022
 44729 000077F4 EBC0                    	jmp	short useroper_error
 44730                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44731                                  	;jnb     short OKPA
 44732                                  	;jmp     short useroper_error
 44733                                  
 44734                                  	; 17/12/2022
 44735                                  ;OKPA:
 44736                                  ;	jmp	short UserBye
 44737                                  
 44738                                    ;ENDIF
 44739                                  
 44740                                  ;Break	<GetVisDrv - return visible drive>
 44741                                  ;----------------------------------------------------------------------------
 44742                                  ;   GetVisDrv - correctly map non-spliced inuse drives
 44743                                  ;
 44744                                  ;   Inputs:	AL has drive identifier (0=default)
 44745                                  ;   Outputs:	Carry Set - invalid drive/macro
 44746                                  ;		Carry Clear - AL has physical drive (0=A)
 44747                                  ;		    ThisCDS points to CDS
 44748                                  ;   Registers modified: AL
 44749                                  ;----------------------------------------------------------------------------
 44750                                  
 44751                                  	; 21/05/2019 - Retro DOS v4.0
 44752                                  	; DOSCODE:AA9Fh (MSDOS 6.21, MSDOS.SYS)
 44753                                  
 44754                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 44755                                  	; DOSCODE:AA3Fh (MSDOS 5.0, MSDOS.SYS)
 44756                                  
 44757                                  GetVisDrv:
 44758                                  	; 05/08/2018 - Retro DOS v3.0
 44759                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 6839h
 44760 000077F6 E81900                  	CALL	GETTHISDRV		; get inuse drive
 44761 000077F9 72AB                    	jc	short RET45
 44762 000077FB 1E                      	push	ds
 44763 000077FC 56                      	push	si
 44764 000077FD 36C536[A205]            	LDS	SI,[SS:THISCDS]		;smr;SS Override
 44765                                  	;test	word [si+67],2000h
 44766                                  	; 17/12/2022
 44767                                  	;test	byte [si+68],20h
 44768 00007802 F6444420                	test	byte [SI+curdir.flags+1],(curdir_splice>>8)
 44769                                  	;TEST	word [SI+curdir.flags],curdir_splice
 44770 00007806 5E                      	pop	si
 44771 00007807 1F                      	pop	ds
 44772 00007808 749C                    	jz	short RET45		; if not spliced, return OK
 44773                                  	; MSDOS 6.0
 44774                                  	;mov	byte [ss:DrvErr],0Fh
 44775 0000780A 36C606[1006]0F          	MOV	byte [SS:DrvErr],error_invalid_drive ;IFS. ;AN000;smr;SS Override
 44776 00007810 F9                      	STC				; signal error
 44777 00007811 C3                      	retn
 44778                                  
 44779                                  ;Break <Getthisdrv - map a drive designator (0=def, 1=A...)>
 44780                                  ;----------------------------------------------------------------------------
 44781                                  ;   GetThisDrv - look through a set of macros and return the current drive and
 44782                                  ;	macro pointer
 44783                                  ;
 44784                                  ;   Inputs:	AL has drive identifier (1=A, 0=default)
 44785                                  ;   Outputs:
 44786                                  ;		Carry Set - invalid drive/macro
 44787                                  ;		Carry Clear - AL has physical drive (0=A)
 44788                                  ;		   ThisCDS points to macro
 44789                                  ;   Registers modified: AL
 44790                                  ;----------------------------------------------------------------------------
 44791                                  
 44792                                  	; 21/05/2019 - Retro DOS v4.0
 44793                                  	; DOSCODE:AABCh (MSDOS 6.21, MSDOS.SYS)
 44794                                  
 44795                                  	; 02/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 44796                                  	; DOSCODE:AA5Ch (MSDOS 5.0, MSDOS.SYS)
 44797                                  
 44798                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 44799                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BD48h
 44800                                  
 44801                                  GETTHISDRV:
 44802                                  	; 05/08/2018
 44803                                  	; 12/07/2018 - Retro DOS v3.0
 44804                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 6850h
 44805                                  	; MSDOS 3.3 (& MSDOS 6.0)
 44806 00007812 08C0                    	OR	AL,AL			; are we using default drive?
 44807 00007814 7505                    	JNZ	SHORT GTD10		; no, go get the CDS pointers
 44808 00007816 36A0[3603]              	MOV	AL,[SS:CURDRV]		; get the current drive
 44809                                  	;INC	ax			; Counteract next instruction
 44810                                  	; 04/09/2018
 44811                                  	;inc	al
 44812                                  	; 07/12/2022
 44813 0000781A 40                      	inc	ax
 44814                                  GTD10:	
 44815                                  	;DEC	AX
 44816                                  	; 02/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 44817 0000781B 48                      	dec	ax			; 0 = A
 44818                                  	;dec	al
 44819 0000781C 1E                      	PUSH	DS			; save world
 44820 0000781D 56                      	PUSH	SI
 44821                                  
 44822                                  ; 13/03/2024
 44823                                  %if 0
 44824                                  	;mov	byte [ss:EXTERR_LOCUS],2
 44825                                  	MOV	BYTE [SS:EXTERR_LOCUS],errLOC_Disk		;smr;SS Override
 44826                                  	TEST	BYTE [SS:FSHARING],-1	; Logical or Physical?	;smr;SS Override
 44827                                  	JZ	SHORT GTD20		; Logical
 44828                                  %else
 44829                                  	; 13/03/2024 (PCDOS 7.1 IBMDOS.COM)
 44830                                  	;;;
 44831 0000781E E8A29A                  	call	set_exerr_locus_disk
 44832 00007821 36803E[7205]00          	cmp	byte [ss:FSHARING],0	; Logical or Physical?
 44833 00007827 7420                    	jz	short GTD20		; Logical
 44834                                  	;;;	
 44835                                  %endif
 44836 00007829 50                      	PUSH	AX
 44837 0000782A 06                      	PUSH	ES
 44838 0000782B 57                      	PUSH	DI
 44839 0000782C 36C706[A205][F304]      	MOV	WORD [SS:THISCDS],DUMMYCDS ;smr;SS Override
 44840                                  	;mov	[SS:THISCDS+2],CS ; MSDOS 3.3
 44841 00007833 368C16[A405]            	MOV	[SS:THISCDS+2],SS ; MSDOS 6.0 ;ThisCDS = &DummyCDS;smr;
 44842 00007838 0441                    	ADD	AL,'A'
 44843 0000783A E81DFF                  	CALL	InitCDS			; InitCDS(c);
 44844                                  	;test	word [es:di+67],4000h
 44845                                  	; 17/12/2022
 44846                                  	;test	byte [es:di+68],40h
 44847 0000783D 26F6454440              	test	byte [ES:DI+curdir.flags+1],(curdir_inuse>>8)
 44848                                  	;TEST	WORD [ES:DI+curdir.flags],curdir_inuse	; Clears carry
 44849 00007842 5F                      	POP	DI
 44850 00007843 07                      	POP	ES
 44851 00007844 58                      	POP	AX
 44852 00007845 740D                    	JZ	SHORT GTD30		; Not a physical drive.
 44853 00007847 EB15                    	JMP	SHORT GTDX		; carry clear
 44854                                  GTD20:
 44855 00007849 E81500                  	CALL	GetCDSFromDrv
 44856 0000784C 7206                    	JC	SHORT GTD30	; Unassigned CDS -> return error already set
 44857                                  	;test	word [si+43h],4000h
 44858                                  	; 17/12/2022
 44859                                  	;test	byte [si+44h],40h
 44860 0000784E F6444440                	test	byte [SI+curdir.flags+1],(curdir_inuse>>8)
 44861                                  	;TEST	WORD [SI+curdir.flags],curdir_inuse ; Clears Carry
 44862 00007852 750A                    	JNZ	SHORT GTDX		; carry clear
 44863                                  GTD30:	
 44864                                  	; 21/05/2019
 44865                                  	; MSDOS 6.0
 44866 00007854 B00F                    	MOV	AL,error_invalid_drive	; invalid FAT drive
 44867 00007856 36A2[1006]              	MOV	BYTE [ss:DrvErr],AL	; save this for IOCTL
 44868                                  
 44869                                  ; 13/03/2024
 44870                                  %if 0
 44871                                  	; MSDOS 3.3 (.& MSDOS 6.0)
 44872                                  	MOV	BYTE [ss:EXTERR_LOCUS],errLOC_Unk
 44873                                  %else
 44874                                  	; 13/03/2024 (PCDOS 7.1 IBMDOS.COM)
 44875                                  	;;;
 44876 0000785A E85D9A                  	call	set_exerr_locus_unk
 44877                                  	;;;
 44878                                  %endif
 44879 0000785D F9                      	STC
 44880                                  GTDX:	
 44881 0000785E 5E                      	POP	SI			; restore world
 44882 0000785F 1F                      	POP	DS
 44883 00007860 C3                      	RETN
 44884                                  
 44885                                  ;Break <GetCDSFromDrv - convert a drive number to a CDS pointer>
 44886                                  ;----------------------------------------------------------------------------
 44887                                  ;   GetCDSFromDrv - given a physical drive number, convert it to a CDS
 44888                                  ;	pointer, returning an error if the drive number is greater than the
 44889                                  ;	number of CDS's
 44890                                  ;
 44891                                  ;   Inputs:	AL is physical unit # A=0...
 44892                                  ;   Outputs:	Carry Set if Bad Drive
 44893                                  ;		Carry Clear
 44894                                  ;		    DS:SI -> CDS
 44895                                  ;		    [THISCDS] = DS:SI
 44896                                  ;   Registers modified: DS,SI
 44897                                  ;----------------------------------------------------------------------------
 44898                                  
 44899                                  	; 21/05/2019 - Retro DOS v4.0
 44900                                  GetCDSFromDrv:
 44901 00007861 363A06[4700]            	CMP	AL,[SS:CDSCOUNT]	; is this a valid designator;smr;SS Override
 44902                                  	;JB	SHORT GetCDS	; cf=1	; yes, go get the macro
 44903                                  	;STC				; signal error
 44904                                  	;RETN				; bye
 44905                                  	; 23/09/2023
 44906 00007866 F5                      	cmc	; cf=1 <-> cf=0
 44907 00007867 7217                    	jc	short GetCDS_retn
 44908                                  GetCDS:
 44909                                  	; 23/09/2023
 44910                                  	;PUSH	BX
 44911 00007869 50                      	PUSH	AX
 44912 0000786A 36C536[3C00]            	LDS	SI,[SS:CDSADDR]		; get pointer to table	;smr;SS Override
 44913                                  	;mov	bl,81 ; MSDOS 3.3
 44914                                  	;mov	bl,88 ; MSDOS 6.0 
 44915                                  	; 23/09/2023
 44916                                  	;MOV	BL,curdir.size		; size in convenient spot
 44917                                  	;MUL	BL			; get net offset
 44918 0000786F B458                    	mov	ah,curdir.size
 44919 00007871 F6E4                    	mul	ah
 44920 00007873 01C6                    	ADD	SI,AX ; *		; convert to true pointer
 44921 00007875 368936[A205]            	MOV	[SS:THISCDS],SI		; store convenient offset;smr;SS Override
 44922 0000787A 368C1E[A405]            	MOV	[SS:THISCDS+2],DS	; store convenient segment;smr;SS Override
 44923 0000787F 58                      	POP	AX
 44924                                  	; 23/09/2023
 44925                                  	;POP	BX
 44926                                  	; (cf must be 0 here) ; *
 44927                                  	;CLC				; no error
 44928                                  GetCDS_retn:
 44929 00007880 C3                      	RETN				; bye!
 44930                                  
 44931                                  ;============================================================================
 44932                                  ; MACRO2.ASM, MSDOS 6.0, 1991
 44933                                  ;============================================================================
 44934                                  ; Retro	DOS v3.0 - 12/07/2018
 44935                                  ; 22/05/2019 - Retro DOS v4.0
 44936                                  ; 13/03/2024 - Retro DOS v5.0
 44937                                  
 44938                                  ;BREAK <TransFCB - convert an FCB into a path, doing substitution>
 44939                                  ;----------------------------------------------------------------------------
 44940                                  ;   TransFCB - Copy an FCB from DS:DX into a reserved area doing all of the
 44941                                  ;       gritty substitution.
 44942                                  ;
 44943                                  ;   Inputs:     DS:DX - pointer to FCB
 44944                                  ;               ES:DI - point to destination
 44945                                  ;   Outputs:    Carry Set - invalid path in final map
 44946                                  ;               Carry Clear - FCB has been mapped into ES:DI
 44947                                  ;                   Sattrib is set from possibly extended FCB
 44948                                  ;                   ExtFCB set if extended FCB found
 44949                                  ;   Registers modified: most
 44950                                  ;----------------------------------------------------------------------------
 44951                                  
 44952                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 44953                                  TransFCB:
 44954                                  	; 22/05/2019 - Retro DOS v4.0
 44955                                  	; 12/07/2018 - Retro DOS v3.0
 44956                                  	;LocalVar FCBTmp,16
 44957                                  	;ENTER
 44958 00007881 55                      	push	bp
 44959 00007882 89E5                    	mov	bp,sp
 44960                                  	;sub	sp,15	; MSDOS 3.3
 44961 00007884 83EC10                  	sub	sp,16	; MSDOS 6.0
 44962 00007887 16                      	push	ss
 44963 00007888 07                      	pop	es
 44964 00007889 06                      	push	es
 44965 0000788A 57                      	push	di
 44966                                  	;lea	di,[bp-15] ; MSDOS 3.3
 44967                                  	;LEA	DI,FCBTmp 
 44968 0000788B 8D7EF0                  	lea	di,[bp-16]		; point to FCB temp area
 44969 0000788E 36C606[6C05]00          	mov	byte [SS:EXTFCB],0	; no extended FCB found ;smr;SS Override
 44970 00007894 36C606[6D05]00          	mov	byte [SS:SATTRIB],0	; default search attributes;smr;SS Override
 44971 0000789A E84FA9                  	call	GetExtended             ; get FCB, extended or not
 44972                                  	; 06/12/2022
 44973 0000789D 740D                    	jz	short GetDrive		; not an extended FCB, get drive
 44974 0000789F 8A44FF                  	mov	AL,[SI-1]               ; get attributes
 44975 000078A2 36A2[6D05]              	mov	[SS:SATTRIB],AL		; store search attributes;smr;SS Override
 44976 000078A6 36C606[6C05]FF          	mov	byte [SS:EXTFCB],-1	; signal extended FCB  ;smr;SS Override
 44977                                  GetDrive:
 44978 000078AC AC                      	lodsb				; get drive byte
 44979 000078AD E862FF                  	call	GETTHISDRV
 44980 000078B0 722A                    	jc	short BadPack
 44981 000078B2 E86F03                  	call	TextFromDrive           ; convert 0-based drive to text
 44982                                  
 44983                                  ; Scan the source to see if there are any illegal chars
 44984                                  
 44985                                  	;mov	bx,CharType		; load lookup table
 44986 000078B5 B90B00                  	mov	cx,11
 44987 000078B8 56                      	push	si			; back over name, ext
 44988                                  FCBScan:
 44989 000078B9 AC                      	lodsb				; get a byte
 44990                                  	
 44991                                  	; 09/08/2018
 44992                                  	;;xlat	byte [es:bx]
 44993                                  	;es	xlat
 44994                                  
 44995                                  	; 22/05/2019 - Retro DOS v4.0	
 44996 000078BA E8B8E1                  	call	GetCharType		; get flags
 44997                                  
 44998                                  	;test	al,8	
 44999 000078BD A808                    	test	al,FFCB
 45000 000078BF 741B                    	jz	short BadPack
 45001                                  NextCh: 
 45002 000078C1 E2F6                    	loop	FCBScan
 45003 000078C3 5E                      	pop	si
 45004 000078C4 89FB                    	mov	bx,di
 45005 000078C6 E880AD                  	call	PackName                ; crunch the path
 45006 000078C9 5F                      	pop	di			; get original destination
 45007 000078CA 07                      	pop	es
 45008 000078CB 16                      	push	ss			; get DS addressability
 45009 000078CC 1F                      	pop	ds
 45010                                  	;lea	si,[bp-15] ; MSDOS 3.3
 45011                                  	;LEA	SI,FCBTmp		; point at new pathname
 45012 000078CD 8D76F0                  	lea	si,[bp-16]
 45013 000078D0 803F00                  	cmp	byte [bx],0
 45014 000078D3 7407                    	jz	short BadPack
 45015 000078D5 55                      	push	bp
 45016 000078D6 E80E00                  	call	TransPathSet            ; convert the path
 45017 000078D9 5D                      	pop	bp
 45018 000078DA 7303                    	jnc	short FCBRet		; bye with transPath error code
 45019                                  BadPack:
 45020 000078DC F9                      	STC
 45021                                  	;mov	al,3
 45022 000078DD B003                    	MOV     AL,error_path_not_found
 45023                                  FCBRet: 
 45024                                  	;LEAVE
 45025 000078DF 89EC                    	mov	sp,bp
 45026 000078E1 5D                      	pop	bp
 45027                                  TransPath_retn:
 45028 000078E2 C3                      	retn
 45029                                  
 45030                                  ; 12/07/2018 - Retro DOS v3.0
 45031                                  
 45032                                  ;BREAK <TransPath - copy a path, do string sub and put in current dir>
 45033                                  ;----------------------------------------------------------------------------
 45034                                  ;
 45035                                  ;   TransPath - copy a path from DS:SI to ES:DI, performing component string
 45036                                  ;       substitution, insertion of current directory and fixing . and ..
 45037                                  ;       entries. Perform splicing. Allow input string to match splice
 45038                                  ;       exactly.
 45039                                  ;
 45040                                  ;   TransPathSet - Same as above except No splicing is performed if input path
 45041                                  ;       matches splice.
 45042                                  ;
 45043                                  ;   TransPathNoSet - No splicing/local using is performed at all.
 45044                                  ;
 45045                                  ;   The following anomalous behaviour is required:
 45046                                  ;
 45047                                  ;       Drive letters on devices are ignored. (set up DummyCDS)
 45048                                  ;       Paths on devices are ignored. (truncate to 0-length)
 45049                                  ;       Raw net I/O sets ThisCDS => NULL.
 45050                                  ;       fSharing => dummyCDS and no subst/splice. Only canonicalize.
 45051                                  ;
 45052                                  ;   Other behaviour:
 45053                                  ;
 45054                                  ;       ThisCDS set up.
 45055                                  ;       FatRead done on local CDS.
 45056                                  ;       ValidateCDS done on local CDS.
 45057                                  ;
 45058                                  ;   Brief flowchart:
 45059                                  ;
 45060                                  ;       if fSharing then
 45061                                  ;           set up DummyCDS (ThisCDS)
 45062                                  ;           canonicalize (sets cMeta)
 45063                                  ;           splice
 45064                                  ;           fatRead
 45065                                  ;           return
 45066                                  ;       if \\ or d:\\ lead then
 45067                                  ;           set up null CDS (ThisCDS)
 45068                                  ;           canonicalize (sets cMeta)
 45069                                  ;           return
 45070                                  ;       if device then
 45071                                  ;           set up dummyCDS (ThisCDS)
 45072                                  ;           canonicalize (sets cMeta)
 45073                                  ;           return
 45074                                  ;       if file then
 45075                                  ;           getCDS (sets (ThisCDS) from name)
 45076                                  ;           validateCDS (may reset current dir)
 45077                                  ;           Copy current dir
 45078                                  ;           canonicalize (set cMeta)
 45079                                  ;           splice
 45080                                  ;           generate correct CDS (ThisCDS)
 45081                                  ;           if local then
 45082                                  ;               fatread
 45083                                  ;           return
 45084                                  ;
 45085                                  ;   Inputs:     DS:SI - point to ASCIZ string path
 45086                                  ;               DI - point to buffer in DOSDATA
 45087                                  ;   Outputs:    Carry Set - invalid path specification: too many .., bad
 45088                                  ;                   syntax, etc. or user FAILed to I 24.
 45089                                  ;               WFP_Start - points to beginning of buffer
 45090                                  ;               Curr_Dir_End - points to end of current dir in path
 45091                                  ;               DS - DOSDATA
 45092                                  ;   Registers modified: most
 45093                                  ;
 45094                                  ;----------------------------------------------------------------------------
 45095                                  
 45096                                  ; 22/05/2019
 45097                                  ; 13/05/2019 - Retro DOS v4.0
 45098                                  ; DOSCODE:AB99h (MSDOS 6.21, MSDOS.SYS)
 45099                                  
 45100                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 45101                                  ; DOSCODE:AB39h (MSDOS 5.0, MSDOS.SYS)
 45102                                  
 45103                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 45104                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0BE1Dh
 45105                                  
 45106                                  TransPath:
 45107 000078E3 30C0                    	XOR     AL,AL
 45108 000078E5 EB02                    	JMP     SHORT SetSplice
 45109                                  TransPathSet:
 45110 000078E7 B0FF                    	MOV     AL,-1
 45111                                  SetSplice:
 45112 000078E9 36A2[4C03]              	MOV	[SS:NoSetDir],AL	; NoSetDir = !fExact;	;smr;SS Override
 45113 000078ED B0FF                    	MOV     AL,-1
 45114                                  TransPathNoSet:
 45115 000078EF 36A2[7105]              	MOV	[SS:FSPLICE],AL		; fSplice = TRUE;	;smr;SS Override
 45116 000078F3 36C606[7A05]FF          	MOV	byte [ss:CMETA],-1      			;smr;SS Override
 45117 000078F9 36893E[B205]            	MOV     [SS:WFP_START],DI 				;smr;SS Override
 45118 000078FE 36C706[B605]FFFF        	MOV	word [SS:CURR_DIR_END],-1 ; crack from start	;smr;SS Override
 45119 00007905 16                      	push	ss
 45120 00007906 07                      	pop	es
 45121                                  	;lea	bp,[di+134]
 45122 00007907 8DAD8600                	LEA     BP,[DI+TEMPLEN]         ; end of buffer
 45123                                  ;
 45124                                  ; if this is through the server dos call, fsharing is set. We set up a
 45125                                  ; dummy cds and let the operation go.
 45126                                  ;
 45127                                  	;TEST	byte [SS:FSHARING],-1	; if no sharing		;smr;SS Override
 45128                                  	;JZ	short CheckUNC		; skip to UNC check
 45129                                  	; 13/03/2024 (PCDOS 7.1 IBMDOS.COM)
 45130                                  	;;;
 45131 0000790B 36803E[7205]00          	cmp	byte [ss:FSHARING],0
 45132 00007911 7435                    	jz	short CheckUNC
 45133                                  	;;;
 45134                                  ;
 45135                                  ; ES:DI point to buffer
 45136                                  ;
 45137 00007913 E8F802                  	CALL	DriveFromText           ; get drive and advance DS:SI
 45138 00007916 E8F9FE                  	call	GETTHISDRV              ; Set ThisCDS and convert to 0-based
 45139 00007919 722A                    	jc	short NoPath
 45140 0000791B E80603                  	CALL	TextFromDrive		; drop in new
 45141 0000791E 8D5D01                  	LEA	BX,[DI+1]               ; backup limit
 45142 00007921 E83401                  	CALL	Canonicalize            ; copy and canonicalize
 45143 00007924 72BC                    	jc	short TransPath_retn	; errors
 45144                                  ;
 45145                                  ; Perform splices for net guys.
 45146                                  ;
 45147 00007926 16                      	push	ss
 45148 00007927 1F                      	pop	ds
 45149 00007928 8B36[B205]              	MOV     SI,[WFP_START] 		; point to name
 45150 0000792C F606[7105]FF            	TEST	byte [FSPLICE],-1
 45151 00007931 7403                    	JZ	short NoServerSplice
 45152 00007933 E82D02                  	CALL    Splice
 45153                                  NoServerSplice:
 45154 00007936 16                      	push	ss
 45155 00007937 1F                      	pop	ds                      ; for FATREAD
 45156 00007938 C43E[A205]              	LES     DI,[THISCDS]		; for fatread
 45157 0000793C E8459F                  	call	ECritDisk
 45158 0000793F E8BFE8                  	call	FATREAD_CDS
 45159 00007942 E86C9F                  	call	LCritDisk
 45160                                  NoPath:
 45161                                  	;mov	al,3
 45162 00007945 B003                    	MOV     AL,error_path_not_found ; Set up for possible bad path error
 45163 00007947 C3                      	retn				; any errors are in Carry flag
 45164                                  
 45165                                  ; Let the network decide if the name is for a spooled device. It will map
 45166                                  ; the name if so.
 45167                                  
 45168                                  CheckUNC:
 45169 00007948 36C706[A205]FFFF        	MOV     WORD [SS:THISCDS],-1	; NULL thisCDS		;smr;SS Override
 45170                                  	;CallInstall NetSpoolCheck,MultNET,35
 45171 0000794F B82311                  	mov	ax,1123h
 45172 00007952 CD2F                    	int	2Fh	; Multiplex - NETWORK REDIRECTOR - QUALIFY REMOTE FILENAME
 45173                                  			; DS:SI -> ASCIZ filename to canonicalize
 45174                                  			; ES:DI -> 128-byte buffer for qualified name
 45175                                  			; Return: CF set if not resolved
 45176 00007954 7329                    	JNC	short UNCDone
 45177                                  
 45178                                  ; At this point the name is either a UNC-style name (prefixed with two leading
 45179                                  ; \\s) or is a local file/device. Remember that if a net-spooled device was
 45180                                  ; input, then the name has been changed to the remote spooler by the above net
 45181                                  ; call. Also, there may be a drive in front of the \\.
 45182                                  
 45183                                  NO_CHECK:
 45184 00007956 E8B502                  	CALL    DriveFromText		; eat drive letter
 45185 00007959 50                      	PUSH    AX                      ; save it
 45186 0000795A 8B04                    	MOV     AX,[SI]			; get first two bytes of path
 45187 0000795C E831E1                  	call    PATHCHRCMP              ; convert to normal form
 45188 0000795F 86C4                    	XCHG    AH,AL                   ; swap for second byte
 45189 00007961 E82CE1                  	call    PATHCHRCMP              ; convert to normal form
 45190 00007964 751F                    	JNZ	short CheckDevice	; not a path char
 45191 00007966 38C4                    	CMP     AH,AL                   ; are they same?
 45192 00007968 751B                    	JNZ	short CheckDevice	; nope
 45193                                  
 45194                                  ; We have a UNC request. We must copy the string up to the beginning of the
 45195                                  ; local machine root path
 45196                                  
 45197 0000796A 58                      	POP     AX
 45198 0000796B A5                      	MOVSW                           ; get the lead \\.
 45199                                  UNCCpy:
 45200 0000796C AC                      	LODSB                           ; get a byte
 45201 0000796D E8CDE0                   	call	UCase                   ;AN000;; convert the char
 45202 00007970 08C0                    	OR      AL,AL
 45203 00007972 740E                    	JZ	short UNCTerm		; end of string. All done.
 45204 00007974 E819E1                  	call    PATHCHRCMP              ; is it a path char?
 45205 00007977 89FB                    	MOV     BX,DI                   ; backup position
 45206 00007979 AA                      	STOSB
 45207 0000797A 75F0                    	JNZ	short UNCCpy		; no, go copy
 45208 0000797C E8D900                  	CALL    Canonicalize            ; wham (and set cMeta)
 45209                                  UNCDone:
 45210 0000797F 16                      	push	ss
 45211 00007980 1F                      	pop	ds
 45212 00007981 C3                       	retn				; return error code
 45213                                  UNCTerm:
 45214 00007982 AA                      	STOSB                           ;AN000;
 45215 00007983 EBFA                    	JMP	short UNCDone		;AN000;
 45216                                  
 45217                                  CheckDevice:
 45218                                  
 45219                                  ; Check DS:SI for device. First eat any path stuff
 45220                                  
 45221 00007985 58                      	POP     AX                      ; retrieve drive info
 45222 00007986 803C00                  	CMP     BYTE [SI],0		; check for null file
 45223 00007989 7504                    	JNZ	short CheckPath
 45224                                  	;mov	al,2 
 45225 0000798B B002                    	MOV     AL,error_file_not_found ; bad file error
 45226 0000798D F9                      	STC                             ; signal error on null input
 45227 0000798E C3                      	RETN				; bye!
 45228                                  CheckPath:
 45229 0000798F 50                      	push	ax
 45230 00007990 55                      	push	bp			; save drive number
 45231                                  
 45232                                  ; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 45233                                  %if 0
 45234                                  	; MSDOS 6.0
 45235                                  ;;;BUGBUG BUG 10-26-1992 scottq
 45236                                  ;;;This is a hack for the CDROM extensions (2.1) who scan looking
 45237                                  ;;;for the following POP BP == 5Dh (restore <bp,ax>).
 45238                                  ;;;The problem is that a direct call to CheckThisDevice can (and did)
 45239                                  ;;;end up having a 5D in the opcode's displacement field. The
 45240                                  ;;;scanning code would choke on this thinking it was a POP BP instruction.
 45241                                  ;;;
 45242                                  ;;;What we do here is do a call to a function that is less than 5Dh
 45243                                  ;;;bytes away (and assert its not exactly 5D away) that jmps (transfers)
 45244                                  ;;;to the correct function. This cannot accidently insert a 5Dh.
 45245                                  ;;;
 45246                                  ;;;More info:
 45247                                  ;;;  This particular scan is begun at the UNCdone label for 32 bytes
 45248                                  ;;;looking for pop BP, so you cannot put a 5D between here and there.
 45249                                  ;;;
 45250                                  	call	no5Dshere
 45251                                  start5Dhack:
 45252                                  ;following is replaced with 5Dhack code--Invoke CheckThisDevice
 45253                                  backfrom5Dhack:
 45254                                  
 45255                                  %endif
 45256                                  
 45257                                  ; 13/03/2024
 45258                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:BECBh
 45259                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:AC47h)
 45260                                  ; ((Windows ME IO.SYS - BIOSCODE:A6C2h))
 45261                                  %if 0
 45262                                  	call	no5Dshere
 45263                                  %else
 45264                                  ; 13/03/2024 - Retro DOS v5.0
 45265                                  
 45266                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 45267                                  	; Note: 'call no5Dshere' is not required for MSDOS 5.0 MSDOS.SYS
 45268 00007991 E8C0D3                  	call    CheckThisDevice	; E8h,6Fh,0D6h
 45269                                  %endif
 45270 00007994 5D                      	pop	bp
 45271 00007995 58                      	pop	ax			; get drive letter back
 45272 00007996 731C                    	JNC	short DoFile		; yes we have a file.
 45273                                  
 45274                                  ; We have a device. AX has drive letter. At this point we may fake a CDS ala
 45275                                  ; sharing DOS call. We know by getting here that we are NOT in a sharing DOS
 45276                                  ; call.
 45277                                  
 45278 00007998 36C606[7205]FF          	MOV	byte [SS:FSHARING],-1	; simulate sharing dos call;smr;SS Override
 45279 0000799E E871FE                  	call	GETTHISDRV              ; set ThisCDS and init DUMMYCDS
 45280 000079A1 36C606[7205]00          	MOV     byte [SS:FSHARING],0	;                       ;smr;SS Override
 45281                                  
 45282                                  ; Now that we have noted that we have a device, we put it into a form that
 45283                                  ; getpath can understand. Normally getpath requires d:\ to begin the input
 45284                                  ; string. We relax this to state that if the d:\ is present then the path
 45285                                  ; may be a file. If D:/ (note the forward slash) is present then we have
 45286                                  ; a device.
 45287                                  
 45288 000079A7 E87A02                  	CALL    TextFromDrive
 45289 000079AA B02F                    	MOV     AL,'/'                  ; path sep.
 45290 000079AC AA                      	STOSB
 45291 000079AD E8DE9D                  	call	StrCpy			; move remainder of string
 45292                                  
 45293 000079B0 F8                      	CLC                             ; everything OK.
 45294 000079B1 16                      	push	ss
 45295 000079B2 1F                      	pop	ds                      ; remainder of OK stuff
 45296                                  DoFile_retn:
 45297 000079B3 C3                      	retn
 45298                                  
 45299                                  ; 13/03/2024 - Retro DOS v5.0
 45300                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:BEEEh
 45301                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:AC6Ah)
 45302                                  ; ((Windows ME IO.SYS - BIOSCODE:A6F2h))
 45303                                  ;%if 1
 45304                                  
 45305                                  ; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 45306                                  %if 0
 45307                                  
 45308                                  no5Dshere:
 45309                                  	; 10/08/2018
 45310                                  	jmp	CheckThisDevice		; snoop for device
 45311                                  %endif
 45312                                  
 45313                                  ;.erre (no5Dshere - start5Dhack - 5D)
 45314                                  
 45315                                  ; We have a file. Get the raw CDS.
 45316                                  
 45317                                  DoFile:
 45318                                  	; MSDOS 3.3 (& MSDOS 6.0)
 45319                                  
 45320 000079B4 E83FFE                  	call	GetVisDrv               ; get proper CDS
 45321                                  	;mov	al,3 
 45322 000079B7 B003                    	MOV     AL,error_path_not_found ; Set up for possible bad file error
 45323 000079B9 72F8                    	jc	short DoFile_retn  ; CARRY set -> bogus drive/spliced
 45324                                  
 45325                                  ; ThisCDS has correct CDS. DS:SI advanced to point to beginning of path/file.
 45326                                  ; Make sure that CDS has valid directory; ValidateCDS requires a temp buffer
 45327                                  ; Use the one that we are going to use (ES:DI).
 45328                                  
 45329                                  	;SAVE    <DS,SI,ES,DI>		; save all string pointers.
 45330 000079BB 1E                      	push	ds
 45331 000079BC 56                      	push	si
 45332 000079BD 06                      	push	es
 45333 000079BE 57                      	push	di
 45334 000079BF E8C5D2                  	call	ValidateCDS             ; poke CDS and make everything OK
 45335                                  	;RESTORE <DI,ES,SI,DS>		; get back pointers
 45336 000079C2 5F                      	pop	di
 45337 000079C3 07                      	pop	es
 45338 000079C4 5E                      	pop	si
 45339 000079C5 1F                      	pop	ds
 45340                                  	;mov	al,3
 45341 000079C6 B003                    	MOV     AL,error_path_not_found ; Set up for possible bad path error
 45342                                  	;retc				; someone failed an operation
 45343 000079C8 72E9                    	jc	short DoFile_retn
 45344                                  
 45345                                  ; ThisCDS points to correct CDS. It contains the correct text of the
 45346                                  ; current directory. Copy it in.
 45347                                  
 45348 000079CA 1E                      	push	ds
 45349 000079CB 56                      	push	si
 45350 000079CC 36C536[A205]            	LDS     SI,[SS:THISCDS]		; point to CDS	;smr;SS Override
 45351 000079D1 89FB                    	MOV     BX,DI                   ; point to destination
 45352                                  	;add	bx,[si+79] ; MSDOS 6.0
 45353 000079D3 035C4F                  	ADD     BX,[SI+curdir.end]	; point to backup limit
 45354                                  	;lea	bp,[di+134]
 45355 000079D6 8DAD8600                	LEA     BP,[DI+TEMPLEN]         ; regenerate end of buffer
 45356                                  					;AN000;
 45357 000079DA E8C09D                  	call	FStrCpy                 ; copy string. ES:DI point to end
 45358 000079DD 4F                      	DEC     DI                      ; point to NUL byte
 45359                                  
 45360                                  ; Make sure that there is a path char at end.
 45361                                  
 45362 000079DE B05C                    	MOV     AL,'\'
 45363 000079E0 263845FF                	CMP     [ES:DI-1],AL
 45364 000079E4 7401                    	JZ	short GetOrig
 45365 000079E6 AA                      	STOSB
 45366                                  
 45367                                  ; Now get original string.
 45368                                  
 45369                                  GetOrig:
 45370 000079E7 4F                      	DEC     DI                      ; point to path char
 45371 000079E8 5E                      	pop	si
 45372 000079E9 1F                      	pop	ds
 45373                                  
 45374                                  ; BX points to the end of the root part of the CDS (at where a path char
 45375                                  ; should be). Now, we decide whether we use this root or extend it with the
 45376                                  ; current directory. See if the input string begins with a leading 
 45378 000079EA E8CE00                  	CALL    PathSep                 ; is DS:SI a path sep?
 45379 000079ED 7511                    	JNZ	short PathAssure	; no, DI is correct. Assure a path char
 45380 000079EF 08C0                    	OR      AL,AL                   ; end of string?
 45381 000079F1 7410                    	JZ	short DoCanon		; yes, skip.
 45382                                  ;
 45383                                  ; The string does begin with a \. Reset the beginning of the canonicalization
 45384                                  ; to this root. Make sure that there is a path char there and advance the
 45385                                  ; source string over all leading \'s.
 45386                                  ;
 45387 000079F3 89DF                    	MOV     DI,BX                   ; back up to root point.
 45388                                  SkipPath:
 45389 000079F5 AC                      	LODSB
 45390 000079F6 E897E0                  	call    PATHCHRCMP
 45391 000079F9 74FA                    	JZ	short SkipPath
 45392 000079FB 4E                      	DEC     SI
 45393 000079FC 08C0                    	OR      AL,AL
 45394 000079FE 7403                    	JZ	short DoCanon
 45395                                  
 45396                                  ; DS:SI start at some file name. ES:DI points at some path char. Drop one in
 45397                                  ; for yucks.
 45398                                  
 45399                                  PathAssure:
 45400 00007A00 B05C                    	MOV     AL,'\'	; 5Ch
 45401 00007A02 AA                      	STOSB
 45402                                  
 45403                                  ; ES:DI point to the correct spot for canonicalization to begin.
 45404                                  ; BP is the max extent to advance DI
 45405                                  ; BX is the backup limit for ..
 45406                                  
 45407                                  DoCanon:
 45408 00007A03 E85200                  	CALL    Canonicalize            ; wham.
 45409                                  	;retc				; badly formatted path.
 45410 00007A06 72AB                    	jc	short DoFile_retn
 45411                                  
 45412                                  ; The string has been moved to ES:DI. Reset world to DOS context, pointers
 45413                                  ; to wfp_start and do string substitution. BP is still the max position in
 45414                                  ; buffer.
 45415                                  
 45416 00007A08 16                      	push	ss
 45417 00007A09 1F                      	pop	ds
 45418 00007A0A 8B3E[B205]              	MOV     DI,[WFP_START]		; DS:SI point to string
 45419 00007A0E C536[A205]              	LDS     SI,[THISCDS]		; point to CDS
 45420 00007A12 E81702                  	CALL    PathPref                ; is there a prefix?
 45421 00007A15 7514                    	JNZ	short DoSplice		; no, do splice
 45422                                  
 45423                                  ; We have a match. Check to see if we ended in a path char.
 45424                                  
 45425 00007A17 8A44FF                  	MOV     AL,[SI-1]		; last char to match
 45426 00007A1A E873E0                  	call    PATHCHRCMP              ; did we end on a path char? (root)
 45427 00007A1D 740C                    	JZ	short DoSplice		; yes, no current dir here.
 45428                                  Pathline:                               ; 2/13/KK
 45429 00007A1F 26803D00                	CMP     BYTE [ES:DI],0		; end at NUL?
 45430 00007A23 7406                    	JZ	short DoSplice
 45431 00007A25 47                      	INC     DI                      ; point to after current path char
 45432 00007A26 36893E[B605]            	MOV     [SS:CURR_DIR_END],DI	; point to correct spot ;smr;SS Override
 45433                                  
 45434                                  ; Splice the result.
 45435                                  
 45436                                  DoSplice:
 45437 00007A2B 16                      	push	ss
 45438 00007A2C 1F                      	pop	ds			; back to DOSDATA
 45439 00007A2D 8B36[B205]              	MOV     SI,[WFP_START]		; point to beginning of string
 45440 00007A31 31C9                    	XOR     CX,CX
 45441 00007A33 F606[7105]FF            	TEST	byte [FSPLICE],-1
 45442 00007A38 7403                    	JZ	short SkipSplice
 45443 00007A3A E82601                  	CALL    Splice                  ; replaces in place.
 45444                                  SkipSplice:
 45445                                  
 45446                                  ; The final thing is to assure ourselves that a FATREAD is done on the local
 45447                                  ; device.
 45448                                  
 45449 00007A3D 16                      	push	ss
 45450 00007A3E 1F                      	pop	ds
 45451 00007A3F C43E[A205]              	LES     DI,[THISCDS]		; point to correct drive
 45452                                  	;test	word [es:di+67],8000h
 45453                                  	; 17/12/2022
 45454                                  	;test	byte [es:di+68],80h
 45455 00007A43 26F6454480              	test	byte [ES:DI+curdir.flags+1],curdir_isnet>>8 ; 04/12/2022
 45456                                  	;TEST	word [ES:DI+curdir.flags],curdir_isnet ; 8000h
 45457 00007A48 750D                    	JNZ	short Done		; net, no fatread necessary (retnz)
 45458 00007A4A E30B                    	JCXZ    Done
 45459 00007A4C E8359E                  	call	ECritDisk
 45460 00007A4F E8AFE7                  	call	FATREAD_CDS
 45461 00007A52 E85C9E                  	call	LCritDisk
 45462                                  	;mov	al, 3
 45463 00007A55 B003                    	MOV     AL,error_path_not_found ; Set up for possible bad path error
 45464                                  Done:   
 45465 00007A57 C3                      	retn                         ; any errors in carry flag.
 45466                                  
 45467                                  ; 13/07/2018
 45468                                  
 45469                                  ;BREAK <Canonicalize - copy a path and remove . and .. entries>
 45470                                  ;----------------------------------------------------------------------------
 45471                                  ;   Canonicalize - copy path removing . and .. entries.
 45472                                  ;
 45473                                  ;   Inputs:     DS:SI - point to ASCIZ string path
 45474                                  ;               ES:DI - point to buffer
 45475                                  ;               BX - backup limit (offset from ES) points to slash
 45476                                  ;               BP - end of buffer
 45477                                  ;   Outputs:    Carry Set - invalid path specification: too many .., bad
 45478                                  ;                   syntax, etc.
 45479                                  ;               Carry Clear -
 45480                                  ;                   DS:DI - advanced to end of string
 45481                                  ;                   ES:DI - advanced to end of canonicalized form after nul
 45482                                  ;   Registers modified: AX CX DX (in addition to those above)
 45483                                  ;----------------------------------------------------------------------------
 45484                                  
 45485                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 45486                                  
 45487                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 45488                                  
 45489                                  Canonicalize:
 45490                                  
 45491                                  ; We copy all leading path separators.
 45492                                  
 45493 00007A58 AC                      	LODSB                           ;   while (PathChr (*s))
 45494 00007A59 E834E0                  	call    PATHCHRCMP
 45495 00007A5C 7507                    	JNZ	short CanonDec
 45496 00007A5E 39EF                    	CMP     DI,BP                   ;       if (d > dlim)
 45497 00007A60 7319                    	JAE	short CanonBad		;           goto error;
 45498 00007A62 AA                      	STOSB
 45499 00007A63 EBF3                    	JMP	short Canonicalize	;           *d++ = *s++;
 45500                                  CanonDec:
 45501 00007A65 4E                      	DEC     SI
 45502                                  
 45503                                  ; Main canonicalization loop. We come here with DS:SI pointing to a textual
 45504                                  ; component (no leading path separators) and ES:DI being the destination
 45505                                  ; buffer.
 45506                                  
 45507                                  CanonLoop:
 45508                                  
 45509                                  ; If we are at the end of the source string, then we need to check to see that
 45510                                  ; a potential drive specifier is correctly terminated with a path sep char.
 45511                                  ; Otherwise, do nothing
 45512                                  
 45513 00007A66 31C0                    	XOR     AX,AX
 45514 00007A68 3804                    	CMP     [SI],AL                 ;       if (*s == 0) {
 45515 00007A6A 751A                    	JNZ	short DoComponent
 45516 00007A6C 26807DFF3A              	CMP     BYTE [ES:DI-1],':'	;           if (d[-1] == ':')
 45517 00007A71 7505                    	JNZ	short DoTerminate
 45518 00007A73 B05C                    	MOV     AL,'\'                  ;               *d++ = '\';
 45519 00007A75 AA                      	STOSB
 45520 00007A76 88E0                    	MOV     AL,AH
 45521                                  DoTerminate:
 45522 00007A78 AA                      	STOSB                           ;           *d++ = 0;
 45523 00007A79 F8                      	CLC                             ;           return (0);
 45524 00007A7A C3                      	retn
 45525                                  
 45526                                  CanonBad:
 45527 00007A7B E8C701                  	CALL	ScanPathChar            ; check for path chars in rest of string
 45528                                  	;mov	al,3
 45529 00007A7E B003                    	MOV     AL,error_path_not_found ; Set up for bad path error
 45530 00007A80 7402                    	JZ	short PathEnc		; path character encountered in string
 45531                                  	;mov	al,2
 45532 00007A82 B002                    	MOV     AL,error_file_not_found ; Set bad file error
 45533                                  PathEnc:
 45534 00007A84 F9                      	STC
 45535                                  CanonBad_retn:
 45536 00007A85 C3                      	retn
 45537                                  
 45538                                  ; We have a textual component that we must copy. We uppercase it and truncate
 45539                                  ; it to 8.3
 45540                                  
 45541                                  DoComponent:                            ;           }
 45542 00007A86 E84C00                  	CALL    CopyComponent		;       if (!CopyComponent (s, d))
 45543 00007A89 72FA                    	jc	short CanonBad_retn	;           return (-1);
 45544                                  
 45545                                  ; We special case the . and .. cases. These will be backed up.
 45546                                  
 45547                                  	;CMP	WORD PTR ES:[DI],'.' + (0 SHL 8)
 45548 00007A8B 26833D2E                	CMP	WORD [ES:DI],002Eh
 45549 00007A8F 7408                    	JZ	short Skip1
 45550                                  	;CMP	WORD PTR ES:[DI],'..'
 45551 00007A91 26813D2E2E              	CMP     WORD [ES:DI],2E2Eh
 45552 00007A96 7508                    	JNZ	short CanonNormal
 45553 00007A98 4F                      	DEC     DI                      ;           d--;
 45554                                  Skip1:  
 45555 00007A99 E82800                  	CALL    SkipBack                ;           SkipBack ();
 45556                                  	;;mov	al,3
 45557                                  	; 07/07/2024 (*)
 45558                                  	;MOV    AL,error_path_not_found ; Set up for possible bad path error
 45559 00007A9C 72E7                    	jc	short CanonBad_retn ; AL=3 (*)
 45560 00007A9E EB02                    	JMP     short CanonPath         ;           }
 45561                                  
 45562                                  ; We have a normal path. Advance destination pointer over it.
 45563                                  
 45564                                  CanonNormal:                            ;       else
 45565 00007AA0 01CF                    	ADD     DI,CX                   ;           d += ct;
 45566                                  
 45567                                  ; We have successfully copied a component. We are now pointing at a path
 45568                                  ; sep char or are pointing at a nul or are pointing at something else.
 45569                                  ; If we point at something else, then we have an error.
 45570                                  
 45571                                  CanonPath:
 45572 00007AA2 E81600                  	CALL    PathSep
 45573 00007AA5 75D4                    	JNZ	short CanonBad		; something else...
 45574                                  
 45575                                  ; Copy the first path char we see.
 45576                                  
 45577 00007AA7 AC                      	LODSB                           ; get the char
 45578 00007AA8 E8E5DF                  	call    PATHCHRCMP              ; is it path char?
 45579 00007AAB 75B8                    	JNZ	short CanonDec		; no, go test for nul
 45580 00007AAD 39EF                    	CMP     DI,BP                   ; beyond buffer end?
 45581 00007AAF 73CA                    	JAE	short CanonBad		; yep, error.
 45582 00007AB1 AA                      	STOSB                           ; copy the one byte
 45583                                  
 45584                                  ; Skip all remaining path chars
 45585                                  
 45586                                  CanonPathLoop:
 45587 00007AB2 AC                      	LODSB                           ; get next byte
 45588 00007AB3 E8DADF                  	call    PATHCHRCMP              ; path char again?
 45589 00007AB6 74FA                    	JZ	short CanonPathLoop	; yep, grab another
 45590 00007AB8 4E                      	DEC     SI                      ; back up
 45591 00007AB9 EBAB                    	JMP	short  CanonLoop	; go copy component
 45592                                  
 45593                                  ;BREAK <PathSep - determine if char is a path separator>
 45594                                  ;----------------------------------------------------------------------------
 45595                                  ;   PathSep - look at DS:SI and see if char is / \ or NUL
 45596                                  ;   Inputs:     DS:SI - point to a char
 45597                                  ;   Outputs:    AL has char from DS:SI (/ => \)
 45598                                  ;               Zero set if AL is / \ or NUL
 45599                                  ;               Zero reset otherwise
 45600                                  ;   Registers modified: AL
 45601                                  ;----------------------------------------------------------------------------
 45602                                  
 45603                                  PathSep:
 45604 00007ABB 8A04                    	MOV     AL,[SI]                 ; get the character
 45605                                  PathSepGotCh:				; already have character
 45606 00007ABD 08C0                    	OR      AL,AL                   ; test for zero
 45607 00007ABF 74C4                    	jz	short CanonBad_retn	; return if equal to zero (NUL)
 45608                                  	;call	PATHCHRCMP              ; check for path character
 45609                                  	;retn				; and return HIS determination
 45610                                  	; 18/12/2022
 45611 00007AC1 E9CCDF                  	jmp	PATHCHRCMP
 45612                                  
 45613                                  
 45614                                  ;BREAK <SkipBack - move backwards to a path separator>
 45615                                  ;----------------------------------------------------------------------------
 45616                                  ;   SkipBack - look at ES:DI and backup until it points to a / ;   Inputs:     ES:DI - point to a char
 45618                                  ;               BX has current directory back up limit (point to a / \)
 45619                                  ;   Outputs:    ES:DI backed up to point to a path char
 45620                                  ;               AL has char from output ES:DI (path sep if carry clear)
 45621                                  ;               Carry set if illegal backup
 45622                                  ;               Carry Clear if ok
 45623                                  ;   Registers modified: DI,AL
 45624                                  ;----------------------------------------------------------------------------
 45625                                  
 45626                                  SkipBack:
 45627 00007AC4 39DF                    	CMP     DI,BX                   ;   while (TRUE) {
 45628 00007AC6 720A                    	JB	short SkipBad		;       if (d < dlim)
 45629 00007AC8 4F                      	DEC     DI                      ;           goto err;
 45630 00007AC9 268A05                  	MOV     AL,[ES:DI]		;       if (pathchr (*--d))
 45631 00007ACC E8C1DF                  	call    PATHCHRCMP              ;           break;
 45632 00007ACF 75F3                    	JNZ	short SkipBack		;       }
 45633                                  	;CLC				;   return (0);
 45634                                  	; 01/07/2024
 45635                                  	; cf=0
 45636 00007AD1 C3                      	retn				;
 45637                                  SkipBad:                                ;err:
 45638                                  	;mov	al,3
 45639 00007AD2 B003                    	MOV     AL,error_path_not_found ; bad path error
 45640                                  	;STC				;   return (-1);
 45641                                  	; 01/07/2024
 45642                                  	; cf=1
 45643 00007AD4 C3                      	retn				;
 45644                                  
 45645                                  ;Break <CopyComponent - copy out a file path component>
 45646                                  ;----------------------------------------------------------------------------
 45647                                  ;   CopyComponent - copy a file component from a path string (DS:SI) into ES:DI
 45648                                  ;
 45649                                  ;   Inputs:     DS:SI - source path
 45650                                  ;               ES:DI - destination
 45651                                  ;               ES:BP - end of buffer
 45652                                  ;   Outputs:    Carry Set - too long
 45653                                  ;               Carry Clear - DS:SI moved past component
 45654                                  ;                   CX has length of destination
 45655                                  ;   Registers modified: AX,CX,DX
 45656                                  ;----------------------------------------------------------------------------
 45657                                  
 45658                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 45659                                  
 45660                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 45661                                  
 45662                                  CopyComponent:
 45663                                  
 45664                                  %define CopyBP	 [BP]		; word
 45665                                  %define CopyD	 [BP+2]		; dword
 45666                                  %define CopyDoff [BP+2]		; word
 45667                                  %define CopyS	 [BP+6]		; dword
 45668                                  %define CopySoff [BP+6]		; word
 45669                                  %define CopyTemp [BP+10]	; byte
 45670                                  
 45671 00007AD5 83EC0E                  	SUB     SP,14                   ; room for temp buffer
 45672 00007AD8 1E                      	push	ds
 45673 00007AD9 56                      	push	si
 45674 00007ADA 06                      	push	es
 45675 00007ADB 57                      	push	di
 45676 00007ADC 55                      	push	bp
 45677 00007ADD 89E5                    	MOV     BP,SP
 45678 00007ADF B42E                    	MOV     AH,'.'
 45679 00007AE1 AC                      	LODSB
 45680 00007AE2 AA                      	STOSB
 45681 00007AE3 38E0                    	CMP     AL,AH                   ;   if ((*d++=*s++) == '.') {
 45682 00007AE5 7518                    	JNZ	short NormalComp
 45683 00007AE7 E8D1FF                  	CALL    PathSep                 ;       if (!pathsep(*s))
 45684 00007AEA 740B                    	JZ	short NulTerm
 45685                                  TryTwoDot:
 45686 00007AEC AC                      	LODSB                           ;           if ((*d++=*s++) != '.'
 45687 00007AED AA                      	STOSB
 45688 00007AEE 38E0                    	CMP     AL,AH
 45689 00007AF0 7557                    	JNZ	short CopyBad
 45690 00007AF2 E8C6FF                  	CALL    PathSep
 45691 00007AF5 7552                    	JNZ	short CopyBad		;               || !pathsep (*s))
 45692                                  NulTerm:                                ;               return -1;
 45693 00007AF7 30C0                    	XOR     AL,AL                   ;       *d++ = 0;
 45694 00007AF9 AA                      	STOSB
 45695 00007AFA 897606                  	MOV     CopySoff,SI
 45696 00007AFD EB47                    	JMP     SHORT _GoodRet		;       }
 45697                                  NormalComp:                             ;   else {
 45698 00007AFF 8B7606                  	MOV     SI,CopySoff ; [bp+6]
 45699 00007B02 E8CFDE                  	call	NameTrans               ;       s = NameTrans (s, Name1);
 45700 00007B05 3B7606                  	CMP     SI,CopySoff             ;       if (s == CopySOff)
 45701 00007B08 743F                    	JZ	short CopyBad		;           return (-1);
 45702 00007B0A 36F606[7205]FF          	TEST	byte [SS:FSHARING],-1	;       if (!fSharing) {;smr;SS Override
 45703 00007B10 7510                    	JNZ	short DoPack
 45704 00007B12 80E201                  	AND     DL,1                    ;           cMeta += fMeta;
 45705 00007B15 360016[7A05]            	ADD	[ss:CMETA],DL		;           if (cMeta > 0);smr;SS Override
 45706 00007B1A 7F2D                    	JG	short CopyBad		;               return (-1);
 45707 00007B1C 7504                    	JNZ	short DoPack		;           else
 45708 00007B1E 08D2                    	OR      DL,DL                   ;           if (cMeta == 0 && fMeta == 0)
 45709 00007B20 742F                    	JZ	short CopyBadPath	;               return (-1);
 45710                                  DoPack:                                 ;           }
 45711 00007B22 897606                  	MOV     CopySoff,SI ; [bp+6]
 45712 00007B25 16                      	push	ss
 45713 00007B26 1F                      	pop	ds
 45714 00007B27 BE[4B05]                	MOV     SI,NAME1
 45715 00007B2A 8D7E0A                  	LEA     DI,CopyTemp ; [bp+10]
 45716 00007B2D 57                      	push	di
 45717 00007B2E E818AB                  	call	PackName                ;       PackName (Name1, temp);
 45718 00007B31 5F                      	pop	di
 45719 00007B32 E8719C                  	call	StrLen                  ;       if (strlen(temp)+d > bp)
 45720 00007B35 49                      	DEC     CX
 45721 00007B36 034E02                  	ADD     CX,CopyDoff ; [bp+2]
 45722                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 45723                                  	;cmp	cx,[bp+0]
 45724                                  	; 15/12/2022
 45725                                  	;cmp	cx,[bp]
 45726 00007B39 3B4E00                  	CMP	CX,CopyBP   ; [bp+0]
 45727 00007B3C 730B                    	JAE	short CopyBad		;           return (-1);
 45728 00007B3E 89FE                    	MOV     SI,DI                   ;       strcpy (d, temp);
 45729 00007B40 C47E02                  	LES     DI,CopyD    ; [bp+2]
 45730 00007B43 E8579C                  	call	FStrCpy
 45731                                  _GoodRet:				;       }
 45732 00007B46 F8                      	CLC
 45733 00007B47 EB0B                    	JMP     SHORT CopyEnd           ;   return 0;
 45734                                  CopyBad:
 45735 00007B49 F9                      	STC
 45736 00007B4A E8F800                  	CALL    ScanPathChar            ; check for path chars in rest of string
 45737                                  	;mov	al,2
 45738 00007B4D B002                    	MOV     AL,error_file_not_found ; Set up for bad file error
 45739 00007B4F 7503                    	JNZ	short CopyEnd
 45740                                  CopyBadPath:
 45741 00007B51 F9                      	STC
 45742                                  	;mov	al,3
 45743 00007B52 B003                    	MOV     AL,error_path_not_found ; Set bad path error
 45744                                  CopyEnd:
 45745 00007B54 5D                      	pop	bp
 45746 00007B55 5F                      	pop	di
 45747 00007B56 07                      	pop	es
 45748 00007B57 5E                      	pop	si
 45749 00007B58 1F                      	pop	ds
 45750 00007B59 9F                      	LAHF
 45751 00007B5A 83C40E                  	ADD     SP,14                   ; reclaim temp buffer
 45752 00007B5D E8469C                  	call	StrLen
 45753 00007B60 49                      	DEC     CX
 45754 00007B61 9E                      	SAHF
 45755 00007B62 C3                      	retn
 45756                                  
 45757                                  ; 14/05/2019 - Retro DOS v4.0
 45758                                  ; DOSCODE:AE22h (MSDOS 6.21, MSDOS.SYS)
 45759                                  
 45760                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 45761                                  ; DOSCODE:ADBFh (MSDOS 5.0, MSDOS.SYS)
 45762                                  
 45763                                  ;Break <Splice - pseudo mount by string substitution>
 45764                                  ;----------------------------------------------------------------------------
 45765                                  ;   Splice - take a string and substitute a prefix if one exists. Change
 45766                                  ;       ThisCDS to point to physical drive CDS.
 45767                                  ;   Inputs:     DS:SI point to string
 45768                                  ;               NoSetDir = TRUE => exact matches with splice fail
 45769                                  ;   Outputs:    DS:SI points to thisCDS
 45770                                  ;               ES:DI points to DPB
 45771                                  ;               String at DS:SI may be reduced in length by removing prefix
 45772                                  ;               and substituting drive letter.
 45773                                  ;               CX = 0 If no splice done
 45774                                  ;               CX <> 0 otherwise
 45775                                  ;               ThisCDS points to proper CDS if spliced, otherwise it is
 45776                                  ;                   left alone
 45777                                  ;               ThisDPB points to proper DPB
 45778                                  ;   Registers modified: DS:SI, ES:DI, BX,AX,CX
 45779                                  ;----------------------------------------------------------------------------
 45780                                  
 45781                                  	; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 45782                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0C0A6h
 45783                                  
 45784                                  Splice:
 45785 00007B63 36F606[5A00]FF          	TEST	byte [SS:SPLICES],-1	;smr;SS Override
 45786 00007B69 7469                    	JZ	short AllDone
 45787 00007B6B 36FF36[A205]            	push	word [SS:THISCDS]
 45788 00007B70 36FF36[A405]            	push	word [SS:THISCDS+2]	; TmpCDS = ThisCDS;smr;SS Override
 45789 00007B75 1E                      	push	ds
 45790 00007B76 56                      	push	si
 45791 00007B77 5F                      	pop	di
 45792 00007B78 07                      	pop	es
 45793 00007B79 31C0                    	XOR     AX,AX                   ;   for (i=1; s = GetCDSFromDrv (i); i++)
 45794                                  SpliceScan:
 45795 00007B7B E8E3FC                  	call	GetCDSFromDrv
 45796 00007B7E 724A                    	JC	short SpliceDone
 45797 00007B80 FEC0                    	INC     AL
 45798                                  	; 17/12/2022
 45799                                  	;test	byte [si+68],20h
 45800 00007B82 F6444420                	test	byte [si+curdir.flags+1],curdir_splice>>8 ; 04/12/2022
 45801                                  	;;test	word [si+67],2000h
 45802                                  	;TEST	word [SI+curdir.flags],curdir_splice
 45803 00007B86 74F3                    	JZ	short SpliceScan 	;       if ( Spliced (i) ) {
 45804 00007B88 57                      	push	di
 45805 00007B89 E8A000                  	CALL    PathPref                ;           if (!PathPref (s, d))
 45806 00007B8C 7403                    	JZ	short SpliceFound	;
 45807                                  SpliceSkip:
 45808 00007B8E 5F                      	pop	di
 45809 00007B8F EBEA                    	JMP	short SpliceScan	;               continue;
 45810                                  SpliceFound:
 45811 00007B91 26803D00                	CMP     BYTE [ES:DI],0		;           if (*s || NoSetDir) {
 45812 00007B95 7508                    	JNZ	short SpliceDo
 45813 00007B97 36F606[4C03]FF          	TEST	byte [ss:NoSetDir],-1			;smr;SS Override
 45814 00007B9D 75EF                    	JNZ	short SpliceSkip
 45815                                  SpliceDo:
 45816 00007B9F 89FE                    	MOV     SI,DI                   ;               p = src + strlen (p);
 45817 00007BA1 06                      	push	es
 45818 00007BA2 1F                      	pop	ds
 45819 00007BA3 5F                      	pop	di
 45820 00007BA4 E87F00                  	CALL	TextFromDrive1          ;               src = TextFromDrive1(src,i);
 45821 00007BA7 36A1[B605]              	MOV     AX,[SS:CURR_DIR_END]			;smr;SS Override
 45822 00007BAB 09C0                    	OR      AX,AX
 45823 00007BAD 7808                    	JS	short NoPoke
 45824 00007BAF 01F8                    	ADD     AX,DI                   ;               curdirend += src-p;
 45825 00007BB1 29F0                    	SUB     AX,SI
 45826 00007BB3 36A3[B605]              	MOV     [SS:CURR_DIR_END],AX			;smr;SS Override
 45827                                  NoPoke:
 45828 00007BB7 803C00                  	CMP     BYTE [SI],0		;               if (*p)
 45829 00007BBA 7503                    	JNZ	short SpliceCopy	;                   *src++ = '\\';
 45830 00007BBC B05C                    	MOV     AL,"\"
 45831 00007BBE AA                      	STOSB
 45832                                  SpliceCopy:                             ;               strcpy (src, p);
 45833 00007BBF E8DB9B                  	call	FStrCpy
 45834 00007BC2 83C404                  	ADD     SP,4                    ; throw away saved stuff
 45835 00007BC5 80C901                  	OR      CL,1                    ; signal splice done.
 45836 00007BC8 EB0C                    	JMP     SHORT DoSet             ;               return;
 45837                                  SpliceDone:                             ;               }
 45838 00007BCA 368F06[A405]            	pop	word [SS:THISCDS+2]     ;   ThisCDS = TmpCDS;
 45839 00007BCF 368F06[A205]            	pop	word [SS:THISCDS]			;smr;SS Override
 45840                                  AllDone:
 45841 00007BD4 31C9                    	XOR     CX,CX
 45842                                  DoSet:
 45843 00007BD6 36C536[A205]            	LDS     SI,[SS:THISCDS]		;   ThisDPB = ThisCDS->devptr;;smr;SS Override
 45844                                  	;les	di,[si+69]
 45845 00007BDB C47C45                  	LES     DI,[SI+curdir.devptr]
 45846 00007BDE 36893E[8A05]            	MOV	[SS:THISDPB],DI				;smr;SS Override
 45847 00007BE3 368C06[8C05]            	MOV	[SS:THISDPB+2],ES			;smr;SS Override
 45848                                  Splice_retn:
 45849 00007BE8 C3                      	retn
 45850                                  
 45851                                  ; 15/05/2019 - Retro DOS v4.0
 45852                                  ; DOSCODE:AEA9h (MSDOS 6.21, MSDOS.SYS)
 45853                                  
 45854                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 45855                                  ; DOSCODE:AE46h (MSDOS 5.0, MSDOS.SYS)
 45856                                  
 45857                                  ; 13/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 45858                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0C12Dh
 45859                                  
 45860                                  ;Break <$NameTrans - partially process a name>
 45861                                  ;----------------------------------------------------------------------------
 45862                                  ;   $NameTrans - allow users to see what names get mapped to. This call
 45863                                  ;   performs only string substitution and canonicalization, not splicing.  Due
 45864                                  ;   to Transpath playing games with devices, we need to insure that the output
 45865                                  ;   has drive letter and : in it.
 45866                                  ;
 45867                                  ;   Inputs:     DS:SI - source string for translation
 45868                                  ;               ES:DI - pointer to buffer
 45869                                  ;   Outputs:
 45870                                  ;       Carry Clear
 45871                                  ;               Buffer at ES:DI is filled in with data
 45872                                  ;               ES:DI point byte after nul byte at end of dest string in buffer
 45873                                  ;       Carry Set
 45874                                  ;               AX = error_path_not_found
 45875                                  ;   Registers modified: all
 45876                                  ;----------------------------------------------------------------------------
 45877                                  
 45878                                  _$NameTrans:
 45879 00007BE9 1E                      	push	ds
 45880 00007BEA 56                      	push	si
 45881 00007BEB 06                      	push	es
 45882 00007BEC 57                      	push	di
 45883 00007BED 51                      	push	cx ; MSDOS 6.0
 45884                                  	
 45885                                  	; MSDOS 6.0
 45886                                  ; M027 - Start
 45887                                  ;
 45888                                  ; Sattrib must be set up with default values here. Otherwise, the value from
 45889                                  ; a previous DOS call is used for attrib and DevName thinks it is not a 
 45890                                  ; device if the old call set the volume attribute bit. Note that devname in
 45891                                  ; dir2.asm gets ultimately called by Transpath. See also M026. Also save
 45892                                  ; and restore CX.
 45893                                  
 45894                                  	;mov	ch,16h
 45895 00007BEE B516                    	mov     ch,attr_hidden+attr_system+attr_directory
 45896 00007BF0 E8EE02                  	call	SetAttrib
 45897                                  
 45898                                  ; M027 - End
 45899                                  
 45900                                  	; MSDOS 3.3 (& MSDOS 6.0)
 45901 00007BF3 BF[BE03]                	MOV     DI,OPENBUF
 45902 00007BF6 E8EAFC                  	CALL    TransPath               ; to translation (everything)
 45903 00007BF9 59                      	pop	cx ; MSDOS 6.0
 45904 00007BFA 5F                      	pop     di
 45905 00007BFB 07                      	pop	es
 45906 00007BFC 5E                      	pop     si
 45907 00007BFD 1F                      	pop     ds
 45908 00007BFE 7303                    	JNC	short TransOK
 45909 00007C00 E9728A                  	jmp	SYS_RET_ERR
 45910                                  TransOK:
 45911 00007C03 BE[BE03]                	MOV     SI,OPENBUF
 45912 00007C06 16                      	push	ss
 45913 00007C07 1F                      	pop	ds
 45914                                  ;GotText:
 45915 00007C08 E8929B                  	call	FStrCpy
 45916 00007C0B E95D8A                  	jmp	SYS_RET_OK
 45917                                  
 45918                                  ;Break   <DriveFromText - return drive number from a text string>
 45919                                  ;----------------------------------------------------------------------------
 45920                                  ;   DriveFromText - examine DS:SI and remove a drive letter, advancing the
 45921                                  ;   pointer.
 45922                                  ;
 45923                                  ;   Inputs:     DS:SI point to a text string
 45924                                  ;   Outputs:    AL has drive number
 45925                                  ;               DS:SI advanced
 45926                                  ;   Registers modified: AX,SI.
 45927                                  ;----------------------------------------------------------------------------
 45928                                  
 45929                                  DriveFromText:
 45930 00007C0E 30C0                    	XOR	AL,AL                   ;       drive = 0;
 45931                                  	;CMP	BYTE [SI],0		;       if (*s &&
 45932                                  	; 23/09/2023
 45933 00007C10 3804                    	cmp	[si],al ; 0
 45934 00007C12 74D4                    	jz	short Splice_retn
 45935 00007C14 807C013A                	CMP	BYTE [SI+1],':'		;           s[1] == ':') {
 45936 00007C18 75CE                    	jnz	short Splice_retn
 45937 00007C1A AD                      	LODSW                           ;           drive = (*s | 020) - 'a'+1;
 45938 00007C1B 0C20                    	OR	AL,20h	; (convert to lowercase)
 45939                                  	;sub	al,60h
 45940 00007C1D 2C60                    	SUB	AL,'a'-1                ;           s += 2;
 45941 00007C1F 75C7                    	jnz	short Splice_retn
 45942 00007C21 B0FF                    	MOV	AL,-1                   ; nuke AL...
 45943                                  	; 23/09/2023
 45944                                  	;dec	al ; -1
 45945 00007C23 C3                      	retn				;           }
 45946                                  
 45947                                  ;Break   <TextFromDrive - convert a drive number to a text string>
 45948                                  ;----------------------------------------------------------------------------
 45949                                  ;   TextFromDrive - turn AL into a drive letter: and put it at es:di with
 45950                                  ;   trailing :. TextFromDrive1 takes a 1-based number.
 45951                                  ;
 45952                                  ;   Inputs:     AL has 0-based drive number
 45953                                  ;   Outputs:    ES:DI advanced
 45954                                  ;   Registers modified: AX
 45955                                  ;----------------------------------------------------------------------------
 45956                                  
 45957                                  TextFromDrive:
 45958 00007C24 FEC0                    	INC	AL
 45959                                  TextFromDrive1:
 45960                                  	;add	al,40h
 45961 00007C26 0440                    	ADD	AL,'A'-1                ;   *d++ = drive-1+'A';
 45962 00007C28 B43A                    	MOV	AH,":"	; 3Ah           ;   strcat (d, ":");
 45963 00007C2A AB                      	STOSW
 45964                                  PathPref_retn:
 45965 00007C2B C3                      	retn
 45966                                  
 45967                                  ;Break   <PathPref - see if one path is a prefix of another>
 45968                                  ;----------------------------------------------------------------------------
 45969                                  ;   PathPref - compare DS:SI with ES:DI to see if one is the prefix of the
 45970                                  ;   other.  Remember that only at a pathchar break are we allowed to have a
 45971                                  ;   prefix: A:\ and A:\FOO
 45972                                  ;
 45973                                  ;   Inputs:     DS:SI potential prefix
 45974                                  ;               ES:DI string
 45975                                  ;   Outputs:    Zero set => prefix found
 45976                                  ;                   DI/SI advanced past matching part
 45977                                  ;               Zero reset => no prefix, DS/SI garbage
 45978                                  ;   Registers modified: CX
 45979                                  ;----------------------------------------------------------------------------
 45980                                  
 45981                                  PathPref:
 45982 00007C2C E8859B                  	call	DStrLen                 ; get length
 45983 00007C2F 49                      	DEC     CX                      ; do not include nul byte
 45984 00007C30 F3A6                    	REPZ    CMPSB                   ; compare
 45985 00007C32 75F7                    	jnz	short PathPref_retn	; if NZ then return NZ
 45986 00007C34 50                      	push	ax			; save char register
 45987 00007C35 8A44FF                  	MOV     AL,[SI-1]               ; get last byte to match
 45988 00007C38 E855DE                  	call    PATHCHRCMP              ; is it a path char (Root!)
 45989 00007C3B 7406                    	JZ	short Prefix		; yes, match root (I hope)
 45990                                  NotSep:                                 ; 2/13/KK
 45991 00007C3D 268A05                  	MOV     AL,[ES:DI]		; get next char to match
 45992 00007C40 E87AFE                  	CALL    PathSepGotCh            ; was it a pathchar?
 45993                                  Prefix:
 45994 00007C43 58                      	pop	ax			; get back original
 45995 00007C44 C3                      	retn
 45996                                  
 45997                                  ;Break   <ScanPathChar - see if there is a path character in a string>
 45998                                  ;----------------------------------------------------------------------------
 45999                                  ;     ScanPathChar - search through the string (pointed to by DS:SI) for
 46000                                  ;     a path separator.
 46001                                  ;
 46002                                  ;     Input:    DS:SI target string (null terminated)
 46003                                  ;     Output:   Zero set => path separator encountered in string
 46004                                  ;               Zero clear => null encountered
 46005                                  ;     Registers modified: SI
 46006                                  ;----------------------------------------------------------------------------
 46007                                  
 46008                                  ScanPathChar:
 46009 00007C45 AC                      	LODSB                           ; fetch a character
 46010 00007C46 E874FE                  	call    PathSepGotCh
 46011 00007C49 75FA                    	JNZ	short ScanPathChar	; not \, / or NUL => go back for more
 46012                                  	;call	PATHCHRCMP              ; path separator?
 46013                                  	;retn
 46014                                  	; 18/12/2022
 46015 00007C4B E942DE                  	jmp	PATHCHRCMP
 46016                                  
 46017                                  ;============================================================================
 46018                                  ; FILE.ASM, MSDOS 6.0, 1991
 46019                                  ;============================================================================
 46020                                  ; 14/07/2018 - Retro DOS v3.0
 46021                                  
 46022                                  ; 13/05/2019 - Retro DOS v4.0
 46023                                  ; DOSCODE:AF10h (MSDOS 6.21, MSDOS.SYS)
 46024                                  
 46025                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46026                                  ; DOSCODE:AEADh (MSDOS 5.0, MSDOS.SYS)
 46027                                  
 46028                                  ; 14/03/2024 - Retro DOS v5.0
 46029                                  
 46030                                  ; MSDOS 2.11
 46031                                  ;BREAK <$Open - open a file handle>
 46032                                  ;----------------------------------------------------------------------------
 46033                                  ;   Assembler usage:
 46034                                  ;           LDS     DX, Name
 46035                                  ;           MOV     AH, Open
 46036                                  ;           MOV     AL, access
 46037                                  ;           INT     int_command
 46038                                  ;
 46039                                  ;       ACCESS          Function
 46040                                  ;       ------          --------
 46041                                  ;       open_for_read   file is opened for reading
 46042                                  ;       open_for_write  file is opened for writing
 46043                                  ;       open_for_both   file is opened for both reading and writing.
 46044                                  ;
 46045                                  ;   Error returns:
 46046                                  ;           AX = error_invalid_access
 46047                                  ;              = error_file_not_found
 46048                                  ;              = error_access_denied
 46049                                  ;              = error_too_many_open_files
 46050                                  ;----------------------------------------------------------------------------
 46051                                  
 46052                                  ; MSDOS 6.0
 46053                                  ;	BREAK <$Open - open a file from a path string>
 46054                                  ;----------------------------------------------------------------------------
 46055                                  ;
 46056                                  ;**	$OPen - Open a File
 46057                                  ;
 46058                                  ;	given a path name in DS:DX and an open mode in AL, $Open opens the
 46059                                  ;	file and and returns a handle
 46060                                  ;
 46061                                  ;	ENTRY	(DS:DX) = pointer to asciz name
 46062                                  ;		(AL) = open mode
 46063                                  ;	EXIT	'C' clear if OK
 46064                                  ;		  (ax) = file handle
 46065                                  ;		'C' set if error
 46066                                  ;		  (ax) = error code
 46067                                  ;	USES	all
 46068                                  ;
 46069                                  ;----------------------------------------------------------------------------
 46070                                  
 46071                                  ; 13/05/2019 - Retro DOS v4.0
 46072                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46073                                  
 46074                                  ; 14/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 46075                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0C194h
 46076                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0AF10h)
 46077                                  ; (Windows ME IO.SYS - BIOSCODE:0A9A7h)
 46078                                  
 46079                                  _$OPEN:       
 46080 00007C4E 30E4                    	xor	ah,ah  ; MSDOS 6.0	
 46081                                  _$Open2:
 46082                                  	;mov	ch,16h
 46083 00007C50 B516                    	mov	ch,attr_hidden+attr_system+attr_directory
 46084 00007C52 E88C02                  	call	SetAttrib
 46085 00007C55 B9[2B31]                	mov	cx,DOS_OPEN
 46086                                  
 46087                                  	;xor	ah,ah  ; MSDOS 3.3
 46088                                  
 46089 00007C58 50                      	push	ax
 46090                                  
 46091                                  ;*	General file open/create code. The $CREATE call and the various
 46092                                  ;	$OPEN calls all come here.
 46093                                  ;
 46094                                  ;	We'll share a lot of the standard stuff of allocating SFTs, cracking
 46095                                  ;	path names, etc., and then dispatch to our individual handlers.
 46096                                  ;	WARNING - this info and list is just a guess, not definitive - jgl
 46097                                  ;
 46098                                  ;	(TOS) = create mode
 46099                                  ;	(CX) = address of routine to call to do actual function
 46100                                  ;	(DS:DX) = ASCIZ name
 46101                                  ;	SAttrib = Attribute mask
 46102                                  
 46103                                  ;	Get a free SFT and mark it "being allocated"
 46104                                  
 46105                                  AccessFile:
 46106 00007C59 E8289C                  	call	ECritSFT
 46107 00007C5C E84CF7                  	call	SFNFree			; get a free sfn
 46108 00007C5F E84F9C                  	call	LCritSFT
 46109                                  	;jc	short OpenFailJ		; oops, no free sft's
 46110                                  	; 14/03/2024
 46111 00007C62 7248                    	jc	short OpenFail
 46112                                  
 46113 00007C64 36891E[AA05]            	MOV	[SS:SFN],BX		; save the SFN for later;smr;SS Override
 46114 00007C69 36893E[9E05]            	MOV	[SS:THISSFT],DI		; save the SF offset	;smr;SS Override
 46115 00007C6E 368C06[A005]            	MOV	[SS:THISSFT+2],ES	; save the SF segment	;smr;SS Override
 46116                                  
 46117                                  ;	Find a free area in the user's JFN table.
 46118                                  
 46119 00007C73 E822F7                  	call	JFNFree			; get a free jfn
 46120                                  	;jnc	short SaveJFN
 46121                                  	; 14/03/2024
 46122 00007C76 7234                    	jc	short OpenFail
 46123                                  	;
 46124                                  ;OpenFailJ:
 46125                                  	;JMP	OpenFail		; there were free JFNs... try SFN
 46126                                  
 46127                                  SaveJFN:
 46128 00007C78 36893E[AE05]            	mov	[ss:PJFN],DI		; save the jfn offset	;smr;SS Override
 46129 00007C7D 368C06[B005]            	MOV	[ss:PJFN+2],ES		; save the jfn segment	;smr;SS Override
 46130 00007C82 36891E[AC05]            	MOV	[ss:JFN],BX		; save the jfn itself	;smr;SS Override
 46131                                  
 46132                                  ;	We have been given an JFN. We lock it down to prevent other tasks from
 46133                                  ;	reusing the same JFN.
 46134                                  
 46135 00007C87 368B1E[AA05]            	MOV	BX,[ss:SFN]					;smr;SS Override
 46136 00007C8C 26881D                  	MOV	[ES:DI],BL		; assign the JFN
 46137 00007C8F 89D6                    	MOV	SI,DX			; get name in appropriate place
 46138 00007C91 BF[BE03]                	MOV	DI,OPENBUF		; appropriate buffer
 46139 00007C94 51                      	push	cx			; save routine to call
 46140 00007C95 E84BFC                  	call	TransPath		; convert the path
 46141 00007C98 5B                      	pop	bx			; (bx) = routine to call
 46142                                  
 46143 00007C99 36C536[9E05]            	LDS	SI,[SS:THISSFT]					;smr;SS Override
 46144                                  	;JC	short OpenCleanJ	; no error, go and open file
 46145                                  	; 14/03/2024
 46146 00007C9E 7260                    	jc	short OpenClean
 46147                                  
 46148 00007CA0 36803E[7A05]FF          	CMP	byte [ss:CMETA],-1				;smr;SS Override
 46149 00007CA6 7408                    	JZ	short SetSearch
 46150                                  	;mov	al,2
 46151 00007CA8 B002                    	MOV	AL,error_file_not_found ; no meta chars allowed
 46152                                  OpenCleanJ:
 46153 00007CAA EB54                    	JMP	short OpenClean
 46154                                  
 46155                                  	; 14/03/2024 (PCDOS 7.1 IBMDOS.COM)
 46156                                  	;;;
 46157                                  OpenFail:
 46158 00007CAC FB                      	STI
 46159 00007CAD 59                      	pop	cx			; Clean stack
 46160                                  	;
 46161 00007CAE EB5D                    	jmp	short OpenCritLeave
 46162                                  	;;;
 46163                                  
 46164                                  SetSearch:
 46165 00007CB0 58                      	pop	ax			; Mode (Open), Attributes (Create)
 46166                                  
 46167                                  ;	We need to get the new inheritance bits.
 46168                                  
 46169 00007CB1 31C9                    	xor	cx,cx
 46170                                  	; MSDOS 6.0
 46171                                  	;mov	[si+2],cx ; 0
 46172 00007CB3 894C02                  	MOV	[SI+SF_ENTRY.sf_mode],cx ; initialize mode field to 0
 46173                                  	;mov    [si+51],cx ; 0
 46174 00007CB6 894C33                  	MOV	[SI+SF_ENTRY.sf_MFT],cx	 ; clean out sharing info
 46175                                  	;
 46176 00007CB9 81FB[2B31]              	CMP	BX,DOS_OPEN
 46177 00007CBD 7509                    	JNZ	short _DoOper
 46178                                  	;test   al,80h
 46179 00007CBF A880                    	test	AL,SHARING_NO_INHERIT	; look for no inher
 46180 00007CC1 7405                    	JZ	short _DoOper ; 10/08/2018
 46181 00007CC3 247F                    	AND	AL,7Fh			; mask off inherit bit
 46182                                  	;mov	cx,1000h
 46183 00007CC5 B90010                  	MOV	CX,sf_no_inherit
 46184                                  _DoOper:
 46185                                  	;; MSDOS 3.3
 46186                                  	;;mov	word [si+2], 0
 46187                                  	;;mov	word [si+33h], 0
 46188                                  	;MOV	word [SI+SF_ENTRY.sf_mode],0
 46189                                  	;MOV	word [SI+SF_ENTRY.sf_MFT],0
 46190                                  
 46191                                  	; MSDOS 6.0
 46192                                  ;**	Check if this is an extended open. If so you must set the
 46193                                  ;	modes in sf_mode. Call Set_EXT_mode to do all this. See
 46194                                  ;	Set_EXT_mode in creat.asm
 46195                                  
 46196                                  	; MSDOS 6.0
 46197                                  	;SAVE	<di, es>                ;M022 conditional removed here
 46198 00007CC8 57                      	push	di
 46199 00007CC9 06                      	push	es
 46200 00007CCA 1E                      	push	ds
 46201 00007CCB 07                      	pop	es
 46202 00007CCC 56                      	push	si
 46203 00007CCD 5F                      	pop	di			; (es:di) = SFT address
 46204 00007CCE E846B4                  	call	Set_EXT_mode
 46205                                  	;RESTORE <es, di>
 46206 00007CD1 07                      	pop	es
 46207 00007CD2 5F                      	pop	di
 46208                                  
 46209                                  	;Context DS
 46210 00007CD3 16                      	push	ss
 46211 00007CD4 1F                      	pop	ds	
 46212                                  
 46213 00007CD5 51                      	push	cx
 46214 00007CD6 FFD3                    	CALL	BX			; blam!
 46215 00007CD8 59                      	pop	cx
 46216 00007CD9 C536[9E05]              	LDS	SI,[THISSFT]
 46217 00007CDD 7240                    	JC	short OpenE2		;AN000;FT. chek extended open hooks first
 46218                                  	;jc	short OpenE ; MSDOS 3.3
 46219                                  
 46220                                  ;	The SFT was successfully opened. Remove busy mark.
 46221                                  
 46222                                  OpenOK:
 46223                                  	;MOV	word [SI+SF_ENTRY.sf_ref_count],1
 46224 00007CDF C7040100                	mov	word [SI],1
 46225                                  	;or	[SI+5],cx
 46226 00007CE3 094C05                  	OR	[SI+SF_ENTRY.sf_flags],CX ; set no inherit bit if necessary
 46227                                  
 46228                                  ; If the open mode is 70, we scan the system for other SFT's with the same
 46229                                  ; contents. If we find one, then we can 'collapse' thissft onto the already
 46230                                  ; opened one. Otherwise we use this new one. We compare uid/pid/mode/mft
 46231                                  ;
 46232                                  ; Since this is only relevant on sharer systems, we stick this code into the
 46233                                  ; sharer.
 46234                                  
 46235                                  	; 01/07/2024
 46236                                  	;;;
 46237 00007CE6 1E                      	push	ds
 46238 00007CE7 07                      	pop	es
 46239 00007CE8 89F7                    	mov	di,si
 46240 00007CEA E8DCCB                  	call	set_sftfcb_entry	; set SFT-FCB entry
 46241                                  				 	; in the internal (SFT_FCB) table
 46242                                  				 	; (used for FCB calls only!)
 46243                                  	;;;
 46244                                  	
 46245 00007CED 36A1[AC05]              	MOV	AX,[ss:JFN]				;smr;SS Override
 46246 00007CF1 36FF1E[C000]            	Call	far [ss:JShare+(12*4)]	; 12 = ShCol	;smr;SS Override
 46247                                  
 46248 00007CF6 36C706[AA05]FFFF        	MOV	word [ss:SFN],-1	; clear out sfn pointer	;smr;SS Override
 46249                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 46250                                  OpenOkj:
 46251 00007CFD E96B89                  	jmp	SYS_RET_OK		; bye with no errors
 46252                                  
 46253                                  ;	Extended Open hooks check
 46254                                  ;
 46255                                  ;	AL has error code. Stack has argument to dos_open/dos_create.
 46256                                  
 46257                                  OpenClean:
 46258 00007D00 5B                      	pop	bx			; clean off stack
 46259                                  OpenE:
 46260                                  	;MOV	word [SI+SF_ENTRY.sf_ref_count],0 ; release SFT
 46261 00007D01 C7040000                	mov	word [SI],0
 46262 00007D05 36C536[AE05]            	LDS	SI,[ss:PJFN]		;smr;SS Override
 46263 00007D0A C604FF                  	MOV	BYTE [SI],0FFh		; free the SFN...
 46264                                  
 46265                                  	; 14/03/2024
 46266                                  	;JMP	SHORT OpenCritLeave
 46267                                  	;
 46268                                  ;OpenFail:
 46269                                  	;STI
 46270                                  	;pop	cx			; Clean stack
 46271                                  
 46272                                  OpenCritLeave:
 46273 00007D0D 36C706[AA05]FFFF        	MOV	word [SS:SFN],-1	; remove mark.
 46274                                  
 46275                                  	; MSDOS 6.0
 46276                                  ; File Tagging DOS 4.00
 46277 00007D14 36833E[2403]25          	CMP	word [SS:EXTERR],error_Code_Page_Mismatched
 46278                                  					;AN000;;FT. code page mismatch
 46279 00007D1A 7538                    	JNZ	short NORERR	  	;AN000;;FT. no
 46280 00007D1C E95E89                  	jmp	From_GetSet		;AN000;;FT. yes
 46281                                  
 46282                                  ; 14/03/2024
 46283                                  	; MSDOS 6.0
 46284                                  ;Extended Open hooks check
 46285                                  OpenE2:					;AN000;;EO.
 46286 00007D1F 83F857                  	CMP	AX,error_invalid_parameter ;AN000;;EO. IFS extended open ?
 46287 00007D22 75DD                    	JNZ	short OpenE		;AN000;;EO. no.
 46288 00007D24 EBE7                    	JMP	short OpenCritLeave	;AN000;;EO. keep handle
 46289                                  
 46290                                  ; 15/03/2024
 46291                                  %if 0
 46292                                  NORERR: 				;AN000;
 46293                                  ; File Tagging DOS 4.00
 46294                                  
 46295                                  	jmp	SYS_RET_ERR		; no free, return error
 46296                                  %endif
 46297                                  
 46298                                  ; MSDOS 2.11
 46299                                  ;BREAK <$CREAT - create a new file and open him for input>
 46300                                  ;----------------------------------------------------------------------------
 46301                                  ;   Assembler usage:
 46302                                  ;           LDS     DX, name
 46303                                  ;           MOV     AH, Creat
 46304                                  ;           MOV     CX, access
 46305                                  ;           INT     21h
 46306                                  ;       ; AX now has the handle
 46307                                  ;
 46308                                  ;   Error returns:
 46309                                  ;           AX = error_access_denied
 46310                                  ;              = error_path_not_found
 46311                                  ;              = error_too_many_open_files
 46312                                  ;----------------------------------------------------------------------------
 46313                                  
 46314                                  ; MSDOS 6.0
 46315                                  ;	BREAK <$Creat - create a brand-new file>
 46316                                  ;----------------------------------------------------------------------------
 46317                                  ;
 46318                                  ;**	$Creat - Create a File
 46319                                  ;
 46320                                  ;	$Creat creates the directory entry specified in DS:DX and gives it the
 46321                                  ;	initial attributes contained in CX
 46322                                  ;
 46323                                  ;	ENTRY	(DS:DX) = ASCIZ path name
 46324                                  ;		(CX) = initial attributes
 46325                                  ;	EXIT	'C' set if error
 46326                                  ;		  (ax) = error code
 46327                                  ;		'C' clear if OK
 46328                                  ;		  (ax) = file handle
 46329                                  ;	USES	all
 46330                                  ;
 46331                                  ;----------------------------------------------------------------------------
 46332                                  
 46333                                  _$CREAT:
 46334 00007D26 51                      	push	cx			; Save attributes on stack
 46335 00007D27 B9[FD2F]                	mov	CX,DOS_CREATE		; routine to call
 46336                                  AccessSet:
 46337                                  	;mov	byte [ss:SATTRIB],6
 46338 00007D2A 36C606[6D05]06          	mov	byte [ss:SATTRIB],attr_hidden+attr_system ;smr;SS Override
 46339                                  	; 10/08/2018
 46340 00007D30 E926FF                  	JMP	AccessFile		; use good ol' open
 46341                                  
 46342                                  
 46343                                  ; MSDOS 6.0 (MSDOS 3.3)
 46344                                  ;	BREAK <$CHMOD - change file attributes>
 46345                                  ;----------------------------------------------------------------------------
 46346                                  ;
 46347                                  ;**	$CHMOD - Change File Attributes
 46348                                  ;
 46349                                  ;   Assembler usage:
 46350                                  ;	    LDS     DX, name
 46351                                  ;	    MOV     CX, attributes
 46352                                  ;	    MOV     AL,func (0=get, 1=set)
 46353                                  ;	    INT     21h
 46354                                  ;   Error returns:
 46355                                  ;	    AX = error_path_not_found
 46356                                  ;	    AX = error_access_denied
 46357                                  ;
 46358                                  ;----------------------------------------------------------------------------
 46359                                  
 46360                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46361                                  
 46362                                  	; 14/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 46363                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0C27Ch
 46364                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0AFF4h)
 46365                                  	; (Windows ME IO.SYS - BIOSCODE:0AAB2h)
 46366                                  
 46367                                  _$CHMOD:
 46368                                  	; 14/03/2024 (PCDOS 7.1 IBMDOS.COM)
 46369                                  	;;;
 46370 00007D33 3CFF                    	cmp	al,0FFh		; MS-DOS 7.20 (Win98) - EXTENDED-LENGTH FILENAME OPERATIONS
 46371                                  				; AX = 43FFh
 46372                                  				; BP = 5053h ('PS')
 46373                                  				; CL = function
 46374                                  				; 39h "mkdir" create directory
 46375                                  				; DS:DX -> ASCIZ pathname
 46376                                  				; 56h rename file
 46377                                  				; DS:DX -> ASCIZ filename of existing file (no wildcards)
 46378                                  				; ES:DI -> ASCIZ new filename (no wildcards)
 46379                                  				;
 46380                                  				; ref: Ralf Brown's Interrupt List
 46381 00007D35 7520                    	jnz	short std_chmod
 46382 00007D37 81FD5350                	cmp	bp,5053h
 46383 00007D3B 7515                    	jnz	short chmod_x_2
 46384 00007D3D 88CC                    	mov	ah,cl
 46385                                  	;mov	word [ss:PATHNAMELEN],128
 46386 00007D3F 36C606[1011]80          	mov	byte [ss:PATHNAMELEN],128 ; Retro DOS v5.0
 46387 00007D45 80F939                  	cmp	cl,39h
 46388 00007D48 7503                    	jne	short chmod_x_1
 46389 00007D4A E977AA                  	jmp	mkdir_x
 46390                                  chmod_x_1:
 46391 00007D4D 80F956                  	cmp	cl,56h
 46392 00007D50 7472                    	je	short rename_x
 46393                                  chmod_x_2:
 46394 00007D52 B001                    	mov	al,1
 46395                                  	;jmp	short NORERR
 46396                                  	; 15/03/2024
 46397                                  NORERR: 
 46398 00007D54 E91E89                  	jmp	SYS_RET_ERR
 46399                                  
 46400                                  std_chmod:
 46401                                  	;;;
 46402                                  
 46403                                  	; 05/08/2018 - Retro DOS v3.0
 46404                                  	; IBMDOS.COM (MSDOS 3.3, 1987) - Offset 6FCCh
 46405 00007D57 BF[BE03]                	MOV	DI,OPENBUF		; appropriate buffer
 46406 00007D5A 50                      	push	ax
 46407 00007D5B 51                      	push	cx			; save function and attributes
 46408 00007D5C 89D6                    	MOV	SI,DX			; get things in appropriate places
 46409 00007D5E E886FB                  	call	TransPathSet		; get correct path
 46410 00007D61 59                      	pop	cx
 46411 00007D62 58                      	pop	ax			; and get function and attrs back
 46412 00007D63 7255                    	JC	short ChModErr		; errors get mapped to path not found
 46413 00007D65 16                      	push	ss			; set up for later possible calls
 46414 00007D66 1F                      	pop	ds
 46415 00007D67 803E[7A05]FF            	CMP	byte [CMETA],-1
 46416 00007D6C 754C                    	JNZ	short ChModErr
 46417                                  	;mov	byte [SATTRIB],16h
 46418 00007D6E C606[6D05]16            	MOV	byte [SATTRIB],attr_hidden+attr_system+attr_directory
 46419 00007D73 2C01                    	SUB	AL,1			; fast way to discriminate
 46420 00007D75 7209                    	JB	short ChModGet		; 0 -> go get value
 46421 00007D77 7415                    	JZ	short ChModSet		; 1 -> go set value
 46422                                  
 46423                                  ; 14/04/2024
 46424                                  %if 0
 46425                                  	;mov	byte [EXTERR_LOCUS],1
 46426                                  	MOV	byte [EXTERR_LOCUS],errLOC_Unk ; Extended Error Locus
 46427                                  %else
 46428                                  	; 14/03/2024 (PCDOS 7.1 IBMDOS.COM)
 46429                                  	;;;
 46430 00007D79 E83E95                  	call	set_exerr_locus_unk	; Extended Error Locus
 46431                                  	;;;
 46432                                  %endif
 46433                                  	;mov	al,1
 46434 00007D7C B001                    	mov	al,error_invalid_function ; bad value
 46435                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 46436                                  chmod_errj:	
 46437                                  	;;jmp	SYS_RET_ERR
 46438                                  	;jmp	short ChModE	
 46439 00007D7E EBD4                    	jmp	short NORERR	; 06/12/2022
 46440                                  ChModGet:
 46441 00007D80 E892B1                  	call	GET_FILE_INFO		; suck out the ol' info
 46442 00007D83 7237                    	JC	short ChModE		; error codes are already set for ret
 46443 00007D85 E8EF86                  	call	Get_User_Stack		; point to user saved vaiables
 46444                                  	;mov	[SI+4],ax
 46445 00007D88 894404                  	MOV	[SI+user_env.user_CX],AX ; return the attributes
 46446                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility
 46447                                  OpenOkj2:
 46448                                  	; 17/12/2022
 46449                                  	;;jmp	SYS_RET_OK		; say sayonara
 46450                                  	;jmp	short OpenOkj
 46451                                  	; 25/06/2019
 46452 00007D8B E9E088                  	jmp	SYS_RET_OK_clc
 46453                                  
 46454                                  ChModSet:
 46455 00007D8E 89C8                    	MOV	AX,CX			; get attrs in position
 46456 00007D90 E8E0B1                  	call	SET_FILE_ATTRIBUTE	; go set
 46457 00007D93 7227                    	JC	short ChModE		; errors are set
 46458                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility
 46459                                  	;jmp	SYS_RET_OK
 46460                                  OpenOkj3:
 46461                                  	;jmp	short OpenOkj2
 46462                                  	; 17/12/2022
 46463 00007D95 E9D388                  	jmp	SYS_RET_OK
 46464                                  
 46465                                  ; 17/12/2022
 46466                                  %if 0
 46467                                  ChModErr:
 46468                                  NotFound:	; 17/12/2022
 46469                                  	;mov	al,3
 46470                                  	mov	al,error_path_not_found
 46471                                  ChModE:
 46472                                  UnlinkE:	; 17/12/2022
 46473                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 46474                                  	;;jmp	SYS_RET_ERR
 46475                                  	;jmp	short chmod_errj
 46476                                  	; 17/12/2022
 46477                                  	jmp	short NORERR
 46478                                  %endif
 46479                                  
 46480                                  ; 22/05/2019 - Retro DOS v4.0
 46481                                  ; DOSCODE:B039h (MSDOS 6.21, MSDOS.SYS)
 46482                                  
 46483                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46484                                  ; DOSCODE:AFD6h (MSDOS 5.0, MSDOS.SYS)
 46485                                  
 46486                                  ;	BREAK <$UNLINK - delete a file entry>
 46487                                  ;----------------------------------------------------------------------------
 46488                                  ;
 46489                                  ;**	$UNLINK - Delete a File
 46490                                  ;
 46491                                  ;
 46492                                  ;	Assembler usage:
 46493                                  ;	    LDS     DX, name
 46494                                  ;	    IF VIA SERVER DOS CALL
 46495                                  ;	     MOV     CX,SEARCH_ATTRIB
 46496                                  ;	    MOV     AH, Unlink
 46497                                  ;	    INT     21h
 46498                                  ;
 46499                                  ;	ENTRY	(ds:dx) = path name
 46500                                  ;		(cx) = search_attribute, if via server_dos
 46501                                  ;	EXIT	'C' clear if no error
 46502                                  ;		'C' set if error
 46503                                  ;		  (ax) = error code
 46504                                  ;			= error_file_not_found
 46505                                  ;			= error_access_denied
 46506                                  ;
 46507                                  ;----------------------------------------------------------------------------
 46508                                  
 46509                                  	; 15/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 46510                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0C2E4h
 46511                                  
 46512                                  _$UNLINK:
 46513 00007D98 51                      	push	cx			; Save possible CX input parm
 46514 00007D99 89D6                    	MOV	SI,DX			; Point at input string
 46515 00007D9B BF[BE03]                	MOV	DI,OPENBUF		; temp spot for path
 46516 00007D9E E846FB                  	call	TransPathSet		; go get normalized path
 46517 00007DA1 59                      	pop	cx
 46518 00007DA2 7216                    	JC	short ChModErr		; badly formed path
 46519 00007DA4 36803E[7A05]FF          	CMP	byte [ss:CMETA],-1	; meta chars?	;smr;SS Override
 46520 00007DAA 750E                    	JNZ	short NotFound
 46521 00007DAC 16                      	push	ss
 46522 00007DAD 1F                      	pop	ds
 46523                                  	;mov	ch,6
 46524 00007DAE B506                    	mov	ch,attr_hidden+attr_system ; unlink appropriate files
 46525 00007DB0 E82E01                  	call	SetAttrib
 46526 00007DB3 E850AD                  	call	DOS_DELETE		; remove that file
 46527                                  	;JC	short UnlinkE 		; error is there
 46528                                  	; 17/12/2022
 46529 00007DB6 729C                    	jc	short NORERR
 46530                                  
 46531                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 46532                                  UnlinkOk:
 46533                                  	;jmp	SYS_RET_OK		; okey doksy
 46534 00007DB8 EBDB                    	jmp	short OpenOkj3
 46535                                  
 46536                                  	; 17/12/2022
 46537                                  ChModErr:	; 17/12/2022
 46538                                  NotFound:
 46539                                  	;mov	al,3
 46540 00007DBA B003                    	MOV	AL,error_path_not_found
 46541                                  ChModE:		; 17/12/2022
 46542                                  UnlinkE:
 46543                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 46544                                  	;;jmp	SYS_RET_ERR		; bye
 46545                                  	;jmp	short ChModE
 46546                                  	; 17/12/2022
 46547 00007DBC EB96                    	jmp	short NORERR
 46548                                  
 46549                                  ;BREAK <$RENAME - move directory entries around>
 46550                                  ;----------------------------------------------------------------------------
 46551                                  ;
 46552                                  ;   Assembler usage:
 46553                                  ;	    LDS     DX, source
 46554                                  ;	    LES     DI, dest
 46555                                  ;	    IF VIA SERVER DOS CALL
 46556                                  ;	      MOV   CX,SEARCH_ATTRIB
 46557                                  ;	    MOV     AH, Rename
 46558                                  ;	    INT     21h
 46559                                  ;
 46560                                  ;   Error returns:
 46561                                  ;	    AX = error_file_not_found
 46562                                  ;	       = error_not_same_device
 46563                                  ;	       = error_access_denied
 46564                                  ;
 46565                                  ;----------------------------------------------------------------------------
 46566                                  
 46567                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46568                                  	; 15/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 46569                                  
 46570                                  _$RENAME:
 46571                                  	; 15/03/2024 (PCDOS 7.1 IBMDOS.COM)
 46572                                  	;;;
 46573                                  	;mov	word [ss:PATHNAMELEN],67
 46574                                  	; 15/03/2024 - Retro DOS v5.0
 46575 00007DBE 36C606[1011]43          	mov	byte [ss:PATHNAMELEN],67 ; DIRSTRLEN = 67
 46576                                  rename_x:
 46577                                  	;;;
 46578                                  
 46579                                  	; MSDOS 3.3 (& MSDOS 6.0)
 46580 00007DC4 51                      	push	cx
 46581 00007DC5 1E                      	push	ds
 46582 00007DC6 52                      	push	dx			; save source and possible CX arg
 46583 00007DC7 06                      	PUSH	ES
 46584 00007DC8 1F                      	POP	DS			; move dest to source
 46585 00007DC9 89FE                    	MOV	SI,DI			; save for offsets
 46586 00007DCB BF[3E04]                	MOV	DI,RENBUF
 46587 00007DCE E816FB                  	call	TransPathSet		; munge the paths
 46588 00007DD1 36FF36[B205]            	PUSH	word [ss:WFP_START]	; get pointer	;smr;SS Override
 46589 00007DD6 368F06[B405]            	POP	word [ss:REN_WFP]	; stash it	;smr;SS Override
 46590 00007DDB 5E                      	pop	si
 46591 00007DDC 1F                      	pop	ds
 46592 00007DDD 59                      	pop	cx			; get back source and possible CX arg
 46593                                  epjc2:	
 46594 00007DDE 72DA                    	JC	short ChModErr		; get old error
 46595 00007DE0 36803E[7A05]FF          	CMP	byte [ss:CMETA],-1			;smr;SS Override
 46596 00007DE6 75D2                    	JNZ	short NotFound
 46597 00007DE8 51                      	push	cx			; Save possible CX arg
 46598 00007DE9 BF[BE03]                	MOV	DI,OPENBUF		; appropriate buffer
 46599 00007DEC E8F8FA                  	call	TransPathSet		; wham
 46600 00007DEF 59                      	pop	cx
 46601                                  	;JC	short epjc2
 46602                                  	; 15/03/2024
 46603 00007DF0 72C8                    	jc	short ChModErr
 46604                                  
 46605 00007DF2 16                      	push	ss
 46606 00007DF3 1F                      	pop	ds
 46607 00007DF4 803E[7A05]FF            	CMP	byte [CMETA],-1
 46608 00007DF9 72BF                    	JB	short NotFound
 46609                                  
 46610                                  	; MSDOS 6.0
 46611                                  	;PUSH	WORD [THISCDS]		   ;AN000;;MS.save thiscds
 46612                                  	;PUSH	WORD [THISCDS+2]	   ;AN000;;MS.
 46613                                  	; 15/03/2024 (PCDOS 7.1 IBMDOS.COM)
 46614                                  	;;;
 46615 00007DFB C43E[A205]              	les	di,[THISCDS]
 46616 00007DFF 57                      	push	di
 46617 00007E00 06                      	push	es
 46618                                  	;;;
 46619                                  
 46620 00007E01 BF[BE03]                	MOV	DI,OPENBUF		   ;AN000;;MS.
 46621 00007E04 16                      	PUSH	SS			   ;AN000;;MS.
 46622 00007E05 07                      	POP	ES			   ;AN000;;MS.es:di-> source
 46623 00007E06 30C0                    	XOR	AL,AL			   ;AN000;;MS.scan all CDS
 46624                                  rnloop: 				   ;AN000;
 46625 00007E08 E856FA                  	call	GetCDSFromDrv		   ;AN000;;MS.
 46626 00007E0B 720F                    	JC	short dorn		   ;AN000;;MS.	end of CDS
 46627 00007E0D E85C99                  	call	StrCmp			   ;AN000;;MS.	current dir ?
 46628 00007E10 7404                    	JZ	short rnerr		   ;AN000;;MS.	yes
 46629 00007E12 FEC0                    	INC	AL			   ;AN000;;MS.	next
 46630 00007E14 EBF2                    	JMP	short rnloop		   ;AN000;;MS.
 46631                                  rnerr:					   ;AN000;
 46632                                  	;ADD	SP,4			   ;AN000;;MS. pop thiscds
 46633                                  	; 15/03/2024 (PCDOS 7.1 IBMDOS.COM)
 46634 00007E16 58                      	pop	ax
 46635 00007E17 58                      	pop	ax
 46636                                  
 46637                                  	;error	error_current_directory    ;AN000;;MS.
 46638 00007E18 B010                    	mov	al,error_current_directory
 46639                                  	;jmp	SYS_RET_ERR
 46640                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 46641 00007E1A EBA0                    	jmp	short UnlinkE
 46642                                  dorn:
 46643                                  
 46644                                  ; 15/03/2024
 46645                                  %if 0					   ;AN000;
 46646                                  	POP	WORD [SS:THISCDS+2]	   ;AN000;;MS.;PBUGBUG;SS REQD??
 46647                                  	POP	WORD [SS:THISCDS]	   ;AN000;;MS.;PBUGBUG;SS REQD??
 46648                                  %endif
 46649 00007E1C 16                      	push	ss
 46650 00007E1D 1F                      	pop	ds
 46651                                  
 46652                                  ; 15/03/2024
 46653                                  %if 1
 46654 00007E1E 8F06[A405]              	pop	word [THISCDS+2]
 46655 00007E22 8F06[A205]              	pop	word [THISCDS]
 46656                                  %endif
 46657                                  	; MSDOS 3.3 (& MSDOS 6.0)
 46658                                  	;mov	ch,16h
 46659 00007E26 B516                    	mov	ch,attr_directory+attr_hidden+attr_system
 46660                                  					; rename appropriate files
 46661 00007E28 E8B600                  	call	SetAttrib
 46662 00007E2B E8B0AE                  	call	DOS_RENAME		; do the deed
 46663 00007E2E 728C                    	JC	short UnlinkE 		; errors
 46664                                  
 46665                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 46666                                  	;jmp	SYS_RET_OK
 46667 00007E30 EB86                    	jmp	short UnlinkOk
 46668                                  
 46669                                  ; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46670                                  
 46671                                  ; 14/07/2018 - Retro DOS v3.0
 46672                                  ; MSDOS 3.3 (& MSDOS 6.0)
 46673                                  
 46674                                  ;Break <$CreateNewFile - Create a new directory entry>
 46675                                  ;----------------------------------------------------------------------------
 46676                                  ;   CreateNew - Create a new directory entry. Return a file handle if there
 46677                                  ;	was no previous directory entry, and fail if a directory entry with
 46678                                  ;	the same name existed previously.
 46679                                  ;
 46680                                  ;   Inputs:	DS:DX point to an ASCIZ file name
 46681                                  ;		CX contains default file attributes
 46682                                  ;   Outputs:	Carry Clear:
 46683                                  ;		    AX has file handle opened for read/write
 46684                                  ;		Carry Set:
 46685                                  ;		    AX has error code
 46686                                  ;   Registers modified: All
 46687                                  ;----------------------------------------------------------------------------
 46688                                  
 46689                                  _$CreateNewFile:
 46690 00007E32 51                      	push	cx			; Save attributes on stack
 46691 00007E33 B9[C130]                	MOV	CX,DOS_Create_New	; routine to call
 46692 00007E36 E9F1FE                  	JMP	AccessSet		; use good ol' open
 46693                                  
 46694                                  ;**	BinToAscii - convert a number to a string.
 46695                                  ;----------------------------------------------------------------------------
 46696                                  ;	BinToAscii converts a 16 bit number into a 4 ascii characters.
 46697                                  ;	This routine is used to generate temp file names so we don't spend
 46698                                  ;	the time and code needed for a true hex number, we just use
 46699                                  ;	A thorugh O.
 46700                                  ;
 46701                                  ;	ENTRY	(ax) = value
 46702                                  ;		(es:di) = destination
 46703                                  ;	EXIT	(es:di) updated by 4
 46704                                  ;	USES	cx, di, flags
 46705                                  ;----------------------------------------------------------------------------
 46706                                  
 46707                                  ; MSDOS 3.3
 46708                                  ;BinToAscii:
 46709                                  ;	mov     cx,4
 46710                                  ;bta5:
 46711                                  ;	push    cx
 46712                                  ;	mov     cl,4
 46713                                  ;	rol     ax,cl
 46714                                  ;	push    ax
 46715                                  ;	and     al,0Fh
 46716                                  ;	add     al,'0'
 46717                                  ;	cmp     al,'9'
 46718                                  ;	jbe     short bta6
 46719                                  ;	add     al,7
 46720                                  ;bta6: 
 46721                                  ;	stosb
 46722                                  ;	pop     ax
 46723                                  ;	pop     cx
 46724                                  ;	loop    bta5
 46725                                  ;	retn
 46726                                  
 46727                                  ; 15/03/2024
 46728                                  ; MSDOS 5.0-6.22 & Windows ME
 46729                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0B0D9h)
 46730                                  ; (Windows ME IO.SYS - BIOSCODE:0ABA4h)
 46731                                  %if 0
 46732                                  
 46733                                  ; MSDOS 6.0
 46734                                  BinToAscii:
 46735                                  	mov	cx,404h			; (ch) = digit counter, (cl) = shift cnt
 46736                                  bta5:	
 46737                                  	ROL	AX,CL			; move leftmost nibble into rightmost
 46738                                  	push	ax			; preserve remainder of digits
 46739                                  	AND	AL,0Fh			; grab low nibble
 46740                                  	ADD	AL,'A'			; turn into ascii
 46741                                  	STOSB				; drop in the character
 46742                                  	pop	ax			; (ax) = shifted number
 46743                                  	dec	ch
 46744                                  	jnz	short bta5		; process 4 digits
 46745                                  	retn
 46746                                  %else
 46747                                  ; 15/03/2024
 46748                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0C385h
 46749                                  
 46750                                  BinToAscii:
 46751 00007E39 50                      	push	ax		; convert a number to a string ; ax = value
 46752 00007E3A 86C4                    	xchg	ah,al
 46753                                  	;db	0D4h,10h
 46754 00007E3C D410                    	aam	10h		; AH = AL / 16 and AL = remainder
 46755 00007E3E 054141                  	add	ax,4141h	; 'AA'
 46756 00007E41 AB                      	stosw
 46757 00007E42 58                      	pop	ax
 46758                                  	;db	0D4h,10h
 46759 00007E43 D410                    	aam	10h
 46760 00007E45 054141                  	add	ax,4141h	; add ax,'AA'
 46761 00007E48 AB                      	stosw
 46762 00007E49 C3                      	retn	
 46763                                  %endif
 46764                                  
 46765                                  ;Break	<$CreateTempFile - create a unique name>
 46766                                  ;----------------------------------------------------------------------------
 46767                                  ;   $CreateTemp - given a directory, create a unique name in that directory.
 46768                                  ;	Method used is to get the current time, convert to a name and attempt
 46769                                  ;	a create new. Repeat until create new succeeds.
 46770                                  ;
 46771                                  ;   Inputs:	DS:DX point to a null terminated directory name.
 46772                                  ;		CX  contains default attributes
 46773                                  ;   Outputs:	Unique name is appended to DS:DX directory.
 46774                                  ;		AX has handle
 46775                                  ;   Registers modified: all
 46776                                  ;----------------------------------------------------------------------------
 46777                                  
 46778                                  	; 10/07/2024
 46779                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 46780                                  	; 15/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 46781                                  
 46782                                  _$CreateTempFile:
 46783                                  	;Enter
 46784 00007E4A 55                      	push	bp
 46785 00007E4B 89E5                    	mov	bp,sp
 46786                                  
 46787                                  	;LocalVar  EndPtr,DWORD
 46788                                  	;LocalVar  FilPtr,DWORD
 46789                                  	;LocalVar  Attr,WORD
 46790                                  
 46791 00007E4D 83EC0A                  	sub	sp,10
 46792                                  
 46793                                  	;test	cx,0FFD8h
 46794 00007E50 F7C1D8FF                	test	CX,~attr_changeable
 46795 00007E54 7405                    	JZ	short OKatts		; Ok if no non-changeable bits set
 46796                                  
 46797                                  ; We need this "hook" here to detect these cases (like user sets one both of
 46798                                  ; vol_id and dir bits) because of the structure of the or $CreateNewFile loop
 46799                                  ; below. The code loops on error_access_denied, but if one of the non
 46800                                  ; changeable attributes is specified, the loop COULD be infinite or WILL be
 46801                                  ; infinite because CreateNewFile will fail with access_denied always. Thus we
 46802                                  ; need to detect these cases before getting to the loop.
 46803                                  
 46804                                  	;mov	ax, 5
 46805 00007E56 B80500                  	MOV	AX,error_access_denied
 46806 00007E59 EB7A                    	JMP	SHORT SETTMPERR
 46807                                  
 46808                                  OKatts:
 46809                                  	;MOV	attr,CX 		; save attribute
 46810 00007E5B 894EF6                  	mov     [bp-10],cx
 46811                                  	;MOV	FilPtrL,DX		; pointer to file
 46812 00007E5E 8956F8                  	mov	[bp-8],dx
 46813                                  	;MOV	FilPtrH,DS
 46814 00007E61 8C5EFA                  	mov	[bp-6],ds
 46815                                  	;MOV	EndPtrH,DS		; seg pointer to end of dir
 46816 00007E64 8C5EFE                  	mov	[bp-2],ds
 46817 00007E67 1E                      	PUSH	DS
 46818 00007E68 07                      	POP	ES			; destination for nul search
 46819 00007E69 89D7                    	MOV	DI,DX
 46820 00007E6B 89F9                    	MOV	CX,DI
 46821 00007E6D F7D9                    	NEG	CX			; number of bytes remaining in segment
 46822                                  	; MSDOS 6.0
 46823 00007E6F 09C9                    	OR	CX,CX			;AN000;MS. cx=0 ? ds:dx on segment boundary
 46824 00007E71 7501                    	JNZ	short okok		;AN000;MS. no
 46825                                  	;MOV	CX,-1			;AN000;MS.
 46826                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 46827                                  	; 17/12/2022
 46828 00007E73 49                      	dec	cx  ; mov cx,-1
 46829                                  	;mov	cx,-1 ; 0FFFh
 46830                                  okok:					;AN000;
 46831 00007E74 31C0                    	XOR	AX,AX			;AN000;
 46832 00007E76 F2AE                    	REPNZ	SCASB			;AN000;
 46833                                  					;AN000;
 46834 00007E78 4F                      	DEC	DI			; point back to the null
 46835 00007E79 268A45FF                	MOV	AL,[ES:DI-1]		; Get char before the NUL
 46836 00007E7D E810DC                  	call	PATHCHRCMP		; Is it a path separator?
 46837 00007E80 7403                    	JZ	short SETENDPTR		; Yes
 46838                                  STOREPTH:
 46839 00007E82 B05C                    	MOV	AL,'\'
 46840 00007E84 AA                      	STOSB				; Add a path separator (and INC DI)
 46841                                  SETENDPTR:
 46842                                  	; 10/07/2024 - Retro DOS v5.0
 46843                                  	;MOV	EndPtrL,DI		; pointer to the tail
 46844                                  	; 09/07/2024 (Retro DOS v4 BugFix - Erdogan Tan - Istanbul)
 46845                                  	; (Note: I find this Retro DOS v4 Kernel bug while searching the reason
 46846                                  	;  of the AutoCAD R12 running/startup problem. Now it is solved here.)
 46847                                  	;mov	[bp-4],dl ; (Retro DOS v4 !Bug!)
 46848 00007E85 897EFC                  	mov	[bp-4],di ; !Fix!
 46849                                  CreateLoop:
 46850 00007E88 16                      	push	ss			; let ReadTime see variables
 46851 00007E89 1F                      	pop	ds
 46852 00007E8A 55                      	push	bp
 46853 00007E8B E8D98C                  	call	READTIME		; go get time
 46854 00007E8E 5D                      	pop	bp
 46855                                  ;
 46856                                  ; Time is in CX:DX. Go drop it into the string.
 46857                                  ;
 46858                                  	;les	di,EndPtr		; point to the string
 46859 00007E8F C47EFC                  	les	di,[BP-4]
 46860 00007E92 89C8                    	mov	ax,cx
 46861 00007E94 E8A2FF                  	call	BinToAscii		; store upper word
 46862 00007E97 89D0                    	mov	ax,dx
 46863 00007E99 E89DFF                  	call	BinToAscii		; store lower word
 46864 00007E9C 30C0                    	xor	al,al
 46865 00007E9E AA                      	STOSB				; nul terminate
 46866                                  	;LDS	DX,FilPtr		; get name
 46867 00007E9F C556F8                  	lds	dx,[bp-8]
 46868                                  	;MOV	CX,Attr 		; get attr
 46869 00007EA2 8B4EF6                  	mov	cx,[bp-10]
 46870 00007EA5 55                      	push	bp
 46871 00007EA6 E889FF                  	CALL	_$CreateNewFile		; try to create a new file
 46872 00007EA9 5D                      	pop	bp
 46873 00007EAA 732A                    	JNC	short CreateDone	; failed, go try again
 46874                                  
 46875                                  ; The operation failed and the error has been mapped in AX. Grab the extended
 46876                                  ; error and figure out what to do.
 46877                                  
 46878                                  	;; MSDOS 3.3			; M049 - start
 46879                                  ;;	mov	ax,[ss:EXTERR]				;smr;SS Override
 46880                                  ;;	cmp	al,error_file_exists
 46881                                  ;;	jz	short CreateLoop	; file existed => try with new name
 46882                                  ;;	cmp	al,error_access_denied
 46883                                  ;;	jz	short CreateLoop	; access denied (attr mismatch)
 46884                                  
 46885                                  	; MSDOS 6.0
 46886                                  	;cmp	al,50h
 46887 00007EAC 3C50                    	CMP	AL,error_file_exists	; Q: did file already exist
 46888 00007EAE 74D8                    	JZ	short CreateLoop	; Y: try again
 46889                                  	;cmp	al,5
 46890 00007EB0 3C05                    	CMP	AL,error_access_denied	; Q: was it access denied
 46891 00007EB2 7521                    	JNZ	short SETTMPERR		; N: Error out
 46892                                  					; Y: Check to see if we got this due
 46893                                  					;    to the network drive. Note that
 46894                                  					;    the redir will set the exterr
 46895                                  					;    to error_cannot_make if this is 
 46896                                  					;    so.
 46897                                  ; 15/03/2024
 46898                                  %if 0
 46899                                  	CMP	byte [SS:EXTERR],error_net_access_denied ; M069
 46900                                  					; See if it's REALLY an att mismatch
 46901                                  	je	short SETTMPERR		; no, network error, stop
 46902                                  ;M070
 46903                                  ; If the user failed on an I24, we do not want to try again
 46904                                  ;
 46905                                  	cmp	byte [SS:EXTERR],error_FAIL_I24 ;User failed on I24? ;M070
 46906                                  	;je	short SETTMPERR		;yes, do not try again ;M070
 46907                                  
 46908                                  	;jmp	short CreateLoop	;attr mismatch, try again ;M070
 46909                                  	; 17/12/2022
 46910                                  	jne	short CreateLoop ; 10/06/2019 
 46911                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 46912                                  	;jz	short SETTMPERR
 46913                                  	;jmp	short CreateLoop
 46914                                  %else
 46915                                  	; 15/03/2024 (PCDOS 7.1 IBMDOS.COM)
 46916                                  	;;;
 46917 00007EB4 36A0[2403]              	mov	al,[ss:EXTERR]
 46918 00007EB8 3C41                    	cmp	al,41h			; error_net_access_denied
 46919 00007EBA 7419                    	je	short SETTMPERR
 46920 00007EBC 3C53                    	cmp	al,53h			; error_FAIL_I24
 46921 00007EBE 7415                    	je	short SETTMPERR
 46922 00007EC0 3C50                    	cmp	al,50h			; error_file_exists
 46923 00007EC2 74C4                    	je	short CreateLoop
 46924 00007EC4 36C43E[A205]            	les	di,[ss:THISCDS]
 46925 00007EC9 83FFFF                  	cmp	di,0FFFFh ; -1
 46926 00007ECC 74BA                    	je	short CreateLoop	; No CDS
 46927                                  	;;test	word [es:di+43h],8000h
 46928                                  	;test	word [es:di+curdir.flags],curdir_isnet
 46929 00007ECE 26F6454480              	test	byte [es:di+curdir.flags+1],(curdir_isnet>>8)
 46930 00007ED3 75B3                    	jnz	short CreateLoop
 46931                                  	;;;
 46932                                  %endif
 46933                                  
 46934                                  ;;	MOV	AL,error_access_denied	; Return this "extended" error
 46935                                  					; M049 - end
 46936                                  SETTMPERR:
 46937 00007ED5 F9                      	STC
 46938                                  CreateDone:
 46939                                  	;Leave
 46940 00007ED6 89EC                    	mov	sp,bp
 46941 00007ED8 5D                      	pop	bp
 46942 00007ED9 7203                    	JC	short CreateFail
 46943 00007EDB E98D87                  	jmp	SYS_RET_OK		; success!
 46944                                  CreateFail:
 46945 00007EDE E99487                  	jmp	SYS_RET_ERR
 46946                                  
 46947                                  ;   SetAttrib will set the search attribute (SAttrib) either to the normal
 46948                                  ;   (CH) or to the value in CL if the current system call is through
 46949                                  ;   serverdoscall.
 46950                                  ;
 46951                                  ;   Inputs:	fSharing == FALSE => set sattrib to CH
 46952                                  ;		fSharing == TRUE => set sattrib to CL
 46953                                  ;   Outputs:	none
 46954                                  ;   Registers changed:	CX
 46955                                  
 46956                                  SetAttrib:
 46957                                  	;test	byte [SS:FSHARING],-1		;smr;SS Override
 46958                                  	;jnz	short Set
 46959                                  	; 15/03/2024
 46960 00007EE1 36803E[7205]00          	cmp	byte [ss:FSHARING],0
 46961 00007EE7 7502                    	jnz	short Set
 46962                                  
 46963 00007EE9 88E9                    	mov	cl,ch
 46964                                  Set:
 46965 00007EEB 36880E[6D05]            	mov	byte [ss:SATTRIB],cl		;smr;SS Override
 46966 00007EF0 C3                      	retn
 46967                                  
 46968                                  ;----------------------------------------------------------------------------
 46969                                  	; 16/03/2024 - Retro DOS v5.0
 46970                                  ext_inval2:
 46971                                  	;mov	al,1
 46972 00007EF1 B001                    	mov	al,error_invalid_function
 46973                                  eo_err:
 46974                                  	;jmp	SYS_RET_ERR
 46975 00007EF3 EBE9                    	jmp	short CreateFail
 46976                                  
 46977                                  ; 14/07/2018 - Retro DOS v3.0
 46978                                  ; MSDOS 6.0
 46979                                  
 46980                                  ; 29/04/2019 - Retro DOS v4.0
 46981                                  
 46982                                  ;Break	<Extended_Open- Extended open the file>
 46983                                  ;----------------------------------------------------------------------------
 46984                                  ; Input: AL= 0 reserved  AH=6CH
 46985                                  ;	 BX= mode
 46986                                  ;	 CL= create attribute  CH=search attribute (from server)
 46987                                  ;	 DX= flag
 46988                                  ;	 DS:SI = file name
 46989                                  ;	 ES:DI = parm list
 46990                                  ;			   DD  SET EA list (-1) null
 46991                                  ;			   DW  n  parameters
 46992                                  ;			   DB  type (TTTTTTLL)
 46993                                  ;			   DW  IOMODE
 46994                                  ; Function: Extended Open
 46995                                  ; Output: carry clear
 46996                                  ;		     AX= handle
 46997                                  ;		     CX=1 file opened
 46998                                  ;			2 file created/opened
 46999                                  ;			3 file replaced/opened
 47000                                  ;	  carry set: AX has error code
 47001                                  ;----------------------------------------------------------------------------
 47002                                  
 47003                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 47004                                  	; 16/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 47005                                  
 47006                                  _$Extended_Open:			  ;AN000;
 47007                                  	;ASSUME	CS:DOSCODE,SS:DOSDATA	  ;AN000;
 47008 00007EF5 368916[F405]            	MOV	[SS:EXTOPEN_FLAG],DX	  ;AN000;EO. save ext. open flag;smr;SS Override
 47009 00007EFA 36C706[F705]0000        	MOV	word [SS:EXTOPEN_IO_MODE],0 ;AN000;EO. initialize IO mode;smr;SS Override
 47010                                  	; 17/12/2022
 47011 00007F01 F6C6FE                  	test	dh,0FEh ; 04/12/2022 
 47012                                  	;;test	dx,0FE00h
 47013                                  	;TEST	DX,RESERVED_BITS_MASK	  ;AN000;EO. reserved bits 0 ?
 47014 00007F04 75EB                    	JNZ	short ext_inval2	  ;AN000;EO. no
 47015 00007F06 88D4                    	MOV	AH,DL			  ;AN000;EO. make sure flag is right
 47016 00007F08 80FA00                  	CMP	DL,0			  ;AN000;EO. all fail ?
 47017 00007F0B 74E4                    	JZ	short ext_inval2	  ;AN000;EO. yes, error
 47018                                  	;and	dl,0Fh
 47019 00007F0D 80E20F                  	AND	DL,EXISTS_MASK		  ;AN000;EO. get exists action byte
 47020 00007F10 80FA02                  	CMP	DL,2			  ;AN000;EO, > 2
 47021 00007F13 77DC                    	JA	short ext_inval2	  ;AN000;EO. yes, error
 47022                                  	;and	ah,0F0h
 47023 00007F15 80E4F0                  	AND	AH,NOT_EXISTS_MASK	  ;AN000;EO. get no exists action byte
 47024 00007F18 80FC10                  	CMP	AH,10H			  ;AN000;EO. > 10
 47025 00007F1B 77D4                    	JA	short ext_inval2	  ;AN000;EO. yes, error
 47026                                  
 47027 00007F1D 368C06[FB05]            	MOV	[SS:SAVE_ES],ES		  ;AN000;EO. save API parms;smr;SS Override
 47028 00007F22 36893E[F905]            	MOV	[SS:SAVE_DI],DI		  ;AN000;EO.;smr;SS Override
 47029 00007F27 36FF36[F405]            	PUSH	word [SS:EXTOPEN_FLAG]	  ;AN000;EO.;smr;SS Override
 47030 00007F2C 368F06[FD05]            	POP	word [SS:SAVE_DX]	  ;AN000;EO.;smr;SS Override
 47031 00007F31 36890E[FF05]            	MOV	[SS:SAVE_CX],CX		  ;AN000;EO.;smr;SS Override
 47032 00007F36 36891E[0106]            	MOV	[SS:SAVE_BX],BX		  ;AN000;EO.;smr;SS Override
 47033 00007F3B 368C1E[0506]            	MOV	[SS:SAVE_DS],DS		  ;AN000;EO.;smr;SS Override
 47034 00007F40 368936[0306]            	MOV	[SS:SAVE_SI],SI		  ;AN000;EO.;smr;SS Override
 47035 00007F45 89F2                    	MOV	DX,SI			  ;AN000;EO. ds:dx points to file name
 47036 00007F47 89D8                    	MOV	AX,BX			  ;AN000;EO. ax= mode
 47037                                  ; 16/03/2024
 47038                                  %if 0
 47039                                  	JMP	SHORT goopen2		  ;AN000;;EO. do normal
 47040                                  ext_inval2:				  ;AN000;;EO.
 47041                                  	;mov	al,1
 47042                                  	mov	al,error_invalid_function ;AN000;EO.. invalid function
 47043                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47044                                  eo_err:
 47045                                  	;jmp	SYS_RET_ERR
 47046                                  	jmp	short CreateFail
 47047                                  %endif
 47048                                  
 47049                                  ; 16/03/2024
 47050                                  %if 0
 47051                                  ext_inval_parm:				  ;AN000;EO..
 47052                                  	POP	CX			  ;AN000;EO..  pop up satck
 47053                                  	POP	SI			  ;AN000;EO..
 47054                                  	;error	error_invalid_data	  ;AN000;EO..  invalid parms
 47055                                  	;mov	al,13
 47056                                  	mov	al,error_invalid_data
 47057                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47058                                  	;;jmp	SYS_RET_ERR
 47059                                  	;jmp	short eo_err
 47060                                  	; 17/12/2022
 47061                                  	jmp	short CreateFail
 47062                                  %endif
 47063                                  
 47064                                  	; 17/12/2022	
 47065                                  ;error_return:				  ;AN000;EO.
 47066                                  ;	retn				  ;AN000;EO.. return with error
 47067                                  
 47068                                  goopen2:				  ;AN000;
 47069                                  	; 17/12/2022
 47070                                  	;test	bh,20h				 
 47071 00007F49 F6C720                  	test	bh,INT_24_ERROR>>8 ; 04/12/2022
 47072                                  	;;test	bx,2000h
 47073                                  	;TEST	BX,INT_24_ERROR		  ;AN000;EO.. disable INT 24 error ?
 47074 00007F4C 7406                    	JZ	short goopen		  ;AN000;EO.. no
 47075                                  	;or	byte [SS:EXTOPEN_ON],2
 47076 00007F4E 36800E[F605]02          	OR	byte [SS:EXTOPEN_ON],EXT_OPEN_I24_OFF ;AN000;EO.. set bit to disable;smr;SS Override
 47077                                  goopen:					  ;AN000;
 47078                                  	;or	byte [SS:EXTOPEN_ON],1 
 47079 00007F54 36800E[F605]01          	OR	byte [SS:EXTOPEN_ON],EXT_OPEN_ON  ;AN000;EO.. set Extended Open active;smr;SS Override
 47080                                  	;AND	word [SS:EXTOPEN_FLAG],0FFh  ;AN000;EO.create new ?;smr;SS Override
 47081                                  	; 18/12/2022
 47082 00007F5A 36C606[F505]00          	mov	byte [SS:EXTOPEN_FLAG+1],0 ; AND word [SS:EXTOPEN_FLAG],0FFh
 47083                                  	;cmp	word [SS:EXTOPEN_FLAG],10h
 47084 00007F60 36833E[F405]10          	CMP	word [SS:EXTOPEN_FLAG],EXT_EXISTS_FAIL+EXT_NEXISTS_CREATE ;AN000;FT.;smr;SS Override
 47085 00007F66 7516                    	JNZ	short chknext 		  ;AN000;;EO. no
 47086 00007F68 E8C7FE                  	call	_$CreateNewFile		  ;AN000;;EO. yes
 47087 00007F6B 723F                    	JC	short error_return	  ;AN000;;EO. error
 47088                                  
 47089 00007F6D 36803E[F605]00          	CMP	byte [SS:EXTOPEN_ON],0	  ;AN000;;EO. IFS does it;smr;SS Override
 47090 00007F73 7438                    	JZ	short ok_return2	  ;AN000;;EO. yes
 47091                                  	;mov	word [SS:EXTOPEN_FLAG],2
 47092 00007F75 36C706[F405]0200        	MOV	word [SS:EXTOPEN_FLAG],ACTION_CREATED_OPENED ;AN000;EO. created/opened;smr;SS Override
 47093 00007F7C EB7F                    	JMP	short setXAttr ; 16/03/2024 ;AN000;;EO. set XAs
 47094                                  
 47095                                  	; 17/12/2022
 47096                                  ;ok_return2:
 47097                                  ;	jmp	SYS_RET_OK		  ;AN000;;EO.
 47098                                  
 47099                                  chknext:
 47100                                  	; 17/12/2022
 47101 00007F7E 36F606[F405]01          	test	byte [SS:EXTOPEN_FLAG],EXT_EXISTS_OPEN ; 1
 47102                                  	;;test	word [SS:EXTOPEN_FLAG],1
 47103                                  	;TEST	word [SS:EXTOPEN_FLAG],EXT_EXISTS_OPEN ;AN000;;EO. exists open;smr;SS Override
 47104 00007F84 752A                    	JNZ	short exist_open	  ;AN000;;EO. yes
 47105 00007F86 E89DFD                  	call	_$CREAT			  ;AN000;;EO. must be replace open
 47106 00007F89 7221                    	JC	short error_return	  ;AN000;;EO. return with error
 47107 00007F8B 36803E[F605]00          	CMP	byte [SS:EXTOPEN_ON],0	  ;AN000;;EO. IFS does it;smr;SS Override
 47108 00007F91 741A                    	JZ	short ok_return2	  ;AN000;;EO. yes
 47109 00007F93 36C706[F405]0200        	MOV	word [SS:EXTOPEN_FLAG],ACTION_CREATED_OPENED ;AN000;EO. presume create/open;smr;SS Override
 47110 00007F9A 36F606[F605]04          	TEST	byte [SS:EXTOPEN_ON],EXT_FILE_NOT_EXISTS ;AN000;;EO. file not exists ?;smr;SS Override
 47111 00007FA0 755B                    	JNZ	short setXAttr		  ;AN000;;EO. no
 47112 00007FA2 36C706[F405]0300        	MOV	word [SS:EXTOPEN_FLAG],ACTION_REPLACED_OPENED ;AN000;;EO. replaced/opened;smr;SS Override
 47113 00007FA9 EB52                    	JMP	SHORT setXAttr		  ;AN000;;EO. set XAs
 47114                                  error_return2:
 47115 00007FAB F9                      	STC 				  ; Set Carry again to flag error ;AN001;
 47116                                  error_return:	 ; 17/12/2022
 47117 00007FAC C3                      	retn				  ;AN000;;EO. return with error
 47118                                  
 47119                                  	; 17/12/2022
 47120                                  ok_return:
 47121                                  ok_return2:
 47122 00007FAD E9BB86                  	jmp	SYS_RET_OK
 47123                                  
 47124                                  exist_open:				  ;AN000;
 47125                                  	;test	byte [SS:FSHARING],-1	  ;AN000;;EO. server doscall?;smr;SS Override
 47126                                  	;jz	short noserver		  ;AN000;;EO. no
 47127                                  	; 16/03/2024
 47128                                  	;;;
 47129 00007FB0 36803E[7205]00          	cmp	byte [ss:FSHARING],0	; server doscall?
 47130 00007FB6 7402                    	jz	short noserver		; no
 47131                                  	;;;
 47132 00007FB8 88E9                    	MOV	CL,CH			  ;AN000;;EO. cl=search attribute
 47133                                  noserver:
 47134 00007FBA E893FC                  	call	_$Open2			  ;AN000;;EO. do open
 47135 00007FBD 732F                    	JNC	short ext_ok		  ;AN000;;EO.
 47136 00007FBF 36803E[F605]00          	CMP	byte [SS:EXTOPEN_ON],0	  ;AN000;;EO. error and IFS call;smr;SS Override
 47137 00007FC5 74E4                    	JZ	short error_return2	  ;AN000;;EO. return with error
 47138                                  local_extopen:
 47139                                  	;cmp	ax,2
 47140 00007FC7 83F802                  	CMP	AX,error_file_not_found   ;AN000;;EO. file not found error
 47141 00007FCA 75DF                    	JNZ	short error_return2	  ;AN000;;EO. no,
 47142                                  	;;test	word [SS:EXTOPEN_FLAG],10h
 47143                                  	; 17/12/2022
 47144 00007FCC 36F606[F405]10          	test	byte [SS:EXTOPEN_FLAG],EXT_NEXISTS_CREATE ; 10h
 47145                                  	;TEST	word [SS:EXTOPEN_FLAG],EXT_NEXISTS_CREATE ;AN000;;EO. want to fail;smr;SS Override
 47146                                  	;JNZ	short do_creat		  ;AN000;;EO. yes
 47147                                  	;JMP	short extexit 		  ;AN000;;EO. yes
 47148                                  	; 17/12/2022
 47149 00007FD2 7446                    	jz	short extexit ; 10/06/2019
 47150                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47151                                  	;jnz	short do_creat
 47152                                  	;jmp	short extexit
 47153                                  do_creat:
 47154 00007FD4 368B0E[FF05]            	MOV	CX,[SS:SAVE_CX]		  ;AN000;;EO. get ds:dx for file name;smr;SS Override
 47155 00007FD9 36C536[0306]            	LDS	SI,[SS:SAVE_SI]		  ;AN000;;EO. cx = attribute;smr;SS Override
 47156 00007FDE 89F2                    	MOV	DX,SI			  ;AN000;;EO.
 47157 00007FE0 E843FD                  	call	_$CREAT			  ;AN000;;EO. do create
 47158 00007FE3 7235                    	JC	short extexit 		  ;AN000;;EO. error
 47159                                  	;mov	word [SS:EXTOPEN_FLAG],2
 47160 00007FE5 36C706[F405]0200        	MOV	word [SS:EXTOPEN_FLAG],ACTION_CREATED_OPENED
 47161                                  					  ;AN000;;EO. is created/opened;smr;SS Override
 47162 00007FEC EB0F                    	JMP	SHORT setXAttr		  ;AN000;;EO. set XAs
 47163                                  
 47164                                  ext_ok:
 47165 00007FEE 36803E[F605]00          	CMP	byte [SS:EXTOPEN_ON],0	  ;AN000;;EO. IFS call ?;smr;SS Override
 47166 00007FF4 74B7                    	JZ	short ok_return		  ;AN000;;EO. yes
 47167                                  	;mov	word [SS:EXTOPEN_FLAG],1
 47168 00007FF6 36C706[F405]0100        	MOV	word [SS:EXTOPEN_FLAG],ACTION_OPENED ;AN000;;EO. opened;smr;SS Override
 47169                                  setXAttr:
 47170                                  	; 29/04/2019
 47171 00007FFD 50                      	push	ax
 47172 00007FFE E87684                  	call	Get_User_Stack		  ;AN000;;EO.
 47173 00008001 36A1[F405]              	MOV	AX,[SS:EXTOPEN_FLAG]	  ;AN000;;EO.;smr;SS Override
 47174                                  	;mov	[si+4],ax
 47175 00008005 894404                  	MOV	[SI+user_env.user_CX],AX  ;AN000;;EO. set action code for cx
 47176 00008008 58                      	pop	ax			  ;AN000;;EO.
 47177 00008009 8904                    	mov	[si],ax
 47178                                  	;MOV	[SI+user_env.user_AX],AX  ;AN000;;EO. set handle for ax
 47179                                  	; 17/12/2022
 47180 0000800B EBA0                    	jmp	short ok_return
 47181                                  ;ok_return:				  ;AN000;
 47182                                  	;jmp	SYS_RET_OK		  ;AN000;;EO.
 47183                                  
 47184                                  ; 16/03/2024
 47185                                  %if 0
 47186                                  extexit2:				  ;AN000; ERROR RECOVERY
 47187                                  	POP	BX			  ;AN000;EO. close the handle
 47188                                  	PUSH	AX			  ;AN000;EO. save error code from set XA
 47189                                  	;cmp	word [SS:EXTOPEN_FLAG],2
 47190                                  	CMP	word [SS:EXTOPEN_FLAG],ACTION_CREATED_OPENED
 47191                                  					  ;AN000;EO. from create;smr;SS Override
 47192                                  	JNZ	short justopen		  ;AN000;EO.
 47193                                  	LDS	SI,[SS:SAVE_SI]		  ;AN000;EO. cx = attribute;smr;SS Override
 47194                                  	LDS	DX,[SI]			  ;AN000;EO.
 47195                                  	call	_$UNLINK 		  ;AN000;EO. delete the file
 47196                                  	JMP	SHORT reserror		  ;AN000;EO.
 47197                                  
 47198                                  justopen:				  ;AN000;
 47199                                  	call	_$CLOSE			  ;AN000;EO. pretend never happend
 47200                                  reserror:				  ;AN000;
 47201                                  	POP	AX			  ;AN000;EO. restore error code from set XA
 47202                                  
 47203                                  	JMP	SHORT extexit		  ;AN000;EO.
 47204                                  
 47205                                  ext_file_unfound:			  ;AN000;
 47206                                  	;mov	ax,2
 47207                                  	MOV	AX,error_file_not_found   ;AN000;EO.
 47208                                  	JMP	SHORT extexit		  ;AN000;EO.
 47209                                  ext_inval:				  ;AN000;
 47210                                  	;mov	ax,1
 47211                                  	MOV	AX,error_invalid_function ;AN000;EO.
 47212                                  
 47213                                  lockoperr:	; 17/12/2022
 47214                                  extexit:
 47215                                  	jmp	SYS_RET_ERR		  ;AN000;EO.
 47216                                  
 47217                                  %endif
 47218                                  
 47219                                  ;============================================================================
 47220                                  ; LOCK.ASM, MSDOS 6.0, 1991
 47221                                  ;============================================================================
 47222                                  ; 14/07/2018 - Retro DOS v3.0
 47223                                  ; 22/05/2019 - Retro DOS v4.0
 47224                                  
 47225                                  ;BREAK <$LockOper - Lock Calls>
 47226                                  ;----------------------------------------------------------------------------
 47227                                  ;
 47228                                  ;   Assembler usage:
 47229                                  ;	    MOV     BX, Handle	       (DOS 3.3)
 47230                                  ;	    MOV     CX, OffsetHigh
 47231                                  ;	    MOV     DX, OffsetLow
 47232                                  ;	    MOV     SI, LengthHigh
 47233                                  ;	    MOV     DI, LengthLow
 47234                                  ;	    MOV     AH, LockOper
 47235                                  ;	    MOV     AL, Request
 47236                                  ;	    INT     21h
 47237                                  ;
 47238                                  ;   Error returns:
 47239                                  ;	    AX = error_invalid_handle
 47240                                  ;	       = error_invalid_function
 47241                                  ;	       = error_lock_violation
 47242                                  ;
 47243                                  ;   Assembler usage:
 47244                                  ;	    MOV     AX, 5C??	       (DOS 4.00)
 47245                                  ;
 47246                                  ;				    0? lock all
 47247                                  ;				    8? lock write
 47248                                  ;				    ?2 lock multiple
 47249                                  ;				    ?3 unlock multiple
 47250                                  ;				    ?4 lock/read
 47251                                  ;				    ?5 write/unlock
 47252                                  ;				    ?6 add (lseek EOF/lock/write/unlock)
 47253                                  ;	    MOV     BX, Handle
 47254                                  ;	    MOV     CX, count or size
 47255                                  ;	    LDS     DX, buffer
 47256                                  ;	    INT     21h
 47257                                  ;
 47258                                  ;   Error returns:
 47259                                  ;	    AX = error_invalid_handle
 47260                                  ;	       = error_invalid_function
 47261                                  ;	       = error_lock_violation
 47262                                  ;
 47263                                  ;----------------------------------------------------------------------------
 47264                                  
 47265                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 47266                                  
 47267                                  	; 17/03/2024
 47268                                  	; 16/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 47269                                  
 47270                                  _$LockOper:
 47271 0000800D 3C01                    	CMP	AL,1
 47272 0000800F 770C                    	JA	short lock_bad_func
 47273                                  
 47274 00008011 57                      	PUSH	DI			       ; Save LengthLow
 47275 00008012 E843F3                  	call	SFFromHandle		       ; ES:DI -> SFT
 47276 00008015 731B                    	JNC	short lock_do 		       ; have valid handle
 47277 00008017 5F                      	POP	DI			       ; Clean stack
 47278                                  	;mov	al,6
 47279 00008018 B006                    	mov	al,error_invalid_handle
 47280                                  
 47281                                  	; 16/03/2024
 47282                                  extexit:
 47283                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47284                                  lockoperr:
 47285 0000801A E95886                  	jmp	SYS_RET_ERR
 47286                                  	; 17/12/2022
 47287                                  	;jmp	short lockoperr ; jmp SYS_RET_ERR
 47288                                  
 47289                                  lock_bad_func:
 47290                                  
 47291                                  ; 16/03/2024
 47292                                  %if 0
 47293                                  	;mov	byte [ss:EXTERR_LOCUS],1
 47294                                  	MOV	byte [SS:EXTERR_LOCUS],errLOC_Unk ; Extended Error Locus;smr;SS Override
 47295                                  %else
 47296                                  	; 16/03/2024 (PCDOS 7.1 IBMDOS.COM)
 47297                                  	;;;
 47298 0000801D E89A92                  	call	set_exerr_locus_unk	 ; Extended Error Locus
 47299                                  	;;;
 47300                                  %endif
 47301                                  	;mov	al,1
 47302 00008020 B001                    	mov	al,error_invalid_function
 47303                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47304                                  lockoperrj:
 47305                                  	;jmp	SYS_RET_ERR
 47306 00008022 EBF6                    	jmp	short lockoperr
 47307                                  
 47308                                  	; 22/05/2019 - Retro DOS v4.0
 47309                                  
 47310                                  	; MSDOS 6.0 
 47311                                  ; Align_buffer call has been deleted, since it corrupts the DTA (6/5/88) P5013
 47312                                  ; Dead code deleted, MD, 23 Mar 90
 47313                                  
 47314                                  ;lock_do:
 47315                                  ;	; MSDOS 3.3
 47316                                  ;	or	al,al
 47317                                  ;	pop	ax
 47318                                  ;	jz	short DOS_Lock
 47319                                  ;DOS_Unlock:
 47320                                  ;	;test	word [es:di+5],8000h
 47321                                  ;	test	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 47322                                  ;	JZ	short LOCAL_UNLOCK
 47323                                  ;	push    ax
 47324                                  ;	mov     ax,110Bh
 47325                                  ;	int     2Fh	; Multiplex - NETWORK REDIRECTOR - UNLOCK REGION OF FILE
 47326                                  ;			; BX = file handle, CX:DX = starting offset, SI = high word of size
 47327                                  ;			; STACK: WORD low word of size, ES:DI -> SFT for file
 47328                                  ;			; SFT DPB field -> DPB of drive containing file
 47329                                  ;			; Return: CF set error
 47330                                  ;	pop     bx
 47331                                  ;	jmp     short ValChk
 47332                                  ;
 47333                                  ;LOCAL_UNLOCK:
 47334                                  ;	Call	far [ss:JShare+(7*4)]	; 7 = clr_block ;smr;SS Override
 47335                                  ;ValChk:
 47336                                  ;	JNC	short Lock_OK
 47337                                  ;lockerror:
 47338                                  ;	jmp	SYS_RET_ERR
 47339                                  ;Lock_OK:
 47340                                  ;	;MOV	AX,[SS:Temp_VAR] ;AN000;;MS. AX= number of bytes ;smr;SS Override
 47341                                  ;	jmp	SYS_RET_OK
 47342                                  ;DOS_Lock:
 47343                                  ;	;test	word [es:di+5],8000h
 47344                                  ;	test	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 47345                                  ;	JZ	short LOCAL_LOCK
 47346                                  ;	;CallInstall NET_XLock,MultNET,10
 47347                                  ;	mov     ax, 110Ah
 47348                                  ;	int     2Fh	; Multiplex - NETWORK REDIRECTOR - LOCK REGION OF FILE
 47349                                  ;			; BX = file handle, CX:DX = starting offset, SI = high word of size
 47350                                  ;			; STACK: WORD low word of size, ES:DI -> SFT
 47351                                  ;			; SFT DPB field -> DPB of drive containing file, SS = DOS CS
 47352                                  ;			; Return: CF set error
 47353                                  ;	JMP	short ValChk
 47354                                  ;
 47355                                  ;LOCAL_LOCK:
 47356                                  ;	Call	far [ss:JShare+(6*4)]	; 6 = Set_Block ;smr;SS Override
 47357                                  ;	JMP	short ValChk
 47358                                  
 47359                                  ; 17/12/2022
 47360                                  LOCAL_UNLOCK:
 47361                                  	; MSDOS 3.3
 47362                                  	;Call	far [ss:JShare+(7*4)]	; 7 = clr_block ;smr;SS Override
 47363                                  	; MSDOS 6.0
 47364 00008024 FF1E[AC00]              	Call	far [JShare+(7*4)]	; 7 = clr_block ;smr;SS Override
 47365                                  ValChk:
 47366 00008028 7302                    	JNC	short Lock_OK
 47367                                  lockerror:
 47368                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47369                                  	;;jmp	SYS_RET_ERR
 47370                                  	;jmp	short lockoperrj
 47371                                  	; 17/12/2022
 47372 0000802A EBEE                    	jmp	short lockoperr	; jmp SYS_RET_ERR
 47373                                  Lock_OK:
 47374                                  	;MOV	AX,[SS:TEMP_VAR] ;AN000;;MS. AX= number of bytes ;smr;SS Override
 47375                                  	; 10/06/2019
 47376 0000802C A1[0C06]                	mov	ax,[TEMP_VAR]
 47377 0000802F E93986                  	jmp	SYS_RET_OK
 47378                                  
 47379                                  	; 22/05/2019
 47380                                  lock_do:
 47381                                  	; MSDOS 6.0
 47382 00008032 89C3                    	MOV	BX,AX				; save AX
 47383 00008034 BD[A903]                	MOV	BP,Lock_Buffer			; get DOS LOCK buffer
 47384                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47385                                  	;;mov	[bp+0],dx
 47386                                  	;MOV	[BP+LockBuf.Lock_position],DX	; set low offset
 47387                                  	; 15/12/2022
 47388 00008037 895600                  	mov	[bp],dx
 47389                                  	;mov	[bp+2],cx
 47390 0000803A 894E02                  	MOV	[BP+LockBuf.Lock_position+2],CX; set high offset
 47391                                  	
 47392                                  	; 16/03/2024
 47393                                  	;POP	CX				; get low length
 47394                                  	;;mov	[bp+4],cx
 47395                                  	;MOV	[BP+LockBuf.Lock_length],CX	; set low length
 47396 0000803D 8F4604                  	pop	word [bp+LockBuf.Lock_length]
 47397                                  
 47398                                  	;mov	[bp+6],si
 47399 00008040 897606                  	MOV	[BP+LockBuf.Lock_length+2],SI	; set high length
 47400 00008043 B90100                  	MOV	CX,1				; one range
 47401                                  
 47402                                  ;	PUSH	CS				;
 47403                                  ;	POP	DS				; DS:DX points to
 47404                                  
 47405 00008046 16                      	push	ss
 47406 00008047 1F                      	pop	ds
 47407                                  
 47408 00008048 89EA                    	MOV	DX,BP				; Lock_Buffer
 47409                                  	;test	al,1
 47410 0000804A A801                    	TEST	AL,UNLOCK_ALL			; function 1
 47411                                  	;JNZ	short DOS_Unlock		; yes
 47412                                  	;JMP	short DOS_Lock			; function 0
 47413                                  	; 17/12/2022
 47414                                  	; 10/06/2019
 47415 0000804C 740E                    	jz	short DOS_Lock
 47416                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47417                                  	;JNZ	short DOS_Unlock
 47418                                  	;JMP	short DOS_Lock
 47419                                  
 47420                                  DOS_Unlock:
 47421                                  	;;test	word [es:di+5],8000h
 47422                                  	;test	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 47423 0000804E 26F6450680              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 47424 00008053 74CF                    	JZ	short LOCAL_UNLOCK
 47425                                  
 47426                                  ; 17/03/2024
 47427                                  ;lock_unlock: ; 22/05/2019
 47428                                  
 47429                                  	;CallInstall Net_Xlock,MultNET,10
 47430                                  ;	
 47431                                  ;	; MSDOS 3.3
 47432                                  ;	;mov     ax,110Bh
 47433                                  ;	;int     2Fh	; Multiplex - NETWORK REDIRECTOR - UNLOCK REGION OF FILE
 47434                                  ;			; BX = file handle, CX:DX = starting offset, SI = high word of size
 47435                                  ;			; STACK: WORD low word of size, ES:DI -> SFT for file
 47436                                  ;			; SFT DPB field -> DPB of drive containing file
 47437                                  ;			; Return: CF set error
 47438                                  
 47439                                  ; 17/03/2024 - Retro DOS v5.0
 47440                                  lock_unlock:
 47441                                  
 47442                                  	; MSDOS 6.0
 47443 00008055 B80A11                  	mov     ax,110Ah
 47444 00008058 CD2F                    	int     2Fh 	; Multiplex - NETWORK REDIRECTOR - LOCK REGION OF FILE
 47445                                  			; BX = file handle, CX:DX = starting offset, SI = high word of size
 47446                                  			; STACK: WORD low word of size, ES:DI -> SFT
 47447                                  			; SFT DPB field -> DPB of drive containing file, SS = DOS CS
 47448                                  			; Return: CF set error
 47449                                  
 47450 0000805A EBCC                    	JMP	SHORT ValChk
 47451                                  
 47452                                  ; 17/12/2022
 47453                                  %if 0
 47454                                  LOCAL_UNLOCK:
 47455                                  	; MSDOS 3.3
 47456                                  	;Call	far [ss:JShare+(7*4)]	; 7 = clr_block ;smr;SS Override
 47457                                  	; MSDOS 6.0
 47458                                  	Call	far [JShare+(7*4)]	; 7 = clr_block ;smr;SS Override
 47459                                  ValChk:
 47460                                  	JNC	short Lock_OK
 47461                                  lockerror:
 47462                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47463                                  	;jmp	SYS_RET_ERR
 47464                                  	jmp	short lockoperrj
 47465                                  Lock_OK:
 47466                                  	;MOV	AX,[SS:TEMP_VAR] ;AN000;;MS. AX= number of bytes ;smr;SS Override
 47467                                  	; 10/06/2019
 47468                                  	mov	ax,[TEMP_VAR]
 47469                                  	jmp	SYS_RET_OK
 47470                                  %endif
 47471                                  
 47472                                  DOS_Lock:
 47473                                  	;;test	word [es:di+5],8000h
 47474                                  	;test	word [ES:DI+SF_ENTRY.sf_flags],sf_isnet
 47475 0000805C 26F6450680              	test	byte [ES:DI+SF_ENTRY.sf_flags+1],(sf_isnet>>8)
 47476                                  	;JZ	short LOCAL_LOCK
 47477                                  	; 17/03/2024
 47478 00008061 75F2                    	jnz	short lock_unlock
 47479                                  
 47480                                  ; 17/03/2024
 47481                                  %if 0
 47482                                  	;CallInstall NET_XLock,MultNET,10
 47483                                  
 47484                                  	mov     ax,110Ah
 47485                                  	int     2Fh	; Multiplex - NETWORK REDIRECTOR - LOCK REGION OF FILE
 47486                                  			; BX = file handle, CX:DX = starting offset, SI = high word of size
 47487                                  			; STACK: WORD low word of size, ES:DI -> SFT
 47488                                  			; SFT DPB field -> DPB of drive containing file, SS = DOS CS
 47489                                  			; Return: CF set error
 47490                                  
 47491                                  	JMP	short ValChk
 47492                                  %endif
 47493                                  
 47494                                  LOCAL_LOCK:
 47495                                  	; MSDOS 3.3
 47496                                  	;Call	far [ss:JShare+(6*4)]	; 6 = Set_Block ;smr;SS Override
 47497                                  	; MSDOS 6.0
 47498 00008063 FF1E[A800]              	Call	far [JShare+(6*4)]	; 6 = Set_Block ;smr;SS Override
 47499                                  
 47500 00008067 EBBF                    	JMP	short ValChk
 47501                                  
 47502                                  ; 14/07/2018 - Retro DOS v3.0
 47503                                  ; LOCK_CHECK
 47504                                  ;MSDOS 6.0 (& MSDOS 3.3)
 47505                                  
 47506                                  ;----------------------------------------------------------------------------
 47507                                  ; Inputs:
 47508                                  ;	Outputs of SETUP
 47509                                  ;	[USER_ID] Set
 47510                                  ;	[PROC_ID] Set
 47511                                  ; Function:
 47512                                  ;	Check for lock violations on local I/O
 47513                                  ;	Retries are attempted with sleeps in between
 47514                                  ; Outputs:
 47515                                  ;    Carry clear
 47516                                  ;	Operation is OK
 47517                                  ;    Carry set
 47518                                  ;	A lock violation detected
 47519                                  ; Outputs of SETUP preserved
 47520                                  ;----------------------------------------------------------------------------
 47521                                  
 47522                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 47523                                  	; 22/05/2019 - Retro DOS v4.0
 47524                                  LOCK_CHECK:
 47525 00008069 8B1E[1A00]              	MOV	BX,[RetryCount]	; Number retries
 47526                                  LockRetry:
 47527 0000806D 53                      	push	bx		; save regs
 47528 0000806E 50                      	push	ax ; MSDOS 6.0
 47529                                  
 47530                                  	;MSDOS 3.3
 47531                                  	;Call	far [ss:JShare+(8*4)]	; 8 = chk_block
 47532                                  	;MSDOS 6.0
 47533 0000806F FF1E[B000]              	Call	far [JShare+(8*4)]	; 8 = chk_block
 47534                                  
 47535 00008073 58                      	pop	ax ; MSDOS 6.0
 47536 00008074 5B                      	pop	bx		; restrore regs
 47537 00008075 7307                    	jnc	short lc_ret_label ; There are no locks (retnc)
 47538                                  LockN:
 47539 00008077 E84797                  	call	Idle		; wait a while
 47540 0000807A 4B                      	DEC	BX		; remember a retry
 47541 0000807B 75F0                    	JNZ	short LockRetry	; more retries left...
 47542 0000807D F9                      	STC
 47543                                  lc_ret_label:
 47544 0000807E C3                      	retn
 47545                                  
 47546                                  ; 14/07/2018 - Retro DOS v3.0
 47547                                  ; LOCK_VIOLATION
 47548                                  ;MSDOS 6.0 (& MSDOS 3.3)
 47549                                  
 47550                                  ;----------------------------------------------------------------------------
 47551                                  ; Inputs:
 47552                                  ;	[THISDPB] set
 47553                                  ;	[READOP] indicates whether error on read or write
 47554                                  ; Function:
 47555                                  ;	Handle Lock violation on compatibility (FCB) mode SFTs
 47556                                  ; Outputs:
 47557                                  ;	Carry set if user says FAIL, causes error_lock_violation
 47558                                  ;	Carry clear if user wants a retry
 47559                                  ;
 47560                                  ; DS, ES, DI, CX preserved, others destroyed
 47561                                  ;----------------------------------------------------------------------------
 47562                                  
 47563                                  	; 19/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 47564                                  
 47565                                  LOCK_VIOLATION:
 47566 0000807F 1E                      	PUSH	DS
 47567 00008080 06                      	PUSH	ES
 47568 00008081 57                      	PUSH	DI
 47569 00008082 51                      	PUSH	CX
 47570                                  	;mov	ax,21h
 47571 00008083 B82100                  	MOV	AX,error_lock_violation
 47572                                  	;mov	byte [ALLOWED],18h
 47573 00008086 C606[4B03]18            	MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY
 47574 0000808B C42E[8A05]              	LES	BP,[THISDPB]
 47575 0000808F BF0100                  	MOV	DI,1		; Fake some registers
 47576 00008092 89F9                    	MOV	CX,DI
 47577                                  
 47578                                  	; 19/03/2024 (PCDOS 7.1 IBMDOS.COM)
 47579                                  	;;;
 47580 00008094 31D2                    	xor	dx,dx	; 0
 47581                                  	;cmp	[es:bp+0Fh],dx
 47582 00008096 2639560F                	cmp	[es:bp+DPB.FAT_SIZE],dx ; 0 ?
 47583 0000809A 750E                    	jnz	short lockv_1	; not FAT32
 47584                                  	; FAT32
 47585                                  	;mov	dx,[es:bp+2Bh]
 47586 0000809C 268B562B                	mov	dx,[es:bp+DPB.FCLUS_FSECTOR+2]
 47587 000080A0 8916[0706]              	mov	[HIGH_SECTOR],dx
 47588                                  	;mov	dx,[es:bp+29h]
 47589 000080A4 268B5629                	mov	dx,[es:bp+DPB.FCLUS_FSECTOR]
 47590 000080A8 EB08                    	jmp	short lockv_2
 47591                                  lockv_1:
 47592 000080AA 8916[0706]              	mov     [HIGH_SECTOR],dx ; 0
 47593                                  	;;;
 47594                                  
 47595                                  	;mov	dx,[es:bp+11]
 47596 000080AE 268B560B                	MOV	DX,[ES:BP+DPB.FIRST_SECTOR]
 47597                                  lockv_2:	; 19/03/2024
 47598 000080B2 E845DC                  	call	HARDERR
 47599 000080B5 59                      	POP	CX
 47600                                  sharev_3:	; 01/07/2024
 47601 000080B6 5F                      	POP	DI
 47602 000080B7 07                      	POP	ES
 47603 000080B8 1F                      	POP	DS
 47604 000080B9 3C01                    	CMP	AL,1
 47605 000080BB 74C1                    	jz	short lc_ret_label ; 1 = retry, carry clear
 47606 000080BD F9                      	STC
 47607 000080BE C3                      	retn
 47608                                  
 47609                                  ; 14/07/2018 - Retro DOS v3.0
 47610                                  
 47611                                  ;----------------------------------------------------------------------------
 47612                                  
 47613                                  ;	do a retz to return error
 47614                                  
 47615                                  	; 22/05/2019 - Retro DOS v4.0
 47616                                  CheckShare:
 47617                                  	; MSDOS 3.3
 47618                                  	;cmp	byte [cs:fShare],0
 47619                                  	;retn
 47620                                  
 47621                                  	; MSDOS 6.0
 47622 000080BF 1E                      	push	ds			;smr;
 47623                                  	;getdseg <ds>			; ds -> dosdata
 47624 000080C0 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 47625 000080C5 803E[0303]00            	cmp	byte [fShare],0
 47626 000080CA 1F                      	pop	ds			;smr;
 47627 000080CB C3                      	retn
 47628                                  	
 47629                                  ;============================================================================
 47630                                  ; SHARE.ASM, MSDOS 6.0, 1991
 47631                                  ;============================================================================
 47632                                  ; 14/07/2018 - Retro DOS v3.0
 47633                                  ; 22/05/2019 - Retro DOS v4.0
 47634                                  ; 19/03/2024 - Retro DOS v5.0
 47635                                  
 47636                                  ; SHARE_CHECK
 47637                                  ;----------------------------------------------------------------------------
 47638                                  ; Inputs:
 47639                                  ;       [THISSFT] Points to filled in local file/device SFT for new
 47640                                  ;               instance of file sf_mode ALWAYS has mode (even on FCB SFTs)
 47641                                  ;       [WFP_START] has full path of name
 47642                                  ;       [USER_ID] Set
 47643                                  ;       [PROC_ID] Set
 47644                                  ; Function:
 47645                                  ;       Check for sharing violations on local file/device access
 47646                                  ; Outputs:
 47647                                  ;    Carry clear
 47648                                  ;       Sharing approved
 47649                                  ;    Carry set
 47650                                  ;       A sharing violation detected
 47651                                  ;           AX is error code
 47652                                  ; USES    ALL but DS
 47653                                  ;----------------------------------------------------------------------------
 47654                                  
 47655                                  	; 22/05/2019 - Retro DOS v4.0
 47656                                  SHARE_CHECK:
 47657                                  	; 26/07/2019
 47658 000080CC FF1E[9400]              	call	far [JShare+(1*4)] 	; 1 = MFT_Enter
 47659                                  shchk_retn:
 47660 000080D0 C3                      	retn
 47661                                  
 47662                                  ; SHARE_VIOLATION
 47663                                  ;----------------------------------------------------------------------------
 47664                                  ; Inputs:
 47665                                  ;       [THISDPB] Set
 47666                                  ;       AX has error code
 47667                                  ; Function:
 47668                                  ;       Handle Sharing errors
 47669                                  ; Outputs:
 47670                                  ;       Carry set if user says FAIL, causes error_sharing_violation
 47671                                  ;       Carry clear if user wants a retry
 47672                                  ;
 47673                                  ; DS, ES, DI preserved, others destroyed
 47674                                  ;----------------------------------------------------------------------------
 47675                                  
 47676                                  	; 19/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 47677                                  
 47678                                  SHARE_VIOLATION:
 47679 000080D1 1E                      	PUSH	DS
 47680 000080D2 06                      	PUSH	ES
 47681 000080D3 57                      	PUSH	DI
 47682                                  	; 19/03/2024
 47683 000080D4 31D2                    	xor	dx,dx	; Retro DOS v5.0
 47684                                  	;
 47685                                  	;MOV	byte [READOP],0	; All share errors are reading
 47686 000080D6 8816[7505]              	mov	[READOP],dl ; 0
 47687                                  	;		
 47688                                  	;mov	byte [ALLOWED],18h
 47689 000080DA C606[4B03]18            	MOV	byte [ALLOWED],Allowed_FAIL+Allowed_RETRY
 47690 000080DF C42E[8A05]              	LES	BP,[THISDPB]
 47691 000080E3 BF0100                  	MOV	DI,1			; Fake some registers
 47692 000080E6 89F9                    	MOV	CX,DI
 47693                                  	
 47694                                  	; 19/03/2024
 47695                                  	;;mov	dx,[es:bp+17]
 47696                                  	;MOV	DX,[ES:BP+DPB.DIR_SECTOR]
 47697                                  
 47698                                  	; 19/03/2024 - Retro DOS v5.0
 47699                                  	; PCDOS 7.1 IBMDOS.COM
 47700                                  	;;;
 47701                                   	;cmp	word [es:bp+0Fh],0
 47702 000080E8 2639560F                	cmp	word [es:bp+DPB.FAT_SIZE],dx ; 0
 47703 000080EC 740A                    	jz	short sharev_1 ; FAT32
 47704                                  	; FAT16 or FAT12
 47705                                  	;mov	word [HIGH_SECTOR],0
 47706 000080EE 8916[0706]              	mov	[HIGH_SECTOR],dx ; 0
 47707                                  	;mov	dx,[es:bp+11h]
 47708 000080F2 268B5611                	mov	dx,[es:bp+DPB.DIR_SECTOR]
 47709 000080F6 EB0C                    	jmp     short sharev_2
 47710                                  sharev_1:
 47711                                  	;mov	dx,[es:bp+2Bh]
 47712 000080F8 268B562B                	mov	dx,[es:bp+DPB.FCLUS_FSECTOR+2]
 47713 000080FC 8916[0706]              	mov	[HIGH_SECTOR],dx
 47714                                  	;mov	dx,[es:bp+29h]
 47715 00008100 268B5629                	mov	dx,[es:bp+DPB.FCLUS_FSECTOR]
 47716                                  sharev_2: 
 47717                                  	;;;
 47718 00008104 E8F3DB                  	call	HARDERR
 47719                                  ; 01/07/2024
 47720                                  %if 0
 47721                                  	POP	DI
 47722                                  	POP	ES
 47723                                  	POP	DS
 47724                                  	CMP	AL,1
 47725                                  	jz	short shchk_retn	; 1 = retry, carry clear
 47726                                  	STC
 47727                                  	retn
 47728                                  %else
 47729 00008107 EBAD                    	jmp	short sharev_3
 47730                                  %endif
 47731                                  
 47732                                  ;----------------------------------------------------------------------------
 47733                                  ;   ShareEnd - terminate sharing info on a particular SFT/UID/PID. This does
 47734                                  ;       NOT perform a close, it merely asserts that the sharing information
 47735                                  ;       for the SFT/UID/PID may be safely released.
 47736                                  ;
 47737                                  ;   Inputs:     ES:DI points to an SFT
 47738                                  ;   Outputs:    None
 47739                                  ;   Registers modified: all except DS,ES,DI
 47740                                  ;----------------------------------------------------------------------------
 47741                                  
 47742                                  ShareEnd:
 47743                                  	; 26/07/2019
 47744 00008109 FF1E[9800]              	call	far [JShare+(2*4)]	; 2 = MFTClose
 47745 0000810D C3                      	retn
 47746                                  
 47747                                  ;Break <ShareEnter - attempt to enter a node into the sharing set>
 47748                                  ;----------------------------------------------------------------------------
 47749                                  ;   ShareEnter - perform a retried entry of a nodde into the sharing set. If
 47750                                  ;   the max number of retries is exceeded, we notify the user via int 24.
 47751                                  ;
 47752                                  ;   Inputs:     ThisSFT points to the SFT
 47753                                  ;               WFP_Start points to the WFP
 47754                                  ;   Outputs:    Carry clear => successful entry
 47755                                  ;               Carry set => failed system call
 47756                                  ;   Registers modified: all
 47757                                  ;----------------------------------------------------------------------------
 47758                                  
 47759                                  ShareEnter:
 47760 0000810E 51                      	push	cx
 47761                                  retry:
 47762 0000810F 8B0E[1A00]              	mov     cx,[RetryCount]
 47763                                  attempt:
 47764 00008113 C43E[9E05]              	les     di,[THISSFT]		; grab sft
 47765 00008117 31C0                    	XOR     AX,AX
 47766                                   	;mov	[es:di+51],ax
 47767 00008119 26894533                	MOV     [ES:DI+SF_ENTRY.sf_MFT],AX ; indicate free SFT
 47768 0000811D 51                      	push	cx
 47769 0000811E E8ABFF                  	call    SHARE_CHECK             ; attempt to enter into the sharing set
 47770 00008121 59                      	pop	cx
 47771 00008122 730A                    	jnc	short done		; success, let the user see this
 47772 00008124 E89A96                  	call	Idle                    ; wait a while
 47773 00008127 E2EA                    	loop    attempt                 ; go back for another attempt
 47774 00008129 E8A5FF                  	call    SHARE_VIOLATION         ; signal the problem to the user
 47775 0000812C 73E1                    	jnc	short retry		; user said to retry, go do it
 47776                                  done:
 47777 0000812E 59                      	pop	cx
 47778 0000812F C3                      	retn
 47779                                  
 47780                                  ;============================================================================
 47781                                  ; EXEPATCH.ASM (MSDOS 6.0, 1991)
 47782                                  ;============================================================================
 47783                                  ; 29/04/2019 - Retro DOS 4.0
 47784                                  ; 20/03/2024 - Retro DOS 5.0
 47785                                  
 47786                                  ;** EXEPATCH.ASM 
 47787                                  ;----------------------------------------------------------------------------
 47788                                  ;	Contains the foll:
 47789                                  ;
 47790                                  ;		- code to find and overlay buggy unpack code
 47791                                  ;		- new code to be overlayed on buggy unpack code 
 47792                                  ;		- old code sequence to identify buggy unpack code
 47793                                  ;
 47794                                  ;	Revision history:
 47795                                  ;
 47796                                  ;		Created: 5/14/90
 47797                                  ;----------------------------------------------------------------------------
 47798                                  
 47799                                  ;----------------------------------------------------------------------------
 47800                                  ;
 47801                                  ; M020 : Fix for rational bug - for details see routine header
 47802                                  ; M028 : 4b04 implementation
 47803                                  ; M030 : Fixing bug in EXEPACKPATCH (EXEC_CS is an un-relocated value)
 47804                                  ; M032 : set turnoff bit only if DOS in HMA.
 47805                                  ; M033 : if IP < 2 then not exepacked.
 47806                                  ; M046 : support for a 4th version of exepacked files.
 47807                                  ; M068 : support for copy protected apps.
 47808                                  ; M071 : use A20OFF_COUNT of 10.
 47809                                  ;
 47810                                  ;----------------------------------------------------------------------------
 47811                                  
 47812                                  PATCH1_COM_OFFSET	EQU	06CH
 47813                                  PATCH1_OFFSET		EQU	028H
 47814                                  PATCH1_CHKSUM		EQU	0EF4EH
 47815                                  CHKSUM1_LEN		EQU	11CH/2 ; 142
 47816                                  
 47817                                  PATCH2_COM_OFFSET	EQU	076H
 47818                                  PATCH2_OFFSET		EQU	032H
 47819                                  
 47820                                  	; The strings that start at offset 076h have two possible 
 47821                                  	; check sums that are defined as PATCH2_CHKSUM PATCH2A_CHKSUM
 47822                                  
 47823                                  PATCH2_CHKSUM		EQU	78B2H
 47824                                  CHKSUM2_LEN		EQU	119H/2
 47825                                  PATCH2A_CHKSUM		EQU	1C47H		; M046
 47826                                  CHKSUM2A_LEN		EQU	103H/2		; M046
 47827                                  
 47828                                  PATCH3_COM_OFFSET	EQU	074H
 47829                                  PATCH3_OFFSET		EQU	032H
 47830                                  PATCH3_CHKSUM		EQU	4EDEH
 47831                                  CHKSUM3_LEN		EQU	117H/2
 47832                                  
 47833                                  ;**	Data structure passed for ExecReady call
 47834                                  ;
 47835                                  ;struc ERStruc
 47836                                  ; .ER_Reserved:	resw	1	; reserved, should be zero
 47837                                  ; .ER_Flags:	resw	1
 47838                                  ; .ER_ProgName:	resd	1	; ptr to ASCIIZ str of prog name
 47839                                  ; .ER_PSP:	resw	1	; PSP of the program
 47840                                  ; .ER_StartAddr: resd	1	; Start CS:IP of the program
 47841                                  ; .ER_ProgSize:	resd	1	; Program size including PSP
 47842                                  ; .size:
 47843                                  ;endstruc
 47844                                  
 47845                                  ;DOSCODE SEGMENT
 47846                                  
 47847                                  	; 22/05/2019 - Retro DOS v4.0
 47848                                  	; DOSCODE:B3DDh (MSDOS 6.21, MSDOS.SYS)
 47849                                  
 47850                                  	; 04/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 47851                                  	; DOSCODE:B37Ah (MSDOS 5.0, MSDOS.SYS)
 47852                                  
 47853                                  	; 20/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 47854                                  	; DOSCODE:C697h (PCDOS 7.1, IBMDOS.COM)
 47855                                  
 47856                                  ; M028 - BEGIN
 47857                                  
 47858                                  ;--------------------------------------------------------------------------
 47859                                  ;
 47860                                  ;	Procedure Name		: ExecReady
 47861                                  ;
 47862                                  ;	Input			: DS:DX -> ERStruc (see exe.inc)
 47863                                  ;
 47864                                  ;--------------------------------------------------------------------------
 47865                                  
 47866                                  ExecReady:
 47867 00008130 89D6                    	mov	si,dx			; move the pointer into a friendly one
 47868                                  	;;test	word [si+2],1
 47869                                  	; 17/12/2022
 47870 00008132 F6440201                	test	byte [si+ERStruc.ER_Flags],ER_EXE ; 1
 47871                                  	;test	word [si+ERStruc.ER_Flags],ER_EXE ; COM or EXE ?
 47872 00008136 7418                    	jz	short er_setver		; only setver for .COM files
 47873                                  
 47874                                  	;mov	ax,[si+8]
 47875 00008138 8B4408                  	mov	ax,[si+ERStruc.ER_PSP]
 47876 0000813B 83C010                  	add	ax,10h
 47877 0000813E 8EC0                    	mov	es,ax
 47878                                  
 47879                                  	;mov	cx,[si+10]
 47880 00008140 8B4C0A                  	mov	cx,[si+ERStruc.ER_StartAddr]   ; M030
 47881                                  	;mov	ax,[si+12]	; 11/04/2024
 47882 00008143 8B440C                  	mov	ax,[si+ERStruc.ER_StartAddr+2] ; M030
 47883                                  
 47884                                  	;call	[ss:FixExePatch]
 47885 00008146 36FF16[670D]            	call	word [ss:FixExePatch] ; 28/12/2022
 47886                                  	
 47887                                  	; 20/03/2024
 47888                                  	; 04/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 47889 0000814B 36FF16[4A12]            	call	word [ss:Rational386PatchPtr]
 47890                                  
 47891                                  er_setver:
 47892                                  	;;test	word [si+2],2		; Q: is this an overlay
 47893                                  	; 17/12/2022
 47894 00008150 F6440202                	test	byte [si+ERStruc.ER_Flags],ER_OVERLAY ; 2
 47895                                  	;test	word [si+ERStruc.ER_Flags],ER_OVERLAY
 47896 00008154 7518                    	jnz	short er_chkdoshi	; Y: set A20OFF_COUNT if DOS high
 47897                                  					; N: set up lie version first
 47898 00008156 1E                      	push	ds
 47899 00008157 56                      	push	si
 47900                                  	;lds	si,[si+4]
 47901 00008158 C57404                  	lds	si,[si+ERStruc.ER_ProgName]
 47902 0000815B E8DCEC                  	call	Scan_Execname1
 47903 0000815E E8EDEC                  	call	Scan_Special_Entries
 47904 00008161 5E                      	pop	si
 47905 00008162 1F                      	pop	ds
 47906                                  	;mov	es,[si+8]
 47907 00008163 8E4408                  	mov	es,[si+ERStruc.ER_PSP]
 47908 00008166 36A1[BB0E]              	mov	ax,[ss:SPECIAL_VERSION]
 47909                                  	;mov	[es:40h],ax ; 11/04/2024
 47910 0000816A 26A34000                	mov	[es:PDB.Version],ax
 47911                                  
 47912                                  er_chkdoshi:
 47913 0000816E 36803E[660D]00          	cmp	byte [ss:DosHasHMA],0	; M032: Q: is dos in HMA (M021)
 47914 00008174 741E                    	je	short er_done		; M032: N: done
 47915                                  
 47916                                  					; M068 - Start
 47917                                  	;mov	ax,[si+8]
 47918 00008176 8B4408                  	mov	ax,[si+ERStruc.ER_PSP]	; ax = PSP
 47919                                  
 47920                                  	;or	byte [ss:DOS_FLAG],4
 47921 00008179 36800E[8600]04          	or	byte [ss:DOS_FLAG],EXECA20OFF ; Set bit to signal int 21
 47922                                  					; ah = 25 & ah= 49. See dossym.inc 
 47923                                  					; under TAG M003 & M009 for 
 47924                                  					; explanation
 47925                                  	;;test	word [si+2],1
 47926                                  	; 17/12/2022
 47927 0000817F F6440201                	test	byte [si+ERStruc.ER_Flags],ER_EXE ; 1
 47928                                  	;test	word [si+ERStruc.ER_Flags],ER_EXE ; Q: COM file
 47929 00008183 7506                    	jnz	short er_setA20		; N: inc a20off_count, set 
 47930                                  					;    a20off_psp and ret
 47931                                     	; 07/03/2025
 47932                                  	;push	ds
 47933                                  	;mov	ds,ax			; DS = load segment of com file.
 47934                                  	;call	IsCopyProt ; !*!	; check if copy protected
 47935                                  	;pop	ds
 47936                                  
 47937                                  	; 07/03/2025 (MiniDOS 1.0)
 47938 00008185 36C606[8500]0A          	mov	byte [ss:A20OFF_COUNT],0Ah ; *!*
 47939                                  
 47940                                  er_setA20:
 47941                                  	; We need to inc the A20OFF_COUNT here. Note that if the count
 47942                                  	; is non-zero at this point it indicates that the A20 is to be 
 47943                                  	; turned off for that many int 21 calls made by the app. In 
 47944                                  	; addition the A20 has to be turned off when we exit from this 
 47945                                  	; call. Hence the inc.
 47946                                  
 47947 0000818B 36FE06[8500]            	inc	byte [ss:A20OFF_COUNT]		
 47948 00008190 36A3[6300]              	mov	[ss:A20OFF_PSP],ax	; set the PSP for which A20 is to be
 47949                                  					; turned OFF.
 47950                                  er_done:				; M068 - End
 47951 00008194 31C0                    	xor	ax,ax
 47952 00008196 C3                      	retn
 47953                                  
 47954                                  ; M028 - END
 47955                                  
 47956                                  
 47957                                  ; 06/08/2018 - Retro DOS v3.0
 47958                                  ;============================================================================
 47959                                  ; MSINIT.ASM
 47960                                  ;============================================================================
 47961                                  ; 22/04/2019 - Retro DOS v4.0 (MSINIT.ASM, MSDOS 6.0, 1991)
 47962                                  ;
 47963                                  ; MAIN ENTRY FOR DOS INITIALIZATION
 47964                                  ;
 47965                                  	; 15/07/2018 - Retro DOS v3.0
 47966                                  	; (MSDOS 3.3, IBMDOS.COM, 1987)
 47967                                  
 47968                                  ; temp iret instruction
 47969                                  
 47970                                  ; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 47971                                  ; DOSCODE:B76Ah (MSDOS 5.0, MSDOS.SYS)
 47972                                  
 47973                                  initiret: ; MSDOS 6.0
 47974                                  SYSBUF:
 47975                                  ;IRETT: ; 06/05/2019
 47976 00008197 CF                      	iret
 47977                                  
 47978                                  ; 22/04/2019 - Retro DOS v4.0
 47979                                  
 47980                                  ; pointer to the BIOS data segment that will be available just to the
 47981                                  ; initialization code
 47982                                  
 47983 00008198 7000                    InitBioDataSeg:	dw 70h ; KERNEL_SEGMENT = 0070h
 47984                                  
 47985                                  ; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 47986                                  ; DOSCODE:B76Dh (MSDOS 5.0, MSDOS.SYS)
 47987                                  
 47988                                  ; 22/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 47989                                  ; DOSCODE:CCE1h (PCDOS 7.1 IBMDOS.COM)
 47990                                  
 47991                                  ; Convert AX from a number of bytes to a number of paragraphs (round up).
 47992                                  
 47993                                  ParaRound:
 47994 0000819A 83C00F                  	add	ax, 15
 47995 0000819D D1D8                    	rcr	ax, 1
 47996 0000819F D1E8                    	shr	ax, 1
 47997 000081A1 D1E8                    	shr	ax, 1
 47998 000081A3 D1E8                    	shr	ax, 1
 47999 000081A5 C3                      	retn
 48000                                  
 48001                                  ; ---------------------------------------------------------------------------
 48002                                  
 48003                                  ; 22/03/2024 - Retro DOS v5.0
 48004                                  %if 1
 48005                                  ; 28/12/2022 - Retro DOS v4.1
 48006                                  ;%if 0
 48007                                  
 48008                                  ;----------------------------------------------------------------------------
 48009                                  ;
 48010                                  ; Procedure Name : WhatCPUType
 48011                                  ;
 48012                                  ; Inputs	 : none
 48013                                  ;
 48014                                  ; Outputs	 : AL = 0 if CPU <  286
 48015                                  ;		      = 1 if CPU == 286
 48016                                  ;		      = 2 if CPU >= 386
 48017                                  ;
 48018                                  ; Regs. Mod.	 : AX
 48019                                  ;
 48020                                  ;----------------------------------------------------------------------------
 48021                                  
 48022                                  WhatCPUType:
 48023                                  	; 25/04/2019 - Retro DOS v4.0
 48024                                  	;get_cpu_type	; done with a MACRO which can't be generated > once
 48025                                  
 48026                                  	;CPUTYPE.INC (MSDOS 6.0, 1991)
 48027                                  
 48028                                  ; Note: this must be a macro, and not a subroutine in the BIOS since
 48029                                  ; 	it is called from both CODE and SYSINITSEG.
 48030                                  ;
 48031                                  ;------GET_CPU_TYPE-----------------------------------May, 88 by M.Williamson
 48032                                  ;  Returns: AX = 0 if 8086 or 8088
 48033                                  ;              = 1 if 80286
 48034                                  ;              = 2 if 80386
 48035                                  
 48036                                  	; 04/11/2022
 48037                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:0BB03h
 48038                                  
 48039                                  	; 22/03/2024
 48040                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0CCEDh
 48041                                  
 48042                                  Get_CPU_Type:	;macro
 48043 000081A6 9C                      	pushf
 48044 000081A7 53                      	push	bx			; preserve bx
 48045 000081A8 31DB                    	xor	bx,bx			; init bx to zero
 48046                                  
 48047 000081AA 31C0                    	xor	ax,ax			; 0000 into AX
 48048 000081AC 50                      	push	ax			; put it on the stack...
 48049 000081AD 9D                      	popf				; ...then shove it into the flags
 48050 000081AE 9C                      	pushf				; get it back out of the flags...
 48051 000081AF 58                      	pop	ax			; ...and into ax
 48052 000081B0 2500F0                  	and	ax,0F000h		; mask off high four bits
 48053 000081B3 3D00F0                  	cmp	ax,0F000h		; was it all 1's?
 48054 000081B6 740E                    	je	short cpu_8086		; aye; it's an 8086 or 8088
 48055                                  
 48056 000081B8 B800F0                  	mov	ax,0F000h		; now try to set the high four bits..
 48057 000081BB 50                      	push	ax
 48058 000081BC 9D                      	popf
 48059 000081BD 9C                      	pushf
 48060 000081BE 58                      	pop	ax			; ...and see what happens
 48061 000081BF 2500F0                  	and	ax,0F000h		; any high bits set ?
 48062 000081C2 7401                    	jz	short cpu_286		; nay; it's an 80286
 48063                                  cpu_386:				; bx starts as zero
 48064 000081C4 43                      	inc	bx			; inc twice if 386
 48065                                  cpu_286:				; just inc once if 286
 48066 000081C5 43                      	inc	bx
 48067                                  cpu_8086:				; don't inc at all if 086
 48068 000081C6 89D8                    	mov	ax,bx			; put CPU type value in ax
 48069 000081C8 5B                      	pop	bx			; restore original bx
 48070 000081C9 9D                      	popf
 48071                                  	
 48072                                  	;endm
 48073                                  
 48074                                  	; 04/11/2022 (MSDOS 5.0 MSDOS.SYS)
 48075 000081CA C3                      	retn	; 19/09/2023
 48076                                  
 48077                                  ; ---------------------------------------------------------------------------
 48078                                  %endif	; 28/12/2022
 48079                                  
 48080                                  ;============================================================================
 48081                                  
 48082                                  ; MAIN ENTRY FOR DOS INITIALIZATION
 48083                                  
 48084                                  	; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 48085                                  	; DOSCODE:B779h (MSDOS 5.0 MSDOS.SYS)
 48086                                  
 48087                                  	; 23/03/2024
 48088                                  	; 22/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 48089                                  	; DOSCODE:CCEDh (PCDOS 7.1 IBMDOS.COM)
 48090                                  
 48091                                  	; DOSCODE:BA57h (MSDOS 6.22 MSDOS.SYS)
 48092                                  	; BIOSCODE:CF81h (Windows ME IO.SYS)
 48093                                  	
 48094                                  	; 30/05/2019
 48095                                  	; 22/04/2019 - Retro DOS v4.0
 48096                                  	; 07/07/2018 - Retro DOS v3.0
 48097                                  	; Retro DOS v2.0 - 03/03/2018
 48098                                  	; 03/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 48099                                  	; MSDOS 5.0 - MSDOS.SYS, offset 79A9h
 48100                                  DOSINIT:
 48101                                  	; MSDOS 6.21 - MSDOS.SYS, offset 7C77h
 48102                                  	;
 48103                                  	; Far call from SYSINIT
 48104                                  	; DX = Memory size in paragraphs
 48105                                  	; DS:SI = [DEVICE_LIST] (SYSINIT.S) 
 48106                                  	;	  (Retro DOS v2.0, 16/03/2018)
 48107                                  	;
 48108                                  	; ES:DI = ptr to BIOS communication block (sysinit3.s)
 48109                                  	;	  (Retro DOS v4.0, 20/04/2019)
 48110                                  
 48111 000081CB FA                              CLI
 48112 000081CC FC                              CLD
 48113                                  
 48114                                  	; 03/11/2022
 48115                                  	;push	dx ; 30/05/2019		; save parameters from BIOS
 48116                                  	
 48117                                  	; 17/12/2022
 48118                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48119                                  	;push	dx ; =*=		; save parameters from BIOS
 48120                                  	
 48121 000081CD 56                      	push	si
 48122 000081CE 1E                      	push	ds
 48123 000081CF 57                      	push	di			;save di (ptr to BiosComBlock)
 48124                                  
 48125 000081D0 8CC3                    	mov	bx,es			;bx:di = ptr to BiosComBlock
 48126                                  
 48127                                  ; First, move the DOS data segment to its final location in low memory
 48128                                  
 48129                                  	;;;mov	ax,0BF69h ; MSDOS 6.21 MSDOS.SYS, file offset 7C7Fh
 48130                                  	;;mov	ax,0BC77h ; MSDOS 5.0 MSDOS.SYS, file offset 79B1h
 48131                                  	; 22/03/2024
 48132                                  	;mov	ax,0D20Fh ; PCDOS 7.1 IBMDOS.COM, file offset 92FFh
 48133 000081D2 B8[4286]                	mov	ax,MEMSTRT		; get offset of end of init code
 48134                                  
 48135                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48136 000081D5 83C00F                  	add	ax,15			; round to nearest paragraph
 48137                                  	;and	ax,~15	; 0FFF0h	; boundary
 48138                                  	; 12/04/2024
 48139 000081D8 24F0                    	and	al,0F0h
 48140                                  
 48141 000081DA 89C6                    	mov	si,ax			; si = offset of DOSDATA in current
 48142                                  					; code segment
 48143                                  	; 05/12/2022
 48144                                  	; 30/04/2019 - Retro DOS v4.0
 48145                                  	;xor	si,si
 48146                                  	
 48147                                  	;mov	ax,cs
 48148                                  	;mov	ds,ax			; ds = current code segment
 48149                                  					; DS:SI now points to dosdata
 48150                                  	; 22/03/2024
 48151 000081DC 0E                      	push	cs
 48152 000081DD 1F                      	pop	ds
 48153                                  
 48154                                  	;mov	es,[cs:0BA49h] ; MSDOS 6.21 IO.SYS, offset 7C8Eh 
 48155                                  	;mov	es,[cs:InitBioDataSeg]	; First access to DosDataSg in
 48156                                  					;  BData segment. Cannot use
 48157                                  					;  getdseg macro here!!!
 48158                                  	; 17/12/2022
 48159 000081DE 8E06[9881]              	mov	es,[InitBioDataSeg]
 48160                                  	; 07/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48161                                  	;mov	es,[cs:InitBioDataSeg]  ; ds = cs !
 48162                                  
 48163                                  	;mov	es,[es:3]
 48164 000081E2 268E060300              	mov	es,[es:DosDataSg]	; Get free location in low memory
 48165                                  
 48166 000081E7 31FF                    	xor	di,di			; ES:DI now points to RAM data
 48167                                  
 48168                                  	;mov	cx,4970  ; Offset 0BA78h in MSDOS 6.21 MSDOS.SYS)
 48169                                  	;mov	cx,4976  ; 25/05/2019
 48170                                  	; 22/03/2024
 48171                                  	;mov	cx,4934	 ; PCDOS 7.1 IBMDOS.COM
 48172                                  	; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 48173                                  	;mov	cx,4962
 48174                                  	;mov	cx,MSDAT001E		; get end of dosdata = size of dosdata
 48175 000081E9 B94C12                  	mov	cx,DOSDATASIZE	; = 4962 for MSDOS 5.0 MSDOS.SYS
 48176                                  				; = 4934 for PCDOS 7.1 IBMDOS.COM ; 01/07/2024
 48177 000081EC F3A4                    	rep	movsb			; move data to final location
 48178                                  	
 48179 000081EE 5F                      	pop	di			; restore ptr to BiosComBlock
 48180 000081EF 1F                      	pop	ds			; restore parms from BIOS
 48181 000081F0 5E                      	pop	si
 48182                                  	; 17/12/2022
 48183                                  	;pop	dx ; 30/05/2019	
 48184                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48185                                  	;pop	dx ; =*=
 48186                                  
 48187 000081F1 06                      	push	es
 48188 000081F2 1E                      	push	ds
 48189 000081F3 07                      	pop	es			; es:si -> device chain
 48190 000081F4 1F                      	pop	ds			; ds points to dosdata
 48191                                  
 48192                                  ;SR;
 48193                                  ;We get a ptr to the BIOS exchange data block. This has been setup right 
 48194                                  ;now so that the EXEC call knows when SysInit is present to do the special
 48195                                  ;lie table handling for device drivers. This can be expanded later on to
 48196                                  ;establish a communication block from the BIOS to the DOS.
 48197                                  
 48198                                  	;mov	[1040h],di	; Offset 0BA87h in MSDOS 6.21 MSDOS.SYS)
 48199                                  	;mov	[1042h],bx
 48200 000081F5 893E[2F12]              	mov	[BiosDataPtr],di
 48201 000081F9 891E[3112]              	mov	[BiosDataPtr+2],bx	; save ptr to BiosComBlock
 48202                                  
 48203 000081FD 2E8C1E[0700]            	mov	[cs:DosDSeg],ds		; set pointer to dosdata in code seg
 48204                                  
 48205                                  	; Set the segment of Lowint23/24/28Addr in msctrlc.asm to dosdata
 48206                                  
 48207 00008202 2E8C1E[9F5A]            	mov	[cs:LowInt23Addr+2],ds	; set pointers in code seg
 48208 00008207 2E8C1E[A35A]            	mov	[cs:LowInt24Addr+2],ds
 48209 0000820C 2E8C1E[A75A]            	mov	[cs:LowInt28Addr+2],ds
 48210                                  
 48211                                  	;mov	[346h],dx	; MSDOS 6.21 DOSDATA addresses
 48212                                  	;mov	[584h],sp
 48213                                  	;mov	[586h],ss
 48214 00008211 8916[4603]                  	mov	[ENDMEM],dx	; =*=
 48215 00008215 8926[8405]              	mov	[USER_SP],sp
 48216 00008219 8C16[8605]              	mov	[USER_SS],ss
 48217                                  
 48218                                  	;mov	ax,ds		; set up ss:sp to dosdata:dskstack
 48219                                  	;mov	ss,ax
 48220                                  	; 01/07/2024
 48221 0000821D 1E                      	push	ds
 48222 0000821E 17                      	pop	ss
 48223                                  
 48224                                  	;mov	sp,920h		; MSDOS 6.21 DOSDATA address
 48225                                  	;mov	sp,offset dosdata:dskstack
 48226 0000821F BC[2009]                	mov	sp,DSKSTACK	; 920h ; PCDOS 7.1 IBMDOS.COM ; 22/03/2024
 48227                                  
 48228                                  ;M023
 48229                                  ; Init patch ptrs to default values
 48230                                  
 48231                                  ; 22/03/2024
 48232                                  %if 0
 48233                                  	;mov	word [1212h],RetExePatch
 48234                                  	;mov	word [1214h],RetExePatch
 48235                                  	;mov	word [61h],RetExePatch
 48236                                  	mov	word [FixExePatch],RetExePatch	; M023
 48237                                  	; 28/12/2022 - Retro DOS v4.1
 48238                                  	;mov	word [RationalPatchPtr],RetExePatch ; M023
 48239                                  	mov	word [ChkCopyProt],RetExePatch	; M068
 48240                                  ; 07/03/2025
 48241                                  ;%else
 48242                                  	; 22/03/2024 (PCDOS 7.1 IBMDOS.COM)
 48243                                  	;;;	
 48244                                  	mov	ax,RetExePatch
 48245                                  	mov	[FixExePatch],ax
 48246                                  	mov	[RationalPatchPtr],ax ; 25/03/2024
 48247                                  	mov	[ChkCopyProt],ax
 48248                                  	;;;
 48249                                  %endif
 48250                                  
 48251                                  ; 07/03/2025
 48252                                  ; 22/03/2024
 48253                                  %if 0
 48254                                  ; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48255                                  ;%if 0	; 19/09/2023
 48256                                  
 48257                                  ; Setup to call 386 Rational DOS Extender patch routine if running on
 48258                                  ; a 386 or later. Unlike other patches, this is not dependent on MS-DOS
 48259                                  ; running in the HMA.
 48260                                  
 48261                                  	call	WhatCPUType	; get cpu type (0 < 286,1==286,2 >= 386)
 48262                                  	cmp	al,2		;   386 or later?
 48263                                  	mov	ax,Rational386Patch
 48264                                  	jae	short di_set_patch
 48265                                  	mov	ax,RetExePatch	; < 386, don't need this patch
 48266                                  di_set_patch:
 48267                                  	mov	[Rational386PatchPtr],ax ; patch routine or RET instr.
 48268                                  
 48269                                  %endif
 48270                                  	; Set up the variable temp_dosloc to point to the dos code segment
 48271                                  
 48272 00008222 8CC8                    	mov	ax,cs		; ax = current segment of DOS code
 48273                                  
 48274                                  	; ax now holds segment of DOS code
 48275 00008224 A3[A30A]                	mov	[TEMP_DOSLOC],ax   ; store temp location of DOS
 48276                                  
 48277 00008227 8C06[4A00]              	mov	word [NULDEV+2],es ; nuldev -> points to device chain
 48278 0000822B 8936[4800]              	mov	word [NULDEV],si
 48279                                  ;SR;
 48280                                  ; There are some locations in the Win386 instance data structures
 48281                                  ; which need to be set up with the DOS data segment. First, initialize
 48282                                  ; the segment part of the instance table pointer in the SIS.
 48283                                  
 48284                                  	;;mov	[0FF2h],ds ; [Win386_Info+14+2]
 48285                                  	;mov	[0EF1h],ds ; PCDOS 7.1 IBMDOS.COM ; 22/03/2024
 48286 0000822F 8C1E[F10E]              	mov	[Win386_Info+Win386_SIS.Instance_Data_Ptr+2],ds
 48287                                  
 48288                                  ; Now initialize the segment part of the pointer to the data in each
 48289                                  ; instance table entry.
 48290                                  
 48291 00008233 56                      	push	si		; preserve pointer to device chain
 48292                                  	; 18/12/2022
 48293                                  	; cx = 0
 48294 00008234 B107                    	mov	cl,7
 48295                                  	;mov	cx,7		; There are 7 entries in the instance table
 48296                                  				; M019
 48297                                  	;;mov	si,0FF6h ; offset (dosdata:Instance_Table+2)
 48298                                  	;mov	si,0EF9h ; PCDOS 7.1 IBMDOS.COM ; 22/03/2024
 48299 00008236 BE[F50E]                	mov	si,Instance_Table+2 ; point si to segment field
 48300                                  Instance_init_loop:
 48301 00008239 8C1C                    	mov	[si],ds		; set offset in instance entry
 48302                                  	;add	si,6
 48303 0000823B 83C606                  	add	si,size_of_Win386_IIS ; move on to next entry
 48304 0000823E E2F9                    	loop	Instance_init_loop
 48305                                  
 48306                                  ;Initialize the WIN386 2.xx instance table with the DOS data segment value
 48307                                  
 48308                                  	; 18/12/2022
 48309 00008240 B105                    	mov	cl,5
 48310                                  	;mov	cx,5		; There are five entries in the instance table
 48311                                  
 48312                                  	;mov	si,(offset dosdata:OldInstanceJunk) + 6
 48313                                  	;;mov	si,11EDh	; point si to segment field
 48314                                  	;mov	si,1102h ; PCDOS 7.1 IBMDOS.COM ; 22/03/2024
 48315 00008242 BE[D610]                	mov	si,OldInstanceJunk+6
 48316                                  OldInstance_init_loop:
 48317 00008245 8C1C                    	mov	[si],ds		; set offset in instance entry
 48318 00008247 83C606                  	add	si,6		; move on to next entry
 48319 0000824A E2F9                    	loop	OldInstance_init_loop
 48320 0000824C 5E                      	pop	si		; restore pointer to device chain
 48321                                  
 48322                                  ; End of WIN386 2.xx compatibility bullshit
 48323                                  
 48324                                  ; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48325                                  %if 0	
 48326                                     	; 30/04/2019
 48327                                  	;push	es
 48328                                  	;pop	ds
 48329                                  			; ds:si points to console device
 48330                                  
 48331                                  	; 24/04/2019 - Retro DOS v4.0
 48332                                  
 48333                                  	; 15/07/2018
 48334                                  	; MSDOS 3.3 (IBMDOS.COM, 1987)
 48335                                  	; (Set INT 2Ah handler address to an 'IRET')
 48336                                  
 48337                                  	; need crit vector inited to use deviocall
 48338                                  	;push	ds			; preserve segment of device chain
 48339                                  	push	es ; 30/04/2019
 48340                                  
 48341                                  %endif
 48342                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48343 0000824D 06                      	push	es
 48344                                  	; 17/12/2022
 48345                                  	;pop	ds
 48346                                  	;push	ds
 48347                                  
 48348 0000824E 31C0                    	xor	ax,ax
 48349 00008250 8ED8                    	mov	ds,ax			; point DS to int vector table
 48350 00008252 B8[9781]                	mov	ax,initiret
 48351                                  	;mov	[0A8h],ax  ; [2Ah*4]
 48352 00008255 A3A800                  	mov	[addr_int_ibm],ax
 48353 00008258 8CC8                    	mov	ax,cs
 48354                                  	;mov	[0AAh],ax  ; [(2Ah*4)+2]
 48355 0000825A A3AA00                  	mov	[addr_int_ibm+2],ax
 48356 0000825D 1F                      	pop	ds			; restore segment of device chain
 48357                                  
 48358 0000825E E84002                  	call	CHARINIT  		; initialize console driver
 48359 00008261 56                      	push	si			; save pointer to header
 48360                                  
 48361 00008262 16                      	push	ss			; move pointer to dos data...
 48362 00008263 07                      	pop	es			; ...into ES
 48363                                  
 48364                                  	;initialize sft for file 0 (CON)
 48365                                  
 48366                                          ; 07/07/2018 - Retro DOS v3.0
 48367                                  	; 24/04/2019 - Retro DOS v4.0
 48368                                  	;mov	di,SFTABL+6 		; SFT0_SFTable ; 22/03/2024
 48369 00008264 BF[D200]                	MOV	DI,SFTABL+SFT.SFTable	; Point to sft 0
 48370 00008267 B80300                  	MOV	AX,3
 48371 0000826A AB                      	STOSW           	; Refcount
 48372                                          ;DEC	AL
 48373                                  	; 22/03/2024 - Retro DOS v5.0
 48374 0000826B 48                      	dec	ax
 48375 0000826C AB                      	STOSW			; Access rd/wr, compatibility
 48376 0000826D 30C0                    	XOR	AL,AL
 48377 0000826F AA                      	STOSB           	; attribute
 48378                                  	;mov	al,0C3h
 48379 00008270 B0C3                    	mov	al,devid_device_EOF|devid_device|ISCIN|ISCOUT
 48380 00008272 AB                      	STOSW			; flags
 48381 00008273 89F0                    	mov	ax,si
 48382 00008275 AB                      	stosw			; device pointer in devptr
 48383 00008276 8CD8                    	mov	ax,ds
 48384 00008278 AB                      	stosw
 48385 00008279 31C0                    	xor	ax,ax	; 0
 48386                                  
 48387                                  ; 22/03/2024
 48388                                  %if 0
 48389                                  	stosw			; firclus
 48390                                  	stosw			; time
 48391                                  	stosw			; date
 48392                                  	dec	ax	; -1
 48393                                  	stosw			; size
 48394                                  	stosw
 48395                                  	inc	ax	; 0
 48396                                  	stosw			; position
 48397                                  	stosw
 48398                                  %else
 48399                                  	; 22/03/2024 (PCDOS 7.1 IBMDOS.COM)
 48400                                  	;;;
 48401 0000827B 83C720                  	add	di,32		; SFTABL+SFT.SFTable + 43
 48402 0000827E AB                      	stosw			; SFT0_SFTable + 43 ; .sf_fclus32
 48403 0000827F AB                      	stosw			; SF_ENTRY.sf_fclus32+2
 48404 00008280 83C7DE                  	add	di,-34		; 0FFDEh ; SFTABL+SFT.SFTable + 13
 48405 00008283 AB                      	stosw			; SFT0_SFTable + 13 ; .sf_time
 48406 00008284 AB                      	stosw			; SF_ENTRY.sf_date
 48407 00008285 48                      	dec	ax              ; -1
 48408 00008286 AB                      	stosw			; SFT0_SFTable + 17 ; .sf_size
 48409 00008287 AB                      	stosw			; SF_ENTRY.sf_size + 2
 48410 00008288 40                      	inc	ax		; 0
 48411 00008289 AB                      	stosw			; SFT0_SFTable + 21 ; .sf_position
 48412 0000828A AB                      	stosw			; SF_ENTRY.sf_position + 2
 48413                                  	;;;
 48414                                  %endif
 48415                                  
 48416                                  	;add	di,7		; SFT0_SFTable + 32 ; 22/03/2024
 48417 0000828B 83C707                  	add	di,SF_ENTRY.sf_name-SF_ENTRY.sf_cluspos
 48418                                  				; point at name
 48419                                  	;add	si,10
 48420 0000828E 83C60A                  	add	si,SYSDEV.NAME	; sdevname
 48421                                  				; point to name
 48422 00008291 B90400                  	mov	cx,4
 48423 00008294 F3A5                    	rep	movsw		; name
 48424 00008296 B103                    	mov	cl,3
 48425 00008298 B020                    	mov	al," "
 48426 0000829A F3AA                    	rep	stosb		; extension
 48427                                  
 48428 0000829C 5E                      	pop	si		; get back pointer to header
 48429                                  
 48430                                  				; mark device as CON I/O
 48431                                  	; 15/07/2018
 48432                                          ;OR	BYTE [SI+4],ISCIN|ISCOUT ; or byte [si+4],3
 48433 0000829D 804C0403                	OR	BYTE [SI+SYSDEV.ATT],ISCIN|ISCOUT
 48434                                  	; 12/03/2018
 48435                                  	;mov	[ss:32h],si
 48436 000082A1 368936[3200]            	MOV     [SS:BCON],SI
 48437                                  	;mov	[ss:34h],ds
 48438 000082A6 368C1E[3400]                    MOV     [SS:BCON+2],DS
 48439                                  
 48440                                  	; initialize each device until the clock device is found
 48441                                  
 48442                                  CHAR_INIT_LOOP:
 48443 000082AB C534                            LDS     SI,[SI]			; AUX device
 48444 000082AD E8F101                  	call	CHARINIT
 48445                                         	;15/07/2018
 48446                                  	;test	byte [SI+4],8
 48447 000082B0 F6440408                	TEST    BYTE [SI+SYSDEV.ATT],ISCLOCK
 48448 000082B4 74F5                            JZ      SHORT CHAR_INIT_LOOP
 48449                                  	; 12/03/2018
 48450                                  	;mov	[ss:2Eh],si
 48451 000082B6 368936[2E00]                    MOV     [SS:BCLOCK],SI
 48452                                  	;mov	[ss:30h],ds
 48453 000082BB 368C1E[3000]                    MOV     [SS:BCLOCK+2],DS
 48454                                          ;MOV	BP,MEMSTRT ; Retro DOS 3.0 ; ES:BP points to DPB
 48455                                  
 48456                                  	;mov	bp,4970			; bp = pointer to free mem
 48457                                  	;mov	bp,4976  ; 25/05/2019 - Retro DOS v4.0
 48458                                  	; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0, MSDOS.SYS)
 48459                                  	;mov	bp,4962 ; (MSDOS 5.0 MSDOS.SYS)
 48460                                  	; 22/03/2024 - Retro DOS v5.0
 48461                                  	;mov	bp,4934	; (PCDOS 7.1 IBMDOS.COM)
 48462 000082C0 BD4C12                  	mov	bp,MSDAT001E		; es:bp points to dpb area
 48463                                  
 48464 000082C3 36892E[2600]            	mov	[ss:DPBHEAD],bp		; set offset of pointer to DPB's
 48465 000082C8 368C06[2800]            	mov	[ss:DPBHEAD+2],es	; set segment of pointer to DPB's
 48466                                  
 48467                                  PERDRV:
 48468                                  	;lds	si,[SI+SYSDEV.NEXT] ; 15/07/2018
 48469 000082CD C534                            LDS	SI,[SI]			; Next device
 48470 000082CF 83FEFF                          CMP	SI,-1	; 0FFFFh
 48471                                  	;JZ	SHORT CONTINIT
 48472                                  	; 23/03/2024
 48473                                  	;;;
 48474 000082D2 7503                    	jnz	short PERDRV2
 48475 000082D4 E99C00                  	jmp     CONTINIT
 48476                                  PERDRV2:
 48477                                  	;;;
 48478                                  
 48479 000082D7 E8C701                          call	CHARINIT
 48480                                  
 48481                                  	; Retro DOS v2.0 - 16/03/2018 (NOTE for 'CHARINIT' return):
 48482                                  	; [CALLUNIT] = Number of drives for (Disk) Block Dev Driver ([DRVMAX])
 48483                                  	;           (..When the command is 'DSK$INIT', as in 'CHARINIT')
 48484                                  	; [CALLBPB] = [DEVCALL.COUNT] = Address of the BPB (DEVCALL offset 18)
 48485                                  	; (REF: MSDOS 3.3 MSBIO2.ASM, MSDATA.INC, MSDISK.ASM, MSBIO1.ASM)
 48486                                  	; (.. !DSK$IN' in MSBIO1.ASM)
 48487                                  	; DEVCALL.MEDIA = CALLUNIT (DEVCALL offset 13)
 48488                                  
 48489                                          ; 15/07/2018
 48490                                  	;test	word [SI+4],8000h		; DEVTYP
 48491                                          ; 17/12/2022
 48492                                  	;test	byte [SI+5],80h
 48493 000082DA F6440580                	test	byte [SI+SYSDEV.ATT+1],(DEVTYP>>8) ; 80h
 48494                                  	;TEST	word [SI+SYSDEV.ATT],DEVTYP ; 8000h
 48495 000082DE 75ED                    	JNZ     SHORT PERDRV			; Skip any other character devs
 48496                                  
 48497 000082E0 368A0E[6703]                    MOV	CL,[SS:CALLUNIT] ; 12/03/2018
 48498 000082E5 30ED                    	XOR     CH,CH
 48499                                          ; 07/07/2018
 48500                                  	;MOV	[SI+10],CL		; Number of units in name field
 48501 000082E7 884C0A                  	mov	[si+SYSDEV.NAME],cl	; sdevname
 48502 000082EA 368A16[4600]            	MOV     DL,[SS:NUMIO]	; 15/03/2018
 48503 000082EF 30F6                    	XOR     DH,DH
 48504 000082F1 36000E[4600]            	ADD	[SS:NUMIO],CL	; 12/03/2018
 48505 000082F6 1E                      	PUSH    DS
 48506 000082F7 56                              PUSH    SI
 48507 000082F8 36C51E[6C03]            	LDS	BX,[SS:CALLBPB]	; 12/03/2018
 48508                                  
 48509                                  PERUNIT:
 48510 000082FD 8B37                            MOV     SI,[BX]                 ; DS:SI Points to BPB
 48511 000082FF 43                              INC     BX
 48512 00008300 43                              INC     BX                      ; On to next BPB
 48513                                  	; 15/12/2022
 48514                                  	; 07/07/2018
 48515                                          ;mov	[ES:BP+DPB.DRIVE],DL
 48516 00008301 26885600                	MOV     [ES:BP],DL
 48517                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48518                                  	;;mov	[ES:BP+0],DL
 48519                                  	;mov	[ES:BP+DPB.DRIVE],DL
 48520                                  
 48521                                  	;MOV	[ES:BP+1],DH
 48522 00008305 26887601                	MOV	[ES:BP+DPB.UNIT],DH
 48523 00008309 53                              PUSH    BX
 48524 0000830A 51                              PUSH    CX
 48525 0000830B 52                              PUSH    DX
 48526                                  
 48527                                  	; 23/03/2024 (PCDOS 7.1 IBMDOS.COM)
 48528                                  	;;;
 48529 0000830C BA5241                  	mov	dx,4152h ; 'RA'	; signature ('AR') for FAT32 extended BPB/DPB
 48530 0000830F 31C9                    	xor	cx,cx  ; 0
 48531                                  	;mov	[es:bp+29],cx
 48532 00008311 26894E1D                	mov	[es:bp+DPB.NEXT_FREE],cx
 48533 00008315 394C0B                  	cmp	[si+A_BPB.SECTORSPERFAT],cx ; 16 bit FAT size = 0 ?
 48534                                  	;cmp	[si+11],cx	; BPB_FATSz16 
 48535 00008318 7514                    	jnz	short PERUNIT2	; FAT (FAT12 or FAT16) -old DPB-
 48536                                  	;mov	[es:bp+57],cx	; FAT32 -new- DPB
 48537 0000831A 26894E39                	mov	[es:bp+DPB.FAT32_NXTFREE],cx
 48538                                  	;mov	[es:bp+59],cx
 48539 0000831E 26894E3B                	mov	[es:bp+DPB.FAT32_NXTFREE+2],cx
 48540 00008322 49                      	dec	cx  ; 0FFFFh	; -1
 48541                                  	;mov	[es:bp+31],cx
 48542 00008323 26894E1F                	mov	[es:bp+DPB.FREE_CNT],cx
 48543                                  	;mov	[es:bp+33],cx
 48544 00008327 26894E21                	mov	[es:bp+DPB.FREE_CNT_HW],cx
 48545 0000832B B95845                  	mov	cx,4558h ; 'XE'	; signature ('EX') for FAT32 extended BPB/DPB
 48546                                  PERUNIT2: 
 48547                                  	;;;
 48548                                  
 48549                                          ;invoke	$SETDPB
 48550 0000832E E81191                          CALL	_$SETDPB		; build DPB!
 48551                                  
 48552                                  	; 07/07/2018
 48553                                  	;MOV	AX,[ES:BP+2]
 48554 00008331 268B4602                	mov	ax,[ES:BP+DPB.SECTOR_SIZE]
 48555                                          ; 12/03/2018
 48556 00008335 363B06[3600]            	CMP	AX,[SS:MAXSEC]		; Q:is this the largest sector so far
 48557 0000833A 7604                    	JBE     SHORT NOTMAX		; N:
 48558 0000833C 36A3[3600]              	MOV	[SS:MAXSEC],AX		; Y: save it in maxsec
 48559                                  NOTMAX:	
 48560                                  	; set the next dpb field in the currently built bpb
 48561                                  	; and mark as never accessed
 48562                                          
 48563                                  	; 24/04/2019
 48564 00008340 89E8                    	mov	ax,bp			; get pointer to DPB
 48565                                  	;;add	ax,33
 48566                                  	;add	ax,61  ; next DPB (PCDOS 7.1 DPB size = 61) ; 23/03/2024
 48567 00008342 83C03D                  	add	ax,DPBSIZ		; advance pointer to next DPB
 48568                                  					; set seg & offset of next DPB
 48569                                  	;mov	[es:bp+25],ax
 48570 00008345 26894619                	mov	[es:bp+DPB.NEXT_DPB],ax
 48571                                  	;mov	[es:bp+27],es
 48572 00008349 268C461B                	mov	[es:bp+DPB.NEXT_DPB+2],es
 48573                                  					; mark as never accessed
 48574                                  	;mov	byte [es:bp+24],0FFh
 48575 0000834D 26C64618FF              	mov	byte [es:bp+DPB.FIRST_ACCESS],-1
 48576                                  
 48577 00008352 5A                      	POP     DX
 48578 00008353 59                              POP     CX
 48579 00008354 5B                              POP     BX
 48580 00008355 8CD8                            MOV     AX,DS                   ; save segment of bpb array
 48581 00008357 5E                              POP     SI
 48582 00008358 1F                              POP     DS
 48583                                  					; ds:si -> device header
 48584                                  					; store it in the corresponding dpb
 48585                                  	; 07/07/2018
 48586                                  	;MOV	[ES:BP+19],SI ; 24/04/2019
 48587 00008359 26897613                	mov	[ES:BP+DPB.DRIVER_ADDR],si
 48588                                  	;MOV	[ES:BP+21],DS ; 24/04/2019
 48589 0000835D 268C5E15                	mov	[ES:BP+DPB.DRIVER_ADDR+2],ds
 48590                                  
 48591 00008361 1E                      	PUSH	DS			; save pointer to device header
 48592 00008362 56                      	PUSH	SI
 48593 00008363 FEC6                    	INC	DH			; inc unit #
 48594 00008365 FEC2                    	INC	DL			; inc drive #
 48595 00008367 8ED8                    	MOV	DS,AX			; restore segment of BPB array
 48596                                  	;;add	bp,33 ; 24/04/2019
 48597                                  	;add	bp,61 ; 23/03/2024 (PCDOS 7.1)
 48598 00008369 83C53D                  	ADD	BP,DPBSIZ		; advance pointer to next dpb
 48599 0000836C E28F                    	LOOP	PERUNIT			; process all units in each driver
 48600                                  
 48601 0000836E 5E                      	POP     SI			; restore pointer to device header
 48602 0000836F 1F                      	POP     DS
 48603 00008370 E95AFF                  	JMP	PERDRV			; process all drivers in chain
 48604                                  
 48605                                  CONTINIT:
 48606                                  	; 24/04/2019
 48607                                  	;;sub	bp,33			; set link in last DPB to -1
 48608                                  	;sub	bp,61 ; 23/03/2024 (PCDOS 7.1)
 48609 00008373 83ED3D                  	sub	bp,DPBSIZ		; back up to last dpb
 48610                                  					; set last link offset & segment
 48611                                  ; 23/03/2024 - Retro DOS v5.0
 48612                                  %if 0
 48613                                  	;mov	word [bp+25],0FFFFh
 48614                                  	mov	word [bp+DPB.NEXT_DPB],-1
 48615                                  	;mov	word [bp+27],0FFFFh
 48616                                  	mov	word [bp+DPB.NEXT_DPB+2],-1
 48617                                  %else
 48618                                  	; 23/03/2024 (PCDOS 7.1 IBMDOS.COM)
 48619                                  	;;;
 48620 00008376 B8FFFF                  	mov	ax,0FFFFh ; -1
 48621                                  	;mov	word [bp+25],ax
 48622 00008379 894619                  	mov	word [bp+DPB.NEXT_DPB],ax ; -1
 48623                                  	;mov	word [bp+27],ax
 48624 0000837C 89461B                  	mov	word [bp+DPB.NEXT_DPB+2],ax ; -1
 48625                                  	;;;
 48626                                  %endif
 48627                                  	;;add	bp,33
 48628                                  	;add	bp,61 ; 23/03/2024 (PCDOS 7.1)
 48629 0000837F 83C53D                  	add	BP,DPBSIZ		; advance to free memory again
 48630                                  					; the DPB chain is done.
 48631 00008382 16                      	push	ss
 48632 00008383 1F                      	pop	ds
 48633                                  
 48634 00008384 89E8                    	mov	ax,bp
 48635 00008386 E811FE                  	call	ParaRound		; round up to segment
 48636                                  
 48637 00008389 8CDA                    	mov	dx,ds			; dx = dosdata segment
 48638 0000838B 01C2                    	add	dx,ax			; dx = ds+ax first free segment
 48639                                  
 48640 0000838D BB0F00                  	mov	bx,0Fh
 48641                                  	
 48642                                  	; 24/05/2019
 48643                                  	;mov	cx,[ENDMEM]
 48644                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48645                                  	; 17/12/2022
 48646                                  	;mov	cx,[ENDMEM]
 48647                                  					; set seg inpacketto dosdata
 48648 00008390 8C1E[A203]              	mov	[DSKCHRET+3],ds ; mov [DOSSEG_INIT],ds
 48649                                  
 48650                                  ; Patch in the segments of the interrupt vectors with current code segment.
 48651                                  ; Also patch in the segment of the pointers in the dosdata area.
 48652                                  ;
 48653                                  ; Note: Formerly, temp_dosloc was initialized to -1 until after these
 48654                                  ; calls were done. The procedure patch_misc_segments is called multiple
 48655                                  ; times, and relies on temp_dosloc being initialized to -1 as a flag
 48656                                  ; for the first invocation. Thus, we must set it to -1 for this call.
 48657                                  
 48658 00008394 52                      	push	dx			; preserve first free segment
 48659                                  
 48660 00008395 A1[A30A]                	mov	ax,[TEMP_DOSLOC]	; ax = segment to patch in 
 48661 00008398 8EC0                    	mov	es,ax			; es = segment of DOS
 48662 0000839A C706[A30A]FFFF          	mov	word [TEMP_DOSLOC],-1	; -1 means first call to patch_misc_segments
 48663                                  
 48664 000083A0 E89C01                  	call	patch_vec_segments	; uses AX as doscode segment
 48665 000083A3 E8D101                  	call	patch_misc_segments	; patch in segments for sharer and
 48666                                  					; other tables with seg in ES.
 48667                                  	; 17/12/2022
 48668                                  	; cx = 0
 48669 000083A6 8C06[A30A]              	mov	[TEMP_DOSLOC],es	; put back segment of dos code
 48670                                  
 48671 000083AA 5A                      	pop	dx			; restore first free segment
 48672                                  
 48673                                  ; We shall now proceed to set the offsets of the interrupt vectors handled
 48674                                  ; by DOS to their appropriate values in DOSCODE. In case the DOS loads in
 48675                                  ; HIMEM the offsets also will be patched to their appropriate values in the
 48676                                  ; low_mem_stub by seg_reinit.
 48677                                  
 48678                                  	;xor	ax,ax ; 0
 48679                                  	;mov	ds,ax
 48680                                  	;mov	es,ax
 48681                                  	; 17/12/2022
 48682                                  	; cx = 0
 48683                                  	;xor	cx,cx ; 0
 48684 000083AB 8ED9                    	mov	ds,cx
 48685 000083AD 8EC1                    	mov	es,cx
 48686                                  
 48687                                  	; set the segment of int 24 vector that was
 48688                                  	; left out by patch_vec_segments above.
 48689                                  
 48690                                  	; 17/12/2022
 48691                                  ; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48692                                  ;%if 0
 48693                                  	; 24/05/2019
 48694                                  	;;mov	di,90h
 48695                                  	;;mov	di,4*int_fatal_abort
 48696                                  	;mov	di,addr_int_fatal_abort
 48697 000083AF BF9200                  	mov	di,addr_int_fatal_abort+2 ; 24/05/2019
 48698                                  
 48699 000083B2 36A1[A30A]              	mov	ax,[ss:TEMP_DOSLOC]
 48700                                  	;mov	[di+2],ax  ; int 24h segment
 48701 000083B6 8905                    	mov	[di],ax ; 24/05/2019
 48702                                  
 48703                                  	;;mov	di,82h
 48704                                  	;mov	di,INTBASE+2
 48705                                  
 48706                                  ;%endif
 48707                                  	; 17/12/2022
 48708                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48709                                  	;;mov	di,90h
 48710                                  	;;mov	di,4*int_fatal_abort
 48711                                  	;mov	di,addr_int_fatal_abort
 48712                                  	;mov	ax,[ss:TEMP_DOSLOC]
 48713                                  	;mov	[di+2],ax  ; int 24h segment
 48714                                  	;;mov	di,82h
 48715                                  	;mov	di,INTBASE+2
 48716                                  
 48717                                  	; set default divide trap offset
 48718                                  
 48719                                  	;mov	word ptr ds:[0],offset doscode:divov
 48720 000083B8 C7060000[7B5C]          	mov	word [0],DIVOV
 48721                                  
 48722                                  	; set vectors 20-28 and 2a-3f to point to iret.
 48723                                  
 48724                                  	;mov	di,80h
 48725 000083BE BF8000                  	mov	di,INTBASE
 48726                                  	;mov	ax,offset doscode:irett
 48727 000083C1 B8[CB02]                	mov	ax,IRETT
 48728                                  
 48729                                  	; 17/12/2022
 48730                                  	; cx = 0
 48731 000083C4 B109                    	mov	cl,9
 48732                                  	;mov	cx,9			; set 9 offsets (skip 2 between each)
 48733                                  					;   sets offsets for ints 20h-28h
 48734                                  iset1:
 48735 000083C6 AB                      	stosw
 48736                                  	;add	di,2
 48737                                  	; 20/09/2023
 48738 000083C7 47                      	inc	di
 48739 000083C8 47                      	inc	di
 48740 000083C9 E2FB                    	loop	iset1
 48741                                  
 48742 000083CB 83C704                  	add	di,4			; skip vector 29h
 48743                                  
 48744                                  ;	mov	cx,6			; set 6 offsets (skip 2 between each)
 48745                                  ;					;   sets offsets for ints 2Ah-2Fh
 48746                                  ;iset2:
 48747                                  ;	stosw
 48748                                  ;	add	di,2
 48749                                  ;	loop	iset2
 48750                                  
 48751                                  ; 30h & 31H is the CPM call entry point whose segment address is set up by
 48752                                  ; patch_vec_segments above. So skip it.
 48753                                  
 48754                                  ;	add	di,8			; skip vector 30h & 31h
 48755                                  
 48756                                  	;;;
 48757                                  	; 06/05/2019 - Retro DOS v4.0
 48758                                  	;mov	cx,5			; set offsets for int 2Ah-2Eh
 48759                                  	; 17/12/2022
 48760 000083CE B105                    	mov	cl,5 ; 28/06/2019
 48761                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48762                                  	;mov	cx,6
 48763                                  iset2:
 48764 000083D0 AB                      	stosw
 48765                                  	;add	di,2
 48766                                  	; 20/09/2023
 48767 000083D1 47                      	inc	di
 48768 000083D2 47                      	inc	di
 48769 000083D3 E2FB                    	loop	iset2
 48770                                  
 48771                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48772                                  	; 17/12/2022
 48773 000083D5 83C70C                  	add	di,12			; skip vectors 2Fh, 30h & 31h
 48774                                  	;add	di,8
 48775                                  	;;;
 48776                                  
 48777                                  	; 17/12/2022
 48778 000083D8 B10E                    	mov	cl,14
 48779                                  	;mov	cx,14			; set 14 offsets (skip 2 between each)
 48780                                  					;   sets offsets for ints 32h-3Fh
 48781                                  iset3:
 48782 000083DA AB                      	stosw
 48783                                  	;add	di,2
 48784                                  	; 20/09/2023
 48785 000083DB 47                      	inc	di
 48786 000083DC 47                      	inc	di
 48787 000083DD E2FB                    	loop	iset3
 48788                                  
 48789                                  ;if installed
 48790                                  	; set the offset of int2f handler
 48791                                  	;mov	word [0BCh],INT2F
 48792 000083DF C706BC00[3707]          	mov	word [02Fh*4],INT2F
 48793                                  	; set segment to doscode as we have to do int 2f to check for XMS
 48794 000083E5 36A1[A30A]              	mov	ax,[ss:TEMP_DOSLOC]	; get segment of doscode
 48795                                  	;mov	[0BEh],ax
 48796 000083E9 A3BE00                  	mov	[(02Fh*4)+2],ax
 48797                                  ;endif
 48798                                  	; set up entry point call at vectors 30-31h. Note the segment of the
 48799                                  	; long jump will be patched in by seg_reinit
 48800                                  
 48801                                  	;mov	byte [C0h],0EAh
 48802 000083EC C606C000EA              	mov	byte [ENTRYPOINT],mi_long_jmp
 48803                                  	;mov	byte [C1h],CALL_ENTRY
 48804 000083F1 C706C100[CC02]          	mov	word [ENTRYPOINT+1],CALL_ENTRY
 48805                                  
 48806 000083F7 C7068000[C502]          	mov	word [addr_int_abort],QUIT	; INT 20h
 48807 000083FD C7068400[F102]          	mov	word [addr_int_command],COMMAND ; INT 21h
 48808 00008403 C70688000001            	mov	word [addr_int_terminate],100h	; INT 22h
 48809 00008409 89168A00                	mov	word [addr_int_terminate+2],dx	
 48810 0000840D C7069400[2D05]          	mov	word [addr_int_disk_read],ABSDRD   ; INT 25h
 48811 00008413 C7069800[DF05]          	mov	word [addr_int_disk_write],ABSDWRT ; INT 26h 
 48812 00008419 C7069C00[C36E]          	mov	word [addr_int_keep_process],STAY_RESIDENT ; INT 27h
 48813                                  
 48814 0000841F 16                      	push	ss
 48815 00008420 1F                      	pop	ds
 48816                                  	
 48817                                  	; 24/05/2019
 48818                                  	;push	ss
 48819                                  	;pop	es
 48820                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48821                                  	; 17/12/2022
 48822                                  	;push	ss
 48823                                  	;pop	es
 48824                                  
 48825 00008421 52                      	push	dx			; remember address of arena
 48826                                  
 48827 00008422 42                      	inc	dx			; leave room for arena header
 48828                                  	;mov	[330h],dx
 48829 00008423 8916[3003]              	mov     [CurrentPDB],dx		; set current pdb
 48830                                  
 48831 00008427 31FF                    	xor	di,di			; point es:di at end of memory
 48832 00008429 8EC2                    	mov	es,dx			; ...where psp will be
 48833 0000842B 31C0                    	xor	ax,ax
 48834                                  	;mov	cx,80h			; psp is 128 words
 48835                                  	; 17/12/2022
 48836 0000842D B180                    	mov	cl,128 ; 28/06/2019
 48837                                  	; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48838                                  	;mov	cx,128
 48839                                  
 48840 0000842F F3AB                    	rep	stosw			; zero out psp area
 48841 00008431 A1[4603]                        mov     ax,[ENDMEM]
 48842                                  	
 48843                                  	; 17/12/2022
 48844                                  	; cx = 0
 48845 00008434 E86B92                  	call	SETMEM         	 	; build psp at dx; ax is memory size
 48846                                  
 48847                                  	; ds, es now point to PSP
 48848                                  
 48849 00008437 16                      	push	ss
 48850 00008438 1F                      	pop	ds
 48851                                  
 48852                                  	;mov	di,24
 48853 00008439 BF1800                  	mov	di,PDB.JFN_TABLE	; es:di -> pdb_jfn_table in psp
 48854 0000843C 31C0                    	xor	ax,ax
 48855 0000843E AB                      	stosw
 48856 0000843F AA                      	stosb				; 0,1 and 2 are con device
 48857 00008440 B0FF                    	mov	al,0FFh
 48858                                  	;mov	cx,FILPERPROC-3 ; 17
 48859                                  	; 17/12/2022
 48860                                  	; cx = 4
 48861 00008442 B111                    	mov	cl,FILPERPROC-3 ; 17
 48862 00008444 F3AA                    	rep	stosb			; rest are unused
 48863                                  
 48864 00008446 16                      	push	ss
 48865 00008447 07                      	pop	es
 48866                                  					; must be set to print messages
 48867 00008448 8C1E[2C00]              	mov	[SFT_ADDR+2],ds
 48868                                  
 48869                                  ; after this point the char device functions for con will work for
 48870                                  ; printing messages
 48871                                  
 48872                                  	; 24/04/2019 - Retro DOS v4.0
 48873                                  
 48874                                  ; 12/05/2019
 48875                                  ;
 48876                                  ;write_version_msg:
 48877                                  ;
 48878                                  ;	;if	(not ibm)
 48879                                  ;	;mov	si,offset doscode:header
 48880                                  ;	mov	si,HEADER
 48881                                  ;outmes:
 48882                                  ;	;lods	cs:byte ptr [si]
 48883                                  ;	cs
 48884                                  ;	lodsb
 48885                                  ;	cmp	al,"$"
 48886                                  ;	je	short outdone
 48887                                  ;	call	OUTT
 48888                                  ;	jmp	short outmes
 48889                                  ;outdone:
 48890                                  ;	push	ss			; out stomps on segments
 48891                                  ;	pop	ds
 48892                                  ;	push	ss
 48893                                  ;	pop	es
 48894                                  ;	;endif
 48895                                  
 48896                                  	; at this point es is dosdata
 48897                                  
 48898                                  	; Fill in the segment addresses of sysinitvar and country_cdpg
 48899                                  	; in sysinittable (ms_data.asm)
 48900                                  
 48901                                  	;mov	si,0D28h
 48902 0000844C BE[580D]                	mov	si,SysInitTable
 48903                                  
 48904                                  	; 17/12/2022
 48905                                  	; ds = es = ss
 48906                                  
 48907                                  	; 23/03/2024
 48908                                  	;;;
 48909                                  	; 17/12/2022
 48910                                  	;; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 48911                                  
 48912                                  	;;mov	[es:si+6],es
 48913                                  	;mov	[es:si+SYSI_EXT.Country_Tab+2],es
 48914                                  	;;mov	[es:si+2],es
 48915                                  	;mov	[es:si+SYSI_EXT.SysInitVars+2],es
 48916                                  	
 48917 0000844F 8C4406                  	mov	[si+SYSI_EXT.Country_Tab+2],es
 48918 00008452 8C4402                  	mov	[si+SYSI_EXT.SysInitVars+2],es
 48919                                  
 48920                                  	; buffhead -> dosdata:hashinitvar
 48921                                  
 48922                                  	;mov	[es:BUFFHEAD+2],es	; BUGBUG - unused, remove this
 48923 00008455 8C06[3A00]              	mov	[BUFFHEAD+2],es
 48924                                  	;mov	si,offset dosdata:hashinitvar ; and all other references
 48925                                  	;mov	si,6Dh
 48926 00008459 BE[6D00]                	mov	si,HASHINITVAR
 48927                                  	;mov	[es:BUFFHEAD],si
 48928 0000845C 8936[3800]              	mov	[BUFFHEAD],si
 48929                                  
 48930 00008460 5A                              pop     dx                      ; restore address of arena
 48931                                  
 48932                                  	;mov	[032Ch+2],dx
 48933 00008461 8916[2E03]                      mov     [DMAADD+2],dx
 48934                                  
 48935                                  	;mov	[es:arena_head],dx
 48936 00008465 8916[2400]              	mov	[arena_head],dx
 48937                                  	;;;
 48938                                  
 48939 00008469 8EDA                            mov     ds,dx
 48940                                  
 48941                                  	;mov	byte [0],'Z'
 48942 0000846B C60600005A              	mov     byte [ARENA.SIGNATURE],arena_signature_end
 48943                                          ;mov	word [1],0
 48944 00008470 C70601000000            	mov     word [ARENA.OWNER],arena_owner_system
 48945                                  
 48946 00008476 36A1[4603]                      mov     ax,[ss:ENDMEM]
 48947 0000847A 29D0                    	sub	ax,dx
 48948 0000847C 48                              dec     ax
 48949                                  	;mov	[3],ax	; 23/03/2024
 48950 0000847D A30300                          mov     [ARENA.SIZE],ax
 48951                                  
 48952                                  	; point to sft 0
 48953                                  
 48954                                  	;mov	di,offset dosdata:sftabl + sftable
 48955                                  	;mov	di,SFTABL+6
 48956 00008480 BF[D200]                	mov	di,SFTABL+SFT.SFTable
 48957 00008483 B80300                          mov     ax,3
 48958 00008486 AB                              stosw           		; adjust refcount
 48959                                  
 48960                                  	; es:di is shared data area i.e., es:di -> dosdata:sysinttable
 48961                                  
 48962                                  	;mov	di,offset dosdata:sysinittable
 48963                                  	;;mov	di,0D28h
 48964                                  	;mov	di,0D58h	; 23/03/2024 (PCDOS 7.1)
 48965 00008487 BF[580D]                	mov	di,SysInitTable	
 48966                                  
 48967 0000848A 42                      	inc	dx			; advance dx from arena to psp
 48968 0000848B 8EDA                    	mov	ds,dx			; point ds to psp
 48969                                  
 48970                                  					; pass the address os seg_reinit 
 48971                                  					; in dx
 48972 0000848D BA[F484]                	mov	dx,seg_reinit
 48973                                  	;mov	cx,exepatch_start
 48974                                  	; 08/03/2025 (MiniDOS)
 48975                                  	;mov	cx,SYSBUF
 48976                                  	;sub	cx,_$STARTCODE		; cx = (doscode - exepatch) - dosinit
 48977                                  
 48978 00008490 B8[9781]                	mov	ax,SYSBUF
 48979 00008493 2D[0000]                	sub	ax,_$STARTCODE		; ax = size of doscode - dosinit
 48980                                  	; 08/03/2025
 48981                                  	;mov	cx,ax
 48982                                  	; ax = [dos_code_size]
 48983                                  	
 48984 00008496 368B26[8405]                    mov     sp,[ss:USER_SP]		; use ss override for next 2
 48985 0000849B 368E16[8605]                    mov     ss,[ss:USER_SS]
 48986                                  
 48987 000084A0 CB                              retf
 48988                                  
 48989                                  ;
 48990                                  ; END OF DOSINIT
 48991                                  ;
 48992                                  ;--------------------------------------------------------------------------
 48993                                  
 48994                                  CHARINIT:
 48995                                  	; 11/04/2024
 48996                                  	; 23/03/2024 - Retro DOS v5.0
 48997                                  	; 24/04/2019 - Retro DOS v4.0
 48998                                  	; 07/07/2018 - Retro DOS v3.0
 48999                                  	;mov	byte [ss:035Ah],26 ; 1Ah ; MSDOS 6.22
 49000 000084A1 36C606[5A03]19                  MOV	BYTE [SS:DEVCALL_REQLEN],DINITHL ; 25 ; PCDOS 7.1
 49001                                  	;mov	byte [ss:035Bh],0
 49002 000084A7 36C606[5B03]00                  MOV	BYTE [SS:DEVCALL_REQUNIT],0
 49003                                  	;mov	byte [ss:035Ch],0
 49004 000084AD 36C606[5C03]00                  MOV	BYTE [SS:DEVCALL_REQFUNC],DEVINIT
 49005                                  	;mov	word [ss:035BD],0
 49006 000084B3 36C706[5D03]0000                MOV	WORD [SS:DEVCALL_REQSTAT],0
 49007 000084BA 06                              PUSH	ES
 49008 000084BB 53                              PUSH	BX
 49009 000084BC 50                              PUSH	AX
 49010 000084BD BB[5A03]                        MOV	BX,DEVCALL
 49011                                          ;PUSH	CS
 49012 000084C0 16                      	PUSH	SS ; 30/04/2019
 49013 000084C1 07                              POP	ES
 49014 000084C2 E8B3CA                          CALL	DEVIOCALL2
 49015 000084C5 58                      	POP	AX
 49016 000084C6 5B                              POP	BX
 49017 000084C7 07                              POP	ES
 49018 000084C8 C3                              RETN
 49019                                  
 49020                                  ; 25/04/2019 - Retro DOS v4.0
 49021                                  
 49022                                  ;-----------------------------------------------------------------------------
 49023                                  ;
 49024                                  ;	check_XMM: routine to check presence of XMM driver
 49025                                  ;
 49026                                  ;	Exit:   Sets up the XMM entry point in XMMcontrol in DOSDATA
 49027                                  ;
 49028                                  ;	USED:	none
 49029                                  ;
 49030                                  ;-----------------------------------------------------------------------------
 49031                                  
 49032                                  check_XMM: ; proc near
 49033                                  ;
 49034                                  ; determine whether or not an XMM driver is installed
 49035                                  ;
 49036 000084C9 50                      	push	ax
 49037                                  	;mov	ax,(XMM_MULTIPLEX<<8)+XMM_INSTALL_CHECK
 49038 000084CA B80043                  	mov	ax,4300h
 49039 000084CD CD2F                    	int	2Fh
 49040                                  		; - Multiplex - XMS - INSTALLATION CHECK
 49041                                  		; Return: AL = 80h XMS driver installed
 49042                                  		; AL <> 80h no driver
 49043 000084CF 3C80                    	cmp	al,80h			; Q: installed
 49044 000084D1 751D                    	jne	short cXMM_no_driver	; N: set error, quit
 49045                                  ;
 49046                                  ; get the XMM control functions entry point, save it, we
 49047                                  ; need to call it later.
 49048                                  ;
 49049 000084D3 53                      	push	bx
 49050 000084D4 52                      	push	dx
 49051 000084D5 1E                      	push	ds
 49052 000084D6 06                      	push	es
 49053                                  	;mov	ax,(XMM_MULTIPLEX<<8)+XMM_FUNCTION_ADDR
 49054 000084D7 B81043                  	mov	ax,4310h
 49055 000084DA CD2F                    	int	2Fh
 49056                                  		; - Multiplex - XMS - GET DRIVER ADDRESS
 49057                                  		; Return: ES:BX -> driver entry point
 49058                                  
 49059 000084DC 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 49060                                  
 49061 000084E1 891E[4F10]              	mov	[XMMcontrol],bx
 49062 000084E5 8C06[5110]              	mov	[XMMcontrol+2],es
 49063                                  cXMMexit:
 49064 000084E9 F8                      	clc
 49065 000084EA 07                      	pop	es
 49066 000084EB 1F                      	pop	ds
 49067 000084EC 5A                      	pop	dx
 49068 000084ED 5B                      	pop	bx
 49069 000084EE 58                      	pop	ax
 49070 000084EF C3                      	retn				; done
 49071                                  ;
 49072                                  ; set carry if XMM driver not present
 49073                                  ;
 49074                                  cXMM_no_driver:
 49075 000084F0 F9                      	stc
 49076 000084F1 58                      	pop	ax
 49077 000084F2 C3                      	retn
 49078                                  
 49079                                  ;-----------------------------------------------------------------------------
 49080                                  ;
 49081                                  ; Procedure Name : seg_reinit
 49082                                  ;
 49083                                  ; Inputs	 : ES has final dos code location
 49084                                  ;		   AX = 0 / 1
 49085                                  ;
 49086                                  ; Outputs	 : Patch in the sharer and other tables with seg in ES
 49087                                  ;		   if AX =0
 49088                                  ;		      if first entry
 49089                                  ;			 patch segment & offset of vectors with stub
 49090                                  ;			 and stub with segment in ES
 49091                                  ;		      else
 49092                                  ;			 patch stub with segment in ES
 49093                                  ;
 49094                                  ;		   else if AX = 1
 49095                                  ;			patch segment of vectors with segment in ES
 49096                                  ;
 49097                                  ; NOTE		 : This routine can be called at most twice!
 49098                                  ;
 49099                                  ; Regs Mod.	 : es, ax, di, cx, bx
 49100                                  ;-----------------------------------------------------------------------------
 49101                                  
 49102 000084F3 00                      num_entry: db	0		; keeps track of the # of times this routine
 49103                                  				; has been called. (0 or 1)
 49104                                  
 49105                                  	; 04/11/2022 - Retro DOS v4.0 (ref: MSDOS 5.0)
 49106                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:0BAB7h
 49107                                  	; 25/05/2019 - Retro DOS v4.0 (ref: MSDOS 6.21)
 49108                                  	; MSDOS 6.21 MSDOS.SYS - DOSCODE:0BDA5h
 49109                                  
 49110                                  	; 23/03/2024 - Retro DOS v5.0 (ref: PCDOS 7.1)
 49111                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0D07Eh
 49112                                  
 49113                                  seg_reinit:	; proc	far
 49114 000084F4 1E                      	push	ds
 49115                                  
 49116 000084F5 2E8E1E[0700]            	mov	ds,[cs:DosDSeg]
 49117                                  
 49118 000084FA E87A00                  	call	patch_misc_segments	; patch in segments for sharer and 
 49119                                  					; other tables with seg in ES.
 49120                                  	
 49121                                  	; 17/12/2022
 49122                                  	; cx = 0
 49123 000084FD 39C8                    	cmp	ax,cx ; 0
 49124                                  	;cmp	ax,0
 49125 000084FF 7531                    	jne	short patch_vec_seg	; patch vectors with segment in es
 49126                                  	; 23/03/2024
 49127                                  	;or	ax, ax
 49128                                  	;jnz	short patch_vec_seg
 49129                                  
 49130                                  	; 23/03/2024
 49131                                  	;cmp	[cs:num_entry],al ; 0
 49132                                  	; 17/12/2022
 49133 00008501 2E380E[F384]            	cmp	[cs:num_entry],cl ; 0
 49134                                  	;cmp	byte [cs:num_entry],0	; Q: is it the first call to this
 49135 00008506 7508                    	jne	short second_entry	; N: just patch the stub with 
 49136                                  					;    segment in ES
 49137                                  					; Y: patch the vectors with stub
 49138 00008508 8CD8                    	mov	ax,ds
 49139 0000850A E83200                  	call	patch_vec_segments	; patch the segment of vectors
 49140 0000850D E8A100                  	call	patch_offset		; patch the offsets of vectors
 49141                                  					; with those in the stub.
 49142                                  	; 17/12/2022
 49143                                  	; cx = 0
 49144                                  second_entry:
 49145 00008510 8CC0                    	mov	ax,es			; patch the stub with segment in es
 49146                                  
 49147                                  	;mov	di,OFFSET DOSDATA:DOSINTTABLE
 49148                                  	;;mov	di,1062h	; (same table addr for MSDOS 5.0 and MSDOS 6.21)
 49149                                  	;mov	di,0F7Ah ; 23/03/2024 ; PCDOS 7.1
 49150 00008512 BF[4E0F]                	mov	di,DOSINTTABLE
 49151                                  	
 49152                                  	; 17/12/2022
 49153                                  	; cx = 0
 49154                                  	;;mov	cx,9
 49155                                  	;mov	cl,9
 49156                                  	; 23/03/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 49157                                  	;;;
 49158                                  	;mov	cx,8
 49159 00008515 B108                    	mov	cl,8
 49160                                  	;;;
 49161 00008517 1E                      	push	ds			
 49162 00008518 07                      	pop	es			; es:di -> DOSINTTABLE
 49163                                  
 49164                                  dosinttabloop:
 49165                                  	;add	di,2
 49166                                  	; 19/06/2023
 49167 00008519 47                      	inc	di
 49168 0000851A 47                      	inc	di
 49169 0000851B AB                      	stosw
 49170 0000851C E2FB                    	loop	dosinttabloop	
 49171                                  
 49172                                  ; For ROMDOS, this routine will only be called when the DOS wants to
 49173                                  ; use the HMA, so we don't want to check CS
 49174                                  
 49175                                  ;ifndef ROMDOS
 49176 0000851E 3D00F0                  	cmp	ax,0F000h		; Q: is the DOS running in the HMA
 49177 00008521 7214                    	jb	short sr_done		; N: done
 49178                                  ;endif
 49179 00008523 E8A3FF                  	call	check_XMM		; Y: set up the XMS entry point
 49180 00008526 720F                    	jc	short sr_done		; failed to set up XMS do not do
 49181                                  					; A20 toggling in the stub.
 49182                                  	; 17/12/2022
 49183                                  	; cx = 0
 49184 00008528 E80101                  	call	patch_in_nops		; enable the stub to check A20 state
 49185                                  ; M021-
 49186                                  	;;mov	byte [1211h],1
 49187                                  	;mov	byte [0D66h],1 1 ; 23/03/2024 ; PCDOS 7.1
 49188 0000852B C606[660D]01            	mov	byte [DosHasHMA],1	; set flag telling DOS control of HMA
 49189                                  
 49190                                  ; 07/03/2025 (MiniDOS)				
 49191                                  %if 0					; set pointer to the routine that 
 49192                                  					; patches buggy exepacked code.
 49193                                  	;mov	[FixExePatch],offset DOSCODE:ExePatch
 49194                                  	mov	word [FixExePatch],ExePatch
 49195                                  					; M068: set pointer to the routine 
 49196                                  					; M068: that detects copy protected
 49197                                  					; M068: apps
 49198                                  	;mov	[ChkCopyProt],offset DOSCODE:IsCopyProt
 49199                                  	mov	word [ChkCopyProt],IsCopyProt
 49200                                  
 49201                                  	; 23/03/2024 - PCDOS 7.1 IBMDOS.COM - DOSCODE:0D0C7h
 49202                                  	;	      (MSDOS 6.22 MSDOS.SYS - DOSCODE:0BDF1h)
 49203                                  	call	WhatCPUType
 49204                                  	cmp	al,1
 49205                                  	jne	short sr_done	; we need Rational Patch only on 286 systems
 49206                                  	mov	word [RationalPatchPtr],RationalPatch
 49207                                  %endif
 49208                                  
 49209                                  	; 19/09/2023
 49210 00008530 EB05                    	jmp	short sr_done
 49211                                  
 49212                                  	; 23/03/2024
 49213                                  patch_vec_seg:				; patch vectors with segment in es
 49214 00008532 8CC0                    	mov	ax,es
 49215 00008534 E80800                  	call	patch_vec_segments	; patch in DOSCODE for the segments
 49216                                  					; NOTE we don't have to patch the 
 49217                                  					; offsets as they have been already
 49218                                  					; set to the doscode offsets at
 49219                                  					; DOSINIT.
 49220                                  sr_done:
 49221 00008537 2EC606[F384]01          	mov	byte [cs:num_entry],1
 49222 0000853D 1F                      	pop	ds
 49223 0000853E CB                      	retf	; ! far return !
 49224                                  
 49225                                  ;----------------------------------------------------------------------------
 49226                                  ;
 49227                                  ; Procedure Name : patch_vec_segments
 49228                                  ;
 49229                                  ; Inputs	 : ax -> has segment address to patch in
 49230                                  ;		   ds -> DOSDATA
 49231                                  ;
 49232                                  ; Outputs	 : Patches in AX as the segment for the following vectors:
 49233                                  ;			
 49234                                  ;			0,20-28,3a-3f
 49235                                  ;
 49236                                  ; Regs. Mod.	 : DI,CX,DX,AX
 49237                                  ;
 49238                                  ;----------------------------------------------------------------------------
 49239                                  
 49240                                  patch_vec_segments:
 49241                                  
 49242 0000853F 06                      	push	es
 49243                                  
 49244 00008540 31C9                    	xor	cx,cx ; 0
 49245 00008542 8EC1                    	mov	es,cx
 49246                                  
 49247                                  	;mov	di,82h
 49248 00008544 BF8200                  	mov	di,INTBASE+2		; di -> segment of int 20h vector
 49249                                  
 49250 00008547 26A30200                	mov	[es:2],ax		; segment of default divide trap handler
 49251                                  
 49252                                  					; set vectors 20h & 21h
 49253                                  	; 04/11/2022
 49254                                  	;mov	cx,2
 49255                                  	; 17/12/2022
 49256                                  	;mov	cl,2
 49257                                  ps_set1:
 49258 0000854B AB                      	stosw	; int 20h segment
 49259                                  	;add	di,2
 49260                                  	; 17/12/2022
 49261 0000854C 47                      	inc	di
 49262 0000854D 47                      	inc	di
 49263                                  	;loop	ps_set1
 49264                                  
 49265                                  	; 17/12/2022
 49266 0000854E AB                      	stosw	; int 21h segment
 49267                                  	;inc	di
 49268                                  	;inc	di
 49269                                  
 49270                                  	;add	di,4			; skip int 22h vector
 49271 0000854F 83C706                  	add	di,6 ; *
 49272                                  
 49273 00008552 AB                      	stosw				; set int 23h
 49274 00008553 83C706                  	add	di,6			; skip int 24h
 49275                                  
 49276                                  					; set vectors 25h-28h and 2Ah-3Fh
 49277                                  	; 04/11/2022
 49278                                  	;mov	cx,4			; set 4 segments
 49279                                  	; 17/12/2022
 49280 00008556 B104                    	mov	cl,4
 49281                                  ps_set2:
 49282 00008558 AB                      	stosw
 49283                                  	;add	di,2
 49284                                  	; 17/12/2022
 49285 00008559 47                      	inc	di
 49286 0000855A 47                      	inc	di
 49287 0000855B E2FB                    	loop	ps_set2
 49288                                  
 49289 0000855D 83C704                  	add	di,4			; skip int 29h vector (fast con) as it may
 49290                                  					;   already be set.
 49291                                  	; 04/11/2022
 49292                                  	;mov	cx,6			; set 6 segs (skip 2 between each)
 49293                                  	; 17/12/2022
 49294 00008560 B106                    	mov	cl,6			;  set segs for ints 2Ah-2Fh
 49295                                  ps_set3:
 49296 00008562 AB                      	stosw
 49297                                  	;add	di,2
 49298                                  	; 17/12/2022
 49299 00008563 47                      	inc	di
 49300 00008564 47                      	inc	di
 49301 00008565 E2FB                    	loop	ps_set3
 49302                                  
 49303                                  ; 30h & 31H is the CPM call entry point whose segment address is set up by
 49304                                  ; below. So skip it.
 49305                                  
 49306 00008567 83C708                  	add	di,8			; skip vector 30h & 31h 
 49307                                  	
 49308                                  	; 04/11/2022
 49309                                  	;mov	cx,14			; set 14 segs (skip 2 between each)
 49310                                  	; 17/12/2022
 49311 0000856A B10E                    	mov	cl,14			;  sets segs for ints 32h-3Fh
 49312                                  ps_set4:
 49313 0000856C AB                      	stosw
 49314                                  	;add	di,2
 49315                                  	; 17/12/2022
 49316 0000856D 47                      	inc	di
 49317 0000856E 47                      	inc	di
 49318 0000856F E2FB                    	loop	ps_set4
 49319                                  
 49320                                  ; set offset of int2f
 49321                                  
 49322                                  ;if installed
 49323                                  ;	mov	word ptr es:[02fh * 4],offset doscode:int2f
 49324                                  ;endif
 49325                                  	;mov	[es:0C3h],ax
 49326 00008571 26A3C300                	mov	[es:ENTRYPOINT+3],ax
 49327                                  	; 17/12/2022
 49328                                  	; cx = 0
 49329 00008575 07                      	pop	es
 49330 00008576 C3                      	retn
 49331                                  
 49332                                  ;---------------------------------------------------------------------------
 49333                                  ;
 49334                                  ; Procedure Name : patch_misc_segments
 49335                                  ;
 49336                                  ; Inputs	 : es = segment to patch in
 49337                                  ;		   ds = dosdata
 49338                                  ;
 49339                                  ; outputs	 : patches in the sharer and other tables in the dos
 49340                                  ;		   with right dos code segment in es
 49341                                  ;
 49342                                  ; Regs Mod	 : DI,SI,CX
 49343                                  ;
 49344                                  ;---------------------------------------------------------------------------
 49345                                  
 49346                                  patch_misc_segments:
 49347                                  
 49348 00008577 53                      	push	bx
 49349 00008578 06                      	push	es
 49350 00008579 50                      	push	ax
 49351                                  
 49352 0000857A 8CC0                    	mov	ax,es			; ax - > DOS segment
 49353                                  	
 49354 0000857C 1E                      	push	ds
 49355 0000857D 07                      	pop	es			; es -> DOSDATA
 49356                                  	
 49357                                  ; initialize the jump table for the sharer...
 49358                                  
 49359                                  	;mov	di,offset dosdata:jshare
 49360                                  	;mov	di,90h
 49361 0000857E BF[9000]                	mov	di,JShare
 49362                                  	;;mov	bx,[0AAAh]
 49363                                  	;mov	bx,[0AA3h] ; 23/03/2024 ; PCDOS 7.1 
 49364 00008581 8B1E[A30A]              	mov	bx,[TEMP_DOSLOC]	; bx = location to which the share
 49365                                  					; table was patched during the first
 49366                                  					; call to this routine
 49367 00008585 B90F00                  	mov	cx,15
 49368                                  jumptabloop:
 49369                                  	;add	di,2			; skip offset
 49370                                  	; 17/12/2022
 49371 00008588 47                      	inc	di
 49372 00008589 47                      	inc	di
 49373 0000858A 83FBFF                  	cmp	bx,-1 ; 0FFFFh		; Q: is this called for the 1st time
 49374 0000858D 7405                    	je	short share_patch	; Y: patch in sharer table
 49375                                  					; N: 
 49376 0000858F 263B1D                  	cmp	bx,[es:di]		; Q: has share been installed
 49377 00008592 7501                    	jne	short no_share_patch	; Y: don't patch in sharer table
 49378                                  share_patch:
 49379 00008594 AB                      	stosw				; drop in segment
 49380                                  no_share_patch:
 49381 00008595 E2F1                    	loop	jumptabloop
 49382                                  					; BUGBUG patching the country info 
 49383                                  					; with dosdata can be done inline
 49384                                  					; in dosinit.
 49385                                  					; for dos 3.3 country info
 49386                                  					; table address
 49387                                  
 49388                                  	;mov	si,offset dosdata:country_cdpg
 49389                                  	;mov	si,122Ah   
 49390 00008597 BE[3611]                	mov	si,COUNTRY_CDPG
 49391                                  					; initialize double word
 49392                                  					; pointers with dosdata in ds
 49393                                  	;mov	[si+4Fh],ds
 49394                                  	;mov	[si+54h],ds
 49395                                  	;mov	[si+59h],ds
 49396                                  	;mov	[si+5Eh],ds
 49397                                  	;mov	[si+80h],ds
 49398                                  	;mov	[si+63h],ds
 49399 0000859A 8C5C4F                  	mov	[si+DOS_CCDPG.ccUcase_ptr+2],ds
 49400 0000859D 8C5C54                  	mov	[si+DOS_CCDPG.ccFileUcase_ptr+2],ds
 49401 000085A0 8C5C59                  	mov	[si+DOS_CCDPG.ccFileChar_ptr+2],ds
 49402 000085A3 8C5C5E                  	mov	[si+DOS_CCDPG.ccCollate_ptr+2],ds
 49403 000085A6 8C9C8000                	mov	[si+DOS_CCDPG.ccMono_ptr+2],ds
 49404 000085AA 8C5C63                  	mov	[si+DOS_CCDPG.ccDBCS_ptr+2],ds
 49405                                  
 49406                                  					; fastopen routines are in doscode
 49407                                  					; so patch with doscode seg in ax
 49408                                  ; 03/03/2025 (MiniDOS)
 49409                                  %if 0	
 49410                                  
 49411                                  	;mov	si,offset dosdata:fastopentable
 49412                                  	;mov	si,0D30h
 49413                                  	mov	si,FastOpenTable
 49414                                  
 49415                                  	; 17/12/2022
 49416                                  	; bx = [TEMP_DOSLOC]
 49417                                  	cmp	bx,-1
 49418                                  	;cmp	word [TEMP_DOSLOC],-1	; Q: first time 
 49419                                  	je	short fast_patch	; Y: patch segment
 49420                                  	;mov	cx,[TEMP_DOSLOC]
 49421                                  					; Q: has fastopen patched in it's
 49422                                  					;    segment
 49423                                  	; 17/12/2022
 49424                                  	cmp	bx,[si+fastopen_entry.name_caching+2]
 49425                                  	;;cmp	cx,[si+4]
 49426                                  	;cmp	cx,[si+fastopen_entry.name_caching+2]
 49427                                  	jne	short no_fast_patch	; Y: don't patch in doscode seg
 49428                                  
 49429                                  fast_patch:
 49430                                  	;mov	[si+4],ax
 49431                                  	mov	[si+fastopen_entry.name_caching+2],ax
 49432                                  no_fast_patch:
 49433                                  %endif
 49434                                  
 49435                                  	; 17/12/2022
 49436                                  	; cx = 0
 49437 000085AD 58                      	pop	ax
 49438 000085AE 07                      	pop	es
 49439 000085AF 5B                      	pop	bx
 49440                                  
 49441 000085B0 C3                      	retn
 49442                                  
 49443                                  ;--------------------------------------------------------------------------
 49444                                  ;
 49445                                  ; Procedure Name : patch_offset
 49446                                  ; 
 49447                                  ; Inputs	 : NONE
 49448                                  ;
 49449                                  ; Outputs	 : Patches in the offsets in the low_mem_stub for vectors
 49450                                  ;		   0,20-28,3a-3f, and 30,31
 49451                                  ;
 49452                                  ;
 49453                                  ; Regs. Mod	 : AX,DI,CX
 49454                                  ;--------------------------------------------------------------------------
 49455                                  
 49456                                  patch_offset:
 49457 000085B1 06                      	push	es		; preserve es
 49458                                  
 49459 000085B2 31C0                    	xor	ax,ax
 49460 000085B4 8EC0                    	mov	es,ax
 49461                                  				; set default divide trap address
 49462                                  	;mov	word ptr es:[0],offset dosdata:ldivov
 49463                                  	;;mov	word [es:0],108Ah
 49464                                  	;mov	word [es:0],0F9Eh ; 23/03/2024 ; PCDOS 7.1
 49465 000085B6 26C7060000[720F]        	mov	word [es:0],ldivov
 49466                                  
 49467                                  	;mov	di,80h
 49468 000085BD BF8000                  	mov	di,INTBASE	; di-> offset of int 20 handler
 49469                                  	;mov	ax,offset dosdata:lirett
 49470                                  	;mov	ax,10DAh
 49471 000085C0 B8[4210]                	mov	ax,lirett
 49472                                  				; set vectors 20h & 21h to point to iret.
 49473                                  	; 17/12/2022
 49474                                  	; cx = 0
 49475                                  
 49476                                  	;mov	cx,2		; set 2 offsets (skip 2 between each)
 49477                                  po_iset1:
 49478 000085C3 AB                      	stosw	; int 20h offset
 49479                                  	;add	di,2 ; *
 49480                                  	;loop	po_iset1
 49481                                  	; 17/12/2022
 49482 000085C4 47                      	inc	di
 49483 000085C5 47                      	inc	di
 49484 000085C6 AB                      	stosw	; int 21h offset
 49485                                  
 49486                                  	;add	di,4		; skip vector 22h
 49487                                  	; 17/12/2022
 49488 000085C7 83C706                  	add	di,6 ; *
 49489                                  
 49490 000085CA AB                      	stosw			; set offset of 23h
 49491                                  	;add	di,6		; skip 24h
 49492                                  	; 19/09/2023
 49493 000085CB 83C712                  	add	di,18		; skip 23h segment and int 24-25-26-27h
 49494                                  
 49495                                  				; set vectors 25-28 and 2a-3f to iret.
 49496                                  	; 04/11/2022
 49497                                  	;mov	cx,4		; set 4 offsets (skip 2 between each)
 49498                                  	; 19/09/2023
 49499                                  	; 17/12/2022
 49500                                  	;mov	cl,4		; sets offsets for ints 25h-28h
 49501                                  po_iset2:
 49502 000085CE AB                      	stosw		; set offset for int 28h ; 19/09/2023
 49503                                  	;add	di,2
 49504                                  	; 19/09/2023
 49505                                  	; 17/12/2022
 49506                                  	;inc	di
 49507                                  	;inc	di
 49508                                  	; 19/09/2023
 49509                                  	;loop	po_iset2
 49510                                  
 49511                                  	;add	di,4		; skip vector 29h
 49512                                  	; 19/09/2023
 49513 000085CF 83C706                  	add	di,6	; skip int 28h segment and int 29h ; 19/09/2023
 49514                                  
 49515                                  	; 04/11/2022
 49516                                  	;mov	cx,6		; set 6 offsets (skip 2 between each)
 49517                                  	; 17/12/2022
 49518                                  	;mov	cl,6		; sets offsets for ints 2Ah-2Fh
 49519 000085D2 B105                    	mov	cl,5		; sets offsets for ints 2Ah-2Eh
 49520                                  po_iset3:
 49521 000085D4 AB                      	stosw
 49522                                  	;add	di,2
 49523                                  	; 17/12/2022
 49524 000085D5 47                      	inc	di
 49525 000085D6 47                      	inc	di
 49526 000085D7 E2FB                    	loop	po_iset3
 49527                                  
 49528                                  ; 30h & 31H is the CPM call entry point whose offset address is set up by
 49529                                  ; below. So skip it.
 49530                                  
 49531                                  	;add	di,8		; skip vector 30h & 31h
 49532                                  	; 17/12/2022
 49533 000085D9 83C70C                  	add	di,12		; skip vector 2Fh, 30h & 31h
 49534                                  
 49535                                  	; 04/11/2022
 49536                                  	;mov	cx,14		; set 14 offsets (skip 2 between each)
 49537                                  				;  sets offsets for ints 32h-3Fh
 49538                                  	; 17/12/2022
 49539 000085DC B10E                    	mov	cl,14 ; 26/06/2019
 49540                                  po_iset4:
 49541 000085DE AB                      	stosw
 49542                                  	;add	di,2
 49543                                  	; 17/12/2022
 49544 000085DF 47                      	inc	di
 49545 000085E0 47                      	inc	di
 49546 000085E1 E2FB                    	loop	po_iset4
 49547                                  
 49548                                  ;if installed
 49549                                  	;mov	word ptr es:[02fh * 4],offset dosdata:lint2f
 49550                                  	;;mov	word [es:0BCh],10C6h ; (MSDOS 5.0 & 6.21)
 49551                                  	;mov	word [es:0BCh],0FDAh ; PCDOS 7.1 ; 23/03/2024
 49552 000085E3 26C706BC00[AE0F]        	mov	word [es:(2Fh*4)],lint2f
 49553                                  ;endif
 49554                                  
 49555                                  ; set up entry point call at vectors 30-31h
 49556                                  	;mov	byte [es:0C0h],0EAh
 49557 000085EA 26C606C000EA            	mov	byte [es:ENTRYPOINT],mi_long_jmp
 49558                                  	;mov	word [es:0C1h],10D0h ;; 0FE4h ; 23/03/2024 (PCDOS 7.1)
 49559                                  
 49560 000085F0 26C706C100[B80F]        	mov	word [es:ENTRYPOINT+1],lcall_entry
 49561                                  
 49562                                  							; 19/09/2023
 49563                                  	;mov	word [es:80h],1094h ;; 0FA8h ; 23/03/2024
 49564 000085F7 26C7068000[7C0F]        	mov	word [es:addr_int_abort],lquit		; int 20h
 49565                                  	;mov	word [es:84h],109Eh ;; 0FB2h
 49566 000085FE 26C7068400[860F]        	mov	word [es:addr_int_command],lcommand	; int 21h
 49567                                  	;mov	word [es:94h],10A8h ;; 0FBCh
 49568 00008605 26C7069400[900F]        	mov	word [es:addr_int_disk_read],labsdrd	; int 25h
 49569                                  	;mov	word [es:98h],10B2h ;; 0FC6h
 49570 0000860C 26C7069800[9A0F]        	mov	word [es:addr_int_disk_write],labsdwrt	; int 26h
 49571                                  	;mov	word [es:9Ch],10BCh ;; 0FD0h
 49572 00008613 26C7069C00[A40F]        	mov	word [es:addr_int_keep_process],lstay_resident	; int 27h
 49573                                  
 49574                                  	; 17/12/2022
 49575                                  	; CX = 0
 49576 0000861A 07                      	pop	es		; restore es
 49577 0000861B C3                      	retn
 49578                                  
 49579                                  ;--------------------------------------------------------------------------
 49580                                  ;
 49581                                  ; 	Procedure Name	:	patch_in_nops
 49582                                  ;
 49583                                  ; 	Entry		: 	ES -> DOSDATA
 49584                                  ;
 49585                                  ;	Regs Mod	: 	cx, di
 49586                                  ;
 49587                                  ;	Description:
 49588                                  ;		This routine patches in 2 nops at the offsets specified in 
 49589                                  ;	patch_table. This basically enables the low mem stub to start 
 49590                                  ;	making XMS calls.
 49591                                  ;
 49592                                  ;--------------------------------------------------------------------------
 49593                                  
 49594                                  	; 04/11/2022
 49595                                  	; MSDOS 5.0 MSDOS.SYS - DOSCODE:0BC50h
 49596                                  
 49597                                  	; 23/03/2024
 49598                                  	; MSDOS 6.22 MSDOS.SYS - DOSCODE:0BF42h
 49599                                  	; 23/03/2024 - Retro DOS v5.0
 49600                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0D1E9h
 49601                                  
 49602                                  patch_table:	; label	byte
 49603                                  	;dw	offset dosdata:i0patch
 49604                                  	;dw	offset dosdata:i20patch
 49605                                  	;dw	offset dosdata:i21patch
 49606                                  	;dw	offset dosdata:i25patch
 49607                                  	;dw	offset dosdata:i26patch
 49608                                  	;dw	offset dosdata:i27patch
 49609                                  	;dw	offset dosdata:i2fpatch
 49610                                  	;dw	offset dosdata:cpmpatch
 49611 0000861C [720F]                  	dw	i0patch
 49612 0000861E [7C0F]                  	dw	i20patch
 49613 00008620 [860F]                  	dw	i21patch
 49614 00008622 [900F]                  	dw	i25patch
 49615 00008624 [9A0F]                  	dw	i26patch
 49616 00008626 [A40F]                  	dw	i27patch
 49617 00008628 [AE0F]                  	dw	i2fpatch
 49618 0000862A [B80F]                  	dw	cpmpatch
 49619                                  
 49620                                  patch_table_size equ ($-patch_table)/2
 49621                                  
 49622                                  patch_in_nops:
 49623 0000862C 50                      	push	ax
 49624 0000862D 56                      	push	si
 49625 0000862E BE[1C86]                	mov	si,patch_table
 49626 00008631 B89090                  	mov	ax,9090h ; nop, nop
 49627                                  	; 17/12/2022
 49628                                  	; cx = 0
 49629                                  	;mov	cx,8
 49630                                  	;mov	cx,patch_table_size ; 8
 49631 00008634 B108                    	mov	cl,patch_table_size ; 8
 49632                                  pin_loop:
 49633 00008636 2E8B3C                  	mov	di,[cs:si]
 49634 00008639 AB                      	stosw
 49635                                  	;add	si,2
 49636                                  	; 17/12/2022
 49637 0000863A 46                      	inc	si
 49638 0000863B 46                      	inc	si
 49639 0000863C E2F8                    	loop	pin_loop
 49640 0000863E 5E                      	pop	si
 49641 0000863F 58                      	pop	ax
 49642 00008640 C3                      	retn
 49643                                  
 49644                                  ; 05/12/2022 (MSDOS 5.0 MSDOS.SYS compatibility)
 49645                                  ; ---------------------------------------------------------------------------
 49646                                  ; MSDOS 5.0 - MSDOS.SYS offset BC77h, file offset 7EA7h
 49647                                  ; ---------------------------------------------------------------------------
 49648                                  ; 23/03/2024
 49649                                  ; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0BF69h)
 49650                                  ; PCDOS 7.1 IBMDOS.COM - DOSCODE:0D20Fh
 49651                                  
 49652                                  	; 05/12/2022 - temporary ; (paragraph alinment)
 49653                                  DOSCODE_END:
 49654                                  
 49655                                  	; 23/03/2024
 49656                                  	;;times	9 db 0	; db 9 dup(0)
 49657                                  	;; 18/12/2022
 49658                                  	;dw	0	; times 2 db 0
 49659                                  	
 49660                                  	; 23/03/2024
 49661                                  	;times	7 db 0	; MSDOS 6.22 MSDOS.SYS
 49662                                  	
 49663                                  	; 23/03/2024 - Retro DOS v5.0
 49664                                  	;db	0	; PCDOS 7.1 IBMDOS.COM
 49665                                  	; 01/07/2024
 49666                                  	;times	12 db 0
 49667                                  
 49668                                  	; 01/07/2024 - Retro DOS v5.0
 49669                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0D0Fh
 49670 00008641 00                      	db	0
 49671                                  
 49672                                  ;align 16
 49673                                  	; DOSCODE:BC80h	(MSDOS 5.0 MSDOS.SYS file offset 7EB0h)
 49674                                  	; MSDOS.SYS file offset: 32432 (start of DOSDATA)
 49675                                  
 49676                                  	; 23/03/2024 
 49677                                  	; PCDOS 7.1 IBMDOS.COM - DOSCODE:0D210h
 49678                                  	; (MSDOS 6.22 MSDOS.SYS - DOSCODE:0BF70h)
 49679                                  
 49680                                  ; ---------------------------------------------------------------------------
 49681                                  
 49682                                  ;memstrt label word
 49683                                  ; ---------------------------------------------------------------------------
 49684                                  ; MSDOS 6.21 - MSDOS.SYS offset BF69h, file offset 8189h
 49685                                  ; ---------------------------------------------------------------------------
 49686                                  
 49687                                  MEMSTRT: ; 25/04/2019 - Retro DOS v4.0
 49688                                  
 49689                                  ; if not ROMDOS, then we close the dos code segment, otherwise we close
 49690                                  ; the dos initialization segment
 49691                                  
 49692                                  ;ifndef ROMDOS
 49693                                  
 49694                                  ;doscode ends
 49695                                  
 49696                                  ;else
 49697                                  
 49698                                  ;;dosinitseg ends
 49699                                  
 49700                                  ;endif ; ROMDOS
 49701                                  
 49702                                  ;============================================================================
 49703                                  
 49704                                  ; DPUBLIC <ParaRound, cXMM_no_driver, cXMMexit, char_init_loop, charinit>
 49705                                  ; DPUBLIC <check_XMM, continit, dosinttabloop, endlist>
 49706                                  ; DPUBLIC <initiret, iset1, iset2, jumptabloop, nxtentry>
 49707                                  ; DPUBLIC <notmax,  patch_offset, perdrv>
 49708                                  ; DPUBLIC <perunit, po_iset1, po_iset2, po_iset3>
 49709                                  ; DPUBLIC <ps_set1, ps_set2, ps_set3, seg_reinit>
 49710                                  ; DPUBLIC <sr_done, version_fake_table, xxx>
 49711                                  
 49712                                  ;; burasý doscode sonu
 49713                                  
 49714                                  ;============================================================================
 49715                                  ; DOSDATA
 49716                                  ;============================================================================
 49717                                  ; 29/04/2019 - Retro DOS 4.0
 49718                                  ; 24/03/2024 - Retro DOS 5.0
 49719                                  
 49720                                  ;[BITS 16]
 49721                                  
 49722                                  ;[ORG 0]
 49723                                  
 49724                                  ; 25/04/2019 - Retro DOS v4.0
 49725                                  
 49726                                  ;============================================================================
 49727                                  ; DOSDATA - MSDOS 6.21 - MSDOS.SYS Offset 0BF70h, file offset 8190h
 49728                                  ;============================================================================
 49729                                  
 49730                                  ;align 16
 49731                                  	; DOSDATA (MSDOS.SYS kernel DATA) segment starts here...
 49732                                  	; (4970 bytes for MSDOS 6.21)
 49733                                  	; (4976 bytes for Retro DOS v4.0, 25/05/2019 modification.)
 49734                                  
 49735                                  ;============================================================================
 49736                                  ; MSCONST.ASM (MSDOS 6.0, 1991)
 49737                                  ;============================================================================
 49738                                  ; 03/11/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 49739                                  ; 25/04/2019 - Retro DOS 4.0 (MSDOS 6.21)
 49740                                  ; 16/07/2018 - Retro DOS 3.0	
 49741                                  
 49742                                  ;Break <Initialized data and data used at DOS initialization>
 49743                                  ;----------------------------------------------------------------------------
 49744                                  
 49745                                  ; We need to identify the parts of the data area that are relevant to tasks
 49746                                  ; and those that are relevant to the system as a whole. Under 3.0, the system
 49747                                  ; data will be gathered with the system code. The process data under 2.x will
 49748                                  ; be available for swapping and under 3.0 it will be allocated per-process.
 49749                                  ;
 49750                                  ; The data that is system data will be identified by [SYSTEM] in the comments
 49751                                  ; describing that data item.
 49752                                  
 49753                                  ;DOSDATA SEGMENT
 49754                                  
 49755                                  ; 04/11/2022
 49756                                  ;[ORG 0]
 49757                                  
 49758                                  ; ----------------------------------------------------------------------------
 49759                                  ; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 49760                                  ; ----------------------------------------------------------------------------
 49761                                  ; DOSDATA segment start offset from beginning of MSDOS.SYS file: 32432 (7EB0h)
 49762                                  ; (3DD0h+7EB0h = 0BC80h) - for MSDOS 5.0 kernel file -
 49763                                  ; ----------------------------------------------------------------------------
 49764                                  
 49765                                  ; 04/11/2022
 49766                                  
 49767                                  ;DOSDATA:0000h
 49768                                  
 49769 00008642 90<rep Eh>              align 16
 49770                                  
 49771                                  ; ----------------------------------------------------------------------------
 49772                                  ; 06/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 49773                                  ; ----------------------------------------------------------------------------
 49774                                  
 49775                                  segment .data  vstart=0 ; 06/12/2022
 49776                                  
 49777                                  ; ============================================================================
 49778                                  
 49779                                  ; 06/12/2022
 49780                                  ;DOSDATASTART equ $
 49781                                  DOSDATASTART:
 49782                                  
 49783                                  ;hkn; add 4 bytes to get correct offsets since jmp has been removed in START
 49784                                  
 49785                                  	;; 03/11/2022
 49786                                  	;jmp	DOSINIT		; MSDOS 5.0 - MSDOS.SYS (DOSDATA:0000h)
 49787                                  
 49788                                  	; 04/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 49789                                  	;db	4 dup (?)	
 49790 00000000 00<rep 4h>              	times	4 db 0
 49791                                  
 49792                                  	; 29/04/2019 - Retro DOS v4.0 modification
 49793                                  	;dw 	_$STARTCODE ; DOSCODE offset and/or size of DOSDATA
 49794                                  	;dw	0
 49795                                  
 49796                                  	;EVEN
 49797                                  
 49798                                  ;align 2
 49799                                  
 49800                                  ; WANGO!!! The following word is used by SHARE and REDIR to determin data
 49801                                  ; area compatability. This location must be incremented EACH TIME the data
 49802                                  ; area here gets mucked with.
 49803                                  ;
 49804                                  ; Also, do NOT change this position relative to DOSDATA:0.
 49805                                  
 49806                                  MSCT001S:	; LABEL BYTE
 49807                                  	
 49808                                  DataVersion:	
 49809 00000004 0100                    	dw	1	;AC000; [SYSTEM] version number for DOS DATA
 49810                                  
 49811                                  ;hkn; add 8 bytes to get correct offsets since BugTyp, BugLev and "BUG " has 
 49812                                  ;hkn; been removed to DOSCODE above
 49813                                  
 49814                                  ;M044
 49815                                  ; First part of save area for saving last para of Window memory
 49816                                  
 49817                                  WinoldPatch1:	; db 8 dup (?)	;M044
 49818 00000006 00<rep 8h>              	times	8 db 0
 49819                                  
 49820                                  	; MSDOS 6.21 DOSDATA:000Eh
 49821                                  MYNUM:			; Offset 000Eh
 49822 0000000E 0000                    	dw	0	; [SYSTEM] A number that goes with MYNAME
 49823                                  FCBLRU: 		; [SYSTEM] LRU count for FCB cache
 49824 00000010 0000                    	dw	0
 49825                                  OpenLRU:
 49826 00000012 0000                    	dw	0	; [SYSTEM] LRU count for FCB cache opens
 49827                                  OEM_HANDLER: 		
 49828 00000014 FFFFFFFF                	dd	-1	; [SYSTEM] Pointer to OEM handler code
 49829                                  
 49830                                  ;	BUGBUG - who uses LeaveAddr?  What if we want to rework the
 49831                                  ;;			way that we leave DOS???? - jgl
 49832                                  
 49833                                  LeaveAddr:
 49834 00000018 [F603]                  	dw	LeaveDOS  ; <<OFFSET DOSCODE:LeaveDOS>> ; [SYSTEM]
 49835                                  RetryCount:		
 49836 0000001A 0300                    	dw	3	; [SYSTEM] Share retries
 49837                                  RetryLoop:
 49838 0000001C 0100                    	dw	1	; [SYSTEM] Share retries
 49839                                  LastBuffer:
 49840 0000001E FFFFFFFF                	dd	-1	; [SYSTEM] Buffer queue recency pointer
 49841                                  CONTPOS:
 49842 00000022 0000                    	dw	0	; [SYSTEM] location in buffer of next read
 49843                                  arena_head:
 49844 00000024 0000                    	dw	0	; [SYSTEM] Segment # of first arena in memory
 49845                                  
 49846                                  ;; 16/07/2018
 49847                                  ;;***************************************************************************
 49848                                  ;; NOTE: INT 21H AH=52H !  (http://stanislavs.org/helppc/int_21-52.html)
 49849                                  ;;***************************************************************************
 49850                                  ;; INT 21,52 - Get Pointer to DOS "INVARS" (Undocumented)
 49851                                  ;;
 49852                                  ;;	AH = 52h
 49853                                  ;;
 49854                                  ;;	on return:
 49855                                  ;;	ES:BX = pointer to DOS "invars", a table of pointers used by DOS.
 49856                                  ;;		Known "invars" fields follow (varies with DOS version):
 49857                                  ;;
 49858                                  ;;	Offset Size		 Description
 49859                                  ;;
 49860                                  ;;	 -12   word   sharing retry count (DOS 3.1-3.3)
 49861                                  ;;	 -10   word   sharing retry delay  (DOS 3.1-3.3)
 49862                                  ;;	  -8   dword  pointer to current disk buffer (DOS 3.x)
 49863                                  ;;	  -4   word   pointer in DOS code segment of unread CON input;
 49864                                  ;;		      0 indicates no unread input (DOS 3.x)
 49865                                  ;;	  -2   word   segment of first Memory Control Block (MCB)
 49866                                  ;;	  00   dword  pointer to first DRIVE PARAMETER TABLE (A:) in chain
 49867                                  ;;	  04   dword  pointer to DOS System File Table (SFT)
 49868                                  ;;	  08   dword  pointer to $CLOCK device driver
 49869                                  ;;	  0C   dword  pointer to CON device driver
 49870                                  ;;	  10   byte   number of logical drives in system
 49871                                  ;;	  11   word   maximum bytes/block of any block device
 49872                                  ;;	  13   dword  pointer to DOS cache buffer header
 49873                                  ;;	  17 18bytes  NUL device header, first 4 bytes of device header
 49874                                  ;;		      point to the next device in device chain
 49875                                  ;;
 49876                                  ;;***************************************************************************
 49877                                  
 49878                                  ; The following block of data is used by SYSINIT. 
 49879                                  ; Do not change the order or size of this block
 49880                                  
 49881                                  ;SYSINITVAR:
 49882                                  ;----------------------------------------------------------------------------
 49883                                  SYSINITVARS:
 49884                                  DPBHEAD:
 49885 00000026 00000000                	dd	0	; [SYSTEM] Pointer to head of DPB-FAT list
 49886                                  SFT_ADDR:
 49887 0000002A [CC000000]              	dd	SFTABL	; [SYSTEM] Pointer to first SFT table
 49888                                  BCLOCK:
 49889 0000002E 00000000                	dd	0	; [SYSTEM] The CLOCK device
 49890                                  BCON:
 49891 00000032 00000000                	dd	0	; [SYSTEM] Console device entry points
 49892                                  MAXSEC:
 49893 00000036 8000                    	dw	128	; [SYSTEM] Maximum allowed sector size
 49894                                  BUFFHEAD:
 49895 00000038 00000000                	dd	0	; [SYSTEM] Pointer to head of buffer queue
 49896                                  CDSADDR:
 49897 0000003C 00000000                	dd	0	; [SYSTEM] Pointer to curdir structure table
 49898                                  SFTFCB:
 49899 00000040 00000000                	dd	0	; [SYSTEM] pointer to FCB cache table
 49900                                  KEEPCOUNT:
 49901 00000044 0000                    	dw	0	; [SYSTEM] count of FCB opens to keep
 49902                                  NUMIO:
 49903 00000046 00                      	db	0	; [SYSTEM] Number of disk tables
 49904                                  CDSCOUNT:
 49905 00000047 00                      	db	0	; [SYSTEM] Number of CDS structures in above
 49906                                  
 49907                                  ; A fake header for the NUL device
 49908                                  NULDEV:
 49909 00000048 00000000                	dd	0	; [SYSTEM] Link to rest of device list
 49910                                  	;dw	8004h
 49911 0000004C 0480                    	dw	DEVTYP|ISNULL ; [SYSTEM] Null device attributes
 49912 0000004E [CD0D]                  	dw	SNULDEV	; [SYSTEM] Strategy entry point
 49913 00000050 [D30D]                  	dw	INULDEV	; [SYSTEM] Interrupt entry point
 49914 00000052 4E554C2020202020        	db	"NUL     " ; [SYSTEM] Name of null device
 49915                                  SPLICES:
 49916 0000005A 00                      	db	0	; [SYSTEM] TRUE => splices being done
 49917                                  
 49918                                  Special_Entries:
 49919 0000005B 0000                    	dw	0	; [SYSTEM] address of special entries ;AN000;
 49920                                  UU_IFS_DOS_CALL:
 49921 0000005D 00000000                	dd	0	; [SYSTEM] entry for IFS DOS service ;AN000;
 49922                                  ; 
 49923                                  ; UU_IFS_HEADER:
 49924                                  ; 	dd	0	; [SYSTEM] IFS header chain ;AN000;
 49925                                  
 49926                                  ChkCopyProt:
 49927 00000061 0000                    	dw	0	; M068
 49928                                  A20OFF_PSP:
 49929 00000063 0000                    	dw	0	; M068
 49930                                  BUFFERS_PARM1:
 49931 00000065 0000                    	dw	0	; [SYSTEM] value of BUFFERS= ,m	;AN000;
 49932                                  BUFFERS_PARM2:
 49933 00000067 0000                    	dw	0	; [SYSTEM] value of BUFFERS= ,n ;AN000;
 49934                                  BOOTDRIVE:
 49935 00000069 00                      	db	0	; [SYSTEM] the boot drive ;AN000;
 49936                                  DDMOVE:
 49937 0000006A 00                      	db	0 	; [SYSTEM] 1 if we need DWORD move ;AN000;
 49938                                  EXT_MEM_SIZE:
 49939 0000006B 0000                    	dw	0	; [SYSTEM] extended memory size	;AN000;
 49940                                  
 49941                                  HASHINITVAR: ; LABEL   WORD	; AN000;
 49942                                  ;
 49943                                  ; Replaced by next two declarations
 49944                                  ;
 49945                                  ;UU_BUF_HASH_PTR:
 49946                                  ;	dd	0	; [SYSTEM] buffer Hash table addr
 49947                                  ;UU_BUF_HASH_COUNT:
 49948                                  ;	dw	1	; [SYSTEM] number of Hash entries
 49949                                  
 49950                                  BufferQueue:
 49951 0000006D 00000000                	dd	0	; [SYSTEM] Head of the buffer Queue
 49952                                  DirtyBufferCount:
 49953 00000071 0000                    	dw	0	; [SYSTEM] Count of Dirty buffers in the Que
 49954                                  			; BUGBUG ---- change to byte
 49955                                  SC_CACHE_PTR:
 49956 00000073 00000000                	dd	0	; [SYSTEM] secondary cache pointer
 49957                                  SC_CACHE_COUNT:
 49958 00000077 0000                    	dw	0 	; [SYSTEM] secondary cache count
 49959                                  BuffInHMA:
 49960 00000079 00                      	db	0	; Flag to indicate that buffs are in HMA
 49961                                  LoMemBuff:
 49962 0000007A 00000000                	dd	0	; Ptr to intermediate buffer
 49963                                  			;  in Low mem when buffs are in HMA
 49964                                  ;
 49965                                  ; All variables which have UU_ as prefix can be reused for other
 49966                                  ; purposes and can be renamed. All these variables were used for
 49967                                  ; EMS support of Buffer Manager. Now they are useless for Buffer
 49968                                  ; manager ---- MOHANS
 49969                                  ;
 49970                                  	;I_am	UU_BUF_EMS_FIRST_PAGE,3,<0,0,0>  
 49971                                  UU_BUF_EMS_FIRST_PAGE:	
 49972 0000007E 000000                  	db	0,0,0	; holds the first page above 640K
 49973                                  
 49974                                  	;;I_am	UU_BUF_EMS_NPA640,WORD,<0> ; holds the number of pages 
 49975                                  ;UU_BUF_EMS_NPA640:			   ; above 640K	
 49976                                  ;	dw	0			
 49977                                  
 49978                                  CL0FATENTRY:
 49979 00000081 FFFF                    	dw	-1	; M014:	Holds the data that
 49980                                  			; is used in pack/unpack rts.
 49981                                  			; in fat.asm if cluster 0 is specified.
 49982                                  			; SR;
 49983                                  IoStatFail:
 49984 00000083 00                      	db	0	; IoStatFail has been added to 
 49985                                  			; record a fail on an I24 
 49986                                  			; issued from IOFUNC on a status call. 
 49987                                  
 49988                                  ;***	I_am	UU_BUF_EMS_MODE,BYTE,<-1>	; EMS mode 	;AN000;
 49989                                  ;***	I_am	UU_BUF_EMS_HANDLE,BYTE		; buffer EMS handle ;AN000;
 49990                                  ;***	I_am	UU_BUF_EMS_PAGE_FRAME,WORD ,<-1>; EMS page frame # ;AN000;
 49991                                  ;***	I_am	UU_BUF_EMS_SEG_CNT,WORD,<1>	; EMS seg count	;AN000;
 49992                                  ;***	I_am	UU_BUF_EMS_PFRAME,WORD		; EMS page frame seg address ;AN000;
 49993                                  ;***	I_am	UU_BUF_EMS_RESERV,WORD,<0> 	; reserved	;AN000;
 49994                                  ;
 49995                                  ;***	I_am	UU_BUF_EMS_MAP_BUFF,1,<0>	; this is not used to save the
 49996                                  						; state of the 	buffers page.
 49997                                  						; This one byte is retained to
 49998                                  						; keep the size of this data 
 49999                                  						; block the same.;
 50000                                  ALLOCMSAVE:
 50001 00000084 00                      	db	0	; M063: temp var. used to 
 50002                                  			; M063: save alloc method in
 50003                                  			; M063: msproc.asm
 50004                                  A20OFF_COUNT:
 50005 00000085 00                      	db	0	; M068: indicates the # of 
 50006                                  			; M068: int 21 calls for 
 50007                                  			; M068: which A20 is off
 50008                                  DOS_FLAG:
 50009 00000086 00                      	db	0	; see DOSSYM.INC for Bit 
 50010                                  			; definitions
 50011                                  UNPACK_OFFSET:
 50012 00000087 0000                    	dw	0	; saves pointer to the start
 50013                                  			; of unpack code in exepatch.
 50014                                  			; asm.
 50015                                  UMBFLAG:
 50016 00000089 00                      	db	0 	; M003: bit 0 indicates the 
 50017                                  			; M003: link state of the UMBs
 50018                                  			; M003: whether linked or not 
 50019                                  			; M003: to the DOS arena chain
 50020                                  SAVE_AX:
 50021 0000008A 0000                    	dw	0	; M000: temp varibale to store ax
 50022                                  			; M000: in msproc.asm
 50023                                  UMB_HEAD:
 50024 0000008C FFFF                    	dw	-1	; M000: this is initialized to  
 50025                                  			; M000: the first umb arena by 
 50026                                  			; M000: BIOS sysinit.
 50027                                  START_ARENA:
 50028 0000008E 0100                    	dw	1	; M000: this is the first arena 
 50029                                  			; M000: from which DOS will 
 50030                                  			; M000: start its scan for alloc.
 50031                                  
 50032                                  ; End of SYSINITVar block
 50033                                  ;----------------------------------------------------------------------------
 50034                                  
 50035                                  ; 25/04/2019 - Retro DOS v4.0
 50036                                  
 50037                                  ; 16/07/2018
 50038                                  ; MSDOS 3.3 (& MDOS 6.0)
 50039                                  
 50040                                  ;
 50041                                  ; Sharer jump table
 50042                                  ;
 50043                                  
 50044                                  ;PUBLIC	JShare
 50045                                  	;EVEN
 50046                                  
 50047                                  ;JShare	LABEL	DWORD
 50048                                  ;	DW	OFFSET DOSCODE:BadCall, 0
 50049                                  ;	DW	OFFSET DOSCODE:OKCall,  0  ;	1   MFT_enter
 50050                                  ;	DW	OFFSET DOSCODE:OKCall,  0  ;	2   MFTClose
 50051                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	3   MFTclU
 50052                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	4   MFTCloseP
 50053                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	5   MFTCloN
 50054                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	6   set_block
 50055                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	7   clr_block
 50056                                  ;	DW	OFFSET DOSCODE:OKCall,  0  ;	8   chk_block
 50057                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	9   MFT_get
 50058                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	10  ShSave
 50059                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	11  ShChk
 50060                                  ;	DW	OFFSET DOSCODE:OKCall , 0  ;	12  ShCol
 50061                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	13  ShCloseFile
 50062                                  ;	DW	OFFSET DOSCODE:BadCall, 0  ;	14  ShSU
 50063                                  
 50064                                  align 2
 50065                                  
 50066                                  JShare:
 50067 00000090 [3107]0000              		DW	BadCall,0
 50068 00000094 [3507]0000              MFT_enter:	DW	OKCall, 0  ; 1   MFT_enter
 50069 00000098 [3507]0000              MFTClose:	DW	OKCall, 0  ; 2   MFTClose
 50070 0000009C [3107]0000              MFTclU:		DW	BadCall,0  ; 3   MFTclU
 50071 000000A0 [3107]0000              MFTCloseP:	DW	BadCall,0  ; 4   MFTCloseP
 50072 000000A4 [3107]0000              MFTCloN:	DW	BadCall,0  ; 5   MFTCloN
 50073 000000A8 [3107]0000              set_block:	DW	BadCall,0  ; 6   set_block
 50074 000000AC [3107]0000              clr_block:	DW	BadCall,0  ; 7   clr_block
 50075 000000B0 [3507]0000              chk_block:	DW	OKCall, 0  ; 8   chk_block
 50076 000000B4 [3107]0000              MFT_get:	DW	BadCall,0  ; 9   MFT_get
 50077 000000B8 [3107]0000              ShSave:		DW	BadCall,0  ; 10  ShSave
 50078 000000BC [3107]0000              ShChk:		DW	BadCall,0  ; 11  ShChk
 50079 000000C0 [3507]0000              ShCol:		DW	OKCall, 0  ; 12  ShCol
 50080 000000C4 [3107]0000              ShCloseFile:	DW	BadCall,0  ; 13  ShCloseFile
 50081 000000C8 [3107]0000              ShSU:		DW	BadCall,0  ; 14  ShSU
 50082                                  
 50083                                  
 50084                                  ;============================================================================
 50085                                  ; CONST2.ASM (MSDOS 6.0, 1991)
 50086                                  ;============================================================================
 50087                                  ; 25/04/2019 - Retro DOS 4.0 
 50088                                  ; 16/07/2018 - Retro DOS 3.0	
 50089                                  
 50090                                  ;Break <Initialized data and data used at DOS initialization>
 50091                                  ;----------------------------------------------------------------------------
 50092                                  
 50093                                  ; We need to identify the parts of the data area that are relevant to tasks
 50094                                  ; and those that are relevant to the system as a whole.  Under 3.0, the system
 50095                                  ; data will be gathered with the system code.  The process data under 2.x will
 50096                                  ; be available for swapping and under 3.0 it will be allocated per-process.
 50097                                  ;
 50098                                  ; The data that is system data will be identified by [SYSTEM] in the comments
 50099                                  ; describing that data item.
 50100                                  
 50101                                  ;DOSDATA SEGMENT WORD PUBLIC 'DATA'
 50102                                  
 50103                                  ;
 50104                                  ; Table of routines for assignable devices
 50105                                  ;
 50106                                  ; MSDOS allows assignment if the following standard devices:
 50107                                  ;   stdin  (usually CON input)
 50108                                  ;   stdout (usually CON output)
 50109                                  ;   auxin  (usually AUX input)
 50110                                  ;   auxout (usually AUX output)
 50111                                  ;   stdlpt (usually PRN output)
 50112                                  ;
 50113                                  ; SPECIAL NOTE:
 50114                                  ;   Status of a file is a strange idea. We choose to handle it in this manner:
 50115                                  ;   If we're not at end-of-file, then we always say that we have a character.
 50116                                  ;   Otherwise, we return ^Z as the character and set the ZERO flag. In this
 50117                                  ;   manner we can support program written under the old DOS (they use ^Z as EOF
 50118                                  ;   on devices) and programs written under the new DOS (they use the ZERO flag
 50119                                  ;   as EOF).
 50120                                  
 50121                                  ; Default SFTs for boot up
 50122                                  
 50123                                  		;PUBLIC	SFTABL
 50124                                  
 50125                                  SFTABL:	   ; LABEL   DWORD		; [SYSTEM] file table
 50126 000000CC FFFF                    		DW -1			; [SYSTEM] link to next table
 50127 000000CE FFFF                    		DW -1			; [SYSTEM] link seg to next table
 50128                                  		;dw 5 ; 24/03/2024
 50129 000000D0 0500                    		DW sf_default_number	; [SYSTEM] Number of entries in table
 50130                                  		;times 295 db 0 ; MSDOS 6.0 ; PCDOS 7.1  ; 24/03/2024
 50131 000000D2 00<rep 127h>            		times (sf_default_number*sf_entry_size) db 0
 50132                                  
 50133                                  ; the next two variables relate to the position of the logical stdout/stdin
 50134                                  ; cursor. They are only meaningful when stdin/stdout are assigned to the
 50135                                  ; console.
 50136                                  		; DOSDATA:01F9h (MSDOS 6.21) ; PCDOS 7.1 ; 24/03/2024
 50137 000001F9 00                      CARPOS:		db 0			; [SYSTEM] cursor position in stdin
 50138 000001FA 00                      STARTPOS:	db 0			; [SYSTEM] position of cursor at beginning
 50139                                  					;	   of buffered input call
 50140 000001FB 00<rep 80h>             INBUF:		times 128 db 0		; [SYSTEM] general device input buffer
 50141 0000027B 00<rep 83h>             CONBUF:		times 131 db 0		; [SYSTEM] The rest of INBUF and console buffer
 50142                                  		; DOSDATA:02FEh (MSDOS 6.21) ; PCDOS 7.1
 50143 000002FE 00                      PFLAG:		db 0			; [SYSTEM] printer echoing flag
 50144 000002FF 00                      VERFLG:		db 0			; [SYSTEM] Initialize with verify off
 50145 00000300 03                      CHARCO:		db 00000011b ; 3	; [SYSTEM] Allows statchks every 4 chars...
 50146                                  switch_character:
 50147 00000301 2F                      chSwitch:	db '/'			; UNUSED - obsolete datum, can be reused
 50148 00000302 00                      AllocMethod:	db 0			; [SYSTEM] how to alloc first(best)last
 50149 00000303 00                      fShare:		db 0			; [SYSTEM] TRUE => sharing installed
 50150 00000304 01                      DIFFNAM:	db 1			; [SYSTEM] Indicates when MYNAME has changed
 50151 00000305 20<rep 10h>             MYNAME:		times 16 db 20h		; [SYSTEM] My network name
 50152                                  
 50153                                  ; The following table is a list of addresses that the sharer patches to be
 50154                                  ; PUSH AX to enable the critical sections
 50155                                  
 50156                                  		; DOSDATA:0315h (MSDOS 6.21) ; PCDOS 7.1 ; 24/03/2024
 50157                                  
 50158                                  ;PUBLIC	CritPatch
 50159                                  
 50160                                  CritPatch:	; LABEL WORD
 50161                                  
 50162                                  ;IRP sect,<critDisk,critDevice>
 50163                                  
 50164                                  ;IF (NOT REDIRECTOR) AND (NOT SHAREF)
 50165                                  ;
 50166                                  ;SR; Change code patch address to a variable in data segment
 50167                                  ;
 50168                                  ;       dw OFFSET DOSDATA: redir_patch
 50169                                  ;       dw OFFSET DOSDATA: redir_patch
 50170                                  ;
 50171                                  ;;hkn	Short_Addr  E&sect
 50172                                  ;;hkn	Short_Addr  L&sect
 50173                                  ;
 50174                                  ;ELSE
 50175                                  ;	DW	0
 50176                                  ;	DW	0
 50177                                  ;ENDIF
 50178                                  ;ENDM
 50179                                  ;	DW	0
 50180                                  
 50181                                  	; 25/07/2019 - Retro DOS v4.0 (MSDOS 6.21)
 50182                                   
 50183 00000315 [650D]                  	dw 	redir_patch
 50184 00000317 [650D]                  	dw 	redir_patch			
 50185 00000319 [650D]                  	dw	redir_patch
 50186 0000031B [650D]                  	dw 	redir_patch
 50187                                  
 50188 0000031D 0000                    	dw	0
 50189                                  
 50190                                  ; WARNING!!! PRINT and PSPRINT *REQUIRE* ErrorMode to precede INDOS.
 50191                                  ; Also, IBM server 1.0 requires this also.
 50192                                  
 50193                                  	;db	90h ; 24/03/2024
 50194                                  
 50195                                  	;EVEN			; Force swap area to start on word boundry
 50196                                  
 50197 0000031F 90                      align 2
 50198                                  	;PUBLIC	SWAP_START
 50199                                  
 50200                                  ; 10/03/2024 - Retro DOS v5.0
 50201                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0320h
 50202                                  SWAP_START:	; LABEL BYTE
 50203 00000320 00                      ERRORMODE:	db 0		; Flag for INT 24 processing
 50204 00000321 00                      INDOS:		db 0		; DOS status for interrupt processing
 50205 00000322 FF                      WPERR:		db -1		; Write protect error flag
 50206 00000323 00                      EXTERR_LOCUS:	db 0		; Extended Error Locus
 50207 00000324 0000                    EXTERR:		dw 0		; Extended Error code
 50208                                  
 50209                                  ;WARNING Following two bytes Accessed as word in $GetExtendedError
 50210 00000326 00                      EXTERR_ACTION:	db 0		; Extended Error Action
 50211 00000327 00                      EXTERR_CLASS:	db 0		; Extended Error Class
 50212                                  ; end warning
 50213                                   
 50214 00000328 00000000                EXTERRPT:	dd 0		; Extended Error pointer
 50215                                  
 50216 0000032C 80000000                DMAADD:		dd 80h		; User's disk transfer address (disp/seg)
 50217 00000330 0000                    CurrentPDB:	dw 0		; Current process identifier
 50218 00000332 0000                    ConC_Spsave:	dw 0		; saved SP before ^C
 50219 00000334 0000                    exit_code:	dw 0		; exit code of last proc.
 50220 00000336 00                      CURDRV:		db 0		; Default drive (init A)
 50221 00000337 00                      CNTCFLAG:	db 0		; ^C check in dispatch disabled
 50222                                  ;				; F.C. 2/17/86
 50223 00000338 00                      CPSWFLAG:	db 0		; Code Page Switching Flag  DOS 4.00
 50224 00000339 00                      CPSWSAVE:	db 0		; copy of above in case of ABORT
 50225                                  ;align 2
 50226                                  ; 10/03/2024 - Retro DOS v5.0
 50227                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:033Ah
 50228                                  SWAP_ALWAYS:	; 05/08/2018
 50229 0000033A 0000                    USER_IN_AX:	dw 0		; User INPUT AX value (used for
 50230                                  				;   extended error type stuff.
 50231                                  				;   NOTE: does not have Correct value on
 50232                                  				;   1-12, OEM, Get/Set CurrentPDB,
 50233                                  				;   GetExtendedError system calls)
 50234 0000033C 0000                    PROC_ID:	dw 0		; PID for sharing (0 = local)
 50235 0000033E 0000                    USER_ID:	dw 0		; Machine for sharing (0 = local)
 50236 00000340 0000                    FirstArena:	dw 0		; first free block found
 50237 00000342 0000                    BestArena:	dw 0		; best free block found
 50238 00000344 0000                    LastArena:	dw 0		; last free block found
 50239 00000346 0000                    ENDMEM:		dw 0		; End of memory used in DOSINIT
 50240 00000348 0000                    LASTENT:	dw 0		; Last entry for directory search
 50241 0000034A 00                      FAILERR:	db 0		; NZ if user did FAIL on I 24
 50242 0000034B 00                      ALLOWED:	db 0		; Allowed I 24 answers (see allowed_)
 50243 0000034C 00                      NoSetDir:	db 0		; true -> do not set directory
 50244 0000034D 00                      DidCTRLC:	db 0		; true -> we did a ^C exit
 50245 0000034E 00                      SpaceFlag:	db 0		; true -> embedded spaces are allowed in FC
 50246                                  
 50247                                  ; Warning!  The following items are accessed as a WORD in TIME.ASM
 50248                                  	;EVEN
 50249 0000034F 90                      align 2
 50250                                  		; DOSDATA:0350h (MSDOS 6.21)
 50251 00000350 00                      DAY:		db 0		; Day of month
 50252 00000351 00                      MONTH:		db 0		; Month of year
 50253 00000352 0000                    YEAR:		dw 0		; Year (with century)
 50254 00000354 FFFF                    DAYCNT:		dw -1		; Day count from beginning of year
 50255 00000356 00                      WEEKDAY:	db 0		; Day of week
 50256                                  ; end warning
 50257                                  
 50258 00000357 00                      CONSWAP:	db 0		; TRUE => console was swapped during device read
 50259 00000358 01                      IDLEINT:	db 1		; TRUE => idle int is allowed
 50260 00000359 00                      fAborting:	db 0		; TRUE => abort in progress
 50261                                  
 50262                                  ; Combination of all device call parameters
 50263                                  	;PUBLIC	DEVCALL 	;
 50264                                  ;DEVCALL SRHEAD	<>		; basic header for disk packet
 50265                                  DEVCALL: ; 08/08/2018
 50266 0000035A 00                      DEVCALL_REQLEN:  db 0 		;Length in bytes of request block
 50267 0000035B 00                      DEVCALL_REQUNIT: db 0		;Device unit number
 50268 0000035C 00                      DEVCALL_REQFUNC: db 0		;Type of request
 50269 0000035D 0000                    DEVCALL_REQSTAT: dw 0		;Status Word
 50270 0000035F 00<rep 8h>                       times 8 db 0		;Reserved for queue links
 50271                                  
 50272                                  	;PUBLIC	CALLUNIT
 50273                                  CALLUNIT: ; LABEL   BYTE	; unit number for disk
 50274                                  CALLFLSH: ; LABEL   WORD	;
 50275 00000367 00                      CALLMED:	db 0		; media byte
 50276                                  CALLBR:	  ; LABEL   DWORD	;
 50277                                  	;PUBLIC	CALLXAD 	;
 50278                                  CALLXAD:  ; LABEL   DWORD	;
 50279 00000368 00                      CALLRBYT:	db 0		;
 50280                                  	;PUBLIC	CALLVIDM	;
 50281                                  CALLVIDM: ; LABEL   DWORD	;
 50282 00000369 00<rep 3h>              	times 3 db 0	;
 50283                                  	;PUBLIC CallBPB		;
 50284                                  CALLBPB:  ; LABEL   DWORD	;
 50285                                  CALLSCNT:			;
 50286 0000036C 0000                    		dw 0		;
 50287                                  	;PUBLIC	CALLSSEC	;
 50288                                  CALLSSEC: ; LABEL   WORD	;
 50289 0000036E 0000                    		dw 0		;
 50290 00000370 00000000                CALLVIDRW:	dd 0		;
 50291                                  ;MSDOS 6.0
 50292 00000374 00000000                CALLNEWSC:	dd 0		; starting sector for >32mb
 50293 00000378 00000000                CALLDEVAD:	dd 0		; stash for device entry point
 50294                                  
 50295                                  ; Same as above for I/O calls	;
 50296                                  				;
 50297                                  	;PUBLIC	IOCall		;
 50298                                  ;IOCALL	SRHEAD	<>		;
 50299                                  IOCALL:	; 07/08/2018
 50300 0000037C 00                      IOCALL_REQLEN:	db 0		;Length in bytes of request block
 50301 0000037D 00                      IOCALL_REQUNIT:	db 0		;Device unit number
 50302 0000037E 00                      IOCALL_REQFUNC: db 0		;Type of request
 50303 0000037F 0000                    IOCALL_REQSTAT: dw 0		;Status Word
 50304 00000381 00<rep 8h>              	times 8	db 0		;Reserved for queue links
 50305                                  IOFLSH:	  ; LABEL   WORD	;
 50306                                          ;PUBLIC  IORCHR		;
 50307                                  IORCHR:	  ; LABEL   BYTE	;
 50308 00000389 00                      IOMED:		db 0		;
 50309 0000038A 00000000                IOXAD:		dd 0		;
 50310 0000038E 0000                    IOSCNT:		dw 0		;
 50311 00000390 0000                    IOSSEC:		dw 0		;
 50312                                  
 50313                                  ; Call struct for DSKSTATCHK	;
 50314 00000392 0E                      DSKSTCALL:	db DRDNDHL 	; = 14
 50315 00000393 00                      		db 0
 50316 00000394 05                      DSKSTCOM:	db DEVRDND	; = 5
 50317 00000395 0000                    DSKSTST:	dw 0		;
 50318 00000397 00<rep 8h>              	times 8	db 0		;
 50319 0000039F 00                      DSKCHRET:	db 0		;
 50320                                  
 50321                                  ;hkn; short_addr has been changed to provide offset in DOSCODE.
 50322                                  ;hkn; deviobuf is in DATA seg (DOSDATA)
 50323                                  ;hkn   short_addr  DEVIOBUF	;
 50324                                  	
 50325 000003A0 [BC03]                  DEVIOBUF_PTR	dw DEVIOBUF
 50326 000003A2 0000                    DOSSEG_INIT	dw 0		; DOS segment set at Init
 50327 000003A4 0100                    DSKSTCNT:	dw 1		;
 50328 000003A6 0000                    		dw 0		;
 50329                                  
 50330 000003A8 00                      CreatePDB:	db 0		; flag for creating a process
 50331                                  
 50332                                  ;MSDOS 6.0
 50333                                  Lock_Buffer:	; LABEL  DWORD	;MS. DOS Lock Buffer for Ext Lock
 50334 000003A9 00000000                		dd 0		;MS. position
 50335 000003AD 00000000                		dd 0		;MS. length
 50336                                  
 50337                                  ;hkn; the foll. was moved from dosmes.asm.
 50338                                  
 50339                                  ; 29/01/2024 - Retro DOS v5.0 (PCDOS v7.1 IBMDOS.COM)
 50340                                  ; DOSDATA:03B1h
 50341 000003B1 90                      IOCTL_drvnum:	db 90h ; nop
 50342                                  
 50343                                  	;EVEN
 50344                                  align 2				; needed to maintain offsets
 50345                                  
 50346                                  		; DOSDATA:03B2h (MSDOS 6.21)
 50347                                  USERNUM:
 50348 000003B2 0000                     		dw 0		; 24 bit user number
 50349 000003B4 00                      		db 0
 50350                                  ;IF IBM
 50351                                  ;IF IBMCOPYRIGHT
 50352                                  ; 24/03/2024 (PCDOS v7.1 IBMDOS.COM)	
 50353 000003B5 00                      OEMNUM:		DB 0		; 8 bit OEM number
 50354                                  ;ELSE
 50355                                  ;OEMNUM:	DB 0FFh		; 8 bit OEM number
 50356                                  ;ENDIF
 50357                                  ;ELSE
 50358                                  ;OEMNUM:	DB 0FFh		; (MSDOS 6.22) ; 24/03/2024
 50359                                  ;ENDIF
 50360                                  
 50361                                  ;============================================================================
 50362                                  ; MS_DATA.ASM (MSDOS 6.0, 1991)
 50363                                  ;============================================================================
 50364                                  ; 25/04/2019 - Retro DOS 4.0
 50365                                  
 50366                                  ; Retro DOS v4.0 NOTE: (by Erdogan Tan, 25/04/2019)
 50367                                  ; ----------------------------------------------------------
 50368                                  ; This data section which was named as uninitialized data
 50369                                  ; (as overlayed by initialization code) but follows 
 50370                                  ; initialized data section from DOSDATA:03B6h address
 50371                                  ; (in otherwords, the method is different than MSDOS 3.3,
 50372                                  ; and there is not overlaying..)
 50373                                  ; **********************************************************
 50374                                  ; Reference: MSDOS 6.21 kernel DOSDATA section (4970 bytes)
 50375                                  ; follows DOSCODE section in the kernel file (MSDOS.SYS) 
 50376                                  ; (it is located at offset 0BF70h, file offset 0BF70h-3DE0h) 
 50377                                  ; but starts from offset 0 (ORG 0) and ends at offset 1370h.
 50378                                  ; TIMEBUF is at offset 03B6h.
 50379                                  ; **********************************************************	
 50380                                  
 50381                                  ;Break <Uninitialized data overlayed by initialization code>
 50382                                  ;----------------------------------------------------------------------------
 50383                                  ;DOSDATA    SEGMENT WORD PUBLIC 'DATA'
 50384                                  ; Init code overlaps with data area below
 50385                                  
 50386                                  ; 	ORG     0
 50387                                  
 50388                                  MSDAT001S:	; label byte
 50389                                  
 50390                                  ; DOSDATA:03B6h	; MSDOS 6.21 (MSDOS.SYS, file offset 0BF70h-3DE0h+3B6h)
 50391                                  TIMEBUF: ;	times 6 db 0
 50392 000003B6 0000<rep 3h>            	times 3 dw	0		; Time read from clock device
 50393 000003BC 0000                    DEVIOBUF:	dw	0		; Buffer for I/O under file assignment
 50394                                  
 50395                                  ; The following areas are used as temp buffer in EXEC system call
 50396                                  
 50397                                  ; DOSDATA:03BEh
 50398                                  OPENBUF: ;times 64  dw	0
 50399 000003BE 00<rep 80h>             	times	128 db	0		; buffer for name operations
 50400                                  RENBUF:	
 50401 0000043E 00<rep 80h>             	times	128 db	0		; buffer for rename destination
 50402                                  
 50403                                  ; Buffer for search calls
 50404                                  SEARCHBUF:	
 50405 000004BE 00<rep 35h>             	times	53  db	0		; internal search buffer
 50406                                  DUMMYCDS:  ;times 88 db 0
 50407 000004F3 00<rep 58h>             	times	curdirLen db 0
 50408                                  
 50409                                  ; End of contiguous buffer
 50410                                   
 50411                                  ; Temporary directory entry for use by many routines. Device directory
 50412                                  ; entries (bogus) are built here.
 50413                                  
 50414                                  ; DOSDATA:054Bh
 50415                                  
 50416                                  DEVFCB:	; LABEL   BYTE			; Uses NAME1, NAME2, combined
 50417                                  
 50418                                  ; WARNING..  do not alter position of NAME1 relative to DEVFCB
 50419                                  ; without first examining BUILD_DEVICE_ENT. Look carefully at DOS_RENAME
 50420                                  ; as well as it is the only guy who uses NAME2 and DESTSTART.
 50421                                  
 50422                                  NAME1:	
 50423 0000054B 00<rep Ch>                      times 	12 db	0		; File name buffer
 50424                                  NAME2:
 50425 00000557 00<rep Dh>              	times	13 db	0 		;
 50426                                  DESTSTART:
 50427 00000564 0000                    	dw	0			;
 50428                                          ;DB	((SIZE DIR_ENTRY) - ($ - DEVFCB)) DUP (?)
 50429                                  	;times	5  db	0
 50430 00000566 00<rep 5h>              	times	((dir_entry.size)-($-DEVFCB)) db 0
 50431                                  
 50432                                  ; End Temporary directory entry.
 50433                                  
 50434 0000056B 00                      ATTRIB:	db	0		; storage for file attributes
 50435                                  EXTFCB:	
 50436 0000056C 00                      	db	0		; TRUE => extended FCB in use
 50437                                  SATTRIB:
 50438 0000056D 00                      	db	0		; Storage for search attributes
 50439                                  OPEN_ACCESS:
 50440 0000056E 00                      	db	0		; access of open system call
 50441                                  FOUNDDEL:
 50442 0000056F 00                      	db	0		; true => file was deleted
 50443                                  FOUND_DEV:
 50444 00000570 00                      	db	0		; true => search found a device
 50445                                  FSPLICE:
 50446 00000571 00                      	db	0		; true => do a splice in transpath
 50447                                  FSHARING:
 50448 00000572 00                      	db	0		; TRUE => no redirection
 50449                                  SECCLUSPOS:
 50450 00000573 00                      	db	0		; Position of first sector within cluster
 50451 00000574 00                      TRANS:	db	0		;
 50452 00000575 00                      READOP:	db	0		;
 50453                                  THISDRV:
 50454 00000576 00                      	db	0		;
 50455                                  CLUSFAC:
 50456 00000577 00                      	db	0		;
 50457                                  CLUSSPLIT:
 50458 00000578 00                      	db	0		;
 50459                                  INSMODE:
 50460 00000579 00                      	db	0		; true => insert mode in buffered read
 50461 0000057A 00                      CMETA:	db	0		; count of meta'ed components found
 50462 0000057B 00                      VOLID:	db	0		;
 50463                                  EXIT_TYPE:
 50464 0000057C 00                      	db	0		; type of exit...
 50465                                  	; 24/03/2024	 
 50466 0000057D 00                      	db	0   ; PCDOS 7.1 - DOSDATA:057Dh
 50467                                  	;db	90h ; MSDOS 6.22 - DOSDATA:057Dh
 50468                                  
 50469                                  	;EVEN
 50470                                  
 50471                                  align 2
 50472                                  
 50473                                  ; DOSDATA:057Eh
 50474                                  
 50475                                  ; WARNING - the following two items are accessed as a word
 50476                                  
 50477                                  CREATING:
 50478 0000057E 00                      	db	0		; true => creating a file
 50479 0000057F 00                      DELALL:	db	0		; = 0 iff BUGBUG
 50480                                  				; = DIRFREE iff BUGBUG
 50481                                  EXITHOLD:
 50482 00000580 00000000                	dd	0		; Temp location for proc terminate
 50483                                  USER_SP:
 50484 00000584 0000                    	dw	0		; User SP for system call
 50485                                  USER_SS:
 50486 00000586 0000                    	dw	0		; User SS for system call
 50487                                  CONTSTK:
 50488 00000588 0000                    	dw	0		;
 50489                                  THISDPB:
 50490 0000058A 00000000                	dd	0		;
 50491                                  CLUSSAVE:
 50492 0000058E 0000                    	dw	0		;
 50493                                  CLUSSEC:
 50494 00000590 00000000                	dd	0		;>32mb			AC0000
 50495                                  PREREAD:
 50496 00000594 0000                    	dw	0		; 0 means preread; 1 means optional
 50497 00000596 0000                    FATBYT:	dw	0		; Used by ALLOCATE
 50498                                  FATBYTE:
 50499 00000598 0000                    	dw	0		; Used by $SLEAZEFUNC
 50500                                  ; DOSDATA:059Ah
 50501 0000059A 00000000                DEVPT:	dd	0		;
 50502                                  THISSFT:
 50503 0000059E 00000000                	dd	0		; Address of user SFT
 50504                                  THISCDS:
 50505 000005A2 00000000                	dd	0		; Address of current CDS
 50506                                  THISFCB:
 50507 000005A6 00000000                	dd	0		; Address of user FCB
 50508 000005AA FFFF                    SFN:	dw	-1		; SystemFileNumber found for accessfile
 50509 000005AC 0000                    JFN:	dw	0		; JobFileNumber found for accessfile
 50510 000005AE 00000000                PJFN:	dd	0		; PointerJobFileNumber found for accessfile
 50511                                  WFP_START:
 50512 000005B2 0000                    	dw	0		;
 50513                                  REN_WFP:
 50514 000005B4 0000                    	dw	0		;
 50515                                  CURR_DIR_END:
 50516 000005B6 0000                    	dw	0		;
 50517                                  NEXTADD:
 50518 000005B8 0000                    	dw	0		;
 50519                                  LASTPOS:
 50520 000005BA 0000                    	dw	0		;
 50521                                  CLUSNUM:
 50522 000005BC 0000                    	dw	0		;
 50523 000005BE 00000000                DIRSEC:	dd	0		;>32mb			AC0000
 50524                                  DIRSTART:
 50525 000005C2 0000                    	dw	0		;
 50526 000005C4 00000000                SECPOS:	dd	0		;>32mb Position of first sector accessed
 50527 000005C8 00000000                VALSEC:	dd	0		;>32mb Number of valid (previously written)
 50528                                                                  ; sectors
 50529                                  BYTSECPOS:
 50530 000005CC 0000                    	dw	0		; Position of first byte within sector
 50531                                  BYTPOS: ;times	4 db 0		; Byte position in file of access
 50532 000005CE 0000<rep 2h>                    times	2 dw 0
 50533                                  BYTCNT1:
 50534 000005D2 0000                    	dw	0		; No. of bytes in first sector
 50535                                  BYTCNT2:
 50536 000005D4 0000                    	dw	0		; No. of bytes in last sector
 50537 000005D6 0000                    SECCNT:	dw	0		; No. of whole sectors
 50538                                  ; DOSDATA:05D8h
 50539                                  ENTFREE:
 50540 000005D8 0000                    	dw	0		;
 50541                                  ENTLAST:
 50542 000005DA 0000                    	dw	0		;
 50543                                  NXTCLUSNUM:
 50544 000005DC 0000                    	dw	0		;
 50545                                  GROWCNT:
 50546 000005DE 00000000                	dd	0		;
 50547 000005E2 00000000                CURBUF:	dd	0		;
 50548 000005E6 00000000                CONSFT:	dd	0		; SFT of console swapped guy.
 50549 000005EA 0000                    SAVEBX:	dw	0		;
 50550 000005EC 0000                    SAVEDS:	dw	0		;
 50551                                  RESTORE_TMP:
 50552 000005EE 0000                    	dw	0		; return address for restore world
 50553 000005F0 0000                    NSS:	dw	0
 50554 000005F2 0000                    NSP:	dw	0
 50555                                  ; DOSDATA:05F4h
 50556                                  EXTOPEN_FLAG:
 50557 000005F4 0000                    	dw	0		;FT. extended open input flag	;AN000;
 50558                                  EXTOPEN_ON:
 50559 000005F6 00                      	db	0		;FT. extended open conditional flag ;AN000;
 50560                                  EXTOPEN_IO_MODE:
 50561 000005F7 0000                    	dw	0		;FT. extended open io mode	;AN000;
 50562                                  SAVE_DI:
 50563 000005F9 0000                    	dw	0		;FT. extended open saved DI	;AN000;
 50564                                  SAVE_ES:
 50565 000005FB 0000                    	dw	0		;FT. extended open saved ES	;AN000;
 50566                                  SAVE_DX:
 50567 000005FD 0000                    	dw	0		;FT. extended open saved DX	;AN000;
 50568                                  SAVE_CX:
 50569 000005FF 0000                    	dw	0		;FT. extended open saved CX	;AN000;
 50570                                  SAVE_BX:
 50571 00000601 0000                    	dw	0		;FT. extended open saved BX	;AN000;
 50572                                  SAVE_SI:
 50573 00000603 0000                    	dw	0		;FT. extended open saved SI	;AN000;
 50574                                  SAVE_DS:
 50575 00000605 0000                    	dw	0		;FT. extended open saved DS	;AN000;
 50576                                  
 50577                                  ; DOSDATA:0607h
 50578                                  
 50579                                  ; HIGH_SECTOR is a hack to allow passing 32-bit sector numbers where
 50580                                  ; we used to just pass 16 bits in a register. Now High_SECTOR holds
 50581                                  ; the high 16, the low 16 are still in the register.
 50582                                  
 50583                                  HIGH_SECTOR:	
 50584 00000607 0000                    	dw	0		;>32mb higher sector #		;AN000;
 50585                                  
 50586                                  ; 07/03/2025
 50587                                  	; 25/09/2023
 50588                                  ;OffsetMagicPatch:
 50589                                  	; 24/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 50590                                  	;dw	MagicPatch	;scottq 8/6/92
 50591                                  	; 06/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 50592 00000609 0000                    	dw	0
 50593                                  				;see dos\mpatch.asm
 50594                                  DISK_FULL:
 50595 0000060B 00                      	db	0		;>32mb indicating disk full when 1 ;AN000;
 50596                                  TEMP_VAR:
 50597 0000060C 0000                    	dw	0		; temporary variable for everyone ;AN000;
 50598                                  TEMP_VAR2:
 50599 0000060E 0000                    	dw	0		; temporary variable 2 for everyone ;AN000;
 50600 00000610 00                      DrvErr:	db	0		; used to save drive error	;AN000;
 50601                                  DOS34_FLAG:
 50602 00000611 0000                    	dw	0		; common flag for DOS 3.4	;AN000;
 50603                                  NO_FILTER_PATH:
 50604 00000613 00000000                	dd	0		; pointer to original path	;AN000;
 50605                                  NO_FILTER_DPATH:
 50606 00000617 00000000                	dd	0		; pointer to original path of destination ;AN000;
 50607                                  ; M008
 50608                                  AbsRdWr_SS:
 50609 0000061B 0000                    	dw	0		; INT 25/26 user stack segment
 50610                                  AbsRdWr_SP:
 50611 0000061D 0000                    	dw	0		; INT 25/26 user stack offset
 50612                                  
 50613                                  	; I_am  UU_Callback_flag,BYTE,<0>  ; Unused
 50614                                  ; M008
 50615                                  	; 24/03/2024
 50616                                  	; MSDOS 5.0 MSDOS.SYS - DOSDATA:061Fh
 50617                                  	; MSDOS 6.22 MSDOS.SYS - DOSDATA:061Fh
 50618                                  	; 01/01/2024 
 50619                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:061Fh
 50620 0000061F 00                      	db 	0
 50621                                   
 50622                                  ; make those pushes fast!!!
 50623                                  ;EVEN
 50624                                  
 50625                                  align 2
 50626                                  
 50627                                  StackSize   equ 180h  ; 384	; gross but effective
 50628                                  
 50629                                  ;StackSize  equ 300h  ;	768	; This is a "trial" change IBM hasn't
 50630                                  ;				; made up their minds about
 50631                                   
 50632                                  ; WARNING!!!! DskStack may grow into AUXSTACK due to interrupt service.
 50633                                  ; This is NO problem as long as AUXSTACK comes immediately before DSKSTACK
 50634                                  
 50635                                  RENAMEDMA:	; LABEL   BYTE	; See DOS_RENAME
 50636                                   
 50637 00000620 00<rep 180h>                    times	StackSize db	0	; db 384 dup(0) ;  PCDOS 7.1
 50638                                  AUXSTACK:			; LABEL   BYTE
 50639                                   
 50640 000007A0 00<rep 180h>                    times	StackSize db 	0	; db 384 dup(0) ;  PCDOS 7.1
 50641                                  DSKSTACK:			; LABEL   BYTE
 50642                                  	; 24/03/2024
 50643                                  	; 01/01/2024 - Retro DOS v5.0 (PCDOS 7.1 IBMDOS.COM)
 50644                                  	; (PCDOS 7.1 IBMDOS.COM - DOSDATA:0920h)
 50645 00000920 402349424D3A31322E-     	db '@#IBM:12.01.2003.build_1.32#@ IBMDOS.COM(USA)',0 
 50645 00000929 30312E323030332E62-
 50645 00000932 75696C645F312E3332-
 50645 0000093B 23402049424D444F53-
 50645 00000944 2E434F4D2855534129-
 50645 0000094D 00                 
 50646 0000094E 00<rep 152h>            	times	StackSize-($-DSKSTACK) db 0  ; db 338 dup(0) ; PCDOS 7.1
 50647                                  	;times	StackSize db 	0	;
 50648                                  IOSTACK:			; LABEL   BYTE
 50649                                  
 50650                                  ; DOSDATA:0AA0h 
 50651                                   
 50652                                  ; patch space for Boca folks.
 50653                                  ; Say What????!!! This does NOT go into the swappable area!
 50654                                  ; NOTE: We include the decl of ibmpatch in ms-dos even though it is not needed.
 50655                                  ;       This allows the REDIRector to work on either IBM or MS-DOS.
 50656                                   
 50657                                  IBMPATCH: ; label byte
 50658                                  PRINTER_FLAG:
 50659 00000AA0 00                      	db	0		; [SYSTEM] status of PRINT utility
 50660                                  VOLCHNG_FLAG:
 50661                                  	;db	0		; [SYSTEM] true if volume label created
 50662                                  	; 24/03/2024 (PCDOS 7.1 IBMDOS.COM)
 50663 00000AA1 FF                      	db	0FFh  ; -1
 50664                                  VIRTUAL_OPEN:
 50665 00000AA2 00                      	db	0		; [SYSTEM] non-zero if we opened a virtual file
 50666                                   
 50667                                  ; 24/03/2024 - Retro DOS v5.0
 50668                                  ; PCDOS 7.1 IBMDOS.COM
 50669                                  %if 0
 50670                                  
 50671                                  ; Following 4 variables moved to MSDATA.asm from MSTABLE.asm (P4986)
 50672                                  
 50673                                  	; DOSDATA:0AA3h ; MSDOS 6.22 ; MSDOS 5.0
 50674                                  FSeek_drive:
 50675                                  	db	0		;AN000; fastseek drive #
 50676                                  FSeek_firclus:
 50677                                  	dw	0		;AN000; fastseek first cluster #
 50678                                  FSeek_logclus:
 50679                                  	dw	0		;AN000; fastseek logical cluster #
 50680                                  FSeek_logsave:
 50681                                  	dw	0		;AN000; fastseek returned log clus #
 50682                                  
 50683                                  %endif
 50684                                  
 50685                                  ; DOSDATA:0AAAh ; MSDOS 6.22 ; MSDOS 5.0
 50686                                  ; DOSDATA:0AA3h	; PCDOS 7.1 ; 24/03/2024
 50687                                  
 50688                                  TEMP_DOSLOC:
 50689 00000AA3 FFFF                    	dw	-1		;stores the temporary location of dos
 50690                                  				;at SYSINIT time.
 50691                                  ; 10/03/2024
 50692                                  ;SWAP_END:  ; LABEL   BYTE
 50693                                   
 50694                                  ; THE FOLLOWING BYTE MUST BE HERE, IMMEDIATELY FOLLOWING SWAP_END. IT CANNOT
 50695                                  ; BE USED. If the size of the swap data area is ODD, it will be rounded up
 50696                                  ; to include this byte.
 50697                                   
 50698                                  	; 24/03/2024
 50699                                  	; 05/01/2024 (PCDOS 7.1 IBMDOS.COM)
 50700                                  	;db	0	 ; DOSDATA:0AACh (MSDOS 5.0-6.22 MSDOS.SYS)
 50701                                  
 50702                                  ; DOSDATA:0AADh
 50703                                   
 50704                                  ;hkn;	DB	(512+80+32-(SWAP_END-ibmpatch)) DUP (?)
 50705                                  
 50706                                  ; ---------------------------------------------------------------------------
 50707                                  ; 05/01/2024 - Retro DOS v5.0 
 50708                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0AA5h
 50709                                  
 50710                                  	; 24/01/2024
 50711                                  LNE_COUNT:
 50712 00000AA5 0000                    	dw	0	; long name entry count (for file)
 50713                                  
 50714 00000AA7 00<rep Eh>              	times 14 db 0
 50715                                  
 50716                                  ENTLAST_PREV:
 50717 00000AB5 0000                    	dw	0	; previous ENTLAST (for long name search !?)
 50718                                  
 50719 00000AB7 00<rep 24h>             	times 36 db 0
 50720                                  
 50721                                  absdrw_extd:
 50722 00000ADB 00                      	db	0
 50723                                  DIRSTART_HW:
 50724 00000ADC 0000                    	dw	0
 50725                                  CLUSNUM_HW:
 50726 00000ADE 0000                    	dw	0
 50727                                  NXTCLUSNUM_HW:
 50728 00000AE0 0000                    	dw	0
 50729                                  LASTPOS_HW:
 50730 00000AE2 0000                    	dw	0
 50731                                  FATBYT_HW:
 50732 00000AE4 0000                    	dw	0
 50733                                  DESTSTART_HW:
 50734 00000AE6 0000                    	dw	0
 50735                                  CLUSTNUM_HW:
 50736 00000AE8 0000                    	dw	0
 50737                                  CLUSDATA_HW:	; cluster data (0 = release, -1 = allocate) ; 30/01/2024
 50738 00000AEA 0000                    	dw	0
 50739                                  CCONTENT_HW:	; UNPACK output
 50740 00000AEC 0000                    	dw	0
 50741                                  ROOTCLUST_HW:
 50742 00000AEE 0000                    	dw	0
 50743                                  CCOUNT_HW:	; 09/02/2024 ; for ALLOCATE
 50744 00000AF0 0000                    	dw	0	
 50745                                  CLUSTERS_HW:
 50746 00000AF2 0000                    	dw	0
 50747 00000AF4 0000                    	dw	0
 50748 00000AF6 0000                    	dw	0
 50749                                  CLSKIP_HW:
 50750 00000AF8 0000                    	dw	0
 50751                                  
 50752                                  ; 10/03/2024 - Retro DOS v5.0
 50753                                  ; (PCDOS 7.1 IBMDOS.COM)
 50754                                  SWAP_END:  ; LABEL   BYTE
 50755                                  
 50756                                  ;DOSDATA    ENDS
 50757                                  
 50758                                  ;============================================================================
 50759                                  ; DOSTAB.ASM (MSDOS 6.0, 1991)
 50760                                  ;============================================================================
 50761                                  ; 27/04/2019 - Retro DOS 4.0
 50762                                  ; 16/07/2018 - Retro DOS 3.0
 50763                                  
 50764                                  ;DOSDATA Segment
 50765                                  
 50766                                  ; DOSDATA:0AADh (MSDOS 6.21, MSDOS.SYS)
 50767                                  
 50768                                  ; DOSDATA:0AFAh (PCDOS 7.1, IBMDOS.COM) ; 05/01/2024
 50769                                  
 50770                                  ;
 50771                                  ; upper case table
 50772                                  ; ---------------------------------------------------------------------------
 50773                                  UCASE_TAB:	; label   byte
 50774 00000AFA 8000                    	dw	128
 50775 00000AFC 809A45418E418F80        	db	128,154,069,065,142,065,143,128 
 50776 00000B04 4545454949498E8F        	db	069,069,069,073,073,073,142,143
 50777 00000B0C 9092924F994F5555        	db	144,146,146,079,153,079,085,085
 50778 00000B14 59999A9B9C9D9E9F        	db	089,153,154,155,156,157,158,159
 50779 00000B1C 41494F55A5A5A6A7        	db	065,073,079,085,165,165,166,167
 50780 00000B24 A8A9AAABACADAEAF        	db	168,169,170,171,172,173,174,175
 50781 00000B2C B0B1B2B3B4B5B6B7        	db	176,177,178,179,180,181,182,183
 50782 00000B34 B8B9BABBBCBDBEBF        	db	184,185,186,187,188,189,190,191
 50783 00000B3C C0C1C2C3C4C5C6C7        	db	192,193,194,195,196,197,198,199
 50784 00000B44 C8C9CACBCCCDCECF        	db	200,201,202,203,204,205,206,207
 50785 00000B4C D0D1D2D3D4D5D6D7        	db	208,209,210,211,212,213,214,215
 50786 00000B54 D8D9DADBDCDDDEDF        	db	216,217,218,219,220,221,222,223
 50787 00000B5C E0E1E2E3E4E5E6E7        	db	224,225,226,227,228,229,230,231
 50788 00000B64 E8E9EAEBECEDEEEF        	db	232,233,234,235,236,237,238,239
 50789 00000B6C F0F1F2F3F4F5F6F7        	db	240,241,242,243,244,245,246,247
 50790 00000B74 F8F9FAFBFCFDFEFF        	db	248,249,250,251,252,253,254,255
 50791                                  ;
 50792                                  ; file upper case table
 50793                                  ; ---------------------------------------------------------------------------
 50794                                  FILE_UCASE_TAB:	; label  byte
 50795 00000B7C 8000                    	dw	128
 50796 00000B7E 809A45418E418F80        	db	128,154,069,065,142,065,143,128
 50797 00000B86 4545454949498E8F        	db	069,069,069,073,073,073,142,143
 50798 00000B8E 9092924F994F5555        	db	144,146,146,079,153,079,085,085
 50799 00000B96 59999A9B9C9D9E9F        	db	089,153,154,155,156,157,158,159
 50800 00000B9E 41494F55A5A5A6A7        	db	065,073,079,085,165,165,166,167
 50801 00000BA6 A8A9AAABACADAEAF        	db	168,169,170,171,172,173,174,175
 50802 00000BAE B0B1B2B3B4B5B6B7        	db	176,177,178,179,180,181,182,183
 50803 00000BB6 B8B9BABBBCBDBEBF        	db	184,185,186,187,188,189,190,191
 50804 00000BBE C0C1C2C3C4C5C6C7        	db	192,193,194,195,196,197,198,199
 50805 00000BC6 C8C9CACBCCCDCECF        	db	200,201,202,203,204,205,206,207
 50806 00000BCE D0D1D2D3D4D5D6D7        	db	208,209,210,211,212,213,214,215
 50807 00000BD6 D8D9DADBDCDDDEDF        	db	216,217,218,219,220,221,222,223
 50808 00000BDE E0E1E2E3E4E5E6E7        	db	224,225,226,227,228,229,230,231
 50809 00000BE6 E8E9EAEBECEDEEEF        	db	232,233,234,235,236,237,238,239
 50810 00000BEE F0F1F2F3F4F5F6F7        	db	240,241,242,243,244,245,246,247
 50811 00000BF6 F8F9FAFBFCFDFEFF        	db	248,249,250,251,252,253,254,255
 50812                                  
 50813                                  ; 24/03/2024 - Retro DOS v5.0
 50814                                  ; PCDOS 7.1 IBMDOS.COM
 50815                                  %if 0
 50816                                  	; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0BB1h
 50817                                  ;
 50818                                  ; file char list
 50819                                  ; ---------------------------------------------------------------------------
 50820                                  FILE_CHAR_TAB:	; label  byte
 50821                                  	dw	22				; length
 50822                                  	db	1,0,255 			; include all
 50823                                  	db	0,0,20h 			; exclude 0 - 20h
 50824                                  	db	2,14,'."/\[]:|<>+=;,'           ; exclude 14 special
 50825                                  	;db	24 dup (?)			; reserved
 50826                                  	times	24 db 0
 50827                                  %endif
 50828                                  
 50829                                  	; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0BE1h
 50830                                  
 50831                                  	; 24/03/2024
 50832                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:0BFEh
 50833                                  ;
 50834                                  ; collate table
 50835                                  ; ---------------------------------------------------------------------------
 50836                                  COLLATE_TAB:	; label   byte
 50837 00000BFE 0001                    	dw	256
 50838 00000C00 0001020304050607        	db	0,1,2,3,4,5,6,7
 50839 00000C08 08090A0B0C0D0E0F        	db	8,9,10,11,12,13,14,15
 50840 00000C10 1011121314151617        	db	16,17,18,19,20,21,22,23
 50841 00000C18 18191A1B1C1D1E1F        	db	24,25,26,27,28,29,30,31
 50842 00000C20 2021222324252627        	db	" ","!",'"',"#","$","%","&","'"
 50843 00000C28 28292A2B2C2D2E2F        	db	"(",")","*","+",",","-",".","/"
 50844 00000C30 3031323334353637        	db	"0","1","2","3","4","5","6","7"
 50845 00000C38 38393A3B3C3D3E3F        	db	"8","9",":",";","<","=",">","?"
 50846 00000C40 4041424344454647        	db	"@","A","B","C","D","E","F","G"
 50847 00000C48 48494A4B4C4D4E4F        	db	"H","I","J","K","L","M","N","O"
 50848 00000C50 5051525354555657        	db	"P","Q","R","S","T","U","V","W"
 50849 00000C58 58595A5B5C5D5E5F        	db	"X","Y","Z","[","\","]","^","_"
 50850 00000C60 6041424344454647        	db	"`","A","B","C","D","E","F","G"
 50851 00000C68 48494A4B4C4D4E4F        	db	"H","I","J","K","L","M","N","O"
 50852 00000C70 5051525354555657        	db	"P","Q","R","S","T","U","V","W"
 50853 00000C78 58595A7B7C7D7E7F        	db	"X","Y","Z","{","|","}","~",127
 50854 00000C80 4355454141414143        	db	"C","U","E","A","A","A","A","C"
 50855 00000C88 4545454949494141        	db	"E","E","E","I","I","I","A","A"
 50856 00000C90 4541414F4F4F5555        	db	"E","A","A","O","O","O","U","U"
 50857 00000C98 594F552424242424        	db	"Y","O","U","$","$","$","$","$"
 50858 00000CA0 41494F554E4EA6A7        	db	"A","I","O","U","N","N",166,167
 50859 00000CA8 3FA9AAABAC212222        	db	"?",169,170,171,172,"!",'"','"'
 50860 00000CB0 B0B1B2B3B4B5B6B7        	db	176,177,178,179,180,181,182,183
 50861 00000CB8 B8B9BABBBCBDBEBF        	db	184,185,186,187,188,189,190,191
 50862 00000CC0 C0C1C2C3C4C5C6C7        	db	192,193,194,195,196,197,198,199
 50863 00000CC8 C8C9CACBCCCDCECF        	db	200,201,202,203,204,205,206,207
 50864 00000CD0 D0D1D2D3D4D5D6D7        	db	208,209,210,211,212,213,214,215
 50865 00000CD8 D8D9DADBDCDDDEDF        	db	216,217,218,219,220,221,222,223
 50866 00000CE0 E053                    	db	224,"S"
 50867 00000CE2 E2E3E4E5E6E7            	db	226,227,228,229,230,231
 50868 00000CE8 E8E9EAEBECEDEEEF        	db	232,233,234,235,236,237,238,239
 50869 00000CF0 F0F1F2F3F4F5F6F7        	db	240,241,242,243,244,245,246,247
 50870 00000CF8 F8F9FAFBFCFDFEFF        	db	248,249,250,251,252,253,254,255
 50871                                  
 50872                                  ; ------------------------------------------------<MSKK01>----------------------
 50873                                  
 50874                                  ; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0CE3h
 50875                                  ; 24/03/2024
 50876                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D00h
 50877                                  
 50878                                  ; 29/04/2019
 50879                                  
 50880                                  ; dbcs is not supported in DOS 3.3
 50881                                  ;		   DBCS_TAB	    CC_DBCS <>
 50882                                  ;
 50883                                  ; DBCS for DOS 4.00			   2/12/KK
 50884                                  
 50885                                  DBCS_TAB:	; label byte		;AN000;  2/12/KK
 50886                                  ; ------------------------------------------------<MSKK01>----------------------
 50887                                  ;ifdef	DBCS
 50888                                  ; ifdef	  JAPAN
 50889                                  ;		dw	6		; <MSKK01>
 50890                                  ;		db	081h,09fh	; <MSKK01>
 50891                                  ;		db	0e0h,0fch	; <MSKK01>
 50892                                  ;		db	0,0		; <MSKK01>
 50893                                  ;
 50894                                  ;		db	0,0,0,0,0,0,0,0,0,0	; <MSKK01>
 50895                                  ; endif
 50896                                  ; ifdef	  TAIWAN
 50897                                  ;		dw	4		; <TAIWAN>
 50898                                  ;		db	081h,0FEh	; <TAIWAN>
 50899                                  ;		db	0,0		; <TAIWAN>
 50900                                  ;
 50901                                  ;		db	0,0,0,0,0,0,0,0,0,0,0,0
 50902                                  ; endif
 50903                                  ; ifdef   KOREA                         ; Keyl
 50904                                  ;               dw      4               ; <KOREA>
 50905                                  ;               db      0A1h,0FEh       ; <KOREA>
 50906                                  ;               db      0,0             ; <KOREA>
 50907                                  ;
 50908                                  ;		db	0,0,0,0,0,0,0,0,0,0,0,0
 50909                                  ;  endif
 50910                                  ;else
 50911 00000D00 0000                    		dw	0		;AN000;  2/12/KK   max number
 50912                                  		;db	16 dup(0)	;AN000;  2/12/KK
 50913 00000D02 00<rep 10h>             		times	16 db 0
 50914                                  
 50915                                  ;		dw	6		;  2/12/KK
 50916                                  ;		db	081h,09Fh	;  2/12/KK
 50917                                  ;		db	0E0h,0FCh	;  2/12/KK
 50918                                  ;		db	0,0		;  2/12/KK
 50919                                  ;
 50920                                  ;endif
 50921                                  ; ------------------------------------------------<MSKK01>----------------------
 50922                                  
 50923                                  ; 24/03/2024 - Retro DOS v5.0
 50924                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D12h
 50925                                  %if 1
 50926                                  IBMDOSVERSION:	
 50927                                  	;db 7
 50928                                  	;db 10			; MSVERSION
 50929 00000D12 07                      	db MAJOR_VERSION
 50930 00000D13 0A                      	db MINOR_VERSION
 50931                                  
 50932 00000D14 C8A6                    YRTAB:	db 200,166	; Leap Year
 50933 00000D16 C8A5C8A5C8A5            	db 200,165,200,165,200,165
 50934                                  
 50935 00000D1C 1F                      MONTAB:	db 31
 50936                                  february:
 50937 00000D1D 1C1F1E1F1E1F1F1E1F-     	db 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31
 50937 00000D26 1E1F               
 50938                                  %endif
 50939                                  
 50940                                  ; 24/03/2024 - Retro DOS v5.0
 50941                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D28h
 50942                                  %if 1
 50943                                  ;
 50944                                  ; file char list
 50945                                  ; ---------------------------------------------------------------------------
 50946                                  FILE_CHAR_TAB:	; label  byte
 50947 00000D28 1600                    	dw	22				; length
 50948 00000D2A 0100FF                  	db	1,0,255 			; include all
 50949 00000D2D 000020                  	db	0,0,20h 			; exclude 0 - 20h
 50950 00000D30 020E2E222F5C5B5D3A-     	db	2,14,'."/\[]:|<>+=;,'           ; exclude 14 special
 50950 00000D39 7C3C3E2B3D3B2C     
 50951                                  	;db	24 dup (?)			; reserved
 50952 00000D40 00<rep 18h>             	times	24 db 0
 50953                                  %endif
 50954                                  
 50955                                  ; 24/03/2024 - Retro DOS v5.0
 50956                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D58h
 50957                                  %if 1
 50958                                  SysInitTable:
 50959 00000D58 [2600]                  	dw	DPBHEAD		; SYSINITVARS
 50960 00000D5A 0000                    	dw	0
 50961 00000D5C [3611]                  	dw	COUNTRY_CDPG
 50962 00000D5E 0000                    	dw	0
 50963 00000D60 000000                  	db	0,0,0
 50964                                  TEMPSEG:
 50965 00000D63 0000                    	dw	0
 50966                                  redir_patch:
 50967 00000D65 00                      	db	0
 50968                                  DosHasHMA:
 50969 00000D66 00                      	db	0
 50970                                  FixExePatch:
 50971 00000D67 0000                    	dw	0
 50972                                  RationalPatchPtr:
 50973 00000D69 0000                    	dw	0
 50974                                  %endif
 50975                                  
 50976                                  ; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0CF5h
 50977                                  ; 24/03/2024
 50978                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D6Bh
 50979                                  
 50980                                  ; ---------------------------------------------------------------------------
 50981                                  ;
 50982                                  ;CASE MAPPER ROUTINE FOR 80H-FFH character range, DOS 3.3
 50983                                  ;     ENTRY: AL = Character to map
 50984                                  ;     EXIT:  AL = The converted character
 50985                                  ; Alters no registers except AL and flags.
 50986                                  ; The routine should do nothing to chars below 80H.
 50987                                  ; ---------------------------------------------------------------------------
 50988                                  ; Example:
 50989                                  
 50990                                  MAP_CASE:
 50991                                  ;Procedure MAP_CASE,FAR
 50992                                  
 50993 00000D6B 3C80                    	CMP	AL,80h
 50994                                  	;JAE	short Map1	;Map no chars below 80H ever
 50995                                  	;RETF
 50996                                  	; 24/03/2024 (PCDOS 7.1 IBMDOS.COM)
 50997                                  	;;;
 50998 00000D6D 720C                    	jb	short L_RET     ;Map no chars below 80H ever
 50999                                  	;;;
 51000                                  Map1:
 51001 00000D6F 2C80                    	SUB	AL,80h		;Turn into index value
 51002 00000D71 1E                      	PUSH	DS
 51003 00000D72 53                      	PUSH	BX
 51004 00000D73 BB[FC0A]                	MOV	BX,UCASE_TAB+2
 51005                                  FINISH:
 51006 00000D76 0E                      	PUSH	CS		;Move to DS
 51007 00000D77 1F                      	POP	DS
 51008 00000D78 D7                      	XLAT			;Get upper case character
 51009 00000D79 5B                      	POP	BX
 51010 00000D7A 1F                      	POP	DS
 51011                                  L_RET:	
 51012 00000D7B CB                      	RETF
 51013                                  
 51014                                  ;EndProc MAP_CASE
 51015                                  
 51016                                  ; ---------------------------------------------------------------------------
 51017                                  
 51018                                  ; 24/03/2024 - Retro DOS v5.0
 51019                                  ; PCDOS 7.1 IBMDOS.COM
 51020                                  %if 0
 51021                                  
 51022                                  ; The variables for ECS version are moved here for the same data alignments
 51023                                  ; as IBM-DOS and MS-DOS.
 51024                                  
 51025                                  InterChar:
 51026                                  	db	0	; Interim character flag ( 1= interim)  ;AN000;
 51027                                  ;------- NOTE: NEXT TWO BYTES SOMETIMES USED AS A WORD !! -------------------
 51028                                  DUMMY:	; LABEL   WORD
 51029                                  InterCon:  
 51030                                  	db	0	; Console in Interim mode ( 1= interim) ;AN000;
 51031                                  SaveCurFlg:
 51032                                  	db	0	; Print, do not advance cursor flag     ;AN000;
 51033                                  
 51034                                  ; ---------------------------------------------------------------------------
 51035                                  
 51036                                  ; 17/01/2024 - Retro DOS v5.0
 51037                                  ;TEMPSEG:  dw	0	;hkn; used to store ds.
 51038                                  ;redir_patch:
 51039                                  ;	  db	0
 51040                                  
 51041                                  ; DOSDATA:0D0Dh
 51042                                  
 51043                                  Mark1:	; label byte
 51044                                  
 51045                                  ;IF2
 51046                                  ;	IF ((OFFSET MARK1) GT (OFFSET MSVERSION) )
 51047                                  ;		%OUT !DATA CORRUPTION!MARK1 OFFSET TOO BIG. RE-ORGANIZE DATA.
 51048                                  ;	ENDIF
 51049                                  ;ENDIF
 51050                                  
 51051                                  	  times 5 db 0
 51052                                  
 51053                                  ;############################################################################
 51054                                  ;
 51055                                  ; ** HACK FOR DOS 4.0 REDIR **
 51056                                  ; 
 51057                                  ; The redir requires the following:
 51058                                  ;
 51059                                  ;	MSVERS	offset D12H
 51060                                  ;	YRTAB	offset D14H
 51061                                  ; 	MONTAB	offset D1CH
 51062                                  ;
 51063                                  ; WARNING! WARNING!
 51064                                  ; 
 51065                                  ; MARK1 SHOULD NOT BE >= 0D12H. IF SOME VARIABLE IS TO BE ADDED ABOVE DO SO
 51066                                  ; WITHOUT VIOLATING THIS AND UPDATE THE FOLL. LINE
 51067                                  ;
 51068                                  ; CURRENTLY MARK1 = 0D0DH
 51069                                  ;
 51070                                  ;############################################################################
 51071                                  
 51072                                  	;ORG	0D12h
 51073                                  
 51074                                  ; DOSDATA:0D12h (MSDOS 6.21, MSDOS.SYS)
 51075                                  
 51076                                  	;db	6
 51077                                  	;db	20
 51078                                  
 51079                                  	; Offset 0C78h in IBMDOS.COM (MSDOS 3.3, 1987)
 51080                                  MSVERSION:				; MS-DOS version in hex for $GET_VERSION
 51081                                  MSMAJORV: DB	MAJOR_VERSION	; DOS_MAJOR_VERSION
 51082                                  MSMINORV: DB	MINOR_VERSION	; DOS_MINOR_VERSION  
 51083                                  
 51084                                  ; YRTAB & MONTAB moved from TABLE segment in ms_table.asm
 51085                                  ;
 51086                                  ;	I_am    YRTAB,8,<200,166,200,165,200,165,200,165>
 51087                                  ;	I_am    MONTAB,12,<31,28,31,30,31,30,31,31,30,31,30,31> 
 51088                                  
 51089                                  ; Days in year
 51090                                  
 51091                                  YRTAB:   
 51092                                  	DB	200,166			; Leap year
 51093                                  	DB	200,165
 51094                                  	DB	200,165
 51095                                  	DB	200,165
 51096                                  
 51097                                  ; Days of each month
 51098                                  
 51099                                  MONTAB:        
 51100                                  	DB      31                      ; January
 51101                                  february:
 51102                                  	DB	28 			; February--reset each 
 51103                                  					; time year changes
 51104                                          DB      31                      ; March
 51105                                          DB      30                      ; April
 51106                                          DB      31                      ; May
 51107                                          DB      30                      ; June
 51108                                          DB      31                      ; July
 51109                                          DB      31                      ; August
 51110                                          DB      30                      ; September
 51111                                          DB      31                      ; October
 51112                                          DB      30                      ; November
 51113                                          DB      31                      ; December
 51114                                  
 51115                                  ;----------------THE FOLL. BLOCK MOVED FROM TABLE SEG IN MS_TABLE.ASM-------
 51116                                  
 51117                                  ; SYS init extended table,   DOS 3.3   F.C. 5/29/86
 51118                                  
 51119                                  SysInitTable:
 51120                                  	;dw	SYSINITVAR
 51121                                  	dw	SYSINITVARS	; pointer to sysinit var
 51122                                          dw      0		; segment
 51123                                          dw	COUNTRY_CDPG	; pointer to country tabl
 51124                                          dw      0		; segment of pointer
 51125                                  
 51126                                  	;;;
 51127                                  	; 17/01/2024 - Retro DOS v5.0
 51128                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D60h
 51129                                  	;
 51130                                  	times	3 db 0
 51131                                  TEMPSEG:
 51132                                  	dw	0
 51133                                  redir_patch:
 51134                                  	db	0
 51135                                  
 51136                                  ;%endif
 51137                                  
 51138                                  ; 17/01/2024
 51139                                  ;%if 1
 51140                                  
 51141                                  ; M021-
 51142                                  ;
 51143                                  ; DosHasHMA - This flag is set by seg_reinit when the DOS actually
 51144                                  ; 	takes control of the HMA. When running, this word is a reliable
 51145                                  ;	indicator that the DOS is actually using HMA. You can't just use
 51146                                  ;	CS, because ROMDOS uses HMA with CS < F000.
 51147                                  
 51148                                  DosHasHMA:
 51149                                  	db	0
 51150                                  FixExePatch:
 51151                                  	dw	0		; M012
 51152                                  
 51153                                  ;%endif
 51154                                  
 51155                                  UnknownPatch:
 51156                                  	dw	0
 51157                                  	;;;
 51158                                  
 51159                                  ; 17/01/2024
 51160                                  ;%if 0
 51161                                  
 51162                                  ; DOS 3.3 F.C. 6/12/86
 51163                                  ; FASTOPEN communications area DOS 3.3   F.C. 5/29/86
 51164                                  
 51165                                  FastTable:				; a better name
 51166                                  FastOpenTable:
 51167                                  	dw      2                       ; number of entries
 51168                                  	dw      FastRet			; pointer to ret instr.
 51169                                  	dw      0                       ; and will be modified by
 51170                                  	dw      FastRet			; FASTxxx when loaded in
 51171                                  	dw      0
 51172                                  
 51173                                  ; DOS 3.3 F.C. 6/12/86
 51174                                  
 51175                                  FastFlg:				; flags
 51176                                  FastOpenFlg:
 51177                                  	db	0			; don't change the foll: order
 51178                                  
 51179                                  ;%endif
 51180                                  
 51181                                  ; FastOpen_Ext_Info is used as a temporary storage for saving dirpos,dirsec
 51182                                  ; and clusnum which are filled by DOS 3.nc when calling FastOpen Insert
 51183                                  ; or filled by FastOPen when calling FastOpen Lookup
 51184                                  
 51185                                  FastOpen_Ext_Info: ; label  byte	;dirpos
 51186                                  	;db	SIZE FASTOPEN_EXTENDED_INFO dup(0)
 51187                                  	;times	11 db 0
 51188                                  	times	FEI.size db 0
 51189                                  
 51190                                  %endif	; 24/03/2024	
 51191                                  
 51192                                  ; Dir_Info_Buff is a dir entry buffer which is filled by FastOPen
 51193                                  ; when calling FastOpen Lookup
 51194                                  
 51195                                  Dir_Info_Buff:	; label  byte
 51196                                  	;db	SIZE dir_entry dup (0)
 51197                                  	;times	32 db 0
 51198 00000D7C 00<rep 20h>             	times	dir_entry.size db 0
 51199                                  
 51200                                  Next_Element_Start:
 51201 00000D9C 0000                    	dw	0			; save next element start offset
 51202                                  
 51203                                  ; 24/03/2024
 51204                                  %if 0
 51205                                  	; MSDOS 6.22 MSDOS.SYS - DOSDATA:0D68h
 51206                                  
 51207                                  Del_ExtCluster:
 51208                                  	dw	0			; for dos_delete
 51209                                  %endif
 51210                                  
 51211                                  ; The following is a stack and its pointer for interrupt 2F which is used
 51212                                  ; by NLSFUNC. There is no significant use of this stack, we are just trying
 51213                                  ; not to destroy the INT 21 stack saved for the user.
 51214                                  
 51215                                  	; MSDOS 6.22 MSDOS.SYS - DOSDATA:0D6Ah
 51216                                  	; 24/03/2024
 51217                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:0D9Eh
 51218                                  
 51219                                  USER_SP_2F:	; LABEL  WORD
 51220 00000D9E [A00D]                  	dw	FAKE_STACK_2F
 51221                                  
 51222                                  Packet_Temp:	; label  word		; temporary packet used by readtime
 51223                                  DOS_TEMP:	; label  word		; temporary word
 51224                                  
 51225                                  FAKE_STACK_2F:  
 51226                                  	; dw	14 dup (0)		; 12 register temporary storage
 51227 00000DA0 0000<rep Eh>            	times	14 dw 0
 51228                                  
 51229                                  ; 24/03/2024 - Retro DOS v5.0
 51230                                  ; PCDOS 7.1 IBMDOS.COM
 51231                                  %if 0
 51232                                  Hash_Temp:	;label  word		; temporary word
 51233                                  	;dw	4 dup (0)		; temporary hash table during config.sys
 51234                                  	times	4 dw 0
 51235                                  %endif
 51236                                  
 51237                                  SCAN_FLAG:
 51238 00000DBC 00                      	db     0			; flag to indicate key ALT_Q
 51239                                  DATE_FLAG:
 51240 00000DBD 0000                    	dw     0                	; flag to update the date
 51241                                  
 51242                                  ; 24/03/2024
 51243                                  %if 0
 51244                                  	; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0D93h
 51245                                  
 51246                                  FETCHI_TAG:	; label  word		; OBSOLETE - no longer used
 51247                                  	dw     0			; formerly part of IBM's piracy protection
 51248                                  
 51249                                  MSG_EXTERROR:	; label  DWORD 		; for system message addr
 51250                                  	dd     0               		; for extended error
 51251                                  	dd     0			; for parser
 51252                                  	dd     0			; for critical errror
 51253                                  	dd     0			; for IFS
 51254                                  	dd     0			; for code reduction
 51255                                  
 51256                                  SEQ_SECTOR:	; label  DWORD 		; last sector read
 51257                                  	dd     -1
 51258                                  SC_SECTOR_SIZE:
 51259                                  	dw	0			; sector size for SC
 51260                                  SC_DRIVE:
 51261                                  	db	0			; drive # for secondary cache
 51262                                  
 51263                                  ; 17/01/2024
 51264                                  ;CurSC_DRIVE:
 51265                                  ;	db	-1			; current SC drive
 51266                                  
 51267                                  CurSC_SECTOR:
 51268                                  	dd	0			; current SC starting sector
 51269                                  SC_STATUS:
 51270                                  	dw	0			; SC status word
 51271                                  SC_FLAG:
 51272                                  	db	0			; SC flag
 51273                                  
 51274                                  %endif
 51275                                  	; 24/03/2024
 51276                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:0DBFh
 51277                                  	; (MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0DB8h)
 51278                                  AbsDskErr:
 51279 00000DBF 0000                    	dw	0			; Storage for Abs dsk read/write err
 51280                                  
 51281                                  NO_NAME_ID:	; label byte
 51282 00000DC1 4E4F204E414D452020-     	db	'NO NAME    '		; null media id
 51282 00000DCA 2020               
 51283                                  
 51284                                  ;hkn; moved from TABLE segment in kstrin.asm
 51285                                  
 51286                                  KISTR001S:	; label	byte		; 2/17/KK
 51287 00000DCC 00                      LOOKSIZ: DB	0			; 0 if byte, NZ if word	2/17/KK
 51288                                  KISTR001E:	; label	byte		; 2/17/KK
 51289                                  
 51290                                  ; the nul device driver used to be part of the code. However, since the
 51291                                  ; header is in the data, and the entry points are only given as an offset,
 51292                                  ; the strategy and interrupt entry points must also be in the data now.
 51293                                  
 51294                                  ; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:0DC6h
 51295                                  ; 24/03/2024
 51296                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0DCDh
 51297                                  
 51298                                  SNULDEV:
 51299                                  ;procedure snuldev,far
 51300                                  	;or	word [es:bx+3],100h
 51301                                  	; 17/12/2022
 51302                                  	;or	byte [es:bx+4],01h
 51303                                  	; 05/01/2024 - Retro DOS v4.2 (*)
 51304                                  	; (Original MSDOS and RetroDOS DATA address compatibility) (*)
 51305                                  	;or	byte [es:bx+SRHEAD.REQSTAT+1],(STDON>>8)
 51306                                  	; 24/03/2024 (PCDOS 7.1 IBMDOS.COM)
 51307 00000DCD 26814F030001            	or	word [es:bx+SRHEAD.REQSTAT],STDON ; set done bit
 51308                                  	; 05/01/2024 - Retro DOS v5.0
 51309                                  	;or	byte [es:bx+SRHEAD.REQSTAT+1],(STDON>>8)
 51310                                  INULDEV:
 51311 00000DD3 CB                      	retf				; must not be a return!
 51312                                  ;endproc snuldev
 51313                                  
 51314                                  ;M044
 51315                                  ; Second part of save area for saving last para of Windows memory
 51316                                  
 51317                                  ; 17/01/2024
 51318                                  ;WinoldPatch2:
 51319                                  ;	;db	8 dup (?)	; M044
 51320                                  ;	times	8 db 0	
 51321                                  
 51322                                  	; 24/03/2024 (PCDOS 7.1 IBMDOS.COM)
 51323 00000DD4 00                      	db	0
 51324                                  
 51325                                  UmbSave2:
 51326                                  	;db	5 dup (?)	; M062
 51327 00000DD5 00<rep 5h>              	times	5 db 0
 51328                                  UmbSaveFlag:
 51329 00000DDA 00                      	db	0		; M062
 51330                                  
 51331                                  ; DOSDATA:0DDBh
 51332                                  
 51333                                  Mark2:	; label byte
 51334                                  
 51335                                  ;IF2
 51336                                  ;	IF ((OFFSET MARK2) GT (OFFSET ERR_TABLE_21) )
 51337                                  ;		%OUT !DATA CORRUPTION!MARK2 OFFSET TOO BIG. RE-ORGANIZE DATA.
 51338                                  ;	ENDIF
 51339                                  ;ENDIF
 51340                                  
 51341                                  ;############################################################################
 51342                                  ;
 51343                                  ; ** HACK FOR DOS 4.0 REDIR **
 51344                                  ; 
 51345                                  ; The redir requires the following:
 51346                                  ;
 51347                                  ;	ERR_TABLE_21	offset DDBH
 51348                                  ;	ERR_TABLE_24	offset E5BH
 51349                                  ; 	ErrMap24	offset EABH
 51350                                  ;
 51351                                  ; WARNING! WARNING!
 51352                                  ;
 51353                                  ; MARK2 SHOULD NOT BE >= 0DDBH. IF SOME VARIABLE IS TO BE ADDED ABOVE DO SO
 51354                                  ; WITHOUT VIOLATING THIS AND UPDATE THE FOLL. LINE
 51355                                  ;
 51356                                  ; CURRENTLY MARK2 = 0DD0H
 51357                                  ;
 51358                                  ;############################################################################
 51359                                  
 51360                                  	;ORG	0DDBh
 51361                                  
 51362                                  ; DOSDATA:0DDBh (MSDOS 6.21, MSDOS.SYS)
 51363                                  ; 24/03/2024
 51364                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0DDBh
 51365                                  
 51366                                  ; ---------------------------------------------------------------------------
 51367                                  ;
 51368                                  ; The following table defines CLASS ACTION and LOCUS info for the INT 21H
 51369                                  ; errors. Each entry is 4 bytes long:
 51370                                  ;
 51371                                  ;       Err#,Class,Action,Locus
 51372                                  ;
 51373                                  ; A value of 0FFh indicates a call specific value (ie. should already
 51374                                  ; be set). AN ERROR CODE NOT IN THE TABLE FALLS THROUGH TO THE CATCH ALL AT
 51375                                  ; THE END, IT IS ASSUMES THAT CLASS, ACTION, LOCUS IS ALREADY SET.
 51376                                  ;
 51377                                  ; ---------------------------------------------------------------------------
 51378                                  
 51379                                  ;ErrTab  Macro   err,class,action,locus
 51380                                  ;ifidn <locus>,<0FFh>
 51381                                  ;    DB  error_&err,errCLASS_&class,errACT_&action,0FFh
 51382                                  ;ELSE
 51383                                  ;    DB  error_&err,errCLASS_&class,errACT_&action,errLOC_&locus
 51384                                  ;ENDIF
 51385                                  ;ENDM
 51386                                  
 51387                                  ERR_TABLE_21: ; LABEL   BYTE
 51388 00000DDB 010704FF                    DB  error_invalid_function,       errCLASS_Apperr,    errACT_Abort,    0FFh
 51389 00000DDF 02080302                    DB  error_file_not_found,         errCLASS_NotFnd,    errACT_User,     errLOC_Disk
 51390 00000DE3 03080302                    DB  error_path_not_found,         errCLASS_NotFnd,    errACT_User,     errLOC_Disk
 51391 00000DE7 04010401                    DB  error_too_many_open_files,    errCLASS_OutRes,    errACT_Abort,    errLOC_Unk
 51392 00000DEB 050303FF                    DB  error_access_denied,          errCLASS_Auth,      errACT_User,     0FFh
 51393 00000DEF 06070401                    DB  error_invalid_handle,         errCLASS_Apperr,    errACT_Abort,    errLOC_Unk
 51394 00000DF3 07070505                    DB  error_arena_trashed,          errCLASS_Apperr,    errACT_Panic,    errLOC_Mem
 51395 00000DF7 08010405                    DB  error_not_enough_memory,      errCLASS_OutRes,    errACT_Abort,    errLOC_Mem
 51396 00000DFB 09070405                    DB  error_invalid_block,          errCLASS_Apperr,    errACT_Abort,    errLOC_Mem
 51397 00000DFF 0A070405                    DB  error_bad_environment,        errCLASS_Apperr,    errACT_Abort,    errLOC_Mem
 51398 00000E03 0B090301                    DB  error_bad_format,             errCLASS_BadFmt,    errACT_User,     errLOC_Unk
 51399 00000E07 0C070401                    DB  error_invalid_access,         errCLASS_Apperr,    errACT_Abort,    errLOC_Unk
 51400 00000E0B 0D090401                    DB  error_invalid_data,           errCLASS_BadFmt,    errACT_Abort,    errLOC_Unk
 51401 00000E0F 0F080302                    DB  error_invalid_drive,          errCLASS_NotFnd,    errACT_User,     errLOC_Disk
 51402 00000E13 10030302                    DB  error_current_directory,      errCLASS_Auth,      errACT_User,     errLOC_Disk
 51403 00000E17 110D0302                    DB  error_not_same_device,        errCLASS_Unk,       errACT_User,     errLOC_Disk
 51404 00000E1B 12080302                    DB  error_no_more_files,          errCLASS_NotFnd,    errACT_User,     errLOC_Disk
 51405 00000E1F 500C0302                    DB  error_file_exists,            errCLASS_Already,   errACT_User,     errLOC_Disk
 51406 00000E23 200A0202                    DB  error_sharing_violation,      errCLASS_Locked,    errACT_DlyRet,   errLOC_Disk
 51407 00000E27 210A0202                    DB  error_lock_violation,         errCLASS_Locked,    errACT_DlyRet,   errLOC_Disk
 51408 00000E2B 540104FF                    DB  error_out_of_structures,      errCLASS_OutRes,    errACT_Abort,    0FFh
 51409 00000E2F 56030301                    DB  error_invalid_password,       errCLASS_Auth,      errACT_User,     errLOC_Unk
 51410 00000E33 52010402                    DB  error_cannot_make,            errCLASS_OutRes,    errACT_Abort,    errLOC_Disk
 51411 00000E37 32090303                    DB  error_not_supported,          errCLASS_BadFmt,    errACT_User,     errLOC_Net
 51412 00000E3B 550C0303                    DB  error_already_assigned,       errCLASS_Already,   errACT_User,     errLOC_Net
 51413 00000E3F 57090301                    DB  error_invalid_parameter,      errCLASS_BadFmt,    errACT_User,     errLOC_Unk
 51414 00000E43 530D0401                    DB  error_FAIL_I24,               errCLASS_Unk,       errACT_Abort,    errLOC_Unk
 51415 00000E47 24010405                    DB  error_sharing_buffer_exceeded,errCLASS_OutRes,    errACT_Abort,    errLOC_Mem
 51416                                      ; MSDOS 6.0
 51417 00000E4B 26010401                    DB  error_handle_EOF,             errCLASS_OutRes,    errACT_Abort,    errLOC_Unk ;AN000;
 51418 00000E4F 27010401                    DB  error_handle_Disk_Full,       errCLASS_OutRes,    errACT_Abort,    errLOC_Unk ;AN000;
 51419 00000E53 5A0D0402                    DB  error_sys_comp_not_loaded,    errCLASS_Unk,       errACT_Abort,    errLOC_Disk ;AN001;
 51420 00000E57 FFFFFFFF                    DB  0FFh,                         0FFH,       	  0FFH,       	   0FFh
 51421                                  
 51422                                  ; MSDOS 3.3 (IBMDOS.COM, 1987) - Offset 0D2Ah
 51423                                  ;ERR_TABLE_21:	db 1,7,4,0FFh
 51424                                  ;		db 2,8,3,2
 51425                                  ;		db 3,8,3,2
 51426                                  ;		db 4,1,4,1
 51427                                  ;		db 5,3,3,0FFh
 51428                                  ;		db 6,7,4,1
 51429                                  ;		db 7,7,5,5
 51430                                  ;		db 8,1,4,5
 51431                                  ;		db 9,7,4,5
 51432                                  ;		db 0Ah,7,4,5
 51433                                  ;		db 0Bh,9,3,1
 51434                                  ;		db 0Ch,7,4,1
 51435                                  ;		db 0Dh,9,4,1
 51436                                  ;		db 0Fh,8,3,2
 51437                                  ;		db 10h,3,3,2
 51438                                  ;		db 11h,0Dh,3,2
 51439                                  ;		db 12h,8,3,2
 51440                                  ;		db 50h,0Ch,3,2
 51441                                  ;		db 20h,0Ah,2,2
 51442                                  ;		db 21h,0Ah,2,2
 51443                                  ;		db 54h,1,4,0FFh
 51444                                  ;		db 56h,3,3,1
 51445                                  ;		db 52h,1,4,2
 51446                                  ;		db 32h,9,3,3
 51447                                  ;		db 55h,0Ch,3,3
 51448                                  ;		db 57h,9,3,1
 51449                                  ;		db 53h,0Dh,4,1
 51450                                  ;		db 24h,1,4,5
 51451                                  ; MSDOS 6.0 (MSDOS 6.21)
 51452                                  ;		db 26h,1,4,1
 51453                                  ;		db 27h,1,4,1
 51454                                  ;		db 5Ah,0Dh,4,2
 51455                                  ; MSDOS 6.0 & MSDOS 3.3
 51456                                  ;		db 0FFh,0FFh,0FFh,0FFh
 51457                                  
 51458                                  ; DOSDATA:0E5Bh (MSDOS 6.21, MSDOS.SYS)
 51459                                  
 51460                                  ; ---------------------------------------------------------------------------
 51461                                  ;
 51462                                  ; The following table defines CLASS ACTION and LOCUS info for the INT 24H
 51463                                  ; errors. Each entry is 4 bytes long:
 51464                                  ;
 51465                                  ;       Err#,Class,Action,Locus
 51466                                  ;
 51467                                  ; A Locus value of 0FFh indicates a call specific value (ie. should already
 51468                                  ; be set). AN ERROR CODE NOT IN THE TABLE FALLS THROUGH TO THE CATCH ALL AT
 51469                                  ; THE END.
 51470                                  ;
 51471                                  ; ---------------------------------------------------------------------------
 51472                                  
 51473                                  ERR_TABLE_24: ; LABEL   BYTE
 51474 00000E5B 130B0702                    DB  error_write_protect,          errCLASS_Media,     errACT_IntRet,   errLOC_Disk
 51475 00000E5F 14040501                    DB  error_bad_unit,               errCLASS_Intrn,     errACT_Panic,    errLOC_Unk
 51476 00000E63 150507FF                    DB  error_not_ready,              errCLASS_HrdFail,   errACT_IntRet,   0FFh
 51477 00000E67 16040501                    DB  error_bad_command,            errCLASS_Intrn,     errACT_Panic,    errLOC_Unk
 51478 00000E6B 170B0402                    DB  error_CRC,                    errCLASS_Media,     errACT_Abort,    errLOC_Disk
 51479 00000E6F 18040501                    DB  error_bad_length,             errCLASS_Intrn,     errACT_Panic,    errLOC_Unk
 51480 00000E73 19050102                    DB  error_seek,                   errCLASS_HrdFail,   errACT_Retry,    errLOC_Disk
 51481 00000E77 1A0B0702                    DB  error_not_DOS_disk,           errCLASS_Media,     errACT_IntRet,   errLOC_Disk
 51482 00000E7B 1B0B0402                    DB  error_sector_not_found,       errCLASS_Media,     errACT_Abort,    errLOC_Disk
 51483 00000E7F 1C020704                    DB  error_out_of_paper,           errCLASS_TempSit,   errACT_IntRet,   errLOC_SerDev
 51484 00000E83 1D0504FF                    DB  error_write_fault,            errCLASS_HrdFail,   errACT_Abort,    0FFh
 51485 00000E87 1E0504FF                    DB  error_read_fault,             errCLASS_HrdFail,   errACT_Abort,    0FFh
 51486 00000E8B 1F0D04FF                    DB  error_gen_failure,            errCLASS_Unk,       errACT_Abort,    0FFh
 51487 00000E8F 200A0202                    DB  error_sharing_violation,      errCLASS_Locked,    errACT_DlyRet,   errLOC_Disk
 51488 00000E93 210A0202                    DB  error_lock_violation,         errCLASS_Locked,    errACT_DlyRet,   errLOC_Disk
 51489 00000E97 220B0702                    DB  error_wrong_disk,             errCLASS_Media,     errACT_IntRet,   errLOC_Disk
 51490 00000E9B 32090303                    DB  error_not_supported,          errCLASS_BadFmt,    errACT_User,     errLOC_Net
 51491 00000E9F 23070401                    DB  error_FCB_unavailable,        errCLASS_Apperr,    errACT_Abort,    errLOC_Unk
 51492 00000EA3 24010405                    DB  error_sharing_buffer_exceeded,errCLASS_OutRes,    errACT_Abort,    errLOC_Mem
 51493 00000EA7 FF0D05FF                    DB	0FFh,                         errCLASS_Unk,       errACT_Panic,    0FFh
 51494                                  
 51495                                  ; MSDOS 3.3 (IBMDOS.COM, 1987) - Offset 0D9Eh
 51496                                  ;ERR_TABLE_24:	db 13h,0Bh,7,2
 51497                                  ;		db 14h,4,5,1
 51498                                  ;		db 15h,5,7,0FFh
 51499                                  ;		db 16h,4,5,1
 51500                                  ;		db 17h,0Bh,4,2
 51501                                  ;		db 18h,4,5,1
 51502                                  ;		db 19h,5,1,2
 51503                                  ;		db 1Ah,0Bh,7,2
 51504                                  ;		db 1Bh,0Bh,4,2
 51505                                  ;		db 1Ch,2,7,4
 51506                                  ;		db 1Dh,5,4,0FFh
 51507                                  ;		db 1Eh,5,4,0FFh
 51508                                  ;		db 1Fh,0Dh,4,0FFh
 51509                                  ;		db 20h,0Ah,2,2
 51510                                  ;		db 21h,0Ah,2,2
 51511                                  ;		db 22h,0Bh,7,2
 51512                                  ;		db 32h,9,3,3
 51513                                  ;		db 23h,7,4,1
 51514                                  ;		db 24h,1,4,5
 51515                                  ;		db 0FFh,0Dh,5,0FFh
 51516                                  
 51517                                  ; DOSDATA:0EABh (MSDOS 6.21, MSDOS.SYS)
 51518                                  
 51519                                  ; ---------------------------------------------------------------------------
 51520                                  ;
 51521                                  ; We need to map old int 24 errors and device driver errors into the new set
 51522                                  ; of errors. The following table is indexed by the new errors
 51523                                  ;
 51524                                  ; ---------------------------------------------------------------------------
 51525                                  
 51526                                  ;Public  ErrMap24
 51527                                  ErrMap24: ; Label   BYTE
 51528 00000EAB 13                          DB  error_write_protect	; 0
 51529 00000EAC 14                          DB  error_bad_unit		; 1
 51530 00000EAD 15                          DB  error_not_ready		; 2
 51531 00000EAE 16                          DB  error_bad_command	; 3
 51532 00000EAF 17                          DB  error_CRC		; 4
 51533 00000EB0 18                          DB  error_bad_length	; 5
 51534 00000EB1 19                          DB  error_seek		; 6
 51535 00000EB2 1A                          DB  error_not_DOS_disk	; 7
 51536 00000EB3 1B                          DB  error_sector_not_found	; 8
 51537 00000EB4 1C                          DB  error_out_of_paper	; 9
 51538 00000EB5 1D                          DB  error_write_fault	; A
 51539 00000EB6 1E                          DB  error_read_fault	; B
 51540 00000EB7 1F                          DB  error_gen_failure	; C
 51541 00000EB8 1F                          DB  error_gen_failure	; D  RESERVED
 51542 00000EB9 1F                          DB  error_gen_failure	; E  RESERVED
 51543 00000EBA 22                          DB  error_wrong_disk	; F
 51544                                  
 51545                                  ;ErrMap24: db 13h, 14h, 15h, 16h, 17h, 18h, 19h, 1Ah
 51546                                  ;	   db 1Bh, 1Ch, 1Dh, 1Eh, 1Fh, 1Fh, 1Fh, 22h
 51547                                  	
 51548                                  ErrMap24End: ; LABEL   BYTE
 51549                                  
 51550                                  ; DOSDATA:0EBBh (MSDOS 6.21, MSDOS.SYS)
 51551                                  
 51552                                  ; 09/03/2024 - Retro DOS v5.0
 51553                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0EBBh (SPECIAL_VERSION)
 51554                                  
 51555                                  ; MSDOS 5.0  MSDOS.SYS - DOSDATA:0EBBh (FIRST_BUFF_ADDR)
 51556                                  ; MSDOS 6.22 MSDOS.SYS - DOSDATA:0EBBh (FIRST_BUFF_ADDR)
 51557                                  ; Windows ME    IO.SYS - DOSDATA:0EBBh (SPECIAL_VERSION)
 51558                                  
 51559                                  ; ---------------------------------------------------------------------------
 51560                                  
 51561                                  ; 27/04/2019 - Retro DOS v4.0
 51562                                  
 51563                                  ; 17/01/2024
 51564                                  ;FIRST_BUFF_ADDR:
 51565                                  ;	dw	0			; first buffer address
 51566                                  
 51567                                  SPECIAL_VERSION:
 51568 00000EBB 0000                    	dw	0			;AN006; used by INT 2F 47H
 51569                                  
 51570                                  ; 25/03/2024 - Retro DOS v5.0
 51571                                  ; PCDOS 7.1 IBMDOS.COM
 51572                                  %if 0
 51573                                  FAKE_COUNT:
 51574                                  	times 255 db 0			;AN008; fake version count
 51575                                  %endif
 51576                                  
 51577                                  OLD_FIRSTCLUS:
 51578 00000EBD 0000                    	dw	0			;AN011; save old first cluster for fastopen
 51579                                  
 51580                                  ; ---------------------------------------------------------------------------
 51581                                  
 51582                                  ;smr; moved from TABLE segment in exec.asm
 51583                                  
 51584 00000EBF 0000                    exec_init_SP: dw 0
 51585 00000EC1 0000                    exec_init_SS: dw 0
 51586 00000EC3 0000                    exec_init_IP: dw 0
 51587 00000EC5 0000                    exec_init_CS: dw 0
 51588                                  
 51589                                  exec_signature:
 51590 00000EC7 0000                    	dw	0	; must contain 4D5A (yay zibo!)
 51591                                  exec_len_mod_512:
 51592 00000EC9 0000                    	dw	0	; low 9 bits of length
 51593                                  exec_pages:
 51594 00000ECB 0000                    	dw	0	; number of 512b pages in file
 51595                                  exec_rle_count:
 51596 00000ECD 0000                    	dw	0	; count of reloc entries
 51597                                  exec_par_dir:
 51598 00000ECF 0000                    	dw	0	; number of paragraphs before image
 51599                                  exec_min_BSS:
 51600 00000ED1 0000                    	dw	0	; minimum number of para of BSS
 51601                                  exec_max_BSS:
 51602 00000ED3 0000                    	dw	0	; max number of para of BSS
 51603                                  exec_SS:
 51604 00000ED5 0000                    	dw	0	; stack of image
 51605                                  exec_SP:
 51606 00000ED7 0000                    	dw	0	; SP of image
 51607                                  exec_chksum:
 51608 00000ED9 0000                    	dw	0	; checksum of file (ignored)
 51609                                  exec_IP:
 51610 00000EDB 0000                    	dw	0	; IP of entry
 51611                                  exec_CS:
 51612 00000EDD 0000                    	dw	0	; CS of entry
 51613                                  exec_rle_table:
 51614 00000EDF 0000                    	dw	0	; byte offset of reloc table
 51615                                  
 51616                                  exec_header_len	equ $-exec_signature			;PBUGBUG
 51617                                  
 51618                                  ;smr; eom
 51619                                  
 51620                                  ; ---------------------------------------------------------------------------
 51621                                  
 51622                                  ;SR;
 51623                                  ; WIN386 instance table for DOS
 51624                                  
 51625                                  Win386_Info:
 51626                                  	;db	3,0
 51627                                  	; 17/01/2024 - PCDOS 7.1 IBMDOS.COM - DOSDATA:0EE1h
 51628 00000EE1 0400                    	db	4,0	; WIN386_SIS version
 51629 00000EE3 00000000                	dd	0	; .Next_Dev_Ptr
 51630                                  Win386_Inf_Virt_Dev_Ptr:
 51631 00000EE7 00000000                	dd	0	; .Virt_Dev_File_Ptr
 51632 00000EEB 00000000                	dd	0	; .Reference_Data
 51633                                  Instance_Data_Ptr:
 51634 00000EEF [F30E]0000              	dw	Instance_Table, 0
 51635                                  
 51636                                  ; 09/03/2025
 51637                                  %if 0
 51638                                  	; 17/01/2024 - PCDOS 7.1 IBMDOS.COM
 51639                                  	;;
 51640                                  	dw	Unknown_Table, 0  ; (what is this and what for ?)
 51641                                  				  ; (Win386_IIS.size)
 51642                                  	;;
 51643                                  %endif
 51644                                  
 51645                                  Instance_Table:
 51646 00000EF3 [2200]00000200          	dw	CONTPOS,0,2
 51647 00000EF9 [3200]00000400          	dw	BCON,0,4
 51648 00000EFF [F901]00000601          	dw	CARPOS,0,106h
 51649 00000F05 [0003]00000100          	dw	CHARCO,0,1
 51650 00000F0B [BF0E]00002200          	dw	exec_init_SP,0,34	; M074
 51651 00000F11 [8900]00000100          	dw	UMBFLAG,0,1		; M019
 51652 00000F17 [8C00]00000200          	dw	UMB_HEAD,0,2		; M019
 51653                                  	;;;
 51654                                  	; 17/01/2024 - PCDOS 7.1 IBMDOS.COM
 51655 00000F1D [8600]C9000100          	dw	DOS_FLAG,0C9h,1
 51656 00000F23 [C411]C9000100          	dw	INDOS_FLAG,0C9h,1 ; (what for a 2nd INDOS flag, windows?)
 51657 00000F29 [C511]C9000100          	dw	DEVIO_IN_PROGRESS,0C9h,1
 51658                                  				; "devio call in progress" status flag ptr
 51659                                  	;;;
 51660 00000F2F 00000000                	dw	0, 0
 51661                                  
 51662                                  	;;;
 51663                                  	; 17/01/2024 - PCDOS 7.1 IBMDOS.COM
 51664 00000F33 FFFF                    	dw	0FFFFh
 51665 00000F35 FFFF                    	dw	0FFFFh
 51666                                  CL0FATENTRY_HW:
 51667 00000F37 FFFF                    	dw	0FFFFh
 51668                                  
 51669                                  ; 09/03/2025 (MiniDOS)
 51670                                  %if 0
 51671                                  Unknown_Table:
 51672                                  	dw	0
 51673                                  	dw	0C9h
 51674                                  	dw	SFTABL		; DOSDATA:00CCh
 51675                                  	dw	CARPOS
 51676                                  	dw	0C9h
 51677                                  	dw	UNKNOWN1	; ? (points to DOSDATA:114Dh)
 51678                                  	dw	0
 51679                                  	dw	0
 51680                                  	;;;
 51681                                  %endif
 51682                                  
 51683                                  ; M001; SR;
 51684                                  ; M001; On DOSMGR call ( cx == 0 ), we need to return a table of offsets of
 51685                                  ; M001; some DOS variables. Note that the only really important variable in
 51686                                  ; M001; this is User_Id. The other variables are needed only to patch stuff
 51687                                  ; M001; which does not need to be done in DOS 5.0. 
 51688                                  
 51689                                  ; 29/12/2022
 51690                                  ; (MSDOS 6.21 MSDOS.SYS - DOSDATA:1022h)
 51691                                  ; 25/03/2024
 51692                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0F4Dh
 51693                                  
 51694                                  Win386_DOSVars:
 51695 00000F39 05                      	db	5	;Major version 5 ; M001
 51696 00000F3A 00                      	db	0	;Minor version 0 ; M001
 51697 00000F3B [EC05]                  	dw	SAVEDS	; M001
 51698 00000F3D [EA05]                  	dw	SAVEBX	; M001
 51699 00000F3F [2103]                  	dw	INDOS	; M001
 51700 00000F41 [3E03]                  	dw	USER_ID	; M001
 51701 00000F43 [1503]                  	dw	CritPatch ; M001
 51702 00000F45 [8C00]                  	dw	UMB_HEAD ; M012
 51703                                  
 51704                                  ;SR;
 51705                                  ; Flag to indicate whether WIN386 is running or not
 51706                                  
 51707                                  IsWin386:
 51708 00000F47 00                      	db	0
 51709                                  
 51710                                  ; 09/03/2024 (PCDOS 7.1 IBMDOS.COM)
 51711                                  
 51712 00000F48 00                      	db	0
 51713                                  
 51714                                  ; 09/03/2024 (PCDOS 7.1 IBMDOS.COM)
 51715                                  %if 0		
 51716                                  
 51717                                  ;M018
 51718                                  ; This variable contains the path to the VxD device needed for Win386
 51719                                  
 51720                                  ; 09/01/2024
 51721                                  ;VxDpath: db	'c:\wina20.386',0	;M018
 51722                                  
 51723                                  ;End WIN386 support
 51724                                  
 51725                                  ; ---------------------------------------------------------------------------
 51726                                  
 51727                                  ;SR;
 51728                                  ; These variables have been added for the special lie support for device
 51729                                  ;drivers.
 51730                                  ;
 51731                                  
 51732                                  DriverLoad:	
 51733                                  	db	1	;initialized to do special handling
 51734                                  BiosDataPtr:
 51735                                  	dd	0
 51736                                  
 51737                                  %endif
 51738                                  
 51739                                  ; DOSDATA:105Dh (MSDOS 6.21, MSDOS.SYS)
 51740                                  ; 25/03/2024
 51741                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0F76h
 51742                                  
 51743                                  ;--------------------------------------------------------------------------
 51744                                  
 51745                                  ;*** New FCB Implementation
 51746                                  ; This variable is used as a cache in the new FCB implementation to remember
 51747                                  ;the address of a local SFT that can be recycled for a regenerate operation
 51748                                  
 51749 00000F49 00000000                LocalSFT: dd	0		; 0 to indicate invalid pointer
 51750                                  
 51751                                  ;DOSDATA ENDS
 51752                                  
 51753                                  ;============================================================================
 51754                                  ; LMSTUB.ASM (MSDOS 6.0, 1991)
 51755                                  ;============================================================================
 51756                                  ; 27/04/2019 - Retro DOS 4.0
 51757                                  ; 25/03/2024 - Retro DOS 5.0
 51758                                  
 51759                                  ;DOSDATA  SEGMENT WORD PUBLIC 'DATA'
 51760                                  
 51761                                  ;---------------------------------------------------------------------------
 51762                                  ;	Low Memory Stub for DOS when DOS runs in HMA
 51763                                  ;----------------------------------------------------------------------------
 51764                                  	
 51765                                  	;db	90h
 51766                                  
 51767                                  	;EVEN
 51768 00000F4D 90                      align 2
 51769                                  
 51770                                  ; DOSDATA:1062h (MSDOS 5.0-6.22, MSDOS.SYS)
 51771                                  ; 25/03/2024
 51772                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0F7Ah
 51773                                  
 51774                                  DOSINTTABLE:	; LABEL	DWORD
 51775                                  
 51776                                  	;DW	OFFSET DOSCODE:DIVOV 		, 0
 51777                                  	;DW	OFFSET DOSCODE:QUIT 		, 0
 51778                                  	;DW	OFFSET DOSCODE:COMMAND		, 0
 51779                                  	;DW	OFFSET DOSCODE:ABSDRD		, 0
 51780                                  	;DW	OFFSET DOSCODE:ABSDWRT		, 0
 51781                                  	;DW	OFFSET DOSCODE:Stay_resident	, 0
 51782                                  	;DW	OFFSET DOSCODE:INT2F		, 0
 51783                                  	;DW	OFFSET DOSCODE:CALL_ENTRY	, 0
 51784                                  	;DW	OFFSET DOSCODE:IRETT		, 0
 51785                                  	
 51786 00000F4E [7B5C]0000              	dw	DIVOV 		, 0  ; DOSINTTABLE+0
 51787 00000F52 [C502]0000              	dw	QUIT 		, 0  ; DOSINTTABLE+4
 51788 00000F56 [F102]0000              	dw	COMMAND		, 0  ; DOSINTTABLE+8
 51789 00000F5A [2D05]0000              	dw	ABSDRD		, 0  ; DOSINTTABLE+12
 51790 00000F5E [DF05]0000              	dw	ABSDWRT		, 0  ; DOSINTTABLE+16
 51791 00000F62 [C36E]0000              	dw	STAY_RESIDENT	, 0  ; DOSINTTABLE+20
 51792 00000F66 [3707]0000              	dw	INT2F		, 0  ; DOSINTTABLE+24
 51793 00000F6A [CC02]0000              	dw	CALL_ENTRY	, 0  ; DOSINTTABLE+28
 51794                                  
 51795                                  ; 25/03/2024 - Retro DOS v5.0
 51796                                  ; PCDOS 7.1 IBMDOS.COM
 51797                                  %if 0
 51798                                  	dw	IRETT		, 0  ; DOSINTTABLE+32
 51799                                  %endif
 51800                                  
 51801 00000F6E 0000                    SS_Save: dw	0		; save user's stack segment
 51802 00000F70 0000                    SP_Save: dw	0		; save user's stack offset
 51803                                  
 51804                                  ;-------------------------------------------------------------------------
 51805                                  ;
 51806                                  ; LOW MEM STUB:
 51807                                  ;
 51808                                  ; The low mem stub contains the entry points into DOS for all interrupts
 51809                                  ; handled by DOS. This stub is installed if the user specifies that the
 51810                                  ; DOS load in HIMEM. Each entry point does this.
 51811                                  ;
 51812                                  ; 	1. if jmp to 8 has been patched out
 51813                                  ;	   2. if A20 OFF
 51814                                  ;	      3. Enable A20
 51815                                  ;	   4. else 
 51816                                  ;	      5. just go to dos entry
 51817                                  ;	   6. endif
 51818                                  ;	7. else
 51819                                  ;	   8. just go to dos entry
 51820                                  ;	9. endif
 51821                                  ;
 51822                                  ;--------------------------------------------------------------------------
 51823                                  
 51824                                  ; 27/04/2019 - Retro DOS v4.0
 51825                                  
 51826                                  ; DOSDATA:108Ah (MSDOS 6.21, MSDOS.SYS)
 51827                                  
 51828                                  ; 25/03/2024 - Retro DOS v5.0
 51829                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0F9Eh
 51830                                  
 51831                                  ;--------------------------------------------------------------------------
 51832                                  ;
 51833                                  ; DIVIDE BY 0 handler
 51834                                  ;
 51835                                  ;--------------------------------------------------------------------------
 51836                                  
 51837                                  ldivov:
 51838                                  	; The following jump, skipping the XMS calls will be patched to
 51839                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 51840                                  	; needed because the stub is installed even before the XMS driver
 51841                                  	; is loaded if the user specifies dos=high in the config.sys
 51842                                  i0patch:
 51843 00000F72 EB03                    	jmp	short divov_cont
 51844                                  
 51845 00000F74 E8E200                  	call	EnsureA20ON		; we must turn on A20 if OFF
 51846                                  divov_cont:
 51847 00000F77 2EFF2E[4E0F]            	jmp	far [cs:DOSINTTABLE]	; jmp to DOS
 51848                                  
 51849                                  ;--------------------------------------------------------------------------
 51850                                  ;
 51851                                  ; INT 20h Handler
 51852                                  ;
 51853                                  ; Here we do not have to set up the stack to return here as the abort call
 51854                                  ; will return to the address after the int 21 ah=4b call. This would be the
 51855                                  ; common exit point if A20 had been OFF (for TOGGLE DOS) and the A20 line
 51856                                  ; will be restored then.
 51857                                  ;
 51858                                  ;--------------------------------------------------------------------------
 51859                                  
 51860                                  lquit:
 51861                                  	; The following jump, skipping the XMS calls will be patched to
 51862                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 51863                                  	; needed because the stub is installed even before the XMS driver
 51864                                  	; is loaded if the user specifies dos=high in the config.sys
 51865                                  i20patch:
 51866 00000F7C EB03                    	jmp	short quit_cont
 51867                                  
 51868 00000F7E E8D800                  	call	EnsureA20ON		; we must turn on A20 if OFF
 51869                                  quit_cont:
 51870 00000F81 2EFF2E[520F]            	jmp	far [cs:DOSINTTABLE+4]	; jump to DOS
 51871                                  
 51872                                  ;--------------------------------------------------------------------------
 51873                                  ;
 51874                                  ; INT 21h Handler
 51875                                  ;
 51876                                  ;--------------------------------------------------------------------------
 51877                                  
 51878                                  lcommand:
 51879                                  	; The following jump, skipping the XMS calls will be patched to
 51880                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 51881                                  	; needed because the stub is installed even before the XMS driver
 51882                                  	; is loaded if the user specifies dos=high in the config.sys
 51883                                  i21patch:
 51884 00000F86 EB03                    	jmp	short command_cont
 51885                                  
 51886 00000F88 E8CE00                  	call	EnsureA20ON		; we must turn on A20 if OFF
 51887                                  command_cont:
 51888 00000F8B 2EFF2E[560F]            	jmp	far [cs:DOSINTTABLE+8]	; jmp to DOS
 51889                                  
 51890                                  ;--------------------------------------------------------------------------
 51891                                  ;
 51892                                  ; INT 25h
 51893                                  ;
 51894                                  ;--------------------------------------------------------------------------
 51895                                  
 51896                                  labsdrd:
 51897                                  	; The following jump, skipping the XMS calls will be patched to
 51898                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 51899                                  	; needed because the stub is installed even before the XMS driver
 51900                                  	; is loaded if the user specifies dos=high in the config.sys
 51901                                  i25patch:
 51902 00000F90 EB03                    	jmp	short absdrd_cont
 51903                                  
 51904 00000F92 E8C400                  	call	EnsureA20ON		; we must turn on A20 if OFF
 51905                                  absdrd_cont:
 51906 00000F95 2EFF2E[5A0F]            	jmp	far [cs:DOSINTTABLE+12]	; jmp to DOS
 51907                                  
 51908                                  ;--------------------------------------------------------------------------
 51909                                  ;
 51910                                  ; INT 26h
 51911                                  ;
 51912                                  ;--------------------------------------------------------------------------
 51913                                  
 51914                                  labsdwrt:
 51915                                  	; The following jump, skipping the XMS calls will be patched to
 51916                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 51917                                  	; needed because the stub is installed even before the XMS driver
 51918                                  	; is loaded if the user specifies dos=high in the config.sys
 51919                                  i26patch:
 51920 00000F9A EB03                    	jmp	short absdwrt_cont
 51921                                  
 51922 00000F9C E8BA00                  	call	EnsureA20ON		; we must turn on A20 if OFF
 51923                                  absdwrt_cont:
 51924 00000F9F 2EFF2E[5E0F]            	jmp	far [cs:DOSINTTABLE+16]	; jmp to DOS
 51925                                  
 51926                                  ;--------------------------------------------------------------------------
 51927                                  ;
 51928                                  ; INT 27h
 51929                                  ;
 51930                                  ;--------------------------------------------------------------------------
 51931                                  
 51932                                  lstay_resident:
 51933                                  	; The following jump, skipping the XMS calls will be patched to
 51934                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 51935                                  	; needed because the stub is installed even before the XMS driver
 51936                                  	; is loaded if the user specifies dos=high in the config.sys
 51937                                  i27patch:
 51938 00000FA4 EB03                    	jmp	short sr_cont
 51939                                  
 51940 00000FA6 E8B000                  	call	EnsureA20ON		; we must turn on A20 if OFF
 51941                                  sr_cont:
 51942 00000FA9 2EFF2E[620F]            	jmp	far [cs:DOSINTTABLE+20]	; jmp to DOS
 51943                                  
 51944                                  ;--------------------------------------------------------------------------
 51945                                  ;
 51946                                  ; INT 2Fh
 51947                                  ;
 51948                                  ;--------------------------------------------------------------------------
 51949                                  
 51950                                  lint2f:
 51951                                  	; The following jump, skipping the XMS calls will be patched to
 51952                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 51953                                  	; needed because the stub is installed even before the XMS driver
 51954                                  	; is loaded if the user specifies dos=high in the config.sys
 51955                                  i2fpatch:
 51956 00000FAE EB03                    	jmp	short int2f_cont
 51957                                  
 51958 00000FB0 E8A600                  	call	EnsureA20ON		; we must turn on A20 if OFF
 51959                                  int2f_cont:
 51960 00000FB3 2EFF2E[660F]            	jmp	far [cs:DOSINTTABLE+24]	; jmp to DOS
 51961                                  
 51962                                  ;--------------------------------------------------------------------------
 51963                                  ;
 51964                                  ; CPM entry
 51965                                  ;
 51966                                  ;--------------------------------------------------------------------------
 51967                                  
 51968                                  lcall_entry:
 51969                                  	; The following jump, skipping the XMS calls will be patched to
 51970                                  	; NOPS by SEG_REINIT if DOS successfully loads high. This jump is
 51971                                  	; needed because the stub is installed even before the XMS driver
 51972                                  	; is loaded if the user specifies dos=high in the config.sys
 51973                                  cpmpatch:
 51974 00000FB8 EB03                    	jmp	short callentry_cont
 51975                                  
 51976 00000FBA E89C00                  	call	EnsureA20ON		; we must turn on A20 if OFF
 51977                                  callentry_cont:
 51978 00000FBD 2EFF2E[6A0F]            	jmp	far [cs:DOSINTTABLE+28]	; jmp to DOS
 51979                                  
 51980                                  ;--------------------------------------------------------------------------
 51981                                  
 51982                                  ; 25/03/2024 - Retro DOS v5.0
 51983                                  ; PCDOS 7.1 IBMDOS.COM
 51984                                  %if 0
 51985                                  
 51986                                  lirett:
 51987                                  	iret
 51988                                  
 51989                                  %endif
 51990                                  
 51991                                  ;---------------------------------------------------------------------------
 51992                                  ;
 51993                                  ; LowIntXX:
 51994                                  ;
 51995                                  ; Interrupts from DOS that pass control to a user program must be done from
 51996                                  ; low memory, as the user program may change the state of the A20 line or
 51997                                  ; they may require that the A20 line be OFF. The following piece of code is
 51998                                  ; far call'd from the following places in DOS:
 51999                                  ;
 52000                                  ;	1. msctrlc.asm where dos issues an int 23h (ctrlc)
 52001                                  ;	2. msctrlc.asm where dos issues an int 24h (critical error)
 52002                                  ;	3. msctrlc.asm where dos issues an int 28h (idle int)
 52003                                  ;
 52004                                  ; The int 23 and int 24 handlers may decide to do a far return instead of an
 52005                                  ; IRET ane leave the flags on the stack. Therefore we save the return address
 52006                                  ; before doing the ints and then do a far junp back into DOS.
 52007                                  ;
 52008                                  ;---------------------------------------------------------------------------
 52009                                  
 52010                                  ; 25/03/2024 - Retro DOS v5.0
 52011                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:0FEEh
 52012                                  ; (MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:10DBh)
 52013                                  
 52014 00000FC2 00000000                DosRetAddr23:	dd	0
 52015 00000FC6 00000000                DosRetAddr24:	dd	0
 52016                                  
 52017                                  ; 25/03/2024 - Retro DOS v5.0
 52018                                  ; PCDOS 7.1 IBMDOS.COM
 52019                                  %if 0
 52020                                  DosRetAddr28:	dd	0
 52021                                  %endif
 52022                                  
 52023                                  	; Execute int 23h from low memory
 52024                                  LowInt23:
 52025                                  					; save the return address that is on
 52026                                  					; the stack
 52027 00000FCA 2E8F06[C20F]            	pop	word [cs:DosRetAddr23]
 52028 00000FCF 2E8F06[C40F]            	pop	word [cs:DosRetAddr23+2]
 52029                                  
 52030 00000FD4 CD23                    	int	23h			; ctrl C
 52031                                  					; turn on A20 it has been turned OFF
 52032                                  					; by int 28/23/24 handler.
 52033                                  
 52034 00000FD6 E88000                  	call	EnsureA20ON		; M011: we must turn on A20 if OFF
 52035                                  
 52036 00000FD9 2EFF2E[C20F]            	jmp	far [cs:DosRetAddr23]	; jump back to DOS
 52037                                  
 52038                                  
 52039                                  	; Execute int 24h from low memory
 52040                                  LowInt24:
 52041                                  					; save the return address that is on
 52042                                  					; the stack
 52043 00000FDE 2E8F06[C60F]            	pop	word [cs:DosRetAddr24]
 52044 00000FE3 2E8F06[C80F]            	pop	word [cs:DosRetAddr24+2]
 52045                                  
 52046 00000FE8 CD24                    	int	24h			; crit error
 52047                                  					; turn on A20 it has been turned OFF
 52048                                  					; by int 28/23/24 handler.
 52049                                  
 52050 00000FEA E86C00                  	call	EnsureA20ON		; M011: we must turn on A20 if OFF
 52051                                  
 52052 00000FED 2EFF2E[C60F]            	jmp	far [cs:DosRetAddr24]	; jump back to DOS
 52053                                  
 52054                                  
 52055                                   
 52056                                  	; Execute int 28h from low memory
 52057                                  LowInt28:
 52058 00000FF2 CD28                    	int	28h			; idle int
 52059                                  					; turn on A20 it has been turned OFF
 52060                                  					; by int 28/23/24 handler.
 52061                                  
 52062 00000FF4 E86200                  	call	EnsureA20ON		; M011: we must turn on A20 if OFF
 52063                                  
 52064 00000FF7 CB                      	retf
 52065                                  
 52066                                  ; DOSDATA:1115h (MSDOS 6.21, MSDOS.SYS)
 52067                                  
 52068                                  ;-------------------------------------------------------------------------
 52069                                  ;
 52070                                  ; int 21 ah=4b (exec) call will jump to the following label before xferring
 52071                                  ; control to the exec'd program. We turn off A20 inorder to allow programs
 52072                                  ; that have been packed by the faulty exepack utility to unpack correctly.
 52073                                  ; This is so because exepac'd programs rely on address wrap.
 52074                                  ;
 52075                                  ;------------------------------------------------------------------------- 
 52076                                  
 52077                                  ; 25/03/2024 - Retro DOS v5.0
 52078                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1024h
 52079                                  
 52080                                  disa20_xfer:
 52081 00000FF8 E84800                  	call	XMMDisableA20		; disable A20
 52082                                  
 52083                                  	; Look at msproc.asm at label exec_go for understanding the following:
 52084                                  
 52085                                  	; DS:SI points to entry point
 52086                                  	; AX:DI points to initial stack
 52087                                  	; DX has PDB pointer
 52088                                  	; BX has initial AX value
 52089                                  
 52090 00000FFB FA                      	cli
 52091 00000FFC 2EC606[2103]00          	mov	byte [cs:INDOS],0	; SS Override
 52092                                  
 52093                                  	; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 52094                                  	;;;
 52095 00001002 36C606[C411]00          	mov     byte [ss:INDOS_FLAG],0
 52096                                  	;;;
 52097                                  
 52098 00001008 8ED0                    	mov	SS,AX			; set up user's stack
 52099 0000100A 89FC                    	mov	SP,DI			; and SP
 52100 0000100C FB                      	sti
 52101                                  
 52102 0000100D 1E                      	push	DS			; fake long call to entry
 52103 0000100E 56                      	push	SI
 52104 0000100F 8EC2                    	mov	ES,DX			; set up proper seg registers
 52105 00001011 8EDA                    	mov	DS,DX
 52106 00001013 89D8                    	mov	AX,BX			; set up proper AX
 52107 00001015 CB                      	retf
 52108                                  
 52109                                  ;-------------------------------------------------------------------------
 52110                                  ;
 52111                                  ; M003:
 52112                                  ;
 52113                                  ; If an int 21 ah=25 call is made immediately after an exec call, DOS will
 52114                                  ; come here, turn A20 OFF restore user stack and registers before returning
 52115                                  ; to user. This is done in dos\msdisp.asm. This has been done to support 
 52116                                  ; programs compiled with MS PASCAL 3.2. See under TAG M003 in DOSSYM.INC for
 52117                                  ; more info.
 52118                                  ;
 52119                                  ; Also at this point DS is DOSDATA. So we can assume DS DOSDATA. Note that
 52120                                  ; SS is also DOS stack. It is important that we do the XMS call on DOS's
 52121                                  ; stack to avoid additional stack overhead for the user.
 52122                                  ;
 52123                                  ; -------------------------------------------------------------------------
 52124                                  
 52125                                  disa20_iret:
 52126 00001016 E82A00                  	call	XMMDisableA20
 52127 00001019 FE0E[2103]              	dec	byte [INDOS]
 52128                                  
 52129                                  	; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 52130                                  	;;;
 52131 0000101D FE0E[C411]              	dec	byte [INDOS_FLAG]
 52132                                  	;;;
 52133                                  
 52134 00001021 8E16[8605]              	mov	SS,[USER_SS]		; restore user stack
 52135 00001025 8B26[8405]              	mov	SP,[USER_SP]
 52136 00001029 89E5                    	mov	BP,SP
 52137                                  	;mov	[BP+user_env.user_AX],AL
 52138 0000102B 884600                  	mov	[bp],al
 52139                                  	
 52140                                  ; 25/03/2024
 52141                                  %if 0
 52142                                  	mov	AX,[NSP]
 52143                                  	mov	[USER_SP],AX
 52144                                  	mov	AX,[NSS]
 52145                                  	mov	[USER_SS],AX
 52146                                  %else
 52147                                  	; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 52148                                  	;;;
 52149                                  	;les	ax, dword ptr ds:NSS
 52150 0000102E C406[F005]              	les	ax,[NSS]
 52151 00001032 8C06[8405]              	mov	[USER_SP],es
 52152 00001036 A3[8605]                	mov	[USER_SS],ax
 52153                                  	;;;
 52154                                  %endif
 52155 00001039 58                      	pop	AX			; restore user regs
 52156 0000103A 5B                      	pop	BX
 52157 0000103B 59                      	pop	CX
 52158 0000103C 5A                      	pop	DX
 52159 0000103D 5E                      	pop	SI
 52160 0000103E 5F                      	pop	DI
 52161 0000103F 5D                      	pop	BP
 52162 00001040 1F                      	pop	DS
 52163 00001041 07                      	pop	ES
 52164                                  lirett:		; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 52165 00001042 CF                      	iret
 52166                                  
 52167                                  ;**************************************************************************
 52168                                  ;***	XMMDisableA20 - switch 20th address line
 52169                                  ;
 52170                                  ;	This routine is used to disable the 20th address line in
 52171                                  ;	the system using XMM calls.
 52172                                  ;
 52173                                  ;	ENTRY	none		;ds = _DATA
 52174                                  ;	EXIT	A20 line disabled
 52175                                  ;	USES	NOTHING
 52176                                  ;
 52177                                  ;**************************************************************************
 52178                                  
 52179                                  XMMDisableA20:
 52180 00001043 53                      	push	bx
 52181 00001044 50                      	push	ax
 52182                                  	;mov	ah,XMM_LOCAL_DISABLE_A20
 52183 00001045 B406                    	mov	ah,6
 52184 00001047 2EFF1E[4F10]            	call	far [cs:XMMcontrol]
 52185 0000104C 58                      	pop	ax
 52186 0000104D 5B                      	pop	bx
 52187 0000104E C3                      	retn
 52188                                  
 52189                                  ; The entry point in the BIOS XMS driver is defined here.
 52190                                  
 52191                                  XMMcontrol:
 52192 0000104F 00000000                	dd	0
 52193                                  
 52194                                  ;--------------------------------------------------------------------------
 52195                                  ; 24/03/2024 - Retro DOS v5.0
 52196                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:107Fh
 52197                                  ;;;
 52198 00001053 00000000                	dd	0
 52199                                  SC_STATUS:
 52200 00001057 0000                    	dw	0
 52201                                  ;;;
 52202                                  
 52203                                  ;--------------------------------------------------------------------------
 52204                                  ;
 52205                                  ;***	EnsureA20ON - Ensures that A20 is ON
 52206                                  ;
 52207                                  ;	This routine is used to query the A20 state in
 52208                                  ;	the system using XMM calls.
 52209                                  ;
 52210                                  ;	ENTRY: none
 52211                                  ;
 52212                                  ;	EXIT : A20 will be ON
 52213                                  ;		
 52214                                  ; 	USES : NONE
 52215                                  ;
 52216                                  ;--------------------------------------------------------------------------
 52217                                  
 52218                                  ; 19/09/2023
 52219                                  ;LowMemory:	; label dword		; Set equal to 0000:0080
 52220                                  ;	dw	00080h
 52221                                  ;	dw	00000h
 52222                                  ;
 52223                                  ;HighMemory:	; label dword
 52224                                  ;	dw	00090h			; Set equal to FFFF:0090
 52225                                  ;	dw	0FFFFh
 52226                                  
 52227                                  	; 25/03/2024 - Retro DOS v5.0
 52228                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:1085h
 52229                                  	; (MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:116Fh)
 52230                                  
 52231                                  EnsureA20ON:
 52232 00001059 9C                      	pushf
 52233 0000105A 1E                      	push    ds
 52234 0000105B 06                      	push	es
 52235 0000105C 51                      	push	cx
 52236 0000105D 56                      	push	si
 52237 0000105E 57                      	push	di
 52238                                  
 52239                                  	; 19/09/2023
 52240                                  	;lds	si,[cs:LowMemory]	; Compare the 4 words at 0000:0080
 52241                                  	;les	di,[cs:HighMemory]	; with the 4 at FFFF:0090
 52242                                  
 52243                                  	; 25/03/2024 
 52244                                  	; PCDOS 7.1 IBMDOS.COM
 52245                                  	;;;
 52246 0000105F 31F6                    	xor	si,si
 52247 00001061 8EDE                    	mov	ds,si
 52248 00001063 4E                      	dec	si
 52249 00001064 BF9000                  	mov	di,90h	; 0FFFFh:0090h	; HighMemory
 52250 00001067 8EC6                    	mov	es,si
 52251 00001069 BE8000                  	mov	si,80h	; 0000h:0080h	; LowMemory
 52252                                  	;;;	
 52253                                  
 52254 0000106C B90400                  	mov	cx,4
 52255 0000106F FC                      	cld
 52256 00001070 F3A7                    	repe    cmpsw
 52257                                  
 52258 00001072 7407                    	jz	short EA20_OFF
 52259                                  EA20_RET:
 52260 00001074 5F                      	pop	di
 52261 00001075 5E                      	pop	si
 52262 00001076 59                      	pop	cx
 52263 00001077 07                      	pop	es
 52264 00001078 1F                      	pop	ds
 52265 00001079 9D                      	popf
 52266 0000107A C3                      	retn
 52267                                  
 52268                                  EA20_OFF:
 52269                                  	; We are going to do the XMS call on the DOS's AuxStack.
 52270                                  	; NOTE: ints are disabled at this point.
 52271                                  
 52272 0000107B 53                      	push	bx
 52273 0000107C 50                      	push	ax
 52274                                  
 52275                                  ; 25/03/2024
 52276                                  %if 0
 52277                                  	mov	ax,ss			; save user's stack pointer
 52278                                  	mov	[cs:SS_Save],ax
 52279                                  	mov	[cs:SP_Save],sp
 52280                                  	mov	ax,cs
 52281                                  	mov	ss,ax
 52282                                  %else
 52283                                  	; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 52284                                  	;;;
 52285 0000107D 8CC8                    	mov	ax,cs
 52286 0000107F 2E8C16[6E0F]            	mov	[cs:SS_Save],ss
 52287 00001084 2E8926[700F]            	mov	[cs:SP_Save],sp
 52288 00001089 8ED0                    	mov	ss,ax
 52289                                  	;;;
 52290                                  %endif
 52291 0000108B BC[A007]                	mov	sp,AUXSTACK
 52292                                  					; ss:sp -> DOSDATA:AuxStack
 52293                                  	;mov	ah,XMM_LOCAL_ENABLE_A20
 52294 0000108E B405                    	mov	ah,5
 52295 00001090 2EFF1E[4F10]            	call	far [cs:XMMcontrol]
 52296 00001095 09C0                    	or	ax,ax
 52297 00001097 740E                    	jz	short XMMerror		; AX = 0 fatal error
 52298                                  
 52299                                  	;mov	ax,[cs:SS_Save]		; restore user stack
 52300                                  	;mov	ss,ax
 52301                                  	;  25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 52302                                  	;;;
 52303 00001099 2E8E16[6E0F]            	mov	ss,[cs:SS_Save]
 52304                                  	;;;
 52305 0000109E 2E8B26[700F]            	mov	sp,[cs:SP_Save]
 52306                                  
 52307 000010A3 58                      	pop	ax
 52308 000010A4 5B                      	pop	bx
 52309                                  
 52310 000010A5 EBCD                    	jmp	short EA20_RET
 52311                                  
 52312                                  XMMerror:				; M006 - Start
 52313 000010A7 B40F                    	mov	ah,0Fh			; get video mode
 52314 000010A9 CD10                    	int	10h
 52315 000010AB 3C07                    	cmp	al,7			; Q: are we an MDA
 52316 000010AD 7405                    	je	short XMMcont		; Y: do not change mode
 52317                                  	;xor	ah,ah ; 0		; set video mode
 52318                                  	;mov	al,02h			; 80 X 25 text
 52319                                  	; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 52320                                  	;;;
 52321 000010AF B80200                  	mov     ax,2
 52322                                  	;;;
 52323 000010B2 CD10                    	int	10h
 52324                                  XMMcont:
 52325                                  	;mov	ah,05h			; set display page
 52326                                  	;xor	al,al			; page 0
 52327                                  	; 25/03/2024 (PCDOS 7.1 IBMDOS.COM)
 52328                                  	;;;
 52329 000010B4 B80005                  	mov     ax,500h
 52330                                  	;;;
 52331 000010B7 CD10                    	int	10h
 52332                                  	
 52333 000010B9 BE[1D11]                	mov	si,XMMERRMSG
 52334 000010BC 0E                      	push	cs
 52335 000010BD 1F                      	pop	ds
 52336 000010BE FC                      	cld				; clear direction flag
 52337                                  XMMprnt:
 52338 000010BF AC                      	lodsb
 52339 000010C0 3C24                    	cmp	al,'$'			; indicates end of XMMERRMSG
 52340 000010C2 7409                    	jz	short XMMStall		; function 0Eh
 52341 000010C4 B40E                    	mov	ah,0Eh
 52342 000010C6 BB0700                  	mov	bx,7
 52343 000010C9 CD10                    	int	10h
 52344 000010CB EBF2                    	jmp	short XMMprnt
 52345                                  
 52346                                  XMMStall:
 52347 000010CD FB                      	sti				; allow the user to warm boot
 52348 000010CE EBFD                    	jmp	short XMMStall		; M006 - End
 52349                                  
 52350                                  ;---------------------------------------------------------------------------
 52351                                  
 52352                                  ; 27/04/2019 - Retro DOS v4.0
 52353                                  
 52354                                  ; retrodos4.s ; offset 0Ch in BIOS segment (0070h)
 52355                                  ALTAH	equ 0Ch
 52356                                  
 52357                                  ;This has been put in for WIN386 2.XX support. The format of the instance
 52358                                  ;table was different for this. Segments will be patched in at init time.
 52359                                  
 52360                                  	; 25/03/2024
 52361                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:10FCh
 52362                                  	; (MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:11E7h)
 52363                                  
 52364                                  OldInstanceJunk:
 52365 000010D0 7000                    	dw	70h	;segment of BIOS
 52366 000010D2 0000                    	dw	0	;indicate stacks in SYSINIT area
 52367 000010D4 0600                    	dw	6	;6 instance items
 52368                                  
 52369                                  	;dw	0,offset dosdata:contpos, 2
 52370                                  	;dw	0,offset dosdata:bcon, 4
 52371                                  	;dw	0,offset dosdata:carpos,106h
 52372                                  	;dw	0,offset dosdata:charco, 1
 52373                                  	;dw	0,offset dosdata:exec_init_sp, 34               ;M032
 52374                                  	;dw	070h,offset BData:altah, 1	 ; altah byte in bios
 52375                                  
 52376 000010D6 0000[2200]0200          	dw	0,CONTPOS,2
 52377 000010DC 0000[3200]0400          	dw	0,BCON,4
 52378 000010E2 0000[F901]0601          	dw	0,CARPOS,106h
 52379 000010E8 0000[0003]0100          	dw	0,CHARCO,1
 52380 000010EE 0000[BF0E]2200          	dw	0,exec_init_SP,34
 52381 000010F4 70000C000100            	dw	70h,ALTAH,1	; altah byte in bios
 52382                                  
 52383                                  ;---------------------------------------------------------------------------
 52384                                  
 52385                                  ; 24/03/2024
 52386                                  ; 17/01/2024
 52387                                  %if 0
 52388                                  
 52389                                  ; M021-
 52390                                  ;
 52391                                  ; DosHasHMA - This flag is set by seg_reinit when the DOS actually
 52392                                  ; 	takes control of the HMA. When running, this word is a reliable
 52393                                  ;	indicator that the DOS is actually using HMA. You can't just use
 52394                                  ;	CS, because ROMDOS uses HMA with CS < F000.
 52395                                  
 52396                                  DosHasHMA:
 52397                                  	db	0
 52398                                  FixExePatch:
 52399                                  	dw	0		; M012
 52400                                  
 52401                                  ; 21/03/2024 - Retro DOS v5.0
 52402                                  ;;28/12/2022 - Retro DOS v4.1
 52403                                  RationalPatchPtr:
 52404                                  	dw	0		; M012
 52405                                  
 52406                                  %endif
 52407                                  
 52408                                  ; End M021
 52409                                  
 52410                                  ;---------------------------------------------------------------------------
 52411                                  
 52412                                  ; 21/03/2024 - Retro DOS v5.0
 52413                                  %if 1
 52414                                  ; 28/12/2022 - Retro DOS v4.1
 52415                                  ;%if 0
 52416                                  
 52417                                  ; M020 Begin
 52418                                  
 52419                                  RatBugCode:	; proc	far
 52420 000010FA 51                      	push	cx
 52421 000010FB 8B0E1000                	mov	cx,[10h]
 52422                                  rbc_loop:
 52423                                  	;loop	$
 52424 000010FF E2FE                    	loop	rbc_loop
 52425 00001101 59                      	pop	cx
 52426 00001102 CB                      	retf
 52427                                  
 52428                                  ; M020 End
 52429                                  
 52430                                  %endif
 52431                                  
 52432                                  ;---------------------------------------------------------------------------
 52433                                  
 52434                                  UmbSave1:
 52435                                  	;db	11 dup (?)	; M023
 52436 00001103 00<rep Bh>              	times	11 db 0
 52437                                  
 52438                                  ;---------------------------------------------------------------------------
 52439                                  ; 16/01/2024 - Retrodos v5.0
 52440                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA: 113Ah
 52441                                  
 52442                                  OLD_FIRSTCLUS_HW:
 52443 0000110E 0000                    	dw	0
 52444                                  
 52445                                  
 52446                                  ; 17/01/2024 
 52447                                  ; 08/03/2025 (MiniDOS)
 52448                                  %if 0
 52449                                  
 52450                                  ; DOS 3.3 F.C. 6/12/86
 52451                                  ; FASTOPEN communications area DOS 3.3   F.C. 5/29/86
 52452                                  
 52453                                  FastTable:				; a better name
 52454                                  FastOpenTable:
 52455                                  	dw      2                       ; number of entries
 52456                                  	dw      FastRet			; pointer to ret instr.
 52457                                  	dw      0                       ; and will be modified by
 52458                                  	dw      FastRet			; FASTxxx when loaded in
 52459                                  	dw      0
 52460                                  
 52461                                  ; DOS 3.3 F.C. 6/12/86
 52462                                  
 52463                                  FastFlg:				; flags
 52464                                  FastOpenFlg:
 52465                                  	db	0			; don't change the foll: order
 52466                                  
 52467                                  %endif
 52468                                  
 52469                                  ; 24/03/2024 - Retrto DOS v5.0
 52470                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1147h
 52471                                  ; 08/03/2025 (MiniDOS)
 52472                                  %if 0
 52473                                  
 52474                                  FastOpen_Ext_Info:
 52475                                  	;db	6 dup(0)
 52476                                  	times	6 db 0
 52477                                  UNKNOWN1:
 52478                                  	dw	0
 52479                                  	;db	5 dup(0)
 52480                                  	times	5 db 0
 52481                                  PATHNAMELEN:
 52482                                  	dw	67
 52483                                   
 52484                                  	;db	31 dup(0)
 52485                                  	times	31 db 0
 52486                                  %endif
 52487                                  
 52488                                  ; 09/03/2025
 52489                                  PATHNAMELEN:
 52490 00001110 4300                    	dw	67
 52491                                  
 52492                                  ; 17/01/2024
 52493                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1175h
 52494                                  CurSC_DRIVE:
 52495 00001112 FF                      	db	-1  ; 0FFh	; current SC drive
 52496                                  
 52497                                  ;M044
 52498                                  ; Second part of save area for saving last para of Windows memory
 52499                                  
 52500                                  ; 17/01/2024
 52501                                  WinoldPatch2:
 52502                                  	;db	8 dup (?)	; M044
 52503 00001113 00<rep 8h>              	times	8 db 0	
 52504                                  
 52505                                  FIRST_BUFF_ADDR:
 52506 0000111B 0000                    	dw	0
 52507                                  
 52508                                  ;----------------------------------------------------------------------------
 52509                                  ; 17/01/2024 - Retrodos v5.0
 52510                                  ; PCDOS 7.1 IBMDOS.COM
 52511                                  ; DOSDATA:1180h
 52512                                  
 52513                                  ; 08/03/2025 (MiniDOS)
 52514                                  %if 0
 52515                                  
 52516                                  ;============================================================================
 52517                                  ; WPATCH.INC (MSDOS 6.0, 1991)  ;;; Windows 3.1 patches ;;;
 52518                                  ;============================================================================
 52519                                  ; 27/04/2019 - Retro DOS 4.0
 52520                                  
 52521                                  ; DOSDATA:12CFh (MSDOS 6.21, MSDOS.SYS)
 52522                                  
 52523                                  ; Retro DOS v5.0
 52524                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1180h
 52525                                  
 52526                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 52527                                  ; DOSDATA:12CFh (MSDOS 5.0, MSDOS.SYS)
 52528                                  
 52529                                  ; first and second DOS patches
 52530                                  ;	Non-console device read/write (system calls 3Fh and 40h)
 52531                                  ;
 52532                                  ; Code in disk.asm, 2 locations, one for read, one for write
 52533                                  ;	DVRDLP:
 52534                                  ;	DVWRTLP:
 52535                                  ;
 52536                                  ;
 52537                                  ; 036h	lds	si,SS:[????]				  ; ThisSFT
 52538                                  ;	lds	si,si+7 				  ; sf_devptr
 52539                                  ; 0E8h	call	????		<- "simulate" int28 event ; DSKSTATCHK
 52540                                  
 52541                                  DOSP1_ID:	db	036h,0C5h,036h
 52542                                  DOSP1_THISSFT:	db	036h,005h,0C5h,074h,007h,0E8h
 52543                                  DOSP1_ID_LEN	equ	$-DOSP1_ID
 52544                                  
 52545                                  		db	90h, 90h
 52546                                  
 52547                                  DOSP12_ID:	db	036h,0C5h,036h
 52548                                  DOSP12_THISSFT:	db	036h,005h,0C5h,074h,007h,0E8h
 52549                                  DOSP12_ID_LEN	equ	$-DOSP1_ID
 52550                                  
 52551                                  ; DOSDATA:12E3h
 52552                                  
 52553                                  ; Third/Fourth DOS patch - System call 3Fh (Read) from console
 52554                                  ;
 52555                                  ; Code in disk.asm, 1 location
 52556                                  ;	GETBUF:
 52557                                  ;
 52558                                  ; 051h	push	cx	<- begin special int28 mode
 52559                                  ;	push	es
 52560                                  ;	push	di
 52561                                  ;	mov	dx,???? ; offset dosgroup:CONBUF
 52562                                  ;	call	????	; $STD_CON_STRING_INPUT
 52563                                  ;	pop	di
 52564                                  ;	pop	es
 52565                                  ; 059h	pop	cx	<- end special int28 mode
 52566                                  
 52567                                  DOSP3_ID:	db	051h,006h,057h,0BAh
 52568                                  DOSP3_CONBUF:	db	029h,002h,0E8h
 52569                                  DOSP3_ID_LEN	equ	$-DOSP3_ID
 52570                                  		db	09Ah,0E3h,05Fh,007h	; ???? , pop di, pop es
 52571                                  DOSP4_ID:	db	059h			; pop cx
 52572                                  DOSP4_ID_OFF	equ	(DOSP4_ID - DOSP3_ID)
 52573                                  	
 52574                                  ; DOSDATA:12EFh
 52575                                  
 52576                                  ; Fifth DOS patch - System call 40h (Write) to console
 52577                                  ;
 52578                                  ; Code in disk.asm, 1 location
 52579                                  ;
 52580                                  ;		push	cx
 52581                                  ;      WRCONLP: lodsb
 52582                                  ;		cmp	al,1Ah
 52583                                  ;		jz	????
 52584                                  ;		call	????	<- "simulate" int28 event
 52585                                  ;		loop	WRCONLP
 52586                                  ;      CONEOF:	pop	ax
 52587                                  
 52588                                  DOSP5_ID:	db	051h			; push cx
 52589                                  		db	0ACh,03Ch,01Ah,074h,005h
 52590                                  		db	0E8h			; call
 52591                                  DOSP5_ID_LEN	equ	$-DOSP5_ID
 52592                                  
 52593                                  ; DOSDATA:12F6h
 52594                                  
 52595                                  ; Seventh DOS patch - System call entry, patch USER_ID with VMid for share
 52596                                  ;
 52597                                  ; Code in disp.asm, 1 location
 52598                                  ;
 52599                                  ;
 52600                                  ;	mov [SaveDS],ds
 52601                                  ;	mov [SaveBX],bx
 52602                                  ;	mov bx,cs
 52603                                  ;	mov ds,bx
 52604                                  ;	inc [indos]
 52605                                  ;	xor ax,ax
 52606                                  ;	mov [USER_ID],AX	<- Patch to set USER_ID to VMID
 52607                                  
 52608                                  DOSP7_ID:	db	02Eh,08Ch,01Eh
 52609                                  DOSP7_SAVEDS:	db	07Eh,05h		; mov [SaveDS],ds
 52610                                  		db	02Eh,089h,01Eh
 52611                                  DOSP7_SAVEBX:	db	07Ch,05h		; mov [SaveBX],bx
 52612                                  		db	08Ch,0CBh		; mov bx,cs
 52613                                  		db	08Eh,0DBh		; mov ds,bx
 52614                                  		db	0FEh,006h
 52615                                  DOSP7_INDOS:	db	0CFh,002h		; inc [indos]
 52616                                  		db	033h,0C0h		; xor ax,ax
 52617                                  DOSP7_ID_LEN	equ	$-DOSP7_ID
 52618                                  
 52619                                  ; DOSDATA:130Ah
 52620                                  
 52621                                  ; Eighth DOS patch - OWNER check in handle calls. For share, need to NOP test
 52622                                  ;
 52623                                  ; Code in handle.asm, 1 location in routine CheckOwner
 52624                                  ;
 52625                                  ;
 52626                                  ;
 52627                                  ;	push	ax
 52628                                  ;	mov	ax,ss:[USER_ID]     <- patch to XOR AX,AX to set zero
 52629                                  ;	cmp	ax,es:[di.sf_UID]   <- NOP
 52630                                  ;	pop	ax
 52631                                  ;	jz	????
 52632                                  
 52633                                  DOSP8_ID:	db	050h			; push ax
 52634                                  		db	036h,0A1h
 52635                                  DOSP8_USER_ID:	db	0EAh,002h		; mov  ax,ss:[USER_ID]
 52636                                  		db	026h,03Bh,045h		; cmp  ax,es:[di+2F]
 52637                                  DOSP8_ID_LEN	equ	$-DOSP8_ID
 52638                                  		db	02Fh,058h		; pop  ax
 52639                                  
 52640                                  ; DOSDATA:1314h
 52641                                  
 52642                                  ; 10th, 11th, 12th DOS patch - System call 3Fh (Read) in raw mode
 52643                                  ;
 52644                                  ;   Take RAW read to STDIN SFT and turn it into a polling loop doing
 52645                                  ;   a yeild when a character is not ready to be read.
 52646                                  ;
 52647                                  ; Code in disk.asm, 3 locations
 52648                                  ;
 52649                                  ;   DVRDRAW:
 52650                                  ;	    PUSH    ES
 52651                                  ;	    POP     DS
 52652                                  ;   ReadRawRetry:				<- Patch 10
 52653                                  ;	    MOV     BX,DI
 52654                                  ;	    XOR     AX,AX			<- Reenter #2
 52655                                  ;	    MOV     DX,AX
 52656                                  ;	    call    SETREAD
 52657                                  ;	    PUSH    DS				<- Reenter #1
 52658                                  ;	    LDS     SI,[THISSFT]
 52659                                  ;	    call    DEVIOCALL
 52660                                  ;	    MOV     DX,DI
 52661                                  ;	    MOV     AH,86H
 52662                                  ;	    MOV     DI,[DEVCALL.REQSTAT]
 52663                                  ;	    TEST    DI,STERR
 52664                                  ;	    JZ	    CRDROK
 52665                                  ;	    call    CHARHARD
 52666                                  ;	    MOV     DI,DX
 52667                                  ;	    OR	    AL,AL
 52668                                  ;	    JZ	    CRDROK
 52669                                  ;	    CMP     AL,3
 52670                                  ;	    JZ	    CRDFERR
 52671                                  ;	    POP     DS
 52672                                  ;	    JMP     ReadRawRetry
 52673                                  ;
 52674                                  ;   CRDFERR:
 52675                                  ;	    POP     DI				<- Patch 11
 52676                                  ;   DEVIOFERR:
 52677                                  ;	    LES     DI,[THISSFT]
 52678                                  ;	    jmp     SET_ACC_ERR_DS
 52679                                  ;
 52680                                  ;   CRDROK:
 52681                                  ;	    POP     DI				<- Patch 12
 52682                                  ;	    MOV     DI,DX
 52683                                  ;	    ADD     DI,[CALLSCNT]
 52684                                  ;	    JMP     SHORT ENDRDDEVJ3
 52685                                  
 52686                                  DOSP10_ID:		db	006H,01FH
 52687                                  DOSP10_LOC_OFFSET	equ	$-DOSP10_ID
 52688                                  DOSP10_LOC:		db	08BH,0DFH
 52689                                  DOSP10_REENT2_OFFSET	equ	$-DOSP10_LOC
 52690                                  			db	033H,0C0H,08BH,0D0H,0E8H
 52691                                  DOSP10_ID_LEN		equ	$-DOSP10_ID
 52692                                  			db	0DFH,00EH
 52693                                  DOSP10_REENT1_OFFSET	equ	$-DOSP10_LOC
 52694                                  			db	01EH,036H,0C5H,036H,036H,005H,0E8H,0AFH,00EH
 52695                                  			db	08BH,0D7H,0B4H,086H,036H,08BH,03EH
 52696                                  DOSP10_PACKVAL_OFFSET	equ	$-DOSP10_ID
 52697                                  			db	009H,003H
 52698                                  			db	0F7H,0C7H,000H,080H,074H,019H,0E8H,047H,017H
 52699                                  			db	08BH,0FAH,00AH,0C0H,074H,010H,03CH,003H,074H,003H
 52700                                  			db	01FH,0EBH,0CFH
 52701                                  DOSP11_LOC_OFFSET	equ	$-DOSP10_ID
 52702                                  			db	05FH
 52703                                  DOSP11_REENT_OFFSET	equ	$-DOSP10_LOC
 52704                                  			db	036H,0C4H,03EH,036H,005H,0E9H,0A1H,004H
 52705                                  
 52706                                  DOSP12_LOC_OFFSET	equ	$-DOSP10_ID
 52707                                  			db	05FH,08BH,0FAH
 52708                                  ; DOSDATA:1353h
 52709                                  
 52710                                  ; 13th DOS patch - Actually a SYSINIT patch. Patches the stack fault code
 52711                                  ;		which prints the fatal stack fault error on DOS >= 3.20.
 52712                                  ;
 52713                                  ;	    Sets focus to current VM so user can see fatal message.
 52714                                  ;
 52715                                  ;
 52716                                  ;	l0: lodsb		<- Setfocus here
 52717                                  ;	    cmp al, '$'
 52718                                  ;	    je l1
 52719                                  ;	    mov bl, 7
 52720                                  ;	    mov ah, 0Eh
 52721                                  ;	    int 10h
 52722                                  ;	    jmp l0
 52723                                  ;	l1: jmp $
 52724                                  
 52725                                  DOSP13_ID:	db	0ACh			; l0: lodsb
 52726                                  		db	03Ch,024h		;     cmp al, '$'
 52727                                  		db	074h,008h		;     je l1
 52728                                  		db	0B3h,007h		;     mov bl, 7
 52729                                  		db	0B4h,00Eh		;     mov ah, 0Eh
 52730                                  		db	0CDh,010h		;     int 10h
 52731                                  		db	0EBh,0F3h		;     jmp l0
 52732                                  		db	0EBh,0FEh		; l1: jmp $
 52733                                  DOSP13_ID_LEN	equ	$-DOSP13_ID
 52734                                  
 52735                                  ; 05/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 52736                                  ; DOSDATA:1362h (MSDOS 5.0 MSDOS.SYS)
 52737                                  
 52738                                  ; 05/01/2024
 52739                                  %endif	; 05/11/2022
 52740                                  
 52741                                  ;----------------------------------------------------------------------------
 52742                                  
 52743                                  ; DOSDATA:122Ah
 52744                                  
 52745                                  Mark3:	; label byte
 52746                                  
 52747                                  ;IF2
 52748                                  ;	IF ((OFFSET MARK3) GT (OFFSET COUNTRY_CDPG) )
 52749                                  ;		%OUT !DATA CORRUPTION!MARK3 OFFSET TOO BIG. RE-ORGANIZE DATA.
 52750                                  ;	ENDIF
 52751                                  ;ENDIF
 52752                                  
 52753                                  ;----------------------------------------------------------------------------
 52754                                  
 52755                                  ; 27/04/2019 - Retro DOS v4.0
 52756                                  ; 05/01/2024 - Retro DOS v5.0
 52757                                  
 52758                                  ;include msdos.cl2			; XMMERRMSG
 52759                                  
 52760                                  ; DOSDATA:12B8h (MSDOS 6.22, MSDOS.SYS) ; 17/01/2024
 52761                                  ; DOSDATA:1213h (PCDOS 7.1, IBMDOS.COM) ; 05/01/2024
 52762                                  
 52763                                  XMMERRMSG:
 52764 0000111D 0D0A                    	db	0Dh,0Ah
 52765 0000111F 413230204861726477-     	db	'A20 Hardware Error',0Dh,0Ah,'$'
 52765 00001128 617265204572726F72-
 52765 00001131 0D0A24             
 52766                                  
 52767                                  ;----------------------------------------------------------------------------
 52768                                  ;----------------------------------------------------------------------------
 52769                                  	
 52770                                  	; 08/03/2025 (MiniDOS 1.0)
 52771                                  
 52772                                  ; 16/03/2025
 52773                                  ;FILLZERO equ 0122Ah - $
 52774                                  
 52775                                  ;	times FILLZERO db 0
 52776                                  
 52777                                  ; 16/03/2025
 52778 00001134 00                      db 0
 52779 00001135 90                      align 2
 52780                                  
 52781                                  ;----------------------------------------------------------------------------
 52782                                  
 52783                                  ;----------------------------------------------------------------------------
 52784                                  ; 17/01/2024 - Note: COUNTRY_CDPG must be at DOSDATA:122Ah (to 12B8h) addr
 52785                                  ; It is fixed at 122Ah in PCDOS 7.1 IBMDOS.COM and MSDOS 5.0-6.22 MSDOS.SYS
 52786                                  ;----------------------------------------------------------------------------
 52787                                  
 52788                                  ;############################################################################
 52789                                  ;
 52790                                  ; ** HACK FOR DOS 4.0 REDIR **
 52791                                  ;
 52792                                  ; The dos 4.X redir requires that country_cdpg is at offset 0122ah. Any new
 52793                                  ; data variable that is to be added to DOSDATA must go in between Mark3
 52794                                  ; COUNTRY_CDPG if it can. 
 52795                                  ;
 52796                                  ; MARK3 SHOULD NOT BE > 122AH 
 52797                                  ;
 52798                                  ; As of 9/6/90, this area is FULL!
 52799                                  ;
 52800                                  ;############################################################################
 52801                                   
 52802                                  	;ORG	0122Ah
 52803                                  
 52804                                  ; DOSDATA:122Ah (MSDOS 6.21, MSDOS.SYS)
 52805                                  
 52806                                  ; 09/01/2024 - Retro DOS v5.0
 52807                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:122Ah
 52808                                  
 52809                                  ; 17/01/2024
 52810                                  ; MSDOS 5.0  MSDOS.SYS - DOSDATA:122Ah
 52811                                  ; MSDOS 6.22 MSDOS.SYS - DOSDATA:122Ah
 52812                                  ; 09/03/2024
 52813                                  ; Windows ME    IO.SYS - DOSDATA:122Ah
 52814                                  
 52815                                  ; The following table is used for DOS 3.3
 52816                                  ;DOS country and code page information is defined here for DOS 3.3.
 52817                                  ;The initial value for ccDosCountry is 1 (USA).
 52818                                  ;The initial value for ccDosCodepage is 850.
 52819                                  
 52820                                  ; country and code page information
 52821                                  ; ---------------------------------------------------------------------------
 52822                                  COUNTRY_CDPG:	; label  byte
 52823 00001136 0000000000000000        	db   0,0,0,0,0,0,0,0		; reserved words
 52824 0000113E 5C434F554E5452592E-     	db   '\COUNTRY.SYS',0		; path name of country.sys
 52824 00001147 53595300           
 52825                                  	;db   51 dup (?)
 52826 0000114B 00<rep 33h>             	times 51 db 0
 52827                                  ; ------------------------------------------------<MSKK01>-------------------
 52828                                  ;ifdef	DBCS
 52829                                  ;  ifdef JAPAN
 52830                                  ;	dw   932			; system code page id (JAPAN)
 52831                                  ;  endif
 52832                                  ;  ifdef TAIWAN
 52833                                  ;	dw   938			; system code page id (TAIWAN)
 52834                                  ;  endif
 52835                                  ;  ifdef KOREA
 52836                                  ;	dw   934			; system code page id (KOREA IBM)
 52837                                  ;  endif
 52838                                  ;else
 52839 0000117E B501                    	dw   437			; system code page id
 52840                                  ;endif
 52841                                  ; ------------------------------------------------<MSKK01>-------------------
 52842 00001180 0600                    	dw   6				; number of entries
 52843                                  COUNTRY_CDPG_76: ; COUNTRY_CDPG + 76 
 52844 00001182 02                      	db   SetUcase  ; 2		; Ucase type
 52845 00001183 [FA0A]                  	dw   UCASE_TAB			;pointer to upper case table
 52846 00001185 0000                    	dw   0				; segment of poiter
 52847 00001187 04                      	db   SetUcaseFile  ; 4		; Ucase file char type
 52848 00001188 [7C0B]                  	dw   FILE_UCASE_TAB 		;pointer to file upper case table
 52849 0000118A 0000                    	dw   0				; segment of poiter
 52850 0000118C 05                      	db   SetFileList ; 5		; valid file chars type
 52851 0000118D [280D]                  	dw   FILE_CHAR_TAB 		;pointer to valid file char tab
 52852 0000118F 0000                    	dw   0				; segment of poiter
 52853 00001191 06                      	db   SetCollate	; 6		; collate type
 52854 00001192 [FE0B]                  	dw   COLLATE_TAB		;pointer to collate table
 52855 00001194 0000                    	dw   0				; segment of poiter
 52856 00001196 07                      	db   SetDBCS	; 7		;AN000; DBCS Ev			2/12/KK
 52857 00001197 [000D]                  	dw   DBCS_TAB			;AN000;pointer to DBCS Ev table	2/12/KK
 52858 00001199 0000                    	dw   0				;AN000; segment of pointer	2/12/KK
 52859 0000119B 01                      	db   SetCountryInfo  ; 1	; country info type
 52860 0000119C 2600                    	dw   NEW_COUNTRY_SIZE		; extended country info size
 52861                                  ; ------------------------------------------------<MSKK01>-------------------
 52862                                  ;ifdef	DBCS
 52863                                  ;	......
 52864                                  ;else
 52865                                  	; 09/01/2024 - Retro DOS v5.0
 52866                                  	; PCDOS 7.1 IBMDOS.COM - DOSDATA:1292h
 52867                                  _COUNTRY_ID:
 52868 0000119E 0100                    	dw   1				; USA country id
 52869 000011A0 B501                    	dw   437			; USA system code page id
 52870                                  COUNTRY_CDPG_108: ; COUNTRY_CDPG + 108	
 52871 000011A2 0000                    	dw   0 				; date format
 52872 000011A4 2400000000              	db   '$',0,0,0,0		; currency symbol
 52873 000011A9 2C00                    	db   ',',0			; thousand separator
 52874 000011AB 2E00                    	db   '.',0			; decimal separator
 52875 000011AD 2D00                    	db   '-',0			; date separator
 52876 000011AF 3A00                    	db   ':',0			; time separator
 52877 000011B1 00                      	db   0				; currency format flag
 52878 000011B2 02                      	db   2				; # of digits in currency
 52879 000011B3 00                      	db   0 				; time format
 52880 000011B4 [6B0D]                  	dw   MAP_CASE			; mono case routine entry point
 52881 000011B6 0000                    	dw   0				; segment of entry point
 52882 000011B8 2C00                    	db   ',',0			; data list separator
 52883 000011BA 000000000000000000-     	dw   0,0,0,0,0			; reserved
 52883 000011C3 00                 
 52884                                  ;endif
 52885                                  ; ------------------------------------------------<MSKK01>-------------------
 52886                                  
 52887                                  ;----------------------------------------------------------------------------
 52888                                  ; 01/01/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 52889                                  
 52890                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:12B8h
 52891                                  
 52892                                  INDOS_FLAG:
 52893 000011C4 00                      	db 0		; duplicated INDOS flag, what for ? 
 52894                                  			; (PCDOS 7.1 kernel CODE always updates it together
 52895                                  			; with 'INDOS' flag !?)
 52896                                  ; 09/01/2024
 52897                                  DEVIO_IN_PROGRESS:
 52898 000011C5 00                      	db 0
 52899                                  
 52900                                  ; 09/01/2024
 52901                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:12BAh
 52902                                  ; ----------
 52903                                  ; INTERNATIONALIZATION INFORMATION
 52904                                  ;	 for Get/Set Extended Country Info functions
 52905                                  
 52906 000011C6 454E5500                _ENU:	db 'ENU',0
 52907 000011CA 55534100                _USA:	db 'USA',0
 52908 000011CE 5553                    _US:	db 'US'
 52909 000011D0 0100                    	dw 1
 52910 000011D2 0200                    	dw 2
 52911 000011D4 0000                    	dw 0
 52912 000011D6 414D00                  _AM:	db 'AM',0
 52913 000011D9 504D00                  _PM:	db 'PM',0
 52914                                  _MMDDYY:
 52915 000011DC 4D2F642F7979202020-     	db 'M/d/yy     dddd,MMMMdd,yyyy         '
 52915 000011E5 2020646464642C4D4D-
 52915 000011EE 4D4D64642C79797979-
 52915 000011F7 202020202020202020 
 52916 00001200 00                      	db 0
 52917 00001201 00                      	db 0
 52918 00001202 0000                    	dw 0
 52919                                  
 52920                                  ; 09/01/2024
 52921                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:12F8h
 52922                                  
 52923                                  VxDpath:
 52924 00001204 633A5C77696E613230-     	db 'c:\wina20.386',0
 52924 0000120D 2E33383600         
 52925 00001212 0000                    	dw 0
 52926                                  
 52927                                  ; 09/01/2024
 52928                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1308h
 52929                                  
 52930                                  drive_flags:
 52931 00001214 00<rep 1Ah>             	times 26 db 0
 52932                                  
 52933                                  DriverLoad:
 52934 0000122E 01                              db 1
 52935                                  BiosDataPtr:	; 08/03/2024
 52936 0000122F 0000<rep 2h>            	times 2 dw 0
 52937 00001233 00<rep 5h>              	times 5 db 0
 52938 00001238 0400                    	dw 4
 52939 0000123A [C411]                  	dw INDOS_FLAG
 52940 0000123C [1412]                  	dw drive_flags
 52941 0000123E [4212]                  	dw NLS_YES	; "YN"
 52942 00001240 [4612]                  	dw unknown_zero_dd
 52943                                  NLS_YES:
 52944 00001242 59                      	db 'Y'
 52945 00001243 4E                      NLS_NO:	db 'N'
 52946                                  NLS_yes2:
 52947 00001244 79                      	db 'y'
 52948                                  NLS_no2:
 52949 00001245 6E                      	db 'n'
 52950                                  
 52951                                  unknown_zero_dd:
 52952 00001246 00000000                	dd 0
 52953                                  
 52954                                  ; ---------------------------------------------------------------------------
 52955                                  
 52956                                  ; 27/04/2019 - Retro DOS v4.0
 52957                                  
 52958                                  ;include msdos.cl2			; XMMERRMSG
 52959                                  
 52960                                  ; DOSDATA:12B8h (MSDOS 6.21, MSDOS.SYS)
 52961                                  
 52962                                  ;XMMERRMSG:
 52963                                  ;	db	0Dh,0Ah
 52964                                  ;	db	'A20 Hardware Error',0Dh,0Ah,'$'
 52965                                  
 52966                                  ; DOSDATA ends
 52967                                  
 52968                                  ; 05/11/2022
 52969                                  ;----------------------------------------------------------------------------
 52970                                  ; End of MSDOS 5.0 MSDOS.SYS /// Retro DOS v4.0 (2022) - 05/11/2022
 52971                                  ;----------------------------------------------------------------------------
 52972                                  
 52973                                  ;============================================================================
 52974                                  ; MPATCH.ASM (MSDOS 6.0, 1993)
 52975                                  ;============================================================================
 52976                                  ; 27/04/2019 - Retro DOS 4.0
 52977                                  
 52978                                  ;mpatch.asm -- holds data patch location for callouts 
 52979                                  ; -- allocate cluster in rom.asm
 52980                                  ;
 52981                                  ; This area is pointed to by OffsetMagicPatch[609h] in fixed DOS data.
 52982                                  ; Currently, this location is used only by magicdrv.sys's patch to
 52983                                  ; cluster allocation, however it can be expanded to be used by other
 52984                                  ; patches. This is important since we have an easy-access pointer to
 52985                                  ; this location in OffsetMagicPatch. Magicdrv.sys is guaranteed to
 52986                                  ; only patch out a far call/retf, so any space after that could be
 52987                                  ; used as a patch by using OffsetMagicPatch+6. See rom.asm on how
 52988                                  ; to call out here.
 52989                                  ;
 52990                                  ; Currently, we allocate only the minimum space required for the 6
 52991                                  ; byte magicdrv patch, so if you change the dos data, you may want
 52992                                  ; to reserve space here if your new data will be position dependent
 52993                                  ; and would prohibit growing of this table.
 52994                                  ;
 52995                                  ;history	-	created 8-7-92 by scottq
 52996                                  ;		-	added Rational386PatchPtr 2-1-93 by jimmat
 52997                                  ;
 52998                                  ;Exported Functions
 52999                                  ;==================
 53000                                  ;MagicPatch     -       callout patched by magidrv.sys for cluster allocations
 53001                                  
 53002                                  ; DosData Segment
 53003                                  
 53004                                  ; DOSDATA:1362h (MSDOS 6.21, MSDOS.SYS)
 53005                                  
 53006                                  ; ---------------------------------------------------------------------------
 53007                                  
 53008                                  ; Rational386PatchPtr points to either a RET instruction (80286 or less) or
 53009                                  ; a routine to fix buggy versions of the Rational DOS Extender (80386 or
 53010                                  ; greater). Added to this file because it needed to be somewhere and is
 53011                                  ; 'patch' related.
 53012                                  
 53013                                  Rational386PatchPtr:
 53014 0000124A 0000                    	dw	0	; points to patch routine or RET instr.
 53015                                  ; ---------------------------------------------------------------------------
 53016                                  
 53017                                  ; 25/03/2024
 53018                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1340h
 53019                                  ; (Windows ME IO.SYS - DOSDATA:133Eh)
 53020                                  
 53021                                  ; 07/03/2025
 53022                                  %if 0
 53023                                  MagicPatch:
 53024                                  ;MagicPatch proc far
 53025                                          retf            ;default is to just return to allocate
 53026                                          nop             ;however, this code will be patched
 53027                                          nop             ;by magicdrv.sys to
 53028                                          nop             ; call far ?:?     
 53029                                          nop             ; retf or perhaps just jmp far
 53030                                          nop             ;retf/nop take one byte, so we need six instructions
 53031                                                          ;for 6 byte patch
 53032                                  ;MagicPatch endp
 53033                                  %endif
 53034                                  
 53035                                  ; ---------------------------------------------------------------------------
 53036                                  
 53037                                  ;DosData Ends
 53038                                  
 53039                                  ; MSDOS 5.0-6.22 MSDOS.SYS - DOSDATA:136Ah
 53040                                  ;
 53041                                  ; 25/03/2024 - Retro DOS v5.0
 53042                                  ; PCDOS 7.1 IBMDOS.COM - DOSDATA:1346h
 53043                                  
 53044                                  ;; Windows ME IO.SYS
 53045                                  ;; db 12 dup(0)
 53046                                  
 53047                                  ; (Windows ME IO.SYS - DOSDATA:1344h)
 53048                                  
 53049                                  ;----------------------------------------------------------------------------
 53050                                  
 53051                                  ;DOSDATALAST SEGMENT
 53052                                  
 53053                                  ; 29/04/2019 - Retro DOS v4.0
 53054                                  
 53055                                  ;----------------------------------------------------------------------------
 53056                                  ; 25/05/2019 - Retro DOS v4.0 Modification (paragraph alignment)
 53057                                  
 53058                                  ;db 0,1,12,64,19,0 ; ! Magic numbers !
 53059                                  
 53060                                  ;align 16
 53061                                  
 53062                                  ; !!! DOSDATA:1370h ; Retro DOS v4.0 only!
 53063                                  
 53064                                  ;----------------------------------------------------------------------------
 53065                                  
 53066                                  ; 05/01/2024
 53067                                  ;%endif	; 05/11/2022
 53068                                  
 53069                                  ; 05/12/2022
 53070                                  ;MSDAT001E:	; label byte
 53071                                  
 53072                                  ; 22/03/2024 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMDOS.COM)
 53073                                  ; 05/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 MSDOS.SYS)
 53074                                  DOSDATAEND equ $
 53075                                  DOSDATASIZE equ DOSDATAEND - DOSDATASTART ; = 4962 for MSDOS 5.0 MSDOS.SYS
 53076                                  					; = 4970 for MSDOS 6.22 MSDOS.SYS
 53077                                  MSDAT001E equ DOSDATAEND - DOSDATASTART ; = 4934 for PCDOS 7.1 IBMDOS.COM
 53078                                  					; (= 4944 for Windows ME IO.SYS)
 53079                                  ;DOSDATALAST ENDS
 53080                                  
 53081                                  ; Retro DOS v4.0 by Erdogan Tan (Redevelopment of MSDOS 5.0 KERNEL via NASM)
 53082                                  ; DECEMBER 2022, ISTANBUL - TURKIYE.
 53083                                  ;============================================================================
 53084                                  ;	END
 53085                                  ;============================================================================
 53086                                  ; Retro DOS v4.0 by Erdogan Tan (Redevelopment of MSDOS 6.21 KERNEL via NASM)
 53087                                  ; -----------------------------
 53088                                  ; MAY 2019, ISTANBUL - TURKIYE.
 53089                                  ;============================================================================
 53090                                  ; 25/03/2024 - RETRO DOS v5.0 KERNEL code is READY! (Start: 01/01/2024)
