     1                                  ; ****************************************************************************
     2                                  ; cgaplay.asm - Retro DOS (MSDOS/PCDOS) WAV PLAYER - Video Mode 13h
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; CGAPLAY.COM ! AC'97 (ICH) .WAV PLAYER program by Erdogan TAN
     5                                  ;
     6                                  ; 01/01/2025				- play music from multiple wav files -
     7                                  ;
     8                                  ; [ Last Modification: 01/01/2025 ]
     9                                  ;
    10                                  ; Modified from CGAPLAY1.PRG .wav player program by Erdogan Tan, 31/12/2024
    11                                  ;	        AC97PLAY.COM, 18/12/2024
    12                                  ;
    13                                  ; ****************************************************************************
    14                                  ; nasm cgaplay.asm -l cgaplay.lst -o CGAPLAY.COM -Z error.txt
    15                                  
    16                                  ; 31/12/2024
    17                                  ; cgaplay1.s (int 31h modifications on cgaplay.s) -TRDOS386-PRG-
    18                                  ; 18/12/2024
    19                                  ; ac97play.asm : TUNELOOP version (playing without AC97 interrupt) -DOS-COM-
    20                                  
    21                                  ; vgaplay.s (26/12/2024) - play music from multiple wav files -
    22                                  ; dplayvga.s (25/12/2024) - play music from single wav file -
    23                                  ; ac97play.s (18/12/2024) - play music from multiple wav files -
    24                                  
    25                                  ; 07/12/2024 - playwav9.s - interrupt (srb) + tuneloop version
    26                                  ; ------------------------------------------------------------
    27                                  ; INTERRUPT (SRB) + TUNELOOP version ; 24/11/2024 (PLAYWAV9.ASM)
    28                                  ;	(running in DOSBOX, VIRTUALBOX, QEMU is ok)
    29                                  ; Signal Response Byte = message/signal to user about an event/interrupt
    30                                  ;	    as requested (TuneLoop procedure continuously checks this SRB)
    31                                  ; (TRDOS 386 v2 feature is used here as very simple interrupt handler output)
    32                                  
    33                                  ; ------------------------------------------------------------
    34                                  
    35                                  ; 01/01/2025	
    36                                  %macro	sys_msg	2
    37                                  	mov	si, %1	; message
    38                                  	mov	bl, %2	; text color
    39                                  	xor	bh, bh	; video page 0
    40                                  	mov	ah, 0Eh
    41                                  	call	p_msg	
    42                                  %endmacro
    43                                  
    44                                  ; ------------------------------------------------------------
    45                                  ; player internal variables and other equates.
    46                                  ;BUFFERSIZE	equ 64 * 1024	; 64k file buffer size.
    47                                  ; 17/11/2024
    48                                  BUFFERSIZE	equ 65520
    49                                  ENDOFFILE	equ 1		; flag for knowing end of file
    50                                  ; ------------------------------------------------------------
    51                                  
    52                                  [BITS 16] ; 16-bit intructions
    53                                  
    54                                  [ORG 100h]
    55                                  
    56                                  	; 01/01/2025
    57                                  START_CODE:
    58                                  	; 30/05/2024
    59                                  	; Prints the Credits Text.
    60                                  	sys_msg Credits, 0Bh
    37 00000000 BE[4821]            <1>  mov si, %1
    38 00000003 B30B                <1>  mov bl, %2
    39 00000005 30FF                <1>  xor bh, bh
    40 00000007 B40E                <1>  mov ah, 0Eh
    41 00000009 E88C03              <1>  call p_msg
    61                                  
    62                                  	; 01/01/2025
    63                                  	; (setFree is required before memAlloc)
    64                                  	; 30/05/2024
    65 0000000C E8BF05                          call    setFree		; deallocate unused DOS mem
    66                                  
    67                                  	; 17/02/2017
    68                                  	; Clear BSS (uninitialized data) area
    69 0000000F 31C0                    	xor	ax, ax ; 0
    70 00000011 B99D01                  	mov	cx, (bss_end - bss_start)/2
    71 00000014 BF[5427]                	mov	di, bss_start
    72 00000017 F3AB                    	rep	stosw
    73                                  
    74                                  ; -------------------------------------------------------------
    75                                  
    76                                  	; 21/12/2024
    77                                  	; Detect (& Enable) AC'97 Audio Device
    78 00000019 E82F05                  	call	DetectAC97
    79 0000001C 730F                    	jnc	short ac97_hardware_ready
    80                                  
    81                                  	; 30/11/2024
    82                                  	; 30/05/2024
    83                                  _dev_not_ready:
    84                                  	; couldn't find the audio device!
    85                                  	sys_msg noDevMsg, 0Fh
    37 0000001E BE[EA21]            <1>  mov si, %1
    38 00000021 B30F                <1>  mov bl, %2
    39 00000023 30FF                <1>  xor bh, bh
    40 00000025 B40E                <1>  mov ah, 0Eh
    41 00000027 E86E03              <1>  call p_msg
    86 0000002A E93D03                          jmp     Exit
    87                                  
    88                                  ac97_hardware_ready:
    89 0000002D E8EC09                  	call	write_audio_dev_info
    90                                  
    91                                  ; -------------------------------------------------------------
    92                                  	; 30/05/2024
    93                                  allocate_memory:
    94                                  
    95                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    96                                  
    97 00000030 B81000                          mov     ax, BDL_SIZE / 16
    98 00000033 E8A005                          call    memAlloc
    99 00000036 A3[722A]                        mov     [BDL_BUFFER], ax	; segment 
   100                                  
   101                                  ; allocate 2 buffers, 64k each for now.
   102                                  
   103 00000039 B8FF0F                          mov     ax, BUFFERSIZE / 16	; 64k for .WAV file
   104 0000003C E89705                          call    memAlloc
   105 0000003F A3[742A]                        mov     [WAV_BUFFER1], ax	; segment
   106                                  
   107 00000042 B8FF0F                  	mov	ax, BUFFERSIZE / 16
   108 00000045 E88E05                  	call	memAlloc
   109 00000048 A3[762A]                	mov	[WAV_BUFFER2], ax
   110                                  
   111                                  ; -------------------------------------------------------------
   112                                  
   113                                  	; 01/01/2025
   114                                  	; set VGA/CGA mode (320*200 pixels, 256 colors)
   115 0000004B B81300                  	mov	ax, 13h
   116 0000004E CD10                    	int	10h
   117                                  
   118                                  ; -------------------------------------------------------------
   119                                  
   120                                  mode_13h_set_ok:
   121                                  	; 01/01/2025
   122                                  	;mov	word [graphstart], (11*8*320)+(4*320)
   123                                  
   124                                  ; -------------------------------------------------------------
   125                                  
   126                                  	; 01/01/2025
   127                                  Player_ParseParameters:
   128                                  	; 28/11/2024
   129 00000050 BE8100                  	mov	si, 81h
   130 00000053 8936[102A]              	mov	[PSP_CurrentOffset], si
   131 00000057 803C0D                  	cmp	byte [si], 0Dh		; "CR": No command line parameters
   132 0000005A 7737                    	ja	short Player_ParseNextParameter ; 01/01/2025
   133 0000005C E91203                  	jmp	pmsg_usage
   134                                  
   135                                  	; 30/12/2024
   136                                  	; 29/11/2024
   137                                  check_p_command:
   138 0000005F 803E[DD29]50              	cmp	byte [command], 'P'
   139 00000064 740C                    	je	short Player_ParsePreviousParameter
   140                                      
   141 00000066 8B36[102A]              	mov	si, [PSP_CurrentOffset]
   142 0000006A 803C0D                  	cmp	byte [si], 0Dh
   143 0000006D 7724                    	ja	short Player_ParseNextParameter
   144                                  jmp_Player_Quit:
   145 0000006F E96703                  	jmp	Player_Quit
   146                                  
   147                                  Player_ParsePreviousParameter:
   148                                  	; 29/11/2024
   149                                  	;mov	byte [command], 0
   150                                  
   151 00000072 8B36[102A]              	mov	si, [PSP_CurrentOffset]
   152                                  
   153 00000076 81FE8100                	cmp	si, 81h
   154 0000007A 7417                    	je	short Player_ParseNextParameter
   155                                  
   156                                  	;; Search for previous space character
   157 0000007C 4E                      	dec	si
   158 0000007D B90200                  	mov	cx, 2
   159                                  PSPParsePrev_Search:
   160 00000080 4E                      	dec	si
   161 00000081 8A04                    	mov	al, [si]
   162 00000083 3C20                    	cmp	al, 20h
   163 00000085 75F9                    	jne	short PSPParsePrev_Search
   164                                  
   165 00000087 81FE8100                	cmp	si, 81h
   166 0000008B 7602                    	jna	PSPParsePrev_Copy
   167 0000008D E2F1                    	loop	PSPParsePrev_Search
   168                                  
   169                                  PSPParsePrev_Copy:
   170 0000008F 8936[102A]              	mov	[PSP_CurrentOffset], si
   171                                  	
   172                                  Player_ParseNextParameter:
   173                                  	; 29/11/2024
   174 00000093 E82600                  	call	GetFileName
   175 00000096 E3D7                    	jcxz	jmp_Player_Quit
   176                                  
   177                                  	; 01/01/2025
   178                                  	; 28/11/2024
   179 00000098 BA[122A]                	mov	dx, wav_file_name
   180                                  
   181                                  	; 30/12/2024
   182                                          ; open existing file
   183 0000009B E8E804                          call	openFile ; no error? ok.
   184 0000009E 736C                            jnc	getwavparms	; 14/11/2024
   185                                  
   186                                  	; 29/11/2024
   187 000000A0 803E[DE29]00            	cmp	byte [filecount], 0
   188 000000A5 77B8                    	ja	short check_p_command
   189                                  
   190                                  	; 25/12/2024
   191                                  	; 21/12/2024
   192 000000A7 E81A03                  	call	set_text_mode
   193                                  	; file not found!
   194                                  	; 01/01/2025
   195                                  	; 30/11/2024
   196                                  	sys_msg	noFileErrMsg, 0Ch
    37 000000AA BE[1522]            <1>  mov si, %1
    38 000000AD B30C                <1>  mov bl, %2
    39 000000AF 30FF                <1>  xor bh, bh
    40 000000B1 B40E                <1>  mov ah, 0Eh
    41 000000B3 E8E202              <1>  call p_msg
   197 000000B6 E9B102                          jmp     Exit
   198                                  
   199                                  _exit_:
   200 000000B9 E9AB02                  	jmp	terminate
   201                                  
   202                                  ; -------------------------------------------------------------
   203                                  
   204                                  	; 29/11/2024
   205                                  	; 30/05/2024
   206                                  GetFileName:
   207 000000BC BF[122A]                	mov	di, wav_file_name 
   208 000000BF 8B36[102A]              	mov	si, [PSP_CurrentOffset]
   209 000000C3 31C9                    	xor	cx, cx ; 0
   210                                  ScanName:
   211 000000C5 AC                      	lodsb
   212                                  	;test	al, al
   213                                  	;jz	short a_4
   214                                  	; 29/11/2024
   215 000000C6 3C0D                    	cmp	al, 0Dh
   216 000000C8 7639                    	jna	short a_4
   217 000000CA 3C20                    	cmp	al, 20h
   218 000000CC 74F7                    	je	short ScanName	; scan start of name.
   219 000000CE AA                      	stosb
   220 000000CF B4FF                    	mov	ah, 0FFh
   221                                  	;;;
   222                                  	; 14/11/2024
   223                                  	; (max. path length = 64 bytes for MSDOS ?) (*)
   224                                  	;xor	cx, cx ; 0
   225                                  	;;;
   226                                  a_0:	
   227 000000D1 FEC4                    	inc	ah
   228                                  a_1:
   229                                  	;;;
   230                                  	; 14/11/2024
   231 000000D3 41                      	inc	cx
   232                                  	;;;
   233 000000D4 AC                      	lodsb
   234 000000D5 AA                      	stosb
   235 000000D6 3C2E                    	cmp	al, '.'
   236 000000D8 74F7                    	je	short a_0
   237                                  	; 29/11/2024
   238 000000DA 3C20                    	cmp	al, 20h
   239                                  	;and	al, al
   240                                  	;jnz	short a_1
   241                                  	;;;
   242                                  	; 14/11/2024
   243 000000DC 7613                    	jna	short a_3
   244 000000DE 20E4                    	and	ah, ah
   245 000000E0 7406                    	jz	short a_2
   246 000000E2 3C5C                    	cmp	al, '\'
   247 000000E4 7502                    	jne	short a_2
   248 000000E6 B400                    	mov	ah, 0
   249                                  a_2:
   250 000000E8 80F94B                  	cmp	cl, 75	; 64+8+'.'+3 -> offset 75 is the last chr
   251 000000EB 72E6                    	jb	short a_1
   252                                  	; 29/11/2024
   253 000000ED 29C9                    	sub	cx, cx
   254 000000EF EB12                    	jmp	short a_4
   255                                  a_3:
   256                                  	; 29/11/2024
   257 000000F1 4F                      	dec	di
   258                                  	;;;
   259 000000F2 08E4                    	or	ah, ah		; if period NOT found,
   260 000000F4 750D                    	jnz	short a_4 	; then add a .WAV extension.
   261                                  SetExt:
   262                                  	; 29/11/2024
   263                                  	;dec	di
   264 000000F6 66C7052E574156          	mov	dword [di], '.WAV' ; ! 64+12 is DOS limit
   265                                  				   ;   but writing +4 must not
   266                                  				   ;   destroy the following data	 
   267                                  	;mov	byte [di+4], 0	   ; so, 80 bytes path + 0 is possible here
   268                                  	; 29/11/2024
   269 000000FD 83C104                  	add	cx, 4
   270 00000100 83C704                  	add	di, 4
   271                                  a_4:	
   272 00000103 C60500                  	mov	byte [di], 0
   273 00000106 4E                      	dec	si
   274 00000107 8936[102A]              	mov	[PSP_CurrentOffset], si
   275 0000010B C3                      	retn
   276                                  
   277                                  ; -------------------------------------------------------------
   278                                  
   279                                  getwavparms:
   280                                  	; 14/11/2024
   281 0000010C E89604                         	call    getWAVParameters
   282 0000010F 72A8                    	jc	short _exit_		; nothing to do
   283                                  
   284                                  	; 17/11/2024
   285 00000111 B304                    	mov	bl, 4
   286 00000113 2A1E[002A]              	sub	bl, byte [WAVE_BlockAlign]
   287                                  			; = 0 for 16 bit stereo
   288                                  			; = 2 for 8 bit stereo or 16 bit mono
   289                                  			; = 3 for 8 bit mono	
   290                                  
   291 00000117 D0EB                    	shr	bl, 1	;  0 -->  0,  2 -->  1,  3 -->  1
   292                                  	; 15/11/2024
   293 00000119 80D300                  	adc	bl, 0	; 3 --> 1 --> 2
   294 0000011C 881E[642A]              	mov	byte [fbs_shift], bl	; = 2 mono and 8 bit
   295                                  					; = 0 stereo and 16 bit
   296                                  					; = 1 mono or 8 bit
   297                                  	; 29/12/2024
   298                                  	; 30/05/2024
   299 00000120 E8E205                  	call	codecConfig		; unmute codec, set rates.
   300 00000123 0F825B02                	jc	init_err
   301                                  
   302                                  ; -------------------------------------------------------------
   303                                  
   304                                  	; 01/01/2025
   305                                  StartPlay:
   306                                  	; 30/12/2024
   307 00000127 C606[D729]01            	mov	byte [wpoints], 1
   308                                  
   309                                  	; 01/01/2025 (RetroDOS, 16bit)
   310                                  	; 09/12/2024 (TRDOS386, 32bit)
   311 0000012C B83429                  	mov	ax, 10548 ; (48000*10/182)*4
   312 0000012F 803E[DC29]00            	cmp	byte [VRA], 0
   313 00000134 760F                    	jna	short _w ; 48kHZ (interpolation)
   314                                  	;
   315 00000136 A1[F829]                	mov	ax, [WAVE_SampleRate]
   316 00000139 B90A00                  	mov	cx, 10
   317 0000013C F7E1                    	mul	cx
   318 0000013E B1B6                    	mov	cl, 182
   319 00000140 F7F1                    	div	cx
   320                                  	; ax = samples per 1/18.2 second
   321                                  	;mov	cl, byte [WAVE_BlockAlign]
   322                                  	; 09/12/2024 
   323                                  	;mov	cl, 4 ; 16 bit, stereo
   324                                  	;mul	cx
   325 00000142 C1E002                  	shl	ax, 2 ; * 4
   326                                  _w:
   327 00000145 A3[5027]                	mov	[wpoints_dif], ax ; buffer read differential (distance)
   328                                  				; for wave volume leds update
   329                                  				; (byte stream per 1/18.2 second)
   330                                  
   331                                  ; -------------------------------------------------------------
   332                                  
   333                                  	; 25/12/2024
   334 00000148 FE06[DE29]              	inc	byte [filecount]
   335 0000014C C606[DD29]00            	mov	byte [command], 0
   336                                  	; 30/12/2024
   337 00000151 C606[5327]FF            	mov	byte [pbprev], -1
   338                                  
   339                                  ; -------------------------------------------------------------
   340                                  
   341                                  	; 01/01/2025 (cgaplay.asm)
   342                                  	; 28/11/2024 (ac97play.asm)
   343                                  	; 25/11/2023
   344                                  	; 18/11/2023 (ich_wav4.asm)
   345                                  	; 13/11/2023 (ich_wav3.asm)
   346                                  
   347 00000156 803E[DC29]01            	cmp	byte [VRA], 1
   348 0000015B 721A                    	jb	short chk_sample_rate
   349                                  
   350                                  playwav_48_khz:
   351 0000015D C706[782A][7E09]        	mov	word [loadfromwavfile], loadFromFile
   352                                  	;mov	word [loadsize], 0 ; 65536
   353                                  	;;;
   354                                  	; 17/11/2024
   355                                  	;mov	word [buffersize], 32768
   356 00000163 B8F87F                  	mov	ax, BUFFERSIZE/2 ; 32760
   357 00000166 A3[7C2A]                	mov	[buffersize], ax	; 16 bit samples
   358 00000169 D1E0                    	shl	ax, 1			; bytes
   359 0000016B 8A0E[642A]              	mov	cl, [fbs_shift]
   360 0000016F D3E8                    	shr	ax, cl
   361 00000171 A3[7A2A]                	mov	[loadsize], ax ; 16380 or 32760 or 65520
   362                                  	;;;
   363                                  	;jmp	PlayNow ; 30/05/2024
   364                                  	; 01/01/2025
   365 00000174 E9A401                  	jmp	Player_Template
   366                                  
   367                                  chk_sample_rate:
   368                                  	; set conversion parameters
   369                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   370 00000177 A1[F829]                	mov	ax, [WAVE_SampleRate]
   371 0000017A 3D80BB                  	cmp	ax, 48000
   372 0000017D 74DE                    	je	short playwav_48_khz
   373                                  chk_22khz:
   374 0000017F 3D2256                  	cmp	ax, 22050
   375 00000182 752F                    	jne	short chk_11khz
   376 00000184 803E[022A]08            	cmp	byte [WAVE_BitsPerSample], 8
   377 00000189 760F                    	jna	short chk_22khz_1
   378 0000018B BB[1415]                	mov	bx, load_22khz_stereo_16_bit
   379 0000018E 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   380 00000193 7512                    	jne	short chk_22khz_2
   381 00000195 BB[A814]                	mov	bx, load_22khz_mono_16_bit
   382 00000198 EB0D                    	jmp	short chk_22khz_2
   383                                  chk_22khz_1:
   384 0000019A BB[4014]                	mov	bx, load_22khz_stereo_8_bit
   385 0000019D 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   386 000001A2 7503                    	jne	short chk_22khz_2
   387 000001A4 BB[D413]                	mov	bx, load_22khz_mono_8_bit
   388                                  chk_22khz_2:
   389 000001A7 B85A1D                  	mov	ax, 7514  ; (442*17)
   390 000001AA BA2500                  	mov	dx, 37
   391 000001AD B91100                  	mov	cx, 17
   392 000001B0 E94301                  	jmp	set_sizes
   393                                  chk_11khz:
   394 000001B3 3D112B                  	cmp	ax, 11025
   395 000001B6 752F                    	jne	short chk_44khz
   396 000001B8 803E[022A]08            	cmp	byte [WAVE_BitsPerSample], 8
   397 000001BD 760F                    	jna	short chk_11khz_1
   398 000001BF BB[B416]                	mov	bx, load_11khz_stereo_16_bit
   399 000001C2 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   400 000001C7 7512                    	jne	short chk_11khz_2
   401 000001C9 BB[5616]                	mov	bx, load_11khz_mono_16_bit
   402 000001CC EB0D                    	jmp	short chk_11khz_2
   403                                  chk_11khz_1:
   404 000001CE BB[F815]                	mov	bx, load_11khz_stereo_8_bit
   405 000001D1 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   406 000001D6 7503                    	jne	short chk_11khz_2
   407 000001D8 BB[9715]                	mov	bx, load_11khz_mono_8_bit
   408                                  chk_11khz_2:
   409 000001DB B8AD0E                  	mov	ax, 3757  ; (221*17)
   410 000001DE BA4A00                  	mov	dx, 74
   411 000001E1 B91100                  	mov	cx, 17
   412 000001E4 E90F01                  	jmp	set_sizes
   413                                  chk_44khz:
   414 000001E7 3D44AC                  	cmp	ax, 44100
   415 000001EA 752F                    	jne	short chk_16khz
   416 000001EC 803E[022A]08            	cmp	byte [WAVE_BitsPerSample], 8
   417 000001F1 760F                    	jna	short chk_44khz_1
   418 000001F3 BB[7118]                	mov	bx, load_44khz_stereo_16_bit
   419 000001F6 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   420 000001FB 7512                    	jne	short chk_44khz_2
   421 000001FD BB[1618]                	mov	bx, load_44khz_mono_16_bit
   422 00000200 EB0D                    	jmp	short chk_44khz_2
   423                                  chk_44khz_1:
   424 00000202 BB[B517]                	mov	bx, load_44khz_stereo_8_bit
   425 00000205 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   426 0000020A 7503                    	jne	short chk_44khz_2
   427 0000020C BB[5517]                	mov	bx, load_44khz_mono_8_bit
   428                                  chk_44khz_2:
   429                                  	;mov	ax, 15065 ; (655*23)
   430                                  	; 18/11/2023 ((file size + bss + stack) <= 64KB)
   431                                  	;mov	ax, 14076 ; (612*23)
   432                                  	; 17/11/2024
   433 0000020F B86A31                  	mov	ax, 12650 ; (550*23)
   434 00000212 BA1900                  	mov	dx, 25
   435 00000215 B91700                  	mov	cx, 23
   436 00000218 E9DB00                  	jmp	set_sizes
   437                                  chk_16khz:
   438 0000021B 3D803E                  	cmp	ax, 16000
   439 0000021E 752F                    	jne	short chk_8khz
   440 00000220 803E[022A]08            	cmp	byte [WAVE_BitsPerSample], 8
   441 00000225 760F                    	jna	short chk_16khz_1
   442 00000227 BB[3A10]                	mov	bx, load_16khz_stereo_16_bit
   443 0000022A 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   444 0000022F 7512                    	jne	short chk_16khz_2
   445 00000231 BB[D60F]                	mov	bx, load_16khz_mono_16_bit
   446 00000234 EB0D                    	jmp	short chk_16khz_2
   447                                  chk_16khz_1:
   448 00000236 BB[430F]                	mov	bx, load_16khz_stereo_8_bit
   449 00000239 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   450 0000023E 7503                    	jne	short chk_16khz_2
   451 00000240 BB[DC0E]                	mov	bx, load_16khz_mono_8_bit
   452                                  chk_16khz_2:
   453                                  	;mov	ax, 5461
   454                                  	; 17/11/2024
   455 00000243 B85415                  	mov	ax, 5460
   456 00000246 BA0300                  	mov	dx, 3
   457 00000249 B90100                  	mov	cx, 1
   458 0000024C E9A700                  	jmp	set_sizes
   459                                  chk_8khz:
   460 0000024F 3D401F                  	cmp	ax, 8000
   461 00000252 752E                    	jne	short chk_24khz
   462 00000254 803E[022A]08            	cmp	byte [WAVE_BitsPerSample], 8
   463 00000259 760F                    	jna	short chk_8khz_1
   464 0000025B BB[F20D]                	mov	bx, load_8khz_stereo_16_bit
   465 0000025E 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   466 00000263 7512                    	jne	short chk_8khz_2
   467 00000265 BB[5E0D]                	mov	bx, load_8khz_mono_16_bit
   468 00000268 EB0D                    	jmp	short chk_8khz_2
   469                                  chk_8khz_1:
   470 0000026A BB[6B0C]                	mov	bx, load_8khz_stereo_8_bit
   471 0000026D 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   472 00000272 7503                    	jne	short chk_8khz_2
   473 00000274 BB[B50B]                	mov	bx, load_8khz_mono_8_bit
   474                                  chk_8khz_2:
   475 00000277 B8AA0A                  	mov	ax, 2730
   476 0000027A BA0600                  	mov	dx, 6
   477 0000027D B90100                  	mov	cx, 1
   478 00000280 EB74                    	jmp	short set_sizes
   479                                  chk_24khz:
   480 00000282 3DC05D                  	cmp	ax, 24000
   481 00000285 753E                    	jne	short chk_32khz
   482 00000287 803E[022A]08            	cmp	byte [WAVE_BitsPerSample], 8
   483 0000028C 760F                    	jna	short chk_24khz_1
   484 0000028E BB[DB11]                	mov	bx, load_24khz_stereo_16_bit
   485 00000291 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   486 00000296 7512                    	jne	short chk_24khz_2
   487 00000298 BB[8F11]                	mov	bx, load_24khz_mono_16_bit
   488 0000029B EB0D                    	jmp	short chk_24khz_2
   489                                  chk_24khz_1:
   490 0000029D BB[2411]                	mov	bx, load_24khz_stereo_8_bit
   491 000002A0 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   492 000002A5 7503                    	jne	short chk_24khz_2
   493 000002A7 BB[D210]                	mov	bx, load_24khz_mono_8_bit
   494                                  chk_24khz_2:
   495                                  	;mov	ax, 8192
   496                                  	; 17/11/2024
   497 000002AA B8FE1F                  	mov	ax, 8190
   498 000002AD BA0200                  	mov	dx, 2
   499 000002B0 B90100                  	mov	cx, 1
   500 000002B3 EB41                    	jmp	short set_sizes
   501                                  
   502                                  	; 01/01/2025 (cgaplay.asm)
   503                                  vra_needed:
   504                                  	; 13/11/2023
   505 000002B5 58                      	pop	ax ; discard return address to the caller
   506                                  	; 30/05/2024
   507                                  vra_err:
   508                                  	sys_msg msg_no_vra, 0Fh
    37 000002B6 BE[5F22]            <1>  mov si, %1
    38 000002B9 B30F                <1>  mov bl, %2
    39 000002BB 30FF                <1>  xor bh, bh
    40 000002BD B40E                <1>  mov ah, 0Eh
    41 000002BF E8D600              <1>  call p_msg
   509 000002C2 E9A500                  	jmp	Exit
   510                                  
   511                                  chk_32khz:
   512 000002C5 3D007D                  	cmp	ax, 32000
   513 000002C8 75EB                    	jne	short vra_needed
   514 000002CA 803E[022A]08            	cmp	byte [WAVE_BitsPerSample], 8
   515 000002CF 760F                    	jna	short chk_32khz_1
   516 000002D1 BB[6913]                	mov	bx, load_32khz_stereo_16_bit
   517 000002D4 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   518 000002D9 7512                    	jne	short chk_32khz_2
   519 000002DB BB[1913]                	mov	bx, load_32khz_mono_16_bit
   520 000002DE EB0D                    	jmp	short chk_32khz_2
   521                                  chk_32khz_1:
   522 000002E0 BB[9F12]                	mov	bx, load_32khz_stereo_8_bit
   523 000002E3 803E[F629]01            	cmp	byte [WAVE_NumChannels], 1
   524 000002E8 7503                    	jne	short chk_32khz_2
   525 000002EA BB[4412]                	mov	bx, load_32khz_mono_8_bit
   526                                  chk_32khz_2:
   527                                  	;mov	ax, 10922
   528                                  	; 17/11/2024
   529 000002ED B8A82A                  	mov	ax, 10920
   530 000002F0 BA0300                  	mov	dx, 3
   531 000002F3 B90200                  	mov	cx, 2
   532                                  	;jmp	short set_sizes
   533                                  set_sizes:
   534                                  	;;;
   535                                  	; 17/11/2024
   536 000002F6 51                      	push	cx
   537 000002F7 B102                    	mov	cl, 2
   538 000002F9 2A0E[642A]              	sub	cl, [fbs_shift]
   539                                  		; = 2 for 16 bit stereo
   540                                  		; = 1 for 16 bit mono or 8 bit stereo
   541                                  		; = 0 for 8 bit mono
   542 000002FD D3E0                    	shl	ax, cl
   543 000002FF 59                      	pop	cx
   544 00000300 A3[7A2A]                	mov	[loadsize], ax	; (one) read count in bytes
   545                                  	;;;
   546 00000303 F7E2                    	mul	dx
   547 00000305 83F901                  	cmp	cx, 1
   548 00000308 7402                    	je	short s_2
   549                                  s_1:
   550 0000030A F7F1                    	div	cx
   551                                  s_2:	
   552                                  	;;;
   553                                  	; ax = byte count of (to be) converted samples 
   554                                  	
   555                                  	; 17/11/2024
   556                                  	;;;
   557 0000030C 8A0E[642A]              	mov	cl, [fbs_shift]
   558                                  
   559 00000310 D3E0                    	shl	ax, cl
   560                                  		; *1 for 16 bit stereo
   561                                  		; *2 for 16 bit mono or 8 bit stereo
   562                                  		; *4 for for 8 bit mono
   563                                  	;;;
   564                                  
   565                                  	; ax = 16 bit stereo byte count (target buffer size)
   566                                  	
   567 00000312 D1E8                    	shr	ax, 1	; buffer size is 16 bit sample count
   568 00000314 A3[7C2A]                	mov	[buffersize], ax 
   569 00000317 891E[782A]              	mov	[loadfromwavfile], bx
   570                                  	
   571                                  	; 01/01/2025 (cgaplay.asm)
   572                                  ; -------------------------------------------------------------
   573                                  	; 30/12/2024
   574                                  Player_Template:
   575                                  	; 21/12/2024
   576 0000031B E88400                  	call	clearscreen
   577 0000031E E89200                  	call	drawplayingscreen
   578                                  	; 14/11/2024
   579 00000321 E8C91B                  	call	SetTotalTime
   580 00000324 E8691C                  	call	UpdateFileInfo
   581                                  
   582                                  ; -------------------------------------------------------------
   583                                  
   584                                  	; 30/12/2024 (cgaplay.s)
   585                                  	; 29/12/2024 (vgaplay3.s)
   586                                  	; 18/12/2024 (ac97play.s)
   587                                  PlayNow:
   588                                  	; 01/12/2024 (32bit)
   589                                  	; 14/11/2024
   590                                  	;mov	al, 3	; 0 = max, 31 = min
   591                                  	; 14/12/2024
   592 00000327 A0[E51E]                	mov	al, [volume]
   593 0000032A E81302                  	call	SetPCMOutVolume@
   594                                  	; 15/11/2024
   595                                  	;;call	SetMasterVolume
   596                                  	;call	SetPCMOutVolume
   597                                  
   598                                  	;;;
   599                                  	; 14/11/2024
   600 0000032D E8E81C                  	call	UpdateProgressBar
   601                                  	;;;
   602                                  
   603                                   	; 30/05/2024
   604                                  	; playwav4.asm
   605                                  _2:	
   606 00000330 E85A1B                  	call	check4keyboardstop	; flush keyboard buffer
   607 00000333 72FB                    	jc	short _2		; 07/11/2023
   608                                  
   609                                  	; 01/01/2025 (cgaplay.asm)
   610                                  
   611                                  ; play the .wav file. Most of the good stuff is in here.
   612                                  
   613 00000335 E8A300                  	call    PlayWav
   614                                  
   615                                  	; 30/12/2024
   616                                  	; 29/12/2024 (vgaplay3.s)
   617                                  	; 27/12/2024 (vgaplay.s)
   618                                  _3:
   619                                  
   620                                  ; close the .wav file and exit.
   621                                  
   622                                  	; 25/12/2024
   623 00000338 E85902                  	call	closeFile
   624                                  
   625                                  	; 01/01/2025 (16bit modifications)
   626                                  	; 25/12/2024
   627                                  	;;;
   628                                  	; reset file loading and EOF parameters
   629                                  	; 18/12/2024
   630 0000033B C706[842A]0000          	mov	word [count], 0
   631                                  	;mov	dword [LoadedDataBytes], 0
   632 00000341 C706[862A]0000          	mov	word [LoadedDataBytes], 0
   633 00000347 C706[882A]0000          	mov	word [LoadedDataBytes+2], 0
   634 0000034D C606[0C2A]00            	mov	byte [flags], 0
   635 00000352 C606[D429]00            	mov	byte [stopped], 0
   636                                  	; 29/12/2024
   637 00000357 C706[DA29]0000          	mov	word [pbuf_s], 0
   638                                  	;;;
   639                                  
   640 0000035D 803E[DD29]51            	cmp	byte [command], 'Q'
   641 00000362 7403                    	je	short terminate
   642 00000364 E9F8FC                  	jmp	check_p_command
   643                                  
   644                                  terminate:
   645 00000367 E85A00                  	call	set_text_mode
   646                                  	
   647                                  Exit:	; 01/01/2025
   648 0000036A B8004C                  	mov	ax, 4C00h	; bye !
   649 0000036D CD21                    	int	21h
   650                                  halt:
   651 0000036F EBFE                    	jmp	short halt
   652                                  
   653                                  ; -------------------------------------------------------------
   654                                  
   655                                  	; 30/05/2024
   656                                  pmsg_usage:
   657                                  	; 21/12/2024
   658 00000371 E85000                  	call	set_text_mode
   659                                  	; 01/01/2025
   660                                  	; 01/12/2024
   661                                  	sys_msg msg_usage, 0Fh
    37 00000374 BE[BB21]            <1>  mov si, %1
    38 00000377 B30F                <1>  mov bl, %2
    39 00000379 30FF                <1>  xor bh, bh
    40 0000037B B40E                <1>  mov ah, 0Eh
    41 0000037D E81800              <1>  call p_msg
   662 00000380 EBE8                    	jmp	short Exit
   663                                  
   664                                  ; -------------------------------------------------------------
   665                                  
   666                                  	; 30/05/2024
   667                                  init_err:
   668                                  	; 21/12/2024
   669 00000382 E83F00                  	call	set_text_mode
   670                                  	; 01/01/2025
   671                                  	; 01/12/2024
   672                                  	sys_msg msg_init_err, 0Fh
    37 00000385 BE[2E22]            <1>  mov si, %1
    38 00000388 B30F                <1>  mov bl, %2
    39 0000038A 30FF                <1>  xor bh, bh
    40 0000038C B40E                <1>  mov ah, 0Eh
    41 0000038E E80700              <1>  call p_msg
   673 00000391 EBD7                    	jmp	short Exit
   674                                  
   675                                  ; -------------------------------------------------------------
   676                                  
   677                                  	; 01/01/2025 (cgaplay.asm)
   678                                  	; 21/12/2024
   679                                  	; 14/11/2024
   680                                  PrintString:
   681 00000393 B40E                    	mov	ah, 0Eh
   682 00000395 BB0F00                  	mov	bx, 0Fh ; char attribute & color (white)
   683                                  p_msg:
   684                                  	; ah = 0Eh
   685                                  	; bh = 0
   686                                  	; bl = color
   687                                  	; ds:si = msg address
   688                                  p_next_chr:
   689 00000398 AC                      	lodsb
   690 00000399 08C0                    	or	al, al
   691 0000039B 7404                    	jz	short p_retn ; retn
   692 0000039D CD10                    	int	10h
   693 0000039F EBF7                    	jmp	short p_next_chr
   694                                  p_retn:
   695 000003A1 C3                      	retn
   696                                  
   697                                  ; -------------------------------------------------------------
   698                                  
   699                                  	; 01/01/2025 (cgaplay.asm)
   700                                  clearscreen:
   701                                  	; fast clear
   702                                  	; 320*200, 256 colors
   703 000003A2 06                      	push	es
   704 000003A3 BF00A0                  	mov	di, 0A000h
   705 000003A6 8EC7                    	mov	es, di
   706 000003A8 31FF                    	xor	di, di
   707 000003AA B9007D                  	mov	cx, 320*200*1/2
   708 000003AD 31C0                    	xor	ax, ax
   709 000003AF F3AB                    	rep	stosw
   710 000003B1 07                      	pop	es
   711 000003B2 C3                      	retn
   712                                  
   713                                  ; -------------------------------------------------------------
   714                                  
   715                                  	; 01/01/2025v (cgaplay.asm)
   716                                  drawplayingscreen:
   717                                  	;push	es
   718                                  	;push	bp
   719                                  	;push	ds
   720                                  	;pop	es
   721                                  	; es = ds
   722 000003B3 BD[8823]                	mov	bp, PlayingScreen
   723 000003B6 B80013                  	mov	ax, 1300h ; write character string
   724 000003B9 BB0F00                  	mov	bx, 0Fh
   725 000003BC B9C003                  	mov	cx, 24*40
   726 000003BF 31D2                    	xor	dx, dx ; row 0, columns 0
   727 000003C1 CD10                    	int	10h
   728                                  	;pop	bp
   729                                  	;pop	es
   730 000003C3 C3                      	retn
   731                                  
   732                                  ; -------------------------------------------------------------
   733                                  
   734                                  	; 01/01/2025
   735                                  set_text_mode:
   736 000003C4 B80300                  	mov	ax, 03h
   737 000003C7 CD10                    	int	10h
   738                                  	;retn
   739                                  
   740                                  	sys_msg Credits, 0Bh
    37 000003C9 BE[4821]            <1>  mov si, %1
    38 000003CC B30B                <1>  mov bl, %2
    39 000003CE 30FF                <1>  xor bh, bh
    40 000003D0 B40E                <1>  mov ah, 0Eh
    41 000003D2 E8C3FF              <1>  call p_msg
   741                                  	;call	write_audio_dev_info
   742                                  	;retn
   743 000003D5 E94406                  	jmp	write_audio_dev_info
   744                                  
   745                                  ; -------------------------------------------------------------
   746                                  
   747                                  	; 01/01/2025 (16bit pop)
   748                                  	; 02/12/2024
   749                                  Player_Quit@:
   750 000003D8 58                      	pop	ax ; return addr (call PlayWav@)
   751                                  	
   752                                  	; 29/11/2024
   753                                  Player_Quit:
   754 000003D9 EB8C                    	jmp	 terminate
   755                                  
   756                                  ; -------------------------------------------------------------
   757                                  
   758                                  	; 01/01/2025 (cgaplay.asm)
   759                                  	; 18/12/2024 (ac97play.asm)
   760                                  	; 30/12/2024 (cgaplay.s)
   761                                  	; 29/12/2024 (vgaplay3.s)
   762                                  	; 02/12/2024 (ac97play.s)
   763                                  PlayWav:
   764                                  	; 29/05/2024 (TRDOS 386, playwav7.s)
   765                                  	; ((Modified from playwav4.asm, ich_wav4.asm))
   766                                  	; ------------------
   767                                  
   768                                  	; create Buffer Descriptor List
   769                                  
   770                                  	;  Generic Form of Buffer Descriptor
   771                                  	;  ---------------------------------
   772                                  	;  63   62    61-48    47-32   31-0
   773                                  	;  ---  ---  --------  ------- -----
   774                                  	;  IOC  BUP -reserved- Buffer  Buffer
   775                                  	;		      Length   Pointer
   776                                  	;		      [15:0]   [31:0]
   777                                  
   778 000003DB 06                              push    es
   779 000003DC A1[722A]                        mov     ax, [BDL_BUFFER]		; get segment # for BDL
   780 000003DF 8EC0                            mov     es, ax
   781                                  
   782 000003E1 B91000                          mov     cx, 32 / 2                      ; make 32 entries in BDL
   783 000003E4 31FF                            xor     di, di
   784                                  _pw0:
   785 000003E6 660FB706[742A]                  movzx   eax, word [WAV_BUFFER1]
   786 000003EC 66C1E004                        shl     eax, 4                          ; convert seg:off ->0:offset
   787 000003F0 66AB                            stosd		       ; store pointer to wavbuffer1
   788                                  
   789                                  	;mov	eax, BUFFERSIZE / 2 ; size of buffer (32K) in (16bit) words
   790                                  	; 13/11/2023 (ich_wav3.asm) - 18/11/2023 (ich_wav4.asm)
   791 000003F2 66A1[7C2A]              	mov	eax, [buffersize]
   792                                  
   793                                  	;or	eax, IOC + BUP
   794                                  	; 06/11/2023 (TUNELOOP version, without interrupt)
   795 000003F6 660D00000040            	or	eax, BUP
   796 000003FC 66AB                    	stosd
   797                                  
   798 000003FE 660FB706[762A]                  movzx   eax, word [WAV_BUFFER2]
   799 00000404 66C1E004                        shl     eax, 4                          ; convert seg:off ->0:offset
   800 00000408 66AB                            stosd		       ; store pointer to wavbuffer2
   801                                  
   802                                  	;mov	eax, BUFFERSIZE / 2 ; size of half buffer (32K)
   803                                  	; 13/11/2023 (ich_wav3.asm) - 18/11/2023 (ich_wav4.asm)
   804 0000040A 66A1[7C2A]              	mov	eax, [buffersize]
   805                                  
   806                                  	;or	eax, IOC + BUP
   807                                  	; 06/11/2023 (TUNELOOP version, without interrupt)
   808 0000040E 660D00000040            	or	eax, BUP
   809 00000414 66AB                    	stosd
   810                                  
   811 00000416 E2CE                            loop    _pw0
   812 00000418 07                              pop     es
   813                                  
   814                                  	; 18/12/2024
   815                                  	;mov	word [count], cx ; 0
   816                                  	; 14/11/2024
   817                                  	;mov	dword [LoadedDataBytes], 0
   818                                  
   819                                  	; 19/11/2024
   820                                  RePlayWav:
   821                                  	; load 64k into buffer 1
   822 00000419 A1[742A]                        mov     ax, [WAV_BUFFER1]
   823                                          ;call	loadFromFile
   824                                  	; 13/11/2023
   825 0000041C FF16[782A]              	call	word [loadfromwavfile]
   826                                  	; 14/11/2024
   827 00000420 A1[842A]                	mov	ax, [count]
   828 00000423 0106[862A]              	add	[LoadedDataBytes], ax
   829 00000427 8316[882A]00            	adc	word [LoadedDataBytes+2], 0
   830                                  
   831                                  	; and 64k into buffer 2
   832 0000042C A1[762A]                	mov     ax, [WAV_BUFFER2]
   833                                         	;call	loadFromFile
   834                                  	; 13/11/2023
   835 0000042F FF16[782A]              	call	word [loadfromwavfile]
   836                                  	; 14/11/2024
   837 00000433 A1[842A]                	mov	ax, [count]
   838 00000436 0106[862A]              	add	[LoadedDataBytes], ax
   839 0000043A 8316[882A]00            	adc	word [LoadedDataBytes+2], 0
   840                                  
   841                                  	; write NABMBAR+10h with offset of buffer descriptor list
   842                                  
   843 0000043F 660FB706[722A]                  movzx   eax, word [BDL_BUFFER]
   844 00000445 66C1E004                	shl     eax, 4                          ; convert seg:off to 0:off
   845 00000449 8B16[702A]                      mov     dx, [NABMBAR]
   846 0000044D 83C210                          add     dx, PO_BDBAR_REG                ; set pointer to BDL
   847 00000450 66EF                            out     dx, eax                         ; write to AC97 controller
   848                                  
   849                                  	; 19/05/2024
   850 00000452 E8CB04                  	call	delay1_4ms
   851                                  
   852 00000455 B01F                            mov	al, 31
   853 00000457 E81B05                  	call	setLastValidIndex
   854                                  
   855                                  	; 19/05/2024
   856                                  	;call	delay1_4ms
   857                                  
   858                                  	; 17/02/2017
   859 0000045A 8B16[702A]                      mov	dx, [NABMBAR]
   860 0000045E 83C21B                          add	dx, PO_CR_REG		; PCM out Control Register
   861                                          ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   862                                  	;			; (LVBI interrupt will not be enabled)
   863                                  	; 06/11/2023 (TUNELOOP version, without interrupt)
   864 00000461 B001                    	mov	al, RPBM
   865 00000463 EE                      	out	dx, al			; Start bus master operation.
   866                                  
   867                                  	; 19/05/2024
   868                                  	; 06/11/2023
   869 00000464 E8B904                  	call	delay1_4ms	; 30/05/2024
   870                                  	;call	delay1_4ms
   871                                  	;call	delay1_4ms
   872                                  	;call	delay1_4ms
   873                                  
   874                                  	; 30/12/2024
   875                                  
   876                                  ; -------------------------------------------
   877                                  
   878                                  	; 01/01/2025 (cgaplay.asm)
   879                                  	; 18/12/2024 (ac97play.asm)
   880                                  	; 30/12/2024 (cgaplay.s)
   881                                  	; 29/12/2024 (vgaplay3.s)
   882                                  	; 18/12/2024 (ac97play.s)
   883                                  	; 01/12/2024 (32bit)
   884                                  	; 29/11/2024
   885                                  tuneLoop:
   886                                  	; 30/05/2024
   887                                  	; 18/11/2023 (ich_wav4.asm)
   888                                  	; 08/11/2023
   889                                  	; 06/11/2023
   890                                  tLWait:
   891                                  	; 18/11/2024
   892 00000467 803E[D429]00            	cmp	byte [stopped], 0
   893                                  	;jna	short tL@
   894                                  	; 21/11/2024
   895 0000046C 7710                    	ja	short tLWait@
   896 0000046E A0[D629]                	mov	al, [tLP]
   897 00000471 3C31                    	cmp	al, '1'
   898 00000473 743C                    	je	short tL1@
   899 00000475 7772                    	ja	short tL2@
   900 00000477 B031                    	mov	al, '1'
   901 00000479 A2[D629]                	mov	[tLP], al
   902 0000047C EB33                    	jmp	short tL1@ 
   903                                  tLWait@:	; 21/11/2024
   904                                  	;;;
   905                                  	; 09/12/2024
   906 0000047E 803E[D429]03            	cmp	byte [stopped], 3
   907 00000483 0F839F00                	jnb	_exitt_
   908                                  	;;;
   909 00000487 E88218                  	call	checkUpdateEvents
   910 0000048A 0F829800                	jc	_exitt_
   911                                  	;;;
   912                                  	; 29/11/2024
   913 0000048E 803E[DD29]4E            	cmp	byte [command], 'N'
   914 00000493 0F848F00                	je	_exitt_
   915 00000497 803E[DD29]50            	cmp	byte [command], 'P'
   916 0000049C 0F848600                	je	_exitt_
   917                                  	;;;
   918 000004A0 803E[D529]30            	cmp	byte [tLO], '0'
   919 000004A5 74C0                    	je	short tLWait
   920 000004A7 E88200                  	call	tLZ
   921 000004AA C606[D529]30            	mov	byte [tLO], '0'
   922 000004AF EBB6                    	jmp	short tLWait
   923                                  
   924                                  ;tLO:	db 0
   925                                  	
   926                                  tL1@:
   927                                  	;mov	al, '1'
   928                                  	; 19/11/2024
   929 000004B1 A2[D529]                	mov	[tLO], al
   930 000004B4 E87700                  	call	tL0
   931                                  tL1:
   932 000004B7 E89004                  	call	updateLVI	; /set LVI != CIV/
   933 000004BA 746A                    	jz	_exitt_		; 08/11/2023
   934                                  	;;;
   935                                  	;call	check4keyboardstop
   936                                  	; 14/11/2024
   937 000004BC E84D18                  	call	checkUpdateEvents
   938 000004BF 7265                    	jc	_exitt_
   939                                  	; 18/11/2024
   940 000004C1 803E[D429]00            	cmp	byte [stopped], 0
   941 000004C6 77B6                    	ja	short tLWait@	; 21/11/2024
   942                                  	;;;
   943 000004C8 E87604                  	call	getCurrentIndex
   944 000004CB A801                    	test	al, BIT0
   945 000004CD 74E8                    	jz	short tL1	; loop if buffer 2 is not playing
   946                                  
   947                                  	; load buffer 1
   948 000004CF A1[742A]                	mov     ax, [WAV_BUFFER1]
   949                                  	;call	loadFromFile
   950                                  	; 18/11/2023
   951 000004D2 FF16[782A]              	call	word [loadfromwavfile]
   952 000004D6 724E                    	jc	short _exitt_	; end of file
   953                                  
   954                                  	; 14/11/2024
   955 000004D8 A1[842A]                	mov	ax, [count]
   956 000004DB 0106[862A]              	add	[LoadedDataBytes], ax
   957 000004DF 8316[882A]00            	adc	word [LoadedDataBytes+2], 0
   958                                  
   959 000004E4 B032                    	mov	al, '2'
   960                                  	; 21/11/2024
   961 000004E6 A2[D629]                	mov	[tLP], al
   962                                  tL2@:
   963                                  	; 19/11/2024
   964 000004E9 A2[D529]                	mov	[tLO], al
   965 000004EC E83F00                  	call	tL0
   966                                  tL2:
   967 000004EF E85804                  	call    updateLVI
   968 000004F2 7432                    	jz	short _exitt_	; 08/11/2023
   969                                  	;;;
   970                                  	;call	check4keyboardstop
   971                                  	; 14/11/2024
   972 000004F4 E81518                  	call	checkUpdateEvents
   973 000004F7 722D                    	jc	short _exitt_
   974                                  	; 18/11/2024
   975 000004F9 803E[D429]00            	cmp	byte [stopped], 0
   976 000004FE 0F877CFF                	ja	tLWait@		; 21/11/2024 
   977                                  	;;;
   978 00000502 E83C04                  	call    getCurrentIndex
   979 00000505 A801                    	test	al, BIT0
   980 00000507 75E6                    	jnz	short tL2	; loop if buffer 1 is not playing
   981                                  
   982                                  	; load buffer 2
   983 00000509 A1[762A]                	mov     ax, [WAV_BUFFER2]
   984                                  	;call	loadFromFile
   985                                  	; 18/11/2023
   986 0000050C FF16[782A]              	call	word [loadfromwavfile]
   987                                  	;jnc	short tuneLoop
   988 00000510 7214                    	jc	short _exitt_
   989                                  
   990                                  	; 14/11/2024
   991 00000512 A1[842A]                	mov	ax, [count]
   992 00000515 0106[862A]              	add	[LoadedDataBytes], ax
   993 00000519 8316[882A]00            	adc	word [LoadedDataBytes+2], 0
   994                                  
   995                                  	; 21/11/2024
   996 0000051E C606[D629]31            	mov	byte [tLP], '1'
   997 00000523 E941FF                  	jmp	tuneLoop
   998                                  
   999                                  	; 29/12/2024 (vgaplay3.s)
  1000                                  _exitt_:
  1001                                  	; 07/12/2024
  1002                                  	; Stop Playing
  1003 00000526 E8CC03                  	call	ac97_stop
  1004                                  
  1005                                  	;;;
  1006                                  	; 14/11/2024
  1007 00000529 E8EC1A                  	call	UpdateProgressBar
  1008                                  	;;;
  1009                                  
  1010                                  	; 18/11/2024
  1011                                  tLZ:
  1012                                  	; 30/05/2024
  1013 0000052C B030                    	mov	al, '0'
  1014                                  tL0:
  1015                                  	; 01/01/2025 (cgaplay.asm)
  1016                                  	; 31/12/2024
  1017 0000052E 50                      	push	ax
  1018 0000052F 31D2                    	xor	dx, dx ; row 0, column 0
  1019 00000531 E8B219                  	call	setCursorPosition
  1020 00000534 58                      	pop	ax
  1021                                  	;
  1022 00000535 B40E                    	mov	ah, 0Eh
  1023 00000537 BB0E00                  	mov	bx, 0Eh
  1024 0000053A CD10                    	int	10h
  1025                                  	
  1026 0000053C C3                      	retn
  1027                                  
  1028                                  ; -------------------------------------------
  1029                                  
  1030                                  	; 14/11/2024
  1031                                  ;SetMasterVolume:
  1032                                  	; 15/11/2024
  1033                                  SetPCMOutVolume:
  1034                                  	;cmp	al, 31
  1035                                  	;ja	short setvolume_ok
  1036 0000053D A2[E51E]                	mov	[volume], al  ; max = 0, min = 31
  1037                                  SetPCMOutVolume@:	; 19/11/2024
  1038 00000540 88C4                    	mov	ah, al
  1039 00000542 8B16[6E2A]              	mov	dx, [NAMBAR]
  1040                                  	; 15/11/2024 (QEMU)
  1041                                    	;add	dx, CODEC_MASTER_VOL_REG
  1042 00000546 83C218                  	add	dx, CODEC_PCM_OUT_REG
  1043 00000549 EF                      	out	dx, ax
  1044                                  ;setvolume_ok:
  1045 0000054A C3                      	retn
  1046                                  
  1047                                  ; -------------------------------------------
  1048                                  
  1049                                  	; 30/05/2024
  1050                                  DetectAC97:
  1051                                  DetectICH:
  1052                                  	; 22/11/2023
  1053                                  	; 19/11/2023
  1054                                  	; 01/11/2023 - TRDOS 386 Kernel v2.0.7
  1055                                  	;; 10/06/2017
  1056                                  	;; 05/06/2017
  1057                                  	;; 29/05/2017
  1058                                  	;; 28/05/2017
  1059                                  
  1060                                  	; 19/11/2023
  1061 0000054B BE[F020]                	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
  1062 0000054E B91500                  	mov	cx, valid_id_count
  1063                                  pfd_1:
  1064 00000551 66AD                    	lodsd
  1065 00000553 E88900                  	call	pciFindDevice
  1066 00000556 7303                    	jnc	short d_ac97_1
  1067 00000558 E2F7                    	loop	pfd_1
  1068                                  
  1069                                  	;stc
  1070 0000055A C3                      	retn
  1071                                  
  1072                                  d_ac97_1:
  1073                                  	; eax = BUS/DEV/FN
  1074                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1075                                  	; edx = DEV/VENDOR
  1076                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1077                                  
  1078                                  	; playwav4.asm - 19/05/2024
  1079                                  
  1080 0000055B 66A3[662A]              	mov	[bus_dev_fn], eax
  1081 0000055F 668916[6A2A]            	mov	[dev_vendor], edx
  1082                                  
  1083                                  	; get ICH base address regs for mixer and bus master
  1084                                  
  1085 00000564 B010                            mov     al, NAMBAR_REG
  1086 00000566 E80401                          call    pciRegRead16			; read PCI registers 10-11
  1087                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
  1088                                  	; 19/05/2024
  1089 00000569 80E2FE                  	and	dl, 0FEh
  1090                                  
  1091 0000056C 8916[6E2A]                      mov     [NAMBAR], dx			; save audio mixer base addr
  1092                                  
  1093 00000570 B014                    	mov     al, NABMBAR_REG
  1094 00000572 E8F800                          call    pciRegRead16
  1095                                          ;and    dx, IO_ADDR_MASK
  1096                                  	; 19/05/2024
  1097 00000575 80E2C0                  	and	dl, 0C0h
  1098                                  
  1099 00000578 8916[702A]                      mov     [NABMBAR], dx			; save bus master base addr
  1100                                  
  1101 0000057C B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
  1102 0000057E E8E400                  	call	pciRegRead8 ; 17/02/2017
  1103                                  
  1104 00000581 8816[0D2A]              	mov	[ac97_int_ln_reg], dl
  1105                                  
  1106                                  	;clc
  1107                                  
  1108 00000585 C3                      	retn
  1109                                  
  1110                                  ; ----------------------------------
  1111                                  
  1112                                  	; 14/11/2024
  1113                                  	; INPUT: ds:dx = file name address
  1114                                  	; OUTPUT: [filehandle] = ; -1 = not open
  1115                                  openFile:
  1116 00000586 B8003D                  	mov	ax, 3D00h	; open File for read
  1117 00000589 CD21                    	int	21h
  1118 0000058B 7303                    	jnc	short _of1
  1119 0000058D B8FFFF                  	mov	ax, -1
  1120                                  	; cf = 1 -> not found or access error
  1121                                  _of1:
  1122 00000590 A3[0E2A]                	mov	[filehandle], ax
  1123 00000593 C3                      	retn
  1124                                  
  1125                                  ; ----------------------------------
  1126                                  
  1127                                  ; close the currently open file
  1128                                  
  1129                                  	; 14/11/2024
  1130                                  	; INPUT: [filehandle] ; -1 = not open
  1131                                  	; OUTPUT: none
  1132                                  closeFile:
  1133 00000594 833E[0E2A]FF            	cmp	word [filehandle], -1
  1134 00000599 7409                    	jz	short _cf1
  1135 0000059B 8B1E[0E2A]              	mov     bx, [filehandle]
  1136 0000059F B8003E                  	mov     ax, 3E00h
  1137 000005A2 CD21                            int     21h              ; close file
  1138                                  _cf1:
  1139 000005A4 C3                      	retn
  1140                                  
  1141                                  ; ----------------------------------
  1142                                  
  1143                                  	; 14/11/2024 - Erdogan Tan
  1144                                  getWAVParameters:
  1145                                  ; reads WAV file header(s) (44 bytes) from the .wav file.
  1146                                  ; entry: none - assumes file is already open
  1147                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
  1148                                  ;	cx = number of channels (mono=1, stereo=2)
  1149                                  ;	dx = bits per sample (8, 16)
  1150                                  ;	bx = number of bytes per sample (1 to 4)
  1151                                  
  1152 000005A5 BA[E029]                        mov     dx, WAVFILEHEADERbuff
  1153 000005A8 8B1E[0E2A]              	mov	bx, [filehandle]
  1154 000005AC B92C00                          mov     cx, 44			; 44 bytes
  1155 000005AF B43F                    	mov	ah, 3Fh
  1156 000005B1 CD21                            int     21h
  1157 000005B3 7218                    	jc	short gwavp_retn
  1158                                  
  1159 000005B5 83F82C                  	cmp	ax, 44
  1160 000005B8 7213                    	jb	short gwavp_retn
  1161                                  
  1162 000005BA 66813E[E829]574156-     	cmp	dword [RIFF_Format], 'WAVE'
  1162 000005C2 45                 
  1163 000005C3 7507                    	jne	short gwavp_stc_retn
  1164                                  
  1165 000005C5 833E[F429]01            	cmp	word [WAVE_AudioFormat], 1 ; Offset 20, must be 1 (= PCM)
  1166                                  	;jne	short gwavp_stc_retn
  1167 000005CA 7401                    	je	short gwavp_retn ; 15/11/2024
  1168                                  
  1169                                  	; 15/11/2024
  1170                                  	;mov	cx, [WAVE_NumChannels]	; return num of channels in CX
  1171                                          ;mov    ax, [WAVE_SampleRate]	; return sample rate in AX
  1172                                  	;mov	dx, [WAVE_BitsPerSample] 
  1173                                  					; return bits per sample value in DX
  1174                                  	;mov	bx, [WAVE_BlockAlign]	; return bytes per sample in BX
  1175                                  ;gwavp_retn:
  1176                                          ;retn
  1177                                  
  1178                                  gwavp_stc_retn:
  1179 000005CC F9                      	stc
  1180                                  gwavp_retn:
  1181 000005CD C3                      	retn
  1182                                  
  1183                                  ; --------------------------------------------------------
  1184                                  ; ----	30/05/2024 (playwav4.asm, 19/05/2024)
  1185                                  ; --------------------------------------------------------
  1186                                  
  1187                                  ; MEMALLOC.ASM
  1188                                  ;-- SETFREE: Release memory not used  --------------------
  1189                                  ;-- Input    : ES = address of PSP
  1190                                  ;-- Output   : none
  1191                                  ;-- Register : AX, BX, CL and FLAGS are changed 
  1192                                  ;-- Info     : Since the stack-segment is always the last segment in an 
  1193                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
  1194                                  ;              to the end of the program in memory. Through this the
  1195                                  ;              length of the program can be calculated 
  1196                                  ; call this routine once at the beginning of the program to free up memory
  1197                                  ; assigned to it by DOS.
  1198                                  
  1199                                  setFree:
  1200 000005CE BB0010                  	mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
  1201                                  
  1202 000005D1 B44A                    	mov	ah, 4Ah		; pass new length to DOS
  1203 000005D3 CD21                    	int	21h
  1204                                  
  1205 000005D5 C3                      	retn			; back to caller 
  1206                                  				; new size (allocated memory) = 64KB
  1207                                  
  1208                                  ; --------------------------------------------------------
  1209                                  
  1210                                  memAlloc:
  1211                                  ; input: AX = # of paragraphs required
  1212                                  ; output: AX = segment of block to use
  1213                                  
  1214 000005D6 53                      	push	bx
  1215 000005D7 89C3                    	mov	bx, ax
  1216 000005D9 B448                    	mov	ah, 48h
  1217 000005DB CD21                    	int	21h
  1218 000005DD 5B                      	pop	bx
  1219 000005DE C3                      	retn
  1220                                  
  1221                                  ; --------------------------------------------------------
  1222                                  
  1223                                  ; 29/12/2024 (vgaplay3.s)
  1224                                  ; 18/12/2024 (ac97play.s)
  1225                                  ; --------------------------------------------------------
  1226                                  ; 27/05/2024 - (TRDOS 386 Kernel) audio.s
  1227                                  ; --------------------------------------------------------
  1228                                  
  1229                                  NOT_PCI32_PCI16	EQU 03FFFFFFFh ; NOT BIT31+BIT30 ; 19/03/2017
  1230                                  NOT_BIT31 EQU 7FFFFFFFh
  1231                                  
  1232                                  pciFindDevice:
  1233                                  	; 19/11/2023
  1234                                  	; 03/04/2017 ('pci.asm', 20/03/2017)
  1235                                  	;
  1236                                  	; scan through PCI space looking for a device+vendor ID
  1237                                  	;
  1238                                  	; Entry: EAX=Device+Vendor ID
  1239                                  	;
  1240                                  	; Exit: EAX=PCI address if device found
  1241                                  	;	EDX=Device+Vendor ID
  1242                                  	;       CY clear if found, set if not found. EAX invalid if CY set.
  1243                                  	;
  1244                                  	; Destroys: ebx, edi ; 19/11/2023
  1245                                  
  1246                                          ; 19/11/2023
  1247 000005DF 6689C3                  	mov	ebx, eax
  1248 000005E2 66BF00000080            	mov	edi, 80000000h
  1249                                  nextPCIdevice:
  1250 000005E8 6689F8                  	mov 	eax, edi		; read PCI registers
  1251 000005EB E88D00                  	call	pciRegRead32
  1252                                  	; 19/11/2023
  1253 000005EE 6639DA                  	cmp	edx, ebx
  1254 000005F1 7414                    	je	short PCIScanExit	; found
  1255                                  	; 19/11/2023
  1256 000005F3 6681FF00F8FF80          	cmp	edi, 80FFF800h
  1257 000005FA 7309                    	jnb	short pfd_nf		; not found
  1258 000005FC 6681C700010000          	add	edi, 100h
  1259 00000603 EBE3                    	jmp	short nextPCIdevice
  1260                                  pfd_nf:
  1261 00000605 F9                      	stc
  1262 00000606 C3                      	retn
  1263                                  PCIScanExit:
  1264                                  	;pushf
  1265 00000607 66B8FFFFFF7F            	mov	eax, NOT_BIT31 	; 19/03/2017
  1266 0000060D 6621F8                  	and	eax, edi	; return only bus/dev/fn #
  1267 00000610 C3                      	retn
  1268                                  
  1269                                  pciRegRead:
  1270                                  	; 30/05/2024
  1271                                  	; 03/04/2017 ('pci.asm', 20/03/2017)
  1272                                  	;
  1273                                  	; 8/16/32bit PCI reader
  1274                                  	;
  1275                                  	; Entry: EAX=PCI Bus/Device/fn/register number
  1276                                  	;           BIT30 set if 32 bit access requested
  1277                                  	;           BIT29 set if 16 bit access requested
  1278                                  	;           otherwise defaults to 8 bit read
  1279                                  	;
  1280                                  	; Exit:  DL,DX,EDX register data depending on requested read size
  1281                                  	;
  1282                                  	; Note1: this routine is meant to be called via pciRegRead8,
  1283                                  	;	 pciRegread16 or pciRegRead32, listed below.
  1284                                  	;
  1285                                  	; Note2: don't attempt to read 32 bits of data from a non dword
  1286                                  	;	 aligned reg number. Likewise, don't do 16 bit reads from
  1287                                  	;	 non word aligned reg #
  1288                                  	
  1289 00000611 6653                    	push	ebx
  1290 00000613 51                      	push	cx
  1291 00000614 6689C3                          mov     ebx, eax		; save eax, dh
  1292 00000617 88F1                            mov     cl, dh
  1293                                  
  1294 00000619 6625FFFFFF3F                    and     eax, NOT_PCI32_PCI16	; clear out data size request
  1295 0000061F 660D00000080                    or      eax, BIT31		; make a PCI access request
  1296                                  	; 01/01/2025 (NASM)
  1297 00000625 24FC                            and     al, ~3 ; NOT 3		; force index to be dword
  1298                                  
  1299 00000627 BAF80C                          mov     dx, PCI_INDEX_PORT
  1300 0000062A 66EF                    	out	dx, eax			; write PCI selector
  1301                                  		
  1302 0000062C BAFC0C                          mov     dx, PCI_DATA_PORT
  1303 0000062F 88D8                            mov     al, bl
  1304 00000631 2403                            and     al, 3			; figure out which port to
  1305 00000633 00C2                            add     dl, al			; read to
  1306                                  
  1307 00000635 66F7C3000000C0          	test    ebx, PCI32+PCI16
  1308 0000063C 7507                            jnz     short _pregr0
  1309                                  
  1310 0000063E EC                      	in	al, dx			; return 8 bits of data
  1311                                  
  1312 0000063F 88C2                    	mov	dl, al
  1313 00000641 88CE                    	mov     dh, cl			; restore dh for 8 bit read
  1314 00000643 EB13                    	jmp	short _pregr2
  1315                                  _pregr0:	
  1316 00000645 66F7C300000080          	test    ebx, PCI32
  1317 0000064C 7505                            jnz	short _pregr1
  1318                                  
  1319 0000064E ED                      	in	ax, dx
  1320                                  
  1321 0000064F 89C2                    	mov     dx, ax			; return 16 bits of data
  1322 00000651 EB05                    	jmp	short _pregr2
  1323                                  _pregr1:
  1324 00000653 66ED                    	in	eax, dx			; return 32 bits of data
  1325                                  
  1326 00000655 6689C2                  	mov	edx, eax
  1327                                  _pregr2:
  1328 00000658 6689D8                  	mov     eax, ebx		; restore eax
  1329 0000065B 6625FFFFFF3F                    and     eax, NOT_PCI32_PCI16	; clear out data size request
  1330 00000661 59                      	pop	cx
  1331 00000662 665B                    	pop	ebx
  1332 00000664 C3                      	retn
  1333                                  
  1334                                  pciRegRead8:
  1335 00000665 6625FFFFFF3F                    and     eax, NOT_PCI32_PCI16	; set up 8 bit read size
  1336 0000066B EBA4                            jmp     short pciRegRead	; call generic PCI access
  1337                                  
  1338                                  pciRegRead16:
  1339 0000066D 6625FFFFFF3F                    and     eax, NOT_PCI32_PCI16	; set up 16 bit read size
  1340 00000673 660D00000040                    or      eax, PCI16		; call generic PCI access
  1341 00000679 EB96                            jmp     short pciRegRead
  1342                                  
  1343                                  pciRegRead32:
  1344 0000067B 6625FFFFFF3F                    and     eax, NOT_PCI32_PCI16	; set up 32 bit read size
  1345 00000681 660D00000080                    or      eax, PCI32		; call generic PCI access
  1346 00000687 EB88                            jmp     pciRegRead
  1347                                  
  1348                                  pciRegWrite:
  1349                                  	; 30/05/2024
  1350                                  	; 03/04/2017 ('pci.asm', 29/11/2016)
  1351                                  	;
  1352                                  	; 8/16/32bit PCI writer
  1353                                  	;
  1354                                  	; Entry: EAX=PCI Bus/Device/fn/register number
  1355                                  	;           BIT31 set if 32 bit access requested
  1356                                  	;           BIT30 set if 16 bit access requested
  1357                                  	;           otherwise defaults to 8bit read
  1358                                  	;        DL/DX/EDX data to write depending on size
  1359                                  	;
  1360                                  	; Note1: this routine is meant to be called via pciRegWrite8,
  1361                                  	;	 pciRegWrite16 or pciRegWrite32 as detailed below.
  1362                                  	;
  1363                                  	; Note2: don't attempt to write 32bits of data from a non dword
  1364                                  	;	 aligned reg number. Likewise, don't do 16 bit writes from
  1365                                  	;	 non word aligned reg #
  1366                                  
  1367 00000689 6653                    	push	ebx
  1368 0000068B 6651                    	push	ecx
  1369 0000068D 6689C3                          mov     ebx, eax		; save eax, edx
  1370 00000690 6689D1                          mov     ecx, edx
  1371 00000693 6625FFFFFF3F            	and     eax, NOT_PCI32_PCI16	; clear out data size request
  1372 00000699 660D00000080                    or      eax, BIT31		; make a PCI access request
  1373                                  	; 01/01/2025 (NASM)
  1374 0000069F 24FC                            and     al, ~3 ; NOT 3		; force index to be dword
  1375                                  
  1376 000006A1 BAF80C                          mov     dx, PCI_INDEX_PORT
  1377 000006A4 66EF                    	out	dx, eax			; write PCI selector
  1378                                  		
  1379 000006A6 BAFC0C                          mov     dx, PCI_DATA_PORT
  1380 000006A9 88D8                            mov     al, bl
  1381 000006AB 2403                            and     al, 3			; figure out which port to
  1382 000006AD 00C2                            add     dl, al			; write to
  1383                                  
  1384 000006AF 66F7C3000000C0          	test    ebx, PCI32+PCI16
  1385 000006B6 7505                            jnz     short _pregw0
  1386                                  	
  1387 000006B8 88C8                    	mov	al, cl 			; put data into al
  1388 000006BA EE                      	out	dx, al
  1389                                  	
  1390 000006BB EB13                    	jmp	short _pregw2
  1391                                  _pregw0:
  1392 000006BD 66F7C300000080          	test    ebx, PCI32
  1393 000006C4 7505                            jnz     short _pregw1
  1394                                  	
  1395 000006C6 89C8                    	mov	ax, cx			; put data into ax
  1396 000006C8 EF                      	out	dx, ax
  1397                                  
  1398 000006C9 EB05                    	jmp	short _pregw2
  1399                                  _pregw1:
  1400 000006CB 6689C8                  	mov	eax, ecx		; put data into eax
  1401 000006CE 66EF                    	out	dx, eax
  1402                                  _pregw2:
  1403 000006D0 6689D8                          mov     eax, ebx		; restore eax
  1404 000006D3 6625FFFFFF3F                    and     eax, NOT_PCI32_PCI16	; clear out data size request
  1405 000006D9 6689CA                          mov     edx, ecx		; restore dx
  1406 000006DC 6659                    	pop	ecx
  1407 000006DE 665B                    	pop	ebx
  1408 000006E0 C3                      	retn
  1409                                  
  1410                                  pciRegWrite8:
  1411 000006E1 6625FFFFFF3F                    and     eax, NOT_PCI32_PCI16	; set up 8 bit write size
  1412 000006E7 EBA0                            jmp	short pciRegWrite	; call generic PCI access
  1413                                  
  1414                                  pciRegWrite16:
  1415 000006E9 6625FFFFFF3F                    and     eax, NOT_PCI32_PCI16	; set up 16 bit write size
  1416 000006EF 660D00000040                    or      eax, PCI16		; call generic PCI access
  1417 000006F5 EB92                            jmp	short pciRegWrite
  1418                                  
  1419                                  pciRegWrite32:
  1420 000006F7 6625FFFFFF3F                    and     eax, NOT_PCI32_PCI16	; set up 32 bit write size
  1421 000006FD 660D00000080                    or      eax, PCI32		; call generic PCI access
  1422 00000703 EB84                            jmp	pciRegWrite
  1423                                  
  1424                                  ; --------------------------------------------------------
  1425                                  ; 19/05/2024 - (playwav4.asm) ac97_vra.asm
  1426                                  ; --------------------------------------------------------
  1427                                  
  1428                                  	; 13/11/2023
  1429                                  
  1430                                  ;VRA:	db 1
  1431                                  
  1432                                  codecConfig:
  1433                                  	; 30/05/2024
  1434                                  	; 19/05/2024
  1435                                  	; 19/11/2023
  1436                                  	; 15/11/2023
  1437                                  	; 04/11/2023
  1438                                  	; 17/02/2017 
  1439                                  	; 07/11/2016 (Erdogan Tan)
  1440                                  
  1441                                  	;AC97_EA_VRA equ 1
  1442                                  	AC97_EA_VRA equ BIT0
  1443                                  
  1444                                  	; 04/11/2023
  1445                                  init_ac97_controller:
  1446 00000705 66A1[662A]              	mov	eax, [bus_dev_fn]
  1447 00000709 B004                    	mov	al, PCI_CMD_REG
  1448 0000070B E85FFF                  	call	pciRegRead16		; read PCI command register
  1449 0000070E 80CA05                  	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
  1450 00000711 E8D5FF                  	call	pciRegWrite16
  1451                                  
  1452                                  	;call	delay_100ms
  1453                                  
  1454                                  	; 19/05/2024
  1455                                  	; ('PLAYMOD3.ASM', Erdogan Tan, 18/05/2024)
  1456                                  
  1457                                  init_ac97_codec:
  1458                                  	; 18/11/2023
  1459 00000714 BD2800                  	mov	bp, 40
  1460                                  	; 29/05/2024
  1461                                  	;mov	bp, 1000
  1462                                  _initc_1:
  1463                                  	; 30/05/2024
  1464 00000717 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1465 0000071A 0316[702A]              	add	dx, [NABMBAR]
  1466 0000071E 66ED                    	in	eax, dx
  1467                                  
  1468                                  	; 19/05/2024
  1469 00000720 E8FD01                  	call	delay1_4ms
  1470                                  
  1471 00000723 6683F8FF                	cmp	eax, 0FFFFFFFFh ; -1
  1472 00000727 7508                    	jne	short _initc_3
  1473                                  _initc_2:
  1474 00000729 4D                      	dec	bp
  1475 0000072A 741E                    	jz	short _ac97_codec_ready
  1476                                  
  1477 0000072C E8E601                  	call	delay_100ms
  1478 0000072F EBE6                    	jmp	short _initc_1
  1479                                  _initc_3:
  1480 00000731 66A900030010            	test	eax, CTRL_ST_CREADY
  1481 00000737 7511                    	jnz	short _ac97_codec_ready
  1482                                  
  1483                                  	; 30/05/2024
  1484 00000739 803E[9121]01            	cmp	byte [reset], 1
  1485 0000073E 73E9                    	jnb	short _initc_2
  1486                                  
  1487 00000740 E81801                  	call	reset_ac97_codec
  1488                                  	; 30/05/2024
  1489 00000743 C606[9121]01            	mov	byte [reset], 1
  1490                                  	; 19/05/2024
  1491 00000748 EBDF                    	jmp	short _initc_2
  1492                                  
  1493                                  _ac97_codec_ready:
  1494 0000074A 8B16[6E2A]              	mov	dx, [NAMBAR]
  1495                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1496 0000074E EF                      	out	dx, ax
  1497                                  	
  1498 0000074F E8C301                  	call	delay_100ms
  1499                                  
  1500                                  	; 19/11/2023
  1501 00000752 09ED                    	or	bp, bp
  1502 00000754 7525                    	jnz	short _ac97_codec_init_ok
  1503                                  
  1504 00000756 31C0                    	xor	ax, ax ; 0
  1505 00000758 8B16[6E2A]              	mov	dx, [NAMBAR]
  1506 0000075C 83C226                  	add	dx, CODEC_REG_POWERDOWN
  1507 0000075F EF                      	out	dx, ax
  1508                                  
  1509                                  	; 30/05/2024
  1510 00000760 E8BD01                  	call	delay1_4ms
  1511                                  
  1512                                  	; 19/11/2023
  1513                                  	; wait for 1 second
  1514                                  	; 19/05/2024
  1515 00000763 B9E803                  	mov	cx, 1000 ; 1000*4*0.25ms = 1s
  1516                                  	;;mov	cx, 10
  1517                                  	; 30/05/2024
  1518                                  	;mov	cx, 40
  1519                                  _ac97_codec_rloop:
  1520                                  	;call	delay_100ms
  1521                                  
  1522                                  	; 30/05/2024
  1523 00000766 8B16[6E2A]              	mov	dx, [NAMBAR]
  1524 0000076A 83C226                  	add	dx, CODEC_REG_POWERDOWN
  1525 0000076D ED                      	in	ax, dx
  1526                                  
  1527 0000076E E8AF01                  	call	delay1_4ms
  1528                                  	
  1529 00000771 83E00F                  	and	ax, 0Fh
  1530 00000774 3C0F                    	cmp	al, 0Fh
  1531 00000776 7403                    	je	short _ac97_codec_init_ok
  1532 00000778 E2EC                    	loop	_ac97_codec_rloop 
  1533                                  
  1534                                  init_ac97_codec_err1:
  1535                                  	;stc	; cf = 1 ; 19/05/2024
  1536                                  init_ac97_codec_err2:
  1537 0000077A C3                      	retn
  1538                                  
  1539                                  _ac97_codec_init_ok:
  1540 0000077B E89600                  	call 	reset_ac97_controller
  1541                                  
  1542                                  	; 30/05/2024
  1543                                  	; 19/05/2024
  1544                                  	;call	delay_100ms
  1545                                  
  1546                                  	; 30/05/2024
  1547 0000077E E89F01                  	call	delay1_4ms
  1548 00000781 E89C01                  	call	delay1_4ms
  1549 00000784 E89901                  	call	delay1_4ms
  1550 00000787 E89601                  	call	delay1_4ms
  1551                                  
  1552                                  setup_ac97_codec:
  1553                                  	; 12/11/2023
  1554 0000078A 813E[F829]80BB          	cmp	word [WAVE_SampleRate], 48000
  1555 00000790 7453                    	je	short skip_rate
  1556                                  	
  1557                                  	; 30/05/2024
  1558                                  	; 19/05/2024
  1559                                  	;call	delay1_4ms
  1560                                  
  1561                                  	; 30/05/2024
  1562                                  	;cmp	byte [VRA], 0
  1563                                  	;jna	short skip_rate
  1564                                  
  1565                                  	; 11/11/2023
  1566 00000792 8B16[6E2A]              	mov	dx, [NAMBAR]
  1567 00000796 83C22A                  	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1568 00000799 ED                      	in	ax, dx
  1569                                  
  1570                                  	; 30/05/2024
  1571                                  	; 19/05/2024
  1572 0000079A E88301                  	call	delay1_4ms
  1573                                  	
  1574                                  	; 13/11/2024
  1575                                  	;and	al, NOT BIT1 ; Clear DRA
  1576                                  	;;;
  1577                                  	; 30/05/2024
  1578                                  	;and	al, NOT (BIT1+BIT0) ; Clear DRA+VRA
  1579                                  	; 01/01/2025 (NASM)
  1580 0000079D 24FC                    	and	al, ~(BIT1+BIT0)
  1581 0000079F EF                      	out	dx, ax
  1582                                  
  1583 000007A0 E83801                  	call	check_vra
  1584                                  
  1585 000007A3 803E[DC29]00            	cmp	byte [VRA], 0
  1586 000007A8 763B                    	jna	short skip_rate
  1587                                  
  1588 000007AA 8B16[6E2A]              	mov	dx, [NAMBAR]
  1589 000007AE 83C22A                  	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1590 000007B1 ED                      	in	ax, dx
  1591                                  	;and	al, ~BIT1 ; Clear DRA
  1592                                  	;;;
  1593                                  
  1594 000007B2 0C01                    	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
  1595                                  	; 30/05/2024
  1596 000007B4 8B16[6E2A]              	mov	dx, [NAMBAR]
  1597 000007B8 83C22A                  	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1598                                  
  1599 000007BB EF                      	out	dx, ax			; Enable variable rate audio
  1600                                  
  1601 000007BC B90A00                  	mov	cx, 10
  1602                                  check_vra_loop:
  1603 000007BF E85301                  	call	delay_100ms
  1604                                  	; 30/05/2024
  1605                                  	;call	delay1_4ms
  1606                                  
  1607                                  	; 30/05/2024
  1608 000007C2 8B16[6E2A]              	mov	dx, [NAMBAR]
  1609 000007C6 83C22A                  	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1610                                  	; 11/11/2023
  1611 000007C9 ED                      	in	ax, dx
  1612                                  	
  1613 000007CA A801                    	test	al, AC97_EA_VRA ; 1
  1614 000007CC 7509                    	jnz	short set_rate
  1615                                  
  1616                                  	; 11/11/2023
  1617 000007CE E2EF                    	loop	check_vra_loop
  1618                                  
  1619                                  ;vra_not_supported:	; 19/05/2024
  1620 000007D0 C606[DC29]00            	mov	byte [VRA], 0
  1621 000007D5 EB0E                    	jmp	short skip_rate
  1622                                  
  1623                                  set_rate:
  1624 000007D7 A1[F829]                	mov	ax, [WAVE_SampleRate] ; 17/02/2017 (Erdogan Tan)
  1625                                  
  1626 000007DA 8B16[6E2A]              	mov    	dx, [NAMBAR]               	
  1627 000007DE 83C22C                  	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch
  1628 000007E1 EF                      	out	dx, ax 			; PCM Front/Center Output Sample Rate
  1629                                  
  1630                                  	;call	delay_100ms
  1631                                  	; 30/05/2024
  1632 000007E2 E83B01                  	call	delay1_4ms
  1633                                  
  1634                                  	; 12/11/2023
  1635                                  skip_rate:
  1636 000007E5 B80202                  	mov	ax, 0202h
  1637 000007E8 8B16[6E2A]                	mov	dx, [NAMBAR]
  1638 000007EC 83C202                    	add	dx, CODEC_MASTER_VOL_REG	; 02h
  1639 000007EF EF                      	out	dx, ax
  1640                                  
  1641                                  	; 11/11/2023
  1642 000007F0 E82D01                  	call	delay1_4ms
  1643 000007F3 E82A01                  	call	delay1_4ms
  1644 000007F6 E82701                  	call	delay1_4ms
  1645 000007F9 E82401                  	call	delay1_4ms
  1646                                  
  1647 000007FC B80202                  	mov	ax, 0202h
  1648 000007FF 8B16[6E2A]                	mov	dx, [NAMBAR]
  1649 00000803 83C218                    	add	dx, CODEC_PCM_OUT_REG		; 18h
  1650 00000806 EF                        	out	dx, ax
  1651                                  	
  1652                                  	; 11/11/2023
  1653 00000807 E81601                  	call	delay1_4ms
  1654 0000080A E81301                  	call	delay1_4ms
  1655 0000080D E81001                  	call	delay1_4ms
  1656 00000810 E80D01                  	call	delay1_4ms
  1657                                  
  1658                                  	; 30/05/2024
  1659                                  	; 19/05/2024
  1660                                  	;clc
  1661                                  
  1662 00000813 C3                              retn
  1663                                  
  1664                                  reset_ac97_controller:
  1665                                  	; 19/05/2024
  1666                                  	; 11/11/2023
  1667                                  	; 10/06/2017
  1668                                  	; 29/05/2017
  1669                                  	; 28/05/2017
  1670                                  	; reset AC97 audio controller registers
  1671 00000814 31C0                    	xor     ax, ax
  1672 00000816 BA0B00                          mov	dx, PI_CR_REG
  1673 00000819 0316[702A]              	add	dx, [NABMBAR]
  1674 0000081D EE                      	out     dx, al
  1675                                  
  1676                                  	; 19/05/2024
  1677 0000081E E8FF00                  	call	delay1_4ms
  1678                                  
  1679 00000821 BA1B00                          mov     dx, PO_CR_REG
  1680 00000824 0316[702A]              	add	dx, [NABMBAR]
  1681 00000828 EE                      	out     dx, al
  1682                                  
  1683                                  	; 19/05/2024
  1684 00000829 E8F400                  	call	delay1_4ms
  1685                                  
  1686 0000082C BA2B00                          mov     dx, MC_CR_REG
  1687 0000082F 0316[702A]              	add	dx, [NABMBAR]
  1688 00000833 EE                      	out     dx, al
  1689                                  
  1690                                  	; 19/05/2024
  1691 00000834 E8E900                  	call	delay1_4ms
  1692                                  
  1693 00000837 B002                            mov     al, RR
  1694 00000839 BA0B00                          mov     dx, PI_CR_REG
  1695 0000083C 0316[702A]              	add	dx, [NABMBAR]
  1696 00000840 EE                      	out     dx, al
  1697                                  
  1698                                  	; 19/05/2024
  1699 00000841 E8DC00                  	call	delay1_4ms
  1700                                  
  1701 00000844 BA1B00                          mov     dx, PO_CR_REG
  1702 00000847 0316[702A]              	add	dx, [NABMBAR]
  1703 0000084B EE                      	out     dx, al
  1704                                  
  1705                                  	; 19/05/2024
  1706 0000084C E8D100                  	call	delay1_4ms
  1707                                  
  1708 0000084F BA2B00                          mov     dx, MC_CR_REG
  1709 00000852 0316[702A]              	add	dx, [NABMBAR]
  1710 00000856 EE                      	out     dx, al
  1711                                  
  1712                                  	; 19/05/2024
  1713 00000857 E8C600                  	call	delay1_4ms
  1714                                  
  1715 0000085A C3                      	retn
  1716                                  
  1717                                  reset_ac97_codec:
  1718                                  	; 11/11/2023
  1719                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1720 0000085B BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1721 0000085E 0316[702A]              	add	dx, [NABMBAR]
  1722 00000862 66ED                    	in	eax, dx
  1723                                  
  1724                                  	;test	eax, 2
  1725                                  	; 06/08/2022
  1726 00000864 A802                    	test	al, 2
  1727 00000866 7405                    	jz	short _r_ac97codec_cold
  1728                                  
  1729 00000868 E80E00                  	call	warm_ac97codec_reset
  1730 0000086B 7306                    	jnc	short _r_ac97codec_ok
  1731                                  _r_ac97codec_cold:
  1732 0000086D E83400                          call    cold_ac97codec_reset
  1733 00000870 7301                            jnc     short _r_ac97codec_ok
  1734                                  	
  1735                                  	; 16/04/2017
  1736                                          ;xor	eax, eax	; timeout error
  1737                                         	;stc
  1738 00000872 C3                      	retn
  1739                                  
  1740                                  _r_ac97codec_ok:
  1741 00000873 6631C0                          xor     eax, eax
  1742                                          ;mov	al, VIA_ACLINK_C00_READY ; 1
  1743 00000876 FEC0                            inc	al
  1744 00000878 C3                      	retn
  1745                                  
  1746                                  warm_ac97codec_reset:
  1747                                  	; 11/11/2023
  1748                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1749                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1750 00000879 66B806000000            	mov	eax, 6
  1751 0000087F BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1752 00000882 0316[702A]              	add	dx, [NABMBAR]
  1753 00000886 66EF                    	out	dx, eax
  1754                                  
  1755 00000888 B90A00                  	mov	cx, 10	; total 1s
  1756                                  _warm_ac97c_rst_wait:
  1757 0000088B E88700                  	call	delay_100ms
  1758                                  
  1759 0000088E BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1760 00000891 0316[702A]              	add	dx, [NABMBAR]
  1761 00000895 66ED                    	in	eax, dx
  1762                                  
  1763 00000897 66A900030010            	test	eax, CTRL_ST_CREADY
  1764 0000089D 7504                    	jnz	short _warm_ac97c_rst_ok
  1765                                  
  1766 0000089F 49                              dec     cx
  1767 000008A0 75E9                            jnz     short _warm_ac97c_rst_wait
  1768                                  
  1769                                  _warm_ac97c_rst_fail:
  1770 000008A2 F9                              stc
  1771                                  _warm_ac97c_rst_ok:
  1772 000008A3 C3                      	retn
  1773                                  
  1774                                  cold_ac97codec_reset:
  1775                                  	; 11/11/2023
  1776                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1777                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1778 000008A4 66B802000000                    mov	eax, 2
  1779 000008AA BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1780 000008AD 0316[702A]              	add	dx, [NABMBAR]
  1781 000008B1 66EF                    	out	dx, eax
  1782                                  
  1783 000008B3 E85F00                  	call	delay_100ms 	; wait 100 ms
  1784 000008B6 E85C00                  	call	delay_100ms 	; wait 100 ms
  1785 000008B9 E85900                  	call	delay_100ms 	; wait 100 ms
  1786 000008BC E85600                  	call	delay_100ms 	; wait 100 ms
  1787                                  
  1788 000008BF B91000                  	mov	cx, 16	; total 20*100 ms = 2s
  1789                                  
  1790                                  _cold_ac97c_rst_wait:
  1791 000008C2 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1792 000008C5 0316[702A]              	add	dx, [NABMBAR]
  1793 000008C9 66ED                    	in	eax, dx
  1794                                  
  1795 000008CB 66A900030010            	test	eax, CTRL_ST_CREADY
  1796 000008D1 7507                    	jnz	short _cold_ac97c_rst_ok
  1797                                  
  1798 000008D3 E83F00                  	call	delay_100ms
  1799                                  
  1800 000008D6 49                              dec     cx
  1801 000008D7 75E9                            jnz     short _cold_ac97c_rst_wait
  1802                                  
  1803                                  _cold_ac97c_rst_fail:
  1804 000008D9 F9                              stc
  1805                                  _cold_ac97c_rst_ok:
  1806 000008DA C3                      	retn
  1807                                  
  1808                                  ; 13/11/2024
  1809                                  ; 30/05/2024
  1810                                  %if 1
  1811                                  check_vra:
  1812                                  	; 30/05/2024
  1813 000008DB C606[DC29]01            	mov	byte [VRA], 1
  1814                                  
  1815                                  	; 29/05/2024 - audio.s (TRDOS 386 Kernel) - 27/05/2024
  1816                                  	; 24/05/2024
  1817                                  	; 23/05/2024
  1818 000008E0 8B16[6E2A]              	mov	dx, [NAMBAR]
  1819 000008E4 83C228                  	add	dx, CODEC_EXT_AUDIO_REG	; 28h
  1820 000008E7 ED                      	in	ax, dx
  1821                                  
  1822                                  	; 30/05/2024
  1823                                  	; 23/05/2024
  1824 000008E8 E83500                  	call	delay1_4ms
  1825                                  
  1826                                  	; 30/05/2024
  1827 000008EB A801                    	test	al, BIT0
  1828                                  	;test	al, 1 ; BIT0 ; Variable Rate Audio bit
  1829 000008ED 7505                    	jnz	short check_vra_ok
  1830                                  
  1831                                  vra_not_supported:
  1832                                  	; 13/11/2023
  1833 000008EF C606[DC29]00            	mov	byte [VRA], 0
  1834                                  check_vra_ok:
  1835 000008F4 C3                      	retn
  1836                                  %endif
  1837                                  
  1838                                  ; --------------------------------------------------------
  1839                                  ; --------------------------------------------------------
  1840                                  
  1841                                  ; 01/01/2025 (cgaplay.asm)
  1842                                  ; 29/12/2024 (vgaplay3.s)
  1843                                  ; 18/12/2024 (ac97play.s)
  1844                                  ;
  1845                                  ; 18/11/2024
  1846                                  ; Ref: TRDOS 386 v2.0.9, audio.s, Erdogan Tan, 06/06/2024
  1847                                  
  1848                                  ac97_stop:
  1849                                  	; 18/11/2024
  1850 000008F5 C606[D429]02            	mov	byte [stopped], 2
  1851                                  
  1852                                  ac97_po_cmd@:
  1853 000008FA 30C0                    	xor	al, al ; 0
  1854                                  ac97_po_cmd:
  1855 000008FC 8B16[702A]              	mov     dx, [NABMBAR]
  1856 00000900 83C21B                          add     dx, PO_CR_REG	; PCM out control register
  1857 00000903 EE                      	out	dx, al
  1858 00000904 C3                      	retn
  1859                                  
  1860                                  ac97_pause:
  1861 00000905 C606[D429]01            	mov	byte [stopped], 1 ; paused
  1862                                  	;mov	al, 0
  1863                                  	;jmp	short ac97_po_cmd
  1864 0000090A EBEE                    	jmp	short ac97_po_cmd@
  1865                                  
  1866                                  ac97_play: ; continue to play (after pause)
  1867 0000090C C606[D429]00            	mov	byte [stopped], 0
  1868 00000911 B001                    	mov	al, RPBM
  1869 00000913 EBE7                    	jmp	short ac97_po_cmd
  1870                                  
  1871                                  ; --------------------------------------------------------
  1872                                  
  1873                                  PORTB		EQU 061h
  1874                                  REFRESH_STATUS	EQU 010h	; Refresh signal status
  1875                                  
  1876                                  delay_100ms:
  1877                                  	; 11/11/2023
  1878                                  	; 29/05/2017
  1879                                  	; 24/03/2017 ('codec.asm')
  1880                                  	; wait 100 ms
  1881 00000915 51                      	push	cx
  1882 00000916 B99001                  	mov	cx, 400  ; 400*0.25ms
  1883                                  _delay_x_ms:
  1884 00000919 E80400                  	call	delay1_4ms
  1885 0000091C E2FB                            loop	_delay_x_ms
  1886 0000091E 59                      	pop	cx
  1887 0000091F C3                      	retn
  1888                                  
  1889                                  delay1_4ms:
  1890 00000920 50                              push    ax
  1891 00000921 51                              push    cx
  1892 00000922 B91000                          mov     cx, 16			; close enough.
  1893 00000925 E461                    	in	al, PORTB
  1894 00000927 2410                    	and	al, REFRESH_STATUS
  1895 00000929 88C4                    	mov	ah, al			; Start toggle state
  1896 0000092B 09C9                    	or	cx, cx
  1897 0000092D 7401                    	jz	short _d4ms1
  1898 0000092F 41                      	inc	cx			; Throwaway first toggle
  1899                                  _d4ms1:
  1900 00000930 E461                    	in	al, PORTB		; Read system control port
  1901 00000932 2410                    	and	al, REFRESH_STATUS	; Refresh toggles 15.085 microseconds
  1902 00000934 38C4                    	cmp	ah, al
  1903 00000936 74F8                    	je	short _d4ms1		; Wait for state change
  1904                                  
  1905 00000938 88C4                    	mov	ah, al			; Update with new state
  1906 0000093A 49                      	dec	cx
  1907 0000093B 75F3                    	jnz	short _d4ms1
  1908                                  
  1909                                  	; 30/05/2024
  1910 0000093D F8                      	clc
  1911                                  
  1912 0000093E 59                              pop     cx
  1913 0000093F 58                              pop     ax
  1914 00000940 C3                              retn
  1915                                  
  1916                                  ; --------------------------------------------------------
  1917                                  
  1918                                  ; returns AL = current index value
  1919                                  getCurrentIndex:
  1920                                  	; 08/11/2023
  1921                                  	;push	dx
  1922 00000941 8B16[702A]              	mov	dx, [NABMBAR]
  1923 00000945 83C214                  	add	dx, PO_CIV_REG
  1924 00000948 EC                      	in	al, dx
  1925                                  	;pop	dx
  1926                                  uLVI2:	;	06/11/2023
  1927 00000949 C3                      	retn
  1928                                  
  1929                                  ; --------------------------------------------------------
  1930                                  
  1931                                  updateLVI:
  1932                                  	; 06/11/2023
  1933 0000094A 8B16[702A]              	mov	dx, [NABMBAR]
  1934 0000094E 83C214                  	add	dx, PO_CIV_REG
  1935                                  	; (Current Index Value and Last Valid Index value)
  1936 00000951 ED                      	in	ax, dx
  1937                                  
  1938 00000952 38E0                    	cmp	al, ah ; is current index = last index ?
  1939 00000954 75F3                    	jne	short uLVI2
  1940                                  
  1941                                  	; 08/11/2023
  1942 00000956 E8E8FF                  	call	getCurrentIndex
  1943                                   
  1944 00000959 F606[0C2A]01            	test	byte [flags], ENDOFFILE
  1945                                  	;jnz	short uLVI1
  1946 0000095E 7411                    	jz	short uLVI0  ; 08/11/2023
  1947                                  
  1948                                  	; 08/11/2023
  1949 00000960 50                      	push	ax
  1950 00000961 8B16[702A]              	mov	dx, [NABMBAR]
  1951 00000965 83C216                  	add	dx, PO_SR_REG  ; PCM out status register
  1952 00000968 ED                      	in	ax, dx
  1953                                  
  1954 00000969 A803                    	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
  1955                                  		      ; (has been processed)
  1956                                  		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
  1957 0000096B 58                      	pop	ax
  1958 0000096C 7407                    	jz	short uLVI1
  1959                                  uLVI3:
  1960 0000096E 31C0                    	xor	ax, ax
  1961                                  	; zf = 1
  1962 00000970 C3                      	retn
  1963                                  uLVI0:
  1964                                          ; not at the end of the file yet.
  1965 00000971 FEC8                    	dec	al
  1966 00000973 241F                    	and	al, 1Fh
  1967                                  uLVI1:
  1968                                  	;call	setLastValidIndex
  1969                                  ;uLVI2:
  1970                                  	;retn
  1971                                  
  1972                                  ;input AL = index # to stop on
  1973                                  setLastValidIndex:
  1974                                  	; 08/11/2023
  1975                                  	;push	dx
  1976 00000975 8B16[702A]              	mov	dx, [NABMBAR]
  1977 00000979 83C215                  	add	dx, PO_LVI_REG
  1978 0000097C EE                              out     dx, al
  1979                                  	;pop	dx
  1980 0000097D C3                      	retn
  1981                                  
  1982                                  ; --------------------------------------------------------
  1983                                  ; 07/12/2024
  1984                                  ; --------------------------------------------------------
  1985                                  
  1986                                  ; /////
  1987                                  	; 30/05/2024 (ich_wav4.asm, 19/05/2024)
  1988                                  loadFromFile:
  1989                                  	; 07/11/2023
  1990 0000097E F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  1991                                  					; last of the file?
  1992 00000983 7402                    	jz	short lff_0		; no
  1993 00000985 F9                      	stc
  1994 00000986 C3                      	retn
  1995                                  
  1996                                  lff_0:
  1997                                  	; 08/11/2023
  1998 00000987 89C5                    	mov	bp, ax ; save buffer segment
  1999                                  
  2000                                  	; 17/11/2024
  2001 00000989 8B1E[0E2A]              	mov	bx, [filehandle]
  2002                                  
  2003                                  	; 17/11/2024
  2004 0000098D 8B0E[7A2A]              	mov	cx, [loadsize]
  2005 00000991 31FF                    	xor	di, di ; 0
  2006                                  
  2007                                  	;mov	cl, [fbs_shift]
  2008                                  	;and	cl, cl
  2009                                  	;jz	short lff_1 ; stereo, 16 bit
  2010                                  	; 17/11/2024
  2011 00000993 803E[642A]00            	cmp	byte [fbs_shift], 0
  2012 00000998 7650                    	jna	short lff_1 ; stereo, 16 bit
  2013                                  
  2014                                  	;mov	di, BUFFERSIZE - 1 ; 65535
  2015                                  
  2016                                  	;; fbs_shift =
  2017                                  	;;	2 for mono and 8 bit sample (multiplier = 4)
  2018                                  	;;	1 for mono or 8 bit sample (multiplier = 2)
  2019                                  	;shr	di, cl
  2020                                  	;inc	di ; 16384 for 8 bit and mono
  2021                                  	;	   ; 32768 for 8 bit or mono
  2022                                  	
  2023                                  	; 17/11/2024
  2024                                  	;mov	cx, [loadsize] ; 16380 or 32760
  2025                                  
  2026                                  	;mov	ax, cs
  2027 0000099A BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  2028                                  
  2029                                  	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
  2030                                  	; load file into memory
  2031                                  	;mov	cx, di ; 17/11/2024
  2032                                  	;mov	bx, [filehandle] ; 17/11/2024
  2033                                  	;mov    ds, ax
  2034 0000099D B43F                           	mov	ah, 3Fh
  2035 0000099F CD21                    	int	21h
  2036                                  
  2037                                  	;mov	bx, cs
  2038                                  	;mov	ds, bx
  2039                                  	; 17/11/2024
  2040                                  	;push	cs
  2041                                  	;pop	ds
  2042                                  
  2043 000009A1 7265                    	jc	lff_4 ; error !
  2044                                  
  2045                                  	; 14/11/2024
  2046 000009A3 A3[842A]                	mov	[count], ax
  2047                                  
  2048                                  	; 17/11/2024
  2049                                  	; 08/11/2023
  2050                                  	;xor	dx, dx ; 0
  2051                                  
  2052 000009A6 21C0                    	and	ax, ax
  2053 000009A8 7455                    	jz	short lff_3
  2054                                  
  2055 000009AA 8A1E[642A]              	mov	bl, [fbs_shift]
  2056                                  
  2057 000009AE 06                      	push	es
  2058                                  	;mov	di, dx ; 0 ; [fbs_off]
  2059                                  	; 17/11/2024
  2060                                  	; di = 0
  2061                                  	;mov	bp, [fbs_seg] ; buffer segment
  2062 000009AF 8EC5                    	mov	es, bp
  2063 000009B1 BE[8E2A]                	mov	si, temp_buffer ; temporary buffer address
  2064 000009B4 89C1                    	mov	cx, ax ; byte count
  2065 000009B6 803E[022A]08            	cmp	byte [WAVE_BitsPerSample], 8 ; bits per sample (8 or 16)
  2066 000009BB 751B                    	jne	short lff_7 ; 16 bit samples
  2067                                  	; 8 bit samples
  2068 000009BD FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
  2069 000009BF 740C                    	jz	short lff_6 ; 8 bit, stereo
  2070                                  lff_5:
  2071                                  	; mono & 8 bit
  2072 000009C1 AC                      	lodsb
  2073 000009C2 2C80                    	sub	al, 80h ; 08/11/2023
  2074 000009C4 C1E008                  	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
  2075 000009C7 AB                      	stosw	; left channel
  2076 000009C8 AB                      	stosw	; right channel
  2077 000009C9 E2F6                    	loop	lff_5
  2078 000009CB EB12                    	jmp	short lff_9
  2079                                  lff_6:
  2080                                  	; stereo & 8 bit
  2081 000009CD AC                      	lodsb
  2082 000009CE 2C80                    	sub	al, 80h ; 08/11/2023
  2083 000009D0 C1E008                  	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
  2084 000009D3 AB                      	stosw
  2085 000009D4 E2F7                    	loop	lff_6
  2086 000009D6 EB07                    	jmp	short lff_9
  2087                                  lff_7:
  2088 000009D8 D1E9                    	shr	cx, 1 ; word count
  2089                                  lff_8:
  2090 000009DA AD                      	lodsw
  2091 000009DB AB                      	stosw	; left channel
  2092 000009DC AB                      	stosw	; right channel
  2093 000009DD E2FB                    	loop	lff_8
  2094                                  lff_9:
  2095 000009DF 07                      	pop	es
  2096                                  	
  2097                                  	;or	di, di
  2098                                  	;jz	short endLFF ; 64KB ok 
  2099                                  	;mov	ax, di ; [fbs_off]
  2100                                  	;dec	ax
  2101                                  	; 17/11/2024
  2102 000009E0 89F8                    	mov	ax, di 
  2103                                  	;cmp	ax, BUFFERSIZE ; 65520
  2104                                  	;jnb	short endLFF
  2105                                  
  2106                                  	;mov	cx, BUFFERSIZE - 1 ; 65535
  2107                                  	; 17/11/2024
  2108 000009E2 B9F0FF                  	mov	cx, BUFFERSIZE
  2109                                  	; 17/11/2024
  2110                                  	; ax = di
  2111 000009E5 39C8                    	cmp	ax, cx
  2112                                  	;jnb	short endLFF
  2113                                  	;jmp	short lff_3
  2114 000009E7 7216                    	jb	short lff_3
  2115 000009E9 C3                      	retn
  2116                                  	
  2117                                  lff_1:  
  2118                                  	;mov	bp, ax ; save buffer segment
  2119 000009EA 31D2                    	xor	dx, dx
  2120                                  	; load file into memory
  2121                                          ;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
  2122                                  	
  2123                                  	; 17/11/2024
  2124                                  	;mov	cx, [buffersize] ; BUFFERSIZE / 2
  2125                                  	; 17/11/2024 (*)
  2126                                  	; cx = [loadsize] = 2*[buffersize]
  2127                                  
  2128                                  	;mov	bx, [filehandle] ; 17/11/2024
  2129 000009EC 8ED8                    	mov     ds, ax ; mov ds, bp
  2130 000009EE B43F                           	mov	ah, 3Fh
  2131 000009F0 CD21                    	int	21h
  2132                                  
  2133                                  	;mov	di, cs
  2134                                  	;mov	ds, di
  2135                                  	; 17/11/2024
  2136 000009F2 0E                      	push	cs
  2137 000009F3 1F                      	pop	ds
  2138                                  
  2139                                  	; 07/11/2023
  2140 000009F4 7212                    	jc	short lff_4 ; error !
  2141                                  
  2142                                  	; 14/11/2024
  2143 000009F6 A3[842A]                	mov	[count], ax
  2144                                  	; 17/11/2024
  2145                                  	; di = 0
  2146                                  
  2147                                  ; 17/11/2024 (*)
  2148                                  %if 0	
  2149                                  	cmp	ax, cx
  2150                                  	jne	short lff_3
  2151                                  lff_2:
  2152                                  	; 08/11/2023
  2153                                  	add	dx, ax
  2154                                  	;;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
  2155                                  	;mov	cx, [buffersize] ; BUFFERSIZE / 2
  2156                                  	;mov	bx, [filehandle]
  2157                                  	mov     ds, bp
  2158                                         	mov	ah, 3Fh
  2159                                  	int	21h
  2160                                  
  2161                                  	;;mov	di, cs
  2162                                  	;mov	ds, di
  2163                                  	; 17/11/2024
  2164                                  	push	cs
  2165                                  	pop	ds
  2166                                  
  2167                                  	jc	short lff_4 ; error !
  2168                                  
  2169                                  	; 17/11/2024
  2170                                  	; 14/11/2024
  2171                                  	add	[count], ax
  2172                                  %endif
  2173                                  
  2174 000009F9 39C8                    	cmp	ax, cx
  2175 000009FB 740A                    	je	short endLFF
  2176                                  	; 17/11/2024
  2177                                  	; di = 0
  2178 000009FD 89C7                    	mov	di, ax
  2179                                  lff_3:
  2180 000009FF E80F00                  	call    padfill			; blank pad the remainder
  2181                                          ;clc				; don't exit with CY yet.
  2182 00000A02 800E[0C2A]01                    or	byte [flags], ENDOFFILE	; end of file flag
  2183                                  endLFF:
  2184 00000A07 C3                              retn
  2185                                  lff_4:
  2186                                  	; 08/11/2023
  2187 00000A08 B021                    	mov	al, '!'  ; error
  2188 00000A0A E821FB                  	call	tL0
  2189                                  
  2190 00000A0D 31C0                    	xor	ax, ax
  2191 00000A0F EBEE                    	jmp	short lff_3
  2192                                  
  2193                                  ; entry ds:ax points to last byte in file
  2194                                  ; cx = target size
  2195                                  ; note: must do byte size fill
  2196                                  ; destroys bx, cx
  2197                                  
  2198                                  padfill:
  2199                                  	; 14/12/2024
  2200                                  	; 17/11/2024
  2201                                  	;   di = offset (to be filled with ZEROs)
  2202                                  	;   bp = buffer segment
  2203                                  	;   ax = di = number of bytes loaded
  2204                                  	;   cx = buffer size (> loaded bytes)
  2205                                  	; 07/11/2023
  2206                                  	; 06/11/2023
  2207                                  	; 17/02/2017
  2208 00000A11 06                      	push	es
  2209                                          ;push	di
  2210                                  	;mov	di, [fbs_seg]
  2211                                  	;mov	es, di
  2212 00000A12 8EC5                            mov	es, bp
  2213 00000A14 29C1                    	sub	cx, ax
  2214                                  	; 08/11/2023
  2215                                  	;mov	di, ax ; (wrong)
  2216                                  	; 17/11/2024
  2217                                  	;mov	di, dx ; buffer offset
  2218                                  	;add	di, ax
  2219                                  	; 07/11/2023
  2220                                  	;add	di, [fbs_off]
  2221                                   	; 25/11/2024
  2222 00000A16 31C0                    	xor	ax, ax
  2223                                  	; 14/12/2024
  2224 00000A18 F3AA                    	rep	stosb
  2225                                  	;mov	[fbs_off], di
  2226                                  	;pop	di
  2227 00000A1A 07                              pop	es
  2228 00000A1B C3                      	retn
  2229                                  
  2230                                  ; /////
  2231                                  
  2232                                  ; --------------------------------------------------------
  2233                                  ; --------------------------------------------------------
  2234                                  	
  2235                                  write_audio_dev_info:
  2236                                  	; 30/05/2024
  2237                                       	sys_msg msgAudioCardInfo, 0Fh
    37 00000A1C BE[9221]            <1>  mov si, %1
    38 00000A1F B30F                <1>  mov bl, %2
    39 00000A21 30FF                <1>  xor bh, bh
    40 00000A23 B40E                <1>  mov ah, 0Eh
    41 00000A25 E870F9              <1>  call p_msg
  2238 00000A28 C3                      	retn
  2239                                  
  2240                                  ; --------------------------------------------------------
  2241                                  
  2242                                  write_ac97_pci_dev_info:
  2243                                  	; 01/01/2025 (cgaplay.asm)
  2244                                  	; 19/11/2024
  2245                                  	; 30/05/2024
  2246                                  	; 06/06/2017
  2247                                  	; 03/06/2017
  2248                                  	; BUS/DEV/FN
  2249                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  2250                                  	; DEV/VENDOR
  2251                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  2252                                  
  2253 00000A29 66A1[6A2A]              	mov	eax, [dev_vendor]
  2254 00000A2D 30FF                    	xor	bh, bh
  2255 00000A2F 88C3                    	mov	bl, al
  2256 00000A31 88DA                    	mov	dl, bl
  2257 00000A33 80E30F                  	and	bl, 0Fh
  2258 00000A36 8A87[9822]              	mov	al, [bx+hex_chars]
  2259 00000A3A A2[DF22]                	mov	[msgVendorId+3], al
  2260 00000A3D 88D3                    	mov	bl, dl
  2261 00000A3F C0EB04                  	shr	bl, 4
  2262 00000A42 8A87[9822]              	mov	al, [bx+hex_chars]
  2263 00000A46 A2[DE22]                	mov	[msgVendorId+2], al
  2264 00000A49 88E3                    	mov	bl, ah
  2265 00000A4B 88DA                    	mov	dl, bl
  2266 00000A4D 80E30F                  	and	bl, 0Fh
  2267 00000A50 8A87[9822]              	mov	al, [bx+hex_chars]
  2268 00000A54 A2[DD22]                	mov	[msgVendorId+1], al
  2269 00000A57 88D3                    	mov	bl, dl
  2270 00000A59 C0EB04                  	shr	bl, 4
  2271 00000A5C 8A87[9822]              	mov	al, [bx+hex_chars]
  2272 00000A60 A2[DC22]                	mov	[msgVendorId], al
  2273 00000A63 66C1E810                	shr	eax, 16
  2274 00000A67 88C3                    	mov	bl, al
  2275 00000A69 88DA                    	mov	dl, bl
  2276 00000A6B 80E30F                  	and	bl, 0Fh
  2277 00000A6E 8A87[9822]              	mov	al, [bx+hex_chars]
  2278 00000A72 A2[F022]                	mov	[msgDevId+3], al
  2279 00000A75 88D3                    	mov	bl, dl
  2280 00000A77 C0EB04                  	shr	bl, 4
  2281 00000A7A 8A87[9822]              	mov	al, [bx+hex_chars]
  2282 00000A7E A2[EF22]                	mov	[msgDevId+2], al
  2283 00000A81 88E3                    	mov	bl, ah
  2284 00000A83 88DA                    	mov	dl, bl
  2285 00000A85 80E30F                  	and	bl, 0Fh
  2286 00000A88 8A87[9822]              	mov	al, [bx+hex_chars]
  2287 00000A8C A2[EE22]                	mov	[msgDevId+1], al
  2288 00000A8F 88D3                    	mov	bl, dl
  2289 00000A91 C0EB04                  	shr	bl, 4
  2290 00000A94 8A87[9822]              	mov	al, [bx+hex_chars]
  2291 00000A98 A2[ED22]                	mov	[msgDevId], al
  2292                                  
  2293 00000A9B 66A1[662A]              	mov	eax, [bus_dev_fn]
  2294 00000A9F 66C1E808                	shr	eax, 8
  2295 00000AA3 88C3                    	mov	bl, al
  2296 00000AA5 88DA                    	mov	dl, bl
  2297 00000AA7 80E307                  	and	bl, 7 ; bit 0,1,2
  2298 00000AAA 8A87[9822]              	mov	al, [bx+hex_chars]
  2299 00000AAE A2[1523]                	mov	[msgFncNo+1], al
  2300 00000AB1 88D3                    	mov	bl, dl
  2301 00000AB3 C0EB03                  	shr	bl, 3
  2302 00000AB6 88DA                    	mov	dl, bl
  2303 00000AB8 80E30F                  	and	bl, 0Fh
  2304 00000ABB 8A87[9822]              	mov	al, [bx+hex_chars]
  2305 00000ABF A2[0723]                	mov	[msgDevNo+1], al
  2306 00000AC2 88D3                    	mov	bl, dl
  2307 00000AC4 C0EB04                  	shr	bl, 4
  2308 00000AC7 8A87[9822]              	mov	al, [bx+hex_chars]
  2309 00000ACB A2[0623]                	mov	[msgDevNo], al
  2310 00000ACE 88E3                    	mov	bl, ah
  2311 00000AD0 88DA                    	mov	dl, bl
  2312 00000AD2 80E30F                  	and	bl, 0Fh
  2313 00000AD5 8A87[9822]              	mov	al, [bx+hex_chars]
  2314 00000AD9 A2[FB22]                	mov	[msgBusNo+1], al
  2315 00000ADC 88D3                    	mov	bl, dl
  2316 00000ADE C0EB04                  	shr	bl, 4
  2317 00000AE1 8A87[9822]              	mov	al, [bx+hex_chars]
  2318 00000AE5 A2[FA22]                	mov	[msgBusNo], al
  2319                                  
  2320                                  	;mov	ax, [ac97_NamBar]
  2321 00000AE8 A1[6E2A]                	mov	ax, [NAMBAR]
  2322 00000AEB 88C3                    	mov	bl, al
  2323 00000AED 88DA                    	mov	dl, bl
  2324 00000AEF 80E30F                  	and	bl, 0Fh
  2325 00000AF2 8A87[9822]              	mov	al, [bx+hex_chars]
  2326 00000AF6 A2[2523]                	mov	[msgNamBar+3], al
  2327 00000AF9 88D3                    	mov	bl, dl
  2328 00000AFB C0EB04                  	shr	bl, 4
  2329 00000AFE 8A87[9822]              	mov	al, [bx+hex_chars]
  2330 00000B02 A2[2423]                	mov	[msgNamBar+2], al
  2331 00000B05 88E3                    	mov	bl, ah
  2332 00000B07 88DA                    	mov	dl, bl
  2333 00000B09 80E30F                  	and	bl, 0Fh
  2334 00000B0C 8A87[9822]              	mov	al, [bx+hex_chars]
  2335 00000B10 A2[2323]                	mov	[msgNamBar+1], al
  2336 00000B13 88D3                    	mov	bl, dl
  2337 00000B15 C0EB04                  	shr	bl, 4
  2338 00000B18 8A87[9822]              	mov	al, [bx+hex_chars]
  2339 00000B1C A2[2223]                	mov	[msgNamBar], al
  2340                                  
  2341                                  	;mov	ax, [ac97_NabmBar]
  2342 00000B1F A1[702A]                	mov	ax, [NABMBAR]
  2343 00000B22 88C3                    	mov	bl, al
  2344 00000B24 88DA                    	mov	dl, bl
  2345 00000B26 80E30F                  	and	bl, 0Fh
  2346 00000B29 8A87[9822]              	mov	al, [bx+hex_chars]
  2347 00000B2D A2[3523]                	mov	[msgNabmBar+3], al
  2348 00000B30 88D3                    	mov	bl, dl
  2349 00000B32 C0EB04                  	shr	bl, 4
  2350 00000B35 8A87[9822]              	mov	al, [bx+hex_chars]
  2351 00000B39 A2[3423]                	mov	[msgNabmBar+2], al
  2352 00000B3C 88E3                    	mov	bl, ah
  2353 00000B3E 88DA                    	mov	dl, bl
  2354 00000B40 80E30F                  	and	bl, 0Fh
  2355 00000B43 8A87[9822]              	mov	al, [bx+hex_chars]
  2356 00000B47 A2[3323]                	mov	[msgNabmBar+1], al
  2357 00000B4A 88D3                    	mov	bl, dl
  2358 00000B4C C0EB04                  	shr	bl, 4
  2359 00000B4F 8A87[9822]              	mov	al, [bx+hex_chars]
  2360 00000B53 A2[3223]                	mov	[msgNabmBar], al
  2361                                  
  2362 00000B56 6631C0                  	xor	eax, eax
  2363 00000B59 A0[0D2A]                	mov	al, [ac97_int_ln_reg]
  2364 00000B5C B10A                    	mov	cl, 10
  2365 00000B5E F6F1                    	div	cl
  2366                                  	; 23/11/2024
  2367                                  	;add	[msgIRQ], ax
  2368 00000B60 053030                  	add	ax, 3030h
  2369 00000B63 A3[3E23]                	mov	[msgIRQ], ax
  2370                                  	;and	al, al
  2371 00000B66 3C30                    	cmp	al, 30h
  2372 00000B68 7508                    	jnz	short _w_ac97imsg_
  2373 00000B6A A0[3F23]                	mov	al, byte [msgIRQ+1]
  2374 00000B6D B420                    	mov	ah, ' '
  2375 00000B6F A3[3E23]                	mov	[msgIRQ], ax
  2376                                  _w_ac97imsg_:
  2377                                  	; 19/11/2024
  2378 00000B72 E86515                  	call 	clear_window
  2379                                  	;mov	dh, 13
  2380                                  	; 01/01/2025 (video mode 13h)
  2381 00000B75 B60B                    	mov	dh, 11
  2382 00000B77 B200                    	mov	dl, 0
  2383 00000B79 E86A13                  	call	setCursorPosition
  2384                                  	;;;
  2385                                  	; 30/05/2024
  2386                                  	sys_msg msgAC97Info, 07h
    37 00000B7C BE[A922]            <1>  mov si, %1
    38 00000B7F B307                <1>  mov bl, %2
    39 00000B81 30FF                <1>  xor bh, bh
    40 00000B83 B40E                <1>  mov ah, 0Eh
    41 00000B85 E810F8              <1>  call p_msg
  2387                                  
  2388                                  	; 19/11/2024
  2389                                          ;retn
  2390                                  
  2391                                  	; 30/05/2024
  2392                                  write_VRA_info:
  2393                                  	sys_msg	msgVRAheader, 07h
    37 00000B88 BE[4323]            <1>  mov si, %1
    38 00000B8B B307                <1>  mov bl, %2
    39 00000B8D 30FF                <1>  xor bh, bh
    40 00000B8F B40E                <1>  mov ah, 0Eh
    41 00000B91 E804F8              <1>  call p_msg
  2394 00000B94 803E[DC29]00            	cmp	byte [VRA], 0
  2395 00000B99 760D                    	jna	short _w_VRAi_no
  2396                                  _w_VRAi_yes:
  2397                                  	sys_msg msgVRAyes, 07h
    37 00000B9B BE[5223]            <1>  mov si, %1
    38 00000B9E B307                <1>  mov bl, %2
    39 00000BA0 30FF                <1>  xor bh, bh
    40 00000BA2 B40E                <1>  mov ah, 0Eh
    41 00000BA4 E8F1F7              <1>  call p_msg
  2398 00000BA7 C3                      	retn
  2399                                  _w_VRAi_no:
  2400                                  	sys_msg msgVRAno, 07h
    37 00000BA8 BE[5823]            <1>  mov si, %1
    38 00000BAB B307                <1>  mov bl, %2
    39 00000BAD 30FF                <1>  xor bh, bh
    40 00000BAF B40E                <1>  mov ah, 0Eh
    41 00000BB1 E8E4F7              <1>  call p_msg
  2401 00000BB4 C3                      	retn
  2402                                  
  2403                                  ; --------------------------------------------------------
  2404                                  
  2405                                  ; 01/01/2025 - cgaplay.asm
  2406                                  ; 18/12/2024 - ac97play.asm
  2407                                  ; ----------
  2408                                  ; 30/05/2024 - playwav6.asm
  2409                                  ; 18/11/2023 - ich_wav3.asm & ich_wav4.asm
  2410                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  2411                                  ; 14/11/2023
  2412                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  2413                                  ; --------------------------------------------------------
  2414                                  
  2415                                  ;;Note:	At the end of every buffer load,
  2416                                  ;;	during buffer switch/swap, there will be discontinuity
  2417                                  ;;	between the last converted sample and the 1st sample
  2418                                  ;;	of the next buffer.
  2419                                  ;;	(like as a dot noises vaguely between normal sound samples)
  2420                                  ;;	-To avoid this defect, the 1st sample of
  2421                                  ;;	the next buffer may be read from the wav file but
  2422                                  ;;	the file pointer would need to be set to 1 sample back
  2423                                  ;;	again via seek system call. Time comsumption problem! -
  2424                                  ;;
  2425                                  ;;	Erdogan Tan - 15/11/2023
  2426                                  ;;
  2427                                  ;;	((If entire wav data would be loaded at once.. conversion
  2428                                  ;;	defect/noise would disappear.. but for DOS, to keep
  2429                                  ;;	64KB buffer limit is important also it is important
  2430                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  2431                                  ;;	I have tested this program by using 2-30MB wav files.))
  2432                                  ;;
  2433                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  2434                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  2435                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  2436                                  ;;			Realtek ALC850 codec.
  2437                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  2438                                  
  2439                                  load_8khz_mono_8_bit:
  2440                                  	; 15/11/2023
  2441                                  	; 14/11/2023
  2442                                  	; 13/11/2023
  2443 00000BB5 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  2444                                  					; last of the file?
  2445 00000BBA 7402                    	jz	short lff8m_0		; no
  2446 00000BBC F9                      	stc
  2447 00000BBD C3                      	retn
  2448                                  
  2449                                  lff8m_0:
  2450 00000BBE 8EC0                    	mov	es, ax ; buffer segment
  2451 00000BC0 31FF                    	xor	di, di
  2452 00000BC2 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  2453                                  	; ds = cs
  2454                                  
  2455                                  	; load file into memory
  2456 00000BC5 8B0E[7A2A]                      mov	cx, [loadsize]
  2457 00000BC9 8B1E[0E2A]              	mov	bx, [filehandle]
  2458 00000BCD B43F                           	mov	ah, 3Fh
  2459 00000BCF CD21                    	int	21h
  2460                                  	;jc	short lff8m_5 ; error !
  2461                                  	; 14/11/2023
  2462 00000BD1 7303                    	jnc	short lff8m_6
  2463 00000BD3 E98E00                  	jmp	lff8m_5
  2464                                  
  2465                                  lff8m_6:
  2466                                  	; 14/11/2024
  2467 00000BD6 A3[842A]                	mov	[count], ax
  2468                                  
  2469 00000BD9 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  2470 00000BDB 21C0                    	and	ax, ax
  2471                                  	;jz	short lff8m_3
  2472                                  	; 15/11/2023
  2473 00000BDD 747E                    	jz	short lff8_eof
  2474                                  
  2475 00000BDF 89C1                    	mov	cx, ax		; byte count
  2476                                  lff8m_1:
  2477 00000BE1 AC                      	lodsb
  2478 00000BE2 A2[031D]                	mov	[previous_val], al
  2479 00000BE5 2C80                    	sub	al, 80h
  2480 00000BE7 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2481 00000BEA AB                      	stosw		; original sample (left channel)
  2482 00000BEB AB                      	stosw		; original sample (right channel)
  2483                                  	;xor	ax, ax
  2484                                  	; 14/11/2023
  2485 00000BEC B080                    	mov	al, 80h
  2486 00000BEE 49                      	dec	cx
  2487 00000BEF 7402                    	jz	short lff8m_2
  2488 00000BF1 8A04                    	mov	al, [si]
  2489                                  lff8m_2:
  2490                                  	;mov	[next_val], ax
  2491 00000BF3 88C7                    	mov	bh, al	; [next_val]
  2492 00000BF5 8A26[031D]              	mov	ah, [previous_val]
  2493 00000BF9 00E0                    	add	al, ah	; [previous_val]
  2494 00000BFB D0D8                    	rcr	al, 1
  2495 00000BFD 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  2496 00000BFF 00E0                    	add	al, ah	; [previous_val]
  2497 00000C01 D0D8                    	rcr	al, 1
  2498 00000C03 88C3                    	mov	bl, al 	; this is temporary interpolation value	
  2499 00000C05 00E0                    	add	al, ah	; [previous_val]
  2500 00000C07 D0D8                    	rcr	al, 1
  2501 00000C09 2C80                    	sub	al, 80h
  2502 00000C0B C1E008                  	shl	ax, 8	
  2503 00000C0E AB                      	stosw		; this is 1st interpolated sample (L)
  2504 00000C0F AB                      	stosw		; this is 1st interpolated sample (R)
  2505 00000C10 88D8                    	mov	al, bl
  2506 00000C12 00D0                    	add	al, dl
  2507 00000C14 D0D8                    	rcr	al, 1
  2508 00000C16 2C80                    	sub	al, 80h
  2509 00000C18 C1E008                  	shl	ax, 8
  2510 00000C1B AB                      	stosw		; this is 2nd interpolated sample (L)
  2511 00000C1C AB                      	stosw		; this is 2nd interpolated sample (R)
  2512 00000C1D 88D0                    	mov	al, dl
  2513 00000C1F 2C80                    	sub	al, 80h
  2514 00000C21 C1E008                  	shl	ax, 8
  2515 00000C24 AB                      	stosw		; this is middle (3th) interpolated sample (L)
  2516 00000C25 AB                      	stosw		; this is middle (3th) interpolated sample (R)
  2517                                  	;mov	al, [next_val]
  2518 00000C26 88F8                    	mov	al, bh
  2519 00000C28 00D0                    	add	al, dl
  2520 00000C2A D0D8                    	rcr	al, 1
  2521 00000C2C 88C3                    	mov	bl, al	; this is temporary interpolation value
  2522 00000C2E 00D0                    	add	al, dl
  2523 00000C30 D0D8                    	rcr	al, 1
  2524 00000C32 2C80                    	sub	al, 80h
  2525 00000C34 C1E008                  	shl	ax, 8
  2526 00000C37 AB                      	stosw		; this is 4th interpolated sample (L)
  2527 00000C38 AB                      	stosw		; this is 4th interpolated sample (R)
  2528                                  	;mov	al, [next_val]
  2529 00000C39 88F8                    	mov	al, bh
  2530 00000C3B 00D8                    	add	al, bl
  2531 00000C3D D0D8                    	rcr	al, 1
  2532 00000C3F 2C80                    	sub	al, 80h
  2533 00000C41 C1E008                  	shl	ax, 8
  2534 00000C44 AB                      	stosw		; this is 5th interpolated sample (L)
  2535 00000C45 AB                      	stosw		; this is 5th interpolated sample (R)
  2536                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2537 00000C46 09C9                    	or	cx, cx
  2538 00000C48 7597                    	jnz	short lff8m_1
  2539                                  
  2540                                  	; --------------
  2541                                  
  2542                                  lff8s_3:
  2543                                  lff8m_3:
  2544                                  lff8s2_3:
  2545                                  lff8m2_3:
  2546                                  lff16s_3:
  2547                                  lff16m_3:
  2548                                  lff16s2_3:
  2549                                  lff16m2_3:
  2550                                  lff24_3:
  2551                                  lff32_3:
  2552                                  lff44_3:
  2553                                  lff22_3:
  2554                                  lff11_3:
  2555 00000C4A 8B0E[7C2A]              	mov	cx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  2556 00000C4E D1E1                    	shl	cx, 1	; byte count
  2557 00000C50 29F9                    	sub	cx, di
  2558 00000C52 7606                    	jna	short lff8m_4
  2559                                  	;inc	cx
  2560 00000C54 D1E9                    	shr	cx, 1
  2561 00000C56 31C0                    	xor	ax, ax	; fill (remain part of) buffer with zeros	
  2562 00000C58 F3AB                    	rep	stosw
  2563                                  lff8m_4:
  2564 00000C5A 0E                      	push	cs
  2565 00000C5B 07                      	pop	es
  2566 00000C5C C3                      	retn
  2567                                  
  2568                                  lff8_eof:
  2569                                  lff16_eof:
  2570                                  lff24_eof:
  2571                                  lff32_eof:
  2572                                  lff44_eof:
  2573                                  lff22_eof:
  2574                                  lff11_eof:
  2575                                  	; 15/11/2023
  2576 00000C5D C606[0C2A]01            	mov	byte [flags], ENDOFFILE
  2577 00000C62 EBE6                    	jmp	short lff8m_3
  2578                                  
  2579                                  lff8s_5:
  2580                                  lff8m_5:
  2581                                  lff8s2_5:
  2582                                  lff8m2_5:
  2583                                  lff16s_5:
  2584                                  lff16m_5:
  2585                                  lff16s2_5:
  2586                                  lff16m2_5:
  2587                                  lff24_5:
  2588                                  lff32_5:
  2589                                  lff44_5:
  2590                                  lff22_5:
  2591                                  lff11_5:
  2592 00000C64 B021                    	mov	al, '!'  ; error
  2593 00000C66 E8C5F8                  	call	tL0
  2594                                  	
  2595                                  	;jmp	short lff8m_3
  2596                                  	; 15/11/2023
  2597 00000C69 EBF2                    	jmp	lff8_eof
  2598                                  
  2599                                  	; --------------
  2600                                  
  2601                                  load_8khz_stereo_8_bit:
  2602                                  	; 15/11/2023
  2603                                  	; 14/11/2023
  2604                                  	; 13/11/2023
  2605 00000C6B F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  2606                                  					; last of the file?
  2607 00000C70 7402                    	jz	short lff8s_0		; no
  2608 00000C72 F9                      	stc
  2609 00000C73 C3                      	retn
  2610                                  
  2611                                  lff8s_0:
  2612 00000C74 8EC0                    	mov	es, ax ; buffer segment
  2613 00000C76 31FF                    	xor	di, di
  2614 00000C78 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  2615                                  	; ds = cs
  2616                                  
  2617                                  	; load file into memory
  2618 00000C7B 8B0E[7A2A]                      mov	cx, [loadsize]
  2619 00000C7F 8B1E[0E2A]              	mov	bx, [filehandle]
  2620 00000C83 B43F                           	mov	ah, 3Fh
  2621 00000C85 CD21                    	int	21h
  2622 00000C87 72DB                    	jc	short lff8s_5 ; error !
  2623                                  
  2624                                  	; 14/11/2024
  2625 00000C89 A3[842A]                	mov	[count], ax
  2626                                  
  2627 00000C8C 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  2628                                  	
  2629 00000C8E D1E8                    	shr	ax, 1
  2630                                  	;;and	ax, ax
  2631                                  	;jz	short lff8s_3
  2632                                  	; 15/11/2023
  2633 00000C90 74CB                    	jz	short lff8_eof
  2634                                  
  2635 00000C92 89C1                    	mov	cx, ax		; word count
  2636                                  lff8s_1:
  2637 00000C94 AC                      	lodsb
  2638 00000C95 A2[031D]                	mov	[previous_val_l], al
  2639 00000C98 2C80                    	sub	al, 80h
  2640 00000C9A C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2641 00000C9D AB                      	stosw		; original sample (L)
  2642 00000C9E AC                      	lodsb
  2643 00000C9F A2[051D]                	mov	[previous_val_r], al
  2644 00000CA2 2C80                    	sub	al, 80h
  2645 00000CA4 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2646 00000CA7 AB                      	stosw		; original sample (R)
  2647                                  
  2648                                  	;xor	ax, ax
  2649                                  	; 14/11/2023
  2650 00000CA8 B88080                  	mov	ax, 8080h
  2651 00000CAB 49                      	dec	cx
  2652 00000CAC 7402                    	jz	short lff8s_2
  2653                                  		; convert 8 bit sample to 16 bit sample
  2654 00000CAE 8B04                    	mov	ax, [si]
  2655                                  lff8s_2:
  2656 00000CB0 A2[071D]                	mov	[next_val_l], al
  2657 00000CB3 8826[091D]              	mov	[next_val_r], ah
  2658 00000CB7 8A26[031D]              	mov	ah, [previous_val_l]
  2659 00000CBB 00E0                    	add	al, ah
  2660 00000CBD D0D8                    	rcr	al, 1
  2661 00000CBF 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  2662 00000CC1 00E0                    	add	al, ah
  2663 00000CC3 D0D8                    	rcr	al, 1
  2664 00000CC5 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  2665 00000CC7 00E0                    	add	al, ah
  2666 00000CC9 D0D8                    	rcr	al, 1
  2667 00000CCB 2C80                    	sub	al, 80h
  2668 00000CCD C1E008                  	shl	ax, 8
  2669 00000CD0 AB                      	stosw		; this is 1st interpolated sample (L)
  2670 00000CD1 A0[091D]                	mov	al, [next_val_r]
  2671 00000CD4 8A26[051D]              	mov	ah, [previous_val_r]
  2672 00000CD8 00E0                    	add	al, ah
  2673 00000CDA D0D8                    	rcr	al, 1
  2674 00000CDC 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  2675 00000CDE 00E0                    	add	al, ah
  2676 00000CE0 D0D8                    	rcr	al, 1
  2677 00000CE2 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  2678 00000CE4 00E0                    	add	al, ah
  2679 00000CE6 D0D8                    	rcr	al, 1
  2680 00000CE8 2C80                    	sub	al, 80h
  2681 00000CEA C1E008                  	shl	ax, 8
  2682 00000CED AB                      	stosw		; this is 1st interpolated sample (R)
  2683 00000CEE 88D8                    	mov	al, bl
  2684 00000CF0 00D0                    	add	al, dl
  2685 00000CF2 D0D8                    	rcr	al, 1
  2686 00000CF4 2C80                    	sub	al, 80h
  2687 00000CF6 C1E008                  	shl	ax, 8
  2688 00000CF9 AB                      	stosw		; this is 2nd interpolated sample (L)
  2689 00000CFA 88F8                    	mov	al, bh
  2690 00000CFC 00F0                    	add	al, dh
  2691 00000CFE D0D8                    	rcr	al, 1
  2692 00000D00 2C80                    	sub	al, 80h
  2693 00000D02 C1E008                  	shl	ax, 8
  2694 00000D05 AB                      	stosw 		; this is 2nd interpolated sample (R)
  2695 00000D06 88D0                    	mov	al, dl
  2696 00000D08 2C80                    	sub	al, 80h
  2697 00000D0A C1E008                  	shl	ax, 8
  2698 00000D0D AB                      	stosw		; this is middle (3th) interpolated sample (L)
  2699 00000D0E 88F0                    	mov	al, dh
  2700 00000D10 2C80                    	sub	al, 80h
  2701 00000D12 C1E008                  	shl	ax, 8
  2702 00000D15 AB                      	stosw		; this is middle (3th) interpolated sample (R)
  2703 00000D16 A0[071D]                	mov	al, [next_val_l]
  2704 00000D19 00D0                    	add	al, dl
  2705 00000D1B D0D8                    	rcr	al, 1
  2706 00000D1D 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  2707 00000D1F 00D0                    	add	al, dl
  2708 00000D21 D0D8                    	rcr	al, 1
  2709 00000D23 2C80                    	sub	al, 80h
  2710 00000D25 C1E008                  	shl	ax, 8
  2711 00000D28 AB                      	stosw		; this is 4th interpolated sample (L)
  2712 00000D29 A0[091D]                	mov	al, [next_val_r]
  2713 00000D2C 00F0                    	add	al, dh
  2714 00000D2E D0D8                    	rcr	al, 1
  2715 00000D30 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  2716 00000D32 00F0                    	add	al, dh
  2717 00000D34 D0D8                    	rcr	al, 1
  2718 00000D36 2C80                    	sub	al, 80h
  2719 00000D38 C1E008                  	shl	ax, 8
  2720 00000D3B AB                      	stosw		; this is 4th interpolated sample (R)
  2721 00000D3C A0[071D]                	mov	al, [next_val_l]
  2722 00000D3F 00D8                    	add	al, bl
  2723 00000D41 D0D8                    	rcr	al, 1
  2724 00000D43 2C80                    	sub	al, 80h
  2725 00000D45 C1E008                  	shl	ax, 8
  2726 00000D48 AB                      	stosw		; this is 5th interpolated sample (L)
  2727 00000D49 A0[091D]                	mov	al, [next_val_r]
  2728 00000D4C 00F8                    	add	al, bh
  2729 00000D4E D0D8                    	rcr	al, 1
  2730 00000D50 2C80                    	sub	al, 80h
  2731 00000D52 C1E008                  	shl	ax, 8
  2732 00000D55 AB                      	stosw		; this is 5th interpolated sample (R)
  2733                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2734 00000D56 E303                    	jcxz	lff8s_6
  2735 00000D58 E939FF                  	jmp	lff8s_1
  2736                                  lff8s_6:
  2737 00000D5B E9ECFE                  	jmp	lff8s_3
  2738                                  
  2739                                  load_8khz_mono_16_bit:
  2740                                  	; 13/11/2023
  2741 00000D5E F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  2742                                  					; last of the file?
  2743 00000D63 7402                    	jz	short lff8m2_0		; no
  2744 00000D65 F9                      	stc
  2745 00000D66 C3                      	retn
  2746                                  
  2747                                  lff8m2_0:
  2748 00000D67 8EC0                    	mov	es, ax ; buffer segment
  2749 00000D69 31FF                    	xor	di, di
  2750 00000D6B BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  2751                                  	; ds = cs
  2752                                  
  2753                                  	; load file into memory
  2754 00000D6E 8B0E[7A2A]                      mov	cx, [loadsize]
  2755 00000D72 8B1E[0E2A]              	mov	bx, [filehandle]
  2756 00000D76 B43F                           	mov	ah, 3Fh
  2757 00000D78 CD21                    	int	21h
  2758 00000D7A 7273                    	jc	short lff8m2_7 ; error !
  2759                                  
  2760                                  	; 14/11/2024
  2761 00000D7C A3[842A]                	mov	[count], ax
  2762                                  
  2763 00000D7F 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  2764                                  	
  2765 00000D81 D1E8                    	shr	ax, 1
  2766                                  	;and	ax, ax
  2767 00000D83 7503                    	jnz	short lff8m2_8
  2768                                  	;jmp	lff8m2_3
  2769                                  	; 15/11/2023
  2770 00000D85 E9D5FE                  	jmp	lff8_eof
  2771                                  
  2772                                  lff8m2_8:
  2773 00000D88 89C1                    	mov	cx, ax		; word count
  2774                                  lff8m2_1:
  2775 00000D8A AD                      	lodsw
  2776 00000D8B AB                      	stosw		; original sample (left channel)
  2777 00000D8C AB                      	stosw		; original sample (right channel)
  2778 00000D8D 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  2779 00000D90 A3[031D]                	mov	[previous_val], ax
  2780 00000D93 31C0                    	xor	ax, ax
  2781 00000D95 49                      	dec	cx
  2782 00000D96 7402                    	jz	short lff8m2_2
  2783 00000D98 8B04                    	mov	ax, [si]
  2784                                  lff8m2_2:
  2785 00000D9A 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  2786 00000D9D 89C5                    	mov	bp, ax	; [next_val]
  2787 00000D9F 0306[031D]              	add	ax, [previous_val]
  2788 00000DA3 D1D8                    	rcr	ax, 1
  2789 00000DA5 89C2                    	mov	dx, ax	; this is interpolated middle (3th) sample
  2790 00000DA7 0306[031D]              	add	ax, [previous_val]
  2791 00000DAB D1D8                    	rcr	ax, 1	; this is temporary interpolation value
  2792 00000DAD 89C3                    	mov	bx, ax 		
  2793 00000DAF 0306[031D]              	add	ax, [previous_val]
  2794 00000DB3 D1D8                    	rcr	ax, 1
  2795 00000DB5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2796 00000DB8 AB                      	stosw		; this is 1st interpolated sample (L)
  2797 00000DB9 AB                      	stosw		; this is 1st interpolated sample (R)
  2798 00000DBA 89D8                    	mov	ax, bx
  2799 00000DBC 01D0                    	add	ax, dx
  2800 00000DBE D1D8                    	rcr	ax, 1
  2801 00000DC0 80EC80                  	sub	ah, 80h
  2802 00000DC3 AB                      	stosw		; this is 2nd interpolated sample (L)
  2803 00000DC4 AB                      	stosw		; this is 2nd interpolated sample (R)
  2804 00000DC5 89D0                    	mov	ax, dx
  2805 00000DC7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2806 00000DCA AB                      	stosw		; this is middle (3th) interpolated sample (L)
  2807 00000DCB AB                      	stosw		; this is middle (3th) interpolated sample (R)
  2808 00000DCC 89E8                    	mov	ax, bp
  2809 00000DCE 01D0                    	add	ax, dx
  2810 00000DD0 D1D8                    	rcr	ax, 1
  2811 00000DD2 89C3                    	mov	bx, ax	; this is temporary interpolation value
  2812 00000DD4 01D0                    	add	ax, dx
  2813 00000DD6 D1D8                    	rcr	ax, 1
  2814 00000DD8 80EC80                  	sub	ah, 80h
  2815 00000DDB AB                      	stosw		; this is 4th interpolated sample (L)
  2816 00000DDC AB                      	stosw		; this is 4th interpolated sample (R)
  2817 00000DDD 89E8                    	mov	ax, bp
  2818 00000DDF 01D8                    	add	ax, bx
  2819 00000DE1 D1D8                    	rcr	ax, 1
  2820 00000DE3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2821 00000DE6 AB                      	stosw		; this is 5th interpolated sample (L)
  2822 00000DE7 AB                      	stosw		; this is 5th interpolated sample (R)
  2823                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2824 00000DE8 09C9                    	or	cx, cx
  2825 00000DEA 759E                    	jnz	short lff8m2_1
  2826 00000DEC E95BFE                  	jmp	lff8m2_3
  2827                                  
  2828                                  lff8m2_7:
  2829                                  lff8s2_7:
  2830 00000DEF E972FE                  	jmp	lff8m2_5  ; error
  2831                                  
  2832                                  load_8khz_stereo_16_bit:
  2833                                  	; 16/11/2023
  2834                                  	; 15/11/2023
  2835                                  	; 13/11/2023
  2836 00000DF2 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  2837                                  					; last of the file?
  2838 00000DF7 7402                    	jz	short lff8s2_0		; no
  2839 00000DF9 F9                      	stc
  2840 00000DFA C3                      	retn
  2841                                  
  2842                                  lff8s2_0:
  2843 00000DFB 8EC0                    	mov	es, ax ; buffer segment
  2844 00000DFD 31FF                    	xor	di, di
  2845 00000DFF BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  2846                                  	; ds = cs
  2847                                  
  2848                                  	; load file into memory
  2849 00000E02 8B0E[7A2A]                      mov	cx, [loadsize]
  2850 00000E06 8B1E[0E2A]              	mov	bx, [filehandle]
  2851 00000E0A B43F                           	mov	ah, 3Fh
  2852 00000E0C CD21                    	int	21h
  2853 00000E0E 72DF                    	jc	short lff8s2_7 ; error !
  2854                                  
  2855                                  	; 14/11/2024
  2856 00000E10 A3[842A]                	mov	[count], ax
  2857                                  
  2858 00000E13 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  2859                                  	
  2860 00000E15 C1E802                  	shr	ax, 2	; 16/11/2023
  2861                                  	;and	ax, ax
  2862 00000E18 7503                    	jnz	short lff8s2_8
  2863                                  	;jmp	lff8s2_3
  2864                                  	; 15/11/2023
  2865 00000E1A E940FE                  	jmp	lff8_eof
  2866                                  
  2867                                  lff8s2_8:
  2868 00000E1D 89C1                    	mov	cx, ax ; dword count
  2869                                  lff8s2_1:
  2870 00000E1F AD                      	lodsw
  2871 00000E20 AB                      	stosw		; original sample (L)
  2872                                  	; 15/11/2023
  2873 00000E21 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  2874 00000E24 A3[031D]                	mov	[previous_val_l], ax
  2875 00000E27 AD                      	lodsw
  2876 00000E28 AB                      	stosw		; original sample (R)
  2877 00000E29 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  2878 00000E2C A3[051D]                	mov	[previous_val_r], ax
  2879 00000E2F 31D2                    	xor	dx, dx
  2880 00000E31 31C0                    	xor	ax, ax
  2881                                  	; 16/11/2023
  2882 00000E33 49                      	dec	cx
  2883 00000E34 7405                    	jz	short lff8s2_2
  2884 00000E36 8B04                    	mov	ax, [si]
  2885 00000E38 8B5402                  	mov	dx, [si+2]
  2886                                  lff8s2_2:
  2887 00000E3B 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  2888 00000E3E A3[071D]                	mov	[next_val_l], ax
  2889 00000E41 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  2890 00000E44 8916[091D]              	mov	[next_val_r], dx
  2891 00000E48 0306[031D]              	add	ax, [previous_val_l]
  2892 00000E4C D1D8                    	rcr	ax, 1
  2893 00000E4E 89C2                    	mov	dx, ax	; this is interpolated middle (3th) sample (L)
  2894 00000E50 0306[031D]              	add	ax, [previous_val_l]
  2895 00000E54 D1D8                    	rcr	ax, 1	
  2896 00000E56 89C3                    	mov	bx, ax 	; this is temporary interpolation value (L)
  2897 00000E58 0306[031D]              	add	ax, [previous_val_l]
  2898 00000E5C D1D8                    	rcr	ax, 1
  2899 00000E5E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2900 00000E61 AB                      	stosw		; this is 1st interpolated sample (L)
  2901 00000E62 A1[091D]                	mov	ax, [next_val_r]
  2902 00000E65 0306[051D]              	add	ax, [previous_val_r]
  2903 00000E69 D1D8                    	rcr	ax, 1
  2904 00000E6B 89C5                    	mov	bp, ax	; this is interpolated middle (3th) sample (R)
  2905 00000E6D 0306[051D]              	add	ax, [previous_val_r]
  2906 00000E71 D1D8                    	rcr	ax, 1
  2907 00000E73 50                      	push	ax ; *	; this is temporary interpolation value (R)
  2908 00000E74 0306[051D]              	add	ax, [previous_val_r]
  2909 00000E78 D1D8                    	rcr	ax, 1
  2910 00000E7A 80EC80                  	sub	ah, 80h
  2911 00000E7D AB                      	stosw		; this is 1st interpolated sample (R)
  2912 00000E7E 89D8                    	mov	ax, bx
  2913 00000E80 01D0                    	add	ax, dx
  2914 00000E82 D1D8                    	rcr	ax, 1
  2915 00000E84 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2916 00000E87 AB                      	stosw		; this is 2nd interpolated sample (L)
  2917 00000E88 58                      	pop	ax ; *
  2918 00000E89 01E8                    	add	ax, bp
  2919 00000E8B D1D8                    	rcr	ax, 1
  2920 00000E8D 80EC80                  	sub	ah, 80h
  2921 00000E90 AB                      	stosw 		; this is 2nd interpolated sample (R)
  2922 00000E91 89D0                    	mov	ax, dx
  2923 00000E93 80EC80                  	sub	ah, 80h
  2924 00000E96 AB                      	stosw		; this is middle (3th) interpolated sample (L)
  2925 00000E97 89E8                    	mov	ax, bp
  2926 00000E99 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2927 00000E9C AB                      	stosw		; this is middle (3th) interpolated sample (R)
  2928 00000E9D A1[071D]                	mov	ax, [next_val_l]
  2929 00000EA0 01D0                    	add	ax, dx
  2930 00000EA2 D1D8                    	rcr	ax, 1
  2931 00000EA4 89C3                    	mov	bx, ax	; this is temporary interpolation value (L)
  2932 00000EA6 01D0                    	add	ax, dx
  2933 00000EA8 D1D8                    	rcr	ax, 1
  2934 00000EAA 80EC80                  	sub	ah, 80h
  2935 00000EAD AB                      	stosw		; this is 4th interpolated sample (L)
  2936 00000EAE A1[091D]                	mov	ax, [next_val_r]
  2937 00000EB1 01E8                    	add	ax, bp
  2938 00000EB3 D1D8                    	rcr	ax, 1
  2939 00000EB5 50                      	push	ax ; ** ; this is temporary interpolation value (R)
  2940 00000EB6 01E8                    	add	ax, bp
  2941 00000EB8 D1D8                    	rcr	ax, 1
  2942 00000EBA 80EC80                  	sub	ah, 80h
  2943 00000EBD AB                      	stosw		; this is 4th interpolated sample (R)
  2944 00000EBE A1[071D]                	mov	ax, [next_val_l]
  2945 00000EC1 01D8                    	add	ax, bx
  2946 00000EC3 D1D8                    	rcr	ax, 1
  2947 00000EC5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2948 00000EC8 AB                      	stosw		; this is 5th interpolated sample (L)
  2949 00000EC9 58                      	pop	ax ; **
  2950 00000ECA 0306[091D]              	add	ax, [next_val_r]
  2951 00000ECE D1D8                    	rcr	ax, 1
  2952 00000ED0 80EC80                  	sub	ah, 80h
  2953 00000ED3 AB                      	stosw		; this is 5th interpolated sample (R)
  2954                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2955 00000ED4 E303                    	jcxz	lff8_s2_9
  2956 00000ED6 E946FF                  	jmp	lff8s2_1
  2957                                  lff8_s2_9:
  2958 00000ED9 E96EFD                  	jmp	lff8s2_3
  2959                                  
  2960                                  ; .....................
  2961                                  
  2962                                  load_16khz_mono_8_bit:
  2963                                  	; 14/11/2023
  2964                                  	; 13/11/2023
  2965 00000EDC F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  2966                                  					; last of the file?
  2967 00000EE1 7402                    	jz	short lff16m_0		; no
  2968 00000EE3 F9                      	stc
  2969 00000EE4 C3                      	retn
  2970                                  
  2971                                  lff16m_0:
  2972 00000EE5 8EC0                    	mov	es, ax ; buffer segment
  2973 00000EE7 31FF                    	xor	di, di
  2974 00000EE9 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  2975                                  	; ds = cs
  2976                                  
  2977                                  	; load file into memory
  2978 00000EEC 8B0E[7A2A]                      mov	cx, [loadsize]
  2979 00000EF0 8B1E[0E2A]              	mov	bx, [filehandle]
  2980 00000EF4 B43F                           	mov	ah, 3Fh
  2981 00000EF6 CD21                    	int	21h
  2982 00000EF8 7246                    	jc	short lff16m_7 ; error !
  2983                                  
  2984                                  	; 14/11/2024
  2985 00000EFA A3[842A]                	mov	[count], ax
  2986                                  
  2987 00000EFD 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  2988                                  	
  2989 00000EFF 21C0                    	and	ax, ax
  2990 00000F01 7503                    	jnz	short lff16m_8
  2991                                  	;jmp	lff16m_3
  2992                                  	; 15/11/2023
  2993 00000F03 E957FD                  	jmp	lff16_eof
  2994                                  
  2995                                  lff16m_8:
  2996 00000F06 89C1                    	mov	cx, ax		; byte count
  2997                                  lff16m_1:
  2998 00000F08 AC                      	lodsb
  2999                                  	;mov	[previous_val], al
  3000 00000F09 88C3                    	mov	bl, al
  3001 00000F0B 2C80                    	sub	al, 80h
  3002 00000F0D C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3003 00000F10 AB                      	stosw		; original sample (left channel)
  3004 00000F11 AB                      	stosw		; original sample (right channel)
  3005                                  	;xor	ax, ax
  3006                                  	; 14/11/22023
  3007 00000F12 B080                    	mov	al, 80h
  3008 00000F14 49                      	dec	cx
  3009 00000F15 7402                    	jz	short lff16m_2
  3010 00000F17 8A04                    	mov	al, [si]
  3011                                  lff16m_2:
  3012                                  	;mov	[next_val], al
  3013 00000F19 88C7                    	mov	bh, al
  3014                                  	;add	al, [previous_val]
  3015 00000F1B 00D8                    	add	al, bl
  3016 00000F1D D0D8                    	rcr	al, 1
  3017 00000F1F 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  3018                                  	;add	al, [previous_val]
  3019 00000F21 00D8                    	add	al, bl
  3020 00000F23 D0D8                    	rcr	al, 1
  3021 00000F25 2C80                    	sub	al, 80h
  3022 00000F27 C1E008                  	shl	ax, 8
  3023 00000F2A AB                      	stosw		; this is 1st interpolated sample (L)
  3024 00000F2B AB                      	stosw		; this is 1st interpolated sample (R)
  3025                                  	;mov	al, [next_val]
  3026 00000F2C 88F8                    	mov	al, bh
  3027 00000F2E 00D0                    	add	al, dl
  3028 00000F30 D0D8                    	rcr	al, 1
  3029 00000F32 2C80                    	sub	al, 80h
  3030 00000F34 C1E008                  	shl	ax, 8
  3031 00000F37 AB                      	stosw		; this is 2nd interpolated sample (L)
  3032 00000F38 AB                      	stosw		; this is 2nd interpolated sample (R)
  3033                                  	
  3034                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3035 00000F39 09C9                    	or	cx, cx
  3036 00000F3B 75CB                    	jnz	short lff16m_1
  3037 00000F3D E90AFD                  	jmp	lff16m_3
  3038                                  
  3039                                  lff16m_7:
  3040                                  lff16s_7:
  3041 00000F40 E921FD                  	jmp	lff16m_5  ; error
  3042                                  
  3043                                  load_16khz_stereo_8_bit:
  3044                                  	; 14/11/2023
  3045                                  	; 13/11/2023
  3046 00000F43 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  3047                                  					; last of the file?
  3048 00000F48 7402                    	jz	short lff16s_0		; no
  3049 00000F4A F9                      	stc
  3050 00000F4B C3                      	retn
  3051                                  
  3052                                  lff16s_0:
  3053 00000F4C 8EC0                    	mov	es, ax ; buffer segment
  3054 00000F4E 31FF                    	xor	di, di
  3055 00000F50 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  3056                                  	; ds = cs
  3057                                  
  3058                                  	; load file into memory
  3059 00000F53 8B0E[7A2A]                      mov	cx, [loadsize]
  3060 00000F57 8B1E[0E2A]              	mov	bx, [filehandle]
  3061 00000F5B B43F                           	mov	ah, 3Fh
  3062 00000F5D CD21                    	int	21h
  3063 00000F5F 72DF                    	jc	short lff16s_7 ; error !
  3064                                  
  3065                                  	; 14/11/2024
  3066 00000F61 A3[842A]                	mov	[count], ax
  3067                                  
  3068 00000F64 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  3069                                  	
  3070 00000F66 D1E8                    	shr	ax, 1
  3071                                  	;and	ax, ax
  3072 00000F68 7503                    	jnz	short lff16s_8
  3073                                  	;jmp	lff16s_3
  3074                                  	; 15/11/2023
  3075 00000F6A E9F0FC                  	jmp	lff16_eof
  3076                                  
  3077                                  lff16s_8:
  3078 00000F6D 89C1                    	mov	cx, ax		; word count
  3079                                  lff16s_1:
  3080 00000F6F AC                      	lodsb
  3081 00000F70 A2[031D]                	mov	[previous_val_l], al
  3082 00000F73 2C80                    	sub	al, 80h
  3083 00000F75 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3084 00000F78 AB                      	stosw		; original sample (L)
  3085 00000F79 AC                      	lodsb
  3086 00000F7A A2[051D]                	mov	[previous_val_r], al
  3087 00000F7D 2C80                    	sub	al, 80h
  3088 00000F7F C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3089 00000F82 AB                      	stosw		; original sample (R)
  3090                                  
  3091                                  	;xor	ax, ax
  3092                                  	; 14/11/2023
  3093 00000F83 B88080                  	mov	ax, 8080h
  3094 00000F86 49                      	dec	cx
  3095 00000F87 7402                    	jz	short lff16s_2
  3096                                  		; convert 8 bit sample to 16 bit sample
  3097 00000F89 8B04                    	mov	ax, [si]
  3098                                  lff16s_2:
  3099                                  	;mov	[next_val_l], al
  3100                                  	;mov	[next_val_r], ah
  3101 00000F8B 89C3                    	mov	bx, ax
  3102 00000F8D 0206[031D]              	add	al, [previous_val_l]
  3103 00000F91 D0D8                    	rcr	al, 1
  3104 00000F93 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  3105 00000F95 0206[031D]              	add	al, [previous_val_l]
  3106 00000F99 D0D8                    	rcr	al, 1
  3107 00000F9B 2C80                    	sub	al, 80h
  3108 00000F9D C1E008                  	shl	ax, 8
  3109 00000FA0 AB                      	stosw		; this is 1st interpolated sample (L)
  3110 00000FA1 88F8                    	mov	al, bh	; [next_val_r]
  3111 00000FA3 0206[051D]              	add	al, [previous_val_r]
  3112 00000FA7 D0D8                    	rcr	al, 1
  3113 00000FA9 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  3114 00000FAB 0206[051D]              	add	al, [previous_val_r]
  3115 00000FAF D0D8                    	rcr	al, 1
  3116 00000FB1 2C80                    	sub	al, 80h
  3117 00000FB3 C1E008                  	shl	ax, 8
  3118 00000FB6 AB                      	stosw		; this is 1st interpolated sample (R)
  3119 00000FB7 88D0                    	mov	al, dl
  3120 00000FB9 00D8                    	add	al, bl	; [next_val_l]
  3121 00000FBB D0D8                    	rcr	al, 1
  3122 00000FBD 2C80                    	sub	al, 80h
  3123 00000FBF C1E008                  	shl	ax, 8
  3124 00000FC2 AB                      	stosw		; this is 2nd interpolated sample (L)
  3125 00000FC3 88F0                    	mov	al, dh
  3126 00000FC5 00F8                    	add	al, bh	; [next_val_r]
  3127 00000FC7 D0D8                    	rcr	al, 1
  3128 00000FC9 2C80                    	sub	al, 80h
  3129 00000FCB C1E008                  	shl	ax, 8
  3130 00000FCE AB                      	stosw 		; this is 2nd interpolated sample (R)
  3131                                  	
  3132                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3133 00000FCF 09C9                    	or	cx, cx
  3134 00000FD1 759C                    	jnz	short lff16s_1
  3135 00000FD3 E974FC                  	jmp	lff16s_3
  3136                                  
  3137                                  load_16khz_mono_16_bit:
  3138                                  	; 15/11/2023
  3139                                  	; 13/11/2023
  3140 00000FD6 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  3141                                  					; last of the file?
  3142 00000FDB 7402                    	jz	short lff16m2_0		; no
  3143 00000FDD F9                      	stc
  3144 00000FDE C3                      	retn
  3145                                  
  3146                                  lff16m2_0:
  3147 00000FDF 8EC0                    	mov	es, ax ; buffer segment
  3148 00000FE1 31FF                    	xor	di, di
  3149 00000FE3 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  3150                                  	; ds = cs
  3151                                  
  3152                                  	; load file into memory
  3153 00000FE6 8B0E[7A2A]                      mov	cx, [loadsize]
  3154 00000FEA 8B1E[0E2A]              	mov	bx, [filehandle]
  3155 00000FEE B43F                           	mov	ah, 3Fh
  3156 00000FF0 CD21                    	int	21h
  3157 00000FF2 7243                    	jc	short lff16m2_7 ; error !
  3158                                  
  3159                                  	; 14/11/2024
  3160 00000FF4 A3[842A]                	mov	[count], ax
  3161                                  
  3162 00000FF7 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  3163                                  	
  3164 00000FF9 D1E8                    	shr	ax, 1
  3165                                  	;and	ax, ax
  3166 00000FFB 7503                    	jnz	short lff16m2_8
  3167                                  	;jmp	lff16m2_3
  3168                                  	; 15/11/2023
  3169 00000FFD E95DFC                  	jmp	lff16_eof
  3170                                  
  3171                                  lff16m2_8:
  3172 00001000 89C1                    	mov	cx, ax	; word count
  3173                                  lff16m2_1:
  3174 00001002 AD                      	lodsw
  3175 00001003 AB                      	stosw		; original sample (left channel)
  3176 00001004 AB                      	stosw		; original sample (right channel)
  3177 00001005 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3178                                  	;mov	[previous_val], ax
  3179 00001008 89C3                    	mov	bx, ax
  3180 0000100A 31C0                    	xor	ax, ax
  3181 0000100C 49                      	dec	cx
  3182 0000100D 7402                    	jz	short lff16m2_2
  3183 0000100F 8B04                    	mov	ax, [si]
  3184                                  lff16m2_2:
  3185 00001011 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3186 00001014 89C5                    	mov	bp, ax	; [next_val]
  3187                                  	;add	ax, [previous_val]
  3188 00001016 01D8                    	add	ax, bx
  3189 00001018 D1D8                    	rcr	ax, 1
  3190 0000101A 89C2                    	mov	dx, ax	; this is temporary interpolation value
  3191                                  	;add	ax, [previous_val]
  3192 0000101C 01D8                    	add	ax, bx
  3193 0000101E D1D8                    	rcr	ax, 1
  3194 00001020 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3195 00001023 AB                      	stosw		; this is 1st interpolated sample (L)
  3196 00001024 AB                      	stosw		; this is 1st interpolated sample (R)
  3197 00001025 89E8                    	mov	ax, bp 
  3198 00001027 01D0                    	add	ax, dx
  3199 00001029 D1D8                    	rcr	ax, 1
  3200 0000102B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3201 0000102E AB                      	stosw		; this is 2nd interpolated sample (L)
  3202 0000102F AB                      	stosw		; this is 2nd interpolated sample (R)
  3203                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3204 00001030 09C9                    	or	cx, cx
  3205 00001032 75CE                    	jnz	short lff16m2_1
  3206 00001034 E913FC                  	jmp	lff16m2_3
  3207                                  
  3208                                  lff16m2_7:
  3209                                  lff16s2_7:
  3210 00001037 E92AFC                  	jmp	lff16m2_5  ; error
  3211                                  
  3212                                  load_16khz_stereo_16_bit:
  3213                                  	; 16/11/2023
  3214                                  	; 15/11/2023
  3215                                  	; 13/11/2023
  3216 0000103A F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  3217                                  					; last of the file?
  3218 0000103F 7402                    	jz	short lff16s2_0		; no
  3219 00001041 F9                      	stc
  3220 00001042 C3                      	retn
  3221                                  
  3222                                  lff16s2_0:
  3223 00001043 8EC0                    	mov	es, ax ; buffer segment
  3224 00001045 31FF                    	xor	di, di
  3225 00001047 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  3226                                  	; ds = cs
  3227                                  
  3228                                  	; load file into memory
  3229 0000104A 8B0E[7A2A]                      mov	cx, [loadsize]
  3230 0000104E 8B1E[0E2A]              	mov	bx, [filehandle]
  3231 00001052 B43F                           	mov	ah, 3Fh
  3232 00001054 CD21                    	int	21h
  3233 00001056 72DF                    	jc	short lff16s2_7 ; error !
  3234                                  
  3235                                  	; 14/11/2024
  3236 00001058 A3[842A]                	mov	[count], ax
  3237                                  
  3238 0000105B 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  3239                                  	
  3240                                  	;shr	ax, 1
  3241 0000105D C1E802                  	shr	ax, 2	; 16/11/2023
  3242                                  	;and	ax, ax
  3243 00001060 7503                    	jnz	short lff16s2_8
  3244                                  	;jmp	lff16s2_3
  3245                                  	; 15/11/2023
  3246 00001062 E9F8FB                  	jmp	lff16_eof
  3247                                  
  3248                                  lff16s2_8:
  3249 00001065 89C1                    	mov	cx, ax		; dword count
  3250                                  lff16s2_1:
  3251 00001067 AD                      	lodsw
  3252 00001068 AB                      	stosw		; original sample (L)
  3253 00001069 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3254 0000106C A3[031D]                	mov	[previous_val_l], ax
  3255 0000106F AD                      	lodsw
  3256 00001070 AB                      	stosw		; original sample (R)
  3257 00001071 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3258 00001074 A3[051D]                	mov	[previous_val_r], ax
  3259 00001077 31D2                    	xor	dx, dx
  3260 00001079 31C0                    	xor	ax, ax
  3261                                  	; 16/11/2023
  3262 0000107B 49                      	dec	cx
  3263 0000107C 7405                    	jz	short lff16s2_2
  3264 0000107E 8B04                    	mov	ax, [si]
  3265 00001080 8B5402                  	mov	dx, [si+2]
  3266                                  lff16s2_2:
  3267 00001083 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3268                                  	;mov	[next_val_l], ax
  3269 00001086 89C5                    	mov	bp, ax
  3270 00001088 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  3271 0000108B 8916[091D]              	mov	[next_val_r], dx
  3272 0000108F 0306[031D]              	add	ax, [previous_val_l]
  3273 00001093 D1D8                    	rcr	ax, 1
  3274 00001095 89C2                    	mov	dx, ax	; this is temporary interpolation value (L)
  3275 00001097 0306[031D]              	add	ax, [previous_val_l]
  3276 0000109B D1D8                    	rcr	ax, 1
  3277 0000109D 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  3278 000010A0 AB                      	stosw		; this is 1st interpolated sample (L)
  3279 000010A1 A1[091D]                	mov	ax, [next_val_r]
  3280 000010A4 0306[051D]              	add	ax, [previous_val_r]
  3281 000010A8 D1D8                    	rcr	ax, 1
  3282 000010AA 89C3                    	mov	bx, ax	; this is temporary interpolation value (R)
  3283 000010AC 0306[051D]              	add	ax, [previous_val_r]
  3284 000010B0 D1D8                    	rcr	ax, 1
  3285 000010B2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3286 000010B5 AB                      	stosw		; this is 1st interpolated sample (R)
  3287                                  	;mov	ax, [next_val_l]
  3288 000010B6 89E8                    	mov	ax, bp
  3289 000010B8 01D0                    	add	ax, dx
  3290 000010BA D1D8                    	rcr	ax, 1
  3291 000010BC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3292 000010BF AB                      	stosw		; this is 2nd interpolated sample (L)
  3293 000010C0 A1[091D]                	mov	ax, [next_val_r]
  3294 000010C3 01D8                    	add	ax, bx
  3295 000010C5 D1D8                    	rcr	ax, 1
  3296 000010C7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3297 000010CA AB                      	stosw 		; this is 2nd interpolated sample (R)
  3298                                  	
  3299                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3300 000010CB 09C9                    	or	cx, cx
  3301 000010CD 7598                    	jnz	short lff16s2_1
  3302 000010CF E978FB                  	jmp	lff16s2_3
  3303                                  
  3304                                  ; .....................
  3305                                  
  3306                                  load_24khz_mono_8_bit:
  3307                                  	; 15/11/2023
  3308 000010D2 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  3309                                  					; last of the file?
  3310 000010D7 7402                    	jz	short lff24m_0		; no
  3311 000010D9 F9                      	stc
  3312 000010DA C3                      	retn
  3313                                  
  3314                                  lff24m_0:
  3315 000010DB 8EC0                    	mov	es, ax ; buffer segment
  3316 000010DD 31FF                    	xor	di, di
  3317 000010DF BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  3318                                  	; ds = cs
  3319                                  
  3320                                  	; load file into memory
  3321 000010E2 8B0E[7A2A]                      mov	cx, [loadsize]
  3322 000010E6 8B1E[0E2A]              	mov	bx, [filehandle]
  3323 000010EA B43F                           	mov	ah, 3Fh
  3324 000010EC CD21                    	int	21h
  3325 000010EE 7231                    	jc	short lff24m_7 ; error !
  3326                                  
  3327                                  	; 14/11/2024
  3328 000010F0 A3[842A]                	mov	[count], ax
  3329                                  
  3330 000010F3 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  3331                                  	
  3332 000010F5 21C0                    	and	ax, ax
  3333 000010F7 7503                    	jnz	short lff24m_8
  3334 000010F9 E961FB                  	jmp	lff24_eof
  3335                                  
  3336                                  lff24m_8:
  3337 000010FC 89C1                    	mov	cx, ax		; byte count
  3338                                  lff24m_1:
  3339 000010FE AC                      	lodsb
  3340                                  	;mov	[previous_val], al
  3341 000010FF 88C3                    	mov	bl, al
  3342 00001101 2C80                    	sub	al, 80h
  3343 00001103 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3344 00001106 AB                      	stosw		; original sample (left channel)
  3345 00001107 AB                      	stosw		; original sample (right channel)
  3346                                  	;xor	ax, ax
  3347 00001108 B080                    	mov	al, 80h
  3348 0000110A 49                      	dec	cx
  3349 0000110B 7402                    	jz	short lff24m_2
  3350 0000110D 8A04                    	mov	al, [si]
  3351                                  lff24m_2:
  3352                                  	;;mov	[next_val], al
  3353                                  	;mov	bh, al
  3354                                  	;add	al, [previous_val]
  3355 0000110F 00D8                    	add	al, bl
  3356 00001111 D0D8                    	rcr	al, 1
  3357 00001113 2C80                    	sub	al, 80h
  3358 00001115 C1E008                  	shl	ax, 8
  3359 00001118 AB                      	stosw		; this is interpolated sample (L)
  3360 00001119 AB                      	stosw		; this is interpolated sample (R)
  3361                                  	
  3362                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3363 0000111A 09C9                    	or	cx, cx
  3364 0000111C 75E0                    	jnz	short lff24m_1
  3365 0000111E E929FB                  	jmp	lff24_3
  3366                                  
  3367                                  lff24m_7:
  3368                                  lff24s_7:
  3369 00001121 E940FB                  	jmp	lff24_5  ; error
  3370                                  
  3371                                  load_24khz_stereo_8_bit:
  3372                                  	; 15/11/2023
  3373 00001124 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  3374                                  					; last of the file?
  3375 00001129 7402                    	jz	short lff24s_0		; no
  3376 0000112B F9                      	stc
  3377 0000112C C3                      	retn
  3378                                  
  3379                                  lff24s_0:
  3380 0000112D 8EC0                    	mov	es, ax ; buffer segment
  3381 0000112F 31FF                    	xor	di, di
  3382 00001131 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  3383                                  	; ds = cs
  3384                                  
  3385                                  	; load file into memory
  3386 00001134 8B0E[7A2A]                      mov	cx, [loadsize]
  3387 00001138 8B1E[0E2A]              	mov	bx, [filehandle]
  3388 0000113C B43F                           	mov	ah, 3Fh
  3389 0000113E CD21                    	int	21h
  3390 00001140 72DF                    	jc	short lff24s_7 ; error !
  3391                                  
  3392                                  	; 14/11/2024
  3393 00001142 A3[842A]                	mov	[count], ax
  3394                                  
  3395 00001145 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  3396                                  	
  3397 00001147 D1E8                    	shr	ax, 1
  3398                                  	;and	ax, ax
  3399 00001149 7503                    	jnz	short lff24s_8
  3400 0000114B E90FFB                  	jmp	lff24_eof
  3401                                  
  3402                                  lff24s_8:
  3403 0000114E 89C1                    	mov	cx, ax		; word count
  3404                                  lff24s_1:
  3405 00001150 AC                      	lodsb
  3406 00001151 A2[031D]                	mov	[previous_val_l], al
  3407 00001154 2C80                    	sub	al, 80h
  3408 00001156 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3409 00001159 AB                      	stosw		; original sample (L)
  3410 0000115A AC                      	lodsb
  3411 0000115B A2[051D]                	mov	[previous_val_r], al
  3412 0000115E 2C80                    	sub	al, 80h
  3413 00001160 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3414 00001163 AB                      	stosw		; original sample (R)
  3415                                  
  3416                                  	;xor	ax, ax
  3417 00001164 B88080                  	mov	ax, 8080h
  3418 00001167 49                      	dec	cx
  3419 00001168 7402                    	jz	short lff24s_2
  3420                                  		; convert 8 bit sample to 16 bit sample
  3421 0000116A 8B04                    	mov	ax, [si]
  3422                                  lff24s_2:
  3423                                  	;;mov	[next_val_l], al
  3424                                  	;;mov	[next_val_r], ah
  3425                                  	;mov	bx, ax
  3426 0000116C 88E7                    	mov	bh, ah
  3427 0000116E 0206[031D]              	add	al, [previous_val_l]
  3428 00001172 D0D8                    	rcr	al, 1
  3429                                  	;mov	dl, al
  3430 00001174 2C80                    	sub	al, 80h
  3431 00001176 C1E008                  	shl	ax, 8
  3432 00001179 AB                      	stosw		; this is interpolated sample (L)
  3433 0000117A 88F8                    	mov	al, bh	; [next_val_r]
  3434 0000117C 0206[051D]              	add	al, [previous_val_r]
  3435 00001180 D0D8                    	rcr	al, 1
  3436                                  	;mov	dh, al
  3437 00001182 2C80                    	sub	al, 80h
  3438 00001184 C1E008                  	shl	ax, 8
  3439 00001187 AB                      	stosw		; this is interpolated sample (R)
  3440                                  		
  3441                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3442 00001188 09C9                    	or	cx, cx
  3443 0000118A 75C4                    	jnz	short lff24s_1
  3444 0000118C E9BBFA                  	jmp	lff24_3
  3445                                  
  3446                                  load_24khz_mono_16_bit:
  3447                                  	; 15/11/2023
  3448 0000118F F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  3449                                  					; last of the file?
  3450 00001194 7402                    	jz	short lff24m2_0		; no
  3451 00001196 F9                      	stc
  3452 00001197 C3                      	retn
  3453                                  
  3454                                  lff24m2_0:
  3455 00001198 8EC0                    	mov	es, ax ; buffer segment
  3456 0000119A 31FF                    	xor	di, di
  3457 0000119C BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  3458                                  	; ds = cs
  3459                                  
  3460                                  	; load file into memory
  3461 0000119F 8B0E[7A2A]                      mov	cx, [loadsize]
  3462 000011A3 8B1E[0E2A]              	mov	bx, [filehandle]
  3463 000011A7 B43F                           	mov	ah, 3Fh
  3464 000011A9 CD21                    	int	21h
  3465 000011AB 722B                    	jc	short lff24m2_7 ; error !
  3466                                  
  3467                                  	; 14/11/2024
  3468 000011AD A3[842A]                	mov	[count], ax
  3469                                  
  3470 000011B0 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  3471                                  	
  3472 000011B2 D1E8                    	shr	ax, 1
  3473                                  	;and	ax, ax
  3474 000011B4 7503                    	jnz	short lff24m2_8
  3475 000011B6 E9A4FA                  	jmp	lff24_eof
  3476                                  
  3477                                  lff24m2_8:
  3478 000011B9 89C1                    	mov	cx, ax	; word count
  3479                                  lff24m2_1:
  3480 000011BB AD                      	lodsw
  3481 000011BC AB                      	stosw		; original sample (left channel)
  3482 000011BD AB                      	stosw		; original sample (right channel)
  3483 000011BE 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3484                                  	;mov	[previous_val], ax
  3485                                  	;mov	bx, ax
  3486                                  	;xor	ax, ax
  3487 000011C1 31DB                    	xor	bx, bx
  3488 000011C3 49                      	dec	cx
  3489 000011C4 7402                    	jz	short lff24m2_2
  3490                                  	;mov	ax, [si
  3491 000011C6 8B1C                    	mov	bx, [si]
  3492                                  lff24m2_2:
  3493                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  3494                                  	;mov	bp, ax	; [next_val]
  3495                                  	;add	ax, [previous_val]
  3496                                  	; ax = [previous_val]
  3497                                  	; bx = [next_val]
  3498 000011C8 01D8                    	add	ax, bx
  3499 000011CA D1D8                    	rcr	ax, 1
  3500 000011CC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3501 000011CF AB                      	stosw		; this is interpolated sample (L)
  3502 000011D0 AB                      	stosw		; this is interpolated sample (R)
  3503                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3504 000011D1 09C9                    	or	cx, cx
  3505 000011D3 75E6                    	jnz	short lff24m2_1
  3506 000011D5 E972FA                  	jmp	lff24_3
  3507                                  
  3508                                  lff24m2_7:
  3509                                  lff24s2_7:
  3510 000011D8 E989FA                  	jmp	lff24_5  ; error
  3511                                  
  3512                                  load_24khz_stereo_16_bit:
  3513                                  	; 16/11/2023
  3514                                  	; 15/11/2023
  3515 000011DB F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  3516                                  					; last of the file?
  3517 000011E0 7402                    	jz	short lff24s2_0		; no
  3518 000011E2 F9                      	stc
  3519 000011E3 C3                      	retn
  3520                                  
  3521                                  lff24s2_0:
  3522 000011E4 8EC0                    	mov	es, ax ; buffer segment
  3523 000011E6 31FF                    	xor	di, di
  3524 000011E8 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  3525                                  	; ds = cs
  3526                                  
  3527                                  	; load file into memory
  3528 000011EB 8B0E[7A2A]                      mov	cx, [loadsize]
  3529 000011EF 8B1E[0E2A]              	mov	bx, [filehandle]
  3530 000011F3 B43F                           	mov	ah, 3Fh
  3531 000011F5 CD21                    	int	21h
  3532 000011F7 72DF                    	jc	short lff24s2_7 ; error !
  3533                                  
  3534                                  	; 14/11/2024
  3535 000011F9 A3[842A]                	mov	[count], ax
  3536                                  
  3537 000011FC 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  3538                                  	
  3539                                  	;shr	ax, 1
  3540 000011FE C1E802                  	shr	ax, 2	; 16/11/2023
  3541                                  	;and	ax, ax
  3542 00001201 7503                    	jnz	short lff24s2_8
  3543 00001203 E957FA                  	jmp	lff24_eof
  3544                                  
  3545                                  lff24s2_8:
  3546 00001206 89C1                    	mov	cx, ax		; dword count
  3547                                  lff24s2_1:
  3548 00001208 AD                      	lodsw
  3549 00001209 AB                      	stosw		; original sample (L)
  3550 0000120A 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3551 0000120D A3[031D]                	mov	[previous_val_l], ax
  3552 00001210 AD                      	lodsw
  3553 00001211 AB                      	stosw		; original sample (R)
  3554 00001212 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3555                                  	;mov	[previous_val_r], ax
  3556 00001215 89C3                    	mov	bx, ax
  3557 00001217 31D2                    	xor	dx, dx
  3558 00001219 31C0                    	xor	ax, ax
  3559                                  	; 16/11/2023
  3560 0000121B 49                      	dec	cx
  3561 0000121C 7405                    	jz	short lff24s2_2
  3562 0000121E 8B04                    	mov	ax, [si]
  3563 00001220 8B5402                  	mov	dx, [si+2]
  3564                                  lff24s2_2:
  3565 00001223 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3566                                  	;;mov	[next_val_l], ax
  3567                                  	;mov	bp, ax
  3568 00001226 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  3569                                  	;mov	[next_val_r], dx
  3570 00001229 0306[031D]              	add	ax, [previous_val_l]
  3571 0000122D D1D8                    	rcr	ax, 1
  3572 0000122F 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  3573 00001232 AB                      	stosw		; this is interpolated sample (L)
  3574                                  	;mov	ax, [next_val_r]
  3575 00001233 89D0                    	mov	ax, dx
  3576                                  	;add	ax, [previous_val_r]
  3577 00001235 01D8                    	add	ax, bx
  3578 00001237 D1D8                    	rcr	ax, 1
  3579 00001239 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3580 0000123C AB                      	stosw		; this is interpolated sample (R)
  3581                                  	
  3582                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3583 0000123D 09C9                    	or	cx, cx
  3584 0000123F 75C7                    	jnz	short lff24s2_1
  3585 00001241 E906FA                  	jmp	lff24_3
  3586                                  
  3587                                  ; .....................
  3588                                  
  3589                                  load_32khz_mono_8_bit:
  3590                                  	; 15/11/2023
  3591 00001244 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  3592                                  					; last of the file?
  3593 00001249 7402                    	jz	short lff32m_0		; no
  3594 0000124B F9                      	stc
  3595 0000124C C3                      	retn
  3596                                  
  3597                                  lff32m_0:
  3598 0000124D 8EC0                    	mov	es, ax ; buffer segment
  3599 0000124F 31FF                    	xor	di, di
  3600 00001251 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  3601                                  	; ds = cs
  3602                                  
  3603                                  	; load file into memory
  3604 00001254 8B0E[7A2A]                      mov	cx, [loadsize]
  3605 00001258 8B1E[0E2A]              	mov	bx, [filehandle]
  3606 0000125C B43F                           	mov	ah, 3Fh
  3607 0000125E CD21                    	int	21h
  3608 00001260 723A                    	jc	short lff32m_7 ; error !
  3609                                  
  3610                                  	; 14/11/2024
  3611 00001262 A3[842A]                	mov	[count], ax
  3612                                  
  3613 00001265 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  3614                                  	
  3615 00001267 21C0                    	and	ax, ax
  3616 00001269 7503                    	jnz	short lff32m_8
  3617 0000126B E9EFF9                  	jmp	lff32_eof
  3618                                  
  3619                                  lff32m_8:
  3620 0000126E 89C1                    	mov	cx, ax		; byte count
  3621                                  lff32m_1:
  3622 00001270 AC                      	lodsb
  3623                                  	;mov	[previous_val], al
  3624 00001271 88C3                    	mov	bl, al
  3625 00001273 2C80                    	sub	al, 80h
  3626 00001275 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3627 00001278 AB                      	stosw		; original sample (left channel)
  3628 00001279 AB                      	stosw		; original sample (right channel)
  3629                                  	;xor	ax, ax
  3630 0000127A B080                    	mov	al, 80h
  3631 0000127C 49                      	dec	cx
  3632 0000127D 7402                    	jz	short lff32m_2
  3633 0000127F 8A04                    	mov	al, [si]
  3634                                  lff32m_2:
  3635                                  	;;mov	[next_val], al
  3636                                  	;mov	bh, al
  3637                                  	;add	al, [previous_val]
  3638 00001281 00D8                    	add	al, bl
  3639 00001283 D0D8                    	rcr	al, 1
  3640 00001285 2C80                    	sub	al, 80h
  3641 00001287 C1E008                  	shl	ax, 8
  3642 0000128A AB                      	stosw		; this is interpolated sample (L)
  3643 0000128B AB                      	stosw		; this is interpolated sample (R)
  3644                                  	
  3645                                  	; different than 8-16-24 kHZ !
  3646                                  	; 'original-interpolated-original' trio samples 
  3647 0000128C E30B                    	jcxz	lff32m_3
  3648                                  
  3649 0000128E AC                      	lodsb
  3650 0000128F 2C80                    	sub	al, 80h
  3651 00001291 C1E008                  	shl	ax, 8
  3652 00001294 AB                      	stosw		; original sample (left channel)
  3653 00001295 AB                      	stosw		; original sample (right channel)
  3654                                  
  3655                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3656 00001296 49                      	dec	cx
  3657 00001297 75D7                    	jnz	short lff32m_1
  3658                                  lff32m_3:
  3659 00001299 E9AEF9                  	jmp	lff32_3
  3660                                  
  3661                                  lff32m_7:
  3662                                  lff32s_7:
  3663 0000129C E9C5F9                  	jmp	lff32_5  ; error
  3664                                  
  3665                                  load_32khz_stereo_8_bit:
  3666                                  	; 15/11/2023
  3667 0000129F F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  3668                                  					; last of the file?
  3669 000012A4 7402                    	jz	short lff32s_0		; no
  3670 000012A6 F9                      	stc
  3671 000012A7 C3                      	retn
  3672                                  
  3673                                  lff32s_0:
  3674 000012A8 8EC0                    	mov	es, ax ; buffer segment
  3675 000012AA 31FF                    	xor	di, di
  3676 000012AC BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  3677                                  	; ds = cs
  3678                                  
  3679                                  	; load file into memory
  3680 000012AF 8B0E[7A2A]                      mov	cx, [loadsize]
  3681 000012B3 8B1E[0E2A]              	mov	bx, [filehandle]
  3682 000012B7 B43F                           	mov	ah, 3Fh
  3683 000012B9 CD21                    	int	21h
  3684 000012BB 72DF                    	jc	short lff32s_7 ; error !
  3685                                  
  3686                                  	; 14/11/2024
  3687 000012BD A3[842A]                	mov	[count], ax
  3688                                  
  3689 000012C0 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  3690                                  	
  3691 000012C2 D1E8                    	shr	ax, 1
  3692                                  	;and	ax, ax
  3693 000012C4 7503                    	jnz	short lff32s_8
  3694 000012C6 E994F9                  	jmp	lff32_eof
  3695                                  
  3696                                  lff32s_8:
  3697 000012C9 89C1                    	mov	cx, ax		; word count
  3698                                  lff32s_1:
  3699 000012CB AC                      	lodsb
  3700 000012CC A2[031D]                	mov	[previous_val_l], al
  3701 000012CF 2C80                    	sub	al, 80h
  3702 000012D1 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3703 000012D4 AB                      	stosw		; original sample (L)
  3704 000012D5 AC                      	lodsb
  3705 000012D6 A2[051D]                	mov	[previous_val_r], al
  3706 000012D9 2C80                    	sub	al, 80h
  3707 000012DB C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3708 000012DE AB                      	stosw		; original sample (R)
  3709                                  
  3710                                  	;xor	ax, ax
  3711 000012DF B88080                  	mov	ax, 8080h
  3712 000012E2 49                      	dec	cx
  3713 000012E3 7402                    	jz	short lff32s_2
  3714                                  		; convert 8 bit sample to 16 bit sample
  3715 000012E5 8B04                    	mov	ax, [si]
  3716                                  lff32s_2:
  3717                                  	;;mov	[next_val_l], al
  3718                                  	;;mov	[next_val_r], ah
  3719                                  	;mov	bx, ax
  3720 000012E7 88E7                    	mov	bh, ah
  3721 000012E9 0206[031D]              	add	al, [previous_val_l]
  3722 000012ED D0D8                    	rcr	al, 1
  3723                                  	;mov	dl, al
  3724 000012EF 2C80                    	sub	al, 80h
  3725 000012F1 C1E008                  	shl	ax, 8
  3726 000012F4 AB                      	stosw		; this is interpolated sample (L)
  3727 000012F5 88F8                    	mov	al, bh	; [next_val_r]
  3728 000012F7 0206[051D]              	add	al, [previous_val_r]
  3729 000012FB D0D8                    	rcr	al, 1
  3730                                  	;mov	dh, al
  3731 000012FD 2C80                    	sub	al, 80h
  3732 000012FF C1E008                  	shl	ax, 8
  3733 00001302 AB                      	stosw		; this is interpolated sample (R)
  3734                                  
  3735                                  	; different than 8-16-24 kHZ !
  3736                                  	; 'original-interpolated-original' trio samples 
  3737 00001303 E311                    	jcxz	lff32s_3
  3738                                  
  3739 00001305 AC                      	lodsb
  3740 00001306 2C80                    	sub	al, 80h
  3741 00001308 C1E008                  	shl	ax, 8
  3742 0000130B AB                      	stosw		; original sample (left channel)
  3743                                  
  3744 0000130C AC                      	lodsb
  3745 0000130D 2C80                    	sub	al, 80h
  3746 0000130F C1E008                  	shl	ax, 8
  3747 00001312 AB                      	stosw		; original sample (right channel)
  3748                                  		
  3749                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3750 00001313 49                      	dec	cx
  3751 00001314 75B5                    	jnz	short lff32s_1
  3752                                  lff32s_3:
  3753 00001316 E931F9                  	jmp	lff32_3
  3754                                  
  3755                                  load_32khz_mono_16_bit:
  3756                                  	; 15/11/2023
  3757 00001319 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  3758                                  					; last of the file?
  3759 0000131E 7402                    	jz	short lff32m2_0		; no
  3760 00001320 F9                      	stc
  3761 00001321 C3                      	retn
  3762                                  
  3763                                  lff32m2_0:
  3764 00001322 8EC0                    	mov	es, ax ; buffer segment
  3765 00001324 31FF                    	xor	di, di
  3766 00001326 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  3767                                  	; ds = cs
  3768                                  
  3769                                  	; load file into memory
  3770 00001329 8B0E[7A2A]                      mov	cx, [loadsize]
  3771 0000132D 8B1E[0E2A]              	mov	bx, [filehandle]
  3772 00001331 B43F                           	mov	ah, 3Fh
  3773 00001333 CD21                    	int	21h
  3774 00001335 722F                    	jc	short lff32m2_7 ; error !
  3775                                  
  3776                                  	; 14/11/2024
  3777 00001337 A3[842A]                	mov	[count], ax
  3778                                  
  3779 0000133A 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  3780                                  	
  3781 0000133C D1E8                    	shr	ax, 1
  3782                                  	;and	ax, ax
  3783 0000133E 7503                    	jnz	short lff32m2_8
  3784 00001340 E91AF9                  	jmp	lff32_eof
  3785                                  
  3786                                  lff32m2_8:
  3787 00001343 89C1                    	mov	cx, ax	; word count
  3788                                  lff32m2_1:
  3789 00001345 AD                      	lodsw
  3790 00001346 AB                      	stosw		; original sample (left channel)
  3791 00001347 AB                      	stosw		; original sample (right channel)
  3792 00001348 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3793                                  	;mov	[previous_val], ax
  3794                                  	;mov	bx, ax
  3795                                  	;xor	ax, ax
  3796 0000134B 31DB                    	xor	bx, bx
  3797 0000134D 49                      	dec	cx
  3798 0000134E 7402                    	jz	short lff32m2_2
  3799                                  	;mov	ax, [si
  3800 00001350 8B1C                    	mov	bx, [si]
  3801                                  lff32m2_2:
  3802                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  3803                                  	;mov	bp, ax	; [next_val]
  3804                                  	;add	ax, [previous_val]
  3805                                  	; ax = [previous_val]
  3806                                  	; bx = [next_val]
  3807 00001352 01D8                    	add	ax, bx
  3808 00001354 D1D8                    	rcr	ax, 1
  3809 00001356 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3810 00001359 AB                      	stosw		; this is interpolated sample (L)
  3811 0000135A AB                      	stosw		; this is interpolated sample (R)
  3812                                  
  3813                                  	; different than 8-16-24 kHZ !
  3814                                  	; 'original-interpolated-original' trio samples 
  3815 0000135B E306                    	jcxz	lff32m2_3
  3816                                  
  3817 0000135D AD                      	lodsw
  3818 0000135E AB                      	stosw		; original sample (left channel)
  3819 0000135F AB                      	stosw		; original sample (right channel)
  3820                                  
  3821                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3822 00001360 49                      	dec	cx
  3823 00001361 75E2                    	jnz	short lff32m2_1
  3824                                  lff32m2_3:
  3825 00001363 E9E4F8                  	jmp	lff32_3
  3826                                  
  3827                                  lff32m2_7:
  3828                                  lff32s2_7:
  3829 00001366 E9FBF8                  	jmp	lff32_5  ; error
  3830                                  
  3831                                  load_32khz_stereo_16_bit:
  3832                                  	 ;16/11/2023
  3833                                  	; 15/11/2023
  3834 00001369 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  3835                                  					; last of the file?
  3836 0000136E 7402                    	jz	short lff32s2_0		; no
  3837 00001370 F9                      	stc
  3838 00001371 C3                      	retn
  3839                                  
  3840                                  lff32s2_0:
  3841 00001372 8EC0                    	mov	es, ax ; buffer segment
  3842 00001374 31FF                    	xor	di, di
  3843 00001376 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  3844                                  	; ds = cs
  3845                                  
  3846                                  	; load file into memory
  3847 00001379 8B0E[7A2A]                      mov	cx, [loadsize]
  3848 0000137D 8B1E[0E2A]              	mov	bx, [filehandle]
  3849 00001381 B43F                           	mov	ah, 3Fh
  3850 00001383 CD21                    	int	21h
  3851 00001385 72DF                    	jc	short lff32s2_7 ; error !
  3852                                  
  3853 00001387 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  3854                                  	
  3855 00001389 C1E802                  	shr	ax, 2	; 16/11/2023 (word left ch + word right ch)
  3856                                  	;and	ax, ax
  3857 0000138C 7503                    	jnz	short lff32s2_8
  3858 0000138E E9CCF8                  	jmp	lff32_eof
  3859                                  
  3860                                  lff32s2_8:
  3861 00001391 89C1                    	mov	cx, ax		; dword count
  3862                                  lff32s2_1:
  3863 00001393 AD                      	lodsw
  3864 00001394 AB                      	stosw		; original sample (L)
  3865 00001395 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3866 00001398 A3[031D]                	mov	[previous_val_l], ax
  3867 0000139B AD                      	lodsw
  3868 0000139C AB                      	stosw		; original sample (R)
  3869 0000139D 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3870                                  	;mov	[previous_val_r], ax
  3871 000013A0 89C3                    	mov	bx, ax
  3872 000013A2 31D2                    	xor	dx, dx
  3873 000013A4 31C0                    	xor	ax, ax
  3874                                  	; 16/11/2023
  3875 000013A6 49                      	dec	cx
  3876 000013A7 7405                    	jz	short lff32s2_2
  3877 000013A9 8B04                    	mov	ax, [si]
  3878 000013AB 8B5402                  	mov	dx, [si+2]
  3879                                  lff32s2_2:
  3880 000013AE 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3881                                  	;;mov	[next_val_l], ax
  3882                                  	;mov	bp, ax
  3883 000013B1 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  3884                                  	;mov	[next_val_r], dx
  3885 000013B4 0306[031D]              	add	ax, [previous_val_l]
  3886 000013B8 D1D8                    	rcr	ax, 1
  3887 000013BA 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  3888 000013BD AB                      	stosw		; this is interpolated sample (L)
  3889                                  	;mov	ax, [next_val_r]
  3890 000013BE 89D0                    	mov	ax, dx
  3891                                  	;add	ax, [previous_val_r]
  3892 000013C0 01D8                    	add	ax, bx
  3893 000013C2 D1D8                    	rcr	ax, 1
  3894 000013C4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3895 000013C7 AB                      	stosw		; this is interpolated sample (R)
  3896                                  
  3897                                  	; different than 8-16-24 kHZ !
  3898                                  	; 'original-interpolated-original' trio samples
  3899 000013C8 E307                    	jcxz	lff32s2_3
  3900                                  
  3901 000013CA AD                      	lodsw
  3902 000013CB AB                      	stosw	; original sample (L)
  3903 000013CC AD                      	lodsw
  3904 000013CD AB                      	stosw	; original sample (R)
  3905                                  	
  3906                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3907 000013CE 49                      	dec	cx
  3908 000013CF 75C2                    	jnz	short lff32s2_1
  3909                                  lff32s2_3:
  3910 000013D1 E976F8                  	jmp	lff32_3
  3911                                  
  3912                                  ; .....................
  3913                                  
  3914                                  load_22khz_mono_8_bit:
  3915                                  	; 16/11/2023
  3916 000013D4 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  3917                                  					; last of the file?
  3918 000013D9 7402                    	jz	short lff22m_0		; no
  3919 000013DB F9                      	stc
  3920 000013DC C3                      	retn
  3921                                  
  3922                                  lff22m_0:
  3923 000013DD 8EC0                    	mov	es, ax ; buffer segment
  3924 000013DF 31FF                    	xor	di, di
  3925 000013E1 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  3926                                  	; ds = cs
  3927                                  
  3928                                  	; load file into memory
  3929 000013E4 8B0E[7A2A]                      mov	cx, [loadsize]
  3930 000013E8 8B1E[0E2A]              	mov	bx, [filehandle]
  3931 000013EC B43F                           	mov	ah, 3Fh
  3932 000013EE CD21                    	int	21h
  3933 000013F0 724B                    	jc	short lff22m_7 ; error !
  3934                                  
  3935                                  	; 14/11/2024
  3936 000013F2 A3[842A]                	mov	[count], ax
  3937                                  
  3938 000013F5 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  3939                                  	
  3940 000013F7 21C0                    	and	ax, ax
  3941 000013F9 7503                    	jnz	short lff22m_8
  3942 000013FB E95FF8                  	jmp	lff22_eof
  3943                                  
  3944                                  lff22m_8:
  3945 000013FE 89C1                    	mov	cx, ax		; byte count
  3946                                  lff22m_9:
  3947 00001400 BD0500                  	mov	bp, 5 ; interpolation (one step) loop count
  3948 00001403 C606[0B1D]03            	mov	byte [faz], 3  ; 3 steps/phases
  3949                                  lff22m_1:
  3950                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  3951 00001408 AC                      	lodsb
  3952 00001409 B280                    	mov	dl, 80h
  3953 0000140B 49                      	dec	cx
  3954 0000140C 7402                    	jz	short lff22m_2_1
  3955 0000140E 8A14                    	mov	dl, [si]
  3956                                  lff22m_2_1:	
  3957                                  	; al = [previous_val]
  3958                                  	; dl = [next_val]
  3959 00001410 E8C104                  	call	interpolating_3_8bit_mono ; 1 of 17
  3960 00001413 E325                    	jcxz	lff22m_3
  3961                                  lff22m_2_2:
  3962 00001415 AC                      	lodsb
  3963 00001416 B280                    	mov	dl, 80h
  3964 00001418 49                      	dec	cx
  3965 00001419 7402                    	jz	short lff22m_2_3
  3966 0000141B 8A14                    	mov	dl, [si]
  3967                                  lff22m_2_3:
  3968 0000141D E82305                   	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  3969 00001420 E318                    	jcxz	lff22m_3
  3970 00001422 4D                      	dec	bp
  3971 00001423 75F0                    	jnz	short lff22m_2_2
  3972                                  
  3973 00001425 A0[0B1D]                	mov	al, [faz]
  3974 00001428 FEC8                    	dec	al
  3975 0000142A 74D4                    	jz	short lff22m_9
  3976 0000142C FE0E[0B1D]              	dec	byte [faz]
  3977 00001430 BD0400                  	mov	bp, 4
  3978 00001433 FEC8                    	dec	al
  3979 00001435 75D1                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  3980 00001437 45                      	inc	bp ; 5
  3981 00001438 EBCE                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  3982                                  
  3983                                  lff22m_3:
  3984                                  lff22s_3:
  3985 0000143A E90DF8                  	jmp	lff22_3	; padfill
  3986                                  		; (put zeros in the remain words of the buffer)
  3987                                  lff22m_7:
  3988                                  lff22s_7:
  3989 0000143D E924F8                  	jmp	lff22_5  ; error
  3990                                  
  3991                                  load_22khz_stereo_8_bit:
  3992                                  	; 16/11/2023
  3993 00001440 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  3994                                  					; last of the file?
  3995 00001445 7402                    	jz	short lff22s_0		; no
  3996 00001447 F9                      	stc
  3997 00001448 C3                      	retn
  3998                                  
  3999                                  lff22s_0:
  4000 00001449 8EC0                    	mov	es, ax ; buffer segment
  4001 0000144B 31FF                    	xor	di, di
  4002 0000144D BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  4003                                  	; ds = cs
  4004                                  
  4005                                  	; load file into memory
  4006 00001450 8B0E[7A2A]                      mov	cx, [loadsize]
  4007 00001454 8B1E[0E2A]              	mov	bx, [filehandle]
  4008 00001458 B43F                           	mov	ah, 3Fh
  4009 0000145A CD21                    	int	21h
  4010 0000145C 72DF                    	jc	short lff22s_7 ; error !
  4011                                  
  4012                                  	; 14/11/2024
  4013 0000145E A3[842A]                	mov	[count], ax
  4014                                  
  4015 00001461 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  4016                                  	
  4017 00001463 D1E8                    	shr	ax, 1
  4018                                  	;and	ax, ax
  4019 00001465 7503                    	jnz	short lff22s_8
  4020 00001467 E9F3F7                  	jmp	lff22_eof
  4021                                  
  4022                                  lff22s_8:
  4023 0000146A 89C1                    	mov	cx, ax		; word count
  4024                                  lff22s_9:
  4025 0000146C BD0500                  	mov	bp, 5 ; interpolation (one step) loop count
  4026 0000146F C606[0B1D]03            	mov	byte [faz], 3  ; 3 steps/phase
  4027                                  lff22s_1:
  4028                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4029 00001474 AD                      	lodsw
  4030 00001475 BA8080                  	mov	dx, 8080h
  4031 00001478 49                      	dec	cx
  4032 00001479 7402                    	jz	short lff22s_2_1 
  4033 0000147B 8B14                    	mov	dx, [si]
  4034                                  lff22s_2_1:	
  4035                                  	; al = [previous_val_l]
  4036                                  	; ah = [previous_val_r]
  4037                                  	; dl = [next_val_l]
  4038                                  	; dl = [next_val_r]	
  4039 0000147D E87C04                  	call	interpolating_3_8bit_stereo ; 1 of 17 
  4040 00001480 E3B8                    	jcxz	lff22s_3
  4041                                  lff22s_2_2:
  4042 00001482 AD                      	lodsw
  4043 00001483 BA8080                  	mov	dx, 8080h
  4044 00001486 49                      	dec	cx
  4045 00001487 7402                    	jz	short lff22s_2_3
  4046 00001489 8B14                    	mov	dx, [si]
  4047                                  lff22s_2_3:
  4048 0000148B E8CC04                   	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  4049 0000148E E3AA                    	jcxz	lff22s_3
  4050 00001490 4D                      	dec	bp
  4051 00001491 75EF                    	jnz	short lff22s_2_2
  4052                                  
  4053 00001493 A0[0B1D]                	mov	al, [faz]
  4054 00001496 FEC8                    	dec	al
  4055 00001498 74D2                    	jz	short lff22s_9
  4056 0000149A FE0E[0B1D]              	dec	byte [faz]
  4057 0000149E BD0400                  	mov	bp, 4
  4058 000014A1 FEC8                    	dec	al
  4059 000014A3 75CF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  4060 000014A5 45                      	inc	bp ; 5
  4061 000014A6 EBCC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4062                                  
  4063                                  load_22khz_mono_16_bit:
  4064                                  	; 16/11/2023
  4065 000014A8 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  4066                                  					; last of the file?
  4067 000014AD 7402                    	jz	short lff22m2_0		; no
  4068 000014AF F9                      	stc
  4069 000014B0 C3                      	retn
  4070                                  
  4071                                  lff22m2_0:
  4072 000014B1 8EC0                    	mov	es, ax ; buffer segment
  4073 000014B3 31FF                    	xor	di, di
  4074 000014B5 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  4075                                  	; ds = cs
  4076                                  
  4077                                  	; load file into memory
  4078 000014B8 8B0E[7A2A]                      mov	cx, [loadsize]
  4079 000014BC 8B1E[0E2A]              	mov	bx, [filehandle]
  4080 000014C0 B43F                           	mov	ah, 3Fh
  4081 000014C2 CD21                    	int	21h
  4082 000014C4 724B                    	jc	short lff22m2_7 ; error !
  4083                                  
  4084                                  	; 14/11/2024
  4085 000014C6 A3[842A]                	mov	[count], ax
  4086                                  
  4087 000014C9 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  4088                                  	
  4089 000014CB D1E8                    	shr	ax, 1
  4090                                  	;and	ax, ax
  4091 000014CD 7503                    	jnz	short lff22m2_8
  4092 000014CF E98BF7                  	jmp	lff22_eof
  4093                                  
  4094                                  lff22m2_8:
  4095 000014D2 89C1                    	mov	cx, ax		; word count
  4096                                  lff22m2_9:
  4097 000014D4 BD0500                  	mov	bp, 5 ; interpolation (one step) loop count
  4098 000014D7 C606[0B1D]03            	mov	byte [faz], 3  ; 3 steps/phases
  4099                                  lff22m2_1:
  4100                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4101 000014DC AD                      	lodsw
  4102 000014DD 31D2                    	xor	dx, dx
  4103 000014DF 49                      	dec	cx
  4104 000014E0 7402                    	jz	short lff22m2_2_1
  4105 000014E2 8B14                    	mov	dx, [si]
  4106                                  lff22m2_2_1:	
  4107                                  	; ax = [previous_val]
  4108                                  	; dx = [next_val]
  4109 000014E4 E89C04                  	call	interpolating_3_16bit_mono ; 1 of 17
  4110 000014E7 E325                    	jcxz	lff22m2_3
  4111                                  lff22m2_2_2:
  4112 000014E9 AD                      	lodsw
  4113 000014EA 31D2                    	xor	dx, dx
  4114 000014EC 49                      	dec	cx
  4115 000014ED 7402                    	jz	short lff22m2_2_3
  4116 000014EF 8B14                    	mov	dx, [si]
  4117                                  lff22m2_2_3:
  4118 000014F1 E8FC04                   	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  4119 000014F4 E318                    	jcxz	lff22m2_3
  4120 000014F6 4D                      	dec	bp
  4121 000014F7 75F0                    	jnz	short lff22m2_2_2
  4122                                  
  4123 000014F9 A0[0B1D]                	mov	al, [faz]
  4124 000014FC FEC8                    	dec	al
  4125 000014FE 74D4                    	jz	short lff22m2_9
  4126 00001500 FE0E[0B1D]              	dec	byte [faz]
  4127 00001504 BD0400                  	mov	bp, 4
  4128 00001507 FEC8                    	dec	al
  4129 00001509 75D1                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  4130 0000150B 45                      	inc	bp ; 5
  4131 0000150C EBCE                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4132                                  
  4133                                  lff22m2_3:
  4134                                  lff22s2_3:
  4135 0000150E E939F7                  	jmp	lff22_3	; padfill
  4136                                  		; (put zeros in the remain words of the buffer)
  4137                                  lff22m2_7:
  4138                                  lff22s2_7:
  4139 00001511 E950F7                  	jmp	lff22_5  ; error
  4140                                  
  4141                                  load_22khz_stereo_16_bit:
  4142                                  	; 16/11/2023
  4143 00001514 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  4144                                  					; last of the file?
  4145 00001519 7402                    	jz	short lff22s2_0		; no
  4146 0000151B F9                      	stc
  4147 0000151C C3                      	retn
  4148                                  
  4149                                  lff22s2_0:
  4150 0000151D 8EC0                    	mov	es, ax ; buffer segment
  4151 0000151F 31FF                    	xor	di, di
  4152 00001521 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  4153                                  	; ds = cs
  4154                                  
  4155                                  	; load file into memory
  4156 00001524 8B0E[7A2A]                      mov	cx, [loadsize]
  4157 00001528 8B1E[0E2A]              	mov	bx, [filehandle]
  4158 0000152C B43F                           	mov	ah, 3Fh
  4159 0000152E CD21                    	int	21h
  4160 00001530 72DF                    	jc	short lff22s2_7 ; error !
  4161                                  
  4162                                  	; 14/11/2024
  4163 00001532 A3[842A]                	mov	[count], ax
  4164                                  
  4165 00001535 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  4166                                  	
  4167 00001537 C1E802                  	shr	ax, 2	; dword (left chan word + right chan word)
  4168                                  	;and	ax, ax
  4169 0000153A 7503                    	jnz	short lff22s2_8
  4170 0000153C E91EF7                  	jmp	lff22_eof
  4171                                  
  4172                                  lff22s2_8:
  4173 0000153F 89C1                    	mov	cx, ax		; dword count
  4174                                  lff22s2_9:
  4175 00001541 BD0500                  	mov	bp, 5 ; interpolation (one step) loop count
  4176 00001544 C606[0B1D]03            	mov	byte [faz], 3  ; 3 steps/phase
  4177                                  lff22s2_1:
  4178                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4179 00001549 AD                      	lodsw
  4180 0000154A 89C3                    	mov	bx, ax
  4181 0000154C AD                      	lodsw
  4182 0000154D 8B14                    	mov	dx, [si]
  4183 0000154F 8916[071D]              	mov	[next_val_l], dx
  4184 00001553 8B5402                  	mov	dx, [si+2]
  4185 00001556 49                      	dec	cx
  4186 00001557 7506                    	jnz	short lff22s2_2_1
  4187 00001559 31D2                    	xor	dx, dx ; 0
  4188 0000155B 8916[071D]              	mov	[next_val_l], dx
  4189                                  lff22s2_2_1:
  4190                                  	; bx = [previous_val_l]
  4191                                  	; ax = [previous_val_r]
  4192                                  	; [next_val_l]
  4193                                  	; dx = [next_val_r]
  4194 0000155F E84504                  	call	interpolating_3_16bit_stereo ; 1 of 17 
  4195 00001562 E3AA                    	jcxz	lff22s2_3
  4196                                  lff22s2_2_2:
  4197 00001564 AD                      	lodsw
  4198 00001565 89C3                    	mov	bx, ax
  4199 00001567 AD                      	lodsw
  4200 00001568 8B14                    	mov	dx, [si]
  4201 0000156A 8916[071D]              	mov	[next_val_l], dx
  4202 0000156E 8B5402                  	mov	dx, [si+2]
  4203 00001571 49                      	dec	cx
  4204 00001572 7506                    	jnz	short lff22s2_2_3
  4205 00001574 31D2                    	xor	dx, dx ; 0
  4206 00001576 8916[071D]              	mov	[next_val_l], dx
  4207                                  lff22s2_2_3:
  4208 0000157A E88504                   	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  4209 0000157D E38F                    	jcxz	lff22s2_3
  4210 0000157F 4D                      	dec	bp
  4211 00001580 75E2                    	jnz	short lff22s2_2_2
  4212                                  
  4213 00001582 A0[0B1D]                	mov	al, [faz]
  4214 00001585 FEC8                    	dec	al
  4215 00001587 74B8                    	jz	short lff22s2_9
  4216 00001589 FE0E[0B1D]              	dec	byte [faz]
  4217 0000158D BD0400                  	mov	bp, 4
  4218 00001590 FEC8                    	dec	al
  4219 00001592 75B5                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  4220 00001594 45                      	inc	bp ; 5
  4221 00001595 EBB2                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4222                                  
  4223                                  ; .....................
  4224                                  
  4225                                  load_11khz_mono_8_bit:
  4226                                  	; 18/11/2023
  4227 00001597 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  4228                                  					; last of the file?
  4229 0000159C 7402                    	jz	short lff11m_0		; no
  4230 0000159E F9                      	stc
  4231 0000159F C3                      	retn
  4232                                  
  4233                                  lff11m_0:
  4234 000015A0 8EC0                    	mov	es, ax ; buffer segment
  4235 000015A2 31FF                    	xor	di, di
  4236 000015A4 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  4237                                  	; ds = cs
  4238                                  
  4239                                  	; load file into memory
  4240 000015A7 8B0E[7A2A]                      mov	cx, [loadsize]
  4241 000015AB 8B1E[0E2A]              	mov	bx, [filehandle]
  4242 000015AF B43F                           	mov	ah, 3Fh
  4243 000015B1 CD21                    	int	21h
  4244 000015B3 7240                    	jc	short lff11m_7 ; error !
  4245                                  
  4246                                  	; 14/11/2024
  4247 000015B5 A3[842A]                	mov	[count], ax
  4248                                  
  4249 000015B8 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  4250                                  	
  4251 000015BA 21C0                    	and	ax, ax
  4252 000015BC 7503                    	jnz	short lff11m_8
  4253 000015BE E99CF6                  	jmp	lff11_eof
  4254                                  
  4255                                  lff11m_8:
  4256 000015C1 89C1                    	mov	cx, ax		; byte count
  4257                                  lff11m_9:
  4258 000015C3 BD0600                  	mov	bp, 6 ; interpolation (one step) loop count
  4259                                  lff11m_1:
  4260                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4261 000015C6 AC                      	lodsb
  4262 000015C7 B280                    	mov	dl, 80h
  4263 000015C9 49                      	dec	cx
  4264 000015CA 7402                    	jz	short lff11m_2_1
  4265 000015CC 8A14                    	mov	dl, [si]
  4266                                  lff11m_2_1:	
  4267                                  	; al = [previous_val]
  4268                                  	; dl = [next_val]
  4269 000015CE E85704                  	call	interpolating_5_8bit_mono
  4270 000015D1 E31F                    	jcxz	lff11m_3
  4271                                  lff11m_2_2:
  4272 000015D3 AC                      	lodsb
  4273 000015D4 B280                    	mov	dl, 80h
  4274 000015D6 49                      	dec	cx
  4275 000015D7 7402                    	jz	short lff11m_2_3
  4276 000015D9 8A14                    	mov	dl, [si]
  4277                                  lff11m_2_3:
  4278 000015DB E83305                   	call	interpolating_4_8bit_mono
  4279 000015DE E312                    	jcxz	lff11m_3
  4280                                  
  4281 000015E0 4D                      	dec	bp
  4282 000015E1 74E0                    	jz	short lff11m_9
  4283                                  
  4284 000015E3 AC                      	lodsb
  4285 000015E4 B280                    	mov	dl, 80h
  4286 000015E6 49                      	dec	cx
  4287 000015E7 7402                    	jz	short lff11m_2_4
  4288 000015E9 8A14                    	mov	dl, [si]
  4289                                  lff11m_2_4:
  4290 000015EB E82305                  	call	interpolating_4_8bit_mono
  4291 000015EE E302                    	jcxz	lff11m_3
  4292 000015F0 EBD4                    	jmp	short lff11m_1
  4293                                  
  4294                                  lff11m_3:
  4295                                  lff11s_3:
  4296 000015F2 E955F6                  	jmp	lff11_3	; padfill
  4297                                  		; (put zeros in the remain words of the buffer)
  4298                                  lff11m_7:
  4299                                  lff11s_7:
  4300 000015F5 E96CF6                  	jmp	lff11_5  ; error
  4301                                  
  4302                                  load_11khz_stereo_8_bit:
  4303                                  	; 18/11/2023
  4304 000015F8 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  4305                                  					; last of the file?
  4306 000015FD 7402                    	jz	short lff11s_0		; no
  4307 000015FF F9                      	stc
  4308 00001600 C3                      	retn
  4309                                  
  4310                                  lff11s_0:
  4311 00001601 8EC0                    	mov	es, ax ; buffer segment
  4312 00001603 31FF                    	xor	di, di
  4313 00001605 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  4314                                  	; ds = cs
  4315                                  
  4316                                  	; load file into memory
  4317 00001608 8B0E[7A2A]                      mov	cx, [loadsize]
  4318 0000160C 8B1E[0E2A]              	mov	bx, [filehandle]
  4319 00001610 B43F                           	mov	ah, 3Fh
  4320 00001612 CD21                    	int	21h
  4321 00001614 72DF                    	jc	short lff11s_7 ; error !
  4322                                  
  4323                                  	; 14/11/2024
  4324 00001616 A3[842A]                	mov	[count], ax
  4325                                  
  4326 00001619 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  4327                                  	
  4328 0000161B D1E8                    	shr	ax, 1
  4329                                  	;and	ax, ax
  4330 0000161D 7503                    	jnz	short lff11s_8
  4331 0000161F E93BF6                  	jmp	lff11_eof
  4332                                  
  4333                                  lff11s_8:
  4334 00001622 89C1                    	mov	cx, ax		; word count
  4335                                  lff11s_9:
  4336 00001624 BD0600                  	mov	bp, 6 ; interpolation (one step) loop count
  4337                                  lff11s_1:
  4338                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4339 00001627 AD                      	lodsw
  4340 00001628 BA8080                  	mov	dx, 8080h
  4341 0000162B 49                      	dec	cx
  4342 0000162C 7402                    	jz	short lff11s_2_1
  4343 0000162E 8B14                    	mov	dx, [si]
  4344                                  lff11s_2_1:	
  4345                                  	; al = [previous_val_l]
  4346                                  	; ah = [previous_val_r]
  4347                                  	; dl = [next_val_l]
  4348                                  	; dl = [next_val_r]
  4349 00001630 E84504                  	call	interpolating_5_8bit_stereo
  4350 00001633 E3BD                    	jcxz	lff11s_3
  4351                                  lff11s_2_2:
  4352 00001635 AD                      	lodsw
  4353 00001636 BA8080                  	mov	dx, 8080h
  4354 00001639 49                      	dec	cx
  4355 0000163A 7402                    	jz	short lff11s_2_3
  4356 0000163C 8B14                    	mov	dx, [si]
  4357                                  lff11s_2_3:
  4358 0000163E E80305                   	call	interpolating_4_8bit_stereo
  4359 00001641 E3AF                    	jcxz	lff11s_3
  4360                                  	
  4361 00001643 4D                      	dec	bp
  4362 00001644 74DE                    	jz	short lff11s_9
  4363                                  
  4364 00001646 AD                      	lodsw
  4365 00001647 BA8080                  	mov	dx, 8080h
  4366 0000164A 49                      	dec	cx
  4367 0000164B 7402                    	jz	short lff11s_2_4
  4368 0000164D 8B14                    	mov	dx, [si]
  4369                                  lff11s_2_4:
  4370 0000164F E8F204                  	call	interpolating_4_8bit_stereo
  4371 00001652 E39E                    	jcxz	lff11s_3
  4372 00001654 EBD1                    	jmp	short lff11s_1
  4373                                  
  4374                                  load_11khz_mono_16_bit:
  4375                                  	; 18/11/2023
  4376 00001656 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  4377                                  					; last of the file?
  4378 0000165B 7402                    	jz	short lff11m2_0		; no
  4379 0000165D F9                      	stc
  4380 0000165E C3                      	retn
  4381                                  
  4382                                  lff11m2_0:
  4383 0000165F 8EC0                    	mov	es, ax ; buffer segment
  4384 00001661 31FF                    	xor	di, di
  4385 00001663 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  4386                                  	; ds = cs
  4387                                  
  4388                                  	; load file into memory
  4389 00001666 8B0E[7A2A]                      mov	cx, [loadsize]
  4390 0000166A 8B1E[0E2A]              	mov	bx, [filehandle]
  4391 0000166E B43F                           	mov	ah, 3Fh
  4392 00001670 CD21                    	int	21h
  4393 00001672 723D                    	jc	short lff11m2_7 ; error !
  4394                                  
  4395                                  	; 14/11/2024
  4396 00001674 A3[842A]                	mov	[count], ax
  4397                                  
  4398 00001677 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  4399                                  	
  4400 00001679 D1E8                    	shr	ax, 1
  4401                                  	;and	ax, ax
  4402 0000167B 7503                    	jnz	short lff11m2_8
  4403 0000167D E9DDF5                  	jmp	lff11_eof
  4404                                  
  4405                                  lff11m2_8:
  4406 00001680 89C1                    	mov	cx, ax		; word count
  4407                                  lff11m2_9:
  4408 00001682 BD0600                  	mov	bp, 6 ; interpolation (one step) loop count
  4409                                  lff11m2_1:
  4410                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4411 00001685 AD                      	lodsw
  4412 00001686 31D2                    	xor	dx, dx
  4413 00001688 49                      	dec	cx
  4414 00001689 7402                    	jz	short lff11m2_2_1
  4415 0000168B 8B14                    	mov	dx, [si]
  4416                                  lff11m2_2_1:	
  4417                                  	; ax = [previous_val]
  4418                                  	; dx = [next_val]
  4419 0000168D E81105                  	call	interpolating_5_16bit_mono
  4420 00001690 E34D                    	jcxz	lff11m2_3
  4421                                  lff11m2_2_2:
  4422 00001692 AD                      	lodsw
  4423 00001693 31D2                    	xor	dx, dx
  4424 00001695 49                      	dec	cx
  4425 00001696 7402                    	jz	short lff11m2_2_3
  4426 00001698 8B14                    	mov	dx, [si]
  4427                                  lff11m2_2_3:
  4428 0000169A E8DF05                   	call	interpolating_4_16bit_mono
  4429 0000169D E340                    	jcxz	lff11m2_3
  4430                                  
  4431 0000169F 4D                      	dec	bp
  4432 000016A0 74E0                    	jz	short lff11m2_9
  4433                                  
  4434 000016A2 AD                      	lodsw
  4435 000016A3 31D2                    	xor	dx, dx
  4436 000016A5 49                      	dec	cx
  4437 000016A6 7402                    	jz	short lff11m2_2_4
  4438 000016A8 8B14                    	mov	dx, [si]
  4439                                  lff11m2_2_4:
  4440 000016AA E8CF05                   	call	interpolating_4_16bit_mono
  4441 000016AD E330                    	jcxz	lff11m2_3
  4442 000016AF EBD4                    	jmp	short lff11m2_1
  4443                                  
  4444                                  lff11m2_7:
  4445                                  lff11s2_7:
  4446 000016B1 E9B0F5                  	jmp	lff11_5  ; error
  4447                                  
  4448                                  load_11khz_stereo_16_bit:
  4449                                  	; 18/11/2023
  4450 000016B4 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  4451                                  					; last of the file?
  4452 000016B9 7402                    	jz	short lff11s2_0		; no
  4453 000016BB F9                      	stc
  4454 000016BC C3                      	retn
  4455                                  
  4456                                  lff11s2_0:
  4457 000016BD 8EC0                    	mov	es, ax ; buffer segment
  4458 000016BF 31FF                    	xor	di, di
  4459 000016C1 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  4460                                  	; ds = cs
  4461                                  
  4462                                  	; load file into memory
  4463 000016C4 8B0E[7A2A]                      mov	cx, [loadsize]
  4464 000016C8 8B1E[0E2A]              	mov	bx, [filehandle]
  4465 000016CC B43F                           	mov	ah, 3Fh
  4466 000016CE CD21                    	int	21h
  4467 000016D0 72DF                    	jc	short lff11s2_7 ; error !
  4468                                  
  4469                                  	; 14/11/2024
  4470 000016D2 A3[842A]                	mov	[count], ax
  4471                                  
  4472 000016D5 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  4473                                  	
  4474 000016D7 C1E802                  	shr	ax, 2	; dword (left chan word + right chan word)
  4475                                  	;and	ax, ax
  4476 000016DA 7506                    	jnz	short lff11s2_8
  4477 000016DC E97EF5                  	jmp	lff11_eof
  4478                                  
  4479                                  lff11m2_3:
  4480                                  lff11s2_3:
  4481 000016DF E968F5                  	jmp	lff11_3	; padfill
  4482                                  		; (put zeros in the remain words of the buffer)
  4483                                  
  4484                                  lff11s2_8:
  4485 000016E2 89C1                    	mov	cx, ax		; dword count
  4486                                  lff11s2_9:
  4487 000016E4 BD0600                  	mov	bp, 6 ; interpolation (one step) loop count
  4488                                  lff11s2_1:
  4489                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4490 000016E7 AD                      	lodsw
  4491 000016E8 89C3                    	mov	bx, ax
  4492 000016EA AD                      	lodsw
  4493 000016EB 8B14                    	mov	dx, [si]
  4494 000016ED 8916[071D]              	mov	[next_val_l], dx
  4495 000016F1 8B5402                  	mov	dx, [si+2]
  4496 000016F4 8916[091D]              	mov	[next_val_r], dx
  4497 000016F8 49                      	dec	cx
  4498 000016F9 750A                    	jnz	short lff11s2_2_1
  4499 000016FB 31D2                    	xor	dx, dx ; 0
  4500 000016FD 8916[071D]              	mov	[next_val_l], dx
  4501 00001701 8916[091D]              	mov	[next_val_r], dx
  4502                                  lff11s2_2_1:
  4503                                  	; bx = [previous_val_l]
  4504                                  	; ax = [previous_val_r]
  4505                                  	; [next_val_l]
  4506                                  	; dx = [next_val_r]
  4507 00001705 E8DC04                  	call	interpolating_5_16bit_stereo
  4508 00001708 E3D5                    	jcxz	lff11s2_3
  4509                                  lff11s2_2_2:
  4510 0000170A AD                      	lodsw
  4511 0000170B 89C3                    	mov	bx, ax
  4512 0000170D AD                      	lodsw
  4513 0000170E 8B14                    	mov	dx, [si]
  4514 00001710 8916[071D]              	mov	[next_val_l], dx
  4515 00001714 8B5402                  	mov	dx, [si+2]
  4516 00001717 8916[091D]              	mov	[next_val_r], dx
  4517 0000171B 49                      	dec	cx
  4518 0000171C 750A                    	jnz	short lff11s2_2_3
  4519 0000171E 31D2                    	xor	dx, dx ; 0
  4520 00001720 8916[071D]              	mov	[next_val_l], dx
  4521 00001724 8916[091D]              	mov	[next_val_r], dx
  4522                                  lff11s2_2_3:
  4523 00001728 E87C05                   	call	interpolating_4_16bit_stereo
  4524 0000172B E3B2                    	jcxz	lff11s2_3
  4525                                  	
  4526 0000172D 4D                      	dec	bp
  4527 0000172E 74B4                    	jz	short lff11s2_9
  4528                                  
  4529 00001730 AD                      	lodsw
  4530 00001731 89C3                    	mov	bx, ax
  4531 00001733 AD                      	lodsw
  4532 00001734 8B14                    	mov	dx, [si]
  4533 00001736 8916[071D]              	mov	[next_val_l], dx
  4534 0000173A 8B5402                  	mov	dx, [si+2]
  4535 0000173D 8916[091D]              	mov	[next_val_r], dx
  4536 00001741 49                      	dec	cx
  4537 00001742 750A                    	jnz	short lff11s2_2_4
  4538 00001744 31D2                    	xor	dx, dx ; 0
  4539 00001746 8916[071D]              	mov	[next_val_l], dx
  4540 0000174A 8916[091D]              	mov	[next_val_r], dx
  4541                                  lff11s2_2_4:
  4542 0000174E E85605                   	call	interpolating_4_16bit_stereo
  4543 00001751 E38C                    	jcxz	lff11s2_3
  4544 00001753 EB92                    	jmp	short lff11s2_1
  4545                                  
  4546                                  ; .....................
  4547                                  
  4548                                  load_44khz_mono_8_bit:
  4549                                  	; 18/11/2023
  4550 00001755 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  4551                                  					; last of the file?
  4552 0000175A 7402                    	jz	short lff44m_0		; no
  4553 0000175C F9                      	stc
  4554 0000175D C3                      	retn
  4555                                  
  4556                                  lff44m_0:
  4557 0000175E 8EC0                    	mov	es, ax ; buffer segment
  4558 00001760 31FF                    	xor	di, di
  4559 00001762 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  4560                                  	; ds = cs
  4561                                  
  4562                                  	; load file into memory
  4563 00001765 8B0E[7A2A]                      mov	cx, [loadsize]
  4564 00001769 8B1E[0E2A]              	mov	bx, [filehandle]
  4565 0000176D B43F                           	mov	ah, 3Fh
  4566 0000176F CD21                    	int	21h
  4567 00001771 723F                    	jc	short lff44m_7 ; error !
  4568                                  
  4569                                  	; 14/11/2024
  4570 00001773 A3[842A]                	mov	[count], ax
  4571                                  
  4572 00001776 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  4573                                  	
  4574 00001778 21C0                    	and	ax, ax
  4575 0000177A 7503                    	jnz	short lff44m_8
  4576 0000177C E9DEF4                  	jmp	lff44_eof
  4577                                  
  4578                                  lff44m_8:
  4579 0000177F 89C1                    	mov	cx, ax		; byte count
  4580                                  lff44m_9:
  4581 00001781 BD0A00                  	mov	bp, 10 ; interpolation (one step) loop count
  4582 00001784 C606[0B1D]02            	mov	byte [faz], 2  ; 2 steps/phases
  4583                                  lff44m_1:
  4584                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  4585                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  4586 00001789 AC                      	lodsb
  4587 0000178A B280                    	mov	dl, 80h
  4588 0000178C 49                      	dec	cx
  4589 0000178D 7402                    	jz	short lff44m_2_1
  4590 0000178F 8A14                    	mov	dl, [si]
  4591                                  lff44m_2_1:	
  4592                                  	; al = [previous_val]
  4593                                  	; dl = [next_val]
  4594 00001791 E8AF01                  	call	interpolating_2_8bit_mono
  4595 00001794 E319                    	jcxz	lff44m_3
  4596                                  lff44m_2_2:
  4597 00001796 AC                      	lodsb
  4598 00001797 2C80                    	sub	al, 80h
  4599 00001799 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4600 0000179C AB                      	stosw		; (L)
  4601 0000179D AB                      	stosw		; (R)
  4602                                  
  4603 0000179E 49                      	dec	cx
  4604 0000179F 740E                    	jz	short lff44m_3
  4605 000017A1 4D                      	dec	bp
  4606 000017A2 75F2                    	jnz	short lff44m_2_2
  4607                                  	
  4608 000017A4 FE0E[0B1D]              	dec	byte [faz]
  4609 000017A8 74D7                    	jz	short lff44m_9 
  4610 000017AA BD0B00                  	mov	bp, 11
  4611 000017AD EBDA                    	jmp	short lff44m_1
  4612                                  
  4613                                  lff44m_3:
  4614                                  lff44s_3:
  4615 000017AF E998F4                  	jmp	lff44_3	; padfill
  4616                                  		; (put zeros in the remain words of the buffer)
  4617                                  lff44m_7:
  4618                                  lff44s_7:
  4619 000017B2 E9AFF4                  	jmp	lff44_5  ; error
  4620                                  
  4621                                  load_44khz_stereo_8_bit:
  4622                                  	; 16/11/2023
  4623 000017B5 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  4624                                  					; last of the file?
  4625 000017BA 7402                    	jz	short lff44s_0		; no
  4626 000017BC F9                      	stc
  4627 000017BD C3                      	retn
  4628                                  
  4629                                  lff44s_0:
  4630 000017BE 8EC0                    	mov	es, ax ; buffer segment
  4631 000017C0 31FF                    	xor	di, di
  4632 000017C2 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  4633                                  	; ds = cs
  4634                                  
  4635                                  	; load file into memory
  4636 000017C5 8B0E[7A2A]                      mov	cx, [loadsize]
  4637 000017C9 8B1E[0E2A]              	mov	bx, [filehandle]
  4638 000017CD B43F                           	mov	ah, 3Fh
  4639 000017CF CD21                    	int	21h
  4640 000017D1 72DF                    	jc	short lff44s_7 ; error !
  4641                                  
  4642                                  	; 14/11/2024
  4643 000017D3 A3[842A]                	mov	[count], ax
  4644                                  
  4645 000017D6 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  4646                                  	
  4647 000017D8 D1E8                    	shr	ax, 1
  4648                                  	;and	ax, ax
  4649 000017DA 7503                    	jnz	short lff44s_8
  4650 000017DC E97EF4                  	jmp	lff44_eof
  4651                                  
  4652                                  lff44s_8:
  4653 000017DF 89C1                    	mov	cx, ax		; word count
  4654                                  lff44s_9:
  4655 000017E1 BD0A00                  	mov	bp, 10 ; interpolation (one step) loop count
  4656 000017E4 C606[0B1D]02            	mov	byte [faz], 2  ; 2 steps/phase
  4657                                  lff44s_1:
  4658                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  4659                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  4660 000017E9 AD                      	lodsw
  4661 000017EA BA8080                  	mov	dx, 8080h
  4662 000017ED 49                      	dec	cx
  4663 000017EE 7402                    	jz	short lff44s_2_1
  4664 000017F0 8B14                    	mov	dx, [si]
  4665                                  lff44s_2_1:	
  4666                                  	; al = [previous_val_l]
  4667                                  	; ah = [previous_val_r]
  4668                                  	; dl = [next_val_l]
  4669                                  	; dl = [next_val_r]
  4670 000017F2 E86501                  	call	interpolating_2_8bit_stereo
  4671 000017F5 E3B8                    	jcxz	lff44s_3
  4672                                  lff44s_2_2:
  4673 000017F7 AC                      	lodsb
  4674 000017F8 2C80                    	sub	al, 80h
  4675 000017FA C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4676 000017FD AB                      	stosw		; (L)
  4677 000017FE AC                      	lodsb
  4678 000017FF 2C80                    	sub	al, 80h
  4679 00001801 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4680 00001804 AB                      	stosw		; (R)
  4681                                  
  4682 00001805 49                      	dec	cx
  4683 00001806 74A7                    	jz	short lff44s_3
  4684 00001808 4D                      	dec	bp
  4685 00001809 75EC                    	jnz	short lff44s_2_2
  4686                                  	
  4687 0000180B FE0E[0B1D]              	dec	byte [faz]
  4688 0000180F 74D0                    	jz	short lff44s_9 
  4689 00001811 BD0B00                  	mov	bp, 11
  4690 00001814 EBD3                    	jmp	short lff44s_1
  4691                                  
  4692                                  load_44khz_mono_16_bit:
  4693                                  	; 18/11/2023
  4694 00001816 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  4695                                  					; last of the file?
  4696 0000181B 7402                    	jz	short lff44m2_0		; no
  4697 0000181D F9                      	stc
  4698 0000181E C3                      	retn
  4699                                  
  4700                                  lff44m2_0:
  4701 0000181F 8EC0                    	mov	es, ax ; buffer segment
  4702 00001821 31FF                    	xor	di, di
  4703 00001823 BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  4704                                  	; ds = cs
  4705                                  
  4706                                  	; load file into memory
  4707 00001826 8B0E[7A2A]                      mov	cx, [loadsize]
  4708 0000182A 8B1E[0E2A]              	mov	bx, [filehandle]
  4709 0000182E B43F                           	mov	ah, 3Fh
  4710 00001830 CD21                    	int	21h
  4711 00001832 723A                    	jc	short lff44m2_7 ; error !
  4712                                  
  4713                                  	; 14/11/2024
  4714 00001834 A3[842A]                	mov	[count], ax
  4715                                  
  4716 00001837 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  4717                                  	
  4718 00001839 D1E8                    	shr	ax, 1
  4719                                  	;and	ax, ax
  4720 0000183B 7503                    	jnz	short lff44m2_8
  4721 0000183D E91DF4                  	jmp	lff44_eof
  4722                                  
  4723                                  lff44m2_8:
  4724 00001840 89C1                    	mov	cx, ax		; word count
  4725                                  lff44m2_9:
  4726 00001842 BD0A00                  	mov	bp, 10 ; interpolation (one step) loop count
  4727 00001845 C606[0B1D]02            	mov	byte [faz], 2  ; 2 steps/phases
  4728                                  lff44m2_1:
  4729                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  4730                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  4731 0000184A AD                      	lodsw
  4732 0000184B 31D2                    	xor	dx, dx
  4733 0000184D 49                      	dec	cx
  4734 0000184E 7402                    	jz	short lff44m2_2_1
  4735 00001850 8B14                    	mov	dx, [si]
  4736                                  lff44m2_2_1:	
  4737                                  	; ax = [previous_val]
  4738                                  	; dx = [next_val]
  4739 00001852 E89B01                  	call	interpolating_2_16bit_mono
  4740 00001855 E314                    	jcxz	lff44m2_3
  4741                                  lff44m2_2_2:
  4742 00001857 AD                      	lodsw
  4743 00001858 AB                      	stosw		; (L)eft Channel
  4744 00001859 AB                      	stosw		; (R)ight Channel
  4745                                  
  4746 0000185A 49                      	dec	cx
  4747 0000185B 740E                    	jz	short lff44m2_3	
  4748 0000185D 4D                      	dec	bp
  4749 0000185E 75F7                    	jnz	short lff44m2_2_2
  4750                                  	
  4751 00001860 FE0E[0B1D]              	dec	byte [faz]
  4752 00001864 74DC                    	jz	short lff44m2_9 
  4753 00001866 BD0B00                  	mov	bp, 11
  4754 00001869 EBDF                    	jmp	short lff44m2_1
  4755                                  
  4756                                  lff44m2_3:
  4757                                  lff44s2_3:
  4758 0000186B E9DCF3                  	jmp	lff44_3	; padfill
  4759                                  		; (put zeros in the remain words of the buffer)
  4760                                  lff44m2_7:
  4761                                  lff44s2_7:
  4762 0000186E E9F3F3                  	jmp	lff44_5  ; error
  4763                                  
  4764                                  load_44khz_stereo_16_bit:
  4765                                  	; 18/11/2023
  4766 00001871 F606[0C2A]01                    test    byte [flags], ENDOFFILE	; have we already read the
  4767                                  					; last of the file?
  4768 00001876 7402                    	jz	short lff44s2_0		; no
  4769 00001878 F9                      	stc
  4770 00001879 C3                      	retn
  4771                                  
  4772                                  lff44s2_0:
  4773 0000187A 8EC0                    	mov	es, ax ; buffer segment
  4774 0000187C 31FF                    	xor	di, di
  4775 0000187E BA[8E2A]                	mov	dx, temp_buffer ; temporary buffer for wav data
  4776                                  	; ds = cs
  4777                                  
  4778                                  	; load file into memory
  4779 00001881 8B0E[7A2A]                      mov	cx, [loadsize]
  4780 00001885 8B1E[0E2A]              	mov	bx, [filehandle]
  4781 00001889 B43F                           	mov	ah, 3Fh
  4782 0000188B CD21                    	int	21h
  4783 0000188D 72DF                    	jc	short lff44s2_7 ; error !
  4784                                  
  4785                                  	; 14/11/2024
  4786 0000188F A3[842A]                	mov	[count], ax
  4787                                  
  4788 00001892 89D6                    	mov	si, dx ; temp_buffer ; temporary buffer address
  4789                                  	
  4790 00001894 C1E802                  	shr	ax, 2	; dword (left chan word + right chan word)
  4791                                  	;and	ax, ax
  4792 00001897 7503                    	jnz	short lff44s2_8
  4793 00001899 E9C1F3                  	jmp	lff44_eof
  4794                                  
  4795                                  lff44s2_8:
  4796 0000189C 89C1                    	mov	cx, ax		; dword count
  4797                                  lff44s2_9:
  4798 0000189E BD0A00                  	mov	bp, 10 ; interpolation (one step) loop count
  4799 000018A1 C606[0B1D]02            	mov	byte [faz], 2  ; 2 steps/phase
  4800                                  lff44s2_1:
  4801                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  4802                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  4803 000018A6 AD                      	lodsw
  4804 000018A7 89C3                    	mov	bx, ax
  4805 000018A9 AD                      	lodsw
  4806 000018AA 8B14                    	mov	dx, [si]
  4807 000018AC 8916[071D]              	mov	[next_val_l], dx
  4808 000018B0 8B5402                  	mov	dx, [si+2]
  4809 000018B3 49                      	dec	cx
  4810 000018B4 7506                    	jnz	short lff44s2_2_1
  4811 000018B6 31D2                    	xor	dx, dx ; 0
  4812 000018B8 8916[071D]              	mov	[next_val_l], dx
  4813                                  lff44s2_2_1:
  4814                                  	; bx = [previous_val_l]
  4815                                  	; ax = [previous_val_r]
  4816                                  	; [next_val_l]
  4817                                  	; dx = [next_val_r]
  4818 000018BC E84301                  	call	interpolating_2_16bit_stereo
  4819 000018BF E3AA                    	jcxz	lff44s2_3
  4820                                  lff44s2_2_2:
  4821                                  	;lodsw
  4822                                  	;stosw		; (L)
  4823                                  	;lodsw
  4824                                  	;stosw		; (R)
  4825 000018C1 A5                      	movsw		; (L)eft Channel
  4826 000018C2 A5                      	movsw		; (R)ight Channel
  4827                                  
  4828 000018C3 49                      	dec	cx
  4829 000018C4 74A5                    	jz	short lff44s2_3	
  4830 000018C6 4D                      	dec	bp
  4831 000018C7 75F8                    	jnz	short lff44s2_2_2
  4832                                  	
  4833 000018C9 FE0E[0B1D]              	dec	byte [faz]
  4834 000018CD 74CF                    	jz	short lff44s2_9 
  4835 000018CF BD0B00                  	mov	bp, 11
  4836 000018D2 EBD2                    	jmp	short lff44s2_1
  4837                                  
  4838                                  ; .....................
  4839                                  
  4840                                  interpolating_3_8bit_mono:
  4841                                  	; 16/11/2023
  4842                                  	; al = [previous_val]
  4843                                  	; dl = [next_val]
  4844                                  	; original-interpolated-interpolated
  4845 000018D4 88C3                    	mov	bl, al
  4846 000018D6 2C80                    	sub	al, 80h
  4847 000018D8 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4848 000018DB AB                      	stosw		; original sample (L)
  4849 000018DC AB                      	stosw		; original sample (R)
  4850 000018DD 88D8                    	mov	al, bl
  4851 000018DF 00D0                    	add	al, dl
  4852 000018E1 D0D8                    	rcr	al, 1
  4853 000018E3 88C7                    	mov	bh, al	; interpolated middle (temporary)
  4854 000018E5 00D8                    	add	al, bl
  4855 000018E7 D0D8                    	rcr	al, 1
  4856 000018E9 2C80                    	sub	al, 80h
  4857 000018EB C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4858 000018EE AB                      	stosw		; interpolated sample 1 (L)
  4859 000018EF AB                      	stosw		; interpolated sample 1 (R)
  4860 000018F0 88F8                    	mov	al, bh
  4861 000018F2 00D0                    	add	al, dl	; [next_val]
  4862 000018F4 D0D8                    	rcr	al, 1
  4863 000018F6 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4864 000018F9 AB                      	stosw		; interpolated sample 2 (L)
  4865 000018FA AB                      	stosw		; interpolated sample 2 (R)
  4866 000018FB C3                      	retn
  4867                                  
  4868                                  interpolating_3_8bit_stereo:
  4869                                  	; 16/11/2023
  4870                                  	; al = [previous_val_l]
  4871                                  	; ah = [previous_val_r]
  4872                                  	; dl = [next_val_l]
  4873                                  	; dh = [next_val_r]
  4874                                  	; original-interpolated-interpolated
  4875 000018FC 89C3                    	mov	bx, ax
  4876 000018FE 2C80                    	sub	al, 80h
  4877 00001900 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4878 00001903 AB                      	stosw		; original sample (L)
  4879 00001904 88F8                    	mov	al, bh
  4880 00001906 2C80                    	sub	al, 80h
  4881 00001908 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4882 0000190B AB                      	stosw		; original sample (R)
  4883 0000190C 88D8                    	mov	al, bl
  4884 0000190E 00D0                    	add	al, dl	; [next_val_l]
  4885 00001910 D0D8                    	rcr	al, 1
  4886 00001912 50                      	push	ax ; *	; al = interpolated middle (L) (temporary)
  4887 00001913 00D8                    	add	al, bl	; [previous_val_l]
  4888 00001915 D0D8                    	rcr	al, 1
  4889 00001917 2C80                    	sub	al, 80h
  4890 00001919 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4891 0000191C AB                      	stosw		; interpolated sample 1 (L)
  4892 0000191D 88F8                    	mov	al, bh
  4893 0000191F 00F0                    	add	al, dh	; [next_val_r]
  4894 00001921 D0D8                    	rcr	al, 1
  4895 00001923 50                      	push	ax ; ** ; al = interpolated middle (R) (temporary)
  4896 00001924 00F8                    	add	al, bh	; [previous_val_r]
  4897 00001926 D0D8                    	rcr	al, 1
  4898 00001928 2C80                    	sub	al, 80h
  4899 0000192A C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4900 0000192D AB                      	stosw		; interpolated sample 1 (R)
  4901 0000192E 5B                      	pop	bx ; **
  4902 0000192F 58                      	pop	ax ; *
  4903 00001930 00D0                    	add	al, dl	; [next_val_l]
  4904 00001932 D0D8                    	rcr	al, 1
  4905 00001934 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4906 00001937 AB                      	stosw		; interpolated sample 2 (L)
  4907 00001938 88D8                    	mov	al, bl
  4908 0000193A 00F0                    	add	al, dh	; [next_val_r]
  4909 0000193C D0D8                    	rcr	al, 1
  4910 0000193E C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4911 00001941 AB                      	stosw		; interpolated sample 2 (R)
  4912 00001942 C3                      	retn
  4913                                  
  4914                                  interpolating_2_8bit_mono:
  4915                                  	; 16/11/2023
  4916                                  	; al = [previous_val]
  4917                                  	; dl = [next_val]
  4918                                  	; original-interpolated
  4919 00001943 88C3                    	mov	bl, al
  4920 00001945 2C80                    	sub	al, 80h
  4921 00001947 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4922 0000194A AB                      	stosw		; original sample (L)
  4923 0000194B AB                      	stosw		; original sample (R)
  4924 0000194C 88D8                    	mov	al, bl
  4925 0000194E 00D0                    	add	al, dl
  4926 00001950 D0D8                    	rcr	al, 1
  4927 00001952 2C80                    	sub	al, 80h
  4928 00001954 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4929 00001957 AB                      	stosw		; interpolated sample (L)
  4930 00001958 AB                      	stosw		; interpolated sample (R)
  4931 00001959 C3                      	retn
  4932                                  
  4933                                  interpolating_2_8bit_stereo:
  4934                                  	; 16/11/2023
  4935                                  	; al = [previous_val_l]
  4936                                  	; ah = [previous_val_r]
  4937                                  	; dl = [next_val_l]
  4938                                  	; dh = [next_val_r]
  4939                                  	; original-interpolated
  4940 0000195A 89C3                    	mov	bx, ax
  4941 0000195C 2C80                    	sub	al, 80h
  4942 0000195E C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4943 00001961 AB                      	stosw		; original sample (L)
  4944 00001962 88F8                    	mov	al, bh
  4945 00001964 2C80                    	sub	al, 80h
  4946 00001966 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4947 00001969 AB                      	stosw		; original sample (R)
  4948 0000196A 88D8                    	mov	al, bl	; [previous_val_l]
  4949 0000196C 00D0                    	add	al, dl	; [next_val_l]	
  4950 0000196E D0D8                    	rcr	al, 1
  4951 00001970 2C80                    	sub	al, 80h
  4952 00001972 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4953 00001975 AB                      	stosw		; interpolated sample (L)
  4954 00001976 88F8                    	mov	al, bh
  4955 00001978 00F0                    	add	al, dh	; [next_val_r]
  4956 0000197A D0D8                    	rcr	al, 1
  4957 0000197C 2C80                    	sub	al, 80h
  4958 0000197E C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4959 00001981 AB                      	stosw		; interpolated sample (R)
  4960 00001982 C3                      	retn
  4961                                  
  4962                                  interpolating_3_16bit_mono:
  4963                                  	; 16/11/2023
  4964                                  	; ax = [previous_val]
  4965                                  	; dx = [next_val]
  4966                                  	; original-interpolated-interpolated
  4967                                  
  4968 00001983 AB                      	stosw		; original sample (L)
  4969 00001984 AB                      	stosw		; original sample (R)
  4970 00001985 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4971 00001988 50                      	push	ax ; *	; [previous_val]
  4972 00001989 80C680                  	add	dh, 80h
  4973 0000198C 01D0                    	add	ax, dx
  4974 0000198E D1D8                    	rcr	ax, 1
  4975 00001990 5B                      	pop	bx ; *
  4976 00001991 93                      	xchg	bx, ax	; bx  = interpolated middle (temporary)
  4977 00001992 01D8                    	add	ax, bx	; [previous_val] + interpolated middle
  4978 00001994 D1D8                    	rcr	ax, 1
  4979 00001996 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4980 00001999 AB                      	stosw 		; interpolated sample 1 (L)
  4981 0000199A AB                      	stosw		; interpolated sample 1 (R)
  4982 0000199B 89D8                    	mov	ax, bx
  4983 0000199D 01D0                    	add	ax, dx	 ;interpolated middle + [next_val]
  4984 0000199F D1D8                    	rcr	ax, 1
  4985 000019A1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4986 000019A4 AB                      	stosw		; interpolated sample 2 (L)
  4987 000019A5 AB                      	stosw		; interpolated sample 2 (R)
  4988 000019A6 C3                      	retn
  4989                                  
  4990                                  interpolating_3_16bit_stereo:
  4991                                  	; 16/11/2023
  4992                                  	; bx = [previous_val_l]
  4993                                  	; ax = [previous_val_r]
  4994                                  	; [next_val_l]
  4995                                  	; dx = [next_val_r]
  4996                                  	; original-interpolated-interpolated
  4997                                  
  4998 000019A7 93                      	xchg	ax, bx
  4999 000019A8 AB                      	stosw		; original sample (L)
  5000 000019A9 93                      	xchg	ax, bx
  5001 000019AA AB                      	stosw		; original sample (R)
  5002 000019AB 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5003 000019AE 50                      	push	ax ; *	; [previous_val_r]
  5004 000019AF 80C780                  	add	bh, 80h
  5005 000019B2 8006[081D]80            	add	byte [next_val_l+1], 80h
  5006 000019B7 A1[071D]                	mov	ax, [next_val_l]
  5007 000019BA 01D8                    	add	ax, bx	; [previous_val_l]
  5008 000019BC D1D8                    	rcr	ax, 1
  5009 000019BE 93                      	xchg	ax, bx	; ax = [previous_val_l]	
  5010 000019BF 01D8                    	add	ax, bx	; bx = interpolated middle (L)
  5011 000019C1 D1D8                    	rcr	ax, 1
  5012 000019C3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5013 000019C6 AB                      	stosw 		; interpolated sample 1 (L)
  5014 000019C7 58                      	pop	ax  ; *
  5015 000019C8 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  5016 000019CB 52                      	push	dx  ; * ; [next_val_r]
  5017 000019CC 92                      	xchg	ax, dx
  5018 000019CD 01D0                    	add	ax, dx	; [next_val_r] + [previous_val_r]
  5019 000019CF D1D8                    	rcr	ax, 1	; / 2
  5020 000019D1 50                      	push	ax ; ** ; interpolated middle (R)
  5021 000019D2 01D0                    	add	ax, dx	; + [previous_val_r]
  5022 000019D4 D1D8                    	rcr	ax, 1
  5023 000019D6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5024 000019D9 AB                      	stosw 		; interpolated sample 1 (R)
  5025 000019DA A1[071D]                	mov	ax, [next_val_l]
  5026 000019DD 01D8                    	add	ax, bx	; + interpolated middle (L)
  5027 000019DF D1D8                    	rcr	ax, 1
  5028 000019E1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5029 000019E4 AB                      	stosw 		; interpolated sample 2 (L)
  5030 000019E5 58                      	pop	ax ; **
  5031 000019E6 5A                      	pop	dx ; *	
  5032 000019E7 01D0                    	add	ax, dx	; interpolated middle + [next_val_r]
  5033 000019E9 D1D8                    	rcr	ax, 1	; / 2
  5034 000019EB 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5035 000019EE AB                      	stosw 		; interpolated sample 2 (L)
  5036 000019EF C3                      	retn
  5037                                  
  5038                                  
  5039                                  interpolating_2_16bit_mono:
  5040                                  	; 16/11/2023
  5041                                  	; ax = [previous_val]
  5042                                  	; dx = [next_val]
  5043                                  	; original-interpolated
  5044                                  
  5045 000019F0 AB                      	stosw		; original sample (L)
  5046 000019F1 AB                      	stosw		; original sample (R)
  5047 000019F2 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5048 000019F5 80C680                  	add	dh, 80h
  5049 000019F8 01D0                    	add	ax, dx
  5050 000019FA D1D8                    	rcr	ax, 1
  5051 000019FC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5052 000019FF AB                      	stosw		; interpolated sample (L)
  5053 00001A00 AB                      	stosw		; interpolated sample (R)
  5054 00001A01 C3                      	retn
  5055                                  
  5056                                  interpolating_2_16bit_stereo:
  5057                                  	; 16/11/2023
  5058                                  	; bx = [previous_val_l]
  5059                                  	; ax = [previous_val_r]
  5060                                  	; [next_val_l]
  5061                                  	; dx = [next_val_r]
  5062                                  	; original-interpolated
  5063                                  
  5064 00001A02 93                      	xchg	ax, bx
  5065 00001A03 AB                      	stosw		; original sample (L)
  5066 00001A04 93                      	xchg	ax, bx
  5067 00001A05 AB                      	stosw		; original sample (R)
  5068 00001A06 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5069 00001A09 80C680                  	add	dh, 80h
  5070 00001A0C 01D0                    	add	ax, dx	; [previous_val_r] + [next_val_r]
  5071 00001A0E D1D8                    	rcr	ax, 1	; / 2
  5072 00001A10 50                      	push	ax ; *	; interpolated sample (R)
  5073 00001A11 A1[071D]                	mov	ax, [next_val_l]
  5074 00001A14 80C480                  	add	ah, 80h
  5075 00001A17 80C780                  	add	bh, 80h
  5076 00001A1A 01D8                    	add	ax, bx	; [next_val_l] + [previous_val_l]
  5077 00001A1C D1D8                    	rcr	ax, 1	; / 2		
  5078 00001A1E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5079 00001A21 AB                      	stosw 		; interpolated sample (L)
  5080 00001A22 58                      	pop	ax ; *	
  5081 00001A23 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5082 00001A26 AB                      	stosw 		; interpolated sample (R)
  5083 00001A27 C3                      	retn
  5084                                  
  5085                                  interpolating_5_8bit_mono:
  5086                                  	; 17/11/2023
  5087                                  	; al = [previous_val]
  5088                                  	; dl = [next_val]
  5089                                  	; original-interpltd-interpltd-interpltd-interpltd
  5090 00001A28 88C3                    	mov	bl, al
  5091 00001A2A 2C80                    	sub	al, 80h
  5092 00001A2C C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5093 00001A2F AB                      	stosw		; original sample (L)
  5094 00001A30 AB                      	stosw		; original sample (R)
  5095 00001A31 88D8                    	mov	al, bl
  5096 00001A33 00D0                    	add	al, dl
  5097 00001A35 D0D8                    	rcr	al, 1
  5098 00001A37 88C7                    	mov	bh, al	; interpolated middle (temporary)
  5099 00001A39 00D8                    	add	al, bl  ; [previous_val]
  5100 00001A3B D0D8                    	rcr	al, 1 	
  5101 00001A3D 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  5102 00001A3F 00D8                    	add	al, bl
  5103 00001A41 D0D8                    	rcr	al, 1
  5104 00001A43 2C80                    	sub	al, 80h
  5105 00001A45 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5106 00001A48 AB                      	stosw		; interpolated sample 1 (L)
  5107 00001A49 AB                      	stosw		; interpolated sample 1 (R)
  5108 00001A4A 88F8                    	mov	al, bh
  5109 00001A4C 00F0                    	add	al, dh
  5110 00001A4E D0D8                    	rcr	al, 1
  5111 00001A50 2C80                    	sub	al, 80h
  5112 00001A52 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5113 00001A55 AB                      	stosw		; interpolated sample 2 (L)
  5114 00001A56 AB                      	stosw		; interpolated sample 2 (R)
  5115 00001A57 88F8                    	mov	al, bh
  5116 00001A59 00D0                    	add	al, dl	; [next_val]
  5117 00001A5B D0D8                    	rcr	al, 1
  5118 00001A5D 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  5119 00001A5F 00F8                    	add	al, bh
  5120 00001A61 D0D8                    	rcr	al, 1
  5121 00001A63 2C80                    	sub	al, 80h
  5122 00001A65 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5123 00001A68 AB                      	stosw		; interpolated sample 3 (L)
  5124 00001A69 AB                      	stosw		; interpolated sample 3 (R)
  5125 00001A6A 88F0                    	mov	al, dh
  5126 00001A6C 00D0                    	add	al, dl
  5127 00001A6E D0D8                    	rcr	al, 1
  5128 00001A70 2C80                    	sub	al, 80h
  5129 00001A72 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5130 00001A75 AB                      	stosw		; interpolated sample 4 (L)
  5131 00001A76 AB                      	stosw		; interpolated sample 4 (R)
  5132 00001A77 C3                      	retn
  5133                                  
  5134                                  interpolating_5_8bit_stereo:
  5135                                  	; 17/11/2023
  5136                                  	; al = [previous_val_l]
  5137                                  	; ah = [previous_val_r]
  5138                                  	; dl = [next_val_l]
  5139                                  	; dh = [next_val_r]
  5140                                  	; original-interpltd-interpltd-interpltd-interpltd
  5141 00001A78 89C3                    	mov	bx, ax
  5142 00001A7A 2C80                    	sub	al, 80h
  5143 00001A7C C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5144 00001A7F AB                      	stosw		; original sample (L)
  5145 00001A80 88F8                    	mov	al, bh
  5146 00001A82 2C80                    	sub	al, 80h
  5147 00001A84 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5148 00001A87 AB                      	stosw		; original sample (R)
  5149 00001A88 52                      	push	dx ; *
  5150 00001A89 88D8                    	mov	al, bl
  5151 00001A8B 00D0                    	add	al, dl	; [next_val_l]
  5152 00001A8D D0D8                    	rcr	al, 1
  5153 00001A8F 50                      	push	ax ; **	; al = interpolated middle (L) (temporary)
  5154 00001A90 00D8                    	add	al, bl	; [previous_val_l]
  5155 00001A92 D0D8                    	rcr	al, 1
  5156 00001A94 86D8                    	xchg	al, bl
  5157 00001A96 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  5158 00001A98 D0D8                    	rcr	al, 1
  5159 00001A9A 2C80                    	sub	al, 80h
  5160 00001A9C C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5161 00001A9F AB                      	stosw		; interpolated sample 1 (L)
  5162 00001AA0 88F8                    	mov	al, bh
  5163 00001AA2 00F0                    	add	al, dh	; [next_val_r]
  5164 00001AA4 D0D8                    	rcr	al, 1
  5165 00001AA6 50                      	push	ax ; *** ; al = interpolated middle (R) (temporary)
  5166 00001AA7 00F8                    	add	al, bh	; [previous_val_r]
  5167 00001AA9 D0D8                    	rcr	al, 1
  5168 00001AAB 86F8                    	xchg	al, bh
  5169 00001AAD 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  5170 00001AAF D0D8                    	rcr	al, 1
  5171 00001AB1 2C80                    	sub	al, 80h
  5172 00001AB3 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5173 00001AB6 AB                      	stosw		; interpolated sample 1 (R)
  5174 00001AB7 5A                      	pop	dx ; ***
  5175 00001AB8 58                      	pop	ax ; **	; al = interpolated middle (L) (temporary)
  5176 00001AB9 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  5177 00001ABB 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  5178 00001ABD D0D8                    	rcr	al, 1
  5179 00001ABF 2C80                    	sub	al, 80h
  5180 00001AC1 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5181 00001AC4 AB                      	stosw		; interpolated sample 2 (L)	
  5182 00001AC5 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  5183 00001AC7 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  5184 00001AC9 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  5185 00001ACB D0D8                    	rcr	al, 1
  5186 00001ACD 2C80                    	sub	al, 80h
  5187 00001ACF C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5188 00001AD2 AB                      	stosw		; interpolated sample 2 (R)
  5189 00001AD3 5A                      	pop	dx ; *
  5190 00001AD4 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  5191 00001AD6 00D0                    	add	al, dl	; [next_val_l]
  5192 00001AD8 D0D8                    	rcr	al, 1
  5193 00001ADA 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  5194 00001ADC 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  5195 00001ADE D0D8                    	rcr	al, 1
  5196 00001AE0 2C80                    	sub	al, 80h
  5197 00001AE2 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5198 00001AE5 AB                      	stosw		; interpolated sample 3 (L)
  5199 00001AE6 88F8                    	mov	al, bh	
  5200 00001AE8 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  5201 00001AEA D0D8                    	rcr	al, 1
  5202 00001AEC 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  5203 00001AEE 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  5204 00001AF0 D0D8                    	rcr	al, 1
  5205 00001AF2 2C80                    	sub	al, 80h
  5206 00001AF4 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5207 00001AF7 AB                      	stosw		; interpolated sample 3 (R)
  5208 00001AF8 88D8                    	mov	al, bl
  5209 00001AFA 00D0                    	add	al, dl	; [next_val_l]
  5210 00001AFC D0D8                    	rcr	al, 1
  5211 00001AFE 2C80                    	sub	al, 80h
  5212 00001B00 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5213 00001B03 AB                      	stosw		; interpolated sample 4 (L)
  5214 00001B04 88F8                    	mov	al, bh
  5215 00001B06 00F0                    	add	al, dh	; [next_val_r]
  5216 00001B08 D0D8                    	rcr	al, 1
  5217 00001B0A 2C80                    	sub	al, 80h
  5218 00001B0C C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5219 00001B0F AB                      	stosw		; interpolated sample 4 (R)
  5220 00001B10 C3                      	retn
  5221                                  
  5222                                  interpolating_4_8bit_mono:
  5223                                  	; 17/11/2023
  5224                                  	; al = [previous_val]
  5225                                  	; dl = [next_val]
  5226                                  	; original-interpolated-interpolated-interpolated
  5227 00001B11 88C3                    	mov	bl, al
  5228 00001B13 2C80                    	sub	al, 80h
  5229 00001B15 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5230 00001B18 AB                      	stosw		; original sample (L)
  5231 00001B19 AB                      	stosw		; original sample (R)
  5232 00001B1A 88D8                    	mov	al, bl
  5233 00001B1C 00D0                    	add	al, dl
  5234 00001B1E D0D8                    	rcr	al, 1
  5235 00001B20 86D8                    	xchg	al, bl  ; al = [previous_val]
  5236 00001B22 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  5237 00001B24 D0D8                    	rcr	al, 1
  5238 00001B26 2C80                    	sub	al, 80h
  5239 00001B28 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5240 00001B2B AB                      	stosw		; interpolated sample 1 (L)
  5241 00001B2C AB                      	stosw		; interpolated sample 1 (R)
  5242 00001B2D 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  5243 00001B2F 2C80                    	sub	al, 80h
  5244 00001B31 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5245 00001B34 AB                      	stosw		; interpolated sample 2 (L)
  5246 00001B35 AB                      	stosw		; interpolated sample 2 (R)
  5247 00001B36 88D8                    	mov	al, bl
  5248 00001B38 00D0                    	add	al, dl	; [next_val]
  5249 00001B3A D0D8                    	rcr	al, 1
  5250 00001B3C 2C80                    	sub	al, 80h
  5251 00001B3E C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5252 00001B41 AB                      	stosw		; interpolated sample 3 (L)
  5253 00001B42 AB                      	stosw		; interpolated sample 3 (R)
  5254 00001B43 C3                      	retn
  5255                                  
  5256                                  interpolating_4_8bit_stereo:
  5257                                  	; 17/11/2023
  5258                                  	; al = [previous_val_l]
  5259                                  	; ah = [previous_val_r]
  5260                                  	; dl = [next_val_l]
  5261                                  	; dh = [next_val_r]
  5262                                  	; original-interpolated-interpolated-interpolated
  5263 00001B44 89C3                    	mov	bx, ax
  5264 00001B46 2C80                    	sub	al, 80h
  5265 00001B48 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5266 00001B4B AB                      	stosw		; original sample (L)
  5267 00001B4C 88F8                    	mov	al, bh
  5268 00001B4E 2C80                    	sub	al, 80h
  5269 00001B50 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5270 00001B53 AB                      	stosw		; original sample (R)
  5271 00001B54 88D8                    	mov	al, bl
  5272 00001B56 00D0                    	add	al, dl	; [next_val_l]
  5273 00001B58 D0D8                    	rcr	al, 1
  5274 00001B5A 86D8                    	xchg	al, bl	; al = [previous_val_l]
  5275 00001B5C 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  5276 00001B5E D0D8                    	rcr	al, 1
  5277 00001B60 2C80                    	sub	al, 80h
  5278 00001B62 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5279 00001B65 AB                      	stosw		; interpolated sample 1 (L)
  5280 00001B66 88F8                    	mov	al, bh
  5281 00001B68 00F0                    	add	al, dh	; [next_val_r]
  5282 00001B6A D0D8                    	rcr	al, 1
  5283 00001B6C 86F8                    	xchg	al, bh	; al = [previous_val_h]
  5284 00001B6E 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  5285 00001B70 D0D8                    	rcr	al, 1
  5286 00001B72 2C80                    	sub	al, 80h
  5287 00001B74 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5288 00001B77 AB                      	stosw		; interpolated sample 1 (R)
  5289 00001B78 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  5290 00001B7A 2C80                    	sub	al, 80h
  5291 00001B7C C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5292 00001B7F AB                      	stosw		; interpolated sample 2 (L)
  5293 00001B80 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  5294 00001B82 2C80                    	sub	al, 80h
  5295 00001B84 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5296 00001B87 AB                      	stosw		; interpolated sample 2 (L)
  5297 00001B88 88D8                    	mov	al, bl
  5298 00001B8A 00D0                    	add	al, dl	; [next_val_l]
  5299 00001B8C D0D8                    	rcr	al, 1
  5300 00001B8E 2C80                    	sub	al, 80h
  5301 00001B90 C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5302 00001B93 AB                      	stosw		; interpolated sample 3 (L)
  5303 00001B94 88F8                    	mov	al, bh
  5304 00001B96 00F0                    	add	al, dh	; [next_val_r]
  5305 00001B98 D0D8                    	rcr	al, 1
  5306 00001B9A 2C80                    	sub	al, 80h
  5307 00001B9C C1E008                  	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5308 00001B9F AB                      	stosw		; interpolated sample 3 (R)
  5309 00001BA0 C3                      	retn
  5310                                  
  5311                                  interpolating_5_16bit_mono:
  5312                                  	; 18/11/2023
  5313                                  	; ax = [previous_val]
  5314                                  	; dx = [next_val]
  5315                                  	; original-interpltd-interpltd-interpltd-interpltd
  5316 00001BA1 AB                      	stosw		; original sample (L)
  5317 00001BA2 AB                      	stosw		; original sample (R)
  5318 00001BA3 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5319 00001BA6 89C3                    	mov	bx, ax	; [previous_val]
  5320 00001BA8 80C680                  	add	dh, 80h
  5321 00001BAB 01D0                    	add	ax, dx
  5322 00001BAD D1D8                    	rcr	ax, 1
  5323 00001BAF 50                      	push	ax ; *	; interpolated middle (temporary)
  5324 00001BB0 01D8                    	add	ax, bx	; interpolated middle + [previous_val] 
  5325 00001BB2 D1D8                    	rcr	ax, 1
  5326 00001BB4 50                      	push	ax ; **	; interpolated 1st quarter (temporary)
  5327 00001BB5 01D8                    	add	ax, bx	; 1st quarter + [previous_val]
  5328 00001BB7 D1D8                    	rcr	ax, 1	
  5329 00001BB9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5330 00001BBC AB                      	stosw 		; interpolated sample 1 (L)
  5331 00001BBD AB                      	stosw		; interpolated sample 1 (R)
  5332 00001BBE 58                      	pop	ax ; **	
  5333 00001BBF 5B                      	pop	bx ; *
  5334 00001BC0 01D8                    	add	ax, bx	; 1st quarter + middle
  5335 00001BC2 D1D8                    	rcr	ax, 1	; / 2
  5336 00001BC4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  5337 00001BC7 AB                      	stosw		; interpolated sample 2 (L)
  5338 00001BC8 AB                      	stosw		; interpolated sample 2 (R)		
  5339 00001BC9 89D8                    	mov	ax, bx
  5340 00001BCB 01D0                    	add	ax, dx	; interpolated middle + [next_val]
  5341 00001BCD D1D8                    	rcr	ax, 1
  5342 00001BCF 50                      	push	ax ; *	; interpolated 3rd quarter (temporary)
  5343 00001BD0 01D8                    	add	ax, bx	; + interpolated middle
  5344 00001BD2 D1D8                    	rcr	ax, 1
  5345 00001BD4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5346 00001BD7 AB                      	stosw		; interpolated sample 3 (L)
  5347 00001BD8 AB                      	stosw		; interpolated sample 3 (R)
  5348 00001BD9 58                      	pop	ax ; *	
  5349 00001BDA 01D0                    	add	ax, dx	; 3rd quarter + [next_val]
  5350 00001BDC D1D8                    	rcr	ax, 1	; / 2
  5351 00001BDE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5352 00001BE1 AB                      	stosw		; interpolated sample 4 (L)
  5353 00001BE2 AB                      	stosw		; interpolated sample 4 (R)
  5354 00001BE3 C3                      	retn
  5355                                  
  5356                                  interpolating_5_16bit_stereo:
  5357                                  	; 18/11/2023
  5358                                  	; bx = [previous_val_l]
  5359                                  	; ax = [previous_val_r]
  5360                                  	; [next_val_l]
  5361                                  	; [next_val_r]
  5362                                  	; original-interpltd-interpltd-interpltd-interpltd
  5363 00001BE4 51                      	push	cx ; !
  5364 00001BE5 93                      	xchg	ax, bx
  5365 00001BE6 AB                      	stosw		; original sample (L)
  5366 00001BE7 93                      	xchg	ax, bx
  5367 00001BE8 AB                      	stosw		; original sample (R)
  5368 00001BE9 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5369 00001BEC 50                      	push	ax ; *	; [previous_val_r]
  5370 00001BED 80C780                  	add	bh, 80h
  5371 00001BF0 8006[081D]80            	add	byte [next_val_l+1], 80h
  5372 00001BF5 A1[071D]                	mov	ax, [next_val_l]
  5373 00001BF8 01D8                    	add	ax, bx	; [previous_val_l]
  5374 00001BFA D1D8                    	rcr	ax, 1
  5375 00001BFC 89C1                    	mov	cx, ax	; interpolated middle (L)
  5376 00001BFE 01D8                    	add	ax, bx
  5377 00001C00 D1D8                    	rcr	ax, 1
  5378 00001C02 89C2                    	mov	dx, ax	; interpolated 1st quarter (L)	
  5379 00001C04 01D8                    	add	ax, bx	; [previous_val_l]
  5380 00001C06 D1D8                    	rcr	ax, 1
  5381 00001C08 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5382 00001C0B AB                      	stosw 		; interpolated sample 1 (L)
  5383 00001C0C 89C8                    	mov	ax, cx
  5384 00001C0E 01D0                    	add	ax, dx	; middle (L) + 1st quarter (L) 
  5385 00001C10 D1D8                    	rcr	ax, 1	; / 2
  5386 00001C12 89C3                    	mov	bx, ax  ; interpolated sample 2 (L)
  5387 00001C14 5A                      	pop	dx ; *	; [previous_val_r]
  5388 00001C15 89D0                    	mov	ax, dx
  5389 00001C17 8006[0A1D]80            	add	byte [next_val_r+1], 80h
  5390 00001C1C 0306[091D]              	add	ax, [next_val_r]
  5391 00001C20 D1D8                    	rcr	ax, 1
  5392 00001C22 50                      	push	ax ; *	; interpolated middle (R)
  5393 00001C23 01D0                    	add	ax, dx
  5394 00001C25 D1D8                    	rcr	ax, 1
  5395 00001C27 50                      	push	ax ; **	; interpolated 1st quarter (R)
  5396 00001C28 01D0                    	add	ax, dx	; [previous_val_r]
  5397 00001C2A D1D8                    	rcr	ax, 1
  5398 00001C2C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5399 00001C2F AB                      	stosw 		; interpolated sample 1 (R)
  5400 00001C30 89D8                    	mov	ax, bx
  5401 00001C32 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5402 00001C35 AB                      	stosw 		; interpolated sample 2 (L)
  5403 00001C36 58                      	pop	ax ; **
  5404 00001C37 5A                      	pop	dx ; *
  5405 00001C38 01D0                    	add	ax, dx	; 1st quarter (R) + middle (R)
  5406 00001C3A D1D8                    	rcr	ax, 1	; / 2
  5407 00001C3C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5408 00001C3F AB                      	stosw 		; interpolated sample 2 (R)
  5409 00001C40 89C8                    	mov	ax, cx
  5410 00001C42 0306[071D]              	add	ax, [next_val_l]
  5411 00001C46 D1D8                    	rcr	ax, 1
  5412 00001C48 50                      	push	ax ; * 	; interpolated 3rd quarter (L)
  5413 00001C49 01C8                    	add	ax, cx	; interpolated middle (L)
  5414 00001C4B D1D8                    	rcr	ax, 1
  5415 00001C4D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5416 00001C50 AB                      	stosw 		; interpolated sample 3 (L)
  5417 00001C51 89D0                    	mov	ax, dx
  5418 00001C53 0306[091D]              	add	ax, [next_val_r]
  5419 00001C57 D1D8                    	rcr	ax, 1
  5420 00001C59 50                      	push	ax ; ** ; interpolated 3rd quarter (R)
  5421 00001C5A 01D0                    	add	ax, dx	; interpolated middle (R)
  5422 00001C5C D1D8                    	rcr	ax, 1
  5423 00001C5E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5424 00001C61 AB                      	stosw 		; interpolated sample 3 (R)
  5425 00001C62 5B                      	pop	bx ; **
  5426 00001C63 58                      	pop	ax ; *
  5427 00001C64 0306[071D]              	add	ax, [next_val_l]
  5428 00001C68 D1D8                    	rcr	ax, 1
  5429 00001C6A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5430 00001C6D AB                      	stosw 		; interpolated sample 4 (L)
  5431 00001C6E 89D8                    	mov	ax, bx	
  5432 00001C70 0306[091D]              	add	ax, [next_val_r]
  5433 00001C74 D1D8                    	rcr	ax, 1
  5434 00001C76 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5435 00001C79 AB                      	stosw 		; interpolated sample 4 (R)
  5436 00001C7A 59                      	pop	cx ; !
  5437 00001C7B C3                      	retn
  5438                                  
  5439                                  interpolating_4_16bit_mono:
  5440                                  	; 18/11/2023
  5441                                  	; ax = [previous_val]
  5442                                  	; dx = [next_val]
  5443                                  	; original-interpolated
  5444                                  
  5445 00001C7C AB                      	stosw		; original sample (L)
  5446 00001C7D AB                      	stosw		; original sample (R)
  5447 00001C7E 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5448 00001C81 89C3                    	mov	bx, ax	; [previous_val]
  5449 00001C83 80C680                  	add	dh, 80h
  5450 00001C86 01D0                    	add	ax, dx	; [previous_val] + [next_val]
  5451 00001C88 D1D8                    	rcr	ax, 1
  5452 00001C8A 93                      	xchg	ax, bx
  5453 00001C8B 01D8                    	add	ax, bx	; [previous_val] + interpolated middle
  5454 00001C8D D1D8                    	rcr	ax, 1
  5455 00001C8F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5456 00001C92 AB                      	stosw 		; interpolated sample 1 (L)
  5457 00001C93 AB                      	stosw		; interpolated sample 1 (R)
  5458 00001C94 89D8                    	mov	ax, bx	; interpolated middle
  5459 00001C96 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5460 00001C99 AB                      	stosw 		; interpolated sample 2 (L)
  5461 00001C9A AB                      	stosw		; interpolated sample 2 (R)
  5462 00001C9B 89D8                    	mov	ax, bx
  5463 00001C9D 01D0                    	add	ax, dx	; interpolated middle + [next_val]
  5464 00001C9F D1D8                    	rcr	ax, 1
  5465 00001CA1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5466 00001CA4 AB                      	stosw		; interpolated sample 3 (L)
  5467 00001CA5 AB                      	stosw		; interpolated sample 3 (R)
  5468 00001CA6 C3                      	retn
  5469                                  
  5470                                  interpolating_4_16bit_stereo:
  5471                                  	; 18/11/2023
  5472                                  	; bx = [previous_val_l]
  5473                                  	; ax = [previous_val_r]
  5474                                  	; [next_val_l]
  5475                                  	; [next_val_r]
  5476                                  	; original-interpolated-interpolated-interpolated
  5477 00001CA7 93                      	xchg	ax, bx
  5478 00001CA8 AB                      	stosw		; original sample (L)
  5479 00001CA9 93                      	xchg	ax, bx
  5480 00001CAA AB                      	stosw		; original sample (R)
  5481 00001CAB 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5482 00001CAE 89C2                    	mov	dx, ax	; [previous_val_r]
  5483 00001CB0 80C780                  	add	bh, 80h
  5484 00001CB3 8006[081D]80            	add	byte [next_val_l+1], 80h
  5485 00001CB8 A1[071D]                	mov	ax, [next_val_l]
  5486 00001CBB 01D8                    	add	ax, bx	; [previous_val_l]
  5487 00001CBD D1D8                    	rcr	ax, 1
  5488 00001CBF 93                      	xchg	ax, bx
  5489 00001CC0 01D8                    	add	ax, bx	; bx = interpolated middle (L)
  5490 00001CC2 D1D8                    	rcr	ax, 1
  5491 00001CC4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5492 00001CC7 AB                      	stosw 		; interpolated sample 1 (L)
  5493 00001CC8 8006[0A1D]80            	add	byte [next_val_r+1], 80h
  5494 00001CCD 89D0                    	mov	ax, dx	; [previous_val_r]
  5495 00001CCF 0306[091D]              	add	ax, [next_val_r]
  5496 00001CD3 D1D8                    	rcr	ax, 1
  5497 00001CD5 92                      	xchg	ax, dx	
  5498 00001CD6 01D0                    	add	ax, dx	; dx = interpolated middle (R)
  5499 00001CD8 D1D8                    	rcr	ax, 1
  5500 00001CDA 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5501 00001CDD AB                      	stosw 		; interpolated sample 1 (R)
  5502 00001CDE 89D8                    	mov	ax, bx
  5503 00001CE0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5504 00001CE3 AB                      	stosw 		; interpolated sample 2 (L)
  5505 00001CE4 89D0                    	mov	ax, dx
  5506 00001CE6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5507 00001CE9 AB                      	stosw 		; interpolated sample 2 (R)
  5508 00001CEA 89D8                    	mov	ax, bx
  5509 00001CEC 0306[071D]              	add	ax, [next_val_l]
  5510 00001CF0 D1D8                    	rcr	ax, 1
  5511 00001CF2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5512 00001CF5 AB                      	stosw 		; interpolated sample 3 (L)
  5513 00001CF6 89D0                    	mov	ax, dx
  5514 00001CF8 0306[091D]              	add	ax, [next_val_r]
  5515 00001CFC D1D8                    	rcr	ax, 1
  5516 00001CFE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5517 00001D01 AB                      	stosw 		; interpolated sample 3 (R)
  5518 00001D02 C3                      	retn
  5519                                  
  5520                                  ; 13/11/2023
  5521                                  previous_val:
  5522 00001D03 0000                    previous_val_l: dw 0
  5523 00001D05 0000                    previous_val_r: dw 0
  5524                                  next_val:
  5525 00001D07 0000                    next_val_l: dw 0
  5526 00001D09 0000                    next_val_r: dw 0
  5527                                  
  5528                                  ; 16/11/2023
  5529 00001D0B 00                      faz:	db 0
  5530                                  
  5531                                  ; --------------------------------------------------------
  5532                                  ; 14/11/2024 - Erdogan Tan
  5533                                  ; --------------------------------------------------------
  5534                                  
  5535                                  	; 01/01/2025 (cgaplay.asm, 16bit registers)
  5536                                  	; 07/12/2024
  5537                                  	; 01/12/2024 (32bit registers)
  5538                                  	; 29/11/2024
  5539                                  checkUpdateEvents:
  5540 00001D0C E87E01                  	call	check4keyboardstop
  5541 00001D0F 7251                    	jc	short c4ue_ok
  5542                                  
  5543                                  	; 01/01/2025
  5544                                  	; 18/11/2024
  5545 00001D11 50                      	push	ax ; *
  5546 00001D12 09C0                    	or	ax, ax
  5547 00001D14 0F849E00                	jz	c4ue_cpt
  5548                                  
  5549                                  	; 18/11/2024
  5550 00001D18 3C20                    	cmp	al, 20h ; SPACE (spacebar) ; pause/play
  5551 00001D1A 752C                    	jne	short c4ue_chk_s
  5552 00001D1C 803E[D429]00            	cmp	byte [stopped], 0
  5553 00001D21 770C                    	ja	short c4ue_chk_ps
  5554                                  	; pause
  5555 00001D23 E8DFEB                  	call	ac97_pause
  5556                                  	; 21/11/2024
  5557 00001D26 A0[D529]                	mov	al, [tLO]
  5558 00001D29 A2[D629]                	mov	byte [tLP], al
  5559 00001D2C E98700                  	jmp	c4ue_cpt
  5560                                  c4ue_chk_ps:
  5561 00001D2F 803E[D429]01            	cmp	byte [stopped], 1
  5562 00001D34 7705                    	ja	short c4ue_replay
  5563                                  	; continue to play (after a pause)
  5564 00001D36 E8D3EB                  	call	ac97_play 
  5565 00001D39 EB7B                    	jmp	c4ue_cpt
  5566                                  c4ue_replay:
  5567                                  	; 19/11/2024
  5568 00001D3B 58                      	pop	ax ; *
  5569 00001D3C 58                      	pop	ax ; return address
  5570                                  	; 07/02/2024
  5571                                  	;mov	al, [volume]
  5572                                  	;call	SetmasterVolume
  5573 00001D3D C606[D429]00            	mov	byte [stopped], 0
  5574 00001D42 E85903                  	call	move_to_beginning
  5575                                  	;jmp	PlayWav
  5576                                  	; 07/12/2024
  5577 00001D45 E9D1E6                  	jmp	RePlayWav
  5578                                  
  5579                                  c4ue_chk_s:
  5580 00001D48 3C53                    	cmp	al, 'S'	; stop
  5581 00001D4A 7517                    	jne	short c4ue_chk_fb
  5582 00001D4C 803E[D429]00            	cmp	byte [stopped], 0
  5583 00001D51 7763                    	ja	c4ue_cpt ; Already stopped/paused
  5584 00001D53 E89FEB                  	call	ac97_stop
  5585                                  	; 19/11/2024
  5586 00001D56 C606[D529]00            	mov	byte [tLO], 0
  5587                                  	; 21/11/2024
  5588 00001D5B C606[D629]30            	mov	byte [tLP], '0'
  5589 00001D60 EB54                    	jmp	c4ue_cpt
  5590                                  
  5591                                  	; 01/12/2024
  5592                                  	; 18/11/2024
  5593                                  c4ue_ok:
  5594 00001D62 C3                      	retn
  5595                                  
  5596                                  c4ue_chk_fb:
  5597                                  	; 17/11/2024
  5598 00001D63 3C46                    	cmp	al, 'F'
  5599 00001D65 7505                    	jne	short c4ue_chk_b
  5600 00001D67 E81003                  	call 	Player_ProcessKey_Forwards
  5601 00001D6A EB4A                    	jmp	c4ue_cpt
  5602                                  
  5603                                  c4ue_chk_b:
  5604 00001D6C 3C42                    	cmp	al, 'B'
  5605                                  	;;jne	short c4ue_cpt
  5606                                  	; 19/11/2024
  5607                                  	;jne	short c4ue_chk_h
  5608                                  	; 25/12/2024
  5609                                  	; 29/11/2024
  5610 00001D6E 7505                    	jne	short c4ue_chk_n
  5611 00001D70 E80303                  	call 	Player_ProcessKey_Backwards
  5612 00001D73 EB41                    	jmp	short c4ue_cpt
  5613                                  
  5614                                  	;;;
  5615                                  	; 25/12/2024
  5616                                  	; 29/11/2024
  5617                                  c4ue_chk_n:
  5618 00001D75 3C4E                    	cmp	al, 'N'
  5619 00001D77 7404                    	je	short c4ue_nps
  5620                                  c4ue_chk_p:
  5621 00001D79 3C50                    	cmp	al, 'P'
  5622 00001D7B 7507                    	jne	short c4ue_chk_h
  5623                                  c4ue_nps:
  5624 00001D7D C606[D429]03            	mov	byte [stopped], 3
  5625 00001D82 EB32                    	jmp	short c4ue_cpt
  5626                                  	;;;
  5627                                  
  5628                                  c4ue_chk_h:
  5629                                  	; 19/11/2024
  5630 00001D84 3C48                    	cmp	al, 'H'
  5631 00001D86 750A                    	jne	short c4ue_chk_cr
  5632 00001D88 C606[D729]00            	mov	byte [wpoints], 0
  5633 00001D8D E899EC                  	call 	write_ac97_pci_dev_info
  5634                                  	; 30/12/2024
  5635 00001D90 EB24                    	jmp	short c4ue_cpt
  5636                                  c4ue_chk_cr:
  5637                                  	;;;
  5638                                  	; 24/12/2024 (wave lighting points option)
  5639                                  	;mov	ah, [wpoints]
  5640                                  	; 01/01/2025
  5641 00001D92 31DB                    	xor	bx, bx
  5642 00001D94 8A1E[D729]              	mov	bl, [wpoints]
  5643 00001D98 3C47                    	cmp	al, 'G'
  5644 00001D9A 7406                    	je	short c4ue_g
  5645                                  	; 19/11/2024
  5646 00001D9C 3C0D                    	cmp	al, 0Dh ; ENTER/CR key
  5647 00001D9E 7516                    	jne	short c4ue_cpt
  5648                                  	; 23/11/2024
  5649                                  	;xor	bx, bx
  5650                                  	; 30/12/2024
  5651                                  	;mov	bl, ah ; 24/12/2024
  5652 00001DA0 FEC3                    	inc	bl
  5653                                  c4ue_g:	; 30/12/2024
  5654 00001DA2 80E307                  	and	bl, 07h
  5655 00001DA5 7501                    	jnz	short c4ue_sc
  5656                                  	; 01/01/2025
  5657 00001DA7 43                      	inc	bx
  5658                                  c4ue_sc:
  5659 00001DA8 881E[D729]              	mov	[wpoints], bl
  5660                                  	; 01/01/2025
  5661 00001DAC 8A87[4727]              	mov	al, [bx+colors-1] ; 1 to 7
  5662                                  	; 24/12/2024
  5663 00001DB0 A2[4F27]                	mov	[ccolor], al
  5664                                  	; 30/12/2024
  5665 00001DB3 E82403                  	call	clear_window
  5666                                  	;;;
  5667                                  c4ue_cpt:
  5668 00001DB6 1E                      	push	ds
  5669 00001DB7 BB4000                  	mov	bx, 40h
  5670 00001DBA 8EDB                    	mov	ds, bx
  5671 00001DBC BB6C00                  	mov	bx, 6Ch  ; counter (INT 08h, 18.2 ticks per sec)
  5672                                  	;cli
  5673 00001DBF 8B07                    	mov	ax, [bx]
  5674 00001DC1 8B5702                  	mov	dx, [bx+2]
  5675                                  	;sti
  5676 00001DC4 1F                      	pop	ds
  5677                                  	; 18/11/2024
  5678 00001DC5 59                      	pop	cx ; *
  5679 00001DC6 3B16[8C2A]              	cmp	dx, [timerticks+2]
  5680 00001DCA 7506                    	jne	short c4ue_utt
  5681 00001DCC 3B06[8A2A]              	cmp	ax, [timerticks]
  5682                                  	;je	short c4ue_ok
  5683                                  	; 18/11/2024
  5684 00001DD0 740A                    	je	short c4ue_skip_utt
  5685                                  c4ue_utt:
  5686                                  	; 01/01/2025
  5687 00001DD2 A3[8A2A]                	mov	[timerticks], ax
  5688 00001DD5 8916[8C2A]              	mov	[timerticks+2], dx
  5689 00001DD9 EB05                    	jmp	short c4ue_cpt_@
  5690                                  
  5691                                  	; 30/12/2024
  5692                                  c4ue_vb_ok:
  5693 00001DDB C3                      	retn
  5694                                  
  5695                                  c4ue_skip_utt:
  5696                                  	; 01/01/2025
  5697                                  	; 18/11/2024
  5698 00001DDC 21C9                    	and	cx, cx
  5699 00001DDE 74FB                    	jz	short c4ue_vb_ok
  5700                                  c4ue_cpt_@:
  5701                                  	; 18/11/2024
  5702 00001DE0 803E[D429]00            	cmp	byte [stopped], 0
  5703 00001DE5 77F4                    	ja	short c4ue_vb_ok
  5704                                  	
  5705 00001DE7 E88A01                  	call	CalcProgressTime
  5706                                  
  5707 00001DEA 3B06[822A]              	cmp	ax, [ProgressTime]
  5708                                  	;je	short c4ue_vb_ok
  5709                                  			; same second, no need to update
  5710                                  	; 23/11/2024
  5711 00001DEE 7403                    	je	short c4ue_uvb
  5712                                  
  5713                                  	;call	UpdateProgressTime
  5714                                  	;call	UpdateProgressBar@
  5715 00001DF0 E82502                  	call	UpdateProgressBar
  5716                                  
  5717                                  	; 23/11/2024
  5718                                  c4ue_uvb:
  5719 00001DF3 803E[D729]00            	cmp	byte [wpoints], 0
  5720 00001DF8 76E1                    	jna	short c4ue_vb_ok
  5721                                  
  5722                                  	; 30/12/2024
  5723                                  	;call	UpdateWavePoints
  5724                                  	;retn
  5725                                  
  5726                                  ; --------------------------------------------------------
  5727                                  ; 27/12/2024 - Erdogan Tan
  5728                                  ; --------------------------------------------------------
  5729                                  
  5730                                  	; 01/01/2025 (cgaplay.asm, 16bit registers)
  5731                                  	; 30/12/2024 (cgaplay.s)
  5732                                  	;  * 320*200 pixels, 256 colors
  5733                                  	;  * 64 volume levels
  5734                                  	; 29/12/2024
  5735                                  	; 27/12/2024 (DMA Buffer Tracking)
  5736                                  	; 26/12/2024
  5737                                  	; 24/12/2024
  5738                                  UpdateWavePoints:
  5739                                  	; 01/01/2024
  5740 00001DFA 06                      	push	es ; **
  5741 00001DFB BB00A0                  	mov	bx, 0A000h
  5742 00001DFE 8EC3                    	mov	es, bx
  5743                                  	;
  5744 00001E00 BE[5427]                	mov	si, prev_points
  5745 00001E03 833C00                  	cmp	word [si], 0
  5746 00001E06 740C                    	jz	short lights_off_ok
  5747                                  
  5748                                  	;mov	cx, 640
  5749                                  	; 30/12/2024
  5750 00001E08 B94001                  	mov	cx, 320
  5751                                  light_off:
  5752 00001E0B AD                      	lodsw
  5753                                  	; ax = wave point (lighting point) address
  5754                                  	;mov	byte [ax], 0 ; black point (light off)
  5755                                  	; 01/01/2025 (16bit mode modification)
  5756 00001E0C 89C3                    	mov	bx, ax
  5757 00001E0E 26C60700                	mov	byte [es:bx], 0
  5758 00001E12 E2F7                    	loop	light_off
  5759                                  
  5760                                  lights_off_ok:
  5761                                  	; 29/12/2024
  5762 00001E14 803E[D529]32            	cmp	byte [tLO],'2'
  5763 00001E19 7506                    	jne	short lights_on_buff_1
  5764                                  lights_on_buff_2:
  5765                                  	; 01/01/2025
  5766 00001E1B 8B16[762A]              	mov	dx, [WAV_BUFFER2]
  5767 00001E1F EB04                    	jmp	short lights_on
  5768                                  lights_on_buff_1:
  5769                                  	; 01/01/2025
  5770 00001E21 8B16[742A]              	mov	dx, [WAV_BUFFER1]
  5771                                  lights_on:
  5772 00001E25 3916[DA29]              	cmp	[pbuf_s], dx
  5773 00001E29 751C                    	jne	short lights_on_2
  5774 00001E2B 8B1E[5027]              	mov	bx, [wpoints_dif]
  5775 00001E2F 8B36[D829]              	mov	si, [pbuf_o]
  5776 00001E33 8B0E[7C2A]              	mov	cx, [buffersize] ; samples
  5777                                  	; 01/01/2025
  5778 00001E37 D1E1                    	shl	cx, 1  ; bytes
  5779 00001E39 29D9                    	sub	cx, bx ; sub cx, [wpoints_dif]
  5780 00001E3B 01DE                    	add	si, bx
  5781 00001E3D 7204                    	jc	short lights_on_1
  5782 00001E3F 39CE                    	cmp	si, cx
  5783 00001E41 760A                    	jna	short lights_on_3
  5784                                  lights_on_1:
  5785 00001E43 89CE                    	mov	si, cx
  5786 00001E45 EB06                    	jmp	short lights_on_3
  5787                                  
  5788                                  lights_on_2:
  5789                                  	; 29/12/2024
  5790 00001E47 8916[DA29]              	mov	[pbuf_s], dx
  5791 00001E4B 31F6                    	xor	si, si ; 0
  5792                                  lights_on_3:
  5793 00001E4D 8936[D829]              	mov	[pbuf_o], si
  5794                                  	; 01/01/2025
  5795 00001E51 1E                      	push	ds ; **
  5796                                  	;
  5797                                  	;mov	cx, 640
  5798                                  	; 30/12/2024
  5799 00001E52 B94001                  	mov	cx, 320
  5800 00001E55 89CD                    	mov	bp, cx
  5801                                  	; 26/12/2024
  5802 00001E57 BF[5427]                	mov	di, prev_points
  5803                                  	;mov	bx, [graphstart] ; start (top) line
  5804                                  	; 01/01/2025
  5805 00001E5A 8EDA                    	mov	ds, dx
  5806 00001E5C BB0073                  	mov	bx, (11*8*320)+(4*320)
  5807                                  lights_on_4:
  5808                                  	; 01/01/2025
  5809 00001E5F 6631C0                  	xor	eax, eax ; 0
  5810 00001E62 AD                      	lodsw	; left
  5811 00001E63 80C480                  	add	ah, 80h
  5812 00001E66 6689C2                  	mov	edx, eax
  5813 00001E69 AD                      	lodsw	; right
  5814                                  	;add	ax, dx
  5815 00001E6A 80C480                  	add	ah, 80h
  5816                                  	;;shr	eax, 9	; 128 volume levels
  5817 00001E6D 6601D0                  	add	eax, edx
  5818                                  	;;shr	eax, 10	; (L+R/2) & 128 volume levels
  5819                                  	;shr	eax, 9	; (L+R/2) & 256 volume levels
  5820                                  	; 30/12/2024
  5821 00001E70 66C1E80B                	shr	eax, 11	; (L+R/2) & 64 volume levels
  5822                                  	; * 320 row  ; 30/12/2024
  5823 00001E74 F7E5                    	mul	bp	; * 640 (row) 
  5824 00001E76 01D8                    	add	ax, bx ; + column
  5825                                  	;mov	dl, [ccolor]
  5826                                  	; 01/01/2025
  5827 00001E78 2E8A16[4F27]            	mov	dl, [cs:ccolor]
  5828 00001E7D 93                      	xchg	ax, bx
  5829 00001E7E 268817                  	mov	[es:bx], dl ; pixel (light on) color
  5830 00001E81 93                      	xchg	ax, bx
  5831 00001E82 2E8905                  	mov	[cs:di], ax ; save light on addr in prev_points
  5832 00001E85 47                      	inc	di
  5833 00001E86 47                      	inc	di
  5834 00001E87 43                      	inc	bx
  5835 00001E88 E2D5                    	loop	lights_on_4
  5836 00001E8A 1F                      	pop	ds ; **
  5837 00001E8B 07                      	pop	es ; *
  5838 00001E8C C3                      	retn
  5839                                  
  5840                                  ; --------------------------------------------------------
  5841                                  ; 19/05/2024 - (playwav4.asm) ich_wav4.asm
  5842                                  ; --------------------------------------------------------
  5843                                  
  5844                                  	; 29/11/2024
  5845                                  check4keyboardstop:
  5846                                  	; 19/05/2024
  5847                                  	; 08/11/2023
  5848                                  	; 04/11/2023
  5849 00001E8D B401                    	mov	ah, 1
  5850 00001E8F CD16                    	int	16h
  5851                                  	;clc
  5852 00001E91 742C                    	jz	short _cksr
  5853                                  
  5854 00001E93 30E4                    	xor	ah, ah
  5855 00001E95 CD16                    	int	16h
  5856                                  
  5857                                  	; 29/11/2024
  5858 00001E97 A2[DD29]                	mov	[command], al
  5859                                  
  5860                                  	;;;
  5861                                  	; 19/05/2024 (change PCM out volume)
  5862 00001E9A 3C2B                    	cmp	al, '+'
  5863 00001E9C 750B                    	jne	short p_1
  5864                                  	
  5865 00001E9E A0[E51E]                	mov	al, [volume]
  5866 00001EA1 3C00                    	cmp	al, 0
  5867 00001EA3 761C                    	jna	short p_3
  5868 00001EA5 FEC8                    	dec	al
  5869 00001EA7 EB0D                    	jmp	short p_2
  5870                                  p_1:
  5871 00001EA9 3C2D                    	cmp	al, '-'
  5872 00001EAB 7515                    	jne	short p_4
  5873                                  
  5874 00001EAD A0[E51E]                	mov	al, [volume]
  5875 00001EB0 3C1F                    	cmp	al, 31
  5876 00001EB2 730D                    	jnb	short p_3
  5877 00001EB4 FEC0                    	inc	al
  5878                                  p_2:
  5879 00001EB6 A2[E51E]                	mov	[volume], al
  5880                                  	; 14/11/2024
  5881 00001EB9 E881E6                  	call	SetPCMOutVolume
  5882                                  	; 15/11/2024 (QEMU)
  5883                                  	;call	SetMasterVolume
  5884                                  	;call	UpdateVolume
  5885                                  	;;clc
  5886                                  	;retn
  5887 00001EBC E93101                  	jmp	UpdateVolume
  5888                                  	;mov	ah, al
  5889                                  	;mov    dx, [NAMBAR]
  5890                                    	;;add   dx, CODEC_MASTER_VOL_REG
  5891                                  	;add	dx, CODEC_PCM_OUT_REG
  5892                                  	;out    dx, ax
  5893                                  	;
  5894                                  	;call   delay1_4ms
  5895                                          ;call   delay1_4ms
  5896                                          ;call   delay1_4ms
  5897                                          ;call   delay1_4ms
  5898                                  _cksr:		; 19/05/2024
  5899                                  	; 18/11/2024
  5900 00001EBF 31C0                    	xor	ax, ax
  5901                                  	;clc
  5902                                  p_3:
  5903 00001EC1 C3                      	retn
  5904                                  p_4:
  5905                                  	; 17/11/2024
  5906 00001EC2 80FC01                  	cmp	ah, 01h  ; ESC
  5907 00001EC5 7417                        	je	short p_q
  5908 00001EC7 3C03                    	cmp	al, 03h  ; CTRL+C
  5909 00001EC9 7413                    	je	short p_q
  5910                                  
  5911                                  	; 18/11/2024
  5912 00001ECB 3C20                    	cmp	al, 20h
  5913 00001ECD 7415                    	je	short p_r
  5914                                  
  5915                                  	; 19/11/2024
  5916 00001ECF 3C0D                    	cmp	al, 0Dh ; CR/ENTER
  5917 00001ED1 7411                    	je	short p_r
  5918                                  
  5919 00001ED3 24DF                    	and	al, 0DFh
  5920                                  
  5921                                  	; 29/11/2024
  5922 00001ED5 A2[DD29]                	mov	[command], al
  5923                                  
  5924                                  	;cmp	al, 'B'
  5925                                  	;je	short p_r
  5926                                  	;cmp	al, 'F'
  5927                                  	;je	short p_r
  5928                                  
  5929                                  	; 29/11/2024
  5930                                  	;cmp	al, 'N'
  5931                                  	;je	short p_r
  5932                                  	;cmp	al, 'P'
  5933                                  	;je	short p_r
  5934                                  
  5935 00001ED8 3C51                    	cmp	al, 'Q'
  5936                                  	;je	short p_q
  5937 00001EDA 7407                    	je	short p_quit ; 29/11/2024
  5938                                  
  5939 00001EDC F8                      	clc
  5940 00001EDD C3                      	retn
  5941                                  
  5942                                  	;;;
  5943                                  ;_cskr:	
  5944                                  p_q:
  5945                                  	; 29/11/2024
  5946 00001EDE C606[DD29]51            	mov	byte [command], 'Q'
  5947                                  p_quit:
  5948 00001EE3 F9                      	stc
  5949                                  p_r:
  5950 00001EE4 C3                      	retn
  5951                                  
  5952                                  ; 29/05/2024
  5953                                  ; 19/05/2024
  5954                                  volume: 
  5955                                  	;db	02h
  5956                                  ; 26/12/2024
  5957 00001EE5 03                      	db	03h
  5958                                  
  5959                                  ; --------------------------------------------------------
  5960                                  
  5961                                  	; 01/01/2025 /cgaplay.asm)
  5962                                  setCursorPosition:
  5963                                  	; dh = Row
  5964                                  	; dl = Column
  5965                                  
  5966                                  	; 31/12/2024
  5967 00001EE6 B700                    	mov	bh, 0
  5968 00001EE8 B402                    	mov	ah, 02h
  5969 00001EEA CD10                    	int	10h
  5970 00001EEC C3                      	retn
  5971                                  	
  5972                                  ; --------------------------------------------------------
  5973                                  ; 14/11/2024
  5974                                  ; (Ref: player.asm, out_cs.asm, Matan Alfasi, 2017)
  5975                                  
  5976                                  ;; NAME:	SetTotalTime
  5977                                  ;; DESCRIPTION: Calculates the total time in seconds in file
  5978                                  ;; INPUT:	DATA_SubchunkSize, WAVE_SampleRate, WAVE_BlockAlign
  5979                                  ;; OUTPUT:	CurrentTotalTime=Total time in seconds in file,
  5980                                  ;; 		Output on the screen of the total time in seconds
  5981                                  
  5982                                  	; 01/01/2025
  5983                                  SetTotalTime:
  5984                                  	;; Calculate total seconds in file
  5985 00001EED A1[082A]                	mov	ax, [DATA_SubchunkSize]
  5986 00001EF0 8B16[0A2A]              	mov	dx, [DATA_SubchunkSize+2]
  5987 00001EF4 8B1E[F829]              	mov	bx, [WAVE_SampleRate]
  5988 00001EF8 F7F3                    	div	bx
  5989 00001EFA 31D2                    	xor	dx, dx
  5990                                  
  5991 00001EFC 8B1E[002A]              	mov	bx, [WAVE_BlockAlign]
  5992                                  
  5993 00001F00 F7F3                    	div	bx
  5994                                  
  5995 00001F02 A3[802A]                	mov	[TotalTime], ax
  5996                                  
  5997 00001F05 B33C                    	mov	bl, 60
  5998 00001F07 F6F3                    	div	bl
  5999                                  
  6000                                  	;; al = minutes, ah = seconds
  6001 00001F09 50                      	push	ax ; **
  6002 00001F0A 50                      	push	ax ; *
  6003                                  
  6004                                  	;mov	dh, 24
  6005                                  	;mov	dl, 42
  6006                                  	; 01/01/2025 (cgaplay.asm, video mode 13h)
  6007 00001F0B B617                    	mov	dh, 23
  6008 00001F0D B216                    	mov	dl, 22
  6009 00001F0F E8D4FF                  	call	setCursorPosition
  6010                                  
  6011 00001F12 58                      	pop	ax ; *
  6012 00001F13 30E4                    	xor	ah, ah
  6013 00001F15 BD0200                  	mov	bp, 2
  6014 00001F18 E80F00                  	call	PrintNumber
  6015                                  	
  6016                                  	;mov	dh, 24
  6017                                  	;mov	dl, 45
  6018                                  	; 01/01/2025 (cgaplay.asm, video mode 13h)
  6019 00001F1B B617                    	mov	dh, 23
  6020 00001F1D B219                    	mov	dl, 25
  6021 00001F1F E8C4FF                  	call	setCursorPosition
  6022                                  
  6023 00001F22 58                      	pop	ax ; **
  6024 00001F23 88E0                    	mov	al, ah
  6025 00001F25 30E4                    	xor	ah, ah
  6026 00001F27 BD0200                  	mov	bp, 2
  6027                                  	;jmp	short PrintNumber
  6028                                  
  6029                                  ; --------------------------------------------------------
  6030                                  
  6031                                  	; 01/01/2025 (cgaplay.asm)
  6032                                  PrintNumber:
  6033                                  	; bp = digits
  6034                                  	; ax = binary number
  6035 00001F2A BB0A00                  	mov	bx, 10
  6036 00001F2D 31C9                    	xor	cx, cx
  6037                                  printNumber_CutNumber:
  6038 00001F2F 41                      	inc	cx
  6039 00001F30 31D2                    	xor	dx, dx
  6040 00001F32 F7F3                    	div	bx
  6041 00001F34 52                      	push	dx
  6042 00001F35 39E9                    	cmp	cx, bp
  6043 00001F37 7402                    	je	short printNumber_printloop
  6044 00001F39 EBF4                    	jmp	printNumber_CutNumber
  6045                                  
  6046                                  printNumber_printloop:
  6047 00001F3B 58                      	pop	ax
  6048                                  	; bp = count of digits
  6049                                  	; ax <= 9
  6050                                  
  6051 00001F3C 0430                    	add	al, '0'
  6052                                  	
  6053                                  	; al = character
  6054 00001F3E E8CE00                  	call	write_character_white
  6055                                  
  6056 00001F41 4D                      	dec	bp
  6057 00001F42 7402                     	jz	short printNumber_ok
  6058 00001F44 EBF5                    	jmp	short printNumber_printloop
  6059                                  printNumber_ok:
  6060 00001F46 C3                      	retn
  6061                                  
  6062                                  ; --------------------------------------------------------
  6063                                  
  6064                                  	; 01/01/2025
  6065                                  	; 14/11/2024 - Erdogan Tan
  6066                                  SetProgressTime:
  6067                                  	;; Calculate playing/progress seconds in file
  6068 00001F47 E82A00                  	call	CalcProgressTime
  6069                                  
  6070                                  UpdateProgressTime:
  6071                                  	; ax = (new) progress time 
  6072                                  
  6073 00001F4A A3[822A]                	mov	[ProgressTime], ax
  6074                                  
  6075 00001F4D B33C                    	mov	bl, 60
  6076 00001F4F F6F3                    	div	bl
  6077                                  
  6078                                  	;; al = minutes, ah = seconds
  6079 00001F51 50                      	push	ax ; **
  6080 00001F52 50                      	push	ax ; *
  6081                                  
  6082                                  	;mov	dh, 24
  6083                                  	;mov	dl, 33
  6084                                  	; 01/01/2025 (cgaplay.asm, video mode 13h)
  6085 00001F53 B617                    	mov	dh, 23
  6086 00001F55 B20D                    	mov	dl, 13
  6087 00001F57 E88CFF                  	call	setCursorPosition
  6088                                  
  6089 00001F5A 58                      	pop	ax ; *
  6090 00001F5B 30E4                    	xor	ah, ah
  6091 00001F5D BD0200                  	mov	bp, 2
  6092 00001F60 E8C7FF                  	call	PrintNumber
  6093                                  	
  6094                                  	;mov	dh, 24
  6095                                  	;mov	dl, 36
  6096                                  	; 01/01/2025 (cgaplay.asm, video mode 13h)
  6097 00001F63 B617                    	mov	dh, 23
  6098 00001F65 B210                    	mov	dl, 16
  6099 00001F67 E87CFF                  	call	setCursorPosition
  6100                                  
  6101 00001F6A 58                      	pop	ax ; **
  6102 00001F6B 88E0                    	mov	al, ah
  6103 00001F6D 30E4                    	xor	ah, ah
  6104                                  	; 21/12/2024
  6105 00001F6F BD0200                  	mov	bp, 2
  6106 00001F72 EBB6                    	jmp	short PrintNumber
  6107                                  
  6108                                  ; --------------------------------------------------------
  6109                                  
  6110                                  	; 17/11/2024
  6111                                  	; 14/11/2024
  6112                                  CalcProgressTime:
  6113 00001F74 A1[862A]                	mov	ax, [LoadedDataBytes]
  6114 00001F77 8B16[882A]              	mov	dx, [LoadedDataBytes+2]
  6115 00001F7B 89C3                    	mov	bx, ax
  6116 00001F7D 09D3                    	or	bx, dx
  6117 00001F7F 740E                    	jz	short cpt_ok
  6118                                  
  6119 00001F81 8B1E[F829]              	mov	bx, [WAVE_SampleRate]
  6120 00001F85 F7F3                    	div	bx
  6121 00001F87 31D2                    	xor	dx, dx
  6122 00001F89 8B1E[002A]              	mov	bx, [WAVE_BlockAlign]
  6123 00001F8D F7F3                    	div	bx
  6124                                  cpt_ok:
  6125                                  	; ax = (new) progress time
  6126 00001F8F C3                      	retn
  6127                                  
  6128                                  ; --------------------------------------------------------
  6129                                  ; 14/11/2024
  6130                                  ; (Ref: player.asm, out_cs.asm, Matan Alfasi, 2017)
  6131                                  
  6132                                  ;; DESCRIPTION: Update file information on template
  6133                                  ;; PARAMS:	WAVE parameters and other variables
  6134                                  ;; REGS:	AX(RW)
  6135                                  ;; VARS:	CurrentFileName, WAVE_SampleRate, 
  6136                                  ;; RETURNS:	On-screen file info is updated.
  6137                                  
  6138                                  	; 01/01/2025 (cgaplay.asm)
  6139                                  UpdateFileInfo:
  6140                                  	;; Print File Name
  6141                                  	;mov	dh, 9
  6142                                  	;mov	dl, 23
  6143                                  	; 01/01/2025 (cgaplay.asm, video mode 13h)
  6144 00001F90 B607                    	mov	dh, 7
  6145 00001F92 B208                    	mov	dl, 8
  6146 00001F94 E84FFF                  	call	setCursorPosition
  6147                                  	
  6148 00001F97 BE[122A]                	mov	si, wav_file_name
  6149                                  	
  6150                                  	;;;
  6151                                  	; 14/11/2024
  6152                                  	; skip directory separators
  6153                                  	; (note: asciiz string, max. 79 bytes except zero tail)
  6154 00001F9A 89F3                    	mov	bx, si
  6155                                  chk4_nxt_sep:
  6156 00001F9C AC                      	lodsb
  6157 00001F9D 3C5C                    	cmp	al, '\'
  6158 00001F9F 7406                    	je	short chg_fpos
  6159 00001FA1 20C0                    	and	al, al
  6160 00001FA3 7406                    	jz	short chg_fpos_ok
  6161 00001FA5 EBF5                    	jmp	short chk4_nxt_sep
  6162                                  chg_fpos:
  6163 00001FA7 89F3                    	mov	bx, si
  6164 00001FA9 EBF1                    	jmp	short chk4_nxt_sep
  6165                                  chg_fpos_ok:
  6166 00001FAB 89DE                    	mov	si, bx	; file name (without its path/directory)
  6167                                  	;;;
  6168                                  _fnl_chk:
  6169                                  	; 01/01/2025 (cplay.asm)
  6170                                  	; 30/12/2024 (cgaplay.s)
  6171                                  	; ????????.wav
  6172                                  	; 26/12/2024 (file name length limit -display-)
  6173 00001FAD BB0C00                  	mov	bx, 12
  6174                                  	;mov	bx, 17	; ????????.wav?????
  6175 00001FB0 56                      	push	si
  6176                                  _fnl_chk_loop:
  6177 00001FB1 AC                      	lodsb
  6178 00001FB2 20C0                    	and	al, al
  6179 00001FB4 7406                    	jz	short _fnl_ok
  6180 00001FB6 4B                       	dec	bx
  6181 00001FB7 75F8                    	jnz	short _fnl_chk_loop
  6182 00001FB9 C60400                  	mov	byte [si], 0
  6183                                  _fnl_ok:
  6184 00001FBC 5E                      	pop	si
  6185                                  	;;;
  6186                                  
  6187 00001FBD E8D3E3                  	call	PrintString
  6188                                  	
  6189                                  	;; Print Frequency
  6190                                  	;mov	dh, 10
  6191                                  	;mov	dl, 23
  6192                                  	; 01/01/2025 (cgaplay.asm, video mode 13h)
  6193 00001FC0 B608                    	mov	dh, 8
  6194 00001FC2 B208                    	mov	dl, 8
  6195 00001FC4 E81FFF                  	call	setCursorPosition
  6196                                  	 
  6197 00001FC7 A1[F829]                	mov	ax, [WAVE_SampleRate]
  6198 00001FCA BD0500                  	mov	bp, 5
  6199 00001FCD E85AFF                  	call	PrintNumber
  6200                                  
  6201                                  	;; Print BitRate
  6202                                  	;mov	dh, 9
  6203                                  	;mov	dl, 57
  6204                                  	; 01/01/2025 (cgaplay.asm, video mode 13h)
  6205 00001FD0 B607                    	mov	dh, 7
  6206 00001FD2 B21F                    	mov	dl, 31
  6207 00001FD4 E80FFF                  	call	setCursorPosition
  6208                                  
  6209 00001FD7 A1[022A]                	mov	ax, [WAVE_BitsPerSample]
  6210 00001FDA BD0200                  	mov	bp, 2
  6211 00001FDD E84AFF                  	call	PrintNumber
  6212                                  
  6213                                  	;; Print Channel Number
  6214                                  	;mov	dh, 10
  6215                                  	;mov	dl, 57
  6216                                  	; 01/01/2025 (cgaplay.asm, video mode 13h)
  6217 00001FE0 B608                    	mov	dh, 8
  6218 00001FE2 B21F                    	mov	dl, 31
  6219 00001FE4 E8FFFE                  	call	setCursorPosition
  6220                                  
  6221 00001FE7 A1[F629]                	mov	ax, [WAVE_NumChannels]
  6222 00001FEA BD0100                  	mov	bp, 1
  6223 00001FED E83AFF                  	call	PrintNumber
  6224                                  
  6225                                  	;call	UpdateVolume
  6226                                  	;retn
  6227                                  
  6228                                  ; --------------------------------------------------------
  6229                                  
  6230                                  	; 01/01/2025
  6231                                  	; 14/11/2024
  6232                                  UpdateVolume:
  6233                                  	;; Print Volume
  6234                                  	;mov	dh, 24
  6235                                  	;mov	dl, 75
  6236                                  	; 01/01/2025 (cgaplay.asm, video mode 13h)
  6237 00001FF0 B617                    	mov	dh, 23
  6238 00001FF2 B223                    	mov	dl, 35
  6239 00001FF4 E8EFFE                  	call	setCursorPosition
  6240                                  	
  6241 00001FF7 A0[E51E]                	mov	al, [volume]
  6242                                  
  6243 00001FFA B364                    	mov	bl, 100
  6244 00001FFC F6E3                    	mul	bl
  6245                                  
  6246 00001FFE B31F                    	mov	bl, 31
  6247 00002000 F6F3                    	div	bl
  6248                                  
  6249 00002002 F7D8                    	neg	ax
  6250 00002004 83C064                  	add	ax, 100
  6251                                  
  6252 00002007 30E4                    	xor	ah, ah
  6253 00002009 BD0300                  	mov	bp, 3
  6254                                  	;call	PrintNumber
  6255                                  	;retn
  6256 0000200C E91BFF                  	jmp	PrintNumber	
  6257                                  
  6258                                  ; --------------------------------------------------------
  6259                                  
  6260                                  	; 01/01/2025 (cgaplay.asm)
  6261                                  write_character_white:
  6262                                  	;mov	cx, 0Fh
  6263 0000200F B30F                    	mov	bl, 0Fh
  6264                                  write_character:
  6265                                  	; 01/12/2024
  6266 00002011 30FF                    	xor	bh, bh
  6267                                  	; bl = foreground color
  6268                                  	; al = character (ASCII code)
  6269 00002013 B40E                    	mov	ah, 0Eh
  6270 00002015 CD10                    	int	10h
  6271 00002017 C3                      	retn
  6272                                  
  6273                                  ; --------------------------------------------------------
  6274                                  
  6275                                  	; 01/01/2025 (cgaplay.asm)
  6276                                  	; 30/12/2024
  6277                                  	; write characters in video mode 13h
  6278                                  	; (320*200 pixels, 256 colors)
  6279                                  	; 22/12/2024
  6280                                  	; 21/12/2024
  6281                                  	; (write chars in VESA VBE graphics mode)
  6282                                  	; 14/11/2024
  6283                                  	; (Ref: player.asm, Matan Alfasi, 2017)
  6284                                  	; (Modification: Erdogan Tan, 14/11/2024)
  6285                                  
  6286                                  	;PROGRESSBAR_ROW equ 23
  6287                                  	; 21/12/2024 (640*480)
  6288                                  	;PROGRESSBAR_ROW equ 31
  6289                                  	; 30/12/2024 (320*200)
  6290                                  	PROGRESSBAR_ROW equ 22
  6291                                  
  6292                                  UpdateProgressBar:
  6293 00002018 E82CFF                  	call	SetProgressTime	; 14/11/2024
  6294                                  
  6295                                  	; 01/01/2025
  6296 0000201B A1[822A]                	mov	ax, [ProgressTime]
  6297                                  UpdateProgressBar@:
  6298                                  	;mov	dx, 80
  6299                                  	; 30/12/2024
  6300 0000201E BA2800                  	mov	dx, 40 ; 320*200 pixels, 40 columns 
  6301 00002021 F7E2                    	mul	dx
  6302 00002023 8B1E[802A]              	mov	bx, [TotalTime]
  6303 00002027 F7F3                    	div	bx
  6304                                  
  6305                                  	; 22/12/2024
  6306                                  	; check progress bar indicator position if it is same 
  6307 00002029 3A06[5327]              	cmp	al, [pbprev]
  6308 0000202D 741E                    	je	short UpdateProgressBar_ok
  6309 0000202F A2[5327]                	mov	[pbprev], al
  6310                                  
  6311                                  	; 01/01/2025
  6312                                  UpdateProgressBar@@:
  6313                                  	;; Push for the 'Clean' part
  6314 00002032 50                      	push	ax ; **
  6315 00002033 50                      	push	ax ; *
  6316                                  
  6317                                  	;; Set cursor position
  6318 00002034 B616                    	mov	dh, PROGRESSBAR_ROW
  6319 00002036 B200                    	mov	dl, 0
  6320 00002038 E8ABFE                  	call	setCursorPosition
  6321                                  
  6322 0000203B 58                      	pop	ax ; *
  6323 0000203C 09C0                    	or	ax, ax
  6324 0000203E 741D                    	jz	short UpdateProgressBar_Clean
  6325                                  
  6326                                  	; 01/01/2025
  6327                                  UpdateProgressBar_DrawProgress:
  6328                                  	; 31/12/2024 (int 31h)
  6329                                  	; 22/12/2024
  6330                                  	; 21/12/2024
  6331                                  	; (write progress bar chars in graphics mode)
  6332                                  	;;;;
  6333 00002040 89C5                    	mov	bp, ax
  6334 00002042 50                      	push	ax ; ***
  6335                                  UpdateProgressBar_DrawProgress_@:
  6336                                  	; 01/01/2025
  6337 00002043 B0DF                    	mov	al, 223
  6338                                  
  6339                                  	; al = character
  6340                                  	;call	write_character
  6341                                  	; 22/12/2024
  6342 00002045 E8C7FF                  	call	write_character_white
  6343                                  
  6344 00002048 4D                      	dec	bp
  6345 00002049 7403                    	jz	short UpdateProgressBar_DrawCursor
  6346 0000204B EBF6                    	jmp	short UpdateProgressBar_DrawProgress_@
  6347                                  
  6348                                  UpdateProgressBar_ok:
  6349 0000204D C3                      	retn
  6350                                  
  6351                                  	; 01/01/2025
  6352                                  UpdateProgressBar_DrawCursor:
  6353                                  	; 22/12/2024
  6354 0000204E 5A                      	pop	dx ; ***
  6355 0000204F B616                    	mov	dh, PROGRESSBAR_ROW
  6356                                  	; 31/12/2024
  6357 00002051 FECA                    	dec	dl ; last written position again
  6358 00002053 E890FE                  	call	setCursorPosition
  6359                                  
  6360                                  	; 01/01/2025	
  6361 00002056 B0DF                    	mov	al, 223
  6362                                  	;mov	cl, 0Ch ; red
  6363                                  	; 01/01/2025
  6364 00002058 B30C                    	mov	bl, 0Ch
  6365 0000205A E8B4FF                  	call	write_character
  6366                                  
  6367                                  	; 01/01/2025
  6368                                  UpdateProgressBar_Clean:
  6369                                  	;pop	ax  ; **
  6370                                  	; 22/12/2024
  6371 0000205D 5A                      	pop	dx  ; **
  6372                                  	; 30/12/2024
  6373                                  	; 21/12/2024
  6374                                  	;mov	bp, 80
  6375                                  	; 30/12/2024
  6376 0000205E BD2800                  	mov	bp, 40 ; 40 columns (320*200 pixels)
  6377                                  	;sub	bp, ax
  6378 00002061 29D5                    	sub	bp, dx ; 22/12/2024
  6379                                  	;jz	short UpdateProgressBar_ok
  6380                                  	; 31/12/2024
  6381 00002063 76E8                    	jna	short UpdateProgressBar_ok
  6382                                  
  6383 00002065 B616                    	mov	dh, PROGRESSBAR_ROW
  6384                                  	;mov	dl, al ; 22/12/2024
  6385 00002067 E87CFE                  	call	setCursorPosition
  6386                                  
  6387                                  	; 21/12/2024
  6388                                  	; (write progress bar chars in graphics mode)
  6389                                  UpdateProgressBar_Clean_@:
  6390                                  	; 01/01/2025	
  6391 0000206A B0DF                    	mov	al, 223
  6392                                  	;mov	cl, 08h ; gray (dark)
  6393 0000206C B308                    	mov	bl, 08h
  6394 0000206E E8A0FF                  	call	write_character
  6395                                  	
  6396 00002071 4D                      	dec	bp
  6397 00002072 74D9                    	jz	short UpdateProgressBar_ok
  6398 00002074 EBF4                    	jmp	short UpdateProgressBar_Clean_@
  6399                                  
  6400                                  ; --------------------------------------------------------
  6401                                  ; 17/11/2024
  6402                                  
  6403                                  Player_ProcessKey_Backwards:
  6404                                  	;; In order to go backwards 5 seconds:
  6405                                  	;; Update file pointer to the beginning, skip headers
  6406 00002076 B142                    	mov	cl, 'B'
  6407 00002078 EB02                    	jmp	short Player_ProcessKey_B_or_F
  6408                                  
  6409                                  Player_ProcessKey_Forwards:
  6410                                  	;; In order to fast-forward 5 seconds, set the file pointer
  6411                                  	;; to CUR_SEEK + 5 * Freq
  6412                                  
  6413 0000207A B146                    	mov	cl, 'F'
  6414                                  	;jmp	short Player_ProcessKey_B_or_F
  6415                                  
  6416                                  	; 01/01/2025 (cgaplay.asm, 16bit registers)
  6417                                  	; 01/12/2024 (32bit registers)
  6418                                  Player_ProcessKey_B_or_F:
  6419                                  	; 17/11/2024
  6420                                  	; 04/11/2024
  6421                                  	; (Ref: player.asm, Matan Alfasi, 2017)
  6422                                    
  6423                                  	; 04/11/2024
  6424 0000207C B80500                  	mov	ax, 5
  6425 0000207F 8B1E[002A]              	mov	bx, [WAVE_BlockAlign]
  6426 00002083 F7E3                    	mul	bx
  6427 00002085 8B1E[F829]              	mov	bx, [WAVE_SampleRate]
  6428 00002089 F7E3                    	mul	bx
  6429                                  	; dx:ax = transfer byte count for 5 seconds
  6430                                  	
  6431                                  	; 17/11/2024
  6432 0000208B 80F942                  	cmp	cl, 'B'
  6433 0000208E 8B1E[862A]              	mov	bx, [LoadedDataBytes]
  6434 00002092 8B0E[882A]              	mov	cx, [LoadedDataBytes+2]
  6435 00002096 750C                    	jne	short move_forward ; cl = 'F'
  6436                                  move_backward:
  6437 00002098 29C3                    	sub	bx, ax
  6438 0000209A 19D1                    	sbb	cx, dx
  6439 0000209C 7322                    	jnc	short move_file_pointer
  6440                                  move_to_beginning:
  6441 0000209E 31C9                    	xor	cx, cx ; 0
  6442 000020A0 31DB                    	xor	bx, bx ; 0
  6443 000020A2 EB1C                    	jmp	short move_file_pointer
  6444                                  move_forward: 
  6445 000020A4 01C3                    	add	bx, ax
  6446 000020A6 11D1                    	adc	cx, dx
  6447 000020A8 720E                    	jc	short move_to_end
  6448 000020AA 3B0E[0A2A]              	cmp	cx, [DATA_SubchunkSize+2]
  6449 000020AE 7708                    	ja	short move_to_end
  6450 000020B0 720E                    	jb	short move_file_pointer
  6451 000020B2 3B1E[082A]              	cmp	bx, [DATA_SubchunkSize]
  6452 000020B6 7608                    	jna	short move_file_pointer
  6453                                  move_to_end:
  6454 000020B8 8B1E[082A]              	mov	bx, [DATA_SubchunkSize]
  6455 000020BC 8B0E[0A2A]              	mov	cx, [DATA_SubchunkSize+2]
  6456                                  move_file_pointer:
  6457 000020C0 89DA                    	mov	dx, bx    
  6458 000020C2 8916[862A]              	mov	[LoadedDataBytes], dx
  6459 000020C6 890E[882A]              	mov	[LoadedDataBytes+2], cx
  6460 000020CA 83C22C                  	add	dx, 44 ; + header
  6461 000020CD 83D100                  	adc	cx, 0
  6462                                  
  6463                                  	; seek
  6464 000020D0 8B1E[0E2A]              	mov	bx, [filehandle]
  6465 000020D4 B80042                  	mov	ax, 4200h
  6466 000020D7 CD21                    	int	21h
  6467                                  	
  6468 000020D9 C3                      	retn
  6469                                  
  6470                                  ; --------------------------------------------------------
  6471                                  
  6472                                  	; 01/01/2025 (cgaplay.asm)
  6473                                  	; (video mode 13h, 320*200, 256 colors)
  6474                                  clear_window:
  6475 000020DA 06                      	push	es
  6476 000020DB BF00A0                  	mov	di, 0A000h
  6477 000020DE 8EC7                    	mov	es, di
  6478 000020E0 BF8070                  	mov	di, (11*8*320)+(2*320) ; AC97 info start 
  6479 000020E3 29C0                    	sub	ax, ax
  6480 000020E5 B90032                  	mov	cx, (10*8*320)/2
  6481 000020E8 F3AB                    	rep	stosw
  6482 000020EA A3[5427]                	mov	[prev_points], ax ; 0
  6483 000020ED 07                      	pop	es
  6484 000020EE C3                      	retn
  6485                                  
  6486                                  ; -------------------------------------------------------------
  6487                                  ; ac97.inc (11/11/2023)
  6488                                  ; -------------------------------------------------------------
  6489                                  
  6490                                  ; special characters
  6491                                  LF      EQU 10
  6492                                  CR      EQU 13
  6493                                  
  6494                                  ; PCI stuff
  6495                                  
  6496                                  BIT0  EQU 1
  6497                                  BIT1  EQU 2
  6498                                  BIT2  EQU 4
  6499                                  BIT8  EQU 100h
  6500                                  BIT9  EQU 200h
  6501                                  BIT28 EQU 10000000h
  6502                                  BIT30 EQU 40000000h
  6503                                  BIT31 EQU 80000000h
  6504                                  
  6505                                  BUP		equ	BIT30		; Buffer Underrun Policy.
  6506                                  					; if this buffer is the last buffer
  6507                                  					; in a playback, fill the remaining
  6508                                  					; samples with 0 (silence) or not.
  6509                                  					; It's a good idea to set this to 1
  6510                                  					; for the last buffer in playback,
  6511                                  					; otherwise you're likely to get a lot
  6512                                  					; of noise at the end of the sound.
  6513                                  
  6514                                  RR		equ	BIT1		; reset registers. Nukes all regs
  6515                                                                          ; except bits 4:2 of this register.
  6516                                                                          ; Only set this bit if BIT 0 is 0
  6517                                  RPBM		equ	BIT0		; Run/Pause
  6518                                  					; set this bit to start the codec!
  6519                                  IO_ENA		EQU	BIT0		; i/o decode enable
  6520                                  BM_ENA		EQU	BIT2		; bus master enable
  6521                                  
  6522                                  PCI_INDEX_PORT  EQU     0CF8h
  6523                                  PCI_DATA_PORT   EQU     0CFCh
  6524                                  PCI32           EQU     BIT31           ; bitflag to signal 32bit access
  6525                                  PCI16           EQU     BIT30           ; bitflag for 16bit access
  6526                                  
  6527                                  AC97_INT_LINE	equ	3Ch		; AC97 Interrupt Line register offset
  6528                                  
  6529                                  ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
  6530                                  
  6531                                  INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
  6532                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  6533                                  SIS_VID		equ	1039h
  6534                                  NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
  6535                                  AMD_VID		equ	1022h
  6536                                  
  6537                                  ICH_DID         equ     2415h           ; ICH device ID
  6538                                  ICH0_DID        equ     2425h           ; ICH0
  6539                                  ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
  6540                                                                          ; they all should be compatible.
  6541                                  
  6542                                  ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
  6543                                  ICH3_DID	equ     2485h           ; ICH3
  6544                                  ICH4_DID        equ     24C5h           ; ICH4
  6545                                  ICH5_DID	equ     24D5h           ; ICH5
  6546                                  ICH6_DID	equ     266Eh           ; ICH6
  6547                                  ESB6300_DID	equ     25A6h           ; 6300ESB
  6548                                  ESB631X_DID	equ     2698h           ; 631XESB
  6549                                  ICH7_DID	equ	27DEh		; ICH7
  6550                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  6551                                  MX82440_DID	equ	7195h
  6552                                  SI7012_DID	equ	7012h
  6553                                  NFORCE_DID	equ	01B1h
  6554                                  NFORCE2_DID	equ	006Ah
  6555                                  AMD8111_DID	equ	746Dh
  6556                                  AMD768_DID	equ	7445h
  6557                                  ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
  6558                                  CK804_DID	equ	0059h
  6559                                  MCP04_DID	equ	003Ah
  6560                                  CK8_DID		equ	008Ah
  6561                                  NFORCE3_DID	equ	00DAh
  6562                                  CK8S_DID	equ	00EAh
  6563                                  
  6564                                  NAMBAR_REG	equ	10h		; native audio mixer BAR
  6565                                  NABMBAR_REG	equ	14h		; native audio bus mastering BAR
  6566                                  
  6567                                  CODEC_MASTER_VOL_REG	equ	02h	; master volume
  6568                                  CODEC_MASTER_TONE_REG	equ	08h	; master tone (R+L)
  6569                                  CODEC_PCM_OUT_REG 	equ	18h     ; PCM output volume
  6570                                  CODEC_EXT_AUDIO_REG	equ	28h	; extended audio
  6571                                  CODEC_EXT_AUDIO_CTRL_REG equ	2Ah	; extended audio control
  6572                                  CODEC_PCM_FRONT_DACRATE_REG equ	2Ch	; PCM out sample rate
  6573                                  
  6574                                  ; ICH supports 3 different types of register sets for three types of things
  6575                                  ; it can do, thus:
  6576                                  ;
  6577                                  ; PCM in (for recording) aka PI
  6578                                  ; PCM out (for playback) aka PO
  6579                                  ; MIC in (for recording) aka MC
  6580                                  
  6581                                  PI_BDBAR_REG	equ	0		; PCM in buffer descriptor BAR
  6582                                  PO_BDBAR_REG	equ	10h		; PCM out buffer descriptor BAR
  6583                                  
  6584                                  GLOB_CNT_REG	equ	2Ch		; Global control register
  6585                                  GLOB_STS_REG 	equ	30h		; Global Status register (RO)
  6586                                  
  6587                                  PI_CR_REG 	equ	0Bh		; PCM in Control Register
  6588                                  PO_CR_REG	equ	1Bh		; PCM out Control Register
  6589                                  MC_CR_REG	equ	2Bh		; MIC in Control Register
  6590                                  
  6591                                  PCI_CMD_REG	EQU	04h		; reg 04h, command register
  6592                                  
  6593                                  CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
  6594                                  CODEC_REG_POWERDOWN	equ	26h
  6595                                  
  6596                                  PO_CIV_REG	equ	14h		; PCM out current Index value (RO)
  6597                                  PO_LVI_REG	equ	15h		; PCM out Last Valid Index
  6598                                  PO_SR_REG	equ	16h		; PCM out Status register
  6599                                  
  6600                                  BDL_SIZE	equ	32*8		; Buffer Descriptor List size
  6601                                  
  6602                                  ; -------------------------------------------------------------
  6603                                  
  6604                                  ; 22/12/2024
  6605 000020EF 90                      align 4
  6606                                  
  6607                                  ; 13/11/2024
  6608                                  ; ('<<' to 'shl' conversion for FASM)
  6609                                  ;
  6610                                  ; 29/05/2024 (TRDOS 386)
  6611                                  ; 17/02/2017
  6612                                  ; Valid ICH device IDs
  6613                                  
  6614                                  valid_ids:
  6615                                  	;dd (ICH_DID shl 16) + INTEL_VID	; 8086h:2415h
  6616 000020F0 86801524                	dd (ICH_DID << 16) + INTEL_VID		; 8086h:2415h
  6617 000020F4 86802524                	dd (ICH0_DID << 16) + INTEL_VID		; 8086h:2425h
  6618 000020F8 86804524                	dd (ICH2_DID << 16) + INTEL_VID		; 8086h:2445h
  6619 000020FC 86808524                	dd (ICH3_DID << 16) + INTEL_VID		; 8086h:2485h
  6620 00002100 8680C524                	dd (ICH4_DID << 16) + INTEL_VID		; 8086h:24C5h
  6621 00002104 8680D524                	dd (ICH5_DID << 16) + INTEL_VID		; 8086h:24D5h
  6622 00002108 86806E26                	dd (ICH6_DID << 16) + INTEL_VID		; 8086h:266Eh
  6623 0000210C 8680A625                	dd (ESB6300_DID << 16) + INTEL_VID	; 8086h:25A6h
  6624 00002110 86809826                	dd (ESB631X_DID << 16) + INTEL_VID	; 8086h:2698h
  6625 00002114 8680DE27                	dd (ICH7_DID << 16) + INTEL_VID		; 8086h:27DEh
  6626                                  	; 03/11/2023 - Erdogan Tan
  6627 00002118 86809571                	dd (MX82440_DID << 16) + INTEL_VID	; 8086h:7195h
  6628 0000211C 39101270                	dd (SI7012_DID << 16)  + SIS_VID	; 1039h:7012h
  6629 00002120 DE10B101                	dd (NFORCE_DID << 16)  + NVIDIA_VID	; 10DEh:01B1h
  6630 00002124 DE106A00                	dd (NFORCE2_DID << 16) + NVIDIA_VID	; 10DEh:006Ah
  6631 00002128 22106D74                	dd (AMD8111_DID << 16) + AMD_VID	; 1022h:746Dh
  6632 0000212C 22104574                	dd (AMD768_DID << 16)  + AMD_VID	; 1022h:7445h
  6633 00002130 DE105900                	dd (CK804_DID << 16) + NVIDIA_VID	; 10DEh:0059h
  6634 00002134 DE103A00                	dd (MCP04_DID << 16) + NVIDIA_VID	; 10DEh:003Ah
  6635 00002138 DE108A00                	dd (CK8_DID << 16) + NVIDIA_VID		; 1022h:008Ah
  6636 0000213C DE10DA00                	dd (NFORCE3_DID << 16) + NVIDIA_VID	; 10DEh:00DAh
  6637 00002140 DE10EA00                	dd (CK8S_DID << 16) + NVIDIA_VID	; 10DEh:00EAh
  6638                                  
  6639                                  valid_id_count equ (($ - valid_ids)>>2)	; 05/11/2023
  6640                                  ; 13/11/2024
  6641                                  ;valid_id_count = ($ - valid_ids) shr 2	; 05/11/2023
  6642                                  
  6643 00002144 00000000                	dd 0
  6644                                  
  6645                                  ; 01/01/2025
  6646                                  
  6647                                  Credits:
  6648 00002148 564741205741562050-     	db 'VGA WAV Player for Retro DOS by Erdogan Tan. '
  6648 00002151 6C6179657220666F72-
  6648 0000215A 20526574726F20444F-
  6648 00002163 53206279204572646F-
  6648 0000216C 67616E2054616E2E20 
  6649 00002175 4A616E756172792032-     	db 'January 2025.',10,13,0
  6649 0000217E 3032352E0A0D00     
  6650 00002185 30312F30312F323032-     	db '01/01/2025', 10,13
  6650 0000218E 350A0D             
  6651                                  ; 15/11/2024
  6652                                  reset:
  6653 00002191 00                      	db 0
  6654                                  
  6655                                  msgAudioCardInfo:
  6656 00002192 666F7220496E74656C-     	db 'for Intel AC97 (ICH) Audio Controller.', 10,13,0
  6656 0000219B 204143393720284943-
  6656 000021A4 482920417564696F20-
  6656 000021AD 436F6E74726F6C6C65-
  6656 000021B6 722E0A0D00         
  6657                                  
  6658                                  	; 01/01/2025
  6659                                  msg_usage:
  6660 000021BB 75736167653A204347-     	db 'usage: CGAPLAY <FileName1> <FileName2> <...>',10,13,0
  6660 000021C4 41504C4159203C4669-
  6660 000021CD 6C654E616D65313E20-
  6660 000021D6 3C46696C654E616D65-
  6660 000021DF 323E203C2E2E2E3E0A-
  6660 000021E8 0D00               
  6661                                  
  6662                                  noDevMsg:
  6663 000021EA 4572726F723A20556E-     	db 'Error: Unable to find AC97 audio device!'
  6663 000021F3 61626C6520746F2066-
  6663 000021FC 696E64204143393720-
  6663 00002205 617564696F20646576-
  6663 0000220E 69636521           
  6664 00002212 0A0D00                  	db 10,13,0
  6665                                  
  6666                                  noFileErrMsg:
  6667 00002215 4572726F723A206669-     	db 'Error: file not found.',10,13,0
  6667 0000221E 6C65206E6F7420666F-
  6667 00002227 756E642E0A0D00     
  6668                                  
  6669                                  ; 29/05/2024
  6670                                  ; 11/11/2023
  6671                                  msg_init_err:
  6672 0000222E 0D0A                    	db CR, LF
  6673 00002230 4143393720436F6E74-     	db 'AC97 Controller/Codec initialization error !'
  6673 00002239 726F6C6C65722F436F-
  6673 00002242 64656320696E697469-
  6673 0000224B 616C697A6174696F6E-
  6673 00002254 206572726F722021   
  6674 0000225C 0D0A00                  	db CR, LF, 0 ; 07/12/2024
  6675                                  
  6676                                  ; 25/11/2023
  6677                                  msg_no_vra:
  6678 0000225F 0A0D                    	db 10,13
  6679 00002261 4E6F20565241207375-     	db 'No VRA support ! Only 48 kHZ sample rate supported !'
  6679 0000226A 70706F72742021204F-
  6679 00002273 6E6C79203438206B48-
  6679 0000227C 5A2073616D706C6520-
  6679 00002285 726174652073757070-
  6679 0000228E 6F727465642021     
  6680 00002295 0A0D00                  	db 10,13,0
  6681                                  
  6682                                  ; 19/11/2024
  6683                                  ; 03/06/2017
  6684                                  hex_chars:
  6685 00002298 303132333435363738-     	db '0123456789ABCDEF', 0
  6685 000022A1 3941424344454600   
  6686                                  msgAC97Info:
  6687 000022A9 0D0A                    	db 0Dh, 0Ah
  6688 000022AB 204143393720417564-     	db ' AC97 Audio Controller & Codec Info', 0Dh, 0Ah 
  6688 000022B4 696F20436F6E74726F-
  6688 000022BD 6C6C6572202620436F-
  6688 000022C6 64656320496E666F0D-
  6688 000022CF 0A                 
  6689 000022D0 2056656E646F722049-     	db ' Vendor ID: '
  6689 000022D9 443A20             
  6690                                  msgVendorId:
  6691 000022DC 303030306820446576-     	db '0000h Device ID: '
  6691 000022E5 6963652049443A20   
  6692                                  msgDevId:
  6693 000022ED 30303030680D0A          	db '0000h', 0Dh, 0Ah
  6694 000022F4 204275733A20            	db ' Bus: '
  6695                                  msgBusNo:
  6696 000022FA 303068204465766963-     	db '00h Device: '
  6696 00002303 653A20             
  6697                                  msgDevNo:
  6698 00002306 3030682046756E6374-     	db '00h Function: '
  6698 0000230F 696F6E3A20         
  6699                                  msgFncNo:
  6700 00002314 303068                  	db '00h'
  6701 00002317 0D0A                    	db 0Dh, 0Ah
  6702 00002319 204E414D4241523A20      	db ' NAMBAR: '
  6703                                  msgNamBar:
  6704 00002322 30303030682020          	db '0000h  '
  6705 00002329 4E41424D4241523A20      	db 'NABMBAR: '
  6706                                  msgNabmBar:
  6707 00002332 303030306820204952-     	db '0000h  IRQ: '
  6707 0000233B 513A20             
  6708                                  msgIRQ:
  6709 0000233E 3030                    	dw 3030h
  6710 00002340 0D0A00                  	db 0Dh, 0Ah, 0
  6711                                  ; 25/11/2023
  6712                                  msgVRAheader:
  6713 00002343 205652412073757070-     	db ' VRA support: '
  6713 0000234C 6F72743A20         
  6714 00002351 00                      	db 0	
  6715                                  msgVRAyes:
  6716 00002352 5945530D0A00            	db 'YES', 0Dh, 0Ah, 0
  6717                                  msgVRAno:
  6718 00002358 4E4F200D0A              	db 'NO ', 0Dh, 0Ah
  6719                                  	;db ' (Interpolated sample rate playing method)'
  6720                                  	; 30/12/2024
  6721 0000235D 2028496E746572706F-     	db ' (Interpolated samplerate play method)'
  6721 00002366 6C617465642073616D-
  6721 0000236F 706C65726174652070-
  6721 00002378 6C6179206D6574686F-
  6721 00002381 6429               
  6722 00002383 0D0A00                  	db 0Dh, 0Ah, 0
  6723                                  
  6724 00002386 90<rep 2h>              align 4
  6725                                  
  6726                                  ; -------------------------------------------------------------
  6727                                  
  6728                                  	; 30/12/2024
  6729                                  PlayingScreen:
  6730 00002388 DBDBDBDBDBDBDBDBDB-     	db  14 dup(219), " DOS Player ", 14 dup(219)
  6730 00002391 DBDBDBDBDB20444F53-
  6730 0000239A 20506C6179657220DB-
  6730 000023A3 DBDBDBDBDBDBDBDBDB-
  6730 000023AC DBDBDBDB           
  6731 000023B0 C9CDCDCDCDCDCDCDCD-     	db  201, 38 dup(205), 187
  6731 000023B9 CDCDCDCDCDCDCDCDCD-
  6731 000023C2 CDCDCDCDCDCDCDCDCD-
  6731 000023CB CDCDCDCDCDCDCDCDCD-
  6731 000023D4 CDCDCDBB           
  6732 000023D8 BA203C53706163653E-     	db  186, " <Space> Play/Pause <N>/<P> Next/Prev ", 186
  6732 000023E1 20506C61792F506175-
  6732 000023EA 7365203C4E3E2F3C50-
  6732 000023F3 3E204E6578742F5072-
  6732 000023FC 657620BA           
  6733 00002400 BA203C533E20202020-     	db  186, " <S>     Stop       <Enter> Color     ", 186
  6733 00002409 2053746F7020202020-
  6733 00002412 2020203C456E746572-
  6733 0000241B 3E20436F6C6F722020-
  6733 00002424 202020BA           
  6734 00002428 BA203C463E20202020-     	db  186, " <F>     Forwards   <+>/<-> Volume    ", 186
  6734 00002431 20466F727761726473-
  6734 0000243A 2020203C2B3E2F3C2D-
  6734 00002443 3E20566F6C756D6520-
  6734 0000244C 202020BA           
  6735 00002450 BA203C423E20202020-     	db  186, " <B>     Backwards  <Q>     Quit Prg  ", 186
  6735 00002459 204261636B77617264-
  6735 00002462 7320203C513E202020-
  6735 0000246B 202051756974205072-
  6735 00002474 672020BA           
  6736 00002478 CCCDCDCDCDCDCDCDCD-     	db  204, 38 dup(205), 185
  6736 00002481 CDCDCDCDCDCDCDCDCD-
  6736 0000248A CDCDCDCDCDCDCDCDCD-
  6736 00002493 CDCDCDCDCDCDCDCDCD-
  6736 0000249C CDCDCDB9           
  6737 000024A0 BA2046696C653A2020-     	db  186, " File:              Bits:     0       ", 186
  6737 000024A9 202020202020202020-
  6737 000024B2 202020426974733A20-
  6737 000024BB 202020203020202020-
  6737 000024C4 202020BA           
  6738 000024C8 BA20467265713A2030-     	db  186, " Freq: 0     Hz     Channels: 0       ", 186
  6738 000024D1 2020202020487A2020-
  6738 000024DA 2020204368616E6E65-
  6738 000024E3 6C733A203020202020-
  6738 000024EC 202020BA           
  6739 000024F0 C8CDCDCDCDCDCDCDCD-     	db  200, 38 dup(205), 188
  6739 000024F9 CDCDCDCDCDCDCDCDCD-
  6739 00002502 CDCDCDCDCDCDCDCDCD-
  6739 0000250B CDCDCDCDCDCDCDCDCD-
  6739 00002514 CDCDCDBC           
  6740 00002518 202020202020202020-     	db  40 dup(32)
  6740 00002521 202020202020202020-
  6740 0000252A 202020202020202020-
  6740 00002533 202020202020202020-
  6740 0000253C 20202020           
  6741                                  improper_samplerate_txt:
  6742                                  read_error_txt:
  6743 00002540 202020202020202020-     	db  40 dup(32)
  6743 00002549 202020202020202020-
  6743 00002552 202020202020202020-
  6743 0000255B 202020202020202020-
  6743 00002564 20202020           
  6744 00002568 202020202020202020-     	db  40 dup(32)
  6744 00002571 202020202020202020-
  6744 0000257A 202020202020202020-
  6744 00002583 202020202020202020-
  6744 0000258C 20202020           
  6745 00002590 202020202020202020-     	db  40 dup(32)
  6745 00002599 202020202020202020-
  6745 000025A2 202020202020202020-
  6745 000025AB 202020202020202020-
  6745 000025B4 20202020           
  6746 000025B8 202020202020202020-     	db  40 dup(32)
  6746 000025C1 202020202020202020-
  6746 000025CA 202020202020202020-
  6746 000025D3 202020202020202020-
  6746 000025DC 20202020           
  6747 000025E0 202020202020202020-     	db  40 dup(32)
  6747 000025E9 202020202020202020-
  6747 000025F2 202020202020202020-
  6747 000025FB 202020202020202020-
  6747 00002604 20202020           
  6748 00002608 202020202020202020-     	db  40 dup(32)
  6748 00002611 202020202020202020-
  6748 0000261A 202020202020202020-
  6748 00002623 202020202020202020-
  6748 0000262C 20202020           
  6749 00002630 202020202020202020-     	db  40 dup(32)
  6749 00002639 202020202020202020-
  6749 00002642 202020202020202020-
  6749 0000264B 202020202020202020-
  6749 00002654 20202020           
  6750 00002658 202020202020202020-     	db  40 dup(32)
  6750 00002661 202020202020202020-
  6750 0000266A 202020202020202020-
  6750 00002673 202020202020202020-
  6750 0000267C 20202020           
  6751 00002680 202020202020202020-     	db  40 dup(32)
  6751 00002689 202020202020202020-
  6751 00002692 202020202020202020-
  6751 0000269B 202020202020202020-
  6751 000026A4 20202020           
  6752 000026A8 202020202020202020-     	db  40 dup(32)
  6752 000026B1 202020202020202020-
  6752 000026BA 202020202020202020-
  6752 000026C3 202020202020202020-
  6752 000026CC 20202020           
  6753 000026D0 CDCDCDCDCDCDCDCDCD-     	db  40 dup(205)
  6753 000026D9 CDCDCDCDCDCDCDCDCD-
  6753 000026E2 CDCDCDCDCDCDCDCDCD-
  6753 000026EB CDCDCDCDCDCDCDCDCD-
  6753 000026F4 CDCDCDCD           
  6754 000026F8 202020202020202020-     	db  40 dup(32)
  6754 00002701 202020202020202020-
  6754 0000270A 202020202020202020-
  6754 00002713 202020202020202020-
  6754 0000271C 20202020           
  6755 00002720 202020202020202020-     	db  13 dup(32), "00:00 ", 174, 175, " 00:00", 4 dup(32), "VOL 000%"
  6755 00002729 2020202030303A3030-
  6755 00002732 20AEAF2030303A3030-
  6755 0000273B 20202020564F4C2030-
  6755 00002744 303025             
  6756                                  	;db  40 dup(32) ; not necessary
  6757 00002747 00                      	db 0
  6758                                  
  6759                                  ; -------------------------------------------------------------
  6760                                  
  6761                                  ; 31/12/2024
  6762                                  	; 30/12/2024
  6763                                  ;fillblock:
  6764                                  ;	times 8 db 0FFh
  6765                                  ;	dw 0
  6766                                  
  6767                                  ; -------------------------------------------------------------
  6768                                  
  6769                                  ; 30/12/2024
  6770                                  ; 23/11/2024
  6771                                  colors:
  6772 00002748 0F0B0A0C0E090D          	db 0Fh, 0Bh, 0Ah, 0Ch, 0Eh, 09h, 0Dh
  6773                                  	; white, cyan, green, red, yellow, blue, magenta
  6774 0000274F 0B                      ccolor:	db 0Bh	; cyan
  6775                                  
  6776                                  EOF: 
  6777                                  
  6778                                  ; -------------------------------------------------------------
  6779                                  
  6780                                  bss:
  6781                                  
  6782                                  ABSOLUTE bss
  6783                                  
  6784                                  ; 01/01/2025 (16bit modifications)
  6785                                  
  6786                                  alignb 2
  6787                                  
  6788                                  ; 24/12/2024
  6789                                  wpoints_dif:	; wave lighting points factor (differential) 
  6790 00002750 ????                    	resw 1	; required bytes for 1/18 second wave lighting
  6791                                  ; 01/01/2025
  6792                                  ;graphstart:
  6793                                  ;	resw 1	; start (top) line/row for wave lighting points 	 
  6794                                  
  6795                                  columns:
  6796 00002752 ??                      	resb 1
  6797 00002753 ??                      pbprev:	resb 1 ; previous progress bar indicator position
  6798                                  
  6799                                  ;alignb 2
  6800                                  
  6801                                  bss_start:
  6802                                  
  6803                                  ; 30/12/2024
  6804                                  prev_points:
  6805 00002754 <res 280h>              	resw 320 ; previous wave points (which are lighting)	
  6806                                  
  6807                                  ; 18/11/2024
  6808                                  stopped:
  6809 000029D4 ??                      	resb 1
  6810 000029D5 ??                      tLO:	resb 1
  6811                                  ; 21/11/2024
  6812 000029D6 ??                      tLP:	resb 1
  6813                                  ; 30/12/2024
  6814                                  wpoints:
  6815 000029D7 ??                      	resb 1
  6816 000029D8 ????                    pbuf_o:	resw 1
  6817                                  ; 29/12/2024
  6818 000029DA ????                    pbuf_s:	resw 1
  6819                                  
  6820                                  ; 30/05/2024
  6821 000029DC ??                      VRA:	resb 1	; Variable Rate Audio Support Status
  6822                                  
  6823                                  ; 25/12/2024
  6824                                  ; 29/11/2024
  6825                                  command:
  6826 000029DD ??                      	resb 1
  6827                                  filecount:
  6828 000029DE ??                      	resb 1
  6829                                  
  6830                                  ; 30/11/2024
  6831 000029DF ??                      alignb 4
  6832                                  
  6833                                  ;;;;;;;;;;;;;;
  6834                                  ; 14/11/2024
  6835                                  ; (Ref: player.asm, Matan Alfasi, 2017)  
  6836                                  WAVFILEHEADERbuff:
  6837                                  RIFF_ChunkID:
  6838 000029E0 ????????                	resd 1	; Must be equal to "RIFF" - big-endian
  6839                                  		; 0x52494646
  6840                                  RIFF_ChunkSize:
  6841 000029E4 ????????                	resd 1	; Represents total file size, not 
  6842                                          	; including the first 2 fields 
  6843                                  		; (Total_File_Size - 8), little-endian
  6844                                  RIFF_Format:
  6845 000029E8 ????????                	resd 1	; Must be equal to "WAVE" - big-endian
  6846                                  		; 0x57415645
  6847                                  
  6848                                  ;; WAVE header parameters ("Sub-chunk")
  6849                                  WAVE_SubchunkID:
  6850 000029EC ????????                	resd 1	; Must be equal to "fmt " - big-endian
  6851                                  		; 0x666d7420
  6852                                  WAVE_SubchunkSize:
  6853 000029F0 ????????                	resd 1	; Represents total chunk size
  6854                                  WAVE_AudioFormat:
  6855 000029F4 ????                    	resw 1	; PCM (Raw) - is 1, other - is a form 
  6856                                  		; of compression, not supported.
  6857                                  WAVE_NumChannels:
  6858 000029F6 ????                    	resw 1	; Number of channels, Mono-1, Stereo-2
  6859                                  WAVE_SampleRate:
  6860 000029F8 ????????                	resd 1	; Frequency rate, in Hz (8000, 44100 ...)
  6861                                  WAVE_ByteRate:
  6862 000029FC ????????                	resd 1	; SampleRate * NumChannels * BytesPerSample
  6863                                  WAVE_BlockAlign:
  6864 00002A00 ????                    	resw 1	; NumChannels * BytesPerSample
  6865                                  		; Number of bytes for one sample.
  6866                                  WAVE_BitsPerSample:
  6867 00002A02 ????                    	resw 1	; 8 = 8 bits, 16 = 16 bits, etc.
  6868                                  
  6869                                  ;; DATA header parameters
  6870                                  DATA_SubchunkID:
  6871 00002A04 ????????                	resd 1	; Must be equal to "data" - big-endian
  6872                                          	; 0x64617461
  6873                                  DATA_SubchunkSize:
  6874 00002A08 ????????                	resd 1	; NumSamples * NumChannels * BytesPerSample
  6875                                          	; Number of bytes in the data.
  6876                                  ;;;;;;;;;;;;;;
  6877                                  
  6878                                  ; 01/01/2025
  6879                                  
  6880 00002A0C ??                      flags:	resb 1
  6881                                  ; 06/11/2023
  6882                                  ac97_int_ln_reg:
  6883 00002A0D ??                      	resb 1
  6884                                  filehandle:
  6885 00002A0E ????                    	resw 1
  6886                                  
  6887                                  ; 01/01/2025
  6888                                  ; 28/11/2024
  6889                                  PSP_CurrentOffset:
  6890 00002A10 ????                    	resw 1
  6891                                  
  6892                                  ; 30/05/2024
  6893                                  wav_file_name:
  6894 00002A12 <res 50h>               	resb 80	; wave file, path name (<= 80 bytes)
  6895 00002A62 ????                    	resw 1	; 30/11/2024
  6896                                  
  6897                                  ; 08/11/2023
  6898                                  ; 07/11/2023
  6899                                  fbs_shift:
  6900 00002A64 ??                      	resb 1
  6901                                  ; 07/12/2024
  6902 00002A65 ??                      SRB:	resb 1
  6903                                  
  6904                                  ; 12/11/2016 - Erdogan Tan
  6905                                  bus_dev_fn:
  6906 00002A66 ????????                	resd 1
  6907                                  dev_vendor:
  6908 00002A6A ????????                	resd 1
  6909                                  
  6910                                  ; 17/02/2017
  6911                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  6912                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  6913                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  6914                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  6915 00002A6E ????                    NAMBAR:	resw 1	; BAR for mixer
  6916                                  NABMBAR:
  6917 00002A70 ????                    	resw 1	; BAR for bus master regs
  6918                                  
  6919                                  ; 01/01/2024
  6920                                  ; 256 byte buffer for descriptor list
  6921                                  BDL_BUFFER:
  6922 00002A72 ????                    	resw 1	; segment of our 256byte BDL buffer
  6923                                  WAV_BUFFER1:
  6924 00002A74 ????                    	resw 1	; segment of our WAV storage
  6925                                  ; 64k buffers for wav file storage
  6926                                  WAV_BUFFER2:
  6927 00002A76 ????                    	resw 1	; segment of 2nd wav buffer
  6928                                  
  6929                                  ; 01/01/2025
  6930                                  ; 15/11/2024
  6931                                  loadfromwavfile:
  6932 00002A78 ????                    	resw 1	; 'loadfromfile' or load+conversion proc address
  6933                                  loadsize:
  6934 00002A7A ????                    	resw 1	; (.wav file) read count (bytes) per one time
  6935                                  buffersize:
  6936 00002A7C ????????                	resd 1	; 16 bit samples (not bytes)
  6937                                  		
  6938                                  ; 01/01/2025
  6939                                  ; 14/11/2024
  6940                                  TotalTime:
  6941 00002A80 ????                    	resw 1	; Total (WAV File) Playing Time in seconds
  6942                                  ProgressTime:
  6943 00002A82 ????                    	resw 1
  6944 00002A84 ????                    count:	resw 1	; byte count of one (wav file) read
  6945                                  LoadedDataBytes:
  6946 00002A86 ????????                	resd 1	; total read/load count
  6947                                  
  6948                                  timerticks:
  6949 00002A8A ????????                	resd 1	; (to eliminate excessive lookup of events in tuneloop)
  6950                                  		; (in order to get the emulator/qemu to run correctly)
  6951                                  ; 14/11/2024
  6952                                  bss_end:
  6953                                  
  6954                                  ; 01/01/2025
  6955                                  ; 17/11/2024
  6956                                  temp_buffer:
  6957 00002A8E <res C5A8h>             	resb 50600  ; (44.1 kHZ stereo 12650 samples)
