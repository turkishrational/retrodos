     1                                  ; ****************************************************************************
     2                                  ; RD5HDIMG.S (RD5HDIMG.COM) - Retro DOS v5 Hard Disk Image Formatting Utility
     3                                  ; 							  (for MSDOS/WINDOWS)
     4                                  ; ****************************************************************************
     5                                  ; Last Update: 04/05/2024
     6                                  ; ----------------------------------------------------------------------------
     7                                  ; Beginning: 03/12/2017
     8                                  ; ----------------------------------------------------------------------------
     9                                  ; Assembler: NASM version 2.15
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Modified from 'hdimage.s'(HDIMAGE.COM) source code by Erdogan Tan
    12                                  ; (03/05/2024) - TRDOS 386 v2 hard disk image formatting utility -
    13                                  ; ****************************************************************************
    14                                  ; nasm hdimage.s -l hdimage.txt -o HDIMAGE.COM
    15                                  
    16                                  ; DTA (PSP+80h= Offset 128)
    17                                  DTA_Attrib equ 149 ; PDP+21
    18                                  DTA_Time equ 150 ; PSP+22
    19                                  DTA_Date equ 152 ; PSP 24
    20                                  DTA_FileSize equ 154 ; PSP + 26
    21                                  DTA_FileName equ 158 ; PSP + 30
    22                                  
    23                                  ; Masterboot / Partition Table at Beginning+1BEh
    24                                  ptBootable      equ 0
    25                                  ptBeginHead     equ 1
    26                                  ptBeginSector   equ 2
    27                                  ptBeginCylinder equ 3
    28                                  ptFileSystemID	equ 4
    29                                  ptEndHead       equ 5
    30                                  ptEndSector     equ 6
    31                                  ptEndCylinder   equ 7
    32                                  ptStartSector   equ 8
    33                                  ptSectors       equ 12
    34                                  
    35                                  ; BIOS Disk Parameters
    36                                  DPDiskNumber  equ 0h
    37                                  DPDType       equ 1h
    38                                  DPReturn      equ 2h
    39                                  DPHeads       equ 3h
    40                                  DPCylinders   equ 4h
    41                                  DPSecPerTrack equ 6h
    42                                  DPDisks       equ 7h
    43                                  DPTableOff    equ 8h
    44                                  DPTableSeg    equ 0Ah
    45                                  DPNumOfSecs   equ 0Ch
    46                                  
    47                                  ; BIOS INT 13h Extensions (LBA extensions)
    48                                  ; Just After DP Data (DPDiskNumber+)
    49                                  DAP_PacketSize equ 10h  ; If extensions present, this byte will be >=10h
    50                                  DAP_Reserved1 equ 11h   ; Reserved Byte 
    51                                  DAP_NumOfBlocks equ 12h ; Value of this byte must be 0 to 127
    52                                  DAP_Reserved2 equ 13h   ; Reserved Byte
    53                                  DAP_Destination equ 14h ; Address of Transfer Buffer as SEGMENT:OFFSET
    54                                  DAP_LBA_Address equ 18h ; LBA=(C1*H0+H1)*S0+S1-1
    55                                                          ; C1= Selected Cylinder Number
    56                                                          ; H0= Number Of Heads (Maximum Head Number + 1)
    57                                                          ; H1= Selected Head Number
    58                                                          ; S0= Maximum Sector Number
    59                                                          ; S1= Selected Sector Number
    60                                                          ; QUAD WORD
    61                                  ; DAP_Flat_Destination equ 20h ; 64 bit address, if value in 4h is FFFF:FFFFh
    62                                                               ; QUAD WORD (Also, value in 0h must be 18h) 
    63                                                               ; TR-DOS will not use 64 bit Flat Address
    64                                  
    65                                  ; INT 13h Function 48h "Get Enhanced Disk Drive Parameters"
    66                                  ; Just After DP Data (DPDiskNumber+)
    67                                  GetDParams_48h equ 20h ; Word. Data Lenght, must be 26 (1Ah) for short data.
    68                                  GDP_48h_InfoFlag equ 22h ; Word
    69                                  ; Bit 1 = 1 -> The geometry returned in bytes 4-15 is valid.
    70                                  GDP_48h_NumOfPCyls equ 24h ; Double Word. Number physical cylinders.
    71                                  GDP_48h_NumOfPHeads equ 28h ; Double Word. Number of physical heads.
    72                                  GDP_48h_NumOfPSpT equ 2Ch ; Double word. Num of physical sectors per track.
    73                                  GDP_48h_LBA_Sectors equ 30h ; 8 bytes. Number of physical/LBA sectors.
    74                                  GDP_48h_BytesPerSec equ 38h ; Word. Number of bytes in a sector.
    75                                  
    76                                  ; Cursor Location
    77                                  CCCpointer equ  0450h   ; BIOS data, current cursor column
    78                                  
    79                                  ; MINIMUM & MAXIMUM SECTORS (partition and disk size limits in sectors)
    80                                  MINPARTSIZE equ 4096 ; 2MB
    81                                  MAXPARTSIZE equ 4128768 - 1 ; 2GB - masterboot sector	
    82                                  MINDISKSIZE equ 16384 ; 8MB
    83                                  MAXDISKSIZE equ 4128768 ; 2GB
    84                                  
    85                                  pTableOffset equ 1BEh ; 446
    86                                  
    87                                  	; Convert LBA to CHS
    88                                  	; 08/02/2019
    89                                  
    90                                  	; LBA = ((C1*H0+H1)*S0)+S1-1
    91                                  	;
    92                                  	; C1 = Selected Cylinder Number
    93                                  	; H0 = Number of Heads (Maximum Head Number + 1)
    94                                  	; H1 = Selected Head Number
    95                                  	; S0 = Maximum Sector Number
    96                                  	; S1 = Selected Sector Number
    97                                  	;
    98                                  	; Phoenix, Enchanced Disk Drive Specicifications, v1.1, Page 8)
    99                                  
   100                                  [BITS 16]
   101                                  [ORG 100h]
   102                                  
   103                                  	;cli
   104                                  	;cld
   105                                  	;push	cs
   106                                  	;pop	ss
   107                                  	;mov	sp, 0FFFEh
   108                                  	;sti
   109                                  	
   110                                  	;mov	bx, SizeOfFile+100
   111                                  	
   112 00000000 BB[5872]                	mov	bx, bss_end
   113                                  
   114 00000003 83C30F                          add	bx, 15
   115 00000006 D1EB                            shr	bx, 1
   116 00000008 D1EB                            shr	bx, 1
   117 0000000A D1EB                    	shr	bx, 1
   118 0000000C D1EB                    	shr	bx, 1
   119 0000000E B44A                            mov	ah, 4Ah ; modify memory allocation
   120                                          ;push	cs
   121                                          ;pop	es
   122 00000010 CD21                            int	21h
   123                                  
   124                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   125                                  ; clear BSS
   126                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   127                                  ; 03/02/2019
   128                                  
   129                                  	;mov	cx, bss_end
   130 00000012 B9[4A71]                	mov	cx, bss_clear_end ; 15/02/2019
   131                                  
   132 00000015 BF[0E6A]                	mov	di, bss_start
   133 00000018 29F9                    	sub	cx, di
   134 0000001A 41                      	inc	cx
   135 0000001B D1E9                    	shr	cx, 1
   136 0000001D 31C0                    	xor	ax, ax
   137 0000001F F3AB                    	rep	stosw
   138                                  
   139                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   140                                  ; get hd image file name
   141                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   142                                  
   143 00000021 BE8000                  	mov	si, 80h			; PSP command tail
   144 00000024 AC                       	lodsb
   145 00000025 08C0                    	or	al, al 			; command tail length
   146 00000027 0F845B07                	jz	B_01			; jump if zero
   147                                  A_01:
   148 0000002B AC                      	lodsb
   149 0000002C 3C20                    	cmp	al, ' '			; is it SPACE ?
   150 0000002E 74FB                    	je	short A_01
   151 00000030 0F825207                	jb	B_01
   152                                  	
   153                                  	; check hd image file name
   154                                  A_02:
   155 00000034 BF[8559]                       	mov	di, img_file_name
   156 00000037 AA                      	stosb
   157                                  A_03:
   158 00000038 AC                      	lodsb
   159                                  	;cmp	al, 0Dh ; ENTER (CR) key
   160 00000039 3C20                    	cmp	al, 20h ; ' '
   161 0000003B 760C                    	jna	short A_04
   162 0000003D AA                      	stosb
   163 0000003E 81FF[9159]              	cmp	di, img_file_name + 12
   164 00000042 72F4                    	jb	short A_03
   165 00000044 803C20                  	cmp	byte [si], 20h 
   166 00000047 773F                    	ja	short A_10
   167                                  A_04:
   168                                  	;sub	al, al
   169                                  	;stosb
   170                                  
   171                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   172                                  ; File name capitalization
   173                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   174                                  
   175 00000049 BE[8559]                	mov	si, img_file_name
   176 0000004C 89F7                    	mov	di, si
   177 0000004E 89F3                    	mov	bx, si
   178                                  A_05:
   179 00000050 AC                      	lodsb
   180 00000051 3C61                    	cmp	al, 'a'
   181 00000053 730D                    	jnb	short A_07
   182 00000055 20C0                    	and	al, al
   183 00000057 7412                    	jz	short A_08
   184 00000059 3C2E                    	cmp	al, '.'
   185 0000005B 7502                    	jne	short A_06
   186 0000005D 89FB                    	mov	bx, di ; dot position
   187                                  A_06:
   188 0000005F AA                      	stosb
   189 00000060 EBEE                    	jmp	short A_05
   190                                  A_07:
   191 00000062 3C7A                    	cmp	al, 'z'
   192 00000064 77F9                    	ja	short A_06
   193 00000066 24DF                    	and	al, 0DFh ; NOT 32
   194 00000068 AA                      	stosb
   195 00000069 EBE5                    	jmp	short A_05
   196                                  A_08:
   197 0000006B 8805                    	mov	[di], al
   198 0000006D 4F                      	dec	di
   199 0000006E 39FB                    	cmp	bx, di
   200 00000070 7316                    	jnb	short A_10
   201 00000072 29DF                    	sub	di, bx
   202 00000074 81EB[8559]              	sub	bx, img_file_name
   203 00000078 83FF03                  	cmp	di, 3
   204 0000007B 7606                    	jna	short A_09
   205 0000007D 21DB                    	and	bx, bx
   206 0000007F 7507                    	jnz	short A_10
   207 00000081 EB0E                    	jmp	short A_11
   208                                  A_09:
   209 00000083 83FB08                  	cmp	bx, 8
   210 00000086 7609                    	jna	short A_11
   211                                  A_10:
   212 00000088 BE[1645]                	mov	si, msg_inv_file_name
   213 0000008B E8A71D                  	call	print_msg
   214 0000008E E9FB06                  	jmp	B_02
   215                                  
   216                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   217                                  ; Find image file
   218                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   219                                  	
   220                                  A_11:
   221 00000091 BA[8559]                	mov	dx, img_file_name
   222 00000094 B93F00                  	mov	cx, 3Fh ; File Attributes
   223 00000097 B44E                    	mov	ah, 4Eh ; MS-DOS Function = Find First File
   224 00000099 CD21                    	int	21h
   225                                  	;jc	B_05
   226 0000009B 0F82F20A                	jc	new_image ; 07/03/2019
   227                                  
   228                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   229                                  ; Check image file features
   230                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   231                                  
   232                                  A_12:
   233 0000009F BE9500                  	mov	si, DTA_Attrib
   234 000000A2 8A04                    	mov	al, [si]
   235 000000A4 241F                    	and	al, 1Fh ; directory, volume label, system, hidden, read only
   236 000000A6 0F85ED06                	jnz	B_04     
   237 000000AA BE9A00                  	mov	si, DTA_FileSize
   238 000000AD AD                      	lodsw
   239                                  	; max. size of hard disk image = 63sectors*64heads*1024cylinders
   240 000000AE 8B14                    	mov	dx, [si]
   241 000000B0 81FA007E                	cmp	dx, 7E00h ; 2GB upper limit (7E000000h)
   242 000000B4 0F87DF06                	ja	B_04
   243 000000B8 7208                    	jb	short A_13
   244 000000BA 21C0                    	and	ax, ax
   245 000000BC 0F85D706                	jnz	B_04
   246                                  	; 20/09/2020
   247                                  	;mov	ax, 1024
   248                                  	;jmp	A_24
   249 000000C0 EB0E                    	jmp	short A_14
   250                                  A_13:
   251 000000C2 A9FF01                  	test	ax, 511 ; check file size for sector boundary
   252 000000C5 0F85CE06                	jnz	B_04
   253 000000C9 83FA7E                  	cmp	dx, 7Eh  ; 8MB lower limit  (7E0000h)
   254 000000CC 0F82C706                	jb	B_04
   255                                  A_14:
   256 000000D0 A3[946E]                	mov	[file_size], ax
   257 000000D3 8916[966E]              	mov	[file_size+2], dx
   258                                  
   259                                  	; convert (disk image) file size to sector count (disk size)
   260                                  	; (dx:ax)/512
   261                                  	
   262 000000D7 B90002                  	mov	cx, 512
   263 000000DA E8590D                  	call	div32
   264                                  
   265                                  	; 12/02/2019
   266 000000DD A3[8C6E]                	mov	[total_sectors], ax
   267 000000E0 8916[8E6E]              	mov	[total_sectors+2], dx
   268                                  
   269                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   270                                  ; Load masterboot sector of HD image file
   271                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   272                                  
   273 000000E4 BA[8559]                	mov	dx, img_file_name
   274 000000E7 B8023D                  	mov	ax, 3D02h ; open for reading and writing
   275 000000EA CD21                    	int	21h
   276 000000EC 0F822F1D                	jc	D_02
   277                                  
   278                                  	;mov	[img_file_handle], ax
   279 000000F0 89C3                    	mov	bx, ax
   280                                  
   281 000000F2 B43F                    	mov	ah, 3Fh ; read file
   282 000000F4 B90002                  	mov	cx, 512
   283 000000F7 BA[2C57]                	mov	dx, MasterBootBuff
   284 000000FA CD21                    	int	21h
   285 000000FC 9C                      	pushf
   286 000000FD 50                      	push	ax
   287 000000FE B43E                    	mov	ah, 3Eh ; close file
   288                                  	;mov	bx, [img_file_handle]
   289 00000100 CD21                    	int	21h
   290 00000102 58                      	pop	ax
   291 00000103 9D                      	popf
   292 00000104 0F82171D                	jc	D_02
   293                                  
   294                                  	; 11/02/2019
   295                                  	;mov	word [img_file_handle], 0 ; disk image file is not open
   296                                  
   297                                  	; 12/02/2019
   298                                  
   299 00000108 813E[2A59]55AA          	cmp 	word [MBIDCode], 0AA55h
   300 0000010E 0F858506                	jne	B_04 ; invalid disk image file !
   301                                  
   302                                  	; clear screen
   303 00000112 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
   304 00000115 CD10                    	int	10h
   305                                  
   306 00000117 C606[C56E]01            	mov	byte [existingfile], 1 ; we are using existing disk image file
   307                                  				       ; (not a new file) flag
   308                                  
   309                                  	; Check for Singlix Master Boot code
   310 0000011C 813E[E858]BE07          	cmp	word [MasterBootBuff+444], 7BEh
   311 00000122 7540                    	jne	short A_15 ; no ..
   312                                  	
   313                                  	; It is seen as singlix MBR
   314                                  	; Let's check for disk size words (CHS record)
   315 00000124 8B0E[D058]              	mov	cx, [MasterBootBuff+420] ; cylinders
   316 00000128 83F910                  	cmp	cx, 16
   317 0000012B 7237                    	jb	short A_15 ; invalid
   318 0000012D A1[D258]                	mov	ax, [MasterBootBuff+422] ; heads
   319 00000130 83F802                  	cmp	ax, 2
   320 00000133 722F                    	jb	short A_15 ; invalid
   321 00000135 8B16[D458]              	mov	dx, [MasterBootBuff+424] ; sectors
   322 00000139 83FA11                  	cmp	dx, 17
   323 0000013C 7226                    	jb	short A_15 ; invalid
   324 0000013E 890E[9A40]              	mov	[cylinders], cx
   325 00000142 A3[9840]                	mov	[heads], ax
   326 00000145 8916[9640]              	mov	[sectors], dx
   327 00000149 F7E2                    	mul	dx
   328 0000014B E8F60C                  	call	mul32
   329 0000014E 09DB                    	or	bx, bx
   330 00000150 7512                    	jnz	short A_15 ; invalid
   331 00000152 3B16[8E6E]              	cmp	dx, [total_sectors+2]
   332 00000156 750C                    	jne	short A_15
   333 00000158 3B06[8C6E]              	cmp	ax, [total_sectors]
   334 0000015C 7506                    	jne	short A_15 ; invalid
   335                                  
   336                                  	; valid singlix MBR & disk image file
   337                                  
   338                                  	; Display disk geometry
   339                                  
   340                                  	;mov	si, trdos386_disk_chs_header
   341                                  	; 04/05/2024
   342 0000015E BE[155F]                	mov	si, retrodos5_disk_chs_header
   343                                  	;call	print_msg
   344                                  	;
   345                                  	;jmp	A_27
   346                                  	; 20/09/2020
   347 00000161 E9D300                  	jmp	A_24
   348                                  
   349                                  A_15:
   350                                  	; 17/10/2020
   351                                  	;mov	ax, [file_size]
   352                                  	;mov	dx, [file_size+2]
   353                                  
   354                                  	;shr	dx, 1
   355                                  	;rcr	ax, 1 ; / 2
   356                                  		      ; / 256
   357                                  	;mov	al, ah
   358                                  	;mov	ah, dl
   359                                  	;mov	dl, dh
   360                                  	;xor	dh, dh
   361                                  
   362                                  ;	mov	cl, 9 ; / 512
   363                                  ;A_15shr32:
   364                                  ;	shr	dx,1
   365                                  ;	rcr	ax,1
   366                                  ;	dec	cl
   367                                  ;	jnz	short A_15shr32
   368                                  
   369                                  	; 17/10/2020
   370 00000164 A1[8C6E]                	mov	ax, [total_sectors]
   371 00000167 8B16[8E6E]              	mov	dx, [total_sectors+2]
   372                                  
   373                                  	; cylinders*63sectors*16heads (<=528MB)
   374                                  	;cmp	dx, 1F80h ; 1024*16*63 (1F800000h)
   375 0000016B 83FA0F                  	cmp	dx, 0Fh ; 17/10/2020
   376 0000016E 7774                    	ja	short A_21
   377 00000170 7213                    	jb	short A_16
   378                                  	;and	ax, ax
   379                                  	;jnz	A_22
   380 00000172 3D00C0                  	cmp	ax, 0C000h ; 17/10/2020
   381 00000175 0F878200                	ja	A_22
   382                                  	; = 528MB (1024*16*63*512)
   383 00000179 C706[9840]1000          	mov	word [heads], 16
   384 0000017F B80004                  	mov	ax, 1024
   385 00000182 E99C00                  	jmp	A_25
   386                                  A_16:
   387                                  	; < 528MB
   388 00000185 B9F003                  	mov	cx, 63*16 ; 1008
   389                                  	;div	cx
   390                                  	;and	dx, dx
   391 00000188 E8AB0C                  	call	div32 ; 16/10/2020
   392 0000018B 21DB                    	and	bx, bx ; remainder
   393                                  	;jnz	B_04
   394                                  	; 10/02/2019
   395 0000018D 7509                    	jnz	short A_17 ; 17 spt disk image check
   396 0000018F C706[9840]1000          	mov	word [heads], 16
   397 00000195 E98900                  	jmp	A_25
   398                                  A_17:
   399                                  	; 12/02/2019
   400                                  	;mov	ax, [file_size]
   401                                  	;mov	dx, [file_size+2]
   402                                  
   403                                  	; 17/10/2020
   404 00000198 A1[8C6E]                	mov	ax, [total_sectors]
   405 0000019B 8B16[8E6E]              	mov	dx, [total_sectors+2]
   406                                  
   407                                  	;; 10/02/2019
   408                                  	;; Check 17 spt disk image
   409                                  	;mov	si, DTA_FileSize
   410                                  	;lodsw
   411                                  	;; max. size of hard disk image = 17sectors*16heads*1024cylinders
   412                                  	;mov	dx, [si]
   413                                  	
   414                                  	;cmp	dx, 880h ; 136MB upper limit (8800000h)
   415 0000019F 83FA04                  	cmp	dx, 04h  ;17/10/2020
   416 000001A2 0F87F105                	ja	B_04
   417 000001A6 7207                    	jb	short A_49
   418                                  
   419 000001A8 3D0040                  	cmp	ax, 4000h ; 17/10/2020
   420 000001AB 0F87E805                	ja	B_04
   421                                  A_49:
   422                                  	; 17/10/2020
   423                                  	;mov	cx, 512
   424                                  	;call	div32
   425                                  
   426                                  	;mov	[pp_Sectors], ax
   427                                  	;mov	[pp_Sectors+2], dx
   428                                  	
   429                                  	; Calculate with increased heads (count) order
   430                                  	; (For example cyls = 1024 & heads = 8 is better than
   431                                  	;      cyls = 512 & heads = 16, for 17 SPT.v)
   432                                  
   433 000001AF B92200                  	mov	cx, 17*2 ; 34 ; heads = 2
   434                                  A_18:
   435 000001B2 E8810C                  	call	div32
   436                                  		; If remainder = 0
   437                                  		;    it is 17 spt hard disk image file
   438 000001B5 21DB                    	and	bx, bx
   439 000001B7 7414                    	jz	short A_20
   440                                  A_19:
   441 000001B9 83C111                  	add	cx, 17
   442 000001BC 81F91001                	cmp	cx, 17*16 ; 272 ; heads = 16
   443 000001C0 0F87D305                	ja	B_04 ; invalid image file !
   444                                  
   445                                  	;mov	ax, [pp_Sectors]
   446                                  	;mov	dx, [pp_Sectors+2]
   447                                  
   448                                  	; 17/10/2020
   449 000001C4 A1[8C6E]                	mov	ax, [total_sectors]
   450 000001C7 8B16[8E6E]              	mov	dx, [total_sectors+2]
   451                                  
   452 000001CB EBE5                    	jmp	short A_18
   453                                  
   454                                  A_20:
   455 000001CD 3D0004                  	cmp	ax, 1024
   456 000001D0 77E7                    	ja	short A_19
   457                                  
   458 000001D2 B311                    	mov	bl, 17
   459 000001D4 881E[9640]              	mov	[sectors], bl ; 17
   460 000001D8 A3[9A40]                	mov	[cylinders], ax
   461                                  
   462 000001DB 89C8                    	mov	ax, cx
   463 000001DD F6F3                    	div	bl
   464                                  	;xor	ah, ah
   465 000001DF A3[9840]                	mov	[heads], ax
   466                                  
   467 000001E2 EB46                    	jmp	short A_26
   468                                  
   469                                  A_21:
   470                                  	; cylinders*63sectors*32heads (>528MB, <=1GB)
   471                                  	;cmp	dx, 3F00h ; 1024*32*63 (3F000000h)
   472 000001E4 83FA1F                  	cmp	dx, 1Fh ; 17/10/2020
   473 000001E7 7726                    	ja	short A_23
   474 000001E9 7210                    	jb	short A_22
   475                                  	;and	ax, ax
   476                                  	;jnz	short A_23
   477 000001EB 3D0080                  	cmp	ax, 8000h ; 17/10/2020
   478 000001EE 771F                    	ja	short A_23
   479                                  	; = 1GB (1024*32*63*512)
   480 000001F0 C706[9840]1000          	mov	word [heads], 16
   481 000001F6 B80004                  	mov	ax, 1024
   482 000001F9 EB26                    	jmp	short A_25
   483                                  A_22:
   484 000001FB B9E007                  	mov	cx, 63*32
   485                                  	;div	cx
   486                                  	;and	dx, dx
   487 000001FE E8350C                  	call	div32 ; 16/10/2020
   488 00000201 21DB                    	and	bx, bx ; remainder
   489 00000203 0F859005                	jnz	B_04
   490 00000207 C706[9840]2000          	mov	word [heads], 32
   491 0000020D EB12                    	jmp	short A_25
   492                                  A_23:
   493                                  	; cylinders*63sectors*64heads (>1GB, <=2GB)
   494 0000020F B9C00F                  	mov	cx, 63*64
   495                                  	;div	cx
   496                                  	;and	dx, dx
   497 00000212 E8210C                  	call	div32 ; 16/10/2020
   498 00000215 21DB                    	and	bx, bx ; remainder
   499 00000217 0F857C05                	jnz	B_04
   500                                  ;A_24:
   501 0000021B C706[9840]4000          	mov	word [heads], 64
   502                                  A_25:
   503 00000221 C706[9640]3F00          	mov	word [sectors], 63
   504 00000227 A3[9A40]                	mov	[cylinders], ax
   505                                  A_26:
   506                                  	; 08/02/2019
   507                                  
   508                                  	; calculate total sectors (by using CHS values)
   509 0000022A A1[9640]                	mov	ax, [sectors]
   510 0000022D F726[9840]              	mul	word [heads]
   511 00000231 A3[C66E]                	mov	[min_sectors], ax ; Minimum sectors
   512                                  	
   513                                  	; 17/10/2020
   514                                  	;mov	dx, [cylinders]
   515                                  	;mul	dx
   516                                  	;mov	[total_sectors], ax
   517                                  	;mov	[total_sectors+2], dx
   518                                  
   519                                  	; 12/02/2019
   520 00000234 BE[685F]                	mov	si, disk_chs_header
   521                                  A_24:			; 20/09/2020
   522 00000237 E8FB1B                  	call	print_msg
   523                                  A_27:
   524 0000023A E8DE22                  	call	init_partition_tables
   525 0000023D 7307                    	jnc	short A_28
   526                                  
   527                                  	; 24/02/2019
   528 0000023F E8FD28                  	call	partition_table_fix
   529 00000242 73F6                    	jnc	short A_27
   530                                  
   531 00000244 CD20                    	int 	20h
   532                                  A_28:
   533                                  	; 26/02/2019
   534 00000246 803E[9571]00            	cmp	byte [epnumber], 0
   535 0000024B 7623                    	jna	short A_29
   536                                  
   537                                  	; Enable random access to disk image file
   538 0000024D C606[9C40]01            	mov	byte [random], 1
   539                                  
   540                                  	;mov	byte [ldrives], 255 ; invalid value
   541                                  	;			    ; to prevent deleting
   542                                  	;			    ; extended partition
   543                                  
   544                                  	; Open disk image file again.
   545 00000252 BA[8559]                	mov	dx, img_file_name
   546 00000255 B8023D                  	mov	ax, 3D02h ; open for reading and writing
   547 00000258 CD21                    	int	21h
   548 0000025A 7214                    	jc	short A_29
   549                                  
   550 0000025C A3[9440]                	mov	[img_file_handle], ax
   551                                  
   552 0000025F E8692E                  	call	init_ext_partition_tables
   553                                  
   554                                  	; Close file
   555 00000262 8B1E[9440]              	mov	bx, [img_file_handle]
   556 00000266 B43E                    	mov	ah, 3Eh ; close file
   557 00000268 CD21                    	int	21h
   558                                  
   559                                  	; 28/02/2019
   560 0000026A C706[9440]0000          	mov	word [img_file_handle], 0
   561                                  A_29:
   562                                  	; 08/03/2019
   563 00000270 803E[C56E]00            	cmp	byte [existingfile], 0
   564 00000275 7743                    	ja	short A_32
   565                                  
   566 00000277 B80300                  	mov	ax, 3  ; clear screen
   567 0000027A CD10                    	int	10h
   568                                  
   569 0000027C E8FE1C                  	call	display_chs_table
   570                                  
   571 0000027F BE[5356]                	mov	si, CRLF
   572 00000282 E8B01B                  	call	print_msg
   573                                  
   574                                  	; 08/03/2019
   575 00000285 C606[C56E]01            	mov	byte [existingfile], 1
   576                                  
   577 0000028A E81627                  	call	dpt_1
   578                                  
   579 0000028D BE[5356]                	mov	si, CRLF
   580 00000290 E8A21B                  	call	print_msg
   581                                  
   582 00000293 BE[8254]                	mov	si, msg_edit_or_exit
   583 00000296 E89C1B                  	call	print_msg
   584                                  A_30:
   585 00000299 30E4                    	xor	ah, ah
   586 0000029B CD16                    	int	16h
   587                                  
   588 0000029D 3C0D                    	cmp	al, 13 ; CR (ENTER) key
   589 0000029F 7426                    	je	short A_33
   590                                  
   591 000002A1 3C1B                    	cmp	al, 27 ; ESCape key
   592 000002A3 740D                    	je	short A_31
   593                                  
   594 000002A5 3C20                    	cmp	al, 32 ; SPACE key
   595 000002A7 741E                    	je	short A_33
   596                                  
   597 000002A9 3C03                    	cmp	al, 3 ; CTRL+C
   598 000002AB 7405                    	je	short A_31
   599                                  
   600 000002AD 83F800                  	cmp	ax, 0 ; CTRL+BREAK
   601 000002B0 77E7                    	ja	short A_30
   602                                  A_31:
   603 000002B2 BE[5356]                	mov	si, CRLF
   604 000002B5 E87D1B                  	call	print_msg
   605                                  
   606 000002B8 CD20                    	int	20h
   607                                  
   608                                  A_32:
   609                                  	; initialize primary partition tables
   610                                  
   611 000002BA E85E22                  	call	init_partition_tables
   612 000002BD 7308                    	jnc	short A_33  ; 24/02/2019
   613                                  
   614                                  	; 24/02/2019
   615 000002BF E87D28                  	call	partition_table_fix
   616 000002C2 73F6                    	jnc	short A_32
   617                                  	; ESC key has been pressed for EXIT
   618 000002C4 E9C504                  	jmp	B_02  ; Terminate program
   619                                  A_33:
   620                                  	; 04/02/2019
   621 000002C7 30C0                    	xor	al, al  ; MBR/PRIMARY PARTITIONS
   622 000002C9 E8C126                  	call	display_partition_table
   623                                  A_34:
   624 000002CC 30C0                    	xor	al, al ; 11/02/2019
   625 000002CE 3806[9271]              	cmp	byte [pcount], al ; 0
   626                                  	;jna	A_44 ; empty partition table
   627 000002D2 7703                    	ja	short A_35
   628                                  	;inc	al ; 11/02/2019
   629                                  	; 10/02/2019
   630                                  	;mov	[newdisk], al ; 1 ; Continue as new disk image (with empty pt)
   631                                  	;mov	[random], al ; 1 ; next r/w is not sequental
   632 000002D4 E9EF00                  	jmp	A_44
   633                                  A_35:
   634                                  	; Check disk parameters with current CHS settings
   635 000002D7 31DB                    	xor	bx, bx
   636 000002D9 31C9                    	xor	cx, cx
   637                                  A_36:
   638 000002DB 80BF[4F71]00            	cmp	byte [part_table_sys_id+bx], 0
   639 000002E0 767C                    	jna	A_37
   640                                  
   641 000002E2 A1[9640]                	mov	ax, [sectors]
   642 000002E5 F726[9840]              	mul	word [heads]
   643                                  	; dx = 0, ax = heads*sectors
   644 000002E9 8B97[4D71]              	mov	dx, [part_table_start_cyl+bx]
   645 000002ED F7E2                    	mul	dx
   646 000002EF 89C6                    	mov	si, ax
   647 000002F1 89D7                    	mov	di, dx
   648 000002F3 8A87[4B71]              	mov	al, [part_table_start_head+bx]
   649 000002F7 F626[9640]              	mul	byte [sectors]
   650 000002FB 01C6                    	add	si, ax
   651 000002FD 83D700                  	adc	di, 0
   652 00000300 8A87[4C71]              	mov	al, [part_table_start_sector+bx]
   653 00000304 30E4                    	xor	ah, ah
   654 00000306 FEC8                    	dec	al ; 1 -> 0
   655 00000308 01C6                    	add	si, ax
   656 0000030A 83D700                  	adc	di, 0
   657                                  
   658 0000030D 3BBF[5671]              	cmp	di, [part_table_rel_sec_hw+bx]
   659                                  	;jne	B_04 ; invalid
   660 00000311 7558                    	jne	short A_38
   661 00000313 3BB7[5471]              	cmp	si, [part_table_rel_sec_lw+bx]
   662                                  	;jne	B_04 ; invalid
   663 00000317 7552                    	jne	short A_38
   664                                  
   665 00000319 A1[9640]                	mov	ax, [sectors]
   666 0000031C F726[9840]              	mul	word [heads]
   667                                  	; dx = 0, ax = heads*sectors
   668 00000320 8B97[5271]              	mov	dx, [part_table_end_cyl+bx]
   669 00000324 F7E2                    	mul	dx
   670 00000326 89C6                    	mov	si, ax
   671 00000328 89D7                    	mov	di, dx
   672 0000032A 8A87[5071]              	mov	al, [part_table_end_head+bx]
   673 0000032E F626[9640]              	mul	byte [sectors]
   674 00000332 01C6                    	add	si, ax
   675 00000334 83D700                  	adc	di, 0
   676 00000337 8A87[5171]              	mov	al, [part_table_end_sector+bx]
   677 0000033B 30E4                    	xor	ah, ah
   678                                  	;dec	al ; 63 -> 62
   679 0000033D 01C6                    	add	si, ax
   680 0000033F 83D700                  	adc	di, 0
   681                                  
   682 00000342 8B87[5871]              	mov	ax, [part_table_num_sec_lw+bx]
   683 00000346 8B97[5A71]              	mov	dx, [part_table_num_sec_hw+bx]
   684                                  	
   685 0000034A 0387[5471]              	add	ax, [part_table_rel_sec_lw+bx]
   686 0000034E 1397[5671]              	adc	dx, [part_table_rel_sec_hw+bx]
   687                                  
   688 00000352 39F0                    	cmp	ax, si
   689                                  	;jne	B_04 ; invalid
   690 00000354 7515                    	jne	short A_38
   691                                  
   692 00000356 39FA                    	cmp	dx, di
   693                                  	;jne	B_04 ; invalid
   694 00000358 7511                    	jne	short A_38
   695                                  
   696 0000035A FE06[4871]              	inc	byte [goodpte]
   697                                  A_37:
   698 0000035E FEC1                    	inc	cl
   699                                  
   700 00000360 80F904                  	cmp	cl, 4
   701 00000363 7316                    	jnb	short A_39
   702                                  
   703 00000365 83C312                  	add	bx, 18  ; partition table structure size
   704                                  
   705 00000368 E970FF                  	jmp	A_36
   706                                  A_38:
   707                                  	; 24/02/2019 
   708                                  	; If defective pte count > 1 do not tolerate MBR.
   709 0000036B B001                    	mov 	al, 1
   710 0000036D 3806[4971]              	cmp	[badpte], al ; 1
   711 00000371 0F872204                	ja	B_04
   712 00000375 FE06[4971]              	inc	byte [badpte]
   713 00000379 EBE3                    	jmp	short A_37 
   714                                  A_39:
   715                                  	; If defective pte count > good pte, we must not continue
   716 0000037B A0[4971]                	mov	al, [badpte]
   717 0000037E 20C0                    	and	al, al
   718 00000380 7410                    	jz	short A_41
   719                                  
   720 00000382 3A06[4871]              	cmp	al, [goodpte]
   721 00000386 0F870D04                	ja	B_04
   722                                  
   723                                  	; 24/02/2019
   724                                  A_40:
   725 0000038A BE[F560]                	mov	si, msg_defective_pt
   726 0000038D E8A51A                  	call	print_msg
   727 00000390 EB34                    	jmp	short A_44
   728                                  
   729                                  A_41:
   730                                  	; LBA and CHS values of all partitions are OK (here)
   731                                  
   732                                  	; sort MBR (primary) partitions
   733                                  
   734 00000392 E8CF22                  	call	sort_partition_table
   735                                  
   736                                  	; Checking partition overlaps (via start and end cylinders)
   737                                  
   738 00000395 31DB                    	xor	bx, bx
   739 00000397 BA1200                  	mov	dx, 18
   740                                  A_42:
   741 0000039A FEC3                    	inc	bl
   742                                  
   743 0000039C 8A87[D66E]              	mov	al, [bx+sort]
   744 000003A0 F6E2                    	mul	dl
   745 000003A2 89C6                    	mov	si, ax	; current
   746                                  
   747 000003A4 80BC[4F71]00            	cmp	byte [part_table_sys_id+si], 0
   748 000003A9 7616                    	jna	short A_43
   749                                  
   750 000003AB 8A87[D56E]              	mov	al, [bx+sort-1]
   751 000003AF F6E2                    	mul	dl
   752 000003B1 89C7                    	mov	di, ax  ; previous
   753                                  
   754 000003B3 8B85[5271]              	mov	ax, [part_table_end_cyl+di]
   755 000003B7 3B84[4D71]              	cmp	ax, [part_table_start_cyl+si]
   756 000003BB 7204                    	jb	short A_43
   757                                  
   758 000003BD 21C0                    	and	ax, ax
   759                                  	;jnz	B_04  ; overlap error (except empty entries)
   760                                  	; 24/02/2019
   761 000003BF 75C9                    	jnz	short A_40
   762                                  
   763                                  A_43:
   764 000003C1 80FB03                  	cmp	bl, 3
   765 000003C4 72D4                    	jb	short A_42
   766                                  
   767                                  A_44:
   768 000003C6 BE[265B]                	mov	si, mbr_editing_options
   769 000003C9 E8691A                  	call	print_msg
   770                                  
   771 000003CC BE[D45B]                	mov	si, enter_option_number_msg
   772 000003CF E8631A                  	call	print_msg
   773                                  
   774 000003D2 803E[D46E]00            	cmp	byte [ldrives], 0
   775 000003D7 760C                    	jna	short A_45
   776                                  
   777 000003D9 BE[5356]                	mov	si, CRLF
   778 000003DC E8561A                  	call	print_msg
   779                                  
   780 000003DF BE[3D62]                	mov	si, str_display_ebr_pt
   781 000003E2 E8501A                  	call	print_msg
   782                                  A_45:
   783                                  	;mov	si, CRLF
   784                                  	;call	print_msg
   785                                  
   786                                  A_46:
   787 000003E5 30E4                    	xor	ah, ah
   788 000003E7 CD16                    	int	16h
   789                                  
   790 000003E9 3C30                    	cmp	al, '0'
   791 000003EB 7428                    	je	short A_47
   792                                  
   793 000003ED 3C31                    	cmp	al, '1'
   794 000003EF 742D                    	je	short create_partition
   795 000003F1 3C32                    	cmp	al, '2'
   796 000003F3 0F84F300                	je	activate_partition
   797 000003F7 3C33                    	cmp	al, '3'
   798 000003F9 0F849001                	je	delete_partition
   799 000003FD 3C34                    	cmp	al, '4'
   800 000003FF 0F849602                	je	write_pt_mbr
   801                                  	
   802 00000403 3C1B                    	cmp	al, 27 ; ESCape
   803 00000405 740E                    	je	short A_47
   804                                  
   805                                  	; 28/02/2019
   806 00000407 803E[D46E]00            	cmp	byte [ldrives], 0
   807 0000040C 76D7                    	jna	short A_46
   808                                  
   809 0000040E 3C20                    	cmp	al, 20h ; SPACE
   810 00000410 75D3                    	jne	short A_46
   811                                  
   812 00000412 E95D27                  	jmp	display_extended_pt
   813                                  A_47:
   814                                  	; terminate
   815 00000415 CD20                    	int	20h
   816                                  
   817                                  A_48:
   818                                  	; 24/02/2019
   819 00000417 30C0                    	xor	al, al  ; MBR/PRIMARY PARTITIONS
   820 00000419 E87125                  	call	display_partition_table
   821 0000041C EBA8                    	jmp	short A_44
   822                                  
   823                                  ;-----------------------------------------------------------------------------
   824                                  
   825                                  create_partition:
   826                                  	; 10/02/2019
   827 0000041E 31C0                    	xor	ax, ax
   828 00000420 A2[A06E]                	mov	byte [wholedisk], al ; 0 ; Reset wholedisk flag
   829                                  
   830                                  	; 13/02/2019
   831 00000423 3806[9D40]              	cmp	byte [newdisk], al ; 0
   832 00000427 772E                    	ja	short cp_2 ; New disk image, continue
   833                                  
   834 00000429 3806[9271]              	cmp	byte [pcount], al ; 0 ; number of (valid) partitions
   835 0000042D 7707                    	ja	short cp_1
   836                                  
   837 0000042F C606[9D40]01            	mov	byte [newdisk], 1
   838 00000434 EB21                    	jmp	short cp_2
   839                                  cp_1:
   840 00000436 803E[9271]04            	cmp	byte [pcount], 4
   841 0000043B 7339                    	jnb	short cp_3 ; full pt !
   842                                  
   843                                  	; al = 0
   844 0000043D E88722                  	call	find_part_free_space
   845                                  		 ; Following values are for the max. free space on disk
   846                                  
   847 00000440 21C9                    	and	cx, cx
   848 00000442 7445                    	jz	short cp_4 ; there is not free space on disk
   849                                  
   850                                  	;mov	[c_cylinders], cx  ; count of free cylinders in the gap
   851 00000444 891E[3072]              	mov	[c_fspc_offset], bx  ; offset from beginning of 'fspc:'
   852                                  	;mov	[c_gap], al ; gap (space index) number of this free space
   853                                  	;		    ; 0 -> before partition 1 (as PTE)
   854                                  	;		    ; 1-2-3 -> between partitions 1 to 4
   855                                  	;		    ; 4 -> after partition 4 (as PTE)
   856                                  
   857                                  	; Start to job with non-aligned (full) free sectors of this max. space
   858                                  	
   859 00000448 8B87[E671]              	mov	ax, [free_space.sectors_unused+bx]
   860 0000044C 8B97[E871]              	mov	dx, [free_space.sectors_unused+2+bx]
   861                                  
   862 00000450 A3[9C6E]                	mov	[pp_Sectors], ax
   863 00000453 8916[9E6E]              	mov	[pp_Sectors+2], dx
   864                                  cp_2:
   865 00000457 C606[9C40]01            	mov	byte [random], 1  ; random access (use seek before reading)
   866                                  
   867 0000045C 3906[9440]              	cmp	[img_file_handle], ax ; 0
   868 00000460 0F87000B                	ja	B_49
   869                                  
   870                                  	; Open disk image file again.
   871                                  
   872                                  	; 25/02/2019 (Random access to disk image sectors must be enabled)
   873                                  	;dec	byte [random] ; 0 ; masterboot sector will be written
   874                                  	;		  	  ; no need to seek file pointer
   875                                  
   876 00000464 BA[8559]                	mov	dx, img_file_name
   877 00000467 B8023D                  	mov	ax, 3D02h ; open file for reading and writing
   878 0000046A CD21                    	int	21h
   879 0000046C 0F82AF19                	jc	D_02
   880                                  
   881 00000470 A3[9440]                	mov	[img_file_handle], ax
   882                                  
   883 00000473 E9EE0A                  	jmp	B_49 ; New/Empty disk, create partition menu
   884                                  
   885                                  cp_3:
   886                                  	; 13/02/2019
   887                                  	; There is not a free pt entry to create a new partition
   888                                  
   889 00000476 30C0                    	xor	al, al  ; MBR/PRIMARY PARTITIONS
   890 00000478 E81225                  	call	display_partition_table
   891                                  
   892 0000047B BE[B65C]                	mov	si, msg_full_pt
   893 0000047E E8B419                  	call	print_msg
   894 00000481 BE[E35C]                	mov	si, msg_to_create_new_p
   895 00000484 E8AE19                  	call	print_msg
   896                                  
   897 00000487 EB73                    	jmp	ap_0
   898                                  cp_4:
   899                                  	; 02/03/2019
   900 00000489 803E[9571]00            	cmp	byte [epnumber], 0
   901 0000048E 7602                    	jna	short cp_5
   902                                  
   903 00000490 EB08                    	jmp	short create_logical_drives
   904                                  cp_5:
   905                                  	; 15/02/2019
   906                                  	; There is not (enough) free space to create a new partition
   907                                  
   908 00000492 BE[015D]                	mov	si, msg_no_free_space
   909 00000495 E89D19                  	call	print_msg
   910 00000498 EB62                    	jmp	ap_0
   911                                  
   912                                  ;-----------------------------------------------------------------------------
   913                                  
   914                                  create_logical_drives:
   915                                  	; 05/03/2019
   916 0000049A E80C2A                  	call	check_ext_free_space
   917 0000049D 7236                    	jc	short cld_5 ; 19/10/2020
   918                                  cld_1:
   919                                  	; 05/03/2019
   920 0000049F 803E[D46E]04            	cmp	byte [ldrives], 4
   921 000004A4 7203                    	jb	short cld_2
   922 000004A6 E93B27                  	jmp	eetc_2
   923                                  cld_2:
   924 000004A9 BE[7065]                	mov	si, msg_c_ldd_q
   925 000004AC E88619                  	call	print_msg
   926                                  cld_3:
   927 000004AF 28E4                    	sub	ah, ah
   928 000004B1 CD16                    	int	16h
   929                                  
   930 000004B3 3C1B                    	cmp	al, 27 ; ESCAPE key
   931 000004B5 0F846501                	je	cp_esc
   932 000004B9 24DF                    	and	al, 0DFh
   933 000004BB 3C4E                    	cmp	al, 'N'
   934 000004BD 740D                    	je	short cld_4
   935 000004BF 3C59                    	cmp	al, 'Y'
   936 000004C1 75EC                    	jne	short cld_3
   937 000004C3 BE[F65D]                	mov	si, _msg_YES
   938 000004C6 E86C19                  	call	print_msg
   939                                  
   940 000004C9 E94527                  	jmp	edit_ext_table_create_x
   941                                  cld_4:
   942 000004CC BE[FC5D]                	mov	si, _msg_NO
   943 000004CF E86319                  	call	print_msg
   944                                  
   945 000004D2 E94901                  	jmp	cp_esc
   946                                  cld_5:
   947 000004D5 BE[1065]                	mov	si, msg_c_part_error
   948 000004D8 E85A19                  	call	print_msg
   949                                  
   950 000004DB 803E[D46E]03            	cmp	byte [ldrives], 3
   951 000004E0 76C7                    	jna	short cld_2
   952                                  
   953 000004E2 BE[3E65]                	mov	si, msg_c_ldd_error
   954 000004E5 E84D19                  	call	print_msg
   955                                  
   956 000004E8 EB12                    	jmp	short ap_0
   957                                  
   958                                  ;-----------------------------------------------------------------------------
   959                                   	
   960                                  activate_partition:
   961                                  	; 12/02/2019
   962 000004EA 30C0                    	xor	al, al  ; MBR/PRIMARY PARTITIONS
   963 000004EC E89E24                  	call	display_partition_table
   964                                  
   965 000004EF 803E[9271]00            	cmp	byte [pcount], 0
   966 000004F4 7713                    	ja	short ap_1
   967                                  
   968 000004F6 BE[6A5C]                	mov	si, msg_empty_pt
   969 000004F9 E83919                  	call	print_msg
   970                                  
   971                                  ap_0:
   972 000004FC BE[0C57]                	mov	si, msg_press_any_key
   973 000004FF E83319                  	call	print_msg
   974                                  
   975 00000502 30E4                    	xor	ah, ah
   976 00000504 CD16                    	int	16h
   977                                  
   978 00000506 E91501                  	jmp	ap_esc
   979                                  
   980                                  ap_1:
   981                                  	; Set valid_ppnums (MBR partition IDs) list
   982 00000509 BE[EA58]                	mov	si, MasterBootBuff+pTableOffset ; MasterBootBuff+446
   983 0000050C BB[E870]                	mov	bx, valid_ppnums
   984 0000050F B104                    	mov	cl, 4
   985                                  ap_2:
   986 00000511 8A4404                  	mov	al, [si+ptFileSystemID]
   987 00000514 8807                    	mov	[bx], al
   988 00000516 FEC9                    	dec	cl
   989 00000518 7406                    	jz	short ap_3
   990 0000051A 43                      	inc	bx
   991 0000051B 83C610                  	add	si, 16
   992 0000051E EBF1                    	jmp	short ap_2
   993                                  ap_3:
   994 00000520 BE[E95E]                	mov	si, msg_enter_pn_to_act
   995 00000523 E80F19                  	call	print_msg
   996                                  ap_getchar:
   997 00000526 30E4                    	xor	ah, ah
   998 00000528 CD16                    	int	16h
   999                                  	
  1000                                  	; 19/10/2020
  1001 0000052A 3C1B                    	cmp	al, 27
  1002 0000052C 0F84EE00                	je	ap_esc
  1003                                  
  1004                                  	;cmp	al, '0'
  1005                                  	;je	ap_esc
  1006                                  	
  1007 00000530 3C31                    	cmp	al, '1'
  1008 00000532 72F2                    	jb	short ap_getchar
  1009 00000534 3C34                    	cmp	al, '4'
  1010 00000536 77EE                    	ja	short ap_getchar
  1011                                  
  1012 00000538 30E4                    	xor	ah, ah
  1013 0000053A 89C2                    	mov	dx, ax
  1014                                  	
  1015 0000053C 80EA31                  	sub	dl, '1'
  1016 0000053F 89D6                    	mov	si, dx
  1017 00000541 38A4[E870]              	cmp	byte [si+valid_ppnums], ah  ; 0
  1018 00000545 76DF                    	jna	short ap_getchar ; Empty partition table entry, it is not shown
  1019                                  
  1020 00000547 BB0700                  	mov	bx, 07h
  1021 0000054A B409                    	mov	ah, 09h
  1022 0000054C B90100                  	mov	cx, 1
  1023 0000054F CD10                    	int	10h
  1024                                  
  1025 00000551 BE[EA58]                	mov	si, MasterBootBuff+pTableOffset
  1026 00000554 BF[4A71]                	mov	di, part_table_boot_ind ; (**)
  1027                                  
  1028                                  	; Clear all of possible active partition flags
  1029 00000557 8834                    	mov	[si], dh ; 0
  1030 00000559 887410                  	mov	[si+16], dh ; 0
  1031 0000055C 887420                  	mov	[si+32], dh ; 0
  1032 0000055F 887430                  	mov	[si+48], dh ; 0
  1033                                  
  1034                                  	; This may not be needed !?
  1035                                  	; (**) (Primary partitions structure/list)
  1036 00000562 8835                    	mov	[di], dh ; 0
  1037 00000564 887512                  	mov	[di+18], dh ; 0
  1038 00000567 887524                  	mov	[di+36], dh ; 0
  1039 0000056A 887536                  	mov	[di+54], dh ; 0
  1040                                  
  1041 0000056D 20D2                    	and 	dl, dl
  1042 0000056F 740D                    	jz	short ap_4
  1043                                  
  1044 00000571 89D0                    	mov	ax, dx
  1045                                  
  1046 00000573 C0E004                  	shl	al, 4 ; * 16
  1047 00000576 01C6                    	add	si, ax
  1048                                  
  1049 00000578 B012                    	mov	al, 18
  1050 0000057A F6E2                    	mul	dl ; 1 to 3
  1051 0000057C 01C7                    	add	di, ax
  1052                                  ap_4:
  1053                                  	; Then	set active partition as requested by user
  1054 0000057E C60480                  	mov	byte [si], 80h
  1055 00000581 C60580                  	mov	byte [di], 80h ; (**)
  1056                                  
  1057 00000584 BE[5356]                	mov	si, CRLF ; Next line
  1058 00000587 E8AB18                  	call	print_msg
  1059                                  
  1060                                  	; NOTE: Only the MBR buffer has been changed
  1061                                  	; (Masterboot sector will not be updated unless/till
  1062                                  	;  MBR partition table -and MBR code- will be written
  1063                                  	;  to disk image as result of 'write part. table' command.)
  1064                                  
  1065                                  	;; wait for 1 second
  1066                                  	;mov	ah, 02h
  1067                                  	;int	1Ah
  1068                                  	;mov	[GetChar], dh
  1069                                  ;ap_wait:
  1070                                  	;mov	ah, 02h
  1071                                  	;int	1Ah
  1072                                  	;cmp	dh, [GetChar]
  1073                                  	;je	short ap_wait
  1074                                  
  1075                                  	;jmp	A_33 ; display partition table again
  1076 0000058A E98AFE                  	jmp	A_48 ; 25/02/2019
  1077                                  
  1078                                  ;-----------------------------------------------------------------------------
  1079                                  
  1080                                  delete_partition:
  1081                                  	; 19/10/2020
  1082                                  	; 10/02/2019
  1083 0000058D 30C0                    	xor	al, al  ; MBR/PRIMARY PARTITIONS
  1084 0000058F E8FB23                  	call	display_partition_table
  1085                                  
  1086 00000592 803E[9271]00            	cmp	byte [pcount], 0
  1087 00000597 7712                    	ja	short dp_1
  1088                                  
  1089 00000599 BE[6A5C]                	mov	si, msg_empty_pt
  1090 0000059C E89618                  	call	print_msg
  1091                                  
  1092 0000059F BE[0C57]                	mov	si, msg_press_any_key
  1093 000005A2 E89018                  	call	print_msg
  1094                                  
  1095 000005A5 30E4                    	xor	ah, ah
  1096 000005A7 CD16                    	int	16h
  1097                                  
  1098 000005A9 EB73                    	jmp	short dp_esc
  1099                                  
  1100                                  dp_1:
  1101                                  	; Set valid_ppnums (MBR partition IDs) list
  1102 000005AB BE[EA58]                	mov	si, MasterBootBuff+pTableOffset ; MasterBootBuff+446
  1103 000005AE BB[E870]                	mov	bx, valid_ppnums
  1104 000005B1 B104                    	mov	cl, 4
  1105                                  dp_2:
  1106 000005B3 8A4404                  	mov	al, [si+ptFileSystemID]
  1107 000005B6 8807                    	mov	[bx], al
  1108 000005B8 FEC9                    	dec	cl
  1109 000005BA 7406                    	jz	short dp_3
  1110 000005BC 43                      	inc	bx
  1111 000005BD 83C610                  	add	si, 16
  1112 000005C0 EBF1                    	jmp	short dp_2
  1113                                  dp_3:
  1114 000005C2 BE[255D]                	mov	si, msg_enter_pn_to_del
  1115 000005C5 E86D18                  	call	print_msg
  1116                                  dp_getchar1:
  1117 000005C8 30E4                    	xor	ah, ah
  1118 000005CA CD16                    	int	16h
  1119                                  	
  1120                                  	; 19/10/2020
  1121 000005CC 3C1B                    	cmp	al, 27
  1122 000005CE 744E                    	je	short dp_esc
  1123 000005D0 3C30                    	cmp	al, '0'
  1124 000005D2 744A                    	je	short dp_esc
  1125                                  	;cmp	al, '1'
  1126 000005D4 72F2                    	jb	short dp_getchar1
  1127 000005D6 3C34                    	cmp	al, '4'
  1128 000005D8 77EE                    	ja	short dp_getchar1
  1129                                  
  1130                                  	;sub	al, '0'
  1131 000005DA 30FF                    	xor	bh, bh
  1132 000005DC 88C3                    	mov	bl, al
  1133                                  	;dec	bl
  1134 000005DE 80EB31                  	sub	bl, '1'
  1135 000005E1 38BF[E870]              	cmp	byte [bx+valid_ppnums], bh ; 0 ; 12/02/2019
  1136 000005E5 76E1                    	jna	short dp_getchar1  ; Empty partition table entry, it is not shown
  1137                                  	
  1138 000005E7 881E[F570]              	mov	[del_part_num], bl ; Selected partition number to be deleted.
  1139                                  	;add	al, '0'
  1140 000005EB A2[495D]                	mov	[chr_del_pnum1], al ; Partition number for "Enter ..." text
  1141 000005EE A2[EB5D]                	mov	[chr_del_pnum2], al ; Partition number for "Do you want ..." text
  1142                                  
  1143 000005F1 BE[495D]                	mov	si, chr_del_pnum1 ; write partition number (user input)
  1144 000005F4 E83E18                  	call	print_msg
  1145                                  
  1146                                  	;xor	al, al
  1147 000005F7 A2[495D]                	mov	[chr_del_pnum1], al ; 0 ; reset
  1148                                  
  1149 000005FA BE[4D5D]                	mov	si, msg_delete_partition_q ; question for deleting (with warning)
  1150 000005FD E83518                  	call	print_msg
  1151                                  
  1152                                  dp_getchar2:
  1153 00000600 30E4                    	xor	ah, ah
  1154 00000602 CD16                    	int	16h
  1155                                  
  1156 00000604 3C1B                    	cmp	al, 27
  1157 00000606 7416                    	je	short dp_esc
  1158                                  
  1159 00000608 24DF                    	and	al, 0DFh
  1160 0000060A 3C59                    	cmp	al, 'Y'
  1161 0000060C 7418                    	je	short dp_yes
  1162 0000060E 3C4E                    	cmp	al, 'N'
  1163 00000610 75EE                    	jne	short dp_getchar2
  1164                                  dp_no:
  1165 00000612 BE[FD5D]                	mov	si, msg_NO ;  Write 'NO' (it may be shown for a moment)
  1166 00000615 E81D18                  	call	print_msg
  1167                                  	
  1168 00000618 BE[5356]                	mov	si, CRLF  ; Next line
  1169 0000061B E81718                  	call	print_msg
  1170                                  	
  1171                                  	;jmp	short dp_esc
  1172                                  
  1173                                  cp_esc:
  1174                                  ap_esc:
  1175                                  wptmbr_esc:
  1176                                  dp_esc:
  1177 0000061E 30C0                    	xor	al, al  ; MBR/PRIMARY PARTITIONS
  1178 00000620 E86A23                  	call	display_partition_table
  1179 00000623 E9A0FD                  	jmp	A_44
  1180                                  
  1181                                  dp_yes:
  1182 00000626 BE[F75D]                	mov	si, msg_YES ;  Write 'YES' (it may be shown for a moment)
  1183 00000629 E80918                  	call	print_msg
  1184                                  
  1185 0000062C BF[EA58]                	mov	di, MasterBootBuff+pTableOffset
  1186 0000062F A0[F570]                	mov	al, [del_part_num]
  1187 00000632 20C0                    	and 	al, al
  1188 00000634 7406                    	jz	short dp_4
  1189 00000636 98                      	cbw
  1190                                  	;xor	ah, ah
  1191 00000637 C0E004                  	shl	al, 4 ; * 16
  1192 0000063A 01C7                    	add	di, ax
  1193                                  dp_4:
  1194 0000063C BE[5356]                	mov	si, CRLF ; Next line
  1195 0000063F E8F317                  	call	print_msg
  1196                                  
  1197                                  	; 27/02/2019
  1198 00000642 807D0405                	cmp	byte [di+ptFileSystemID], 5
  1199 00000646 7547                    	jne	short dp_5
  1200                                  
  1201 00000648 3806[D46E]              	cmp	byte [ldrives], al ; 0
  1202 0000064C 7641                    	jna	short dp_5
  1203                                  
  1204 0000064E BE[1361]                	mov	si, msg_ext_part_del_error
  1205 00000651 E8E117                  	call	print_msg
  1206 00000654 BE[5361]                	mov	si, msg_cancel_continue
  1207 00000657 E8DB17                  	call	print_msg
  1208                                       	
  1209 0000065A 30E4                    	xor	ah, ah
  1210 0000065C CD16                    	int	16h
  1211                                  	
  1212 0000065E 3C1B                    	cmp	al, 27 ; ESCape
  1213 00000660 74BC                    	je	short dp_esc
  1214                                  
  1215 00000662 E8672B                  	call	delete_logical_drives
  1216                                  	
  1217                                  	; 28/02/2019
  1218 00000665 803E[D46E]01            	cmp	byte [ldrives], 1
  1219 0000066A 73B2                    	jnb	short dp_esc
  1220                                  
  1221 0000066C 30C0                    	xor	al, al  ; MBR/PRIMARY PARTITIONS
  1222 0000066E E81C23                  	call	display_partition_table
  1223                                  
  1224 00000671 BE[E661]                	mov	si, msg_delete_ext_part
  1225 00000674 E8BE17                  	call	print_msg
  1226                                  
  1227                                  dp_ask_again:
  1228 00000677 28E4                    	sub	ah, ah
  1229 00000679 CD16                    	int	16h
  1230                                  
  1231 0000067B 3C1B                    	cmp	al, 27 ; ESCape
  1232 0000067D 749F                    	je	short dp_esc
  1233                                  
  1234 0000067F 3C0D                    	cmp	al, 13 ; ENTER/CR
  1235 00000681 75F4                    	jne	short dp_ask_again
  1236                                  
  1237 00000683 BF[EA58]                	mov	di, MasterBootBuff+pTableOffset
  1238 00000686 A0[F570]                	mov	al, [del_part_num]
  1239 00000689 98                      	cbw
  1240 0000068A C0E004                  	shl	al, 4 ; * 16
  1241 0000068D 01C7                    	add	di, ax
  1242                                  dp_5:
  1243 0000068F 31C0                    	xor	ax, ax
  1244                                  
  1245                                  	; clear partition table entry in MBR buffer
  1246 00000691 B90800                  	mov	cx, 8
  1247 00000694 F3AB                    	rep	stosw
  1248                                  	
  1249                                  	; NOTE: Only the MBR buffer will be cleared
  1250                                  	; (Masterboot sector will not be updated unless/till
  1251                                  	;  MBR partition table -and MBR code- will be written
  1252                                  	;  to disk image as result of 'write part. table' command.)
  1253                                  
  1254 00000696 E9A1FB                  	jmp	A_27 ; 08/03/2019
  1255                                   	 
  1256                                  ;-----------------------------------------------------------------------------
  1257                                  
  1258                                  write_pt_mbr:
  1259                                  	; 11/02/2019
  1260 00000699 30C0                    	xor	al, al  ; MBR/PRIMARY PARTITIONS
  1261 0000069B E8EF22                  	call	display_partition_table
  1262                                  
  1263 0000069E BE[015E]                	mov	si, msg_write_masterboot_sector
  1264 000006A1 E89117                  	call	print_msg
  1265                                  
  1266 000006A4 A2[C46E]                	mov	[GetChar], al ; 0
  1267                                  
  1268 000006A7 BE[E45E]                	mov	si, option_input
  1269 000006AA E88817                  	call	print_msg
  1270                                  
  1271 000006AD B403                    	mov	ah, 3
  1272                                  	;mov	bx, 7
  1273 000006AF CD10                    	int	10h ; Return Cursor Position
  1274                                  	; DL = Column
  1275                                  	
  1276 000006B1 FECA                    	dec	dl ; previous char ; ']'
  1277 000006B3 FECA                    	dec	dl ; previous char ; '[ ]'
  1278                                  
  1279 000006B5 B402                    	mov	ah, 2
  1280                                  	;mov	bx, 7
  1281 000006B7 CD10                    	int	10h ; Set Cursor Position
  1282                                  
  1283                                  	; write char at current cursor position
  1284                                  
  1285 000006B9 B030                    	mov	al, '0' ; Write default char
  1286                                  
  1287                                  	;;mov	bx, 07h
  1288 000006BB B409                    	mov	ah, 09h
  1289 000006BD B90100                  	mov	cx, 1
  1290 000006C0 CD10                    	int	10h
  1291                                  
  1292                                  wptmbr_getchar:
  1293 000006C2 30E4                    	xor	ah, ah
  1294 000006C4 CD16                    	int	16h
  1295                                  
  1296 000006C6 3C1B                    	cmp	al, 1Bh ; 27
  1297 000006C8 0F8452FF                	je	wptmbr_esc ; 19/10/2020
  1298                                  
  1299 000006CC 3C0D                    	cmp	al, 0Dh ; 13
  1300 000006CE 7414                    	je	short wptmbr_1
  1301                                                  
  1302 000006D0 3C31                    	cmp	al, '1'
  1303 000006D2 72EE                    	jb	short wptmbr_getchar
  1304                                  
  1305 000006D4 3C32                    	cmp	al, '2'
  1306 000006D6 77EA                    	ja 	short wptmbr_getchar
  1307                                  
  1308 000006D8 A2[C46E]                	mov	[GetChar], al
  1309                                  
  1310                                  	;;mov	bx, 07h
  1311 000006DB B409                    	mov	ah, 09h
  1312 000006DD B90100                  	mov	cx, 1
  1313 000006E0 CD10                    	int	10h
  1314 000006E2 EBDE                    	jmp	short wptmbr_getchar
  1315                                  
  1316                                  wptmbr_1:
  1317 000006E4 803E[C46E]00            	cmp	byte [GetChar], 0
  1318 000006E9 76D7                    	jna	short wptmbr_getchar
  1319                                  
  1320 000006EB BE[B25E]                	mov	si, msg_writing_ptable
  1321 000006EE E84417                  	call	print_msg
  1322                                  
  1323 000006F1 803E[C46E]32            	cmp	byte [GetChar], '2'
  1324 000006F6 7471                    	je	short wptmbr_5
  1325                                  
  1326                                  wptmbr_2:
  1327                                  	; this may not be needed here (?)
  1328                                  	; ('seek' file pointer is needed flag)
  1329 000006F8 C606[9C40]01            	mov 	byte [random], 1
  1330                                  
  1331 000006FD 833E[9440]00            	cmp	word [img_file_handle], 0
  1332 00000702 7713                    	ja	short wptmbr_3
  1333                                  
  1334                                  	; Open disk image file again.
  1335                                  
  1336 00000704 FE0E[9C40]              	dec	byte [random] ; 0 ; masterboot sector will be written
  1337                                  			  	  ; no need to seek file pointer
  1338                                  
  1339 00000708 BA[8559]                	mov	dx, img_file_name
  1340 0000070B B8023D                  	mov	ax, 3D02h ; open file for reading and writing
  1341 0000070E CD21                    	int	21h
  1342 00000710 0F820B17                	jc	D_02
  1343                                  
  1344 00000714 A3[9440]                	mov	[img_file_handle], ax
  1345                                  wptmbr_3:
  1346 00000717 31C0                    	xor	ax, ax ; 0
  1347 00000719 31D2                    	xor	dx, dx ; 0
  1348                                  	; DX_AX = Masterboot Sector = 0
  1349 0000071B BB[2C57]                	mov	bx, MasterBootBuff
  1350                                  	; ES:BX = Sector Buffer
  1351 0000071E E82317                  	call	write_hd_sector
  1352 00000721 0F82F016                	jc	D_01 ; ! display error msg and then exit !
  1353                                  
  1354 00000725 BE[DB5E]                	mov	si, _msg_OK
  1355 00000728 E80A17                  	call	print_msg
  1356                                  
  1357 0000072B 803E[9C40]00            	cmp	byte [random], 0
  1358 00000730 7712                    	ja	short wptmbr_4
  1359                                  
  1360                                  	;mov	byte [random], 1
  1361                                  
  1362 00000732 8B1E[9440]              	mov	bx, [img_file_handle]
  1363 00000736 B43E                    	mov	ah, 3Eh ; close file
  1364 00000738 CD21                    	int	21h
  1365 0000073A 0F82E116                	jc	D_02
  1366                                  
  1367 0000073E C706[9440]0000          	mov	word [img_file_handle], 0
  1368                                  
  1369                                  wptmbr_4:
  1370                                  	; wait for 1 second
  1371 00000744 B402                    	mov	ah, 02h
  1372 00000746 CD1A                    	int	1Ah
  1373 00000748 8836[C46E]              	mov	[GetChar], dh
  1374                                  wptmbr_wait:
  1375 0000074C B402                    	mov	ah, 02h
  1376 0000074E CD1A                    	int	1Ah
  1377 00000750 3A36[C46E]              	cmp	dh, [GetChar]
  1378 00000754 74F6                    	je	short wptmbr_wait
  1379                                  	
  1380 00000756 BE[0C57]                	mov	si, msg_press_any_key
  1381 00000759 E8D916                  	call	print_msg
  1382                                                  
  1383 0000075C 30E4                    	xor	ah, ah	; "Press any key to continue"
  1384 0000075E CD16                    	int	16h
  1385                                  
  1386 00000760 BE[5356]                	mov	si, CRLF
  1387 00000763 E8CF16                  	call	print_msg
  1388                                  
  1389 00000766 E9B5FE                  	jmp	wptmbr_esc
  1390                                  
  1391                                  wptmbr_5:
  1392 00000769 BE[8232]                	mov	si, TRDOS386_MASTERBOOT_SECTOR
  1393 0000076C B9DF00                  	mov	cx, 446/2 ; Copy Singlix FS 1 MBR code
  1394                                  			  ; except Partition Table
  1395 0000076F BF[2C57]                	mov	di, MasterBootBuff
  1396 00000772 F3A5                    	rep	movsw
  1397                                  	
  1398                                  	; This (Below) is not needed; because, if MBR magicword
  1399                                  	; would not be 0AA55h, we would not be able to come here!
  1400                                  	;;add	di, 64  ; skip partition table
  1401                                  	;;mov	ax, 0AA55h
  1402                                  	;;stosw
  1403                                  	;mov 	word [MBIDCode], 0AA55h
  1404                                  
  1405                                  	; 12/02/2019
  1406                                  	; Copy CHS parameters to Singlix MBR (on disk)
  1407                                  	
  1408 00000774 BF[D058]                	mov	di, MasterBootBuff+420
  1409                                  
  1410 00000777 A1[9A40]                	mov	ax, [cylinders]
  1411 0000077A AB                      	stosw 			; cylinders
  1412 0000077B A1[9840]                	mov	ax, [heads]
  1413 0000077E AB                      	stosw 			; heads
  1414 0000077F A1[9640]                	mov	ax, [sectors]
  1415 00000782 AB                      	stosw 			; sectors
  1416                                  
  1417 00000783 E972FF                  	jmp	wptmbr_2
  1418                                  
  1419                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1420                                  ; Nextline & Exit
  1421                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1422                                  ; 25/02/2019
  1423                                  
  1424                                  B_01:
  1425                                  	;mov	si, TrDOS_Welcome
  1426                                  	; 04/05/2024
  1427 00000786 BE[9A44]                	mov	si, RD5_Welcome
  1428 00000789 E8A916                  	call	print_msg
  1429                                  B_02:
  1430 0000078C BE[5356]                	mov	si, CRLF
  1431                                  B_03:
  1432 0000078F E8A316                  	call	print_msg
  1433 00000792 B8004C                  	mov	ax, 4C00h		; terminate
  1434 00000795 CD21                    	int	21h
  1435                                  B_04:
  1436 00000797 BE[5845]                	mov	si, msg_inv_image_file
  1437 0000079A EBF3                    	jmp	short B_03 ; 03/10/2020 (short jump)
  1438                                  
  1439                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1440                                  ; Display create partition menu & get partition type input
  1441                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1442                                  
  1443                                  create_partition_input:
  1444                                  	; 15/02/2019
  1445                                  	; clear screen
  1446 0000079C B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  1447 0000079F CD10                    	int	10h
  1448                                  	
  1449 000007A1 BE[4D46]                	mov	si, msg_create_partition_h ; header
  1450 000007A4 E88E16                  	call	print_msg
  1451 000007A7 BE[4247]                	mov	si, msg_create_partition_m ; menu
  1452 000007AA E88816                  	call	print_msg
  1453                                  cpi_1:
  1454 000007AD 30E4                    	xor	ah, ah
  1455 000007AF CD16                    	int	16h
  1456 000007B1 3C1B                    	cmp	al, 27 ; ESC key
  1457                                  	;;je	B_47
  1458                                  	;je	A_48 ; A_33
  1459 000007B3 7445                    	je	short cpi_4  ; 25/02/2019
  1460 000007B5 3C30                    	cmp	al, '0'
  1461                                  	;;je	B_47
  1462                                  	;je	A_48 ; A_33
  1463 000007B7 7441                    	je	short cpi_4  ; 25/02/2019
  1464 000007B9 72F2                    	jb	short cpi_1
  1465 000007BB 3C34                    	cmp	al, '4'
  1466 000007BD 77EE                    	ja	short cpi_1
  1467                                  
  1468 000007BF 30E4                    	xor	ah, ah
  1469 000007C1 2C30                    	sub	al, '0'
  1470                                  
  1471                                  	;mov	[pp_type], al
  1472                                  
  1473                                  	;mov	byte [pp_type_user], 0
  1474                                  
  1475 000007C3 3C01                    	cmp	al, 1 ; DOS partition
  1476 000007C5 7536                    	jne	short cpi_5 ; ah = 0 
  1477                                  			    ; (al = 2 -> singlix, al = 3 -> retro unix)
  1478                                  cpi_2:
  1479                                  	; clear screen
  1480 000007C7 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  1481 000007CA CD10                    	int	10h
  1482                                  	
  1483 000007CC BE[F848]                	mov	si, msg_create_dos_partition_h ; header
  1484 000007CF E86316                  	call	print_msg
  1485 000007D2 BE[CC4C]                	mov	si, msg_create_dos_partition_m ; menu
  1486 000007D5 E85D16                  	call	print_msg
  1487                                  cpi_3:
  1488 000007D8 30E4                    	xor	ah, ah
  1489 000007DA CD16                    	int	16h
  1490 000007DC 3C1B                    	cmp	al, 27 ; ESC key
  1491                                  	;je	short B_47
  1492 000007DE 741A                    	je	short cpi_4
  1493 000007E0 3C30                    	cmp	al, '0'
  1494                                  	;je	short B_47
  1495 000007E2 7416                    	je	short cpi_4
  1496 000007E4 72F2                    	jb	short cpi_3
  1497 000007E6 3C33                    	cmp	al, '3'
  1498 000007E8 77EE                    	ja	short cpi_3
  1499                                  	
  1500 000007EA 30E4                    	xor	ah, ah
  1501 000007EC 2C30                    	sub	al, '0'
  1502 000007EE 3C01                    	cmp	al, 1
  1503 000007F0 7420                    	je	short cpi_6  ;	ah = 0 (al = primary dos partition)
  1504                                  
  1505                                  	;mov	byte [pp_type], 5
  1506                                  
  1507 000007F2 3C02                    	cmp	al, 2
  1508 000007F4 761D                    	jna	short cpi_7
  1509                                  
  1510 000007F6 B80600                  	mov	ax, 6	; ah = 0 (al = logical dos drive/partition)
  1511 000007F9 C3                      	retn
  1512                                  
  1513                                  cpi_4:
  1514 000007FA 31C0                    	xor	ax, ax	; ah = 0 (al = 0 -> ESCape/Cancel)
  1515 000007FC C3                      	retn
  1516                                  cpi_5:
  1517 000007FD 3C04                    	cmp	al, 4	 ; option num. for partition type (user) input
  1518 000007FF 7511                    	jne	short cpi_6
  1519                                  
  1520 00000801 E84F1A                  	call	partition_type_input
  1521                                  
  1522 00000804 B404                    	mov	ah, 4 ; user/another type partition flag
  1523                                  	; al = Partition ID
  1524 00000806 50                      	push	ax
  1525 00000807 BE[0C57]                	mov	si, msg_press_any_key
  1526 0000080A E82816                  	call	print_msg
  1527 0000080D 28E4                    	sub	ah, ah
  1528 0000080F CD16                    	int	16h
  1529 00000811 58                      	pop	ax
  1530                                  cpi_6:
  1531 00000812 C3                      	retn
  1532                                  cpi_7:
  1533 00000813 B80500                  	mov	ax, 5	; ah = 0 (al = extended dos partition)
  1534 00000816 C3                      	retn
  1535                                  
  1536                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1537                                  ; Create primary (dos or non-dos) partition
  1538                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1539                                  ; 16/02/2019 
  1540                                  ;	(This procedure must be called after 'find_part_free_space')
  1541                                  
  1542                                  create_primary_partition:  
  1543                                  	; 16/02/2019
  1544                                  
  1545                                  	; INPUT:
  1546                                  	;	none 
  1547                                  	;  (CHS parameters and free space calculation result will be used.) 
  1548                                  	;
  1549                                  	; OUTPUT:
  1550                                  	;	Partition table in MBR buffer will be updated.
  1551                                  	;
  1552                                  	; (Modified registers: ax, bx, cx, dx, si, di)
  1553                                  
  1554                                  	; Create primary dos or non-dos partition,
  1555                                  	; make partition table entry
  1556                                  
  1557 00000817 803E[9D40]00            	cmp	byte [newdisk], 0
  1558 0000081C 760A                    	jna	short cpp_0
  1559                                  
  1560                                  	; cylinder = 0, head = 1, sector = 1
  1561                                  	; LBA = (((cylinder*heads)+head)*sectors)+sector-1
  1562                                  
  1563 0000081E BE[EA58]                	mov	si, MasterBootBuff+pTableOffset
  1564                                  
  1565 00000821 A1[9640]                	mov	ax, [sectors] ; LBA = 17 or 63
  1566 00000824 31D2                    	xor	dx, dx
  1567 00000826 EB56                    	jmp	short cpp_4
  1568                                  cpp_0:
  1569                                  	; 16/02/2019
  1570 00000828 E81B21                  	call	get_first_free_pte
  1571                                  		 ; CX = First free PTE number, 0 to 3 
  1572                                  		 ;    (CX = 3 if there is not a free PTE, and CF = 1)
  1573                                  		 ;    ((But CF = 1 is not possible here because pcount < 4))
  1574                                   	 	 ; SI = PTE address/offset in MBR buffer
  1575                                  
  1576                                  	;mov	si, MasterBootBuff+pTableOffset
  1577                                  	;shl	cl, 4 ; * 16
  1578                                  	;add	si, cx
  1579                                  
  1580                                  	; 18/02/2019
  1581 0000082B 8B3E[3072]              	mov	di, [c_fspc_offset]
  1582 0000082F 8B9D[E071]              	mov	bx, [di+free_space.start]
  1583 00000833 A0[9840]                	mov	al, [heads]
  1584 00000836 F626[9640]              	mul	byte [sectors]
  1585 0000083A F7E3                    	mul	bx
  1586                                  		; DX:AX = LBA of start cylinder, head 0, sector 1
  1587                                  	
  1588 0000083C 8A0E[3272]              	mov	cl, [cylinder_boundary]
  1589                                  
  1590                                  	;cmp	cl, 0 ; Default (partition size unit is one of C, G, M)
  1591                                  		      ; boundary alignment is forced as default
  1592                                  	;je	short cpp_4
  1593                                  
  1594                                  	; 20/02/2019
  1595                                  	;and	cl, cl
  1596                                  	;jz 	short cpp_1
  1597                                  
  1598 00000840 80F959                  	cmp	cl, 'Y'
  1599 00000843 7439                    	je	short cpp_4 ; cylinder boundary option (answer) = YES
  1600                                  
  1601 00000845 80F94E                  	cmp	cl, 'N'
  1602 00000848 750A                    	jne	short cpp_1 ; cylinder boundary option (answer) = YES/NO
  1603                                  
  1604                                  	; cylinder boundary option (answer) = NO 
  1605 0000084A 8B85[EA71]              	mov	ax, [di+free_space.startsector]
  1606 0000084E 8B95[EC71]              	mov	dx, [di+free_space.startsector+2]
  1607 00000852 EB2A                    	jmp	short cpp_4
  1608                                  cpp_1:
  1609                                  	;cmp	cl, 27 ; ESCape
  1610                                  	;jne	short cpp_4 ; 'Y'
  1611                                  
  1612                                  	; check	cylinder boundary alignment of the start sector
  1613                                  
  1614                                  	; if start sector is not aligned, end sector must not be aligned
  1615                                  	; (this rule is valid for ESCape key from the user) 
  1616                                  
  1617 00000854 C606[3272]59            	mov	byte [cylinder_boundary], 'Y' ; YES for end sector check
  1618                                  
  1619 00000859 8B8D[EA71]              	mov	cx, [di+free_space.startsector]
  1620                                  
  1621 0000085D 09DB                    	or	bx, bx
  1622                                  
  1623 0000085F 8B9D[EC71]              	mov	bx, [di+free_space.startsector+2]
  1624                                  
  1625 00000863 7508                    	jnz	short cpp_2 ; start cylinder > 0
  1626                                  
  1627                                  	;and	bx, bx
  1628                                  	;jnz	short cpp_3
  1629                                  
  1630 00000865 3B0E[9640]              	cmp	cx, [sectors]
  1631 00000869 7413                    	je	short cpp_4 ; start sector is as aligned 
  1632 0000086B EB08                    	jmp	short cpp_3
  1633                                  cpp_2:
  1634 0000086D 39C8                    	cmp	ax, cx
  1635 0000086F 7504                    	jne	short cpp_3
  1636 00000871 39DA                    	cmp	dx, bx
  1637 00000873 7409                    	je	short cpp_4 
  1638                                  cpp_3:
  1639 00000875 89C8                    	mov	ax, cx
  1640 00000877 89DA                    	mov	dx, bx
  1641 00000879 C606[3272]4E            	mov	byte [cylinder_boundary], 'N'
  1642                                  cpp_4:
  1643 0000087E 894408                  	mov	[si+ptStartSector], ax
  1644 00000881 89540A                  	mov	[si+ptStartSector+2], dx
  1645                                  
  1646                                  	; save start sector (for partition formatting procedure)
  1647 00000884 A3[986E]                	mov	[pp_StartSector], ax
  1648 00000887 8916[9A6E]              	mov	[pp_StartSector+2], dx
  1649                                  
  1650 0000088B 803E[9D40]00            	cmp	byte [newdisk], 0
  1651 00000890 763F                    	jna	short cpp_5
  1652                                  
  1653 00000892 31C9                    	xor	cx, cx
  1654 00000894 894C03                  	mov	[si+ptBeginCylinder], cx ; 0
  1655 00000897 FEC1                    	inc	cl  ; 1
  1656 00000899 884C02                  	mov	[si+ptBeginSector], cl ; 1
  1657 0000089C 884C01                  	mov	[si+ptBeginHead], cl ; 1
  1658                                  
  1659                                  	; set active partition flag
  1660                                  	;mov	byte [si+ptBootable], 80h ; bootable/active partition
  1661 0000089F C60480                  	mov	byte [si], 80h ; bootable/active partition
  1662                                  
  1663                                  	; 18/02/2019
  1664                                  
  1665 000008A2 8B0E[CC6E]              	mov	cx, [ppn_Sectors]
  1666 000008A6 8B1E[CE6E]              	mov	bx, [ppn_Sectors+2]
  1667                                  
  1668 000008AA 803E[A06E]00            	cmp	byte [wholedisk], 0
  1669 000008AF 0F86FE00                	jna	cpp_12
  1670                                  
  1671 000008B3 A0[9840]                	mov	al, [heads]
  1672 000008B6 FEC8                    	dec	al
  1673 000008B8 884405                  	mov	[si+ptEndHead], al
  1674 000008BB A0[9640]                	mov	al, [sectors]
  1675 000008BE 884406                  	mov	[si+ptEndSector], al
  1676 000008C1 A1[9A40]                	mov	ax, [cylinders]
  1677 000008C4 48                      	dec	ax
  1678 000008C5 884407                  	mov	[si+ptEndCylinder], al
  1679 000008C8 C0E406                  	shl	ah, 6
  1680 000008CB 086406                  	or	[si+ptEndSector], ah
  1681                                  
  1682                                  	;jmp	cpp_16
  1683 000008CE E95501                  	jmp	cpp_15 ; 06/03/2019
  1684                                  cpp_5:
  1685                                  	; 18/02/2019
  1686                                  		
  1687 000008D1 803E[3272]59            	cmp	byte [cylinder_boundary], 'Y'
  1688 000008D6 7525                    	jne	short cpp_7
  1689                                  
  1690 000008D8 30DB                    	xor	bl, bl ; head  = 0
  1691                                  
  1692 000008DA 8B8D[E071]              	mov	cx, [di+free_space.start]
  1693                                  
  1694                                  	; 06/03/2019
  1695                                  	;or	ax, ax
  1696                                  	;jnz	short cpp_6
  1697                                  
  1698                                  	;and	cx, cx  ; start cylinder = 0 ?
  1699                                  	;jnz	short cpp_6
  1700                                  
  1701 000008DE 09C8                    	or	ax, cx
  1702 000008E0 7513                    	jnz	short cpp_6
  1703                                  
  1704 000008E2 A1[9640]                	mov	ax, [sectors]
  1705                                  	
  1706 000008E5 894408                  	mov	[si+ptStartSector], ax
  1707                                  	;mov	[si+ptStartSector+2], cx ; 0
  1708                                  
  1709 000008E8 A3[986E]                	mov	[pp_StartSector], ax
  1710                                  	;mov	[pp_StartSector+2], cx
  1711                                  
  1712 000008EB 2906[9C6E]              	sub	[pp_Sectors], ax
  1713 000008EF 190E[9E6E]              	sbb	[pp_Sectors+2], cx ; 0
  1714                                  	
  1715                                  	; cylinder 0, head 1, sector 1 (LBA = 17 or 63)
  1716 000008F3 FEC3                    	inc	bl  ; head = 1
  1717                                  cpp_6:
  1718 000008F5 89C8                    	mov	ax, cx
  1719 000008F7 C6440201                	mov	byte [si+ptBeginSector], 1 ; sector = 1
  1720 000008FB EB16                    	jmp	short cpp_8
  1721                                  cpp_7:
  1722                                  	; 18/02/2019
  1723                                  
  1724                                  	; [wholedisk] = 0
  1725                                  
  1726                                  	; Fix partition size for MSDOS 3.3 (Retro DOS 3.0) compatibility.
  1727                                  	; (DOS partition size will be changed -down- to 65535 sectors,
  1728                                  	; if it is 65536 sectors.)
  1729                                  	
  1730 000008FD E83601                  	call	fix_32mb_dos_psize
  1731                                  
  1732                                  	;cylinder = LBA / (heads_per_cylinder * sectors_per_track)
  1733                                  	;temp = LBA % (heads_per_cylinder * sectors_per_track)
  1734                                  	;head = temp / sectors_per_track
  1735                                  	;sector = temp % sectors_per_track + 1
  1736                                  	
  1737                                  	; Convert LBA sector address to CHS parameters
  1738 00000900 8B0E[9640]              	mov	cx, [sectors]
  1739 00000904 E82F05                  	call	div32
  1740                                  	; BX = Sector number - 1
  1741 00000907 FEC3                    	inc	bl ; sector number (1 based)
  1742 00000909 885C02                  	mov	[si+ptBeginSector], bl	
  1743                                  	; DX_AX = cylinders * heads + head
  1744 0000090C 8B0E[9840]              	mov	cx, [heads]
  1745 00000910 E82305                  	call	div32
  1746                                  cpp_8:
  1747                                  	; BX = Head number
  1748 00000913 885C01                  	mov	[si+ptBeginHead], bl
  1749                                  	; AX = Cylinder number
  1750                                  	;and	ax, 1023
  1751 00000916 884403                  	mov	[si+ptBeginCylinder], al
  1752 00000919 C0E406                  	shl	ah, 6
  1753 0000091C 086402                  	or	[si+ptBeginSector], ah
  1754                                  
  1755                                  	; clear active partition flag (for now)
  1756                                  	;mov	byte [si+ptBootable], 0 ; not bootable/active partition
  1757 0000091F C60400                  	mov	byte [si], 0 ; not bootable/active partition
  1758                                  
  1759                                  	;mov	di, [c_fspc_offset]
  1760                                  
  1761 00000922 803E[3272]59            	cmp	byte [cylinder_boundary], 'Y'
  1762 00000927 7579                    	jne	short cpp_11
  1763                                  
  1764 00000929 8A0E[9840]              	mov	cl, [heads]
  1765 0000092D A0[9640]                	mov	al, [sectors]
  1766 00000930 88C5                    	mov	ch, al
  1767 00000932 F6E1                    	mul	cl	
  1768                                  	; ax = heads*sectors
  1769                                  
  1770 00000934 8B9D[E271]              	mov	bx, [di+free_space.end]  ; end cylinder of the partition
  1771                                  
  1772 00000938 803E[A06E]00            	cmp	byte [wholedisk], 0 ; entire free space ?
  1773 0000093D 7726                    	ja	short cpp_10
  1774                                  
  1775 0000093F 89C3                    	mov	bx, ax
  1776 00000941 A1[CC6E]                	mov	ax, [ppn_Sectors]
  1777 00000944 8B16[CE6E]              	mov	dx, [ppn_Sectors+2]
  1778 00000948 0306[986E]              	add	ax, [pp_StartSector]
  1779 0000094C 1316[9A6E]              	adc	dx, [pp_StartSector+2]
  1780 00000950 83E801                  	sub	ax, 1
  1781 00000953 83DA00                  	sbb	dx, 0
  1782                                  		; dx:ax = end sector
  1783 00000956 F7F3                    	div	bx
  1784                                  		; ax = cylinder count
  1785 00000958 21D2                    	and	dx, dx
  1786 0000095A 7401                    	jz	short cpp_9
  1787 0000095C 40                      	inc	ax ; + 1 (because of remainder > 0)
  1788                                  cpp_9:	
  1789 0000095D 93                      	xchg	ax, bx
  1790                                  		; bx = end cylinder
  1791                                  		; ax = heads*sectors
  1792                                  	; free space limit check
  1793 0000095E 3B9D[E271]              	cmp	bx, [di+free_space.end]
  1794 00000962 7601                    	jna	short cpp_10 ; ok
  1795                                  	; end cylinder is out of free space
  1796 00000964 4B                      	dec	bx  ; decrease end cylinder number
  1797                                  cpp_10: 
  1798 00000965 F7E3                    	mul	bx
  1799                                  		 ; dx:ax = (end cylinder)*heads*sectors
  1800 00000967 52                      	push	dx ; **
  1801 00000968 50                      	push	ax ; *
  1802 00000969 FEC9                    	dec	cl ; heads - 1 = end head
  1803                                  
  1804 0000096B 884C05                  	mov	[si+ptEndHead], cl
  1805                                  		
  1806                                  	;mov	al, [sectors]
  1807 0000096E 88E8                    	mov	al, ch
  1808 00000970 885C07                  	mov	[si+ptEndCylinder], bl
  1809 00000973 88C3                    	mov	bl, al
  1810 00000975 C0E706                  	shl	bh, 6 ; shift high bytes (2 bits) of end cyl num
  1811                                  		      ; to 6 bits left	
  1812 00000978 08DF                    	or	bh, bl ; combine high bits of end cyl num and end sector
  1813 0000097A 887C06                  	mov	[si+ptEndSector], bh
  1814 0000097D 30FF                    	xor	bh, bh ; clear bh
  1815 0000097F FECB                    	dec	bl ; sectors - 1 ; 22/02/2019
  1816 00000981 F6E1                    	mul	cl
  1817 00000983 5A                      	pop	dx ; *
  1818                                  	; 22/02/2019
  1819 00000984 31C9                    	xor	cx, cx
  1820 00000986 01D0                    	add	ax, dx
  1821 00000988 5A                      	pop	dx ; **
  1822 00000989 11CA                    	adc	dx, cx ; 0
  1823 0000098B 01D8                    	add	ax, bx
  1824 0000098D 11CA                    	adc	dx, cx ; 0
  1825                                  	; dx:ax = ((([end cylinder]*heads)+[end head])*sectors)+sectors-1
  1826                                  
  1827                                  	; calculate aligned partition size in sectors
  1828 0000098F 89C1                    	mov	cx, ax
  1829 00000991 89D3                    	mov	bx, dx
  1830 00000993 83C101                  	add	cx, 1
  1831 00000996 83D300                  	adc	bx, 0	
  1832 00000999 2B4C08                  	sub	cx, [si+ptStartSector]
  1833 0000099C 1B5C0A                  	sbb	bx, [si+ptStartSector+2]
  1834                                  		; bx:cx = partition size
  1835                                  	;mov	[ppn_Sectors], cx
  1836                                  	;mov	[ppn_Sectors+2], bx
  1837                                  	;jmp	cpp_16
  1838 0000099F E98400                  	jmp	cpp_15 ; 06/03/2019
  1839                                  cpp_11:
  1840                                  	; 20/02/2019
  1841 000009A2 8B0E[CC6E]              	mov	cx, [ppn_Sectors]
  1842 000009A6 8B1E[CE6E]              	mov	bx, [ppn_Sectors+2]
  1843                                  
  1844                                  	;;mov	ax, [di+free_space.startsector]
  1845                                  	;;mov	ax, [di+free_space.startsector+2]
  1846                                  	;mov	ax, [si+ptStartSector]
  1847                                  	;mov	dx, [si+ptStartSector+2]
  1848 000009AA A1[986E]                	mov	ax, [pp_StartSector]
  1849 000009AD 8B16[9A6E]              	mov	dx, [pp_StartSector+2]
  1850                                  cpp_12:	
  1851                                  	; 18/02/2019
  1852                                  
  1853                                  	; [wholedisk] = 0
  1854                                  
  1855                                  	; Fix partition size for MSDOS 3.3 (Retro DOS 3.0) compatibility.
  1856                                  	; (DOS partition size will be changed -down- to 65535 sectors,
  1857                                  	; if it is 65536 sectors.)
  1858                                  
  1859 000009B1 E88200                  	call	fix_32mb_dos_psize
  1860                                  
  1861 000009B4 01C8                    	add	ax, cx
  1862 000009B6 11DA                    	adc	dx, bx
  1863                                  
  1864                                  	; Convert LBA sector address to CHS parameters
  1865 000009B8 83E801                  	sub	ax, 1 ; locate on to end sector of the partition
  1866 000009BB 83DA00                  	sbb	dx, 0
  1867                                  	
  1868                                  	; 06/03/2019
  1869 000009BE 803E[3272]59            	cmp	byte [cylinder_boundary],'Y'
  1870                                  	;jne	short cpp_15
  1871 000009C3 753A                    	jne	short cpp_14
  1872                                  
  1873 000009C5 89C1                    	mov	cx, ax
  1874 000009C7 A0[9840]                	mov	al, [heads]
  1875 000009CA F626[9640]              	mul	byte [sectors]
  1876 000009CE 89C7                    	mov	di, ax ; [heads]*[sectors]
  1877 000009D0 91                      	xchg	ax, cx
  1878                                  		; cx = heads*spt
  1879 000009D1 E86204                  	call	div32
  1880                                  		; dx = 0
  1881                                  		; ax = end cylinder
  1882                                  		; bx = remainder
  1883                                  	;and	bx, bx
  1884                                  	;jz	short cpp_13
  1885                                  	;inc	ax
  1886                                  ;cpp_13:
  1887                                  	;cmp	ax, [cylinders]
  1888                                  	;jb	short cpp_14
  1889                                  	;dec	ax
  1890                                  ;cpp_14:
  1891 000009D4 8B1E[9840]              	mov	bx, [heads]
  1892 000009D8 FECB                    	dec	bl
  1893 000009DA 885C05                  	mov	[si+ptEndHead], bl
  1894 000009DD 8B0E[9640]              	mov	cx, [sectors]
  1895 000009E1 88E2                    	mov	dl, ah
  1896 000009E3 C0E206                  	shl	dl, 6
  1897 000009E6 08CA                    	or	dl, cl
  1898 000009E8 885406                  	mov	[si+ptEndSector], dl
  1899 000009EB 884407                  	mov	[si+ptEndCylinder], al	
  1900                                  	;mul	di ; [cylinders]*[heads]*[sectors]
  1901                                  	;;sub	di, cx ; ([heads] - 1) * [sectors]
  1902                                  	;add	ax, di
  1903                                  	;adc	dx, 0
  1904                                  	;;add	ax, cx
  1905                                  	;;adc	dx, 0
  1906 000009EE 40                      	inc	ax
  1907 000009EF F7E7                    	mul	di  ; result = start LBA of next cylinder
  1908                                  	; dx:ax = end sector LBA + 1 (as cyl. boundary aligned)
  1909 000009F1 2B06[986E]              	sub	ax, [pp_StartSector]
  1910 000009F5 1B16[9A6E]              	sbb	dx, [pp_StartSector+2] ; 26/10/2020
  1911                                  
  1912 000009F9 89C1                    	mov	cx, ax
  1913 000009FB 89D3                    	mov	bx, dx
  1914                                  	;jmp	short cpp_16
  1915 000009FD EB27                    	jmp	short cpp_15
  1916                                  ;cpp_15:
  1917                                  cpp_14:
  1918 000009FF 8B0E[9640]              	mov	cx, [sectors]
  1919 00000A03 E83004                  	call	div32
  1920                                  	; BX = Sector number - 1
  1921 00000A06 FEC3                    	inc	bl ; sector number (1 based)
  1922 00000A08 885C06                  	mov	[si+ptEndSector], bl	
  1923                                  	; DX_AX = cylinders * heads + head
  1924 00000A0B 8B0E[9840]              	mov	cx, [heads]
  1925 00000A0F E82404                  	call	div32
  1926                                  	; BX = Head number
  1927 00000A12 885C05                  	mov	[si+ptEndHead], bl
  1928                                  	; AX = Cylinder number
  1929                                  	;and	ax, 1023
  1930 00000A15 884407                  	mov	[si+ptEndCylinder], al
  1931                                  	; 18/02/2019
  1932 00000A18 C0E406                  	shl	ah, 6
  1933 00000A1B 086406                  	or	[si+ptEndSector], ah
  1934                                  
  1935 00000A1E 8B0E[CC6E]              	mov	cx, [ppn_Sectors]
  1936 00000A22 8B1E[CE6E]              	mov	bx, [ppn_Sectors+2]
  1937                                  ;cpp_16:
  1938                                  cpp_15:
  1939 00000A26 894C0C                  	mov	[si+ptSectors], cx
  1940 00000A29 895C0E                  	mov	[si+ptSectors+2], bx
  1941                                  
  1942                                  	; set partition ID after checking DOS FAT limits
  1943 00000A2C E8CD00                  	call	set_partition_id
  1944                                  	; al = partition ID
  1945                                  
  1946 00000A2F A2[A16E]                	mov	[pp_type], al
  1947                                  
  1948 00000A32 884404                  	mov	[si+ptFileSystemID], al
  1949                                  
  1950 00000A35 C3                      	retn
  1951                                  
  1952                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1953                                  ; Decrease DOS partition size when it is (exact) 65536 sectors
  1954                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1955                                  ; 18/02/2019
  1956                                  
  1957                                  fix_32mb_dos_psize:	; call this if [wholedisk] = 0
  1958                                  
  1959                                  ; Purpose: 
  1960                                  ;	If a DOS partition's size is 65536 sectors
  1961                                  ;	MSDOS 3.3 can not use it. (FAT 16 partition ID = 06h)
  1962                                  ;	Decreasing partition size to 65535 sectors will ensure
  1963                                  ;	MSDOS 3.3 compatibility (FAT 16 partition ID will be 04h).
  1964                                  
  1965                                  	; INPUT:
  1966                                  	;    BX:CX = partition size in sectors
  1967                                  	;    [pp_type] = partition type dos, non-dos, user input
  1968                                  	;
  1969                                  	; OUTPUT:
  1970                                  	;    Partition size will be changed to 65535 sectors, if
  1971                                  	;    	- partition size is 65536 sectors and
  1972                                  	; 	- [pp_type] is 1 (DOS)
  1973                                  	;
  1974                                  	;    [ppn_Sectors] = 65535 (if it will be changed)
  1975                                  	;
  1976                                  	; (Modified registers: cx, bx) 
  1977                                  
  1978                                  	;mov	cx, [ppn_Sectors]
  1979                                  	;mov	bx, [ppn_Sectors+2]
  1980                                  
  1981 00000A36 803E[A16E]01            	cmp	byte [pp_type], 1 ;  DOS partition
  1982 00000A3B 7513                    	jne	short psfx_0  ; non-dos partition or user input
  1983                                  			      ; nothing to do !
  1984 00000A3D 09C9                    	or	cx, cx
  1985 00000A3F 750F                    	jnz	short psfx_0 ; <> 65536 sectors
  1986 00000A41 83FB01                  	cmp	bx, 1
  1987 00000A44 750A                    	jne	short psfx_0
  1988 00000A46 4B                      	dec	bx
  1989                                  	;mov	[wholedisk], bx ; 0
  1990 00000A47 49                      	dec	cx  ; bx:cx = 65535
  1991 00000A48 890E[CC6E]              	mov	[ppn_Sectors], cx
  1992 00000A4C 891E[CE6E]              	mov	[ppn_Sectors+2], bx
  1993                                  psfx_0:
  1994 00000A50 C3                      	retn
  1995                                  
  1996                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1997                                  ; Create extended dos partition
  1998                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1999                                  ; 16/02/2019 
  2000                                  ;	(This procedure must be called after 'find_part_free_space')
  2001                                  
  2002                                  create_extended_partition:
  2003                                  	; 15/02/2019
  2004                                  
  2005                                  	; INPUT:
  2006                                  	;	none 
  2007                                  	;  (CHS parameters and free space calculation result will be used.)
  2008                                  	;
  2009                                  	; OUTPUT:
  2010                                  	;	Partition table in MBR buffer will be updated.
  2011                                  	;
  2012                                  	; (Modified registers: ax, bx, cx, dx, si, di)
  2013                                  
  2014                                  	; Create extended dos partition, make partition table entry
  2015                                  	; (Extended partition will be created on cylinder bounds.)
  2016                                  
  2017                                  	; 16/02/2019
  2018 00000A51 E8F21E                  	call	get_first_free_pte
  2019                                  		 ; CX = First free PTE number, 0 to 3 
  2020                                  		 ;    (CX = 3 if there is not a free PTE, and CF = 1)
  2021                                  		 ;    ((But CF = 1 is not possible here because pcount < 4))
  2022                                   	 	 ; SI = PTE addres/offset in MBR buffer
  2023                                  
  2024                                  	;mov	si, MasterBootBuff+pTableOffset
  2025                                  	;shl	cl, 4 ; * 16
  2026                                  	;add	si, cx
  2027                                  	
  2028 00000A54 8B1E[3072]              	mov	bx, [c_fspc_offset]
  2029                                  	
  2030 00000A58 8B87[E071]              	mov	ax, [bx+free_space.start]
  2031 00000A5C 89C7                    	mov	di, ax
  2032                                  
  2033                                  	;mov	cx, 1
  2034 00000A5E B101                    	mov	cl, 1
  2035                                  
  2036                                  	;mov	byte [si+ptBootable], 0 ; not bootable/active partition
  2037 00000A60 882C                    	mov	[si], ch ; 0 ; not bootable/active partition
  2038 00000A62 886C01                  	mov	[si+ptBeginHead], ch ; Head 0 
  2039 00000A65 C0E406                  	shl	ah, 6
  2040 00000A68 08E1                    	or	cl, ah
  2041 00000A6A 884C02                  	mov	[si+ptBeginSector], cl ; Sector 1
  2042 00000A6D 884403                  	mov	[si+ptBeginCylinder], al
  2043                                  
  2044 00000A70 A0[9840]                	mov	al, [heads]
  2045 00000A73 F626[9640]              	mul	byte [sectors]
  2046                                  		; ax = heads*sectors
  2047 00000A77 F7E7                    	mul	di  ; AX * cylinder count before start cylinder
  2048                                  		; DX:AX = LBA of cylinder DI, head 0, sector 1 
  2049                                  
  2050 00000A79 894408                  	mov	[si+ptStartSector], ax
  2051 00000A7C 89540A                  	mov	[si+ptStartSector+2], dx
  2052                                  
  2053                                  	; This is not needed for extended partition.
  2054                                  	; 16/02/2019
  2055                                  	;mov	[pp_StartSector], ax
  2056                                  	;mov	[pp_StartSector+2], dx
  2057                                  
  2058                                  	; 16/02/2019
  2059 00000A7F 803E[A06E]00            	cmp	byte [wholedisk], 0
  2060 00000A84 772A                    	ja	short cep_2 ; all of free space will be used
  2061                                  			    ; ([bx+free_space.end] will be end cyl)
  2062                                  
  2063                                  	; calculate cylinder count (from partition size input)
  2064 00000A86 A0[9840]                	mov	al, [heads]
  2065 00000A89 F626[9640]              	mul	byte [sectors]
  2066 00000A8D 89C1                    	mov	cx, ax
  2067 00000A8F A1[CC6E]                	mov	ax, [ppn_Sectors]
  2068 00000A92 8B16[CE6E]              	mov	dx, [ppn_Sectors+2]
  2069 00000A96 E89D03                  	call	div32
  2070                                  		; ax = cylinders
  2071                                  		; bx = remainder
  2072 00000A99 21DB                    	and	bx, bx
  2073 00000A9B 7401                    	jz	short cep_1
  2074                                  
  2075 00000A9D 40                      	inc	ax  ; round up
  2076                                  cep_1:
  2077                                  	; 16/02/2019
  2078                                  	; DI  = extended partition's start cylinder
  2079 00000A9E 89C2                    	mov	dx, ax ; cylinder count
  2080 00000AA0 01FA                    	add	dx, di ; result is end cyl + 1
  2081 00000AA2 4A                      	dec	dx ; decrease number for current end cylinder
  2082 00000AA3 8B1E[3072]              	mov	bx, [c_fspc_offset]
  2083 00000AA7 3B97[E271]              	cmp	dx, [bx+free_space.end]
  2084 00000AAB 7607                    	jna	short cep_3
  2085                                  	; 24/10/2020
  2086                                  	;dec	ax ; decrease cylinder count down to the limit
  2087 00000AAD 4A                      	dec	dx ; decrease end cylinder down to the limit
  2088 00000AAE EB04                    	jmp	short cep_3
  2089                                  cep_2:
  2090 00000AB0 8B97[E271]              	mov	dx, [bx+free_space.end]
  2091                                  	; 24/10/2020
  2092                                  	;mov	ax, [bx+free_space.space]
  2093                                  cep_3:
  2094 00000AB4 8A2E[9840]              	mov	ch, [heads]
  2095 00000AB8 FECD                    	dec	ch 
  2096 00000ABA 8A0E[9640]              	mov	cl, [sectors]
  2097 00000ABE 886C05                  	mov	[si+ptEndHead], ch
  2098                                  	; 23/02/2019
  2099 00000AC1 88F3                    	mov	bl, dh
  2100 00000AC3 C0E306                  	shl	bl, 6
  2101 00000AC6 08CB                    	or	bl, cl
  2102                                  	;or	[si+ptEndSector], bl
  2103                                  	; 24/10/2020
  2104 00000AC8 885C06                  	mov	[si+ptEndSector], bl
  2105 00000ACB 885407                  	mov	[si+ptEndCylinder], dl
  2106                                  
  2107 00000ACE A0[9840]                	mov	al, [heads]
  2108                                  	;mul	byte [sectors]
  2109 00000AD1 F6E1                    	mul	cl
  2110                                  		; ax = heads*sectors
  2111 00000AD3 F7E2                    	mul	dx ; AX * cylinder count before end cylinder
  2112                                  		; DX:AX = LBA of cylinder DX, head 0, sector 1
  2113 00000AD5 52                      	push	dx
  2114 00000AD6 50                      	push	ax
  2115 00000AD7 88E8                    	mov	al, ch ; [heads] - 1
  2116 00000AD9 8B0E[9640]              	mov	cx, [sectors]  ; 63 or 17
  2117 00000ADD F6E1                    	mul	cl
  2118                                  		; ax = (heads-1)*sectors
  2119 00000ADF 5A                      	pop	dx
  2120 00000AE0 01D0                    	add	ax, dx
  2121 00000AE2 5A                      	pop	dx
  2122 00000AE3 83D200                  	adc	dx, 0
  2123                                  		; dx:ax = ((end cylinder)*heads)+(heads-1)*sectors
  2124 00000AE6 01C8                    	add	ax, cx
  2125 00000AE8 83D200                  	adc	dx, 0
  2126                                  	; dx:ax = (((end cylinder)*heads)+(heads-1)*sectors) + sectors
  2127                                  	; dx:ax = LBA of the partition's end sector + 1
  2128 00000AEB 2B4408                  	sub	ax, [si+ptStartSector]
  2129 00000AEE 1B540A                  	sbb	dx, [si+ptStartSector+2]
  2130                                  
  2131 00000AF1 89440C                  	mov	[si+ptSectors], ax
  2132 00000AF4 89540E                  	mov	[si+ptSectors+2], dx
  2133                                  
  2134                                  	;mov	[pp_type], al
  2135                                  
  2136 00000AF7 C6440405                	mov	byte [si+ptFileSystemID], 5
  2137                                  
  2138 00000AFB C3                      	retn
  2139                                  
  2140                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2141                                  ; Set DOS (and non-dos) partition ID according to partition size
  2142                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2143                                  ; 18/02/2019
  2144                                  
  2145                                  set_partition_id: 
  2146                                  	; 18/02/2019
  2147                                  	;mov	cx, [ppn_Sectors]
  2148                                  	;mov	bx, [ppn_Sectors+2]
  2149                                  
  2150 00000AFC A0[A16E]                	mov	al, [pp_type]
  2151                                  
  2152                                  	;cmp	byte [pp_type], 1
  2153 00000AFF 3C01                    	cmp	al, 1 ; primary DOS (FAT12, FAT16, FAT32)
  2154 00000B01 7519                    	jne	short spid_2
  2155                                  
  2156                                  	;mov	al, 1	; FAT12
  2157                                  
  2158 00000B03 09DB                    	or	bx, bx
  2159 00000B05 750A                    	jnz	short spid_1
  2160                                  
  2161 00000B07 81F9A87F                	cmp	cx, 32680
  2162 00000B0B 763A                    	jna	short spid_8	; FAT12 file system
  2163                                  
  2164 00000B0D B004                    	mov	al, 4	; FAT16 (< 32MB)
  2165                                  
  2166 00000B0F EB36                    	jmp	short spid_8	; FAT16 (CHS) file system
  2167                                  
  2168                                  spid_1:
  2169 00000B11 B00B                    	mov	al, 0Bh ; FAT32 (CHS)
  2170                                  
  2171 00000B13 83FB10                  	cmp	bx, 10h
  2172 00000B16 732F                    	jnb	short spid_8	; FAT32 (CHS) file system
  2173                                  
  2174 00000B18 B006                    	mov	al, 6	; FAT16 (>= 32MB)
  2175                                  
  2176 00000B1A EB2B                    	jmp	short spid_8	; FAT16 big (CHS) file system
  2177                                  
  2178                                  spid_2:
  2179                                  	;cmp	byte [pp_type], 2 ; Singlix FS
  2180 00000B1C 3C02                    	cmp	al, 2
  2181 00000B1E 7504                    	jne	short spid_3
  2182 00000B20 B0A1                    	mov	al, 0A1h
  2183 00000B22 EB23                    	jmp	short spid_8
  2184                                  spid_3:
  2185                                  	;cmp	byte [pp_type], 3 ; Retro Unix FS
  2186 00000B24 3C03                    	cmp	al, 3
  2187 00000B26 7504                    	jne	short spid_4
  2188 00000B28 B071                    	mov	al, 71h
  2189 00000B2A EB1B                    	jmp	short spid_8
  2190                                  
  2191                                  spid_4:
  2192                                  	; another partition type (user input)
  2193                                  	
  2194                                  	; [pp_type] = 4
  2195                                  
  2196 00000B2C A0[A26E]                	mov	al, [pp_type_user]
  2197                                  
  2198                                  	; Check FAT12 fs size validation
  2199                                  
  2200 00000B2F 3C01                    	cmp	al, 1 ; FAT12
  2201 00000B31 7715                    	ja	short spid_9
  2202                                  
  2203 00000B33 21DB                    	and	bx, bx
  2204 00000B35 750A                    	jnz	short spid_6
  2205                                  
  2206 00000B37 81F9A87F                	cmp	cx, 32680
  2207 00000B3B 760A                    	jna	short spid_8
  2208                                  spid_5:
  2209 00000B3D B004                    	mov	al, 4 ; FAT16 (<= 32MB)
  2210 00000B3F EB06                    	jmp	short spid_8
  2211                                  spid_6:
  2212                                  	;;cmp	bx, 10h	; 512MB (16*32MB)
  2213                                  	;cmp	bx, 40h ; 2GB (64*32MB)
  2214                                  	;jnb	short spid_7
  2215                                  	
  2216 00000B41 B006                    	mov	al, 6
  2217 00000B43 EB02                    	jmp	short spid_8
  2218                                  spid_7:
  2219 00000B45 B00B                    	mov	al, 0Bh ; FAT32 (CHS) partition
  2220                                  spid_8:
  2221 00000B47 C3                      	retn
  2222                                  spid_9:
  2223 00000B48 3C04                    	cmp	al, 4 ; FAT16 (< 32 MB)
  2224 00000B4A 7505                    	jne	short spid_10
  2225                                  
  2226 00000B4C 09DB                    	or	bx, bx
  2227 00000B4E 75F1                    	jnz	short spid_6
  2228                                  	
  2229 00000B50 C3                      	retn	; FAT16 (< 32 MB) partition
  2230                                  spid_10:
  2231 00000B51 3C06                    	cmp	al, 6 ; FAT 16 big partition
  2232 00000B53 750E                    	jne	short spid_13 ; Extended partition or another type
  2233                                  	
  2234 00000B55 21DB                    	and	bx, bx
  2235 00000B57 7401                    	jz	short spid_11
  2236                                  
  2237                                  	;;cmp	bx, 10h	; 512MB (16*32MB)
  2238                                  	;cmp	bx, 40h ; 2GB (64*32MB)
  2239                                  	;jnb	short spid_7
  2240                                  	
  2241 00000B59 C3                      	retn
  2242                                  spid_11:
  2243                                  	;cmp	ax, 4150 ; 4085 + 32 + 32 + 1
  2244 00000B5A 81F93610                	cmp	cx, 4150 ; 14/09/2020 (BugFix)
  2245 00000B5E 73DD                    	jnb	short spid_5
  2246                                  spid_12:
  2247 00000B60 B001                    	mov	al, 1 ;  FAT12 partition
  2248 00000B62 C3                      	retn
  2249                                  spid_13:
  2250                                  	; 14/09/2020
  2251 00000B63 3C0B                    	cmp	al, 0Bh ; FAT 32 (CHS) partition
  2252 00000B65 7419                    	je	short spid_15 ; FAT 32 CHS
  2253 00000B67 3C0C                    	cmp	al, 0Ch	 
  2254 00000B69 750C                    	jne	short spid_14
  2255                                  	; FAT 32 LBA
  2256 00000B6B 21DB                    	and	bx, bx	; < 33 MB
  2257 00000B6D 74EB                    	jz	short spid_11 ; force to FAT 16 CHS or FAT 12
  2258 00000B6F 83FB10                  	cmp	bx, 10h ; 512 MB
  2259 00000B72 73D3                    	jnb	short spid_8  ; OK, FAT 32 LBA has been confirmed
  2260 00000B74 B00E                    	mov	al, 0Eh ; force to FAT 16 LBA
  2261 00000B76 C3                      	retn
  2262                                  spid_14:
  2263                                  	; 14/09/2020
  2264 00000B77 3C0E                    	cmp	al, 0Eh
  2265 00000B79 75CC                    	jne	short spid_8 ; non-dos or extended partition
  2266                                  	; FAT 16 LBA
  2267 00000B7B 09DB                    	or	bx, bx
  2268 00000B7D 74DB                    	jz	short spid_11
  2269                                  	;cmp	bx, 20h ; 1 GB
  2270                                  	;jb	short spid_8
  2271                                  	;mov	al, 0Ch	; FAT 32 LBA
  2272 00000B7F C3                      	retn
  2273                                  spid_15:
  2274                                  	; Minimum size of FAT 32 FS = 65525 + 512 + 512 + 32
  2275                                   	; >= 66581 sectors (or >= 65525 data clusters)
  2276 00000B80 83FB01                  	cmp	bx, 1
  2277 00000B83 72D5                    	jb	short spid_11  ; invalid! (< 33 MB)
  2278 00000B85 77C0                    	ja	short spid_8
  2279 00000B87 81F91504                	cmp	cx, 1045
  2280 00000B8B 7201                    	jb	short spid_16  ; invalid! (< 33 MB)
  2281 00000B8D C3                      	retn
  2282                                  spid_16:
  2283 00000B8E B006                    	mov	al, 6
  2284 00000B90 C3                      	retn
  2285                                  
  2286                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2287                                  ; Set disk size before creating hd image file
  2288                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2289                                  
  2290                                  new_image:
  2291                                  	; 07/03/2019
  2292 00000B91 B80300                  	mov	ax, 3 ; set video mode to 3 (clear video page)
  2293 00000B94 CD10                    	int	10h
  2294                                  B_05:
  2295                                  	;mov	byte [existingfile], 0 ; 12/02/2019
  2296 00000B96 E8E413                  	call	display_chs_table
  2297                                  B_06:
  2298 00000B99 30E4                    	xor	ah, ah
  2299 00000B9B CD16                    	int	16h
  2300 00000B9D 3C61                    	cmp	al, 'a'
  2301 00000B9F 7206                    	jb	short B_07
  2302 00000BA1 3C7A                    	cmp	al, 'z'
  2303 00000BA3 7702                    	ja	short B_07
  2304 00000BA5 24DF                    	and	al, 0DFh
  2305                                  B_07:
  2306 00000BA7 3C43                    	cmp	al, 'C'
  2307 00000BA9 752C                    	jne	short B_12
  2308                                  B_08:
  2309 00000BAB 833E[9A40]00            	cmp	word [cylinders], 0
  2310 00000BB0 7706                    	ja	short B_09
  2311 00000BB2 C706[9A40]0004          	mov	word [cylinders], 1024
  2312                                  B_09:
  2313 00000BB8 833E[9840]00            	cmp	word [heads], 0
  2314 00000BBD 7706                    	ja	short B_10
  2315 00000BBF C706[9840]1000          	mov	word [heads], 16
  2316                                  B_10:
  2317 00000BC5 833E[9640]00            	cmp	word [sectors], 0
  2318 00000BCA 7706                    	ja	short B_11
  2319 00000BCC C706[9640]3F00          	mov	word [sectors], 63
  2320                                  B_11:
  2321 00000BD2 A2[A36E]                	mov	byte [chs_focus], al
  2322 00000BD5 EBBF                    	jmp	short B_05
  2323                                  B_12:
  2324 00000BD7 3C48                    	cmp	al, 'H'
  2325 00000BD9 74D0                    	je	short B_08
  2326 00000BDB 3C53                    	cmp	al, 'S'
  2327 00000BDD 74CC                    	je	short B_08
  2328 00000BDF 3C1B                    	cmp	al, 27 ; ESC key
  2329 00000BE1 0F848D00                	je	B_18	
  2330 00000BE5 3C0D                    	cmp	al, 13 ; ENTER key
  2331 00000BE7 0F85EF00                	jne	B_21
  2332                                  
  2333 00000BEB 833E[9640]3F            	cmp	word [sectors], 63
  2334 00000BF0 730D                    	jnb	short B_13
  2335 00000BF2 833E[9840]10            	cmp	word [heads], 16
  2336 00000BF7 7606                    	jna	short B_13
  2337 00000BF9 C706[9840]1000          	mov	word [heads], 16
  2338                                  B_13:
  2339 00000BFF A1[9640]                	mov	ax, [sectors]
  2340 00000C02 F726[9840]              	mul	word [heads]
  2341 00000C06 A3[C66E]                	mov	[min_sectors], ax  ; 08/02/2019
  2342 00000C09 8B16[9A40]              	mov	dx, [cylinders]
  2343 00000C0D F7E2                    	mul	dx
  2344 00000C0F A3[8C6E]                	mov	[total_sectors], ax
  2345 00000C12 8916[8E6E]              	mov	[total_sectors+2], dx
  2346                                  
  2347                                  	; 05/02/2019
  2348 00000C16 BF[7F56]                	mov	di, str_disk_sectors
  2349                                  
  2350 00000C19 89E5                    	mov	bp, sp
  2351 00000C1B B90A00                  	mov	cx, 10
  2352                                  B_14:
  2353 00000C1E E81502                  	call	div32
  2354                                  	
  2355 00000C21 80C330                  	add	bl, '0'
  2356 00000C24 53                      	push	bx
  2357 00000C25 21C0                    	and	ax, ax
  2358 00000C27 75F5                    	jnz	short B_14
  2359 00000C29 21D2                    	and	dx, dx
  2360 00000C2B 75F1                    	jnz	short B_14
  2361                                  
  2362 00000C2D 29E5                    	sub	bp, sp
  2363 00000C2F D1ED                    	shr	bp, 1
  2364                                  B_15:
  2365 00000C31 58                      	pop	ax
  2366 00000C32 AA                      	stosb
  2367 00000C33 4D                      	dec	bp
  2368 00000C34 75FB                    	jnz	short B_15
  2369                                  
  2370 00000C36 30C0                    	xor	al, al
  2371 00000C38 AA                      	stosb
  2372                                  
  2373 00000C39 A1[8C6E]                	mov	ax, [total_sectors]
  2374 00000C3C 8B16[8E6E]              	mov	dx, [total_sectors+2]
  2375 00000C40 B90002                  	mov	cx, 512
  2376 00000C43 E8FE01                  	call	mul32
  2377 00000C46 A3[946E]                	mov	[file_size], ax
  2378 00000C49 8916[966E]              	mov	[file_size+2], dx
  2379                                  	
  2380 00000C4D BF[C256]                	mov	di, str_file_size
  2381                                  
  2382 00000C50 89E5                    	mov	bp, sp
  2383 00000C52 B90A00                  	mov	cx, 10
  2384                                  B_16:
  2385 00000C55 E8DE01                  	call	div32
  2386                                  
  2387 00000C58 80C330                  	add	bl, '0'
  2388 00000C5B 53                      	push	bx
  2389 00000C5C 21C0                    	and	ax, ax
  2390 00000C5E 75F5                    	jnz	short B_16
  2391 00000C60 21D2                    	and	dx, dx
  2392 00000C62 75F1                    	jnz	short B_16
  2393                                  
  2394 00000C64 29E5                    	sub	bp, sp
  2395 00000C66 D1ED                    	shr	bp, 1
  2396                                  B_17:
  2397 00000C68 58                      	pop	ax
  2398 00000C69 AA                      	stosb
  2399 00000C6A 4D                      	dec	bp
  2400 00000C6B 75FB                    	jnz	short B_17
  2401                                  
  2402 00000C6D 30C0                    	xor	al, al
  2403 00000C6F AA                      	stosb
  2404                                  
  2405 00000C70 B00D                    	mov	al, 13 ; ENTER (Carriage Return) key
  2406                                  B_18:
  2407 00000C72 50                      	push	ax
  2408                                  
  2409 00000C73 C606[A36E]00            	mov	byte [chs_focus], 0
  2410 00000C78 E80213                  	call	display_chs_table
  2411                                  
  2412 00000C7B 58                      	pop	ax
  2413                                  
  2414 00000C7C 3C0D                    	cmp	al, 13 ; CR ?
  2415 00000C7E 7402                    	je	short B_20 ; print total sectors and file size..
  2416                                  B_19:
  2417 00000C80 CD20                    	int	20h
  2418                                  B_20:
  2419 00000C82 BE[6956]                	mov	si, msg_disk_sectors
  2420 00000C85 E8AD11                  	call	print_msg
  2421 00000C88 BE[7F56]                	mov	si, str_disk_sectors
  2422 00000C8B E8A711                  	call	print_msg
  2423 00000C8E BE[5356]                	mov	si, CRLF
  2424 00000C91 E8A111                  	call	print_msg
  2425 00000C94 BE[AC56]                	mov	si, msg_file_size
  2426 00000C97 E89B11                  	call	print_msg
  2427 00000C9A BE[C256]                	mov	si, str_file_size
  2428 00000C9D E89511                  	call	print_msg
  2429 00000CA0 BE[CD56]                	mov	si, msg_bytes
  2430 00000CA3 E88F11                  	call	print_msg
  2431 00000CA6 BE[D656]                	mov	si, msg_enter_cancel
  2432 00000CA9 E88911                  	call	print_msg
  2433 00000CAC 30E4                    	xor	ah, ah
  2434 00000CAE CD16                    	int	16h
  2435 00000CB0 3C1B                    	cmp	al, 1Bh ; ESC key
  2436 00000CB2 74CC                    	je	short B_19
  2437 00000CB4 3C0D                    	cmp	al, 0Dh ; Enter key
  2438 00000CB6 0F85DCFE                	jne	B_05
  2439                                  
  2440 00000CBA 833E[8E6E]00            	cmp	word [total_sectors+2], 0
  2441 00000CBF 0F879501                	ja	B_42
  2442                                  
  2443 00000CC3 813E[8C6E]003F          	cmp	word [total_sectors], 16128  ; 63*16*16
  2444 00000CC9 0F838B01                	jnb	B_42
  2445                                  
  2446 00000CCD BE[B245]                	mov	si, msg_min_8mb_disk
  2447 00000CD0 E86211                  	call	print_msg
  2448                                  
  2449 00000CD3 30E4                    	xor	ah, ah
  2450 00000CD5 CD16                    	int	16h
  2451                                  
  2452 00000CD7 E9BCFE                  	jmp	B_05
  2453                                  	
  2454                                  B_21:
  2455 00000CDA 3C20                    	cmp	al, 20h
  2456 00000CDC 745A                    	je	short B_25
  2457 00000CDE 3C2D                    	cmp	al, '-'
  2458 00000CE0 0F84E200                	je	B_34
  2459 00000CE4 3C2B                    	cmp	al, '+'
  2460 00000CE6 7450                    	je	short B_25
  2461 00000CE8 80FC51                  	cmp	ah, 51h ; Pg Down
  2462 00000CEB 7416                    	je	short B_23
  2463 00000CED 80FC49                  	cmp	ah, 49h ; Pg Up
  2464 00000CF0 742F                    	je	short B_24  
  2465                                  B_22:
  2466 00000CF2 803E[A36E]00            	cmp	byte [chs_focus], 0
  2467 00000CF7 0F869EFE                	jna	B_06
  2468 00000CFB C606[A36E]00            	mov	byte [chs_focus], 0
  2469 00000D00 E993FE                  	jmp	B_05
  2470                                  B_23:
  2471 00000D03 803E[A36E]43            	cmp	byte [chs_focus], 'C'
  2472                                  	;jne	short B_22
  2473 00000D08 0F85BA00                	jne	B_34 ; 10/02/2019
  2474 00000D0C 832E[9A40]10            	sub	word [cylinders], 16
  2475 00000D11 0F82C500                	jc	B_35
  2476 00000D15 833E[9A40]10            	cmp	word [cylinders], 16
  2477 00000D1A 0F82BC00                	jb	B_35
  2478 00000D1E E975FE                  	jmp	B_05
  2479                                  B_24:
  2480 00000D21 803E[A36E]43            	cmp	byte [chs_focus], 'C'
  2481                                  	;jne	short B_22
  2482 00000D26 752E                    	jne	short B_27 ; 10/02/2019
  2483 00000D28 8306[9A40]10            	add	word [cylinders], 16
  2484 00000D2D 813E[9A40]0004          	cmp	word [cylinders], 1024
  2485 00000D33 7718                    	ja	short B_26
  2486 00000D35 E95EFE                  	jmp	B_05
  2487                                  B_25:
  2488 00000D38 803E[A36E]43            	cmp	byte [chs_focus], 'C'
  2489 00000D3D 7517                    	jne	short B_27
  2490 00000D3F FF06[9A40]              	inc	word [cylinders]
  2491 00000D43 813E[9A40]0004          	cmp	word [cylinders], 1024
  2492 00000D49 0F8649FE                	jna	B_05
  2493                                  B_26:
  2494 00000D4D C706[9A40]1000          	mov	word [cylinders], 16 ; minimum cylinders
  2495 00000D53 E940FE                  	jmp	B_05
  2496                                  B_27:
  2497 00000D56 803E[A36E]48            	cmp	byte [chs_focus], 'H'
  2498 00000D5B 7547                    	jne	short B_32
  2499 00000D5D 833E[9840]10            	cmp	word [heads], 16
  2500 00000D62 7307                    	jnb	short B_28
  2501 00000D64 FF06[9840]              	inc	word [heads]
  2502 00000D68 E92BFE                  	jmp	B_05
  2503                                  B_28:
  2504 00000D6B 833E[9640]3F            	cmp	word [sectors], 63
  2505 00000D70 7212                    	jb	short B_29
  2506 00000D72 833E[9840]20            	cmp	word [heads], 32
  2507 00000D77 7722                    	ja	short B_31
  2508 00000D79 7217                    	jb	short B_30
  2509 00000D7B C706[9840]4000          	mov	word [heads], 64
  2510 00000D81 E912FE                  	jmp	B_05
  2511                                  B_29:
  2512 00000D84 833E[9840]10            	cmp	word [heads], 16
  2513 00000D89 7310                    	jnb	short B_31
  2514 00000D8B FF06[9840]              	inc	word [heads]
  2515 00000D8F E904FE                  	jmp	B_05
  2516                                  B_30:
  2517 00000D92 C706[9840]2000          	mov	word [heads], 32
  2518 00000D98 E9FBFD                  	jmp	B_05
  2519                                  B_31:
  2520 00000D9B C706[9840]0200          	mov	word [heads], 2
  2521 00000DA1 E9F2FD                  	jmp	B_05
  2522                                  B_32:
  2523 00000DA4 803E[A36E]53            	cmp	byte [chs_focus], 'S'
  2524 00000DA9 0F85E9FD                	jne	B_05
  2525 00000DAD 833E[9640]3F            	cmp	word [sectors], 63
  2526 00000DB2 7509                    	jne	short B_33
  2527 00000DB4 C706[9640]1100          	mov	word [sectors], 17
  2528 00000DBA E9D9FD                  	jmp	B_05
  2529                                  B_33:
  2530 00000DBD C706[9640]3F00          	mov	word [sectors], 63
  2531 00000DC3 E9D0FD                  	jmp	B_05
  2532                                  B_34:
  2533 00000DC6 803E[A36E]43            	cmp	byte [chs_focus], 'C'
  2534 00000DCB 7516                    	jne	short B_36
  2535 00000DCD FF0E[9A40]              	dec	word [cylinders]
  2536 00000DD1 833E[9A40]10            	cmp	word [cylinders], 16
  2537 00000DD6 0F83BCFD                	jnb	B_05
  2538                                  B_35:
  2539 00000DDA C706[9A40]0004          	mov	word [cylinders], 1024
  2540 00000DE0 E9B3FD                  	jmp	B_05
  2541                                  B_36:
  2542 00000DE3 803E[A36E]48            	cmp	byte [chs_focus], 'H'
  2543 00000DE8 75BA                    	jne	short B_32
  2544                                  
  2545 00000DEA 833E[9640]3F            	cmp	word [sectors], 63
  2546 00000DEF 721E                    	jb	short B_38
  2547                                  
  2548 00000DF1 833E[9840]02            	cmp	word [heads], 2
  2549 00000DF6 760E                    	jna	short B_37
  2550 00000DF8 833E[9840]10            	cmp	word [heads], 16
  2551 00000DFD 771E                    	ja	short B_39
  2552 00000DFF FF0E[9840]              	dec	word [heads]
  2553 00000E03 E990FD                  	jmp	B_05
  2554                                  B_37:
  2555 00000E06 C706[9840]4000          	mov	word [heads], 64
  2556 00000E0C E987FD                  	jmp	B_05
  2557                                  B_38:
  2558 00000E0F 833E[9840]02            	cmp	word [heads], 2
  2559 00000E14 760E                    	jna	short B_40
  2560 00000E16 FF0E[9840]              	dec	word [heads]
  2561 00000E1A E979FD                  	jmp	B_05
  2562                                  B_39:
  2563 00000E1D 833E[9840]20            	cmp	word [heads], 32
  2564 00000E22 7709                    	ja	short B_41
  2565                                  B_40:
  2566 00000E24 C706[9840]1000          	mov	word [heads], 16
  2567 00000E2A E969FD                  	jmp	B_05
  2568                                  B_41:
  2569 00000E2D C706[9840]2000          	mov	word [heads], 32
  2570 00000E33 E960FD                  	jmp	B_05
  2571                                  
  2572                                  ;-----------------------------------------------------------------------------
  2573                                  
  2574                                  div32:
  2575                                  	; DX_AX/CX
  2576                                  	; Result: DX_AX, BX (remainder)
  2577 00000E36 89C3                    	mov	bx, ax
  2578                                  	;or	dx, ax ; * DX_AX = 0 ?
  2579                                  	;jz	short div32_retn ; yes, do not divide!
  2580 00000E38 89D0                    	mov	ax, dx
  2581 00000E3A 31D2                            xor	dx, dx
  2582 00000E3C F7F1                            div	cx	; at first, divide DX
  2583                                  			; remainder is in DX 
  2584 00000E3E 93                      	xchg	ax, bx	; now quotient is in BX
  2585                                    			; and initial AX value is in AX
  2586 00000E3F F7F1                    	div	cx	; now, DX_AX has been divided and
  2587                                  			; AX has quotient
  2588                                  			; DX has remainder
  2589 00000E41 87D3                    	xchg	dx, bx	; finally, BX has remainder
  2590                                  ;div32_retn:
  2591 00000E43 C3                              retn
  2592                                  
  2593                                  ;-----------------------------------------------------------------------------
  2594                                  
  2595                                  mul32:
  2596                                  	; DX_AX*CX
  2597                                  	; Result: BX_DX_AX
  2598 00000E44 51                      	push	cx
  2599 00000E45 89D3                    	mov	bx, dx
  2600 00000E47 F7E1                    	mul	cx
  2601 00000E49 93                       	xchg	ax, bx
  2602 00000E4A 52                      	push	dx
  2603 00000E4B F7E1                    	mul	cx 
  2604 00000E4D 59                      	pop	cx 
  2605 00000E4E 01C8                    	add	ax, cx
  2606 00000E50 83D200                  	adc	dx, 0
  2607 00000E53 93                      	xchg	bx, ax
  2608 00000E54 87D3                    	xchg	dx, bx
  2609 00000E56 59                      	pop	cx
  2610 00000E57 C3                      	retn
  2611                                  
  2612                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2613                                  ; Create a new hard disk image file
  2614                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2615                                  
  2616                                  B_42:
  2617 00000E58 BA[8559]                	mov	dx, img_file_name
  2618 00000E5B B90000                  	mov	cx, 0 ; File Attributes
  2619 00000E5E B43C                    	mov	ah, 3Ch ; MS-DOS Function = Create File
  2620 00000E60 CD21                    	int	21h
  2621 00000E62 0F8222F2                	jc	A_10
  2622                                  
  2623 00000E66 BE[5356]                	mov	si, CRLF
  2624 00000E69 E8C90F                  	call	print_msg
  2625                                  
  2626                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2627                                  ; Open image file for writing
  2628                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2629                                  
  2630 00000E6C B002                    	mov	al, 2 ; open for reading and writing
  2631                                  	;mov	dx, img_file_name
  2632 00000E6E B43D                    	mov	ah, 3Dh ; open file
  2633 00000E70 CD21                    	int	21h
  2634 00000E72 0F82A90F                	jc	D_02
  2635                                  
  2636 00000E76 A3[9440]                	mov	[img_file_handle], ax
  2637                                  
  2638 00000E79 BE[0755]                	mov	si, msg_writing_mbr
  2639 00000E7C E8B60F                  	call	print_msg
  2640                                  
  2641                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2642                                  ; Writing/Saving CHS parameters into (Singlix FS1) MBR
  2643                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2644                                  ; Note: Partition Table will be left empty at this stage
  2645                                  
  2646                                  	;cmp	word [TRDOS386_MASTERBOOT_SECTOR+417], 417
  2647                                  	;jne	short B_43
  2648                                  
  2649 00000E7F 8B0E[9A40]              	mov	cx, [cylinders]
  2650 00000E83 890E[2634]              	mov	[TRDOS386_MASTERBOOT_SECTOR+420], cx ; pt_cylinders
  2651 00000E87 8B0E[9840]              	mov	cx, [heads]
  2652 00000E8B 890E[2834]              	mov	[TRDOS386_MASTERBOOT_SECTOR+422], cx ; pt_heads
  2653 00000E8F 8B0E[9640]              	mov	cx, [sectors]
  2654 00000E93 890E[2A34]              	mov	[TRDOS386_MASTERBOOT_SECTOR+424], cx ; pt_sectors
  2655                                  
  2656                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2657                                  ; writing masterboot sector
  2658                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2659                                  
  2660                                  B_43:
  2661 00000E97 8B1E[9440]              	mov	bx, [img_file_handle]
  2662 00000E9B BA[8232]                	mov	dx, TRDOS386_MASTERBOOT_SECTOR ; Singlix FS1 MBR
  2663 00000E9E B90002                  	mov	cx, 512
  2664 00000EA1 B440                    	mov	ah, 40h ; write to file	
  2665 00000EA3 CD21                    	int	21h
  2666 00000EA5 0F826C0F                	jc	D_01
  2667                                  
  2668 00000EA9 BE[4F56]                	mov	si, Msg_OK
  2669 00000EAC E8860F                  	call	print_msg
  2670                                  
  2671 00000EAF BE[2455]                	mov	si, msg_writing_disk_sectors
  2672 00000EB2 E8800F                  	call	print_msg
  2673 00000EB5 B403                    	mov	ah, 3
  2674 00000EB7 BB0700                  	mov	bx, 7
  2675 00000EBA CD10                    	int	10h ; Return Cursor Position
  2676                                  	; DL = Column, DH = Line
  2677 00000EBC 8916[9755]              	mov	[Cursor_Pos], dx
  2678                                  
  2679                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2680                                  ; writing disk sectors (with F6h -format- bytes)
  2681                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2682                                  
  2683 00000EC0 31D2                    	xor	dx, dx
  2684 00000EC2 B80100                  	mov	ax, 1
  2685                                  
  2686                                  	; 63 (17) sectors (after MBR) will be filled with ZERO 
  2687                                  B_44:
  2688 00000EC5 52                      	push	dx
  2689 00000EC6 50                      	push	ax
  2690 00000EC7 BE[9555]                	mov	si, Sector_Str + 6
  2691 00000ECA E8F00F                  	call	bin_to_decimal
  2692 00000ECD 8B16[9755]              	mov	dx, [Cursor_Pos]
  2693 00000ED1 BB0700                  	mov	bx, 7
  2694 00000ED4 B402                    	mov	ah, 2
  2695 00000ED6 CD10                    	int	10h  ; Set Cursor Position
  2696 00000ED8 E85A0F                  	call	print_msg
  2697 00000EDB 58                      	pop	ax
  2698 00000EDC 5A                      	pop	dx
  2699 00000EDD BB[106A]                	mov	bx, HDFORMAT_FATBUFFER ; Empty Sector
  2700 00000EE0 E8610F                  	call	write_hd_sector
  2701 00000EE3 0F822E0F                	jc	D_01
  2702                                  	;inc	ax
  2703 00000EE7 FEC0                    	inc	al
  2704 00000EE9 3B06[9640]              	cmp	ax, [sectors] ; 63 or 17
  2705 00000EED 76D6                    	jna	short B_44
  2706                                  
  2707                                  	; writing other sectors upto [total sectors] - 1
  2708                                  B_45:
  2709 00000EEF 52                      	push	dx
  2710 00000EF0 50                      	push	ax
  2711 00000EF1 BE[9555]                	mov	si, Sector_Str + 6
  2712 00000EF4 E8C60F                  	call	bin_to_decimal
  2713 00000EF7 8B16[9755]              	mov	dx, [Cursor_Pos]
  2714 00000EFB BB0700                  	mov	bx, 7
  2715 00000EFE B402                    	mov	ah, 2
  2716 00000F00 CD10                    	int	10h  ; Set Cursor Position
  2717 00000F02 E8300F                  	call	print_msg
  2718 00000F05 58                      	pop	ax
  2719 00000F06 5A                      	pop	dx
  2720 00000F07 BB[0E66]                	mov	bx, HDFORMAT_SECBUFFER ; F6h filled sectors
  2721 00000F0A E8370F                  	call	write_hd_sector
  2722 00000F0D 0F82040F                	jc	D_01
  2723 00000F11 83C001                  	add	ax, 1
  2724 00000F14 83D200                  	adc	dx, 0
  2725 00000F17 3B16[8E6E]              	cmp	dx, [total_sectors+2]
  2726 00000F1B 72D2                    	jb	short B_45
  2727 00000F1D 7706                    	ja	short B_46
  2728 00000F1F 3B06[8C6E]              	cmp	ax, [total_sectors]
  2729 00000F23 72CA                    	jb	short B_45
  2730                                  B_46:
  2731 00000F25 BE[4C56]                	mov	si, Msg_3dot_OK
  2732 00000F28 E80A0F                  	call	print_msg
  2733                                  
  2734 00000F2B BE[1546]                	mov	si, msg_any_key_esc_exit
  2735 00000F2E E8040F                  	call	print_msg
  2736                                  	
  2737 00000F31 30E4                    	xor	ah, ah
  2738 00000F33 CD16                    	int	16h
  2739                                  
  2740 00000F35 3C1B                    	cmp	al, 27 ; 1Bh, ESC key
  2741 00000F37 7508                    	jne	short B_48
  2742                                  B_47:
  2743 00000F39 BE[5356]                	mov	si, CRLF
  2744 00000F3C E8F60E                  	call	print_msg
  2745                                  	
  2746 00000F3F CD20                    	int	20h
  2747                                  B_48:
  2748 00000F41 FE06[9C40]              	inc	byte [random] ; next r/w is not sequental
  2749 00000F45 FE06[9D40]              	inc	byte [newdisk] ; will be used by partitioning
  2750                                  
  2751                                  	; 11/02/2019
  2752                                  	; Copy Singlix FS (TRDOS 386) MBR to MasterBoot buffer
  2753 00000F49 B90001                  	mov	cx, 256
  2754 00000F4C BE[8232]                	mov	si, TRDOS386_MASTERBOOT_SECTOR ; Singlix FS1 MBR
  2755 00000F4F BF[2C57]                	mov	di, MasterBootBuff
  2756 00000F52 F3A5                    	rep	movsw
  2757                                  
  2758                                  	; 26/02/2019
  2759                                  	; Clear partition table structure
  2760                                  	; (for preventing wrong partition data display for new disk image)
  2761 00000F54 BF[4A71]                	mov	di, part_table_boot_ind
  2762 00000F57 31C0                    	xor	ax, ax
  2763 00000F59 B92400                  	mov	cx, 4*18/2
  2764 00000F5C F3AB                    	rep	stosw
  2765                                  
  2766                                  	; 08/03/2019
  2767                                  	; Clear pcount, epnumber values
  2768 00000F5E A3[9271]                	mov	[pcount], ax ; reset (pcount & ppcount)
  2769 00000F61 A3[9471]                	mov	[apcount], ax ; reset (apcount & epnumber)
  2770                                  B_49:
  2771                                  	; 06/03/2019
  2772 00000F64 C606[AE6E]4D            	mov	byte [pSize_unit], 'M' ; default (for 'whole' disk/space)
  2773                                  	; 15/02/2019
  2774 00000F69 E830F8                  	call	create_partition_input
  2775                                  B_50:
  2776 00000F6C 21C0                    	and	ax, ax
  2777                                  	;jz	short B_47 ; 0 = none or not a valid input
  2778 00000F6E 0F84A5F4                	jz	A_48 ; 25/02/2019
  2779                                  
  2780                                  	;or	ah, ah
  2781                                  	;jz	short B_51
  2782                                  
  2783                                  	; 23/02/2019
  2784 00000F72 80FC04                  	cmp	ah, 4  ; user's partition type input ?
  2785 00000F75 7505                    	jne	short B_51 ; no
  2786                                  
  2787                                  	; user type input
  2788 00000F77 A2[A26E]                	mov	[pp_type_user], al
  2789 00000F7A 88E0                    	mov	al, ah ; mov al, 4
  2790                                  B_51:
  2791 00000F7C A2[A16E]                	mov	[pp_type], al
  2792                                  
  2793                                  	; clear screen
  2794 00000F7F B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  2795 00000F82 CD10                    	int	10h
  2796                                  
  2797 00000F84 A0[A16E]                	mov	al, [pp_type]
  2798 00000F87 3C01                    	cmp	al, 1
  2799 00000F89 7705                    	ja	short B_52
  2800                                  
  2801 00000F8B BE[F848]                	mov	si,  msg_create_dos_partition_h ; header
  2802 00000F8E EB69                    	jmp	short B_57
  2803                                  B_52:
  2804 00000F90 3C05                    	cmp	al, 5
  2805 00000F92 7262                    	jb	short B_56
  2806                                  	;ja	short B_55
  2807 00000F94 7741                    	ja	short B_106 ; 26/10/2020
  2808                                  
  2809                                  	; 23/02/2019
  2810 00000F96 BE[ED49]                	mov	si, msg_create_ext_partition_h
  2811 00000F99 E8990E                  	call	print_msg
  2812                                  
  2813                                  	; 24/02/2019
  2814 00000F9C 803E[9571]00            	cmp	byte [epnumber], 0
  2815 00000FA1 7613                    	jna	short B_53
  2816                                  
  2817 00000FA3 BE[CF60]                	mov	si, msg_ext_partition_exists
  2818 00000FA6 E88C0E                  	call 	print_msg
  2819                                  
  2820 00000FA9 BE[0C57]                	mov	si, msg_press_any_key
  2821 00000FAC E8860E                  	call	print_msg
  2822                                  
  2823 00000FAF 30E4                    	xor	ah, ah
  2824 00000FB1 CD16                    	int	16h
  2825                                  
  2826                                  	;jmp	A_33
  2827 00000FB3 E961F4                  	jmp	A_48
  2828                                  B_53:
  2829 00000FB6 803E[9371]00            	cmp	byte [ppcount], 0  ; primary partition count
  2830 00000FBB 773F                    	ja	short B_58
  2831                                  
  2832                                  	; 09/02/2019
  2833 00000FBD BE[7450]                	mov	si, msg_ext_partition_error
  2834 00000FC0 E8720E                  	call	print_msg
  2835                                  B_54:
  2836 00000FC3 BE[0C57]                	mov	si, msg_press_any_key
  2837 00000FC6 E86C0E                  	call	print_msg
  2838                                  
  2839 00000FC9 30E4                    	xor	ah, ah
  2840 00000FCB CD16                    	int	16h
  2841                                  
  2842 00000FCD C606[A16E]01            	mov	byte [pp_type], 1
  2843                                  
  2844 00000FD2 E8F2F7                  	call	cpi_2 ; 15/02/2019
  2845 00000FD5 EB95                    	jmp	B_50
  2846                                  B_106:
  2847                                  	; 26/10/2020
  2848 00000FD7 803E[9371]00            	cmp	byte [ppcount], 0  ; primary partition count
  2849 00000FDC 760A                    	jna	short B_55
  2850 00000FDE 803E[9571]00            	cmp	byte [epnumber], 0  
  2851                                  			; is there an extended partition ?
  2852 00000FE3 7603                    	jna	short B_55
  2853 00000FE5 E9B2F4                  	jmp	create_logical_drives
  2854                                  B_55:
  2855 00000FE8 BE[E24A]                	mov	si, msg_create_logical_drive_h
  2856 00000FEB E8470E                  	call	print_msg
  2857                                  
  2858 00000FEE BE[B350]                	mov	si, msg_logical_drive_error
  2859 00000FF1 E8410E                  	call	print_msg
  2860 00000FF4 EBCD                    	jmp	short B_54
  2861                                  
  2862                                  ;	mov	si, msg_use_entire_ep_space
  2863                                  ;	jmp	short B_60
  2864                                  
  2865                                  B_56:
  2866 00000FF6 BE[D74B]                	mov	si, msg_create_nondos_partition_h
  2867                                  B_57:
  2868 00000FF9 E8390E                  	call	print_msg
  2869                                  B_58:
  2870                                  	; 15/02/2019
  2871 00000FFC 803E[9D40]00            	cmp	byte [newdisk], 0
  2872 00001001 7705                    	ja	short B_59
  2873                                  
  2874 00001003 BE[0C4F]                	mov	si, msg_use_all_space
  2875 00001006 EB03                    	jmp	short B_60
  2876                                  B_59:
  2877 00001008 BE[E54E]                	mov	si, msg_use_whole_disk ; partition size: whole disk
  2878                                  B_60:
  2879 0000100B E8270E                  	call	print_msg
  2880                                  B_61:
  2881 0000100E 30E4                    	xor	ah, ah
  2882 00001010 CD16                    	int	16h
  2883                                  
  2884 00001012 3C1B                    	cmp	al, 27 ; ESCAPE key
  2885                                  	;;je	B_47
  2886                                  	;je	A_33
  2887 00001014 0F84FFF3                	je	A_48 ; 25/02/2019
  2888 00001018 24DF                    	and	al, 0DFh
  2889 0000101A 3C4E                    	cmp	al, 'N'
  2890 0000101C 740D                    	je	short B_62  ;02/03/2019
  2891 0000101E 3C59                    	cmp	al, 'Y'
  2892 00001020 75EC                    	jne	short B_61
  2893                                  	
  2894 00001022 FE06[A06E]              	inc	byte [wholedisk]
  2895                                  	
  2896                                  	; 02/03/2019
  2897 00001026 BE[F65D]                	mov	si, _msg_YES
  2898                                  	;call	print_msg
  2899 00001029 EB03                    	jmp	short B_63
  2900                                  B_62:
  2901 0000102B BE[FC5D]                	mov	si, _msg_NO
  2902                                  B_63:	; 06/03/2019
  2903 0000102E E8040E                  	call	print_msg
  2904                                  
  2905                                  	; 15/02/2019
  2906 00001031 29DB                    	sub	bx, bx
  2907 00001033 381E[9D40]              	cmp	byte [newdisk], bl ; 0
  2908 00001037 7708                    	ja	short B_64 ; 23/02/2019
  2909 00001039 381E[A06E]              	cmp	byte [wholedisk], bl ; 0
  2910 0000103D 0F870E01                	ja	B_75 ; 23/02/2019
  2911                                  B_64:
  2912                                  	; 08/02/2019
  2913                                  	;sub	bx, bx
  2914 00001041 A1[8C6E]                	mov	ax, [total_sectors]
  2915 00001044 8B16[8E6E]              	mov	dx, [total_sectors+2]
  2916 00001048 2B06[9640]              	sub	ax, [sectors]
  2917 0000104C 19DA                    	sbb	dx, bx ; sbb dx, 0
  2918                                  
  2919 0000104E A3[9C6E]                	mov	[pp_Sectors], ax   ; = [total_sectors] - [sectors]
  2920 00001051 8916[9E6E]              	mov	[pp_Sectors+2], dx ; = [total_sectors+2] - carry bit
  2921                                  B_65:
  2922 00001055 381E[A06E]              	cmp	byte [wholedisk], bl ; 0
  2923 00001059 0F87F900                	ja	B_76 ; 09/02/2019
  2924                                  B_66:
  2925                                  	; clear screen
  2926 0000105D B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  2927 00001060 CD10                    	int	10h
  2928                                  
  2929 00001062 BE[F848]                	mov	si, msg_create_dos_partition_h ; header
  2930 00001065 E8CD0D                  	call	print_msg
  2931 00001068 BE[894D]                	mov	si, msg_create_dos_partition_s ; size options
  2932 0000106B E8C70D                  	call	print_msg
  2933                                  B_67:
  2934 0000106E 30E4                    	xor	ah, ah
  2935 00001070 CD16                    	int	16h
  2936                                  
  2937                                  	; 24/02/2019
  2938 00001072 3C1B                    	cmp	al, 27	; ESCAPE key 
  2939 00001074 0F849FF3                	je	A_48	; Cancel
  2940                                  
  2941 00001078 3C20                    	cmp	al, 32	; SPACE key
  2942 0000107A 751F                    	jne	short B_69
  2943                                  
  2944                                  		; Entire space
  2945 0000107C A1[9C6E]                	mov	ax, [pp_Sectors]
  2946 0000107F 8B16[9E6E]              	mov	dx, [pp_Sectors+2]
  2947                                  
  2948 00001083 C606[A06E]01            	mov 	byte [wholedisk], 1 ; 09/02/2019
  2949 00001088 EB58                    	jmp	short B_71
  2950                                  
  2951                                  B_68:
  2952                                  	; ZERO partition size message
  2953 0000108A BE[095C]                	mov	si, msg_zero_partition_size
  2954 0000108D E8A50D                  	call	print_msg
  2955                                  	
  2956 00001090 30E4                    	xor	ah, ah
  2957 00001092 CD16                    	int	16h
  2958 00001094 3C1B                    	cmp	al, 27 ; ESCAPE key
  2959 00001096 75C5                    	jne	short B_66 ; Retry
  2960                                  
  2961 00001098 E99EFE                  	jmp	B_47 ; exit
  2962                                  
  2963                                  B_69:
  2964 0000109B C606[AE6E]25            	mov	byte [pSize_unit], '%'
  2965 000010A0 3C25                    	cmp	al, '%'
  2966 000010A2 7422                    	je	short B_70
  2967 000010A4 C606[AE6E]53            	mov	byte [pSize_unit], 'S'
  2968 000010A9 3C0D                    	cmp	al, 13 ; 0Dh, Carriage Return key
  2969 000010AB 7419                    	je	short B_70
  2970 000010AD 24DF                    	and	al, 0DFh
  2971 000010AF 3C53                    	cmp	al, 'S'
  2972 000010B1 7413                    	je	short B_70
  2973 000010B3 A2[AE6E]                	mov	[pSize_unit], al
  2974 000010B6 3C4B                    	cmp	al, 'K'
  2975 000010B8 740C                    	je	short B_70
  2976 000010BA 3C4D                    	cmp	al, 'M'
  2977 000010BC 7408                    	je	short B_70
  2978 000010BE 3C47                    	cmp	al, 'G'
  2979 000010C0 7404                    	je	short B_70
  2980 000010C2 3C43                    	cmp	al, 'C'
  2981 000010C4 75A8                    	jne	short B_67
  2982                                  B_70:
  2983 000010C6 C606[F365]73            	mov	byte [msg_sectors_crlf_s], 's' ; " sectors"
  2984                                  
  2985 000010CB E8AE0F                  	call	partition_size_input
  2986                                  	;jc	B_47 ; exit if partition size input is 0
  2987 000010CE 72BA                    	jc	short B_68
  2988                                  
  2989 000010D0 21DB                    	and	bx, bx ; bx_dx_ax = partition size
  2990                                  	;jnz	short B_77
  2991                                  	; 23/02/2019 
  2992 000010D2 7540                    	jnz	short B_72 ; invalid! (use maximum available sectors)
  2993                                  
  2994                                  	; 08/02/2019
  2995 000010D4 09D2                    	or	dx, dx
  2996 000010D6 750A                    	jnz	short B_71 ; proper size (for now)
  2997                                  
  2998 000010D8 8B1E[C66E]              	mov	bx, [min_sectors] ; minimum sectors
  2999 000010DC 39C3                    	cmp	bx, ax
  3000 000010DE 7602                    	jna	short B_71 ; proper size (for now)
  3001                                  
  3002                                  	; invalid! (use minimum sectors or sectors per cylinder)
  3003 000010E0 89D8                    	mov	ax, bx
  3004                                  B_71:
  3005                                  	; 09/02/2019
  3006                                  	; save dx,ax
  3007 000010E2 8916[CE6E]              	mov	[ppn_Sectors+2], dx
  3008 000010E6 A3[CC6E]                	mov	[ppn_Sectors], ax
  3009                                  
  3010                                  	; write partition size
  3011                                  	;push	dx
  3012                                  	;push	ax
  3013 000010E9 BE[BB6E]                	mov	si, msg_partition_sectors + 7 ; max. 7 digits
  3014 000010EC E8CE0D                  	call	bin_to_decimal
  3015                                  	; ds:si = beginning of decimal number text
  3016 000010EF E8430D                  	call	print_msg
  3017 000010F2 BE[EC65]                	mov	si, msg_sectors_crlf
  3018 000010F5 E83D0D                  	call	print_msg
  3019                                  	;pop	ax
  3020                                  	;pop	dx
  3021                                  
  3022 000010F8 803E[A06E]00            	cmp	byte [wholedisk], 0
  3023 000010FD 775E                    	ja	short B_77 ; 09/02/2019
  3024                                  
  3025                                  	; restore ax,dx
  3026 000010FF A1[CC6E]                	mov	ax, [ppn_Sectors]
  3027 00001102 8B16[CE6E]              	mov	dx, [ppn_Sectors+2]
  3028                                  
  3029                                  	; select whole disk 
  3030                                  	;   if partition size > disk size
  3031 00001106 3B16[9E6E]              	cmp	dx, [pp_Sectors+2]
  3032 0000110A 7708                    	ja	short B_72
  3033 0000110C 724F                    	jb	short B_77
  3034 0000110E 3B06[9C6E]              	cmp	ax, [pp_Sectors]
  3035 00001112 7649                    	jna	short B_77
  3036                                  B_72:
  3037 00001114 803E[9D40]00            	cmp	byte [newdisk], 0
  3038 00001119 7667                    	jna	short B_78
  3039                                  
  3040                                  	; "use whole disk or go to back" question
  3041 0000111B BE[0A50]                	mov	si, msg_partition_size_overs
  3042                                  B_73:
  3043 0000111E E8140D                  	call	print_msg
  3044                                  B_74:
  3045 00001121 30E4                    	xor	ah, ah
  3046 00001123 CD16                    	int	16h
  3047                                  	
  3048 00001125 3C1B                    	cmp	al, 27 ; ESCAPE key
  3049                                  	;je	B_49
  3050 00001127 0F8432FF                	je	B_66 ; 09/02/2019
  3051 0000112B 3C0D                    	cmp	al, 13 ; ENTER (Carriage Return) key
  3052 0000112D 75F2                    	jne	short B_74
  3053                                  
  3054 0000112F FE06[A06E]              	inc	byte [wholedisk]
  3055                                  
  3056                                  	; 24/02/2019
  3057 00001133 803E[9D40]00            	cmp	byte [newdisk], 0
  3058 00001138 7715                    	ja	short B_75
  3059                                  
  3060 0000113A 8B1E[3072]              	mov	bx, [c_fspc_offset]
  3061 0000113E 8B87[E671]              	mov	ax, [free_space.sectors_unused+bx]
  3062 00001142 8B97[E871]              	mov	dx, [free_space.sectors_unused+bx+2]
  3063 00001146 A3[9C6E]                	mov	[pp_Sectors], ax
  3064 00001149 8916[9E6E]              	mov	[pp_Sectors+2], dx
  3065 0000114D EB07                    	jmp	short B_76 
  3066                                  B_75:
  3067                                  	; 09/02/2019
  3068 0000114F 8B16[9E6E]              	mov	dx, [pp_Sectors+2]
  3069 00001153 A1[9C6E]                	mov	ax, [pp_Sectors]
  3070                                  B_76:
  3071 00001156 8916[CE6E]              	mov	[ppn_Sectors+2], dx
  3072 0000115A A3[CC6E]                	mov	[ppn_Sectors], ax
  3073                                  B_77:
  3074 0000115D 803E[A16E]05            	cmp	byte [pp_type], 5
  3075 00001162 0F853601                	jne	B_99
  3076                                  
  3077 00001166 803E[9371]00            	cmp	byte [ppcount], 0  ; primary partition count
  3078 0000116B 0F87C500                	ja	B_93
  3079                                  
  3080 0000116F BE[7450]                	mov	si, msg_ext_partition_error
  3081 00001172 E8C00C                  	call	print_msg
  3082 00001175 BE[ED4F]                	mov	si, msg_any_key_to_retry
  3083 00001178 E8BA0C                  	call	print_msg
  3084                                  
  3085                                  	; 09/02/2019
  3086 0000117B 30E4                    	xor	ah, ah
  3087 0000117D CD16                    	int	16h
  3088                                  
  3089                                  	;jmp	B_49
  3090 0000117F E945F6                  	jmp	cpi_2
  3091                                  
  3092                                  B_78:
  3093                                  	; clear screen
  3094 00001182 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  3095 00001185 CD10                    	int	10h
  3096                                  
  3097 00001187 BE[F848]                	mov	si, msg_create_dos_partition_h ; header
  3098 0000118A E8A80C                  	call	print_msg
  3099                                  
  3100 0000118D BE[BB5F]                	mov	si, msg_partition_size_limit
  3101 00001190 E8A20C                  	call	print_msg
  3102                                  
  3103 00001193 8B1E[3072]              	mov	bx, [c_fspc_offset]
  3104                                  
  3105 00001197 803E[AE6E]53            	cmp	byte [pSize_unit], 'S'
  3106 0000119C 7415                    	je	short B_79
  3107 0000119E 803E[AE6E]4B            	cmp	byte [pSize_unit], 'K'
  3108 000011A3 740E                    	je	short B_79
  3109                                  
  3110 000011A5 803E[AE6E]25            	cmp	byte [pSize_unit], '%'
  3111 000011AA 7469                    	je	short B_89
  3112                                  
  3113 000011AC 803E[AE6E]43            	cmp	byte [pSize_unit], 'C'
  3114 000011B1 7479                    	je	B_92
  3115                                  B_79:
  3116                                  	; 'S', 'K'
  3117 000011B3 81C3[E671]              	add	bx, free_space.sectors_unused
  3118 000011B7 8B07                    	mov	ax, [bx]
  3119 000011B9 8B5702                  	mov	dx, [bx+2]
  3120                                  		
  3121 000011BC B90A00                  	mov	cx, 10
  3122 000011BF 89E5                    	mov	bp, sp
  3123                                  B_80:
  3124 000011C1 E872FC                  	call	div32
  3125 000011C4 53                      	push	bx
  3126 000011C5 09D2                    	or	dx, dx
  3127 000011C7 75F8                    	jnz	short B_80
  3128 000011C9 83F809                  	cmp	ax, 9
  3129 000011CC 77F3                    	ja	short B_80
  3130                                  B_81:
  3131 000011CE BB0700                  	mov	bx, 07h
  3132 000011D1 09C0                    	or	ax, ax
  3133 000011D3 7501                    	jnz	short B_83
  3134                                  B_82:
  3135 000011D5 58                      	pop	ax
  3136                                  B_83:
  3137 000011D6 0430                    	add	al, '0'
  3138                                  B_84:
  3139 000011D8 B40E                    	mov	ah, 0Eh
  3140                                  	;mov	bx, 07h
  3141 000011DA CD10                    	int	10h	; write character (as tty)
  3142                                  
  3143 000011DC 39EC                    	cmp	sp, bp
  3144 000011DE 72F5                    	jb	short B_82
  3145                                  
  3146 000011E0 803E[AE6E]53            	cmp	byte [pSize_unit], 'S'
  3147 000011E5 7422                    	je	short B_86
  3148 000011E7 803E[AE6E]4B            	cmp	byte [pSize_unit], 'K'
  3149 000011EC 741B                    	je	short B_86
  3150                                  
  3151 000011EE 803E[AE6E]25            	cmp	byte [pSize_unit], '%'
  3152 000011F3 7508                    	jne	short B_85
  3153                                  
  3154                                  	; 24/02/2019
  3155 000011F5 3C25                    	cmp	al, '%'
  3156 000011F7 7416                    	je	short B_88
  3157 000011F9 B025                    	mov	al, '%'
  3158 000011FB EBDB                    	jmp	short B_84 
  3159                                  B_85:
  3160 000011FD 803E[AE6E]43            	cmp	byte [pSize_unit], 'C'
  3161 00001202 7505                    	jne	short B_86
  3162                                  
  3163 00001204 BE[5760]                	mov	si, msg_cylinders
  3164 00001207 EB03                    	jmp	short B_87
  3165                                  B_86:
  3166 00001209 BE[6260]                	mov	si, msg_sectors
  3167                                  B_87:
  3168 0000120C E8260C                  	call	print_msg
  3169                                  B_88:
  3170 0000120F BE[0860]                	mov	si, msg_partition_size_limit_r
  3171                                  	;call	print_msg
  3172                                  
  3173 00001212 E909FF                  	jmp	B_73
  3174                                  
  3175                                  B_89:
  3176                                  	; '%'
  3177 00001215 81C3[E471]              	add	bx, free_space.percent_unused
  3178 00001219 8B07                    	mov	ax, [bx]
  3179                                  B_90:
  3180 0000121B 89E5                    	mov	bp, sp
  3181                                  B_91:
  3182 0000121D 31D2                    	xor	dx, dx
  3183 0000121F B90A00                  	mov	cx, 10
  3184 00001222 F7F1                    	div	cx
  3185 00001224 52                      	push	dx
  3186 00001225 83F809                  	cmp	ax, 9
  3187 00001228 77F3                    	ja	short B_91
  3188 0000122A EBA2                    	jmp	short B_81
  3189                                  B_92:
  3190                                  	; 'C'
  3191 0000122C 81C3[DE71]              	add	bx, free_space.space
  3192 00001230 8B07                    	mov	ax, [bx]
  3193 00001232 EBE7                    	jmp	short B_90
  3194                                  
  3195                                  B_93:
  3196                                  	; 23/02/2019
  3197 00001234 8B1E[3072]              	mov	bx, [c_fspc_offset]
  3198 00001238 8B87[E071]              	mov	ax, [bx+free_space.start]
  3199                                  
  3200                                  	; set free space start cylinder to 1 if it is 0
  3201 0000123C 09C0                    	or	ax, ax
  3202 0000123E 750F                    	jnz	short B_94
  3203                                  
  3204 00001240 B005                    	mov	al, 5	; Get free space for extended partition
  3205 00001242 E88214                  	call	find_part_free_space
  3206                                  
  3207 00001245 891E[3072]              	mov	[c_fspc_offset], bx
  3208                                  
  3209 00001249 21C9                    	and	cx, cx
  3210 0000124B 0F843AF2                	jz	cp_4	; there is not free space on disk
  3211                                  B_94:
  3212                                  	; 24/02/2019
  3213 0000124F E81100                  	call	partition_size_fixup_x
  3214 00001252 0F822CFF                	jc	B_78
  3215                                  
  3216                                  	; 16/02/2019
  3217 00001256 E8F8F7                  	call	create_extended_partition 
  3218                                  			; must be called after 'find_part_free_space'.
  3219                                  	; 24/02/2019
  3220 00001259 E8DA10                  	call	show_selected_partition
  3221 0000125C E9BE00                  	jmp	C_02
  3222                                  
  3223                                  partition_size_fixup:
  3224                                  	; 24/02/2019
  3225 0000125F 8B1E[3072]              	mov	bx, [c_fspc_offset]
  3226                                  partition_size_fixup_x:
  3227                                  	; 25/02/2019 
  3228 00001263 803E[9D40]00            	cmp	byte [newdisk], 0
  3229 00001268 7731                    	ja	short B_98
  3230                                  
  3231 0000126A 81C3[E671]              	add	bx, free_space.sectors_unused
  3232 0000126E 8B07                    	mov	ax, [bx]
  3233 00001270 8B5702                  	mov	dx, [bx+2]
  3234                                  
  3235 00001273 3B16[CE6E]              	cmp	dx, [ppn_Sectors+2]
  3236 00001277 7222                    	jb	short B_98 ; 24/02/2019
  3237 00001279 7708                    	ja	short B_95
  3238 0000127B 3B06[CC6E]              	cmp	ax, [ppn_Sectors]
  3239 0000127F 721A                    	jb	short B_98 ; 24/02/2019
  3240 00001281 7411                    	je	short B_97
  3241                                  
  3242                                  B_95:
  3243                                  	; 19/02/2019
  3244 00001283 A1[CC6E]                	mov	ax, [ppn_Sectors]
  3245                                  B_96:
  3246 00001286 8B16[CE6E]              	mov	dx, [ppn_Sectors+2]
  3247                                  
  3248                                  	; 18/02/2019
  3249                                  
  3250                                  	; check for best fit
  3251                                  	; (leave max. available space to next time if 
  3252                                  	;  another space/gap fits to partition size request.)
  3253                                  
  3254 0000128A E85416                  	call	find_enough_free_sectors
  3255                                  		; CX = Free space index (0 to 4)
  3256                                  		; DX:AX = First available space which fits to request
  3257                                  	;mov	bx, cx
  3258                                  	;shl	bl, 4 ; * 16  ; * Free space structure size
  3259                                  	;mov	[c_fspc_offset], bx
  3260                                  	
  3261                                  	; 22/02/2019
  3262 0000128D C0E104                  	shl	cl, 4
  3263 00001290 890E[3072]              	mov	[c_fspc_offset], cx 
  3264                                  
  3265                                  	;add	bx, free_space.sectors_unused
  3266                                  	;mov	ax, [bx]
  3267                                  	;mov	dx, [bx+2]
  3268                                  B_97:		
  3269                                  	; Save max. available space
  3270 00001294 A3[9C6E]                	mov	[pp_Sectors], ax
  3271 00001297 8916[9E6E]              	mov	[pp_Sectors+2], dx
  3272                                  B_98:
  3273 0000129B C3                      	retn
  3274                                  
  3275                                  B_99:
  3276                                  	; 24/02/2019
  3277 0000129C E8C0FF                  	call	partition_size_fixup
  3278 0000129F 0F82DFFE                	jc	B_78
  3279                                  
  3280                                  	 ; 16/02/2019
  3281                                  	; Force cylinder boundary alignment except
  3282                                  	;   sectors ('S') and kilobytes ('K') as sizing unit.
  3283                                  
  3284 000012A3 C606[3272]59            	mov	byte [cylinder_boundary], 'Y' ; Default
  3285                                  				; sizing unit is one of
  3286                                  				; 'cylinders','megabytes','gigabytes'
  3287                                  				; and boundary alignment is yes for them.
  3288 000012A8 A0[AE6E]                	mov	al, [pSize_unit]
  3289                                  
  3290                                  	;cmp	byte [pSize_unit], 'S' ; Sectors
  3291 000012AB 3C53                    	cmp	al, 'S'
  3292 000012AD 7404                    	je	short B_100
  3293                                  
  3294                                  	;cmp	byte [pSize_unit], 'K' ; Kilobytes
  3295 000012AF 3C4B                    	cmp	al, 'K'
  3296 000012B1 752F                    	jne	short B_104
  3297                                  B_100:
  3298                                  	; Sizing unit is one of 'sectors' and/or 'kilobytes'
  3299                                  	; and bound aligment will be applied if the answer will be yes. 
  3300                                  
  3301 000012B3 BE[FC50]                	mov	si, msg_cylinder_boundary_set
  3302 000012B6 E87C0B                  	call	print_msg
  3303                                  B_101:
  3304 000012B9 30E4                    	xor	ah, ah
  3305 000012BB CD16                    	int	16h
  3306                                  	; Cylinder boundary adjusting
  3307 000012BD 3C0D                    	cmp	al, 13 ; ENTER key
  3308 000012BF 74F2                    	je	short B_100
  3309 000012C1 3C1B                    	cmp	al, 27 ; ESCAPE key
  3310 000012C3 741A                    	je	short B_103	; Align end of the partition only
  3311                                  				; if start of the partition is aligned
  3312                                  				; or it starts at cyl 0, head 1, sect 17 or 63.
  3313                                  				; (End of the partition will be extended to
  3314                                  				; end sector of it's last cylinder if the size
  3315                                  				; will not over [pp_Sectors] value.)  	 
  3316 000012C5 24DF                    	and	al, 0DFh
  3317                                  
  3318                                  	; 22/02/2019
  3319 000012C7 3C59                    	cmp	al, 'Y'
  3320 000012C9 7508                    	jne	short B_102
  3321                                  
  3322 000012CB BE[F65D]                	mov	si, _msg_YES
  3323 000012CE E8640B                  	call	print_msg
  3324                                  
  3325                                  	;mov	al, 'Y'
  3326                                  	;jmp	short B_103
  3327 000012D1 EB0F                    	jmp	short B_104
  3328                                  B_102:
  3329 000012D3 3C4E                    	cmp	al, 'N'
  3330 000012D5 75E2                    	jne	short B_101
  3331                                  
  3332 000012D7 BE[FC5D]                	mov	si, _msg_NO
  3333 000012DA E8580B                  	call	print_msg
  3334                                  
  3335 000012DD B04E                    	mov	al, 'N'
  3336                                  		; do not align partition to cylinder boundary 
  3337                                  B_103:
  3338 000012DF A2[3272]                	mov	[cylinder_boundary], al
  3339                                  B_104:
  3340 000012E2 E832F5                  	call	create_primary_partition
  3341                                  	
  3342                                  	; 18/02/2019
  3343 000012E5 803E[9D40]00            	cmp	byte [newdisk], 0
  3344 000012EA 760E                    	jna	short B_105
  3345                                  
  3346 000012EC 31C0                    	xor	ax, ax ; 0
  3347 000012EE 31D2                    	xor	dx, dx ; 0
  3348                                  	; DX_AX = Masterboot Sector = 0
  3349 000012F0 BB[2C57]                	mov	bx, MasterBootBuff
  3350                                  	; ES:BX = Sector Buffer
  3351 000012F3 E84E0B                  	call	write_hd_sector
  3352 000012F6 0F821B0B                	jc	D_01
  3353                                  
  3354                                  B_105:
  3355                                  	; DS:SI = Partition Table Entry address
  3356                                  	; 25/02/2019
  3357 000012FA 8936[5472]              	mov	[pte_address], si  ; save PTE address
  3358 000012FE E83510                  	call	show_selected_partition
  3359                                  
  3360                                  	;jmp	C_01
  3361                                  
  3362                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3363                                  ; Format question
  3364                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3365                                  
  3366                                  C_01:
  3367                                  	;mov	si, CRLF
  3368                                  	;call	print_msg
  3369                                  
  3370 00001301 C606[BD6E]01            	mov	byte [format_q], 1
  3371                                  
  3372 00001306 A0[A16E]                	mov	al, [pp_type]
  3373 00001309 3C01                    	cmp	al, 1		; FAT12 (CHS)
  3374 0000130B 741D                    	je	short C_03
  3375 0000130D 3C04                    	cmp	al, 4		; FAT16 CHS
  3376 0000130F 7419                    	je	short C_03
  3377 00001311 3C06                    	cmp	al, 6		; FAT16 BIG CHS
  3378 00001313 7415                    	je	short C_03
  3379 00001315 3C0B                    	cmp	al, 0Bh		; FAT32 CHS
  3380 00001317 7411                    	je	short C_03
  3381 00001319 3CA1                    	cmp	al, 0A1h	; SINGLIX FS1
  3382 0000131B 740D                    	je	short C_03
  3383                                  
  3384                                  	;cmp	al, 71h
  3385                                  	;je	short C_03	; RETRO UNIX 386
  3386                                  
  3387                                  	;dec	byte [format_q] ; 0
  3388                                  C_02:
  3389 0000131D C606[BD6E]00            	mov	byte [format_q], 0 ; 24/02/2019
  3390                                  
  3391                                  	; NON-DOS partition!
  3392                                  	; Ask for editing PT or exit (continue without formatting)
  3393 00001322 BE[8254]                	mov	si, msg_edit_or_exit
  3394 00001325 E80D0B                  	call	print_msg
  3395 00001328 EB06                    	jmp	short C_04
  3396                                  C_03:
  3397                                  	; Ask for formatting, editing PT or exit
  3398 0000132A BE[1354]                	mov	si, msg_format_stage
  3399 0000132D E8050B                  	call	print_msg
  3400                                  C_04:
  3401 00001330 BE[5354]                	mov	si, msg_partition_edit
  3402 00001333 E8FF0A                  	call	print_msg
  3403                                  C_05:
  3404 00001336 28E4                    	sub	ah, ah
  3405 00001338 CD16                    	int	16h
  3406                                  
  3407 0000133A 3C0D                    	cmp	al, 13
  3408 0000133C 7452                    	je	short C_08
  3409                                  
  3410                                  	;; 07/03/2019
  3411 0000133E 3C20                    	cmp	al, 20h ; SPACE
  3412                                  	;je	A_27 ; edit partition table option is selected
  3413 00001340 7406                    	je	short C_06 ; 08/03/2019
  3414                                  
  3415 00001342 3C1B                    	cmp	al, 27 ; ESCAPE
  3416 00001344 75F0                    	jne	short C_05
  3417                                  	
  3418 00001346 30C0                    	xor	al, al ; 08/03/2019
  3419                                  Exit:
  3420                                  C_06:
  3421 00001348 50                      	push	ax ; 08/03/2019
  3422 00001349 B43E                    	mov	ah, 3Eh ; close file
  3423 0000134B 8B1E[9440]              	mov	bx, [img_file_handle]
  3424 0000134F CD21                    	int	21h
  3425                                  	; 08/03/2019
  3426 00001351 58                      	pop	ax
  3427                                  	;cmp	al, 27
  3428                                  	;je	short C_06_exit
  3429 00001352 08C0                    	or	al, al
  3430 00001354 7409                    	jz	short C_06_exit
  3431 00001356 C706[9440]0000          	mov 	word [img_file_handle], 0
  3432 0000135C E9DBEE                  	jmp	A_27
  3433                                  
  3434                                  C_06_exit:
  3435 0000135F BE[5356]                	mov	si, CRLF
  3436 00001362 E8D00A                  	call	print_msg
  3437                                  
  3438                                  	; 11/02/2019
  3439                                   
  3440                                  	; Exit
  3441 00001365 CD20                    	int	20h
  3442                                  
  3443                                  save_mbr_exit:
  3444                                  	; 24/02/2019
  3445 00001367 E8B111                  	call	init_partition_tables
  3446                                  
  3447 0000136A E82016                  	call	display_partition_table
  3448                                  
  3449 0000136D BE[5356]                	mov	si, CRLF
  3450 00001370 E8C20A                  	call	print_msg
  3451                                  
  3452 00001373 BE[0755]                	mov	si, msg_writing_mbr
  3453 00001376 E8BC0A                  	call	print_msg
  3454                                  
  3455 00001379 31C0                    	xor	ax, ax ; 0
  3456 0000137B 31D2                    	xor	dx, dx ; 0
  3457                                  	; DX_AX = Masterboot Sector = 0
  3458 0000137D BB[2C57]                	mov	bx, MasterBootBuff
  3459                                  	; ES:BX = Sector Buffer
  3460 00001380 E8C10A                  	call	write_hd_sector
  3461 00001383 7303                    	jnc	short C_07
  3462 00001385 E98D0A                  	jmp	D_01
  3463                                  C_07:
  3464 00001388 BE[4F56]                	mov	si, Msg_OK
  3465 0000138B E8A70A                  	call	print_msg
  3466 0000138E EBB8                    	jmp	short Exit
  3467                                  
  3468                                  C_08:
  3469 00001390 803E[BD6E]01            	cmp	byte [format_q], 1
  3470 00001395 72D0                    	jb	short save_mbr_exit
  3471                                  
  3472                                  	; 25/02/2019
  3473                                  	; Write MBR without writing message
  3474                                  	
  3475                                  	; NOTE: This may be second time of MBR writing...
  3476                                  	;	but, if partition table is modified,
  3477                                  	;	we need to write MBR to disk, here.
  3478                                  	;
  3479                                  	; (Otherwise.. the last created partition would not be recorded.)
  3480                                  
  3481 00001397 31C0                    	xor	ax, ax ; 0
  3482 00001399 31D2                    	xor	dx, dx ; 0
  3483                                  	; DX_AX = Masterboot Sector = 0
  3484 0000139B BB[2C57]                	mov	bx, MasterBootBuff
  3485                                  	; ES:BX = Sector Buffer
  3486 0000139E E8A30A                  	call	write_hd_sector
  3487 000013A1 0F82700A                	jc	D_01
  3488                                  
  3489                                  	;; clear screen
  3490                                  	;mov	ax, 3 ; set video mode to 03h (80x25 text)
  3491                                  	;int	10h
  3492                                  
  3493                                  	; 25/02/2019
  3494 000013A5 8B36[5472]              	mov	si, [pte_address]
  3495                                  
  3496                                  	; 18/02/2019
  3497 000013A9 E88A0F                  	call	show_selected_partition	
  3498                                  
  3499 000013AC A0[3A54]                	mov	al, [partition_num_chr]
  3500 000013AF A2[FA54]                	mov	[partition_num_txt], al
  3501                                  
  3502 000013B2 BE[D854]                	mov	si, msg_format_question
  3503 000013B5 E87D0A                  	call	print_msg
  3504                                  C_09:
  3505 000013B8 30E4                    	xor	ah, ah
  3506 000013BA CD16                    	int	16h
  3507                                  
  3508 000013BC 3C1B                    	cmp	al, 1Bh ; ESCAPE
  3509 000013BE 7488                    	je	short C_06
  3510                                  
  3511 000013C0 24DF                    	and	al, 0DFh ; capitalization
  3512 000013C2 3C59                    	cmp	al, 'Y'
  3513 000013C4 740C                    	je	short C_10
  3514 000013C6 3C4E                    	cmp	al, 'N'
  3515 000013C8 75EE                    	jne	short C_09
  3516 000013CA BE[FC5D]                	mov	si, _msg_NO
  3517 000013CD E8650A                  	call	print_msg
  3518                                  	;jmp	short C_06
  3519                                  	; 24/02/2019
  3520 000013D0 EB95                    	jmp	short save_mbr_exit
  3521                                  C_10:
  3522 000013D2 BE[F65D]                	mov	si, _msg_YES
  3523 000013D5 E85D0A                  	call	print_msg
  3524                                  
  3525                                  	; [pp_StartSector] = partition's start sector
  3526                                  	; [pp_Sectors] = partition size including start & end sector
  3527                                  	; [partition_num_chr] = partition number + '0'
  3528                                  	; [pp_type] = partition type (for TRDOS 386 boot sector)
  3529                                  
  3530 000013D8 8926[0E6A]              	mov	[old_sp], sp
  3531                                  	
  3532 000013DC 8A16[A16E]              	mov	dl, [pp_type]
  3533                                  	; DL = partition type (file system ID)
  3534                                  	;dec	dl
  3535                                  	;jz	FAT12_hdi_format
  3536 000013E0 80FA01                  	cmp	dl, 1 ; 14/09/2020 (BugFix)
  3537 000013E3 0F86D805                	jna	FAT12_hdi_format
  3538                                  	;cmp	dl, 4
  3539                                  	;je	FAT16_hdi_format
  3540                                  	;cmp	dl, 6
  3541                                  	;je	FAT16_hdi_format
  3542 000013E7 80FA0B                  	cmp	dl, 0Bh 
  3543 000013EA 0F82D503                	jb	FAT16_hdi_format
  3544                                  	;je	short FAT32_hdi_format
  3545                                  	;cmp	dl, 0Ch ; 14/09/2020
  3546 000013EE 0F876507                	ja	SINGLIX_hdi_format
  3547                                  
  3548                                  	;cmp	dl, 0A1h
  3549                                  	;je	SINGLIX_hdi_format
  3550                                  	;jb	RUNIX386_hdi_format ; dl = 071h
  3551                                  
  3552                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3553                                  ; FAT32 FORMATTING
  3554                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3555                                  	
  3556                                  	; 08/02/2019 (Modified for -only- FAT32 CHS partitions)
  3557                                  FAT32_hdi_format:
  3558                                  	;mov	ax, 000Ch ; db 0Ch, 00h ; 'or al, 0'
  3559                                  	;cmp	dl, al ; 0Ch
  3560                                  	;je	short FAT32_lba_format
  3561                                  	;mov	ax, 0C00Bh ; db 0Bh, 0C0h ; 'or ax, ax'
  3562                                  ;FAT32_lba_format:
  3563                                  	; Put TRDOS 386 FAT32 partition magic word 
  3564                                  	; at offset 5Ah, in TRDOS386 FAT32 boot sector 0.
  3565                                  	;mov	bp, TRDOS_FAT32_hd_bs
  3566 000013F2 BD[8234]                	mov	bp, RD5_FAT32_hd_bs ; 04/05/2024
  3567 000013F5 8D7E03                  	lea	di, [bp+3]
  3568 000013F8 BE[F865]                	mov	si, bs_oem_name
  3569 000013FB B90400                  	mov	cx, 4
  3570 000013FE F3A5                    	rep	movsw 
  3571                                  	;mov	[bp+5Ah], ax	; [loc_5A]
  3572 00001400 C7465A0BC0              	mov	word [bp+5Ah], 0C00Bh ; 08/02/2019
  3573 00001405 A1[9640]                	mov	ax, [sectors]
  3574 00001408 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  3575 0000140B A1[9840]                	mov	ax, [heads]
  3576 0000140E 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  3577 00001411 A1[986E]                	mov	ax, [pp_StartSector]
  3578 00001414 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  3579 00001417 A1[9A6E]                	mov	ax, [pp_StartSector+2]
  3580 0000141A 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  3581                                  	;mov	ax, [pp_Sectors]
  3582 0000141D A1[CC6E]                	mov	ax, [ppn_Sectors] ; 16/02/2019
  3583 00001420 894620                  	mov	[bp+20h], ax	; [BPB_TotSec32]
  3584                                  	;mov	dx, [pp_Sectors+2]
  3585 00001423 8B16[CE6E]              	mov	dx, [ppn_Sectors+2] ; 16/02/2019
  3586 00001427 895622                  	mov	[bp+22h], dx	; [BPB_TotSec32+2]
  3587                                  	
  3588                                  	; Sectors per cluster calculation
  3589                                  	; (According to MS FAT32 FS specification.)
  3590 0000142A B108                    	mov	cl, 8  ; 8 sectors per cluster
  3591 0000142C 83FA08                  	cmp	dx, 8  ; >= 532480 sectors
  3592 0000142F 7709                    	ja	short FAT32_f_2 ; 8 sectors per cluster
  3593 00001431 7205                    	jb	short FAT32_f_1 ; 1 sector per cluster
  3594 00001433 3D0020                  	cmp	ax, 2000h ; dx_ax = (8*65536)+8192
  3595 00001436 7302                    	jnb	short FAT32_f_2 ; 12/09/2020 (BugFix)
  3596                                  FAT32_f_1:
  3597 00001438 B101                    	mov	cl, 1	; 1 sector per cluster
  3598                                  FAT32_f_2:
  3599 0000143A 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  3600                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  3601                                  	;mov	word [bp+0Eh], 32 ; [BPB_RsvdSecCnt]
  3602                                  
  3603                                  	; Calculating FAT size in sectors
  3604                                  	; (According to MS FAT32 FS Specification, 2000)
  3605                                  
  3606                                  	; DX_AX = partition (volume) size in sectors
  3607 0000143D 2B460E                  	sub	ax, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  3608 00001440 83DA00                  	sbb	dx, 0
  3609                                  		; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  3610                                  		;	     		RootDirsectors)
  3611                                  		; RootDirSectors = 0 (for FAT32 FS)
  3612 00001443 89CB                    	mov	bx, cx ; ch = 0
  3613 00001445 C1E308                  	shl	bx, 8 ; * 256
  3614 00001448 8A4E10                  	mov	cl, [bp+10h] ; [BPB_NumFATs]
  3615 0000144B 01CB                    	add	bx, cx	
  3616                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  3617 0000144D D1EB                    	shr	bx, 1
  3618                                  		; TmpVal2 = TmpVal2/2
  3619 0000144F 89D9                    	mov	cx, bx
  3620 00001451 4B                      	dec	bx  ; TmpVal2-1
  3621 00001452 01D8                    	add	ax, bx
  3622 00001454 83D200                  	adc	dx, 0
  3623 00001457 E8DCF9                  	call	div32
  3624                                  		; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  3625                                  	; DX_AX = FAT size in sectors
  3626 0000145A 894624                  	mov	[bp+24h], ax	; [BPB_FATSz32]
  3627 0000145D 895626                  	mov	[bp+26h], dx	; [BPB_FATSz32+2]
  3628                                  	; * 2
  3629 00001460 89D3                    	mov	bx, dx
  3630 00001462 01C0                    	add	ax, ax
  3631 00001464 11D3                    	adc	bx, dx
  3632                                  	; BX_AX = [BPB_NumFATs] * [BPB_FATSz32]
  3633 00001466 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  3634 00001469 01C1                    	add	cx, ax
  3635 0000146B 83D300                  	adc	bx, 0
  3636                                  	; BX_CX = [BPB_RsvdSecCnt]+[BPB_NumFATs]*[BPB_FATSz32]
  3637 0000146E 8B4620                  	mov	ax, [bp+20h]	; [BPB_TotSec32]
  3638 00001471 8B5622                  	mov	dx, [bp+22h]	; [BPB_TotSec32+2]
  3639 00001474 29C8                    	sub	ax, cx
  3640 00001476 19DA                    	sbb	dx, bx
  3641 00001478 890E[106C]              	mov	[data_start], cx
  3642 0000147C 891E[126C]              	mov	[data_start+2], bx
  3643                                  	; DX_AX = Data sectors
  3644 00001480 A3[146C]                	mov	[data_sectors], ax
  3645 00001483 8916[166C]              	mov	[data_sectors+2], dx
  3646 00001487 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  3647 0000148A 30ED                    	xor	ch, ch
  3648 0000148C E8A7F9                  	call	div32 ; DX_AX/CX
  3649                                  	; DX_AX = Count of clusters (rounded down)
  3650 0000148F A3[186C]                	mov	[cluster_count], ax
  3651 00001492 8916[1A6C]              	mov	[cluster_count+2], dx
  3652                                  		
  3653 00001496 8D7E47                  	lea	di, [bp+71] ; [BS_VolLab]
  3654 00001499 E89E01                  	call	write_volume_name
  3655 0000149C 8D7643                  	lea	si, [bp+67] ; [BS_VolID]
  3656 0000149F E8F701                  	call	write_volume_serial
  3657 000014A2 E80703                  	call	write_cluster_count
  3658                                  
  3659 000014A5 E87802                  	call	write_formatting_msg
  3660 000014A8 B000                    	mov	al, 0
  3661 000014AA E8D002                  	call	write_format_percent_x
  3662                                  
  3663 000014AD 8B461C                  	mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  3664 000014B0 8B561E                  	mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  3665 000014B3 0106[106C]              	add	[data_start], ax
  3666 000014B7 1116[126C]              	adc	[data_start+2], dx
  3667                                  FAT32_f_3:
  3668                                  	; DX_AX = FAT32 Boot Sector address
  3669                                  	;mov	bx, TRDOS_FAT32_hd_bs
  3670 000014BB BB[8234]                	mov	bx, RD5_FAT32_hd_bs ; 04/05/2024
  3671                                  	; ES:BX = Boot Sector 1 Buffer
  3672 000014BE E88309                  	call	write_hd_sector
  3673 000014C1 0F82CC02                	jc	formatting_error
  3674 000014C5 E87C02                  	call	write_format_percent
  3675 000014C8 83C001                  	add	ax, 1
  3676 000014CB 83D200                  	adc	dx, 0
  3677 000014CE BB[0E68]                	mov	bx, HDFORMAT_FSINFO_BUFF
  3678                                  	; ES:BX = FS INFO Sector Buffer (= BS+1)
  3679 000014D1 E87009                  	call	write_hd_sector
  3680 000014D4 0F82B902                	jc	formatting_error
  3681 000014D8 E86902                  	call	write_format_percent
  3682 000014DB 83C001                  	add	ax, 1
  3683 000014DE 83D200                  	adc	dx, 0
  3684                                  	;mov	bx, TRDOS_FAT32_hd_bs + 512
  3685 000014E1 BB[8236]                	mov	bx, RD5_FAT32_hd_bs + 512 ; 04/05/2024
  3686                                  	; ES:BX = Boot Sector 2 Buffer
  3687 000014E4 E85D09                  	call	write_hd_sector
  3688 000014E7 0F82A602                	jc	formatting_error
  3689 000014EB E85602                  	call	write_format_percent
  3690 000014EE B90300                  	mov	cx, 3
  3691                                  FAT32_f_4:
  3692 000014F1 51                      	push	cx
  3693 000014F2 83C001                  	add	ax, 1
  3694 000014F5 83D200                  	adc	dx, 0
  3695 000014F8 BB[106A]                	mov	bx, HDFORMAT_EMPTY_BUFF
  3696 000014FB E84609                  	call	write_hd_sector
  3697 000014FE 0F828F02                	jc	formatting_error
  3698 00001502 E83F02                  	call	write_format_percent
  3699 00001505 59                      	pop	cx
  3700 00001506 FEC9                    	dec	cl
  3701 00001508 75E7                    	jnz	short FAT32_f_4
  3702 0000150A 83C001                  	add	ax, 1
  3703 0000150D 83D200                  	adc	dx, 0
  3704 00001510 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  3705 00001513 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  3706 00001516 83C10C                  	add	cx, 12
  3707 00001519 83D300                  	adc	bx, 0
  3708                                  	; write BACKUP sectors
  3709                                  	; (6,7,8 boot+fsi and 9,10,11 empty sectors)
  3710 0000151C 39DA                    	cmp	dx, bx
  3711 0000151E 729B                    	jb	short FAT32_f_3
  3712 00001520 39C8                    	cmp	ax, cx
  3713 00001522 7297                    	jb	short FAT32_f_3
  3714                                  	; write remain part of reserved sectors
  3715 00001524 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt]
  3716 00001527 83E90C                  	sub	cx, 12
  3717 0000152A 7618                    	jna	short FAT32_f_6
  3718                                  FAT32_f_5:
  3719 0000152C 51                      	push	cx
  3720 0000152D BB[106A]                	mov	bx, HDFORMAT_EMPTY_BUFF
  3721 00001530 E81109                  	call	write_hd_sector
  3722 00001533 0F825A02                	jc	formatting_error
  3723 00001537 E80A02                  	call	write_format_percent
  3724 0000153A 83C001                  	add	ax, 1
  3725 0000153D 83D200                  	adc	dx, 0
  3726 00001540 59                      	pop	cx
  3727 00001541 49                      	dec	cx
  3728 00001542 75E8                    	jnz	short FAT32_f_5
  3729                                  FAT32_f_6:
  3730                                  	; write FAT sectors
  3731 00001544 8B0E[106C]              	mov	cx, [data_start] ; lba/abs addr
  3732 00001548 8B1E[126C]              	mov	bx, [data_start+2] ; lba/abs addr
  3733 0000154C 53                      	push	bx
  3734 0000154D 51                      	push	cx
  3735 0000154E BB[106A]                	mov	bx, HDFORMAT_FATBUFFER
  3736                                  	; ES:BX = FAT Sector Buffer
  3737 00001551 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  3738 00001554 B5FF                    	mov	ch, 0FFh
  3739 00001556 890F                    	mov	[bx], cx
  3740 00001558 88E9                    	mov	cl, ch ; cx = 0FFFFh
  3741 0000155A 894F02                  	mov	[bx+2], cx
  3742 0000155D 894F04                  	mov	[bx+4], cx
  3743 00001560 894F06                  	mov	[bx+6], cx
  3744                                  	; Root dir cluster number = 2
  3745                                  	; 0FFFFFFFh = end of cluster chain
  3746 00001563 894F08                  	mov	[bx+8], cx  ; 0FFFFh
  3747 00001566 80E50F                  	and	ch, 0Fh
  3748 00001569 894F0A                  	mov	[bx+10], cx ; 0FFFh
  3749                                  	;inc	cx
  3750 0000156C E8D508                  	call	write_hd_sector
  3751 0000156F 0F821E02                	jc	formatting_error
  3752 00001573 E8CE01                  	call	write_format_percent
  3753                                  	;mov	bx, HDFORMAT_FATBUFFER
  3754 00001576 B90000                  	mov	cx, 0
  3755 00001579 890F                    	mov	[bx], cx
  3756 0000157B 894F02                  	mov	[bx+2], cx
  3757 0000157E 894F04                  	mov	[bx+4], cx
  3758 00001581 894F06                  	mov	[bx+6], cx
  3759 00001584 894F08                  	mov	[bx+8], cx
  3760 00001587 894F0A                  	mov	[bx+10], cx
  3761 0000158A EB0F                    	jmp	short FAT32_f_8
  3762                                  FAT32_f_7:	
  3763 0000158C 53                      	push	bx
  3764 0000158D 51                      	push	cx
  3765 0000158E BB[106A]                	mov	bx, HDFORMAT_FATBUFFER
  3766 00001591 E8B008                  	call	write_hd_sector
  3767 00001594 0F82F901                	jc	formatting_error
  3768 00001598 E8A901                  	call	write_format_percent
  3769                                  FAT32_f_8:	
  3770 0000159B 59                      	pop	cx
  3771 0000159C 5B                      	pop	bx
  3772 0000159D 83C001                  	add	ax, 1
  3773 000015A0 83D200                  	adc	dx, 0
  3774 000015A3 39DA                    	cmp	dx, bx
  3775 000015A5 72E5                    	jb	short FAT32_f_7
  3776 000015A7 39C8                    	cmp	ax, cx
  3777 000015A9 72E1                    	jb	short FAT32_f_7
  3778                                  
  3779                                  	; write	root directory (1st cluster)
  3780                                  	; as empty sectors
  3781 000015AB 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  3782 000015AE 30ED                    	xor	ch, ch
  3783 000015B0 290E[146C]              	sub	[data_sectors], cx
  3784 000015B4 831E[166C]00            	sbb	word [data_sectors+2], 0
  3785                                  FAT32_f_9:
  3786 000015B9 51                      	push	cx
  3787 000015BA BB[106A]                	mov	bx, HDFORMAT_EMPTY_BUFF
  3788 000015BD E88408                  	call	write_hd_sector
  3789 000015C0 0F82CD01                	jc	formatting_error
  3790 000015C4 E87D01                  	call	write_format_percent
  3791 000015C7 83C001                  	add	ax, 1
  3792 000015CA 83D200                  	adc	dx, 0
  3793 000015CD 59                      	pop	cx
  3794 000015CE FEC9                    	dec	cl
  3795 000015D0 75E7                    	jnz	short FAT32_f_9
  3796                                  
  3797                                  	; write DATA sectors 
  3798                                  	; (after root directory 1st cluster)
  3799 000015D2 8B0E[146C]              	mov	cx, [data_sectors]
  3800 000015D6 8B1E[166C]              	mov	bx, [data_sectors+2] 
  3801                                  			; NOTE: Partition size must be >= 512 MB
  3802                                  			;	for FAT32 FS  ((BX >= 15))
  3803                                  FAT32_f_10:	
  3804 000015DA 53                      	push	bx
  3805 000015DB 51                      	push	cx
  3806 000015DC BB[0E66]                	mov	bx, HDFORMAT_SECBUFFER
  3807 000015DF E86208                  	call	write_hd_sector
  3808 000015E2 0F82AB01                	jc	formatting_error
  3809 000015E6 E85B01                  	call	write_format_percent
  3810 000015E9 59                      	pop	cx
  3811 000015EA 5B                      	pop	bx
  3812 000015EB 83C001                  	add	ax, 1
  3813 000015EE 83D200                  	adc	dx, 0
  3814 000015F1 49                      	dec	cx
  3815 000015F2 75E6                    	jnz	short FAT32_f_10
  3816 000015F4 4B                      	dec	bx
  3817 000015F5 75E3                    	jnz	short FAT32_f_10
  3818                                  
  3819                                  	; If there are, format remain sectors which are
  3820                                  	; at beyond of data clusters, with zero bytes.
  3821                                  	
  3822 000015F7 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  3823 000015FA 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  3824                                  FAT16_f_18:	
  3825 000015FD 034E20                  	add	cx, [bp+20h]	; [BPB_TotSec32]
  3826 00001600 135E22                  	adc	bx, [bp+22h]	; [BPB_TotSec32+2]
  3827                                  FAT16_f_19:
  3828                                  FAT12_f_8:
  3829                                  	; are there remain sectors (in partition) ?
  3830 00001603 29C1                    	sub	cx, ax
  3831 00001605 19D3                    	sbb	bx, dx
  3832                                  	; 11/02/2019
  3833                                  	; BX must be 0 (Because, 1 cluster <= 32KB. So, 
  3834                                  	;	        remain sectors must not be more than 32K)
  3835 00001607 751C                    	jnz	short FAT32_f_12 ; There is a wrong thing !!!
  3836                                  				 ; If BX is not zero,	
  3837                                  				 ; it is better to skip this stage...)
  3838 00001609 09C9                    	or	cx, cx		
  3839 0000160B 7418                    	jz	short FAT32_f_12 ; no.. 
  3840                                  				 ; (good! FAT contains all data sectors)
  3841                                  FAT32_f_11:
  3842 0000160D 51                      	push	cx
  3843 0000160E BB[106A]                	mov	bx, HDFORMAT_EMPTY_BUFF
  3844 00001611 E83008                  	call	write_hd_sector
  3845 00001614 0F827901                	jc	formatting_error
  3846 00001618 E82901                  	call	write_format_percent
  3847 0000161B 59                      	pop	cx
  3848 0000161C 83C001                  	add	ax, 1
  3849 0000161F 83D200                  	adc	dx, 0
  3850 00001622 49                      	dec	cx
  3851 00001623 75E8                    	jnz	short FAT32_f_11
  3852                                  
  3853                                  FAT32_f_12:
  3854                                  SINGLIX_fs1_f_12:
  3855                                  	; End of FAT format routine...
  3856                                  end_of_formatting:
  3857 00001625 B064                    	mov	al, 100
  3858 00001627 E85301                  	call	write_format_percent_x
  3859                                  	;mov	si, CRLF
  3860                                  	;call	print_msg
  3861 0000162A BE[4F56]                	mov	si, Msg_OK
  3862 0000162D E80508                  	call	print_msg
  3863 00001630 E915FD                  	jmp	Exit
  3864                                  
  3865                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3866                                  ; set & write volume name
  3867                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3868                                  
  3869                                  write_fs_volume_name:
  3870 00001633 C606[F765]40            	mov	byte [vname_length], 64
  3871 00001638 EB05                    	jmp	short svn_fs
  3872                                  
  3873                                  write_volume_name:
  3874 0000163A C606[F765]0B            	mov	byte [vname_length], 11
  3875                                  svn_fs:
  3876                                  	; DI = (BS) Volume Label address
  3877 0000163F BE[F155]                	mov	si, Msg_Volume_Name
  3878 00001642 E8F007                  	call	print_msg
  3879                                  
  3880                                  	; get cursor position
  3881                                  	; bh = 0  ; video page
  3882 00001645 B403                    	mov     ah, 3 ; get cursor pos
  3883 00001647 CD10                    	int     10h
  3884 00001649 8916[9755]              	mov	[Cursor_Pos], dx
  3885                                  
  3886 0000164D E89B08                  	call	rw_char
  3887 00001650 7207                    	jc	short svn_1
  3888                                  svn_0:
  3889 00001652 AC                      	lodsb
  3890 00001653 3C20                    	cmp	al, 20h
  3891 00001655 7706                    	ja	short svn_2
  3892 00001657 74F9                    	je	short svn_0 
  3893                                  svn_1:
  3894 00001659 BE[0266]                	mov	si, no_name
  3895 0000165C AC                      	lodsb
  3896                                  svn_2:
  3897                                  	;mov	di, [bp+47h) ; [BS_VolLab] ; FAT32
  3898                                  	;mov	di, [bp+2Bh) ; [BS_VolLab] ; FAT16 (&FAT12)
  3899 0000165D 89FB                    	mov	bx, di ; *
  3900 0000165F 30ED                    	xor	ch, ch
  3901 00001661 8A0E[F765]              	mov	cl, [vname_length] ; 11
  3902 00001665 EB05                    	jmp	short svn_4
  3903                                  svn_3:
  3904 00001667 AC                      	lodsb
  3905 00001668 3C20                    	cmp	al, 20h
  3906 0000166A 7226                    	jb	short svn_6
  3907                                  svn_4:
  3908 0000166C AA                      	stosb
  3909 0000166D E2F8                    	loop	svn_3
  3910                                  svn_5:
  3911 0000166F 8A0E[F765]              	mov	cl, [vname_length] ; 11
  3912 00001673 89DE                    	mov	si, bx ; *
  3913 00001675 BF[B055]                	mov	di, StrVolumeName
  3914 00001678 F3A4                    	rep	movsb
  3915                                  	;mov	byte [di], 0
  3916                                  
  3917 0000167A 8B16[9755]              	mov	dx, [Cursor_Pos]
  3918 0000167E BB0700                  	mov	bx, 7
  3919 00001681 B402                    	mov	ah, 2
  3920 00001683 CD10                    	int	10h  ; Set Cursor Position
  3921                                  
  3922 00001685 BE[B055]                	mov	si, StrVolumeName
  3923 00001688 E8AA07                  	call	print_msg
  3924 0000168B BE[5356]                	mov	si, CRLF
  3925 0000168E E8A407                  	call	print_msg
  3926 00001691 C3                      	retn
  3927                                  svn_6:
  3928 00001692 B020                    	mov	al, 20h
  3929                                  svn_7:
  3930 00001694 AA                      	stosb
  3931 00001695 E2FD                    	loop	svn_7
  3932 00001697 EBD6                    	jmp	short svn_5
  3933                                  
  3934                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3935                                  ; set & write volume serial number (volume ID)
  3936                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3937                                  
  3938                                  write_volume_serial:
  3939                                  	; SI = (BS) Volume Serial Number (binary) address
  3940                                  
  3941                                  	;xor	ax, ax
  3942                                  	;int	1Ah			; get time of day
  3943                                  
  3944                                  	;mov	[si], dx
  3945                                  	;mov	[si+2], cx		; set unique volume ID
  3946                                  
  3947                                  	;mov	ah, 02h			; Return Current Time
  3948                                  	;int	1Ah
  3949                                  	;xchg	ch, cl
  3950                                  	;xchg	dh, dl
  3951                                  
  3952                                  	;add	cx, dx
  3953                                  	;add	[si+2], cx
  3954                                                 
  3955                                  	;mov	ah, 04h			; Return Current Date
  3956                                  	;int	1Ah
  3957                                  
  3958                                  	;xchg	ch,cl
  3959                                  	;xchg	dh,dl
  3960                                  
  3961                                  	;add	cx, dx
  3962                                  	;add	[si+2], cx
  3963                                  
  3964                                  	; According to Microsoft DOS 6.0 serial number
  3965                                  	; production method...
  3966                                  	; < Create unique 32 bit serial number >
  3967                                  
  3968                                  	; Create_Serial_ID (MSDOS 6.0 Source code, MSFOR.ASM)
  3969                                  	; (20/04/1987)
  3970                                  	;
  3971                                  	;  Get date (INT 21h, AH=2Bh)
  3972                                  	;  Get time (INT 21h, AH=2Ch)
  3973                                  	;  Serial_ID+0 = DX reg date + DX reg time
  3974                                  	;  Serial_ID+2 = CX reg date + CX reg time
  3975                                  	;  Serial_Num_Low = Serial_ID+2
  3976                                  	;  Serial_Num_High = Serial_ID+0
  3977                                  
  3978 00001699 B404                    	mov	ah, 04h		; Return Current Date
  3979 0000169B CD1A                    	int	1Ah
  3980                                  
  3981                                  	; DL = Day (BCD)	(20h)
  3982                                  	; DH = Month (BCD)	(12h)
  3983                                  	; CH = Century (BCD)	(20h)
  3984                                  	; CL = Year (BCD) 	(17h)
  3985                                  
  3986 0000169D 88D0                    	mov	al, dl
  3987 0000169F E87100                  	call	bcd_to_bin
  3988 000016A2 88C2                    	mov	dl, al
  3989 000016A4 88F0                    	mov	al, dh
  3990 000016A6 E86A00                  	call	bcd_to_bin
  3991 000016A9 88C6                    	mov	dh, al
  3992 000016AB 88C8                    	mov	al, cl
  3993 000016AD E86300                  	call	bcd_to_bin
  3994 000016B0 88C1                    	mov	cl, al
  3995 000016B2 88E8                    	mov	al, ch
  3996 000016B4 E85C00                  	call	bcd_to_bin
  3997 000016B7 88C5                    	mov	ch, al
  3998                                  
  3999                                  	; DH = Month (1-10)
  4000                                  	; DL = Day (1-31)
  4001                                  	; CX = Year (1900-2099)
  4002                                  
  4003 000016B9 52                      	push	dx 
  4004 000016BA 51                      	push	cx
  4005                                  
  4006 000016BB B402                    	mov	ah, 02h		; Return Current Time
  4007 000016BD CD1A                    	int	1Ah
  4008                                  	
  4009                                  	; DH = Seconds (BCD)	(59h)
  4010                                  	; CL = Minutes (BCD)	(59h)
  4011                                  	; CH = Hours (BCD)	(23h)
  4012                                  	; DL = Daylight savings time option (1=yes)
  4013                                  
  4014 000016BF 88F0                    	mov	al, dh
  4015 000016C1 E84F00                  	call	bcd_to_bin
  4016 000016C4 88C6                    	mov	dh, al
  4017 000016C6 88C8                    	mov	al, cl
  4018 000016C8 E84800                  	call	bcd_to_bin
  4019 000016CB 88C1                    	mov	cl, al
  4020 000016CD 88E8                    	mov	al, ch
  4021 000016CF E84100                  	call	bcd_to_bin
  4022 000016D2 88C5                    	mov	ch, al
  4023                                  
  4024                                  	; CH = Hour (0-23)
  4025                                  	; CL = Minutes (0-59)
  4026                                  	; DH = Seconds (0-59)
  4027                                  	; ((DL = Hundredths (0-99) - MSDOS!))
  4028                                  	; DL = 0 or 1 (here!)
  4029                                  
  4030 000016D4 89C8                    	mov	ax, cx
  4031 000016D6 59                      	pop	cx
  4032 000016D7 01C8                    	add	ax, cx
  4033                                  
  4034 000016D9 894402                  	mov	[si+2], ax
  4035                                  
  4036 000016DC 89D0                    	mov	ax, dx
  4037 000016DE 5A                      	pop	dx
  4038 000016DF 01D0                    	add	ax, dx
  4039                                  
  4040 000016E1 8904                    	mov	[si], ax
  4041                                  
  4042 000016E3 30E4                    	xor	ah, ah		; Read time counter
  4043 000016E5 CD1A                    	int	1Ah
  4044                                  
  4045                                  	; CX = High word of clock count
  4046                                  	; DX = Low word of clock count
  4047                                  	; AL = 0 if 24 hours has not passed, else 1
  4048                                  
  4049                                  	; NOTES: 
  4050                                  	; (Ref: vitaly_filatov.tripod.com/ng/asm/asm_029.1.html)
  4051                                  	;
  4052                                     	; Following formulas convert the clock count to
  4053                                          ; the time of day:
  4054                                   	;	Hour      = Clock / 65543 (1007h)
  4055                                  	;	Remainder = Clock MOD 65543
  4056                                   	;
  4057                                  	;	Minutes   = Remainder / 1092 (444h)
  4058                                  	;	Remainder = Remainder MOD 1092
  4059                                  	;
  4060                                  	;	Second    = Remainder / 18.21
  4061                                  	;	Remainder = Remainder MOD 18.21
  4062                                  	;
  4063                                  	;	Hundredths = CINT(Remainder * 100)
  4064                                  
  4065 000016E7 0014                    	add	[si], dl
  4066                                  
  4067                                  	; SI = Volume serial number address (4 bytes)
  4068 000016E9 8A04                    	mov	al, [si]
  4069 000016EB E8E607                  	call	bin_to_hex
  4070 000016EE A3[1C56]                	mov	[Vol_Serial2+2], ax
  4071 000016F1 8A4401                  	mov	al, [si+1]
  4072 000016F4 E8DD07                  	call	bin_to_hex
  4073 000016F7 A3[1A56]                	mov	[Vol_Serial2], ax
  4074 000016FA 8A4402                  	mov	al, [si+2]
  4075 000016FD E8D407                  	call	bin_to_hex
  4076 00001700 A3[1756]                	mov	[Vol_Serial1+2], ax
  4077 00001703 8A4403                  	mov	al, [si+3]
  4078 00001706 E8CB07                  	call	bin_to_hex
  4079 00001709 A3[1556]                	mov	[Vol_Serial1], ax
  4080                                  
  4081 0000170C BE[0356]                	mov	si, Msg_Volume_Serial
  4082 0000170F E82307                  	call	print_msg
  4083                                  
  4084 00001712 C3                      	retn
  4085                                  
  4086                                  bcd_to_bin:
  4087 00001713 53                      	push	bx
  4088 00001714 D410                    	db	0D4h,10h  ; Undocumented inst. AAM
  4089                                  			  ; AH = AL / 10h
  4090                                  			  ; AL = AL MOD 10h
  4091 00001716 88C3                    	mov	bl, al
  4092 00001718 B00A                    	mov	al, 10
  4093 0000171A F6E4                    	mul	ah
  4094 0000171C 00D8                    	add	al, bl
  4095 0000171E 5B                      	pop	bx
  4096 0000171F C3                      	retn
  4097                                  
  4098                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4099                                  ; write formatting percentage
  4100                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4101                                  
  4102                                  write_formatting_msg:
  4103                                  	;mov	ax, [pp_Sectors]
  4104                                  	;mov	dx, [pp_Sectors+2]
  4105                                  	; 16/02/2019
  4106 00001720 A1[CC6E]                	mov	ax, [ppn_Sectors]
  4107 00001723 8B16[CE6E]              	mov	dx, [ppn_Sectors+2]
  4108                                  
  4109                                  	; DX_AX = Total sectors for percentage
  4110 00001727 B96400                  	mov	cx, 100	
  4111 0000172A E809F7                  	call	div32
  4112 0000172D A3[1E6C]                	mov	[format_percent], ax
  4113                                  
  4114 00001730 BE[3B56]                	mov	si, msg_formatting
  4115 00001733 E8FF06                  	call	print_msg
  4116                                  
  4117                                  	; get cursor position
  4118                                  	; bh = 0  ; video page
  4119 00001736 B403                    	mov     ah, 3 ; get cursor pos
  4120 00001738 CD10                    	int     10h
  4121 0000173A 8916[9755]              	mov	[Cursor_Pos], dx
  4122                                  
  4123 0000173E C606[206C]FF            	mov	byte [prev_percent], 255
  4124                                  
  4125 00001743 C3                      	retn
  4126                                  
  4127                                  write_format_percent:
  4128                                  	; DX_AX = Current sector (which has been written)
  4129                                  
  4130 00001744 50                      	push	ax
  4131 00001745 52                      	push	dx
  4132 00001746 53                      	push	bx
  4133 00001747 51                      	push	cx
  4134 00001748 56                      	push	si
  4135                                  
  4136 00001749 2B461C                  	sub	ax, [bp+1Ch]	; [BPB_HiddSec]
  4137 0000174C 1B561E                  	sbb	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  4138                                  wpc_t:
  4139 0000174F 8B0E[1E6C]              	mov	cx, [format_percent]
  4140 00001753 E8E0F6                  	call	div32
  4141                                  	; AL = percentage value between 1 to 100
  4142                                  wpc_x:
  4143 00001756 3A06[206C]              	cmp	al, [prev_percent]
  4144 0000175A 741B                    	je	short wpc_y
  4145 0000175C A2[206C]                	mov	[prev_percent], al
  4146 0000175F 8B16[9755]              	mov	dx, [Cursor_Pos]
  4147 00001763 BB0700                  	mov	bx, 7
  4148 00001766 B402                    	mov	ah, 2
  4149 00001768 CD10                    	int	10h  ; Set Cursor Position
  4150 0000176A 31D2                    	xor	dx, dx
  4151 0000176C 30E4                    	xor	ah, ah
  4152                                  	;mov	al, [prev_percent]
  4153 0000176E BE[4956]                	mov	si, format_percent_str + 2
  4154 00001771 E84907                  	call	bin_to_decimal
  4155 00001774 E8BE06                  	call	print_msg
  4156                                  wpc_y:
  4157 00001777 5E                      	pop	si
  4158 00001778 59                      	pop	cx
  4159 00001779 5B                      	pop	bx
  4160 0000177A 5A                      	pop	dx
  4161 0000177B 58                      	pop	ax
  4162 0000177C C3                      	retn
  4163                                  
  4164                                  write_format_percent_x:
  4165                                  	; AL = % number
  4166                                  
  4167 0000177D 50                      	push	ax
  4168 0000177E 52                      	push	dx
  4169 0000177F 53                      	push	bx
  4170 00001780 51                      	push	cx
  4171 00001781 56                      	push	si
  4172                                  
  4173 00001782 EBD2                    	jmp	short wpc_x
  4174                                  
  4175                                  write_fs_format_percent:
  4176                                  	; DX_AX = Current sector (which has been written)
  4177                                  
  4178 00001784 50                      	push	ax
  4179 00001785 52                      	push	dx
  4180 00001786 53                      	push	bx
  4181 00001787 51                      	push	cx
  4182 00001788 56                      	push	si
  4183                                  
  4184 00001789 2B460C                  	sub	ax, [bp+0Ch]	; [bsBeginSector]
  4185 0000178C 1B560E                  	sbb	dx, [bp+0Eh]	; [bsBeginSector+2]
  4186 0000178F EBBE                    	jmp	short wpc_t
  4187                                  	
  4188                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4189                                  ; format error 
  4190                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4191                                  
  4192                                  formatting_error:
  4193 00001791 8B26[0E6A]              	mov	sp, [old_sp]
  4194                                  
  4195 00001795 88E0                    	mov	al, ah ;  error code
  4196 00001797 E83A07                  	call	bin_to_hex
  4197 0000179A A3[6156]                	mov 	[error_code], ax
  4198                                  
  4199 0000179D BE[5356]                	mov	si, CRLF
  4200 000017A0 E89206                  	call	print_msg
  4201                                  
  4202 000017A3 BE[5656]                	mov	si, Msg_Error
  4203 000017A6 E88C06                  	call	print_msg
  4204 000017A9 E99CFB                  	jmp	Exit
  4205                                  
  4206                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4207                                  ; write cluster count
  4208                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4209                                  
  4210                                  write_cluster_count:
  4211 000017AC BE[2156]                	mov	si, msg_cluster_count
  4212 000017AF E88306                  	call	print_msg
  4213 000017B2 A1[186C]                	mov	ax, [cluster_count]
  4214 000017B5 8B16[1A6C]              	mov	dx, [cluster_count+2]
  4215 000017B9 BE[3756]                	mov	si, cluster_count_str+6
  4216 000017BC E8FE06                  	call	bin_to_decimal
  4217 000017BF E87306                  	call	print_msg
  4218 000017C2 C3                      	retn 
  4219                                  
  4220                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4221                                  ; FAT16 FORMATTING
  4222                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4223                                  	; 08/02/2019 (Modified for -only- FAT16 CHS partitions)
  4224                                  FAT16_hdi_format:
  4225 000017C3 B80607                  	mov	ax, 0706h ; db 06h, 07h ; 'push es, pop es'
  4226 000017C6 38C2                    	cmp	dl, al ; 06h ; Big CHS partition (>= 32MB)
  4227 000017C8 7403                    	je	short FAT16_big_chs_format
  4228                                  	;mov	ax, 070Eh ; db 0Eh, 07h	; 'push cs, pop es'
  4229                                  	;cmp	dl, al ; 0Eh ; LBA partition
  4230                                  	;je	short FAT16_lba_format
  4231                                  FAT16_chs_format:  
  4232                                  	; Partition Type: 04h, CHS (<32 MB) partition
  4233 000017CA B80400                  	mov	ax, 0004h ; db 04h, 00h ; 'add al, 0'
  4234                                  FAT16_big_chs_format:
  4235                                  ;FAT16_lba_format:
  4236                                  	; Put TRDOS 386 FAT16 partition magic word 
  4237                                  	; at offset 3Eh, in TRDOS386 FAT16 boot sector.
  4238                                  	;mov	bp, TRDOS_FAT16_hd_bs
  4239 000017CD BD[8238]                	mov	bp, RD5_FAT16_hd_bs ; 04/05/2024
  4240 000017D0 8D7E03                  	lea	di, [bp+3]
  4241 000017D3 BE[F865]                	mov	si, bs_oem_name
  4242 000017D6 B90400                  	mov	cx, 4
  4243 000017D9 F3A5                    	rep	movsw 
  4244 000017DB 89463E                  	mov	[bp+3Eh], ax	; [loc_3E]
  4245                                  
  4246 000017DE A1[9640]                	mov	ax, [sectors]
  4247 000017E1 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  4248 000017E4 A1[9840]                	mov	ax, [heads]
  4249 000017E7 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  4250 000017EA A1[986E]                	mov	ax, [pp_StartSector]
  4251 000017ED 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  4252 000017F0 A1[9A6E]                	mov	ax, [pp_StartSector+2]
  4253 000017F3 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  4254                                  	;mov	ax, [pp_Sectors]
  4255 000017F6 A1[CC6E]                	mov	ax, [ppn_Sectors] ; 16/02/2019
  4256                                  	;mov	dx, [pp_Sectors+2]
  4257 000017F9 8B16[CE6E]              	mov	dx, [ppn_Sectors+2] ; 16/02/2019
  4258 000017FD 21D2                    	and	dx, dx
  4259 000017FF 7505                    	jnz	short FAT16_f_0
  4260 00001801 894613                  	mov	[bp+13h], ax	; [BPB_TotSec16]
  4261                                  	; CX = 0
  4262                                  	;mov	[bp+20h], cx	; [BPB_TotSec32] =  0
  4263                                  	;mov	[bp+22h], cx	; [BPB_TotSec32+2] = 0
  4264 00001804 EB06                    	jmp	short FAT16_f_1
  4265                                  FAT16_f_0:
  4266 00001806 894620                  	mov	[bp+20h], ax	; [BPB_TotSec32]
  4267                                  	;;mov	dx, [pp_Sectors+2]
  4268                                  	;mov	dx, [ppn_Sectors+2] ; 16/02/2019 
  4269 00001809 895622                  	mov	[bp+22h], dx	; [BPB_TotSec32+2]
  4270                                  	; CX = 0
  4271                                  	;mov	[bp+13h], cx ; [BPB_TotSec16] = 0
  4272                                  FAT16_f_1:
  4273                                  	; Sectors per cluster calculation
  4274                                  	; (According to MS FAT32 FS specification.)
  4275 0000180C B102                    	mov	cl, 2  ; 2 sectors per cluster
  4276 0000180E 09D2                    	or	dx, dx
  4277 00001810 7507                    	jnz	short FAT16_f_2 ; >2 sectors (>16MB)
  4278 00001812 3DA87F                  	cmp	ax, 32680
  4279 00001815 763C                    	jna	short FAT16_f_10 ; 2 sectors, <=16MB
  4280                                  	; > 16MB
  4281 00001817 EB38                    	jmp	short FAT16_f_9 ; 4 sectors per cluster
  4282                                  FAT16_f_2:
  4283 00001819 83FA04                  	cmp	dx, 4  ; >= 262144 sectors ; >=128MB
  4284 0000181C 7708                    	ja	short FAT16_f_3 ; >4 sectors per cluster
  4285 0000181E 7231                    	jb	short FAT16_f_9 ; 4 sectors per cluster
  4286 00001820 09C0                    	or	ax, ax ; dx_ax = (4*65536)+0
  4287 00001822 742D                    	jz	short FAT16_f_9 ; 4 sectors per cluster
  4288 00001824 EB29                    	jmp	short FAT16_f_8 ; 8 sectors per cluster
  4289                                  FAT16_f_3:
  4290 00001826 83FA08                  	cmp	dx, 8  ; >= 524288 sectors ; >=256MB
  4291 00001829 7708                    	ja	short FAT16_f_4 ; >8 sectors per cluster
  4292 0000182B 7222                    	jb	short FAT16_f_8 ; 8 sectors per cluster
  4293 0000182D 21C0                    	and	ax, ax ; dx_ax = (8*65536)+0
  4294 0000182F 741E                    	jz	short FAT16_f_8 ; 8 sectors per cluster
  4295 00001831 EB1A                    	jmp	short FAT16_f_7 ; 16 sectors per cluster
  4296                                  FAT16_f_4:
  4297 00001833 83FA10                  	cmp	dx, 16 ; >= 1048576 sectors ; >=512MB
  4298 00001836 7708                    	ja	short FAT16_f_5 ; >16 sectors per cluster
  4299 00001838 7213                    	jb	short FAT16_f_7 ; 16 sectors per cluster
  4300 0000183A 21C0                    	and	ax, ax ; dx_ax = (16*65536)+0
  4301 0000183C 740F                    	jz	short FAT16_f_7 ; 16 sectors per cluster
  4302 0000183E EB0B                    	jmp	short FAT16_f_6 ; 32 sectors per cluster
  4303                                  FAT16_f_5:
  4304 00001840 83FA20                  	cmp	dx, 32 ; >= 2097152 sectors ; >=1GB
  4305 00001843 7206                    	jb	short FAT16_f_6 ; 32 sectors per cluster
  4306 00001845 09C0                    	or	ax, ax		; dx_ax = (32*65536)+0
  4307 00001847 7402                    	jz	short FAT16_f_6 ; 32 sectors per cluster
  4308                                  	; >1GB (<=2GB)
  4309                                  	; 64 sectors per cluster
  4310 00001849 D0E1                    	shl	cl, 1
  4311                                  FAT16_f_6:
  4312                                  	; 32 sectors per cluster (for <= 2GB volumes)
  4313 0000184B D0E1                    	shl	cl, 1
  4314                                  FAT16_f_7:
  4315                                  	; 16 sectors per cluster (for <= 1GB volumes)
  4316 0000184D D0E1                    	shl	cl, 1
  4317                                  FAT16_f_8:
  4318                                  	; 8 sectors per cluster (for <= 512MB volumes)
  4319 0000184F D0E1                    	shl	cl, 1
  4320                                  FAT16_f_9:
  4321                                  	; 4 sectors per cluster (for <= 256MB volumes)
  4322 00001851 D0E1                    	shl	cl, 1
  4323                                  FAT16_f_10:	
  4324                                  	; 2 sectors per cluster (for <= 128MB volumes)
  4325 00001853 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  4326                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  4327                                  	;mov	word [bp+0Eh], 1 ; [BPB_RsvdSecCnt] 
  4328                                  	;mov	word [bp+11h], 512 ; [BPB_RootEntCnt]
  4329                                  	
  4330                                  	; Calculating FAT size in sectors
  4331                                  	; (According to MS FAT32 FS Specification, 2000)
  4332                                  
  4333                                  	; DX_AX = partition (volume) size in sectors
  4334 00001856 8B5E11                  	mov	bx, [bp+11h]	; [BPB_RootEntCnt] = 512
  4335 00001859 83C30F                  	add	bx, 15 ; bx = 527
  4336 0000185C C1EB04                  	shr	bx, 4 ; /16 = 527/16 = 32
  4337                                  		; ((32*BX)+511)/512
  4338 0000185F 891E[1C6C]              	mov	[root_dir_secs], bx
  4339 00001863 035E0E                  	add	bx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4340 00001866 29D8                    	sub	ax, bx
  4341 00001868 83DA00                  	sbb	dx, 0
  4342                                  		; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  4343                                  		;	     		RootDirsectors)
  4344                                  	;mov	bx, cx ; ch = 0
  4345                                  	;shl	bx, 8 ; * 256
  4346                                  	; 11/02/2019
  4347 0000186B 88CF                    	mov	bh, cl
  4348 0000186D 30DB                    	xor	bl, bl
  4349 0000186F B102                    	mov	cl, 2 ; [BPB_NumFATs]
  4350 00001871 01CB                    	add	bx, cx	
  4351                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  4352 00001873 89D9                    	mov	cx, bx
  4353 00001875 4B                      	dec	bx  ; TmpVal2-1
  4354 00001876 01D8                    	add	ax, bx
  4355 00001878 83D200                  	adc	dx, 0
  4356 0000187B E8B8F5                  	call	div32
  4357                                  		; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  4358                                  	; AX = FAT size in sectors
  4359                                  	; DX = 0
  4360 0000187E 894616                  	mov	[bp+16h], ax	; [BPB_FATSz16]
  4361                                  	; * 2
  4362 00001881 D1E0                    	shl	ax, 1
  4363                                  	; AX = [BPB_NumFATs] * [BPB_FATSz16]
  4364 00001883 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4365 00001886 01C1                    	add	cx, ax
  4366                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4367 00001888 030E[1C6C]              	add	cx, [root_dir_secs] ; + RootDirsectors
  4368 0000188C 29DB                    	sub	bx, bx ; BX = 0
  4369                                  	; BX_CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4370                                  	;	  + RootDirSectors
  4371 0000188E 8B4613                  	mov	ax, [bp+13h]	; [BPB_TotSec16]
  4372                                  	;sub	dx, dx 
  4373                                  	; DX = 0
  4374 00001891 21C0                    	and	ax, ax
  4375 00001893 7506                    	jnz	short FAT16_f_11
  4376 00001895 8B4620                  	mov	ax, [bp+20h]	; [BPB_TotSec32]
  4377 00001898 8B5622                  	mov	dx, [bp+22h]	; [BPB_TotSec32+2]
  4378                                  FAT16_f_11:
  4379 0000189B 29C8                    	sub	ax, cx
  4380 0000189D 19DA                    	sbb	dx, bx
  4381 0000189F 890E[106C]              	mov	[data_start], cx
  4382 000018A3 891E[126C]              	mov	[data_start+2], bx
  4383                                  	; DX_AX = Data sectors
  4384 000018A7 A3[146C]                	mov	[data_sectors], ax
  4385 000018AA 8916[166C]              	mov	[data_sectors+2], dx
  4386 000018AE 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  4387 000018B1 30ED                    	xor	ch, ch
  4388 000018B3 E880F5                  	call	div32 ; DX_AX/CX
  4389                                  	; AX = Count of clusters (rounded down)
  4390                                  	; DX = 0
  4391 000018B6 A3[186C]                	mov	[cluster_count], ax
  4392 000018B9 8916[1A6C]              	mov	[cluster_count+2], dx
  4393                                  
  4394 000018BD 8D7E2B                  	lea	di, [bp+43] ; [BS_VolLab]
  4395 000018C0 E877FD                  	call	write_volume_name
  4396 000018C3 8D7627                  	lea	si, [bp+39] ; [BS_VolID]
  4397 000018C6 E8D0FD                  	call	write_volume_serial
  4398 000018C9 E8E0FE                  	call	write_cluster_count
  4399                                  
  4400 000018CC E851FE                  	call	write_formatting_msg
  4401 000018CF B000                    	mov	al, 0
  4402 000018D1 E8A9FE                  	call	write_format_percent_x
  4403                                  
  4404 000018D4 8B461C                  	mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  4405 000018D7 8B561E                  	mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  4406                                  
  4407 000018DA 0106[106C]              	add	[data_start], ax
  4408 000018DE 1116[126C]              	adc	[data_start+2], dx
  4409                                  
  4410                                  	; DX_AX = FAT16 Boot Sector address
  4411                                  	;mov	bx, TRDOS_FAT16_hd_bs
  4412 000018E2 BB[8238]                	mov	bx, RD5_FAT16_hd_bs ; 04/05/2024
  4413                                  	; ES:BX = Boot Sector Buffer
  4414 000018E5 E85C05                  	call	write_hd_sector
  4415 000018E8 0F82A5FE                	jc	formatting_error
  4416 000018EC E855FE                  	call	write_format_percent
  4417 000018EF 83C001                  	add	ax, 1
  4418 000018F2 83D200                  	adc	dx, 0
  4419                                  	; write remain part of reserved sectors
  4420 000018F5 8B4E0E                  	mov	cx, [bp+0Eh] ; [BPB_RsvdSecCnt]
  4421                                  	;sub	cx, 1
  4422                                  	;jna	short FAT16_f_13
  4423                                  	; 11/02/2019
  4424 000018F8 49                      	dec	cx
  4425 000018F9 7418                    	jz	short FAT16_f_13
  4426                                  FAT16_f_12:
  4427 000018FB 51                      	push	cx
  4428 000018FC BB[106A]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4429 000018FF E84205                  	call	write_hd_sector
  4430 00001902 0F828BFE                	jc	formatting_error
  4431 00001906 E83BFE                  	call	write_format_percent
  4432 00001909 83C001                  	add	ax, 1
  4433 0000190C 83D200                  	adc	dx, 0
  4434 0000190F 59                      	pop	cx
  4435 00001910 49                      	dec	cx ; dec cl
  4436 00001911 75E8                    	jnz	short FAT16_f_12
  4437                                  FAT16_f_13:
  4438                                  	; write FAT sectors
  4439 00001913 8B0E[106C]              	mov	cx, [data_start] ; lba/abs addr
  4440 00001917 8B1E[126C]              	mov	bx, [data_start+2] ; lba/abs addr
  4441                                  
  4442                                  	; 11/02/2019
  4443 0000191B 2B0E[1C6C]              	sub	cx, [root_dir_secs]
  4444 0000191F 83DB00                  	sbb	bx, 0
  4445                                  
  4446 00001922 53                      	push	bx
  4447 00001923 51                      	push	cx
  4448 00001924 BB[106A]                	mov	bx, HDFORMAT_FATBUFFER
  4449                                  	; ES:BX = FAT Sector Buffer
  4450 00001927 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  4451 0000192A B5FF                    	mov	ch, 0FFh
  4452 0000192C 890F                    	mov	[bx], cx ; 0FFF8h
  4453 0000192E 88E9                    	mov	cl, ch ; cx = 0FFFFh
  4454 00001930 894F02                  	mov	[bx+2], cx
  4455                                  	;inc	cx
  4456 00001933 E80E05                  	call	write_hd_sector
  4457 00001936 0F8257FE                	jc	formatting_error
  4458 0000193A E807FE                  	call	write_format_percent
  4459                                  	;mov	bx, HDFORMAT_FATBUFFER
  4460 0000193D B90000                  	mov	cx, 0
  4461 00001940 890F                    	mov	[bx], cx
  4462 00001942 894F02                  	mov	[bx+2], cx
  4463 00001945 EB0F                    	jmp	short FAT16_f_15
  4464                                  FAT16_f_14:	
  4465 00001947 53                      	push	bx
  4466 00001948 51                      	push	cx
  4467 00001949 BB[106A]                	mov	bx, HDFORMAT_FATBUFFER
  4468 0000194C E8F504                  	call	write_hd_sector
  4469 0000194F 0F823EFE                	jc	formatting_error
  4470 00001953 E8EEFD                  	call	write_format_percent
  4471                                  FAT16_f_15:	
  4472 00001956 59                      	pop	cx
  4473 00001957 5B                      	pop	bx
  4474 00001958 83C001                  	add	ax, 1
  4475 0000195B 83D200                  	adc	dx, 0
  4476 0000195E 39DA                    	cmp	dx, bx
  4477 00001960 72E5                    	jb	short FAT16_f_14
  4478 00001962 39C8                    	cmp	ax, cx
  4479 00001964 72E1                    	jb	short FAT16_f_14
  4480                                  
  4481                                  	; write	root directory sectors
  4482                                  	; as empty sectors
  4483 00001966 8B0E[1C6C]              	mov	cx, [root_dir_secs]
  4484                                  FAT16_f_16:
  4485 0000196A 51                      	push	cx
  4486 0000196B BB[106A]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4487 0000196E E8D304                  	call	write_hd_sector
  4488 00001971 0F821CFE                	jc	formatting_error
  4489 00001975 E8CCFD                  	call	write_format_percent
  4490 00001978 83C001                  	add	ax, 1
  4491 0000197B 83D200                  	adc	dx, 0
  4492 0000197E 59                      	pop	cx
  4493 0000197F 49                      	dec	cx
  4494 00001980 75E8                    	jnz	short FAT16_f_16
  4495                                  
  4496                                  	; write DATA sectors 
  4497                                  	; (after root directory sectors)
  4498 00001982 8B0E[146C]              	mov	cx, [data_sectors]
  4499 00001986 8B1E[166C]              	mov	bx, [data_sectors+2]
  4500                                  	; 11/02/2019
  4501 0000198A 43                      	inc	bx ; 0 -> 1, 1-> 2
  4502                                  FAT16_f_17:	
  4503 0000198B 53                      	push	bx
  4504 0000198C 51                      	push	cx
  4505 0000198D BB[0E66]                	mov	bx, HDFORMAT_SECBUFFER
  4506 00001990 E8B104                  	call	write_hd_sector
  4507 00001993 0F82FAFD                	jc	formatting_error
  4508 00001997 E8AAFD                  	call	write_format_percent
  4509 0000199A 59                      	pop	cx
  4510 0000199B 5B                      	pop	bx
  4511 0000199C 83C001                  	add	ax, 1
  4512 0000199F 83D200                  	adc	dx, 0
  4513 000019A2 49                      	dec	cx
  4514 000019A3 75E6                    	jnz	short FAT16_f_17
  4515 000019A5 4B                      	dec	bx
  4516 000019A6 75E3                    	jnz	short FAT16_f_17
  4517                                  
  4518                                  	; If there are, format remain sectors which are
  4519                                  	; at beyond of data clusters, with zero bytes.
  4520                                  	
  4521 000019A8 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  4522 000019AB 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  4523                                  
  4524 000019AE 837E1300                	cmp	word [bp+13h], 0 ; [BPB_TotSec16]
  4525 000019B2 0F8447FC                	jz	FAT16_f_18
  4526 000019B6 034E13                  	add	cx, [bp+13h]	; [BPB_TotSec16]
  4527 000019B9 83D300                  	adc	bx, 0
  4528 000019BC E944FC                  	jmp	FAT16_f_19
  4529                                  
  4530                                  FAT12_hdi_format:
  4531                                  	;mov	bp, TRDOS_FAT12_hd_bs
  4532 000019BF BD[823A]                	mov	bp, RD5_FAT12_hd_bs ; 04/05/2024	
  4533 000019C2 8D7E03                  	lea	di, [bp+3]
  4534 000019C5 BE[F865]                	mov	si, bs_oem_name
  4535 000019C8 B90400                  	mov	cx, 4
  4536 000019CB F3A5                    	rep	movsw
  4537 000019CD A1[9640]                	mov	ax, [sectors]
  4538 000019D0 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  4539 000019D3 A1[9840]                	mov	ax, [heads]
  4540 000019D6 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  4541 000019D9 A1[986E]                	mov	ax, [pp_StartSector]
  4542 000019DC 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  4543 000019DF A1[9A6E]                	mov	ax, [pp_StartSector+2]
  4544 000019E2 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  4545                                  	;mov	ax, [pp_Sectors]
  4546 000019E5 A1[CC6E]                	mov	ax, [ppn_Sectors] ; 16/02/2019
  4547 000019E8 894613                  	mov	[bp+13h], ax	; [BPB_TotSec16]
  4548                                  
  4549                                  	; 11/02/2019
  4550 000019EB 31F6                    	xor	si, si ; reset (FAT size fix) flag
  4551 000019ED 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4552 000019F0 8B5611                  	mov	dx, [bp+11h]	; [BPB_RootEntCnt] = 512
  4553 000019F3 83C20F                  	add	dx, 15	; (16-1) (512-1)
  4554 000019F6 C1EA04                  	shr	dx, 4	; /16  (*32/512)
  4555                                  	; AX = Root dir sectors
  4556                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4557 000019F9 01D1                    	add	cx, dx ; + RootDirsectors ; + 32
  4558 000019FB 890E[1C6C]              	mov	[root_dir_secs], cx ; = 33
  4559                                  
  4560                                  	; 11/02/2019
  4561                                  	;sub	ax, 33  ; 1 reserved sector, 32 root dir sectors
  4562                                  			; .. now AX has number of data sectors
  4563                                  			;	 		+ 2* (FAT sectors)
  4564 000019FF 29C8                    	sub	ax, cx
  4565                                  FAT12_f_10:	; 11/02/2019
  4566                                  	; Sectors per cluster calculation
  4567                                  	; (According to MS FAT32 FS specification.)
  4568                                  	;mov	cx, 1  ; 1 sector per cluster
  4569 00001A01 B101                    	mov	cl, 1  ; CH = 0
  4570                                  FAT12_f_0:
  4571 00001A03 3DF50F                  	cmp	ax, 4085 ; Max. cluster count for FAT12
  4572 00001A06 7206                    	jb	short FAT12_f_1
  4573 00001A08 D0E1                    	shl	cl, 1 ; *2
  4574 00001A0A D1E8                    	shr	ax, 1 ; /2
  4575 00001A0C EBF5                    	jmp	short FAT12_f_0
  4576                                  FAT12_f_1:
  4577 00001A0E 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  4578                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  4579                                  	;mov	word [bp+0Eh], 1 ; [BPB_RsvdSecCnt] 
  4580                                  	;mov	word [bp+11h], 512 ; [BPB_RootEntCnt]
  4581                                  	
  4582                                  	; Calculating FAT size in sectors
  4583                                  	; AX = partition (volume) size in sectors
  4584                                  	; CX = sectors per clusters
  4585 00001A11 31D2                    	xor	dx, dx
  4586 00001A13 F7F1                    	div	cx
  4587                                  	; AX = cluster count (only for FAT size calc)
  4588                                  	; DX = 0
  4589 00001A15 83C002                  	add	ax, 2  ; cluster 2 to ...
  4590 00001A18 89C2                    	mov	dx, ax
  4591 00001A1A D1E2                    	shl	dx, 1
  4592 00001A1C 01D0                    	add	ax, dx ; *3
  4593 00001A1E D1E8                    	shr	ax, 1  ; /2
  4594 00001A20 83D000                  	adc	ax, 0  ; +0.5 -> +1
  4595                                  
  4596                                  	; AX = FAT bytes for 12 bit cluster numbers
  4597                                  	
  4598 00001A23 B90002                  	mov	cx, 512		; [BPB_BytesPerSec]
  4599 00001A26 01C8                    	add	ax, cx
  4600 00001A28 48                      	dec	ax		; [BPB_BytesPerSec] - 1
  4601 00001A29 29D2                    	sub	dx, dx
  4602 00001A2B F7F1                    	div	cx
  4603 00001A2D 894616                  	mov	[bp+16h], ax	; [BPB_FATSz16]
  4604                                  	; * 2
  4605 00001A30 D1E0                    	shl	ax, 1
  4606                                  	; AX = [BPB_NumFATs] * [BPB_FATSz16]
  4607                                  
  4608                                  	;mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4609                                  	;add	cx, ax
  4610                                  	;mov	ax, [bp+11h]	; [BPB_RootEntCnt] = 512
  4611                                  	;add	ax, 15	; (16-1) (512-1)
  4612                                  	;shr	ax, 4	; /16  (*32/512)
  4613                                  	;; AX = Root dir sectors
  4614                                  	;; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4615                                  	;add	cx, ax ; + RootDirsectors
  4616                                  	;mov	[root_dir_secs], ax
  4617                                  
  4618                                  	; 11/02/2019
  4619                                  	;mov	cx, 33
  4620 00001A32 8B0E[1C6C]              	mov	cx, [root_dir_secs]
  4621 00001A36 034E0E                  	add	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4622                                  		; cx = root directory sectors + reserved sectors
  4623 00001A39 01C1                    	add	cx, ax
  4624                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4625                                  	;	  + RootDirSectors
  4626 00001A3B 8B4613                  	mov	ax, [bp+13h]	; [BPB_TotSec16]
  4627 00001A3E 29C8                    	sub	ax, cx
  4628                                  		 ; AX = data sectors
  4629                                  		 ; cH = 0
  4630                                  
  4631                                  	; 11/02/2019 - fix FAT size (better method)
  4632 00001A40 09F6                    	or	si, si
  4633 00001A42 7504                    	jnz	short FAT12_f_9
  4634                                  
  4635 00001A44 89C6                    	mov	si, ax  ; ax = data sectors
  4636 00001A46 EBB9                    	jmp	short FAT12_f_10
  4637                                  
  4638                                  FAT12_f_9:
  4639 00001A48 31D2                    	xor	dx, dx
  4640 00001A4A 890E[106C]              	mov	[data_start], cx
  4641 00001A4E 8916[126C]              	mov	[data_start+2], dx ; 0
  4642                                  	; DX_AX = Data sectors
  4643 00001A52 A3[146C]                	mov	[data_sectors], ax
  4644 00001A55 8916[166C]              	mov	[data_sectors+2], dx ; 0
  4645 00001A59 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  4646 00001A5C 28ED                    	sub	ch, ch
  4647 00001A5E F7F1                    	div	cx
  4648                                  	; AX = Count of clusters (rounded down)
  4649 00001A60 29D2                    	sub	dx, dx ; 0
  4650 00001A62 A3[186C]                	mov	[cluster_count], ax
  4651 00001A65 8916[1A6C]              	mov	[cluster_count+2], dx ; 0
  4652                                  
  4653 00001A69 8D7E2B                  	lea	di, [bp+43] ; [BS_VolLab]
  4654 00001A6C E8CBFB                  	call	write_volume_name
  4655 00001A6F 8D7627                  	lea	si, [bp+39] ; [BS_VolID]
  4656 00001A72 E824FC                  	call	write_volume_serial
  4657 00001A75 E834FD                  	call	write_cluster_count
  4658                                  
  4659 00001A78 E8A5FC                  	call	write_formatting_msg
  4660 00001A7B B000                    	mov	al, 0
  4661 00001A7D E8FDFC                  	call	write_format_percent_x
  4662                                  
  4663 00001A80 8B461C                  	mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  4664 00001A83 8B561E                  	mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  4665                                  
  4666 00001A86 0106[106C]              	add	[data_start], ax
  4667 00001A8A 1116[126C]              	adc	[data_start+2], dx
  4668                                  
  4669                                  	; DX_AX = FAT12 Boot Sector address
  4670                                  	;mov	bx, TRDOS_FAT12_hd_bs
  4671 00001A8E BB[823A]                	mov	bx, RD5_FAT12_hd_bs ; 04/05/2024 
  4672                                  	; ES:BX = Boot Sector Buffer
  4673 00001A91 E8B003                  	call	write_hd_sector
  4674 00001A94 0F82F9FC                	jc	formatting_error
  4675 00001A98 E8A9FC                  	call	write_format_percent
  4676 00001A9B 83C001                  	add	ax, 1
  4677 00001A9E 83D200                  	adc	dx, 0
  4678                                  	; write remain part of reserved sectors
  4679 00001AA1 8B4E0E                  	mov	cx, [bp+0Eh] ; [BPB_RsvdSecCnt]
  4680                                  	;sub	cx, 1
  4681                                  	;jna	short FAT12_f_3
  4682                                  	; 11/02/2019
  4683 00001AA4 49                      	dec	cx
  4684 00001AA5 7418                    	jz	short FAT12_f_3
  4685                                  FAT12_f_2:
  4686 00001AA7 51                      	push	cx
  4687 00001AA8 BB[106A]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4688 00001AAB E89603                  	call	write_hd_sector
  4689 00001AAE 0F82DFFC                	jc	formatting_error
  4690 00001AB2 E88FFC                  	call	write_format_percent
  4691 00001AB5 83C001                  	add	ax, 1
  4692 00001AB8 83D200                  	adc	dx, 0
  4693 00001ABB 59                      	pop	cx
  4694 00001ABC 49                      	dec	cx ; dec cl
  4695 00001ABD 75E8                    	jnz	short FAT12_f_2
  4696                                  FAT12_f_3:
  4697                                  	; write FAT sectors
  4698 00001ABF 8B0E[106C]              	mov	cx, [data_start] ; lba/abs addr
  4699 00001AC3 8B1E[126C]              	mov	bx, [data_start+2] ; lba/abs addr
  4700                                  
  4701                                  	; 11/02/2019
  4702 00001AC7 2B0E[1C6C]              	sub	cx, [root_dir_secs]
  4703 00001ACB 83DB00                  	sbb	bx, 0
  4704                                  
  4705 00001ACE 53                      	push	bx
  4706 00001ACF 51                      	push	cx
  4707 00001AD0 BB[106A]                	mov	bx, HDFORMAT_FATBUFFER
  4708                                  	; ES:BX = FAT Sector Buffer
  4709 00001AD3 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  4710 00001AD6 B5FF                    	mov	ch, 0FFh
  4711 00001AD8 890F                    	mov	[bx], cx ; 0FFF8h
  4712 00001ADA 886F02                  	mov	[bx+2], ch ; 0FFFFF8h
  4713                                  	;xor	cx, cx
  4714 00001ADD E86403                  	call	write_hd_sector
  4715 00001AE0 0F82ADFC                	jc	formatting_error
  4716 00001AE4 E85DFC                  	call	write_format_percent
  4717                                  	;mov	bx, HDFORMAT_FATBUFFER
  4718 00001AE7 B90000                  	mov	cx, 0
  4719 00001AEA 890F                    	mov	[bx], cx
  4720 00001AEC 884F02                  	mov	[bx+2], cl
  4721 00001AEF EB0F                    	jmp	short FAT12_f_5
  4722                                  FAT12_f_4:	
  4723 00001AF1 53                      	push	bx
  4724 00001AF2 51                      	push	cx
  4725 00001AF3 BB[106A]                	mov	bx, HDFORMAT_FATBUFFER
  4726 00001AF6 E84B03                  	call	write_hd_sector
  4727 00001AF9 0F8294FC                	jc	formatting_error
  4728 00001AFD E844FC                  	call	write_format_percent
  4729                                  FAT12_f_5:	
  4730 00001B00 59                      	pop	cx
  4731 00001B01 5B                      	pop	bx
  4732 00001B02 83C001                  	add	ax, 1
  4733 00001B05 83D200                  	adc	dx, 0
  4734 00001B08 39DA                    	cmp	dx, bx
  4735 00001B0A 72E5                    	jb	short FAT12_f_4
  4736 00001B0C 39C8                    	cmp	ax, cx
  4737 00001B0E 72E1                    	jb	short FAT12_f_4
  4738                                  
  4739                                  	; write	root directory sectors
  4740                                  	; as empty sectors
  4741 00001B10 8B0E[1C6C]              	mov	cx, [root_dir_secs]
  4742                                  FAT12_f_6:
  4743 00001B14 51                      	push	cx
  4744 00001B15 BB[106A]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4745 00001B18 E82903                  	call	write_hd_sector
  4746 00001B1B 0F8272FC                	jc	formatting_error
  4747 00001B1F E822FC                  	call	write_format_percent
  4748 00001B22 83C001                  	add	ax, 1
  4749 00001B25 83D200                  	adc	dx, 0
  4750 00001B28 59                      	pop	cx
  4751 00001B29 49                      	dec	cx ; dec cl
  4752 00001B2A 75E8                    	jnz	short FAT12_f_6
  4753                                  
  4754                                  	; write DATA sectors 
  4755                                  	; (after root directory sectors)
  4756 00001B2C 8B0E[146C]              	mov	cx, [data_sectors]
  4757                                  	;mov	bx, [data_sectors+2]
  4758                                  	;inc	bx ; 11/02/2019
  4759                                  FAT12_f_7:	
  4760                                  	;push	bx
  4761 00001B30 51                      	push	cx
  4762 00001B31 BB[0E66]                	mov	bx, HDFORMAT_SECBUFFER
  4763 00001B34 E80D03                  	call	write_hd_sector
  4764 00001B37 0F8256FC                	jc	formatting_error
  4765 00001B3B E806FC                  	call	write_format_percent
  4766 00001B3E 59                      	pop	cx
  4767                                  	;pop	bx
  4768 00001B3F 83C001                  	add	ax, 1
  4769 00001B42 83D200                  	adc	dx, 0
  4770 00001B45 49                      	dec	cx
  4771 00001B46 75E8                    	jnz	short FAT12_f_7
  4772                                  	;dec	bx
  4773                                  	;jnz	short FAT12_f_7
  4774                                  
  4775                                  	; If there are, format remain sectors which are
  4776                                  	; at beyond of data clusters, with zero bytes.
  4777                                  	
  4778 00001B48 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  4779 00001B4B 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  4780                                  
  4781 00001B4E 034E13                  	add	cx, [bp+13h]	; [BPB_TotSec16]
  4782 00001B51 83D300                  	adc	bx, 0
  4783 00001B54 E9ACFA                  	jmp	FAT12_f_8
  4784                                  
  4785                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4786                                  ; SINGLIX FS FORMATTING
  4787                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4788                                  
  4789                                  SINGLIX_hdi_format:
  4790                                  	; 06/01/2018
  4791                                  	; 05/01/2018
  4792                                  	; If Sectors/Track = 17, use CHS+LBA type boot sector
  4793 00001B57 8B1E[9640]              	mov	bx, [sectors]
  4794 00001B5B 83FB11                  	cmp	bx, 17
  4795 00001B5E 7711                    	ja	short SINGLIX_fs1_f_1
  4796                                  SINGLIX_fs1_f_0:
  4797 00001B60 BD[823C]                	mov	bp, TRDOS_TRFS1_chs_bs
  4798 00001B63 887E2D                  	mov	[bp+45], bh ; 0 ; [bs_LBA_Ready] = 0
  4799 00001B66 885E2E                  	mov	[bp+46], bl	; [bs_Disk_SecPerTrack]
  4800 00001B69 A0[9840]                	mov	al, [heads]
  4801 00001B6C 88462F                  	mov	[bp+47], al	; [bs_Disk_Heads]
  4802 00001B6F EB15                    	jmp	short SINGLIX_fs1_f_3
  4803                                  SINGLIX_fs1_f_1:
  4804                                  	; Sectors per Track = 63
  4805                                  	; If disk capacity >= 63*16*1024 use LBA type boot sector
  4806 00001B71 8B0E[9840]              	mov	cx, [heads]
  4807 00001B75 A1[9A40]                	mov	ax, [cylinders]
  4808 00001B78 F7E1                    	mul	cx
  4809 00001B7A 21D2                    	and	dx, dx
  4810 00001B7C 7505                    	jnz	short SINGLIX_fs1_f_2
  4811 00001B7E 3D0040                  	cmp	ax, 16384
  4812 00001B81 72DD                    	jb	short SINGLIX_fs1_f_0
  4813                                  SINGLIX_fs1_f_2:	
  4814 00001B83 BD[823E]                	mov	bp, TRDOS_TRFS1_lba_bs
  4815                                  	;mov	byte [bp+45], 1 ; [bs_LBA_Ready] = 1
  4816                                  SINGLIX_fs1_f_3:	
  4817                                  	;mov	ax, [pp_Sectors]
  4818                                  	;mov	dx, [pp_Sectors+2]
  4819                                  	; 16/02/2019
  4820 00001B86 A1[CC6E]                	mov	ax, [ppn_Sectors]
  4821 00001B89 8B16[CE6E]              	mov	dx, [ppn_Sectors+2]
  4822 00001B8D 894610                  	mov	[bp+16], ax	; [bsVolumeSize]
  4823 00001B90 895612                  	mov	[bp+18], dx	; [bsVolumeSize+2]
  4824 00001B93 8B0E[986E]              	mov	cx, [pp_StartSector]
  4825 00001B97 8B1E[9A6E]              	mov	bx, [pp_StartSector+2]
  4826 00001B9B 894E0C                  	mov	[bp+12], cx	; [bsBeginSector]
  4827 00001B9E 895E0E                  	mov	[bp+14], bx	; [bsBeginSector+2]
  4828 00001BA1 C6462C80                	mov	byte [bp+44], 80h ; [bsDriveNumber]  ; hd0
  4829                                  
  4830                                  	; Prepare MAT
  4831 00001BA5 A3[746C]                	mov	[MAT_VolumeSize], ax ; Total Sectors of the FS
  4832 00001BA8 8916[766C]              	mov	[MAT_VolumeSize+2], dx
  4833 00001BAC 890E[786C]              	mov	[MAT_BeginSector], cx ; Beginning Sector of the FS
  4834 00001BB0 891E[7A6C]              	mov	[MAT_BeginSector+2], bx
  4835                                  	;mov	cx, [bp+24]	; [bsMATLocation]
  4836                                  	;mov	bx, [bp+26]	; [bsMATLocation+2]
  4837                                  	;add	cx, 1
  4838                                  	;adc	bx, 0
  4839                                  	; Note: (as Default) MAT Address = 1, DAT Address = 2
  4840 00001BB4 B90200                  	mov	cx, 2
  4841                                  	;xor	bx, bx ; 0
  4842                                  	;mov	[bp+24], cx	; [bsMATLocation]
  4843                                  	;mov	[bp+26], bx	; [bsMATLocation+2]
  4844 00001BB7 890E[7C6C]              	mov	[DAT_Address], cx
  4845                                  	;mov	[DAT_Address+2], bx
  4846                                  	; DX_AX = FS1 Volume Size
  4847 00001BBB 83C007                  	add	ax, 7 ; 7 bits more (for round up)
  4848 00001BBE 83D200                  	adc	dx, 0
  4849 00001BC1 B90800                  	mov	cx, 8 ;  1 DAT byte == 8 sectors 
  4850 00001BC4 E86FF2                  	call	div32
  4851                                  	; DX_AX = DAT bytes
  4852 00001BC7 B9FF01                  	mov	cx, 511
  4853 00001BCA 01C8                    	add	ax, cx
  4854 00001BCC 83D200                  	adc	dx, 0
  4855 00001BCF 41                      	inc	cx ; 512
  4856 00001BD0 E863F2                  	call	div32
  4857                                  	; DX_AX = DAT sectors (DX must be 0 for volume sizes < 128GB)
  4858 00001BD3 A3[806C]                	mov	[DAT_SectorCount], ax
  4859                                  	;mov	[DAT_SectorCount+2], dx ; 0
  4860                                  
  4861 00001BD6 83C002                  	add	ax, 2  ; BS + MAT
  4862                                  	;adc	dx, 0
  4863 00001BD9 89461C                  	mov	[bp+28], ax  ; [bsRootDirDT] ; RDT address (offset)
  4864                                  	;mov	[bp+30], dx
  4865                                  
  4866                                  	; Free Sectors = Total Sectors - (BS+MAT+DATsects+RDT+4)
  4867 00001BDC 83C005                  	add	ax, 5 ; DATsects + (BS+MAT+RDT+4)
  4868 00001BDF 89C2                    	mov	dx, ax
  4869 00001BE1 8B0E[746C]              	mov	cx, [MAT_VolumeSize]
  4870 00001BE5 8B1E[766C]              	mov	bx, [MAT_VolumeSize+2]
  4871 00001BE9 29C1                    	sub	cx, ax
  4872 00001BEB 83DB00                  	sbb	bx, 0
  4873 00001BEE 890E[846C]              	mov	[MAT_FreeSectors], cx
  4874 00001BF2 891E[866C]              	mov	[MAT_FreeSectors+2], bx
  4875 00001BF6 A3[886C]                	mov	[MAT_FirstFreeSector], ax
  4876                                  	;mov	word [MAT_FirstFreesector+2] , 0
  4877                                  
  4878 00001BF9 BF[246C]                	mov	di, fs_volume_name
  4879 00001BFC E834FA                  	call	write_fs_volume_name
  4880 00001BFF BE[646C]                	mov	si, fs_volume_serial
  4881 00001C02 E894FA                  	call	write_volume_serial
  4882                                  
  4883                                  	; Modify FS volume name
  4884                                  	; (Convert 20h tail bytes to 0)
  4885 00001C05 B94000                  	mov	cx, 64 
  4886 00001C08 BE[246C]                	mov	si, fs_volume_name
  4887 00001C0B 31DB                    	xor	bx, bx
  4888 00001C0D B0FF                    	mov	al, 0FFh
  4889                                  modify_fs_vname_1:
  4890 00001C0F 88C4                    	mov	ah, al
  4891 00001C11 AC                      	lodsb
  4892 00001C12 3C20                    	cmp	al, 20h
  4893 00001C14 7708                    	ja	short modify_fs_vname_2
  4894 00001C16 80FC20                  	cmp	ah, 20h
  4895 00001C19 7603                    	jna	short modify_fs_vname_2
  4896 00001C1B 89F3                    	mov	bx, si
  4897 00001C1D 4B                      	dec	bx
  4898                                  modify_fs_vname_2:
  4899 00001C1E E2EF                    	loop	modify_fs_vname_1
  4900 00001C20 09DB                    	or	bx, bx
  4901 00001C22 740B                    	jz	short modify_fs_vname_3
  4902 00001C24 89DF                    	mov	di, bx
  4903 00001C26 B9[646C]                	mov	cx, fs_volume_name+64
  4904 00001C29 29D9                    	sub	cx, bx
  4905 00001C2B 30C0                    	xor	al, al
  4906 00001C2D F3AA                    	rep	stosb 
  4907                                  
  4908                                  modify_fs_vname_3:
  4909 00001C2F E8EEFA                  	call	write_formatting_msg
  4910 00001C32 B000                    	mov	al, 0
  4911 00001C34 E846FB                  	call	write_format_percent_x
  4912                                  
  4913 00001C37 8B460C                  	mov	ax, [bp+12]	; [bsBeginSector]
  4914 00001C3A 8B560E                  	mov	dx, [bp+14]	; [bsBeginSector+2]
  4915                                  
  4916                                  	; DX_AX = TRFS1 Boot Sector address
  4917 00001C3D 89EB                    	mov	bx, bp
  4918                                  	; ES:BX = Boot Sector Buffer
  4919 00001C3F E80202                  	call	write_hd_sector
  4920 00001C42 0F824BFB                	jc	formatting_error
  4921                                  	
  4922 00001C46 83C001                  	add	ax, 1
  4923 00001C49 83D200                  	adc	dx, 0
  4924                                  
  4925                                  	; DX_AX = MAT (DAT header) sector address
  4926 00001C4C BB[706C]                	mov	bx, FS_MAT_Buffer
  4927                                  	; 16/02/2019
  4928 00001C4F C7074D41                	mov	word [bx],'MA'
  4929 00001C53 C6470254                	mov	byte [bx+2],'T'
  4930 00001C57 E8EA01                  	call	write_hd_sector
  4931 00001C5A 0F8233FB                	jc	formatting_error
  4932 00001C5E E823FB                  	call	write_fs_format_percent
  4933                                  
  4934                                  	; Calculate DAT bits 
  4935                                  	; NOTE: 4096 bits per DAT sector
  4936 00001C61 A1[886C]                	mov	ax, [MAT_FirstFreeSector]
  4937                                  	;mov	dx, [MAT_FirstFreeSector+2]
  4938 00001C64 31D2                    	xor	dx, dx
  4939 00001C66 52                      	push	dx
  4940 00001C67 50                      	push	ax
  4941 00001C68 B90010                  	mov	cx, 4096
  4942 00001C6B E8C8F1                  	call	div32
  4943 00001C6E 891E[686C]              	mov	[DAT_FFBit], bx
  4944 00001C72 A3[6A6C]                	mov	[DAT_FFSector], ax
  4945 00001C75 58                      	pop	ax
  4946 00001C76 5A                      	pop	dx
  4947 00001C77 83E801                  	sub	ax, 1
  4948 00001C7A 83DA00                  	sbb	dx, 0
  4949 00001C7D 0306[846C]              	add	ax, [MAT_FreeSectors]
  4950 00001C81 1316[866C]              	adc	dx, [MAT_FreeSectors+2]
  4951 00001C85 E8AEF1                  	call	div32
  4952 00001C88 891E[6C6C]              	mov	[DAT_LFBit], bx
  4953 00001C8C A3[6E6C]                	mov	[DAT_LFSector], ax
  4954                                  
  4955 00001C8F 31F6                    	xor	si, si ; 0
  4956                                  SINGLIX_fs1_f_4:
  4957                                  	; calculate free bits for current DAT sector
  4958                                  	;			(to be written)
  4959 00001C91 BF[8C6C]                	mov	di, FS_DAT_Buffer
  4960 00001C94 3B36[6A6C]              	cmp	si, [DAT_FFSector]
  4961 00001C98 7431                    	je	short SINGLIX_fs1_f_7
  4962 00001C9A 724D                    	jb	short SINGLIX_fs1_f_9
  4963 00001C9C 3B36[6E6C]              	cmp	si, [DAT_LFSector]
  4964 00001CA0 7224                    	jb	short SINGLIX_fs1_f_6
  4965 00001CA2 7745                    	ja	short SINGLIX_fs1_f_9
  4966 00001CA4 8B1E[6C6C]              	mov	bx, [DAT_LFBit]
  4967 00001CA8 B0FF                    	mov	al, 0FFh
  4968 00001CAA 88DC                    	mov	ah, bl
  4969 00001CAC C1EB03                  	shr	bx, 3 ; bit count to byte count
  4970 00001CAF 7409                    	jz	short SINGLIX_fs1_f_5
  4971 00001CB1 89D9                    	mov	cx, bx
  4972 00001CB3 F3AA                    	rep	stosb
  4973 00001CB5 BF[8C6C]                	mov	di, FS_DAT_Buffer
  4974 00001CB8 01DF                    	add	di, bx
  4975                                  SINGLIX_fs1_f_5:
  4976 00001CBA 80E407                  	and	ah, 7
  4977 00001CBD 88E1                    	mov	cl, ah
  4978 00001CBF D2E0                    	shl	al, cl
  4979 00001CC1 F6D0                    	not	al
  4980 00001CC3 AA                      	stosb
  4981                                  	;mov	cx, 511
  4982                                  	;sub	cx, bx
  4983                                  	;jna	short SINGLIX_fs1_f_9
  4984                                  	;mov	al, 0 ; out of volume bits (=0)
  4985                                  	;rep	stosb
  4986 00001CC4 EB23                    	jmp	short SINGLIX_fs1_f_9
  4987                                  SINGLIX_fs1_f_6:
  4988 00001CC6 B90002                  	mov	cx, 512
  4989 00001CC9 EB1A                    	jmp	short SINGLIX_fs1_f_8
  4990                                  SINGLIX_fs1_f_7:
  4991 00001CCB 8B1E[686C]              	mov	bx, [DAT_FFBit]
  4992 00001CCF 88D9                    	mov	cl, bl
  4993 00001CD1 80E107                  	and	cl, 7
  4994 00001CD4 C1EB03                  	shr	bx, 3 ; from bits to bytes
  4995 00001CD7 01DF                    	add	di, bx
  4996 00001CD9 B0FF                    	mov	al, 0FFh
  4997 00001CDB D2E0                    	shl	al, cl
  4998 00001CDD AA                      	stosb
  4999 00001CDE B9FF01                  	mov	cx, 511
  5000 00001CE1 29D9                    	sub	cx, bx
  5001 00001CE3 7604                    	jna	short SINGLIX_fs1_f_9
  5002                                  SINGLIX_fs1_f_8:
  5003 00001CE5 B0FF                    	mov	al, 0FFh ; Free sector bits (=1)
  5004 00001CE7 F3AA                    	rep	stosb
  5005                                  SINGLIX_fs1_f_9:
  5006 00001CE9 A1[786C]                	mov	ax, [MAT_BeginSector]
  5007 00001CEC 8B16[7A6C]              	mov	dx, [MAT_BeginSector+2]
  5008                                  	;add	ax, [DAT_Address] ; = 2
  5009                                  	;adc	dx, [DAT_Address+2]
  5010 00001CF0 83C002                  	add	ax, 2
  5011 00001CF3 83D200                  	adc	dx, 0
  5012 00001CF6 01F0                    	add	ax, si
  5013 00001CF8 83D200                  	adc	dx, 0
  5014                                  	; Write DAT sector(s)
  5015                                  	; DX_AX = Disk Allocation Table sector address
  5016 00001CFB BB[8C6C]                	mov	bx, FS_DAT_Buffer
  5017 00001CFE E84301                  	call	write_hd_sector
  5018 00001D01 0F828CFA                	jc	formatting_error
  5019 00001D05 E87CFA                  	call	write_fs_format_percent
  5020                                  	; Clear DAT buffer again (for next stage)
  5021 00001D08 B90001                  	mov	cx, 256
  5022 00001D0B BF[8C6C]                	mov	di, FS_DAT_Buffer
  5023 00001D0E 29C0                    	sub	ax, ax
  5024 00001D10 F3AB                    	rep	stosw
  5025                                  
  5026 00001D12 46                      	inc	si
  5027                                  
  5028 00001D13 3B36[806C]              	cmp	si, [DAT_SectorCount]
  5029 00001D17 0F8676FF                	jna	SINGLIX_fs1_f_4
  5030                                  
  5031                                  	; ;;;
  5032                                  	
  5033                                  	; DAT sectors has been written..
  5034                                  	; Now, Root Directory Description Table is in order
  5035                                  
  5036 00001D1B BF[8C6C]                	mov	di, FS_RDT_Buffer
  5037 00001D1E B84444                  	mov	ax, 'DD'
  5038 00001D21 AB                      	stosw
  5039 00001D22 30E4                    	xor	ah, ah
  5040 00001D24 B054                    	mov	al, 'T'
  5041 00001D26 AB                      	stosw
  5042 00001D27 B80002                  	mov	ax, 512 ; Sector size (Bytes per sector)
  5043 00001D2A AB                      	stosw
  5044 00001D2B 31C0                    	xor	ax, ax ; RDT sequence number (= 0, section 1)
  5045 00001D2D AB                      	stosw	
  5046                                  	; RDT address
  5047 00001D2E A1[806C]                	mov	ax, [DAT_SectorCount]
  5048 00001D31 8B16[826C]              	mov	dx, [DAT_SectorCount+2]
  5049 00001D35 83C002                  	add	ax, 2 ; BS + MAT
  5050 00001D38 83D200                  	adc	dx, 0
  5051 00001D3B AB                      	stosw
  5052 00001D3C 89D0                    	mov	ax, dx
  5053 00001D3E AB                      	stosw
  5054 00001D3F 29C0                    	sub	ax, ax ; Next RDT number
  5055 00001D41 AB                      	stosw
  5056 00001D42 AB                      	stosw
  5057 00001D43 B80400                  	mov	ax, 4 ; Sector count of this section
  5058                                  		      ; (4*512)/4 = 512 root dir entries
  5059 00001D46 AB                      	stosw
  5060 00001D47 30C0                    	xor	al, al
  5061 00001D49 AB                      	stosw
  5062                                  	; Volume beginning sector
  5063 00001D4A 8B460C                  	mov	ax, [bp+12]	; [bsBeginSector]
  5064 00001D4D 8B560E                  	mov	dx, [bp+14]	; [bsBeginSector+2]
  5065 00001D50 AB                      	stosw
  5066 00001D51 89D0                    	mov	ax, dx
  5067 00001D53 AB                      	stosw
  5068 00001D54 31C0                    	xor	ax, ax
  5069 00001D56 48                      	dec	ax ; 0FFFFh
  5070                                  	; Parent Dir Serial (= FFFFFFFFh for root dir)
  5071 00001D57 AB                      	stosw
  5072 00001D58 AB                      	stosw
  5073                                  
  5074                                  set_fs_volume_serial_number:
  5075 00001D59 BE[646C]                	mov	si, fs_volume_serial
  5076 00001D5C A5                      	movsw
  5077 00001D5D A5                      	movsw
  5078                                  
  5079 00001D5E 29C0                    	sub	ax, ax
  5080 00001D60 AA                      	stosb	; sub directory level = 0
  5081 00001D61 AA                      	stosb	; 0, reverved
  5082 00001D62 B004                    	mov	al, 00000100b ;  (DOS) System attribute
  5083 00001D64 AA                      	stosb	; (DOS) Basic attributes
  5084 00001D65 28C0                    	sub	al, al ; Extended attributes (0 for TRDOS 386)
  5085 00001D67 AA                      	stosb
  5086 00001D68 29C0                    	sub	ax, ax ; reserved (8) bytes for TR-MULTIX
  5087 00001D6A AB                      	stosw
  5088 00001D6B AB                      	stosw
  5089 00001D6C AB                      	stosw
  5090 00001D6D AB                      	stosw
  5091 00001D6E B85254                  	mov	ax, 'RT' ; TRFS Root directory signature
  5092 00001D71 AB                      	stosw
  5093 00001D72 31C0                    	xor	ax, ax ; Country (language, date, text format)
  5094                                  		       ; (0 = Default, 1 = USA, 90 = Turkiye)
  5095 00001D74 AA                      	stosb
  5096 00001D75 AA                      	stosb	; Time Zone (0 = GMT = default ; -11 to +12)
  5097                                  
  5098 00001D76 89FE                    	mov	si, di
  5099                                  	; get the date (from RTC)
  5100 00001D78 B404                    	mov	ah, 4
  5101 00001D7A CD1A                    	int	1Ah
  5102                                  	; Creating Date (of root directory)
  5103 00001D7C 86E9                    	xchg	ch, cl ; 07/01/2018
  5104 00001D7E 89C8                    	mov	ax, cx ; cl = century (BCD), ch = year (BCD)
  5105 00001D80 AB                      	stosw
  5106 00001D81 88F0                    	mov	al, dh  ; month (BCD)
  5107 00001D83 AA                      	stosb
  5108 00001D84 88D0                    	mov	al, dl  ; day (BCD)
  5109 00001D86 AA                      	stosb
  5110                                  	; get the time (from RTC)
  5111 00001D87 B402                    	mov	ah, 2
  5112 00001D89 CD1A                    	int	1Ah
  5113                                  	; Creating Time (of root directory)
  5114 00001D8B 86CD                    	xchg	cl, ch ; ch = hour (BCD), cl = minute (BSD)
  5115 00001D8D 89C8                    	mov	ax, cx ; al = hour, ah = minute
  5116 00001D8F AB                      	stosw
  5117 00001D90 88F0                    	mov	al, dh ; seconds (BCD)
  5118 00001D92 AA                      	stosb
  5119 00001D93 88D0                    	mov	al, dl ; daylight savings time option
  5120 00001D95 AA                      	stosb
  5121                                  	; Set Last Modification Date&Time
  5122 00001D96 B90400                  	mov	cx, 4
  5123 00001D99 F3A5                    	rep	movsw ; copy creating date&time values to
  5124                                  		; last modification date time values
  5125                                  		; (last modif date&time = creating date&time)
  5126                                  
  5127                                  set_fs_volume_name:
  5128 00001D9B BE[246C]                	mov	si, fs_volume_name
  5129 00001D9E B120                    	mov	cl, 32 
  5130 00001DA0 F3A5                    	rep	movsw
  5131                                  
  5132                                  	; Fill remain bytes (of this RDT) with zero
  5133 00001DA2 B9C000                  	mov	cx, (128+256)/2
  5134 00001DA5 31C0                    	xor	ax, ax
  5135 00001DA7 F3AB                    	rep	stosw
  5136                                  
  5137                                  	; RDT is ready here...
  5138                                  
  5139 00001DA9 8B461C                  	mov	ax, [bp+28]	; [bsRootDirDT]
  5140                                  	;mov	dx, [bp+30]	; [bsRootDirDT+2]
  5141 00001DAC 31D2                    	xor	dx, dx
  5142 00001DAE 03460C                  	add	ax, [bp+12]	; [bsBeginSector]
  5143 00001DB1 13560E                  	adc	dx, [bp+14]	; [bsBeginSector+2]
  5144                                  
  5145                                  	; Write RDT sector
  5146                                  	; DX_AX = Root Directory Description Table address
  5147 00001DB4 BB[8C6C]                	mov	bx, FS_RDT_Buffer
  5148 00001DB7 E88A00                  	call	write_hd_sector
  5149 00001DBA 0F82D3F9                	jc	formatting_error
  5150 00001DBE E8C3F9                  	call	write_fs_format_percent
  5151                                  
  5152 00001DC1 83C001                  	add	ax, 1
  5153 00001DC4 83D200                  	adc	dx, 0
  5154                                  
  5155                                  	; write root directory data sectors
  5156 00001DC7 B90400                  	mov	cx, 4
  5157                                  
  5158                                  SINGLIX_fs1_f_10:
  5159 00001DCA 51                      	push	cx
  5160                                  	; Write root directory sector(s)
  5161                                  	; DX_AX = Root Directory Sector address
  5162 00001DCB BB[106A]                	mov	bx, HDFORMAT_EMPTY_BUFF
  5163 00001DCE E87300                  	call	write_hd_sector
  5164 00001DD1 0F82BCF9                	jc	formatting_error
  5165 00001DD5 E8ACF9                  	call	write_fs_format_percent
  5166 00001DD8 83C001                  	add	ax, 1
  5167 00001DDB 83D200                  	adc	dx, 0
  5168 00001DDE 59                      	pop	cx
  5169 00001DDF FEC9                    	dec	cl
  5170 00001DE1 75E7                    	jnz	short SINGLIX_fs1_f_10
  5171                                  
  5172                                  	; Fill remain sectors with 'F6h' bytes
  5173 00001DE3 8B4E10                  	mov	cx, [bp+16]	; [bsVolumeSize]
  5174 00001DE6 8B5E12                  	mov	bx, [bp+18]	; [bsVolumeSize+2]
  5175 00001DE9 034E0C                  	add	cx, [bp+12]	; [bsBeginSector]
  5176 00001DEC 135E0E                  	adc	bx, [bp+14]	; [bsBeginSector+2]
  5177                                  
  5178                                  	; write DATA sectors 
  5179                                  	; (after root directory sectors)
  5180                                  SINGLIX_fs1_f_11:
  5181 00001DEF 53                      	push	bx
  5182 00001DF0 51                      	push	cx
  5183 00001DF1 BB[0E66]                	mov	bx, HDFORMAT_SECBUFFER
  5184 00001DF4 E84D00                  	call	write_hd_sector
  5185 00001DF7 0F8296F9                	jc	formatting_error
  5186 00001DFB E846F9                  	call	write_format_percent
  5187 00001DFE 59                      	pop	cx
  5188 00001DFF 5B                      	pop	bx
  5189 00001E00 83C001                  	add	ax, 1
  5190 00001E03 83D200                  	adc	dx, 0
  5191 00001E06 39DA                    	cmp	dx, bx
  5192 00001E08 72E5                    	jb	short SINGLIX_fs1_f_11
  5193 00001E0A 0F8717F8                	ja	SINGLIX_fs1_f_12
  5194 00001E0E 39C8                    	cmp	ax, cx
  5195 00001E10 72DD                    	jb	short SINGLIX_fs1_f_11
  5196 00001E12 E910F8                  	jmp	SINGLIX_fs1_f_12
  5197                                  
  5198                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5199                                  ; Print error message and exit
  5200                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5201                                  ; 25/02/2019
  5202                                  	
  5203                                  D_01:
  5204 00001E15 50                      	push	ax
  5205 00001E16 8B1E[9440]              	mov	bx, [img_file_handle]
  5206 00001E1A B43E                    	mov	ah, 3Eh ; close file
  5207 00001E1C CD21                    	int	21h
  5208 00001E1E 58                      	pop	ax
  5209                                  
  5210                                  	; 11/02/2019
  5211                                  	;mov 	word [img_file_handle], 0
  5212                                  D_02:
  5213 00001E1F 88E0                    	mov	al, ah ;  error code
  5214 00001E21 E8B000                  	call	bin_to_hex
  5215 00001E24 A3[6156]                	mov 	[error_code], ax
  5216                                  
  5217 00001E27 BE[5356]                	mov	si, CRLF
  5218 00001E2A E80800                  	call	print_msg
  5219                                  
  5220 00001E2D BE[5656]                	mov	si, Msg_Error
  5221                                  
  5222 00001E30 E80200                  	call	print_msg
  5223                                  
  5224 00001E33 CD20                    	int	20h	; Exit
  5225                                  
  5226                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5227                                  ; Print messages
  5228                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5229                                  
  5230                                  print_msg:
  5231                                  
  5232                                  print_msg_LOOP:
  5233 00001E35 AC                      	lodsb                           ; Load byte at DS:SI to AL
  5234 00001E36 20C0                    	and     al, al
  5235 00001E38 7409                    	jz      short print_msg_OK
  5236 00001E3A B40E                    	mov	ah, 0Eh
  5237 00001E3C BB0700                  	mov     bx, 07h
  5238 00001E3F CD10                    	int	10h			; BIOS Service func ( ah ) = 0Eh
  5239                                  					; Write char as TTY
  5240                                  					; AL-char BH-page BL-color
  5241 00001E41 EBF2                    	jmp     short print_msg_LOOP
  5242                                  
  5243                                  print_msg_OK:
  5244 00001E43 C3                      	retn
  5245                                  
  5246                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5247                                  ; Writing a block (sector) to hard disk disk image file
  5248                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5249                                  
  5250                                  write_hd_sector:
  5251                                  	; INPUT -> DX_AX = Logical Block Address
  5252                                  	; 	   ES:BX = Sector Buffer
  5253                                  	; OUTPUT ->
  5254                                  	;  cf = 0 -> DX_AX = Logical Block Adress
  5255                                  	;	     ES:BX = Sector Buffer
  5256                                  	;  cf = 1 -> AH = Error Number
  5257                                  	;
  5258 00001E44 52                      	push	dx ; sector (hw)
  5259 00001E45 50                      	push	ax ; sector (lw)
  5260 00001E46 53                      	push	bx ; buffer
  5261 00001E47 B90002                  	mov	cx, 512
  5262                                  	; DX_AX: Multiplicand
  5263                                  	; CX = Multiplier
  5264 00001E4A E8F7EF                  	call	mul32
  5265                                  	; BX_DX_AX = result of multiplication (product)
  5266 00001E4D 21DB                    	and	bx, bx
  5267 00001E4F 7529                    	jnz	short image_file_size_err
  5268 00001E51 F6C680                  	test	dh, 80h
  5269 00001E54 7524                    	jnz	short image_file_size_err
  5270 00001E56 8B1E[9440]              	mov 	bx, [img_file_handle]
  5271 00001E5A 803E[9C40]00            	cmp	byte [random], 0
  5272 00001E5F 760A                    	jna	short whds
  5273 00001E61 89D1                    	mov	cx, dx
  5274 00001E63 89C2                    	mov	dx, ax
  5275 00001E65 28C0                    	sub	al, al ; specified offset is from the beginning of the file
  5276 00001E67 B442                    	mov	ah, 42h ; seek (move file pointer)
  5277 00001E69 CD21                    	int	21h
  5278                                  whds:
  5279                                  	;mov	bx, [img_file_handle]
  5280 00001E6B B90002                  	mov	cx, 512
  5281 00001E6E 5A                      	pop	dx  ; buffer address
  5282 00001E6F B440                    	mov	ah, 40h ; write to file	
  5283 00001E71 CD21                    	int	21h
  5284 00001E73 89D3                    	mov	bx, dx
  5285 00001E75 7209                    	jc	short image_file_rw_err
  5286 00001E77 58                      	pop	ax ; sector (lw)
  5287 00001E78 5A                      	pop	dx ; sector (hw) 
  5288 00001E79 C3                      	retn
  5289                                  
  5290                                  image_file_size_err:
  5291 00001E7A 5B                      	pop	bx
  5292 00001E7B 30C0                    	xor	al, al
  5293                                  	;mov	ah, 1Bh ; sector not found error
  5294 00001E7D B419                    	mov	ah, 19h ; Seek error
  5295 00001E7F F9                      	stc
  5296                                  
  5297                                  image_file_rw_err:
  5298 00001E80 5A                      	pop	dx ; sector (lw)
  5299 00001E81 5A                      	pop	dx ; sector (hw)
  5300 00001E82 C3                      	retn
  5301                                  
  5302                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5303                                  ; Reading a block (sector) from hard disk disk image file
  5304                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5305                                  
  5306                                  read_hd_sector:
  5307                                  	; INPUT -> DX_AX = Logical Block Address
  5308                                  	; 	   ES:BX = Sector Buffer
  5309                                  	; OUTPUT ->
  5310                                  	;  cf = 0 -> DX_AX = Logical Block Adress
  5311                                  	;	     ES:BX = Sector Buffer
  5312                                  	;  cf = 1 -> AH = Error Number
  5313                                  	;
  5314 00001E83 52                      	push	dx ; sector (hw)
  5315 00001E84 50                      	push	ax ; sector (lw)
  5316 00001E85 53                      	push	bx ; buffer
  5317 00001E86 B90002                  	mov	cx, 512
  5318                                  	; DX_AX: Multiplicand
  5319                                  	; CX = Multiplier
  5320 00001E89 E8B8EF                  	call	mul32
  5321                                  	; BX_DX_AX = result of multiplication (product)
  5322 00001E8C 21DB                    	and	bx, bx
  5323 00001E8E 75EA                    	jnz	short image_file_size_err
  5324 00001E90 F6C680                  	test	dh, 80h
  5325 00001E93 75E5                    	jnz	short image_file_size_err
  5326 00001E95 8B1E[9440]              	mov 	bx, [img_file_handle]
  5327 00001E99 803E[9C40]00            	cmp	byte [random], 0
  5328 00001E9E 760A                    	jna	short rhds
  5329 00001EA0 89D1                    	mov	cx, dx
  5330 00001EA2 89C2                    	mov	dx, ax
  5331 00001EA4 28C0                    	sub	al, al ; specified offset is from the beginning of the file
  5332 00001EA6 B442                    	mov	ah, 42h ; seek (move file pointer)
  5333 00001EA8 CD21                    	int	21h
  5334                                  rhds:
  5335                                  	;mov	bx, [img_file_handle]
  5336 00001EAA B90002                  	mov	cx, 512
  5337 00001EAD 5A                      	pop	dx  ; buffer address
  5338 00001EAE B43F                    	mov	ah, 3Fh ; read from file
  5339 00001EB0 CD21                    	int	21h
  5340 00001EB2 89D3                    	mov	bx, dx
  5341 00001EB4 72CA                    	jc	short image_file_rw_err
  5342 00001EB6 39C8                    	cmp	ax, cx
  5343 00001EB8 75C0                    	jne	short image_file_size_err
  5344 00001EBA 58                      	pop	ax ; sector (lw)
  5345 00001EBB 5A                      	pop	dx ; sector (hw) 
  5346 00001EBC C3                      	retn
  5347                                  	
  5348                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5349                                  ; Convert byte to decimal number
  5350                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5351                                  
  5352                                  bin_to_decimal:
  5353                                  	; INPUT: DS:SI = Target location
  5354                                  	;        DX_AX = Binary Number (Integer)
  5355                                  	; OUTPUT: Decimal char at DS:SI
  5356                                  	; 	 SI decremented after every division
  5357                                  	; 	 till AX<10.
  5358                                  	; CX, DX, BX will be changed.
  5359                                  	;
  5360 00001EBD B90A00                  	mov	cx, 10
  5361                                  btd_0:
  5362                                  	; DX_AX = Dividend
  5363                                  	; CX = Divisor
  5364 00001EC0 E873EF                  	call	div32
  5365                                  	; DX_AX = Quotient
  5366                                  	; BX = remainder
  5367 00001EC3 80C330                  	add	bl, '0'
  5368 00001EC6 881C                    	mov	[si], bl
  5369 00001EC8 21D2                    	and	dx, dx
  5370 00001ECA 7403                    	jz	short btd_2
  5371                                  btd_1:
  5372 00001ECC 4E                      	dec	si
  5373 00001ECD EBF1                    	jmp	short btd_0
  5374                                  btd_2:
  5375 00001ECF 09C0                    	or	ax, ax
  5376 00001ED1 75F9                    	jnz	short btd_1
  5377                                  
  5378 00001ED3 C3                      	retn
  5379                                  
  5380                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5381                                  ; Convert byte to hexadecimal number
  5382                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5383                                  
  5384                                  byte_to_hex: ; 04/02/2019
  5385                                  bin_to_hex:
  5386                                  	; INPUT ->
  5387                                  	; 	AL = byte (binary number)
  5388                                  	; OUTPUT ->
  5389                                  	;	AX = hexadecimal string
  5390                                  	;
  5391 00001ED4 53                      	push	bx
  5392 00001ED5 31DB                    	xor	bx, bx
  5393 00001ED7 88C3                    	mov	bl, al
  5394 00001ED9 C0EB04                  	shr	bl, 4
  5395 00001EDC 8A9F[8340]              	mov	bl, [bx+hexchrs]
  5396 00001EE0 86D8                    	xchg	bl, al
  5397 00001EE2 80E30F                  	and	bl, 0Fh
  5398 00001EE5 8AA7[8340]              	mov	ah, [bx+hexchrs]
  5399 00001EE9 5B                      	pop	bx
  5400 00001EEA C3                      	retn
  5401                                  
  5402                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5403                                  ; Read & Write characters
  5404                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5405                                  
  5406                                  rw_char:
  5407                                  	; OUTPUT -> DS:SI = Entered String (ASCIIZ)
  5408 00001EEB BE[B055]                	mov     si, StrVolumeName
  5409 00001EEE BB0700                  	mov     bx, 7
  5410 00001EF1 B403                    	mov     ah, 3
  5411 00001EF3 CD10                    	int     10h
  5412 00001EF5 8916[9755]              	mov     [Cursor_Pos], dx
  5413                                  read_next_char:
  5414 00001EF9 30E4                    	xor     ah, ah
  5415 00001EFB CD16                    	int     16h
  5416 00001EFD 20C0                    	and     al, al
  5417 00001EFF 7439                    	jz      short loc_arrow
  5418 00001F01 3CE0                    	cmp     al, 0E0h
  5419 00001F03 7435                    	je      short loc_arrow
  5420 00001F05 3C08                    	cmp     al, 8
  5421 00001F07 753D                    	jne     short char_return
  5422                                  loc_back:
  5423 00001F09 B403                    	mov     ah, 3
  5424 00001F0B CD10                    	int     10h
  5425 00001F0D 3A16[9755]              	cmp     dl, byte [Cursor_Pos]
  5426 00001F11 761F                    	jna     short loc_beep
  5427                                  prev_column:
  5428 00001F13 FECA                    	dec     dl
  5429                                  set_cursor_pos:
  5430 00001F15 B402                    	mov     ah, 2
  5431 00001F17 CD10                    	int     10h
  5432 00001F19 88D3                    	mov     bl, dl
  5433 00001F1B 2A1E[9755]              	sub     bl, byte [Cursor_Pos]
  5434 00001F1F B90100                  	mov     cx, 1
  5435 00001F22 B409                    	mov     ah, 9
  5436 00001F24 B020                    	mov     al, 20h
  5437 00001F26 8800                    	mov     [si+bx], al
  5438                                  loc_write_it:
  5439 00001F28 B307                    	mov     bl, 7
  5440 00001F2A CD10                    	int     10h
  5441 00001F2C 8B16[9755]              	mov     dx, [Cursor_Pos]
  5442 00001F30 EBC7                    	jmp     short read_next_char
  5443                                  loc_beep:
  5444 00001F32 B40E                    	mov     ah, 0Eh
  5445 00001F34 B007                    	mov     al, 7
  5446 00001F36 CD10                    	int     10h
  5447 00001F38 EBBF                    	jmp     short read_next_char
  5448                                  loc_arrow:    
  5449 00001F3A 80FC4B                  	cmp     ah, 4Bh
  5450 00001F3D 74CA                    	je      short loc_back
  5451 00001F3F 80FC53                  	cmp     ah, 53h
  5452 00001F42 74C5                    	je      short loc_back
  5453 00001F44 EBB3                    	jmp     short read_next_char
  5454                                  char_return:
  5455 00001F46 B403                    	mov     ah, 3
  5456 00001F48 CD10                    	int     10h
  5457                                  check_char_type:
  5458 00001F4A 3C20                    	cmp     al, 20h
  5459 00001F4C 7229                    	jb      short loc_escape
  5460 00001F4E 88D4                    	mov     ah, dl
  5461 00001F50 2A26[9755]              	sub     ah, byte [Cursor_Pos]
  5462                                  	;cmp	ah, 10 
  5463                                  	;ja	short loc_beep
  5464 00001F54 3A26[F765]              	cmp     ah, [vname_length] ; 05/01/2018
  5465 00001F58 73D8                    	jnb	short loc_beep
  5466 00001F5A 3C7A                    	cmp     al, 'z'
  5467 00001F5C 779B                    	ja      short read_next_char
  5468 00001F5E 3C61                    	cmp     al, 'a'
  5469 00001F60 7202                    	jb      short pass_capitalize
  5470 00001F62 24DF                    	and     al, 0DFh
  5471                                  pass_capitalize:
  5472 00001F64 88E3                    	mov     bl, ah 
  5473 00001F66 30E4                    	xor     ah, ah
  5474 00001F68 8900                    	mov     [si+bx], ax
  5475 00001F6A B307                    	mov     bl, 7
  5476 00001F6C B40E                    	mov     ah, 0Eh
  5477 00001F6E CD10                    	int     10h
  5478 00001F70 EB87                    	jmp     short read_next_char
  5479                                  pass_escape:
  5480 00001F72 3C0D                    	cmp     al, 0Dh	; 13 ; ENTER
  5481 00001F74 7583                    	jne     short read_next_char
  5482                                  	;mov	ah, 0Eh
  5483                                  	;int	10h
  5484                                  	;mov	al, 0Ah
  5485                                  	;int	10h
  5486 00001F76 C3                      	retn
  5487                                  loc_escape:
  5488 00001F77 3C1B                    	cmp     al, 1Bh	; 27 ; ESC
  5489 00001F79 75F7                    	jne     short pass_escape
  5490 00001F7B F9                      	stc
  5491 00001F7C C3                      	retn
  5492                                  
  5493                                  ;-----------------------------------------------------------------------------
  5494                                  
  5495                                  display_chs_table:
  5496 00001F7D 06                      	push	es
  5497 00001F7E BF00B8                  	mov	di, 0B800h
  5498 00001F81 8EC7                    	mov	es, di
  5499 00001F83 31FF                    	xor	di, di
  5500                                  	; 12/02/2019
  5501                                  	; new file ?
  5502 00001F85 803E[C56E]00            	cmp	byte [existingfile], 0
  5503 00001F8A 7604                    	jna	short dchstbl_1
  5504 00001F8C 81C74001                	add	di, 320 ; skip 2 rows (for the header)
  5505                                  dchstbl_1:
  5506 00001F90 B95000                  	mov	cx, 80
  5507 00001F93 B82007                  	mov	ax, 0720h
  5508 00001F96 F3AB                    	rep	stosw
  5509 00001F98 B150                    	mov	cl, 80 
  5510 00001F9A B02D                    	mov	al, "-"
  5511 00001F9C F3AB                    	rep	stosw
  5512 00001F9E B113                    	mov	cl, 19
  5513 00001FA0 B020                    	mov	al, 20h
  5514 00001FA2 F3AB                    	rep	stosw
  5515 00001FA4 B043                    	mov	al, 'C'
  5516 00001FA6 AB                      	stosw
  5517 00001FA7 B079                    	mov	al, 'y'
  5518 00001FA9 AB                      	stosw
  5519 00001FAA B06C                    	mov	al, 'l'
  5520 00001FAC AB                      	stosw
  5521 00001FAD B069                    	mov	al, 'i'
  5522 00001FAF AB                       	stosw
  5523 00001FB0 B06E                    	mov	al, 'n'
  5524 00001FB2 AB                      	stosw	
  5525 00001FB3 B064                    	mov	al, 'd'
  5526 00001FB5 AB                      	stosw
  5527 00001FB6 B065                    	mov	al, 'e'
  5528 00001FB8 AB                      	stosw
  5529 00001FB9 B072                    	mov	al, 'r'
  5530 00001FBB AB                       	stosw
  5531 00001FBC B073                    	mov	al, 's'
  5532 00001FBE AB                       	stosw
  5533 00001FBF B03A                    	mov	al, ':'
  5534 00001FC1 AB                      	stosw
  5535 00001FC2 B020                    	mov	al, 20h
  5536 00001FC4 AB                      	stosw
  5537                                  	;mov	[cylnumpos], di
  5538 00001FC5 A1[9A40]                	mov	ax, [cylinders]
  5539 00001FC8 B104                    	mov	cl, 4
  5540 00001FCA B543                    	mov	ch, 'C'
  5541 00001FCC E88400                  	call	write_number
  5542                                  	
  5543 00001FCF B82007                  	mov	ax, 0720h
  5544 00001FD2 AB                      	stosw
  5545 00001FD3 AB                      	stosw
  5546 00001FD4 B048                    	mov	al, 'H'
  5547 00001FD6 AB                      	stosw
  5548 00001FD7 B065                    	mov	al, 'e'
  5549 00001FD9 AB                      	stosw
  5550 00001FDA B061                    	mov	al, 'a'
  5551 00001FDC AB                      	stosw
  5552 00001FDD B064                    	mov	al, 'd'
  5553 00001FDF AB                       	stosw
  5554 00001FE0 B073                    	mov	al, 's'
  5555 00001FE2 AB                       	stosw
  5556 00001FE3 B03A                    	mov	al, ':'
  5557 00001FE5 AB                      	stosw
  5558 00001FE6 B020                    	mov	al, 20h
  5559 00001FE8 AB                      	stosw
  5560                                  	;mov	[hednumpos], di
  5561 00001FE9 A1[9840]                	mov	ax, [heads]
  5562 00001FEC B102                    	mov	cl, 2
  5563 00001FEE B548                    	mov	ch, 'H'
  5564 00001FF0 E86000                  	call	write_number
  5565                                  
  5566 00001FF3 B82007                  	mov	ax, 0720h
  5567 00001FF6 AB                      	stosw
  5568 00001FF7 AB                      	stosw
  5569 00001FF8 B053                    	mov	al, 'S'
  5570 00001FFA AB                      	stosw
  5571 00001FFB B065                    	mov	al, 'e'
  5572 00001FFD AB                      	stosw
  5573 00001FFE B063                    	mov	al, 'c'
  5574 00002000 AB                      	stosw
  5575 00002001 B074                    	mov	al, 't'
  5576 00002003 AB                       	stosw
  5577 00002004 B06F                    	mov	al, 'o'
  5578 00002006 AB                      	stosw
  5579 00002007 B072                    	mov	al, 'r'
  5580 00002009 AB                       	stosw
  5581 0000200A B073                    	mov	al, 's'
  5582 0000200C AB                       	stosw
  5583 0000200D B03A                    	mov	al, ':'
  5584 0000200F AB                      	stosw
  5585 00002010 B020                    	mov	al, 20h
  5586 00002012 AB                      	stosw
  5587                                  	;mov	[secnumpos], di
  5588 00002013 A1[9640]                	mov	ax, [sectors]
  5589 00002016 B102                    	mov	cl, 2
  5590 00002018 B553                    	mov	ch, 'S'
  5591 0000201A E83600                  	call	write_number
  5592                                  
  5593 0000201D B116                    	mov	cl, 22
  5594 0000201F B82007                  	mov	ax, 0720h
  5595 00002022 F3AB                    	rep	stosw
  5596                                  	
  5597 00002024 B150                    	mov	cl, 80 
  5598 00002026 B02D                    	mov	al, "-"
  5599 00002028 F3AB                    	rep	stosw
  5600                                  
  5601                                  	;mov	cl, 80
  5602 0000202A B1A0                    	mov	cl, 160 ; 11/02/2019
  5603 0000202C B020                    	mov	al, 20h
  5604 0000202E F3AB                    	rep	stosw
  5605                                  
  5606 00002030 BA0006                  	mov	dx, 0600h ; DH = row, DL = 0 column
  5607 00002033 31DB                    	xor	bx, bx ; BH = video page (0)
  5608 00002035 B402                    	mov	ah, 02h ; set cursor position
  5609 00002037 CD10                    	int	10h
  5610                                  
  5611                                  	; 12/02/2019
  5612                                  	; new file ?
  5613 00002039 380E[C56E]              	cmp	byte [existingfile], cl ; 0
  5614 0000203D 7712                    	ja	short dchstbl_2
  5615                                  
  5616 0000203F 81C7A005                	add	di, 9*160 ; 9 rows (CHS_msg)
  5617                                  
  5618 00002043 BE[C941]                	mov	si, CHS_msg
  5619 00002046 E8ECFD                  	call	print_msg
  5620                                  
  5621 00002049 B92003                  	mov	cx, 10*80
  5622 0000204C B82007                  	mov	ax, 0720h
  5623 0000204F F3AB                    	rep	stosw
  5624                                  dchstbl_2:
  5625 00002051 07                      	pop	es
  5626 00002052 C3                      	retn
  5627                                  
  5628                                  ;-----------------------------------------------------------------------------
  5629                                  
  5630                                  write_number:
  5631 00002053 89CE                    	mov	si, cx
  5632 00002055 31D2                    	xor	dx, dx
  5633 00002057 BB0A00                  	mov	bx, 10
  5634                                  wnum_1:
  5635 0000205A F7F3                    	div	bx
  5636 0000205C 52                      	push	dx
  5637 0000205D 31D2                    	xor	dx, dx
  5638 0000205F FEC9                    	dec	cl
  5639 00002061 75F7                    	jnz	short wnum_1
  5640 00002063 89F1                    	mov	cx, si
  5641 00002065 B407                    	mov	ah, 07h
  5642 00002067 88E8                    	mov	al, ch
  5643 00002069 30ED                    	xor	ch, ch
  5644 0000206B 3806[A36E]              	cmp	byte [chs_focus], al
  5645 0000206F 7502                    	jne	short wnum_2
  5646 00002071 B40F                    	mov	ah, 0Fh
  5647                                  wnum_2:
  5648 00002073 5A                      	pop	dx
  5649 00002074 88D0                    	mov	al, dl
  5650 00002076 0430                    	add	al, '0'
  5651 00002078 AB                      	stosw
  5652 00002079 E2F8                    	loop	wnum_2
  5653 0000207B C3                      	retn
  5654                                  
  5655                                  ;-----------------------------------------------------------------------------
  5656                                  
  5657                                  partition_size_input:
  5658 0000207C C706[AA6E]0000          	mov	word [pSize_multiplier+2], 0
  5659 00002082 C606[AF6E]42            	mov	byte [msg_psize_unit+1], 'B'
  5660 00002087 A0[AE6E]                	mov	al, [pSize_unit]
  5661 0000208A 3C25                    	cmp	al, '%'
  5662 0000208C 751F                    	jne	short psu_0
  5663                                  	; 08/02/2019
  5664                                  	; calculate sector count for max. available sectors percentage
  5665 0000208E 8B16[9E6E]              	mov	dx, [pp_Sectors+2] ; max. available sectors
  5666 00002092 A1[9C6E]                	mov	ax, [pp_Sectors]   ; for a new partition
  5667                                  	;mov	dx, [total_sectors+2]
  5668                                  	;mov	ax, [total_sectors]
  5669 00002095 B96400                  	mov	cx, 100
  5670 00002098 E89BED                  	call	div32
  5671 0000209B A3[A86E]                	mov	[pSize_multiplier], ax
  5672 0000209E B400                    	mov	ah, 0
  5673 000020A0 8826[AF6E]              	mov	[msg_psize_unit+1], ah
  5674 000020A4 C606[AC6E]02            	mov	byte [pSize_maxdigits], 2
  5675 000020A9 B025                    	mov	al, '%'
  5676 000020AB EB60                    	jmp	short psu_6
  5677                                  psu_0:
  5678 000020AD 3C43                    	cmp	al, 'C'
  5679 000020AF 7517                    	jne	short psu_1
  5680 000020B1 A1[9640]                	mov	ax, [sectors]
  5681 000020B4 F726[9840]              	mul	word [heads]
  5682 000020B8 A3[A86E]                	mov	[pSize_multiplier], ax	
  5683 000020BB C606[AC6E]04            	mov	byte [pSize_maxdigits], 4
  5684                                  	;sub	dh, dh
  5685 000020C0 8836[AF6E]              	mov	[msg_psize_unit+1], dh
  5686 000020C4 B043                    	mov	al, 'C'
  5687 000020C6 EB45                    	jmp	short psu_6
  5688                                  psu_1:
  5689 000020C8 3C47                    	cmp	al, 'G'
  5690 000020CA 7513                    	jne	short psu_2
  5691 000020CC C706[A86E]0008          	mov	word [pSize_multiplier], 2*1024
  5692 000020D2 C706[AA6E]0004          	mov	word [pSize_multiplier+2], 1024
  5693 000020D8 C606[AC6E]01            	mov	byte [pSize_maxdigits], 1
  5694 000020DD EB2E                    	jmp	short psu_6
  5695                                  psu_2:
  5696 000020DF 3C4D                    	cmp	al, 'M'
  5697 000020E1 750D                    	jne	short psu_3
  5698 000020E3 C706[A86E]0008          	mov	word [pSize_multiplier], 2*1024
  5699 000020E9 C606[AC6E]04            	mov	byte [pSize_maxdigits], 4
  5700 000020EE EB1D                    	jmp	short psu_6
  5701                                  psu_3:
  5702 000020F0 3C4B                    	cmp	al, 'K'
  5703 000020F2 7508                    	jne	short psu_4
  5704 000020F4 C706[A86E]0200          	mov	word [pSize_multiplier], 2
  5705 000020FA EB0C                    	jmp	short psu_5
  5706                                  psu_4:
  5707                                  	; al = 'S'
  5708 000020FC 30E4                    	xor	ah, ah
  5709 000020FE 8826[AF6E]              	mov	[msg_psize_unit+1], ah
  5710 00002102 C706[A86E]0100          	mov	word [pSize_multiplier], 1
  5711                                  psu_5:
  5712 00002108 C606[AC6E]07            	mov	byte [pSize_maxdigits], 7
  5713                                  psu_6:
  5714 0000210D A2[8F4F]                	mov	[msg_partition_size_x], al
  5715 00002110 BE[7B4F]                	mov	si, msg_partition_size
  5716 00002113 E81FFD                  	call	print_msg
  5717                                  
  5718 00002116 89E5                    	mov	bp, sp
  5719 00002118 31DB                    	xor	bx, bx
  5720 0000211A 891E[A46E]              	mov	[pSize_temp], bx ; 0
  5721                                  	;mov	[pSize_temp+2], bx ; 0
  5722 0000211E 881E[AD6E]              	mov	[pSize_digitpos], bl ; 0
  5723                                  	; bh = 0  ; video page
  5724 00002122 B403                    	mov     ah, 3 ; get cursor pos
  5725 00002124 CD10                    	int     10h
  5726 00002126 8916[9755]              	mov	[Cursor_Pos], dx
  5727                                  	; 09/02/2019
  5728 0000212A B307                    	mov     bl, 7   ; page 0, color 7 (light gray)
  5729                                  psu_7:
  5730 0000212C 30E4                    	xor	ah, ah
  5731 0000212E CD16                    	int	16h
  5732                                  
  5733 00002130 3C30                    	cmp	al, '0'
  5734 00002132 721F                    	jb	short psu_8
  5735 00002134 3C39                    	cmp	al, '9'
  5736 00002136 77F4                    	ja	short psu_7
  5737 00002138 8A1E[AD6E]              	mov	bl, [pSize_digitpos]
  5738 0000213C 3A1E[AC6E]              	cmp	bl, [pSize_maxdigits]
  5739 00002140 73EA                    	jnb	short psu_7
  5740 00002142 FE06[AD6E]              	inc	byte [pSize_digitpos]
  5741 00002146 2C30                    	sub	al, '0'
  5742 00002148 30E4                    	xor	ah, ah
  5743 0000214A 50                      	push	ax
  5744 0000214B 0430                    	add	al, '0'
  5745 0000214D B40E                    	mov	ah, 0Eh	; write char as tty
  5746                                  	;mov	bx, 7   ; page 0, color 7 (light gray)
  5747 0000214F CD10                    	int	10h
  5748 00002151 EBD9                    	jmp	short psu_7
  5749                                  psu_8:
  5750 00002153 20C0                    	and	al, al
  5751 00002155 0F849500                	jz	psu_15 ; check for left arrow key 
  5752 00002159 3C1B                    	cmp	al, 27
  5753 0000215B 0F849C00                	je	psu_16esc ; ESCAPE key
  5754 0000215F 0F878500                	ja	psu_14 ; check for left arrow key
  5755 00002163 3C0D                    	cmp	al, 13
  5756                                  	;je	short psu_9  ; ENTER key
  5757 00002165 7249                    	jb	short psu_11 ; check for backspace key
  5758                                  	;jmp	short psu_7
  5759 00002167 77C3                    	ja	short psu_7
  5760                                  psu_9:
  5761 00002169 31C0                    	xor	ax, ax
  5762 0000216B A3[A66E]                	mov	[pSize_temp+2], ax ; 0 ; 08/02/2019
  5763 0000216E 3806[AD6E]              	cmp	byte [pSize_digitpos], al ; 0
  5764 00002172 0F868F00                	jna	psu_16
  5765                                  	;xor	bh, bh
  5766 00002176 8A1E[AD6E]              	mov	bl, [pSize_digitpos]
  5767 0000217A FECB                    	dec	bl
  5768 0000217C D0E3                    	shl	bl, 1
  5769 0000217E 01E3                    	add	bx, sp
  5770 00002180 8B07                    	mov	ax, [bx]
  5771 00002182 A3[A46E]                	mov	[pSize_temp], ax
  5772                                  	;mov	word [pSize_temp+2], 0
  5773 00002185 B90A00                  	mov	cx, 10
  5774                                  psu_10:
  5775 00002188 FE0E[AD6E]              	dec	byte [pSize_digitpos]
  5776 0000218C 7477                    	jz	short psu_16
  5777                                  	
  5778 0000218E A1[A46E]                	mov	ax, [pSize_temp]
  5779 00002191 8B16[A66E]              	mov	dx, [pSize_temp+2]
  5780                                  	;mov	cx, 10
  5781 00002195 E8ACEC                  	call	mul32
  5782                                  	;mov	[pSize_temp], ax
  5783                                  	;mov	[pSize_temp+2], dx
  5784                                  	;xor	bh, bh
  5785 00002198 8A1E[AD6E]              	mov	bl, [pSize_digitpos]
  5786 0000219C FECB                    	dec	bl
  5787 0000219E D0E3                    	shl	bl, 1
  5788 000021A0 01E3                    	add	bx, sp ; (*)
  5789                                  	;mov	ax, [bx]
  5790                                  	;add	[pSize_temp], ax
  5791                                  	;adc	word [pSize_temp+2], 0
  5792 000021A2 0307                    	add	ax, [bx]
  5793 000021A4 83D200                  	adc	dx, 0
  5794 000021A7 A3[A46E]                	mov	[pSize_temp], ax
  5795 000021AA 8916[A66E]              	mov	[pSize_temp+2], dx
  5796 000021AE EBD8                    	jmp	short psu_10
  5797                                  	
  5798                                  	; Left arrow, backspace, DEL key checking
  5799                                  psu_11:
  5800 000021B0 3C08                    	cmp	al, 8 ; backspace key
  5801 000021B2 0F8576FF                	jne	psu_7
  5802                                  psu_12:
  5803                                  	;; bh = 0  ; video page
  5804                                  	;mov	ah, 3 ; get cursor pos
  5805                                  	;int	10h
  5806                                  	;cmp	dl, [Cursor_Pos]
  5807                                  	;jna	short psu_13
  5808                                  	;dec	dl
  5809                                  	;dec	byte [pSize_digitpos]
  5810                                  
  5811                                  	; 08/02/2019
  5812 000021B6 8B16[9755]              	mov	dx, [Cursor_Pos]
  5813 000021BA 8A1E[AD6E]              	mov	bl, [pSize_digitpos]
  5814 000021BE 20DB                    	and	bl, bl
  5815 000021C0 741D                    	jz	short psu_13
  5816                                  
  5817 000021C2 FECB                    	dec	bl 
  5818 000021C4 881E[AD6E]              	mov	[pSize_digitpos], bl
  5819                                  	
  5820 000021C8 00DA                    	add	dl, bl
  5821                                  
  5822                                  	; bh = 0  ; video page
  5823 000021CA B402                    	mov	ah, 2 ; set cursor pos
  5824 000021CC CD10                    	int	10h
  5825                                  	;mov	bl, dl
  5826                                  	;sub	bl, [Cursor_Pos]
  5827 000021CE B90100                  	mov	cx, 1
  5828 000021D1 B409                    	mov	ah, 9 ; write char at current curs pos
  5829 000021D3 B020                    	mov	al, 20h ; space (blank)
  5830 000021D5 8800                    	mov	[si+bx], al
  5831                                  	; bh = 0 ; video page
  5832 000021D7 B307                    	mov	bl, 7 ; attribute/color (light gray)
  5833 000021D9 CD10                    	int	10h
  5834                                  
  5835                                  	; 09/02/2019
  5836 000021DB 58                      	pop	ax ; remove last digit on top of stack 
  5837                                  		   ; set sp to correct position for BX (*)
  5838 000021DC E94DFF                  	jmp	psu_7
  5839                                  psu_13:
  5840 000021DF B40E                    	mov	ah, 0Eh
  5841 000021E1 B007                    	mov	al, 7
  5842                                  	;mov	bx, 7
  5843 000021E3 CD10                    	int	10h
  5844 000021E5 E944FF                  	jmp	psu_7
  5845                                  psu_14:
  5846 000021E8 3CE0                    	cmp	al, 0E0h
  5847 000021EA 0F853EFF                	jne	psu_7
  5848                                  psu_15:    
  5849 000021EE 80FC4B                  	cmp	ah, 4Bh ; left arrow
  5850 000021F1 74C3                    	je	short psu_12
  5851 000021F3 80FC53                  	cmp	ah, 53h ; DEL key (backspace)
  5852 000021F6 74BE                    	je	short psu_12
  5853 000021F8 E931FF                  	jmp	psu_7
  5854                                  
  5855                                  psu_16esc:
  5856 000021FB 31C9                    	xor	cx, cx ; 0
  5857 000021FD 890E[A46E]              	mov	[pSize_temp], cx
  5858 00002201 890E[A66E]              	mov	[pSize_temp+2], cx
  5859                                  psu_16:
  5860 00002205 89EC                    	mov	sp, bp
  5861                                  
  5862 00002207 803E[AE6E]53            	cmp	byte [pSize_unit], 'S'
  5863 0000220C 7508                    	jne	short psu_17 
  5864                                  
  5865 0000220E BE[EC65]                	mov	si, msg_sectors_crlf
  5866 00002211 E821FC                  	call	print_msg
  5867                                  	;xor	bx, bx
  5868 00002214 EB0C                    	jmp	short psu_18
  5869                                  psu_17:
  5870 00002216 BE[AE6E]                	mov	si, msg_psize_unit
  5871 00002219 E819FC                  	call	print_msg
  5872                                  
  5873 0000221C BE[5356]                	mov	si, CRLF
  5874 0000221F E813FC                  	call	print_msg
  5875                                  psu_18:
  5876 00002222 A1[A46E]                	mov	ax, [pSize_temp]
  5877 00002225 8B16[A66E]              	mov	dx, [pSize_temp+2]
  5878 00002229 89C1                    	mov	cx, ax
  5879 0000222B 09D1                    	or	cx, dx
  5880                                  	;jz	short psu_20
  5881 0000222D 7422                    	jz	short psu_21 ; 08/02/2019
  5882 0000222F 8B0E[A86E]              	mov	cx, [pSize_multiplier]
  5883 00002233 803E[AE6E]43            	cmp	byte [pSize_unit], 'C'
  5884 00002238 7413                    	je	short psu_20 ; 09/02/2019
  5885                                  	;jne	short psu_19
  5886                                  	;call	mul32
  5887                                  	; 08/02/2019
  5888                                  	; dx:ax = requested partition size in sectors
  5889                                  	;retn	
  5890                                  ;psu_19:
  5891                                  	;mov	cx, [pSize_multiplier]
  5892 0000223A 83F901                  	cmp	cx, 1
  5893                                  	;jna	short psu_20
  5894 0000223D 7703                    	ja	short psu_19
  5895                                  	; 09/02/2019
  5896 0000223F 31DB                    	xor	bx, bx
  5897 00002241 C3                      	retn
  5898                                  psu_19:
  5899 00002242 E8FFEB                  	call	mul32
  5900                                  	;and	bx, bx
  5901                                  	;jnz	short psu_22 ; 09/02/2019
  5902 00002245 8B0E[AA6E]              	mov	cx, [pSize_multiplier+2]
  5903 00002249 09C9                    	or	cx, cx
  5904                                  	;jz	short psu_20
  5905 0000224B 7405                    	jz	short psu_22 ; 09/02/2019
  5906                                  psu_20:
  5907 0000224D E8F4EB                  	call	mul32
  5908 00002250 C3                      	retn
  5909                                  psu_21:
  5910 00002251 F9                      	stc
  5911                                  psu_22:
  5912 00002252 C3                      	retn
  5913                                  
  5914                                  ;-----------------------------------------------------------------------------
  5915                                  
  5916                                  partition_type_input:
  5917 00002253 BE[954F]                	mov	si, msg_partition_type
  5918 00002256 E8DCFB                  	call	print_msg
  5919                                  
  5920 00002259 31DB                    	xor	bx, bx
  5921                                  
  5922 0000225B 881E[BE6E]              	mov	[pType_pos], bl ; 0
  5923 0000225F 891E[BF6E]              	mov	[pType_num], bx ; 0
  5924                                  
  5925                                  	; bh = 0  ; video page
  5926 00002263 B403                    	mov     ah, 3 ; get cursor pos
  5927 00002265 CD10                    	int     10h
  5928 00002267 8916[9755]              	mov	[Cursor_Pos], dx
  5929                                  ptu_0:
  5930 0000226B 30E4                    	xor	ah, ah
  5931 0000226D CD16                    	int	16h
  5932                                  
  5933 0000226F 803E[BE6E]01            	cmp	byte [pType_pos], 1
  5934 00002274 773F                    	ja	short ptu_5
  5935                                  
  5936 00002276 3C30                    	cmp	al, '0'
  5937 00002278 723B                    	jb	short ptu_5
  5938 0000227A 3C39                    	cmp	al, '9'
  5939 0000227C 7707                    	ja	short ptu_1
  5940 0000227E 88C4                    	mov	ah, al
  5941 00002280 80EC30                  	sub	ah, '0'
  5942 00002283 EB13                    	jmp	short ptu_2 
  5943                                  ptu_1:
  5944 00002285 3CE0                    	cmp     al, 0E0h
  5945 00002287 7473                    	je	short ptu_9
  5946                                  
  5947 00002289 24DF                    	and	al, 0DFh
  5948 0000228B 3C41                    	cmp	al, 'A'
  5949 0000228D 72DC                    	jb	short ptu_0
  5950 0000228F 3C46                    	cmp	al, 'F'
  5951 00002291 77D8                    	ja	short ptu_0
  5952 00002293 88C4                    	mov	ah, al
  5953 00002295 80EC37                  	sub	ah, 'A'-10
  5954                                  ptu_2:
  5955 00002298 803E[BE6E]00            	cmp	byte [pType_pos], 0
  5956 0000229D 7606                    	jna	short ptu_3
  5957 0000229F 8826[C06E]              	mov	[pType_num+1], ah
  5958 000022A3 EB04                    	jmp	short ptu_4 
  5959                                  ptu_3:
  5960 000022A5 8826[BF6E]              	mov	[pType_num], ah
  5961                                  ptu_4:
  5962 000022A9 B40E                    	mov	ah, 0Eh
  5963 000022AB B307                    	mov	bl, 7
  5964 000022AD CD10                    	int	10h
  5965                                  
  5966 000022AF FE06[BE6E]              	inc	byte [pType_pos]
  5967                                  
  5968 000022B3 EBB6                    	jmp	short ptu_0
  5969                                  ptu_5:
  5970 000022B5 20C0                    	and	al, al
  5971 000022B7 7443                    	jz	short ptu_9 ; check for left arrow key 
  5972 000022B9 3C1B                    	cmp	al, 27
  5973 000022BB 744C                    	je	short ptu_10 ; ESCAPE key
  5974 000022BD 77AC                    	ja	short ptu_0
  5975 000022BF 3C0D                    	cmp	al, 13
  5976 000022C1 744A                    	je	short ptu_11  ; ENTER key
  5977 000022C3 77A6                    	ja	short ptu_0
  5978                                  ptu_6:
  5979                                  	; Left arrow, backspace, DEL key checking
  5980                                  
  5981 000022C5 3C08                    	cmp	al, 8 ; backspace key
  5982 000022C7 75A2                    	jne	short ptu_0
  5983                                  ptu_7:
  5984                                  	; bh = 0  ; video page
  5985 000022C9 B403                    	mov	ah, 3 ; get cursor pos
  5986 000022CB CD10                    	int	10h
  5987 000022CD 3A16[9755]              	cmp	dl, [Cursor_Pos]
  5988 000022D1 7620                    	jna	short ptu_8
  5989 000022D3 FECA                    	dec	dl
  5990 000022D5 FE0E[BE6E]              	dec	byte [pType_pos]
  5991                                  	; bh = 0  ; video page
  5992 000022D9 B402                    	mov	ah, 2 ; set cursor pos
  5993 000022DB CD10                    	int	10h
  5994 000022DD 88D3                    	mov	bl, dl
  5995 000022DF 2A1E[9755]              	sub	bl, [Cursor_Pos] 
  5996 000022E3 B90100                  	mov	cx, 1
  5997 000022E6 B409                    	mov	ah, 9 ; write char at current curs pos
  5998 000022E8 B020                    	mov	al, 20h ; space (blank)
  5999 000022EA 8800                    	mov	[si+bx], al
  6000                                  	; bh = 0 ; video page
  6001 000022EC B307                    	mov	bl, 7 ; attribute/color (light gray)
  6002 000022EE CD10                    	int	10h
  6003 000022F0 E978FF                  	jmp	ptu_0
  6004                                  ptu_8:
  6005 000022F3 B40E                    	mov	ah, 0Eh
  6006 000022F5 B007                    	mov	al, 7
  6007 000022F7 CD10                    	int	10h
  6008 000022F9 E96FFF                  	jmp	ptu_0
  6009                                  ptu_9:    
  6010 000022FC 80FC4B                  	cmp	ah, 4Bh ; left arrow
  6011 000022FF 74C8                    	je	short ptu_7
  6012 00002301 80FC53                  	cmp	ah, 53h ; DEL key (backspace)
  6013 00002304 74C3                    	je	short ptu_7
  6014 00002306 E962FF                  	jmp	ptu_0
  6015                                  
  6016                                  ptu_10: ; ESCAPE
  6017 00002309 B000                    	mov	al, 0
  6018                                  	; partition type is 0 (none)
  6019 0000230B EB12                    	jmp	short ptu_12
  6020                                  ptu_11: ; ENTER
  6021 0000230D A0[BF6E]                	mov	al, [pType_num]
  6022 00002310 803E[BE6E]01            	cmp	byte [pType_pos], 1
  6023 00002315 7608                    	jna	short ptu_12
  6024 00002317 B410                    	mov	ah, 16
  6025 00002319 F6E4                    	mul	ah
  6026 0000231B 0206[C06E]              	add	al, [pType_num+1]
  6027                                  ptu_12:
  6028 0000231F 50                      	push	ax
  6029 00002320 E8B1FB                  	call	bin_to_hex
  6030 00002323 A3[AB4F]                	mov	[msg_ptype_num], ax
  6031                                  	; bh = 0  ; video page
  6032 00002326 B402                    	mov	ah, 2 ; set cursor pos
  6033 00002328 8B16[9755]              	mov	dx, [Cursor_Pos]
  6034 0000232C CD10                    	int	10h
  6035 0000232E BE[AB4F]                	mov	si, msg_ptype_num
  6036 00002331 E801FB                  	call	print_msg
  6037 00002334 58                      	pop	ax
  6038 00002335 C3                      	retn
  6039                                  
  6040                                  ;-----------------------------------------------------------------------------
  6041                                  
  6042                                  show_selected_partition:
  6043                                  	; INPUT ->
  6044                                  	; 	DS:SI = Partition table row address
  6045                                  
  6046                                  	pt_s_offset	equ 7
  6047                                  	pt_bh_offset	equ 11
  6048                                  	pt_bs_offset	equ 15
  6049                                  	pt_bc_offset	equ 19
  6050                                  	pt_fs_offset	equ 23
  6051                                  	pt_eh_offset	equ 27
  6052                                  	pt_es_offset	equ 31
  6053                                  	pt_ec_offset	equ 35
  6054                                  	pt_rs_offset	equ 41
  6055                                  	pt_ts_offset	equ 52
  6056                                  	pt_fsn_offset	equ 63
  6057                                  
  6058                                  	; clear screen
  6059 00002336 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  6060 00002339 CD10                    	int	10h
  6061                                  
  6062 0000233B 89F0                    	mov	ax, si
  6063 0000233D 2D[EA58]                	sub	ax, MasterBootBuff + pTableOffset ; + 446
  6064 00002340 C0E804                  	shr	al, 4 ; from offset to partition number
  6065 00002343 0431                    	add	al, '1'  ; 1 based partition number (chr)
  6066                                  	; Write partition number to the header location
  6067 00002345 A2[6B51]                	mov	[msg_selected_partition+43], al ; '1' to '4'
  6068                                  	
  6069                                  	; Partition number will be used at formatting stage
  6070 00002348 A2[3A54]                	mov	[partition_num_chr], al ; number + '0'
  6071                                  
  6072 0000234B B268                    	mov	dl, 'h'
  6073 0000234D 8A04                    	mov	al, [si+ptBootable]
  6074 0000234F E882FB                  	call	bin_to_hex
  6075 00002352 A3[8752]                	mov	[pt_row+pt_s_offset], ax
  6076 00002355 8816[8952]              	mov	[pt_row+pt_s_offset+2], dl ; 'h'
  6077 00002359 8A4401                  	mov	al, [si+ptBeginHead]
  6078 0000235C E875FB                  	call	bin_to_hex
  6079 0000235F A3[8B52]                	mov	[pt_row+pt_bh_offset], ax
  6080 00002362 8816[8D52]              	mov	[pt_row+pt_bh_offset+2], dl ; 'h'
  6081 00002366 8A4402                  	mov	al, [si+ptBeginSector]
  6082 00002369 E868FB                  	call	bin_to_hex
  6083 0000236C A3[8F52]                	mov	[pt_row+pt_bs_offset], ax
  6084 0000236F 8816[9152]              	mov	[pt_row+pt_bs_offset+2], dl ; 'h'
  6085 00002373 8A4403                  	mov	al, [si+ptBeginCylinder]
  6086 00002376 E85BFB                  	call	bin_to_hex
  6087 00002379 A3[9352]                	mov	[pt_row+pt_bc_offset], ax
  6088 0000237C 8816[9552]              	mov	[pt_row+pt_bc_offset+2], dl ; 'h'
  6089 00002380 8A4404                  	mov	al, [si+ptFileSystemID]
  6090                                   	; Partition type will be used at formatting stage
  6091 00002383 A2[A26E]                	mov	[pp_type_user], al
  6092 00002386 E84BFB                  	call	bin_to_hex
  6093 00002389 A3[9752]                	mov	[pt_row+pt_fs_offset], ax
  6094 0000238C 8816[9952]              	mov	[pt_row+pt_fs_offset+2], dl ; 'h'
  6095 00002390 8A4405                  	mov	al, [si+ptEndHead]
  6096 00002393 E83EFB                  	call	bin_to_hex
  6097 00002396 A3[9B52]                	mov	[pt_row+pt_eh_offset], ax
  6098 00002399 8816[9D52]              	mov	[pt_row+pt_eh_offset+2], dl ; 'h'
  6099 0000239D 8A4406                  	mov	al, [si+ptEndSector]
  6100 000023A0 E831FB                  	call	bin_to_hex
  6101 000023A3 A3[9F52]                	mov	[pt_row+pt_es_offset], ax
  6102 000023A6 8816[A152]              	mov	[pt_row+pt_es_offset+2], dl ; 'h'
  6103 000023AA 8A4407                  	mov	al, [si+ptEndCylinder]
  6104 000023AD E824FB                  	call	bin_to_hex
  6105 000023B0 A3[A352]                	mov	[pt_row+pt_ec_offset], ax
  6106 000023B3 8816[A552]              	mov	[pt_row+pt_ec_offset+2], dl ; 'h'
  6107 000023B7 8A4408                  	mov	al, [si+ptStartSector]
  6108 000023BA E817FB                  	call	bin_to_hex
  6109 000023BD A3[AF52]                	mov	[pt_row+pt_rs_offset+6], ax
  6110 000023C0 8816[B152]              	mov	[pt_row+pt_rs_offset+8], dl ; 'h'
  6111 000023C4 8A4409                  	mov	al, [si+ptStartSector+1]
  6112 000023C7 E80AFB                  	call	bin_to_hex
  6113 000023CA A3[AD52]                	mov	[pt_row+pt_rs_offset+4], ax
  6114 000023CD 8A440A                  	mov	al, [si+ptStartSector+2]
  6115 000023D0 E801FB                  	call	bin_to_hex
  6116 000023D3 A3[AB52]                	mov	[pt_row+pt_rs_offset+2], ax
  6117 000023D6 8A440B                  	mov	al, [si+ptStartSector+3]
  6118 000023D9 E8F8FA                  	call	bin_to_hex
  6119 000023DC A3[A952]                	mov	[pt_row+pt_rs_offset], ax
  6120 000023DF 8A440C                  	mov	al, [si+ptSectors]
  6121 000023E2 E8EFFA                  	call	bin_to_hex
  6122 000023E5 A3[BA52]                	mov	[pt_row+pt_ts_offset+6], ax
  6123 000023E8 8816[BC52]              	mov	[pt_row+pt_ts_offset+8], dl ; 'h'
  6124 000023EC 8A440D                  	mov	al, [si+ptSectors+1]
  6125 000023EF E8E2FA                  	call	bin_to_hex
  6126 000023F2 A3[B852]                	mov	[pt_row+pt_ts_offset+4], ax
  6127 000023F5 8A440E                  	mov	al, [si+ptSectors+2]
  6128 000023F8 E8D9FA                  	call	bin_to_hex
  6129 000023FB A3[B652]                	mov	[pt_row+pt_ts_offset+2], ax
  6130 000023FE 8A440F                  	mov	al, [si+ptSectors+3]
  6131 00002401 E8D0FA                  	call	bin_to_hex
  6132 00002404 A3[B452]                	mov	[pt_row+pt_ts_offset], ax
  6133                                  
  6134 00002407 8A4404                  	mov	al, [si+ptFileSystemID]
  6135 0000240A BF[B641]                	mov	di, valid_partitions
  6136 0000240D B91300                  	mov	cx, 19
  6137 00002410 F2AE                    	repnz	scasb
  6138 00002412 7405                    	jz	short ssp_1
  6139 00002414 B8[A841]                	mov	ax, FS_OTHERS
  6140 00002417 EB0C                    	jmp	short ssp_2
  6141                                  ssp_1:
  6142 00002419 81EF[B741]              	sub	di, valid_partitions + 1
  6143 0000241D B80E00                  	mov	ax, 14
  6144 00002420 F7E7                    	mul	di
  6145 00002422 05[9E40]                	add	ax, FileSys_Names
  6146                                  ssp_2:
  6147 00002425 96                      	xchg	ax, si 
  6148 00002426 B107                    	mov	cl, 7
  6149 00002428 BF[BF52]                	mov	di, pt_row + pt_fsn_offset
  6150 0000242B F3A5                    	rep	movsw
  6151 0000242D 89C7                    	mov	di, ax ; partition table row address
  6152                                  
  6153 0000242F BE[4051]                	mov	si, msg_selected_partition
  6154 00002432 E800FA                  	call	print_msg
  6155                                  
  6156 00002435 BE[2153]                	mov	si, msg_boot_indicator
  6157 00002438 E8FAF9                  	call	print_msg
  6158 0000243B BE[F75D]                	mov	si, msg_YES
  6159 0000243E F60580                  	test	byte [di+ptBootable], 80h
  6160 00002441 7503                    	jnz	short ssp_3
  6161 00002443 BE[FD5D]                	mov	si, msg_NO
  6162                                  ssp_3:
  6163 00002446 E8ECF9                  	call	print_msg
  6164                                  
  6165 00002449 BE[3953]                	mov	si, msg_starting_head
  6166 0000244C E8E6F9                  	call	print_msg
  6167 0000244F 8A4501                  	mov	al, [di+ptBeginHead]
  6168 00002452 E8B200                  	call	write_byte_decimal
  6169 00002455 E8DDF9                  	call	print_msg
  6170 00002458 BE[5153]                	mov	si, msg_starting_sector
  6171 0000245B E8D7F9                  	call	print_msg
  6172 0000245E 8A4502                  	mov	al, [di+ptBeginSector]
  6173 00002461 88C2                    	mov	dl, al  ; bits 7&8 are bits 8&9 of cyl
  6174 00002463 243F                    	and	al, 3Fh ; sector number, 1 to 63
  6175 00002465 E89F00                  	call	write_byte_decimal
  6176 00002468 E8CAF9                  	call	print_msg
  6177 0000246B BE[6953]                	mov	si, msg_starting_cylinder
  6178 0000246E E8C4F9                  	call	print_msg
  6179 00002471 8A4503                  	mov	al, [di+ptBeginCylinder] ; bits 0to7 of cyl
  6180 00002474 C0EA06                  	shr	dl, 6 ; bits 8&9 of cyl
  6181 00002477 88D4                    	mov	ah, dl
  6182 00002479 31D2                    	xor	dx, dx
  6183 0000247B BE[BB6E]                	mov	si, msg_partition_sectors + 7 ; max. 7 digits
  6184                                  	; dx_ax: binary number
  6185 0000247E E83CFA                  	call	bin_to_decimal
  6186                                  	; ds:si = decimal number text address
  6187 00002481 E8B1F9                  	call	print_msg
  6188 00002484 BE[8153]                	mov	si, msg_system_id
  6189 00002487 E8ABF9                  	call	print_msg
  6190                                  	; Write file system name (again, copy)
  6191 0000248A BE[BF52]                	mov	si, pt_row + pt_fsn_offset
  6192                                  	;mov	cx, 14
  6193 0000248D B10E                    	mov	cl, 14
  6194 0000248F B40E                    	mov	ah, 0Eh ; write tty
  6195 00002491 BB0700                  	mov	bx, 7
  6196                                  ssp_4:	 
  6197 00002494 AC                      	lodsb
  6198 00002495 CD10                    	int	10h
  6199 00002497 E2FB                    	loop	ssp_4
  6200                                  
  6201 00002499 BE[9953]                	mov	si, msg_ending_head
  6202 0000249C E896F9                  	call	print_msg
  6203 0000249F 8A4505                  	mov	al, [di+ptEndHead]
  6204 000024A2 E86200                  	call	write_byte_decimal
  6205 000024A5 E88DF9                  	call	print_msg
  6206 000024A8 BE[B153]                	mov	si, msg_ending_sector
  6207 000024AB E887F9                  	call	print_msg
  6208 000024AE 8A4506                  	mov	al, [di+ptEndSector]
  6209 000024B1 88C2                    	mov	dl, al  ; bits 7&8 are bits 8&9 of cyl
  6210 000024B3 243F                    	and	al, 3Fh ; sector number, 1 to 63
  6211 000024B5 E84F00                  	call	write_byte_decimal
  6212 000024B8 E87AF9                  	call	print_msg
  6213 000024BB BE[C953]                	mov	si, msg_ending_cylinder
  6214 000024BE E874F9                  	call	print_msg
  6215 000024C1 8A4507                  	mov	al, [di+ptEndCylinder] ; bits 0to7 of cyl
  6216 000024C4 C0EA06                  	shr	dl, 6 ; bits 8&9 of cyl
  6217 000024C7 88D4                    	mov	ah, dl
  6218 000024C9 31D2                    	xor	dx, dx
  6219 000024CB BE[BB6E]                	mov	si, msg_partition_sectors + 7 ; max. 7 digits
  6220                                  	; dx_ax: binary number
  6221 000024CE E8ECF9                  	call	bin_to_decimal
  6222                                  	; ds:si = decimal number text address
  6223 000024D1 E861F9                  	call	print_msg
  6224                                  
  6225 000024D4 BE[E153]                	mov	si, msg_relative_sectors
  6226 000024D7 E85BF9                  	call	print_msg
  6227 000024DA 8B4508                  	mov	ax, [di+ptStartSector]
  6228 000024DD 8B550A                  	mov	dx, [di+ptStartSector+2]
  6229                                  	;mov	si, msg_partition_sectors + 7 ; max. 11 digits
  6230 000024E0 BE[BB6E]                	mov	si, reserved_bytes + 10 ; max. 11 digits
  6231 000024E3 E8D7F9                  	call	bin_to_decimal
  6232 000024E6 E84CF9                  	call	print_msg
  6233                                  
  6234 000024E9 BE[FB53]                	mov	si, msg_total_sectors
  6235 000024EC E846F9                  	call	print_msg
  6236 000024EF 8B450C                  	mov	ax, [di+ptSectors]
  6237 000024F2 8B550E                  	mov	dx, [di+ptSectors+2]
  6238                                  	;mov	si, msg_partition_sectors + 7 ; max. 11 digits
  6239 000024F5 BE[BB6E]                	mov	si, reserved_bytes + 10 ; max. 11 digits
  6240 000024F8 E8C2F9                  	call	bin_to_decimal	
  6241 000024FB E837F9                  	call	print_msg
  6242                                  
  6243                                  	; 24/02/2019
  6244 000024FE BE[5356]                	mov	si, CRLF
  6245 00002501 E831F9                  	call	print_msg
  6246                                  
  6247 00002504 89FE                    	mov	si, di  ; partition table row address
  6248                                  
  6249 00002506 C3                      	retn
  6250                                  
  6251                                  ;-----------------------------------------------------------------------------
  6252                                  
  6253                                  write_byte_decimal:
  6254                                  	; INPUT ->
  6255                                  	;	AL = binary number
  6256                                  	; OUTPUT ->
  6257                                  	;	DS:SI = decimal number text address
  6258                                  	;	        (ASCIIZ string)
  6259                                  	;
  6260                                  	; (SI, AX, CX will me modified)
  6261                                  
  6262 00002507 BE[BC6E]                	mov	si, msg_partition_sectors + 8
  6263 0000250A B10A                    	mov	cl, 10
  6264                                  wbd_loop:
  6265 0000250C 4E                      	dec	si
  6266 0000250D 30E4                    	xor	ah, ah
  6267 0000250F F6F1                    	div	cl
  6268 00002511 80C430                  	add	ah, '0'
  6269 00002514 8824                    	mov	[si], ah
  6270 00002516 20C0                    	and	al, al
  6271 00002518 75F2                    	jnz	short wbd_loop
  6272 0000251A C3                      	retn
  6273                                  
  6274                                  ;-----------------------------------------------------------------------------
  6275                                  ; 03/02/2019
  6276                                  ; 16/10/2020
  6277                                  
  6278                                  init_partition_tables:
  6279                                  
  6280                                  	; INPUT -> none
  6281                                  	; OUTPUT -> none
  6282                                  	 
  6283                                  	; 12/02/2019
  6284                                  	;cmp	word [MBIDCode], 0AA55h
  6285                                  	;jne	ipt_stc ; invalid
  6286                                  
  6287                                  	; 15/02/2019
  6288                                  	; clear primary partition tables structure/list
  6289                                  
  6290 0000251B BF[4A71]                	mov	di, part_table_boot_ind
  6291 0000251E B92400                  	mov	cx, 36 ; 18*4 = 72 bytes
  6292 00002521 31C0                    	xor	ax, ax ; 0
  6293 00002523 F3AB                    	rep	stosw
  6294                                  
  6295 00002525 A3[9271]                	mov	[pcount], ax ; reset (pcount & ppcount)
  6296 00002528 A3[9471]                	mov	[apcount], ax ; reset (apcount & epnumber)
  6297                                  
  6298 0000252B BE[EA58]                	mov	si, MasterBootBuff+446 ; Partition table offset
  6299                                  	;mov	cx, 4
  6300 0000252E B104                    	mov	cl, 4
  6301 00002530 31FF                    	xor	di, di
  6302                                  ipt_0:
  6303 00002532 8A6404                  	mov	ah, [si+ptFileSystemID]
  6304                                  
  6305 00002535 20E4                    	and	ah, ah
  6306 00002537 0F841801                	jz	ipt_8 ; empty
  6307                                  
  6308 0000253B FE06[9271]              	inc	byte [pcount] ; partition count
  6309                                  
  6310 0000253F 80FC01                  	cmp	ah, 1	; FAT12
  6311 00002542 7427                    	je	short ipt_2
  6312 00002544 80FC04                  	cmp	ah, 4	; FAT16
  6313 00002547 7422                    	je	short ipt_2
  6314 00002549 7224                    	jb	short ipt_3
  6315 0000254B 80FC06                  	cmp	ah, 6	; FAT16 big
  6316 0000254E 741B                    	je	short ipt_2
  6317 00002550 7712                    	ja	short ipt_1 ; EXTENDED
  6318                                  
  6319                                  	;cmp	ah, 5 ; EXTENDED
  6320                                  	;jne	short ipt_3
  6321                                  
  6322 00002552 803E[9571]00            	cmp	byte [epnumber], 0
  6323 00002557 0F87B100                	ja	ipt_stc ; invalid  (more than 1 extended dos partition)
  6324                                  	
  6325 0000255B B005                    	mov	al, 5
  6326 0000255D 28C8                    	sub	al, cl ; partition number 1 to 4
  6327 0000255F A2[9571]                	mov	byte [epnumber], al ; extended partition entry number (1 to 4)
  6328 00002562 EB0B                    	jmp	short ipt_3
  6329                                  ipt_1:
  6330 00002564 80FC0B                  	cmp	ah, 0Bh ; FAT32 (CHS)
  6331 00002567 7506                    	jne	short ipt_3 ; 16/10/2020
  6332                                  	; 26/10/2020
  6333 00002569 7400                    	je	short ipt_2
  6334                                  	;cmp	ah, 07h ; NTFS (Windows FS)
  6335                                  	;jne	short ipt_3 ; accept NTFS as primary dos partition
  6336                                  	;		    ; (then, extended partition can be created)
  6337                                  ipt_2:
  6338 0000256B FE06[9371]              	inc	byte [ppcount] ; primary dos partition count
  6339                                  ipt_3:
  6340 0000256F 88A5[4F71]              	mov	[part_table_sys_id+di], ah  ; Partition Type (FS type)
  6341                                  	
  6342 00002573 8A04                    	mov	al, [si+ptBootable]
  6343                                  
  6344 00002575 20C0                    	and	al, al
  6345 00002577 7413                    	jz	short ipt_4
  6346                                  
  6347 00002579 803E[9471]01            	cmp	byte [apcount], 1 ; check (previous) active partition count
  6348 0000257E 0F838A00                	jnb	ipt_stc  ; invalid (if it is not zero here)
  6349                                  
  6350 00002582 3C80                    	cmp	al, 80h  ; active partition sign/flag?
  6351 00002584 0F858400                	jne	ipt_stc  ; invalid flag
  6352                                  
  6353 00002588 FE06[9471]              	inc	byte [apcount]  ; active partition count  = 1
  6354                                  ipt_4:
  6355 0000258C 8885[4A71]              	mov	[part_table_boot_ind+di], al
  6356                                  
  6357 00002590 A0[9840]                	mov	al, [heads]
  6358                                  ipt_4_fix:
  6359 00002593 FEC8                    	dec	al
  6360 00002595 8A6401                  	mov	ah, [si+ptBeginHead]
  6361 00002598 38E0                    	cmp	al, ah
  6362                                  	;jb	short ipt_retn ; invalid
  6363 0000259A 7272                    	jb	ipt_heads_fix ; 10/02/2019
  6364 0000259C 88A5[4B71]              	mov	[part_table_start_head+di], ah
  6365 000025A0 8A6405                  	mov	ah, [si+ptEndHead]
  6366 000025A3 38E0                    	cmp	al, ah
  6367                                  	;jb	short ipt_retn ; invalid
  6368 000025A5 7267                    	jb	short ipt_heads_fix ; 10/02/2019
  6369 000025A7 88A5[5071]              	mov	[part_table_end_head+di], ah
  6370 000025AB A0[9640]                	mov	al, [sectors]
  6371 000025AE 8A7C02                  	mov	bh, [si+ptBeginSector]
  6372 000025B1 88FC                    	mov	ah, bh
  6373 000025B3 80E43F                  	and	ah, 3Fh ; 63
  6374 000025B6 38E0                    	cmp	al, ah
  6375 000025B8 7253                    	jb	short ipt_retn ; invalid
  6376 000025BA 88A5[4C71]              	mov	[part_table_start_sector+di], ah
  6377 000025BE 8A7406                  	mov	dh, [si+ptEndSector]
  6378 000025C1 88F4                    	mov	ah, dh
  6379 000025C3 80E43F                  	and	ah, 3Fh ; 63
  6380 000025C6 38E0                    	cmp	al, ah
  6381 000025C8 7243                    	jb	short ipt_retn ; invalid
  6382 000025CA 88A5[5171]              	mov	[part_table_end_sector+di], ah
  6383 000025CE C0EF06                  	shr	bh, 6
  6384 000025D1 8A5C03                  	mov	bl, [si+ptBeginCylinder]
  6385 000025D4 A1[9A40]                	mov	ax, [cylinders]
  6386 000025D7 48                      	dec	ax
  6387 000025D8 39D8                    	cmp	ax, bx
  6388 000025DA 7231                    	jb	short ipt_retn ; invalid
  6389 000025DC 899D[4D71]              	mov	[part_table_start_cyl+di], bx
  6390 000025E0 C0EE06                  	shr	dh, 6
  6391 000025E3 8A5407                  	mov	dl, [si+ptEndCylinder]
  6392 000025E6 39D0                    	cmp	ax, dx
  6393 000025E8 7223                    	jb	short ipt_retn ; invalid
  6394 000025EA 8995[5271]              	mov	[part_table_end_cyl+di], dx
  6395                                  
  6396 000025EE 8B4408                  	mov	ax, [si+ptStartSector]
  6397 000025F1 8B540A                  	mov	dx, [si+ptStartSector+2]
  6398                                  
  6399 000025F4 8985[5471]              	mov	[part_table_rel_sec_lw+di], ax
  6400 000025F8 8995[5671]              	mov	[part_table_rel_sec_hw+di], dx
  6401                                  
  6402 000025FC 09D0                    	or	ax, dx
  6403 000025FE 740C                    	jz	short ipt_stc ; invalid (start sector must not be zero)
  6404                                  
  6405 00002600 8B440C                  	mov	ax, [si+ptSectors]
  6406 00002603 8B540E                  	mov	dx, [si+ptSectors+2]
  6407                                  
  6408 00002606 89D3                    	mov	bx, dx
  6409 00002608 09C3                    	or	bx, ax
  6410                                  	;jz	short ipt_stc	; invalid (zero size of partition)
  6411 0000260A 7521                    	jnz	short ipt_6 ; 10/02/2019
  6412                                  
  6413                                  	;cmp	dx, [total_sectors+2]
  6414                                  	;ja	short ipt_stc	; invalid (partition size > disk capacity)
  6415                                  	;jb	short ipt_6
  6416                                  	;;cmp	ax, [total_sectors] ; (ax + 1) <= total sectors
  6417                                  	;jb	short ipt_6
  6418                                  	
  6419                                  ipt_stc:
  6420                                  	; invalid MBR data
  6421 0000260C F9                      	stc
  6422                                  ipt_retn:
  6423 0000260D C3                      	retn
  6424                                  
  6425                                  ipt_heads_fix:
  6426                                  	; 10/02/2019
  6427                                  	; AL = [heads] - 1
  6428                                  
  6429 0000260E F606[9A40]01            	test	byte [cylinders], 1
  6430 00002613 75F7                    	jnz	short ipt_stc ; odd cylinder count (can not be shifted)
  6431                                  	
  6432 00002615 FEC0                    	inc	al ; = [heads]
  6433 00002617 3C08                    	cmp	al, 8
  6434 00002619 77F1                    	ja	short ipt_stc ; this fix is needed for <= 16 heads (& 17 spt)
  6435 0000261B D0E0                    	shl	al, 1
  6436 0000261D A2[9840]                	mov	[heads], al ; heads = heads*2
  6437 00002620 D12E[9A40]              	shr	word [cylinders], 1 ; cylinders = cylinders/2
  6438 00002624 E96CFF                  	jmp	ipt_4_fix
  6439                                  
  6440                                  ipt_5:
  6441 00002627 83C712                  	add	di, 18
  6442 0000262A E905FF                  	jmp	ipt_0
  6443                                  
  6444                                  ipt_6:
  6445 0000262D 8985[5871]              	mov	[part_table_num_sec_lw+di], ax
  6446 00002631 8995[5A71]              	mov	[part_table_num_sec_hw+di], dx
  6447                                  
  6448 00002635 0385[5471]              	add	ax, [part_table_rel_sec_lw+di]
  6449 00002639 1395[5671]              	adc	dx, [part_table_rel_sec_hw+di]
  6450 0000263D 72CE                    	jc	short ipt_retn  ; invalid
  6451                                  
  6452 0000263F 3B16[8E6E]              	cmp	dx, [total_sectors+2]
  6453 00002643 77C7                    	ja	short ipt_stc	; invalid (partition end > disk capacity)
  6454 00002645 7206                    	jb	short ipt_7
  6455 00002647 3B06[8C6E]              	cmp	ax, [total_sectors] ; ax <= total sectors
  6456 0000264B 77BF                    	ja	short ipt_stc	; invalid (partition end > disk capacity)
  6457                                  ipt_7:
  6458 0000264D 83C610                  	add	si, 16
  6459 00002650 E2D5                    	loop	ipt_5
  6460                                  	
  6461                                  	; OK!
  6462                                  
  6463                                  	;clc
  6464 00002652 C3                      	retn
  6465                                  
  6466                                  ipt_8:
  6467                                  	; Empty partition table check (all of 16 bytes must be 0)
  6468 00002653 51                      	push	cx
  6469 00002654 B108                    	mov	cl, 8
  6470                                  ipt_9:
  6471 00002656 AD                      	lodsw
  6472 00002657 09C0                    	or	ax, ax
  6473 00002659 7506                    	jnz	short ipt_10
  6474 0000265B E2F9                    	loop	ipt_9
  6475 0000265D 59                      	pop	cx
  6476 0000265E E2C7                    	loop	ipt_5
  6477                                  	
  6478                                  	;clc
  6479 00002660 C3                      	retn
  6480                                  ipt_10:
  6481 00002661 59                      	pop	cx
  6482                                  	; invalid
  6483 00002662 F9                      	stc
  6484 00002663 C3                      	retn
  6485                                  
  6486                                  ;-----------------------------------------------------------------------------
  6487                                  ; 25/10/2020
  6488                                  
  6489                                  	; 02/02/2019
  6490                                  	
  6491                                  sort_partition_table:
  6492                                  
  6493                                  	; INPUT -> none
  6494                                  	; OUTPUT -> none
  6495                                  
  6496 00002664 31DB                    	xor	bx, bx
  6497                                  	;jmp	short sortpt_2 ; 25/10/2020
  6498                                  sortpt_1:
  6499 00002666 889F[D66E]              	mov	[bx+sort], bl ; 0
  6500 0000266A FEC3                    	inc	bl
  6501                                  sortpt_2:
  6502 0000266C 80FB04                  	cmp	bl, 4 ; number of partition table entries to sort
  6503 0000266F 72F5                    	jb	short sortpt_1
  6504                                  
  6505                                  	; Do a bubble sort
  6506                                  
  6507 00002671 EB04                    	jmp	short sortpt_4
  6508                                  sortpt_3:
  6509                                  	; Sort until we don't do a swap
  6510                                  
  6511 00002673 08C9                    	or	cl, cl ; sort changed ?
  6512 00002675 744A                    	jz	short sortpt_8 ; no.
  6513                                  sortpt_4:
  6514 00002677 30C9                    	xor	cl, cl
  6515                                  
  6516 00002679 B301                    	mov	bl, 1
  6517                                  
  6518 0000267B B212                    	mov	dl, 18  ; partition table structure size
  6519 0000267D EB07                    	jmp	short sortpt_6
  6520                                  sortpt_5:
  6521 0000267F FEC3                    	inc	bl
  6522                                  
  6523 00002681 80FB04                  	cmp	bl, 4
  6524 00002684 73ED                    	jnb	short sortpt_3
  6525                                  
  6526                                  sortpt_6:
  6527 00002686 8A87[D66E]              	mov	al, [bx+sort]
  6528                                  
  6529 0000268A F6E2                    	mul	dl
  6530                                  
  6531 0000268C 89C6                    	mov	si, ax
  6532                                  
  6533 0000268E 8BBC[5271]              	mov	di, [part_table_end_cyl+si]
  6534                                  
  6535 00002692 8A87[D56E]              	mov	al, [bx+sort-1]
  6536                                  
  6537 00002696 F6E2                    	mul	dl ; * 18
  6538                                  
  6539 00002698 97                      	xchg	di, ax
  6540                                  
  6541 00002699 3985[5271]              	cmp	[part_table_end_cyl+di], ax ; previous > current
  6542 0000269D 7714                    	ja	short sortpt_7 ; swap order indicators
  6543                                  
  6544                                  	; If current entry is empty partition entry
  6545                                  	; and previous entry is not empty partition entry
  6546                                  	; swap them.
  6547                                  
  6548 0000269F 8B84[5A71]              	mov	ax, [part_table_num_sec_hw+si] ; current entry
  6549 000026A3 0B84[5871]              	or	ax, [part_table_num_sec_lw+si]
  6550 000026A7 75D6                    	jnz	short sortpt_5
  6551                                  
  6552 000026A9 8B85[5A71]              	mov	ax, [part_table_num_sec_hw+di] ; previous entry
  6553 000026AD 0B85[5871]              	or	ax, [part_table_num_sec_lw+di]
  6554 000026B1 74CC                    	jz	short sortpt_5
  6555                                  sortpt_7:
  6556                                  	; Swap the order indicators
  6557                                  
  6558 000026B3 8B87[D56E]              	mov	ax, [bx+sort-1]
  6559 000026B7 86E0                    	xchg	ah, al
  6560 000026B9 8987[D56E]              	mov	[bx+sort-1], ax
  6561                                  
  6562 000026BD B101                    	mov	cl, 1 ; sort changed
  6563 000026BF EBBE                    	jmp	short sortpt_5
  6564                                  sortpt_8:
  6565 000026C1 C606[F270]01            	mov 	byte [p_sorted], 1 ; 04/02/2019
  6566                                  
  6567 000026C6 C3                      	retn
  6568                                  
  6569                                  ;-----------------------------------------------------------------------------
  6570                                  ; 03/02/2019
  6571                                  
  6572                                  find_part_free_space:  ; find/calculate free space for partitions
  6573                                  	; 15/02/2019
  6574                                  
  6575                                  	; INPUT -> 
  6576                                  	;	AL = 0 -> calculate for primary/MBR partitions
  6577                                  	;	AL = 5 -> calculate for extended partition
  6578                                  	; OUTPUT ->
  6579                                  	;	CX = the largest free space/cylinders (between partitions)
  6580                                  	;	AX = Free space index (gap number) - from 0 to 4 -
  6581                                  	;	BX = Free space structure offset (for the largest free space)
  6582                                  	;
  6583                                  	;	22/02/2019
  6584                                  	;	[freespace_count] = number of free spaces/gaps
  6585                                  
  6586 000026C7 A2[F170]                	mov	[p_type], al
  6587                                  
  6588                                  	; Sort the partition table
  6589                                  
  6590 000026CA E897FF                  	call	sort_partition_table ; 16/02/2019
  6591                                  
  6592                                  	; Initialize free space to zero
  6593                                  
  6594                                  	; 15/02/2019
  6595 000026CD BF[DE71]                	mov	di, fspc ; free_space.space
  6596 000026D0 B92800                  	mov	cx, 5*8 ; (5*16/2)
  6597 000026D3 31C0                    	xor	ax, ax ; 0
  6598 000026D5 F3AB                    	rep	stosw
  6599                                  
  6600 000026D7 A2[EE70]                	mov	[freespace_count], al ; 0
  6601                                  	; 22/02/2019
  6602                                  	;mov	[last_found_partition], al ; 0
  6603                                  
  6604 000026DA A3[EC70]                	mov	[_i_], ax ; 0
  6605 000026DD EB11                    	jmp	short fpfs_2
  6606                                  fpfs_1:	
  6607 000026DF FE06[EC70]              	inc	byte [_i_]
  6608                                  ;;fpfs_2:
  6609 000026E3 803E[EC70]04            	cmp	byte [_i_], 4
  6610 000026E8 7203                    	jb	short fpfs_3
  6611 000026EA E97801                  	jmp	fpfs_13
  6612                                  fpfs_3:
  6613                                  	; Find space between start of disk and first partition
  6614                                  
  6615 000026ED A1[EC70]                	mov	ax, [_i_]
  6616                                  fpfs_2:
  6617 000026F0 89C3                    	mov	bx, ax
  6618                                  	;mov	al, [sort+bx]
  6619 000026F2 8A8F[D66E]              	mov	cl, [sort+bx] ; 15/02/2019
  6620                                  
  6621                                  	;mov	cl, 18 ; partition table structure size = 18 bytes
  6622 000026F6 B012                    	mov	al, 18 ; 15/02/2019
  6623 000026F8 F6E1                    	mul	cl
  6624 000026FA 89C3                    	mov	bx, ax
  6625                                  
  6626 000026FC 80BF[4F71]00            	cmp	byte [part_table_sys_id+bx], 0
  6627 00002701 74DC                    	je	short fpfs_1
  6628                                  
  6629 00002703 880E[F070]              	mov	[last_found_partition], cl ; 15/02/2019
  6630                                  
  6631 00002707 30C9                    	xor	cl, cl ; 0
  6632 00002709 B001                    	mov	al, 1 ; LBA = 1 (after MBR) ; ah = 0
  6633                                  	
  6634 0000270B 803E[F170]05            	cmp	byte [p_type], 5  ; EXTENDED
  6635 00002710 7509                    	jne	short fpfs_4
  6636                                  
  6637                                  	; This is a special case - the extended partition can not start
  6638                                  	; on cylinder 0 due to its architecture. Protect against that here
  6639                                  
  6640                                  	; 13/02/2019
  6641                                  	; LBA value of free space start
  6642 00002712 A0[9640]                	mov	al, [sectors]
  6643 00002715 F626[9840]              	mul	byte [heads]
  6644                                  		; ax = start sector (for Extended Partition)
  6645 00002719 FEC1                    	inc	cl ; 1  ; cx = start cylinder = 1
  6646                                  fpfs_4:
  6647                                  	; Found a partition, get the space
  6648                                  
  6649                                  	; 15/02/2019
  6650 0000271B 8B97[4D71]              	mov	dx, [part_table_start_cyl+bx]
  6651 0000271F 39CA                    	cmp	dx, cx
  6652 00002721 0F86C000                	jna	fpfs_9 ; It is accepted as free (partition) space
  6653                                  		       ; if this space between masterboot sector and partition 1
  6654                                  		       ; has 1 cylinder (heads*spt) size at least.
  6655                                  	; 22/02/2019
  6656 00002725 31FF                    	xor	di, di  ; 0 ; Reset Free Space Table offset
  6657                                  
  6658 00002727 FE06[EE70]              	inc	byte [freespace_count]	; mov byte [freespace_count], 1
  6659                                  
  6660 0000272B 890E[E071]              	mov	[free_space.start], cx ; 0 (for PP) or 1 (for EP)
  6661                                  	
  6662                                  	; non-aligned address of start sector (for the 1st partition as sorted)
  6663                                  	; NOTE: later, start sector will be moved to (chs) head 1 and sector 1
  6664                                  	;	if new partition will be selected as a primary dos partition.
  6665                                  	;	(But, start sector -LBA- will not be changed 
  6666                                  	;	 if it is a non-dos or user input type partition.. unless
  6667                                  	;	 cylinder boundary alignment option is used.)
  6668                                  	 	
  6669 0000272F A3[EA71]                	mov	[free_space.startsector], ax ; = [sectors]*[heads] (for EP)
  6670                                  					     ; or 1 (for PP)
  6671                                  	;mov	[free_space.startsector+2], 0
  6672                                  
  6673                                  	; free space ends before start of next valid partition
  6674 00002732 89D0                    	mov	ax, dx	; start cylinder of partition 1 (as sorted)
  6675 00002734 29CA                    	sub	dx, cx	; cylinder count of free space 1 (gap 1)
  6676 00002736 48                      	dec	ax	; end cylinder of free space 1 (gap 1)
  6677 00002737 A3[E271]                	mov	[free_space.end], ax
  6678 0000273A 8916[DE71]              	mov	[free_space.space], dx
  6679                                  
  6680                                  	; save free space (1) as (non-aligned) sector count
  6681 0000273E 8B87[5471]              	mov	ax, [part_table_rel_sec_lw+bx]
  6682 00002742 8B97[5671]              	mov	dx, [part_table_rel_sec_hw+bx]
  6683 00002746 2B06[EA71]              	sub	ax, [free_space.startsector]
  6684 0000274A 83DA00                  	sbb	dx, 0
  6685 0000274D A3[E671]                	mov	[free_space.sectors_unused], ax
  6686 00002750 8916[E871]              	mov	[free_space.sectors_unused+2], dx
  6687                                  
  6688                                  	;mov	ax, [free_space.space]
  6689                                  
  6690                                  	;call	cylinders_to_sectors
  6691                                  
  6692                                  	;mov	[free_space.sectors_unused], ax
  6693                                  	;mov	[free_space.sectors_unused+2], dx
  6694                                  
  6695 00002754 8B0E[9A40]              	mov	cx, [cylinders]		; Total (disk) cylinders -divisor-
  6696 00002758 8B1E[DE71]              	mov	bx, [free_space.space]	; Partition cylinders -dividend-
  6697                                  
  6698 0000275C E81002                  	call	cylinders_to_percent
  6699                                  
  6700 0000275F A3[E471]                	mov	[free_space.percent_unused], ax
  6701                                  
  6702                                  	; 15/02/2019
  6703                                  	;mov	bl, [_i_]
  6704                                  	;xor	bh, bh
  6705                                  	;mov	al, [sort+bx]
  6706                                  
  6707                                  	;mov	[last_found_partition], al
  6708                                  
  6709                                  	; Look for space between the rest of the partitions
  6710                                  
  6711                                  fpfs_7:
  6712                                  	; ah = 0
  6713                                  	;mov	al, [_i_]
  6714                                  	;;cbw
  6715                                  	;mov	bx, ax
  6716                                  	; 22/02/2019
  6717 00002762 8B1E[EC70]              	mov	bx, [_i_]
  6718                                  
  6719                                  	; 15/02/2019
  6720                                  	;mov	al, [sort+bx]
  6721 00002766 8A8F[D66E]              	mov	cl, [sort+bx]
  6722                                  	;mov	bl, 18
  6723                                  	;mul	bl
  6724 0000276A B012                    	mov	al, 18
  6725 0000276C F6E1                    	mul	cl
  6726 0000276E 89C6                    	mov	si, ax
  6727                                  	
  6728 00002770 80BC[4F71]00            	cmp	byte [part_table_sys_id+si], 0
  6729 00002775 746E                    	je	short fpfs_9
  6730                                  
  6731                                  	; 15/02/2019
  6732 00002777 860E[F070]              	xchg	[last_found_partition], cl
  6733                                  
  6734                                  	; Check to see if more than one partition on a cylinder
  6735                                  	; If so, leave the space at zero */
  6736                                  
  6737                                  	; NOTE:
  6738                                  	; It is accepted as valid free (partition) space
  6739                                  	; if free space (gap) between partitions
  6740                                  	; has 1 cylinder (heads*spt) size at least.
  6741                                  
  6742 0000277B B012                    	mov	al, 18 ; Partition tables/data structure size = 18 bytes
  6743 0000277D F6E1                    	mul	cl
  6744 0000277F 89C3                    	mov	bx, ax  ; ah = 0
  6745                                  
  6746 00002781 8B97[5271]              	mov	dx, [part_table_end_cyl+bx]   ; end cyl. of previous partition
  6747 00002785 8B84[4D71]              	mov	ax, [part_table_start_cyl+si] ; start cyl. of current partition
  6748                                  
  6749 00002789 42                      	inc	dx  ; start cylinder of free space is after the end cylinder of
  6750                                  		    ; the previous partition (as sorted)
  6751                                  
  6752 0000278A 39D0                    	cmp	ax, dx ; and it must be before than the next partition (as sorted)
  6753 0000278C 7657                    	jna	short fpfs_9 ; je short fpfs_9
  6754                                  		
  6755                                  	; No, things are normal
  6756                                  	; Get space between the end of the last one and the start of the next one
  6757                                  
  6758                                  	; 22/02/2019
  6759                                  	;add	di, 16
  6760 0000278E 8B3E[EE70]              	mov	di, [freespace_count] 
  6761 00002792 C1E704                  	shl	di, 4	; * 16 ; next entry offset (in free space table)
  6762                                  
  6763 00002795 FE06[EE70]              	inc	byte [freespace_count]
  6764                                  
  6765 00002799 89C1                    	mov	cx, ax
  6766 0000279B 29D1                    	sub	cx, dx
  6767 0000279D 48                      	dec	ax
  6768 0000279E 8995[E071]              	mov	[free_space.start+di], dx
  6769 000027A2 8985[E271]              	mov	[free_space.end+di], ax
  6770 000027A6 898D[DE71]              	mov	[free_space.space+di], cx
  6771                                  
  6772                                  	;mov	ax, [free_space.space+di]
  6773                                  	;call	cylinders_to_sectors
  6774                                  	;mov	[free_space.sectors_unused+di], ax
  6775                                  	;mov	[free_space.sectors_unused+2+di], dx
  6776                                  
  6777                                  	; calculate and save (non-aligned) free sector count between partitions
  6778                                  
  6779 000027AA 8B87[5471]              	mov	ax, [part_table_rel_sec_lw+bx]
  6780 000027AE 8B97[5671]              	mov	dx, [part_table_rel_sec_hw+bx]
  6781 000027B2 0387[5871]              	add	ax, [part_table_num_sec_lw+bx]
  6782 000027B6 1397[5A71]              	adc	dx, [part_table_num_sec_hw+bx]
  6783                                  
  6784 000027BA 8B8C[5471]              	mov	cx, [part_table_rel_sec_lw+si]
  6785 000027BE 8B9C[5671]              	mov	bx, [part_table_rel_sec_hw+si]
  6786                                  
  6787 000027C2 8985[EA71]              	mov	[free_space.startsector+di], ax
  6788 000027C6 8995[EC71]              	mov	[free_space.startsector+2+di], dx
  6789                                  
  6790 000027CA 29C1                    	sub	cx, ax
  6791 000027CC 19D3                    	sbb	bx, dx
  6792                                  
  6793 000027CE 898D[E671]              	mov	[free_space.sectors_unused+di], cx
  6794 000027D2 899D[E871]              	mov	[free_space.sectors_unused+2+di], bx
  6795                                  
  6796                                  fpfs_8:
  6797                                  	; NOTE: Percentage is based on cylinder-boundary aligned partition size.
  6798                                  	; (total disk cylinders and partition's cylinder count are used for that)
  6799                                  
  6800 000027D6 8B0E[9A40]              	mov	cx, [cylinders] ; -divisor-
  6801 000027DA 8B9D[DE71]              	mov	bx, [free_space.space+di] ; -dividend-
  6802 000027DE E88E01                  	call	cylinders_to_percent
  6803                                  	
  6804 000027E1 8985[E471]              	mov	[free_space.percent_unused+di], ax
  6805                                  	
  6806                                  	; ah = 0
  6807                                  
  6808                                  	; 15/02/2019
  6809                                  	;mov	bl, [_i_]
  6810                                  	;xor	bh, bh
  6811                                  	;mov	al, [sort+bx]
  6812                                  	;
  6813                                  	;mov	[last_found_partition], al
  6814                                  
  6815                                  fpfs_9:
  6816 000027E5 FE06[EC70]              	inc	byte [_i_]
  6817                                  fpfs_10:
  6818 000027E9 803E[EC70]04            	cmp	byte [_i_], 4
  6819 000027EE 7303                    	jnb	short fpfs_11
  6820                                  
  6821 000027F0 E96FFF                  	jmp	fpfs_7
  6822                                  
  6823                                  fpfs_11:
  6824                                  	; Find the space between the last partition and the end of the disk
  6825                                  	; Make sure that freespace cannot become negative
  6826                                  
  6827 000027F3 A0[F070]                	mov	al, [last_found_partition]
  6828 000027F6 B112                    	mov	cl, 18  ; Partition table structure size = 18 bytes
  6829 000027F8 F6E1                    	mul	cl
  6830 000027FA 89C3                    	mov	bx, ax
  6831 000027FC 8B0E[9A40]              	mov	cx, [cylinders]
  6832 00002800 49                      	dec	cx ; 15/02/2019 
  6833                                  		   ; (min. cylinder count = 1 for a valid/usable free space)
  6834 00002801 8B87[5271]              	mov	ax, [part_table_end_cyl+bx]
  6835                                  	;cmp	[part_table_end_cyl+bx], cx
  6836 00002805 39C8                    	cmp	ax, cx
  6837 00002807 7203                    	jb	short fpfs_12
  6838 00002809 E9A600                  	jmp	fpfs_15
  6839                                  fpfs_12:
  6840                                  	; 22/02/2019
  6841 0000280C 8B3E[EE70]              	mov	di, [freespace_count]
  6842 00002810 C1E704                  	shl	di, 4 ; * 16  ; next entry offset (in free space table)
  6843                                  
  6844 00002813 FE06[EE70]              	inc	byte [freespace_count]
  6845                                  
  6846 00002817 898D[E271]              	mov	[free_space.end+di], cx  ; end cyl. of free space 5 (gap 5) 
  6847                                  	;mov	ax, [part_table_end_cyl+bx]
  6848 0000281B 89CA                    	mov	dx, cx
  6849 0000281D 29C2                    	sub	dx, ax
  6850 0000281F 8995[DE71]              	mov	[free_space.space+di], dx ; di = 4*16
  6851 00002823 40                      	inc	ax
  6852 00002824 8985[E071]              	mov	[free_space.start+di], ax
  6853                                  	
  6854                                  	;inc	cx ; [cylinders]
  6855                                  	;mov	ax, [free_space.space+si]
  6856                                  	;call	cylinders_to_sectors
  6857                                  	;mov	[free_space.sectors_unused+di], ax
  6858                                  	;mov	[free_space.sectors_unused+2+di], dx
  6859                                  
  6860                                  	; calculate and save (non-aligned) free sector count
  6861                                  
  6862                                  	; 22/02/2019
  6863 00002828 8B87[5471]              	mov	ax, [part_table_rel_sec_lw+bx]
  6864 0000282C 8B97[5671]              	mov	dx, [part_table_rel_sec_hw+bx]
  6865 00002830 0387[5871]              	add	ax, [part_table_num_sec_lw+bx]
  6866 00002834 1397[5A71]              	adc	dx, [part_table_num_sec_hw+bx]
  6867                                  
  6868 00002838 8985[EA71]              	mov	[free_space.startsector+di], ax
  6869 0000283C 8995[EC71]              	mov	[free_space.startsector+2+di], dx
  6870                                  
  6871 00002840 8B0E[8C6E]              	mov	cx, [total_sectors]
  6872 00002844 8B1E[8E6E]              	mov	bx, [total_sectors+2]
  6873 00002848 29C1                    	sub	cx, ax
  6874 0000284A 19D3                    	sbb	bx, dx
  6875 0000284C 898D[E671]              	mov	[free_space.sectors_unused+di], cx
  6876 00002850 899D[E871]              	mov	[free_space.sectors_unused+2+di], bx
  6877                                  
  6878 00002854 8B0E[9A40]              	mov	cx, [cylinders]
  6879 00002858 8B9D[DE71]              	mov	bx, [free_space.space+di]
  6880 0000285C E81001                  	call	cylinders_to_percent
  6881 0000285F 8985[E471]              	mov	[free_space.percent_unused+di], ax
  6882 00002863 EB4D                    	jmp	short fpfs_15
  6883                                  
  6884                                  fpfs_13:
  6885                                  	; No partitions found, show entire space as free
  6886                                  
  6887                                  	; 22/02/2019
  6888 00002865 FE06[EE70]              	inc	byte [freespace_count]	; mov byte [freespace_count], 1
  6889                                  	
  6890                                  	; 15/02/2019
  6891                                  	;sub	ax, ax
  6892 00002869 29D2                    	sub	dx, dx
  6893                                  
  6894                                  	;inc	al ; LBA = 1 (after MBR) ; ah = 0
  6895 0000286B B001                    	mov	al, 1 ; 25/02/2019
  6896                                  
  6897                                  	;This is a special case - the extended partition can not start
  6898                                  	;on cylinder 0 due to its architecture. Protect against that here
  6899                                  
  6900 0000286D 803E[F170]05            	cmp	byte [p_type], 5 ; EXTENDED
  6901 00002872 7509                    	jne	short fpfs_14
  6902                                  
  6903 00002874 FEC2                    	inc	dl
  6904                                  
  6905                                  	; 15/02/2019
  6906                                  	; LBA value of free space start
  6907 00002876 A0[9640]                	mov	al, [sectors]
  6908 00002879 F626[9840]              	mul	byte [heads]
  6909                                  		; ax = start sector (for Extended Partition)
  6910                                  fpfs_14:
  6911 0000287D 8916[E071]              	mov	[free_space.start], dx ; 0 or 1
  6912                                  
  6913                                  	; non-aligned address of start sector (for the 1st partition as sorted)
  6914                                  	; NOTE: later, start sector will be moved to (chs) head 1 and sector 1
  6915                                  	;	if new partition will be selected as a primary dos partition.
  6916                                  	 	
  6917 00002881 A3[EA71]                	mov	[free_space.startsector], ax ; = [sectors]*[heads] (for EP)
  6918                                  					     ; or 1 (for PP)
  6919                                  	;mov	[free_space.startsector+2], 0
  6920                                  
  6921 00002884 A1[9A40]                	mov	ax, [cylinders] ; disk capacity
  6922 00002887 89C1                    	mov	cx, ax
  6923 00002889 48                      	dec	ax
  6924 0000288A A3[E271]                	mov	[free_space.end], ax
  6925 0000288D 29D0                    	sub	ax, dx
  6926 0000288F 40                      	inc	ax
  6927 00002890 A3[DE71]                	mov	[free_space.space], ax
  6928                                  
  6929 00002893 A1[8C6E]                	mov	ax, [total_sectors]
  6930 00002896 8B16[8E6E]              	mov	dx, [total_sectors+2]
  6931 0000289A 2B06[EA71]              	sub	ax, [free_space.startsector]
  6932 0000289E 83DA00                  	sbb	dx, 0
  6933 000028A1 A3[E671]                	mov	[free_space.sectors_unused], ax
  6934 000028A4 8916[E871]              	mov	[free_space.sectors_unused+2], dx
  6935                                  
  6936                                  	;mov	cx, [cylinders] 
  6937 000028A8 8B1E[DE71]              	mov	bx, [free_space.space]
  6938 000028AC E8C000                  	call	cylinders_to_percent
  6939 000028AF A3[E471]                	mov	[free_space.percent_unused], ax
  6940                                  
  6941                                  fpfs_15:
  6942                                  	; Find largest free space
  6943 000028B2 29C9                    	sub	cx, cx
  6944                                  	; 22/02/2019
  6945 000028B4 29C0                    	sub	ax, ax
  6946 000028B6 31DB                    	xor	bx, bx
  6947 000028B8 8A16[EE70]              	mov	dl, [freespace_count]
  6948 000028BC 08D2                    	or	dl, dl
  6949 000028BE 7420                    	jz	short fpfs_19
  6950 000028C0 8816[EC70]              	mov	[_i_], dl
  6951                                  fpfs_16:
  6952 000028C4 8B97[DE71]              	mov	dx, [free_space.space+bx] 
  6953 000028C8 39CA                    	cmp	dx, cx
  6954 000028CA 7604                    	jbe	short fpfs_17
  6955                                  	; 22/02/2019
  6956 000028CC 89D1                    	mov	cx, dx ; Largest free space
  6957 000028CE 89D8                    	mov	ax, bx
  6958                                  fpfs_17:
  6959 000028D0 FE0E[EC70]              	dec	byte [_i_]
  6960 000028D4 7405                    	jz	short fpfs_18
  6961                                  
  6962 000028D6 83C310                  	add	bx, 16 ; Free space structure size
  6963 000028D9 EBE9                    	jmp	short fpfs_16
  6964                                  fpfs_18:
  6965                                  	; 22/02/2019
  6966 000028DB 89C3                    	mov	bx, ax ; offset (from 0 to 64)
  6967 000028DD C0E804                  	shr	al, 4  ; index (from 0 to 4)
  6968                                  fpfs_19:
  6969 000028E0 C3                      	retn
  6970                                  
  6971                                  ;-----------------------------------------------------------------------------
  6972                                  
  6973                                  ;	; 15/02/2019
  6974                                  ;find_enough_free_space:
  6975                                  ;	; Find enough free space
  6976                                  ;	;
  6977                                  ;	; INPUT:
  6978                                  ;	;	AX = Requested space (in cylinders)
  6979                                  ;	;	22/02/2019
  6980                                  ;	;	[freespace_count] = number of free spaces/gaps
  6981                                  ;	; OUTPUT:
  6982                                  ;	;	AX = Available space
  6983                                  	;	DX = Requested space
  6984                                  ;	;	If CF = 0 -> AX >= DX
  6985                                  ;	;	If CF = 1 -> AX < DX
  6986                                  ;	;	CX = Index of available space in free space structure
  6987                                  ;	;	     (GAP number, 0 to 4) - if AX > 0 -
  6988                                  ;
  6989                                  ;	mov	dx, ax ; 22/02/2019
  6990                                  ;	sub	ax, ax
  6991                                  ;	xor	bx, bx
  6992                                  ;	; 22/02/2019
  6993                                  ;	mov	ch, [freespace_count]
  6994                                  ;	mov	[_i_], ax ; 0
  6995                                  ;	jmp	short fefs_1
  6996                                  ;fefs_0:
  6997                                  ;	;mov	al, 16
  6998                                  ;	;mul	byte [_i_]
  6999                                  ;	;mov	bx, ax
  7000                                  ;	mov	bl, [_i_]
  7001                                  ;	shl	bl, 4 ; * 16
  7002                                  ;fefs_1:
  7003                                  ;	mov	ax, [free_space.space+bx]
  7004                                  ;	and	ax, ax
  7005                                  ;	jz	short fefs_2 ; not a free space
  7006                                  ;	mov	cl, [_i_] 
  7007                                  ;	cmp	ax, dx
  7008                                  ;	jnb	short fefs_3 ; enough space
  7009                                  ;fefs_2:
  7010                                  ;	; 22/02/2019
  7011                                  ;	inc	byte [_i_]
  7012                                  ;	cmp	byte [_i_], ch	
  7013                                  ;	jb	short fefs_0
  7014                                  ;	sub	ch, ch
  7015                                  ;	stc
  7016                                  ;	retn
  7017                                  ;fefs_3:
  7018                                  ;	xor	ch, ch
  7019                                  ;	retn
  7020                                  
  7021                                  ;-----------------------------------------------------------------------------
  7022                                  
  7023                                  	; 15/02/2019
  7024                                  find_enough_free_sectors:
  7025                                  	; Find (first) enough free space in sectors
  7026                                  	;
  7027                                  	; INPUT:
  7028                                  	;	DX:AX = Requested space (as non-aligned free sectors)
  7029                                  	;	22/02/2019
  7030                                  	;	[freespace_count] = number of free spaces/gaps
  7031                                  	; OUTPUT:
  7032                                  	;	DX:AX = AX = Available space
  7033                                  	;	If CF = 0 -> DX:AX >= Request
  7034                                  	;	If CF = 1 -> DX:AX < Request
  7035                                  	;	CX = Index of available space in free space structure
  7036                                  	;	     (GAP number, 0 to 4) - if DX:AX > 0 -
  7037                                  
  7038 000028E1 31FF                    	xor	di, di
  7039 000028E3 31F6                    	xor	si, si
  7040 000028E5 31DB                    	xor	bx, bx
  7041                                  	; 22/02/2019
  7042 000028E7 8A2E[EE70]              	mov	ch, [freespace_count]
  7043 000028EB 891E[EC70]              	mov	[_i_], bx ; 0
  7044 000028EF EB07                    	jmp	short fefss_1
  7045                                  fefss_0:
  7046                                  	;mov	al, 16
  7047                                  	;mul	byte [_i_]
  7048                                  	;mov	bx, ax
  7049 000028F1 8B1E[EC70]              	mov	bx, [_i_]
  7050 000028F5 C0E304                  	shl	bl, 4 ; * 16
  7051                                  fefss_1:
  7052 000028F8 81C3[E671]              	add	bx, free_space.sectors_unused
  7053 000028FC 3B5702                  	cmp	dx, [bx+2]
  7054 000028FF 723B                    	jb	short fefss_7
  7055 00002901 7706                    	ja	short fefss_2
  7056 00002903 3B07                    	cmp	ax, [bx]
  7057 00002905 743A                    	je	short fefss_8
  7058 00002907 7233                    	jb	short fefss_7 ; 18/02/2019
  7059                                  fefss_2:
  7060 00002909 833F00                  	cmp	word [bx], 0
  7061 0000290C 7506                    	jne	short fefss_3
  7062 0000290E 837F0200                	cmp	word [bx+2], 0
  7063 00002912 7416                    	je	short fefss_6
  7064                                  fefss_3:
  7065 00002914 3B7F02                  	cmp	di, [bx+2]
  7066 00002917 7711                    	ja	short fefss_6
  7067 00002919 7405                    	je	short fefss_4
  7068 0000291B 8B7F02                  	mov	di, [bx+2]
  7069 0000291E EB04                    	jmp	short fefss_5
  7070                                  fefss_4:
  7071 00002920 3B37                    	cmp	si, [bx]
  7072 00002922 7306                    	jnb	short fefss_6
  7073                                  fefss_5:
  7074 00002924 8B37                    	mov	si, [bx]
  7075                                  	; 22/02/2019
  7076 00002926 8A0E[EC70]              	mov	cl, [_i_]
  7077                                  fefss_6:
  7078 0000292A FE06[EC70]              	inc	byte [_i_]
  7079 0000292E 382E[EC70]              	cmp	byte [_i_], ch ; [freespace_count]
  7080 00002932 72BD                    	jb	short fefss_0
  7081                                  	
  7082 00002934 89F0                    	mov	ax, si
  7083 00002936 89FA                    	mov	dx, di
  7084 00002938 30ED                    	xor	ch, ch
  7085 0000293A F9                      	stc
  7086 0000293B C3                      	retn
  7087                                  fefss_7:
  7088 0000293C 8B07                    	mov	ax, [bx]
  7089 0000293E 8B5702                  	mov	dx, [bx+2]
  7090                                  fefss_8:
  7091 00002941 8B0E[EC70]              	mov	cx, [_i_]
  7092 00002945 C3                      	retn
  7093                                  
  7094                                  ;-----------------------------------------------------------------------------
  7095                                  
  7096                                  	; 16/02/2019
  7097                                  get_first_free_pte:
  7098                                  	; Find free partition table entry
  7099                                  	;
  7100                                  	; INPUT:
  7101                                  	;	none
  7102                                  	; OUTPUT:
  7103                                  	;	If CF = 0 -> CX = partition table entry number
  7104                                  	;	If CF = 1 -> there is not a free entry in partition table
  7105                                  
  7106 00002946 BE[EA58]                	mov	si, MasterBootBuff+pTableOffset
  7107 00002949 31C9                    	xor	cx, cx
  7108                                  gffp_1:
  7109 0000294B 8A4404                  	mov	al, [si+ptFileSystemID] ; 23/02/2019
  7110                                  
  7111 0000294E 20C0                    	and	al, al
  7112 00002950 740E                    	jz	short gffp_3 ; empty
  7113                                  
  7114 00002952 80F903                  	cmp	cl, 3
  7115 00002955 7307                    	jnb	short gffp_2
  7116                                  
  7117 00002957 FEC1                    	inc	cl
  7118 00002959 83C610                  	add	si, 16 ; Partition table entry size
  7119 0000295C EBED                    	jmp	short gffp_1
  7120                                  gffp_2:
  7121                                  	; CL = 3
  7122 0000295E F9                      	stc
  7123 0000295F C3                      	retn
  7124                                  gffp_3:
  7125                                  	; CL = PTE number (0 to 3)
  7126 00002960 C3                      	retn
  7127                                  	
  7128                                  ;-----------------------------------------------------------------------------
  7129                                  ; 03/02/2019
  7130                                  
  7131                                  cylinders_to_sectors:
  7132                                  	; INPUT:
  7133                                  	;	ax = Cylinders (Total or partition's cylinder count)
  7134                                  	; OUTPUT:
  7135                                  	;	dx:ax = Sectors
  7136                                  
  7137 00002961 8B16[9840]              	mov	dx,[heads]
  7138 00002965 F7E2                    	mul	dx
  7139                                  		; dx:ax = Number of tracks (cylinders*heads)
  7140 00002967 8B0E[9640]              	mov	cx,[sectors]
  7141 0000296B E8D6E4                  	call	mul32
  7142                                  		; dx:ax = Number of sectors 
  7143 0000296E C3                      	retn
  7144                                  		
  7145                                  ;-----------------------------------------------------------------------------
  7146                                  ; 03/02/2019
  7147                                  
  7148                                  cylinders_to_percent:
  7149                                  
  7150                                  	; INPUT:
  7151                                  	;	bx = Number of cylinders (of partition) -dividend-
  7152                                  	;	cx = Total cylinders -divisor-
  7153                                  	; OUTPUT:
  7154                                  	;	ax = Percentage
  7155                                  
  7156                                  	;  if (cylinders_in == 0)
  7157                                  	;	 percentage_out = 0;
  7158                                  	;  else if (total_cylinders == 0)
  7159                                  	;           percentage_out = 0;
  7160                                  	;       else
  7161                                  
  7162 0000296F 09DB                    	or	bx, bx
  7163 00002971 7419                    	jz	short ctpc_6 ; ax = 0 = percentage_out 
  7164                                  ctpc_1:
  7165 00002973 09C9                    	or	cx, cx
  7166 00002975 7415                    	jz	short ctpc_6
  7167                                  
  7168 00002977 B86400                  	mov	ax, 100
  7169 0000297A F7E3                    	mul	bx ; [cylinders_in]
  7170                                  
  7171                                  		; dx:ax = Dividend
  7172                                  
  7173 0000297C E8B7E4                  	call	div32 ; 100*cylinders_in / total_cylinders
  7174                                  		; DX:AX = Quotient
  7175                                  		; BX = Remainder
  7176                                  
  7177                                  	; ax = percentage_out
  7178                                  
  7179 0000297F 39CB                    	cmp	bx, cx	; is remainder >= total_cylinders/2 ?
  7180 00002981 7201                    	jb	short ctpc_5 ; No.
  7181                                  ctpc_4:
  7182 00002983 40                      	inc	ax
  7183                                  ctpc_5:
  7184 00002984 83F864                  	cmp	ax, 100
  7185 00002987 7603                    	jbe	short ctpc_6
  7186 00002989 B86400                  	mov	ax, 100
  7187                                  ctpc_6:
  7188 0000298C C3                      	retn
  7189                                  
  7190                                  ;-----------------------------------------------------------------------------
  7191                                  ; 04/02/2019
  7192                                  
  7193                                  display_partition_table:
  7194                                  
  7195                                  	; INPUT:
  7196                                  	;	al = 0 for MBR
  7197                                  	;	   = 5 for EBR (logical drives in extended partition)
  7198                                  	; OUTPUT:
  7199                                  	;	none
  7200                                  
  7201                                  ;pt_positions:
  7202                                  n_pos	equ 30 ; 1 byte	
  7203                                  
  7204 0000298D A2[F470]                	mov	[_e_], al
  7205                                  
  7206                                  	; clear screen
  7207 00002990 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  7208 00002993 CD10                    	int	10h
  7209                                  
  7210 00002995 803E[F470]05            	cmp	byte [_e_], 5
  7211 0000299A 7507                    	jne	short dpt_1
  7212                                  dpt_0:
  7213 0000299C BD[9671]                	mov	bp, ext_table_boot_ind
  7214 0000299F B045                    	mov	al, 'E'
  7215 000029A1 EB05                    	jmp	short dpt_4
  7216                                  dpt_1:
  7217 000029A3 BD[4A71]                	mov	bp, part_table_boot_ind
  7218 000029A6 B04D                    	mov	al, 'M'
  7219                                  dpt_4:
  7220 000029A8 BE[9259]                	mov	si, p_table_header
  7221 000029AB 88441E                  	mov	[si+n_pos], al
  7222 000029AE E884F4                         	call 	print_msg
  7223                                     
  7224 000029B1 31DB                    	xor	bx, bx
  7225 000029B3 891E[EC70]              	mov	[_i_], bx
  7226                                  dpt_5:
  7227 000029B7 FE06[EC70]              	inc	byte [_i_]
  7228                                  
  7229                                  	; BX = partition entry (0 to 3)
  7230                                  	; BP = partition table structure address
  7231                                  
  7232 000029BB E86600                  	call	display_pt_entry  ; display partition table row
  7233                                  
  7234 000029BE 8B1E[EC70]              	mov	bx, [_i_]
  7235                                  	
  7236 000029C2 80FB04                  	cmp	bl, 4
  7237 000029C5 72F0                    	jb	short dpt_5
  7238                                  
  7239 000029C7 BE[D35A]                	mov	si, p_table_footer
  7240 000029CA E868F4                         	call 	print_msg
  7241                                  
  7242                                  	; 27/02/2019
  7243 000029CD BF[7F56]                	mov	di, str_disk_sectors
  7244                                  
  7245 000029D0 803E[F470]05            	cmp	byte [_e_], 5
  7246 000029D5 741D                    	je	short dpt_9 
  7247                                  
  7248                                  	; display total disk sectors
  7249                                  
  7250                                  	;mov	di, str_disk_sectors
  7251                                  
  7252                                  	;cmp	byte [di], '0'
  7253                                  	;jnb	short dpt_8
  7254                                  
  7255 000029D7 A1[8C6E]                        mov	ax, [total_sectors]
  7256 000029DA 8B16[8E6E]                      mov	dx, [total_sectors+2]
  7257                                  
  7258 000029DE E82200                  	call	dpt_10
  7259                                  dpt_8:
  7260 000029E1 BE[6956]                	mov	si, msg_disk_sectors
  7261                                  dpt_11:
  7262 000029E4 E84EF4                  	call	print_msg
  7263                                  
  7264 000029E7 BE[7F56]                	mov	si, str_disk_sectors
  7265 000029EA E848F4                  	call	print_msg
  7266                                  
  7267 000029ED BE[5356]                	mov	si, CRLF
  7268 000029F0 E842F4                  	call	print_msg
  7269                                  
  7270 000029F3 C3                      	retn
  7271                                  
  7272                                  dpt_9:
  7273                                  	; display extended partition size
  7274                                  
  7275 000029F4 A1[E470]                	mov	ax, [ep_Size]
  7276 000029F7 8B16[E670]                      mov	dx, [ep_Size+2]
  7277                                  
  7278 000029FB E80500                  	call	dpt_10
  7279                                  
  7280 000029FE BE[8756]                	mov	si, msg_ep_size
  7281 00002A01 EBE1                    	jmp	short dpt_11
  7282                                  
  7283                                  dpt_10:
  7284 00002A03 89E6                    	mov	si, sp
  7285 00002A05 B90A00                  	mov	cx, 10
  7286                                  dpt_6:
  7287 00002A08 E82BE4                  	call	div32
  7288                                  	
  7289 00002A0B 80C330                  	add	bl, '0'
  7290 00002A0E 53                      	push	bx
  7291 00002A0F 21C0                    	and	ax, ax
  7292 00002A11 75F5                    	jnz	short dpt_6
  7293 00002A13 21D2                    	and	dx, dx
  7294 00002A15 75F1                    	jnz	short dpt_6
  7295                                  
  7296 00002A17 29E6                    	sub	si, sp
  7297 00002A19 D1EE                    	shr	si, 1
  7298                                  dpt_7:
  7299 00002A1B 58                      	pop	ax
  7300 00002A1C AA                      	stosb
  7301 00002A1D 4E                      	dec	si
  7302 00002A1E 75FB                    	jnz	short dpt_7
  7303                                  
  7304 00002A20 30C0                    	xor	al, al
  7305 00002A22 AA                      	stosb
  7306                                  
  7307                                  	; 27/02/2019
  7308 00002A23 C3                      	retn
  7309                                  
  7310                                  ;-----------------------------------------------------------------------------
  7311                                  ; 04/02/2019
  7312                                  
  7313                                  struc ptbl
  7314                                  
  7315 00000000 ??                      .boot_ind:	resb 1
  7316 00000001 ??                      .start_head:	resb 1
  7317 00000002 ??                      .start_sector:	resb 1
  7318 00000003 ????                    .start_cyl:	resw 1
  7319 00000005 ??                      .sys_id:	resb 1
  7320 00000006 ??                      .end_head:	resb 1
  7321 00000007 ??                      .end_sector:	resb 1
  7322 00000008 ????                    .end_cyl:	resw 1
  7323 0000000A ????                    .rel_sec_lw:	resw 1
  7324 0000000C ????                    .rel_sec_hw:	resw 1
  7325 0000000E ????                    .num_sec_lw:	resw 1
  7326 00000010 ????                    .num_sec_hw:	resw 1
  7327                                  .size:
  7328                                  
  7329                                  endstruc
  7330                                  
  7331                                  display_pt_entry:
  7332                                  
  7333                                  	; INPUT:
  7334                                  	;	bl = partition entry
  7335                                  	;	bh = 0
  7336                                  	;	bp = partition table structure address
  7337                                  	; OUTPUT:
  7338                                  	;	none
  7339                                  
  7340                                  ;pt_positions:
  7341                                  p_pos	equ 7  ; 1 byte	hdi
  7342                                  s_pos	equ 9  ; 2+1 byte
  7343                                  bh_pos	equ 13 ; 2+1 bytes
  7344                                  bs_pos	equ 17 ; 2+1 bytes
  7345                                  bc_pos	equ 21 ; 2+1 bytes
  7346                                  fs_pos  equ 25 ; 2+1 bytes
  7347                                  eh_pos  equ 29 ; 2+1 bytes
  7348                                  es_pos	equ 33 ; 2+1 bytes
  7349                                  ec_pos	equ 37 ; 2+1 bytes
  7350                                  rs_pos	equ 42 ; 7 bytes
  7351                                  ns_pos	equ 52 ; 7 bytes
  7352                                  fsx_pos equ 61 ; 14 bytes
  7353                                  
  7354 00002A24 55                      	push	 bp ; 23/02/2019
  7355                                  
  7356 00002A25 08DB                    	or	bl, bl
  7357 00002A27 7406                    	jz	short dpte_0
  7358                                  
  7359                                  	;xor	bh, bh
  7360 00002A29 B012                    	mov	al, ptbl.size ; 18
  7361 00002A2B F6E3                    	mul	bl
  7362 00002A2D 01C5                    	add	bp, ax
  7363                                  dpte_0:
  7364 00002A2F 807E0500                	cmp	byte [bp+ptbl.sys_id], 0
  7365 00002A33 0F860601                	jna	dpte_9
  7366                                  
  7367 00002A37 B768                    	mov	bh, 'h'
  7368                                  
  7369 00002A39 BE[F670]                	mov	si, pte_row
  7370                                  
  7371                                  	; clear partition table display buffer/row
  7372 00002A3C 89F7                    	mov	di, si
  7373 00002A3E B92800                  	mov	cx, 40
  7374 00002A41 B82020                  	mov	ax, 2020h
  7375 00002A44 F3AB                    	rep	stosw
  7376                                  
  7377 00002A46 88D8                    	mov	al, bl
  7378 00002A48 0431                    	add	al, '1'
  7379 00002A4A 884407                  	mov	[si+p_pos], al  ; partition number '1' to '4'
  7380                                  
  7381                                  	; partition status, type and CHS parameters
  7382                                  	; (as hexadecimal number)
  7383                                  
  7384                                  	;mov	al, [bp+ptbl.boot_ind]
  7385 00002A4D 8A4600                  	mov	al, [bp]
  7386 00002A50 E881F4                  	call	byte_to_hex
  7387                                  
  7388 00002A53 894409                  	mov	[si+s_pos], ax
  7389 00002A56 887C0B                  	mov	[si+s_pos+2], bh ; 'h'
  7390                                  
  7391 00002A59 8A4601                  	mov	al, [bp+ptbl.start_head]
  7392 00002A5C E875F4                  	call	byte_to_hex
  7393                                  
  7394 00002A5F 89440D                  	mov	[si+bh_pos], ax
  7395 00002A62 887C0F                  	mov	[si+bh_pos+2], bh ; 'h'
  7396                                  
  7397 00002A65 8B4E03                  	mov	cx, [bp+ptbl.start_cyl]
  7398 00002A68 C0E506                  	shl	ch, 6
  7399 00002A6B 8A4602                  	mov	al, [bp+ptbl.start_sector]
  7400 00002A6E 08E8                    	or	al, ch
  7401 00002A70 E861F4                  	call	byte_to_hex
  7402                                  
  7403 00002A73 894411                  	mov	[si+bs_pos], ax
  7404 00002A76 887C13                  	mov	[si+bs_pos+2], bh ; 'h'
  7405                                  
  7406                                  	;mov	al, [bp+ptbl.start_cyl]
  7407 00002A79 88C8                    	mov	al, cl
  7408 00002A7B E856F4                  	call	byte_to_hex
  7409                                  
  7410 00002A7E 894415                  	mov	[si+bc_pos], ax
  7411 00002A81 887C17                  	mov	[si+bc_pos+2], bh ; 'h'
  7412                                  
  7413 00002A84 8A4605                  	mov	al, [bp+ptbl.sys_id]
  7414 00002A87 E84AF4                  	call	byte_to_hex
  7415                                  
  7416 00002A8A 894419                  	mov	[si+fs_pos], ax
  7417 00002A8D 887C1B                  	mov	[si+fs_pos+2], bh ; 'h'
  7418                                  
  7419 00002A90 8A4606                  	mov	al, [bp+ptbl.end_head]
  7420 00002A93 E83EF4                  	call	byte_to_hex
  7421                                  
  7422 00002A96 89441D                  	mov	[si+eh_pos], ax
  7423 00002A99 887C1F                  	mov	[si+eh_pos+2], bh ; 'h'
  7424                                  
  7425 00002A9C 8B4E08                  	mov	cx, [bp+ptbl.end_cyl]
  7426 00002A9F C0E506                  	shl	ch, 6
  7427 00002AA2 8A4607                  	mov	al, [bp+ptbl.end_sector]
  7428 00002AA5 08E8                    	or	al, ch
  7429 00002AA7 E82AF4                  	call	byte_to_hex
  7430                                  
  7431 00002AAA 894421                  	mov	[si+es_pos], ax
  7432 00002AAD 887C23                  	mov	[si+es_pos+2], bh ; 'h'
  7433                                  
  7434                                  	;mov	al, [bp+ptbl.end_cyl]
  7435 00002AB0 88C8                    	mov	al, cl
  7436 00002AB2 E81FF4                  	call	byte_to_hex
  7437                                  
  7438 00002AB5 894425                  	mov	[si+ec_pos], ax
  7439 00002AB8 887C27                  	mov	[si+ec_pos+2], bh ; 'h'
  7440                                  
  7441                                  	; relative (start) sector address (lba)
  7442                                  	; (as decimal number)
  7443                                  
  7444 00002ABB 8B460A                          mov	ax, [bp+ptbl.rel_sec_lw]
  7445 00002ABE 8B560C                          mov	dx, [bp+ptbl.rel_sec_hw]
  7446                                  
  7447 00002AC1 89E7                    	mov	di, sp
  7448 00002AC3 B90A00                  	mov	cx, 10
  7449                                  dpte_1:
  7450 00002AC6 E86DE3                  	call	div32
  7451                                  	
  7452 00002AC9 80C330                  	add	bl, '0'
  7453 00002ACC 53                      	push	bx
  7454 00002ACD 21C0                    	and	ax, ax
  7455 00002ACF 75F5                    	jnz	short dpte_1
  7456 00002AD1 21D2                    	and	dx, dx
  7457 00002AD3 75F1                    	jnz	short dpte_1
  7458                                  
  7459 00002AD5 8D5C31                  	lea	bx, [si+rs_pos+7]
  7460                                  
  7461 00002AD8 29E7                    	sub	di, sp
  7462 00002ADA D1EF                    	shr	di, 1
  7463 00002ADC 29FB                    	sub	bx, di
  7464                                  dpte_2:
  7465 00002ADE 58                      	pop	ax
  7466 00002ADF 8807                    	mov	[bx], al
  7467 00002AE1 4F                      	dec	di
  7468 00002AE2 7403                    	jz	short dpte_3
  7469                                  	
  7470 00002AE4 43                      	inc	bx
  7471 00002AE5 EBF7                    	jmp	short dpte_2
  7472                                  
  7473                                  dpte_3:
  7474                                  	; number of sectors)
  7475                                  	; (as decimal number)
  7476                                  
  7477 00002AE7 8B460E                          mov	ax, [bp+ptbl.num_sec_lw]
  7478 00002AEA 8B5610                          mov	dx, [bp+ptbl.num_sec_hw]
  7479                                  
  7480 00002AED 89E7                    	mov	di, sp
  7481                                  	;mov	cx, 10
  7482                                  dpte_4:
  7483 00002AEF E844E3                  	call	div32
  7484                                  	
  7485 00002AF2 80C330                  	add	bl, '0'
  7486 00002AF5 53                      	push	bx
  7487 00002AF6 21C0                    	and	ax, ax
  7488 00002AF8 75F5                    	jnz	short dpte_4
  7489 00002AFA 21D2                    	and	dx, dx
  7490 00002AFC 75F1                    	jnz	short dpte_4
  7491                                  
  7492 00002AFE 8D5C3B                  	lea	bx, [si+ns_pos+7]
  7493                                  
  7494 00002B01 29E7                    	sub	di, sp
  7495 00002B03 D1EF                    	shr	di, 1
  7496 00002B05 29FB                    	sub	bx, di
  7497                                  dpte_5:
  7498 00002B07 58                      	pop	ax
  7499 00002B08 8807                    	mov	[bx], al
  7500 00002B0A 4F                      	dec	di
  7501 00002B0B 7403                    	jz	short dpte_6
  7502                                  	
  7503 00002B0D 43                      	inc	bx
  7504 00002B0E EBF7                    	jmp	short dpte_5
  7505                                  dpte_6:
  7506                                  	; set file system name
  7507                                  
  7508 00002B10 8A4605                  	mov	al, [bp+ptbl.sys_id]
  7509 00002B13 BF[B641]                	mov	di, valid_partitions
  7510 00002B16 B91300                  	mov	cx, 19
  7511 00002B19 F2AE                    	repnz	scasb
  7512 00002B1B 7405                    	jz	short dpte_7
  7513 00002B1D B8[A841]                	mov	ax, FS_OTHERS	 
  7514 00002B20 EB0C                    	jmp	short dpte_8
  7515                                  dpte_7:
  7516 00002B22 81EF[B741]              	sub	di, valid_partitions + 1
  7517 00002B26 B80E00                  	mov	ax, 14
  7518 00002B29 F7E7                    	mul	di
  7519 00002B2B 05[9E40]                	add	ax, FileSys_Names
  7520                                  dpte_8:
  7521 00002B2E 8D7C3D                  	lea	di, [si+fsx_pos]
  7522 00002B31 89C6                    	mov	si, ax
  7523 00002B33 B107                    	mov	cl, 7
  7524 00002B35 F3A5                    	rep	movsw
  7525                                  
  7526 00002B37 BE[F670]                	mov	si, pte_row
  7527 00002B3A E8F8F2                  	call	print_msg
  7528                                  dpte_9:
  7529 00002B3D 5D                      	pop	bp ; 23/02/2019
  7530                                  	
  7531 00002B3E C3                      	retn
  7532                                  
  7533                                  ;-----------------------------------------------------------------------------
  7534                                  ; 24/02/2019
  7535                                  
  7536                                  partition_table_fix:
  7537                                  	; DELETE or EXIT option for Invalid Partition Table Entry
  7538                                  	; INPUT:
  7539                                  	;	DS:SI = PTE address in MBR buffer
  7540                                  	
  7541 00002B3F 56                      	push	si  ; save PTE address
  7542                                  
  7543 00002B40 89F0                    	mov	ax, si
  7544 00002B42 2D[EA58]                	sub	ax, MasterBootBuff+446
  7545 00002B45 C0E804                  	shr	al, 4 ; / 16 
  7546 00002B48 0431                    	add	al, '1'
  7547 00002B4A A2[9A60]                	mov	[inv_pte_num], al
  7548                                  
  7549                                  	; DS:SI = PTE address in MBR buffer
  7550 00002B4D E8E6F7                  	call	show_selected_partition
  7551                                  
  7552                                  	;mov	si, CRLF
  7553                                  	;call	print_msg
  7554                                  
  7555                                  	; Warning message...
  7556                                  
  7557 00002B50 BE[7660]                	mov	si, msg_inv_pte
  7558 00002B53 E8DFF2                  	call	print_msg
  7559                                  
  7560 00002B56 5F                      	pop	di  ; restore PTE address
  7561                                  ptf_0:	
  7562 00002B57 30E4                    	xor	ah, ah
  7563 00002B59 CD16                    	int	16h
  7564                                  
  7565 00002B5B 3C0D                    	cmp	al, 13
  7566 00002B5D 7406                    	je	short ptf_1
  7567                                  
  7568 00002B5F 3C1B                    	cmp	al, 27
  7569 00002B61 75F4                    	jne	short ptf_0
  7570                                  
  7571 00002B63 F9                      	stc
  7572 00002B64 C3                      	retn
  7573                                  ptf_1:
  7574                                  	; Clear that (invalid) PTE
  7575 00002B65 31C0                    	xor	ax, ax	
  7576 00002B67 B90800                  	mov	cx, 8
  7577 00002B6A F3AB                    	rep	stosw
  7578                                  
  7579                                  	; Clear screen
  7580 00002B6C B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  7581 00002B6F CD10                    	int	10h
  7582                                  
  7583 00002B71 C3                      	retn
  7584                                  
  7585                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7586                                  ; Display (& Edit) EXTENDED (DOS) Partition Table
  7587                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7588                                  ; 28/02/2019
  7589                                  
  7590                                  display_extended_pt:
  7591 00002B72 B005                    	mov	al, 5 ; extended partition (logical drives)
  7592 00002B74 E816FE                  	call	display_partition_table
  7593                                  
  7594 00002B77 BE[6E62]                	mov	si, ebr_editing_options
  7595 00002B7A E8B8F2                  	call	print_msg
  7596                                  
  7597 00002B7D BE[7D5E]                	mov	si, enter_opt_num_cancel_msg
  7598 00002B80 E8B2F2                  	call	print_msg
  7599                                  
  7600 00002B83 BE[5356]                	mov	si, CRLF
  7601 00002B86 E8ACF2                  	call	print_msg
  7602                                  dept_1:
  7603 00002B89 30E4                    	xor	ah, ah
  7604 00002B8B CD16                    	int	16h
  7605                                  
  7606 00002B8D 3C30                    	cmp	al, '0'
  7607 00002B8F 740C                    	je	short dept_2
  7608                                  
  7609 00002B91 3C31                    	cmp	al, '1'
  7610 00002B93 7467                    	je	short edit_ext_table_create
  7611 00002B95 3C32                    	cmp	al, '2'
  7612 00002B97 7407                    	je	short edit_ext_table_delete
  7613                                  
  7614 00002B99 3C1B                    	cmp	al, 27 ; ESCape
  7615 00002B9B 75EC                    	jne	short dept_1
  7616                                  dept_2:
  7617 00002B9D E977D8                  	jmp	A_48
  7618                                  
  7619                                  edit_ext_table_delete:
  7620                                  	; 28/02/2019
  7621 00002BA0 B005                    	mov	al, 5 ; extended partition (logical drives)
  7622 00002BA2 E8E8FD                  	call	display_partition_table
  7623                                  
  7624 00002BA5 BE[ED62]                	mov	si, msg_delete_ldd_q
  7625 00002BA8 E88AF2                  	call	print_msg
  7626                                  
  7627                                  	;mov	si, CRLF
  7628                                  	;call	print_msg
  7629                                  eetd_1:
  7630 00002BAB 30E4                    	xor	ah, ah
  7631 00002BAD CD16                    	int	16h
  7632                                  
  7633 00002BAF 3C1B                    	cmp	al, 27
  7634 00002BB1 7410                    	je	short eetd_2
  7635                                  
  7636 00002BB3 24DF                    	and	al, 0DFh
  7637 00002BB5 3C59                    	cmp	al, 'Y'
  7638 00002BB7 7412                    	je	short eetd_yes
  7639 00002BB9 3C4E                    	cmp	al, 'N'
  7640 00002BBB 75EE                    	jne	short eetd_1
  7641                                  eetd_no:
  7642 00002BBD BE[FD5D]                	mov	si, msg_NO ;  Write 'NO' (it may be shown for a moment)
  7643 00002BC0 E872F2                  	call	print_msg
  7644                                  eetd_2:	
  7645 00002BC3 BE[5356]                	mov	si, CRLF  ; Next line
  7646 00002BC6 E86CF2                  	call	print_msg
  7647 00002BC9 EBA7                    	jmp	short display_extended_pt
  7648                                  eetd_yes:
  7649 00002BCB BE[F75D]                	mov	si, msg_YES ;  Write 'YES' (it may be shown for a moment)
  7650 00002BCE E864F2                  	call	print_msg
  7651 00002BD1 BE[5356]                	mov	si, CRLF  ; Next line
  7652 00002BD4 E85EF2                  	call	print_msg
  7653 00002BD7 E8F205                  	call	delete_logical_drives
  7654 00002BDA 803E[D46E]00            	cmp	byte [ldrives], 0
  7655 00002BDF 7791                    	ja	short display_extended_pt
  7656 00002BE1 E933D8                  	jmp	A_48
  7657                                  
  7658                                  ;-----------------------------------------------------------------------------
  7659                                  
  7660                                  eetc_2:
  7661 00002BE4 BE[5363]                	mov	si, msg_create_ldd_max_error
  7662                                  eetc_10:
  7663 00002BE7 E84BF2                  	call	print_msg
  7664 00002BEA BE[0C57]                	mov	si, msg_press_any_key
  7665 00002BED E845F2                  	call	print_msg
  7666 00002BF0 30E4                    	xor	ah, ah
  7667 00002BF2 CD16                    	int	16h
  7668 00002BF4 E97BFF                  	jmp	display_extended_pt
  7669                                  	
  7670                                  	; 05/03/2019
  7671                                  eetc_9:
  7672 00002BF7 BE[BC65]                	mov	si, msg_c_ldd_nofspc_error
  7673 00002BFA EBEB                    	jmp	short eetc_10
  7674                                  
  7675                                  ;-----------------------------------------------------------------------------
  7676                                  ; 01/03/2019
  7677                                  
  7678                                  edit_ext_table_create:
  7679                                  
  7680                                  ; Create Method: ; 04/03/2019
  7681                                  ;LDD 1 <- LDD_START0, ebr 1st entry <- MBR (extended partition) - EBR 0
  7682                                  ;LDD 2 <- LDD_START1, ebr 2nd entry <- EBR 1
  7683                                  ;LDD 3 <- LDD_START2, ebr 2nd entry <- EBR 2
  7684                                  ;LDD 4 <- LDD_START3, ebr 2nd entry <- EBR 3
  7685                                  
  7686                                  	; 01/03/2019
  7687 00002BFC 803E[9571]00            	cmp	byte [epnumber], 0 ; check extended partition
  7688 00002C01 0F86E3E3                	jna	B_55		; cancel with error message
  7689                                  
  7690                                  	; 05/03/2019
  7691 00002C05 E8A102                  	call	check_ext_free_space
  7692 00002C08 72ED                    	jc	eetc_9	; error, no free space in extented partition
  7693                                  
  7694 00002C0A 803E[D46E]04            	cmp	byte [ldrives], 4
  7695 00002C0F 73D3                    	jnb	eetc_2	; error, write program limit message
  7696                                  
  7697                                  edit_ext_table_create_x: ; 02/03/2019
  7698                                  
  7699                                  	; Get logical drive size/cylinders (request) from user
  7700 00002C11 E80703                  	call	get_ldd_size
  7701 00002C14 833E[5672]01            	cmp	word [lcylinders], 1  ; at least 1 cylinder
  7702 00002C19 0F8255FF                	jb	display_extended_pt ; cancel
  7703                                  
  7704                                  	; Open hard disk image file
  7705 00002C1D BA[8559]                	mov	dx, img_file_name
  7706 00002C20 B8023D                  	mov	ax, 3D02h ; open for reading and writing
  7707 00002C23 CD21                    	int	21h
  7708 00002C25 0F82F6F1                	jc	D_02
  7709                                  
  7710 00002C29 A3[9440]                	mov	[img_file_handle], ax
  7711                                  
  7712                                  	; 03/03/2019
  7713 00002C2C A0[D46E]                	mov	al, [ldrives]
  7714                                  
  7715                                  	;cmp	byte [ldrives], 1
  7716                                  	;jnb	short eetc_3	; skip verify MBR extended partition
  7717                                  
  7718 00002C2F 20C0                    	and	al, al
  7719 00002C31 7578                    	jnz	short eetc_3
  7720                                  
  7721 00002C33 31ED                    	xor	bp, bp
  7722                                  
  7723                                  	; Read MBR at EBR buffer
  7724                                  	;xor	ax, ax
  7725 00002C35 31D2                    	xor	dx, dx
  7726 00002C37 BB[DA6E]                	mov	bx, ebr_buffer
  7727 00002C3A E846F2                  	call	read_hd_sector
  7728 00002C3D 7218                    	jc	short eetc_0
  7729                                  
  7730 00002C3F A0[9571]                	mov	al, [epnumber]
  7731 00002C42 98                      	cbw
  7732 00002C43 C0E004                  	shl	al, 4 ; * 16
  7733 00002C46 BE[9870]                	mov	si, ebr_buffer+446
  7734 00002C49 01C6                    	add	si, ax
  7735 00002C4B BF[EA58]                	mov	di, MasterBootBuff+446
  7736 00002C4E 01C7                    	add	di, ax
  7737 00002C50 B90800                  	mov	cx, 8
  7738 00002C53 F3A7                    	repe	cmpsw	; repeat comparising while cx > 0 and zf = 1
  7739 00002C55 E30C                    	jcxz	eetc_1	; Extended partition entry is not changed 
  7740                                  	; Different PTE (means there is a new extended partition) 
  7741                                  eetc_0:
  7742                                  	; Write current MBR (with modified PT)
  7743 00002C57 BB[2C57]                	mov	bx, MasterBootBuff
  7744 00002C5A 31C0                    	xor	ax, ax
  7745                                  	; 25/10/2020
  7746                                  	;xor	dx, dx
  7747 00002C5C E8E5F1                  	call	write_hd_sector
  7748 00002C5F 0F82B2F1                	jc	D_01 ; ! display error msg and then exit !
  7749                                  eetc_1:
  7750                                  	; clear	EBR buffer
  7751 00002C63 BF[DA6E]                	mov	di, ebr_buffer
  7752 00002C66 31C0                    	xor	ax, ax
  7753 00002C68 B9FF00                  	mov	cx, 255
  7754 00002C6B F3AB                    	rep	stosw
  7755 00002C6D C70555AA                	mov	word [di], 0AA55h
  7756                                  
  7757                                  	; Set logical dos drive parameters in it's EBR
  7758 00002C71 BF[9870]                	mov	di, ebr_buffer+446
  7759                                  
  7760 00002C74 8B0E[9640]              	mov	cx, [sectors]
  7761 00002C78 29DB                    	sub	bx, bx ; 0
  7762 00002C7A A1[DC70]                	mov	ax, [ep_StartSector]
  7763 00002C7D 8B16[DE70]              	mov	dx, [ep_StartSector+2]
  7764                                  
  7765                                  	; 03/03/2019
  7766                                  	; set partition start address & size
  7767                                  
  7768 00002C81 A3[3472]                	mov	[ldd_start], ax
  7769 00002C84 8916[3672]              	mov	[ldd_start+2], dx
  7770                                  
  7771                                  	; 04/03/2019
  7772 00002C88 01C8                    	add	ax, cx
  7773 00002C8A 11DA                    	adc	dx, bx
  7774                                  
  7775 00002C8C 52                      	push	dx
  7776 00002C8D 50                      	push	ax
  7777                                  
  7778 00002C8E A0[9840]                	mov	al, [heads]
  7779 00002C91 F626[9640]              	mul	byte [sectors]
  7780 00002C95 F726[5672]              	mul	word [lcylinders]
  7781                                  
  7782 00002C99 A3[4472]                	mov	[ldd_size], ax
  7783 00002C9C 8916[4672]              	mov	[ldd_size+2], dx
  7784                                  
  7785 00002CA0 894D08                  	mov	[di+ptStartSector], cx
  7786 00002CA3 895D0A                  	mov	[di+ptStartSector+2], bx
  7787                                  
  7788 00002CA6 58                      	pop	ax
  7789 00002CA7 5A                      	pop	dx
  7790                                  
  7791 00002CA8 E9DB00                  	jmp	eetc_4
  7792                                  
  7793                                  eetc_3:
  7794                                  	; [ldrives] >= 1
  7795                                  	; Read EBR
  7796                                  	;mov	al, [ldrives]
  7797                                  	;;xor	ah, ah
  7798 00002CAB C0E002                  	shl	al, 2
  7799 00002CAE 89C5                    	mov	bp, ax
  7800                                  
  7801                                  	; 03/03/2019
  7802 00002CB0 8B86[3072]              	mov	ax, [bp+ldd_start-4]
  7803 00002CB4 8B96[3272]              	mov	dx, [bp+ldd_start-2]
  7804 00002CB8 BB[DA6E]                	mov	bx, ebr_buffer
  7805 00002CBB E8C5F1                  	call	read_hd_sector
  7806 00002CBE 0F8253F1                	jc	D_01 ; ! display error msg and then exit !
  7807                                  
  7808                                  	; 04/03/2019
  7809 00002CC2 BE[A870]                	mov	si, ebr_buffer+446+16 ; 2nd entry (next EBR)
  7810                                  	
  7811                                  	; 03/03/2019
  7812 00002CC5 8B86[3072]              	mov	ax, [bp+ldd_start-4]
  7813 00002CC9 8B96[3272]              	mov	dx, [bp+ldd_start-2]
  7814 00002CCD 0386[4072]              	add	ax, [bp+ldd_size-4]
  7815 00002CD1 1396[4272]              	adc	dx, [bp+ldd_size-2]
  7816                                  
  7817 00002CD5 8B0E[DC70]              	mov	cx, [ep_StartSector]
  7818 00002CD9 8B1E[DE70]              	mov	bx, [ep_StartSector+2]
  7819                                  
  7820 00002CDD 8986[3472]              	mov	[bp+ldd_start], ax
  7821 00002CE1 8996[3672]              	mov	[bp+ldd_start+2], dx
  7822                                  
  7823 00002CE5 52                      	push	dx
  7824 00002CE6 50                      	push	ax
  7825                                  	
  7826 00002CE7 29C8                    	sub	ax, cx
  7827 00002CE9 19DA                    	sbb	dx, bx
  7828                                  
  7829 00002CEB 894408                  	mov	[si+ptStartSector], ax
  7830 00002CEE 89540A                  	mov	[si+ptStartSector+2], dx
  7831                                  
  7832 00002CF1 A0[9840]                	mov	al, [heads]
  7833 00002CF4 F626[9640]              	mul	byte [sectors]
  7834 00002CF8 F726[5672]              	mul	word [lcylinders]
  7835                                  
  7836 00002CFC 8986[4472]              	mov	[bp+ldd_size], ax
  7837 00002D00 8996[4672]              	mov	[bp+ldd_size+2], dx
  7838                                  
  7839 00002D04 89440C                   	mov	[si+ptSectors], ax
  7840 00002D07 89540E                  	mov	[si+ptSectors+2], dx
  7841                                  
  7842 00002D0A 58                      	pop	ax
  7843 00002D0B 5A                      	pop	dx
  7844                                  
  7845                                  	; calculate CHS from LBA
  7846 00002D0C E8DD01                  	call	lba_to_chs
  7847                                  		; ax = cylinder
  7848                                  		; dl = sector
  7849                                  		; dh = head
  7850                                  
  7851 00002D0F C60400                  	mov	byte [si+ptBootable], 0
  7852 00002D12 887401                  	mov	[si+ptBeginHead], dh
  7853 00002D15 884403                  	mov	[si+ptBeginCylinder], al
  7854 00002D18 C0E406                  	shl	ah, 6
  7855 00002D1B 08E2                    	or	dl, ah
  7856 00002D1D 885402                  	mov	[si+ptBeginSector], dl
  7857                                  
  7858                                   	;mov	ax, [si+ptSectors]
  7859                                  	;mov	dx, [si+ptSectors+2]
  7860 00002D20 8B86[4472]               	mov	ax, [bp+ldd_size]
  7861 00002D24 8B96[4672]              	mov	dx, [bp+ldd_size+2]
  7862 00002D28 83E801                  	sub	ax, 1
  7863 00002D2B 83DA00                  	sbb	dx, 0
  7864 00002D2E 0386[3472]              	add	ax, [bp+ldd_start]
  7865 00002D32 1396[3672]              	adc	dx, [bp+ldd_start+2]
  7866                                  		; dx:ax = end sector
  7867                                  
  7868 00002D36 E8B301                  	call	lba_to_chs
  7869                                  		; ax = cylinder
  7870                                  		; dl = sector
  7871                                  		; dh = head
  7872                                  		
  7873 00002D39 C6440405                	mov	byte [si+ptFileSystemID], 5 ; EXTENDED
  7874 00002D3D 887405                  	mov	[si+ptEndHead], dh
  7875 00002D40 884407                  	mov	[si+ptEndCylinder], al
  7876 00002D43 C0E406                  	shl	ah, 6
  7877 00002D46 08D4                    	or	ah, dl	
  7878 00002D48 886406                  	mov	[si+ptEndSector], ah
  7879                                  
  7880                                  	; Write EBR
  7881 00002D4B 8B86[3072]              	mov	ax, [bp+ldd_start-4]
  7882 00002D4F 8B96[3272]              	mov	dx, [bp+ldd_start-2]
  7883 00002D53 BB[DA6E]                	mov	bx, ebr_buffer
  7884 00002D56 E8EBF0                  	call	write_hd_sector
  7885 00002D59 0F82B8F0                	jc	D_01 ; ! display error msg and then exit !
  7886                                  
  7887                                  	; clear	EBR buffer
  7888 00002D5D BF[DA6E]                	mov	di, ebr_buffer
  7889 00002D60 31C0                    	xor	ax, ax
  7890 00002D62 B9FF00                  	mov	cx, 255
  7891 00002D65 F3AB                    	rep	stosw
  7892 00002D67 C70555AA                	mov	word [di], 0AA55h
  7893                                  
  7894 00002D6B BF[9870]                	mov	di, ebr_buffer+446 ; 1st entry points to LDD
  7895                                  
  7896 00002D6E 8B0E[9640]              	mov	cx, [sectors]
  7897 00002D72 29DB                    	sub	bx, bx ; 0
  7898 00002D74 8B86[3472]              	mov	ax, [bp+ldd_start]
  7899 00002D78 8B96[3672]              	mov	dx, [bp+ldd_start+2]
  7900 00002D7C 01C8                    	add	ax, cx
  7901 00002D7E 11DA                    	adc	dx, bx
  7902 00002D80 894D08                  	mov	[di+ptStartSector], cx
  7903 00002D83 895D0A                  	mov	[di+ptStartSector+2], bx
  7904                                  eetc_4:	
  7905                                  	; calculate CHS from LBA
  7906                                  
  7907 00002D86 E86301                  	call	lba_to_chs
  7908                                  		; ax = cylinder
  7909                                  		; dl = sector
  7910                                  		; dh = head
  7911                                  
  7912                                  	;mov	byte [di+ptBootable], 0
  7913 00002D89 887501                  	mov	[di+ptBeginHead], dh
  7914 00002D8C 884503                  	mov	[di+ptBeginCylinder], al
  7915 00002D8F 88E3                    	mov	bl, ah
  7916 00002D91 C0E306                  	shl	bl, 6
  7917 00002D94 08DA                    	or	dl, bl
  7918 00002D96 885502                  	mov	[di+ptBeginSector], dl
  7919                                  
  7920 00002D99 0306[5672]              	add	ax, [lcylinders]
  7921 00002D9D 48                      	dec	ax ; end cylinder
  7922 00002D9E 89C3                    	mov	bx, ax
  7923                                  		
  7924                                  	;mov	[di+ptFileSystemID], 0
  7925 00002DA0 8B0E[9840]              	mov	cx, [heads]
  7926 00002DA4 FEC9                    	dec	cl
  7927 00002DA6 884D05                  	mov	[di+ptEndHead], cl
  7928 00002DA9 884507                  	mov	[di+ptEndCylinder], al
  7929 00002DAC 8B16[9640]              	mov	dx, [sectors]
  7930 00002DB0 C0E406                  	shl	ah, 6
  7931 00002DB3 08D4                    	or	ah, dl	
  7932 00002DB5 886506                  	mov	[di+ptEndSector], ah
  7933                                  	
  7934                                  	; 02/03/2019
  7935                                  	; Check unused space if it is 3rd LDD
  7936                                  	; (write message to add unused space.)
  7937                                  
  7938 00002DB8 803E[D46E]03            	cmp	byte [ldrives], 3
  7939 00002DBD 727D                    	jb	eetc_7
  7940                                  
  7941 00002DBF 89D0                    	mov	ax, dx ; sectors
  7942 00002DC1 F7E1                    	mul	cx ; * [heads] - 1
  7943                                  
  7944 00002DC3 52                      	push	dx
  7945 00002DC4 50                      	push	ax
  7946                                  
  7947 00002DC5 A0[9640]                	mov	al, [sectors]
  7948 00002DC8 F626[9840]              	mul	byte [heads]
  7949 00002DCC F7E3                    	mul	bx ; * end cylinder
  7950                                  	
  7951 00002DCE 59                      	pop	cx
  7952 00002DCF 01C8                    	add	ax, cx
  7953 00002DD1 59                      	pop	cx
  7954 00002DD2 11CA                    	adc	dx, cx
  7955                                  
  7956                                  	; 03/03/2019
  7957 00002DD4 8B0E[9640]              	mov	cx, [sectors]
  7958 00002DD8 FEC9                    	dec	cl	; [sectors] - 1
  7959 00002DDA 01C8                    	add	ax, cx
  7960 00002DDC 83D200                  	adc	dx, 0
  7961                                  		; DX:AX = end LBA
  7962                                  	
  7963 00002DDF 8B0E[E070]              	mov	cx, [ep_EndSector]
  7964 00002DE3 8B1E[E270]              	mov	bx, [ep_EndSector+2]
  7965                                  
  7966 00002DE7 39DA                      	cmp	dx, bx
  7967 00002DE9 7504                    	jne	short eetc_5
  7968 00002DEB 39C8                    	cmp	ax, cx
  7969 00002DED 744D                    	je	short eetc_7 ; 05/03/2019
  7970                                  eetc_5:
  7971 00002DEF 53                      	push	bx
  7972 00002DF0 BE[8863]                	mov	si, msg_c_ldd_unused_warning
  7973 00002DF3 E83FF0                  	call	print_msg
  7974 00002DF6 5B                      	pop	bx
  7975                                  eetc_6:
  7976 00002DF7 28E4                    	sub	ah, ah
  7977 00002DF9 CD16                    	int	16h
  7978 00002DFB 3C0D                    	cmp	al, 13 ; ENTER
  7979 00002DFD 743D                    	je	short eetc_7 ; continue
  7980 00002DFF 3C1B                    	cmp	al, 27 ; ESC
  7981 00002E01 75F4                    	jne	short eetc_6
  7982                                  
  7983                                  	; 03/03/2019
  7984                                  	; change end cylinder value
  7985 00002E03 A0[9571]                	mov	al, [epnumber]
  7986 00002E06 FEC8                    	dec	al
  7987 00002E08 B412                    	mov	ah, 18  ; primary partition table structure size
  7988 00002E0A F6E4                    	mul	ah
  7989 00002E0C 89C6                    	mov	si, ax
  7990 00002E0E 8B84[5271]              	mov	ax, [si+part_table_end_cyl]
  7991 00002E12 884507                  	mov	[di+ptEndCylinder], al
  7992 00002E15 8A84[5171]              	mov	al, [si+part_table_end_sector]
  7993 00002E19 C0E406                  	shl	ah, 6
  7994 00002E1C 08C4                    	or	ah, al	
  7995 00002E1E 886506                  	mov	[di+ptEndSector], ah
  7996 00002E21 8A84[5071]              	mov	al, [si+part_table_end_head]
  7997 00002E25 884505                  	mov	[di+ptEndHead], al
  7998                                  
  7999 00002E28 89C8                    	mov	ax, cx
  8000 00002E2A 89DA                    	mov	dx, bx
  8001 00002E2C 83C001                  	add	ax, 1
  8002 00002E2F 83D200                  	adc	dx, 0
  8003                                  		; dx:ax = end of ext partition + 1 
  8004 00002E32 2B86[3472]              	sub	ax, [bp+ldd_start]
  8005 00002E36 1B96[3672]              	sbb	dx, [bp+ldd_start+2]
  8006                                  		; dx:ax = new sector count of the ldd
  8007                                  	;mov	[bp+ldd_size], ax
  8008                                  	;mov	[bp+ldd_size+2], dx
  8009 00002E3A EB08                    	jmp	short eetc_8
  8010                                  eetc_7:
  8011 00002E3C 8B86[4472]              	mov	ax, [bp+ldd_size]
  8012 00002E40 8B96[4672]              	mov	dx, [bp+ldd_size+2]
  8013                                  		; dx:ax = sector count
  8014                                  eetc_8:
  8015 00002E44 2B06[9640]              	sub	ax, [sectors]
  8016 00002E48 83DA00                  	sbb	dx, 0
  8017 00002E4B 89450C                  	mov	[di+ptSectors], ax
  8018 00002E4E 89550E                  	mov	[di+ptSectors+2], dx
  8019                                  
  8020                                  	; Get proper FAT type in [ldd_type]
  8021                                  	; by using DX:AX - size -
  8022 00002E51 E8AD00                  	call	size_to_fat_type
  8023                                  
  8024 00002E54 884504                  	mov	[di+ptFileSystemID], al
  8025                                  
  8026                                  	; Write current EBR (with modified PT)
  8027 00002E57 8B86[3472]              	mov	ax, [bp+ldd_start]
  8028 00002E5B 8B96[3672]              	mov	dx, [bp+ldd_start+2]
  8029 00002E5F BB[DA6E]                	mov	bx, ebr_buffer
  8030 00002E62 E8DFEF                  	call	write_hd_sector
  8031 00002E65 0F82ACEF                	jc	D_01 ; ! display error msg and then exit !
  8032                                  
  8033 00002E69 A0[D46E]                	mov	al, [ldrives]
  8034 00002E6C B412                    	mov	ah, 18 ; extended partition table structure size
  8035 00002E6E F6E4                    	mul	ah
  8036                                  
  8037 00002E70 89C6                    	mov	si, ax
  8038 00002E72 81C6[9671]              	add	si, ext_table_boot_ind
  8039 00002E76 87F7                    	xchg	si, di
  8040                                  
  8041                                  	; set partition (logical -dos- drive) data
  8042 00002E78 A5                      	movsw	; boot indicator, beginning head
  8043 00002E79 AC                      	lodsb
  8044 00002E7A 88C4                    	mov	ah, al
  8045 00002E7C 243F                    	and	al, 3Fh
  8046 00002E7E AA                      	stosb	; beginning sector
  8047 00002E7F C0EC06                  	shr	ah, 6
  8048 00002E82 AC                      	lodsb	; beginning cylinder
  8049 00002E83 AB                      	stosw	
  8050 00002E84 A5                      	movsw	; partition id, end head
  8051 00002E85 AC                      	lodsb
  8052 00002E86 88C4                    	mov	ah, al
  8053 00002E88 243F                    	and	al, 3Fh
  8054 00002E8A AA                      	stosb	; end sector
  8055 00002E8B C0EC06                  	shr	ah, 6
  8056 00002E8E AC                      	lodsb	; end cylinder
  8057 00002E8F AB                      	stosw
  8058                                  
  8059 00002E90 A5                      	movsw	; copy start sector (LBA) and sector count
  8060 00002E91 A5                      	movsw
  8061 00002E92 A5                      	movsw
  8062 00002E93 A5                      	movsw
  8063                                  
  8064 00002E94 FE06[D46E]              	inc	byte [ldrives]
  8065                                  
  8066                                  	; Close hard disk image file
  8067                                  
  8068 00002E98 B43E                    	mov	ah, 3Eh ; close file
  8069 00002E9A 8B1E[9440]              	mov	bx, [img_file_handle]
  8070 00002E9E CD21                    	int	21h
  8071                                  
  8072 00002EA0 C706[9440]0000          	mov	word [img_file_handle], 0
  8073                                  	
  8074 00002EA6 E9C9FC                  	jmp	display_extended_pt
  8075                                  
  8076                                  ;-----------------------------------------------------------------------------
  8077                                  ; 05/03/2019
  8078                                  
  8079                                  check_ext_free_space:
  8080 00002EA9 A1[E470]                	mov	ax, [ep_Size]
  8081 00002EAC 8B16[E670]              	mov	dx, [ep_Size+2]
  8082                                  
  8083 00002EB0 8A1E[D46E]              	mov	bl, [ldrives]
  8084 00002EB4 20DB                    	and	bl, bl
  8085 00002EB6 7433                    	jz	short cefs_1
  8086 00002EB8 80FB04                  	cmp	bl, 4
  8087 00002EBB 7602                    	jna	short cefs_0
  8088 00002EBD B304                    	mov	bl, 4
  8089                                  cefs_0:
  8090 00002EBF FECB                    	dec	bl
  8091 00002EC1 C0E302                  	shl	bl, 2 ; *4
  8092 00002EC4 30FF                    	xor	bh, bh
  8093 00002EC6 89DE                    	mov	si, bx
  8094                                  
  8095 00002EC8 8B8C[3472]              	mov	cx, [si+ldd_start]
  8096 00002ECC 8B9C[3672]              	mov	bx, [si+ldd_start+2]
  8097 00002ED0 038C[4472]              	add	cx, [si+ldd_size]
  8098 00002ED4 139C[4672]              	adc	bx, [si+ldd_size+2]
  8099                                  
  8100 00002ED8 0306[DC70]              	add	ax, [ep_StartSector]
  8101 00002EDC 1316[DE70]              	adc	dx, [ep_StartSector+2]
  8102                                  
  8103 00002EE0 29C8                    	sub	ax, cx
  8104 00002EE2 19DA                    	sbb	dx, bx
  8105 00002EE4 7505                    	jnz	short cefs_1
  8106                                  	
  8107 00002EE6 09C0                    	or	ax, ax
  8108 00002EE8 7501                    	jnz	short cefs_1
  8109                                  
  8110                                  	; cf = 0 if the result not negative
  8111                                  
  8112 00002EEA F9                      	stc	
  8113                                  
  8114                                  	; cf = 1 if the result is negative or zero
  8115                                  	 
  8116                                  	; If cf = 0 -> There is free space as in DX:AX
  8117                                  	; NOTE: This calculation is unsafe if
  8118                                  	; logical dos drive count > 4 !	
  8119                                  	; (But still meaningful for creating a new ldd.
  8120                                  	;  Because a new ldd will be created only
  8121                                  	;  if ldd count < 4.)
  8122                                  cefs_1:
  8123 00002EEB C3                      	retn
  8124                                  
  8125                                  ;-----------------------------------------------------------------------------
  8126                                  ; 01/03/2019
  8127                                  
  8128                                  lba_to_chs:
  8129                                  	; INPUT:
  8130                                  	;	DX:AX = LBA address
  8131                                  	; OUTPUT:
  8132                                  	;	AX = cylinder
  8133                                  	;	DL = sector
  8134                                  	;	DH = head
  8135                                  	;
  8136                                  	; (modified registers: ax, bx, cx, dx)
  8137                                  
  8138 00002EEC 8B0E[9640]              	mov	cx, [sectors]
  8139 00002EF0 E843DF                  	call	div32
  8140 00002EF3 FEC3                    	inc	bl
  8141 00002EF5 53                      	push	bx ; BL = sector
  8142 00002EF6 8B0E[9840]              	mov	cx, [heads]
  8143 00002EFA E839DF                  	call	div32
  8144 00002EFD 5A                      	pop	dx  ; DL = sector
  8145 00002EFE 88DE                    	mov	dh, bl ; BL = head
  8146 00002F00 C3                      	retn
  8147                                  
  8148                                  ;-----------------------------------------------------------------------------
  8149                                  ; 02/03/2019
  8150                                  
  8151                                  size_to_fat_type:
  8152                                  	; INPUT:
  8153                                  	;	DX:AX = DOS Partitition Size in sectors
  8154                                  	; OUTPUT:
  8155                                  	;	AL = Partition type/ID (FAT type)
  8156                                  
  8157 00002F01 09D2                    	or	dx, dx
  8158 00002F03 750B                    	jnz	short stft_2
  8159                                  
  8160 00002F05 3DA87F                  	cmp	ax, 32680
  8161 00002F08 7703                    	ja	short stft_1
  8162                                  	
  8163 00002F0A B001                    	mov	al, 1	; FAT12 file system
  8164 00002F0C C3                      	retn
  8165                                  stft_1:
  8166 00002F0D B004                    	mov	al, 4	; FAT16 (< 32MB)
  8167 00002F0F C3                      	retn
  8168                                  stft_2:
  8169 00002F10 83FA10                  	cmp	dx, 10h
  8170 00002F13 7303                    	jnb	short stft_3 ; FAT32 (CHS) file system
  8171                                  
  8172 00002F15 B006                    	mov	al, 6	; FAT16 (>= 32MB)
  8173 00002F17 C3                      	retn
  8174                                  stft_3:
  8175 00002F18 B00B                    	mov	al, 0Bh ; FAT32 (CHS)
  8176 00002F1A C3                      	retn
  8177                                  
  8178                                  ;-----------------------------------------------------------------------------
  8179                                  ; 02/03/2019
  8180                                  
  8181                                  get_ldd_size:	; Get requested logical dos drive size (from user)
  8182                                  	; INPUT -> none
  8183                                  	;
  8184                                  	; OUTPUT -> 
  8185                                  	;	[lcylinders] = cylinder count
  8186                                  	;
  8187                                  	; (Modified registers: ax, bx, cx, dx, si, di)
  8188                                  
  8189 00002F1B B80300                  	mov	ax, 3 ; clear screen
  8190 00002F1E CD10                    	int	10h
  8191                                  
  8192 00002F20 BE[F848]                	mov	si, msg_create_dos_partition_h
  8193 00002F23 E80FEF                  	call	print_msg
  8194                                  
  8195                                  	; 03/03/2019
  8196 00002F26 A0[D46E]                	mov	al, [ldrives]
  8197 00002F29 08C0                    	or	al, al		; cmp byte [ldrives], 0
  8198 00002F2B 740D                    	jz	short gldds_1	; jna short gldds_0
  8199                                  
  8200                                  	;push	ax ; *
  8201                                  
  8202                                  	;dec	al
  8203                                  	;mov	ah, 18
  8204                                  	;mul	ah
  8205                                  	
  8206                                  	;mov	di, ext_table_rel_sec_lw
  8207                                  	;add	di, ax
  8208                                  
  8209 00002F2D BE[0C4F]                	mov	si, msg_use_all_space
  8210 00002F30 E802EF                  	call	print_msg
  8211                                  
  8212                                  	; Calculate available space
  8213                                  
  8214                                  	;mov	ax, [ep_Size] ; ext part size in sectors
  8215                                  	;mov	dx, [ep_Size+2]
  8216                                  	
  8217                                  	; 04/03/2019
  8218                                  ;gldds_0:
  8219                                  	;mov	cx, [di]    ; start sector
  8220                                  	;mov	bx, [di+2]
  8221                                  	;add	cx, [di+4]  ; sectors
  8222                                  	;adc	bx, [di+6]
  8223                                  	;	; bx:cx = start of next ldd
  8224                                  	;sub	ax, cx
  8225                                  	;sbb	dx, bx
  8226                                  	;	; dx:ax = free space in sectors
  8227                                  	;
  8228                                  	;pop	cx ; *
  8229                                  	;dec	cl
  8230                                  	;jz	short gldds_2
  8231                                  	;sub	di, 18
  8232                                  	;push	cx ; *
  8233                                  	;jmp	short gldds_0
  8234                                  
  8235                                  	; 05/03/2019
  8236 00002F33 E873FF                  	call	check_ext_free_space
  8237 00002F36 7243                    	jc	short gldds_cancel
  8238                                  		; DX:AX = free sectors in extended partition
  8239 00002F38 EB0D                    	jmp	short gldds_2
  8240                                  gldds_1:
  8241 00002F3A BE[3F4F]                	mov	si, msg_use_entire_ep_space
  8242 00002F3D E8F5EE                  	call	print_msg
  8243                                  
  8244                                  	; Calculate free space in extended partition
  8245 00002F40 A1[E470]                	mov	ax, [ep_Size]
  8246 00002F43 8B16[E670]              	mov	dx, [ep_Size+2]
  8247                                  gldds_2:
  8248                                  	; subtrack start offset (which always equals to spt value)
  8249 00002F47 2B06[9640]              	sub	ax, [sectors]
  8250 00002F4B 83DA00                  	sbb	dx, 0
  8251                                  
  8252 00002F4E 89C1                    	mov	cx, ax
  8253 00002F50 A0[9840]                	mov	al, [heads]
  8254 00002F53 F626[9640]              	mul	byte [sectors]
  8255 00002F57 91                      	xchg	ax, cx
  8256                                  		; dx:ax = sectors
  8257                                  		; cx = heads*spt 
  8258 00002F58 E8DBDE                  	call	div32
  8259                                  		; ax = cylinders
  8260                                  		; bx = remainder
  8261                                   		; dx = 0
  8262 00002F5B 21DB                    	and	bx, bx
  8263 00002F5D 7401                    	jz	short gldds_3
  8264 00002F5F 40                      	inc	ax
  8265                                  gldds_3:
  8266 00002F60 A3[5672]                	mov	[lcylinders], ax
  8267                                  gldds_getchar:
  8268 00002F63 30E4                    	xor	ah, ah
  8269 00002F65 CD16                    	int	16h
  8270                                  
  8271 00002F67 3C1B                    	cmp	al, 27 ; ESCAPE key
  8272 00002F69 7410                    	je	short gldds_cancel
  8273 00002F6B 24DF                    	and	al, 0DFh
  8274 00002F6D 3C4E                    	cmp	al, 'N'
  8275 00002F6F 7411                    	je	short gldds_4
  8276 00002F71 3C59                    	cmp	al, 'Y'
  8277 00002F73 75EE                    	jne	short gldds_getchar
  8278 00002F75 BE[F65D]                	mov	si, _msg_YES
  8279                                  	;call	print_msg
  8280                                  	;retn
  8281 00002F78 E9BAEE                  	jmp	print_msg
  8282                                  
  8283                                  gldds_cancel:
  8284 00002F7B C706[5672]0000          	mov	word [lcylinders], 0
  8285                                  gldds_28:
  8286 00002F81 C3                      	retn
  8287                                  gldds_4:	
  8288 00002F82 BE[FC5D]                	mov	si, _msg_NO
  8289 00002F85 E8ADEE                  	call	print_msg
  8290                                  gldds_26:
  8291 00002F88 B80300                  	mov	ax, 3 ; clear screen
  8292 00002F8B CD10                    	int	10h
  8293                                  
  8294 00002F8D BE[F848]                	mov	si, msg_create_dos_partition_h
  8295 00002F90 E8A2EE                  	call	print_msg
  8296                                  
  8297 00002F93 BE[0E64]                	mov	si, msg_create_ldd_s
  8298 00002F96 E89CEE                  	call	print_msg
  8299 00002F99 BE[CA4E]                	mov	si, msg_press_esc_to_cancel
  8300 00002F9C E896EE                  	call	print_msg
  8301                                  gldds_25:
  8302 00002F9F 30E4                    	xor	ah, ah
  8303 00002FA1 CD16                    	int	16h
  8304                                  
  8305 00002FA3 3C1B                    	cmp	al, 27 ; ESCAPE key
  8306 00002FA5 7502                    	jne	short gldds_5
  8307                                  
  8308 00002FA7 EBD2                    	jmp	short gldds_cancel
  8309                                  gldds_5:
  8310                                  	; 04/03/2019
  8311 00002FA9 3C20                    	cmp	al, 32 ; SPACE key
  8312 00002FAB 74D4                    	je	short gldds_28
  8313                                  	
  8314 00002FAD C606[AE6E]25            	mov	byte [pSize_unit], '%'
  8315 00002FB2 3C25                    	cmp	al, '%'
  8316 00002FB4 741A                    	je	short gldds_6
  8317 00002FB6 C606[AE6E]4D            	mov	byte [pSize_unit], 'M'
  8318 00002FBB 3C0D                    	cmp	al, 13 ; 0Dh, Carriage Return key
  8319 00002FBD 7411                    	je	short gldds_6
  8320 00002FBF 24DF                    	and	al, 0DFh
  8321 00002FC1 3C4D                    	cmp	al, 'M'
  8322 00002FC3 740B                    	je	short gldds_6
  8323 00002FC5 A2[AE6E]                	mov	[pSize_unit], al
  8324 00002FC8 3C47                    	cmp	al, 'G'
  8325 00002FCA 7404                    	je	short gldds_6
  8326 00002FCC 3C43                    	cmp	al, 'C'
  8327 00002FCE 75CF                    	jne	short gldds_25
  8328                                  gldds_6:
  8329                                  	; Set maximum sector count (all of extended partition)
  8330 00002FD0 A0[9640]                	mov	al, [sectors]
  8331 00002FD3 F626[9840]              	mul	byte [heads]
  8332 00002FD7 F726[5672]              	mul	word [lcylinders]
  8333 00002FDB A3[9C6E]                	mov	[pp_Sectors], ax
  8334 00002FDE 8916[9E6E]              	mov	[pp_Sectors+2], dx
  8335                                  	
  8336 00002FE2 E897F0                   	call	partition_size_input
  8337 00002FE5 7294                    	jc	short gldds_cancel
  8338                                  		; DX:AX = Partition size in sectors
  8339                                  	;or	bx, bx
  8340                                  	;jnz	short gldds_cancel
  8341 00002FE7 89C1                    	mov	cx, ax
  8342 00002FE9 A0[9840]                	mov	al, [heads]
  8343 00002FEC F626[9640]              	mul	byte [sectors]
  8344 00002FF0 91                      	xchg	ax, cx
  8345                                  		; dx:ax = sectors
  8346                                  		; cx = heads*spt 
  8347 00002FF1 E842DE                  	call	div32
  8348                                  		; ax = cylinders
  8349                                  		; bx = remainder
  8350                                   		; dx = 0
  8351 00002FF4 21DB                    	and	bx, bx
  8352 00002FF6 7401                    	jz	short gldds_7
  8353 00002FF8 40                      	inc	ax
  8354                                  gldds_7:
  8355 00002FF9 3B06[5672]              	cmp	ax, [lcylinders]
  8356 00002FFD 7704                    	ja	short gldds_9
  8357                                  gldds_8:
  8358                                  	; OK
  8359 00002FFF A3[5672]                	mov	[lcylinders], ax
  8360 00003002 C3                      	retn
  8361                                  
  8362                                  gldds_9:
  8363                                  	; Partition size limit message
  8364                                  	
  8365 00003003 803E[AE6E]43            	cmp	byte [pSize_unit], 'C'
  8366 00003008 7407                    	je	short gldds_10
  8367                                  
  8368                                  	; Tolerate 1 cylinder if unit is not cylinder
  8369 0000300A 48                      	dec	ax
  8370 0000300B 3B06[5672]              	cmp	ax, [lcylinders]
  8371 0000300F 76EE                    	jna	short gldds_8
  8372                                  gldds_10:
  8373                                  	; clear screen
  8374 00003011 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  8375 00003014 CD10                    	int	10h
  8376                                  
  8377 00003016 BE[F848]                	mov	si, msg_create_dos_partition_h ; header
  8378 00003019 E819EE                  	call	print_msg
  8379                                  
  8380 0000301C BE[BB5F]                	mov	si, msg_partition_size_limit
  8381 0000301F E813EE                  	call	print_msg
  8382                                  
  8383 00003022 803E[AE6E]4D            	cmp	byte [pSize_unit], 'M'
  8384 00003027 7413                    	je	short gldds_11
  8385                                  
  8386 00003029 803E[AE6E]25            	cmp	byte [pSize_unit], '%'
  8387 0000302E 745A                    	je	short gldds_22
  8388                                  
  8389 00003030 803E[AE6E]43            	cmp	byte [pSize_unit], 'C'
  8390 00003035 7505                    	jne	short gldds_11
  8391                                  
  8392 00003037 A1[5672]                	mov	ax, [lcylinders]
  8393 0000303A EB0F                    	jmp	short gldds_12
  8394                                  gldds_11:
  8395                                  	; 'M'
  8396 0000303C A1[9C6E]                	mov	ax, [pp_Sectors]
  8397 0000303F 8B16[9E6E]              	mov	dx, [pp_Sectors+2]
  8398 00003043 B90008                  	mov	cx, 2*1024 ; sectors -> MB
  8399 00003046 E8EDDD                  	call	div32
  8400                                  		; DX = 0 
  8401                                  		; AX = Available space in Megabytes
  8402 00003049 89C7                    	mov	di, ax
  8403                                  gldds_12:	
  8404 0000304B B90A00                  	mov	cx, 10
  8405 0000304E 89E5                    	mov	bp, sp
  8406                                  gldds_13:
  8407 00003050 31D2                    	xor	dx, dx
  8408 00003052 B90A00                  	mov	cx, 10
  8409 00003055 F7F1                    	div	cx
  8410 00003057 52                      	push	dx
  8411 00003058 83F809                  	cmp	ax, 9
  8412 0000305B 77F3                    	ja	short gldds_13
  8413                                  gldds_14:
  8414 0000305D BB0700                  	mov	bx, 07h
  8415 00003060 09C0                    	or	ax, ax
  8416 00003062 7501                    	jnz	short gldds_16
  8417                                  gldds_15:
  8418 00003064 58                      	pop	ax
  8419                                  gldds_16:
  8420 00003065 0430                    	add	al, '0'
  8421                                  gldds_17:
  8422 00003067 B40E                    	mov	ah, 0Eh
  8423                                  	;mov	bx, 07h
  8424 00003069 CD10                    	int	10h	; write character (as tty)
  8425                                  
  8426 0000306B 39EC                    	cmp	sp, bp
  8427 0000306D 72F5                    	jb	short gldds_15
  8428                                  
  8429 0000306F 803E[AE6E]25            	cmp	byte [pSize_unit], '%'
  8430 00003074 7508                    	jne	short gldds_18
  8431                                  
  8432 00003076 3C25                    	cmp	al, '%'
  8433 00003078 743C                    	je	short gldds_21
  8434 0000307A B025                    	mov	al, '%'
  8435 0000307C EBE9                    	jmp	short gldds_17
  8436                                  gldds_18:
  8437 0000307E 803E[AE6E]43            	cmp	byte [pSize_unit], 'C'
  8438 00003083 751C                    	jne	short gldds_19
  8439                                  
  8440 00003085 BE[5760]                	mov	si, msg_cylinders
  8441 00003088 EB29                    	jmp	short gldds_20
  8442                                  
  8443                                  gldds_22:
  8444                                  	; '%'
  8445 0000308A 81C3[E471]              	add	bx, free_space.percent_unused
  8446 0000308E 8B07                    	mov	ax, [bx]
  8447                                  gldds_23:	
  8448 00003090 89E5                    	mov	bp, sp
  8449                                  gldds_24:	
  8450 00003092 31D2                    	xor	dx, dx
  8451 00003094 B90A00                  	mov	cx, 10
  8452 00003097 F7F1                    	div	cx
  8453 00003099 52                      	push	dx
  8454 0000309A 83F809                  	cmp	ax, 9
  8455 0000309D 77F3                    	ja	short gldds_24
  8456 0000309F EBBC                    	jmp	short gldds_14
  8457                                  
  8458                                  gldds_19:
  8459 000030A1 BE[6B60]                	mov	si, msg_megabytes
  8460 000030A4 C606[7460]73            	mov	byte [msg_megabytes_s], 's'
  8461 000030A9 83FF01                  	cmp	di, 1
  8462 000030AC 7705                    	ja	short gldds_20
  8463 000030AE C606[7460]00            	mov	byte [msg_megabytes_s], 0
  8464                                  gldds_20:
  8465 000030B3 E87FED                  	call	print_msg
  8466                                  gldds_21:
  8467 000030B6 BE[0860]                	mov	si, msg_partition_size_limit_r
  8468 000030B9 E879ED                  	call	print_msg
  8469                                  gldds_27:
  8470 000030BC 30E4                    	xor	ah, ah
  8471 000030BE CD16                    	int	16h
  8472                                  	
  8473 000030C0 3C1B                    	cmp	al, 27 ; ESCAPE key
  8474 000030C2 0F84C2FE                	je	gldds_26
  8475 000030C6 3C0D                    	cmp	al, 13 ; ENTER (Carriage Return) key
  8476 000030C8 75F2                    	jne	short gldds_27
  8477                                  
  8478                                  	;mov	ax, [lcylinders]
  8479 000030CA C3                      	retn
  8480                                  	
  8481                                  ;-----------------------------------------------------------------------------
  8482                                  ; 26/02/2019
  8483                                  
  8484                                  init_ext_partition_tables:
  8485                                  
  8486                                  	; INPUT -> 
  8487                                  	;	[epnumber] = extended partition number
  8488                                  	;
  8489                                  	; OUTPUT -> none
  8490                                  
  8491                                  ; Display Method: ; 04/03/2019
  8492                                  ;LDD 1 <- LDD_START0, ebr 1st entry <- MBR (extended partition) - EBR 0
  8493                                  ;LDD 2 <- LDD_START1, ebr 1st entry <- EBR 1
  8494                                  ;LDD 3 <- LDD_START2, ebr 1st entry <- EBR 2
  8495                                  ;LDD 4 <- LDD_START3, ebr 1st entry <- EBR 3
  8496                                  ;LDD 5 <- LDD_START3, ebr 2nd entry (LDD 5 is not diplayed)
  8497                                  
  8498                                  	; 08/03/2019
  8499                                  
  8500                                  	; clear extended partition tables structure/list
  8501                                  
  8502 000030CB BF[9671]                	mov	di, ext_table_boot_ind
  8503 000030CE 89FE                    	mov	si, di ; 28/02/2019
  8504 000030D0 B92400                  	mov	cx, 36 ; 18*4 = 72 bytes
  8505 000030D3 31C0                    	xor	ax, ax ; 0
  8506 000030D5 F3AB                    	rep	stosw
  8507 000030D7 89F7                    	mov	di, si ; 28/02/2019
  8508                                  
  8509                                  	;mov	byte [ldrives], 0
  8510 000030D9 A2[D46E]                	mov	[ldrives], al ; 0
  8511                                  
  8512                                  	;cmp	byte [epnumber], 1
  8513                                  	;jb	short iept_0
  8514                                  
  8515 000030DC A0[9571]                	mov	al, [epnumber]
  8516 000030DF FEC8                    	dec	al
  8517 000030E1 B412                    	mov	ah, 18  ; partition table structure size 
  8518 000030E3 F6E4                    	mul	ah
  8519 000030E5 BE[5471]                	mov	si, part_table_rel_sec_lw
  8520 000030E8 01C6                    	add	si, ax
  8521 000030EA 8B04                    	mov	ax, [si]
  8522 000030EC 8B5402                  	mov	dx, [si+2]
  8523 000030EF A3[DC70]                	mov	[ep_StartSector], ax
  8524 000030F2 8916[DE70]              	mov	[ep_StartSector+2], dx
  8525 000030F6 8B4C04                  	mov	cx, [si+4]
  8526 000030F9 8B5C06                  	mov	bx, [si+6]
  8527 000030FC 890E[E470]              	mov	[ep_Size], cx
  8528 00003100 891E[E670]              	mov	[ep_Size+2], bx
  8529 00003104 83E901                  	sub	cx, 1
  8530 00003107 83DB00                  	sbb	bx, 0
  8531 0000310A 01C1                    	add	cx, ax
  8532 0000310C 11D3                    	adc	bx, dx 
  8533 0000310E 890E[E070]              	mov	[ep_EndSector], cx
  8534 00003112 891E[E270]              	mov	[ep_EndSector+2], bx
  8535                                  
  8536                                  	; 27/02/2019
  8537 00003116 A3[3472]                	mov	[ldd_start], ax
  8538 00003119 8916[3672]              	mov	[ldd_start+2], dx
  8539                                  
  8540                                  	; 03/03/2019
  8541                                  	;mov	word [ldd_size], 0
  8542                                  	;mov	word [ldd_size+2], 0
  8543                                  	
  8544 0000311D BB[DA6E]                	mov	bx, ebr_buffer
  8545                                  	; dx:ax = Extended partition address
  8546                                  	; es:bx = Extended partition buffer 
  8547 00003120 E860ED                  	call	read_hd_sector
  8548 00003123 7209                    	jc	short iept_0
  8549                                  
  8550                                  	; Check EBR if it is a valid boot record or not
  8551 00003125 813E[D870]55AA          	cmp	word [ebr_buffer+510], 0AA55h
  8552 0000312B 7402                    	je	short iept_1
  8553                                  iept_stc_retn:
  8554 0000312D F9                      	stc
  8555                                  iept_0:
  8556 0000312E C3                      	retn
  8557                                  iept_1:
  8558                                  	; Check PTE 1, if it is valid or not
  8559 0000312F A0[9C70]                	mov	al, [ebr_buffer+446+ptFileSystemID]
  8560 00003132 20C0                    	and	al, al
  8561 00003134 74F7                    	jz	short iept_stc_retn ; empty pte, error
  8562 00003136 3C05                    	cmp	al, 5
  8563 00003138 74F3                    	je	short iept_stc_retn ; extended partition, error
  8564                                  
  8565                                  	;inc	byte [ldrives] ; logical (dos) drive count
  8566                                  
  8567 0000313A BE[9870]                	mov	si, ebr_buffer+446 ; Partition table offset
  8568 0000313D B90400                  	mov	cx, 4
  8569                                  
  8570                                  	; set partition (logical -dos- drive) data
  8571 00003140 A5                      	movsw	; boot indicator, beginning head
  8572 00003141 AC                      	lodsb
  8573 00003142 88C4                    	mov	ah, al
  8574 00003144 243F                    	and	al, 3Fh
  8575 00003146 AA                      	stosb	; beginning sector
  8576 00003147 C0EC06                  	shr	ah, 6
  8577 0000314A AC                      	lodsb	; beginning cylinder
  8578 0000314B AB                      	stosw	
  8579 0000314C A5                      	movsw	; partition id, end head
  8580 0000314D AC                      	lodsb
  8581 0000314E 88C4                    	mov	ah, al
  8582 00003150 243F                    	and	al, 3Fh
  8583 00003152 AA                      	stosb	; end sector
  8584 00003153 C0EC06                  	shr	ah, 6
  8585 00003156 AC                      	lodsb	; end cylinder
  8586 00003157 AB                      	stosw
  8587                                  
  8588                                  	; 04/03/2019
  8589 00003158 8A1E[D46E]              	mov	bl, [ldrives]
  8590                                  	;dec 	bl
  8591                                  	;jnz	short iept_2
  8592                                  
  8593                                  	; 05/03/2019
  8594 0000315C 08DB                    	or	bl, bl
  8595 0000315E 7518                    	jnz	short iept_2
  8596                                  
  8597 00003160 8B04                    	mov	ax, [si]   ; start sector of 1st LDD (offset)
  8598 00003162 8B5402                  	mov	dx, [si+2]
  8599 00003165 034404                  	add	ax, [si+4] ; size of 1st LDD (volume)
  8600 00003168 135406                  	adc	dx, [si+6]
  8601                                  
  8602 0000316B A3[4472]                	mov	[ldd_size], ax ; size of 1st LDD (partition)
  8603 0000316E 8916[4672]              	mov	[ldd_size+2], dx
  8604                                  	; 05/03/2019
  8605 00003172 FE06[D46E]              	inc	byte [ldrives] ; logical (dos) drive count
  8606 00003176 FEC3                    	inc	bl
  8607                                  iept_2:
  8608 00003178 F3A5                    	rep	movsw ; copy start sector (LBA) and sector count
  8609                                  
  8610                                  	; get next extended partition (logical -dos- drive) data
  8611 0000317A 8A4404                  	mov	al, [si+ptFileSystemID]
  8612 0000317D 20C0                    	and	al, al ; EMPTY
  8613 0000317F 74AD                    	jz	short iept_0 ; end of logical -dos- drive chain
  8614                                  
  8615 00003181 3C05                    	cmp	al, 5 ; EXTENDED
  8616 00003183 75A8                    	jne	short iept_stc_retn  ; 2nd PTE must have
  8617                                  				     ; extended partition ID
  8618                                  
  8619                                  	; 05/03/2019
  8620 00003185 FE06[D46E]              	inc	byte [ldrives] ; logical (dos) drive count
  8621                                  
  8622                                  	;cmp	byte [ldrives], al ; 5
  8623 00003189 80FB04                  	cmp	bl, 4 ; number of logical dos drives (till here)
  8624 0000318C 733D                    	jnb	short iept_3
  8625                                  
  8626 0000318E 83C608                  	add	si, 8
  8627                                  
  8628 00003191 AD                      	lodsw	
  8629 00003192 89C2                    	mov	dx, ax	; start sector
  8630 00003194 AD                      	lodsw
  8631 00003195 92                      	xchg	dx, ax	; start sector + 2
  8632                                  
  8633                                  	; 04/03/2019
  8634 00003196 0306[DC70]              	add	ax, [ep_StartSector]
  8635 0000319A 1316[DE70]              	adc	dx, [ep_StartSector+2]
  8636                                  	
  8637 0000319E 30FF                    	xor	bh, bh
  8638 000031A0 C0E302                  	shl	bl, 2 ; *4
  8639                                  
  8640                                  	; 28/02/2019
  8641 000031A3 8987[3472]              	mov	[bx+ldd_start], ax ; start of (next) LDD (partition)
  8642 000031A7 8997[3672]              	mov	[bx+ldd_start+2], dx
  8643                                  
  8644                                  	; 03/03/2019
  8645                                  	; set partition size for logical dos drive
  8646 000031AB 8B0C                    	mov	cx, [si]
  8647 000031AD 898F[4472]              	mov	[bx+ldd_size], cx
  8648 000031B1 8B4C02                  	mov	cx, [si+2]
  8649 000031B4 898F[4672]              	mov	[bx+ldd_size+2], cx
  8650                                  
  8651 000031B8 BB[DA6E]                	mov	bx, ebr_buffer
  8652                                  	; dx:ax = Extended partition address
  8653                                  	; es:bx = Extended partition buffer 
  8654 000031BB E8C5EC                  	call	read_hd_sector
  8655 000031BE 720B                    	jc	short iept_3 ; 03/03/2019
  8656                                  
  8657                                  	; Check EBR if it is valid or not
  8658 000031C0 813E[D870]55AA          	cmp	word [ebr_buffer+510], 0AA55h
  8659 000031C6 0F8465FF                	je	iept_1
  8660                                  
  8661 000031CA F9                      	stc
  8662                                  iept_3:	
  8663 000031CB C3                      	retn
  8664                                  
  8665                                  ;-----------------------------------------------------------------------------
  8666                                  ; 27/02/2019
  8667                                  
  8668                                  delete_logical_drives:
  8669                                  
  8670                                  ; Delete Method: ; 04/03/2019
  8671                                  ;LDD 5 <- LDD_START3, ebr 2nd entry
  8672                                  ;LDD 4 <- LDD_START2, ebr 2nd entry
  8673                                  ;LDD 3 <- LDD_START1, ebr 2nd entry
  8674                                  ;LDD 2 <- LDD_START0, ebr 2nd entry
  8675                                  ;LDD 1 <- LDD_START0, ebr 1st entry
  8676                                  
  8677                                  	;cmp	byte [ldrives], 0
  8678                                  	;jna	short dld_stc
  8679                                  
  8680 000031CC B005                    	mov	al, 5 ; extended partition (logical drives)
  8681 000031CE E8BCF7                  	call	display_partition_table
  8682                                  
  8683 000031D1 A0[D46E]                	mov	al, [ldrives]
  8684 000031D4 0430                    	add	al, '0'
  8685 000031D6 A2[E161]                	mov	[lddp_num], al
  8686                                  
  8687 000031D9 BE[8E61]                	mov	si, msg_delete_ldd
  8688 000031DC E856EC                  	call	print_msg
  8689                                  
  8690 000031DF BE[CA4E]                	mov	si, msg_press_esc_to_cancel
  8691 000031E2 E850EC                  	call	print_msg
  8692                                  dld_0:
  8693 000031E5 30E4                    	xor	ah, ah
  8694 000031E7 CD16                    	int	16h
  8695                                  
  8696 000031E9 80FC53                  	cmp	ah, 53h  ; DELETE or DEL key
  8697 000031EC 7527                    	jne	short dld_1
  8698                                  
  8699                                  	; Open disk image file again.
  8700 000031EE BA[8559]                	mov	dx, img_file_name
  8701 000031F1 B8023D                  	mov	ax, 3D02h ; open for reading and writing
  8702 000031F4 CD21                    	int	21h
  8703 000031F6 7221                    	jc	short dld_5
  8704                                  
  8705 000031F8 A3[9440]                	mov	[img_file_handle], ax
  8706                                  
  8707                                  	; Delete PTE 1 & PTE 2 on EBR 1
  8708                                  	;xor	ah, ah
  8709 000031FB A0[D46E]                	mov	al, [ldrives]
  8710 000031FE FEC8                    	dec	al
  8711 00003200 7518                    	jnz	short dld_2
  8712                                  
  8713 00003202 BF[9870]                	mov	di, ebr_buffer+446
  8714 00003205 B91000                  	mov	cx, 16
  8715 00003208 F3AB                    	rep	stosw
  8716                                  
  8717                                  	; 04/03/2019
  8718                                  	; Clear ldd data in extended partition table/structure
  8719 0000320A BF[9671]                	mov	di, ext_table_boot_ind
  8720 0000320D B109                    	mov	cl, 9
  8721 0000320F F3AB                    	rep	stosw
  8722 00003211 31F6                    	xor	si, si
  8723 00003213 EB40                    	jmp	short dld_3
  8724                                  dld_1:	
  8725 00003215 3C1B                    	cmp	al, 27 ; ESC key
  8726 00003217 75CC                    	jne	short dld_0
  8727                                  dld_5:
  8728 00003219 C3                      	retn
  8729                                  
  8730                                  ;dld_stc:
  8731                                  ;	stc
  8732                                  ;	retn
  8733                                  
  8734                                  dld_2:
  8735                                  	; 04/03/2019
  8736                                  	; Delete 2nd PTE on EBR 2 to 4
  8737 0000321A FEC8                    	dec	al 
  8738 0000321C C0E002                  	shl	al, 2 ; *4
  8739 0000321F 89C6                    	mov	si, ax
  8740                                  
  8741 00003221 8B84[3472]              	mov	ax, [si+ldd_start]
  8742 00003225 8B94[3672]              	mov	dx, [si+ldd_start+2]
  8743 00003229 BB[DA6E]                	mov	bx, ebr_buffer
  8744 0000322C E854EC                  	call	read_hd_sector
  8745 0000322F 7238                    	jc	short dld_4
  8746                                  
  8747 00003231 BF[A870]                	mov	di, ebr_buffer+446+16
  8748 00003234 B90800                  	mov	cx, 8
  8749 00003237 29C0                    	sub	ax, ax
  8750 00003239 F3AB                    	rep	stosw
  8751                                  
  8752                                  	; 04/03/2019
  8753                                  	;cmp	byte [ldrives], 5
  8754                                  	;jnb	short dld_3
  8755 0000323B 8A26[D46E]              	mov	ah, [ldrives]
  8756 0000323F 80FC05                  	cmp	ah, 5
  8757 00003242 7311                    	jnb	short dld_3
  8758                                  
  8759                                  	; Clear ldd data in extended partition table/structure
  8760                                  	;mov	ah, [ldrives]
  8761 00003244 FECC                    	dec	ah
  8762 00003246 B012                    	mov	al, 18
  8763 00003248 F6E4                    	mul	ah
  8764 0000324A BF[9671]                	mov	di, ext_table_boot_ind
  8765 0000324D 01C7                    	add	di, ax
  8766                                  	;mov	cx, 9
  8767 0000324F B109                    	mov	cl, 9
  8768                                  	;xor	ax, ax
  8769 00003251 30C0                    	xor	al, al
  8770 00003253 F3AB                    	rep	stosw
  8771                                  dld_3:
  8772                                  	; Write changed EBR
  8773 00003255 8B84[3472]              	mov	ax, [si+ldd_start]
  8774 00003259 8B94[3672]              	mov	dx, [si+ldd_start+2]
  8775 0000325D BB[DA6E]                	mov	bx, ebr_buffer
  8776 00003260 E8E1EB                  	call	write_hd_sector
  8777 00003263 7204                    	jc	short dld_4
  8778                                  
  8779                                  	; 28/02/2019
  8780 00003265 FE0E[D46E]              	dec	byte [ldrives]
  8781                                  dld_4:
  8782                                  	; Close file
  8783 00003269 8B1E[9440]              	mov	bx, [img_file_handle]
  8784 0000326D B43E                    	mov	ah, 3Eh ; close file
  8785 0000326F CD21                    	int	21h
  8786                                  
  8787 00003271 C706[9440]0000          	mov	word [img_file_handle], 0
  8788                                  
  8789 00003277 803E[D46E]00            	cmp	byte [ldrives], 0
  8790 0000327C 0F874CFF                	ja	delete_logical_drives
  8791                                  
  8792 00003280 C3                      	retn
  8793                                  
  8794                                  ;=============================================================================
  8795                                  ;        	initialized data
  8796                                  ;=============================================================================
  8797                                  
  8798 00003281 00                      	db	0
  8799                                  
  8800                                  TRDOS386_MASTERBOOT_SECTOR:
  8801 00003282 <bin 200h>              	incbin	'FS1_MBR.BIN' ; Singlix FS1 MBR
  8802                                  
  8803                                  TRDOS_FAT_hd_bs:
  8804                                  	;incbin 'TRHDBS.BIN'
  8805                                  	; 04/05/2024
  8806                                  ;TRDOS_FAT32_hd_bs:
  8807                                  	;incbin	'FAT32_BS.BIN' ; 27/04/2024
  8808                                  RD5_FAT32_hd_bs:
  8809 00003482 <bin 400h>              	incbin	'RD5HDBS3.BIN' ; 29/04/2024
  8810                                  ;TRDOS_FAT16_hd_bs: 
  8811                                  	;incbin	'FAT16_BS.BIN' ; 26/12/2017
  8812                                  RD5_FAT16_hd_bs:
  8813 00003882 <bin 200h>              	incbin	'RD5HDBS2.BIN' ; 20/04/2024
  8814                                  ;TRDOS_FAT12_hd_bs: 
  8815                                  	;incbin	'FAT12_BS.BIN' ; 26/12/2017
  8816                                  RD5_FAT12_hd_bs:
  8817 00003A82 <bin 200h>              	incbin	'RD5HDBS1.BIN' ; 20/04/2024
  8818                                  
  8819                                  TRDOS_TRFS1_chs_bs:
  8820 00003C82 <bin 200h>              	incbin	'TRFS1CHS.BIN' ; Singlix FS1 (CHS+LBA Disk) BS
  8821                                  TRDOS_TRFS1_lba_bs:
  8822 00003E82 <bin 200h>              	incbin	'TRFS1LBA.BIN' ; Singlix FS1 (LBA Disk) BS
  8823                                  
  8824 00004082 00                      	db	0
  8825                                  
  8826                                  hexchrs:
  8827 00004083 303132333435363738-     	db	'0123456789ABCDEF'
  8827 0000408C 39414243444546     
  8828                                  
  8829 00004093 90                      align 2
  8830                                  
  8831                                  img_file_handle:
  8832 00004094 0000                    	dw	0
  8833                                  
  8834                                  ; (TR-DOS 386 compatible) Hard Disk (image) parameters
  8835                                  
  8836                                  sectors: ; sectors per track (63)
  8837 00004096 3F00                    	dw 63
  8838                                  heads:	 ; number of heads (16 or 32 or 64) 
  8839 00004098 1000                    	dw 16
  8840                                  cylinders: ; number of cylinders (16 to 1024)
  8841 0000409A 0004                    	dw 1024
  8842                                  
  8843                                  random:
  8844 0000409C 00                      	db	0  ; random write to file (0 = sequental)
  8845                                  newdisk:
  8846 0000409D 00                      	db	0
  8847                                  
  8848                                  FileSys_Names: ; 2003-2017
  8849                                  ; (Valid FileSystems for TRDOS 386, SINGLIX, RETRO UNIX OS projects in 2017)
  8850 0000409E 464154313220202020-     FS_FAT12:     db "FAT12         "  ; 01h = FAT12
  8850 000040A7 2020202020         
  8851 000040AC 58454E495820202020-     FS_XENIX:     db "XENIX         "  ; 02h , XENIX System V root
  8851 000040B5 2020202020         
  8852 000040BA 58454E495820757372-     FS_XENIX_USR: db "XENIX usr     "  ; 03h , XENIX System V user
  8852 000040C3 2020202020         
  8853 000040C8 464154313620283034-     FS_FAT16:     db "FAT16 (04h)   "  ; 04h = FAT16 < 32MB
  8853 000040D1 6829202020         
  8854 000040D6 455854454E44454420-     FS_EXT_CHS:   db "EXTENDED (CHS)"  ; 05h = Extended DOS Partition
  8854 000040DF 2843485329         
  8855 000040E4 464154313620283036-     FS_FAT16_BIG: db "FAT16 (06h)   "  ; 06h = FAT16 > 32MB, CHS mode
  8855 000040ED 6829202020         
  8856 000040F2 4E5446532020202020-     FS_NTFS:      db "NTFS          "  ; 07h , WINDOWS NTFS Partition
  8856 000040FB 2020202020         
  8857 00004100 464154333220284348-     FS_FAT32_CHS: db "FAT32 (CHS)   "  ; 0Bh = FAT32, CHS mode
  8857 00004109 5329202020         
  8858 0000410E 464154333220284C42-     FS_FAT32_LBA: db "FAT32 (LBA)   "  ; 0Ch = FAT32, LBA mode
  8858 00004117 4129202020         
  8859 0000411C 464154313620284C42-     FS_FAT16_LBA: db "FAT16 (LBA)   "  ; 0Eh = FAT16, LBA mode
  8859 00004125 4129202020         
  8860 0000412A 455854454E44454420-     FS_EXT_LBA:   db "EXTENDED (LBA)"  ; 0Fh = Extented Partition, LBA mode
  8860 00004133 284C424129         
  8861 00004138 554E49582053595354-     FS_UNIX_SYSV: db "UNIX SYSTEM V "  ; 63h , SCO UNIX, UNIXWARE, OPENSERVER
  8861 00004141 454D205620         
  8862 00004146 524554524F20554E49-     FS_RETROUNIX: db "RETRO UNIX    "  ; 71h , Retro UNIX 386 v2 Partition
  8862 0000414F 5820202020         
  8863 00004154 554E49582056372020-     FS_UNIX_V7:   db "UNIX V7       "  ; 72h , UNIX v7 x86 Partition  
  8863 0000415D 2020202020         
  8864 00004162 4C494E555820535741-     FS_LINUXSWAP: db "LINUX SWAP    "  ; 82h , LINUX SWAP Partition
  8864 0000416B 5020202020         
  8865 00004170 4C494E555820202020-     FS_LINUX:     db "LINUX         "  ; 83h , LINUX NATIVE (ext2) Partition
  8865 00004179 2020202020         
  8866 0000417E 4C494E555820455854-     FS_LINUXEXT:  db "LINUX EXTENDED"  ; 85h , LINUX EXTENDED Partition
  8866 00004187 454E444544         
  8867 0000418C 524444202020202020-     FS_TRDD:      db "RDD           "  ; A0h , (Random Data Disk) LBA
  8867 00004195 2020202020         
  8868 0000419A 53494E474C49582046-     FS_TRFS:      db "SINGLIX FS1   "  ; A1h , (32 bit, 512 bytes per sector)
  8868 000041A3 5331202020         
  8869 000041A8 554E4B4E4F574E2046-     FS_OTHERS:    db "UNKNOWN FS    "  ; Another or Unknown File Systems
  8869 000041B1 5320202020         
  8870                                   
  8871                                  valid_partitions: ; (*)
  8872 000041B6 01020304050607          	      db 01h, 02h, 03h, 04h, 05h, 06h, 07h
  8873 000041BD 0B0C0E0F637172          	      db 0Bh, 0Ch, 0Eh, 0Fh, 63h, 71h, 72h
  8874 000041C4 828385A0A1              	      db 82h, 83h, 85h, 0A0h, 0A1h
  8875                                  
  8876                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8877                                  ;  Messages
  8878                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8879                                  
  8880                                  CHS_msg: ; 80 bytes per row
  8881 000041C9 507265737320274327-     db  "Press 'C' to set cylinders then press '+,-' keys to change number of cylinders. "
  8881 000041D2 20746F207365742063-
  8881 000041DB 796C696E6465727320-
  8881 000041E4 7468656E2070726573-
  8881 000041ED 7320272B2C2D27206B-
  8881 000041F6 65797320746F206368-
  8881 000041FF 616E6765206E756D62-
  8881 00004208 6572206F662063796C-
  8881 00004211 696E646572732E20   
  8882 00004219 507265737320274827-     db  "Press 'H' to set heads then press '+,-' keys to change number of heads.         "
  8882 00004222 20746F207365742068-
  8882 0000422B 65616473207468656E-
  8882 00004234 20707265737320272B-
  8882 0000423D 2C2D27206B65797320-
  8882 00004246 746F206368616E6765-
  8882 0000424F 206E756D626572206F-
  8882 00004258 662068656164732E20-
  8882 00004261 2020202020202020   
  8883 00004269 507265737320275327-     db  "Press 'S' to set sectors then press '+,-' keys to change numb of sectors/track. "
  8883 00004272 20746F207365742073-
  8883 0000427B 6563746F7273207468-
  8883 00004284 656E20707265737320-
  8883 0000428D 272B2C2D27206B6579-
  8883 00004296 7320746F206368616E-
  8883 0000429F 6765206E756D62206F-
  8883 000042A8 6620736563746F7273-
  8883 000042B1 2F747261636B2E20   
  8884 000042B9 202020202020202020-     db  "                                                                                "
  8884 000042C2 202020202020202020-
  8884 000042CB 202020202020202020-
  8884 000042D4 202020202020202020-
  8884 000042DD 202020202020202020-
  8884 000042E6 202020202020202020-
  8884 000042EF 202020202020202020-
  8884 000042F8 202020202020202020-
  8884 00004301 2020202020202020   
  8885 00004309 202020202020202020-     db  "                                                                                "
  8885 00004312 202020202020202020-
  8885 0000431B 202020202020202020-
  8885 00004324 202020202020202020-
  8885 0000432D 202020202020202020-
  8885 00004336 202020202020202020-
  8885 0000433F 202020202020202020-
  8885 00004348 202020202020202020-
  8885 00004351 2020202020202020   
  8886 00004359 507265737320454E54-     db  "Press ENTER to use current CHS values.                                          "
  8886 00004362 455220746F20757365-
  8886 0000436B 2063757272656E7420-
  8886 00004374 4348532076616C7565-
  8886 0000437D 732E20202020202020-
  8886 00004386 202020202020202020-
  8886 0000438F 202020202020202020-
  8886 00004398 202020202020202020-
  8886 000043A1 2020202020202020   
  8887 000043A9 202020202020202020-     db  "                                                                                "
  8887 000043B2 202020202020202020-
  8887 000043BB 202020202020202020-
  8887 000043C4 202020202020202020-
  8887 000043CD 202020202020202020-
  8887 000043D6 202020202020202020-
  8887 000043DF 202020202020202020-
  8887 000043E8 202020202020202020-
  8887 000043F1 2020202020202020   
  8888 000043F9 507265737320455343-     db  "Press ESC to cancel.                                                            "
  8888 00004402 20746F2063616E6365-
  8888 0000440B 6C2E20202020202020-
  8888 00004414 202020202020202020-
  8888 0000441D 202020202020202020-
  8888 00004426 202020202020202020-
  8888 0000442F 202020202020202020-
  8888 00004438 202020202020202020-
  8888 00004441 2020202020202020   
  8889 00004449 202020202020202020-     db  "                                                                                "
  8889 00004452 202020202020202020-
  8889 0000445B 202020202020202020-
  8889 00004464 202020202020202020-
  8889 0000446D 202020202020202020-
  8889 00004476 202020202020202020-
  8889 0000447F 202020202020202020-
  8889 00004488 202020202020202020-
  8889 00004491 2020202020202020   
  8890 00004499 00                      db  0
  8891                                  
  8892                                  	; 04/05/2024
  8893                                  ;TrDOS_Welcome:
  8894                                  RD5_Welcome:
  8895 0000449A 0D0A                    	db	0Dh, 0Ah
  8896                                  	;db	'TR-DOS 386 Fixed Disk Image Format Utility'
  8897 0000449C 526574726F20444F53-     	db	'Retro DOS v5 Fixed Disk Image Format Utility'
  8897 000044A5 207635204669786564-
  8897 000044AE 204469736B20496D61-
  8897 000044B7 676520466F726D6174-
  8897 000044C0 205574696C697479   
  8898 000044C8 0D0A                    	db	0Dh, 0Ah
  8899                                  	;db	"v1.1.240503 (c) Erdogan TAN 2019-2024"
  8900 000044CA 76322E302E32343035-     	db	"v2.0.240503 (c) Erdogan TAN 2019-2024"
  8900 000044D3 303320286329204572-
  8900 000044DC 646F67616E2054414E-
  8900 000044E5 20323031392D323032-
  8900 000044EE 34                 
  8901 000044EF 0D0A                    	db	0Dh,0Ah
  8902 000044F1 0D0A                    	db	0Dh,0Ah
  8903                                  	;db	'Usage: hdimage <image file name> '
  8904 000044F3 55736167653A207264-     	db	'Usage: rd5hdimg <image file name> '
  8904 000044FC 356864696D67203C69-
  8904 00004505 6D6167652066696C65-
  8904 0000450E 206E616D653E20     
  8905 00004515 00                      	db	0
  8906                                  
  8907                                  msg_inv_file_name: 
  8908 00004516 0D0A                    	db	0Dh, 0Ah
  8909 00004518 496E76616C69642066-     	db	"Invalid file name !", 0Dh, 0Ah
  8909 00004521 696C65206E616D6520-
  8909 0000452A 210D0A             
  8910 0000452D 2846696C65206E616D-     	db	"(File name must fit to 8.3 DOS format) !"
  8910 00004536 65206D757374206669-
  8910 0000453F 7420746F20382E3320-
  8910 00004548 444F5320666F726D61-
  8910 00004551 74292021           
  8911 00004555 0D0A00                  	db	0Dh, 0Ah, 0
  8912                                  
  8913                                  msg_inv_image_file:
  8914 00004558 0D0A                    	db	0Dh, 0Ah
  8915 0000455A 496E76616C69642066-     	db	"Invalid fixed disk image file !", 0Dh, 0Ah
  8915 00004563 69786564206469736B-
  8915 0000456C 20696D616765206669-
  8915 00004575 6C6520210D0A       
  8916 0000457B 2846696C652073697A-     	db	"(File size or masterboot sector is not compatible) !"
  8916 00004584 65206F72206D617374-
  8916 0000458D 6572626F6F74207365-
  8916 00004596 63746F72206973206E-
  8916 0000459F 6F7420636F6D706174-
  8916 000045A8 69626C65292021     
  8917 000045AF 0D0A00                  	db	0Dh, 0Ah, 0
  8918                                  
  8919                                  msg_min_8mb_disk:
  8920 000045B2 0D0A                    	db	0Dh, 0Ah
  8921 000045B4 4D696E696D756D2038-     	db	"Minimum 8 MB disk size is needed for a proper hard disk image !"
  8921 000045BD 204D42206469736B20-
  8921 000045C6 73697A65206973206E-
  8921 000045CF 656564656420666F72-
  8921 000045D8 20612070726F706572-
  8921 000045E1 206861726420646973-
  8921 000045EA 6B20696D6167652021 
  8922 000045F3 0D0A                    	db	0Dh, 0Ah
  8923 000045F5 28507265737320616E-     	db	"(Press any key to continue..)"
  8923 000045FE 79206B657920746F20-
  8923 00004607 636F6E74696E75652E-
  8923 00004610 2E29               
  8924 00004612 0D0A00                  	db	0Dh, 0Ah, 0
  8925                                  
  8926                                  msg_any_key_esc_exit:
  8927 00004615 0D0A                    	db	0Dh, 0Ah
  8928 00004617 507265737320455343-     	db	"Press ESC to exit or press another key to continue..."
  8928 00004620 20746F206578697420-
  8928 00004629 6F7220707265737320-
  8928 00004632 616E6F74686572206B-
  8928 0000463B 657920746F20636F6E-
  8928 00004644 74696E75652E2E2E   
  8929 0000464C 00                      	db	0
  8930                                  
  8931                                  msg_create_partition_h:
  8932 0000464D 0D0A                    	db	0Dh, 0Ah
  8933 0000464F 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  8933 00004658 2D2D2D2D2D2D2D2D2D-
  8933 00004661 2D2D2D2D2D2D2D2D2D-
  8933 0000466A 2D2D2D2D2D2D2D2D2D-
  8933 00004673 2D2D2D2D2D2D2D2D2D-
  8933 0000467C 2D2D2D2D2D2D2D2D2D-
  8933 00004685 2D2D2D2D2D2D2D2D2D-
  8933 0000468E 2D2D2D2D2D2D2D2D2D-
  8933 00004697 2D2D2D2D2D2D2D2D   
  8934 0000469F 202020202020202020-     	db	"                               Create Partition                                 "
  8934 000046A8 202020202020202020-
  8934 000046B1 202020202020202020-
  8934 000046BA 202020204372656174-
  8934 000046C3 652050617274697469-
  8934 000046CC 6F6E20202020202020-
  8934 000046D5 202020202020202020-
  8934 000046DE 202020202020202020-
  8934 000046E7 2020202020202020   
  8935 000046EF 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  8935 000046F8 2D2D2D2D2D2D2D2D2D-
  8935 00004701 2D2D2D2D2D2D2D2D2D-
  8935 0000470A 2D2D2D2D2D2D2D2D2D-
  8935 00004713 2D2D2D2D2D2D2D2D2D-
  8935 0000471C 2D2D2D2D2D2D2D2D2D-
  8935 00004725 2D2D2D2D2D2D2D2D2D-
  8935 0000472E 2D2D2D2D2D2D2D2D2D-
  8935 00004737 2D2D2D2D2D2D2D2D   
  8936 0000473F 0D0A00                  	db	0Dh, 0Ah, 0
  8937                                  msg_create_partition_m:
  8938 00004742 53656C65637420616E-     	db	"Select an option: "
  8938 0000474B 206F7074696F6E3A20 
  8939 00004754 0D0A                    	db	0Dh, 0Ah
  8940 00004756 0D0A                    	db	0Dh, 0Ah
  8941 00004758 202031292043726561-     	db	"  1) Create DOS partition ", 0Dh, 0Ah
  8941 00004761 746520444F53207061-
  8941 0000476A 72746974696F6E200D-
  8941 00004773 0A                 
  8942 00004774 202032292043726561-     	db	"  2) Create SINGLIX FS partition ", 0Dh, 0Ah
  8942 0000477D 74652053494E474C49-
  8942 00004786 582046532070617274-
  8942 0000478F 6974696F6E200D0A   
  8943 00004797 202033292043726561-     	db	"  3) Create RETRO UNIX partition ", 0Dh, 0Ah
  8943 000047A0 746520524554524F20-
  8943 000047A9 554E49582070617274-
  8943 000047B2 6974696F6E200D0A   
  8944 000047BA 202034292043726561-     	db	"  4) Create another type of partition ", 0Dh, 0Ah
  8944 000047C3 746520616E6F746865-
  8944 000047CC 722074797065206F66-
  8944 000047D5 20706172746974696F-
  8944 000047DE 6E200D0A           
  8945 000047E2 0D0A                    	db	0Dh, 0Ah
  8946 000047E4 507265737320455343-     	db	"Press ESC or 0 to cancel .. "
  8946 000047ED 206F72203020746F20-
  8946 000047F6 63616E63656C202E2E-
  8946 000047FF 20                 
  8947 00004800 0D0A00                   	db 	0Dh, 0Ah, 0
  8948                                  
  8949                                  msg_create_primary_partition_h:
  8950 00004803 0D0A                    	db	0Dh, 0Ah
  8951 00004805 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  8951 0000480E 2D2D2D2D2D2D2D2D2D-
  8951 00004817 2D2D2D2D2D2D2D2D2D-
  8951 00004820 2D2D2D2D2D2D2D2D2D-
  8951 00004829 2D2D2D2D2D2D2D2D2D-
  8951 00004832 2D2D2D2D2D2D2D2D2D-
  8951 0000483B 2D2D2D2D2D2D2D2D2D-
  8951 00004844 2D2D2D2D2D2D2D2D2D-
  8951 0000484D 2D2D2D2D2D2D2D2D   
  8952 00004855 202020202020202020-     	db	"                          Create Primary DOS Partition                          "
  8952 0000485E 202020202020202020-
  8952 00004867 202020202020202043-
  8952 00004870 726561746520507269-
  8952 00004879 6D61727920444F5320-
  8952 00004882 506172746974696F6E-
  8952 0000488B 202020202020202020-
  8952 00004894 202020202020202020-
  8952 0000489D 2020202020202020   
  8953 000048A5 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  8953 000048AE 2D2D2D2D2D2D2D2D2D-
  8953 000048B7 2D2D2D2D2D2D2D2D2D-
  8953 000048C0 2D2D2D2D2D2D2D2D2D-
  8953 000048C9 2D2D2D2D2D2D2D2D2D-
  8953 000048D2 2D2D2D2D2D2D2D2D2D-
  8953 000048DB 2D2D2D2D2D2D2D2D2D-
  8953 000048E4 2D2D2D2D2D2D2D2D2D-
  8953 000048ED 2D2D2D2D2D2D2D2D   
  8954 000048F5 0D0A00                  	db	0Dh, 0Ah, 0
  8955                                  
  8956                                  msg_create_dos_partition_h:
  8957 000048F8 0D0A                    	db	0Dh, 0Ah
  8958 000048FA 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  8958 00004903 2D2D2D2D2D2D2D2D2D-
  8958 0000490C 2D2D2D2D2D2D2D2D2D-
  8958 00004915 2D2D2D2D2D2D2D2D2D-
  8958 0000491E 2D2D2D2D2D2D2D2D2D-
  8958 00004927 2D2D2D2D2D2D2D2D2D-
  8958 00004930 2D2D2D2D2D2D2D2D2D-
  8958 00004939 2D2D2D2D2D2D2D2D2D-
  8958 00004942 2D2D2D2D2D2D2D2D   
  8959 0000494A 202020202020202020-     	db	"                   Create DOS Partition or Logical DOS Drive                    "
  8959 00004953 202020202020202020-
  8959 0000495C 204372656174652044-
  8959 00004965 4F5320506172746974-
  8959 0000496E 696F6E206F72204C6F-
  8959 00004977 676963616C20444F53-
  8959 00004980 204472697665202020-
  8959 00004989 202020202020202020-
  8959 00004992 2020202020202020   
  8960 0000499A 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  8960 000049A3 2D2D2D2D2D2D2D2D2D-
  8960 000049AC 2D2D2D2D2D2D2D2D2D-
  8960 000049B5 2D2D2D2D2D2D2D2D2D-
  8960 000049BE 2D2D2D2D2D2D2D2D2D-
  8960 000049C7 2D2D2D2D2D2D2D2D2D-
  8960 000049D0 2D2D2D2D2D2D2D2D2D-
  8960 000049D9 2D2D2D2D2D2D2D2D2D-
  8960 000049E2 2D2D2D2D2D2D2D2D   
  8961 000049EA 0D0A00                  	db	0Dh, 0Ah, 0
  8962                                  
  8963                                  msg_create_ext_partition_h:
  8964 000049ED 0D0A                    	db	0Dh, 0Ah
  8965 000049EF 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  8965 000049F8 2D2D2D2D2D2D2D2D2D-
  8965 00004A01 2D2D2D2D2D2D2D2D2D-
  8965 00004A0A 2D2D2D2D2D2D2D2D2D-
  8965 00004A13 2D2D2D2D2D2D2D2D2D-
  8965 00004A1C 2D2D2D2D2D2D2D2D2D-
  8965 00004A25 2D2D2D2D2D2D2D2D2D-
  8965 00004A2E 2D2D2D2D2D2D2D2D2D-
  8965 00004A37 2D2D2D2D2D2D2D2D   
  8966 00004A3F 202020202020202020-     	db	"                         Create Extended DOS Partition                          "
  8966 00004A48 202020202020202020-
  8966 00004A51 202020202020204372-
  8966 00004A5A 656174652045787465-
  8966 00004A63 6E64656420444F5320-
  8966 00004A6C 506172746974696F6E-
  8966 00004A75 202020202020202020-
  8966 00004A7E 202020202020202020-
  8966 00004A87 2020202020202020   
  8967 00004A8F 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  8967 00004A98 2D2D2D2D2D2D2D2D2D-
  8967 00004AA1 2D2D2D2D2D2D2D2D2D-
  8967 00004AAA 2D2D2D2D2D2D2D2D2D-
  8967 00004AB3 2D2D2D2D2D2D2D2D2D-
  8967 00004ABC 2D2D2D2D2D2D2D2D2D-
  8967 00004AC5 2D2D2D2D2D2D2D2D2D-
  8967 00004ACE 2D2D2D2D2D2D2D2D2D-
  8967 00004AD7 2D2D2D2D2D2D2D2D   
  8968 00004ADF 0D0A00                  	db	0Dh, 0Ah, 0
  8969                                  
  8970                                  msg_create_logical_drive_h:
  8971 00004AE2 0D0A                    	db	0Dh, 0Ah
  8972 00004AE4 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  8972 00004AED 2D2D2D2D2D2D2D2D2D-
  8972 00004AF6 2D2D2D2D2D2D2D2D2D-
  8972 00004AFF 2D2D2D2D2D2D2D2D2D-
  8972 00004B08 2D2D2D2D2D2D2D2D2D-
  8972 00004B11 2D2D2D2D2D2D2D2D2D-
  8972 00004B1A 2D2D2D2D2D2D2D2D2D-
  8972 00004B23 2D2D2D2D2D2D2D2D2D-
  8972 00004B2C 2D2D2D2D2D2D2D2D   
  8973 00004B34 202020202020202020-     	db	"                            Create Logical DOS Drive                            "
  8973 00004B3D 202020202020202020-
  8973 00004B46 202020202020202020-
  8973 00004B4F 20437265617465204C-
  8973 00004B58 6F676963616C20444F-
  8973 00004B61 532044726976652020-
  8973 00004B6A 202020202020202020-
  8973 00004B73 202020202020202020-
  8973 00004B7C 2020202020202020   
  8974 00004B84 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  8974 00004B8D 2D2D2D2D2D2D2D2D2D-
  8974 00004B96 2D2D2D2D2D2D2D2D2D-
  8974 00004B9F 2D2D2D2D2D2D2D2D2D-
  8974 00004BA8 2D2D2D2D2D2D2D2D2D-
  8974 00004BB1 2D2D2D2D2D2D2D2D2D-
  8974 00004BBA 2D2D2D2D2D2D2D2D2D-
  8974 00004BC3 2D2D2D2D2D2D2D2D2D-
  8974 00004BCC 2D2D2D2D2D2D2D2D   
  8975 00004BD4 0D0A00                  	db	0Dh, 0Ah, 0
  8976                                  
  8977                                  msg_create_nondos_partition_h:
  8978 00004BD7 0D0A                    	db	0Dh, 0Ah
  8979 00004BD9 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  8979 00004BE2 2D2D2D2D2D2D2D2D2D-
  8979 00004BEB 2D2D2D2D2D2D2D2D2D-
  8979 00004BF4 2D2D2D2D2D2D2D2D2D-
  8979 00004BFD 2D2D2D2D2D2D2D2D2D-
  8979 00004C06 2D2D2D2D2D2D2D2D2D-
  8979 00004C0F 2D2D2D2D2D2D2D2D2D-
  8979 00004C18 2D2D2D2D2D2D2D2D2D-
  8979 00004C21 2D2D2D2D2D2D2D2D   
  8980 00004C29 202020202020202020-     	db	"                            Create NON-DOS Partition                            "
  8980 00004C32 202020202020202020-
  8980 00004C3B 202020202020202020-
  8980 00004C44 20437265617465204E-
  8980 00004C4D 4F4E2D444F53205061-
  8980 00004C56 72746974696F6E2020-
  8980 00004C5F 202020202020202020-
  8980 00004C68 202020202020202020-
  8980 00004C71 2020202020202020   
  8981 00004C79 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  8981 00004C82 2D2D2D2D2D2D2D2D2D-
  8981 00004C8B 2D2D2D2D2D2D2D2D2D-
  8981 00004C94 2D2D2D2D2D2D2D2D2D-
  8981 00004C9D 2D2D2D2D2D2D2D2D2D-
  8981 00004CA6 2D2D2D2D2D2D2D2D2D-
  8981 00004CAF 2D2D2D2D2D2D2D2D2D-
  8981 00004CB8 2D2D2D2D2D2D2D2D2D-
  8981 00004CC1 2D2D2D2D2D2D2D2D   
  8982 00004CC9 0D0A00                  	db	0Dh, 0Ah, 0
  8983                                  
  8984                                  msg_create_dos_partition_m:
  8985 00004CCC 53656C65637420616E-     	db	"Select an option: "
  8985 00004CD5 206F7074696F6E3A20 
  8986 00004CDE 0D0A                    	db	0Dh, 0Ah
  8987 00004CE0 0D0A                    	db	0Dh, 0Ah
  8988 00004CE2 202031292043726561-     	db	"  1) Create Primary DOS partition ", 0Dh, 0Ah
  8988 00004CEB 7465205072696D6172-
  8988 00004CF4 7920444F5320706172-
  8988 00004CFD 746974696F6E200D0A 
  8989 00004D06 202032292043726561-     	db	"  2) Create Extended DOS partition ", 0Dh, 0Ah			
  8989 00004D0F 746520457874656E64-
  8989 00004D18 656420444F53207061-
  8989 00004D21 72746974696F6E200D-
  8989 00004D2A 0A                 
  8990 00004D2B 202033292043726561-     	db	"  3) Create Logical DOS drive(s) in Extended DOS partition ", 0Dh, 0Ah
  8990 00004D34 7465204C6F67696361-
  8990 00004D3D 6C20444F5320647269-
  8990 00004D46 766528732920696E20-
  8990 00004D4F 457874656E64656420-
  8990 00004D58 444F53207061727469-
  8990 00004D61 74696F6E200D0A     
  8991 00004D68 0D0A                    	db	0Dh, 0Ah	
  8992 00004D6A 507265737320455343-     	db	"Press ESC or 0 to cancel .. "
  8992 00004D73 206F72203020746F20-
  8992 00004D7C 63616E63656C202E2E-
  8992 00004D85 20                 
  8993 00004D86 0D0A00                   	db 	0Dh, 0Ah, 0
  8994                                  
  8995                                  msg_create_dos_partition_s:
  8996 00004D89 53656C65637420616E-     	db	"Select an option to set partition size: "
  8996 00004D92 206F7074696F6E2074-
  8996 00004D9B 6F2073657420706172-
  8996 00004DA4 746974696F6E207369-
  8996 00004DAD 7A653A20           
  8997 00004DB1 0D0A                    	db	0Dh, 0Ah
  8998 00004DB3 0D0A                    	db	0Dh, 0Ah
  8999 00004DB5 202043292043796C69-     	db	"  C) Cylinder count", 0Dh, 0Ah
  8999 00004DBE 6E64657220636F756E-
  8999 00004DC7 740D0A             
  9000 00004DCA 2020252920566F6C75-     	db	"  %) Volume percentage (##%)", 0Dh, 0Ah
  9000 00004DD3 6D652070657263656E-
  9000 00004DDC 746167652028232325-
  9000 00004DE5 290D0A             
  9001 00004DE8 202053292053656374-     	db	"  S) Sectors (number of 512 bytes)", 0Dh, 0Ah
  9001 00004DF1 6F727320286E756D62-
  9001 00004DFA 6572206F6620353132-
  9001 00004E03 206279746573290D0A 
  9002 00004E0C 20204B29204B696C6F-     	db	"  K) Kilo bytes (KB, 2*K sectors)", 0Dh, 0Ah
  9002 00004E15 20627974657320284B-
  9002 00004E1E 422C20322A4B207365-
  9002 00004E27 63746F7273290D0A   
  9003 00004E2F 20204D29204D656761-     	db	"  M) Mega bytes (MB, 2*1024*M sectors)", 0Dh, 0Ah
  9003 00004E38 20627974657320284D-
  9003 00004E41 422C20322A31303234-
  9003 00004E4A 2A4D20736563746F72-
  9003 00004E53 73290D0A           
  9004 00004E57 202047292047696761-     	db	"  G) Giga bytes (GB, 2*1024*1024*G sectors)", 0Dh, 0Ah
  9004 00004E60 206279746573202847-
  9004 00004E69 422C20322A31303234-
  9004 00004E72 2A313032342A472073-
  9004 00004E7B 6563746F7273290D0A 
  9005 00004E84 0D0A                    	db	0Dh, 0Ah	
  9006 00004E86 507265737320535041-     	db	"Press SPACE to use whole disk or press ENTER to set sector count .. "
  9006 00004E8F 434520746F20757365-
  9006 00004E98 2077686F6C65206469-
  9006 00004EA1 736B206F7220707265-
  9006 00004EAA 737320454E54455220-
  9006 00004EB3 746F20736574207365-
  9006 00004EBC 63746F7220636F756E-
  9006 00004EC5 74202E2E20         
  9007                                  msg_press_esc_to_cancel:
  9008 00004ECA 0D0A                     	db	0Dh, 0Ah
  9009 00004ECC 285072657373204553-     	db	"(Press ESC to CANCEL) "
  9009 00004ED5 4320746F2043414E43-
  9009 00004EDE 454C2920           
  9010 00004EE2 0D0A00                  	db 	0Dh, 0Ah, 0
  9011                                  
  9012                                  msg_use_whole_disk:
  9013 00004EE5 446F20796F75207761-     	db	"Do you want to use WHOLE disk !? (Y/N)", 0
  9013 00004EEE 6E7420746F20757365-
  9013 00004EF7 2057484F4C45206469-
  9013 00004F00 736B20213F2028592F-
  9013 00004F09 4E2900             
  9014                                  
  9015                                  msg_use_all_space:
  9016 00004F0C 446F20796F75207761-     	db	"Do you want to use all of available space !? (Y/N)", 0
  9016 00004F15 6E7420746F20757365-
  9016 00004F1E 20616C6C206F662061-
  9016 00004F27 7661696C61626C6520-
  9016 00004F30 737061636520213F20-
  9016 00004F39 28592F4E2900       
  9017                                  
  9018                                  msg_use_entire_ep_space:
  9019 00004F3F 446F20796F75207761-     	db	"Do you want to use entire extended partition space !? (Y/N)", 0
  9019 00004F48 6E7420746F20757365-
  9019 00004F51 20656E746972652065-
  9019 00004F5A 7874656E6465642070-
  9019 00004F63 6172746974696F6E20-
  9019 00004F6C 737061636520213F20-
  9019 00004F75 28592F4E2900       
  9020                                  
  9021                                  msg_partition_size:
  9022 00004F7B 0D0A                    	db	0Dh, 0Ah
  9023 00004F7D 0D0A                    	db	0Dh, 0Ah
  9024 00004F7F 506172746974696F6E-     	db	"Partition size ("
  9024 00004F88 2073697A652028     
  9025                                  msg_partition_size_x:
  9026 00004F8F 3F29203A20              	db	"?) : "
  9027 00004F94 00                      	db	0
  9028                                  
  9029                                  msg_partition_type:
  9030 00004F95 0D0A                    	db	0Dh, 0Ah
  9031 00004F97 0D0A                    	db	0Dh, 0Ah
  9032 00004F99 506172746974696F6E-     	db	"Partition type : "
  9032 00004FA2 2074797065203A20   
  9033 00004FAA 00                      	db	0
  9034                                  
  9035                                  msg_ptype_num:
  9036 00004FAB 3030680D0A00            	db	"00h", 0Dh, 0Ah, 0
  9037                                  
  9038                                  msg_partition_type_error:
  9039 00004FB1 506172746974696F6E-     	db	"Partition size is not proper for selected partition type !"
  9039 00004FBA 2073697A6520697320-
  9039 00004FC3 6E6F742070726F7065-
  9039 00004FCC 7220666F722073656C-
  9039 00004FD5 656374656420706172-
  9039 00004FDE 746974696F6E207479-
  9039 00004FE7 70652021           
  9040 00004FEB 0D0A                    	db	0Dh, 0Ah
  9041                                  msg_any_key_to_retry:
  9042 00004FED 28507265737320616E-     	db	"(Press any key to retry..)"
  9042 00004FF6 79206B657920746F20-
  9042 00004FFF 72657472792E2E29   
  9043 00005007 0D0A00                  	db	0Dh, 0Ah, 0
  9044                                  
  9045                                  msg_partition_size_overs:
  9046 0000500A 0D0A                    	db	0Dh, 0Ah
  9047 0000500C 506172746974696F6E-     	db	"Partition size overs the disk capacity !"
  9047 00005015 2073697A65206F7665-
  9047 0000501E 727320746865206469-
  9047 00005027 736B20636170616369-
  9047 00005030 74792021           
  9048 00005034 0D0A                    	db	0Dh, 0Ah
  9049 00005036 28507265737320454E-     	db	"(Press ENTER to use WHOLE disk or press ESC key to retry..)"
  9049 0000503F 54455220746F207573-
  9049 00005048 652057484F4C452064-
  9049 00005051 69736B206F72207072-
  9049 0000505A 65737320455343206B-
  9049 00005063 657920746F20726574-
  9049 0000506C 72792E2E29         
  9050 00005071 0D0A00                  	db	0Dh, 0Ah, 0
  9051                                  
  9052                                  msg_ext_partition_error:
  9053 00005074 457874656E64656420-     	db	"Extended partition must be created after primary partition !"
  9053 0000507D 706172746974696F6E-
  9053 00005086 206D75737420626520-
  9053 0000508F 637265617465642061-
  9053 00005098 66746572207072696D-
  9053 000050A1 617279207061727469-
  9053 000050AA 74696F6E2021       
  9054 000050B0 0D0A00                  	db	0Dh, 0Ah,0
  9055                                  
  9056                                  msg_logical_drive_error:
  9057 000050B3 5072696D6172792061-     	db	"Primary and extended partitions must be created before logical drive !"
  9057 000050BC 6E6420657874656E64-
  9057 000050C5 656420706172746974-
  9057 000050CE 696F6E73206D757374-
  9057 000050D7 206265206372656174-
  9057 000050E0 6564206265666F7265-
  9057 000050E9 206C6F676963616C20-
  9057 000050F2 64726976652021     
  9058 000050F9 0D0A00                  	db	0Dh, 0Ah,0
  9059                                  
  9060                                  msg_cylinder_boundary_set:
  9061 000050FC 0D0A                    	db	0Dh, 0Ah
  9062 000050FE 446F20796F75207761-     	db	"Do you want to adjust partition size to cylinder boundary ? (Y/N)"
  9062 00005107 6E7420746F2061646A-
  9062 00005110 757374207061727469-
  9062 00005119 74696F6E2073697A65-
  9062 00005122 20746F2063796C696E-
  9062 0000512B 64657220626F756E64-
  9062 00005134 617279203F2028592F-
  9062 0000513D 4E29               
  9063 0000513F 00                      	db	0
  9064                                  
  9065                                  msg_selected_partition:
  9066 00005140 202020202020202020-     	db	"                                 PARTITION 0                                    "
  9066 00005149 202020202020202020-
  9066 00005152 202020202020202020-
  9066 0000515B 202020202020504152-
  9066 00005164 544954494F4E203020-
  9066 0000516D 202020202020202020-
  9066 00005176 202020202020202020-
  9066 0000517F 202020202020202020-
  9066 00005188 2020202020202020   
  9067 00005190 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
  9067 00005199 3D3D3D3D3D3D3D3D3D-
  9067 000051A2 3D3D3D3D3D3D3D3D3D-
  9067 000051AB 3D3D3D3D3D3D3D3D3D-
  9067 000051B4 3D3D3D3D3D3D3D3D3D-
  9067 000051BD 3D3D3D3D3D3D3D3D3D-
  9067 000051C6 3D3D3D3D3D3D3D3D3D-
  9067 000051CF 3D3D3D3D3D3D3D3D3D-
  9067 000051D8 3D3D3D3D3D3D3D3D   
  9068 000051E0 202020202020202053-     	db	"        S  BH  BS  BC  FS  EH  ES  EC    START SEC   SECTORS   FILE SYSTEM      "
  9068 000051E9 202042482020425320-
  9068 000051F2 204243202046532020-
  9068 000051FB 454820204553202045-
  9068 00005204 432020202053544152-
  9068 0000520D 542053454320202053-
  9068 00005216 4543544F5253202020-
  9068 0000521F 46494C452053595354-
  9068 00005228 454D202020202020   
  9069 00005230 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9069 00005239 2D2D2D2D2D2D2D2D2D-
  9069 00005242 2D2D2D2D2D2D2D2D2D-
  9069 0000524B 2D2D2D2D2D2D2D2D2D-
  9069 00005254 2D2D2D2D2D2D2D2D2D-
  9069 0000525D 2D2D2D2D2D2D2D2D2D-
  9069 00005266 2D2D2D2D2D2D2D2D2D-
  9069 0000526F 2D2D2D2D2D2D2D2D2D-
  9069 00005278 2D2D2D2D2D2D2D2D   
  9070 00005280 202020202020202020-     pt_row:	db	"                                                                                "
  9070 00005289 202020202020202020-
  9070 00005292 202020202020202020-
  9070 0000529B 202020202020202020-
  9070 000052A4 202020202020202020-
  9070 000052AD 202020202020202020-
  9070 000052B6 202020202020202020-
  9070 000052BF 202020202020202020-
  9070 000052C8 2020202020202020   
  9071 000052D0 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
  9071 000052D9 3D3D3D3D3D3D3D3D3D-
  9071 000052E2 3D3D3D3D3D3D3D3D3D-
  9071 000052EB 3D3D3D3D3D3D3D3D3D-
  9071 000052F4 3D3D3D3D3D3D3D3D3D-
  9071 000052FD 3D3D3D3D3D3D3D3D3D-
  9071 00005306 3D3D3D3D3D3D3D3D3D-
  9071 0000530F 3D3D3D3D3D3D3D3D3D-
  9071 00005318 3D3D3D3D3D3D3D3D   
  9072 00005320 00                      	db	0
  9073                                  msg_boot_indicator:
  9074 00005321 0D0A                    	db	0Dh, 0Ah
  9075 00005323 20202020426F6F7420-     	db	"    Boot Indicator : ", 0 ; "YES", "NO"
  9075 0000532C 496E64696361746F72-
  9075 00005335 203A2000           
  9076                                  msg_starting_head:
  9077 00005339 0D0A                    	db	0Dh, 0Ah
  9078 0000533B 202020202053746172-     	db 	"     Starting Head : ", 0
  9078 00005344 74696E672048656164-
  9078 0000534D 203A2000           
  9079                                  msg_starting_sector:
  9080 00005351 0D0A                    	db	0Dh, 0Ah
  9081 00005353 202020537461727469-     	db	"   Starting Sector : ", 0
  9081 0000535C 6E6720536563746F72-
  9081 00005365 203A2000           
  9082                                  msg_starting_cylinder:
  9083 00005369 0D0A                    	db	0Dh, 0Ah
  9084 0000536B 205374617274696E67-     	db	" Starting Cylinder : ", 0
  9084 00005374 2043796C696E646572-
  9084 0000537D 203A2000           
  9085                                  msg_system_id:
  9086 00005381 0D0A                    	db	0Dh, 0Ah
  9087 00005383 202020202020202020-     	db	"         System ID : ", 0
  9087 0000538C 53797374656D204944-
  9087 00005395 203A2000           
  9088                                  msg_ending_head:
  9089 00005399 0D0A                    	db	0Dh, 0Ah
  9090 0000539B 20202020202020456E-     	db 	"       Ending Head : ", 0
  9090 000053A4 64696E672048656164-
  9090 000053AD 203A2000           
  9091                                  msg_ending_sector:
  9092 000053B1 0D0A                    	db	0Dh, 0Ah
  9093 000053B3 2020202020456E6469-     	db	"     Ending Sector : ", 0
  9093 000053BC 6E6720536563746F72-
  9093 000053C5 203A2000           
  9094                                  msg_ending_cylinder:
  9095 000053C9 0D0A                    	db	0Dh, 0Ah
  9096 000053CB 202020456E64696E67-     	db	"   Ending Cylinder : ", 0
  9096 000053D4 2043796C696E646572-
  9096 000053DD 203A2000           
  9097                                  msg_relative_sectors:
  9098 000053E1 0D0A                    	db	0Dh, 0Ah
  9099 000053E3 0D0A                    	db	0Dh, 0Ah
  9100 000053E5 202052656C61746976-     	db	"  Relative Sectors : ", 0
  9100 000053EE 6520536563746F7273-
  9100 000053F7 203A2000           
  9101                                  msg_total_sectors:
  9102 000053FB 0D0A                    	db	0Dh, 0Ah
  9103 000053FD 2020202020546F7461-     	db	"     Total Sectors : ", 0
  9103 00005406 6C20536563746F7273-
  9103 0000540F 203A2000           
  9104                                  
  9105                                  msg_format_stage:
  9106 00005413 0D0A                    	db	0Dh, 0Ah
  9107 00005415 507265737320454E54-     	db	"Press ENTER to FORMAT disk partition "
  9107 0000541E 455220746F20464F52-
  9107 00005427 4D4154206469736B20-
  9107 00005430 706172746974696F6E-
  9107 00005439 20                 
  9108                                  partition_num_chr:
  9109 0000543A 30                      	db	"0"
  9110 0000543B 206F72207072657373-     	db	" or press ESC to EXIT.."
  9110 00005444 2045534320746F2045-
  9110 0000544D 5849542E2E         
  9111 00005452 00                      	db	0
  9112                                  msg_partition_edit:
  9113 00005453 0D0A                    	db	0Dh, 0Ah
  9114 00005455 2E2E206F7220707265-     	db	".. or press SPACE to EDIT partition table."
  9114 0000545E 737320535041434520-
  9114 00005467 746F20454449542070-
  9114 00005470 6172746974696F6E20-
  9114 00005479 7461626C652E       
  9115 0000547F 0D0A00                  	db	0Dh, 0Ah, 0
  9116                                  
  9117                                  msg_edit_or_exit:
  9118 00005482 0D0A                    	db 	0Dh, 0Ah
  9119 00005484 507265737320454E54-     	db	"Press ENTER to continue or press ESC to exit.."
  9119 0000548D 455220746F20636F6E-
  9119 00005496 74696E7565206F7220-
  9119 0000549F 707265737320455343-
  9119 000054A8 20746F20657869742E-
  9119 000054B1 2E                 
  9120 000054B2 00                      	db	0
  9121                                  
  9122                                  msg_overwrite_question1:
  9123 000054B3 0D0A                    	db	0Dh, 0Ah
  9124 000054B5 446F20796F75207761-     	db	'Do you want to overwrite '
  9124 000054BE 6E7420746F206F7665-
  9124 000054C7 72777269746520     
  9125 000054CE 27                      	db	27h
  9126 000054CF 00                      	db	0
  9127                                  
  9128                                  msg_overwrite_question2:
  9129 000054D0 27                      	db	27h
  9130 000054D1 2066696C6520            	db	' file '
  9131 000054D7 00                      	db	0
  9132                                  
  9133                                  msg_format_question:
  9134 000054D8 0D0A                    	db	0Dh, 0Ah
  9135 000054DA 446F20796F75207761-     	db	"Do you want to format partition "
  9135 000054E3 6E7420746F20666F72-
  9135 000054EC 6D6174207061727469-
  9135 000054F5 74696F6E20         
  9136                                  partition_num_txt:
  9137 000054FA 3020                    	db	 "0 "
  9138                                  msg_yes_no:
  9139 000054FC 285965732F4E6F293F-     	db	'(Yes/No)? ', 0
  9139 00005505 2000               
  9140                                  
  9141                                  msg_writing_mbr:
  9142 00005507 57726974696E67206D-     	db	"Writing masterboot sector...", 0
  9142 00005510 6173746572626F6F74-
  9142 00005519 20736563746F722E2E-
  9142 00005522 2E00               
  9143                                  
  9144                                  msg_writing_disk_sectors:
  9145 00005524 57726974696E672064-     	db	"Writing disk sector: ", 0
  9145 0000552D 69736B20736563746F-
  9145 00005536 723A2000           
  9146                                  
  9147                                  Msg_Writing_Boot_Sector:
  9148 0000553A 57726974696E672074-     	db	"Writing trdos boot sector...", 0
  9148 00005543 72646F7320626F6F74-
  9148 0000554C 20736563746F722E2E-
  9148 00005555 2E00               
  9149                                  
  9150                                  Msg_Writing_Root_Dir:
  9151 00005557 57726974696E672072-     	db	"Writing root directory sectors...", 0
  9151 00005560 6F6F74206469726563-
  9151 00005569 746F72792073656374-
  9151 00005572 6F72732E2E2E00     
  9152                                  
  9153                                  Msg_Writing_Data_Sectors:
  9154 00005579 57726974696E672064-     	db	"Writing data sector: ", 0
  9154 00005582 61746120736563746F-
  9154 0000558B 723A2000           
  9155                                  
  9156                                  Sector_Str:
  9157 0000558F 3030303030303000        	db	"0000000", 0
  9158                                  Cursor_Pos:
  9159 00005597 0000                    	dw	0
  9160                                  
  9161                                  Msg_Writing_FAT_Sectors:
  9162 00005599 57726974696E672046-     	db	"Writing FAT sectors...", 0
  9162 000055A2 415420736563746F72-
  9162 000055AB 732E2E2E00         
  9163                                  
  9164                                  StrVolumeName:
  9165                                  	;times 	12 db  0
  9166 000055B0 00<rep 41h>             	times	65 db 0  ; 05/01/2018 (fs1 volume name)
  9167                                  
  9168                                  Msg_Volume_Name:
  9169 000055F1 0D0A                    	db	0Dh, 0Ah
  9170 000055F3 0D0A                    	db	0Dh, 0Ah
  9171 000055F5 566F6C756D65204E61-     	db	"Volume Name: ", 0
  9171 000055FE 6D653A2000         
  9172                                  
  9173                                  Msg_Volume_Serial:
  9174 00005603 566F6C756D65205365-     	db	"Volume Serial No: "
  9174 0000560C 7269616C204E6F3A20 
  9175                                  Vol_Serial1:
  9176 00005615 30303030                	db	"0000"
  9177 00005619 2D                      	db	"-"
  9178                                  Vol_Serial2:
  9179 0000561A 30303030                	db	"0000"
  9180 0000561E 0D0A00                  	db	0Dh, 0Ah, 0
  9181                                  
  9182                                  msg_cluster_count:
  9183 00005621 436C75737465722043-     	db	"Cluster Count: ", 0
  9183 0000562A 6F756E743A2000     
  9184                                  cluster_count_str:
  9185 00005631 30303030303030          	db	"0000000"
  9186 00005638 0D0A00                  	db	0Dh, 0Ah, 0
  9187                                  msg_formatting:
  9188 0000563B 466F726D617474696E-     	db	"Formatting ", 0
  9188 00005644 672000             
  9189                                  format_percent_str:
  9190 00005647 30303025                	db	"000%"
  9191 0000564B 00                      	db	0
  9192                                  
  9193                                  Msg_3dot_OK:
  9194 0000564C 2E2E2E                  	db	"..."
  9195                                  Msg_OK:
  9196 0000564F 204F4B2E                	db	' OK.'
  9197                                  CRLF:
  9198 00005653 0D0A00                  	db	0Dh, 0Ah, 0
  9199                                  
  9200                                  Msg_Error:
  9201 00005656 0D0A                    	db	0Dh, 0Ah
  9202 00005658 4572726F72202120        	db	'Error ! '
  9203 00005660 28                      	db	'('
  9204                                  error_code:
  9205 00005661 3030                    	dw	3030h
  9206 00005663 68                      	db	'h'
  9207 00005664 2920                    	db	') '
  9208 00005666 0D0A                    	db	0Dh, 0Ah
  9209 00005668 00                      	db	0
  9210                                  
  9211                                  msg_disk_sectors:
  9212 00005669 546F74616C20446973-     	db	"Total Disk Sectors : ", 0
  9212 00005672 6B20536563746F7273-
  9212 0000567B 203A2000           
  9213                                  
  9214                                  str_disk_sectors:
  9215 0000567F 00<rep 8h>              	times	8 db 0
  9216                                  
  9217                                  msg_ep_size:
  9218 00005687 457874656E64656420-     	db	"Extended Partition Size in Sectors: ", 0
  9218 00005690 506172746974696F6E-
  9218 00005699 2053697A6520696E20-
  9218 000056A2 536563746F72733A20-
  9218 000056AB 00                 
  9219                                  
  9220                                  msg_file_size:
  9221 000056AC 484420496D61676520-     	db	"HD Image File Size : ", 0
  9221 000056B5 46696C652053697A65-
  9221 000056BE 203A2000           
  9222                                  
  9223                                  str_file_size:
  9224 000056C2 00<rep Bh>              	times	11 db 0
  9225                                  
  9226                                  msg_bytes:
  9227 000056CD 206279746573            	db	" bytes"
  9228 000056D3 0D0A00                  	db	0Dh, 0Ah, 0
  9229                                  
  9230                                  msg_enter_cancel:
  9231 000056D6 0D0A                    	db	0Dh, 0Ah
  9232 000056D8 507265737320454E54-     	db	"Press ENTER to write file or press ESC to cancel."
  9232 000056E1 455220746F20777269-
  9232 000056EA 74652066696C65206F-
  9232 000056F3 722070726573732045-
  9232 000056FC 534320746F2063616E-
  9232 00005705 63656C2E           
  9233 00005709 0D0A00                  	db	0Dh, 0Ah, 0
  9234                                  
  9235                                  msg_press_any_key:
  9236 0000570C 0D0A                    	db	0Dh, 0Ah
  9237 0000570E 50726573732061206B-     	db	"Press a key to continue..." 
  9237 00005717 657920746F20636F6E-
  9237 00005720 74696E75652E2E2E   
  9238 00005728 0D0A00                  	db	0Dh, 0Ah, 0
  9239                                  
  9240 0000572B 90                      align 2
  9241                                  
  9242                                  ; Masterboot sector
  9243                                  
  9244                                  MasterBootBuff:
  9245                                  MasterBootCode: 
  9246 0000572C 00<rep 1BEh>            	times	446 db 0
  9247                                  PartitionTable:
  9248 000058EA 00<rep 40h>             	times	64 db 0
  9249                                  MBIDCode:
  9250 0000592A 0000                    	dw	0
  9251                                  
  9252                                  PTable_Buffer:
  9253 0000592C 00<rep 40h>             	times	64 db 0
  9254                                   
  9255 0000596C 286329204572646F67-     	db	'(c) Erdogan TAN 2019-2024'
  9255 00005975 616E2054414E203230-
  9255 0000597E 31392D32303234     
  9256                                  
  9257                                  img_file_name:
  9258 00005985 00<rep Dh>              	times	13 db 0
  9259                                  
  9260                                  p_table_header:
  9261 00005992 202020202020202020-     	db	"                              ?BR PARTITION TABLE                               "
  9261 0000599B 202020202020202020-
  9261 000059A4 202020202020202020-
  9261 000059AD 2020203F4252205041-
  9261 000059B6 52544954494F4E2054-
  9261 000059BF 41424C452020202020-
  9261 000059C8 202020202020202020-
  9261 000059D1 202020202020202020-
  9261 000059DA 2020202020202020   
  9262 000059E2 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
  9262 000059EB 3D3D3D3D3D3D3D3D3D-
  9262 000059F4 3D3D3D3D3D3D3D3D3D-
  9262 000059FD 3D3D3D3D3D3D3D3D3D-
  9262 00005A06 3D3D3D3D3D3D3D3D3D-
  9262 00005A0F 3D3D3D3D3D3D3D3D3D-
  9262 00005A18 3D3D3D3D3D3D3D3D3D-
  9262 00005A21 3D3D3D3D3D3D3D3D3D-
  9262 00005A2A 3D3D3D3D3D3D3D3D   
  9263 00005A32 202020202020205020-     	db	"       P  S  BH  BS  BC  FS  EH  ES  EC  START SEC  SECTORS  FILE SYSTEM        "
  9263 00005A3B 205320204248202042-
  9263 00005A44 532020424320204653-
  9263 00005A4D 202045482020455320-
  9263 00005A56 204543202053544152-
  9263 00005A5F 542053454320205345-
  9263 00005A68 43544F525320204649-
  9263 00005A71 4C452053595354454D-
  9263 00005A7A 2020202020202020   
  9264 00005A82 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9264 00005A8B 2D2D2D2D2D2D2D2D2D-
  9264 00005A94 2D2D2D2D2D2D2D2D2D-
  9264 00005A9D 2D2D2D2D2D2D2D2D2D-
  9264 00005AA6 2D2D2D2D2D2D2D2D2D-
  9264 00005AAF 2D2D2D2D2D2D2D2D2D-
  9264 00005AB8 2D2D2D2D2D2D2D2D2D-
  9264 00005AC1 2D2D2D2D2D2D2D2D2D-
  9264 00005ACA 2D2D2D2D2D2D2D2D   
  9265 00005AD2 00                      	db	0
  9266                                  p_table_footer:
  9267 00005AD3 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
  9267 00005ADC 3D3D3D3D3D3D3D3D3D-
  9267 00005AE5 3D3D3D3D3D3D3D3D3D-
  9267 00005AEE 3D3D3D3D3D3D3D3D3D-
  9267 00005AF7 3D3D3D3D3D3D3D3D3D-
  9267 00005B00 3D3D3D3D3D3D3D3D3D-
  9267 00005B09 3D3D3D3D3D3D3D3D3D-
  9267 00005B12 3D3D3D3D3D3D3D3D3D-
  9267 00005B1B 3D3D3D3D3D3D3D3D   
  9268 00005B23 0D0A00                  	db	0Dh,0Ah,0
  9269                                  
  9270                                  mbr_editing_options:
  9271 00005B26 0D0A0D0A                	db 0Dh, 0Ah, 0Dh, 0Ah 
  9272 00005B2A 4D4252205061727469-     	db "MBR Partition Table Editing Options:"
  9272 00005B33 74696F6E205461626C-
  9272 00005B3C 652045646974696E67-
  9272 00005B45 204F7074696F6E733A 
  9273 00005B4E 0D0A0D0A                	db 0Dh, 0Ah, 0Dh, 0Ah
  9274 00005B52 20202020202020312E-     	db "       1. Create Partition", 0Dh, 0Ah
  9274 00005B5B 204372656174652050-
  9274 00005B64 6172746974696F6E0D-
  9274 00005B6D 0A                 
  9275 00005B6E 20202020202020322E-     	db "       2. Set Active Partition", 0Dh, 0Ah
  9275 00005B77 205365742041637469-
  9275 00005B80 766520506172746974-
  9275 00005B89 696F6E0D0A         
  9276 00005B8E 20202020202020332E-     	db "       3. Delete Partition", 0Dh, 0Ah  
  9276 00005B97 2044656C6574652050-
  9276 00005BA0 6172746974696F6E0D-
  9276 00005BA9 0A                 
  9277 00005BAA 20202020202020342E-     	db "       4. Write Current Partition Table", 0Dh, 0Ah, 0
  9277 00005BB3 205772697465204375-
  9277 00005BBC 7272656E7420506172-
  9277 00005BC5 746974696F6E205461-
  9277 00005BCE 626C650D0A00       
  9278                                  
  9279                                  enter_option_number_msg:
  9280 00005BD4 0D0A                    	db 0Dh, 0Ah
  9281 00005BD6 456E74657220746865-     	db "Enter the option number or press ESC to exit ...", 0Dh, 0Ah
  9281 00005BDF 206F7074696F6E206E-
  9281 00005BE8 756D626572206F7220-
  9281 00005BF1 707265737320455343-
  9281 00005BFA 20746F206578697420-
  9281 00005C03 2E2E2E0D0A         
  9282                                  	;db 0Dh, 0Ah, 0
  9283 00005C08 00                      	db 0 
  9284                                  
  9285                                  msg_zero_partition_size:  ; 19/02/2019
  9286 00005C09 0D0A                    	db	0Dh, 0Ah
  9287 00005C0B 506172746974696F6E-     	db	"Partition size input must not be ZERO !", 0Dh, 0Ah
  9287 00005C14 2073697A6520696E70-
  9287 00005C1D 7574206D757374206E-
  9287 00005C26 6F74206265205A4552-
  9287 00005C2F 4F20210D0A         
  9288 00005C34 285072657373204553-     	db	"(Press ESC to exit or press another key to retry..)", 0Dh, 0Ah
  9288 00005C3D 4320746F2065786974-
  9288 00005C46 206F72207072657373-
  9288 00005C4F 20616E6F7468657220-
  9288 00005C58 6B657920746F207265-
  9288 00005C61 7472792E2E290D0A   
  9289 00005C69 00                      	db	0
  9290                                  
  9291                                  msg_empty_pt:
  9292 00005C6A 0D0A                    	db	0Dh, 0Ah
  9293 00005C6C 456D70747920706172-     	db	"Empty partition table !", 0Dh, 0Ah
  9293 00005C75 746974696F6E207461-
  9293 00005C7E 626C6520210D0A     
  9294 00005C85 28412076616C696420-     	db	"(A valid partition must be created at first..)", 0Dh, 0Ah
  9294 00005C8E 706172746974696F6E-
  9294 00005C97 206D75737420626520-
  9294 00005CA0 637265617465642061-
  9294 00005CA9 742066697273742E2E-
  9294 00005CB2 290D0A             
  9295 00005CB5 00                      	db	0
  9296                                  
  9297                                  msg_full_pt:
  9298 00005CB6 0D0A                    	db	0Dh, 0Ah
  9299 00005CB8 546865726520697320-     	db	"There is not a free partition table entry ", 0
  9299 00005CC1 6E6F74206120667265-
  9299 00005CCA 652070617274697469-
  9299 00005CD3 6F6E207461626C6520-
  9299 00005CDC 656E7472792000     
  9300                                  msg_to_create_new_p: 
  9301 00005CE3 746F20637265617465-     	db	"to create a new partition !", 0Dh, 0Ah
  9301 00005CEC 2061206E6577207061-
  9301 00005CF5 72746974696F6E2021-
  9301 00005CFE 0D0A               
  9302 00005D00 00                      	db	0
  9303                                  msg_no_free_space:
  9304 00005D01 0D0A                    	db	0Dh, 0Ah
  9305 00005D03 546865726520697320-     	db	"There is not (enough) free space ", 0
  9305 00005D0C 6E6F742028656E6F75-
  9305 00005D15 676829206672656520-
  9305 00005D1E 73706163652000     
  9306                                  
  9307                                  msg_enter_pn_to_del:
  9308 00005D25 0D0A                    	db	0Dh, 0Ah
  9309 00005D27 456E74657220706172-     	db	"Enter partition number to delete: "
  9309 00005D30 746974696F6E206E75-
  9309 00005D39 6D62657220746F2064-
  9309 00005D42 656C6574653A20     
  9310                                  chr_del_pnum1:
  9311 00005D49 00                      	db	0
  9312 00005D4A 0D0A00                  	db	0Dh, 0Ah, 0
  9313                                  
  9314                                  msg_delete_partition_q:
  9315 00005D4D 0D0A                    	db 	0Dh, 0Ah
  9316 00005D4F 5741524E494E472120-     	db 	"WARNING! All of data in the selected partition will be lost", 0Dh, 0Ah
  9316 00005D58 416C6C206F66206461-
  9316 00005D61 746120696E20746865-
  9316 00005D6A 2073656C6563746564-
  9316 00005D73 20706172746974696F-
  9316 00005D7C 6E2077696C6C206265-
  9316 00005D85 206C6F73740D0A     
  9317 00005D8C 202020202020202020-     	db	"         after you write changed partition table to disk !!", 0Dh, 0Ah
  9317 00005D95 616674657220796F75-
  9317 00005D9E 207772697465206368-
  9317 00005DA7 616E67656420706172-
  9317 00005DB0 746974696F6E207461-
  9317 00005DB9 626C6520746F206469-
  9317 00005DC2 736B2021210D0A     
  9318 00005DC9 0D0A                    	db	0Dh, 0Ah
  9319 00005DCB 446F20796F75207761-     	db	"Do you want to delete PARTITION "
  9319 00005DD4 6E7420746F2064656C-
  9319 00005DDD 657465205041525449-
  9319 00005DE6 54494F4E20         
  9320                                  chr_del_pnum2:
  9321 00005DEB 30                      	db	'0'
  9322 00005DEC 203F2028592F4E2920-     	db	' ? (Y/N) ', 0
  9322 00005DF5 00                 
  9323                                  
  9324                                  _msg_YES:
  9325 00005DF6 20                      	db	 20h
  9326                                  msg_YES:
  9327 00005DF7 5945532000              	db	'YES ', 0
  9328                                  _msg_NO:
  9329 00005DFC 20                      	db	20h
  9330                                  msg_NO:
  9331 00005DFD 4E4F2000                	db	'NO ', 0
  9332                                  
  9333                                  ; 11/02/2019
  9334                                  msg_write_masterboot_sector:
  9335 00005E01 0D0A                    	db	0Dh, 0Ah 
  9336 00005E03 577269746520437572-     	db	"Write Current Partition Table:"
  9336 00005E0C 72656E742050617274-
  9336 00005E15 6974696F6E20546162-
  9336 00005E1E 6C653A             
  9337 00005E21 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
  9338 00005E25 20312E205772697465-     	db	" 1. Write Partition Table only", 0Dh, 0Ah
  9338 00005E2E 20506172746974696F-
  9338 00005E37 6E205461626C65206F-
  9338 00005E40 6E6C790D0A         
  9339 00005E45 20322E205772697465-     	db	" 2. Write Partition Table and Singlix Master Boot Code", 0Dh, 0Ah
  9339 00005E4E 20506172746974696F-
  9339 00005E57 6E205461626C652061-
  9339 00005E60 6E642053696E676C69-
  9339 00005E69 78204D617374657220-
  9339 00005E72 426F6F7420436F6465-
  9339 00005E7B 0D0A               
  9340                                  enter_opt_num_cancel_msg:
  9341 00005E7D 0D0A                    	db	0Dh, 0Ah
  9342 00005E7F 456E74657220746865-     	db	"Enter the option number or press ESC to cancel ...", 0
  9342 00005E88 206F7074696F6E206E-
  9342 00005E91 756D626572206F7220-
  9342 00005E9A 707265737320455343-
  9342 00005EA3 20746F2063616E6365-
  9342 00005EAC 6C202E2E2E00       
  9343                                  
  9344                                  msg_writing_ptable:
  9345 00005EB2 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah  
  9346 00005EB6 57726974696E672070-     	db	"Writing partition table on disk ... ", 0
  9346 00005EBF 6172746974696F6E20-
  9346 00005EC8 7461626C65206F6E20-
  9346 00005ED1 6469736B202E2E2E20-
  9346 00005EDA 00                 
  9347                                  _msg_OK:
  9348                                  	;db	7
  9349 00005EDB 0D0A                    	db	0Dh, 0Ah
  9350 00005EDD 4F4B2021                	db	"OK !"
  9351 00005EE1 0D0A00                  	db	0Dh, 0Ah, 0
  9352                                  
  9353                                  option_input:
  9354 00005EE4 205B205D00              	db	' [ ]', 0
  9355                                  
  9356                                  msg_enter_pn_to_act:
  9357 00005EE9 0D0A                    	db	0Dh, 0Ah
  9358 00005EEB 456E74657220706172-     	db	"Enter partition number to set as active: ", 0
  9358 00005EF4 746974696F6E206E75-
  9358 00005EFD 6D62657220746F2073-
  9358 00005F06 657420617320616374-
  9358 00005F0F 6976653A2000       
  9359                                  
  9360                                  ;trdos386_disk_chs_header:
  9361                                  retrodos5_disk_chs_header:
  9362 00005F15 0D0A                    	db	0Dh, 0Ah
  9363                                  	;db	"                     TRDOS 386 (SINGLIX) HARD DISK IMAGE                        "
  9364                                  	; 04/05/2024
  9365 00005F17 202020202020202020-     	db	"                         RETRO DOS V5 HARD DISK IMAGE                           "
  9365 00005F20 202020202020202020-
  9365 00005F29 202020202020205245-
  9365 00005F32 54524F20444F532056-
  9365 00005F3B 352048415244204449-
  9365 00005F44 534B20494D41474520-
  9365 00005F4D 202020202020202020-
  9365 00005F56 202020202020202020-
  9365 00005F5F 2020202020202020   
  9366 00005F67 00                      	db 	0
  9367                                  
  9368                                  disk_chs_header:
  9369 00005F68 0D0A                    	db	0Dh, 0Ah
  9370 00005F6A 202020202020202020-     	db	"                                HARD DISK IMAGE                                 "
  9370 00005F73 202020202020202020-
  9370 00005F7C 202020202020202020-
  9370 00005F85 202020202048415244-
  9370 00005F8E 204449534B20494D41-
  9370 00005F97 474520202020202020-
  9370 00005FA0 202020202020202020-
  9370 00005FA9 202020202020202020-
  9370 00005FB2 2020202020202020   
  9371 00005FBA 00                      	db 	0
  9372                                  
  9373                                  msg_partition_size_limit:
  9374 00005FBB 0D0A                    	db	0Dh, 0Ah
  9375 00005FBD 506172746974696F6E-     	db	"Partition size overs available free space !"
  9375 00005FC6 2073697A65206F7665-
  9375 00005FCF 727320617661696C61-
  9375 00005FD8 626C65206672656520-
  9375 00005FE1 73706163652021     
  9376 00005FE8 0D0A                    	db	0Dh, 0Ah
  9377 00005FEA 4D61782E2061766169-     	db 	"Max. available free space is ", 0
  9377 00005FF3 6C61626C6520667265-
  9377 00005FFC 652073706163652069-
  9377 00006005 732000             
  9378                                  
  9379                                  msg_partition_size_limit_r:
  9380 00006008 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
  9381 0000600C 28507265737320454E-     	db	"(Press ENTER to use all of available space or press ESC key to retry..) "
  9381 00006015 54455220746F207573-
  9381 0000601E 6520616C6C206F6620-
  9381 00006027 617661696C61626C65-
  9381 00006030 207370616365206F72-
  9381 00006039 207072657373204553-
  9381 00006042 43206B657920746F20-
  9381 0000604B 72657472792E2E2920 
  9382 00006054 000A00                  	db	0D, 0Ah, 0
  9383                                  
  9384                                  msg_cylinders:
  9385 00006057 2063796C696E646572-     	db	" cylinders", 0
  9385 00006060 7300               
  9386                                  msg_sectors:
  9387 00006062 20736563746F727300      	db	" sectors", 0
  9388                                  
  9389                                  ; 02/03/2019
  9390                                  msg_megabytes:
  9391 0000606B 206D65676162797465      	db	" megabyte"
  9392                                  msg_megabytes_s:
  9393 00006074 0000                    	db	0, 0
  9394                                  
  9395                                  msg_inv_pte:
  9396 00006076 0D0A                    	db	0Dh, 0Ah
  9397 00006078 496E76616C69642070-     	db	"Invalid partition table entry ! (P"
  9397 00006081 6172746974696F6E20-
  9397 0000608A 7461626C6520656E74-
  9397 00006093 72792021202850     
  9398 0000609A 3F290D0A                inv_pte_num: db	"?)", 0Dh, 0Ah
  9399 0000609E 28507265737320454E-     	db	"(Press ENTER to DELETE or press ESC to EXIT..)"
  9399 000060A7 54455220746F204445-
  9399 000060B0 4C455445206F722070-
  9399 000060B9 726573732045534320-
  9399 000060C2 746F20455849542E2E-
  9399 000060CB 29                 
  9400 000060CC 0D0A00                  	db	0Dh, 0Ah, 0
  9401                                  
  9402                                  msg_ext_partition_exists:
  9403 000060CF 457874656E64656420-     	db	"Extended partition already exists !"
  9403 000060D8 706172746974696F6E-
  9403 000060E1 20616C726561647920-
  9403 000060EA 6578697374732021   
  9404 000060F2 0D0A00                  	db	0Dh, 0Ah, 0
  9405                                  
  9406                                  msg_defective_pt:
  9407 000060F5 0D0A                    	db	0Dh, 0Ah
  9408 000060F7 446566656374697665-     	db	"Defective partition table !", 0
  9408 00006100 20706172746974696F-
  9408 00006109 6E207461626C652021-
  9408 00006112 00                 
  9409                                  
  9410                                  ; 27/02/2019
  9411                                  msg_ext_part_del_error:
  9412 00006113 0D0A                    	db	0Dh, 0Ah
  9413 00006115 457874656E64656420-     	db	"Extended partition must be deleted after logical drive(s) !"
  9413 0000611E 706172746974696F6E-
  9413 00006127 206D75737420626520-
  9413 00006130 64656C657465642061-
  9413 00006139 66746572206C6F6769-
  9413 00006142 63616C206472697665-
  9413 0000614B 2873292021         
  9414 00006150 0D0A00                  	db	0Dh, 0Ah, 0
  9415                                  
  9416                                  msg_cancel_continue:
  9417 00006153 285072657373204553-     	db	"(Press ESC to cancel or press another key to continue..)"
  9417 0000615C 4320746F2063616E63-
  9417 00006165 656C206F7220707265-
  9417 0000616E 737320616E6F746865-
  9417 00006177 72206B657920746F20-
  9417 00006180 636F6E74696E75652E-
  9417 00006189 2E29               
  9418 0000618B 0D0A00                  	db	0Dh, 0Ah, 0
  9419                                  
  9420                                  msg_delete_ldd:
  9421 0000618E 0D0A                    	db	0Dh, 0Ah
  9422 00006190 0D0A                    	db	0Dh, 0Ah
  9423 00006192 44656C657465204C6F-     	db	"Delete Logical (DOS) Drive:"
  9423 0000619B 676963616C2028444F-
  9423 000061A4 53292044726976653A 
  9424 000061AD 0D0A                    	db	0Dh, 0Ah
  9425 000061AF 50726573732044454C-     	db	"Press DELETE key to delete logical disk partition "
  9425 000061B8 455445206B65792074-
  9425 000061C1 6F2064656C65746520-
  9425 000061CA 6C6F676963616C2064-
  9425 000061D3 69736B207061727469-
  9425 000061DC 74696F6E20         
  9426 000061E1 3F2E                    lddp_num: db	"?."
  9427 000061E3 0D0A00                  	db	0Dh, 0Ah, 0
  9428                                  
  9429                                  msg_delete_ext_part:
  9430 000061E6 0D0A                    	db	0Dh, 0Ah
  9431 000061E8 0D0A                    	db	0Dh, 0Ah
  9432 000061EA 44656C657465204578-     	db	"Delete Extended (DOS) Partition:"
  9432 000061F3 74656E646564202844-
  9432 000061FC 4F5329205061727469-
  9432 00006205 74696F6E3A         
  9433 0000620A 0D0A                    	db	0Dh, 0Ah
  9434 0000620C 507265737320454E54-     	db	"Press ENTER to delete or press ESC to cancel.."
  9434 00006215 455220746F2064656C-
  9434 0000621E 657465206F72207072-
  9434 00006227 657373204553432074-
  9434 00006230 6F2063616E63656C2E-
  9434 00006239 2E                 
  9435 0000623A 0D0A00                  	db	0Dh, 0Ah, 0
  9436                                  
  9437                                  str_display_ebr_pt:
  9438 0000623D 285072657373205350-     	db	"(Press SPACE to edit EXTENDED Partition Table)", 0Dh, 0Ah, 0
  9438 00006246 41434520746F206564-
  9438 0000624F 697420455854454E44-
  9438 00006258 454420506172746974-
  9438 00006261 696F6E205461626C65-
  9438 0000626A 290D0A00           
  9439                                  
  9440                                  ebr_editing_options:
  9441 0000626E 0D0A0D0A                	db 0Dh, 0Ah, 0Dh, 0Ah
  9442 00006272 457874656E64656420-     	db "Extended Partition Table Editing Options:"
  9442 0000627B 506172746974696F6E-
  9442 00006284 205461626C65204564-
  9442 0000628D 6974696E67204F7074-
  9442 00006296 696F6E733A         
  9443 0000629B 0D0A0D0A                	db 0Dh, 0Ah, 0Dh, 0Ah
  9444 0000629F 20202020202020312E-     	db "       1. Create Logical DOS Drive", 0Dh, 0Ah
  9444 000062A8 20437265617465204C-
  9444 000062B1 6F676963616C20444F-
  9444 000062BA 532044726976650D0A 
  9445 000062C3 20202020202020322E-     	db "       2. Delete Logical (DOS) Drive(s)",0Dh, 0Ah, 0
  9445 000062CC 2044656C657465204C-
  9445 000062D5 6F676963616C202844-
  9445 000062DE 4F5329204472697665-
  9445 000062E7 2873290D0A00       
  9446                                  
  9447                                  msg_delete_ldd_q:
  9448 000062ED 0D0A                    	db 	0Dh, 0Ah
  9449 000062EF 5741524E494E47210D-     	db 	"WARNING!", 0Dh, 0Ah 
  9449 000062F8 0A                 
  9450 000062F9 416C6C206F66206461-     	db	"All of data in logical (DOS) drive(s) will be lost !!", 0Dh, 0Ah
  9450 00006302 746120696E206C6F67-
  9450 0000630B 6963616C2028444F53-
  9450 00006314 292064726976652873-
  9450 0000631D 292077696C6C206265-
  9450 00006326 206C6F73742021210D-
  9450 0000632F 0A                 
  9451 00006330 0D0A                    	db	0Dh, 0Ah
  9452 00006332 446F20796F75207761-     	db	"Do you want to continue ? (Y/N) ", 0
  9452 0000633B 6E7420746F20636F6E-
  9452 00006344 74696E7565203F2028-
  9452 0000634D 592F4E292000       
  9453                                  
  9454                                  msg_create_ldd_max_error:
  9455 00006353 0D0A                    	db	0Dh, 0Ah
  9456 00006355 50726F6772616D206C-     	db	"Program limit for logical dos drive count is 4 !"
  9456 0000635E 696D697420666F7220-
  9456 00006367 6C6F676963616C2064-
  9456 00006370 6F7320647269766520-
  9456 00006379 636F756E7420697320-
  9456 00006382 342021             
  9457 00006385 0D0A00                  	db 	0Dh, 0Ah, 0
  9458                                  
  9459                                  msg_c_ldd_unused_warning:
  9460 00006388 0D0A                    	db	0Dh, 0Ah
  9461 0000638A 546865726520697320-     	db	"There is unused extended partition space after logical dos drive 4 !"
  9461 00006393 756E75736564206578-
  9461 0000639C 74656E646564207061-
  9461 000063A5 72746974696F6E2073-
  9461 000063AE 706163652061667465-
  9461 000063B7 72206C6F676963616C-
  9461 000063C0 20646F732064726976-
  9461 000063C9 6520342021         
  9462 000063CE 0D0A                    	db 	0Dh, 0Ah
  9463 000063D0 285072657373204553-     	db	"(Press ESC to add unused space or press ENTER to continue.)"
  9463 000063D9 4320746F2061646420-
  9463 000063E2 756E75736564207370-
  9463 000063EB 616365206F72207072-
  9463 000063F4 65737320454E544552-
  9463 000063FD 20746F20636F6E7469-
  9463 00006406 6E75652E29         
  9464 0000640B 0D0A00                  	db 	0Dh, 0Ah, 0
  9465                                  
  9466                                  msg_create_ldd_s:
  9467 0000640E 53656C65637420616E-     	db	"Select an option to set logical dos drive size: "
  9467 00006417 206F7074696F6E2074-
  9467 00006420 6F20736574206C6F67-
  9467 00006429 6963616C20646F7320-
  9467 00006432 64726976652073697A-
  9467 0000643B 653A20             
  9468 0000643E 0D0A                    	db	0Dh, 0Ah
  9469 00006440 0D0A                    	db	0Dh, 0Ah
  9470 00006442 202043292043796C69-     	db	"  C) Cylinder count", 0Dh, 0Ah   
  9470 0000644B 6E64657220636F756E-
  9470 00006454 740D0A             
  9471 00006457 2020252920566F6C75-     	db	"  %) Volume percentage (##%)", 0Dh, 0Ah
  9471 00006460 6D652070657263656E-
  9471 00006469 746167652028232325-
  9471 00006472 290D0A             
  9472 00006475 20204D29204D656761-     	db	"  M) Mega bytes (MB, 2*1024*M sectors)", 0Dh, 0Ah
  9472 0000647E 20627974657320284D-
  9472 00006487 422C20322A31303234-
  9472 00006490 2A4D20736563746F72-
  9472 00006499 73290D0A           
  9473 0000649D 202047292047696761-     	db	"  G) Giga bytes (GB, 2*1024*1024*G sectors)", 0Dh, 0Ah
  9473 000064A6 206279746573202847-
  9473 000064AF 422C20322A31303234-
  9473 000064B8 2A313032342A472073-
  9473 000064C1 6563746F7273290D0A 
  9474 000064CA 0D0A                    	db	0Dh, 0Ah	
  9475 000064CC 507265737320535041-     	db	"Press SPACE to use entire space or press ENTER to set Megabytes .. ", 0
  9475 000064D5 434520746F20757365-
  9475 000064DE 20656E746972652073-
  9475 000064E7 70616365206F722070-
  9475 000064F0 7265737320454E5445-
  9475 000064F9 5220746F2073657420-
  9475 00006502 4D6567616279746573-
  9475 0000650B 202E2E2000         
  9476                                  
  9477                                  msg_c_part_error:
  9478 00006510 0D0A                    	db 	0Dh, 0Ah
  9479 00006512 4E6F20667265652073-     	db	"No free space for a new primary partition", 0Dh, 0Ah, 0
  9479 0000651B 7061636520666F7220-
  9479 00006524 61206E657720707269-
  9479 0000652D 6D6172792070617274-
  9479 00006536 6974696F6E0D0A00   
  9480                                  msg_c_ldd_error: 
  9481 0000653E 616E64206C6F676963-     	db	"and logical dos drives over program limit (4) !", 0Dh, 0Ah, 0
  9481 00006547 616C20646F73206472-
  9481 00006550 69766573206F766572-
  9481 00006559 2070726F6772616D20-
  9481 00006562 6C696D697420283429-
  9481 0000656B 20210D0A00         
  9482                                  msg_c_ldd_q:
  9483 00006570 0D0A                    	db	0Dh, 0Ah
  9484 00006572 446F20796F75207761-     	db	"Do you want to create logical dos drive in extended dos partition "
  9484 0000657B 6E7420746F20637265-
  9484 00006584 617465206C6F676963-
  9484 0000658D 616C20646F73206472-
  9484 00006596 69766520696E206578-
  9484 0000659F 74656E64656420646F-
  9484 000065A8 732070617274697469-
  9484 000065B1 6F6E20             
  9485 000065B4 3F2028592F4E2900        	db	'? (Y/N)', 0
  9486                                  
  9487                                  msg_c_ldd_nofspc_error:
  9488 000065BC 0D0A                    	db 	0Dh, 0Ah
  9489 000065BE 4E6F20667265652073-     	db	"No free space for a new logical dos drive !", 0Dh, 0Ah, 0
  9489 000065C7 7061636520666F7220-
  9489 000065D0 61206E6577206C6F67-
  9489 000065D9 6963616C20646F7320-
  9489 000065E2 647269766520210D0A-
  9489 000065EB 00                 
  9490                                  
  9491                                  ;pt_positions:
  9492                                  ;n_pos:	 dw	30 ; 1 byte
  9493                                  ;p_pos:	 dw	7  ; 1 byte
  9494                                  ;s_pos:	 dw	9  ; 2+1 bytes
  9495                                  ;bh_pos: dw 	13 ; 2+1 bytes
  9496                                  ;bs_pos: dw	17 ; 2+1 bytes
  9497                                  ;bc_pos: dw  	21 ; 2+1 bytes
  9498                                  ;fs_pos: dw 	25 ; 2+1 bytes
  9499                                  ;eh_pos: dw 	29 ; 2+1 bytes
  9500                                  ;es_pos: dw	33 ; 2+1 bytes
  9501                                  ;ec_pos: dw	37 ; 2+1 bytes
  9502                                  ;rs_pos: dw	42 ; 7 bytes
  9503                                  ;ns_pos: dw	52 ; 7 bytes
  9504                                  ;fsx_pos: dw	61 ; 14 bytes
  9505                                  
  9506                                  align 4
  9507                                  
  9508                                  msg_sectors_crlf:
  9509 000065EC 20736563746F72          	db	" sector"
  9510                                  msg_sectors_crlf_s:
  9511 000065F3 73                      	db	"s"
  9512 000065F4 0D0A00                  	db	0Dh, 0Ah, 0
  9513                                  
  9514                                  vname_length:
  9515 000065F7 00                      	db	0 ; 05/01/2018
  9516                                  
  9517                                  bs_oem_name:
  9518                                  	;db	'TRDOS2.0', 0
  9519                                  	; 04/05/2024
  9520 000065F8 524554524F444F5300      	db	'RETRODOS', 0
  9521                                  
  9522 00006601 90                      align 2
  9523                                  
  9524                                  no_name:
  9525 00006602 4E4F204E414D452020-     	db 	'NO NAME    ', 0
  9525 0000660B 202000             
  9526                                  
  9527                                  align 2
  9528                                  
  9529                                  FDFORMAT_SECBUFFER:
  9530                                  HDFORMAT_SECBUFFER:
  9531 0000660E F6<rep 200h>            	times	512 db 0F6h
  9532                                  HDFORMAT_FSINFO_BUFF:
  9533 0000680E 52526141                	dd	41615252h  ; FSI_LeadSig
  9534 00006812 00<rep 1E0h>            	times	480 db 0   ; FSI_Reserved1
  9535 000069F2 72724161                	dd	61417272h  ; FSI_StrucSig
  9536 000069F6 FFFFFFFF                	dd	0FFFFFFFFh ; FSI_Free_Count
  9537 000069FA 02000000                	dd	000000002h ; FSI_Nxt_Free
  9538 000069FE 00<rep Ch>              	times	12 db 0	   ; FSI_Reserved2
  9539 00006A0A 000055AA                	dd	0AA550000h ; FSI_TrailSig
  9540                                  
  9541                                  SizeOfFile equ $-100
  9542                                  
  9543                                  ; 03/02/2019
  9544                                  
  9545                                  ;=============================================================================
  9546                                  ;        	uninitialized data
  9547                                  ;=============================================================================
  9548                                  
  9549                                  bss_start:
  9550                                  
  9551                                  ABSOLUTE bss_start
  9552                                  
  9553                                  alignb 2
  9554 00006A0E ????                    old_sp:		resw 1
  9555                                  
  9556                                  HDFORMAT_FATBUFFER:
  9557                                  FDFORMAT_FATBUFFER:
  9558                                  FDFORMAT_FATBUFFER_S9: ; temporary !
  9559                                  HDFORMAT_EMPTY_BUFF:
  9560 00006A10 <res 200h>              	resb 512
  9561                                  
  9562 00006C10 ????????                data_start: resd 1
  9563 00006C14 ????????                data_sectors: resd 1
  9564 00006C18 ????????                cluster_count: resd 1
  9565 00006C1C ????                    root_dir_secs: resw 1
  9566 00006C1E ????                    format_percent: resw 1
  9567 00006C20 ??                      prev_percent:	resb 1
  9568 00006C21 ??                      rsvdbyte:	resb 1
  9569                                  
  9570 00006C22 ????                    alignb 4
  9571                                  
  9572                                  ; 05/01/2018
  9573 00006C24 <res 40h>               fs_volume_name: resb 64
  9574 00006C64 ????????                fs_volume_serial: resd 1
  9575 00006C68 ????                    DAT_FFBit:	resw 1
  9576 00006C6A ????                    DAT_FFSector:	resw 1
  9577                                  		;resw 1
  9578 00006C6C ????                    DAT_LFBit:	resw 1
  9579 00006C6E ????                    DAT_LFSector:	resw 1
  9580                                  		;resw 1
  9581                                  
  9582                                  ;alignb 4
  9583                                  
  9584                                  FS_MAT_Buffer: ; TRFS1 Master Allocation Table (05/01/2018)
  9585 00006C70 ??????                  MAT_Sign:		resb    3	; Offset 0  ; 'MAT'
  9586 00006C73 ??                      MAT_Version:		resb 	1	; 	 3  ; 0	
  9587 00006C74 ????????                MAT_VolumeSize:		resd	1	;	 4  ; FS1 Volume Size
  9588 00006C78 ????????                MAT_BeginSector:	resd	1	;	 8  ; FS1 Start Sector
  9589 00006C7C ????????                DAT_Address:		resd	1	;	12  ; Offset (=2)
  9590 00006C80 ????????                DAT_SectorCount:	resd	1	;	16  
  9591 00006C84 ????????                MAT_FreeSectors:	resd 	1	; 	20
  9592 00006C88 ????????                MAT_FirstFreeSector:	resd	1	;	24
  9593                                  ;MAT_OS_Reserved:
  9594                                  ;	 		resb	9
  9595                                  ;MAT_Unused:
  9596                                  ;			resb	112
  9597                                  FS_DAT_Buffer: ; TRFS1 Disk Allocation Table (05/01/2018)
  9598                                  FS_RDT_Buffer: ; TRFS1 Root Directory Description Table (05/01/2018)
  9599 00006C8C <res 200h>              			resb	512
  9600                                  ;alignb 4
  9601                                  
  9602                                  ; (TR-DOS 386 compatible) Hard Disk (image) parameters
  9603                                  
  9604 00006E8C ????????                total_sectors: resd 1
  9605 00006E90 ????????                pType:	       resb 4
  9606 00006E94 ????????                file_size:     resd 1
  9607 00006E98 ????????                pp_StartSector: resd 1
  9608 00006E9C ????????                pp_Sectors:	resd 1
  9609 00006EA0 ??                      wholedisk:	resb 1
  9610 00006EA1 ??                      pp_type: resb 1 ; Primary partition type (for this program)
  9611 00006EA2 ??                      pp_type_user: resb 1
  9612 00006EA3 ??                      chs_focus: resb 1
  9613 00006EA4 ????????                pSize_temp: resd 1
  9614 00006EA8 ????????                pSize_multiplier: resd 1
  9615 00006EAC ??                      pSize_maxdigits: resb 1
  9616 00006EAD ??                      pSize_digitpos: resb 1
  9617                                  msg_psize_unit:
  9618 00006EAE ????                    pSize_unit:	resw 1
  9619 00006EB0 ??                      		resb 1
  9620 00006EB1 ??????                  reserved_bytes: resb 3 ; for 11 bytes of numbers
  9621                                  msg_partition_sectors:
  9622 00006EB4 ????????????????        		resb 8
  9623 00006EBC ??                      		resb 1
  9624 00006EBD ??                      format_q:	resb 1 ; 03/02/2018
  9625                                  
  9626                                  ;alignb 2
  9627 00006EBE ??                      pType_pos:	resb 1
  9628 00006EBF ??                      pType_num:	resb 1
  9629 00006EC0 ??                      		resb 1
  9630                                  ;cylinder_boundary:
  9631 00006EC1 ??                      		resb 1
  9632 00006EC2 ????                    last_cylinder:	resw 1
  9633                                  
  9634                                  alignb 2
  9635                                  
  9636 00006EC4 ??                      GetChar:	resb 1 ; 11/02/2019
  9637 00006EC5 ??                      existingfile:	resb 1 ; 12/02/2019
  9638                                  
  9639 00006EC6 ????                    min_sectors:	resw 1 ; 08/02/2019
  9640 00006EC8 ????                    pp_StartCylinder: resw 1
  9641 00006ECA ????                    pp_EndCylinder:	resw 1
  9642                                  
  9643 00006ECC ????????                ppn_Sectors:	resd 1 ; 09/02/2019
  9644                                  
  9645 00006ED0 ????                    input_col:	resw 1
  9646 00006ED2 ??                      No:		resb 1
  9647 00006ED3 ??                      Yes:		resb 1
  9648                                  
  9649                                  ; 26/02/2019
  9650 00006ED4 ??                      ldrives:	resb 1	
  9651                                  
  9652 00006ED5 ??                      sort_1:		resb 1
  9653 00006ED6 ????????                sort:		resb 4
  9654                                  
  9655                                  ;max_sector:	resb 8
  9656                                  ebr_buffer:		; 26/02/2019
  9657 00006EDA <res 200h>              boot_record:	resb 512
  9658                                  
  9659 000070DA ??                      valid_input:	resb 1
  9660 000070DB ??                      		resb 1
  9661                                  
  9662                                  ; 26/02/2019
  9663 000070DC ????????                ep_StartSector:	resd 1
  9664 000070E0 ????????                ep_EndSector:	resd 1
  9665 000070E4 ????????                ep_Size:	resd 1
  9666                                  
  9667                                  ; 10/02/2019
  9668 000070E8 ????????                valid_ppnums:	resb 4
  9669                                  
  9670 000070EC ????                    _i_:	resw 1
  9671                                  
  9672 000070EE ????                    freespace_count: resw 1
  9673 000070F0 ??                      last_found_partition: resb 1
  9674 000070F1 ??                      p_type: resb 1	
  9675                                  
  9676                                  p_sorted:
  9677 000070F2 ??                      	resb 1
  9678                                  ep_sorted:
  9679 000070F3 ??                      	resb 1
  9680                                  
  9681 000070F4 ??                      _e_:	resb 1
  9682                                  
  9683                                  act_part_num:
  9684                                  cre_part_num:
  9685 000070F5 ??                      del_part_num: resb 1 ; 10/02/2019
  9686                                  
  9687                                  alignb 2
  9688                                  
  9689 000070F6 <res 50h>               pte_row: resb 80
  9690                                  
  9691 00007146 ??                      _zero_:	resb 1
  9692                                  
  9693                                  ;alignb 2
  9694                                  
  9695 00007147 ??                      	resb 1
  9696                                  
  9697                                  ; 24/02/2019
  9698                                  goodpte:
  9699 00007148 ??                      	resb 1
  9700 00007149 ??                      badpte:	resb 1
  9701                                  
  9702                                  bss_clear_end: ; 15/02/2019
  9703                                  
  9704                                  ; PARTITION DATA STRUCTURE
  9705                                  ; 4 partitions
  9706                                  ; 18 byte partition data structure per partition
  9707                                  ; 72 bytes (4*18)
  9708                                  
  9709 0000714A ??                      part_table_boot_ind:	 resb 1
  9710 0000714B ??                      part_table_start_head:	 resb 1
  9711 0000714C ??                      part_table_start_sector: resb 1
  9712 0000714D ????                    part_table_start_cyl:	 resw 1
  9713 0000714F ??                      part_table_sys_id:	 resb 1
  9714 00007150 ??                      part_table_end_head:	 resb 1
  9715 00007151 ??                      part_table_end_sector:	 resb 1
  9716 00007152 ????                    part_table_end_cyl:	 resw 1
  9717 00007154 ????                    part_table_rel_sec_lw:	 resw 1
  9718 00007156 ????                    part_table_rel_sec_hw:	 resw 1
  9719 00007158 ????                    part_table_num_sec_lw:	 resw 1
  9720 0000715A ????                    part_table_num_sec_hw:	 resw 1
  9721                                  
  9722 0000715C <res 36h>               			resb 54 ; 3*18
  9723                                  
  9724 00007192 ??                      pcount:		resb 1
  9725 00007193 ??                      ppcount:	resb 1
  9726 00007194 ??                      apcount:	resb 1
  9727 00007195 ??                      epnumber:	resb 1
  9728                                  
  9729                                  ; LOGICAL PARTITION DATA STRUCTURE
  9730                                  ; (for logical partitions in extended partition)
  9731                                  
  9732                                  ; 1 extended partition
  9733                                  ; 4 logical drives (18 bytes)
  9734                                  ; 72 bytes (4*18)
  9735                                  
  9736 00007196 ??                      ext_table_boot_ind:	resb 1
  9737 00007197 ??                      ext_table_start_head:	resb 1
  9738 00007198 ??                      ext_table_start_sector: resb 1
  9739 00007199 ????                    ext_table_start_cyl:	resw 1
  9740 0000719B ??                      ext_table_sys_id:	resb 1
  9741 0000719C ??                      ext_table_end_head:	resb 1
  9742 0000719D ??                      ext_table_end_sector:	resb 1
  9743 0000719E ????                    ext_table_end_cyl:	resw 1
  9744 000071A0 ????                    ext_table_rel_sec_lw:	resw 1
  9745 000071A2 ????                    ext_table_rel_sec_hw:	resw 1
  9746 000071A4 ????                    ext_table_num_sec_lw:	resw 1
  9747 000071A6 ????                    ext_table_num_sec_hw:	resw 1
  9748                                  
  9749 000071A8 <res 36h>               			resb 54 ; 3*18
  9750                                  
  9751                                  fspc:		; 5*8 words (for free space calculations)
  9752                                  
  9753                                  ; Space 1 - unused cylinders before partition 0
  9754                                  ; Space 2 - unused cylinders between partition 0 & 1
  9755                                  ; Space 3 - unused cylinders between partition 1 & 2
  9756                                  ; Space 4 - unused cylinders between partition 2 & 3
  9757                                  ; Space 5 - unused cylinders after partition 3
  9758                                  
  9759 000071DE ????                    free_space.space:   	   resw 1
  9760 000071E0 ????                    free_space.start:   	   resw 1
  9761 000071E2 ????                    free_space.end:	   	   resw 1
  9762 000071E4 ????                    free_space.percent_unused: resw 1
  9763 000071E6 ????????                free_space.sectors_unused: resd 1
  9764 000071EA ????????                free_space.startsector:   resd 1 ; 13/02/2019
  9765                                  		;resw  4*6 
  9766 000071EE <res 40h>               		resw   4*8 ; 13/02/2019
  9767                                  
  9768                                  ; 18/02/2019
  9769 0000722E ????                    c_cylinder:	resw 1
  9770 00007230 ????                    c_fspc_offset:	resw 1
  9771 00007232 ??                      cylinder_boundary: resb 1
  9772                                  ;c_gap:		resb 1
  9773 00007233 ??                      		resb 1
  9774                                  
  9775                                  ; 27/02/2019
  9776 00007234 <res 10h>               ldd_start:	resd 4
  9777                                  ; 03/03/2019
  9778 00007244 <res 10h>               ldd_size:	resd 4
  9779                                  
  9780                                  ; 25/02/2019
  9781 00007254 ????                    pte_address:	resw 1
  9782                                  ; 02/03/2019
  9783 00007256 ????                    lcylinders:	resw 1
  9784                                  
  9785                                  ;bss_clear_end: ; 18/02/2019  ; temporary
  9786                                  
  9787                                  bss_end:	 	
